     H        1                                                           S01486
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas PM Update portfolio pos. if no backval.')        *
/*OVRF*: OVRDBF FILE(CAPRTDX) TOFILE(PMCAPRL2) SHARE(*NO)           : *   S01486
/*OVRF*: OVRDBF FILE(PMCPOSLX) TOFILE(PMCPOSLL) SHARE(*NO)          : *
     H**********                                                          S01486
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Management                             *
     F*                                                               *
     F*  PM1110 - UPDATE PORTFOLIO POSITIONS IF NO BACKVALUATION      *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD057247           Date 01Feb21               *
      *  Prev Amend No. MD046248           Date 27Oct17               *
      *                 CLE148             Date 23Jul12               *
      *                 CER059             Date 19Jul10               *
      *                 CER020             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CSE031             Date 06Dec01               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CPB001             Date 18Feb00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 130862             Date 16Oct98               *
     F*                 CSE005             Date 04Feb97               *
     F*                 CPM005             Date 06Aug96               *
     F*                 CFF004             DATE 02OCT96               *
     F*                 078956             DATE 01DEC95               *
     F*                 S01486             DATE 05JUL94               *
     F*                 064264     DWH     DATE 06DEC93               *
     F*                 049421             DATE 29OCT93               *
     F*                 059983             DATE 27SEP93               *
     F*                 059063             DATE 11AUG93               *
     F*                 054798             DATE 03MAY93               *
     F*                 042719     ADI     DATE 28JUL92               *
     F*                 46081              DATE 21OCT92               *
     F*                 B08253             DATE 20OCT91               *
     F*                 B08684             DATE 09OCT91               *
     F*                 B08040             DATE 29AUG91               *
     F*                 B07933             DATE 06JUN91               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD057247 - Multiple calls of UTCHOBJEX for several COB com-  *
      *             ponents - Securities module.                      *
      *           - Moved the call of AOSARDR0 from /copy ZLCDZ1.     *
      *  MD046248 - Finastra Rebranding                               *
      *  CLE148 - Alpha Loan Reference (Recompile)                    *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus (Recompile)                              *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
     F*  CSE031 - Coupon Fixing for Floating Rate Notes.              *
     F*           (recompilation due to change to ZNCD/ZLCD)          *
     F*  CPB001 -  'Private Banking' Module                           *
     F*  130862 - Recompiled over changed ZLCDZ1.                     *
     F*  CSE005 - Effect of holidays on FRN Coupon Dates              *
     F*           (recompilation due to change to ZNCD/ZLCD)          *
     F*  CPM005 - Private Banking Phase 2                             *
     F*           Focus Group Changes upgraded to DBA                 *
     F*           PBFG/5 - INSTRUMENT ASSET / LIABILITY SPLIT         *
     F*           PBFG/6 - ADDITIONAL CUSTOMER DETAILS                *
     F*           PBFG/7 - NET COMMITMENT BY CURRENCY                 *
     F*           PBFG/8 - DISPLAY POSITIONS SPLIT BY CURRENCY        *
     F*  CFF004 - Increase in size of Price Fields,(Recompiled Only)  *
     F*  078956 - IF NEW NOMINAL POSITION REMAINS 0 DO NOT DELETE     *
     F*           RECORD ON PMMFHLPD BUT UPDATE 'DATE LAST EXTRACTED' *
     F*  S01486 - Private Banking upgrade to Release 10               *
     F*  064264 - TRIES TO DIVIDE BY ZERO                             *
     F*  049421 - HEADER BOX STANDARDISATION                          *
     F*  059983 - FOR CHANGE OF AVERAGE PRICE RECALCULATE FX AP       *
     F*           NUMERATOR                                           *
     F*  059063 - PREVENT ROUNDING PROBELMS WHEN CALCULATING NEW      *
     F*           AP NUMERATOR FOR A POSITION BECOMING LESS LONG OR   *
     F*           LESS SHORT                                          *
     F*  054798 - ONLY WRITE VALUE DATE POSITION ON CHANGE OF POSITION*
     F*  042719 - CHECK IF PORTFOLIO CURRENCY AND BASE CURRENCY ARE   *
     F*           THE SAME (SETUP FIELD QAAPBC IN PMCPOSPP)           *
     F*  46081  - WRITE VALUE DATE POSITION IF NONE EXISTS            *
     F*  B08253 - FOR EACH NEW POSITION OUTPUT DELETE ANY DETAILS     *
     F*           FOR POSITION ON PMMFHLPP                            *
     F*  B09684 - USE PMCPOSLX - PREFIX 'QA'                          *
     F*  B08040 - SUNDRY FIXES TO SPEED UP COB PROCESSING             *
     F*  B07933 - IF DIVIDEND EVENT HAS OCCURRED RESET EX-COUPON NOM. *
     F*                                                               *
     F*****************************************************************
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*:*OVRDBF*FILE(CAPRTDX)*TOFILE(CAPRTDT)*SHARE(*NO)************:*****S01486
     F*                                                               *
     F*****************************************************************
     FPM1110AUO   E                    PRINTER
     F                                              KINFSR *PSSR
     F***SDBANKL1IF**E           K        DISK                            S01486
     F***********                                   KINFSR *PSSR          S01486
     F***SDPORTPDIF**E           K        DISK                      B08040S01486
     F***********                                   KINFSR *PSSR    B08040S01486
     F***PMCPOSZZUF**E           K        DISK                            S01486
     FPMCPOSPAUF  E           K        DISK                               S01486
     F**  Prefix QA
     F                                              KINFSR *PSSR
     F***SDCURRL0IF**E           K        DISK                            S01486
     F***********                                   KINFSR *PSSR          S01486
     FSECTY   IF  E           K        DISK
     F                                              KINFSR *PSSR
     F***SDPLCSL0IF**E           K        DISK                            S01486
     F****Prefix*QB*******************************************************S01486
     F***********                                   KINFSR *PSSR          S01486
     F***SDSECSL0IF**E           K        DISK                      B08040S01486
     F****Prefix*BF*************************************************B08040S01486
     F***********                                   KINFSR *PSSR    B08040S01486
     F***SDCUSTL0IF**E           K        DISK                      B08040S01486
     F****Prefix*BB*************************************************B08040S01486
     F***********                                   KINFSR *PSSR    B08040S01486
     FPMMFHLL2UF  E           K        DISK                               B08253
     F**  Prefix QA                                                       B08253
     F                                              KINFSR *PSSR          B08253
     F***PMPORTPPIF**E           K        DISK                            S01486
     FPMPORTPDIF  E           K        DISK                               S01486
     F**  Prefix PN
     F                                              KINFSR *PSSR
     F***PMCPOSPPO***E           K        DISK                            S01486
     FPMCPOSPDO   E           K        DISK                               S01486
     F**  Prefix QA
     FPMCPOSLLUF  E           K        DISK
     F**  Prefix QA
     F            PMCPOSP0                          KRENAMEPMCPOSL0
     FPMCPOSLXUF  E           K        DISK                               B9684
     F**  Prefix QA                                                       B9684
     F            PMCPOSP0                          KRENAMEPMCPOSLA       B9684
     F***CAPRTDX*UF**E           K        DISK                            S01486
     FPMCAPRL2UF  E           K        DISK                               S01486
     F*
     FSECET   IF  E           K        DISK         KINFSR *PSSR          B07933
     F*
     FINVTP   IF  E           K        DISK         KINFSR *PSSR          B07933
     F*
      /EJECT
     F*================================================================
     F*
     F* ID F  C  H  L    Function of indicators
     F*
     F*                Unused indicators
     F*                -----------------
     F*       01  02  03  04  05  06  07  08  09  10
     F*       11  12  13  14  15  16  17  18  19  20
     F*       21  22  23  24  25  26  27  28  29  30
     F*       31  32  33  34  35  36  37  38  39  40
     F*       41  42  43  44  45  46  47  48  49  50
     F*       51  52  53  54  55  56  57  58  59  60
     F*       61  62  63  64  65  66  67  68  69  70
     F*       ..  ..  73  74  75  76  77  78  79  80
     F*       81  82  83  84  85  86  87  88  89  90
     F*       ..  ..  ..  ..  ..  96  97  ..  ..
     F*
     F*
     F*       U7&U8      Database error
     F*       U8         Run control error
     F*       LR         End of program
     F*
     F*       71         End of actions file indicator
     F*       72         Files access indicator
     F*       90-99      Standard subroutines indicator
     F*
      /EJECT
     E*================================================================
     E*
      /COPY ZSRSRC,ZDATE2Z1
     E*
      /COPY ZSRSRC,ZNCDZ1
     E*
      /COPY ZSRSRC,ZPOWER8Z1
     E*
     E**   Array for copyright
     E                    CPY@    1   1 80               COPYRIGHT
     E*
      /EJECT
     I*================================================================
     I*                                                                   B9684
     I*  Rename fields from PMCPOSLX                                      B9684
     IPMCPOSLA                                                            B9684
     I              QARECI                          QPRECI                B9684
     I              QACNUM                          QPCNUM                B9684
     I              QAPTFR                          QPPTFR                B9684
     I              QATDSS                          QPTDSS                B9684
     I              QATVDA                          QPTVDA                B9684
     I              QAPDAT                          QPPDAT                B9684
     I              QANOML                          QPNOML                B9684
     I              QACSEX                          QPCSEX                B9684
     I              QAAPNM                          QPAPNM                B9684
     I              QAFXAP                          QPFXAP                B9684
     I              QAPILP                          QPPILP                B9684
     I              QAACDI                          QPACDI                B9684
     I              QABVLD                          QPBVLD                B9684
     I              QATNMC                          QPTNMC                B9684
     I              QATNMD                          QPTNMD                B9684
     I              QAPTCY                          QPPTCY                B9684
     I              QAPCDP                          QPPCDP                B9684
     I              QAAYNM                          QPAYNM                B9684
     I              QACSBY                          QPCSBY                B9684
     I              QABYDP                          QPBYDP                B9684
     I              QACLAS                          QPCLAS                B9684
     I              QAACOC                          QPACOC                B9684
     I              QAOTNM                          QPOTNM                B9684
     I              QAOTEX                          QPOTEX                B9684
     I              QAAPBC                          QPAPBC                B08253
     I              QAFLEX                          QPFLEX                B08253
     I              QACOLC                          QPCOLC                B08040
     I              QABRCD                          QPBRCD                B08040
     I              QANPDT                          QPNPDT                B08040
     I              QAPFMR                          QPPFMR                CPM005
     I              QAPFM8                          QPPFM8                CPM005
     I              QAPFM9                          QPPFM9                CPM005
     I*
     I**   Customer average prices
     ICAPRHDF
     I              RECI                            WWRECI
     I*
      /COPY ZSRSRC,ZNCDZ2
     ISDMMOD    E DSSDMMODPD                                              CPB001
     I** EXTERNAL DS FOR MODULE DETAILS                                   CPB001
     ISDBANK    E DSSDBANKPD                                              S01486
     I** EXTERNAL DS FOR BANK DETAILS                                     S01486
     ISDCURR    E DSSDCURRPD                                              S01486
     I** EXTERNAL DS FOR CURRENCY DETAILS                                 S01486
     ISDCUST    E DSSDCUSTPD                                              S01486
     I** External data structure for Customer Details                     S01486
     ISDPLCS    E DSSDPLCSPD                                              S01486
     I** EXTERNAL DS FOR PORTFOLIO MANAGEMENT CUSTOMER DETAILS            S01486
     ISDPLIN    E DSSDPLINPD                                              S01486
     I** EXTERNAL DS FOR INTRUMENT TYPES DETAILS                          S01486
     ISDPORT    E DSSDPORTPD                                              S01486
     I** DUMMY RECORD FORMATS FOR ACCESS TO BANK DETAILS                  S01486
     ISDSECS    E DSSDSECSPD                                              S01486
     I** External data structure for Securities Customer Details          S01486
     IDSFDY     E DSDSFDY                                                 S01486
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01486
     IDSSDY     E DSDSSDY                                                 S01486
     I* Second DS For Access Programs, Long Data Structure                S01486
     IDSLDY     E DSDSLDY                                                 CPB001
     I* THIRD DS FOR ACCESS PROGRAMS, VERY LONG DATA STRUCTURE            CPB001
     I*
     I**   Local data area for database error details
     I***LDA********UDS                             256                   S01486
     I**************                        132 183 DBLOT                 S01486
     I**************                        132 141 DBFILE                S01486
     ILDA         DS                            256                       S01486
     I                                      134 183 DBLOT                 S01486
     I                                      134 141 DBFILE                S01486
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*                                                                   078956
     IPMSTAT    E DS                                                      078956
     I                                        1   50WWECD                 078956
     I*
      /EJECT
     C*****************************************************************
     C           *ENTRY    PLIST                           Entry parameter
     C                     PARM           WWTVDA  1        Trade/value basis
     C*
     C**   To include copyright into object
     C***********          MOVEACPY@      BIS@   80                       S01486
     C                     MOVEACPY@      ACT@   80                       S01486
     C*****************************************************************
     C*   K E Y   L I S T S
     C*================================================================
     C*
     C**   Key to access the portfolio details
     C           P1KEY     KLIST
     C                     KFLD           CSCN
     C                     KFLD           PTFR
     C*
     C**   Key to access the current portfolio position details
     C           P2KEY     KLIST
     C****                 KFLD           CSCN                            B08040
     C****                 KFLD           PTFR                            B08040
     C****                 KFLD           CSSC                            B08040
     C****                 KFLD           WWTVDA                          B08040
     C**********           KFLD           WCSCN   60                                   B08040 CSD027
     C                     KFLD           WCSCN   6                                           CSD027
     C                     KFLD           WPTFR   4                       B08040
     C                     KFLD           WCSSC  10                       B08040
     C                     KFLD           WTVDA1  1                       B08040
     C*
     C**   Key to position on average prices file if backvaluation
     C           P3KEY     KLIST
     C                     KFLD           CSCN
     C                     KFLD           PTFR
     C                     KFLD           CSSC
     C*                                                                   B07933
     C**   Key to diary event details                                     B07933
     C           P4KEY     KLIST                                          B07933
     C                     KFLD           WWSDSN                          B07933
     C                     KFLD           WWSDET                          B07933
     C                     KFLD           SDED                            B07933
     C*                                                                   B07933
     C**   Key to investment type details                                 B07933
     C           P5KEY     KLIST                                          B07933
     C                     KFLD           NMCY                            B07933
     C                     KFLD           SITP                            B07933
     C*                                                                   B08253
     C           MFHLKY    KLIST                                          B08253
     C                     KFLD           QFCNUM                          B08253
     C                     KFLD           QFPTFR                          B08253
     C                     KFLD           QFTDSS                          B08253
     C*
      /EJECT
     C*================================================================
     C*   M A I N   P R O C E S S I N G
     C*================================================================
     C*
     C**   Perform initial processing
     C                     EXSR #INIT
     C*
     C**   Perform main processing
     C                     EXSR #MAIN
     C*
     C**   Perform final processing
     C                     EXSR #FINAL
     C*
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C**   I N D E X   O F   S U B R O U T I N E S
     C*================================================================
     C**
     C**   #MAIN    Main processing
     C**
     C**   #PORT    Access portfolio details
     C**
     C**   #SECT    Access security details
     C**
     C**   #W01     Write a record to the current portfolio positions
     C**            file
     C**
     C**   #P01     Access current position details
     C**
     C**   #P02     Process the action
     C**
     C**   #P03     Trades processing
     C**
     C**   #P04     Depot movement processing
     C**
     C**   #P05     Price changes processing
     C**
     C**   #P06     Remove mature / flat positions for security
     C**
     C**   #ZAPNUM  To calculate average price numerator
     C**
     C**   #ZAYNUM  To calculate average yield numerator
     C**
     C**   #ZFXAPN  To calculate FX average price numerator
     C**
     C**   #ZLCD    To calculate last coupon date prior the
     C**            event date
     C**
     C**   #ZDATE1  To validate date submittted and convert
     C**            to a number of days
     C**
     C**   #ZDATE2  To convert a day number to a date format
     C**
     C**   #INIT    Initial processing
     C**
     C**   #FINAL   Final processing
     C**
     C**   *PSSR    File error handling
     C**
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #MAIN        -  detail processing
     C**
     C**   CALLED BY    -  main processing
     C**
     C**   CALLS #PORT  -  to access portfolio details
     C**         #SECT  -  to access security details
     C**         #W01   -  to write a new portfolio position record
     C**         #P01   -  to access current position details
     C**         #P02   -  to process the action read
     C**
     C*=========================================================================
     C*
     C           #MAIN     BEGSR                           * #MAIN BEGSR *
     C*
     C**   Read customer average prices generated today
     C***********          READ CAPRTDX                  71               S01486
     C                     READ PMCAPRL2                 71               S01486
     C*
     C**   Perform processing until end of file reached
     C           *IN71     DOWEQ'0'
     C*
     C**   Access portfolio details when change of customer or portfolio
     C           CSCN      CASNEWWCSCN    #PORT
     C           PTFR      CASNEWWPTFR    #PORT
     C                     END
     C*
     C**   Access security details when change of security
     C           CSSC      CASNEWWCSSC    #SECT
     C                     END
     C*
     C**   Write a record to the current portfolio positions file
     C**   if at least one action has been processed
     C********** WWCSCN    IFNE *ZEROS                                                        CSD027
     C           WWCSCN    IFNE *BLANKS                                                       CSD027
     C*
     C**   and there is a change of customer, portfolio, security and date
     C           CSCN      IFNE WWCSCN
     C           PTFR      ORNE WWPTFR
     C           CSSC      ORNE WWCSSC
     C           CSDA      ORNE WWCSDA
     C*
     C**   and no backvaluation was identified for that position
     C           QARECI    CASNE'R'       #W01
     C                     END
     C                     END
     C                     END
     C*
     C**   Save previous portfolio details when change of portfolio
     C**   or customer
     C           CSCN      IFNE WWCSCN
     C           PTFR      ORNE WWPTFR
     C                     MOVE PNPTCY    WWPTCY
     C                     Z-ADDPNPCDP    WWPCDP
     C                     END
     C*
     C**   Save previous security details when change of security
     C           CSSC      IFNE WWCSSC
     C                     MOVE NMCY      WWNMCY
     C                     Z-ADDNMDP      WWNMDP
     C                     Z-ADDA6NBDP    WWNBDP
     C                     END
     C*
     C**   Access current position details when change of customer,
     C**   portfolio and security
     C           CSCN      CASNEWWCSCN    #P01
     C           PTFR      CASNEWWPTFR    #P01
     C           CSSC      CASNEWWCSSC    #P01
     C*
     C**   Otherwise process the action
     C                     CAS            #P02
     C                     END
     C*
     C**   Save previous action details
     C**********           Z-ADDCSCN      WWCSCN                                              CSD027
     C                     MOVE CSCN      WWCSCN                                              CSD027
     C                     MOVE PTFR      WWPTFR
     C                     MOVE CSSC      WWCSSC
     C                     Z-ADDCSDA      WWCSDA
     C*
     C**   Read customer average prices generated today
     C***********          READ CAPRTDX                  71               S01486
     C                     READ PMCAPRL2                 71               S01486
     C*
     C                     END
     C*
     C*    Write record details if end of file reached
     C           *IN71     IFEQ '1'
     C           QARECI    ANDNE'R'
     C********** WWCSCN    ANDNE*ZEROS                                                        CSD027
     C           WWCSCN    ANDNE*BLANKS                                                       CSD027
     C                     EXSR #W01
     C                     END
     C*
     C                     ENDSR                           * #MAIN ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #PORT           -  access portfolio details
     C**
     C**   CALLED BY #MAIN -  detail processing
     C**
     C**   CALLS
     C**
     C*=========================================================================
     C*
     C           #PORT     BEGSR                           * #PORT BEGSR *
     C*
     C** IF PORTFOLIO IS 'UNASSIGNED' PORTFOLIO
     C*
     C           PTFR      IFNE *BLANKS
     C           PTFR      IFEQ '9997'
     C*
     C**   Access the customer details file using the customer number
     C*
     C***********          MOVE CSCN      WCNUM   6                       S01486
     C                     MOVELCSCN      PLCUS                           S01486
     C***********WCNUM     CHAINSDPLCSL0             72                   S01486
     C                     CALL 'AOPLCSR0'                                S01486
     C                     PARM *BLANKS   PRTCD   7                       S01486
     C                     PARM '*KEY'    POPTN   7                       S01486
     C                     PARM           PLCUS  10                       S01486
     C           SDPLCS    PARM SDPLCS    DSFDY                           S01486
     C*
     C**   Perform database in error processing if no record found
     C************IN72     IFEQ '1'                                       S01486
     C           PRTCD     IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD02        DBASE            ***************
     C***********          MOVEL'SDPLCSL0'DBFILE           * DB ERROR 02 *S01486
     C                     MOVEL'SDPLCSPD'DBFILE           * DB ERROR 02 *S01486
     C                     MOVELCSCN      DBKEY            ***************
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C*
     C                     MOVELQBCSBY    PNPTCY
     C                     Z-ADDQBBYDP    PNPCDP
     C*
     C                     ELSE
     C*
     C**   Access the portfolio details file using the customer number
     C**   and portfolio reference
     C***********P1KEY     CHAINPMPORTPP             72                   S01486
     C           P1KEY     CHAINPMPORTPD             72                   S01486
     C*
     C**   Perform database in error processing if no record found
     C           *IN72     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD03        DBASE            ***************
     C***********          MOVEL'PMPORTPP'DBFILE           * DB ERROR 03 *S01486
     C                     MOVEL'PMPORTPD'DBFILE           * DB ERROR 03 *S01486
     C                     MOVELCSCN      DBKY10 10        ***************
     C                     MOVE PTFR      DBKY10
     C                     MOVELDBKY10    DBKEY
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C                     END
     C*
     C                     END
     C                     ENDSR                           * #PORT ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #SECT           -  access security details
     C**
     C**   CALLED BY #MAIN -  detail processing
     C**
     C**   CALLS
     C**
     C*=========================================================================
     C*
     C           #SECT     BEGSR                           * #SECT BEGSR *
     C*
     C**   Access the security details file using the security shortname
     C           CSSC      CHAINSECTY                72
     C*
     C**   Perform database in error processing if no live record found
     C           *IN72     IFEQ '0'
     C           RECI      ANDEQ'*'
     C                     MOVE '1'       *IN72
     C                     END
     C*
     C           *IN72     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD04        DBASE            ***************
     C                     MOVEL'SECTY   'DBFILE           * DB ERROR 04 *
     C                     MOVELCSSC      DBKEY            ***************
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C*                                                                   B07933
     C**   Access the investment details file using the nominal currency  B07933
     C**   and investment type from SECTYD                                B07933
     C           P5KEY     CHAININVTP                72                   B07933
     C*                                                                   B07933
     C**   Perform database in error processing if no live record found   B07933
     C           *IN72     IFEQ '0'                                       B07933
     C           RECI      ANDEQ'*'                                       B07933
     C                     MOVE '1'       *IN72                           B07933
     C                     END                                            B07933
     C*                                                                   B07933
     C           *IN72     IFEQ '1'                                       B07933
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD14        DBASE            ***************B07933
     C                     MOVEL'INVTP   'DBFILE           * DB ERROR 04 *B07933
     C                     MOVELSITP      DBKEY            ***************B07933
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR                                     B07933
     C                     END                                            B07933
     C*
     C**   Access the currency details file using the nominal currency
     C***********NMCY      CHAINSDCURRL0             72                   S01486
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*KEY  '  @OPTN   7                       S01486
     C                     PARM NMCY      @AJCD   3                       S01486
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C*
     C**   Perform database in error processing if no record found
     C************IN72     IFEQ '1'                                       S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD05        DBASE            ***************
     C***********          MOVEL'SDCURRL0'DBFILE           * DB ERROR 05 *S01486
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 05 *S01486
     C                     MOVELNMCY      DBKEY            ***************
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C*
     C                     ENDSR                           * #SECT ENDSR**
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #W01           -  to write a record to the current positions file
     C**
     C**   CALLED BY MAIN -  detail processing
     C**
     C**   CALLS
     C**
     C*=========================================================================
     C*
     C           #W01      BEGSR                           ** #W01 BEGSR *
     C*
     C**   If only the date has been changed, set the record id. to 'I'
     C**   otherwise, set it to 'D'
     C           CSCN      IFEQ WWCSCN
     C           PTFR      ANDEQWWPTFR
     C           CSSC      ANDEQWWCSSC
     C           *IN71     ANDEQ'0'
     C                     MOVE 'I'       QARECI
     C                     Z-ADD*ZEROS    QABVLD
     C                     ELSE
     C                     MOVE 'D'       QARECI
     C                     Z-ADDBKVALD    QABVLD
     C                     END
     C*
     C**********           Z-ADDWWCSCN    QACNUM                                              CSD027
     C                     MOVE WWCSCN    QACNUM                                              CSD027
     C                     MOVE WWPTFR    QAPTFR
     C                     MOVE WWCSSC    QATDSS
     C                     MOVE WWTVDA    QATVDA
     C                     Z-ADDWWCSDA    QAPDAT
     C                     Z-ADD*ZEROS    QAACDI
     C                     MOVE WWNMCY    QATNMC
     C                     Z-ADDWWNMDP    QATNMD
     C                     MOVE WWPTCY    QAPTCY
     C                     Z-ADDWWPCDP    QAPCDP
     C                     Z-ADDWAOTNM    QAOTNM                          B08040
     C                     Z-ADDWAOTEX    QAOTEX                          B08040
     C*                                                                   B08040
     C** Obtain additional customer information                           B08040
     C                     MOVE QACNUM    WWCNUM  6                       B08040
     C                     MOVELQACNUM    PLCUS                           S01486
     C           BGPFMG    IFEQ 'Y'                                       CPB001
     C***********WWCNUM    CHAINSDPLCSL0             72             B08040S01486
     C                     CALL 'AOPLCSR0'                                S01486
     C                     PARM *BLANKS   PRTCD   7                       S01486
     C                     PARM '*KEY'    POPTN   7                       S01486
     C                     PARM           PLCUS  10                       S01486
     C           SDPLCS    PARM SDPLCS    DSFDY                           S01486
     C************IN72     IFEQ '1'                        ***************S01486
     C           PRTCD     IFNE *BLANKS                                   S01486
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C*                                                                   B08040
     C**   Perform database in error processing if no record found        B08040
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD62        DBASE            ***************B08040
     C***********          MOVEL'SDPLCSL0'DBFILE * DB ERROR 62 *    B08040S01486
     C                     MOVEL'SDPLCSPD'DBFILE           * DB ERROR 62 *S01486
     C                     MOVELQACNUM    DBKEY            ***************B08040
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR                                     B08040
     C                     END                                            B08040
     C                     ENDIF                                          CPB001
     C*                                                                   B08040
     C***********WWCNUM    CHAINSDSECSL0             72             B08040S01486
     C                     CALL 'AOSECSR0'                                S01486
     C                     PARM *BLANKS   @RTCD                           S01486
     C                     PARM '*KEY   ' @OPTN                           S01486
     C                     PARM WWCNUM    @AENB   6                       S01486
     C           SDSECS    PARM SDSECS    DSSDY                           S01486
     C*                                                                   B08040
     C**   Perform database in error processing if no record found        B08040
     C************IN72     IFEQ '1'                                 B08040S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD52        DBASE            ***************B08040
     C***********          MOVEL'SDSECSL0'DBFILE     * DB ERROR 52 *B08040S01486
     C                     MOVEL'SDSECSPD'DBFILE           * DB ERROR 52 *S01486
     C                     MOVELWWCNUM    DBKEY            ***************B08040
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR                                     B08040
     C                     END                                            B08040
     C*                                                                   B08040
     C***********WWCNUM    CHAINSDCUSTL0             72             B08040S01486
     C*****                CALL 'AOCUSTR0'                          S01486CPB001
     C                     CALL 'AOCUSTR1'                                CPB001
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*KEY   ' @OPTN   7                       S01486
     C                     PARM           PLCUS  10                       S01486
     C                     PARM *BLANKS   @KYST   7                       S01486
     C*****      SDCUST    PARM SDCUST    DSSDY                     S01486CPB001
     C           SDCUST    PARM SDCUST    DSLDY                           CPB001
     C*                                                                   B08040
     C**   Perform database in error processing if no record found        B08040
     C************IN72     IFEQ '1'                                 B08040S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD55        DBASE            ***************B08040
     C***********          MOVEL'SDCUSTL0'DBFILE     * DB ERROR 52 *B08040S01486
     C                     MOVEL'SDCUSPPD'DBFILE           * DB ERROR 52 *S01486
     C                     MOVELWWCNUM    DBKEY            ***************B08040
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR                                     B08040
     C                     END                                            B08040
     C*                                                                   CPB001
     C           BBPRBA    IFEQ 'Y'                                       CPB001
     C**   Key to access the portfolio details                            CPB001
     C           P6KEY     KLIST                                          CPB001
     C                     KFLD           WWCSCN                          CPB001
     C                     KFLD           WWPTFR                          CPB001
     C*                                                                   CPB001
     C           P6KEY     CHAINPMPORTPD             72                   CPB001
     C*                                                                   CPB001
     C**   Perform database in error processing if no record found        CPB001
     C           *IN72     IFEQ '1'                                       CPB001
     C           PNRECI    ORNE 'D'                                       CPB001
     C           *LOCK     IN   LDA                                       CPB001
     C                     Z-ADD65        DBASE            ***************CPB001
     C                     MOVEL'PMPORTPD'DBFILE           * DB ERROR 65 *CPB001
     C                     MOVELQACNUM    DBKY10 10        ***************CPB001
     C                     MOVE PTFR      DBKY10                          CPB001
     C                     MOVELDBKY10    DBKEY                           CPB001
     C                     OUT  LDA                                       CPB001
     C                     EXSR *PSSR                                     CPB001
     C                     ENDIF                                          CPB001
     C                     ENDIF                                          CPB001
     C*                                                                   B08040
     C           BBPRBA    IFNE 'Y'                                       CPB001
     C                     MOVE QBCSBY    QACSBY                          B08040
     C                     MOVE QBBYDP    QABYDP                          B08040
     C                     ELSE                                           CPB001
     C                     MOVE PNPTCY    QACSBY                          CPB001
     C                     MOVE PNPCDP    QABYDP                          CPB001
     C                     ENDIF                                          CPB001
     C*                                                                   CPB001
     C                     MOVE BFCLAS    QACLAS                          B08040
     C                     MOVE BBACOC    QAACOC                          B08040
     C                     MOVE BBCOLC    QACOLC                          B08040
     C                     MOVE BBBRCD    QABRCD                          B08040
     C*
     C*********************MOVE *BLANKS   QAAPBC                         042719
     C           QACSBY    IFNE QAPTCY                                   042719
     C                     MOVE 'N'       QAAPBC                         042719
     C                     ELSE                                          042719
     C                     MOVE ' '       QAAPBC                         042719
     C                     END                                           042719
     C                     MOVE *BLANKS   QAFLEX
     C*                                                                   B08040
     C                     WRITEPMCPOSP0
     C*                                                                   B08253
     C** Delete details of all flat positions on PMMFHLL2                 B08253
     C***********WWTVDA    IFEQ P9TVPS                              B08253S01486
     C           WWTVDA    IFEQ FCTVPS                                    S01486
     C                     EXSR #P06                                      B08253
     C                     END                                            B08253
     C*                                                                   B08040
     C** Save nominal and ex coupon nominal to be added to other position B08040
     C                     Z-ADDQANOML    WAOTN1 150                      B08040
     C                     Z-ADDQACSEX    WAOTE1 150                      B08040
     C*                                                                   B08040
     C** Update other position with details of new position               B08040
     C           WWTVDA    IFEQ 'T'                                       B08040
     C                     MOVE 'V'       WTVDA1                          B08040
     C                     ELSE                                           B08040
     C                     MOVE 'T'       WTVDA1                          B08040
     C                     END                                            B08040
     C*                                                                   B08040
     C                     MOVE QACNUM    WCSCN                           B08040
     C                     MOVE QAPTFR    WPTFR                           B08040
     C                     MOVE QATDSS    WCSSC                           B08040
     C*                                                                   B08040
     C****       P2KEY     CHAINPMCPOSLL             72             B9684 B08040
     C           P2KEY     CHAINPMCPOSLX             72                   B9684
     C*                                                                   B08040
     C           *IN72     IFEQ '0'                                       B08040
     C****                 Z-ADDWAOTN1    QAOTNM                    B9684 B08040
     C****                 Z-ADDWAOTE1    QAOTEX                    B9684 B08040
     C****                 UPDATPMCPOSL0                            B9684 B08040
     C                     Z-ADDWAOTN1    QPOTNM                          B9684
     C                     Z-ADDWAOTE1    QPOTEX                          B9684
     C                     UPDATPMCPOSLA                                  B9684
     C                     END                                            B08040
     C*                                                                   46081
     C** IF SYSTEM SHOWING VALUE DATE POSITIONS ALSO WRITE VALUE DATE     46081
     C** POSITION WITH ALL AMOUNTS ZERO APRT FROM 'OTHER' FIELDS          46081
     C***********P9TVPS    IFEQ 'V'                                  46081S01486
     C           FCTVPS    IFEQ 'V'                                       S01486
     C           *IN72     ANDEQ'1'                                       46081
     C           WWTVDA    ANDEQ'T'                                       46081
     C** IF CHANGE OF POSITION OR PROCESSING LAST RECORD AND NO VALUE DATE054798
     C** POSITION EXISTS WRITE A VALUE DATE POSITION                      054798
     C           *IN71     IFEQ '1'                                       054798
     C           CSCN      ORNE WWCSCN                                    054798
     C           PTFR      ORNE WWPTFR                                    054798
     C           CSSC      ORNE WWCSSC                                    054798
     C                     MOVE WTVDA1    QATVDA                          46081
     C                     Z-ADDOTHD      QAPDAT                          46081
     C                     Z-ADDQANOML    QAOTNM                          46081
     C                     Z-ADDQACSEX    QAOTEX                          46081
     C                     Z-ADD0         QANOML                          46081
     C                     Z-ADD0         QACSEX                          46081
     C                     Z-ADD0         QAAPNM                          46081
     C                     Z-ADD0         QAFXAP                          46081
     C                     Z-ADD0         QAPILP                          46081
     C                     Z-ADD0         QAACDI                          46081
     C                     Z-ADD0         QABVLD                          46081
     C                     WRITEPMCPOSP0                                  46081
     C                     END                                            054798
     C                     END                                            46081
     C*
     C                     ENDSR                           ** #W01 ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #P01            -  access current position details
     C**
     C**   CALLED BY #MAIN -  detail processing
     C**
     C**   CALLS
     C**
     C*=========================================================================
     C*
     C           #P01      BEGSR                           ** #P01 BEGSR *
     C*                                                                   B08040
     C** Obtain details of other position for output to new position      B08040
     C           WWTVDA    IFEQ 'T'                                       B08040
     C                     MOVE 'V'       WTVDA1                          B08040
     C                     ELSE                                           B08040
     C                     MOVE 'T'       WTVDA1                          B08040
     C                     END                                            B08040
     C*                                                                   B08040
     C                     MOVE CSCN      WCSCN                           B08040
     C                     MOVE PTFR      WPTFR                           B08040
     C                     MOVE CSSC      WCSSC                           B08040
     C*                                                                   B08040
     C           P2KEY     CHAINPMCPOSLL             72                   B08040
     C*                                                                   B08040
     C           *IN72     IFEQ '1'                                       B08040
     C                     Z-ADD0         WAOTNM 150                      B08040
     C                     Z-ADD0         WAOTEX 150                      B08040
     C                     ELSE                                           B08040
     C                     Z-ADDQANOML    WAOTNM                          B08040
     C                     Z-ADDQACSEX    WAOTEX                          B08040
     C                     END                                            B08040
     C*                                                                   B08040
     C*
     C**  Set the backvaluation date equal to this earliest movement date
     C                     Z-ADDCSDA      BKVALD  50
     C*
     C**   Access the current portfolio position using the customer,
     C**   the portfolio, the security and trade/value parameter
     C                     MOVE WWTVDA    WTVDA1                          B08040
     C           P2KEY     CHAINPMCPOSLL             72
     C*
     C**   If no record found, initialize file fields
     C           *IN72     IFEQ '1'
     C           CSDA      SUB  1         QAPDAT
     C                     MOVE *BLANK    QARECI
     C                     Z-ADD*ZEROS    QANOML
     C                     Z-ADD*ZEROS    QACSEX
     C                     Z-ADD*ZEROS    QAAPNM
     C                     Z-ADD*ZEROS    QAAYNM
     C                     Z-ADD*ZEROS    QAFXAP
     C                     Z-ADD*ZEROS    QAPILP
     C                     Z-ADD*ZEROS    QAACDI
     C*
     C**   Add 1 to the count of positions added
     C                     ADD  1         WWCNTA
     C                     END
     C*
     C**   If record found and backvaluation, update file and
     C**   bypass rest of processing for that customer, portfolio
     C**   and security
     C           CSDA      IFLE QAPDAT
     C*
     C           *IN72     IFEQ '0'
     C                     MOVE 'R'       QARECI
     C                     Z-ADDCSDA      QABVLD
     C                     UPDATPMCPOSL0
     C***********P3KEY     SETGTCAPRTDX                                   S01486
     C           P3KEY     SETGTPMCAPRL2                                  S01486
     C                     END
     C*
     C**   If no backvaluation, update file and process action
     C                     ELSE
     C*
     C           *IN72     IFEQ '0'
     C                     MOVE 'I'       QARECI
     C                     Z-ADD*ZEROS    QABVLD
     C                     UPDATPMCPOSL0
     C                     END
     C*
     C                     EXSR #P02
     C                     END
     C*
     C                     ENDSR                           ** #P01 ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #P02            -  to process the action read
     C**
     C**   CALLED BY #MAIN -  detail processing
     C**
     C**   CALLS #P03      -  trades processing
     C**         #P04      -  depot movements processing
     C**         #P05      -  price changes processing
     C**
     C*=========================================================================
     C*
     C           #P02      BEGSR                           ** #P02 BEGSR *
     C*
     C**   If action date being processed different than last processed
     C**   for the same customer, portfolio and security, calculate
     C**   the last coupon or dividend date
     C           CSDA      IFNE WWCSDA
     C           CSCN      ANDEQWWCSCN
     C           PTFR      ANDEQWWPTFR
     C           CSSC      ANDEQWWCSSC
     C*                                                                   B07933
     C** For shares obtain date of previous dividend from diary events    B07933
     C** file                                                             B07933
     C           PROT      IFEQ '4'                                       B07933
     C                     MOVELCSSC      WWSDSN 10                       B07933
     C                     MOVE 'DV'      WWSDET  2                       B07933
     C                     Z-ADDCSDA      SDED                            B07933
     C           P4KEY     SETGTSECET                                     B07933
     C                     READPSECET                    72               B07933
     C*                                                                   B07933
     C           *IN72     IFEQ '0'                                       B07933
     C           SDSN      ANDEQWWSDSN                                    B07933
     C           SDET      ANDEQWWSDET                                    B07933
     C                     Z-ADDSDED      ZZLCD                           B07933
     C                     ELSE                                           B07933
     C                     Z-ADD0         ZZLCD                           B07933
     C                     END                                            B07933
     C*                                                                   B07933
     C** For all other instruments obtain last coupon date using detail   B07933
     C** from LF/SECTY                                                    B07933
     C                     ELSE                                           B07933
     C                     Z-ADDCSDA      ZECD                            B07933
     C                     EXSR ZLCD
     C                     END                                            B07933
     C*
     C**   If the last coupon date is greater or equal to the last date
     C**   processed, set the ex-coupon nominal and purchased interest
     C**   to zero for this position
     C           ZZLCD     IFGE WWCSDA
     C                     Z-ADD*ZEROS    QACSEX
     C                     Z-ADD*ZEROS    QAPILP
     C                     END
     C*
     C                     END
     C*
     C**   If new customer, security and portfolio, calculate last
     C**   coupon date
     C           CSCN      IFNE WWCSCN
     C           PTFR      ORNE WWPTFR
     C           CSSC      ORNE WWCSSC
     C*                                                                   B07933
     C** For shares obtain date of previous dividend from diary events    B07933
     C** file                                                             B07933
     C           PROT      IFEQ '4'                                       B07933
     C                     MOVELCSSC      WWSDSN 10                       B07933
     C                     MOVE 'DV'      WWSDET  2                       B07933
     C                     Z-ADDCSDA      SDED                            B07933
     C           P4KEY     SETGTSECET                                     B07933
     C                     READPSECET                    72               B07933
     C*                                                                   B07933
     C           *IN72     IFEQ '0'                                       B07933
     C           SDSN      ANDEQWWSDSN                                    B07933
     C           SDET      ANDEQWWSDET                                    B07933
     C                     Z-ADDSDED      ZZLCD                           B07933
     C                     ELSE                                           B07933
     C                     Z-ADD0         ZZLCD                           B07933
     C                     END                                            B07933
     C*                                                                   B07933
     C** For all other instruments obtain last coupon date using detail   B07933
     C** from LF/SECTY                                                    B07933
     C                     ELSE                                           B07933
     C                     Z-ADDCSDA      ZECD
     C                     EXSR ZLCD
     C                     END                                            B07933
     C*
     C**   If the last coupon date is greater or equal to the current
     C**   position date, set the ex-coupon nominal and purchased
     C**   interest to zero for this position
     C           ZZLCD     IFGE QAPDAT
     C                     Z-ADD*ZEROS    QACSEX
     C                     Z-ADD*ZEROS    QAPILP
     C                     END
     C*
     C                     END
     C*
     C**   Process the trades, depot movements and price changes
     C**   according to the sort sequence
     C           CSSE      CASEQ'1'       #P03
     C           CSSE      CASEQ'3'       #P04
     C           CSSE      CASEQ'5'       #P05
     C                     END
     C*
     C**   Set the trade or value date record ID to 'H'
     C           WWTVDA    IFEQ 'T'
     C                     MOVE 'H'       PMTI
     C                     END
     C           WWTVDA    IFEQ 'V'
     C                     MOVE 'H'       PMVI
     C                     END
     C*
     C**   Update the action processed
     C                     UPDATCAPRHDF
     C*
     C                     ENDSR                           ** #P02 ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #P03           -  trades processing
     C**
     C**   CALLED BY #P02 -  detail processing
     C**
     C**   CALLS ZAPNUM   -  calculate AP numerator
     C**         ZAYNUM   -  calculate AY numerator
     C**         ZFXAPN   -  calculate FX AP numerator
     C**
     C*=========================================================================
     C*
     C           #P03      BEGSR                           ** #P03 BEGSR *
     C*
     C**   Set up AP numerator according to the value or trade indic.
     C           WWTVDA    IFEQ 'T'
     C                     Z-ADDCSTB      WWCAPN
     C                     ELSE
     C                     Z-ADDCSVB      WWCAPN
     C                     END
     C*
     C**   Calculate AY (Average Yield) Numerator
     C                     Z-ADDCSNL      ZNOML
     C                     Z-ADDCYLD      ZAVYD
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     EXSR ZAYNUM
     C                     Z-ADDZVALU     WWCAYN
     C*
     C**   Save original value of nominal
     C                     Z-ADDQANOML    WWNOML
     C*
     C**   Calculate absolute value of nominal
     C           QANOML    IFLT *ZEROS
     C                     Z-SUBQANOML    WWNOMA
     C                     ELSE
     C                     Z-ADDQANOML    WWNOMA
     C                     END
     C*-------------------------------------------------------------------------
     C**   1. Update fields for trades sale
     C*-------------------------------------------------------------------------
     C           CSOA      IFEQ 'TS'
     C*
     C**   Update nominal
     C                     ADD  CSNL      QANOML
     C*
     C**   Update the ex-coupon nominal and purchased interest
     C           ACIN      IFEQ 'X'
     C                     ADD  CSNL      QACSEX
     C                     SUB  ITRA      QAPILP
     C                     ELSE
     C                     ADD  ITRA      QAPILP
     C                     END
     C*
     C**   Update the AP,AY,& FX AP numerator
     C           WWNOML    IFEQ *ZEROS
     C                     Z-ADDWWCAPN    QAAPNM
     C                     Z-ADDWWCAYN    QAAYNM
     C                     Z-ADDCFAP      QAFXAP
     C                     END
     C*
     C           WWNOML    IFGT *ZEROS
     C                     ADD  WWCAPN    QAAPNM
     C                     ADD  WWCAYN    QAAYNM
     C                     ADD  CFAP      QAFXAP
     C                     END
     C*
     C           WWNOML    IFLT *ZEROS
     C*
     C           WWNOMA    IFGT CSNL
     C****       QANOML    DIV  WWNOML    WWRSLT 157H                     059063
     C****       WWRSLT    MULT QAAPNM    QAAPNM    H                     059063
     C****       WWRSLT    MULT QAAYNM    QAAYNM    H                     059063
     C****       WWRSLT    MULT QAFXAP    QAFXAP    H                     059063
     C           QANOML    MULT QAAPNM    WWTEMP 307H                     059063
     C           WWTEMP    DIV  WWNOML    QAAPNM    H                     059063
     C           QANOML    MULT QAAYNM    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAAYNM    H                     059063
     C           QANOML    MULT QAFXAP    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAFXAP    H                     059063
     C                     END
     C*
     C           WWNOMA    IFLT CSNL
     C*
     C**   Calculate AP (Average Price) Numerator
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCSCP      ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     MOVE SPBS      ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     QAAPNM
     C*
     C**   Calculate AY (Average Yield) Numerator
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCYLD      ZAVYD
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     EXSR ZAYNUM
     C                     Z-ADDZVALU     QAAYNM
     C*
     C**   Calculate FX AP (Average Price) Numerator
     C                     Z-ADDQAAPNM    ZAPNM
     C                     Z-ADDCFXR      ZAVFX
     C                     Z-ADDA6NBDP    ZNMCD
     C                     Z-ADDPNPCDP    ZPTCD
     C                     EXSR ZFXAPN
     C                     Z-ADDZFXAP     QAFXAP
     C                     END
     C*
     C           WWNOMA    IFEQ CSNL
     C                     Z-ADD*ZEROS    QAAPNM
     C                     Z-ADD*ZEROS    QAAYNM
     C                     Z-ADD*ZEROS    QAFXAP
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*-------------------------------------------------------------------------
     C**   2. Update fields for trades purchased
     C*-------------------------------------------------------------------------
     C           CSOA      IFEQ 'TP'
     C*
     C**   Update nominal
     C                     SUB  CSNL      QANOML
     C*
     C**   Update the ex-coupon nominal and purchased interest
     C           ACIN      IFEQ 'X'
     C                     SUB  CSNL      QACSEX
     C                     ADD  ITRA      QAPILP
     C                     ELSE
     C                     SUB  ITRA      QAPILP
     C                     END
     C*
     C**   Update the AP,AY, & FX AP numerator
     C           WWNOML    IFEQ *ZEROS
     C                     Z-SUBWWCAPN    QAAPNM
     C                     Z-SUBWWCAYN    QAAYNM
     C                     Z-SUBCFAP      QAFXAP
     C                     END
     C*
     C           WWNOML    IFLT *ZEROS
     C                     SUB  WWCAPN    QAAPNM
     C                     SUB  WWCAYN    QAAYNM
     C                     SUB  CFAP      QAFXAP
     C                     END
     C*
     C           WWNOML    IFGT *ZEROS
     C*
     C           WWNOML    IFGT CSNL
     C****       QANOML    DIV  WWNOML    WWRSLT 157H                     059063
     C****       WWRSLT    MULT QAAPNM    QAAPNM    H                     059063
     C****       WWRSLT    MULT QAAYNM    QAAYNM    H                     059063
     C****       WWRSLT    MULT QAFXAP    QAFXAP    H                     059063
     C           QANOML    MULT QAAPNM    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAAPNM    H                     059063
     C           QANOML    MULT QAAYNM    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAAYNM    H                     059063
     C           QANOML    MULT QAFXAP    WWTEMP    H                     059063
     C***********WWTEMP    DIV  QAFXAP    QAFXAP    H              059063 064264
     C           WWTEMP    DIV  WWNOML    QAFXAP    H                     064264
     C                     END
     C*
     C           WWNOML    IFLT CSNL
     C*
     C**   Calculate AP (Average Price) Numerator
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCSCP      ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     MOVE SPBS      ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     QAAPNM
     C*
     C**   Calculate AY (Average Yield) Numerator
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCYLD      ZAVYD
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     EXSR ZAYNUM
     C                     Z-ADDZVALU     QAAYNM
     C*
     C**   Calculate FX AP (Average Price) Numerator
     C                     Z-ADDQAAPNM    ZAPNM
     C                     Z-ADDCFXR      ZAVFX
     C                     Z-ADDA6NBDP    ZNMCD
     C                     Z-ADDPNPCDP    ZPTCD
     C                     EXSR ZFXAPN
     C                     Z-ADDZFXAP     QAFXAP
     C*
     C                     END
     C*
     C           WWNOML    IFEQ CSNL
     C                     Z-ADD*ZEROS    QAAPNM
     C                     Z-ADD*ZEROS    QAAYNM
     C                     Z-ADD*ZEROS    QAFXAP
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR                           ** #P03 ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #P04           -  depot movement processing
     C**
     C**   CALLED BY #P02 -  detail processing
     C**
     C**   CALLS ZAPNUM   -  calculate AP numerator
     C**         ZAYNUM   -  calculate AY numerator
     C**         ZFXAPN   -  calculate FX AP numerator
     C**
     C*=========================================================================
     C*
     C           #P04      BEGSR                           ** #P04 BEGSR *
     C*
     C**   Set up AP numerator according to the value or trade indic.
     C           WWTVDA    IFEQ 'T'
     C                     Z-ADDCSTB      WWCAPN
     C                     ELSE
     C                     Z-ADDCSVB      WWCAPN
     C                     END
     C*
     C**   Calculate AY (Average Yield) Numerator
     C                     Z-ADDCSNL      ZNOML
     C                     Z-ADDCYLD      ZAVYD
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     EXSR ZAYNUM
     C                     Z-ADDZVALU     WWCAYN
     C*
     C**   Save original value of nominal
     C                     Z-ADDQANOML    WWNOML
     C*
     C**   Calculate absolute value of nominal
     C           QANOML    IFLT *ZEROS
     C                     Z-SUBQANOML    WWNOMA
     C                     ELSE
     C                     Z-ADDQANOML    WWNOMA
     C                     END
     C*-------------------------------------------------------------------------
     C**   1. Update fields for source of action 'CI'
     C*-------------------------------------------------------------------------
     C           CSOA      IFEQ 'CI'
     C*
     C**   Update nominal
     C                     ADD  CSNL      QANOML
     C/COPY WNCPYSRC,PM1110C001
     C*
     C**   Update the AP,AY & FX AP numerator
     C           WWNOML    IFEQ *ZEROS
     C                     Z-ADDWWCAPN    QAAPNM
     C                     Z-ADDWWCAYN    QAAYNM
     C                     Z-ADDCFAP      QAFXAP
     C                     END
     C*
     C           WWNOML    IFGT *ZEROS
     C                     ADD  WWCAPN    QAAPNM
     C                     ADD  WWCAYN    QAAYNM
     C                     ADD  CFAP      QAFXAP
     C                     END
     C*
     C           WWNOML    IFLT *ZEROS
     C*
     C           WWNOMA    IFGT CSNL
     C****       QANOML    DIV  WWNOML    WWRSLT 157H                     059063
     C****       WWRSLT    MULT QAAPNM    QAAPNM    H                     059063
     C****       WWRSLT    MULT QAAYNM    QAAYNM    H                     059063
     C****       WWRSLT    MULT QAFXAP    QAFXAP    H                     059063
     C           QANOML    MULT QAAPNM    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAAPNM    H                     059063
     C           QANOML    MULT QAAYNM    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAAYNM    H                     059063
     C           QANOML    MULT QAFXAP    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAFXAP    H                     059063
     C                     END
     C*
     C           WWNOMA    IFLT CSNL
     C*
     C**   Calculate AP (Average Price) Numerator
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCSCP      ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     MOVE SPBS      ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     QAAPNM
     C*
     C**   Calculate AY (Average Yield) Numerator
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCYLD      ZAVYD
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     EXSR ZAYNUM
     C                     Z-ADDZVALU     QAAYNM
     C*
     C**   Calculate FX AP (Average Price) Numerator
     C                     Z-ADDQAAPNM    ZAPNM
     C                     Z-ADDCFXR      ZAVFX
     C                     Z-ADDA6NBDP    ZNMCD
     C                     Z-ADDPNPCDP    ZPTCD
     C                     EXSR ZFXAPN
     C                     Z-ADDZFXAP     QAFXAP
     C                     END
     C*
     C           WWNOMA    IFEQ CSNL
     C                     Z-ADD*ZEROS    QAAPNM
     C                     Z-ADD*ZEROS    QAAYNM
     C                     Z-ADD*ZEROS    QAFXAP
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*-------------------------------------------------------------------------
     C**   2. Update fields for source of action 'CO'
     C*-------------------------------------------------------------------------
     C           CSOA      IFEQ 'CO'
     C*
     C**   Update nominal
     C                     SUB  CSNL      QANOML
     C/COPY WNCPYSRC,PM1110C002
     C*
     C**   Update the AP,AY, & FX AP numerator
     C           WWNOML    IFEQ *ZEROS
     C                     Z-SUBWWCAPN    QAAPNM
     C                     Z-SUBWWCAYN    QAAYNM
     C                     Z-SUBCFAP      QAFXAP
     C                     END
     C*
     C           WWNOML    IFLT *ZEROS
     C                     SUB  WWCAPN    QAAPNM
     C                     SUB  WWCAYN    QAAYNM
     C                     SUB  CFAP      QAFXAP
     C                     END
     C*
     C           WWNOML    IFGT *ZEROS
     C*
     C           WWNOML    IFGT CSNL
     C****       QANOML    DIV  WWNOML    WWRSLT 157H                     059063
     C****       WWRSLT    MULT QAAPNM    QAAPNM    H                     059063
     C****       WWRSLT    MULT QAAYNM    QAAYNM    H                     059063
     C****       WWRSLT    MULT QAFXAP    QAFXAP    H                     059063
     C           QANOML    MULT QAAPNM    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAAPNM    H                     059063
     C           QANOML    MULT QAAYNM    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAAYNM    H                     059063
     C           QANOML    MULT QAFXAP    WWTEMP    H                     059063
     C           WWTEMP    DIV  WWNOML    QAFXAP    H                     059063
     C                     END
     C*
     C           WWNOML    IFLT CSNL
     C*
     C**   Calculate AP (Average Price) Numerator
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCSCP      ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     MOVE SPBS      ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     QAAPNM
     C*
     C**   Calculate AY (Average Yield) Numerator
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCYLD      ZAVYD
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     EXSR ZAYNUM
     C                     Z-ADDZVALU     QAAYNM
     C*
     C**   Calculate FX AP (Average Price) Numerator
     C                     Z-ADDQAAPNM    ZAPNM
     C                     Z-ADDCFXR      ZAVFX
     C                     Z-ADDA6NBDP    ZNMCD
     C                     Z-ADDPNPCDP    ZPTCD
     C                     EXSR ZFXAPN
     C                     Z-ADDZFXAP     QAFXAP
     C*
     C                     END
     C*
     C           WWNOML    IFEQ CSNL
     C                     Z-ADD*ZEROS    QAAPNM
     C                     Z-ADD*ZEROS    QAAYNM
     C                     Z-ADD*ZEROS    QAFXAP
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR                           ** #P04 ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #P05           -  price changes processing
     C**
     C**   CALLED BY #P02 -  detail processing
     C**
     C**   CALLS ZAPNUM   -  calculate AP numerator
     C**         ZAYNUM   -  calculate AY numerator
     C**         ZFXAPN   -  calculate FX AP numerator
     C**
     C*=========================================================================
     C*
     C           #P05      BEGSR                           ** #P05 BEGSR *
     C*                                                                   059983
     C** IF ONLY AVERAGE PRICE RESET CALCULATE CURRENT AVERAGE FX      TOR059983
     C** RATE FOR THE POSITION USING SR/ZFXAVP                         TOR059983
     C           CSAP      IFNE *ZEROS                                    059983
     C           CAVR      ANDEQ0                                         059983
     C                     Z-ADDQAAPNM    ZAPNM                           059983
     C                     Z-ADDQAFXAP    ZFXAP                           059983
     C                     Z-ADDA6NBDP    ZNMCD                           059983
     C                     Z-ADDPNPCDP    ZPTCD                           059983
     C                     EXSR ZFXAVP                                    059983
     C                     Z-ADDZAVFX     WWBFXR 138                      059983
     C                     END                                            059983
     C*                                                                   059983
     C** IF CHANGE OF AVERAGE PRICE CALCULATE NEW AP NUMERATOR            059983
     C*
     C           CSAP      IFNE *ZEROS
     C*
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCSAP      ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     MOVE SPBS      ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     QAAPNM
     C*
     C*                                                                   059983
     C** IF FX AVERAGE PRICE HAS NOT CHANGED CALCULATE NEW FX AP          059983
     C** NUMERATOR                                                        059983
     C           CAVR      IFEQ 0                                         059983
     C                     Z-ADDQAAPNM    ZAPNM                           059983
     C                     Z-ADDWWBFXR    ZAVFX                           059983
     C                     Z-ADDA6NBDP    ZNMCD                           059983
     C                     Z-ADDPNPCDP    ZPTCD                           059983
     C                     EXSR ZFXAPN                                    059983
     C                     Z-ADDZFXAP     QAFXAP                          059983
     C                     END                                            059983
     C*                                                                   059983
     C                     END
     C*
     C** IF CHANGE OF YIELD CALCULATE NEW AVERAGE YIELD NUMERATOR         059983
     C           CYLD      IFNE *ZEROS
     C*
     C                     Z-ADDQANOML    ZNOML
     C                     Z-ADDCYLD      ZAVYD
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDA6NBDP    ZNMCD
     C                     EXSR ZAYNUM
     C                     Z-ADDZVALU     QAAYNM
     C*
     C                     END
     C*
     C** IF CHANGE OF AVERAGE FX RATE CALCULATE NEW FX AP NUMERATOR       059983
     C           CAVR      IFNE *ZEROS
     C*
     C                     Z-ADDQAAPNM    ZAPNM
     C                     Z-ADDCAVR      ZAVFX
     C                     Z-ADDA6NBDP    ZNMCD
     C                     Z-ADDPNPCDP    ZPTCD
     C                     EXSR ZFXAPN
     C                     Z-ADDZFXAP     QAFXAP
     C*
     C                     END
     C*
     C                     ENDSR                           ** #P05 ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C********************************************************************B08253
     C**                                                                  B08253
     C**   #P06           -  Remove mature / flat positions               B08253
     C**                                                                  B08253
     C**   CALLED BY #W01 -  Write position details                       B08253
     C**                                                                  B08253
     C**   CALLS                                                          B08253
     C**                                                                  B08253
     C*===================================================================B08253
     C*                                                                   B08253
     C           #P06      BEGSR                           ** #P06 BEGSR *B08253
     C*                                                                   B08253
     C** Set up key fields and check whether flat positions exist for     B08253
     C** portfolio                                                        B08253
     C                     MOVE QACNUM    QFCNUM                          B08253
     C                     MOVE QAPTFR    QFPTFR                          B08253
     C                     MOVE QATDSS    QFTDSS                          B08253
     C*                                                                   B08253
     C           MFHLKY    CHAINPMMFHLL2             60                   B08253
     C           *IN60     IFEQ '0'                                       B08253
     C           QANOML    IFNE 0                                         078956
     C           QAOTNM    ORNE 0                                         078956
     C                     DELETPMHOLDP0                                  B08253
     C                     ELSE                                           078956
     C                     Z-ADDWWECD     QFDXTR                          078956
     C                     UPDATPMHOLDP0                                  078956
     C                     END                                            078956
     C                     END                                            B08253
     C*                                                                   B08253
     C** Check whether record exists for '9998' portfolio                 B08253
     C                     MOVE '9998'    QFPTFR                          B08253
     C*                                                                   B08253
     C           MFHLKY    CHAINPMMFHLL2             60                   B08253
     C           *IN60     IFEQ '0'                                       B08253
     C           QANOML    IFNE 0                                         078956
     C           QAOTNM    ORNE 0                                         078956
     C                     DELETPMHOLDP0                                  B08253
     C                     ELSE                                           078956
     C                     Z-ADDWWECD     QFDXTR                          078956
     C                     UPDATPMHOLDP0                                  078956
     C                     END                                            078956
     C                     END                                            B08253
     C*                                                                   B08253
     C** Check whether record exists for '9999' portfolio                 B08253
     C                     MOVE '9999'    QFPTFR                          B08253
     C*                                                                   B08253
     C           MFHLKY    CHAINPMMFHLL2             60                   B08253
     C           *IN60     IFEQ '0'                                       B08253
     C           QANOML    IFNE 0                                         078956
     C           QAOTNM    ORNE 0                                         078956
     C                     DELETPMHOLDP0                                  B08253
     C                     ELSE                                           078956
     C                     Z-ADDWWECD     QFDXTR                          078956
     C                     UPDATPMHOLDP0                                  078956
     C                     END                                            078956
     C                     END                                            B08253
     C*                                                                   B08253
     C                     ENDSR                           ** #P05 ENDSR *B08253
     C*                                                                   B08253
     C*************************************************************************
      /EJECT
     C**************************************************************************
     C*                                                                        *
     C*  ZAPNUM - CALCULATE AP NUMERATOR                                       *
     C*                                                                        *
     C*  PURPOSE : TO MULTIPLY A NOMINAL POSITION BY THE PRICE OF THE          *
     C*  POSITION TO GIVE A VALUE OF THE POSITION WITH THE CORRECT NUMBER      *
     C*  OF DECIMAL PLACES FOR THE NOMINAL CURRENCY                            *
     C*                                                                        *
     C*  INPUT  FIELDS                                                         *
     C*       ZNOML  11 0     NOMINAL                                          *
     C*       ZAVPR  15 8     AVERAGE PRICE                                    *
     C*       ZNMDP   1 0     NOMINAL DECIMAL PLACES (0-4)                     *
     C*       ZNMCD   1 0     NOMINAL CURRENCY DECIMAL PLACES (0-3)            *
     C*       ZPRCB   1 A     PRICE BASIS (P/U)                                *
     C*                                                                        *
     C*  OUTPUT  FIELDS                                                        *
     C*       ZVALU  15 0     VALUE                                            *
     C*                                                                        *
     C*  ALSO REQUIRED                                                         *
     C*       POWER8 ARRAY OF MULTIPLYING FACTORS FOR NOMINAL DECIMAL PLACES   *
     C*                                                                        *
     C*  WORK FIELDS:                                                          *
     C*       ZVAL0  15 0 - AVERAGE PRICE WITH 0 DECIMAL PLACES                *
     C*       ZVAL1  15 1 - --------------- '' ----------------                *
     C*       ZVAL2  15 2 - --------------- '' ----------------                *
     C*       ZVAL3  15 3 - --------------- '' ----------------                *
     C*       ZI      1 0 - POWER ARRAY                                        *
     C*                                                                        *
     C*  CALLED FROM:                                                          *
     C*                                                                        *
     C*************************************************************************
     C           ZAPNUM    BEGSR                           *** ZAPNUM ***
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDZNOML     ZNOML  110
     C                     Z-ADDZAVPR     ZAVPR  158
     C                     Z-ADDZNMDP     ZNMDP   10
     C                     Z-ADDZNMCD     ZNMCD   10
     C                     MOVE ZPRCB     ZPRCB   1
     C                     Z-ADDZVALU     ZVALU  150
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 0
     C           ZNMCD     IFEQ 0
     C           ZNOML     MULT ZAVPR     ZVAL0  150H
     C                     MOVE ZVAL0     ZVALU
     C                     END
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 1
     C           ZNMCD     IFEQ 1
     C           ZNOML     MULT ZAVPR     ZVAL1  151H
     C                     MOVE ZVAL1     ZVALU
     C                     END
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 2
     C           ZNMCD     IFEQ 2
     C           ZNOML     MULT ZAVPR     ZVAL2  152H
     C                     MOVE ZVAL2     ZVALU
     C                     END
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 3
     C           ZNMCD     IFEQ 3
     C           ZNOML     MULT ZAVPR     ZVAL3  153H
     C                     MOVE ZVAL3     ZVALU
     C                     END
     C*
     C** SET INDEX ZI EQUAL TO 5 -. NOMINAL DECIMAL PLACES )
     C           5         SUB  ZNMDP     ZI      10
     C*
     C** MULTIPLY ZVALU BY  POWER8,ZI TO GET AMOUNT WITH NOMINAL DECIMAL PLACES
     C           ZVALU     MULT POWER8,ZI ZVALU
     C*
     C** PRICE BASIS IF = PERCENTAGE
     C           ZPRCB     IFEQ 'P'
     C           ZVALU     DIV  100       ZVALU     H
     C                     END
     C*
     C                     ENDSR
     C*************************************************************************
      /EJECT
     C**************************************************************************
     C*                                                                        *
     C*  ZAYNUM - CALCULATE AY NUMERATOR                                       *
     C*                                                                        *
     C*  PURPOSE : TO MULTIPLY A NOMINAL POSITION BY THE YIELD ON THE          *
     C*  POSITION TO GIVE A 'YIELD' VALUE OF THE POSITION WITH THE CORRECT     *
     C*  NUMBER OF DECIMAL PLACES FOR THE NOMINAL CURRENCY                     *
     C*                                                                        *
     C*  INPUT  FIELDS                                                         *
     C*       ZNOML  11 0     NOMINAL                                          *
     C*       ZAVYD  11 7     AVERAGE YIELD                                    *
     C*       ZNMDP   1 0     NOMINAL DECIMAL PLACES (0-4)                     *
     C*       ZNMCD   1 0     NOMINAL CURRENCY DECIMAL PLACES (0-3)            *
     C*                                                                        *
     C*  OUTPUT  FIELDS                                                        *
     C*       ZVALU  15 0     VALUE                                            *
     C*                                                                        *
     C*  ALSO REQUIRED                                                         *
     C*       POWER8 ARRAY OF MULTIPLYING FACTORS FOR NOMINAL DECIMAL PLACES   *
     C*                                                                        *
     C*  WORK FIELDS:                                                          *
     C*       ZVAL0  15 0 - AVERAGE YIELD WITH 0 DECIMAL PLACES                *
     C*       ZVAL1  15 1 - --------------- '' ----------------                *
     C*       ZVAL2  15 2 - --------------- '' ----------------                *
     C*       ZVAL3  15 3 - --------------- '' ----------------                *
     C*       ZI      1 0 - POWER ARRAY                                        *
     C*                                                                        *
     C*  CALLED FROM:                                                          *
     C*                                                                        *
     C*************************************************************************
     C           ZAYNUM    BEGSR                           *** ZAYNUM ***
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDZNOML     ZNOML  110
     C                     Z-ADDZAVYD     ZAVYD  117
     C                     Z-ADDZNMDP     ZNMDP   10
     C                     Z-ADDZNMCD     ZNMCD   10
     C                     Z-ADDZVALU     ZVALU  150
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 0
     C           ZNMCD     IFEQ 0
     C           ZNOML     MULT ZAVYD     ZVAL0  150H
     C                     MOVE ZVAL0     ZVALU
     C                     END
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 1
     C           ZNMCD     IFEQ 1
     C           ZNOML     MULT ZAVYD     ZVAL1  151H
     C                     MOVE ZVAL1     ZVALU
     C                     END
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 2
     C           ZNMCD     IFEQ 2
     C           ZNOML     MULT ZAVYD     ZVAL2  152H
     C                     MOVE ZVAL2     ZVALU
     C                     END
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 3
     C           ZNMCD     IFEQ 3
     C           ZNOML     MULT ZAVYD     ZVAL3  153H
     C                     MOVE ZVAL3     ZVALU
     C                     END
     C*
     C** SET INDEX ZI EQUAL TO 5 -. NOMINAL DECIMAL PLACES )
     C           5         SUB  ZNMDP     ZI      10
     C*
     C** MULTIPLY ZVALU BY  POWER8,ZI TO GET AMOUNT WITH NOMINAL DECIMAL PLACES
     C           ZVALU     MULT POWER8,ZI ZVALU
     C*
     C                     ENDSR
     C*************************************************************************
      /EJECT
     C**************************************************************************
     C*                                                                        *
     C*  ZFXAPN - CALCULATE FX AP NUMERATOR                                    *
     C*                                                                        *
     C*  PURPOSE : TO CALCULATE AN FX AP NUMERATOR  (NOMINAL X FX RATE)        *
     C*                                                                        *
     C*  INPUT  FIELDS                                                         *
     C*       ZAPNM  15 0     AP (AVERAGE PRICE) NUMERATOR                     *
     C*       ZAVFX  13 8     FX RATE                                          *
     C*       ZNMCD   1 0     NOMINAL CURRENCY DECIMAL PLACES (0-3)            *
     C*       ZPTCD   1 0     PORTFOLIO CURRENCY DECIMAL PLACES (0-3)          *
     C*                                                                        *
     C*  OUTPUT  FIELDS                                                        *
     C*       ZFXAP  15 0     FX AP NUMERATOR                                  *
     C*                                                                        *
     C*  ALSO REQUIRED                                                         *
     C*       POWER8 ARRAY    ARRAY FOR CURRENCY CONVERSIONS                   *
     C*                                                                        *
     C*  WORK FIELDS:                                                          *
     C*       ZVAL0  15 0     FIELDS FOR CURRENCY CONVERSIONS                  *
     C*       ZVAL1  15 1                                                      *
     C*       ZVAL2  15 2                                                      *
     C*       ZVAL3  15 3                                                      *
     C*       ZI      1 0     INDEX TO POWER ARRAY                             *
     C*                                                                        *
     C*  CALLED FROM:                                                          *
     C*                                                                        *
     C**************************************************************************
     C           ZFXAPN    BEGSR                           *** ZFXAPN ***
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDZAPNM     ZAPNM  150
     C                     Z-ADDZAVFX     ZAVFX  138
     C                     Z-ADDZNMCD     ZNMCD   10
     C                     Z-ADDZPTCD     ZPTCD   10
     C                     Z-ADDZFXAP     ZFXAP  150
     C*
     C** IF NUMBER OF PORTFOLIO  CURRENCY DECIMAL PLACES I = 0
     C           ZPTCD     IFEQ 0
     C           ZAPNM     MULT ZAVFX     ZVAL0  150H
     C                     MOVE ZVAL0     ZFXAP
     C                     END
     C*
     C** IF NUMBER OF PORTFOLIO CURRENCY DECIMAL PLACES I = 1
     C           ZPTCD     IFEQ 1
     C           ZAPNM     MULT ZAVFX     ZVAL1  151H
     C                     MOVE ZVAL1     ZFXAP
     C                     END
     C*
     C** IF NUMBER OF PORTFOLIO CURRENCY DECIMAL PLACES I = 2
     C           ZPTCD     IFEQ 2
     C           ZAPNM     MULT ZAVFX     ZVAL2  152H
     C                     MOVE ZVAL2     ZFXAP
     C                     END
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 3
     C           ZPTCD     IFEQ 3
     C           ZAPNM     MULT ZAVFX     ZVAL3  153H
     C                     MOVE ZVAL3     ZFXAP
     C                     END
     C*
     C** SET INDEX ZI EQUAL TO 5 -. NOMINAL CURRENCY DECIMAL PLACES )
     C           5         SUB  ZNMCD     ZI      10
     C*
     C** MULTIPLY ZFXAP BY  POWER8,ZI
     C           ZFXAP     MULT POWER8,ZI ZFXAP     H
     C*
     C**
     C                     ENDSR
     C**************************************************************************
      /EJECT
      /COPY ZSRSRC,ZLCDZ1                                                                   MD057247
      /EJECT
      /COPY ZSRSRC,ZDATE1Z2
      /EJECT
      /COPY ZSRSRC,ZDATE2Z2
      /EJECT
      /COPY ZSRSRC,ZFXAVP                                                 059983
      /EJECT                                                              059983
     C**************************************************************************
     C**
     C**   #INIT     - to initialize static fields and access bank details
     C**
     C**   CALLED BY - main processing
     C**
     C**   CALLS
     C**
     C*=========================================================================
     C*
     C           #INIT     BEGSR                           * #INIT BEGSR *
     C*
     C**   Define work fields
     C           *LIKE     DEFN CSCN      WWCSCN           Customer
     C           *LIKE     DEFN PTFR      WWPTFR           Portfolio
     C           *LIKE     DEFN CSSC      WWCSSC           Security
     C           *LIKE     DEFN CSDA      WWCSDA           Action date
     C           *LIKE     DEFN NMCY      WWNMCY           Nominal ccy
     C           *LIKE     DEFN NMDP      WWNMDP           Ccy dec. pl.
     C           *LIKE     DEFN PNPTCY    WWPTCY           Portfolio ccy
     C           *LIKE     DEFN PNPCDP    WWPCDP           Ccy dec. pl.
     C           *LIKE     DEFN A6NBDP    WWNBDP           Ccy dec. pl.
     C           *LIKE     DEFN CSTB      WWCAPN           AP numerator
     C           *LIKE     DEFN CSTB      WWCAYN           AY numerator
     C           *LIKE     DEFN QANOML    WWNOML           Position nominal
     C           *LIKE     DEFN QANOML    WWNOMA           Pos. nom. (abs.)
     C*
     C                     Z-ADD*ZEROS    WWCNTA  50
     C*
     C**   Initialize database error fields
     C           *NAMVAR   DEFN           LDA                             S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     MOVE *BLANKS   DBLOT
     C                     MOVEL'PM1110'  DBPGM
     C                     OUT  LDA                                       S01486
     C*
     C**   Access bank details to get run date
     C***********          READ SDBANKL1                 72*ON=NOT THERE  S01486
     C                     CALL 'AOBANKR0'                                S01486
     C                     PARM '*MSG   ' @RTCD   7                       S01486
     C                     PARM '*FIRST ' @OPTN   7                       S01486
     C           SDBANK    PARM SDBANK    DSFDY                           S01486
     C*
     C************IN72     IFEQ '1'                                       S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD01        DBASE            ***************
     C***********          MOVEL'SDBANKL1'DBFILE           * DB ERROR 01 *S01486
     C                     MOVEL'SDBANKPD'DBFILE           * DB ERROR 01 *S01486
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C*
     C**   Check system date format, DDMMYY or MMDDYY.
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98            ** MMDDYY **
     C                     END
     C*                                                                   B08253
     C**   Obtain portfolio management ICD                                B08253
     C***********          READ SDPORTPD           72*ON=NOT THERE  B08253S01486
     C                     CALL 'AOPORTR0'                                S01486
     C                     PARM '*MSG   ' @RTCD   7                       S01486
     C                     PARM '*FIRST ' @OPTN   7                       S01486
     C           SDPORT    PARM SDPORT    DSFDY                           S01486
     C*                                                                   B08253
     C************IN72     IFEQ '1'                                 B08253S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD21        DBASE            ***************B08253
     C                     MOVEL'SDPORTPD'DBFILE           * DB ERROR 21 *B08253
     C                     MOVE *BLANKS   DBKEY            ***************B08253
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR                                     B08253
     C                     END                                            B08253
     C*                                                                   078956
     C** DEFINE DATA AREA PMSTAT                                          078956
     C           *NAMVAR   DEFN           PMSTAT                          078956
     C                     IN   PMSTAT                                    078956
     C*                                                                   CPB001
     C**   Access module details                                          CPB001
     C                     CALL 'AOMMODR0'                                CPB001
     C                     PARM *BLANKS   @RTCD   7                       CPB001
     C                     PARM '*FIRST ' @OPTN   7                       CPB001
     C           SDMMOD    PARM SDMMOD    DSFDY                           CPB001
     C*                                                                   CPB001
     C           @RTCD     IFNE *BLANKS                                   CPB001
     C           *LOCK     IN   LDA                                       CPB001
     C                     Z-ADD66        DBASE            ***************CPB001
     C                     MOVEL'SDMMODPD'DBFILE           * DB ERROR 66 *CPB001
     C                     MOVE *BLANKS   DBKEY            ***************CPB001
     C                     OUT  LDA                                       CPB001
     C                     EXSR *PSSR                                     CPB001
     C                     ENDIF                                          CPB001
      *                                                                                     MD057247
      ** Access Switchable Features file to determine if CSE031 is                          MD057247
      ** installed in the system.                                                           MD057247
      *                                                                                     MD057247
     C                     CALL 'AOSARDR0'                                                  MD057247
     C                     PARM           URTNCD  7                                         MD057247
     C                     PARM '*VERIFY' UOPTN   7                                         MD057247
     C                     PARM 'CSE031'  UUKEY   6                                         MD057247
     C                     PARM           UDSFDY 76                                         MD057247
      *                                                                                     MD057247
     C                     MOVE 'N'       CSE031  1                                         MD057247
     C           URTNCD    IFEQ *BLANKS                                                     MD057247
     C                     MOVE 'Y'       CSE031                                            MD057247
     C                     ENDIF                                                            MD057247
      *                                                                                     MD057247
      ** Access Switchable Features file to determine if CSE071 is                          MD057247
      ** installed in the system.                                                           MD057247
      *                                                                                     MD057247
     C                     CALL 'AOSARDR0'                                                  MD057247
     C                     PARM           URTNCD                                            MD057247
     C                     PARM '*VERIFY' UOPTN                                             MD057247
     C                     PARM 'CSE071'  UUKEY                                             MD057247
     C                     PARM           UDSFDY                                            MD057247
      *                                                                                     MD057247
     C                     MOVE 'N'       CSE071  1                                         MD057247
     C           URTNCD    IFEQ *BLANKS                                                     MD057247
     C                     MOVE 'Y'       CSE071                                            MD057247
     C                     ENDIF                                                            MD057247
     C*
     C                     ENDSR                           * #INIT ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   #FINAL    - final processing
     C**
     C**   CALLED BY - main processing
     C**
     C**   CALLS
     C**
     C*=========================================================================
     C*
     C           #FINAL    BEGSR                           * #FINAL BEGSR*
     C*
     C                     READ PMCPOSZ0                 72*ON=NOT THERE
     C*
     C           *IN72     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD06        DBASE            ***************
     C***********          MOVEL'PMCPOSZZ'DBFILE           * DB ERROR 06 *S01486
     C                     MOVEL'PMCPOSPA'DBFILE           * DB ERROR 06 *S01486
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C*
     C                     ADD  WWCNTA    QANORE
     C                     UPDATPMCPOSZ0
     C*
     C                     Z-ADDWWCNTA    R1NORE
     C                     Z-ADDQANORE    R2NORE
     C*
     C           WWTVDA    IFEQ 'T'
     C                     MOVE 'TRADE'   RRNARR
     C                     ELSE
     C                     MOVE 'VALUE'   RRNARR
     C                     END
     C*
     C                     WRITEAUDIT
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR                           * #FINAL ENDSR*
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C**   *PSSR          -  file exception error handling subroutine
     C**
     C**   CALLED BY #BA  -  access portfolio details
     C**             #BB  -  access seurity details
     C**             #A   -  initial processing
     C**
     C**   CALLS
     C**
     C*=========================================================================
     C           *PSSR     BEGSR                           * *PSSR BEGSR *
     C*
     C           WWERRO    IFEQ ' '
     C                     MOVE 'Y'       WWERRO  1
     C*
     C           DBASE     IFNE 0
     C*
     C**  PRINT ERROR MESSAGE:
     C                     WRITEERRORAU
     C                     ELSE
     C                     Z-ADD999       DBASE
     C                     END
     C*
     C                     DUMP
     C                     END
     C*
     C                     MOVE '1'       *INLR
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     RETRN
     C*
     C                     ENDSR                           * *PSSR ENDSR *
     C*
     C**************************************************************************
      /EJECT
     C**************************************************************************
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  CPY@
(c) Finastra International Limited 2001
