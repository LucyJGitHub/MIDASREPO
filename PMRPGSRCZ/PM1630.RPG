     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas PM Performance analysis')                        *
      *****************************************************************
      *                                                               *
      *       MIDAS  PORTFOLIO MANAGEMENT                             *
      *                                                               *
      *       PM1630 - PORTFOLIO PERFORMANCE ANALYSIS                 *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. CGL165             Date 17Feb15               *
      *  Prev Amend No. CLE134             Date 01Aug12               *
      *                 CLE148             Date 23Jul12               *
      *                 CER059             Date 19Jul10               *
      *                 CER020             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 CPK027             Date 17Apr07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 241147             Date 26Oct06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 091999             Date 17Aug95               *
      *                 CPM005             Date 12Jul96               *
     F*                 CFF004             DATE 10SEP96                  *
     F*                 103072             DATE 25JUN96                  *
     F*                 078956             DATE 31JAN96               *
     F*                 075998             DATE 20DEC95               *
     F*                 CPM004             DATE 04MAR96               *
     F*                 094693             DATE 18OCT95               *
     F*                 092961             DATE 02OCT95               *
     F*                 082662             DATE 02OCT95               *
     F*                       085862            DATE 15MAR95             *
     F*                       081502            DATE 06JAN95             *
     F*                       081348            DATE 21DEC94             *
     F*                       S01486            DATE 29NOV94             *
     F*                       73300             DATE 08SEP94             *
     F*                       72605             DATE 27/06/94            *
     F*                       72242             DATE 14/06/94            *
     F*                       53103             DATE 26/11/93            *
     F*                                                                  *
      *---------------------------------------------------------------*
      *                                                               *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CLE134 - Past Due Call Loan Processing (Recompile)           *
      *  CLE148 - Alpha Loan Reference                                *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus                                          *
      *  CPK027 - Errors in compiling MP1_3_TTTS - recompile over     *
      *           changed FFTVCLZ2.                                   *
      *  241147 - Recompile.                                          *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CPK015 - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed FFYTOPZ1.                    *
     F*  091999 - PBFG/3 SHOULD ONLY APPLY FOR VALUE DATE ACCOUNTING. *
     F*  CPM005 - Private Banking Phase 2  (Includes 091999)          *
     F*           Focus Group Changes upgraded to DBA                 *
     F*           PBFG/2 - CALCULATE & REPORT PERF. FOR ALL CUST.PORT *
     F*           PBFG/3 - DISLPAY UNREALISED P&L ON FORWARD SE TRADES*
     F*  CFF004 - Increase in size of Price Fields,(Recompiled Only)     *
     F* 103072  - wrong interest calculation for ex-coupon               *
     F*           modify fix 78956                                       *
     F*  078956 - Fixes for ex-coupon figs, output event ref for FX      *
     F*           deals and calculations for reversed positions          *
     F*  075998 - Portfolio/Future & Options performance                 *
     F*  CPM004 - Bank Portfolios                                     *
     F*  094693 - ACCNT's key is now split due to branch so use          *
     F*           external file description                              *
     F*  092961 - Define ACCNT with correct length                       *
     F*         - Recompile pgm over amended /COPY SR ZSETAC             *
     F*  082662 - Recompiled over printer file                           *
     F*  085862 - ACCOUNT CODE TO ALSO CONTAIN BRANCH                    *
     F*  081502 - Parameter missing                                      *
     F*  081348 - Amend for ZSETAC subroutine changes                    *
     F*  S01486 - POTFOLIO MANAGEMENT UPGRADE TO RELEASE 10              *
     F*  73300  - FIELDS RESTORED IN INCORRECT PLACE. FOR DEPOT MOVT     *
     F*           CHARGES OBTAIN PSETTLEMENT CURRENCY DECIMALS           *
     F*  72605  - PROCESS 'XT' EVENTS WITH NO FX DEAL NUMBER AS GENERAL  *
     F*           CASHFLOWS IN ROUTINE #GENRA                            *
     F*  72242  - CORRECT CALCULATION OF BOOK COST OF UNEARNED INTEREST  *
     F*           FOR POSITIONS BECOMING MORE SHORT                      *
     F*         - CORRECT CALCULATION OF INTEREST EARNED FOR POSITIONS   *
     F*           GOING FROM SHORT TO LONG                               *
     F*         - USE FIELDS NMDP AND SPBS FROM PF/PMPSTCPP & PF/PMPMIMPP*
     F*  53103  - REWRITTEN FOR RECONCILIATION PROCESSING                *
     F*                                                                  *
     F********************************************************************
     F*  C R E A T I O N     P A R A M E T E R S                         *
     F*                                                                  *
     F*                                                                  *
     F********************************************************************
     F/EJECT
     F********************************************************************
     F* PORTFOLIOS REQUIRING PERFORMANCE (PREFIX QR)
     F***PMPFMRPPIF**E           K        DISK         KINFSR *PSSR       S01486
     FPMPFMRPDIF  E           K        DISK         KINFSR *PSSR          S01486
     F*
     F**BANK*DETAILS*(PREFIX*BJ)******************************************S01486
     F***SDBANKL1IF**E           K        DISK         KINFSR *PSSR       S01486
     F*
     F**PM*ICD**(PREFIX*P9)***********************************************S01486
     F***SDPORTL0IF**E           K        DISK         KINFSR *PSSR       S01486
     F*
     F**BANK*DETAILS*(PREFIX*A6)******************************************S01486
     F***SDCURRL0IF**E           K        DISK         KINFSR *PSSR       S01486
     F*
     F**CURRENT*PORTFOLIO*POSITIONS*(PREFIX*QF*RENAMED*TO*IM)*************S01486
     F* CURRENT PORTFOLIO POSITIONS (PREFIX GE RENAMED TO IM)             S01486
     F***PMPMIMPPIF**E           K        DISK         KINFSR *PSSR       S01486
     FPMPMIMPDIF  E           K        DISK         KINFSR *PSSR          S01486
     F*
     F**START*OF*MONTH*POSITIONS*(PREFIX*QF)******************************S01486
     F* START OF MONTH POSITIONS (PREFIX GF)                              S01486
     F***PMPSTCPPIF**E           K        DISK         KINFSR *PSSR       S01486
     FPMPSTCPDIF  E           K        DISK         KINFSR *PSSR          S01486
     F*
     F* PERFORMANCE TRANSACTION EVENTS (PREFIX QU)
     FPMPTRALLIF  E           K        DISK         KINFSR *PSSR
     F*
     F* PERFORMANCE TRANSACTION EVENTS (PREFIX QU)
     FPMPTRAL1IF  E           K        DISK         KINFSR *PSSR
     F            PMPTRAP0                          KRENAMEPMPTRAPX       R00631
     F*                                                                   075998
     F* PERFORMANCE TRANSACTION EVENTS (PREFIX QU)                        075998
     FPMPTRAL9IF  E           K        DISK         KINFSR *PSSR          075998
     F            PMPTRAP0                          KRENAMEPMPTRAPY       075998
     F*
     F* PERFORMANCE TRANSACTION EVENTS (PREFIX QS)
     FPMPCAALLIF  E           K        DISK         KINFSR *PSSR
     F*
     F* PERFORMANCE TRANSACTION EVENTS (PREFIX QS)
     FPMPCAAL1IF  E           K        DISK         KINFSR *PSSR
     F            PMPCAAP0                          KRENAMEPMPCAAPX
     F*
     F* PERFORMANCE TRANSACTION EVENTS (PREFIX QU)
     FPMPCAAL5IF  E           K        DISK         KINFSR *PSSR
     F            PMPCAAP0                          KRENAMEPMPCAAPY
     F*
     F* PORTFOLIO DEFINITIONS (PREFIX PN)
     F***PMPORTPPIF**E           K        DISK         KINFSR *PSSR       S01486
     FPMPORTPDIF  E           K        DISK         KINFSR *PSSR          S01486
     F*
     FINTYP   IF  E           K        DISK                               CPM003
     F                                              KINFSR *PSSR          CPM003
     F* FF Instrument Types                                               CPM003
     F** ACCOUNT DETAILS BY 15A ACCOUNT CODE. NO PREFIX
     F***ACCNT***IF  F     416 15AI     2 DISK         KINFSR *PSSR       S01486
     F*CCNT***IF**F     416 18AI     2 DISK         KINFSR *PSSR    S01486092961
     F***ACCNT***IF**F     437 18AI     2 DISK         KINFSR *PSSR 092961094693
     F*ACCNT**IF**E           K        DISK         KINFSR *PSSR   094693 CPM004
     F************ACCNTAAF                          KIGNORE        094693 CPM004
     F************ACCNTABF                          KRENAMEACCNTB1F094693 CPM004
     F************ACCNTACF                          KIGNORE        094693 CPM004
     F*
     F** ACCOUNT DETAILS BY 15N ACCOUNT NUMBER. NO PREFIX
     F***ACNUM***IF**F      47 10AI     2 DISK         KINFSR *PSSR       094693
     F*ACNUM**IF**E           K        DISK         KINFSR *PSSR   094693 CPM004
     F************ACCNTABF                          KRENAMEACCNTB2F094693 CPM004
     F*
     F***RETAIL*ICD*-**PREFIX*BM******************************************S01486
     F***SDRETLL0IF**E           K        DISK         KINFSR *PSSR       S01486
     F*
     F***SD*CUSTOMER*DETAILS*-**PREFIX*BB*********************************S01486
     F***SDCUSTL0IF**E           K        DISK         KINFSR *PSSR       S01486
     F*
     F***SE*CUSTOMER*DETAILS*-**PREFIX*BF*********************************S01486
     F***SDSECSL0IF**E           K        DISK         KINFSR *PSSR       S01486
     F*
     F***BRANCH*CODES*-**PREFIX*A8****************************************S01486
     F***SDBRCHL0IF**E           K        DISK         KINFSR *PSSR       S01486
     F*
     F* PERFORMANCE TOTALS (PREFIX QT)
     F***PMPIMTPPO***E                    DISK         KINFSR *PSSR       S01486
     FPMPIMTPDO   E                    DISK         KINFSR *PSSR          S01486
     F*
     F* PERFORMANCE AUDIT REPORT
     FPM1630AUO   E                    PRINTER      KINFSR *PSSR
     F                                              KINFDS SPOOLU         S01486
     F*
     F* PERFOMANCE ANALYSIS REPORT
     FPM1630P1O   E                    PRINTER      KINFSR *PSSR      U1
     F                                              KINFDS SPOOL          S01486
     F********************************************************************
     F*                                                                  *
     F/EJECT
     F********************************************************************
     F*                                                                  *
     F*  ID F  C  H  L    FUNCTION OF INDICATORS                         *
     F*                  ------------------------                        *
     F*                                                                  *
     F*        60 -  POSITION DELETED                                    *
     F*        61 -  ERROR ON FILE READ                                  *
     F*        62 -  ERROR ON WRITE TO PERFORMANCE ANALYSIS REPORT       *
     F*********63*-**READ*EQUAL*ON*PMPFMRPP*WITH*KEY*OF*PERFORMANCE*PD.***S01486
     F*        63 -  READ EQUAL ON PMPFMRPD WITH KEY OF PERFORMANCE PD.  *S01486
     F*********64*-**READ*EQUAL*ON*PMPMIMPP/PMPSTCPP**********************S01486
     F*        64 -  READ EQUAL ON PMPMIMPD/PMPSTCPD                     *S01486
     F*        65 -  READ EQUAL ON PMPTRALL/PMPCAALL                     *
     F*        67 -  REPORT OVERFLOW INDICATOR                           *
     F*                                                                  *
     F*        U1 -  PERFORMANCE ANLYSIS REPORT REQUIRED                 *
     F*        U7 -  DATABASE ERROR                                      *
     F*        U8 -  FILE CONTROLS ERROR                                 *
     F*                                                                  *
     F********************************************************************
     F*                                                                  *
     F/EJECT
     E********************************************************************
     E*
     E** TABLES/ARRAYS USED TO AVOID FILE ACCESS OPERATIONS
     E                    CYCD      200  3
     E                    NBDP      200  1 0
     E                    SPRT      200 13 8
     E                    MDIN      200  1
     E*
     E*    ARRAY FOR COPYRIGHT
     E                    CPY@    1   1 80
     E                    PD      1   3 16
     E****                WE      1  13 17                                72605
     E                    WE      1  14 17                                72605
     E                    PFMC       12  3
     E                    PFMS       12  3
     E                    PFMA       12 13 0
     E                    PFMT        3 12                                078956
      /COPY ZSRSRC,ZSEDITZ1
      /COPY ZSRSRC,ZDATE2Z1
      /COPY ZSRSRC,ZPOWERZ1
      /COPY ZSRSRC,ZPOWER8Z1
     E                    WWTX    1   1 20
     E*
     E********************************************************************
     E*
     E/EJECT
     I*
     I*  RENAME FIELDS FROM PMPMIMP0
     IPMPMIMP0
     I************  QFRECI                          IMRECI
     I************  QFCNUM                          IMCNUM
     I************  QFPTFR                          IMPTFR
     I************  QFINNR                          IMINNR
     I************  QFVALG                          IMVALG
     I************  QFCCY1                          IMCCY1
     I************  QFCDP1                          IMCDP1
     I************  QFCNTR                          IMCNTR
     I************  QFLIND                          IMLIND
     I************  QFTDSS                          IMTDSS
     I************  QFAMT1                          IMAMT1
     I************  QFACIS                          IMACIS
     I************  QFPLFX                          IMPLFX
     I************  QFMFXR                          IMMFXR
     I************  QFMFMD                          IMMFMD
     I************  QFMPRC                          IMMPRC
     I************  QFTRNB                          IMTRNB
     I************  QFMODI                          IMMODI
     I************  QFBYSF                          IMBYSF
     I************  QFFOIS                          IMFOIS
     I************  QFTXT2                          IMTXT2
     I************  QFDXTR                          IMDXTR
     I************  QFMFXD                          IMMFXD
     I************  QFRESH                          IMRESH
     I************  QFNMDP                          IMNMDP                72242
     I************  QFSPBS                          IMSPBS                72242
     I              GERECI                          IMRECI                S01486
     I              GECNUM                          IMCNUM                S01486
     I              GEPTFR                          IMPTFR                S01486
     I              GEINNR                          IMINNR                S01486
     I              GEVALG                          IMVALG                S01486
     I              GECCY1                          IMCCY1                S01486
     I              GECDP1                          IMCDP1                S01486
     I              GECNTR                          IMCNTR                S01486
     I              GELIND                          IMLIND                S01486
     I              GETDSS                          IMTDSS                S01486
     I              GEAMT1                          IMAMT1                S01486
     I              GEACIS                          IMACIS                S01486
     I              GEPLFX                          IMPLFX                S01486
     I              GEMFXR                          IMMFXR                S01486
     I              GEMFMD                          IMMFMD                S01486
     I              GEMPRC                          IMMPRC                S01486
     I              GETRNB                          IMTRNB                S01486
     I              GEMODI                          IMMODI                S01486
     I              GEBYSF                          IMBYSF                S01486
     I              GEFOIS                          IMFOIS                S01486
     I              GETXT2                          IMTXT2                S01486
     I              GEDXTR                          IMDXTR                S01486
     I              GEMFXD                          IMMFXD                S01486
     I              GERESH                          IMRESH                S01486
     I              GENMDP                          IMNMDP                S01486
     I              GESPBS                          IMSPBS                S01486
     I              GETKDM                          IMTKDM                075998
     I              GEMNPF                          IMMNPF                075998
     I              GETKVL                          IMTKVL                075998
     I              GEVDAT                          IMVDAT                CPM005
     I              GEMVPC                          IMMVPC                CPM005
     I              GELOIC                          IMLOIC                                    CER020
     I*
     IINTYPDF                                                             CPM003
     I*                                                                   CPM003
     I**   Selected Instrument Type details                               CPM003
     I*                                                                   CPM003
     I              CTAM                            FFCTAM                CPM003
     I              CNTT                            FFCNTT                CPM003
     I***ACCNT***NS**                                                     094693
     I***********                             2   70ZRCNUM                094693
     I***********                             8  10 ZRCCY                 094693
     I***********                            11  140ZRACOD                094693
     I***********                            15  160ZRACSQ                094693
     I***********                           401 404 ZRPTFR                092961
     I***********                           433 436 ZRPTFR          092961094693
     I***********                                                         094693
     I***ACNUM***NS*                                                      094693
     I***********                            12  170ZRCNUM                094693
     I***********                            18  20 ZRCCY                 094693
     I***********                            21  240ZRACOD                094693
     I***********                            25  260ZRACSQ                094693
     I***********                            29  31 ZRBRCA          081348094693
     I***********                            41  44 ZRPTFR                094693
     I*                                                                   094693
     I*ACCNTB1F******                                              094693 CPM004
     I**************CNUM                            ZRCNUM         094693 CPM004
     I**************CCY                             ZRCCY          094693 CPM004
     I**************ACOD                            ZRACOD         094693 CPM004
     I**************ACSQ                            ZRACSQ         094693 CPM004
     I**************BRCA                            ZRBRCA         094693 CPM004
     I**************PTFR                            ZRPTFR         094693 CPM004
     I*                                                                   094693
     I*ACCNTB2F*****                                               094693 CPM004
     I**************CNUM                            ZRCNUM         094693 CPM004
     I**************CCY                             ZRCCY          094693 CPM004
     I**************ACOD                            ZRACOD         094693 CPM004
     I**************ACSQ                            ZRACSQ         094693 CPM004
     I**************BRCA                            ZRBRCA         094693 CPM004
     I**************PTFR                            ZRPTFR         094693 CPM004
     I*
     I* 15 A SETTLEMENT ACCOUNT RETURNED
     I************DS                            256                       CPM004
     I************                            1   60ZWCNUM                CPM004
     I************                            7   9 ZWCCY                 CPM004
     I************                           10  130ZWACOD                CPM004
     I************                           14  150ZWACSQ                CPM004
     I************                           16  18 ZWBRCA         S01486 CPM004
     I************                            1  15 ZWACCN                S01486
     I***********                             1  18 ZWACCN          S01486094693
     I************                            1  18 ZKACCN         081348 CPM004
     I*
     I** EXTRACT ACCOUNT CODE AND ACCOUNT SEQUENCE
     I            DS
     I***********                            12  15 WAACOD                085862
     I***********                            17  18 WAACSQ                085862
     I**********                             10  13 WAACOD                             085862 CGL029
     I**********                             14  15 WAACSQ                             085862 CGL029
     I**********                             16  18 WABRCA                             085862 CGL029
     I**********                              1  20 IMTXT2                                    CGL029
     I                                       10  19 WAACOD                                    CGL029
     I                                       20  21 WAACSQ                                    CGL029
     I                                       22  24 WABRCA                                    CGL029
     I                                        1  26 IMTXT2                                    CGL029
     I*
     I* DATA STRUCTURE FOR COMPILATION - COPYRIGHT INSERTION
     ICPYR@$      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@$$
     I*                                                                   S01486
     I* FILE INFORMATION DATA STRUCTURE                                   S01486
     ISPOOL       DS                                                      S01486
     I                                       83  92 SFILE                 S01486
     I                                    B 123 1240SFNUM                 S01486
     I*                                                                   S01486
     ISPOOLU      DS                                                      S01486
     I                                       83  92 SFILEU                S01486
     I                                    B 123 1240SFNUMU                S01486
     I*
     I* LOCAL DATA AREA FOR DATA BASE ERRORS
     I*
     I***LDA********UDS                            256                    S01486
     ILDA         DS                            256                       S01486
     I************                          132 141 DBFILE                S01486
     I                                      134 141 DBFILE                S01486
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*                                                                   S01486
     IRUNDAT    E DS                                                      S01486
     I**  Standard Data Area Layout for System flags and Run Date         S01486
     I*                                                                   S01486
     ISDBANK    E DSSDBANKPD                                              S01486
     I**  Data structure for bank details                                 S01486
     I*                                                                   S01486
     ISDSECS    E DSSDSECSPD                                              S01486
     I**  Data structure for Security Customer details                    S01486
     I*                                                                   S01486
     ISDCURR    E DSSDCURRPD                                              S01486
     I**  Data structure for currency details                             S01486
     I*                                                                   S01486
     ISDRETL    E DSSDRETLPD                                              S01486
     I              QQACCD                          QQACC1                                    CGL029
     I**  Data structure for Retail ICD                                   S01486
     I*                                                                   S01486
     ISDPORT    E DSSDPORTPD                                              S01486
     I**  Data structure for Porfolio Management ICD                      S01486
     I*                                                                   S01486
     IDSFDY     E DSDSFDY                                                 S01486
     I**  Short data structure for access objects                         S01486
     I*                                                                   S01486
     IDSSDY     E DSDSSDY                                                 S01486
     I**  Long data structure for access programs                         S01486
     I*                                                                   S01486
      /COPY ZSRSRC,ZSEDITZ2
      /COPY ZSRSRC,FFSRDSZ1                                               075998
      /COPY ZSRSRC,ZYLDZ1                                                 CPM003
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * INDEX OF SUBROUTINES                                             *
      * MAIN     - MAIN PROCESSING ROUTINE                               *
      * #INIT    - INITIAL PROCESSING                                    *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      * #DELET   - PROCESS DELETED FI, MD, ML, LE AND FX POSITIONS       *
      * #FOREX   - CALCULATE PERFORMANCE FOR FX DEALS                    *
      * #GENRA   - CALCULATE PERFORMANCE FOR GENERAL CASHFLOWS           *
      * #CLPFM   - CALCULATE PERFORMANCE FIGURES FOR LIVE NON-FX POS     *
      * #CLPOS   - CALCULATE NEW POSITIONS                               *
      * #NWUI    - CALCULATE NEW UNEARNED INTEREST & COST OF UI FIGS     *
      * #NWAPN   - CALCULATE NEW AP NUMERATOR AND FX AP NUMERATOR        *
      * #PORTD   - ACCESS PORTFOLIO DEFINITION DETAILS                   *
      * #CURRD   - ACCESS CURRENCY DETAILS                               *
      * #FMT23   - PREPARE DETAILS FOR OUTPUT TO FORMATS 2 & 3           *
      * #FMT4    - PREPARE DETAILS FOR OUTPUT TO FORMAT 4                *
      * #FMT89   - PREPARE DETAILS FOR OUTPUT TO FORMATS 8 & 9           *
      **#WRTRP***-*WRITE*DETAILS*TO*REPORT*AND*UPDATE*PMPIMTPP************S01486
      * #WRTRP   - WRITE DETAILS TO REPORT AND UPDATE PMPIMTPD           *S01486
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *
      *                                                                  *
      * EXTERNAL ROUTINES CALLED                                         *
      *                                                                  *
      ********************************************************************
     C*
     C                     MOVEACPY@      CPY2@  80
     C*
     C* INITIAL PROCESSING.
     C                     EXSR #INIT
     C*
     C***********PFMRK1    SETLLPMPFMRPP                                  S01486
     C***********PFMRK1    READEPMPFMRPP                 63               S01486
     C           PFMRK1    SETLLPMPFMRPD                                  S01486
     C           PFMRK1    READEPMPFMRPD                 63               S01486
     C*
     C** CALCULATE PERFORMANCE STATISTICS FOR ALL PORTFOLIOS
     C           *IN63     DOWEQ'0'                        B1
     C*
     C***READ*FIRST*RECORD*FROM*PF/PMPSTCPP*******************************S01486
     C** READ FIRST RECORD FROM PF/PMPSTCPD                               S01486
     C***********PSTCKY    SETLLPMPSTCPP                                  S01486
     C***********PSTCKY    READEPMPSTCPP                 70               S01486
     C           PSTCKY    SETLLPMPSTCPD                                  S01486
     C           PSTCKY    READEPMPSTCPD                 70               S01486
     C*
     C***READ*FIRST*RECORD*FOR*CURRENT*PERFORMANCE*PERIOD*FROM*PF/PMPMIMPPS01486
     C** READ FIRST RECORD FOR CURRENT PERFORMANCE PERIOD FROM PF/PMPMIMPDS01486
     C***********PMIMKY    SETLLPMPMIMPP                                  S01486
     C           PMIMKY    SETLLPMPMIMPD                                  S01486
     C           *IN71     DOUEQ'1'                        B2
     C           IMDXTR    ORGE QRPMSD
     C***********PMIMKY    READEPMPMIMPP                 71               S01486
     C           PMIMKY    READEPMPMIMPD                 71               S01486
     C                     END                             E2
     C*
     C***DO*WHILE*RECORDS*READ*FROM*PF/PMPMIMPP*OR*PF/PMPSTCPP************S01486
     C** DO WHILE RECORDS READ FROM PF/PMPMIMPD OR PF/PMPSTCPD            S01486
     C           *IN70     DOWEQ'0'                        B2
     C           *IN71     OREQ '0'
     C*                                                                   CPM005
     C           *IN71     IFEQ *OFF                       B2.1           CPM005
     C           IMVDAT    ANDNE*ZEROS                                    CPM005
     C           IMMODI    ANDEQ'SE'                                      CPM005
     C           FCTVPS    ANDEQ'V'                                       091999
     C           *IN70     OREQ *OFF                                      CPM005
     C           GFVDAT    ANDNE*ZEROS                                    CPM005
     C           GFMODI    ANDEQ'SE'                                      CPM005
     C           FCTVPS    ANDEQ'V'                                       091999
     C*                                                                   CPM005
     C                     EXSR #FOWRT                                    CPM005
     C                     ELSE                            X2.1           CPM005
     C*
     C***IF*RECORD*FOUND*ON*PF/PMPSTCPP*WHICH*DOES*NOT*EXIST*ON*PF/PMPMIMPS01486
     C** IF RECORD FOUND ON PF/PMPSTCPD WHICH DOES NOT EXIST              S01486
     C** ON PF/PMPMIMPD PERFORM DELETION PROCESSING                       S01486
     C************IN70     IFEQ '0'                        B3             078956
     C***********QFINNR    ANDLTIMINNR                                    S01486
     C***********GFINNR    ANDLTIMINNR                             S01486 078956
     C************IN70     OREQ '0'                                       078956
     C***********QFINNR    ANDEQIMINNR                                    S01486
     C***********QFRESH    ANDLTIMRESH                                    S01486
     C***********GFINNR    ANDEQIMINNR                             S01486 078956
     C***********GFRESH    ANDLTIMRESH                             S01486 078956
     C************IN70     OREQ '0'                                       078956
     C***********QFINNR    ANDEQIMINNR                                    S01486
     C***********QFRESH    ANDEQIMRESH                                    S01486
     C***********QFMODI    ANDLTIMMODI                                    S01486
     C***********GFINNR    ANDEQIMINNR                                    S01486
     C***********GFRESH    ANDEQIMRESH                             S01486 078956
     C***********GFMODI    ANDLTIMMODI                             S01486 078956
     C************IN71     OREQ '1'                                       078956
     C           *IN71     IFEQ '0'                        B3             078956
     C           *IN70     ANDEQ'0'                                       078956
     C           IMRECI    ANDEQ'R'                                       078956
     C           GFINNR    ANDEQIMINNR                                    078956
     C           GFRESH    ANDEQIMRESH                                    078956
     C           GFMODI    ANDEQIMMODI                                    078956
     C                     EXSR #DELET
     C***********PSTCKY    READEPMPSTCPP                 70               S01486
     C           PSTCKY    READEPMPSTCPD                 70               S01486
     C*                                                                   078956
     C           *IN71     DOUEQ'1'                        B4             078956
     C           IMDXTR    ORGE QRPMSD                                    078956
     C           PMIMKY    READEPMPMIMPD                 71               078956
     C                     END                             E4             078956
     C*
     C***OTHERWISE*(MATCHING*RECORDS*READ*FROM*PF/PMPMIMPP*AND*PF/PMPSTCPPS01486
     C** OTHERWISE (MATCHING RECORDS READ FROM PF/PMPMIMPD AND PF/PMPSTCPDS01486
     C                     ELSE                            X3
     C*
     C** IF AN INSTRUMENT READ WITH SECURITY/REFERENCE OF 'GENERAL
     C** CASHFLOW' PERFORM PROCESSING RELATED TO CASHFLOWS NOT ASSOCIATED
     C** WITH A SPECIFIC INSTRUMENT
     C           IMRESH    IFEQ WWTX,1                     B4
     C                     MOVE IMCCY1    WWCCYK
     C                     Z-ADDQRPMSD    WWPMSD
     C                     MOVE *LOVAL    WWPFMC
     C                     MOVE *LOVAL    WWINIO
     C*
     C           PCA1KY    SETLLPMPCAAL1
     C           PCA1K2    READEPMPCAAL1                 72
     C*
     C** OUTPUT POSITION HEADING
     C           *IN72     DOWEQ'0'                        B5
     C                     EXSR #GENRA
     C           PCA1K2    READEPMPCAAL1                 72
     C                     END                             E5
     C*
     C***REPOSITION*FILE*PORINTER*FROM*PMPSTCPP*TO*BE*AFTER*LAST*RECORD***S01486
     C***FROM*PMPMIMPP****************************************************S01486
     C** REPOSITION FILE PORINTER FROM PMPSTCPD TO BE AFTER LAST RECORD   S01486
     C** FROM PMPMIMPD                                                    S01486
     C***********PSTCGT    SETGTPMPSTCPP                                  S01486
     C           *IN71     IFEQ '0'                                       CPM005
     C           PSTCGT    SETGTPMPSTCPD                                  S01486
     C                     END                                            CPM005
     C*
     C** OTHERWISE PROCESSIN NORMAL POSITION
     C                     ELSE                            X4
     C*
     C** CHECK FOR STARTING POSITION
     C                     MOVE 'N'       WWSTRT  1
     C           *IN70     IFEQ '0'
     C***********IMINNR    ANDEQQFINNR                                    S01486
     C***********IMRESH    ANDEQQFRESH                                    S01486
     C***********IMMODI    ANDEQQFMODI                                    S01486
     C           IMINNR    ANDEQGFINNR                                    S01486
     C           IMRESH    ANDEQGFRESH                                    S01486
     C           IMMODI    ANDEQGFMODI                                    S01486
     C                     MOVE 'Y'       WWSTRT
     C                     END
     C*
     C                     EXSR #CALCN
     C*
     C***REPOSITION*FILE*PORINTER*FROM*PMPSTCPP*TO*BE*AFTER*LAST*RECORD***S01486
     C***FROM*PMPMIMPP****************************************************S01486
     C** REPOSITION FILE PORINTER FROM PMPSTCPD TO BE AFTER LAST RECORD   S01486
     C** FROM PMPMIMPD                                                    S01486
     C***********PSTCGT    SETGTPMPSTCPP                                  S01486
     C           *IN71     IFEQ '0'                                       CPM005
     C           PSTCGT    SETGTPMPSTCPD                                  S01486
     C                     END                                            CPM005
     C                     END                             E4
     C*
     C***READ*FIRST*RECORD*FROM*PF/PMPSTCPP*******************************S01486
     C** READ FIRST RECORD FROM PF/PMPSTCPD                               S01486
     C***********PSTCKY    READEPMPSTCPP                 70               S01486
     C           PSTCKY    READEPMPSTCPD                 70               S01486
     C*
     C***READ*FIRST*RECORD*FOR*CURRENT*PERFORMANCE*PERIOD*FROM*PF/PMPMIMPPS01486
     C** READ FIRST RECORD FOR CURRENT PERFORMANCE PERIOD FROM PF/PMPMIMPDS01486
     C           *IN71     DOUEQ'1'                        B4
     C           IMDXTR    ORGE QRPMSD
     C***********PMIMKY    READEPMPMIMPP                 71               S01486
     C           PMIMKY    READEPMPMIMPD                 71               S01486
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2.1           CPM005
     C                     END                             E2
     C*
     C** READ DETAILS OF NEXT PORTFOLIO REQUIRING PERFORMANCE
     C***********PFMRK1    READEPMPFMRPP                 63               S01486
     C           PFMRK1    READEPMPFMRPD                 63               S01486
     C                     END                             E1
     C*
     C** WRITE REPORT TRAILER
     C           *INU1     IFEQ '1'                        B1
     C***********WWNODE    IFEQ *BLANK                     B2
     C***********          WRITEFORMAT1                67
     C***********          END                             E2
     C           WWNODE    IFNE *BLANK                     B2             CPM005
     C                     WRITEENDRPT                 67
     C                     END                             E2             CPM005
     C                     END                             E1
     C*
     C** WRITE AUDIT REPORT
     C                     WRITEFORMTAU                67
     C                     WRITEDETLAU                 67                 S01486
     C*                                                                   S01486
     C**  Output "No details to report"                                   S01486
     C*                                                                   S01486
     C           *INU1     IFEQ '0'                                       S01486
     C                     WRITENODTLS                                    S01486
     C                     END                                            S01486
     C*
     C** END PROGRAM
     C                     MOVE '1'       *INLR
     C                     RETRN
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #INIT    - INITIAL PROCESSING                                    *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - MAIN PROCESSING ROUTINE                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWPFMP   -                                                       *
      * WWCNUM   -                                                       *
      * WWINNR   -                                                       *
      * WWCCY1   -                                                       *
      * WWCNTR   -                                                       *
      * WWLIND   -                                                       *
      * WWACOD   -                                                       *
      * WWACSQ   -                                                       *
      * WWCSHD   -                                                       *
      * WWPFMC   -                                                       *
      * WWINIO   -                                                       *
      * WWPDAT   -                                                       *
      * WWTTYP   -                                                       *
      * WWPCCY   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #INIT     BEGSR
     C*
     C** PARAMETERS RECEIVED FROM CALLING PROGRAM
     C           *ENTRY    PLIST
     C                     PARM           WWPFMP  1
     C                     PARM           WWSEQ   5                       081502
     C*
     C** FOR SUBROUTINES ZSETAC                                           S01486
     C                     MOVE *BLANKS   BRCA    3                       S01486
     C*
     C**KEY*LIST*FOR*FILE*PMPORTPP.***************************************S01486
     C* KEY LIST FOR FILE PMPORTPD.                                       S01486
     C           PORTKY    KLIST
     C                     KFLD           QRCNUM
     C                     KFLD           QRPTFR
     C*
     C**KEY*LIST*FOR*FILE*PMPFMRPP.***************************************S01486
     C* KEY LIST FOR FILE PMPFMRPD.                                       S01486
     C           PFMRK1    KLIST
     C                     KFLD           WWPFMP
     C*
     C**KEY*LIST*FOR*FILE*PMPMIMPP.***************************************S01486
     C* KEY LIST FOR FILE PMPMIMPD.                                       S01486
     C           PMIMKY    KLIST
     C                     KFLD           QRCNUM
     C                     KFLD           QRPTFR
     C*
     C**KEY*LIST*FOR*FILE*PMPSTCPP.***************************************S01486
     C* KEY LIST FOR FILE PMPSTCPD.                                       S01486
     C           PSTCKY    KLIST
     C                     KFLD           QRCNUM
     C                     KFLD           QRPTFR
     C                     KFLD           QRPMSM
     C*
     C* KEY LIST FOR FILE PMPCAALL.
     C           PCAAKY    KLIST
     C                     KFLD           IMCNUM
     C                     KFLD           IMPTFR
     C                     KFLD           IMCCY1
     C**********           KFLD           WWACOD  40                                          CGL029
     C                     KFLD           WWACOD 100                                          CGL029
     C                     KFLD           WWACSQ  20
     C                     KFLD           WWBRCA  3                       085862
     C                     KFLD           WWCSHD  50
     C                     KFLD           WWPFMC  2
     C                     KFLD           WWINIO  1
     C*
     C* KEY LIST FOR READ EQUAL ON PMPCAALL.
     C           PCAAK1    KLIST
     C                     KFLD           IMCNUM
     C                     KFLD           IMPTFR
     C                     KFLD           IMCCY1
     C**********           KFLD           WWACOD  40                                          CGL029
     C                     KFLD           WWACOD                                              CGL029
     C                     KFLD           WWACSQ  20
     C                     KFLD           WWBRCA  3                       085862
     C*
     C* KEY LIST FOR FILE PMPCAAL1.
     C           PCA1KY    KLIST
     C                     KFLD           QRCNUM
     C                     KFLD           QRPTFR
     C                     KFLD           WWCCYK  3
     C                     KFLD           WWPMSD  50
     C                     KFLD           WWPFMC
     C                     KFLD           WWINIO
     C*
     C* KEY LIST FOR READ EQUAL ON PMPCAAL1.
     C           PCA1K2    KLIST
     C                     KFLD           QRCNUM
     C                     KFLD           QRPTFR
     C                     KFLD           IMCCY1
     C*
     C* KEY LIST FOR READ EQUAL ON PMPCAAL5.
     C           PCA5K1    KLIST
     C                     KFLD           IMCNUM
     C                     KFLD           IMPTFR
     C**********           KFLD           IMTRNB                                              CLE148
     C                     KFLD           WTRNB2  60                                          CLE148
     C*
     C* KEY LIST FOR FILE PMPTRALL.
     C           PTRAKY    KLIST
     C                     KFLD           IMCNUM
     C                     KFLD           IMPTFR
     C                     KFLD           IMMODI
     C                     KFLD           IMTDSS
     C                     KFLD           IMTRNB
     C                     KFLD           WWPDAT
     C                     KFLD           WWTTYP  2
     C                     KFLD           WWPFMC  2
     C*
     C* KEY LIST FOR READ EQUAL ON PMPTRALL.
     C           PTRAK1    KLIST
     C                     KFLD           IMCNUM
     C                     KFLD           IMPTFR
     C                     KFLD           IMMODI
     C                     KFLD           IMTDSS
     C                     KFLD           IMTRNB
     C*                                                                   075998
     C* KEY LIST FOR FILE PMPTRAL9.                                       075998
     C           PTRAFE    KLIST                                          075998
     C                     KFLD           IMCNUM                          075998
     C                     KFLD           IMPTFR                          075998
     C                     KFLD           IMMODI                          075998
     C                     KFLD           IMRESH                          075998
     C                     KFLD           WWPDAT                          075998
     C                     KFLD           IMTRNB                          075998
     C                     KFLD           WWSEQN                          075998
     C                     KFLD           WWPFMC  2                       075998
     C*                                                                   075998
     C* KEY LIST FOR READ EQUAL ON PMPTRAL9.                              075998
     C           PTRAF1    KLIST                                          075998
     C                     KFLD           IMCNUM                          075998
     C                     KFLD           IMPTFR                          075998
     C                     KFLD           IMMODI                          075998
     C                     KFLD           IMRESH                          075998
     C*
     C* KEY LIST FOR FILE PMPTRAL1.
     C           PTRASE    KLIST
     C                     KFLD           IMCNUM
     C                     KFLD           IMPTFR
     C                     KFLD           IMMODI
     C                     KFLD           IMTDSS
     C                     KFLD           WWPDAT
     C                     KFLD           IMTRNB
     C                     KFLD           WWSEQN
     C                     KFLD           WWPFMC  2
     C*
     C* KEY LIST FOR READ EQUAL ON PMPTRAL1.
     C           PTRAS1    KLIST
     C                     KFLD           IMCNUM
     C                     KFLD           IMPTFR
     C                     KFLD           IMMODI
     C                     KFLD           IMTDSS
     C*
     C**KEY*LIST*FOR*SETGT*ON*PMPSTCPP.***********************************S01486
     C* KEY LIST FOR SETGT ON PMPSTCPD.                                   S01486
     C           PSTCGT    KLIST
     C                     KFLD           IMCNUM
     C                     KFLD           IMPTFR
     C                     KFLD           QRPMSM
     C                     KFLD           IMINNR
     C                     KFLD           IMRESH
     C                     KFLD           IMMODI
     C*                                                                   094693
     C***Klist*for ACCNT                                           094693 CPM004
     C***********                                                  094693 CPM004
     C***********ZWACCN    KLIST                                   094693 CPM004
     C***********          KFLD           ZWCNUM                   094693 CPM004
     C***********          KFLD           ZWCCY                    094693 CPM004
     C***********          KFLD           ZWACOD                   094693 CPM004
     C***********          KFLD           ZWACSQ                   094693 CPM004
     C***********          KFLD           ZWBRCA                   094693 CPM004
     C*                                                                   S01486
     C**  Read in DTAARA/RUNDAT to get multibranching indicator           S01486
     C*                                                                   S01486
     C           *NAMVAR   DEFN           RUNDAT                          S01486
     C                     IN   RUNDAT                                    S01486
     C           AGMBIN    IFEQ 'Y'                                       S01486
     C                     MOVE '1'       *IN39                           S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C           *NAMVAR   DEFN           LDA                             S01486
     C*
     C* INITIALISE DB ERROR FIELDS ETC, AND STORE PROGRAM NAME FOR
     C* DB ERROR FIELD.
     C*
     C           *LOCK     IN   LDA                                       S01486
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     Z-ADD*ZEROS    DBASE
     C                     MOVEL'PM1630'  DBPGM
     C           1000000000MULT 1000000   WW1015 160
     C                     OUT  LDA                                       S01486
     C*
     C**ACCESS*ICD*FILE*SDBANKL1.*****************************************S01486
     C***********                                                         S01486
     C************LOVAL    SETLLSDBANKL1                                  S01486
     C***********          READ SDBANKL1                 61               S01486
     C***********                                                         S01486
     C************IN61     IFEQ '1'                                       S01486
     C*                                                                   S01486
     C**  Get title and date using access object                          S01486
     C*                                                                   S01486
     C                     CALL 'AOBANKR0'                                S01486
     C                     PARM *BLANKS   P@RTCD  7                       S01486
     C                     PARM '*FIRST'  P@OPTN  7                       S01486
     C           SDBANK    PARM SDBANK    DSFDY                           S01486
     C*                                                                   S01486
     C**  Check if error occurred                                         S01486
     C*                                                                   S01486
     C           P@RTCD    IFNE *BLANK                                    S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD1         DBASE
     C                     MOVE *BLANKS   DBFILE           ***************
     C***********          MOVEL'SDBANKL1'DBFILE           * DBERROR 001 *S01486
     C                     MOVE 'SDBANKPD'DBFILE           * DBERROR 001 *S01486
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C*
     C** SET UP DATE FORMAT INDICATOR
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     END
     C*
     C* ACCESS PM ICD FILE SDPORTL0.
     C*
     C************LOVAL    SETLLSDPORTL0                                  S01486
     C***********          READ SDPORTL0                 61               S01486
     C***********          READ SDPORTL0                 61               S01486
     C************IN61     IFEQ '1'ORTL0                 61               S01486
     C                     CALL 'AOPORTR0'                                S01486
     C                     PARM *BLANKS   P@RTCD  7                       S01486
     C                     PARM '*FIRST'  P@OPTN  7                       S01486
     C           SDPORT    PARM SDPORT    DSFDY                           S01486
     C*                                                                   S01486
     C**  Check if error occurred                                         S01486
     C*                                                                   S01486
     C           P@RTCD    IFNE *BLANK                                    S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD41        DBASE
     C                     MOVE *BLANKS   DBFILE           ***************
     C***********          MOVEL'SDPORTL0'DBFILE           * DBERROR 001 *S01486
     C                     MOVE 'SDPORTPD'DBFILE           * DBERROR 001 *S01486
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C*
     C* Access ICD File SDRETLL0.
     C*
     C************LOVAL    SETLLSDRETLL0                                  S01486
     C***********          READ SDRETLL0                 70               S01486
     C                     CALL 'AORETLR0'                                S01486
     C                     PARM *BLANKS   P@RTCD  7                       S01486
     C                     PARM '*FIRST'  P@OPTN  7                       S01486
     C           SDRETL    PARM SDRETL    DSFDY                           S01486
     C*
     C* If Record not found - Database Error.
     C*
     C************IN70     IFEQ '1'                                       S01486
     C           P@RTCD    IFNE *BLANK                                    S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD1         DBASE
     C                     MOVE *BLANKS   DBFILE           ***************
     C***********          MOVEL'SDRETLL0'DBFILE           * DBERROR 001 *S01486
     C                     MOVE 'SDRETLPD'DBFILE           * DBERROR 001 *S01486
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C*
     C** SET UP PERFORMANCE PERIOD TEXT
     C                     MOVE WWPFMP    J       10
     C                     MOVE PD,J      RRPERD
     C*
     C** READ THROUGH SDCURRL0 SETTING UP ARRAY OF CURRENCIES
     C***********          READ SDCURRL0                 70               S01486
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*FIRST ' P@OPTN                          S01486
     C                     PARM           P@KEY   3                       081502
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C                     Z-ADD1         B       30
     C************IN70     DOWEQ'0'                                       S01486
     C           P@RTCD    DOWNE'*EOF'                                    S01486
     C                     MOVE A6CYCD    CYCD,B
     C                     Z-ADDA6SPRT    SPRT,B
     C                     MOVE A6MDIN    MDIN,B
     C                     Z-ADDA6NBDP    NBDP,B
     C                     ADD  1         B
     C***********          READ SDCURRL0                 70               S01486
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*NEXT  ' P@OPTN                          S01486
     C                     PARM           P@KEY                           081502
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C                     END
     C*                                                                   S01486
     C** Call ZSFILE for AU file                                          S01486
     C*                                                                   S01486
     C                     MOVE WWSEQ     @RSEQ   5                       081502
     C                     Z-ADDSFNUMU    ZSNUM   60                      S01486
     C                     CALL 'ZSFILE'                                  S01486
     C                     PARM           @RSEQ                           S01486
     C                     PARM *BLANKS   @PARM   3                       S01486
     C                     PARM           SFILEU                          S01486
     C                     PARM           ZSNUM                           S01486
     C                     PARM           ZSERR   1                       S01486
     C*                                                                   S01486
     C           ZSERR     IFEQ 'Y'                                       S01486
     C                     MOVE '1'       *INU7                           S01486
     C                     MOVE '1'       *INU8                           S01486
     C                     MOVE '1'       *INLR                           S01486
     C                     RETRN                                          S01486
     C                     END                                            S01486
     C*
     C                     ENDSR
     C*
      ********************************************************************
      /EJECT                                                              CPM005
      ********************************************************************CPM005
      *                                                                  *CPM005
      * #FOWRT   - UNREALISED P/L SE TRADES                              *CPM005
      *                                                                  *CPM005
      * SUBROUTINE CALLS:                                                *CPM005
      *                                                                  *CPM005
      * SUBROUTINE CALLED FROM:                                          *CPM005
      * MAIN     - MAIN PROCESSING ROUTINE                               *CPM005
      *                                                                  *CPM005
      * ROUTINE USES VARIABLES:                                          *CPM005
      *                                                                  *CPM005
      ********************************************************************CPM005
     C           #FOWRT    BEGSR                                          CPM005
     C*                                                                   CPM005
     C                     Z-ADD*ZEROS    WWFLD1 150                      CPM005
     C*                                                                   CPM005
     C**  RECORD FROM PMPSTCPD                                            CPM005
     C           *IN70     IFEQ *OFF                       B1             CPM005
     C           GFVDAT    ANDNE*ZEROS                                    CPM005
     C           GFMODI    ANDEQ'SE'                                      CPM005
     C*                                                                   CPM005
     C** IF PERFORMANCE RECONCILIATION REPORT REQUIRED SET UP DETAILS     CPM005
     C** USED IN ROUTINE #FMT23                                           CPM005
     C           *INU1     IFEQ '1'                        B2             CPM005
     C**********           Z-ADDGFCNUM    WCCNUM  60                                   CPM005 CSD027
     C                     MOVE GFCNUM    WCCNUM  6                                           CSD027
     C                     MOVE GFPTFR    WCPTFR  4                       CPM005
     C                     MOVE GFINNR    WCINNR  3                       CPM005
     C                     MOVE GFVALG    WCVALG  3                       CPM005
     C                     MOVE GFCCY1    WCCCY1  3                       CPM005
     C                     Z-ADDGFCDP1    WCCDP1  10                      CPM005
     C                     Z-ADDGFCDP1    NMDP                            CPM005
     C                     MOVE GFCNTR    WCCNTR  2                       CPM005
     C**********           Z-ADDGFLIND    WCLIND  30                                   CPM005 CER020
     C                     MOVE GFLOIC    WCLOIC  3                                           CER020
     C                     MOVE GFTDSS    WCTDSS 10                       CPM005
     C                     MOVE GFMODI    WCMODI                          CPM005
     C                     MOVE GFTXT2    WCTXT2                          CPM005
     C**********           Z-ADDGFTRNB    WCTRNB                                       CPM005 CLE148
     C                     MOVELGFTRNB    WCTRNB                                              CLE148
     C                     MOVE GFBYSF    WCBYSF                          CPM005
     C                     MOVE GFRESH    WCRESH                          CPM005
     C                     MOVE *BLANKS   WWFILE                          CPM005
     C                     Z-ADDGFMFXD    WCMFXR                          CPM005
     C                     EXSR #FMT23                                    CPM005
     C*                                                                   CPM005
     C** SET UP DETAILS USED IN SR/#FMT4                                  CPM005
     C                     Z-ADDQRPMSD    WCPDAT                          CPM005
     C**********           Z-ADDGFTRNB    WCTRNB                                       CPM005 CLE148
     C                     MOVELGFTRNB    WCTRNB                                              CLE148
     C                     MOVE *BLANKS   WCTTYP                          CPM005
     C                     MOVE *BLANKS   WCPFMC                          CPM005
     C                     MOVE *BLANKS   WCPFMS                          CPM005
     C                     MOVE GFMODI    WCMODI  2                       CPM005
     C                     MOVE *BLANKS   WCINIO                          CPM005
     C                     Z-ADD0         WCRAMT                          CPM005
     C                     MOVE GFBYSF    WCBYSF  1                       CPM005
     C                     MOVE GFTXT2    WCTXT2 20                       CPM005
     C                     MOVE 'N'       WCCPTC                          CPM005
     C                     MOVE 'N'       WCREVI                          CPM005
     C                     MOVE 'C'       WCACIN                          CPM005
     C                     MOVE 'N'       WCPPYT                          CPM005
     C                     Z-ADDGFNMDP    NMDP                            CPM005
     C                     MOVE GFSPBS    SPBS                            CPM005
     C                     Z-ADDGFAMT1    WCTAMT                          CPM005
     C                     Z-ADDGFMFXD    WCMFXR                          CPM005
     C*                                                                   CPM005
     C           SPBS      IFEQ 'U'                                       CPM005
     C                     Z-ADDGFMPRC    WCMPRC                          CPM005
     C                     ELSE                                           CPM005
     C           GFMPRC    DIV  100       WCMPRC                          CPM005
     C                     END                                            CPM005
     C*                                                                   CPM005
     C                     Z-ADD0         WCACIS 150                      CPM005
     C*                                                                   CPM005
     C                     MOVE 'S'       WWRCDT                          CPM005
     C                     EXSR #FMT4                                     CPM005
     C                     END                             E2             CPM005
     C*                                                                   CPM005
     C                     MOVE 'VS '     PFMC,1                          CPM005
     C                     MOVE *BLANKS   PFMS,1                          CPM005
     C                     Z-ADDGFMVPC    PFMA,1                          CPM005
     C*                                                                   CPM005
     C                     MOVE 'VP '     PFMC,2                          CPM005
     C                     MOVE *BLANKS   PFMS,2                          CPM005
     C                     Z-ADD*ZEROS    PFMA,2                          CPM005
     C*                                                                   CPM005
     C                     MOVE 'TU '     PFMC,3                          CPM005
     C                     MOVE *BLANKS   PFMS,3                          CPM005
     C           GFMVPC    SUB  GFPLFX    WWFLD1                          CPM005
     C                     Z-SUBWWFLD1    PFMA,3                          CPM005
     C*                                                                   CPM005
     C                     MOVE 'XTU'     PFMC,4                          CPM005
     C                     MOVE *BLANKS   PFMS,4                          CPM005
     C                     Z-SUBGFPLFX    PFMA,4                          CPM005
     C*                                                                   CPM005
     C                     EXSR #WRTRP                                    CPM005
     C*                                                                   CPM005
     C           PSTCKY    READEPMPSTCPD                 70               CPM005
     C*                                                                   CPM005
     C                     END                             E1             CPM005
     C*                                                                   CPM005
     C**  RECORD FROM PMPMIMPD                                            CPM005
     C           *IN71     IFEQ *OFF                       B1             CPM005
     C           IMVDAT    ANDNE*ZEROS                                    CPM005
     C           IMMODI    ANDEQ'SE'                                      CPM005
     C*                                                                   CPM005
     C** IF REPORT REQUIRED FORMAT DETAILS OUTPUT IN FORMATS 2 TO 3       CPM005
     C           *INU1     IFEQ '1'                        B2             CPM005
     C**********           Z-ADDIMCNUM    WCCNUM  60                                   CPM005 CSD027
     C                     MOVE IMCNUM    WCCNUM  6                                           CSD027
     C                     MOVE IMPTFR    WCPTFR  4                       CPM005
     C                     MOVE IMINNR    WCINNR  3                       CPM005
     C                     MOVE IMVALG    WCVALG  3                       CPM005
     C                     MOVE IMCCY1    WCCCY1  3                       CPM005
     C                     Z-ADDIMCDP1    WCCDP1  10                      CPM005
     C                     Z-ADDIMCDP1    NMDP                            CPM005
     C                     MOVE IMCNTR    WCCNTR  2                       CPM005
     C**********           Z-ADDIMLIND    WCLIND  30                                   CPM005 CER020
     C                     MOVE IMLOIC    WCLOIC  3                                           CER020
     C                     MOVE IMTDSS    WCTDSS 10                       CPM005
     C                     MOVE IMMODI    WCMODI                          CPM005
     C                     MOVE IMTXT2    WCTXT2                          CPM005
     C**********           Z-ADDIMTRNB    WCTRNB                                       CPM005 CLE148
     C                     MOVELIMTRNB    WCTRNB                                              CLE148
     C                     MOVE IMBYSF    WCBYSF                          CPM005
     C                     MOVE IMRESH    WCRESH                          CPM005
     C                     Z-ADDIMMFXD    WCMFXR                          CPM005
     C                     EXSR #FMT23                                    CPM005
     C*                                                                   CPM005
     C** SET UP DETAILS USED IN SR/#FMT4                                  CPM005
     C                     Z-ADDQRPMSD    WCPDAT                          CPM005
     C**********           Z-ADDIMTRNB    WCTRNB                                       CPM005 CLE148
     C                     MOVELIMTRNB    WCTRNB                                              CLE148
     C                     MOVE *BLANKS   WCTTYP                          CPM005
     C                     MOVE *BLANKS   WCPFMC                          CPM005
     C                     MOVE *BLANKS   WCPFMS                          CPM005
     C                     MOVE IMMODI    WCMODI  2                       CPM005
     C                     MOVE *BLANKS   WCINIO                          CPM005
     C                     Z-ADD0         WCRAMT                          CPM005
     C                     MOVE IMBYSF    WCBYSF  1                       CPM005
     C                     MOVE IMTXT2    WCTXT2 20                       CPM005
     C                     MOVE 'N'       WCCPTC                          CPM005
     C                     MOVE 'N'       WCREVI                          CPM005
     C                     MOVE 'C'       WCACIN                          CPM005
     C                     MOVE 'N'       WCPPYT                          CPM005
     C                     Z-ADDIMNMDP    NMDP                            CPM005
     C                     MOVE IMSPBS    SPBS                            CPM005
     C                     Z-ADDIMAMT1    WCTAMT                          CPM005
     C                     Z-ADDIMMFXD    WCMFXR                          CPM005
     C*                                                                   CPM005
     C           SPBS      IFEQ 'U'                                       CPM005
     C                     Z-ADDIMMPRC    WCMPRC                          CPM005
     C                     ELSE                                           CPM005
     C           IMMPRC    DIV  100       WCMPRC                          CPM005
     C                     END                                            CPM005
     C*                                                                   CPM005
     C                     Z-ADD0         WCACIS 150                      CPM005
     C*                                                                   CPM005
     C                     MOVE 'E'       WWRCDT                          CPM005
     C                     EXSR #FMT4                                     CPM005
     C                     END                             E2             CPM005
     C*                                                                   CPM005
     C                     Z-ADD*ZEROS    WWFLD1 150                      CPM005
     C*                                                                   CPM005
     C                     MOVE 'VE '     PFMC,1                          CPM005
     C                     MOVE *BLANKS   PFMS,1                          CPM005
     C                     Z-ADDIMMVPC    PFMA,1                          CPM005
     C*                                                                   CPM005
     C                     MOVE 'TU '     PFMC,2                          CPM005
     C                     MOVE *BLANKS   PFMS,2                          CPM005
     C           IMMVPC    SUB  IMPLFX    WWFLD1                          CPM005
     C                     Z-ADDWWFLD1    PFMA,2                          CPM005
     C*                                                                   CPM005
     C                     MOVE 'XTU'     PFMC,3                          CPM005
     C                     MOVE *BLANKS   PFMS,3                          CPM005
     C                     Z-ADDIMPLFX    PFMA,3                          CPM005
     C*                                                                   CPM005
     C                     EXSR #WRTRP                                    CPM005
     C*                                                                   CPM005
     C           *IN71     DOUEQ'1'                        B2             CPM005
     C           IMDXTR    ORGE QRPMSD                                    CPM005
     C           PMIMKY    READEPMPMIMPD                 71               CPM005
     C                     END                             E2             CPM005
     C*                                                                   CPM005
     C                     END                             E1             CPM005
     C*                                                                   CPM005
     C                     ENDSR                                          CPM005
     C*                                                                   CPM005
      ********************************************************************CPM005
      /EJECT
      ********************************************************************
      *                                                                  *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * #CURRD   - ACCESS CURRENCY DETAILS                               *
      * #PORTD   - ACCESS PORTFOLIO DEFINITION DETAILS                   *
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *
      * #FMT23   - PREPARE DETAILS FOR OUTPUT TO FORMATS 2 & 3           *
      * #FMT4    - PREPARE DETAILS FOR OUTPUT TO FORMAT 4                *
      * #CLPFM   - CALCULATE PERFORMANCE FIGURES FOR LIVE NON-FX POS     *
      * #CLPOS   - CALCULATE NEW POSITIONS                               *
      **#WRTRP***-*WRITE*DETAILS*TO*REPORT*AND*UPDATE*PMPIMTPP************S01486
      * #WRTRP   - WRITE DETAILS TO REPORT AND UPDATE PMPIMTPD           *S01486
      * #FOREX   - CALCULATE PERFORMANCE FOR FX DEALS                    *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - MAIN PROCESSING ROUTINE                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWCCY    -                                                       *
      * WWICDP   -                                                       *
      * WWISPR   -                                                       *
      * WWIMDI   -                                                       *
      * WWPRTC   -                                                       *
      * WWDELT   -                                                       *
      * WWFILE   -                                                       *
      * WWNOML   -                                                       *
      * WWAPNM   -                                                       *
      * WWFXAP   -                                                       *
      * WWUINT   -                                                       *
      * WWBKUI   -                                                       *
      * WWINNM   -                                                       *
      * WWACOD   -                                                       *
      * WWACSQ   -                                                       *
      * WWRCDT   -                                                       *
      * WWCSHD   -                                                       *
      * WWPFMC   -                                                       *
      * WWINIO   -                                                       *
      * WWPDAT   -                                                       *
      * WWTTYP   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #CALCN    BEGSR
     C*
     C                     MOVE '0'       *IN60
     C*
     C** ON CHANGE OF INSTRUMENT CURRENCY ACCESS SDCURRL0 TO OBTAIN
     C** NEW CURRENCY DETAILS
     C           IMCCY1    IFNE WSCCY1                     B1
     C                     MOVE IMCCY1    WWCCY   3
     C                     EXSR #CURRD
     C                     Z-ADDA6NBDP    WWICDP  10
     C                     Z-ADDA6SPRT    WWISPR 138
     C                     MOVE A6MDIN    WWIMDI  1
     C                     MOVE IMCCY1    WSCCY1  3
     C                     END                             E1
     C*
     C***ON*CHANGE*OF*CUSTOMER*OR*PORTFOLIO*ACCESS*PMPORTPP*AND***********S01486
     C** ON CHANGE OF CUSTOMER OR PORTFOLIO ACCESS PMPORTPD AND           S01486
     C** PREPARE DETAILS FOR OUTPUT ON REPORT
     C           IMCNUM    IFNE WSCNUM                     B1
     C           IMPTFR    ORNE WSPTFR
     C                     MOVE 'Y'       WWPRTC  1
     C                     EXSR #PORTD
     C**********           MOVE QRCNUM    WSCNUM  60                                          CSD027
     C                     MOVE QRCNUM    WSCNUM  6                                           CSD027
     C                     MOVE QRPTFR    WSPTFR  4
     C                     END                             E1
     C*
     C***SET*UP*FIELDS*USED*IN*ROUTINE*#FMT23*AND*OUTPUT*TO*PMPIMTPP******S01486
     C** SET UP FIELDS USED IN ROUTINE #FMT23 AND OUTPUT TO PMPIMTPD      S01486
     C**********           Z-ADDIMCNUM    WCCNUM  60                                          CSD027
     C                     MOVE IMCNUM    WCCNUM  6                                           CSD027
     C                     MOVE IMPTFR    WCPTFR  4
     C                     MOVE IMINNR    WCINNR  3
     C                     MOVE IMVALG    WCVALG  3
     C                     MOVE IMCCY1    WCCCY1  3
     C                     Z-ADDIMCDP1    WCCDP1  10
     C                     Z-ADDIMCDP1    NMDP
     C                     MOVE IMCNTR    WCCNTR  2
     C**********           Z-ADDIMLIND    WCLIND  30                                          CER020
     C                     MOVE IMLOIC    WCLOIC  3                                           CER020
     C                     MOVE IMTDSS    WCTDSS 10
     C                     MOVE IMMODI    WCMODI
     C                     MOVE IMTXT2    WCTXT2
     C**********           Z-ADDIMTRNB    WCTRNB                                              CLE148
     C                     MOVELIMTRNB    WCTRNB                                              CLE148
     C                     MOVE IMBYSF    WCBYSF
     C                     MOVE IMRESH    WCRESH
     C                     MOVE *BLANKS   WWFILE
     C*                                                                   075998
     C** SET NOMINAL DECIMALS TO ZERO FOR FUTURES AND OPTIONS             075998
     C           IMMODI    IFEQ 'FM'                                      075998
     C           IMMODI    OREQ 'FO'                                      075998
     C                     Z-ADD0         WCCDP1                          075998
     C                     Z-ADD0         NMDP                            075998
     C                     END                                            075998
     C*
     C** IF REPORT REQUIRED FORMAT DETAILS OUTPUT IN FORMATS 2 TO 3
     C           *INU1     IFEQ '1'                        B1
     C                     EXSR #FMT23
     C                     END                             E1
     C*
     C** RESET POSITION DETAILS TO 0
     C                     Z-ADD0         WWNOML 130
     C                     Z-ADD0         WWAPNM 130
     C                     Z-ADD0         WWFXAP 130
     C                     Z-ADD0         WWUINT 130
     C                     Z-ADD0         WWBKUI 130
     C                     Z-ADD0         WWINNM 150
     C                     Z-ADD0         WWNMEX 150
     C*
     C** IF RETAIL INSTRUMENT SET ACCOUNT CODE AND ACCOUNT SEQUENCE TO
     C** TO VALUES FROM NARRATIVE LINE 2; OTHERWISE ST TO 0
     C           WCMODI    IFEQ 'RE'                       B1
     C*                                                                   CPM005
     C           WAACOD    IFNE 'ACCO'                                    CPM005
     C**********           MOVE WAACOD    WWACOD  40                                          CGL029
     C                     MOVE WAACOD    WWACOD                                              CGL029
     C                     MOVE WAACSQ    WWACSQ  20
     C                     MOVE WABRCA    WWBRCA                          085862
     C                     ELSE                                           CPM005
     C                     Z-ADD0         WWACOD                          CPM005
     C                     Z-ADD0         WWACSQ                          CPM005
     C                     MOVE *BLANKS   WWBRCA                          CPM005
     C                     END                                            CPM005
     C*                                                                   CPM005
     C                     ELSE                            X1
     C                     Z-ADD0         WWACOD
     C                     Z-ADD0         WWACSQ
     C                     MOVE *BLANKS   WWBRCA                          085862
     C                     END                             E1
     C*
     C** MOVE DETAILS FROM START OF MONTH POSITIONS TO WORK FIELDS
     C                     Z-ADDQRPMSD    WCPDAT
     C**********           Z-ADDIMTRNB    WCTRNB                                              CLE148
     C                     MOVELIMTRNB    WCTRNB                                              CLE148
     C                     MOVE *BLANKS   WCTTYP
     C                     MOVE *BLANKS   WCPFMC
     C                     MOVE *BLANKS   WCPFMS
     C                     MOVE IMMODI    WCMODI  2
     C                     MOVE *BLANKS   WCINIO
     C                     Z-ADDWCTAMT    WCRAMT
     C                     MOVE IMBYSF    WCBYSF  1
     C                     MOVE IMTXT2    WCTXT2 20
     C                     MOVE 'N'       WCCPTC
     C                     MOVE 'N'       WCREVI
     C                     MOVE 'C'       WCACIN
     C                     MOVE 'N'       WCPPYT
     C                     Z-ADDIMNMDP    NMDP                            72242
     C                     MOVE IMSPBS    SPBS                            72242
     C*
     C** SETUP DETAILS OF STARTING POSITION IF IT EXISTED
     C           WWSTRT    IFEQ 'Y'
     C                     Z-ADDGFCDP1    WCCDP1  10                      CPM005
     C                     Z-ADDGFCDP1    NMDP                            CPM005
     C*
     C***********QFMODI    IFEQ 'LE'                                      S01486
     C***********QFMODI    OREQ 'ML'                                      S01486
     C***********QFMODI    OREQ 'RE'                                      S01486
     C           GFMODI    IFEQ 'LE'                                      S01486
     C           FCPORS    ANDNE'B'                                       CPM004
     C           GFMODI    OREQ 'ML'                                      S01486
     C           FCPORS    ANDNE'B'                                       CPM004
     C           GFMODI    OREQ 'RE'                                      S01486
     C           FCPORS    ANDNE'B'                                       CPM004
     C***********          Z-SUBQFAMT1    WCTAMT                          S01486
     C                     Z-SUBGFAMT1    WCTAMT                          S01486
     C                     ELSE
     C***********          Z-ADDQFAMT1    WCTAMT                          S01486
     C                     Z-ADDGFAMT1    WCTAMT                          S01486
     C                     END
     C*
     C***********          Z-ADDQFMFXD    WCMFXR                          S01486
     C                     Z-ADDGFMFXD    WCMFXR                          S01486
     C*
     C           SPBS      IFEQ 'U'
     C***********          Z-ADDQFMPRC    WCMPRC                          S01486
     C                     Z-ADDGFMPRC    WCMPRC                          S01486
     C                     ELSE
     C***********QFMPRC    DIV  100       WCMPRC                          S01486
     C           GFMPRC    DIV  100       WCMPRC                          S01486
     C                     END
     C*
     C           WCBYSF    IFNE *BLANKS
     C           WCMODI    ANDNE'FM'                                      075998
     C***********          Z-ADDQFPLFX    WCACIS 150                      S01486
     C                     Z-ADDGFPLFX    WCACIS 150                      S01486
     C                     ELSE
     C***********          Z-ADDQFACIS    WCACIS                          S01486
     C                     Z-ADDGFACIS    WCACIS                          S01486
     C                     END
     C*
     C** IF RECORD FOUND AND REPORT REQUIRED FORMAT DETAILS OUTPUT ON
     C** FORMAT 4
     C                     MOVE 'S'       WWRCDT  1
     C           *INU1     IFEQ '1'
     C                     EXSR #FMT4
     C                     END
     C                     END
     C*
     C** CALCULATE PERFORMANCE FIGURES FOR NON FX DEAL
     C           WCBYSF    IFEQ *BLANKS                    B1
     C           WCMODI    ANDNE'FM'                                      075998
     C*
     C** CALCULATE PERFORMANCE FIGURES FOR STARTING POSITION
     C           WWSTRT    IFEQ 'Y'                        B2
     C                     EXSR #CLPFM
     C*
     C** CALCULATE POSITION DETAILS
     C                     EXSR #CLPOS
     C*
     C** PERFORM ROUTINE TO OUTPUT PERFORMANCE ANALYSIS DETAILS
     C                     EXSR #WRTRP
     C                     END                             E2
     C*
     C                     MOVE 'T'       WWRCDT
     C*
     C** IF PROCESSING DETAILS FOR RE ACCOUNT READ FIRST CASH EVENT
     C           IMMODI    IFEQ 'RE'                       B2
     C                     Z-ADDQRPMSD    WWCSHD  50
     C                     MOVE *LOVAL    WWPFMC  2
     C                     MOVE *LOVAL    WWINIO  1
     C*
     C           PCAAKY    SETLLPMPCAALL
     C           PCAAK1    READEPMPCAALL                 65
     C*
     C                     MOVE 'PMPCAALL'WWFILE  8
     C*
     C***OTHERWISE*FOR*ALL*OTHER*TRANSACTIONS*READ*DETAILS*FROM*PMPTRAPP**S01486
     C** OTHERWISE FOR ALL OTHER TRANSACTIONS READ DETAILS FROM PMPTRAPD  S01486
     C                     ELSE                            X2
     C*
     C** FOR NON-SE TRANSACTIONS READ PMPTRALL
     C           WCMODI    IFNE 'SE'                       B3
     C           WCMODI    ANDNE'FO'                                      075998
     C                     Z-ADDQRPMSD    WWPDAT  50
     C                     MOVE *LOVAL    WWTTYP
     C                     MOVE *LOVAL    WWPFMC
     C*
     C           PTRAKY    SETLLPMPTRALL
     C           PTRAK1    READEPMPTRALL                 65
     C*
     C** FOR SE TRANSACTIONS READ PMPTRAL1
     C                     ELSE                            X3
     C*                                                                   075998
     C           WCMODI    IFEQ 'SE'                       B4             075998
     C                     Z-ADDQRPMSD    WWPDAT
     C                     MOVE *LOVAL    WWTTYP
     C                     Z-ADD*LOVAL    WWSEQN  50
     C                     MOVE *LOVAL    WWPFMC
     C*
     C           PTRASE    SETLLPMPTRAL1
     C           PTRAS1    READEPMPTRAL1                 65
     C*                                                                   075998
     C                     ELSE                            X4             075998
     C                     Z-ADDQRPMSD    WWPDAT                          075998
     C                     MOVE *LOVAL    WWTTYP                          075998
     C                     Z-ADD*LOVAL    WWSEQN  50                      075998
     C                     MOVE *LOVAL    WWPFMC                          075998
     C*                                                                   075998
     C           PTRAFE    SETLLPMPTRAL9                                  075998
     C           PTRAF1    READEPMPTRAL9                 65               075998
     C                     END                             E4             075998
     C                     END                             E3
     C*
     C                     MOVE 'PMPTRALL'WWFILE  8
     C*
     C                     END                             E2
     C*
     C** DO WHILE RECORDS READ FOR SAME POSITION
     C           *IN65     DOWEQ'0'                        B2
     C*
     C** SET UP COMMON WORKFIELDS FOR PROCESSING
     C           IMMODI    IFEQ 'RE'                       B3
     C                     MOVE QSPFMC    WCPFMC  2
     C                     MOVE QSPFMS    WCPFMS  2
     C**********           Z-ADD0         WCTRNB  60                                          CLE148
     C                     MOVEL*BLANKS   WCTRNB  6                                           CLE148
     C                     Z-ADDQSCSHD    WCPDAT  50
     C                     Z-ADDQSCSHA    WCTAMT 130
     C                     Z-ADDQSCSHA    WCRAMT 130
     C                     Z-ADDQSMFXR    WCMFXR 308
     C                     Z-ADD1         WCMPRC 158
     C                     MOVE QSINIO    WCINIO  1
     C                     MOVE QSCPTC    WCCPTC  1
     C                     MOVE 'N'       WCREVI  1
     C                     MOVE 'C'       WCACIN  1
     C                     MOVE 'N'       WCPPYT  1
     C                     MOVE 'RE'      WCMODI
     C                     Z-ADD0         WCACIS
     C                     Z-ADDQSEVRF    WCEVRF
     C*
     C           QSINIO    IFEQ 'I'                        B4
     C                     MOVE 'CR'      WCTTYP  2
     C                     ELSE                            X4
     C                     MOVE 'DR'      WCTTYP
     C                     END                             E4
     C*
     C                     ELSE                            X3
     C                     MOVE QUPFMC    WCPFMC
     C                     MOVE QUPFMS    WCPFMS
     C                     MOVE QUTTYP    WCTTYP
     C**********           Z-ADDQUTRNB    WCTRNB                                              CLE148
     C                     MOVELQUTRNB    WCTRNB                                              CLE148
     C                     Z-ADDQUPDAT    WCPDAT
     C                     Z-ADDQUTAMT    WCTAMT
     C                     Z-ADDQURAMT    WCRAMT
     C                     Z-ADDQUMPRC    WCMPRC
     C                     Z-ADDQUMFXR    WCMFXR
     C                     MOVE QUMODI    WCMODI
     C                     MOVE QUINIO    WCINIO
     C                     MOVE QUCPTC    WCCPTC
     C                     MOVE QUREVI    WCREVI
     C                     MOVE QUACIN    WCACIN
     C                     MOVE QUPPYT    WCPPYT
     C                     Z-ADD0         WCACIS
     C                     Z-ADDQUEVRF    WCEVRF
     C                     Z-ADDQUNMDP    NMDP    10
     C                     MOVE QUSPBS    SPBS    1
     C                     END                             E3
     C*
     C** CALCULATE PERFORMANCE FIGURES FOR PERFORMANCE EVENT
     C                     EXSR #CLPFM
     C*
     C** CALCULATE NEW POSITION DETAILS
     C                     EXSR #CLPOS
     C*
     C** FORMAT TRANSACTION DETAILS OUTPUT AS FORMAT4
     C           *INU1     IFEQ '1'                        B3
     C                     EXSR #FMT4
     C                     END                             E3
     C*
     C** PERFORM ROUTINE TO OUTPUT PERFORMANCE ANALYSIS DETAILS
     C                     EXSR #WRTRP
     C*
     C** READ NEXT PERFORMANCE EVENT
     C           IMMODI    IFEQ 'RE'                       B3
     C           PCAAK1    READEPMPCAALL                 65
     C                     ELSE                            X3
     C           IMMODI    IFNE 'SE'                       B4
     C           IMMODI    ANDNE'FO'                                      075998
     C           PTRAK1    READEPMPTRALL                 65
     C                     ELSE                            X4
     C           IMMODI    IFEQ 'SE'                       B5             075998
     C           PTRAS1    READEPMPTRAL1                 65
     C                     ELSE                            X5             075998
     C           PTRAF1    READEPMPTRAL9                 65               075998
     C                     END                             E5             075998
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C*
     C** IF THE POSITION IS STILL OPEN CALCULATE FIGURES OF UNREALISED
     C** P/L
     C           IMRECI    IFEQ 'D'                        B2
     C                     MOVE 'E'       WWRCDT
     C                     MOVE *BLANKS   WWFILE
     C                     Z-ADDIMCDP1    WCCDP1  10                      CPM005
     C                     Z-ADDIMCDP1    NMDP                            CPM005
     C*
     C** MOVE DETAILS FROM END OF MONTH POSITIONS TO WORK FIELDS
     C                     Z-ADDQRPMED    WCPDAT
     C**********           Z-ADDIMTRNB    WCTRNB                                              CLE148
     C                     MOVELIMTRNB    WCTRNB                                              CLE148
     C                     MOVE *BLANKS   WCTTYP
     C                     MOVE *BLANKS   WCPFMC
     C                     MOVE *BLANKS   WCPFMS
     C*
     C           IMMODI    IFEQ 'LE'
     C           FCPORS    ANDNE'B'                                       CPM004
     C           IMMODI    OREQ 'ML'
     C           FCPORS    ANDNE'B'                                       CPM004
     C           IMMODI    OREQ 'RE'
     C           FCPORS    ANDNE'B'                                       CPM004
     C                     Z-SUBIMAMT1    WCTAMT
     C                     ELSE
     C                     Z-ADDIMAMT1    WCTAMT
     C                     END
     C*
     C                     MOVE IMBYSF    WCBYSF
     C                     MOVE IMTXT2    WCTXT2
     C*
     C           IMRECI    IFEQ 'D'
     C                     Z-ADDIMMFXD    WCMFXR
     C                     END
     C*
     C           SPBS      IFEQ 'U'
     C                     Z-ADDIMMPRC    WCMPRC
     C                     ELSE
     C           IMMPRC    DIV  100       WCMPRC
     C                     END
     C*
     C                     MOVE *BLANKS   WCINIO
     C                     MOVE IMMODI    WCMODI
     C                     Z-ADDWCTAMT    WCRAMT
     C                     MOVE 'N'       WCCPTC
     C                     MOVE 'N'       WCREVI
     C                     MOVE 'C'       WCACIN
     C                     MOVE 'N'       WCPPYT
     C                     Z-ADDIMACIS    WCACIS
     C*
     C                     EXSR #CLPFM
     C*
     C** CALCULATE NEW POSITION DETAILS
     C                     EXSR #CLPOS
     C*
     C** FORMAT TRANSACTION DETAILS OUTPUT AS FORMAT4
     C           *INU1     IFEQ '1'                        B3
     C                     EXSR #FMT4
     C                     END                             E3
     C*
     C** PERFORM ROUTINE TO OUTPUT PERFORMANCE ANALYSIS DETAILS
     C                     EXSR #WRTRP
     C                     END                             E2
     C*                                                                   72242
     C** IF THE POSITION IS MATURED AND THE UNEARNED INTEREST IS NOT EQUAL72242
     C** TO ZERO PERFORM PROCESSING TO GENERATE A LOSS OF INTEREST        72242
     C           IMRECI    IFEQ 'M'                        B2             72242
     C           WWBKUI    ANDNE0                                         72242
     C           IMRECI    OREQ 'F'                                       72242
     C           WWBKUI    ANDNE0                                         72242
     C                     MOVE 'T'       WWRCDT                          72242
     C                     MOVE 'PMPTRALL'WWFILE                          72242
     C*                                                                   72242
     C** MOVE DETAILS FROM END OF MONTH POSITIONS TO WORK FIELDS          72242
     C                     MOVE 'IP'      WCPFMC                          72242
     C                     MOVE *BLANKS   WCPFMS                          72242
     C*                                                                   72242
     C           WWINNM    IFGT 0                                         72242
     C                     MOVE 'O'       WCINIO                          078956
     C                     Z-ADDWWINNM    WCRAMT                          72242
     C                     ELSE                                           72242
     C                     MOVE 'I'       WCINIO                          078956
     C                     Z-SUBWWINNM    WCRAMT                          72242
     C                     END                                            72242
     C*                                                                   72242
     C                     Z-ADD0         WCTAMT                          72242
     C                     MOVE 'C'       WCACIN                          72242
     C                     MOVE 'N'       WCPPYT                          72242
     C                     MOVE 'N'       WCREVI                          72242
     C                     Z-ADD0         WWNMEX                          72242
     C*                                                                   72242
     C                     EXSR #CLPFM                                    72242
     C*                                                                   72242
     C** FORMAT TRANSACTION DETAILS OUTPUT AS FORMAT4                     72242
     C           *INU1     IFEQ '1'                        B3             72242
     C                     EXSR #FMT4                                     72242
     C                     END                             E3             72242
     C*                                                                   72242
     C** PERFORM ROUTINE TO OUTPUT PERFORMANCE ANALYSIS DETAILS           72242
     C                     EXSR #WRTRP                                    72242
     C                     END                             E2             72242
     C*
     C** ... OTHERWISE PERFORM CALCULATIONS FOR FOREX DEAL
     C                     ELSE                            X1
     C*                                                                   075998
     C           WCMODI    IFEQ 'FX'                       B2             075998
     C                     EXSR #FOREX
     C                     ELSE                            X2             075998
     C                     EXSR #MARGN                                    075998
     C                     END                             E2             075998
     C*                                                                   075998
     C                     END                             E1
     C*
     C                     ENDSR
     C*
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #DELET   - PROCESS DELETED FI, MD, ML, LE AND FX POSITIONS       *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * #PORTD   - ACCESS PORTFOLIO DEFINITION DETAILS                   *
      * #CURRD   - ACCESS CURRENCY DETAILS                               *
      * #FMT23   - PREPARE DETAILS FOR OUTPUT TO FORMATS 2 & 3           *
      * #FMT4    - PREPARE DETAILS FOR OUTPUT TO FORMAT 4                *
      * ZCCYXR   -                                                       *
      **#WRTRP***-*WRITE*DETAILS*TO*REPORT*AND*UPDATE*PMPIMTPP************S01486
      * #WRTRP   - WRITE DETAILS TO REPORT AND UPDATE PMPIMTPD           *S01486
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - MAIN PROCESSING ROUTINE                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWDELT   -                                                       *
      * WWPRTC   -                                                       *
      * WWCCY    -                                                       *
      * WWICDP   -                                                       *
      * WWISPR   -                                                       *
      * WWIMDI   -                                                       *
      * WWRCDT   -                                                       *
      * WWPCDP   -                                                       *
      * WWPDAT   -                                                       *
      * WWTTYP   -                                                       *
      * WWPFMC   -                                                       *
      * WWTOTL   -                                                       *
      * WWAMTT   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #DELET    BEGSR
     C*
     C                     MOVE '1'       *IN60
     C*
     C***ON*CHANGE*OF*CUSTOMER*OR*PORTFOLIO*ACCESS*PMPORTPP*AND***********S01486
     C** ON CHANGE OF CUSTOMER OR PORTFOLIO ACCESS PMPORTPD AND           S01486
     C** PREPARE DETAILS FOR OUTPUT ON REPORT
     C***********QFCNUM    IFNE WSCNUM                     B1             S01486
     C***********QFPTFR    ORNE WSPTFR                                    S01486
     C           GFCNUM    IFNE WSCNUM                     B1             S01486
     C           GFPTFR    ORNE WSPTFR                                    S01486
     C                     MOVE 'Y'       WWPRTC
     C                     EXSR #PORTD
     C**********           MOVE QRCNUM    WSCNUM  60                                          CSD027
     C                     MOVE QRCNUM    WSCNUM  6                                           CSD027
     C                     MOVE QRPTFR    WSPTFR  4
     C                     END                             E1
     C*
     C** ON CHANGE OF INSTRUMENT CURRENCY ACCESS SDCURRL0 TO OBTAIN
     C** NEW CURRENCY DETAILS
     C***********QFCCY1    IFNE WSCCY1                     B1             S01486
     C           GFCCY1    IFNE WSCCY1                     B1             S01486
     C***********          MOVE QFCCY1    WWCCY   3                       S01486
     C                     MOVE GFCCY1    WWCCY   3                       S01486
     C                     EXSR #CURRD
     C                     Z-ADDA6NBDP    WWICDP  10
     C                     Z-ADDA6SPRT    WWISPR 138
     C                     MOVE A6MDIN    WWIMDI  1
     C***********          MOVE QFCCY1    WSCCY1  3                       S01486
     C                     MOVE GFCCY1    WSCCY1  3                       S01486
     C                     END                             E1
     C*
     C** MOVE DETAILS FROM START OF MONTH POSITIONS TO WORK FIELDS
     C***********          Z-ADDQFTRNB    WCTRNB                          S01486
     C**********           Z-ADDGFTRNB    WCTRNB                                       S01486 CLE148
     C                     MOVELGFTRNB    WCTRNB                                              CLE148
     C                     MOVE *BLANKS   WCTTYP
     C                     MOVE *BLANKS   WCPFMC
     C                     MOVE *BLANKS   WCPFMS
     C***********          Z-ADDQFCNUM    WCCNUM  60                      S01486
     C***********          MOVE QFPTFR    WCPTFR  4                       S01486
     C***********          MOVE QFINNR    WCINNR  3                       S01486
     C***********          MOVE QFVALG    WCVALG  3                       S01486
     C***********          MOVE QFCCY1    WCCCY1  3                       S01486
     C***********          MOVE QFCNTR    WCCNTR  2                       S01486
     C***********          Z-ADDQFLIND    WCLIND  30                      S01486
     C***********          MOVE QFTDSS    WCTDSS 10                       S01486
     C***********          MOVE QFRESH    WCRESH 20                       S01486
     C**********           Z-ADDGFCNUM    WCCNUM  60                                          CSD027
     C                     MOVE GFCNUM    WCCNUM  6                                           CSD027
     C                     MOVE GFPTFR    WCPTFR  4
     C                     MOVE GFINNR    WCINNR  3
     C                     MOVE GFVALG    WCVALG  3
     C                     MOVE GFCCY1    WCCCY1  3
     C                     MOVE GFCNTR    WCCNTR  2
     C**********           Z-ADDGFLIND    WCLIND  30                                          CER020
     C                     MOVE GFLOIC    WCLOIC  3                                           CER020
     C                     MOVE GFTDSS    WCTDSS 10
     C                     MOVE GFRESH    WCRESH 20
     C*
     C***********QFMODI    IFEQ 'LE'                                      S01486
     C***********QFMODI    OREQ 'ML'                                      S01486
     C           GFMODI    IFEQ 'LE'                                      S01486
     C           FCPORS    ANDNE'B'                                       CPM004
     C           GFMODI    OREQ 'ML'                                      S01486
     C           FCPORS    ANDNE'B'                                       CPM004
     C***********          Z-SUBQFAMT1    WCTAMT                          S01486
     C                     Z-SUBGFAMT1    WCTAMT                          S01486
     C                     ELSE
     C***********          Z-ADDQFAMT1    WCTAMT                          S01486
     C                     Z-ADDGFAMT1    WCTAMT                          S01486
     C                     END
     C*
     C                     Z-ADDQRPMSD    WCPDAT
     C*
     C***********          Z-ADDQFMFXD    WCMFXR                          S01486
     C                     Z-ADDGFMFXD    WCMFXR                          S01486
     C*
     C***********          Z-ADDQFMPRC    WCMPRC                          S01486
     C***********          MOVE QFMODI    WCMODI  2                       S01486
     C                     Z-ADDGFMPRC    WCMPRC                          S01486
     C                     MOVE GFMODI    WCMODI  2                       S01486
     C                     MOVE *BLANKS   WCINIO
     C                     Z-ADDWCTAMT    WCRAMT
     C***********          MOVE QFBYSF    WCBYSF  1                       S01486
     C***********          MOVE QFTXT2    WCTXT2                          S01486
     C                     MOVE GFBYSF    WCBYSF  1                       S01486
     C                     MOVE GFTXT2    WCTXT2                          S01486
     C                     MOVE 'N'       WCCPTC
     C                     MOVE 'N'       WCREVI
     C                     MOVE 'C'       WCACIN
     C                     MOVE 'N'       WCPPYT
     C***********          Z-ADDQFNMDP    NMDP                      72242 S01486
     C***********          MOVE QFSPBS    SPBS                      72242 S01486
     C                     Z-ADDGFNMDP    NMDP                            S01486
     C                     MOVE GFSPBS    SPBS                            S01486
     C*
     C           WCBYSF    IFNE *BLANKS                    B1
     C***********          Z-ADDQFPLFX    WCACIS 150                      S01486
     C                     Z-ADDGFPLFX    WCACIS 150                      S01486
     C                     ELSE                            X1
     C***********          Z-ADDQFACIS    WCACIS                          S01486
     C                     Z-ADDGFACIS    WCACIS                          S01486
     C                     END                             E1
     C*
     C** IF REPORT REQUIRED FORMAT DETAILS OUTPUT IN FORMATS 2 TO 3
     C           *INU1     IFEQ '1'                        B1
     C                     EXSR #FMT23
     C                     END                             E1
     C*
     C** LIVE STARTING POSITION TO BE FORMATTED FOR OUTPUT
     C***********QFEXST    IFEQ 'Y'                        B1             S01486
     C           GFEXST    IFEQ 'Y'                        B1             S01486
     C                     MOVE 'S'       WWRCDT  1
     C           *INU1     IFEQ '1'                        B2
     C                     EXSR #FMT4
     C                     END                             E2
     C                     END                             E1
     C*
     C** PERFORM CALCULATIONS FOR LOAN/DEPOSITS
     C           WCBYSF    IFEQ *BLANKS                    B1
     C***********QFEXST    IFNE 'N'                        B2             S01486
     C           GFEXST    IFNE 'N'                        B2             S01486
     C*
     C** CALCULATE VALUE AT START OF PERIOD AND SAVE IN PERFORMANCE
     C** ARRAY
     C           WCTAMT    ADD  WCACIS    ZAMTF
     C***********          Z-ADDQFMFXD    ZCRSRD                          S01486
     C                     Z-ADDGFMFXD    ZCRSRD                          S01486
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C*
     C                     MOVE 'VS '     PFMC,1
     C                     MOVE '   '     PFMS,1
     C                     Z-ADDZAMTT     PFMA,1
     C*
     C** CALCULATE PRINCIPAL INVESTED AT START OF PERIOD AND SAVE IN
     C** PERFORMANCE ARRAY
     C                     Z-ADDWCTAMT    ZAMTF
     C***********          Z-ADDQFMFXD    ZCRSRD                          S01486
     C                     Z-ADDGFMFXD    ZCRSRD                          S01486
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C*
     C                     MOVE 'VP '     PFMC,2
     C                     MOVE '   '     PFMS,2
     C                     Z-ADDZAMTT     PFMA,2
     C                     Z-ADD3         I
     C                     ELSE                            X2
     C                     Z-ADD1         I
     C                     END                             E2
     C*
     C** SET FILE POINTER BEFORE FIRST TRANSACTION RECORD
     C                     MOVE IMMODI    WXMODI  2
     C                     MOVE IMTDSS    WXTDSS 10
     C**********           MOVE IMTRNB    WXTRNB  60                                          CLE148
     C                     MOVE IMTRNB    WXTRNB  6                                           CLE148
     C***********          MOVE QFCNUM    IMCNUM                          S01486
     C***********          MOVE QFPTFR    IMPTFR                          S01486
     C***********          MOVE QFMODI    IMMODI                          S01486
     C***********          MOVE QFTDSS    IMTDSS                          S01486
     C***********          MOVE QFTRNB    IMTRNB                          S01486
     C                     MOVE GFCNUM    IMCNUM                          S01486
     C                     MOVE GFPTFR    IMPTFR                          S01486
     C                     MOVE GFMODI    IMMODI                          S01486
     C                     MOVE GFTDSS    IMTDSS                          S01486
     C                     MOVE GFTRNB    IMTRNB                          S01486
     C                     Z-ADDQRPMSD    WWPDAT
     C                     MOVE *LOVAL    WWTTYP
     C                     MOVE *LOVAL    WWPFMC
     C                     Z-ADD0         WWTOTL 150
     C*
     C           PTRAKY    SETLLPMPTRALL
     C           PTRAK1    READEPMPTRALL                 65
     C*
     C** DO WHILE RECORDS READ FOR SAME POSITION
     C           *IN65     DOWEQ'0'                        B2
     C*
     C** ONLY INCLUDE PERFORMANCE EVENTS IN THESE CALCULATIONS FOR
     C** WHICH CHANGE TO PORTFOLIO CAPITAL IS 'N'
     C           QUCPTC    IFEQ 'N'                        B3
     C*
     C** CONVERT TRANSACTION AMOUNT FROM NOMINAL TO PORTFOLIO CURRENCY
     C** USING RATE ON PERFORMANCE EVENT
     C                     Z-ADDQUTAMT    ZAMTF
     C                     Z-ADDQUMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C*
     C** DETAERMINE SIGN OF EVENT AMOUNT AS PER TABLE BELOW
     C**     ------------------------------------------------
     C**     I In/Out Indicator I Reversal Indicator I Sign I
     C**     I------------------I--------------------I------I
     C**     I       I          I         Y          I  +   I
     C**     I       I          I         N          I  -   I
     C**     I       O          I         Y          I  -   I
     C**     I       O          I         N          I  +   I
     C**     ------------------------------------------------
     C           QUINIO    IFEQ 'I'                        B4
     C*
     C           QUREVI    IFEQ 'Y'                        B5
     C                     Z-ADDZAMTT     WWAMTT 150
     C                     ELSE                            X5
     C                     Z-SUBZAMTT     WWAMTT 150
     C                     END                             E5
     C*
     C                     ELSE                            X4
     C*
     C           QUREVI    IFEQ 'Y'                        B5
     C                     Z-SUBZAMTT     WWAMTT 150
     C                     ELSE                            X5
     C                     Z-ADDZAMTT     WWAMTT 150
     C                     END                             E5
     C*
     C                     END                             E4
     C*
     C                     END                             E3
     C*
     C** ADD TO RUNNING TOTAL OF CHANGE IN VALUE DUE TO DELETION
     C                     ADD  WWAMTT    WWTOTL
     C*
     C           PTRAK1    READEPMPTRALL                 65
     C                     END                             E2
     C*
     C** CALCULATE ADJUSTMENT DUE TO DELETION AS
     C** ADJ = VA - VS
     C** WHERE VA IS TOTAL CHANGE TO VALUE CALCULATED ABOVE AND 'VS' IS
     C** THE VALUE OF THE POSITION AT THE START
     C                     MOVE 'ADJ'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C           WWTOTL    SUB  PFMA,1    PFMA,I
     C*
     C** ALSO OUTPUT THE 'VA' AMOUNT
     C                     ADD  1         I
     C                     MOVE 'VA '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWTOTL    PFMA,I
     C*
     C** PERFORM ROUTINE TO OUTPUT PERFORMANCE DETAILS
     C                     EXSR #WRTRP
     C*                                                                   73300
     C                     MOVE WXMODI    IMMODI                          73300
     C                     MOVE WXTDSS    IMTDSS                          73300
     C                     MOVE WXTRNB    IMTRNB                          73300
     C*
     C** ...OTHERWISE PERFORM PROCESSING FOR DELETED FX DEAL
     C                     ELSE                            X1
     C*
     C** SET VALUE AT START TO FX P&L AT START
     C                     MOVE 'VS '     PFMC,1
     C                     MOVE '   '     PFMS,1
     C***********          Z-ADDQFPLFX    PFMA,1                          S01486
     C                     Z-ADDGFPLFX    PFMA,1                          S01486
     C*
     C** SET ADJUSTMENT TO MINUS AMOUNT AT START
     C                     MOVE 'ADJ'     PFMC,2
     C                     MOVE '   '     PFMS,2
     C***********          Z-SUBQFPLFX    PFMA,2                          S01486
     C                     Z-SUBGFPLFX    PFMA,2                          S01486
     C*
     C** PERFORM ROUTINE TO OUTPUT PERFORMANCE DETAILS
     C                     EXSR #WRTRP
     C                     END                             E1
     C*
     C****                 MOVE WXMODI    IMMODI                          73300
     C****                 MOVE WXTDSS    IMTDSS                          73300
     C****                 MOVE WXTRNB    IMTRNB                          73300
     C*
     C                     ENDSR
     C*
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #FOREX   - CALCULATE PERFORMANCE FOR FX DEALS                    *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * #FMT89   - PREPARE DETAILS FOR OUTPUT TO FORMATS 8 & 9           *
      **#WRTRP***-*WRITE*DETAILS*TO*REPORT*AND*UPDATE*PMPIMTPP************S01486
      * #WRTRP   - WRITE DETAILS TO REPORT AND UPDATE PMPIMTPD           *S01486
      * #FMT4    - PREPARE DETAILS FOR OUTPUT TO FORMAT 4                *
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *
      * ZCCYCN   -                                                       *
      * ZDATE2   -                                                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWFORX   -                                                       *
      * WWRCDT   -                                                       *
      * WWPDAT   -                                                       *
      * WWPCCY   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #FOREX    BEGSR
     C*
     C                     Z-ADD1         I
     C*
     C** PERFORMS SR/#FMT89 TO RESET NEW POSITION REPORT FIELDS TO BLANK
     C                     EXSR #FMT89
     C*
     C           IMRECI    IFEQ 'D'                        B1
     C           IMMFMD    IFEQ 'M'                        B2
     C                     Z-ADDIMMFXR    WCMFXR
     C                     ELSE                            X2
     C           1         DIV  IMMFXR    WCMFXR
     C                     END                             E2
     C                     END                             E1
     C*
     C** IF FX DEAL LIVE AT START OF PERFORMANCE PERIOD FOLLOWING RECORDS
     C** SHOULD BE OUTPUT:
     C**   VS = FX P&L AT START
     C**   XIU = - FX P&L AT START (DEAL LIVE AT END OF PERIOD)
     C**   XIR = - FX P&L AT END (DEAL MATURED AT END OF PERIOD)
     C*
     C** IF DEAL LIVE AT START OF PERFORMANCE PERIOD OUTPUT STARTING
     C** EVENTS AND WRITE RECORD
     C           *IN70     IFEQ '0'                        B1
     C***********QFTRNB    ANDEQIMTRNB                                    S01486
     C           GFTRNB    ANDEQIMTRNB                                    S01486
     C                     MOVE 'S'       WWRCDT
     C                     MOVE 'VS '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C***********          Z-ADDQFPLFX    PFMA,I                          S01486
     C                     Z-ADDGFPLFX    PFMA,I                          S01486
     C                     ADD  1         I
     C*
     C** OUTPUT UNREALISED FX P&L AS CAPITAL INVESTED AT START
     C                     MOVE 'VP '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C***********          Z-ADDQFPLFX    PFMA,I                          S01486
     C                     Z-ADDGFPLFX    PFMA,I                          S01486
     C                     ADD  1         I
     C*
     C** IF DEAL LIVE AT END OF PERIOD REVERSE OUT UNREALISED P&L
     C           IMRECI    IFEQ 'D'                        B2
     C                     MOVE 'XTU'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C***********          Z-SUBQFPLFX    PFMA,I                          S01486
     C                     Z-SUBGFPLFX    PFMA,I                          S01486
     C                     ADD  1         I
     C                     ELSE                            X2
     C*
     C** OTHERWISE (DEAL MATURED) REVERSE OUT REALISED P&L
     C                     MOVE 'XTR'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C***********          Z-SUBQFPLFX    PFMA,I                          S01486
     C                     Z-SUBGFPLFX    PFMA,I                          S01486
     C                     ADD  1         I
     C                     END                             E2
     C*
     C                     EXSR #WRTRP
     C                     END                             E1
     C*
     C** SET UP COMMON FIELDS TO CONTAIN DETAILS OF POSITION AT END
     C                     Z-ADD1         I
     C                     MOVE 'E'       WWRCDT
     C*
     C** MOVE DETAILS FROM END OF MONTH POSITIONS TO WORK FIELDS
     C                     Z-ADDQRPMED    WCPDAT
     C**********           Z-ADDIMTRNB    WCTRNB                                              CLE148
     C                     MOVELIMTRNB    WCTRNB                                              CLE148
     C                     MOVE *BLANKS   WCTTYP
     C                     MOVE *BLANKS   WCPFMC
     C                     MOVE *BLANKS   WCPFMS
     C*
     C           IMMODI    IFEQ 'LE'
     C           FCPORS    ANDNE'B'                                       CPM004
     C           IMMODI    OREQ 'ML'
     C           FCPORS    ANDNE'B'                                       CPM004
     C                     Z-SUBIMAMT1    WCTAMT
     C                     ELSE
     C                     Z-ADDIMAMT1    WCTAMT
     C                     END
     C*
     C                     MOVE IMBYSF    WCBYSF
     C                     MOVE IMTXT2    WCTXT2
     C*
     C                     Z-ADDIMMPRC    WCMPRC
     C                     MOVE *BLANKS   WCINIO
     C                     MOVE IMMODI    WCMODI
     C                     Z-ADDWCTAMT    WCRAMT
     C                     MOVE 'N'       WCCPTC
     C                     MOVE 'N'       WCREVI
     C                     MOVE 'C'       WCACIN
     C                     MOVE 'N'       WCPPYT
     C                     Z-ADDIMPLFX    WCACIS
     C                     MOVE IMRESH    WCRESH
     C*
     C** IF DEAL LIVE AT END OF PERIOD OUTPUT END DETAILS:
     C**   XIU = FX P&L AT END
     C**   VE = FX P&L AT END
     C           IMRECI    IFEQ 'D'                        B1
     C                     MOVE 'VE '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDIMPLFX    PFMA,I
     C                     ADD  1         I
     C*
     C                     MOVE 'XTU'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDIMPLFX    PFMA,I
     C                     ADD  1         I
     C*
     C** FORMAT DETAILS FOR OUTPUT
     C                     EXSR #FMT4
     C*
     C                     EXSR #WRTRP
     C                     END                             E1
     C*
     C** PERFORM #FXRPL TO CALCULATE REALISED FX P&L FOR DEALS WHICH
     C** MATURED DURING THE CURRENT PERFORMANCE PERIOD
     C           IMRECI    IFEQ 'M'                        B1
     C*
     C                     MOVE 'M'       WWRCDT
     C*
     C** READ THROUGH ALL PERFORMANCE EVENTS FOR DEAL AND OUTPUT
     C                     MOVELIMTRNB    WTRNB2                                              CLE148
     C           PCA5K1    SETLLPMPCAAL5
     C           PCA5K1    READEPMPCAAL5                 73
     C*
     C           *IN73     DOWEQ'0'                        B2
     C                     Z-ADDQSEVRF    WCEVRF
     C                     MOVE 'Y'       WWFXPO  1                       078956
     C*
     C** IF PROCESSING A NOMINAL PERFORMANCE EVENT CONVERT AMOUNT TO
     C** PORTFOLIO BASE CURRENCY
     C           QSPFMC    IFEQ ' N'                       B3
     C*
     C** ON CHANGE OF CURRENCY DETAILS ACCESS SDCURRPD
     C           A6CYCD    IFNE QSCCY                      B4
     C                     MOVE QSCCY     WWCCY
     C                     EXSR #CURRD
     C                     END                             E4
     C*
     C                     Z-ADDQSCSHA    ZAMTF
     C                     Z-ADDQSMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDA6NBDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C*
     C** SET UP PERFORMANCE EVENT
     C           QSINIO    IFEQ 'I'                        B4
     C                     MOVE 'CIR'     PFMC,I
     C                     Z-ADD0         ZFLD15                          078956
     C                     MOVE QSEVRF    ZFLD15                          078956
     C                     Z-ADD0         ZDECS                           078956
     C                     MOVE ' '       ZECODE                          078956
     C                     EXSR ZSEDIT                                    078956
     C                     MOVE ZOUT21    PFMT,I                          078956
     C                     ELSE                            X4
     C                     MOVE 'COR'     PFMC,I
     C                     Z-ADD0         ZFLD15                          078956
     C                     MOVE QSEVRF    ZFLD15                          078956
     C                     Z-ADD0         ZDECS                           078956
     C                     MOVE ' '       ZECODE                          078956
     C                     EXSR ZSEDIT                                    078956
     C                     MOVE ZOUT21    PFMT,I                          078956
     C                     END                             E4
     C                     MOVE *BLANKS   PFMS,I
     C                     Z-ADDZAMTT     PFMA,I
     C                     ADD  1         I
     C                     END                             E3
     C*
     C** IF PROCESSING A REALISED FX P&L EVENT OUTPUT PERFORMANCE DETAILS
     C           QSPFMC    IFEQ 'XT'                       B3
     C                     MOVE 'XTR'     PFMC,I
     C                     MOVE *BLANKS   PFMS,I
     C                     Z-ADDQSCSHA    PFMA,I
     C                     Z-ADD0         ZFLD15                          078956
     C                     MOVE QSEVRF    ZFLD15                          078956
     C                     Z-ADD0         ZDECS                           078956
     C                     MOVE ' '       ZECODE                          078956
     C                     EXSR ZSEDIT                                    078956
     C                     MOVE ZOUT21    PFMT,I                          078956
     C                     END                             E3
     C*
     C           PCA5K1    READEPMPCAAL5                 73
     C                     END                             E2
     C*
     C** FORMAT DETAILS FOR OUTPUT
     C                     EXSR #FMT4
     C*
     C                     EXSR #WRTRP
     C                     END                             E1
     C*
     C                     MOVE 'N'       WWFXPO  1                       078956
     C                     MOVEA*BLANKS   PFMT                            078956
     C*                                                                   078956
     C                     ENDSR
      ********************************************************************
      ********************************************************************075998
      /EJECT                                                              075998
      ********************************************************************075998
      *                                                                  *075998
      * #MARGN   - CALCULATE PERFORMANCE FOR MARGIN INSTRUMENTS          *075998
      *   (IE FUTURES AND OPTIONS WITH MARGIN AT END)                    *075998
      *                                                                  *075998
      * SUBROUTINE CALLS:                                                *075998
      * #FMT89   - PREPARE DETAILS FOR OUTPUT TO FORMATS 8 & 9           *075998
      * #WRTRP   - WRITE DETAILS TO REPORT AND UPDATE PMPIMTPD           *075998
      * #FMT4    - PREPARE DETAILS FOR OUTPUT TO FORMAT 4                *075998
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *075998
      * ZCCYCN   -                                                       *075998
      * ZDATE2   -                                                       *075998
      *                                                                  *075998
      * SUBROUTINE CALLED FROM:                                          *075998
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *075998
      *                                                                  *075998
      ********************************************************************075998
     C           #MARGN    BEGSR                                          075998
     C*                                                                   075998
     C** PERFORMS SR/#FMT89 TO RESET NEW POSITION REPORT FIELDS TO BLANK  075998
     C                     Z-ADD1         I                               075998
     C                     EXSR #FMT89                                    075998
     C*                                                                   075998
     C** IF MARGIN POSITION OPEN AT START CALCULATE VALUE OF MARGIN       075998
     C** POSITION VIA SR/#MARG1                                           075998
     C           *IN70     IFEQ '0'                        B1             075998
     C*                                                                   075998
     C           GFMPRC    IFNE *LOVAL                     B2             075998
     C                     Z-ADDGFAMT1    FFNOC                           075998
     C                     Z-ADDGFMPRC    FFPRIC                          075998
     C                     Z-ADDGFTKDM    FFTKDM                          075998
     C                     Z-ADDGFMNPF    FFMNPF                          075998
     C                     Z-ADDGFACIS    WCACIS                          075998
     C                     Z-ADDGFTKVL    WCTKVL 145                      075998
     C                     MOVE GFFOIS    FFFOIS                          CPM003
     C                     EXSR #MARG1                                    075998
     C*                                                                   075998
     C** CONVERT FROM AN AMOUNT IN INSTRUMENT CURRENCY TO AN AMOUNT IN    075998
     C** PORTFOLIO BASE CURRENCY                                          075998
     C                     Z-ADDWWVLUE    ZAMTF                           075998
     C                     Z-ADDGFMFXD    ZCRSRD                          075998
     C                     MOVE 'M'       ZCRSMD                          075998
     C                     Z-ADDWWICDP    ZCDPF                           075998
     C                     Z-ADDWWPCDP    ZCDPT                           075998
     C                     EXSR ZCCYXD                                    075998
     C*                                                                   075998
     C** OUPUT FOLLOWING PERFORMANCE EVENTS                               075998
     C**   VS = VALUE AT START (FROM SR/#MARG1)                           075998
     C**   TU = - VALUE AT START (FROM SR/#MARG1)                         075998
     C                     MOVE 'S'       WWRCDT                          075998
     C                     MOVE 'VS '     PFMC,I                          075998
     C                     MOVE '   '     PFMS,I                          075998
     C                     Z-ADDZAMTT     PFMA,I                          075998
     C                     ADD  1         I                               075998
     C*                                                                   075998
     C** OUTPUT UNREALISED MARKET P&L RECORD                              075998
     C                     MOVE 'TU '     PFMC,I                          075998
     C                     MOVE '   '     PFMS,I                          075998
     C                     Z-SUBZAMTT     PFMA,I                          075998
     C                     ADD  1         I                               075998
     C                     END                                            075998
     C*                                                                   075998
     C** OUTPUT DETAILS OF STARTING POSITION TO REPORT AND WRITE          075998
     C** PERFORMANCE DETAILS TO PF/PMPIMTPD                               075998
     C                     EXSR #FMT4                                     075998
     C                     EXSR #WRTRP                                    075998
     C                     END                             E1             075998
     C*                                                                   075998
     C** READ THROUGH PERFORMANCE EVENTS FOR POSITION                     075998
     C                     Z-ADDQRPMSD    WWPDAT                          075998
     C                     MOVE *LOVAL    WWTTYP                          075998
     C                     Z-ADD*LOVAL    WWSEQN  50                      075998
     C                     MOVE *LOVAL    WWPFMC                          075998
     C*                                                                   075998
     C           PTRAFE    SETLLPMPTRAL9                                  075998
     C           PTRAF1    READEPMPTRAL9                 65               075998
     C*                                                                   075998
     C           *IN65     DOWEQ'0'                        B1             075998
     C                     MOVE QUPFMC    WCPFMC                          075998
     C                     MOVE QUPFMS    WCPFMS                          075998
     C                     MOVE QUTTYP    WCTTYP                          075998
     C**********           Z-ADDQUTRNB    WCTRNB                                       075998 CLE148
     C                     MOVELQUTRNB    WCTRNB                                              CLE148
     C                     Z-ADDQUPDAT    WCPDAT                          075998
     C                     Z-ADDQUTAMT    WCTAMT                          075998
     C                     Z-ADDQURAMT    WCRAMT                          075998
     C                     Z-ADDQUMPRC    WCMPRC                          075998
     C                     Z-ADDQUMFXR    WCMFXR                          075998
     C                     MOVE QUMODI    WCMODI                          075998
     C                     MOVE QUINIO    WCINIO                          075998
     C                     MOVE QUCPTC    WCCPTC                          075998
     C                     MOVE QUREVI    WCREVI                          075998
     C                     MOVE QUACIN    WCACIN                          075998
     C                     MOVE QUPPYT    WCPPYT                          075998
     C                     Z-ADD0         WCACIS                          075998
     C                     Z-ADDQUEVRF    WCEVRF                          075998
     C                     Z-ADDQUNMDP    NMDP    10                      075998
     C                     MOVE QUSPBS    SPBS    1                       075998
     C                     MOVE 'T'       WWRCDT                          075998
     C*                                                                   075998
     C** CONVERT FROM AN AMOUNT IN INSTRUMENT CURRENCY TO AN AMOUNT IN    075998
     C** PORTFOLIO BASE CURRENCY                                          075998
     C                     Z-ADDQUTAMT    ZAMTF                           075998
     C                     Z-ADDQUMFXR    ZCRSRD                          075998
     C                     MOVE 'M'       ZCRSMD                          075998
     C                     Z-ADDWWICDP    ZCDPF                           075998
     C                     Z-ADDWWPCDP    ZCDPT                           075998
     C                     EXSR ZCCYXD                                    075998
     C*                                                                   075998
     C** OUTPUT CAPITAL CHANGE PERFORMANCE EVENTS                         075998
     C                     Z-ADD1         I                               075998
     C                     MOVE WCINIO    WWINIO  1                       075998
     C           WCREVI    IFEQ 'Y'                        B2             075998
     C           WCINIO    IFEQ 'I'                        B3             075998
     C                     MOVE 'O'       WWINIO                          075998
     C                     ELSE                            X3             075998
     C                     MOVE 'I'       WWINIO                          075998
     C                     END                             E3             075998
     C                     END                             E2             075998
     C*                                                                   075998
     C           WWINIO    IFEQ 'I'                        B2             075998
     C                     MOVE 'CI '     PFMC,I                          075998
     C                     ELSE                            X2             075998
     C                     MOVE 'CO '     PFMC,I                          075998
     C                     END                             E2             075998
     C                     MOVE *BLANKS   PFMS,I                          075998
     C                     Z-ADDZAMTT     PFMA,I                          075998
     C                     ADD  1         I                               075998
     C*                                                                   075998
     C** OUTPUT CHARGE, COMMISSION OR REALISED PROFIT EVENT               075998
     C                     MOVELQUPFMC    PFMC,I                          075998
     C                     MOVELQUPFMS    PFMS,I                          075998
     C                     Z-ADDZAMTT     PFMA,I                          075998
     C                     ADD  1         I                               075998
     C*                                                                   075998
     C** OUTPUT TIME WEIGHTED CHANGE TO CAPITAL EVENT                     075998
     C           WCREVI    IFEQ 'Y'                                       075998
     C                     Z-SUBZAMTT     ZAMTT                           075998
     C                     END                                            075998
     C*                                                                   075998
     C           QRPMED    SUB  QUPDAT    WWDIP   50                      075998
     C*                                                                   075998
     C           ZAMTT     MULT WWDIP     WWVALW                          075998
     C           WWVALW    DIV  QRDYPP    WWVALW    H                     075998
     C*                                                                   075998
     C                     MOVE 'CX '     PFMC,I                          075998
     C                     MOVE '   '     PFMS,I                          075998
     C                     Z-ADDWWVALW    PFMA,I                          075998
     C                     ADD  1         I                               075998
     C*                                                                   075998
     C                     EXSR #FMT4                                     075998
     C                     EXSR #WRTRP                                    075998
     C*                                                                   075998
     C           PTRAF1    READEPMPTRAL9                 65               075998
     C                     END                             E1             075998
     C*                                                                   075998
     C** IF MARGIN POSITION OPEN AT END CALCULATE VALUE OF MARGIN         075998
     C** POSITION VIA SR/#MARG1                                           075998
     C           *IN71     IFEQ '0'                        B1             075998
     C           GFAMT1    ANDNE0                                         075998
     C           *IN71     OREQ '0'                        B1             075998
     C           GFACIS    ANDNE0                                         075998
     C                     MOVE 'E'       WWRCDT                          075998
     C                     MOVE *BLANKS   WWFILE                          075998
     C                     Z-ADD1         I                               075998
     C*                                                                   075998
     C** MOVE DETAILS FROM END OF MONTH POSITIONS TO WORK FIELDS          075998
     C                     Z-ADDQRPMED    WCPDAT                          075998
     C**********           Z-ADDIMTRNB    WCTRNB                                       075998 CLE148
     C                     MOVELIMTRNB    WCTRNB                                              CLE148
     C                     MOVE *BLANKS   WCTTYP                          075998
     C                     MOVE *BLANKS   WCPFMC                          075998
     C                     MOVE *BLANKS   WCPFMS                          075998
     C                     Z-ADDIMAMT1    WCTAMT                          075998
     C                     MOVE IMBYSF    WCBYSF                          075998
     C                     MOVE IMTXT2    WCTXT2                          075998
     C                     Z-ADDIMMFXD    WCMFXR                          075998
     C                     Z-ADDIMMPRC    WCMPRC                          075998
     C                     MOVE *BLANKS   WCINIO                          075998
     C                     MOVE IMMODI    WCMODI                          075998
     C                     Z-ADDWCTAMT    WCRAMT                          075998
     C                     MOVE 'N'       WCCPTC                          075998
     C                     MOVE 'N'       WCREVI                          075998
     C                     MOVE 'C'       WCACIN                          075998
     C                     MOVE 'N'       WCPPYT                          075998
     C                     Z-ADDIMACIS    WCACIS                          075998
     C                     Z-ADDIMAMT1    FFNOC                           075998
     C                     Z-ADDIMMPRC    FFPRIC                          075998
     C                     Z-ADDIMTKDM    FFTKDM                          075998
     C                     Z-ADDIMMNPF    FFMNPF                          075998
     C                     Z-ADDIMTKVL    WCTKVL 145                      075998
     C                     MOVE IMFOIS    FFFOIS  5                       CPM003
     C*                                                                   075998
     C** DO NOT VALUE POSITION IF PRICE NOT FOUND                         075998
     C           IMMPRC    IFNE *LOVAL                                    075998
     C                     EXSR #MARG1                                    075998
     C*                                                                   075998
     C** CONVERT FROM AN AMOUNT IN INSTRUMENT CURRENCY TO AN AMOUNT IN    075998
     C** PORTFOLIO BASE CURRENCY                                          075998
     C                     Z-ADDWWVLUE    ZAMTF                           075998
     C                     Z-ADDIMMFXD    ZCRSRD                          075998
     C                     MOVE 'M'       ZCRSMD                          075998
     C                     Z-ADDWWICDP    ZCDPF                           075998
     C                     Z-ADDWWPCDP    ZCDPT                           075998
     C                     EXSR ZCCYXD                                    075998
     C*                                                                   075998
     C** OUPUT FOLLOWING PERFORMANCE EVENTS                               075998
     C**   VS = VALUE AT START (FROM SR/#MARG1)                           075998
     C**   TU = - VALUE AT START (FROM SR/#MARG1)                         075998
     C                     MOVE 'VE '     PFMC,I                          075998
     C                     MOVE '   '     PFMS,I                          075998
     C                     Z-ADDZAMTT     PFMA,I                          075998
     C                     ADD  1         I                               075998
     C*                                                                   075998
     C** OUTPUT UNREALISED MARKET P&L RECORD                              075998
     C                     MOVE 'TU '     PFMC,I                          075998
     C                     MOVE '   '     PFMS,I                          075998
     C                     Z-ADDZAMTT     PFMA,I                          075998
     C                     ADD  1         I                               075998
     C                     END                             E1             075998
     C*                                                                   075998
     C** OUTPUT DETAILS OF STARTING POSITION TO REPORT AND WRITE          075998
     C** PERFORMANCE DETAILS TO PF/PMPIMTPD                               075998
     C                     EXSR #FMT4                                     075998
     C                     EXSR #WRTRP                                    075998
     C                     END                             E1             075998
     C*                                                                   075998
     C                     ENDSR                                          075998
      ********************************************************************075998
      /EJECT                                                              075998
      ********************************************************************075998
      *                                                                  *075998
      * #MARG1   - CALCULATE VALUE OF MARGIN POSITION                    *075998
      *                                                                  *075998
      * SUBROUTINE CALLS:                                                *075998
      * FFPMCL   - CALCULATE POSITION VALUE                              *075998
      *                                                                  *075998
      * SUBROUTINE CALLED FROM:                                          *075998
      * #MARGN   - PERFORMANCE CALCULATIONS FOR MARGIN INSTRUMENTS       *075998
      *                                                                  *075998
      ********************************************************************075998
     C           #MARG1    BEGSR                                          075998
     C*                                                                   075998
     C** THE VALUE OF A FLAT POSITION IS THE UNREALISED P/L               075998
     C** IE VALUE = TICKS OF UNREALISED PROFIT X TICK VALUE               075998
     C           FFNOC     IFEQ 0                          B1             075998
     C           WCACIS    MULT WCTKVL    WWVLUE 150H                     075998
     C                     END                             E1             075998
     C*                                                                   075998
     C** THE VALUE OF AN OPEN LONG POSITION IS CALCULATED AS CURRENT      075998
     C** POSITION VALUE - COST OF POSITION                                075998
     C           FFNOC     IFGT 0                                         075998
     C*                                                                   CPM003
     C** On change of FF instrument, access FF Instruments file for       CPM003
     C** Contingent amount, Contract Type and Processing Type             CPM003
     C*                                                                   CPM003
     C           FFFOIS    IFNE WSFOIS                                    CPM003
     C                     MOVE FFFOIS    WSFOIS                          CPM003
     C                     EXSR #INTYP                                    CPM003
     C                     END                                            CPM003
     C           ISPT      IFLE 6                                         CPM003
     C                     EXSR FFTVCL                                    075998
     C                     ELSE                                           CPM003
     C           100       SUB  FFPRIC    FFYLD  117                      CPM003
     C                     EXSR FFYTOP                                    CPM003
     C           PRICEC    MULT FFCTAM    W309   309                      CPM003
     C                     MULT 100       W309                            CPM003
     C                     MULT FFNOC     FFTNVL    H                     CPM003
     C                     END                                            CPM003
     C           FFTNVL    ADD  WCACIS    WWTTLT 150                      075998
     C           ISPT      IFLE 6                                         CPM003
     C           WWTTLT    MULT WCTKVL    WWVLUE 150H                     075998
     C                     ELSE                                           CPM003
     C                     Z-ADDWWTTLT    WWVLUE 150H                     CPM003
     C                     END                                            CPM003
     C                     END                                            075998
     C*                                                                   075998
     C** THE VALUE OF AN OPEN SHORT POSITION IS CALCULATED AS COST OF     075998
     C** POSITION - CURRENT VALUE OF POSITION                             075998
     C           FFNOC     IFLT 0                                         075998
     C                     Z-SUBFFNOC     FFNOC                           075998
     C           ISPT      IFLE 6                                         CPM003
     C                     EXSR FFTVCL                                    075998
     C                     ELSE                                           CPM003
     C           100       SUB  FFPRIC    FFYLD                           CPM003
     C                     EXSR FFYTOP                                    CPM003
     C           PRICEC    MULT FFCTAM    W309   309                      CPM003
     C                     MULT 100       W309                            CPM003
     C                     MULT FFNOC     FFTNVL    H                     CPM003
     C                     END                                            CPM003
     C           WCACIS    SUB  FFTNVL    WWTTLT 150                      075998
     C           ISPT      IFLE 6                                         CPM003
     C           WWTTLT    MULT WCTKVL    WWVLUE 150H                     075998
     C                     ELSE                                           CPM003
     C                     Z-ADDWWTTLT    WWVLUE 150H                     CPM003
     C                     END                                            CPM003
     C                     END                                            075998
     C*                                                                   075998
     C                     ENDSR                                          075998
      /EJECT
      ********************************************************************
      *                                                                  *
      * #GENRA   - CALCULATE PERFORMANCE FOR GENERAL CASHFLOWS           *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * #FMT89   - PREPARE DETAILS FOR OUTPUT TO FORMATS 8 & 9           *
      **#WRTRP***-*WRITE*DETAILS*TO*REPORT*AND*UPDATE*PMPIMTPP************S01486
      * #WRTRP   - WRITE DETAILS TO REPORT AND UPDATE PMPIMTPD           *S01486
      * #FMT4    - PREPARE DETAILS FOR OUTPUT TO FORMAT 4                *
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *
      * ZCCYCN   -                                                       *
      * ZDATE2   -                                                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     - MAIN PROCESSING ROUTINE                               *
      *                                                                  *
      ********************************************************************
     C           #GENRA    BEGSR
     C*
     C                     MOVE 'T'       WWRCDT
     C*
     C** ON CHANGE OF INSTRUMENT CURRENCY ACCESS SDCURRL0 TO OBTAIN
     C** NEW CURRENCY DETAILS
     C           QSCCY     IFNE WSCCY1                     B1
     C                     MOVE QSCCY     WWCCY   3
     C                     EXSR #CURRD
     C                     Z-ADDA6NBDP    WWICDP  10
     C                     Z-ADDA6SPRT    WWISPR 138
     C                     MOVE A6MDIN    WWIMDI  1
     C                     MOVE QSCCY     WSCCY1  3
     C                     END                             E1
     C*
     C***ON*CHANGE*OF*CUSTOMER*OR*PORTFOLIO*ACCESS*PMPORTPP*AND***********S01486
     C** ON CHANGE OF CUSTOMER OR PORTFOLIO ACCESS PMPORTPD AND           S01486
     C** PREPARE DETAILS FOR OUTPUT ON REPORT
     C           QRCNUM    IFNE WSCNUM                     B1
     C           QRPTFR    ORNE WSPTFR
     C                     MOVE 'Y'       WWPRTC  1
     C                     EXSR #PORTD
     C**********           MOVE QRCNUM    WSCNUM  60                                          CSD027
     C                     MOVE QRCNUM    WSCNUM  6                                           CSD027
     C                     MOVE QRPTFR    WSPTFR  4
     C                     END                             E1
     C*
     C** MOVE DETAILS FROM PMPCAALL TO WORKFIELDS
     C**********           Z-ADDQSCNUM    WCCNUM                                              CSD027
     C                     MOVE QSCNUM    WCCNUM                                              CSD027
     C                     MOVE QSPTFR    WCPTFR
     C                     MOVE QSCCY     WCINNR
     C                     MOVE QSCCY     WCCCY1
     C                     MOVE *BLANKS   WCVALG
     C                     MOVE *BLANKS   WCCNTR
     C**********           Z-ADD0         WCLIND                                              CER020
     C                     MOVE *BLANKS   WCLOIC                                              CER020
     C                     MOVE *BLANKS   WCTDSS
     C*
     C** RESET POSITION DETAILS TO 0
     C                     Z-ADD0         WWNOML 130
     C                     Z-ADD0         WWAPNM 130
     C                     Z-ADD0         WWFXAP 130
     C                     Z-ADD0         WWUINT 130
     C                     Z-ADD0         WWBKUI 130
     C                     Z-ADD0         WWINNM 150
     C                     Z-ADD0         WWNMEX
     C*
     C** PERFORMS SR/#FMT89 TO RESET NEW POSITION REPORT FIELDS TO BLANK
     C                     EXSR #FMT89
     C*
     C** SET UP INSTRUMENT, CURRENCY, COUNTRY AND INDUSTRY HEADINGS
     C                     MOVE *BLANKS   RRINNR
     C                     MOVE *BLANKS   RRCCY
     C                     MOVE *BLANKS   RRCNTR
     C                     MOVE *BLANKS   RRLIND
     C*
     C** SET UP COMMON FIELDS CONTAINING DETAILS FROM PMPCAALL
     C                     MOVE QSPFMC    WCPFMC  2
     C                     MOVE QSPFMS    WCPFMS  2
     C**********           Z-ADD0         WCTRNB  60                                          CLE148
     C                     MOVEL*BLANKS   WCTRNB  6                                           CLE148
     C                     Z-ADDQSCSHD    WCPDAT  50
     C                     Z-ADDQSCSHA    WCTAMT 130
     C                     Z-ADDQSCSHA    WCRAMT 130
     C                     Z-ADDQSMFXR    WCMFXR
     C                     Z-ADD1         WCMPRC 158
     C                     MOVE QSINIO    WCINIO  1
     C                     MOVE QSCPTC    WCCPTC  1
     C                     MOVE 'N'       WCREVI  1
     C                     MOVE 'C'       WCACIN  1
     C                     MOVE 'N'       WCPPYT  1
     C                     MOVE 'RE'      WCMODI
     C                     Z-ADD0         WCACIS
     C                     Z-ADDQSEVRF    WCEVRF 200
     C                     MOVE IMRESH    WCRESH
     C*
     C           QSINIO    IFEQ 'I'                        B4
     C                     MOVE 'CR'      WCTTYP  2
     C                     ELSE                            X4
     C                     MOVE 'DR'      WCTTYP
     C                     END                             E4
     C*
     C** IF REPORT REQUIRED FORMAT DETAILS OUTPUT IN FORMATS 2 TO 3
     C           *INU1     IFEQ '1'                        B1
     C                     EXSR #FMT23
     C                     END                             E1
     C*
     C** FORMAT DETAILS FOR OUTPUT
     C                     EXSR #FMT4
     C*
     C** CONVERT AMOUNT FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C                     Z-ADDWCTAMT    ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C                     Z-ADDZAMTT     WWVALP 150
     C*
     C** OUTPUT RECORDS FOR PERFORMANCE EVENTS IR, DV, F, T, C, OT
     C                     MOVELWCPFMC    PFMC,1
     C           WCPFMC    IFEQ 'IR'
     C                     MOVEL'IER'     PFMC,1
     C                     END
     C*
     C           WCPFMC    IFEQ 'XT'                                      72605
     C                     MOVEL'XTR'     PFMC,1                          72605
     C                     END                                            72605
     C*                                                                   72605
     C** IF PERFORMANCE CATEGORY 'F ' OR 'C ' OUTPUT SUB CATEGORY OF
     C** 'IR'; OTHERWISE OUTPUT BLANKS
     C           WCPFMC    IFEQ 'F '
     C           WCPFMC    OREQ 'C '
     C                     MOVE 'IR '     PFMS,1
     C                     ELSE
     C                     MOVE *BLANKS   PFMS,1
     C                     END
     C*
     C           WCINIO    IFEQ 'O'
     C                     Z-ADDWWVALP    PFMA,1
     C                     ELSE
     C                     Z-SUBWWVALP    PFMA,1
     C                     END
     C*
     C** OUTPUT BALANCING CI/CO EVENT
     C                     Z-ADDWWVALP    PFMA,2
     C                     MOVE *BLANKS   PFMS,2
     C*
     C           WCINIO    IFEQ 'O'
     C                     MOVE 'CO '     PFMC,2
     C                     ELSE
     C                     MOVE 'CI '     PFMC,2
     C                     END
     C*
     C** OUTPUT EVENT DETAILS
     C                     EXSR #WRTRP
     C*
     C                     MOVE 'N'       WWCASH  1
     C*
     C                     ENDSR
     C*
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #CLPFM   - CALCULATE PERFORMANCE FIGURES FOR LIVE NON-FX POS     *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZAPNUM   -                                                       *
      * ZCCYXR   -                                                       *
      * #NWAPN   - CALCULATE NEW AP NUMERATOR AND FX AP NUMERATOR        *
      * #NWUI    - CALCULATE NEW UNEARNED INTEREST & COST OF UI FIGS     *
      * ZAVPRC   -                                                       *
      * ZFXAVP   -                                                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWRCDT   -                                                       *
      * WWICDP   -                                                       *
      * WWVALU   -                                                       *
      * WWPCDP   -                                                       *
      * WWVALP   -                                                       *
      * WWVALW   -                                                       *
      * WWINIO   -                                                       *
      * WWVLCH   -                                                       *
      * WWNUIN   -                                                       *
      * WWNBKU   -                                                       *
      * WWDIP    -                                                       *
      * WWNOMW   -                                                       *
      * WWNOML   -                                                       *
      * WWNMRL   -                                                       *
      * WWAPNM   -                                                       *
      * WWMPA    -                                                       *
      * WWFXAP   -                                                       *
      * WWFXA    -                                                       *
      * WWMPL    -                                                       *
      * WWVAPT   -                                                       *
      * WWFXT    -                                                       *
      * WWFXAM   -                                                       *
      * WWFILE   -                                                       *
      * WWINNW   -                                                       *
      * WWINNM   -                                                       *
      * WWPFGT   -                                                       *
      * WWPIE    -                                                       *
      * WWIEFL   -                                                       *
      * WWFOP    -                                                       *
      * WWVAL1   -                                                       *
      * WWUIS    -                                                       *
      * WWFACT   -                                                       *
      * WWUINT   -                                                       *
      * WWBKUI   -                                                       *
      * WWINTE   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #CLPFM    BEGSR
     C*
     C                     Z-ADD1         I
     C*
     C** CONVERT NOMINAL AMOUNT PASSED TO ROUTINE INTO A MARKET VALUE
     C** IN PORTFOLIO CURRENCY
     C** IF RECORD FROM SE CONVERT AMOUNT FROM A NOMINAL AMOUNT TO AN
     C** AMOUNT IN INSTRUMENT CURRENCY
     C           WCMODI    IFEQ 'SE'                       B1
     C           WWRCDT    ANDEQ'S'
     C           WCMODI    OREQ 'SE'
     C           WWRCDT    ANDEQ'E'
     C           WCMODI    OREQ 'SE'
     C           WWRCDT    ANDEQ'T'
     C           WCPFMC    ANDEQ' N'
     C           WCMODI    OREQ 'FO'                                      075998
     C           WWRCDT    ANDEQ'S'                                       075998
     C           WCMPRC    ANDNE*LOVAL                                    075998
     C           WCMODI    OREQ 'FO'                                      075998
     C           WWRCDT    ANDEQ'E'                                       075998
     C           WCMPRC    ANDNE*LOVAL                                    075998
     C           WCMODI    OREQ 'FO'                                      075998
     C           WCMPRC    ANDNE*LOVAL                                    075998
     C           WWRCDT    ANDEQ'T'                                       075998
     C           WCPFMC    ANDEQ' N'                                      075998
     C                     Z-ADDWCTAMT    ZNOML
     C                     Z-ADDWCMPRC    ZAVPR
     C                     Z-ADDWCCDP1    ZNMDP
     C                     Z-ADDWWICDP    ZNMCD
     C                     MOVE 'U'       ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     WWVALU 150
     C                     ELSE                            X1
     C                     Z-ADDWCTAMT    WWVALU
     C*                                                                   075998
     C** IF NO PRICE HAS BEE ENTERED FOR AN OPTION POSITION SET           075998
     C** CURRENT VALUE TO 0                                               075998
     C           WCMODI    IFEQ 'FO'                       B2             075998
     C           WCMPRC    ANDEQ*LOVAL                                    075998
     C                     Z-ADD0         WWVALU                          075998
     C                     END                             E2             075998
     C*                                                                   075998
     C                     END                             E1
     C*
     C** CONVERT AMOUNT FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C                     Z-ADDWWVALU    ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRT
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C*                                                                   73300
     C** FOR DEPOT MOVEMENT CHARGES OBTAIN CHARGE SETTLEMENT CURRENCY     73300
     C** DECIMAL PLACES                                                   73300
     C           WCMODI    IFEQ 'SE'                       B1             73300
     C           WCTTYP    IFEQ 'WI'                       B2             73300
     C           WCTTYP    OREQ 'WO'                                      73300
     C           WCPFMC    IFEQ 'C '                       B3             73300
     C                     Z-ADD1         B                               73300
     C           QUCCY     LOKUPCYCD,B                   61               73300
     C** ERROR                                                            73300
     C           *IN61     IFEQ '0'                        ***************73300
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD91        DBASE            **DB ERROR 91**73300
     C***********          MOVEL'SDCURRL0'DBFILE           ***************S01486
     C                     MOVE 'SDCURRPD'DBFILE           ***************S01486
     C                     MOVELQUCCY     DBKEY                           73300
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR                                     73300
     C                     ELSE                            X4             73300
     C                     Z-ADDNBDP,B    ZCDPF                           73300
     C                     END                             E4             73300
     C                     END                             E3             73300
     C                     END                             E2             73300
     C                     END                             E1             73300
     C*
     C                     EXSR ZCCYXD
     C                     Z-ADDZAMTT     WWVALP 150
     C*
     C** IF START OR END POSITION OUTPUT 'VS', 'VP' AND 'VE' RECORDS AS
     C** REQUIRED
     C           WWRCDT    IFEQ 'S'                        B1
     C           WWRCDT    OREQ 'E'
     C*
     C** CONVERT ACCRUED INTEREST FROM NOMINAL TO PORTFOLIO CURRENCY
     C           WCACIS    IFNE 0                          B2
     C                     Z-ADDWCACIS    ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C                     Z-ADDZAMTT     WWVALW 150
     C                     ELSE                            X2
     C                     Z-ADD0         WWVALW
     C                     END                             E2
     C*
     C** IF STARTING RECORD OUTPUT VS AND VP RECORDS
     C           WWRCDT    IFEQ 'S'                        B2
     C                     MOVE 'VS '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C           WWVALP    ADD  WWVALW    PFMA,I
     C                     ADD  1         I
     C*
     C                     MOVE 'VP '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C*
     C***********P9UIIC    IFEQ 'Y'                        B3             S01486
     C           FCUIIC    IFEQ 'Y'                        B3             S01486
     C           WWVALP    ADD  WWVALW    PFMA,I
     C                     ELSE                            X3
     C                     Z-ADDWWVALP    PFMA,I
     C                     END                             E3
     C*
     C                     ADD  1         I
     C                     END                             E2
     C*
     C** IF ENDING RECORD OUTPUT VE RECORD
     C           WWRCDT    IFEQ 'E'                        B2
     C                     MOVE 'VE '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C           WWVALP    ADD  WWVALW    PFMA,I
     C                     ADD  1         I
     C                     END                             E2
     C                     END                             E1
     C*
     C** FOR ALL PERFORMANCE EVENTS (NOT START/END) CALCULATE CI, CO, CX.
     C** IF THE RECORD REPRESENTS A CHANGE OF CAPITAL DUE TO A PAYMENT
     C** OF CASH INTO THE PORTFOLIO OR A WALK IN THE CHANGE TO
     C** PORTFOLIO CAPITAL INDICATOR ON THESE RECORD WILL BE SET TO 'Y'
     C** OTHERWISE THE RECORDS REPRESENT AN IN/OUT OF CAPITAL FOR THE
     C** INSTRUMENT/CURRENCY/COUNTRY/INDUSTRY SECTOR
     C           WWRCDT    IFEQ 'T'                        B1
     C*
     C** FOR REVERSALS REVERSE SIGN OF IN / OUT IND
     C                     MOVE WCINIO    WWINIO  1
     C           WCREVI    IFEQ 'Y'                        B2
     C           WCINIO    IFEQ 'I'                        B3
     C                     MOVE 'O'       WWINIO
     C                     ELSE                            X3
     C                     MOVE 'I'       WWINIO
     C                     END                             E3
     C                     END                             E2
     C*                                                                   078956
     C** FOR EX-COUPON INTEREST EVENTS REVERSE IN/OUT IND                 078956
     C           WCACIN    IFEQ 'X'                        B2             078956
     C           WCMODI    ANDEQ'SE'                                      078956
     C           WCPFMC    ANDEQ'IP'                                      078956
     C           WCREVI    ANDNE'Y'                                       078956
     C                     MOVE WCINIO    WWINIO  1                       078956
     C           WCINIO    IFEQ 'I'                        B3             078956
     C                     MOVE 'O'       WWINIO                          078956
     C                     ELSE                            X3             078956
     C                     MOVE 'I'       WWINIO                          078956
     C                     END                             E3             078956
     C*                                                                   078956
     C           WWVALP    IFLT 0                                         078956
     C                     Z-SUBWWVALP    WWVALP                          078956
     C                     END                                            078956
     C*                                                                   078956
     C                     END                             E2             078956
     C*
     C** RECORDS FOR TIME WEIGHTED CHANGE IN INVESTED CAPITAL (CX)
     C** SHOULD ONLY BE OUTPUT FOR PERFROMANCE EVENTS 'N', 'IP' AND 'IR'
     C           WCMODI    IFNE 'RE'                       B2
     C           WCPFMC    ANDEQ' N'
     C           WCMODI    ORNE 'RE'
     C           WCPFMC    ANDEQ'IP'
     C           WCMODI    ORNE 'RE'
     C           WCPFMC    ANDEQ'IR'
     C           WCMODI    OREQ 'RE'
     C           WCPFMC    ANDEQ' N'
     C           WCMODI    OREQ 'RE'
     C           WCPFMC    ANDEQ'IR'
     C           QSAPRA    ANDEQ'Y'
     C*
     C** FOR EVENTS IP, IR AND DV THE CHANGE TO CAPITAL IS THE
     C** TRANSACTION AMOUNT CONVERTED TO PORTFOLIO CURRENCY. FOR
     C** A CHANGE OF NOMINAL THE CHANGE IN INVESTED CAPITAL IS CALCULATED
     C** AS:
     C**    CHANGE IN CAPITAL = NEW FX AP NUMERTOR - OLD FX AP NUMERATOR
     C** FOR NOMINAL EVENTS THE NEW FX AP NUMERATOR IS CALCULATED IN
     C** SR/#NWAPN
     C           WCPFMC    IFEQ ' N'                       B3
     C                     EXSR #NWAPN
     C           WWNFXN    SUB  WWFXAP    WWVLCH 150
     C                     END                             E3
     C*
     C** FOR IP EVENTS CHANGE IN CAPITAL = NEW BOOK COST OF UNEARNED
     C** INTEREST - OLD BOOK COST OF UNEARNED INTEREST
     C           WCPFMC    IFEQ 'IP'                       B3
     C           WCPFMC    OREQ 'IR'
     C                     Z-ADDWWNUIN    WSNUIN 150
     C                     Z-ADDWWNBKU    WSNBKU 150
     C*
     C           WCACIN    IFEQ 'C'                        B4
     C           WCACIN    OREQ 'X'                                       078956
     C           WWINIO    ANDEQ'I'                                       078956
     C                     EXSR #NWUI
     C           WWNBKU    SUB  WWBKUI    WWVLCH 150
     C                     ELSE                            X4
     C*
     C***********WWINIO    IFEQ 'I'                        B5             078956
     C***********          Z-SUBWWVALP    WWVLCH                          078956
     C***********          ELSE                            X5             078956
     C***********          Z-ADDWWVALP    WWVLCH                          078956
     C***********          END                             E5             078956
     C                     Z-ADDWWVALP    WWVLCH                          078956
     C*
     C                     END                             E4
     C*
     C                     Z-ADDWSNUIN    WWNUIN 150
     C                     Z-ADDWSNBKU    WWNBKU 150
     C                     END                             E3
     C*
     C** OUTPUT TIME WEIGHTED CHANGE IN CAPITAL. THE TIME WEIGHTED
     C** CHANGE IN CAPITAL IS CALCULATED BY MULTIPLYING THE CHANGE IN
     C** CAPITAL BY THE NUMBER OF DAYS WHICH THE CAPITAL WAS EARNING IN
     C** THE PORTFOLIO. THE AMOUNT IS SIGNED '+' FOR ADDITIONS OF CAPITAL
     C** AND '-' FOR WITHDRAWALS
     C           WCPFMC    IFEQ ' N'                       B3
     C           WCPFMC    OREQ 'IP'
     C***********P9UIIC    ANDEQ'Y'                                       S01486
     C           FCUIIC    ANDEQ'Y'                                       S01486
     C           WCACIN    ANDEQ'C'                                       078956
     C           WCPFMC    OREQ 'IP'                                      078956
     C           FCUIIC    ANDEQ'Y'                                       078956
     C           WCACIN    ANDEQ'X'                                       078956
     C           WWINIO    ANDEQ'I'                                       078956
     C           WCPFMC    OREQ 'IR'
     C***********P9UIIC    ANDEQ'Y'                                       S01486
     C           FCUIIC    ANDEQ'Y'                                       S01486
     C*
     C           QRPMED    SUB  WCPDAT    WWDIP   50
     C*
     C           WWVLCH    MULT WWDIP     WWVALW
     C           WWVALW    DIV  QRDYPP    WWVALW    H
     C*
     C                     MOVE 'CX '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWVALW    PFMA,I
     C                     ADD  1         I
     C*
     C                     END                             E3
     C                     END                             E2
     C*
     C** OUTPUT NEW CAPITAL CHANGE RECORDS. OUTPUT FOR ALL TYPES OF
     C** PERFORMANCE EVENT. CHANGE TO PORTFOLIO CAPITAL INDICATES
     C** CROSS PORTFOLIO SETTLEMENT
     C           WWINIO    IFEQ 'I'                        B2
     C                     MOVE 'CI '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C*
     C***********WCPFMC    IFEQ 'IP'                       B3             078956
     C***********WCACIN    ANDEQ'X'                                       078956
     C***********          Z-SUBWWVALP    PFMA,I                          078956
     C***********          ELSE                            X3             078956
     C                     Z-ADDWWVALP    PFMA,I
     C***********          END                             E3             078956
     C*
     C                     ADD  1         I
     C                     END                             E2
     C*
     C** OUTPUT CAPITAL OUT RECORD
     C           WWINIO    IFEQ 'O'                        B2
     C                     MOVE 'CO '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C*
     C***********WCPFMC    IFEQ 'IP'                       B3             078956
     C***********WCACIN    ANDEQ'X'                                       078956
     C***********          Z-SUBWWVALP    PFMA,I                          078956
     C***********          ELSE                            X3             078956
     C                     Z-ADDWWVALP    PFMA,I
     C***********          END                             E3             078956
     C*
     C                     ADD  1         I
     C                     END                             E2
     C                     END                             E1
     C*
     C** IF TRANSACTION EVENT BEING PROCESSED, AND NOMINAL RECORD AND
     C** PART PAYMENT EXIT ROUTINE
     C           WWRCDT    IFEQ 'T'                        B1
     C           WCPFMC    ANDEQ' N'
     C           WCPPYT    ANDEQ'Y'
     C                     GOTO #CLPF9
     C                     END                             E1
     C*
     C** CALCULATE REALISED/UNREALISED MARKET AND FX P&L ON TRADING
     C** FOR EACH CHANGE OF NOMINAL POSITION AND AT END OF PERIOD
     C           WWRCDT    IFEQ 'E'                        B1
     C           WWRCDT    OREQ 'T'
     C           WCPFMC    ANDEQ' N'
     C*
     C** REALISED / UNREALISED MARKET P&L ONLY CALCULATED FOR SE POSNS
     C           WCMODI    IFEQ 'SE'                       B2
     C           WCMODI    OREQ 'FO'                                      075998
     C           WCMPRC    ANDNE*LOVAL                                    075998
     C*
     C** REALISED MARKET P&L CALCUALTED FROM EQUATION
     C**   TR = NM X FXT X (MPT - MPA)
     C**   WHERE NM = NOMINAL POSITION BEING LIQUIDATED FOR A TRADE
     C**              (AT END OF PERIOD SET TO NOMINAL POSITION)
     C**         MPA = AVERAGE BOOK PRICE OF POSITION
     C**         FXT = FX RATE ON TRADE (AT END OF PERIOD)
     C**         FXA = AVERAGE BOOK FX RATE
     C*
     C** MARKET PROFITS ARE CALCULATED FOR ALL NON FLAT END POSITIONS
     C** AND FOR TRADES ACCORDING TO THE TABLE BELOW
     C**   --------------------------------
     C**   I Nominal  I In/Out I Realised I
     C**   I Position I  Ind   I   P&L    I
     C**   I----------I--------I----------I
     C**   I    +     I   I    I    N     I
     C**   I    +     I   O    I    Y     I
     C**   I    -     I   I    I    Y     I
     C**   I    -     I   O    I    N     I
     C**   ---------------------------------
     C*
     C** DETERMINE ABSOLUTE POSITION NOMINAL
     C                     Z-ADDWWNOML    WWNOMW 150
     C           WWNOML    IFLT 0                          B3
     C                     Z-SUBWWNOML    WWNOMW 150
     C                     END                             E3
     C*
     C                     Z-ADD0         WWNMRL 150
     C*
     C** AT END OF PERIOD P&L EARNED ON TOTAL POSITION NOMINAL
     C           WWRCDT    IFEQ 'E'                        B3
     C                     Z-ADDWWNOMW    WWNMRL
     C                     END                             E3
     C*
     C** FOR TRADES P&L EARNED ON AMOUNT OF NOMINAL CANCELLED BY EVENT
     C           WWRCDT    IFEQ 'T'                        B3
     C*
     C           WWNOML    IFGT 0                          B4
     C           WWINIO    ANDEQ'O'
     C           WWNOML    ORLT 0
     C           WWINIO    ANDEQ'I'
     C*
     C** NOMINAL ON WHICH P&L REALISED IS LESSER OF POSITION NOMINAL
     C** AND TRADE NOMINAL
     C*
     C           WCTAMT    IFLT WWNOMW                     B5
     C                     Z-ADDWCTAMT    WWNMRL
     C                     ELSE                            X5
     C                     Z-ADDWWNOMW    WWNMRL
     C                     END                             E5
     C                     END                             E4
     C                     END                             E3
     C*
     C** IF THE NOMINAL ON WHICH MARKET P&L IS TO BE CALCULATED IS NON-
     C** ZERO CALCULATE FACTORS 'MPA' AND 'FXA' OF ABOVE EQUATION
     C           WWNMRL    IFNE 0                          B3
     C*
     C** DETERMINE THE BOOK PRICE (WHICH IS THE POSITION AP NUMERATOR
     C** DIVIDED BY THE POSITION NOMINAL) USING SR/ZAVPRC
     C                     Z-ADDWWNOML    ZNOML
     C                     Z-ADDWWAPNM    ZVALU
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDWWICDP    ZNMCD
     C                     MOVEL'U'       ZPRCB
     C                     EXSR ZAVPRC
     C                     Z-ADDZAVPR     WWMPA  158
     C*
     C** DETERMINE THE BOOK FX RATE (WHICH IS THE POSITION FX AP NUMERATOR
     C** DIVIDED BY THE POSITION AP NUMERATOR) USING SR/ZFXAVP
     C                     Z-ADDWWAPNM    ZAPNM
     C                     Z-ADDWWFXAP    ZFXAP
     C                     Z-ADDWWICDP    ZNMCD
     C                     Z-ADDWWPCDP    ZPTCD
     C                     EXSR ZFXAVP
     C                     Z-ADDZAVFX     WWFXA  138
     C                     EXSR ZFXAVD
     C                     Z-ADDZAVFD     WWFXA1 308
     C*
     C** DETERMINE THE TRADING P&L USING EQUATION DEFINED ABOVE
     C** THE EQUATION TRANSLATES TO THE FOLLOWING PROCESSING:
     C**   1) DIFERENCE IN MARKET PRICE = MPT - MPA
     C**   2) MULTIPLY NOMINAL BY DIFFERENCE IN MARKET PRICE TO GIVE
     C**      MARKET P&L INSTRUMENT CURRENCY
     C**   3) CONVERT FROM INSTRUMENT TO PORTFOLIO CURRENCY AT FX RATE
     C**      ON PERFORMANCE EVENT
     C           WCMPRC    SUB  WWMPA     WWMPL  158
     C                     Z-ADDWWNMRL    ZNOML
     C                     Z-ADDWWMPL     ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDWWICDP    ZNMCD
     C                     MOVE 'U'       ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     WWVALU 150
     C*
     C** CONVERT AMOUNT FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C                     Z-ADDWWVALU    ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRT
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C*
     C                     EXSR ZCCYXD
     C*
     C                     Z-ADDZAMTT     WWVAPT 150
     C*
     C** IF PROCESSING END POSITION AND END POSITION NEGATIVE
     C** OR PROCESSING NON-REVERSED TS/WI OR REVERSED TP
     C**    REVERSE SIGN OF P&L
     C           WWRCDT    IFEQ 'E'                        B4
     C           WWNOML    ANDLT0
     C                     Z-SUBWWVAPT    WWVAPT
     C                     END                             E4
     C*
     C           WWRCDT    IFEQ 'T'                        B4
     C           WWINIO    ANDEQ'I'
     C                     Z-SUBWWVAPT    WWVAPT
     C                     END                             E4
     C*
     C** OUTPUT TRADING P&L. IF PROCESSING TRADE THE P&L IS REALISED.
     C** IF PROCESSING END POSITION THE P&L IS UNREALISED
     C           WWRCDT    IFEQ 'T'                        B4
     C                     MOVE 'TR '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWVAPT    PFMA,I
     C                     ADD  1         I
     C                     ELSE                            X4
     C                     MOVE 'TU '     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWVAPT    PFMA,I
     C                     ADD  1         I
     C                     END                             E4
     C*
     C** DETERMINE THE FX P&L FOR SECURITIES USING EQUATION:
     C**   XTR = NM X MPA X (FXT - FXA)
     C**   WHERE ALL FACTORS OF EQUATION ARE AS ABOVE
     C*
     C** THE EQUATION TRANSLATES TO THE FOLLOWING PROCESSING:
     C**   1) CALCULATE VALUE IN INSTRUMENT CURRENCY AS NM X MPA
     C**      VIA SR/ZAPNUM
     C**   2) CONVERT AMOUNT FROM NOMINAL CURRENCY TO PORTFOLIO TWICE
     C**      USING RATES FXT AND FXA
     C**   3) DIFFERENCE BETWEEN TWO AMOUNT REPRESENTS FX P&L
     C                     Z-ADDWWNMRL    ZNOML
     C                     Z-ADDWWMPA     ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDWWICDP    ZNMCD
     C                     MOVE 'U'       ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     WWVALU 150
     C*
     C** CONVERT AMOUNT FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C** USING FX RATE FROM PERFORMANCE EVENT
     C                     Z-ADDWWVALU    ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRT
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C*
     C                     EXSR ZCCYXD
     C*
     C                     Z-ADDZAMTT     WWFXT  150
     C*
     C** CONVERT AMOUNT FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C** USING AVERAGE FX RATE
     C                     Z-ADDWWVALU    ZAMTF
     C                     Z-ADDWWFXA1    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C                     Z-ADDZAMTT     WWFXAM 150
     C*
     C           WWFXT     SUB  WWFXAM    WWVAPT
     C*
     C** IF PROCESSING END POSITION AND END POSITION NEGATIVE
     C** OR PROCESSING NON-REVERSED TS/WI OR REVERSED TP
     C**    REVERSE SIGN OF P&L
     C           WWRCDT    IFEQ 'E'                        B4
     C           WWNOML    ANDLT0
     C                     Z-SUBWWVAPT    WWVAPT
     C                     END                             E4
     C*
     C           WWRCDT    IFEQ 'T'                        B4
     C           WWINIO    ANDEQ'I'
     C                     Z-SUBWWVAPT    WWVAPT
     C                     END                             E4
     C*
     C** OUTPUT TRADING P&L. IF PROCESSING TRADE THE P&L IS REALISED.
     C** IF PROCESSING END POSITION THE P&L IS UNREALISED
     C           WWRCDT    IFEQ 'T'                        B4
     C                     MOVE 'XTR'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWVAPT    PFMA,I
     C                     ADD  1         I
     C                     ELSE                            X4
     C                     MOVE 'XTU'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWVAPT    PFMA,I
     C                     ADD  1         I
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C*
     C** FOR ALL OTHER INSTRUMENTS ONLY CALCULATE FX P&L. THE
     C** CALCULATION IS THE SAME AS FOR 'SE' BUT WITH A MARKET PRICE
     C** DEFINED AS '1'.
     C*
     C** DETERMINE NOMINAL ON WHICH FX P&L TO BE CALCULATED
     C           WCMODI    IFNE 'SE'                       B2
     C           WCMODI    ANDNE'FO'                                      075998
     C*
     C** DETERMINE ABSOLUTE NOMINAL ON WHICH P&L EARNED
     C                     Z-ADDWWNOML    WWNOMW 150
     C           WWNOML    IFLT 0                          B3
     C                     Z-SUBWWNOML    WWNOMW 150
     C                     END                             E3
     C*
     C                     Z-ADD0         WWNMRL
     C*
     C** AT END OF PERIOD P&L EARNED ON WHOLE POSITION
     C           WWRCDT    IFEQ 'E'                        B3
     C                     Z-ADDWWNOMW    WWNMRL
     C                     END                             E3
     C*
     C** FOR TRANSACTION PERFORMANCE EVENTS FX P&L SHOULD BE CALCULATED
     C** IF AN INFLOW OCCURS AND THE POSITION IS NEGATIVE OR AN OUTFLOW
     C** OCCURS AND THE POSITION IS POSITIVE
     C           WWRCDT    IFNE 'E'                        B3
     C           WWINIO    IFEQ 'I'
     C           WWNOML    ANDLT0
     C           WWINIO    OREQ 'O'
     C           WWNOML    ANDGT0
     C*
     C** FX P&L REALISED IS LESSER OF ABSOLUTE POSITION NOMINAL AND
     C** PERFORMANCE EVENT NOMINAL
     C           WCTAMT    IFLT WWNOMW                     B5
     C                     Z-ADDWCTAMT    WWNMRL
     C                     ELSE                            X5
     C                     Z-ADDWWNOMW    WWNMRL
     C                     END                             E5
     C                     END                             E4
     C                     END                             E3
     C*
     C** DETERMINE THE BOOK FX RATE (WHICH IS THE POSITION FX AP NUMERATOR
     C** DIVIDED BY THE POSITION AP NUMERATOR) USING SR/ZFXAVP
     C           WWNMRL    IFNE 0                          B3
     C                     Z-ADDWWAPNM    ZAPNM
     C                     Z-ADDWWFXAP    ZFXAP
     C                     Z-ADDWWICDP    ZNMCD
     C                     Z-ADDWWPCDP    ZPTCD
     C                     EXSR ZFXAVP
     C                     Z-ADDZAVFX     WWFXA  138
     C                     EXSR ZFXAVD
     C                     Z-ADDZAVFD     WWFXA1
     C*
     C** CONVERT AMOUNT FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C** USING FX RATE FROM PERFORMANCE EVENT
     C                     Z-ADDWWNMRL    ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRT
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C*
     C                     EXSR ZCCYXD
     C                     Z-ADDZAMTT     WWFXT  150
     C*
     C** CONVERT AMOUNT FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C** USING AVERAGE FX RATE
     C                     Z-ADDWWNMRL    ZAMTF
     C                     Z-ADDWWFXA1    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C                     Z-ADDZAMTT     WWFXAM 150
     C*
     C           WWFXT     SUB  WWFXAM    WWVAPT
     C*
     C** IF PROCESSING SHORT POSITION REVERSE SIGN OF P&L
     C           WWRCDT    IFEQ 'T'                        B4
     C           WWINIO    ANDEQ'I'
     C           WWRCDT    OREQ 'E'
     C           WWNOML    ANDLT0
     C                     Z-SUBWWVAPT    WWVAPT
     C                     END                             E4
     C*
     C** OUTPUT TRADING P&L. IF PROCESSING TRADE THE P&L IS REALISED.
     C** IF PROCESSING END POSITION THE P&L IS UNREALISED
     C           WWRCDT    IFEQ 'T'                        B4
     C                     MOVE 'XTR'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWVAPT    PFMA,I
     C                     ADD  1         I
     C                     ELSE                            X4
     C                     MOVE 'XTU'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWVAPT    PFMA,I
     C                     ADD  1         I
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** FOR INTEREST PERFORMANCE EVENTS CALCULATE INTEREST EARNED AND
     C** RECEIVED (IER) AND REALISED FX P&L ON UNEARNED INTEREST
     C           WWRCDT    IFEQ 'T'                        B1
     C*
     C           WCPFMC    IFEQ 'IR'                       B2
     C           WWFILE    ANDEQ'PMPTRALL'
     C           WCPFMC    OREQ 'IR'
     C           WWFILE    ANDEQ'PMPCAALL'
     C           QSAPRA    ANDEQ'Y'
     C           WCPFMC    OREQ 'IP'
     C*
     C** FOR CUM COUPON EVENTS DETERMINE THE PROPORTION OF THE
     C** PERFORMANCE INTEREST EVENT AMOUNT (FOP) WHICH IS USED TO CANCEL
     C** THE EXISTING UNEARNED INTEREST POSITION
     C**-------------------------------------------------------------------
     C**IEventI Trans INominal IEvent NM *GTI Calculation IInterestI FOP I
     C**I Cat.I Type  IPositionIAbs Pos NM  I   of PIE    I Earned I     I
     C**I-----I-------I--------I------------I-------------I--------I-----I
     C**I IR  I  N/a  I  N/a   I     N/a    I     1       I   Y    I  1  I
     C**I IP  I TS,WI I + or 0 I     N/a    I     0       I   N    I  1  I
     C**I IP  I TS,WI I   -    I      N     I  Method 1   I   Y    I  1  I
     C**I IP  I TS,WI I   -    I      Y     I     1       I   Y    I  A  I
     C**I IP  I TP,WO I   +    I      Y     I     1       I   Y    I  A  I
     C**I IP  I TP,WO I   +    I      N     I  Method 1   I   Y    I  1  I
     C**I IP  I TP,WO I - or 0 I     N/a    I     0       I   N    I  1  I
     C**-----------------------------------------------------------------I
     C*
     C** FOR CALCULATIONS OF UNEARNED INTEREST USE CUM COUPON NOMINAL
     C** POSITION
     C                     Z-ADDWWINNM    WSINNM 150
     C           WWINNM    SUB  WWNMEX    WWINNM
     C**
     C** THE PROPORTION OF UNEARNED INTEREST (PIE) SETTLED BY THE
     C** PERFORMANCE EVENT IS CALCULATED FOR METHOD 1 IN TABLE AS:
     C**            NOMINAL ON INTEREST EVENT
     C**      PIE = -------------------------
     C**            ABSOLUTE NOMINAL POSITION
     C**
     C** IF A POSITION GOES LONG TO SHORT SOME OF THE INTEREST ON THE
     C** PERFORMANCE EVENT WILL GO TOWARDS A NEW UNEARNED INTEREST
     C** POSITION. HENCE THE FACTOR OF THE PERFORMANCE AMOUNT (FOP)
     C** IS THE PROPORTION OF THE PERFORMANCE AMOUNT WHICH IS TO BE
     C** OUTPUT AS INTEREST EARNED AND ON WHICH FX P&L IS CALCULATED.
     C** FOP IS AS SET UP IN ABOVE TABLE OTHER THAN WHEN 'A' ENTERED
     C** IN TABLE WHEN FOP CALCULATED AS:
     C**              SIGNED OLD NOMINAL POSITION
     C**        FOP = ---------------------------
     C**                TRADE NOMINAL AMOUNT
     C*
     C** CALCULATE PIE, INTEREST EARNED FLAG AND FOP AS PER ABOVE
     C           WCACIN    IFEQ 'C'                        B3
     C*
     C** CHECK WHETHER EVENT NOMINAL *GT ABSOLUTE VALUE OF NOMINAL
     C** POSITION
     C                     Z-ADDWWINNM    WWINNW 150
     C           WWINNM    IFLT 0                          B4
     C                     Z-SUBWWINNM    WWINNW
     C                     END                             E4
     C*
     C                     MOVE 'N'       WWPFGT  1
     C                     Z-ADD0         WWPIE  138
     C                     MOVE 'N'       WWIEFL  1
     C                     Z-ADD0         WWFOP  138
     C           WCRAMT    IFGT WWINNW                     B4
     C                     MOVE 'Y'       WWPFGT
     C                     END                             E4
     C*
     C** SET UP OUTPUT FIELDS FOR LINE 1 OF ABOVE TABLE
     C           WCPFMC    IFEQ 'IR'                       B4
     C                     Z-ADD1         WWPIE
     C                     MOVE 'Y'       WWIEFL
     C                     Z-ADD1         WWFOP
     C                     END                             E4
     C*
     C** SET UP OUTPUT FIELDS FOR LINE 2 - 6 OF ABOVE TABLE
     C           WCPFMC    IFEQ 'IP'                       B4
     C*
     C           WWINIO    IFEQ 'I'                        B5
     C*
     C** SET UP OUTPUT FIELDS FOR LINE 2 OF ABOVE TABLE
     C           WWINNM    IFGE 0                          B6
     C                     Z-ADD0         WWPIE
     C                     MOVE 'N'       WWIEFL
     C                     Z-ADD1         WWFOP
     C                     END                             E6
     C*
     C** SET UP OUTPUT FIELDS FOR LINE 3 OF ABOVE TABLE
     C           WWINNM    IFLT 0                          B6
     C           WWPFGT    ANDEQ'N'
     C           WCRAMT    DIV  WWINNW    WWPIE
     C                     MOVE 'Y'       WWIEFL
     C                     Z-ADD1         WWFOP
     C                     END                             E6
     C*
     C** SET UP OUTPUT FIELDS FOR LINE 4 OF ABOVE TABLE
     C           WWINNM    IFLT 0                          B6
     C           WWPFGT    ANDEQ'Y'
     C                     Z-ADD1         WWPIE
     C                     MOVE 'Y'       WWIEFL
     C****       WWINNM    DIV  WCRAMT    WWFOP                           72242
     C           WWINNW    DIV  WCRAMT    WWFOP                           72242
     C                     END                             E6
     C                     END                             E5
     C*
     C           WWINIO    IFEQ 'O'                        B5
     C*
     C** SET UP OUTPUT FIELDS FOR LINE 5 OF ABOVE TABLE
     C           WWINNM    IFGT 0                          B6
     C           WWPFGT    ANDEQ'Y'
     C                     Z-ADD1         WWPIE
     C                     MOVE 'Y'       WWIEFL
     C           WWINNM    DIV  WCRAMT    WWFOP
     C                     END                             E6
     C*
     C** SET UP OUTPUT FIELDS FOR LINE 6 OF ABOVE TABLE
     C           WWINNM    IFGT 0                          B6
     C           WWPFGT    ANDEQ'N'
     C           WCRAMT    DIV  WWINNW    WWPIE
     C                     MOVE 'Y'       WWIEFL
     C                     Z-ADD1         WWFOP
     C                     END                             E6
     C*
     C** SET UP OUTPUT FIELDS FOR LINE 7 OF ABOVE TABLE
     C           WWINNM    IFLE 0                          B6
     C           WWINIO    ANDEQ'O'
     C                     Z-ADD0         WWPIE
     C                     MOVE 'N'       WWIEFL
     C                     Z-ADD1         WWFOP
     C                     END                             E6
     C                     END                             E5
     C                     END                             E4
     C*
     C** IF INTEREST EARNED FLAG SET TO 'Y' CALCULATE INTEREST EARNED
     C** AND RECEIVED AS:
     C**    IER = (FOP X PERFORMANCE EVENT AMOUNT) - (PIE X UNEARNED
     C**          INTEREST) X FX RATE FROM EVENT
     C** ABOVE EQUATION IS EQUIVALENT TO FOLLOWING PROCESSING:
     C**  1) CALCULATE INTEREST EARNED IN INSTRUMENT CURRENCY AS
     C**     IER INSTRUMENT CCY = (FOP X PERF AMOUNT) - (PIE X UI)
     C**  2) CONVERT AMOUNT INTO PORTFOLIO CURRENCY USING FX RATE
     C**     ON PERFORMANCE EVENT
     C*
     C           WWIEFL    IFEQ 'Y'                        B4
     C*
     C           WWINIO    IFEQ 'I'                        B5
     C                     Z-SUBWCTAMT    WWVALU
     C                     ELSE                            X5
     C                     Z-ADDWCTAMT    WWVALU
     C                     END                             E5
     C*
     C           WWFOP     MULT WWVALU    WWVALU    H
     C           WWPIE     MULT WWUINT    WWVAL1 150H
     C           WWVALU    SUB  WWVAL1    WWVALU
     C*
     C** CONVERT AMOUNT FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C                     Z-ADDWWVALU    ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C*
     C** OUTPUT AMOUNT CALCULATED ABOVE AS PERFORMANCE EVENT
     C                     MOVE 'IER'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDZAMTT     PFMA,I
     C                     ADD  1         I
     C                     END                             E4
     C                     END                             E3
     C*
     C** FOR EX COUPON EVENTS REVERSE SIGN OF EVENT AMOUNT AND CONVERT
     C** TO PORTFOLIO CURRENCY
     C           WCACIN    IFEQ 'X'                        B3
     C********** WWINIO    ANDEQ'O'                                078956103072
     C*
     C           WWINIO    IFEQ 'O'
     C                     Z-SUBWCTAMT    ZAMTF
     C                     ELSE
     C                     Z-ADDWCTAMT    ZAMTF
     C                     END
     C*
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C*
     C** OUTPUT AMOUNT CALCULATED ABOVE AS PERFORMANCE EVENT
     C                     MOVE 'IER'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDZAMTT     PFMA,I
     C                     ADD  1         I
     C                     END                             E3
     C*
     C** CALCULATE REALISED FX P&L ON UNEARNED INTEREST FOR CUM COUPON
     C** INTEREST EVENTS
     C*
     C** THE UNEARNED INTEREST SETTLED BY THE INTEREST EVENT IS
     C** CALCULATED AS PER THE TABLE BELOW FOR IP EVENTS
     C**  -----------------------------------------------------
     C**  I NOMINAL  I IN /  I INT EVENT NOM *GTI   UI        I
     C**  I POSITION I  OUT  I ABS NOM POSITION I SETTLED     I
     C**  I------------------I------------------I-------------I
     C**  I    +     I   I   I     N/a          I    0        I
     C**  I    +     I   O   I      Y           I SET TO UI   I
     C**  I    +     I   O   I      N           I  CALCN 1    I
     C**  I    -     I   I   I      Y           I SET TO UI   I
     C**  I    -     I   I   I      N           I  CALCN 1    I
     C**  I    -     I   O   I     N/a          I SET TO 0    I
     C**  -----------------------------------------------------
     C*
     C** CALCULATION 1 FROM ABOVE TABLE IS AS BELOW:
     C**    UI SETTLED = UI X (PERFORMANCE EVENT NOMINAL AMOUNT /
     C**                       ABSOLUTE NOMINAL POSITION)
     C           WCACIN    IFEQ 'C'                        B3
     C           WWIEFL    ANDEQ'Y'
     C*
     C           WCPFMC    IFEQ 'IP'                       B4
     C*
     C** CALCULATE UNEARNED INTEREST SETTLED AS PER TABLE ABOVE
     C                     Z-ADD0         WWUIS  150
     C*
     C** CALCULATE AS PER LINE 2 OF ABOVE TABLE (SET TO 0 ALREADY
     C** THEREFORE CHECK FOR LINE 1 & 6 NOT REQUIRED)
     C           WWINNM    IFGT 0                          B5
     C           WWINIO    ANDEQ'O'
     C           WWPFGT    ANDEQ'Y'
     C                     Z-ADDWWUINT    WWUIS
     C                     END                             E5
     C*
     C** CALCULATE AS PER LINE 3 OF ABOVE TABLE
     C           WWINNM    IFGT 0                          B5
     C           WWINIO    ANDEQ'O'
     C           WWPFGT    ANDEQ'N'
     C           WCRAMT    DIV  WWINNW    WWFACT 158H
     C           WWFACT    MULT WWUINT    WWUIS     H
     C                     END                             E5
     C*
     C** CALCULATE AS PER LINE 4 OF ABOVE TABLE
     C           WWINNM    IFLT 0                          B5
     C           WWINIO    ANDEQ'I'
     C           WWPFGT    ANDEQ'Y'
     C                     Z-ADDWWUINT    WWUIS
     C                     END                             E5
     C*
     C** CALCULATE AS PER LINE 5 OF ABOVE TABLE
     C           WWINNM    IFLT 0                          B5
     C           WWINIO    ANDEQ'I'
     C           WWPFGT    ANDEQ'N'
     C           WCRAMT    DIV  WWINNW    WWFACT    H
     C           WWFACT    MULT WWUINT    WWUIS     H
     C                     END                             E5
     C*
     C** OTHERWISE FOR 'IR' SET TO TOTAL OUTSTANDING UNEARNED INTEREST
     C                     ELSE                            X4
     C                     Z-ADDWWUINT    WWUIS
     C                     END                             E4
     C*
     C** REALISED FX P&L ON INTEREST IS THEN CALCULATED AS:
     C**    XIR = UIS X (FXT - BKUI / UI)
     C**    WHERE FXT = FX RATE ON PERFORMANCE EVENT
     C**          BKUI = BOOK COST OF UNEARNED INTEREST IN PORTFOLIO CCY
     C**          UI  = UNEARNED INTEREST POSITION
     C** TO CALCULATE ABOVE EQUATION FOLLOWING PROCESSING REQUIRED:
     C**   1) DETERMINE AVERAGE FX RATE FROM BKUI / UI VIA SR/ZFXAVP
     C**   2) CONVERT UNEARNED INTEREST FROM INSTRUMENT CURRENCY TO
     C**      PORTFOLIO CURRENCY USING FXT AND AVERAGE FX RATE
     C**      CALCULATED IN (1)
     C**   3) DIFFERENCE BETWEEN TWO AMOUNTS IS XIR
     C*
     C** CALCULATE AVERAGE FX RATE
     C                     Z-ADDWWUINT    ZAPNM
     C                     Z-ADDWWBKUI    ZFXAP
     C                     Z-ADDWWICDP    ZNMCD
     C                     Z-ADDWWPCDP    ZPTCD
     C                     EXSR ZFXAVP
     C                     Z-ADDZAVFX     WWFXA  138
     C*
     C** CONVERT UIS FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C** USING FX RATE FROM PERFORMANCE EVENT
     C                     Z-ADDWWUIS     ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C                     Z-ADDZAMTT     WWFXT  150
     C*
     C** CONVERT UIS FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C** USING AVERAGE FX RATE
     C                     Z-ADDWWUIS     ZAMTF
     C                     Z-ADDWWFXA     ZCRSRT
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXR
     C                     Z-ADDZAMTT     WWFXAM 150
     C*
     C           WWFXT     SUB  WWFXAM    WWVAPT
     C*
     C** OUTPUT REALISED INTEREST P&L
     C                     MOVE 'XIR'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWVAPT    PFMA,I
     C                     ADD  1         I
     C                     END                             E3
     C*
     C                     Z-ADDWSINNM    WWINNM
     C                     END                             E2
     C                     END                             E1
     C*
     C** OUTPUT RECORDS FOR PERFORMANCE EVENTS DV,F,T,OT,C
     C** ADD AMOUNT CONVERTED TO PORTFOLIO CURRENCY INTO ARRAY OF
     C** PERFORMANCE EVENTS
     C           WWRCDT    IFEQ 'T'                        B1
     C*
     C           WCPFMC    IFEQ 'DV'                       B2
     C           WCPFMC    OREQ 'F '
     C           WCPFMC    OREQ 'T '
     C           WCPFMC    OREQ 'OT'
     C           WCPFMC    OREQ 'C '
     C           WCPFMC    OREQ 'IR'
     C           WWFILE    ANDEQ'PMPCAALL'
     C           QSAPRA    ANDNE'Y'
     C*
     C           WCPFMC    IFEQ 'IR'
     C                     MOVE 'IER'     PFMC,I
     C                     MOVE *BLANKS   PFMS,I
     C                     ELSE
     C                     MOVELWCPFMC    PFMC,I
     C                     MOVELWCPFMS    PFMS,I
     C                     END
     C*
     C           WWINIO    IFEQ 'O'                        B3
     C                     Z-ADDWWVALP    PFMA,I
     C                     ELSE                            X3
     C                     Z-SUBWWVALP    PFMA,I
     C                     END                             E3
     C                     ADD  1         I
     C                     END                             E2
     C*
     C** FOR CHARGES ON DEPOT MOVEMENTS OUTPUT CX RECORD TO ALTER
     C** CHANGE IN INVESTED CAPITAL
     C           WCPFMC    IFEQ 'C '                       B2
     C           WCTTYP    ANDEQ'WO'
     C           WCPFMC    OREQ 'C '
     C           WCTTYP    ANDEQ'WI'
     C           QRPMED    SUB  WCPDAT    WWDIP   50
     C           WWDIP     SUB  1         WWDIP
     C*
     C           WWVALP    MULT WWDIP     WWVALW
     C           WWVALW    DIV  QRDYPP    WWVALW    H
     C*
     C                     MOVE 'CX '     PFMC,I
     C                     MOVE 'C  '     PFMS,I
     C                     Z-ADDWWVALW    PFMA,I
     C                     ADD  1         I
     C                     END                             E2
     C                     END                             E1
     C*
     C** CALCULATE REMAINING FIGURES (UNREALISED MARKET AND FX P&L
     C** OF UNREALISED P&L AT END OF PERFORMANCE PERIOD
     C           WWRCDT    IFEQ 'E'                        B1
     C*
     C** INTEREST EARNED NOT RECEIVED CALCULATED AS PER EQUATION BELOW:
     C**    IEU = (AI AT END - UNEARNED INTEREST) X FX RATE AT END
     C           WCACIS    SUB  WWUINT    WWINTE 150
     C*
     C** CONVERT INTEREST EARNED FROM NOMINAL CURRENCY TO PORTFOLIO
     C** CURRENCY USING FX RATE AT END
     C                     Z-ADDWWINTE    ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C*
     C** OUTPUT INTEREST EARNED NOT RECEIVED RECORD
     C                     MOVE 'IEU'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDZAMTT     PFMA,I
     C                     ADD  1         I
     C*
     C** UNREALISED FX P&L ON UNEARNED INTEREST. THIS IS CALCULATED
     C** USING EQUATION:
     C**    XIU = UI X (FXT - BKUI / UI)
     C** THIS IS CALCULATED AS PER REALISED INTEREST ABOVE BUT USING
     C** TOTAL UNEARNED INTEREST OUTSTANDING AT END OF PERIOD
     C*
     C** CALCULATE AVERAGE FX RATE FOR UNEARNED INTEREST
     C                     Z-ADDWWUINT    ZAPNM
     C                     Z-ADDWWBKUI    ZFXAP
     C                     Z-ADDWWICDP    ZNMCD
     C                     Z-ADDWWPCDP    ZPTCD
     C                     EXSR ZFXAVP
     C                     Z-ADDZAVFX     WWFXA  138
     C*
     C** CONVERT UI FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C** USING FX RATE FROM PERFORMANCE EVENT
     C                     Z-ADDWWUINT    ZAMTF
     C                     Z-ADDWCMFXR    ZCRSRD
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXD
     C                     Z-ADDZAMTT     WWFXT  150
     C*
     C** CONVERT UIS FROM NOMINAL CURRENCY TO PORTFOLIO CURRENCY
     C** USING AVERAGE FX RATE
     C                     Z-ADDWWUINT    ZAMTF
     C                     Z-ADDWWFXA     ZCRSRT
     C                     MOVE 'M'       ZCRSMD
     C                     Z-ADDWWICDP    ZCDPF
     C                     Z-ADDWWPCDP    ZCDPT
     C                     EXSR ZCCYXR
     C                     Z-ADDZAMTT     WWFXAM 150
     C*
     C           WWFXT     SUB  WWFXAM    WWVAPT
     C*
     C** OUTPUT REALISED INTEREST P&L
     C                     MOVE 'XIU'     PFMC,I
     C                     MOVE '   '     PFMS,I
     C                     Z-ADDWWVAPT    PFMA,I
     C                     ADD  1         I
     C                     END                             E1
     C*
     C           #CLPF9    ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #CLPOS   - CALCULATE NEW POSITIONS                               *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZAPNUM   -                                                       *
      * ZFXAPN   -                                                       *
      * #NWUI    - CALCULATE NEW UNEARNED INTEREST & COST OF UI FIGS     *
      * #NWAPN   - CALCULATE NEW AP NUMERATOR AND FX AP NUMERATOR        *
      * #FMT89   - PREPARE DETAILS FOR OUTPUT TO FORMATS 8 & 9           *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWRCDT   -                                                       *
      * WWNOML   -                                                       *
      * WWICDP   -                                                       *
      * WWAPNM   -                                                       *
      * WWPCDP   -                                                       *
      * WWFXAP   -                                                       *
      * WWUINT   -                                                       *
      * WWBKUI   -                                                       *
      * WWFILE   -                                                       *
      * WWINNM   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #CLPOS    BEGSR
     C*
     C** AT START OF PERFORMANCE PERIOD SET POSITION DETAILS TO AMOUNTS
     C***FROM*PF/PMPSTCPP*************************************************S01486
     C** FROM PF/PMPSTCPD                                                 S01486
     C           WWRCDT    IFEQ 'S'                        B1
     C                     Z-ADDWCTAMT    WWNOML
     C*
     C** AP NUMERATOR = NOMINAL X MARKET PRICE AT START
     C           WCMODI    IFEQ 'SE'                       B2
     C           WCMODI    OREQ 'FO'                                      075998
     C           WCMPRC    ANDNE*LOVAL                                    075998
     C                     Z-ADDWCTAMT    ZNOML
     C                     Z-ADDWCMPRC    ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDWWICDP    ZNMCD
     C                     MOVE 'U'       ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     WWAPNM
     C                     ELSE                            X2
     C                     Z-ADDWCTAMT    WWAPNM
     C*                                                                   075998
     C** IF NO PRICE HAS BEE ENTERED FOR AN OPTION POSITION SET           075998
     C** CURRENT VALUE TO 0                                               075998
     C           WCMODI    IFEQ 'FO'                       B3             075998
     C           WCMPRC    ANDEQ*LOVAL                                    075998
     C                     Z-ADD0         WWVALU                          075998
     C                     END                             E3             075998
     C*                                                                   075998
     C                     END                             E2
     C*
     C** FX AP NUMERATOR = AP NUMERATOR CONVERTED TO PORTFOLIO CURRENCY
     C** AT FX RATE APPLYING AT START OF PERIOD
     C                     Z-ADDWWAPNM    ZAPNM
     C                     Z-ADDWCMFXR    ZFXRD
     C                     Z-ADDWWICDP    ZNMCD
     C                     Z-ADDWWPCDP    ZPTCD
     C                     EXSR ZFXAPD
     C                     Z-ADDZFXAP     WWFXAP
     C*
     C** UNEARNED INTEREST SET TO ACCRUED INTEREST AT START
     C                     Z-ADDWCACIS    WWUINT
     C*
     C** UNEARNED INTEREST CONVERTED TO PORTFOLIO CURRENCY AT FX RATE
     C** AT START
     C                     Z-ADDWWUINT    ZAPNM
     C                     Z-ADDWCMFXR    ZFXRD
     C                     Z-ADDWWICDP    ZNMCD
     C                     Z-ADDWWPCDP    ZPTCD
     C                     EXSR ZFXAPD
     C                     Z-ADDZFXAP     WWBKUI
     C                     END                             E1
     C*
     C** FOR INTEREST PAYMENT EVENT UNEARNED INTEREST RESET TO 0
     C           WWRCDT    IFEQ 'T'                        B1
     C           WCPFMC    ANDEQ'IR'
     C           WWFILE    ANDEQ'PMPTRALL'
     C           WCPFMC    OREQ 'IR'
     C           WWFILE    ANDEQ'PMPCAALL'
     C           QSAPRA    ANDEQ'Y'
     C                     EXSR #NWUI
     C                     Z-ADDWWNUIN    WWUINT
     C                     Z-ADDWWNBKU    WWBKUI
     C                     END                             E1
     C*
     C** UNEARNED INTEREST (UI) AND BOOK COST OF UNEARNED INTEREST
     C** (BKUI) RECALCULATED FOR CUM COUPON SE INTEREST EVENTS
     C           WWRCDT    IFEQ 'T'                        B1
     C           WCACIN    ANDEQ'C'
     C           WCMODI    ANDEQ'SE'
     C           WCPFMC    ANDEQ'IP'
     C                     EXSR #NWUI
     C                     Z-ADDWWNUIN    WWUINT
     C                     Z-ADDWWNBKU    WWBKUI
     C                     END                             E1
     C*
     C** IF PROCESSING NOMINAL PERFORMANCE EVENT CALCULATE NEW NOMINAL
     C** POSITION
     C           WWRCDT    IFEQ 'T'                        B1
     C           WCPFMC    ANDEQ' N'
     C                     Z-ADDWWNOML    WWINNM 150
     C                     EXSR #NWAPN
     C                     Z-ADDWWNNML    WWNOML
     C                     Z-ADDWWNAPN    WWAPNM
     C                     Z-ADDWWNFXN    WWFXAP
     C                     Z-ADDWWNNMX    WWNMEX
     C                     END                             E1
     C*
     C** PERFORM ROUTINE #FMT89 TO FORMAT NEW POSITION DETAILS
     C                     EXSR #FMT89
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #NWUI    - CALCULATE NEW UNEARNED INTEREST & COST OF UI FIGS     *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZFXAPN   -                                                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CLPFM   - CALCULATE PERFORMANCE FIGURES FOR LIVE NON-FX POS     *
      * #CLPOS   - CALCULATE NEW POSITIONS                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWRCDT   -                                                       *
      * WWFILE   -                                                       *
      * WWNUIN   -                                                       *
      * WWNBKU   -                                                       *
      * WWNMAB   -                                                       *
      * WWINNM   -                                                       *
      * WWENGT   -                                                       *
      * WWICDP   -                                                       *
      * WWPCDP   -                                                       *
      * WWTABK   -                                                       *
      * WWINIO   -                                                       *
      * WWNWNM   -                                                       *
      * WWFACT   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #NWUI     BEGSR
     C*
     C** FOR INTEREST PAYMENT EVENT UNEARNED INTEREST RESET TO 0
     C           WWRCDT    IFEQ 'T'                        B1
     C           WCPFMC    ANDEQ'IR'
     C           WWFILE    ANDEQ'PMPTRALL'
     C           WCPFMC    OREQ 'IR'
     C           WWFILE    ANDEQ'PMPCAALL'
     C           QSAPRA    ANDEQ'Y'
     C                     Z-ADD0         WWNUIN
     C                     Z-ADD0         WWNBKU
     C                     END                             E1
     C*
     C** UNEARNED INTEREST (UI) AND BOOK COST OF UNEARNED INTEREST
     C** (BKUI) ARE RECALCULATED FOR CUM COUPON SE INTEREST EVENTS AS
     C** PER TABLE BELOW:
     C**       -----------------------------------------------------------
     C**       INom PosITrans  IEvent Nom >I                             I
     C**       I (Cum) Itype   Iabs Pos NomI Calculation of UI           I
     C**       I-------I-------I-----------I-----------------------------I
     C**       I  +    I TS,WI I   N/a     I UI + Purchased Int on trade I
     C**       I       I TP,WO I    Y      I Calculation 1               I
     C**       I       I TP,WO I    N      I Calculation 2               I
     C**       I  -    I TS,WI I    Y      I Calculation 3               I
     C**       I       I TS,WI I    N      I Calculation 4               I
     C**       I       I TP,WO I   N/a     I UI - Purchased Int on trade I
     C**       I  0    I TS,WI I   N/a     I + Purchased Int on trade    I
     C**       I  0    I TP,WO I   N/a     I - Purchased Int on trade    I
     C**       -----------------------------------------------------------
     C*
     C** FOR CALCULATIONS OF UNEARNED INTEREST USE CUM COUPON NOMINAL
     C** POSITION
     C                     Z-ADDWWINNM    WSINNM 150
     C           WWINNM    SUB  WWNMEX    WWINNM
     C*
     C           WWRCDT    IFEQ 'T'                        B1
     C           WCACIN    ANDEQ'C'
     C           WCMODI    ANDEQ'SE'
     C           WCPFMC    ANDEQ'IP'
     C*
     C** DETERMINE ABSOLUTE NOMINAL POSITION AMD CHECK WHETHER EVENT
     C** NOMINAL *GT ABSOLUTE POSITION NOMINAL
     C                     Z-ADDWWINNM    WWNMAB 150
     C           WWINNM    IFLT 0                          B2
     C                     Z-SUBWWINNM    WWNMAB
     C                     END                             E2
     C*
     C           WCRAMT    IFGT WWNMAB                     B2
     C                     MOVE 'Y'       WWENGT  1
     C                     ELSE                            X2
     C                     MOVE 'N'       WWENGT
     C                     END                             E2
     C*
     C** AMOUNT ON PERFORMANCE INTEREST EVENT CONVERTED TO PORTFOLIO
     C** CURRENCY AT FX RATE ON EVENT
     C                     Z-ADDWCTAMT    ZAPNM
     C                     Z-ADDWCMFXR    ZFXRD     H
     C                     Z-ADDWWICDP    ZNMCD
     C                     Z-ADDWWPCDP    ZPTCD
     C                     EXSR ZFXAPD
     C                     Z-ADDZFXAP     WWTABK 150
     C*
     C** CALCULATE NEW INTEREST POSITION AS PER LINE 1 OF TABLE
     C           WWINNM    IFGT 0                          B2
     C           WWINIO    ANDEQ'I'
     C           WWUINT    ADD  WCTAMT    WWNUIN 150
     C           WWBKUI    ADD  WWTABK    WWNBKU 150
     C                     END                             E2
     C*
     C** CALCULATE NEW INTEREST POSITION AS PER LINE 2 OF TABLE
     C** WHERE CALCULATION 1 IS SHOWN BELOW:
     C**         OLD POS NOM - TRADE NOM
     C**    UI = ----------------------- X PURCHASED INT
     C**               TRADE NOMINAL
     C           WWINNM    IFGT 0                          B2
     C           WWINIO    ANDEQ'O'
     C           WWENGT    ANDEQ'Y'
     C           WWINNM    SUB  WCRAMT    WWNWNM 150
     C           WWNWNM    DIV  WCRAMT    WWFACT    H
     C           WWFACT    MULT WCTAMT    WWNUIN    H
     C           WWFACT    MULT WWTABK    WWNBKU    H
     C                     END                             E2
     C*
     C** CALCULATE NEW INTEREST POSITION AS PER LINE 3 OF TABLE
     C** WHERE CALCULATION 2 IS SHOWN BELOW:
     C**          OLD POS NOM - TRADE NOM
     C** NEW UI = ----------------------- X UI
     C***             OLD POS NOMINAL
     C           WWINNM    IFGT 0                          B2
     C           WWINIO    ANDEQ'O'
     C           WWENGT    ANDEQ'N'
     C           WWINNM    SUB  WCRAMT    WWNWNM 150
     C           WWNWNM    DIV  WWINNM    WWFACT    H
     C           WWFACT    MULT WWUINT    WWNUIN    H
     C           WWFACT    MULT WWBKUI    WWNBKU    H
     C                     END                             E2
     C*
     C** CALCULATE NEW INTEREST POSITION AS PER LINE 4 OF TABLE
     C** WHERE CALCULATION 3 IS SHOWN BELOW:
     C**         OLD POS NOM + TRADE NOM
     C**    UI = ----------------------- X PURCHASED INT
     C**             TRADE NOMINAL
     C           WWINNM    IFLT 0                          B2
     C           WWINIO    ANDEQ'I'
     C           WWENGT    ANDEQ'Y'
     C           WWINNM    ADD  WCRAMT    WWNWNM 150
     C           WWNWNM    DIV  WCRAMT    WWFACT    H
     C****       WWFACT    MULT WWNUIN    WWNUIN    H                     72242
     C****       WWFACT    MULT WWNBKU    WWNBKU    H                     72242
     C           WWFACT    MULT WCTAMT    WWNUIN    H                     72242
     C           WWFACT    MULT WWTABK    WWNBKU    H                     72242
     C                     END                             E2
     C*
     C** CALCULATE NEW INTEREST POSITION AS PER LINE 5 OF TABLE
     C** WHERE CALCULATION 4 IS SHOWN BELOW:
     C**          OLD POS NOM + TRADE NOM
     C** NEW UI = ----------------------- X UI
     C**              OLD POS NOMINAL
     C           WWINNM    IFLT 0                          B2
     C           WWINIO    ANDEQ'I'
     C           WWENGT    ANDEQ'N'
     C           WWINNM    ADD  WCRAMT    WWNWNM 150
     C           WWNWNM    DIV  WWINNM    WWFACT    H
     C           WWFACT    MULT WWUINT    WWNUIN    H
     C           WWFACT    MULT WWBKUI    WWNBKU    H
     C                     END                             E2
     C*                                                                   72242
     C** CALCULATE NEW INTEREST POSITION AS PER LINE 6 OF TABLE           72242
     C           WWINNM    IFLT 0                          B2             72242
     C           WWINIO    ANDEQ'O'                                       72242
     C           WWUINT    SUB  WCTAMT    WWNUIN 150                      72242
     C           WWBKUI    SUB  WWTABK    WWNBKU 150                      72242
     C                     END                             E2             72242
     C*
     C** CALCULATE NEW INTEREST POSITION AS PER LINE 6 OF TABLE
     C           WWINNM    IFEQ 0                          B2
     C           WWINIO    ANDEQ'I'
     C                     Z-ADDWCTAMT    WWNUIN
     C                     Z-ADDWWTABK    WWNBKU
     C                     END                             E2
     C*
     C** CALCULATE NEW INTEREST POSITION AS PER LINE 7 OF TABLE
     C           WWINNM    IFEQ 0                          B2
     C           WWINIO    ANDEQ'O'
     C                     Z-SUBWCTAMT    WWNUIN
     C                     Z-SUBWWTABK    WWNBKU
     C                     END                             E2
     C                     END                             E1
     C*
     C                     Z-ADDWSINNM    WWINNM 150
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #NWAPN   - CALCULATE NEW AP NUMERATOR AND FX AP NUMERATOR        *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZAPNUM   -                                                       *
      * ZFXAPN   -                                                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CLPFM   - CALCULATE PERFORMANCE FIGURES FOR LIVE NON-FX POS     *
      * #CLPOS   - CALCULATE NEW POSITIONS                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWNNML   -                                                       *
      * WWNAPN   -                                                       *
      * WWNFXN   -                                                       *
      * WWOLAB   -                                                       *
      * WWNOML   -                                                       *
      * WWENGT   -                                                       *
      * WWOLNM   -                                                       *
      * WWINIO   -                                                       *
      * WWNMAB   -                                                       *
      * WWICDP   -                                                       *
      * WWPCDP   -                                                       *
      * WWFACT   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #NWAPN    BEGSR
     C*
     C** RESET WORKFIELDS TO STARTING POSITIONS
     C                     Z-ADDWWNOML    WWNNML
     C                     Z-ADDWWAPNM    WWNAPN
     C                     Z-ADDWWFXAP    WWNFXN
     C                     Z-ADDWWNMEX    WWNNMX
     C*
     C** FOR NON-SE POSITION SET MARKET PRICE TO 1
     C           WCMODI    IFNE 'SE'
     C           WCMODI    ANDNE'FO'                                      075998
     C                     Z-ADD1         WCMPRC
     C                     END
     C*
     C** DETERMINE ABSOLUTE NOMINAL POSITION AMD CHECK WHETHER EVENT
     C** NOMINAL *GT ABSOLUTE POSITION NOMINAL
     C                     Z-ADDWWNOML    WWOLAB 150
     C           WWNOML    IFLT 0                          B1
     C                     Z-SUBWWNOML    WWOLAB
     C                     END                             E1
     C*
     C           WCTAMT    IFGT WWOLAB                     B1
     C                     MOVE 'Y'       WWENGT  1
     C                     ELSE                            X1
     C                     MOVE 'N'       WWENGT
     C                     END                             E1
     C*
     C** FOR NON PART PAYMENT EVENT CALCULATE NEW NOMINAL POSITON
     C                     Z-ADDWWNOML    WWOLNM 150
     C           WCPPYT    IFNE 'Y'                        B1
     C           WWINIO    IFEQ 'I'                        B2
     C                     ADD  WCTAMT    WWNNML 150
     C                     ELSE                            X2
     C                     SUB  WCTAMT    WWNNML
     C                     END                             E2
     C                     END                             E1
     C*
     C** FOR NON PART PAYMENT EX-COUPON EVENT CALCULATE NEW EX-
     C** COUPON NOMINAL
     C                     Z-ADDWWNMEX    WWOLEX 150
     C           WCPPYT    IFNE 'Y'                        B1
     C           WCACIN    ANDEQ'X'                        B1
     C           WWINIO    IFEQ 'I'                        B2
     C                     ADD  WCTAMT    WWNNMX 150
     C                     ELSE                            X2
     C                     SUB  WCTAMT    WWNNMX
     C                     END                             E2
     C                     END                             E1
     C*
     C** DETERMINE ABSOLUTE VALUE OF NEW NOMINAL POSITION
     C                     Z-ADDWWNNML    WWNMAB 150
     C           WWNNML    IFLT 0                          B1
     C                     Z-SUBWWNNML    WWNMAB
     C                     END                             E1
     C*
     C** CALCULATE NEW AP NUMERATOR AND FX AP NUMERATOR AS PER TABLE BELOW:
     C**     -------------------------------------------------------------
     C**     I       I      IEvent NM  > I                               I
     C**     IOld NM IIn/OutIabs Old NM  I Calculation of BCN            I
     C**     I-------I------I------------I-------------------------------I
     C**     I + / 0 I  I   I   N/a      I Calculation 1                 I
     C**     I   +   I  O   I    Y       I Calculation 2                 I
     C**     I   +   I  O   I    N       I Calculation 3                 I
     C**     I   -   I  I   I    Y       I Calculation 2                 I
     C**     I   -   I  I   I    N       I Calculation 3                 I
     C**     I - / 0 I  O   I   N/a      I Calculation 4                 I
     C**     -------------------------------------------------------------
     C*
     C** FIRST CALCULATE CHANGE TO AP NUMERATOR DUE TO PERFORMANCE
     C** EVENT VI SR/ZAPNUM
     C           WCMODI    IFEQ 'SE'                       B1
     C           WCMODI    OREQ 'FO'                                      075998
     C                     Z-ADDWCTAMT    ZNOML
     C                     Z-ADDWCMPRC    ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDWWICDP    ZNMCD
     C                     MOVE 'U'       ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     WEAPNM 150
     C                     ELSE                            X1
     C                     Z-ADDWCTAMT    WEAPNM
     C                     END                             E1
     C*
     C** CALCULATE CHANGE TO FX AP NUMERATOR DUE TO PERFORMANCE EVENT
     C                     Z-ADDWEAPNM    ZAPNM
     C                     Z-ADDWCMFXR    ZFXRD     H
     C                     Z-ADDWWICDP    ZNMCD
     C                     Z-ADDWWPCDP    ZPTCD
     C                     EXSR ZFXAPD
     C                     Z-ADDZFXAP     WEFXAP 150
     C*
     C** ALSO CALCULATE AP NUMERATOR AND FX AP NUMERATOR FOR NEW
     C** NOMINAL AND PRICE AND FX RATE FROM PERFORMANCE EVENT
     C           WCMODI    IFEQ 'SE'                       B1
     C                     Z-ADDWWNNML    ZNOML
     C                     Z-ADDWCMPRC    ZAVPR
     C                     Z-ADDNMDP      ZNMDP
     C                     Z-ADDWWICDP    ZNMCD
     C                     MOVE 'U'       ZPRCB
     C                     EXSR ZAPNUM
     C                     Z-ADDZVALU     WNAPNM 150
     C                     ELSE                            X1
     C                     Z-ADDWWNNML    WNAPNM
     C                     END                             E1
     C*
     C** CALCULATE CHANGE TO FX AP NUMERATOR DUE TO PERFORMANCE EVENT
     C                     Z-ADDWNAPNM    ZAPNM
     C                     Z-ADDWCMFXR    ZFXRD     H
     C                     Z-ADDWWICDP    ZNMCD
     C                     Z-ADDWWPCDP    ZPTCD
     C                     EXSR ZFXAPD
     C                     Z-ADDZFXAP     WNFXAP 150
     C*
     C** CALCULATE NEW NUMERATORS AS PER LINE 1 OF TABLE WHERE
     C** CALCULATION 1 IS SHOWN BELOW:
     C**   NEW APNM = OLD APNM + AP NUMERATOR FOR EVENT
     C**   NEW FXAP = OLD FXAP + FX AP NUMERATOR FOR EVENT
     C           WWOLNM    IFGE 0                          B1
     C           WWINIO    ANDEQ'I'
     C           WWAPNM    ADD  WEAPNM    WWNAPN 150
     C           WWFXAP    ADD  WEFXAP    WWNFXN 150
     C                     END                             E1
     C*
     C** CALCULATE NEW NUMERATORS AS PER LINE 2 OF TABLE WHERE
     C** CALCULATION 2 IS SHOWN BELOW:
     C**   APNM = NEW NM X MARKET PRICE ON PERFORMANCE EVENT
     C**   FXAP = NEW NM X MARKET PRICE ON EVENT X FX RATE ON EVENT
     C** NOTE: THESE FIGURES ALREADY CALCULATED ABOVE
     C           WWOLNM    IFGT 0                          B1
     C           WWINIO    ANDEQ'O'
     C           WWENGT    ANDEQ'Y'
     C                     Z-ADDWNAPNM    WWNAPN
     C                     Z-ADDWNFXAP    WWNFXN
     C                     END                             E1
     C*
     C** CALCULATE NEW NUMERATORS AS PER LINE 3 OF TABLE WHERE
     C** CALCULATION 3 IS SHOWN BELOW:
     C**  APNM = OLD APNM X (ABSOLUTE NEW NM / ABSOLUTE OLD NM)
     C**  FXAP = OLD FXAP X (ABSOLUTE NEW NM / ABSOLUTE OLD NM)
     C           WWOLNM    IFGT 0                          B1
     C           WWINIO    ANDEQ'O'
     C           WWENGT    ANDEQ'N'
     C           WWNMAB    MULT WWAPNM    WWTEMP 308H
     C           WWTEMP    DIV  WWOLAB    WWNAPN    H
     C           WWNMAB    MULT WWFXAP    WWTEMP    H
     C           WWTEMP    DIV  WWOLAB    WWNFXN    H
     C                     END                             E1
     C*
     C** CALCULATE NEW NUMERATORS AS PER LINE 4 OF TABLE WHERE
     C** CALCULATION 2 IS AS DESCRIBED ABOVE
     C           WWOLNM    IFLT 0                          B1
     C           WWINIO    ANDEQ'I'
     C           WWENGT    ANDEQ'Y'
     C                     Z-ADDWNAPNM    WWNAPN
     C                     Z-ADDWNFXAP    WWNFXN
     C                     END                             E1
     C*
     C** CALCULATE NEW NUMERATORS AS PER LINE 5 OF TABLE WHERE
     C** CALCULATION 3 IS AS DESCRIBED ABOVE
     C           WWOLNM    IFLT 0                          B1
     C           WWINIO    ANDEQ'I'
     C           WWENGT    ANDEQ'N'
     C           WWNMAB    MULT WWAPNM    WWTEMP 308H
     C           WWTEMP    DIV  WWOLAB    WWNAPN    H
     C           WWNMAB    MULT WWFXAP    WWTEMP    H
     C           WWTEMP    DIV  WWOLAB    WWNFXN    H
     C                     END                             E1
     C*
     C** CALCULATE NEW NUMERATORS AS PER LINE 6 OF TABLE WHERE
     C** CALCULATION 4 IS AS DESCRIBED BELOW:
     C**    APNM = OLD APNM - CHANGE TO AP NUMERATOR
     C**    FXAP = OLD FXAP - CHANGE TO FX AP NUMERATOR
     C           WWOLNM    IFLE 0                          B1
     C           WWINIO    ANDEQ'O'
     C           WWAPNM    SUB  WEAPNM    WWNAPN
     C           WWFXAP    SUB  WEFXAP    WWNFXN
     C                     END                             E1
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #PORTD   - ACCESS PORTFOLIO DEFINITION DETAILS                   *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *
      * ZDATE2   -                                                       *
      * #CURRD   - ACCESS CURRENCY DETAILS                               *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      * #DELET   - PROCESS DELETED FI, MD, ML, LE AND FX POSITIONS       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWCCY    -                                                       *
      * WWPCDP   -                                                       *
      * WWPSPR   -                                                       *
      * WWPMDI   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #PORTD    BEGSR
     C*
     C** OBTAIN PORTFOLIO DETAILS
     C***********PORTKY    CHAINPMPORTPP             61                   S01486
     C           PORTKY    CHAINPMPORTPD             61                   S01486
     C*
     C           *IN61     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD1         DBASE
     C                     MOVE *BLANKS   DBFILE           ***************
     C***********          MOVEL'PMPORTPP'DBFILE           * DBERROR 001 *S01486
     C                     MOVE 'PMPORTPD'DBFILE           * DBERROR 001 *S01486
     C                     MOVELQRCNUM    DBKEY            ***************
     C                     MOVE QRPTFR    DBKEY
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     END
     C*
     C** FORMAT PORTFOLIO DETAILS FOR OUTPUT
     C                     MOVE PNCNUM    RRCNUM
     C*                                                                   CPM005
     C           PNPTFR    IFEQ '9997'                                    CPM005
     C                     MOVE FCR997    RRPTFR                          CPM005
     C                     ELSE                                           CPM005
     C           PNPTFR    IFEQ '9998'                                    CPM005
     C                     MOVE FCR998    RRPTFR                          CPM005
     C                     ELSE                                           CPM005
     C           PNPTFR    IFEQ '9999'                                    CPM005
     C                     MOVE FCR999    RRPTFR                          CPM005
     C                     ELSE                                           CPM005
     C                     MOVE PNPTFR    RRPTFR
     C                     END                                            CPM005
     C                     END                                            CPM005
     C                     END                                            CPM005
     C*                                                                   CPM005
     C                     MOVE PNPTCY    RRPTCY
     C*
     C** FORMAT START AND END OF PERIOD DATES
     C                     Z-ADDQRPMSD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RRPMSD
     C*
     C                     Z-ADDQRPMED    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RRPMED
     C*
     C** ON CHANGE OF PORTFOLIO CURRENCY OBTAIN NEW PORTFOLIO CCY DETAILS
     C           PNPTCY    IFNE WSPTCY                     B1
     C                     MOVE PNPTCY    WWCCY
     C                     EXSR #CURRD
     C                     Z-ADDA6NBDP    WWPCDP  10
     C                     Z-ADDA6SPRT    WWPSPR 138
     C                     MOVE A6MDIN    WWPMDI  1
     C                     MOVE PNPTCY    WSPTCY  3
     C                     END                             E1
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #CURRD   - ACCESS CURRENCY DETAILS                               *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      * #DELET   - PROCESS DELETED FI, MD, ML, LE AND FX POSITIONS       *
      * #PORTD   - ACCESS PORTFOLIO DEFINITION DETAILS                   *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWCCY    -                                                       *
      *                                                                  *
      ********************************************************************
     C           #CURRD    BEGSR
     C*
     C** OBTAIN CURRENCY DETAILS. RECORD NOT FOUND DATABASE ERRO
     C                     Z-ADD1         B
     C           WWCCY     LOKUPCYCD,B                   61
     C** ERROR
     C           *IN61     IFEQ '0'                        ***************
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD1         DBASE            **DB ERROR 02**
     C***********          MOVEL'SDCURRL0'DBFILE           ***************S01486
     C                     MOVE 'SDCURRPD'DBFILE           ***************S01486
     C                     MOVELWWCCY     DBKEY
     C                     OUT  LDA                                       S01486
     C                     EXSR *PSSR
     C                     ELSE
     C                     Z-ADDSPRT,B    A6SPRT
     C                     MOVE MDIN,B    A6MDIN
     C                     Z-ADDNBDP,B    A6NBDP
     C                     END
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT                                                              CPM003
      ********************************************************************CPM003
      *                                                                  *CPM003
      * #INTYP   - ACCESS FF INSTRUMENT DETAILS                          *CPM003
      *                                                                  *CPM003
      * SUBROUTINE CALLS:                                                *CPM003
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *CPM003
      *                                                                  *CPM003
      * SUBROUTINE CALLED FROM:                                          *CPM003
      * #MARG1   - CALCULATE VLUE OF MARGIN POSITION                     *CPM003
      *                                                                  *CPM003
      ********************************************************************CPM003
     C           #INTYP    BEGSR                                          CPM003
     C*                                                                   CPM003
     C** OBTAIN FF INSTRUMENT DETAILS. RECORD NOT FOUND DATABASE ERROR    CPM003
     C           *LIKE     DEFN IMFOIS    WSFOIS                          CPM003
     C           FFFOIS    CHAININTYP                88                   CPM003
     C*                                                                   CPM003
     C** ERROR                                                            CPM003
     C           *IN88     IFEQ '1'                                       CPM003
     C           *LOCK     IN   LDA                                       CPM003
     C                     Z-ADD3         DBASE            ***************CPM003
     C                     MOVE 'INTYP   'DBFILE           ** DB ERROR 03 CPM003
     C                     MOVELFFFOIS    DBKEY            ***************CPM003
     C                     OUT  LDA                                       CPM003
     C                     EXSR *PSSR                                     CPM003
     C                     END                                            CPM003
     C*                                                                   CPM003
     C                     ENDSR                                          CPM003
      ********************************************************************CPM003
      /EJECT
      ********************************************************************
      *                                                                  *
      * #FMT23   - PREPARE DETAILS FOR OUTPUT TO FORMATS 2 & 3           *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      * #DELET   - PROCESS DELETED FI, MD, ML, LE AND FX POSITIONS       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWDELT   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #FMT23    BEGSR
     C*
     C** FORMAT DETAILS DISPLAYED IN FORMAT 2
     C                     MOVE WCINNR    RRINNR
     C                     MOVE WCRESH    RRRESH
     C                     MOVE WCMODI    RRMODI
     C                     MOVE WCCCY1    RRCCY
     C                     MOVE WCCNTR    RRCNTR
     C**********           MOVE WCLIND    RRLIND                                              CER020
     C                     MOVE WCLOIC    RRLIND                                              CER020
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #FMT4    - PREPARE DETAILS FOR OUTPUT TO FORMAT 4                *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZDATE2   -                                                       *
      * ZSEDIT   -                                                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      * #DELET   - PROCESS DELETED FI, MD, ML, LE AND FX POSITIONS       *
      * #FOREX   - CALCULATE PERFORMANCE FOR FX DEALS                    *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWRCDT   -                                                       *
      * WWICDP   -                                                       *
      * WWPCDP   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #FMT4     BEGSR
     C*
     C** SET UP NARRATIVE DESCRIBING EVENT TYPE
     C           WWRCDT    IFEQ 'S'                        B1
     C                     MOVE WE,1      RRNARR
     C                     END                             E1
     C*
     C           WWRCDT    IFEQ 'T'                        B1
     C*
     C           WCPFMC    IFEQ ' N'                       B2
     C                     MOVE WE,2      RRNARR
     C                     END                             E2
     C*
     C           WCPFMC    IFEQ 'IP'                       B2
     C                     MOVE WE,3      RRNARR
     C                     END                             E2
     C*
     C           WCPFMC    IFEQ 'IR'                       B2
     C                     MOVE WE,4      RRNARR
     C                     END                             E2
     C*
     C           WCPFMC    IFEQ 'DV'                       B2
     C                     MOVE WE,5      RRNARR
     C                     END                             E2
     C*
     C           WCPFMC    IFEQ 'F '                       B2
     C                     MOVE WE,6      RRNARR
     C                     END                             E2
     C*
     C           WCPFMC    IFEQ 'T '                       B2
     C                     MOVE WE,7      RRNARR
     C                     END                             E2
     C*
     C           WCPFMC    IFEQ 'C '                       B2
     C                     MOVE WE,8      RRNARR
     C                     END                             E2
     C*
     C           WCPFMC    IFEQ 'OT'                       B2
     C                     MOVE WE,9      RRNARR
     C                     END                             E2
     C*
     C           WCPFMC    IFEQ 'TR'                       B2
     C                     MOVE WE,10     RRNARR
     C                     END                             E2
     C*
     C           WCPFMC    IFEQ 'TU'                       B2
     C                     MOVE WE,11     RRNARR
     C                     END                             E2
     C*                                                                   72605
     C           WCPFMC    IFEQ 'XT'                       B2             72605
     C                     MOVE WE,14     RRNARR                          72605
     C                     END                             E2             72605
     C*
     C                     END                             E1
     C*
     C           WWRCDT    IFEQ 'E'                        B1
     C                     MOVE WE,12     RRNARR
     C                     END                             E1
     C*
     C           WWRCDT    IFEQ 'M'                        B1
     C                     MOVE WE,13     RRNARR
     C                     END                             E1
     C*
     C** FORMAT REMAINING DETAILS SHOWN ON FIRST LINE OF FORMAT 4
     C                     MOVE *BLANKS   RRTRNB
     C                     MOVE *BLANKS   RRTTYP
     C           WWRCDT    IFEQ 'T'                        B1
     C           WCMODI    ANDEQ'SE'
     C*
     C           WCTTYP    IFEQ 'TP'                       B2
     C           WCTTYP    OREQ 'TS'
     C           WCTTYP    OREQ 'WI'
     C           WCTTYP    OREQ 'WO'
     C                     MOVE WCTRNB    RRTRNB
     C                     END                             E2
     C*
     C                     MOVELWCTTYP    RRTTYP
     C                     END                             E1
     C*
     C           WWCASH    IFEQ 'Y'                        B1
     C                     MOVELQSTRAT    RRTRNB
     C                     END                             E1
     C*
     C                     MOVE *BLANKS   RRPDAT
     C                     MOVE *BLANKS   RRREVI
     C                     MOVE *BLANKS   RRACIN
     C                     MOVE *BLANKS   RRCPTC
     C                     MOVE *BLANKS   RRCPTC
     C*
     C           WWRCDT    IFEQ 'T'                        B1
     C*
     C           WCMODI    IFNE 'SE'                       B2
     C           WCMODI    OREQ 'SE'
     C           WCTTYP    ANDNE'TP'
     C           WCTTYP    ANDNE'TS'
     C           WCTTYP    ANDNE'WI'
     C           WCTTYP    ANDNE'WO'
     C           WCTTYP    ANDNE'DV'
     C           WCTTYP    ANDNE'PP'
     C           WCTTYP    ANDNE'MT'
     C           WCTTYP    ANDNE'CP'
     C*
     C           WCINIO    IFEQ 'I'                        B3
     C                     MOVE 'IN '     RRTTYP
     C                     ELSE                            X3
     C                     MOVE 'OUT'     RRTTYP
     C                     END                             E3
     C                     END                             E2
     C*
     C                     Z-ADDWCPDAT    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RRPDAT
     C*
     C                     MOVE WCREVI    RRREVI
     C                     MOVE WCACIN    RRACIN
     C                     MOVE WCCPTC    RRCPTC
     C                     END                             E1
     C*
     C** IF END OF PERIOD OUTPUT END OF PERIOD DATE
     C           WWRCDT    IFEQ 'E'
     C                     Z-ADDQRPMED    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RRPDAT
     C                     END
     C*
     C** FOR MATURED FX POSITIONS OUTPUT FX DEAL VALUE DATE
     C           WWRCDT    IFEQ 'M'
     C                     Z-ADDQSCSHD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RRPDAT
     C                     END
     C*
     C** RESET LINE 2 FIELDS TO BLANK
     C                     MOVE *BLANKS   RRTAMT
     C                     MOVE *BLANKS   RRMPRC
     C                     MOVE *BLANKS   RRMFXR
     C                     MOVE *BLANKS   RRACIS
     C*
     C** EDIT NOMINAL FOR OUTPUT VIA SR/ZSEDIT
     C                     Z-ADD0         ZFLD15
     C                     MOVE WCTAMT    ZFLD15
     C*
     C           WWRCDT    IFEQ 'S'                        B1
     C           WCMODI    ANDEQ'SE'
     C           WWRCDT    OREQ 'S'                                       075998
     C           WCMODI    ANDEQ'FO'                                      075998
     C           WWRCDT    OREQ 'S'                                       075998
     C           WCMODI    ANDEQ'FM'                                      075998
     C           WWRCDT    OREQ 'T'
     C           WCPFMC    ANDEQ' N'
     C           WCMODI    ANDEQ'SE'
     C           WWRCDT    OREQ 'T'                                       075998
     C           WCPFMC    ANDEQ' N'                                      075998
     C           WCMODI    ANDEQ'FO'                                      075998
     C           WWRCDT    OREQ 'T'                                       075998
     C           WCPFMC    ANDEQ' N'                                      075998
     C           WCMODI    ANDEQ'FM'                                      075998
     C           WWRCDT    OREQ 'E'
     C           WCMODI    ANDEQ'SE'
     C           WWRCDT    OREQ 'E'                                       075998
     C           WCMODI    ANDEQ'FO'                                      075998
     C           WWRCDT    OREQ 'E'                                       075998
     C           WCMODI    ANDEQ'FM'                                      075998
     C                     Z-ADDNMDP      ZDECS
     C                     ELSE                            X1
     C                     Z-ADDWWICDP    ZDECS
     C                     END                             E1
     C*
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRTAMT
     C*
     C** EDIT MARKET PRICE FOR OUTPUT VIA SR/ZSEDIT
     C           WCBYSF    IFEQ *BLANKS                    B1
     C           WWRCDT    IFEQ 'S'                        B2
     C           WCMODI    ANDEQ'SE'
     C           WWRCDT    OREQ 'S'                                       075998
     C           WCMODI    ANDEQ'FO'                                      075998
     C           WCMPRC    ANDNE*LOVAL                                    075998
     C           WWRCDT    OREQ 'S'                                       075998
     C           WCMODI    ANDEQ'FM'                                      075998
     C           WCMPRC    ANDNE*LOVAL                                    075998
     C           WWRCDT    OREQ 'T'
     C           WCMODI    ANDEQ'SE'
     C           WCPFMC    ANDEQ' N'
     C           WWRCDT    OREQ 'T'                                       075998
     C           WCMODI    ANDEQ'FO'                                      075998
     C           WCPFMC    ANDEQ' N'                                      075998
     C           WWRCDT    OREQ 'T'                                       075998
     C           WCMODI    ANDEQ'FM'                                      075998
     C           WCPFMC    ANDEQ' N'                                      075998
     C           WWRCDT    OREQ 'E'
     C           WCMODI    ANDEQ'SE'
     C           WWRCDT    OREQ 'E'                                       075998
     C           WCMODI    ANDEQ'FO'                                      075998
     C           WCMPRC    ANDNE*LOVAL                                    075998
     C           WWRCDT    OREQ 'E'                                       075998
     C           WCMODI    ANDEQ'FM'                                      075998
     C           WCMPRC    ANDNE*LOVAL                                    075998
     C                     Z-ADD0         ZFLD15
     C                     MOVE WCMPRC    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     MOVE ' '       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRMPRC
     C                     END                             E2
     C                     END                             E1
     C*
     C** EDIT MARKET FX RATE FOR OUTPUT VIA SR/ZSEDIT
     C                     Z-ADD0         ZFLD15
     C*
     C           WCMODI    IFEQ 'FX'
     C                     Z-ADDWCMFXR    W1MFXR
     C                     MOVE W1MFXR    ZFLD15
     C                     ELSE
     C           WCMFXR    DIV  WW1015    W1MFXR 138
     C                     MOVE W1MFXR    ZFLD15
     C                     END
     C*
     C                     Z-ADD8         ZDECS
     C                     MOVE ' '       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRMFXR
     C*
     C           WWRCDT    IFEQ 'M'
     C                     MOVE *BLANKS   RRMFXR
     C                     END
     C*
     C** EDIT ACCRUED INTEREST FOR OUTPUT VIA SR/ZSEDIT
     C           WCACIS    IFNE 0                          B1
     C                     Z-ADD0         ZFLD15
     C                     MOVE WCACIS    ZFLD15
     C*
     C           WCBYSF    IFEQ *BLANKS                    B2
     C                     Z-ADDWWICDP    ZDECS
     C                     ELSE                            X2
     C                     Z-ADDWWPCDP    ZDECS
     C                     END                             E2
     C*                                                                   075998
     C           WCMODI    IFEQ 'FM'                                      075998
     C                     Z-ADD0         ZDECS                           075998
     C                     END                                            075998
     C*
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRACIS
     C                     END                             E1
     C*
     C** IF PROCESSING PERFORMANCE EVENT MOVE THE EVENT REFERENCE INTO
     C** THE ACCRUED INTEREST FOR OUTPUT
     C           WWRCDT    IFEQ 'T'                        B1
     C           WWFXPO    OREQ 'Y'                                       078956
     C                     Z-ADD0         ZFLD15
     C                     MOVE WCEVRF    ZFLD15
     C                     Z-ADD0         ZDECS
     C                     MOVE ' '       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRACIS
     C                     END
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #FMT89   - PREPARE DETAILS FOR OUTPUT TO FORMATS 8 & 9           *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZSEDIT   -                                                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #FOREX   - CALCULATE PERFORMANCE FOR FX DEALS                    *
      * #CLPOS   - CALCULATE NEW POSITIONS                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWNOML   -                                                       *
      * WWICDP   -                                                       *
      * WWAPNM   -                                                       *
      * WWFXAP   -                                                       *
      * WWUINT   -                                                       *
      * WWBKUI   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #FMT89    BEGSR
     C*
     C** RESET FIELDS TO BLANK
     C                     MOVE *BLANKS   RRNOML
     C                     MOVE *BLANKS   RRAPNM
     C                     MOVE *BLANKS   RRFXAP
     C                     MOVE *BLANKS   RRUINT
     C                     MOVE *BLANKS   RRBKUI
     C                     MOVE *BLANKS   RRNMEX
     C*
     C** FOR FX DEALS BRANCH TO END OF ROUTINE - BLANKS TO BE OUTPUT
     C           WCBYSF    CABNE*BLANKS   #FMT1
     C           WCMODI    CABEQ'FM'      #FMT1                           075998
     C*
     C** EDIT NEW NOMINAL POSITION FOR OUTPUT VIA SR/ZSEDIT
     C                     Z-ADD0         ZFLD15
     C                     MOVE WWNOML    ZFLD15
     C*
     C           IMMODI    IFEQ 'SE'                       B1
     C           IMMODI    OREQ 'FO'                                      075998
     C                     Z-ADDNMDP      ZDECS
     C                     ELSE                            X1
     C                     Z-ADDWWICDP    ZDECS
     C                     END                             E1
     C*
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRNOML
     C*
     C** EDIT EX-COUPON NOMINAL POSITION FOR OUTPUT VIA SR/ZSEDIT
     C                     Z-ADD0         ZFLD15
     C                     MOVE WWNMEX    ZFLD15
     C*
     C           IMMODI    IFEQ 'SE'                       B1
     C                     Z-ADDNMDP      ZDECS
     C                     ELSE                            X1
     C                     Z-ADDWWICDP    ZDECS
     C                     END                             E1
     C*
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRNMEX
     C*
     C** EDIT NEW AP NUMERATOR FOR OUTPUT
     C                     Z-ADD0         ZFLD15
     C                     MOVE WWAPNM    ZFLD15
     C                     Z-ADDWWICDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRAPNM
     C*
     C** EDIT NEW FX AP NUMERATOR FOR OUTPUT
     C                     Z-ADD0         ZFLD15
     C                     MOVE WWFXAP    ZFLD15
     C                     Z-ADDPNPCDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRFXAP
     C*
     C** IF POSITION IS INTEREST BEARING OUTPUT ACCRUED INTEREST AND
     C** COST OF ACCRUED INTEREST IN PORTFOLIO CURRENCY
     C           WCBYSF    IFEQ *BLANKS                    B1
     C*
     C           WCMODI    IFEQ 'SE'                       B2
     C           WWUINT    ANDNE0
     C           WCMODI    OREQ 'SE'
     C           WWBKUI    ANDNE0
     C           WCMODI    ORNE 'SE'
     C                     Z-ADD0         ZFLD15
     C                     MOVE WWUINT    ZFLD15
     C                     Z-ADDWWICDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRUINT
     C*
     C                     Z-ADD0         ZFLD15
     C                     MOVE WWBKUI    ZFLD15
     C                     Z-ADDPNPCDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRBKUI
     C                     END                             E2
     C                     END                             E1
     C*
     C           #FMT1     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      **#WRTRP***-*WRITE*DETAILS*TO*REPORT*AND*UPDATE*PMPIMTPP************S01486
      * #WRTRP   - WRITE DETAILS TO REPORT AND UPDATE PMPIMTPD           *S01486
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZSEDIT   -                                                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      * #DELET   - PROCESS DELETED FI, MD, ML, LE AND FX POSITIONS       *
      * #FOREX   - CALCULATE PERFORMANCE FOR FX DEALS                    *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      * WWNODE   -                                                       *
      * WWLINE   -                                                       *
      * WWOVRF   -                                                       *
      * WWPRTC   -                                                       *
      * WWRCDT   -                                                       *
      * WWDELT   -                                                       *
      * WWFORX   -                                                       *
      *                                                                  *
      ********************************************************************
     C           #WRTRP    BEGSR
     C*
     C                     MOVE 'Y'       WWNODE  1
     C*
     C** IF REPORT NOT REQUIRED BRANCH TO FILE UPDATING PROCESSING
     C           *INU1     CABEQ'0'       FILUPD
     C*
     C** DETERMINE NUMBER OF LINES TO BE OUTPUT FOR EVENT
     C                     Z-ADD1         I
     C           '   '     LOKUPPFMC,I                   61
     C*
     C           I         IFGT 2                          B1
     C           I         SUB  1         I
     C                     ELSE                            X1
     C                     Z-ADD2         I
     C                     END                             E1
     C*
     C** CALCULATE LAST LINE TO BE WRITTEN FOR EVENT AND IF *GE 66
     C** SET ON OVERFLOW INDICATOR
     C           LINE      ADD  I         WWLINE  30
     C****       WWLINE    ADD  5         WWLINE                          075998
     C           WWLINE    ADD  6         WWLINE                          075998
     C                     MOVE 'N'       WWOVRF  1
     C*
     C           WWLINE    IFGE 66                         B1
     C                     MOVE 'Y'       WWOVRF
     C                     END                             E1
     C*
     C** WRITE HEADINGS ON CHANGE OF PORTFOLIO OR ON PAGE OVERFLOW
     C           WWOVRF    IFEQ 'Y'                        B1
     C           WWPRTC    OREQ 'Y'
     C                     MOVE 'N'       WWPRTC
     C*                                                                   S01486
     C** Call ZSFILE for P1 file                                          S01486
     C*                                                                   S01486
     C                     Z-ADDSFNUM     ZSNUM   60                      S01486
     C                     CALL 'ZSFILE'                                  S01486
     C                     PARM           @RSEQ                           S01486
     C                     PARM *BLANKS   @PARM   3                       S01486
     C                     PARM           SFILE                           S01486
     C                     PARM           ZSNUM                           S01486
     C                     PARM           ZSERR   1                       S01486
     C*                                                                   S01486
     C           ZSERR     IFEQ 'Y'                                       S01486
     C                     MOVE '1'       *INU7                           S01486
     C                     MOVE '1'       *INU8                           S01486
     C                     MOVE '1'       *INLR                           S01486
     C                     RETRN                                          S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     WRITEFORMAT1                67
     C*
     C                     WRITEFORMAT2                67
     C*
     C                     MOVE RRINNR    RSINNR  3
     C                     MOVE RRCCY     RSCCY   3
     C                     MOVE RRCNTR    RSCNTR  2
     C                     MOVE RRLIND    RSLIND  3
     C                     MOVE RRMODI    RSMODI  2
     C                     MOVE RRRESH    RSRESH 20
     C                     Z-ADD14        LINE    50
     C*
     C** ...OTHERWISE IF CHANGE OF SECTOR OR CHANGE OF POSITION OUTPUT
     C** NEW HEADINGS
     C                     ELSE                            X1
     C*
     C           RRINNR    IFNE RSINNR                     B2
     C           RRRESH    ORNE RSRESH
     C           RRMODI    ORNE RSMODI
     C                     WRITEFORMAT2                67
     C                     MOVE RRINNR    RSINNR
     C                     MOVE RRRESH    RSRESH
     C                     MOVE RRMODI    RSMODI
     C                     ADD  3         LINE
     C                     END                             E2
     C                     END                             E1
     C*
     C** FORMAT AND OUTPUT FIRST SET OF PERFORMANCE DETAILS
     C                     MOVE PFMC,1    RRPFMC
     C                     MOVE PFMS,1    RRPFMS
     C*
     C                     Z-ADD0         ZFLD15
     C                     MOVE PFMA,1    ZFLD15
     C                     Z-ADDPNPCDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRPFMA
     C*
     C                     WRITEFORMAT5                67
     C*
     C** WRITE FIRST LINE OF NEW POSITION DETAILS
     C           WWRCDT    IFNE 'E'                        B1
     C                     WRITEFORMAT8                67
     C                     END                             E1
     C*
     C** WRITE TRANSACTION / POSITION DETAILS
     C           WWFXPO    IFEQ 'Y'                        B1             078956
     C                     MOVE '1'       *IN66                           078956
     C                     MOVE PFMT,1    RRACI1                          078956
     C                     MOVE PFMT,2    RRACIS                          078956
     C                     END                             E1             078956
     C*                                                                   078956
     C           WWRCDT    IFEQ 'E'                                       078956
     C           WWFXPO    ANDNE'Y'                                       078956
     C                     MOVE RRACIS    WSACIS 12                       078956
     C                     MOVE *BLANKS   RRACIS                          078956
     C                     END                                            078956
     C                     WRITEFORMAT4                67
     C                     ADD  1         LINE
     C                     MOVE '0'       *IN66                           078956
     C*
     C** FORMAT AND SECOND SET OF PERFORMANCE DETAILS IF REQUIRED
     C           PFMC,2    IFNE *BLANKS                    B1
     C                     MOVE PFMC,2    RRPFMC
     C                     MOVE PFMS,2    RRPFMS
     C*
     C                     Z-ADD0         ZFLD15
     C                     MOVE PFMA,2    ZFLD15
     C                     Z-ADDPNPCDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRPFMA
     C*
     C           WWRCDT    IFNE 'E'                        B2
     C                     WRITEFORMAT5                67
     C                     ELSE                            X2
     C           WWFXPO    IFNE 'Y'                        B3             078956
     C                     MOVE WSACIS    RRACIS                          078956
     C                     END                             E3             078956
     C           PFMC,3    IFNE *BLANKS                    B3
     C                     WRITEFORMAT6                67
     C                     ADD  1         LINE
     C                     ELSE                            X3
     C                     WRITEFORMAT7                67
     C                     ADD  2         LINE
     C                     END                             E3
     C*
     C                     END                             E2
     C                     END                             E1
     C*
     C** OUTPUT SECOND LINE OF NEW POSITION DETAILS
     C           WWRCDT    IFNE 'E'                        B1
     C           PFMC,3    IFEQ *BLANKS                    B2
     C                     WRITEFORMT9A                67
     C                     ADD  2         LINE
     C                     ELSE                            X2
     C                     WRITEFORMAT9                67
     C                     ADD  1         LINE
     C                     END                             E2
     C                     END                             E1
     C*
     C** DO WHILE RECORDS REMAIN IN PEFORMANCE ARRAYS
     C                     Z-ADD3         I       30
     C           I         DOWLE12                         B1
     C           PFMC,I    ANDNE*BLANKS
     C                     MOVE PFMC,I    RRPFMC
     C                     MOVE PFMS,I    RRPFMS
     C*
     C                     Z-ADD0         ZFLD15
     C                     MOVE PFMA,I    ZFLD15
     C                     Z-ADDPNPCDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    RRPFMA
     C*                                                                   078956
     C                     MOVE *BLANKS   RRACIS                          078956
     C           WWFXPO    IFEQ 'Y'                        B1             078956
     C                     MOVE PFMT,3    RRACIS                          078956
     C                     END                             E1             078956
     C*
     C** IF FURTHER PERFORMANCE EVENTS TO BE OUTPUT WRITE FORMAT 6
     C** OTHERWISE OUTPUT FORMAT7
     C           I         ADD  1         K       30
     C*
     C           PFMC,K    IFEQ *BLANKS                    B2
     C                     WRITEFORMAT7                67
     C                     ADD  2         LINE
     C                     ELSE                            X2
     C                     WRITEFORMAT6                67
     C                     ADD  1         LINE
     C                     END                             E2
     C*
     C                     ADD  1         I
     C                     END                             E1
     C*
     C** NON-REPORT PROCESSING
     C           FILUPD    TAG
     C*
     C** READ THROUGH ALL PERFORMANCE EVENTS GENERATED AND OUTPUT TO
     C***PF/PMPIMTPP******************************************************S01486
     C** PF/PMPIMTPD                                                      S01486
     C                     Z-ADD1         I
     C           I         DOWLE12                         B1
     C           PFMC,I    ANDNE*BLANKS
     C**********           Z-ADDWCCNUM    QTCNUM                                              CSD027
     C                     MOVE WCCNUM    QTCNUM                                              CSD027
     C                     MOVE WCPTFR    QTPTFR
     C                     MOVE WCINNR    QTINNR
     C                     MOVE WCVALG    QTVALG
     C                     MOVE WCCCY1    QTCCY
     C                     MOVE WCCNTR    QTCNTR
     C**********           Z-ADDWCLIND    QTLIND                                              CER020
     C                     MOVE WCLOIC    QTLOIC                                              CER020
     C                     MOVE WCTDSS    QTTDSS
     C**********           Z-ADDWCTRNB    QTTRNB                                              CLE148
     C                     MOVELWCTRNB    QTTRNB                                              CLE148
     C                     MOVE WCMODI    QTMODI
     C                     MOVE PFMC,I    QTPFMC
     C                     MOVE PFMS,I    QTPFMS
     C                     Z-ADDPFMA,I    QTPFMA
     C                     MOVE QRPFMP    QTPFMP
     C                     MOVE WCRESH    QTRESH
     C*
     C           WWRCDT    IFNE 'T'                        B2
     C                     MOVE 'N'       QTCPTC
     C                     ELSE                            X2
     C                     MOVE WCCPTC    QTCPTC
     C                     END                             E2
     C*
     C** OUTPUT RECORD IF NON-ZERO PERFORMANCE AMOUNT
     C           QTPFMA    IFNE 0                          B2
     C                     WRITEPMPIMTP0
     C                     ADD  1         RRPERW
     C                     END                             E2
     C*
     C                     ADD  1         I
     C                     END                             E1
     C*
     C** MAINTAIN RUNNING TOTAL OF AMOUNTS FOR POSITION
     C** IF NEW POSITION RESET TOTALS TO ZERO
     C                     Z-ADD1         I
     C           I         DOWLE12                         B1
     C                     MOVE *BLANKS   PFMC,I
     C                     MOVE *BLANKS   PFMS,I
     C                     Z-ADD0         PFMA,I
     C                     ADD  1         I
     C                     END                             E1
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*  ZCCYXD SR. TO CONVERT AN AMOUNT USING DOUBLE PRECISION FX
     C*  RATES
     C*
     C*  INPUT  FIELDS
     C*       ZAMTF  150     AMOUNT IN 'FROM' CURRENCY
     C*       ZCDPF   10     CURRENCY DECIMAL PLACES FOR 'FROM' CURRENCY
     C*       ZCDPT   10     CURRENCY DECIMAL PLACES FOR 'TO' CURRENCY
     C*       ZCRSRD 308     DOUBLE PRECISION FX RATE
     C*       ZCRSMD  1      MULTIPLY / DIVIDE INDICATOR
     C*
     C*  OUTPUT  FIELDS
     C*       ZAMTT  150     AMOUNT IN 'TO' CURRENCY (IE. CONVERTED AMOUNT
     C*
     C*
     C********************************************************************
     C*
     C           ZCCYXD    BEGSR                                       **
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDZAMTF     ZAMTF  150
     C                     Z-ADDZCRSRD    ZCRSRD 308
     C                     Z-ADDZCDPF     ZCDPF   10
     C                     Z-ADDZCDPT     ZCDPT   10
     C                     Z-ADDZAMTT     ZAMTT  150
     C*
     C** IF CROSS EXCHANGE RATE IS EQUAL TO ZERO
     C** SET ZAMTT  TO *ZERO  & EXIT
     C           ZCRSRD    IFEQ 0
     C                     Z-ADD*ZEROS    ZAMTT
     C                     GOTO CCYXD
     C                     END
     C*
     C** IF DECIMAL PLACES  FOR 'FROM' CURRENCY (ZCDPF) EQUALS DECIMAL
     C** DECIMAL PLACES  FOR 'TO' CURRENCY CONVERT AMOUNT BY SIMPLE
     C** MULTIPLICATION
     C           ZCDPF     IFEQ ZCDPT                      B1
     C           ZAMTF     MULT ZCRSRD    ZAMTO  300H
     C                     END                             E1
     C*
     C** IF DECIMAL PLACES  FOR 'FROM' CURRENCY (ZCDPF)  NOT EQUALS DECIMA
     C** DECIMAL PLACES  FOR 'TO' CURRENCY ADJUST AMOUNT FOR DIFFERENT DP
     C           ZCDPF     IFNE ZCDPT                      B1
     C*
     C** SUBTRACT DECIMAL PLACES 'FROM' FROM DECIMAL PLACES 'TO' IN POWER
     C           ZCDPT     SUB  ZCDPF     ZWKPX   10
     C           ZWKPX     ADD  4         B       30
     C*
     C** IF POWER ELEMENT (8,4) LESS THAN 1
     C           POWER,B   IFLT 1                          B2
     C*
     C** MULTIPLY AMOUNT IN FROM CURRENCY BY ELEMENT IN POWER ARRAY
     C           POWER,B   MULT ZAMTF     ZWK153 153
     C*
     C           ZWK153    MULT ZCRSRD    ZAMTO     H
     C                     END                             E2
     C*
     C** IF POWER ELEMENT (8,4) GREATER OR EQUAL TO 1
     C           POWER,B   IFGE 1                          B2
     C           ZAMTF     MULT POWER,B   ZAMTO
     C           ZAMTO     MULT ZCRSRD    ZAMTO     H
     C                     END                             E2
     C                     END                             E1
     C*
     C           ZAMTO     DIV  WW1015    ZAMTT     H
     C*
     C           CCYXD     ENDSR
     C********************************************************************
     C*
     C*  ZFXAVD - CALCULATE DOUBLE PRECISION FX RATE
     C*
     C*  PURPOSE : TO CALCULATE AN AVERAGE FX RATE (VALUE OF HOLDING IN
     C*            PORTFOLIO CURRENCY DIVIDED BY VALUE IN NOMINAL CURRENCY
     C*
     C*  INPUT  FIELDS
     C*       ZAPNM  15 0     AVERAGE PRICE NUMERATOR
     C*       ZFXAP  15 0     FX AVERAGE PRICE NUMERATOR
     C*       ZNMCD   1 0     NOMINAL CURRENCY DECIMAL PLACES (0-3)
     C*       ZPTCD   1 0     PORTFOLIO CURRENCY DECIMAL PLACES (0-3)
     C*
     C*  OUTPUT  FIELDS
     C*       ZAVFD  30 8     AVERAGE FX RATE
     C*
     C*  ALSO REQUIRED
     C*       POWER8 ARRAY    ARRAY FOR CURRENCY CONVERSIONS
     C*
     C*  WORK FIELDS:
     C*       ZI      1 0     INDEX TO POWER ARRAY
     C*
     C*  CALLED FROM:
     C*
     C********************************************************************
     C           ZFXAVD    BEGSR
     C*
     C** DEFINE ALL FIELDS
     C*
     C                     Z-ADDZAPNM     ZAPNM  150
     C                     Z-ADDZFXAP     ZFXAP  150
     C                     Z-ADDZNMCD     ZNMCD   10
     C                     Z-ADDZPTCD     ZPTCD   10
     C                     Z-ADDZAVFD     ZAVFD  308
     C*
     C** IF AP NUMERATOR = 0   END PROCESS
     C           ZAPNM     IFEQ 0
     C                     Z-ADD0         ZAVFD
     C*
     C** IF AP NUMERATOR NOT = ZEROS
     C                     ELSE
     C*
     C** DIVIDE FX AP NUMERATOR BY AP NUMERATOR
     C           ZFXAP     MULT 1000000000WWFXPD 300
     C           WWFXPD    DIV  ZAPNM     WWAVFD 308H
     C*
     C** SET POWER8 INDEX TO 5 - NBR NOM CCY DEC. PLACES + NBR PORT CCY DE
     C           5         SUB  ZNMCD     ZI      10
     C                     ADD  ZPTCD     ZI
     C*
     C** DIVIDE AVERAGE PRICE BY POWER
     C           WWAVFD    DIV  POWER8,ZI ZAVFD     H
     C           ZAVFD     MULT 1000000   ZAVFD
     C*
     C** SET AVERAGE PRICE POSITIVE
     C           ZAVFD     IFLE 0
     C                     Z-SUBZAVFD     ZAVFD
     C                     END
     C*
     C** END CONDITION NOMINAL = ZERO
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*  ZFXAPD - CALCULATE FX AP NUMERATOR
     C*
     C*  PURPOSE : TO CALCULATE AN FX AP NUMERATOR  (NOMINAL X FX RATE)
     C*
     C*  INPUT  FIELDS
     C*       ZAPNM  15 0     AP (AVERAGE PRICE) NUMERATOR
     C*       ZFXRD  30 8     FX RATE
     C*       ZNMCD   1 0     NOMINAL CURRENCY DECIMAL PLACES (0-3)
     C*       ZPTCD   1 0     PORTFOLIO CURRENCY DECIMAL PLACES (0-3)
     C*
     C*  OUTPUT  FIELDS
     C*       ZFXAP  15 0     FX AP NUMERATOR
     C*
     C*  ALSO REQUIRED
     C*       POWER8 ARRAY    ARRAY FOR CURRENCY CONVERSIONS
     C*
     C*  WORK FIELDS:
     C*       WWVL0  30 0     FIELDS FOR CURRENCY CONVERSIONS
     C*       WWVL1  30 1
     C*       WWVL2  30 2
     C*       WWVL3  30 3
     C*       ZI      1 0     INDEX TO POWER ARRAY
     C*
     C*  CALLED FROM:
     C*
     C********************************************************************
     C           ZFXAPD    BEGSR                           *** ZFXAPD ***
     C*
     C** DEFINE ALL FIELDS
     C                     Z-ADDZAPNM     ZAPNM  150
     C                     Z-ADDZFXRD     ZFXRD  308
     C                     Z-ADDZNMCD     ZNMCD   10
     C                     Z-ADDZPTCD     ZPTCD   10
     C                     Z-ADDZFXAP     ZFXAP  150
     C*
     C** IF NUMBER OF PORTFOLIO  CURRENCY DECIMAL PLACES I = 0
     C           ZPTCD     IFEQ 0
     C           ZAPNM     MULT ZFXRD     WWVL0  300H
     C                     MOVE WWVL0     WFXAP  300
     C                     END
     C*
     C** IF NUMBER OF PORTFOLIO CURRENCY DECIMAL PLACES I = 1
     C           ZPTCD     IFEQ 1
     C           ZAPNM     MULT ZFXRD     WWVL1  301H
     C                     MOVE WWVL1     WFXAP
     C                     END
     C*
     C** IF NUMBER OF PORTFOLIO CURRENCY DECIMAL PLACES I = 2
     C           ZPTCD     IFEQ 2
     C           ZAPNM     MULT ZFXRD     WWVL2  302H
     C                     MOVE WWVL2     WFXAP
     C                     END
     C*
     C** IF NUMBER OF CURRENCY DECIMAL PLACES I = 3
     C           ZPTCD     IFEQ 3
     C           ZAPNM     MULT ZFXRD     WWVL3  303H
     C                     MOVE WWVL3     WFXAP
     C                     END
     C*
     C** SET INDEX ZI EQUAL TO 5 -. NOMINAL CURRENCY DECIMAL PLACES )
     C           WFXAP     DIV  WW1015    WFXAP
     C           5         SUB  ZNMCD     ZI      10
     C*
     C** MULTIPLY ZFXAP BY  POWER8,ZI
     C           WFXAP     MULT POWER8,ZI ZFXAP     H
     C*
     C**
     C                     ENDSR
     C********************************************************************
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * *PSSR    - REPORT DATABASE AND PROGRAM ERRORS                    *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #INIT    - INITIAL PROCESSING                                    *
      * #CALCN   - CONTROL CALCULATION OF PERFORMANCE FIGURES            *
      * #FOREX   - CALCULATE PERFORMANCE FOR FX DEALS                    *
      * #PORTD   - ACCESS PORTFOLIO DEFINITION DETAILS                   *
      * #CURRD   - ACCESS CURRENCY DETAILS                               *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           *PSSR     BEGSR
     C                     DUMP
     C*
     C** Output header and database error record format                   S01486
     C*                                                                   S01486
     C                     WRITEFORMTAU                                   S01486
     C                     WRITEFCDBERR                                   S01486
     C*                                                                   S01486
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR
      /COPY ZSRSRC,ZDATE2Z2
      /COPY ZSRSRC,ZSEDITZ3
      /COPY ZSRSRC,ZCCYXR
      /COPY ZSRSRC,ZCCYCN
      /COPY ZSRSRC,ZAPNUM
      /COPY ZSRSRC,ZAVPRC
     C***PY ZSRSRC,ZSETAC                                                 CPM004
      /COPY ZSRSRC,ZFXAVP
      /COPY PMCPYSRC,ZFXAPN
      /COPY ZSRSRC,FFTVCLZ2                                               075998
      /COPY ZSRSRC,FFYTOPZ1                                               CPM003
** CPY@
(c) Misys International Banking Systems Ltd. 2001
**  PD
PAST 12 MONTHS
TAX YEAR TO DATE
SHORT PERIOD
**  WE                                                                    72605
STARTING POSITION
NOMINAL CHANGE
INTEREST TRADED
INTEREST EVENT
DIVIDEND
FEE / COMMISSION
WITHHOLDING TAX
CHARGES
TRANSACTION TAX
REALISED MARKET
UNREALISED MARKET
ENDING POSITION
MATURED POSITION
REALISED FX P/L
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  WWTX - TEXT FOR GENERAL CASHFLOWS
GENERAL CASHFLOW
