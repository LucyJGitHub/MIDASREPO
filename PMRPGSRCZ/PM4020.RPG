     H        1                                                           S01486
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas PM Reconcile CAPRHD Agnst TRADSD&DPTMVD2')       *
     H***********                                                         S01486
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Management Module                      *
     F*                                                               *
     F*  PM4020 - Reconcile CAPRHD Actions Against TRADSD & DPTMVD 2  *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. CCB020             Date 06Aug12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *  Prev Amend No. 234300             Date 29Sep06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 BUG3122            Date 17Jul04               *
      *                 222727             Date 05Nov03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSE015             Date 06Dec99               *
      *                 CSE017             Date 20Oct99               *
      *                 CSE012             Date 16Aug99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 053103             Date 25Nov94               *
      *                 S01486             Date 11Aug94               *
     F*                 061063             DATE 24SEP93               *
     F*                 050894             DATE 18MAY93               *
     F*                 42215              DATE 03JUL92               *
     F*                 R37467             DATE 26MAR92               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  CCB020 - COB Restructure - Secondary COB Infrastructure      *
      *  234300 - Recompiled over changed in PF/HSTTRD.               *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  222727 - Release 5.0 errors  (Recompile)                     *
      *  CSE015 - Forward Valued Depot Movements (Recompile)          *
      *  CSE017 - Cum/Ex Indicator on Depot Movements (Recompile)     *
      *  CSE012 - SE Depot Movement Narratives (Recompiled).          *
     F*  53103  - Performance Reconciliation Feature                  *
     F*  S01486 - Portfolio Management Upgrade to Release 10.         *
     F*  061063 - ONLY CHECK IF DATE AFTER BACKVALUE DATE             *
     F*  050894 - NARRATIVE '*** MATURED ***' ADDED TO PRINTER FILE   *
     F*           USE 'RETENTION DATE' TO AVOID TO COUNT DROPPED REC. *
     F*           CHECK 'MPHAS' TO CALCULATE EVENT CONTROL DATE       *
     F*  42215  - REPLACE TRADS BY LF/TRADHS (INCLUDES HIST. TRADES)  *
     F*  R37647 - PROGRAM REWRITTEN AS MAY HAVE PORTFOLIO REFERENCE   *
     F*           ON TRADSD AND DPTMVD FOR SETTLED TRADES FOR A       *
     F*           NON-PORTFOLIO CUSTOMER                              *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*****************************************************************
     F****TRADSD  IF  E                    DISK                           42215
     FTRADHS  IF  E           K        DISK                               42215
     FDPTMVD  IF  E                    DISK
     F***CAPRHC**IF**E           K        DISK                            S01486
     FPMCAPRL6IF  E           K        DISK                               S01486
     FSECTY   IF  E           K        DISK                               050894
     F***SDSECSL0IF**E           K        DISK                            S01486
     F***SDPLCSPDIF**E           K        DISK                            S01486
     F***SDBANKPDIF**E                    DISK                            S01486
     F***TABSE***IF**E           K        DISK                     050894 S01486
     F************TABLETAF                          KIGNORE        050894 S01486
     F************TABTB11F                          KIGNORE        050894 S01486
     F************TABTE10F                          KIGNORE        050894 S01486
     F************TABTE20F                          KIGNORE        050894 S01486
     F************TABTG10F                          KIGNORE        050894 S01486
     F************TABTG20F                          KIGNORE        050894 S01486
     F************TABLETHF                          KIGNORE        050894 S01486
     F************TABLETJF                          KIGNORE        050894 S01486
     F************TABLETKF                          KIGNORE        050894 S01486
     F************TABLETLF                          KIGNORE        050894 S01486
     F************TABLETNF                          KIGNORE        050894 S01486
     F************TABLETPF                          KIGNORE        050894 S01486
     F************TABLETRF                          KIGNORE        050894 S01486
     F************TABLETXF                          KIGNORE        050894 S01486
     F************TABLET2F                          KIGNORE        050894 S01486
     F************TABLET3F                          KIGNORE        050894 S01486
     F************TABLET5F                          KIGNORE        050894 S01486
     F************TABTB40F                          KIGNORE        050894 S01486
     F***PM4020P1O***E                    PRINTER                         S01486
     F*                                                                   S01486
     F** Reconcile CAPRHD Actions Against TRADSD & DPTMVD 2 Report        S01486
     FPM4020P1O   E             25     PRINTER      KINFDS SPOOL      UC  S01486
     F*                                                                   S01486
     F** Reconcile CAPRHD Actions Against TRADSD & DPTMVD 2 Run Controls  S01486
     FPM4020AUO   E             26     PRINTER      KINFDS SPOOLU         S01486
     F*                                                                   S01486
     F*****************************************************************   S01486
     F/EJECT                                                              S01486
     E*****************************************************************   S01486
     E*                                                                   S01486
     E** Array for COPYRIGHT                                              S01486
     E                    CPY@    1   1 80                                S01486
     E*****************************************************************   S01486
     E/EJECT                                                              S01486
     I*****************************************************************   S01486
     I*
     ITRADSDF
     I              RECI                            TDRECI
     I              PTFR                            TDPTFR
     I*                                                                   42215
     IHSTTRDF                                                             42215
     I              RECI                            TDRECI                42215
     I              PTFR                            TDPTFR                42215
     I*
     IDPTMVDF
     I              RECI                            DPRECI
     I              PTFR                            DPPTFR
     I*
     ISECTYDF                                                             050894
     I              RECI                            SRECI                 050894
     I*
     I** Event control date from data area PMSTAT
     I            DS
     I                                        1 256 WWDATE
     I                                        6  100WWRDAT
     I                                       36  410HKDAT                 050894
     I*                                                                   050894
     I**********  DS                                                                   050894 CCB020
     I**********                              1   1 PHASA                              050894 CCB020
     I*                                                                   050894
     I** LOCAL DATA AREA FOR DATABASE ERROR DETAILS                       050894
     I***LDA********UDS***********************     256             050894 S01486
     ILDA         DS                            256                       S01486
     I                                      132 183 DBLOT                 050894
     I                                      132 141 DBFILE                050894
     I                                      142 170 DBKEY                 050894
     I                                      171 180 DBPGM                 050894
     I                                      181 1830DBASE                 050894
     I*                                                                   S01486
     I** Data structure for compilation - COPYRIGHT insertion             S01486
     ICPYR@$      DS                                                      S01486
     I                                        1  80 CPY@                  S01486
     I                                        1  20 CPY@$$                S01486
     I*                                                                   S01486
     IRUNDAT    E DS                                                      S01486
     I** Standard data area layout for system flags and run date          S01486
     I*                                                                   S01486
     ISDBANK    E DSSDBANKPD                                              S01486
     I**  Data structure for Bank details                                 S01486
     I*                                                                   S01486
     ISDSTRD    E DSSDSTRDPD                                              S01486
     I**  Data structure for Securities Trading ICD                       S01486
     I*                                                                   S01486
     ISDSECS    E DSSDSECSPD                                              S01486
     I**  Data structure for security client details                      S01486
     I*                                                                   S01486
     ISDPLCS    E DSSDPLCSPD                                              S01486
     I**  Data structure for Portfolio Management customer details        S01486
     I*                                                                   S01486
     IDSFDY     E DSDSFDY                                                 S01486
     I**  Short data structure for access objects                         S01486
     I*                                                                   050894
     IDSSDY     E DSDSSDY                                                 S01486
     I**  Long data structure for access programs                         S01486
     I*                                                                   S01486
     ISPOOL       DS                                                      S01486
     I                                       83  92 SFILE                 S01486
     I                                    B 123 1240SFNUM                 S01486
     I                                    B 367 3680LINE                  S01486
     ISPOOLU      DS                                                      S01486
     I                                       83  92 SFILEU                S01486
     I                                    B 123 1240SFNUMU                S01486
     I                                    B 367 3680LINE1                 S01486
     I*                                                                   S01486
     I*****************************************************************   S01486
     I/EJECT                                                              S01486
     C*****************************************************************   S01486
     C*                                                                   S01486
     C**  Copyright statement                                             S01486
     C*                                                                   S01486
     C                     MOVEACPY@      ACT@   80                       S01486
     C*                                                                   S01486
     C           *NAMVAR   DEFN           LDA                             S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     MOVE *BLANKS   DBFILE                          S01486
     C                     MOVE *BLANKS   DBKEY                           S01486
     C                     MOVEL'PM4020'  DBPGM                           S01486
     C                     Z-ADD0         DBASE                           S01486
     C                     OUT  LDA                                       S01486
     C*                                                                   S01486
     C** Initialise work fields                                           S01486
     C*                                                                   S01486
     C                     Z-ADD*ZEROS    WNORE   50                      S01486
     C                     Z-ADD*ZEROS    WNORE1  50                      S01486
     C                     Z-ADD*ZEROS    LINE                            S01486
     C                     Z-ADD*ZEROS    LINE1                           S01486
     C                     MOVE 'N'       WRECF   1                       S01486
     C                     MOVE '0'       *IN24                           S01486
     C*                                                                   S01486
     C** Access RUNDAT for multibranching indicator                       S01486
     C*                                                                   S01486
     C           *NAMVAR   DEFN           RUNDAT                          S01486
     C                     IN   RUNDAT                                    S01486
     C           AGMBIN    IFEQ 'Y'                                       S01486
     C                     MOVE '1'       *IN27                           S01486
     C                     END                                            S01486
     C*
     C***OBTAIN*MIDAS*PHASE********************************************                050894 CCB020
     C*                                                                   050894
     C********** *NAMVAR   DEFN           MPHAS   1                                    050894 CCB020
     C**********           IN   MPHAS                                                  050894 CCB020
     C**********           MOVE MPHAS     PHASA                                        050894 CCB020
     C*                                                                   050894
      ** Check if the system is in COB Phase                                                  CCB020
      *                                                                                       CCB020
     C                     MOVEL'CBC00100'@RTPRM  9                                           CCB020
     C                     MOVE '1'       @RTPRM                                              CCB020
     C                     CALL @RTPRM                                                        CCB020
     C                     PARM *BLANKS   COBST   4                                           CCB020
      *                                                                                       CCB020
     C** OBTAIN LAST EVENT CONTROL DATE
     C*
     C           *NAMVAR   DEFN           PMSTAT256
     C                     IN   PMSTAT
     C                     MOVE PMSTAT    WWDATE
     C*
     C********** PHASA     IFEQ 'A'                                                    050894 CCB020
     C           COBST     IFEQ '*NO'                                                         CCB020
     C           WWRDAT    SUB  1         WWRDAT                          050894
     C                     END                                            050894
     C*
     C           CAPRKY    KLIST
     C                     KFLD           TDSS
     C                     KFLD           TDRF
     C                     KFLD           WWCSSE  1
     C*                                                                   S01486
     C** Ensure Audit Spool File recorded by RCF                          S01486
     C*                                                                   S01486
     C                     Z-ADDSFNUMU    ZSNUM2  60                      S01486
     C                     CALL 'ZSFILE'                                  S01486
     C                     PARM           SEQ     5                       S01486
     C                     PARM *BLANK    @PARM   3                       S01486
     C                     PARM           SFILEU                          S01486
     C                     PARM           ZSNUM2                          S01486
     C                     PARM           ZSERR                           S01486
     C           *LOCK     IN   LDA                                       S01486
     C*                                                                   S01486
     C** If an error occurred during ZSFILE processing,                   S01486
     C** Return to the calling program.                                   S01486
     C*                                                                   S01486
     C           ZSERR     IFEQ 'Y'                                       S01486
     C                     SETON                     U7U8LR               S01486
     C                     RETRN                                          S01486
     C                     END                                            S01486
     C*
     C***OTAIN*MIDAS*RUN*DATE******************************************   S01486
     C***********1         SETLLSDBANKPD                                  S01486
     C***********          READ SDBANKPD                 60               S01486
     C*                                                                   S01486
     C** Get bank details using access object                             S01486
     C*                                                                   S01486
     C                     CALL 'AOBANKR0'                                S01486
     C                     PARM *BLANKS   P@RTCD  7                       S01486
     C                     PARM '*FIRST ' P@OPTN  7                       S01486
     C           SDBANK    PARM SDBANK    DSFDY                           S01486
     C*                                                                   S01486
     C** Check if an error occurred                                       S01486
     C*                                                                   S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD1         DBASE            ***************S01486
     C                     MOVE 'SDBANKPD'DBFILE           * DBERROR  001 S01486
     C                     MOVE *BLANKS   DBKEY            ***************S01486
     C                     OUT  LDA                                       S01486
     C                     EXSR #LDBER                                    S01486
     C                     END                                            S01486
     C*
     C* Get Installation Control Data record for Securities trading       050894
     C*                                                                   050894
     C                     CALL 'AOSTRDR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*FIRST ' P@OPTN                          S01486
     C           SDSTRD    PARM SDSTRD    DSSDY                           S01486
     C*                                                                   S01486
     C** Check if an error occurred                                       S01486
     C*                                                                   S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD2         DBASE            ***************S01486
     C                     MOVE 'SDSTRDPD'DBFILE           * DBERROR  002 S01486
     C                     MOVE *BLANKS   DBKEY            ***************S01486
     C                     OUT  LDA                                       S01486
     C                     EXSR #LDBER                                    S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C***********          EXSR ZICDSE                             050894 S01486
     C***********                                                  050894 S01486
     C**If*error*in*ZICDSE,*abend*program************************* 050894 S01486
     C***********                                                  050894 S01486
     C************IN99     IFEQ '1'                 ***************050894 S01486
     C***********          MOVE '02'      DBASE     **DB ERROR 02**050894 S01486
     C***********          MOVEL'TABLE'   DBFILE    ***************050894 S01486
     C***********          MOVELZTABKY    DBKEY                    050894 S01486
     C***********          SETON                     U7U8LR        050894 S01486
     C***********          RETRN                                   050894 S01486
     C***********          END                                     050894 S01486
     C*                                                                   050894
     C** READ THROUGH TRADES FILE CHECKING DETAILS ON PF/CAPRHD
     C                     MOVE '1'       WWCSSE
     C***********          WRITEHEADERF                                   S01486
     C****                                                          050894061063
     C**Calculate Retention date                                    050894061063
     C****                                                          050894061063
     C****       31        MULT RTST      WK3N    30                050894061063
     C****       HKDAT     SUB  WK3N      RTNTDT  50                050894061063
     C*                                                                   061063
     C** CALCULATE BACKVALUE DATE                                         061063
     C***********WWRDAT    SUB  BKVP      RTNTDT  50               061063 S01486
     C           WWRDAT    SUB  BVBVP     RTNTDT  50               061063 S01486
     C*
     C****                 READ TRADSD                   60               42215
     C                     READ TRADHS                   60               42215
     C*
     C           *IN60     DOWEQ'0'                        B1
     C*                                                                   S01486
     C                     ADD  1         WNORE                           S01486
     C*
     C** CHECK WHETHER PORTFOLIO CUSTOMER
     C                     MOVE TCNR      WWCNUM  6
     C***********WWCNUM    CHAINSDSECSL0             63                   S01486
     C*                                                                   S01486
     C                     CALL 'AOSECSR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY    'P@OPTN                          S01486
     C                     PARM WWCNUM    P@AENB  6                       S01486
     C           SDSECS    PARM SDSECS    DSSDY                           S01486
     C*
     C                     MOVE 'N'       WWCUST
     C************IN63     IFEQ '0'                        B2             S01486
     C           P@RTCD    IFEQ *BLANKS                                   S01486
     C           BFCLAS    IFEQ 'S'                        B3
     C           BFCLAS    OREQ 'D'
     C                     MOVE 'Y'       WWCUST  1
     C                     END                             E3
     C                     END                             E2
     C*
     C***********WWCNUM    CHAINSDPLCSPD             63                   S01486
     C*                                                                   S01486
     C                     CALL 'AOPLCSR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY   ' P@OPTN                          S01486
     C                     PARM WWCNUM    P@CUST 10                       S01486
     C           SDPLCS    PARM SDPLCS    DSFDY                           S01486
     C*
     C           TINC      IFEQ 'C'                        B2
     C           TDVD      ANDLEWWRDAT
     C           TDMC      ANDLEWWRDAT
     C           TDRECI    ANDNE'*'
     C           WWCUST    ANDEQ'Y'
     C*
     C           TINC      OREQ 'C'
     C           TDDT      ANDLEWWRDAT
     C           TDMC      ANDLEWWRDAT
     C           TDRECI    ANDNE'*'
     C           WWCUST    ANDEQ'Y'
     C*
     C** SET FLAG TO INDICATE TRADE AND VALUE DATE TRADE ACTIONS FOUND
     C** CORRECTLY
     C           TDDT      IFLE WWRDAT                     B3
     C           TDDT      ANDGTRTNTDT                     B3             050894
     C                     MOVE 'N'       WWTRDE  1
     C                     ELSE                            X3
     C                     MOVE 'Y'       WWTRDE
     C                     END                             E3
     C*
     C           TDVD      IFLE WWRDAT                     B3
     C           TDVD      ANDGTRTNTDT                     B3             050894
     C                     MOVE 'N'       WWVLUE  1
     C                     ELSE                            X3
     C                     MOVE 'Y'       WWVLUE
     C                     END                             E3
     C*
     C***********CAPRKY    SETLLCAPRHC                                    S01486
     C***********CAPRKY    READECAPRHC                   61               S01486
     C           CAPRKY    SETLLPMCAPRL6                                  S01486
     C           CAPRKY    READEPMCAPRL6                 61               S01486
     C*
     C** CHECK THAT INFORMATION CORRECT
     C           *IN61     DOWEQ'0'                        B3
     C                     EXSR CHKTRD
     C***********CAPRKY    READECAPRHC                   61               S01486
     C           CAPRKY    READEPMCAPRL6                 61               S01486
     C                     END                             E3
     C*
     C           WWTRDE    IFEQ 'N'                        B3
     C           WWVLUE    OREQ 'N'
     C*
     C                     MOVE *BLANKS   RRNARR                          050894
     C           *IN61     IFEQ '1'                                       050894
     C           TDSS      CHAINSECTY                62                   050894
     C           *IN62     IFEQ '0'                                       050894
     C           SRECI     ANDEQ'M'                                       050894
     C           SRECI     OREQ 'C'                                       050894
     C           SRECI     OREQ '*'                                       050894
     C                     MOVEL'*** MAT' RRNARR                          050894
     C                     MOVE 'URED ***'RRNARR                          050894
     C                     END                                            050894
     C                     END                                            050894
     C*
     C                     MOVE TDRECI    RRRECI
     C                     MOVE TDSS      RRTDSS
     C                     MOVE TDRF      RRTDRF
     C                     MOVE WWTRDE    RRTRDE
     C                     MOVE WWVLUE    RRVLUE
     C                     MOVE 'TD'      RRTYPE
     C*                                                                   S01486
     C** At least one record to be output on report                       S01486
     C*                                                                   S01486
     C                     MOVE 'Y'       WRECF                           S01486
     C*                                                                   S01486
     C** OPEN detail printer file                                         S01486
     C*                                                                   S01486
     C           *IN24     IFEQ '0'                                       S01486
     C                     OPEN PM4020P1                                  S01486
     C                     MOVE '1'       *IN24                           S01486
     C*                                                                   S01486
     C** Ensure Report Spool File recorded by RCF                         S01486
     C*                                                                   S01486
     C                     Z-ADDSFNUM     ZSNUM1                          S01486
     C                     CALL 'ZSFILE'                                  S01486
     C                     PARM           SEQ                             S01486
     C                     PARM *BLANK    SENTY                           S01486
     C                     PARM           SFILE                           S01486
     C                     PARM           ZSNUM1                          S01486
     C                     PARM           ZSERR                           S01486
     C           *LOCK     IN   LDA                                       S01486
     C*                                                                   S01486
     C** If an error occurred during ZSFILE processing,                   S01486
     C** Return to the calling program.                                   S01486
     C*                                                                   S01486
     C           ZSERR     IFEQ 'Y'                                       S01486
     C                     SETON                     U7U8LR               S01486
     C                     RETRN                                          S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** Output heading                                                   S01486
     C*                                                                   S01486
     C                     WRITEHEADERF                                   S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** Output heading in case of overflow                               S01486
     C*                                                                   S01486
     C           LINE      IFGT 55                                        S01486
     C                     WRITEHEADERF                                   S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** Write detail line                                                S01486
     C*                                                                   S01486
     C                     WRITEERRORF                                    S01486
     C***********          WRITEERRORF                 62                 S01486
     C***********                                                         S01486
     C************IN62     IFEQ '1'                        B4             S01486
     C***********          WRITEHEADERF                                   S01486
     C***********          END                             E4             S01486
     C*
     C                     END                             E3
     C*
     C                     END                             E2
     C*
     C*****                READ TRADSD                   60               42215
     C                     READ TRADHS                   60               42215
     C                     END                             E1
     C*
     C** READ THROUGH DEPOT MOVEMENTS FILE CHECKING DETAILS ON PF/CAPRHD
     C                     MOVE '3'       WWCSSE
     C*
     C                     READ DPTMVD                   60
     C*
     C           *IN60     DOWEQ'0'                        B1
     C*                                                                   S01486
     C                     ADD  1         WNORE1                          S01486
     C*
     C** CHECK WHETHER PORTFOLIO CUSTOMER
     C                     MOVE DPBN      WWCNUM  6
     C***********WWCNUM    CHAINSDSECSL0             63                   S01486
     C*                                                                   S01486
     C                     CALL 'AOSECSR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY    'P@OPTN                          S01486
     C                     PARM WWCNUM    P@AENB                          S01486
     C           SDSECS    PARM SDSECS    DSSDY                           S01486
     C*
     C                     MOVE 'N'       WWCUST
     C************IN63     IFEQ '0'                        B2             S01486
     C           P@RTCD    IFEQ *BLANKS                                   S01486
     C           BFCLAS    IFEQ 'S'                        B3
     C           BFCLAS    OREQ 'D'
     C                     MOVE 'Y'       WWCUST  1
     C                     END                             E3
     C                     END                             E2
     C*
     C***********WWCNUM    CHAINSDPLCSPD             63                   S01486
     C*                                                                   S01486
     C                     CALL 'AOPLCSR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY   ' P@OPTN                          S01486
     C                     PARM WWCNUM    P@CUST                          S01486
     C           SDPLCS    PARM SDPLCS    DSFDY                           S01486
     C*
     C           DPRECI    IFEQ 'S'                        B2
     C           WWCUST    ANDEQ'Y'
     C           DPMV      ANDEQ'WI'
     C           DPVD      ANDGTRTNTDT                                    53103
     C           DPRECI    OREQ 'S'
     C           WWCUST    ANDEQ'Y'
     C           DPMV      ANDEQ'WO'
     C           DPVD      ANDGTRTNTDT                                    53103
     C                     MOVE DPSS      TDSS
     C                     MOVE DPRN      TDRF
     C*
     C                     MOVE 'N'       WWTRDE
     C                     MOVE 'N'       WWVLUE
     C*
     C***********CAPRKY    CHAINCAPRHC               61                   S01486
     C           CAPRKY    CHAINPMCAPRL6             61                   S01486
     C*
     C** CHECK THAT INFORMATION CORRECT
     C           *IN61     IFEQ '0'                        B3
     C                     EXSR CHKDPT
     C                     END                             E3
     C*
     C           WWTRDE    IFEQ 'N'                        B3
     C           WWVLUE    OREQ 'N'
     C*
     C                     MOVE *BLANKS   RRNARR                          050894
     C           *IN61     IFEQ '1'                                       050894
     C           TDSS      CHAINSECTY                62                   050894
     C           *IN62     IFEQ '0'                                       050894
     C           SRECI     ANDEQ'M'                                       050894
     C           SRECI     OREQ 'C'                                       050894
     C           SRECI     OREQ '*'                                       050894
     C                     MOVEL'*** MAT' RRNARR                          050894
     C                     MOVE 'URED ***'RRNARR                          050894
     C                     END                                            050894
     C                     END                                            050894
     C*
     C                     MOVE DPRECI    RRRECI
     C                     MOVE DPSS      RRTDSS
     C                     MOVE DPRN      RRTDRF
     C                     MOVE WWTRDE    RRTRDE
     C                     MOVE WWVLUE    RRVLUE
     C                     MOVE 'DP'      RRTYPE
     C*                                                                   S01486
     C** At least one record to be output on report                       S01486
     C*                                                                   S01486
     C                     MOVE 'Y'       WRECF                           S01486
     C*                                                                   S01486
     C** OPEN detail printer file                                         S01486
     C*                                                                   S01486
     C           *IN24     IFEQ '0'                                       S01486
     C                     OPEN PM4020P1                                  S01486
     C                     MOVE '1'       *IN24                           S01486
     C*                                                                   S01486
     C** Ensure Report Spool File recorded by RCF                         S01486
     C*                                                                   S01486
     C                     Z-ADDSFNUM     ZSNUM1  60                      S01486
     C                     CALL 'ZSFILE'                                  S01486
     C                     PARM           SEQ                             S01486
     C                     PARM *BLANK    SENTY   3                       S01486
     C                     PARM           SFILE                           S01486
     C                     PARM           ZSNUM1                          S01486
     C                     PARM           ZSERR   1                       S01486
     C           *LOCK     IN   LDA                                       S01486
     C*                                                                   S01486
     C** If an error occurred during ZSFILE processing,                   S01486
     C** Return to the calling program.                                   S01486
     C*                                                                   S01486
     C           ZSERR     IFEQ 'Y'                                       S01486
     C                     SETON                     U7U8LR               S01486
     C                     RETRN                                          S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** Output heading                                                   S01486
     C*                                                                   S01486
     C                     WRITEHEADERF                                   S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** Output heading in case of overflow                               S01486
     C*                                                                   S01486
     C           LINE      IFGT 55                                        S01486
     C                     WRITEHEADERF                                   S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** Write detail line                                                S01486
     C*                                                                   S01486
     C                     WRITEERRORF                                    S01486
     C***********          WRITEERRORF                 62                 S01486
     C***********                                                         S01486
     C************IN62     IFEQ '1'                        B4             S01486
     C***********          WRITEHEADERF                                   S01486
     C***********          END                             E4             S01486
     C*
     C                     END                             E3
     C*
     C                     END                             E2
     C*
     C                     READ DPTMVD                   60
     C                     END                             E1
     C*                                                                   S01486
     C** Output heading in case of overflow                               S01486
     C*                                                                   S01486
     C           LINE      IFGT 55                                        S01486
     C           *IN24     ANDEQ'1'                                       S01486
     C                     WRITEHEADERF                                   S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C           *IN24     IFEQ '1'                                       S01486
     C                     WRITETRAILF                                    S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     Z-ADDWNORE     SNORE                           S01486
     C                     Z-ADDWNORE1    SNORE1                          S01486
     C*                                                                   S01486
     C** Produce Run Controls                                             S01486
     C*                                                                   S01486
     C                     WRITEHEADAU                                    S01486
     C                     WRITECONTROL                                   S01486
     C*                                                                   S01486
     C** No details to report.                                            S01486
     C*                                                                   S01486
     C           WRECF     IFEQ 'N'                                       S01486
     C                     WRITENODTLS                                    S01486
     C                     END                                            S01486
     C*
     C***********          WRITETRAILF                 62                 S01486
     C                     SETON                     LR
     C                     RETRN                                          S01486
     C**************************************************************************
     C***
     C***   SR TO CHECK TRADE INFORMATION
     C***
     C**************************************************************************
     C           CHKTRD    BEGSR
     C*
     C** CHECK TRADE DATE RECORD
     C           TDDT      IFEQ CSDA
     C           CSDA      ANDGTRTNTDT                                    050894
     C           CSCN      ANDEQTCNR
     C***********CSBR      ANDEQTDBR                                      S01486
     C           CSBA      ANDEQTDBA                                      S01486
     C           CSSC      ANDEQTDSS
     C           CSOA      ANDEQTDTP
     C           CSNL      ANDEQNOML
     C           CSRF      ANDEQTDRF
     C*
     C           TDPTFR    IFNE *BLANKS
     C           PMTI      ANDEQ'H'
     C           QBRECI    ANDEQ'D'
     C                     MOVE 'Y'       WWTRDE
     C                     END
     C*
     C           TDPTFR    IFEQ *BLANKS
     C           PTFR      ANDEQ*BLANKS
     C           TDPTFR    ORNE *BLANKS
     C           PTFR      ANDEQ*BLANKS
     C           QBRECI    ANDEQ'*'
     C                     MOVE 'Y'       WWTRDE
     C                     END
     C*
     C                     END
     C*
     C** CHECK VALUE DATE RECORD
     C           TDVD      IFEQ CSDA
     C           CSDA      ANDGTRTNTDT                                    050894
     C           CSCN      ANDEQTCNR
     C***********CSBR      ANDEQTDBR                                      S01486
     C           CSBA      ANDEQTDBA                                      S01486
     C           CSSC      ANDEQTDSS
     C           CSOA      ANDEQTDTP
     C           CSNL      ANDEQNOML
     C           CSRF      ANDEQTDRF
     C*
     C           TDPTFR    IFNE *BLANKS
     C           PMVI      ANDEQ'H'
     C           QBRECI    ANDEQ'D'
     C                     MOVE 'Y'       WWVLUE
     C                     END
     C*
     C           TDPTFR    IFEQ *BLANKS
     C           PTFR      ANDEQ*BLANKS
     C           TDPTFR    ORNE *BLANKS
     C           PTFR      ANDEQ*BLANKS
     C           QBRECI    ANDEQ'*'
     C                     MOVE 'Y'       WWVLUE
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C**************************************************************************
     C***
     C***   SR TO CHECK DEPOT MOVEMENT INFORMATION
     C***
     C**************************************************************************
     C           CHKDPT    BEGSR
     C*
     C** CONVERT MOVEMENT TYPE
     C                     MOVE *BLANKS   WWMOVT  2
     C           DPMV      IFEQ 'WI'                       B1
     C                     MOVE 'CI'      WWMOVT
     C                     Z-ADDDPMD      WWDPMD  50
     C                     ELSE                            X1
     C                     MOVE 'CO'      WWMOVT
     C                     Z-ADDDPDO      WWDPMD  50
     C                     END                             E1
     C*
     C** CHECK TRADE DATE RECORD
     C           WWDPMD    IFEQ CSDA                       B1
     C           CSDA      ANDGTRTNTDT                                    050894
     C           CSCN      ANDEQDPBN
     C***********CSBR      ANDEQDPBC                                      S01486
     C           CSBA      ANDEQDPBA                                      S01486
     C           CSSC      ANDEQDPSS
     C           CSOA      ANDEQWWMOVT
     C           CSNL      ANDEQDPNA
     C           CSRF      ANDEQDPRN
     C*
     C           DPPTFR    IFNE *BLANKS                    B2
     C           PMTI      ANDEQ'H'
     C           QBRECI    ANDEQ'D'
     C                     MOVE 'Y'       WWTRDE
     C                     END                             E2
     C*
     C           DPPTFR    IFEQ *BLANKS                    B2
     C           PTFR      ANDEQ*BLANKS                    B2
     C           DPPTFR    ORNE *BLANKS
     C           PTFR      ANDEQ*BLANKS
     C           QBRECI    ANDEQ'*'
     C                     MOVE 'Y'       WWTRDE
     C                     END                             E2
     C                     ELSE                                           061063
     C                     MOVE 'Y'       WWTRDE                          061063
     C                     END                             E1
     C*
     C** CHECK VALUE DATE RECORD
     C           WWDPMD    IFEQ CSDA                       B1
     C           CSDA      ANDGTRTNTDT                                    050894
     C           CSCN      ANDEQDPBN
     C***********CSBR      ANDEQDPBC                                      S01486
     C           CSBA      ANDEQDPBA                                      S01486
     C           CSSC      ANDEQDPSS
     C           CSOA      ANDEQWWMOVT
     C           CSNL      ANDEQDPNA
     C           CSRF      ANDEQDPRN
     C*
     C           DPPTFR    IFNE *BLANKS                    B2
     C           PMVI      ANDEQ'H'
     C           QBRECI    ANDEQ'D'
     C                     MOVE 'Y'       WWVLUE
     C                     END                             E2
     C*
     C           DPPTFR    IFEQ *BLANKS                    B2
     C           PTFR      ANDEQ*BLANKS                    B2
     C           DPPTFR    ORNE *BLANKS
     C           PTFR      ANDEQ*BLANKS
     C           QBRECI    ANDEQ'*'
     C                     MOVE 'Y'       WWVLUE
     C                     END                             E2
     C                     ELSE                                           061063
     C                     MOVE 'Y'       WWVLUE                          061063
     C                     END                             E1
     C*
     C                     ENDSR
     C********************************************************************
     C*****SUBROUTINE-*ZICDSE************************************* 050894 S01486
     C*****ACCESS*ICD*RECORD*FROM*TABTB36*FOR*SECURITIES*TRADING** 050894 S01486
     C************************************************************ 050894 S01486
     C***1.TABTB36*MUST*BE*DECLARED*IN*THE*PROGRAM**************** 050894 S01486
     C***2.ON*RETURN*FROM*THIS*S/R*THE*PROGRAM*MUST*CHECK*U7/U8*-* 050894 S01486
     C*****AND*IF*ON*MUST*EXECUTE*STD*DATABASE*ERROR*ROUTINE****** 050894 S01486
     C***3.*IN99*IS*USED****************************************** 050894 S01486
     C************************************************************ 050894 S01486
     C************************************************************ 050894 S01486
     C************************************************************ 050894 S01486
     C***/COPY ZSRSRC,ZICDSEZ1                                            S01486
     C************************************************************ 050894 S01486
      /EJECT
     C*****************************************************************   S01486
     C*                                                               *   S01486
     C* #LDBER  - Database error processing                           *   S01486
     C*                                                               *   S01486
     C* Called by: Main                                               *   S01486
     C* Calls    : None                                               *   S01486
     C*                                                               *   S01486
     C*****************************************************************   S01486
     C           #LDBER    BEGSR                           ***  #LDBER ** S01486
     C*                                                                   S01486
     C                     WRITEHEADAU                                    S01486
     C                     WRITEDBERROR                                   S01486
     C*                                                                   S01486
     C           *IN24     IFEQ '1'                                       S01486
     C                     WRITEDBERR                                     S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     EXSR *PSSR                                     S01486
     C*                                                                   S01486
     C                     ENDSR                                          S01486
     C*                                                                   S01486
     C*****************************************************************   S01486
     C*                                                               *   S01486
     C* *PSSR   - Subroutine to handle abnormal error conditions      *   S01486
     C*                                                               *   S01486
     C* Called by: Main                                               *   S01486
     C* Calls    : None                                               *   S01486
     C*                                                               *   S01486
     C*****************************************************************   S01486
     C           *PSSR     BEGSR                           ***  PSSR  *** S01486
     C*                                                                   S01486
     C           WRUN      IFEQ *BLANKS                                   S01486
     C                     MOVE 'Y'       WRUN    1                       S01486
     C                     DUMP                                           S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     SETON                     U7U8LR               S01486
     C                     RETRN                                          S01486
     C*                                                                   S01486
     C                     ENDSR                                          S01486
     C*                                                                   S01486
     C********************************************************************
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
