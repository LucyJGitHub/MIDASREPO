     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas PM Reset base currency')
     F*****************************************************************
     F*                                                               *
     F*  Midas - Portfolio Management Module                          *
     F*                                                               *
     F*  PM6420 - RESET BASE CURRENCY                                 *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
     F*  Last Amend No. 250228             Date 22May20               *
      *  Prev Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 234300             Date 22Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CGL029             Date 01Sep03               *
      *                 222727             Date 05Nov03               *
      *                 CAS006             Date 21Jan03               *
      * Midas Release 4.01.01 ----------------------------------------*
      *                 207006             Date 18Jun02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CSE023             Date 12Jul00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSE015             Date 06Dec99               *
      *                 CSE017             Date 20Oct99               *
      *                 CSE012             Date 16Aug99               *
     F*                 160446             Date 11May99               *
     F*                 158524             Date 20Apr99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 CAC003             Date 25Feb97               *
     F*                 CPM005             Date 19JUN96               *
     F*                 S01124             Date 20JUN94               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  250228 - Recompile due to field change in PMPSTMQ0.          *
      *  MD046248 - Finastra Rebranding                               *
      *  234300 - Recompiled over changed in PF/HSTTRD.               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222727 - Release 5.0 errors  (Recompile)                     *
      *  CAS006 - Hedge Accounting Phase B (Recompile)                *
      *  207006 - Add Counterparty & Market Centre to SSI (Recompile) *
      *  CSE023 - Treaty Withholding Tax (Recompiled)                 *
      *  CSE015 - Forward Valued Depot Movements (Recompile)          *
      *  CSE017 - Cum/Ex Indicator on Depot Movements (Recompile)     *
      *  CSE012 - SE Depot Movement Narratives (Recompiled).          *
     F*  160446 - Modify DUMP run in  *PSSR to have full details in   *
     F*           case if DECIMAL DATA ERROR.                         *
     F*  158524 - If the two currencies are in the Euroland, the      *
     F*           new EMU fields in SDCURRPD must be taken.           *
     F*  CAC003 - Profit Centre Accounting Development Phase 3.       *
     F*         - Recompiled due to changes in PF/PMPORTPD.           *
     F*  CPM005 - Private Banking Phase 2                             *
     F*           Focus Group Changes upgraded to DBA                 *
     F*  S01124  -  PBFG/1 - CHANGE CUSTOMER/PORTFOLIO BASE CURRENCY  *
     F*                                                               *
     F*****************************************************************
     FPMPCBCL1IF  E           K        DISK
     F                                              KINFSR *PSSR
     FPMPCBCL0UF  E           K        DISK
     F            PMPCBCD0                          KRENAMEPMPCBCDD
     F                                              KINFSR *PSSR
     F***SDBANKL1IF**E           K        DISK                            CPM005
     F***********                                   KINFSR *PSSR          CPM005
     F***SDCURRL1IF**E           K        DISK                            CPM005
     F***********                                   KINFSR *PSSR          CPM005
     F***SDPLCSLLUF**E           K        DISK                            CPM005
     FSDPLCSL1UF  E           K        DISK                               CPM005
     F                                              KINFSR *PSSR
     FPMCNSDLLUF  E           K        DISK
     F                                              KINFSR *PSSR
     F***PMPORTPPUF**E           K        DISK                            CPM005
     FPMPORTPDUF  E           K        DISK                               CPM005
     F                                              KINFSR *PSSR
     FPMCPOSLLIF  E           K        DISK
     F                                              KINFSR *PSSR
     FSECTY   IF  E           K        DISK
     F                                              KINFSR *PSSR
     FCAPRHD  O   E           K        DISK
     F                                              KINFSR *PSSR
     F***PMPSTMPPUF**E           K        DISK                            CPM005
     FPMPSTMQ0UF  E           K        DISK                               CPM005
     F                                              KINFSR *PSSR
     FPMPTRALLUF  E           K        DISK
     F                                              KINFSR *PSSR
     FPMPCAAL7UF  E           K        DISK
     F                                              KINFSR *PSSR
     FPMAPOSLLUF  E           K        DISK                      A
     F                                              KINFSR *PSSR
     F            PMCPOSP0                          KRENAMEPMAPOSD0
     F***PORTMT**UF**E           K        DISK                            CPM005
     FPMTRMVL0UF  E           K        DISK                               CPM005
     F            CAPRHDF                           KIGNORE
     F                                              KINFDS FDS1
     F                                              KINFSR *PSSR
     F***CAPRHP**UF**E           K        DISK                            CPM005
     FPMCAPRL5UF  E           K        DISK                               CPM005
     F            CAPRHDF                           KRENAMECAPRHD0
     F                                              KINFSR *PSSR
      *****************************************************************
      /COPY ZSRSRC,ZPOWERZ1
      *
     E                    CPY@    1   1 80
      *****************************************************************
     IPMCNSDD0
     I              PNRECI                          XPNREC
     I              PNLUID                          XPNLUI
     I              PNCHTP                          XPNCHT
     I              PNLCD                           XPNLCD
     I              PNTNLU                          XPNTNL
     I              PNCNUM                          XPNCNU
     I              PNPTFR                          XPNPTF
     I              PNVLFQ                          XPNVLF
     I              PNVLDM                          XPNVLD
     I              PNVLND                          XPNVLN
     I              PNS1VR                          XPNS1V
     I              PNS2VR                          XPNS2V
     I              PNS3VR                          XPNS3V
     I              PNS4VR                          XPNS4V
     I              PNS5VR                          XPNS5V
     I              PNS6VR                          XPNS6V
     I              PNS7VR                          XPNS7V
     I              PNS8VR                          XPNS8V
     I              PNS9VR                          XPNS9V
     I              PNS0VR                          XPNS0V
     I              PNRPYP                          XPNRPY
     I              PNTYSM                          XPNTYS
     I              PNADPP                          XPNADP
     I              PNPSDT                          XPNPSD
     I              PNPMNG                          XPNPMN
     I              PNPTCY                          XPNPTC
     I              PNPCDP                          XPNPCD
     IPMAPOSD0
     I              QAAPNM                          YAAPNM
     I              QATNMC                          YATNMC
     I              QAAYNM                          YAAYNM
      *
      **  LOCAL DATA AREA FOR DATA BASE ERRORS:
     ILDA         DS                            256
     I***********                           132 183 DBLOT                 CPM005
     I***********                           132 141 DBFILE                CPM005
     I                                      134 183 DBLOT                 CPM005
     I                                      134 141 DBFILE                CPM005
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*
     IPMSTAT    E DS
     I                                        1   50WWECD
     I                                        1 256 WWSTAT
      *
      **  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION:
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     IWKEY1       DS
     I**********                              1   60KCNUM                                     CSD027
     I                                        1   6 KCNUM                                     CSD027
     I                                        7  10 KPTFR
     IWKEY2       DS
     I**********                              1   60KCNUM2                                    CSD027
     I                                        1   6 KCNUM2                                    CSD027
     I                                        7  10 KPTFR2
     I                                       11  150KTNLU2
      *
      ** FILE STATUS DATA STRUCTURE - RECORD FORMAT
     IFDS1        DS
     I                                     *RECORD  @FORM
     I*                                                                   CPM005
     ISDCURR    E DSSDCURRPD                                              CPM005
     I* DS FOR CURRENCIES DETAILS                                         CPM005
     I*                                                                   CPM005
     ISDBANK    E DSSDBANKPD                                              CPM005
     I** EXTERNAL DS FOR BANK DETAILS                                     CPM005
     ISDGELR    E DSSDGELRPD                                              158524
     I** General ledger details                                           158524
     I*                                                                   CPM005
     IDSFDY     E DSDSFDY                                                 CPM005
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                CPM005
     I*                                                                   CPM005
     IDSSDY     E DSDSSDY                                                 CPM005
     I* Second DS For Access Programs, Long Data Structure                CPM005
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * INDEX OF SUBROUTINES                                             *
      * MAIN     -                                                       *
      * #INIT    - INITIAL PROCESSING                                    *
      * #MAIN    - MAIN PROCESSING                                       *
      * #POSI    - RESET ALL POSITIONS                                   *
      * #TRAD    - RESET ALL TRANSACTIONS                                *
      * #ACTI    - RESET ALL ACTIONS                                     *
      * #TERM    - TERMINATION PROCESSING                                *
      * *PSSR    - ERROR IN FILE                                         *
      *                                                                  *
      * EXTERNAL ROUTINES CALLED                                         *
      *                                                                  *
      ********************************************************************
     C                     EXSR #INIT
      *
     C                     EXSR #MAIN
      *
     C                     EXSR #TERM
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #INIT    - INITIAL PROCESSING                                    *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * *PSSR    - ERROR IN FILE                                         *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #INIT     BEGSR
      *
      **  PREPARE LDA:
     C           *NAMVAR   DEFN           LDA
     C                     MOVEL*BLANK    DBLOT
     C                     MOVEL'PM6420'  DBPGM
     C*
     C** DEFINE DATA AREA PMSTAT
     C           *NAMVAR   DEFN           PMSTAT
     C                     IN   PMSTAT
     C*
     C           KEY1      KLIST
     C**********           KFLD           KCNUM   60                                          CSD027
     C                     KFLD           KCNUM   6                                           CSD027
     C                     KFLD           KPTFR   4
     C*
     C           KEY2      KLIST
     C**********           KFLD           KCNUM2  60                                          CSD027
     C                     KFLD           KCNUM2  6                                           CSD027
     C                     KFLD           KPTFR2  4
     C                     KFLD           KTNLU2  50
     C*
     C           KEY3      KLIST
     C**********           KFLD           KYCUST  60                                          CSD027
     C                     KFLD           KYCUST  6                                           CSD027
     C                     KFLD           KYPTFR  4
      *
      **  GET INSTALLATION CONTROL DATA RECORD 1:
     C************LOVAL    SETLLSDBANKL1                                  CPM005
     C***********          READ SDBANKL1                 71               CPM005
     C                     CALL 'AOBANKR0'                                CPM005
     C                     PARM *BLANKS   WWRTCD  7                       CPM005
     C                     PARM '*FIRST ' WWOPTN  7                       CPM005
     C           SDBANK    PARM SDBANK    DSFDY                           CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C************IN71     IFEQ '1'                        *B1            CPM005
     C           WWRTCD    IFNE *BLANKS                    *B1            CPM005
     C                     Z-ADD1         DBASE            ***************
     C***********          MOVEL'SDBANKL1'DBFILE           * DB ERROR 01 *CPM005
     C                     MOVE 'SDBANKPD'DBFILE           * DB ERROR 01 *CPM005
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E1
      *
     C** Call access object : General Ledger                              158524
     C*                                                                   158524
     C**********           CALL 'AOGELRR0'                                             158524 CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*DBERR ' WWRTCD                          158524
     C                     PARM '*FIRST ' WWOPTN                          158524
     C********** SDGELR    PARM SDGELR    DSFDY                                        158524 CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C*                                                                   158524
      **  If record not found, DB error                                   158524
     C           WWRTCD    IFNE *BLANKS                    *B1            158524
     C                     Z-ADD20        DBASE            ***************158524
     C                     MOVE 'SDGELRPD'DBFILE           * DB ERROR 20 *158524
     C                     MOVEL*BLANKS   DBKEY            ***************158524
     C                     EXSR *PSSR                                     158524
     C                     END                             *E1            158524
     C*                                                                   158524
     C**********           Z-ADD*ZEROS    WWCUST  60                                          CSD027
     C                     MOVE *BLANKS   WWCUST  6                                           CSD027
     C                     MOVE *BLANKS   WWPTFR  4
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #MAIN    - MAIN PROCESSING                                       *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      * ZDATE2   -                                                       *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #MAIN     BEGSR
      *
     C           *LOVAL    SETLLPMPCBCL1
     C                     READ PMPCBCL1                 72
      *
     C           *IN72     DOWEQ'0'                        *BW1
      *
     C           FMCUST    IFNE WWCUST                     *B1
     C           FMPTFR    ORNE WWPTFR
      *
     C**********           Z-ADDFMCUST    WWCUST                                              CSD027
     C                     MOVE FMCUST    WWCUST                                              CSD027
     C                     MOVE FMPTFR    WWPTFR
      *
      **  ACCESS CURRENCY DETAILS FILE TO RETRIEVE NEW CURRENCY DETAILS
     C***********FMNBCY    CHAINSDCURRL1             71                   CPM005
     C                     CALL 'AOCURRR0'                                CPM005
     C                     PARM *BLANKS   WWRTCD                          CPM005
     C                     PARM '*KEY   ' WWOPTN                          CPM005
     C                     PARM FMNBCY    WWKEYC  3                       CPM005
     C           SDCURR    PARM SDCURR    DSSDY                           CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C************IN71     IFEQ '1'                        *B2            CPM005
     C           WWRTCD    IFNE *BLANKS                                   CPM005
     C                     Z-ADD2         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVELFMNBCY    DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
      *
     C                     Z-ADDA6SPRT    W2SPRT 138
     C                     MOVELA6MDIN    W2MDIN  1
     C                     Z-ADDA6NBDP    W2NBDP  10
     C                     MOVELA6INCY    W2INCY  1                       158524
     C                     Z-ADDA6EUER    W2EUER 138                      158524
     C                     MOVELA6EUMD    W2EUMD  1                       158524
      *
      ****IF*PORTFOLIO*REFERENCE*FROM*PF/PMPCBCPP*IS*EQUAL*TO*BLANKS******CPM005
      **  IF PORTFOLIO REFERENCE FROM PF/PMPCBCPD IS EQUAL TO BLANKS      CPM005
      **  (CUSTOMER BASE CURRENCY CHANGE)
     C           FMPTFR    IFEQ *BLANKS                    *B2
      *
      **  CHANGE CUSTOMER BASE CURRENCY
     C                     EXSR #CHGBC
     C                     MOVEL'9997'    KYPTFR
      *
      **  (PORTFOLIO BASE CURRENCY CHANGE)
     C                     ELSE                            *X2
      *
      **  CHANGE PORTFOLIO BASE CURRENCY
     C                     EXSR #CHGPC
     C                     MOVELFMPTFR    KYPTFR
     C                     END                             *E2
      *
      **  SETUP CUSTOMER
     C                     MOVE FMCUST    KYCUST
      *
      **  PORTFOLIO POSITIONS PROCESSING
     C                     EXSR #PORTF
      *
      ****RESET*ALL*POSITIONS*IN*PMCPOSPP*********************************CPM005
      **  RESET ALL POSITIONS IN PMCPOSPD                                 CPM005
     C                     EXSR #POSI
      *
      ****RESET*ALL*TRANSACTIONS*IN*PORTMT********************************CPM005
      **  RESET ALL TRANSACTIONS IN PMTRMVL0                              CPM005
     C                     EXSR #TRAD
      *
      **  RESET ALL ACTIONS IN CAPRHP
     C                     EXSR #ACTI
     C                     END                             *E1
      *
      **  'MATURED' PROCESSING
     C                     EXSR #MATUR
      *
     C                     READ PMPCBCL1                 72
     C                     END                             *EW1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #POSI    - RESET ALL POSITIONS                                   *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #POSI     BEGSR
      *
      **  IF CHANGE OF BASE CURRENCY
     C           KYPTFR    IFEQ '9997'                     *B0
     C           KYCUST    SETLLPMAPOSLL
     C           KYCUST    READEPMAPOSLL                 73
     C                     ELSE                            *X0
     C           KEY3      SETLLPMAPOSLL
     C           KEY3      READEPMAPOSLL                 73
     C                     END                             *E0
      *
     C           *IN73     DOWEQ*OFF                       *BW1
      *
      **  ACCESS CURRENCY DETAILS FILE TO RETRIEVE NOMINAL CCY DETAILS
     C***********YATNMC    CHAINSDCURRL1             71                   CPM005
     C                     CALL 'AOCURRR0'                                CPM005
     C                     PARM *BLANKS   WWRTCD                          CPM005
     C                     PARM '*KEY   ' WWOPTN                          CPM005
     C                     PARM YATNMC    WWKEYC                          CPM005
     C           SDCURR    PARM SDCURR    DSSDY                           CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C************IN71     IFEQ '1'                        *B2            CPM005
     C           WWRTCD    IFNE *BLANKS                                   CPM005
     C                     Z-ADD8         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DB ERROR 08 *CPM005
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 08 *CPM005
     C                     MOVELYATNMC    DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
      *
      **  CONVERT AP NUMERATOR FROM NOMINAL CCY TO NEW CCY
     C                     Z-ADDYAAPNM    ZAMTF
     C                     MOVELYATNMC    ZCCYF
     C                     Z-ADDA6SPRT    ZRATEF
     C                     MOVELA6MDIN    ZMDINF
     C                     Z-ADDA6NBDP    ZCDPF
      *
     C                     MOVELFMNBCY    ZCCYT
     C                     Z-ADDW2SPRT    ZRATET
     C                     MOVELW2MDIN    ZMDINT
     C                     Z-ADDW2NBDP    ZCDPT
     C*                                                                   158524
     C           YATNMC    IFEQ BKEURO                     B2             158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C           FMNBCY    OREQ BKEURO                                    158524
     C           A6INCY    ANDEQ'Y'                                       158524
     C           A6INCY    OREQ 'Y'                                       158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'FROM' details for Nominal Currency       158524
     C           YATNMC    IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINF                          158524
     C                     Z-ADD1         ZRATEF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDA6EUER    ZRATEF                          158524
     C                     MOVE A6EUMD    ZMDINF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'TO' details for Portfolio Currency       158524
     C           FMNBCY    IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINT                          158524
     C                     Z-ADD1         ZRATET                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDW2EUER    ZRATET                          158524
     C                     MOVE W2EUMD    ZMDINT                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C                     END                             E2             158524
     C*                                                                   158524
     C                     EXSR ZCCYCN
      *
     C                     Z-ADDZAMTT     QAFXAP
      *
      **  IF CHANGE OF PORTFOLIO CURRENCY
     C           FMPTFR    IFNE *BLANKS
     C                     MOVE FMNBCY    QAPTCY
     C                     Z-ADDW2NBDP    QAPCDP
      *
      **  IF CHANGE OF BASE CURRENCY
     C                     ELSE
      *
      **  IF RECORD READ HAS A PORTFOLIO REFERENCE EQUAL TO '9997'
      **  CHANGE THE PORTFOLIO AND THE BASE CURRENCIES + NUMBER OF DEC. PLACES
     C           QAPTFR    IFEQ '9997'
     C                     MOVE FMNBCY    QAPTCY
     C                     Z-ADDW2NBDP    QAPCDP
     C                     MOVE FMNBCY    QACSBY
     C                     Z-ADDW2NBDP    QABYDP
     C                     ELSE
      *
      **  IF RECORD READ HAS A PORTFOLIO REFERENCE *NOT* EQUAL TO '9997'
      **  CHANGE *ONLY* THE BASE CURRENCY + NUMBER OF DECIMAL PLACES
     C                     MOVE FMNBCY    QACSBY
     C                     Z-ADDW2NBDP    QABYDP
     C                     END
      *
     C                     END
      *
     C                     MOVE 'N'       WWNEWR  1
      *
     C           QARECI    IFEQ 'D'
     C           QAPDAT    ANDNEFMCDAT
     C                     MOVE 'Y'       WWNEWR
     C                     MOVE 'I'       QARECI
     C                     END
      *
     C                     EXCPTPMAPOU
      *
     C           WWNEWR    IFEQ 'Y'
     C                     MOVE 'D'       QARECI
     C                     Z-ADDFMCDAT    QAPDAT
     C                     WRITEPMAPOSD0
     C                     READ PMAPOSD0                 73
     C                     END
      *
     C           *IN73     IFEQ '0'
      *
      **  IF CHANGE OF BASE CURRENCY
     C           KYPTFR    IFEQ '9997'
     C           KYCUST    READEPMAPOSLL                 73
     C                     ELSE
     C           KEY3      READEPMAPOSLL                 73
     C                     END
      *
     C                     END
      *
     C                     ENDDO                           *EW1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #TRAD    - RESET ALL TRANSACTIONS                                *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #TRAD     BEGSR
      *
     C***********KEY3      SETLLPORTMT                                    CPM005
     C***********KEY3      READEPORTMT                   73               CPM005
     C           KEY3      SETLLPMTRMVL0                                  CPM005
     C           KEY3      READEPMTRMVL0                 73               CPM005
      *
     C           *IN73     DOWEQ*OFF                       *BW1
      *
      **  RECORD COMES FROM DPTMVD
     C           @FORM     IFEQ 'DPTMVDF'                  *B1
     C           @FORM     OREQ 'DPTMVTF'
      *
      **  ACCESS SECURITY TO RETRIEVE NOMINAL CCY
     C           DPSS      CHAINSECTY                71
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C           *IN71     IFEQ '1'                        *B2
     C                     Z-ADD9         DBASE            ***************
     C                     MOVEL'SECTY'   DBFILE           * DB ERROR 09 *
     C                     MOVELDPSS      DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
      *
      **  ACCESS CURRENCY FILE TO RETRIEVE DETAILS
     C***********NMCY      CHAINSDCURRL1             71                   CPM005
     C                     CALL 'AOCURRR0'                                CPM005
     C                     PARM *BLANKS   WWRTCD                          CPM005
     C                     PARM '*KEY   ' WWOPTN                          CPM005
     C                     PARM NMCY      WWKEYC  3                       CPM005
     C           SDCURR    PARM SDCURR    DSSDY                           CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C************IN71     IFEQ '1'                        *B2            CPM005
     C           WWRTCD    IFNE *BLANKS                                   CPM005
     C                     Z-ADD10        DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVELNMCY      DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
      *
      **  CONVERT SPOT RATE FROM NOMINAL CCY TO NEW CCY
     C                     Z-ADD1         ZAMTF
     C                     MOVELNMCY      ZCCYF
     C                     Z-ADDA6SPRT    ZRATEF
     C                     MOVELA6MDIN    ZMDINF
     C                     Z-ADDA6NBDP    ZCDPF
      *
     C                     MOVELFMNBCY    ZCCYT
     C                     Z-ADDW2SPRT    ZRATET
     C                     MOVELW2MDIN    ZMDINT
     C                     Z-ADDW2NBDP    ZCDPT
     C*                                                                   158524
     C           NMCY      IFEQ BKEURO                     B2             158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C           FMNBCY    OREQ BKEURO                                    158524
     C           A6INCY    ANDEQ'Y'                                       158524
     C           A6INCY    OREQ 'Y'                                       158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'FROM' details for Nominal Currency       158524
     C           NMCY      IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINF                          158524
     C                     Z-ADD1         ZRATEF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDA6EUER    ZRATEF                          158524
     C                     MOVE A6EUMD    ZMDINF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'TO' details for Portfolio Currency       158524
     C           FMNBCY    IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINT                          158524
     C                     Z-ADD1         ZRATET                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDW2EUER    ZRATET                          158524
     C                     MOVE W2EUMD    ZMDINT                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C                     END                             E2             158524
     C*                                                                   158524
     C                     EXSR ZCCYCN
      *
     C                     Z-ADDZCRSRT    SPXR
      *
     C           @FORM     IFEQ 'DPTMVDF'                  *B2
     C                     EXCPTDPTMDU
     C                     ELSE                            *X2
     C                     EXCPTDPTMTU
     C                     END                             *E2
      *
     C                     END                             *E1
      *
      **  RECORD COMES FROM TRADSD OR HSTTRD
     C           @FORM     IFEQ 'TRADSDF'                  *B1
     C           @FORM     OREQ 'HSTTRDF'
      *
      **  ACCESS CURRENCY FILE TO RETRIEVE DETAILS
     C***********TNMC      CHAINSDCURRL1             71                   CPM005
     C                     CALL 'AOCURRR0'                                CPM005
     C                     PARM *BLANKS   WWRTCD                          CPM005
     C                     PARM '*KEY   ' WWOPTN                          CPM005
     C                     PARM TNMC      WWKEYC  3                       CPM005
     C           SDCURR    PARM SDCURR    DSSDY                           CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C************IN71     IFEQ '1'                        *B2            CPM005
     C           WWRTCD    IFNE *BLANKS                                   CPM005
     C                     Z-ADD11        DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVELTNMC      DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
      *
      **  CONVERT SPOT RATE FROM NOMINAL CCY TO NEW CCY
     C                     Z-ADD1         ZAMTF
     C                     MOVELTNMC      ZCCYF
     C                     Z-ADDA6SPRT    ZRATEF
     C                     MOVELA6MDIN    ZMDINF
     C                     Z-ADDA6NBDP    ZCDPF
      *
     C                     MOVELFMNBCY    ZCCYT
     C                     Z-ADDW2SPRT    ZRATET
     C                     MOVELW2MDIN    ZMDINT
     C                     Z-ADDW2NBDP    ZCDPT
     C*                                                                   158524
     C           TNMC      IFEQ BKEURO                     B2             158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C           FMNBCY    OREQ BKEURO                                    158524
     C           A6INCY    ANDEQ'Y'                                       158524
     C           A6INCY    OREQ 'Y'                                       158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'FROM' details for Nominal Currency       158524
     C           TNMC      IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINF                          158524
     C                     Z-ADD1         ZRATEF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDA6EUER    ZRATEF                          158524
     C                     MOVE A6EUMD    ZMDINF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'TO' details for Portfolio Currency       158524
     C           FMNBCY    IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINT                          158524
     C                     Z-ADD1         ZRATET                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDW2EUER    ZRATET                          158524
     C                     MOVE W2EUMD    ZMDINT                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C                     END                             E2             158524
     C*                                                                   158524
     C                     EXSR ZCCYCN
      *
     C           @FORM     IFEQ 'TRADSDF'                  *B2
      *
     C                     Z-ADD*ZEROS    WTDER  138
     C           TMDI      IFEQ 'D'                        *B3
     C           1         DIV  TDER      WTDER
     C           ZCRSRT    DIV  WTDER     SPXR
     C                     MOVEL'M'       SPMD
     C                     ELSE                            *X3
     C           ZCRSRT    DIV  TDER      SPXR
     C                     MOVEL'M'       SPMD
     C                     END                             *E3
      *
     C                     EXCPTTRADSU
     C                     ELSE                            *X2
      *
     C           SPMD      IFEQ 'D'                        *B3
     C           1         DIV  TDER      WTDER
     C           ZCRSRT    DIV  WTDER     SPXR
     C                     MOVEL'M'       SPMD
     C                     ELSE                            *X3
     C           ZCRSRT    DIV  TDER      SPXR
     C                     MOVEL'M'       SPMD
     C                     END                             *E3
      *
     C                     EXCPTHSTTRU
     C                     END                             *E2
      *
     C                     END                             *E1
      *
     C***********KEY3      READEPORTMT                   73               CPM005
     C           KEY3      READEPMTRMVL0                 73               CPM005
      *
     C                     ENDDO                           *EW1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #ACTI    - RESET ALL ACTIONS                                     *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #ACTI     BEGSR
      *
     C***********KEY3      SETLLCAPRHP                                    CPM005
     C***********KEY3      READECAPRHP                   73               CPM005
     C           KEY3      SETLLPMCAPRL5                                  CPM005
     C           KEY3      READEPMCAPRL5                 73               CPM005
      *
     C           *IN73     DOWEQ*OFF                       *BW1
      *
     C           PMTI      IFEQ 'H'                        *B1
      *
      **  ACCESS SECURITY TO RETRIEVE NOMINAL CCY
     C           CSSC      CHAINSECTY                71
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C           *IN71     IFEQ '1'                        *B2
     C                     Z-ADD12        DBASE            ***************
     C                     MOVEL'SECTY'   DBFILE           * DB ERROR 12 *
     C                     MOVELCSSC      DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
      *
      **  ACCESS CURRENCY FILE TO RETRIEVE DETAILS
     C***********NMCY      CHAINSDCURRL1             71                   CPM005
     C                     CALL 'AOCURRR0'                                CPM005
     C                     PARM *BLANKS   WWRTCD                          CPM005
     C                     PARM '*KEY   ' WWOPTN                          CPM005
     C                     PARM NMCY      WWKEYC  3                       CPM005
     C           SDCURR    PARM SDCURR    DSSDY                           CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C************IN71     IFEQ '1'                        *B2            CPM005
     C           WWRTCD    IFNE *BLANKS                                   CPM005
     C                     Z-ADD13        DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVELNMCY      DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
      *
      **  CONVERT SPOT RATE FROM NOMINAL CCY TO NEW CCY
     C                     Z-ADDCSTB      ZAMTF
     C                     MOVELNMCY      ZCCYF
     C                     Z-ADDA6SPRT    ZRATEF
     C                     MOVELA6MDIN    ZMDINF
     C                     Z-ADDA6NBDP    ZCDPF
      *
     C                     MOVELFMNBCY    ZCCYT
     C                     Z-ADDW2SPRT    ZRATET
     C                     MOVELW2MDIN    ZMDINT
     C                     Z-ADDW2NBDP    ZCDPT
     C*                                                                   158524
     C           NMCY      IFEQ BKEURO                     B2             158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C           FMNBCY    OREQ BKEURO                                    158524
     C           A6INCY    ANDEQ'Y'                                       158524
     C           A6INCY    OREQ 'Y'                                       158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'FROM' details for Nominal Currency       158524
     C           NMCY      IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINF                          158524
     C                     Z-ADD1         ZRATEF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDA6EUER    ZRATEF                          158524
     C                     MOVE A6EUMD    ZMDINF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'TO' details for Portfolio Currency       158524
     C           FMNBCY    IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINT                          158524
     C                     Z-ADD1         ZRATET                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDW2EUER    ZRATET                          158524
     C                     MOVE W2EUMD    ZMDINT                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C                     END                             E2             158524
     C*                                                                   158524
     C                     EXSR ZCCYCN
      *
     C                     Z-ADDZAMTT     CFAP
      *
     C                     END                             *E1
      *
     C           PMVI      IFEQ 'H'                        *B1
      *
      **  ACCESS SECURITY TO RETRIEVE NOMINAL CCY
     C           CSSC      CHAINSECTY                71
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C           *IN71     IFEQ '1'                        *B2
     C                     Z-ADD14        DBASE            ***************
     C                     MOVEL'SECTY'   DBFILE           * DB ERROR 14 *
     C                     MOVELCSSC      DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
      *
      **  ACCESS CURRENCY FILE TO RETRIEVE DETAILS
     C***********NMCY      CHAINSDCURRL1             71                   CPM005
     C                     CALL 'AOCURRR0'                                CPM005
     C                     PARM *BLANKS   WWRTCD                          CPM005
     C                     PARM '*KEY   ' WWOPTN                          CPM005
     C                     PARM NMCY      WWKEYC  3                       CPM005
     C           SDCURR    PARM SDCURR    DSSDY                           CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C************IN71     IFEQ '1'                        *B2            CPM005
     C           WWRTCD    IFNE *BLANKS                                   CPM005
     C                     Z-ADD15        DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVELNMCY      DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
      *
      **  CONVERT SPOT RATE FROM NOMINAL CCY TO NEW CCY
     C                     Z-ADDCSVB      ZAMTF
     C                     MOVELNMCY      ZCCYF
     C                     Z-ADDA6SPRT    ZRATEF
     C                     MOVELA6MDIN    ZMDINF
     C                     Z-ADDA6NBDP    ZCDPF
      *
     C                     MOVELFMNBCY    ZCCYT
     C                     Z-ADDW2SPRT    ZRATET
     C                     MOVELW2MDIN    ZMDINT
     C                     Z-ADDW2NBDP    ZCDPT
     C*                                                                   158524
     C           NMCY      IFEQ BKEURO                     B2             158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C           FMNBCY    OREQ BKEURO                                    158524
     C           A6INCY    ANDEQ'Y'                                       158524
     C           A6INCY    OREQ 'Y'                                       158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'FROM' details for Nominal Currency       158524
     C           NMCY      IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINF                          158524
     C                     Z-ADD1         ZRATEF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDA6EUER    ZRATEF                          158524
     C                     MOVE A6EUMD    ZMDINF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'TO' details for Portfolio Currency       158524
     C           FMNBCY    IFEQ BKEURO                     B3             158524
     C                     MOVE 'M'       ZMDINT                          158524
     C                     Z-ADD1         ZRATET                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     ELSE                            X3             158524
     C                     Z-ADDW2EUER    ZRATET                          158524
     C                     MOVE W2EUMD    ZMDINT                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     END                             E3             158524
     C*                                                                   158524
     C                     END                             E2             158524
     C*                                                                   158524
     C                     EXSR ZCCYCN
      *
     C                     Z-ADDZAMTT     CFAP
      *
     C                     END                             *E1
      *
     C           PMTI      IFEQ 'H'                        *B1
     C           PMVI      OREQ 'H'
      *
     C                     Z-ADDZCRSRT    CAVR
     C                     Z-ADDZCRSRT    CFXR
      *
     C                     END                             *E1
      *
     C                     EXCPTCAPRHU
      *
     C***********KEY3      READECAPRHP                   73               CPM005
     C           KEY3      READEPMCAPRL5                 73               CPM005
      *
     C                     ENDDO                           *EW1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #CHGBC   - CHANGE CUSTOMER BASE CURRENCY                         *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #CHGBC    BEGSR
      *
      **  ACCESS PM CUSTOMER DETAILS
     C                     MOVE FMCUST    KCUST   6
     C***********KCUST     CHAINSDPLCSLL             71                   CPM005
     C           KCUST     CHAINSDPLCSL1             71                   CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C           *IN71     IFEQ '1'                        *B1
     C                     Z-ADD3         DBASE            ***************
     C***********          MOVEL'SDPLCSLL'DBFILE           * DB ERROR 03 *CPM005
     C                     MOVEL'SDPLCSL1'DBFILE           * DB ERROR 03 *CPM005
     C                     MOVELFMCUST    DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E1
      *
     C                     MOVE FMNBCY    QBCSBY
     C                     Z-ADDA6NBDP    QBBYDP
     C***********          UPDATSDPLCSP0                                  CPM005
     C                     UPDAT@PLCSL1                                   CPM005
      *
     C**********           Z-ADDFMCUST    KCNUM                                               CSD027
     C                     MOVE FMCUST    KCNUM                                               CSD027
     C                     MOVE '9997'    KPTFR
      *
      **  ACCESS CONSOLIDATED PORTFOLIO DETAILS FILE
     C           KEY1      CHAINPMCNSDLL             71
      *
      **  IF RECORD FOUND
     C           *IN71     IFEQ '0'                        *B1
     C           XPNPSD    IFLE WWECD
     C                     Z-ADDWWECD     XPNPSD
     C                     END
     C                     MOVE FMNBCY    XPNPTC
     C                     Z-ADDA6NBDP    XPNPCD
     C                     UPDATPMCNSDD0
     C                     END                             *E1
      *
     C                     MOVE '9998'    KPTFR
      *
      **  ACCESS CONSOLIDATED PORTFOLIO DETAILS FILE
     C           KEY1      CHAINPMCNSDLL             71
      *
      **  IF RECORD FOUND
     C           *IN71     IFEQ '0'                        *B1
     C           XPNPSD    IFLE WWECD
     C                     Z-ADDWWECD     XPNPSD
     C                     END
     C                     MOVE FMNBCY    XPNPTC
     C                     Z-ADDA6NBDP    XPNPCD
     C                     UPDATPMCNSDD0
     C                     END                             *E1
      *
     C                     MOVE '9999'    KPTFR
      *
      **  ACCESS CONSOLIDATED PORTFOLIO DETAILS FILE
     C           KEY1      CHAINPMCNSDLL             71
      *
      **  IF RECORD FOUND
     C           *IN71     IFEQ '0'                        *B1
     C           XPNPSD    IFLE WWECD
     C                     Z-ADDWWECD     XPNPSD
     C                     END
     C                     MOVE FMNBCY    XPNPTC
     C                     Z-ADDA6NBDP    XPNPCD
     C                     UPDATPMCNSDD0
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #CHGPC   - CHANGE PORTFOLIO BASE CURRENCY                        *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #CHGPC    BEGSR
      *
      **  ACCESS PM CUSTOMER DETAILS
     C**********           Z-ADDFMCUST    KCNUM                                               CSD027
     C                     MOVE FMCUST    KCNUM                                               CSD027
     C                     MOVE FMPTFR    KPTFR
     C***********KEY1      CHAINPMPORTPP             71                   CPM005
     C           KEY1      CHAINPMPORTPD             71                   CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C           *IN71     IFEQ '1'                        *B1
     C                     Z-ADD4         DBASE            ***************
     C***********          MOVEL'PMPORTPP'DBFILE           * DB ERROR 04 *CPM005
     C                     MOVEL'PMPORTPD'DBFILE           * DB ERROR 04 *CPM005
     C                     MOVELWKEY1     DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E1
      *
     C           PNPSDT    IFLE WWECD
     C                     Z-ADDWWECD     PNPSDT
     C                     END
     C                     MOVE FMNBCY    PNPTCY
     C                     Z-ADDA6NBDP    PNPCDP
     C                     UPDATPMPORTP0
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #PORTF   - PORTFOLIO POSITIONS PROCESSING                        *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #PORTF    BEGSR
      *
     C**********           Z-ADDFMCUST    KCNUM                                               CSD027
     C                     MOVE FMCUST    KCNUM                                               CSD027
      *
      ****IF*PORTFOLIO*REFERENCE*FROM*PF/PMPCBCPP*IS*EQUAL*TO*BLANKS******CPM005
      **  IF PORTFOLIO REFERENCE FROM PF/PMPCBCPD IS EQUAL TO BLANKS      CPM005
     C           FMPTFR    IFEQ *BLANKS                    *B1
     C                     MOVE '9997'    KPTFR
     C                     ELSE                            *X1
     C                     MOVE FMPTFR    KPTFR
     C                     END                             *E1
      *
     C           KEY1      SETLLPMCPOSLL
     C           KEY1      READEPMCPOSLL                 71
      *
     C           *IN71     DOWEQ'0'
      *
      **  IF TRADE DATE RECORD READ OUTPUT CHANGE TO TRADE DATE PRICE
     C           QATVDA    IFEQ 'T'                        *B2
     C                     MOVE 'XT'      CSOA
     C                     MOVE 'H'       PMTI
     C                     MOVE '*'       PMVI
      *
      **  WRITE A RECORD ON PF/CAPRHD
     C                     EXSR #WRITE
     C                     END                             *E2
      *
      **  IF TRADE DATE RECORD READ OUTPUT CHANGE TO TRADE DATE PRICE
     C           QATVDA    IFEQ 'V'                        *B2
     C                     MOVE 'XV'      CSOA
     C                     MOVE '*'       PMTI
     C                     MOVE 'H'       PMVI
      *
      **  WRITE A RECORD ON PF/CAPRHD
     C                     EXSR #WRITE
     C                     END                             *E2
      *
     C           KEY1      READEPMCPOSLL                 71
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #WRITE   - WRITE A RECORD ON PF/CAPRHD                           *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #PORTF   -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #WRITE    BEGSR
      *
     C                     MOVE 'H'       RECI             Record Id
     C**********           Z-ADDFMCUST    CSCN             Customer                           CSD027
     C                     MOVE FMCUST    CSCN             Customer                           CSD027
     C***********          Z-ADD*ZEROS    CSBR             Branch         CPM005
     C                     MOVEL*BLANKS   CSBA             Branch         CPM005
     C                     MOVE QATDSS    CSSC             Security
     C                     Z-ADDBJRDNB    CSDA             Date
     C                     MOVE '5'       CSSE             Sort Sequence
     C*
     C                     Z-ADD*ZEROS    CSTB             Charge to Av. Price
     C                     Z-ADD*ZEROS    CSVB             Charge to Av. Price
     C                     Z-ADD*ZEROS    CSAP             Average Price
     C                     Z-ADD*ZEROS    CSCP             Cust. Contract Price
     C                     Z-ADD*ZEROS    CSNL             Nominal
     C                     MOVE *BLANKS   CSRF             Reference
     C                     Z-ADDWWECD     CSGD             Date Generated
     C*
     C                     MOVE QAPTFR    PTFR             Portfolio Reference
     C                     MOVE *BLANKS   ACIN             Accrued Indicator
     C                     Z-ADD*ZEROS    ITRA             Interest Amount
     C                     Z-ADD*ZEROS    CFAP             Change to FX AP Num.
      *
      **  ACCESS CURRENCY DETAILS FILE TO RETRIEVE NOMINAL CURRENCY DETAILS
     C***********QATNMC    CHAINSDCURRL1             71                   CPM005
     C                     CALL 'AOCURRR0'                                CPM005
     C                     PARM *BLANKS   WWRTCD                          CPM005
     C                     PARM '*KEY   ' WWOPTN                          CPM005
     C                     PARM QATNMC    WWKEYC  3                       CPM005
     C           SDCURR    PARM SDCURR    DSSDY                           CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C************IN71     IFEQ '1'                        *B2            CPM005
     C           WWRTCD    IFNE *BLANKS                                   CPM005
     C                     Z-ADD5         DBASE            ***************
     C***********          MOVEL'SDCURRL1'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 02 *CPM005
     C                     MOVELQATNMC    DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E2
     C*
     C                     Z-ADD1         ZAMTF
     C                     MOVELQATNMC    ZCCYF
     C                     MOVELFMNBCY    ZCCYT
     C                     Z-ADDA6SPRT    ZRATEF
     C                     Z-ADDW2SPRT    ZRATET
     C                     MOVELA6MDIN    ZMDINF
     C                     MOVELW2MDIN    ZMDINT
     C                     Z-ADDA6NBDP    ZCDPF
     C                     Z-ADDW2NBDP    ZCDPT
     C*                                                                   158524
     C           QATNMC    IFEQ BKEURO                     B1             158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C           FMNBCY    OREQ BKEURO                                    158524
     C           A6INCY    ANDEQ'Y'                                       158524
     C           A6INCY    OREQ 'Y'                                       158524
     C           W2INCY    ANDEQ'Y'                                       158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'FROM' details for Nominal Currency       158524
     C           QATNMC    IFEQ BKEURO                     B2             158524
     C                     MOVE 'M'       ZMDINF                          158524
     C                     Z-ADD1         ZRATEF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     ELSE                            X2             158524
     C                     Z-ADDA6EUER    ZRATEF                          158524
     C                     MOVE A6EUMD    ZMDINF                          158524
     C                     Z-ADDA6NBDP    ZCDPF                           158524
     C                     END                             E2             158524
     C*                                                                   158524
     C**  Set up SR/ZCCYCN with 'TO' details for Portfolio Currency       158524
     C           FMNBCY    IFEQ BKEURO                     B2             158524
     C                     MOVE 'M'       ZMDINT                          158524
     C                     Z-ADD1         ZRATET                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     ELSE                            X2             158524
     C                     Z-ADDW2EUER    ZRATET                          158524
     C                     MOVE W2EUMD    ZMDINT                          158524
     C                     Z-ADDW2NBDP    ZCDPT                           158524
     C                     END                             E2             158524
     C*                                                                   158524
     C                     END                             E1             158524
     C*                                                                   158524
     C                     EXSR ZCCYCN
     C                     Z-ADDZCRSRT    CAVR             Average FX Rate
     C*
     C                     Z-ADD*ZEROS    CFXR             Customer FX Rate
     C                     Z-ADD*ZEROS    CYLD             Customer Yield Rate
     C                     Z-ADDWWECD     OTHD             Other Date
      *
     C                     WRITECAPRHDF
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #MATUR   - SET RECORD ID IN 'MATURED' STATUS                     *
      *          - DELETE PORTFOLIO PROCESSING                           *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #MATUR    BEGSR
      *
     C**********           Z-ADDFMCUST    KCNUM2                                              CSD027
     C                     MOVE FMCUST    KCNUM2                                              CSD027
     C                     MOVE FMPTFR    KPTFR2
     C                     Z-ADDFMTNLU    KTNLU2
      *
     C           KEY2      CHAINPMPCBCL0             71
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C           *IN71     IFEQ '1'                        *B1
     C                     Z-ADD6         DBASE            ***************
     C                     MOVEL'PMPCBCL0'DBFILE           * DB ERROR 06 *
     C                     MOVELWKEY2     DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E1
      *
     C                     MOVE 'M'       FMRECI
     C                     UPDATPMPCBCDD
      *
      **  ACCESS PM CUSTOMER DETAILS
     C                     MOVE FMCUST    KCUST   6
     C***********KCUST     CHAINSDPLCSLL             71                   CPM005
     C           KCUST     CHAINSDPLCSL1             71                   CPM005
      *
      **  IF RECORD NOT FOUND, DB ERROR
     C           *IN71     IFEQ '1'                        *B1
     C                     Z-ADD7         DBASE            ***************
     C***********          MOVEL'SDPLCSLL'DBFILE           * DB ERROR 03 *CPM005
     C                     MOVEL'SDPLCSL1'DBFILE           * DB ERROR 03 *CPM005
     C                     MOVELFMCUST    DBKEY            ***************
     C                     EXSR *PSSR
     C                     END                             *E1
      *
     C                     MOVE 'Y'       WALLBC  1
      *
     C***********FMCUST    SETLLPMPORTPP                                  CPM005
     C***********FMCUST    READEPMPORTPP                 71               CPM005
     C           FMCUST    SETLLPMPORTPD                                  CPM005
     C           FMCUST    READEPMPORTPD                 71               CPM005
      *
      **  DO WHILE SAME CUSTOMER READ AND 'ALL PORTFOLIO IN BASE CCY' IS 'Y'
     C           *IN71     DOWEQ'0'                        *B1
     C           WALLBC    ANDEQ'Y'
      *
      **  IF CUSTOMER BASE CURRENCY IS NOT EQUAL TO PORTFOLIO CURRENCY
     C           QBCSBY    IFNE PNPTCY                     *B2
     C                     MOVE 'N'       WALLBC
     C                     END                             *E2
      *
     C***********FMCUST    READEPMPORTPP                 71               CPM005
     C           FMCUST    READEPMPORTPD                 71               CPM005
     C                     END                             *E1
      *
      **  MOVE WORKFIELD IN "ALL PORTFOLIOS IN BASE CURRENCY" FIELD
     C                     MOVE WALLBC    QBAPBC
     C***********          UPDATSDPLCSP0                                  CPM005
     C                     UPDAT@PLCSL1                                   CPM005
      *
      ****IF*PORTFOLIO*REFERENCE*FROM*PF/PMPCBCPP*IS*EQUAL*TO*BLANKS******CPM005
      **  IF PORTFOLIO REFERENCE FROM PF/PMPCBCPD IS EQUAL TO BLANKS      CPM005
     C           FMPTFR    IFEQ *BLANKS                    *B1
     C                     MOVE '9997'    KPTFR
     C                     EXSR #DELET
      *
     C                     MOVE '9998'    KPTFR
     C                     EXSR #DELET
      *
     C                     MOVE '9999'    KPTFR
     C                     EXSR #DELET
      *
     C                     ELSE                            *X1
     C                     MOVE FMPTFR    KPTFR
     C                     EXSR #DELET
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #DELET   - DELETE RECORD IN 'MATURED' STATUS                     *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #MATUR   -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #DELET    BEGSR
      *
      ** DELETE RECORD FROM "PERFORMANCE START OF MONTH POSITION" FILE
     C***********KEY1      SETLLPMPSTMPP                                  CPM005
     C***********KEY1      READEPMPSTMPP                 71               CPM005
     C           KEY1      SETLLPMPSTMQ0                                  CPM005
     C           KEY1      READEPMPSTMQ0                 71               CPM005
      *
     C           *IN71     DOWEQ'0'                        *B1
     C                     DELETPMPSTMP0
     C***********KEY1      READEPMPSTMPP                 71               CPM005
     C           KEY1      READEPMPSTMQ0                 71               CPM005
     C                     END                             *E1
      *
      ** DELETE RECORD FROM "PERFORMANCE TRANSACTION ANALYSIS" FILE
     C           KEY1      SETLLPMPTRALL
     C           KEY1      READEPMPTRALL                 71
      *
     C           *IN71     DOWEQ'0'                        *B1
     C                     DELETPMPTRAP0
     C           KEY1      READEPMPTRALL                 71
     C                     END                             *E1
      *
      ** DELETE RECORD FROM "PERFORMANCE CASH ANALYSIS" FILE
     C           KEY1      SETLLPMPCAAL7
     C           KEY1      READEPMPCAAL7                 71
      *
     C           *IN71     DOWEQ'0'                        *B1
     C                     DELETPMPCAAP0
     C           KEY1      READEPMPCAAL7                 71
     C                     END                             *E1
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * #TERM    - TERMINATION PROCESSING                                *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * MAIN     -                                                       *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           #TERM     BEGSR
      *
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      *                                                                  *
      * *PSSR    - ERROR IN FILE                                         *
      *                                                                  *
      * SUBROUTINE CALLS:                                                *
      *                                                                  *
      * SUBROUTINE CALLED FROM:                                          *
      * #INIT    - INITIAL PROCESSING                                    *
      *                                                                  *
      * ROUTINE USES VARIABLES:                                          *
      *                                                                  *
      ********************************************************************
     C           *PSSR     BEGSR
      *
     C                     DUMP                                           160446
     C           *LOCK     IN   LDA
     C                     OUT  LDA
      *
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C***********          DUMP                                    160446
      *
     C                     RETRN
      *
     C                     ENDSR
     C**=================================================================
      /EJECT
      /COPY ZSRSRC,ZCCYCN
      /EJECT
      /COPY ZSRSRC,ZCCYXR
      /EJECT
     O*
     O** CUSTOMER AVERAGE PRICE ACTIONS
     OPMAPOSD0E                PMAPOU
     O                         QARECI
     O                         QAFXAP
     O                         QAPTCY
     O                         QAPCDP
     O                         QACSBY
     O                         QABYDP
     O**
     O** CUSTOMER AVERAGE PRICE ACTIONS
     OCAPRHD0 E                CAPRHU
     O                         CFAP
     O                         CAVR
     O                         CFXR
     O*
     O** DEPOT MOVEMENT DETAILS
     ODPTMVDF E                DPTMDU
     O                         SPXR
     O*
     ODPTMVTF E                DPTMTU
     O                         SPXR
     O*
     O** TRADE DETAILS
     OTRADSDF E                TRADSU
     O                         SPXR
     O                         SPMD
     O*
     OHSTTRDF E                HSTTRU
     O                         SPXR
     O                         SPMD
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  CPY@
(c) Finastra International Limited 2001
