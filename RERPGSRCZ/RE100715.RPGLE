     H DEBUG
      *****************************************************************
/*STD *  RPGBASEMOD                                                   *
/*EXI *  TEXT('Midas RE Generate Group A/c Contra Entries')           *
      *****************************************************************
      *                                                               *
      *  Midas - Retail Module                                        *
      *                                                               *
      *  RE100715 - Generate Group A/c Contra Entries                 *
      *                                                               *
      *  Function:  This program generates contra entries for entries *
      *             previously generated by cash management.          *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2002            *
      *                                                               *
      *  Last Amend No. AR676213           Date 19Nov10               *
      *  Prev Amend No. CER059             Date 19Jul10               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CGL029             Date 01Sep03               *
      *                 217357             Date 01May03               *
      *                 216668             Date 24Apr03               *
      *                 214360             Date 03Feb03               *
      *                 CRE008  *CREATE    Date 19Feb02               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  AR676213 - Incorrect definition of CLGLAI field (Recompile)  *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  217357 - Deleted hierarchies and links cause db errors       *
      *  216668 - Contra entries are booked to the wrong branch       *
      *  214360 - Cash Management Deferred Posting                    *
      *  CRE008 - Cash Management                                     *
      *                                                               *
      *****************************************************************
 
     FGECXL2    UP   E           K DISK    INFSR(*PSSR)
     F                                     RENAME(APOSTPDF:GECXF)
     FGLAPSGAL0 IF   E           K DISK    INFSR(*PSSR)
     F*REGAHLJ1*IF***E***********K*DISK****INFSR(*PSSR)                  216668 217357
     F*************************************PREFIX(T_)                    216668 217357
     FRE100715P1O    E             PRINTER INFSR(*PSSR)
     F                                     INFDS(SPOOL1)
     FGLTCMEPD  O    E             DISK    INFSR(*PSSR)
     F                                     RENAME(APOSTPDF:GLTCMEF)
     F                                     PREFIX(E_)
 
      *****************************************************************
      * Standard D Specifications
     D/COPY ZACPYSRC,RECMSTDD
      * Program Status Data Structure
     D/COPY ZACPYSRC,PSDS
      *****************************************************************
 
 
      * Cash Management Hierarchy Details
     D O_CMHD        E DS                  EXTNAME(RECMHDPD)
      * Zero Balancing/Sweeping Hierarchy Details
     D O_ZSHD        E DS                  EXTNAME(REZSHDPD)
      * Group Account Hierarchy Details
     D O_GAHD        E DS                  EXTNAME(REGAHDPD)
 
 
      * Cash Management Hierarchy Links
     D O_CMHL        E DS                  EXTNAME(RECMHLPD)
     D A_HIER                  1      9
     D A_LINK                 10     18
      * Zero Balancing/Sweeping Hierarchy Links
     D O_ZSHL        E DS                  EXTNAME(REZSHLPD)
      * Group Account Hierarchy Links
     D O_GAHL        E DS                  EXTNAME(REGAHLPD)
 
 
      * Cash Management Generated Entries
     D GECX          E DS                  EXTNAME(GECXPD)
     D  XZZ019       E                     EXTFLD(ZZ019)
     D A_XRFI                317    319
     D A_XRFN                320    329
      * Temporary Cash Management Generated Entries
     D GLTCME        E DS                  EXTNAME(GLTCMEPD)
     D                                     PREFIX(E_)
 
 
      ** Branch, Currency & Profit Centre Totals
     D #_BCP           S             16    DIM(1000)
     D #_BCPCTOT       S             17S 0 DIM(1000)
 
 
      ** Branch, Currency & Profit Centre
     D                 DS
     D BRCYPC                  1     16
     D #BRCA                   1      3
     D #BICN                   4      9
     D #CCY                   10     12
     D #PRFC                  13     16
 
 
      ** (INTER-BRANCH) Branch, Currency, A/c Code & Profit Centre Totals       216668
     D*#_BCAP***       S             20    DIM(1000)                                   216668 CGL029
     D #_BCAP          S             26    DIM(1000)                                          CGL029
     D #_BCAPCTOT      S             17S 0 DIM(1000)                            216668
                                                                                216668
                                                                                216668
      ** (INTER-BRANCH) Branch, Currency, A/c code & Profit Centre              216668
     D                 DS                                                       216668
     D*BRCYAPC**               1     20                                                216668 CGL029
     D BRCYAPC                 1     26                                                       CGL029
     D #IBRCA                  1      3                                         216668
     D #IBICN                  4      9                                         216668
     D #ICCY                  10     12                                         216668
     D*#IACOD***              13     16                                                216668 CGL029
     D*#IPRFC***              17     20                                                216668 CGL029
     D #IACOD                 13     22                                                       CGL029
     D #IPRFC                 23     26                                                       CGL029
                                                                                216668
                                                                                216668
     D SDBANK        E DS                  EXTNAME(SDBANKPD)
      ** External DS for BANK details
     D SDCMAN        E DS                  EXTNAME(SDCMANPD)
      ** External DS for cash management details
     D SDBRCH        E DS                  EXTNAME(SDBRCHPD)
     D S_SDBRCH      E DS                  EXTNAME(SDBRCHPD)                    216668
     D                                     PREFIX(S_)                           216668
      ** Branch Details
     D SDCURR        E DS                  EXTNAME(SDCURRPD)
      ** Currency Details
     D SDACOD        E DS                  EXTNAME(SDACODPD)
      ** A/C Code Details
     D DSFDY         E DS                  EXTNAME(DSFDY)
      ** First DS for access programs
     D DSSDY         E DS                  EXTNAME(DSSDY)
      ** Second DS for access programs
 
 
      ** File Information Data Structure for RE100715P1
     D SPOOL1          DS
     D  PSFile1               83     92
     D  PSFNum1              123    124B 0
 
 
      ** Parameters for ZSFILE
     D PSeq            S              5
     D PLevel          S              1
     D PEnty           S              3
     D ZSnum           S              6  0
     D ZSerr           S              1
 
 
     IGECXF         01
     I                                          OTTP          L5
     I                                          OTST          L4
     I                                          BRCA          L3
     I                                          CCY           L2
     I                                          PRFC          L1
     I                                          CNUM          L1
     I                                          ACOD          L1
     I                                          ACSQ          L1
 
      * On change of original transaction type
      * (it contains a hierarchy ID)
      *     Access Hierarchy Detail
      *     Access a/c code for contra entries
 
     C   L5              MOVEL     OTTP          CLHIER
     C   L5              EXSR      ACS_HIER
 
      * On change of original transaction sub type
      * (it contains a link ID)
      *     Access Hierarchy Link
 
     C   L4              MOVEL     OTST          CLLINK
     C   L4              EXSR      ACS_LINK
 
      * On change of link ID
      *   Report source a/c
 
     C   L4              EXSR      REP_SACCNT
 
      * On change of branch
      *   Access branch
 
     C   L3              EXSR      ACS_BRCH
 
      * On change of currency
      *   Access currency
 
     C   L2              EXSR      ACS_CURR
 
      * Access extension record
 
     C     GLAPSGAK      CHAIN     GLAPGAD0                           60        *
     C     *IN60         IFEQ      '1'
     C                   EVAL      X_ERMS = 'NO EXTENSION FOR ENTRY:'
     C                                       + A_XRFI + A_XRFN
     C                   EXSR      *PSSR
     C                   ENDIF
                                                                                216668
      * Access source branch                                                    216668
                                                                                216668
     C                   EXSR      ACS_SBRCH                                    216668
 
      * Reset GECXPD fields
 
     C                   MOVE      'P'           RECI
     C                   BITOFF    '01234567'    PRIN
     C                   MOVEL     *BLANK        OTRF
 
      * Report entry
      * ------------
 
     C                   EXSR      REP_ENTRY
 
      * Update record ID and original transaction reference on entry
 
     C                   EXCEPT    UGECXF
                                                                                216668
      * Determine if a/c replicated to is a top a/c                             216668
                                                                                216668
     C*****ACCNTK********CHAIN*****REGAHLJ1***************************99*216668 217357
     C     STYP          COMP      'T'                                9999      217357
     C   99              MOVEL     'N'           Top_Ac            1            216668
     C  N99              MOVEL     'Y'           Top_Ac                         216668
                                                                                216668
      * Set up contra entry branch, customer, currency, profit centre           216668
      * Entries to top a/cs book to the replication contra in the source a/c    216668
      * branch. Interbranch entries may then be required between the            216668
      * source a/c branch and the top a/c branch.                               216668
                                                                                216668
     C     Top_Ac        IFEQ      'Y'                                          216668
     C                   MOVEL     AGSBRC        #BRCA                          216668
     C                   MOVEL     S_A8BICN      #BICN                          216668
     C                   ELSE                                                   216668
     C                   MOVEL     BRCA          #BRCA                          216668
     C                   MOVEL     A8BICN        #BICN                          216668
     C                   ENDIF                                                  216668
     C                   MOVEL     CCY           #CCY                           216668
     C                   MOVEL     PRFC          #PRFC                          216668
 
      * If 'level for contra entries' on ICD is 'N' (NO SUMMARY)
      *     Write contra entry
      * Else
      *     Accumulate posting total (by branch, currency and profit centre)
 
     C     CMLVCE        IFEQ      'N'
     C                   EXSR      WRT_CON
     C                   ELSE
     C                   EXSR      LOOKUP_BCP
     C     DRCR          IFEQ      0
     C                   ADD       PSTA          #_BCPCTOT(#B)
     C                   ELSE
     C                   SUB       PSTA          #_BCPCTOT(#B)
     C                   ENDIF
     C                   ENDIF
                                                                                216668
      * If the booking to the replication contra is to a branch                 216668
      * different from the account branch                                       216668
      *    Accummulate interbranch entries                                      216668
                                                                                216668
     C     Top_Ac        IFEQ      'Y'                                          216668
     C     AGSBRC        ANDNE     BRCA                                         216668
      * Source a/c branch                                                       216668
     C                   MOVEL     AGSBRC        #IBRCA                         216668
     C                   MOVEL     A8BICN        #IBICN                         216668
     C                   MOVEL     CCY           #ICCY                          216668
     C     DRCR          IFEQ      0                                            216668
     C                   MOVEL     A8DFAC        #IACOD                         216668
     C                   ELSE                                                   216668
     C                   MOVEL     A8DTAC        #IACOD                         216668
     C                   ENDIF                                                  216668
     C                   MOVEL     PRFC          #IPRFC                         216668
     C                   EXSR      LOOKUP_BCAP                                  216668
     C     DRCR          IFEQ      0                                            216668
     C                   ADD       PSTA          #_BCAPCTOT(#B)                 216668
     C                   ELSE                                                   216668
     C                   SUB       PSTA          #_BCAPCTOT(#B)                 216668
     C                   ENDIF                                                  216668
      * Top a/c branch                                                          216668
     C                   MOVEL     BRCA          #IBRCA                         216668
     C                   MOVEL     S_A8BICN      #IBICN                         216668
     C     DRCR          IFEQ      1                                            216668
     C                   MOVEL     A8DFAC        #IACOD                         216668
     C                   ELSE                                                   216668
     C                   MOVEL     A8DTAC        #IACOD                         216668
     C                   ENDIF                                                  216668
     C                   EXSR      LOOKUP_BCAP                                  216668
     C     DRCR          IFEQ      1                                            216668
     C                   ADD       PSTA          #_BCAPCTOT(#B)                 216668
     C                   ELSE                                                   216668
     C                   SUB       PSTA          #_BCAPCTOT(#B)                 216668
     C                   ENDIF                                                  216668
     C                   ENDIF                                                  216668
                                                                                216668
      *    Write inter-branch entries                                           216668
                                                                                216668
     CL5                 Z-ADD     1             #B                             216668
     CL5   #_BCAP(#B)    DOWNE     *BLANK                                       216668
     CL5                 EXSR      WRT_INTERB                                   216668
     CL5                 ADD       1             #B                             216668
     CL5                 ENDDO                                                  216668
     CL5                 MOVEL     *BLANK        #_BCAP                         216668
     CL5                 Z-ADD     *ZERO         #_BCAPCTOT                     216668
 
 
      * If 'level for contra entries' on ICD is 'H' (HIERARCHY)
      *    Write summarised contra entry
 
     CL5   CMLVCE        IFEQ      'H'
     CL5                 Z-ADD     1             #B
     CL5   #_BCP(#B)     DOWNE     *BLANK
     CL5                 EXSR      WRT_SCON
     CL5                 ADD       1             #B
     CL5                 ENDDO
     CL5                 MOVEL     *BLANK        #_BCP
     CL5                 Z-ADD     *ZERO         #_BCPCTOT
     CL5                 ENDIF
 
      * If 'level for contra entries' on ICD is NOT 'N' or 'H'
      * i.e. is 'S' (SYSTEM)
      *****Get*a/c*code*details*********************************************    216668
      *    Write summarised contra entry
 
     CLR   CMLVCE        IFNE      'N'
     CLR   CMLVCE        ANDNE     'H'
     CLR                 Z-ADD     1             #B
     CLR   #_BCP(#B)     DOWNE     *BLANK
     CLR                 EXSR      WRT_SCON
     CLR                 ADD       1             #B
     CLR                 ENDDO
     CLR                 ENDIF
 
      * End of Report
 
     CLR                 EXSR      END_OF_REP
      /SPACE 5
      ********************************************************************
      * Report source a/c
      ********************************************************************
     C     REP_SACCNT    BEGSR
 
     C                   Z-ADD     3             CHLINE            3 0
     C                   EXSR      PAG
     C                   WRITE     SOURCE
 
     C                   ENDSR
      *******************************************************************
      /SPACE 5
      ********************************************************************
      * Report entry
      ********************************************************************
     C     REP_ENTRY     BEGSR
 
      * Space
     C     *INL1         IFEQ      '1'
     C                   Z-ADD     1             CHLINE            3 0
     C                   EXSR      PAG
     C                   WRITE     SPACE
     C                   ENDIF
 
     C     ACNO          COMP      0                                  3636      *
 
      * Edit value date of entry
 
     C                   Z-ADD     VALD          ZDAYNO
     C                   EXSR      ZDATE2
     C                   MOVEL     ZADATE        R_VALD
 
      * Edit posting amount of entry
 
     C                   MOVE      *ZERO         ZFIELD
     C                   MOVE      PSTA          ZFIELD
     C                   EXSR      ZEDIT
     C                   MOVE      ZFIELD        R_PSTA
 
      * Edit posting dr/cr indicator
 
     C     DRCR          IFEQ      0
     C                   MOVEL     'DR'          R_DRCR
     C                   ELSE
     C                   MOVEL     'CR'          R_DRCR
     C                   ENDIF
 
      * Edit Reference Number
 
     C                   MOVE      XRFN          R_XRFN
 
     C                   Z-ADD     1             CHLINE            3 0
     C                   EXSR      PAG
     C                   WRITE     ENTRY
 
     C                   ENDSR
      *******************************************************************
     C/SPACE 5
      ********************************************************************
      * End of Report
      ********************************************************************
     C     END_OF_REP    BEGSR
 
      * Output count of errors and 'end of report'
 
     C                   Z-ADD     3             CHLINE
     C                   EXSR      PAG
     C                   WRITE     ENDOFREP
 
     C                   ENDSR
      *******************************************************************
      /SPACE 5
      ********************************************************************
      * Throw page headings (if required)
      ********************************************************************
     C     PAG           BEGSR
 
     C                   ADD       CHLINE        LINENO
     C     LINENO        IFGT      59
     C                   ADD       1             PAGNUM
     C                   WRITE     PAGEHEAD
     C     6             ADD       CHLINE        LINENO            3 0
     C                   ENDIF
 
     C                   ENDSR
     C********************************************************************
      /SPACE 5
      ********************************************************************
      * Write contra entry
      ********************************************************************
     C     WRT_CON       BEGSR
 
     C                   CLEAR                   GLTCME
      * Record ID
     C                   MOVEL     'P'           E_RECI
 
      * Customer, currency, a/c code and a/c seq.
     C*******************MOVEL     A8BICN        E_CNUM                         216668
     C*******************MOVEL     CCY           E_CCY                          216668
     C                   MOVEL     #BICN         E_CNUM                         216668
     C                   MOVEL     #CCY          E_CCY                          216668
     C                   MOVEL     CMACCE        E_ACOD
     C                   Z-ADD     01            E_ACSQ
      * Retail a/c no.
     C                   Z-ADD     *ZERO         E_ACNO
      * Posting Date
     C                   Z-ADD     BJRDNB        E_PSTD
      * Value Date
     C                   Z-ADD     BJRDNB        E_VALD
      * Transaction Type
     C                   Z-ADD     *ZERO         E_TRAT
      * Posting Narrative
     C                   EVAL      E_PNAR = PNAR
      * Posting Amount
     C                   Z-ADD     PSTA          E_PSTA
      * DR/CR indicator
     C     DRCR          IFEQ      0
     C                   Z-ADD     1             E_DRCR
     C                   ELSE
     C                   Z-ADD     0             E_DRCR
     C                   ENDIF
      * Source of Posting
     C                   MOVE      'GE-CX'       E_SPOS
      * Branch
     C*******************MOVEL     BRCA          E_BRCA                         216668
     C                   MOVEL     #BRCA         E_BRCA                         216668
 
      * Access a/c code details
     C                   MOVEL     E_ACOD        ACCD
     C                   EXSR      ACS_ACOD
      * Retail indicator
     C                   Z-ADD     0             E_RIND
      * A/c type
     C                   MOVEL     A5ACTY        E_ATYP
      * A/c type
     C                   BITOFF    '01234567'    E_PRIN
      * Profit centre
     C*******************MOVEL     PRFC          E_PRFC                         216668
     C                   MOVEL     #PRFC         E_PRFC                         216668
      * Account section
     C                   MOVEL     A5ACSC        E_ACSC
      * Ext.Fil Ref.ID
     C                   MOVEL     *BLANK        E_XRFI
      * Ext.Fil Ref.No.
     C                   Z-ADD     *ZERO         E_XRFN
 
     C                   WRITE     GLTCMEF
 
     C                   ENDSR
     C********************************************************************
      /SPACE 5
      ********************************************************************
      * Write summarised contra entry
      * (a/c code cannot be retail)
      ********************************************************************
     C     WRT_SCON      BEGSR
 
      * Branch, currency and profit centre
 
     C                   MOVEL     #_BCP(#B)     BRCYPC
 
     C                   CLEAR                   GLTCME
 
      * Record ID
     C                   MOVEL     'P'           E_RECI
 
      * Customer, currency, a/c code and a/c seq.
     C                   MOVEL     #BICN         E_CNUM
     C                   MOVEL     #CCY          E_CCY
     C                   MOVEL     CMACCE        E_ACOD
     C                   Z-ADD     01            E_ACSQ
      * Retail a/c no.
     C                   Z-ADD     *ZERO         E_ACNO
      * Posting Date
     C                   Z-ADD     BJRDNB        E_PSTD
      * Value Date
     C                   Z-ADD     BJRDNB        E_VALD
      * Transaction Type
     C                   Z-ADD     *ZERO         E_TRAT
      * Posting Narrative
     C     CMLVCE        IFEQ      'H'
     C                   EVAL      E_PNAR = 'NET FOR HIERARCHY ' + CDHISN
     C                   ELSE
     C                   EVAL      E_PNAR = 'NET'
     C                   ENDIF
      * Posting Amount
      * DR/CR indicator
     C     #_BCPCTOT(#B) IFLT      *ZERO
     C                   Z-SUB     #_BCPCTOT(#B) E_PSTA
     C                   Z-ADD     0             E_DRCR
     C                   ELSE
     C                   Z-ADD     #_BCPCTOT(#B) E_PSTA
     C                   Z-ADD     1             E_DRCR
     C                   ENDIF
      * Source of Posting
     C                   MOVE      'GE-CX'       E_SPOS
      * Branch
     C                   MOVEL     #BRCA         E_BRCA
 
      * Access a/c code details
     C                   MOVEL     E_ACOD        ACCD
     C                   EXSR      ACS_ACOD
      * Retail indicator
     C                   Z-ADD     0             E_RIND
      * A/c type
     C                   MOVEL     A5ACTY        E_ATYP
      * A/c type
     C                   BITOFF    '01234567'    E_PRIN
      * Profit centre
     C                   MOVEL     #PRFC         E_PRFC
      * Account section
     C                   MOVEL     A5ACSC        E_ACSC
      * Ext.Fil Ref.ID
     C                   MOVEL     *BLANK        E_XRFI
      * Ext.Fil Ref.No.
     C                   Z-ADD     *ZERO         E_XRFN
 
     C     E_PSTA        IFNE      *ZERO
     C                   WRITE     GLTCMEF
     C                   ENDIF
 
     C                   ENDSR
      *******************************************************************
      /SPACE 5                                                                  216668
      ********************************************************************      216668
      * Write inter-branch entry                                                216668
      ********************************************************************      216668
     C     WRT_INTERB    BEGSR                                                  216668
                                                                                216668
      * Branch, currency, account code and profit centre                        216668
                                                                                216668
     C                   MOVEL     #_BCAP(#B)    BRCYAPC                        216668
                                                                                216668
     C                   CLEAR                   GLTCME                         216668
                                                                                216668
      * Record ID                                                               216668
     C                   MOVEL     'P'           E_RECI                         216668
                                                                                216668
      * Customer, currency, a/c code and a/c seq.                               216668
     C                   MOVEL     #IBICN        E_CNUM                         216668
     C                   MOVEL     #ICCY         E_CCY                          216668
     C                   MOVEL     #IACOD        E_ACOD                         216668
     C                   Z-ADD     01            E_ACSQ                         216668
      * Retail a/c no.                                                          216668
     C                   Z-ADD     *ZERO         E_ACNO                         216668
      * Posting Date                                                            216668
     C                   Z-ADD     BJRDNB        E_PSTD                         216668
      * Value Date                                                              216668
     C                   Z-ADD     BJRDNB        E_VALD                         216668
      * Transaction Type                                                        216668
     C                   Z-ADD     *ZERO         E_TRAT                         216668
      * Posting Narrative                                                       216668
     C                   EVAL      E_PNAR = 'NET FOR HIERARCHY ' + CDHISN       216668
      * Posting Amount                                                          216668
      * DR/CR indicator                                                         216668
     C     #_BCAPCTOT(#B)IFLT      *ZERO                                        216668
     C                   Z-SUB     #_BCAPCTOT(#B)E_PSTA                         216668
     C                   Z-ADD     1             E_DRCR                         216668
     C                   ELSE                                                   216668
     C                   Z-ADD     #_BCAPCTOT(#B)E_PSTA                         216668
     C                   Z-ADD     0             E_DRCR                         216668
     C                   ENDIF                                                  216668
      * Source of Posting                                                       216668
     C                   MOVE      'GE-CX'       E_SPOS                         216668
      * Branch                                                                  216668
     C                   MOVEL     #IBRCA        E_BRCA                         216668
                                                                                216668
      * Access a/c code details                                                 216668
     C                   MOVEL     E_ACOD        ACCD                           216668
     C                   EXSR      ACS_ACOD                                     216668
      * Retail indicator                                                        216668
     C     A5ACTY        IFEQ      'R'                                          216668
     C                   Z-ADD     1             E_RIND                         216668
     C                   ELSE                                                   216668
     C                   Z-ADD     0             E_RIND                         216668
     C                   ENDIF                                                  216668
      * A/c type                                                                216668
     C                   MOVEL     A5ACTY        E_ATYP                         216668
      * A/c type                                                                216668
     C                   BITOFF    '01234567'    E_PRIN                         216668
      * Profit centre                                                           216668
     C                   MOVEL     #IPRFC        E_PRFC                         216668
      * Account section                                                         216668
     C                   MOVEL     A5ACSC        E_ACSC                         216668
      * Ext.Fil Ref.ID                                                          216668
     C                   MOVEL     *BLANK        E_XRFI                         216668
      * Ext.Fil Ref.No.                                                         216668
     C                   Z-ADD     *ZERO         E_XRFN                         216668
                                                                                216668
     C     E_PSTA        IFNE      *ZERO                                        216668
     C                   WRITE     GLTCMEF                                      216668
     C                   ENDIF                                                  216668
                                                                                216668
     C                   ENDSR                                                  216668
      *******************************************************************       216668
      /SPACE 5
      ********************************************************************
      * Access Hierarchy Detail
      ********************************************************************
     C     ACS_HIER      BEGSR
 
     C                   CALLB     'RE100601'
      * Return code
      * Error Message
     C                   PARM      *BLANK        X_RTCD
     C                   PARM      *BLANK        X_ERMS
      * Option
     C                   PARM      '*ALL   '     X_OPTN            7
      * Hierarchy ID
     C                   PARM      CLHIER        I_HIER            9 0
      * Hierarchy Type
     C                   PARM      *BLANK        I_HTYP            2
 
     C                   PARM                    O_CMHD
     C                   PARM                    O_ZSHD
     C                   PARM                    O_GAHD
 
      * End if error occurred in module
      **or*if*no*record*found**********                                         217357
 
     C     X_RTCD        IFEQ      '*ERROR'
     C*****X_RTCD********OREQ******'*NOREC'                                     217357
     C                   EVAL      X_ERMS = 'BAD HIERARCHY DETAIL:' + A_HIER
     C                   EXSR      *PSSR
     C                   ENDIF
                                                                                217357
      * If no hierarchy present, use hierarchy id instead of name               217357
                                                                                217357
     C     X_RTCD        IFEQ      '*NOREC'                                     217357
     C                   MOVEL     *BLANK        CDHISN                         217357
     C                   MOVEL     CLHIER        CDHISN                         217357
     C                   ENDIF                                                  217357
 
     C                   ENDSR
      *******************************************************************
      /SPACE 5
      ********************************************************************
      * Access Hierarchy Link
      ********************************************************************
     C     ACS_LINK      BEGSR
 
     C                   CALLB     'RE100602'
      * Return code
      * Error Message
     C                   PARM      *BLANK        X_RTCD
     C                   PARM      *BLANK        X_ERMS
      * Option
     C                   PARM      '*ALL   '     X_OPTN            7
      * Hierarchy ID
     C                   PARM      CLHIER        I_HIER            9 0
      * Hierarchy Type
     C                   PARM      'GA'          I_HTYP            2            217357
     C*******************PARM      CDHTYP        I_HTYP            2            217357
      * Link ID
     C                   PARM      CLLINK        I_LINK            9 0
      * Child branch
      * Child customer
      * Child currency
      * Child a/c code
      * Child a/c seq.
     C                   PARM                    I_CBRC            3
     C**********         PARM                    I_CCUS            6 0                        CSD027
     C                   PARM                    I_CCUS            6                          CSD027
     C                   PARM                    I_CCCY            3
     C**********         PARM                    I_CACD            4 0                        CGL029
     C                   PARM                    I_CACD           10 0                        CGL029
     C                   PARM                    I_CASN            2 0
 
     C                   PARM                    O_CMHL
     C                   PARM                    O_ZSHL
     C                   PARM                    O_GAHL
 
      * End if error occurred in module
      **or*if*no*record*found**********                                         217357
 
     C     X_RTCD        IFEQ      '*ERROR'
     C*****X_RTCD********OREQ******'*NOREC'                                     217357
     C                   EVAL      X_ERMS = 'BAD HIERARCHY LINK:' +
     C                                       A_HIER + A_LINK
     C                   EXSR      *PSSR
     C                   ENDIF
 
     C                   ENDSR
      *******************************************************************
      /SPACE 5
      ********************************************************************
      * Access a branch
      ********************************************************************
     C     ACS_BRCH      BEGSR
 
     C                   CALLB     'ZAACSBRCH'
     C                   PARM                    BRCA
     C                   PARM                    SDBRCH
 
      * Database error if branch not found
 
     C     A8BRCD        IFEQ      *BLANK
     C                   EVAL      X_ERMS = 'BAD BRANCH CODE:' + BRCA
     C                   EXSR      *PSSR
     C                   ENDIF
 
     C                   ENDSR
      *********************************************************************
      /SPACE 5                                                                  216668
      ********************************************************************      216668
      * Access a source branch                                                  216668
      ********************************************************************      216668
     C     ACS_SBRCH     BEGSR                                                  216668
                                                                                216668
     C                   CALLB     'ZAACSBRCH'                                  216668
     C                   PARM                    AGSBRC                         216668
     C                   PARM                    S_SDBRCH                       216668
                                                                                216668
      * Database error if branch not found                                      216668
                                                                                216668
     C     S_A8BRCD      IFEQ      *BLANK                                       216668
     C                   EVAL      X_ERMS = 'BAD SOURCE BRANCH CODE:' + AGSBRC  216668
     C                   EXSR      *PSSR                                        216668
     C                   ENDIF                                                  216668
                                                                                216668
     C                   ENDSR                                                  216668
      *********************************************************************     216668
      /SPACE 5
      ********************************************************************
      * Access a currency
      ********************************************************************
     C     ACS_CURR      BEGSR
 
     C                   CALLB     'ZAACSCURR'
     C                   PARM                    CCY
     C                   PARM                    SDCURR
 
      * Database error if currency not found
 
     C     A6CYCD        IFEQ      *BLANK
     C                   EVAL      X_ERMS = 'BAD CCY CODE:' + CCY
     C                   EXSR      *PSSR
     C                   ENDIF
 
     C                   ENDSR
      *********************************************************************
      /SPACE 5
      ********************************************************************
      * Access A/c code
      ********************************************************************
     C     ACS_ACOD      BEGSR
 
     C                   CALLB     'ZAACSACOD'
     C**********         PARM                    ACCD              4                          CGL029
     C                   PARM                    ACCD             10                          CGL029
     C                   PARM                    SDACOD
 
      * Database error if a/c code not found
 
     C     A5ACCD        IFEQ      *BLANK
     C                   EVAL      X_ERMS = 'BAD A/C CODE:' + ACCD
     C                   EXSR      *PSSR
     C                   ENDIF
 
     C                   ENDSR
      *******************************************************************
      /SPACE 5
      ********************************************************************
      * Lookup branch, currency and profit centre
      ********************************************************************
     C     LOOKUP_BCP    BEGSR
 
     C*******************MOVEL     BRCA          #BRCA                          216668
     C*******************MOVEL     A8BICN        #BICN                          216668
     C*******************MOVEL     CCY           #CCY                           216668
     C*******************MOVEL     PRFC          #PRFC                          216668
     C                   Z-ADD     1             #B                3 0
     C     BRCYPC        LOOKUP    #_BCP(#B)                              99    *
     C     *in99         IFEQ      '0'
     C     *BLANK        LOOKUP    #_BCP(#B)                              99    *
     C                   MOVEL     BRCYPC        #_BCP(#B)                      *
     C                   ENDIF
 
     C                   ENDSR
      *******************************************************************
      /SPACE 5                                                                  216668
      ********************************************************************      216668
      * Lookup branch, currency, account code and profit centre                 216668
      ********************************************************************      216668
     C     LOOKUP_BCAP   BEGSR                                                  216668
                                                                                216668
     C                   Z-ADD     1             #B                3 0          216668
     C     BRCYAPC       LOOKUP    #_BCAP(#B)                             99    216668
     C     *in99         IFEQ      '0'                                          216668
     C     *BLANK        LOOKUP    #_BCAP(#B)                             99    216668
     C                   MOVEL     BRCYAPC       #_BCAP(#B)                     216668
     C                   ENDIF                                                  216668
                                                                                216668
     C                   ENDSR                                                  216668
      *******************************************************************       216668
      /SPACE 5
      ********************************************************************
      * Convert a day number into a date
      ********************************************************************
     C     ZDATE2        BEGSR
     C                   CALLB     'ZDATE2'
     C                   PARM                    ZDAYNO            5 0
     C                   PARM      'M'           ZDFIN             1
     C                   PARM      *ZERO         ZDATEN            6 0
     C                   PARM      *BLANK        ZADATE            7
     C                   ENDSR
      *********************************************************************
      /SPACE 5
      ********************************************************************
      * Edit an amount
      ********************************************************************
     C     ZEDIT         BEGSR
     C                   CALLB     'ZEDIT'
     C                   PARM                    ZFIELD           16
     C                   PARM      A6NBDP        ZADEC             1 0
     C                   ENDSR
      *********************************************************************
      /SPACE 5
      ********************************************************************
      * Register P1 printer file with RCF
      ********************************************************************
     C     RCFP1         BEGSR
 
     C                   EVAL      ZSnum = PSFNum1
 
     C                   CALL      'ZSFILE'
     C                   PARM                    PSeq
     C                   PARM                    PEnty
     C                   PARM                    PSFile1
     C                   PARM                    ZSnum
     C                   PARM      *Blank        ZSErr
 
      ** If Error occurs during ZSFILE processing, then end abnormally
 
     C                   IF        ZSErr = 'Y'
     C                   EVAL      X_ERMS = 'Call to ZSFILE in error'
     C                   EXSR      *PSSR
     C                   ENDIF
 
     C                   ENDSR
      *********************************************************************
      /SPACE 5
      ********************************************************************
      * *INZSR --- INITIAL PROCESSING
      ********************************************************************
     C     *INZSR        BEGSR
 
      *  Access Bank Details
 
     C                   CALL      'AOBANKR0'
     C                   PARM      '*DBERR  '    @RTCD             7
     C                   PARM      '*FIRST  '    @OPTN             7
     C     SDBANK        PARM      SDBANK        DSFDY
 
      *  Access Cash Management Details
 
     C                   CALLB     'AOCMANR0'
     C                   PARM      *BLANKS       @RTCD             7
     C                   PARM      '*FIRST  '    @OPTN             7
     C     SDCMAN        PARM      SDCMAN        DSSDY
 
      * Database Error
 
     C                   IF        @RTCD <> *BLANKS
     C                   EVAL      X_ERMS = 'Call to AOCMANR0 in error'
     C                   EXSR      *PSSR
     C                   ENDIF
 
      * Throw a page
 
     C                   Z-ADD     99            LINENO
 
      * Register P1 printer file with RCF
     C                   EXSR      RCFP1
 
      * key lists
 
     C     GLAPSGAK      KLIST
     C                   KFLD                    XRFI
     C                   KFLD                    XRFN
     C     ACCNTK        KLIST                                                  216668
     C                   KFLD                    CNUM                           216668
     C                   KFLD                    CCY                            216668
     C                   KFLD                    ACOD                           216668
     C                   KFLD                    ACSQ                           216668
     C                   KFLD                    BRCA                           216668
 
     C                   ENDSR
      *******************************************************************
      /SPACE 5
      ********************************************************************
      * * P S S R  --- A B N O R M A L   E R R O R   C O N D I T I O N S
      /COPY ZACPYSRC,RECMPSSR
      *****************************************************************
     OGECXF     E            UGECXF
     O                       RECI
     O                       PRIN
     O                       OTRF
