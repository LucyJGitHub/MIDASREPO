     H        1   Y
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE Calculate Fixed Commission Copy Data')        *
      *****************************************************************
      *                                                               *
      *  Midas - Retail Module                                        *
      *                                                               *
      *  RE1132 - RE Calculate Fixed Commission Copy Data             *
      *                                                               *
      *  Function:  This program will copy a block of records from    *
      *             the old driver LF/REHISBNA or LF/REHISBAA         *
      *             (via OVRDBF command in CL program) to a member    *
      *             in the new driver file PF/REFIXCPD.               *
      *                                                               *
      *  Called By: REC1132, REC1142                                  *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. AR1061944          Date 30Nov12               *
      *                 CRE083             Date 06Aug12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD027             Date 09Dec05               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CCB003  *CREATE    Date 24Oct96               *
      *                                    Date DDMmmYY               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  AR1061944 - Added NRF return code conditioning.              *
      *  CRE083 - COB Restructure - RE COB Optimisation Phase 1       *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CCB003 - COB Performance Enhancements - Task Split           *
      *           Copy records from old driver to new driver file.    *
      *                                                               *
      *****************************************************************
      *
     FREHISBN IF  E           K        DISK         KINFSR *PSSR
      *
     F**REFIXCPDUF  E           K        DISK         KINFSR *PSSR A                          CRE083
     FREFIXCPDUF  E           K        DISK         KINFSR *PSSR A    UC                      CRE083
     F**********  REHISPPF                          KRENAMEDRIVEF                             CRE083
     F            REFIXCD0                          KRENAMEDRIVEF                             CRE083
     F                                              KCOMIT
      *
     FREFXCIPDUF  E                    DISK         KINFSR *PSSR A
     F**********  REHISPPF                          KRENAMEINDEXF                             CRE083
     F            REFXCID0                          KRENAMEINDEXF                             CRE083
     F                                              KCOMIT
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  Function of indicators                                       *
      *  ----------------------                                       *
      *                                                               *
      *     50 - Indicator for dummy read of REFIXCPD                 *
      *     80 - READ indicator for REFXCIPD                          *
      *     81 - READ indicator for REHISBN                           *
      *                                                               *
      *  U7+U8 - Database error                                       *
      *                                                               *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *
     E                    CPY@    1   1 80
      ** Array containing Copyright statement
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *
     IINDEXF
      ** Rename fields for REFXCIPD format
     I**********    RECI                            WRECI                                     CRE083
     I              RECID                           WRECID                                    CRE083
     I              BRCA                            WBRCA
     I              CNUM                            WCNUM
     I              CCY                             WCCY
     I              ACOD                            WACOD
     I              ACSQ                            WACSQ
     I              PROT                            WPROT                                     CRE083
     I              TMST                            WTMST                                     CRE083
     I**********    HISD                            WHISD                                     CRE083
     I**********    HISB                            WHISB                                     CRE083
     I**********    MNBL                            WMNBL                                     CRE083
     I**********    CHGAR                           WCHGAR                                    CRE083
     I**********    TCHGAR                          WTCHGR                                    CRE083
     I**********    CHGAN                           WCHGAN                                    CRE083
     I**********    TCHGAN                          WTCHGN                                    CRE083
     I**********    DMVT                            WDMVT                                     CRE083
     I**********    DICT                            WDICT                                     CRE083
     I**********    DRCB                            WDRCB                                     CRE083
     I**********    DRIR                            WDRIR                                     CRE083
     I**********    DRCD                            WDRCD                                     CRE083
     I**********    DAID                            WDAID                                     CRE083
     I**********    MADI                            WMADI                                     CRE083
     I**********    TMADI                           WTMADI                                    CRE083
     I**********    PDID                            WPDID                                     CRE083
     I**********    DMINT                           WDMINT                                    CRE083
     I**********    CMVT                            WCMVT                                     CRE083
     I**********    CICT                            WCICT                                     CRE083
     I**********    CRCB                            WCRCB                                     CRE083
     I**********    CRIR                            WCRIR                                     CRE083
     I**********    CRCD                            WCRCD                                     CRE083
     I**********    CAID                            WCAID                                     CRE083
     I**********    MACI                            WMACI                                     CRE083
     I**********    TMACI                           WTMACI                                    CRE083
     I**********    PCID                            WPCID                                     CRE083
     I**********    CMINT                           WCMINT                                    CRE083
     I**********    DICI                            WDICI                                     CRE083
     I**********    CICI                            WCICI                                     CRE083
     I**********    DRCI                            WDRCI                                     CRE083
     I**********    CRCI                            WCRCI                                     CRE083
     I**********    VDTC                            WVDTC                                     CRE083
     I**********    ADTY                            WADTY                                     CRE083
     I**********    ALTI                            WALTI                                     CRE083
     I**********    MNBCP                           WMNBCP                                    CRE083
     I**********    LGID                            WLGID                                     CRE083
     I**********    VALL                            WVALL                                     CRE083
     I**********    LINK                            WLINK                                     CRE083
      *
     ILDA       E DSLDA                         256
      ** Local data area for database error details
      *
     IPSDS       SDS
      ** Program Status Data Structure
     I                                     *PROGRAM PGM
     I                                      244 253 WSID
     I                                      254 263 USER
      *
      *****************************************************************
      /EJECT
      *****************************************************************
     C           *ENTRY    PLIST
     C                     PARM           RECTOT  70
     C                     PARM           RTCODE  3
      *                                                                                       CRE083
     C                     OPEN REFIXCPD                                                      CRE083
      *
      ** Initial processing
     C           RUNONE    IFEQ ' '                                                           CRE083
     C                     EXSR INIT
     C                     MOVE 'Y'       RUNONE  1                                           CRE083
     C                     ENDIF                                                              CRE083
      *
      ** Split records into new file
     C                     EXSR TSPLIT
      *
      ** End processing
     C                     EXSR END
      *****************************************************************
      /EJECT
      *****************************************************************
      * TSPLIT - Split records into new driver and index files.       *
      *                                                               *
      * Called by: MAIN PROCESSING                                    *
      * Calls    : None                                               *
      *****************************************************************
     C           TSPLIT    BEGSR
      *
     C                     Z-ADD0         TOT     70
      *                                                                                       CRE083
      ** SETLL to the index file.
      *
     C           1         SETLLREFXCIPD                 80                                   CRE083
      *
      ** Check the Index file and set the file pointer to the next
      ** driver record to be copied accordingly.
      *
     C                     READ REFXCIPD                 80
      *
     C           *IN80     IFEQ '1'
     C           *LOVAL    SETLLREHISBN
     C                     ELSE
     C                     MOVE WBRCA     KBRCA
     C**********           Z-ADDWCNUM     KCNUM                                               CSD027
     C                     MOVE WCNUM     KCNUM                                               CSD027
     C                     MOVE WCCY      KCCY
     C                     Z-ADDWACOD     KACOD
     C                     Z-ADDWACSQ     KACSQ
     C           KEY       SETGTREHISBN
     C                     ENDIF
      *
      ** Copy records to the new driver file until the limit
      ** specified in the input parameter (RECTOT) is reached.
      *
     C           TOT       DOUEQRECTOT
     C           *IN81     OREQ '1'
      *
     C                     READ REHISBN                  81
     C           *IN81     IFEQ '0'
      *                                                                                       CRE083
      ** Write first record, if there is one.                                                 CRE083
      *                                                                                       CRE083
     C           TOT       IFEQ 0                                                             CRE083
     C                     MOVE 'A'       RECID                                               CRE083
     C                     MOVE ' '       PROT                                                CRE083
      *                                                                                       CRE083
      ** Output Timestamp.                                                                    CRE083
      *                                                                                       CRE083
     C                     CALL 'ZAGENTS'                                                     CRE083
     C                     PARM           TMST   26                                           CRE083
     C                     WRITEDRIVEF
     C                     ENDIF                                                              CRE083
      *                                                                                       CRE083
     C                     ADD  1         TOT
     C                     ENDIF
      *
     C                     ENDDO
      *                                                                                       CRE083
      ** Write last record, if there is one.                                                  CRE083
      *                                                                                       CRE083
     C           TOT       IFGT 0                                                             CRE083
     C                     MOVE 'Z'       RECID                                               CRE083
     C                     MOVE ' '       PROT                                                CRE083
      *                                                                                       CRE083
      ** Output Timestamp.                                                                    CRE083
      *                                                                                       CRE083
     C                     CALL 'ZAGENTS'                                                     CRE083
     C                     PARM           TMST                                                CRE083
     C                     WRITEDRIVEF                                                        CRE083
     C                     ENDIF                                                              CRE083
      *
      ** Set up fields for Index file with data from last record
      ** written to PF/REFIXCPD.
      *
     C**********           MOVE RECI      WRECI                                               CRE083
     C                     MOVE RECID     WRECID                                              CRE083
     C                     MOVE BRCA      WBRCA
     C**********           Z-ADDCNUM      WCNUM                                               CSD027
     C                     MOVE CNUM      WCNUM                                               CSD027
     C                     MOVE CCY       WCCY
     C                     Z-ADDACOD      WACOD
     C                     Z-ADDACSQ      WACSQ
     C                     MOVE PROT      WPROT                                               CRE083
     C                     MOVE TMST      WTMST                                               CRE083
     C**********           Z-ADDHISD      WHISD                                               CRE083
     C**********           Z-ADDHISB      WHISB                                               CRE083
     C**********           Z-ADDMNBL      WMNBL                                               CRE083
     C**********           Z-ADDCHGAR     WCHGAR                                              CRE083
     C**********           Z-ADDTCHGAR    WTCHGR                                              CRE083
     C**********           Z-ADDCHGAN     WCHGAN                                              CRE083
     C**********           Z-ADDTCHGAN    WTCHGN                                              CRE083
     C**********           Z-ADDDMVT      WDMVT                                               CRE083
     C**********           Z-ADDDICT      WDICT                                               CRE083
     C**********           Z-ADDDRCB      WDRCB                                               CRE083
     C**********           Z-ADDDRIR      WDRIR                                               CRE083
     C**********           Z-ADDDRCD      WDRCD                                               CRE083
     C**********           Z-ADDDAID      WDAID                                               CRE083
     C**********           Z-ADDMADI      WMADI                                               CRE083
     C**********           Z-ADDTMADI     WTMADI                                              CRE083
     C**********           Z-ADDPDID      WPDID                                               CRE083
     C**********           Z-ADDDMINT     WDMINT                                              CRE083
     C**********           Z-ADDCMVT      WCMVT                                               CRE083
     C**********           Z-ADDCICT      WCICT                                               CRE083
     C**********           Z-ADDCRCB      WCRCB                                               CRE083
     C**********           Z-ADDCRIR      WCRIR                                               CRE083
     C**********           Z-ADDCRCD      WCRCD                                               CRE083
     C**********           Z-ADDCAID      WCAID                                               CRE083
     C**********           Z-ADDMACI      WMACI                                               CRE083
     C**********           Z-ADDTMACI     WTMACI                                              CRE083
     C**********           Z-ADDPCID      WPCID                                               CRE083
     C**********           Z-ADDCMINT     WCMINT                                              CRE083
     C**********           MOVE DICI      WDICI                                               CRE083
     C**********           MOVE CICI      WCICI                                               CRE083
     C**********           MOVE DRCI      WDRCI                                               CRE083
     C**********           MOVE CRCI      WCRCI                                               CRE083
     C**********           Z-ADDVDTC      WVDTC                                               CRE083
     C**********           MOVE ADTY      WADTY                                               CRE083
     C**********           MOVE ALTI      WALTI                                               CRE083
     C**********           Z-ADDMNBCP     WMNBCP                                              CRE083
     C**********           MOVE LGID      WLGID                                               CRE083
     C**********           Z-ADDVALL      WVALL                                               CRE083
     C**********           MOVE LINK      WLINK                                               CRE083
      *
      ** If Index file is empty write new record to it, else update
      ** with details of last record written to PF/REFIXCPD.
      *
     C           *IN80     IFEQ '1'
     C                     WRITEINDEXF
     C                     ELSE
     C                     UPDATINDEXF
     C                     ENDIF
      *
     C                     COMIT
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * END - Exit program and return to calling program.             *
      *                                                               *
      * Called by: MAIN PROCESSING                                    *
      * Calls    : None                                               *
      *****************************************************************
     C           END       BEGSR
      *
      ** If end of file on REHISBN  set return code to notify server
      *
     C           *IN81     IFEQ '1'
     C           TOT       IFEQ 0                                                          AR1061944
     C                     MOVE 'NRF'     RTCODE                                           AR1061944
     C                     ELSE                                                            AR1061944
     C                     MOVE 'EOF'     RTCODE
     C                     ENDIF
     C                     ENDIF                                                           AR1061944
      *
     C                     CLOSEREFIXCPD                                                      CRE083
     C**********           SETON                     LR                                       CRE083
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * INIT - Initial processing.                                    *
      *                                                               *
      * Called by: MAIN PROCESSING                                    *
      * Calls    : None                                               *
      *****************************************************************
     C           INIT      BEGSR
      *
      ** KLIST for setting file pointer to next record to be copied
      *
     C           KEY       KLIST
     C                     KFLD           KBRCA   3
     C**********           KFLD           KCNUM   60                                          CSD027
     C                     KFLD           KCNUM   6                                           CSD027
     C                     KFLD           KCCY    3
     C**********           KFLD           KACOD   40                                          CGL029
     C                     KFLD           KACOD  100                                          CGL029
     C                     KFLD           KACSQ   20
      *
      ** Set up copyright parameter
     C                     MOVEACPY@      CPY2@  80
      *
      ** Define LDA
     C           *NAMVAR   DEFN           LDA
      *
      ** Dummy READ to REFIXCPD for compilation purpose
     C           *IN50     IFEQ '1'
     C                     READ REFIXCPD                 50
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      * Called by: (**calling routines**)                             *
      * Calls: None                                                   *
      *****************************************************************
     C           *PSSR     BEGSR
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'RE1132'  DBPGM     P
     C                     OUT  LDA
      *
     C                     SETON                     U7U8LR
     C                     DUMP
     C                     ROLBK
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
** CPY@ - Object copyright
(c) Finastra International Limited 2001
