     H        1   Y
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE Commissions Capitalisation Copy Data')        *
      *****************************************************************
      *                                                               *
      *  Midas - Retail Module                                        *
      *                                                               *
      *  RE3121 - RE Commissions Capitalisation Copy Data             *
      *                                                               *
      *  Function:  This program will copy a block of records from    *
      *             the old driver LF/RECAPML to a member in the      *
      *             new driver PF/RECOMCPD.                           *
      *                                                               *
      *  Called By: REC3121 - Commissions Capitalisations Task Split  *
      *                       Server.                                 *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CRE083BD           Date 06Aug12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD027             Date 09Dec05               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CCB003  *CREATE    Date 24Oct96               *
      *                                                               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CRE083BD - COB Restructure - RE COB Optimisation Phase 1     *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CCB003 - COB Performance Enhancements - Task Split           *
      *           Copy records from old driver to new driver file.    *
      *                                                               *
      *****************************************************************
      *
     FRECAPML IF  E           K        DISK         KINFSR *PSSR
      *
     F**RECOMCPDUF  E                    DISK         KINFSR *PSSR A                        CRE083BD
     FRECOMCPDUF  E                    DISK         KINFSR *PSSR A    UC                    CRE083BD
     F**********  RECAPMF                           KRENAMEDRIVEF                           CRE083BD
     F            RECOMCD0                          KRENAMEDRIVEF                           CRE083BD
     F                                              KCOMIT
      *
     FRECMCIPDUF  E                    DISK         KINFSR *PSSR A
     F**********  RECAPMF                           KRENAMEINDEXF                           CRE083BD
     F            RECOMCD0                          KRENAMEINDEXF                           CRE083BD
     F                                              KCOMIT                                  CRE083BD
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  Function of indicators                                       *
      *  ----------------------                                       *
      *                                                               *
      *     50 - Indicator for dummy read of RECOMCPD                 *
      *     80 - READ indicator for RECMCIPD                          *
      *     81 - READ indicator for RECAPML                           *
      *                                                               *
      *  U7+U8 - Database error                                       *
      *                                                               *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *
     E                    CPY@    1   1 80
      ** Array containing Copyright statement
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *
      ** Rename fields for RECMCIPD format
     IINDEXF
     I              RECID                           WRECID                                  CRE083BD
     I              BRCA                            WBRCA                                   CRE083BD
     I              CNUM                            WCNUM                                   CRE083BD
     I              CCY                             WCCY                                    CRE083BD
     I              ACOD                            WACOD                                   CRE083BD
     I              ACSQ                            WACSQ                                   CRE083BD
     I              PROT                            WPROT                                   CRE083BD
     I              TMST                            WTMST                                   CRE083BD
     I**********    CRECI                           WRECI                                   CRE083BD
     I**********    CBRCA                           WBRCA                                   CRE083BD
     I**********    CCNUM                           WCNUM                                   CRE083BD
     I**********    CCCY                            WCCY                                    CRE083BD
     I**********    CACOD                           WACOD                                   CRE083BD
     I**********    CACSQ                           WACSQ                                   CRE083BD
     I**********    CHISD                           WHISD                                   CRE083BD
     I**********    CHISB                           WHISB                                   CRE083BD
     I**********    CMNBL                           WMNBL                                   CRE083BD
     I**********    CPHGAR                          WPHGAR                                  CRE083BD
     I**********    CTHGAR                          WTHGAR                                  CRE083BD
     I**********    CPHGAN                          WPHGAN                                  CRE083BD
     I**********    CTHGAN                          WTHGAN                                  CRE083BD
     I**********    CDICT                           WDICT                                   CRE083BD
     I**********    CDRCB                           WDRCB                                   CRE083BD
     I**********    CDRIR                           WDRIR                                   CRE083BD
     I**********    CDRCD                           WDRCD                                   CRE083BD
     I**********    CDAIC                           WDAIC                                   CRE083BD
     I**********    CPMADI                          WPMADI                                  CRE083BD
     I**********    CTMADI                          WTMADI                                  CRE083BD
     I**********    CLDID                           WLDID                                   CRE083BD
     I**********    CDMINT                          WDMINT                                  CRE083BD
     I**********    CSGADI                          WSGADI                                  CRE083BD
     I**********    CDRIP                           WDRIP                                   CRE083BD
     I**********    CDICI                           WDICI                                   CRE083BD
     I**********    CDRIS                           WDRIS                                   CRE083BD
     I**********    CSDACP                          WSDACP                                  CRE083BD
     I**********    CSDCI                           WSDCI                                   CRE083BD
     I**********    CCICT                           WCICT                                   CRE083BD
     I**********    CCRCB                           WCRCB                                   CRE083BD
     I**********    CCRIR                           WCRIR                                   CRE083BD
     I**********    CCRCD                           WCRCD                                   CRE083BD
     I**********    CCAIC                           WCAIC                                   CRE083BD
     I**********    CPMACI                          WPMACI                                  CRE083BD
     I**********    CTMACI                          WTMACI                                  CRE083BD
     I**********    CLCID                           WLCID                                   CRE083BD
     I**********    CCMINT                          WCMINT                                  CRE083BD
     I**********    CSGACI                          WSGACI                                  CRE083BD
     I**********    CCRIP                           WCRIP                                   CRE083BD
     I**********    CCICI                           WCICI                                   CRE083BD
     I**********    CCRIS                           WCRIS                                   CRE083BD
     I**********    CSCACP                          WSCACP                                  CRE083BD
     I**********    CSCCI                           WSCCI                                   CRE083BD
     I**********    CSTBL                           WSTBL                                   CRE083BD
     I**********    CCHGP                           WCHGP                                   CRE083BD
     I**********    CSCHAC                          WSCHAC                                  CRE083BD
     I**********    CMNBCP                          WMNBCP                                  CRE083BD
     I**********    CSCHGI                          WSCHGI                                  CRE083BD
     I              LGID                            WLGID
     I**********    DRBR                            WDRBR                                   CRE083BD
     I**********    CRBR                            WCRBR                                   CRE083BD
     I**********    CHBR                            WCHBR                                   CRE083BD
      *
     ILDA       E DSLDA                         256
      ** Local data area for database error details
      *
     IPSDS       SDS
      ** Program Status Data Structure
     I                                     *PROGRAM PGM
     I                                      244 253 WSID
     I                                      254 263 USER
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      * MAIN PROCESSING                                               *
      *                                                               *
      * Calls: INIT, TSPLIT, END                                      *
      *****************************************************************
     C           *ENTRY    PLIST
     C                     PARM           RECTOT  70
     C                     PARM           RTCODE  3
      *                                                                                     CRE083BD
     C                     OPEN RECOMCPD                                                    CRE083BD
      *
      ** Initial processing
     C           RUNONE    IFEQ ' '                                                         CRE083BD
     C                     EXSR INIT
     C                     MOVE 'Y'       RUNONE  1                                         CRE083BD
     C                     ENDIF                                                            CRE083BD
      *
      ** Split records into new file
     C                     EXSR TSPLIT
      *
      ** End processing
     C                     EXSR END
      *****************************************************************
      /EJECT
      *****************************************************************
      * TSPLIT - Split records into new driver and index files.       *
      *                                                               *
      * Called by: MAIN PROCESSING                                    *
      * Calls    : None                                               *
      *****************************************************************
     C           TSPLIT    BEGSR
      *
     C                     Z-ADD0         TOT     70
      *                                                                                     CRE083BD
      ** SETLL to the index file.                                                           CRE083BD
      *                                                                                     CRE083BD
     C           1         SETLLRECMCIPD                 80                                 CRE083BD
      *
      ** Check the Index file and set the file pointer to the next
      ** driver record to be copied accordingly.
      *
     C                     READ RECMCIPD                 80
      *
     C           *IN80     IFEQ '1'
     C           *LOVAL    SETLLRECAPML
     C                     ELSE
     C                     MOVE WLGID     KLGID
     C                     MOVE WBRCA     KBRCA
     C**********           Z-ADDWCNUM     KCNUM                                               CSD027
     C                     MOVE WCNUM     KCNUM                                               CSD027
     C                     MOVE WCCY      KCCY
     C                     Z-ADDWACOD     KACOD
     C                     Z-ADDWACSQ     KACSQ
     C           KEY       SETGTRECAPML
     C                     ENDIF
      *
      ** Copy records to the new driver file until the limit
      ** specified in the input parameter (RECTOT) is reached.
      *
     C           TOT       DOUEQRECTOT
     C           *IN81     OREQ '1'
      *
     C                     READ RECAPML                  81
     C           *IN81     IFEQ '0'
      *                                                                                     CRE083BD
      ** Write first record, if there is one.                                               CRE083BD
      *                                                                                     CRE083BD
     C           TOT       IFEQ 0                                                           CRE083BD
     C                     MOVE 'A'       RECID                                             CRE083BD
     C                     MOVE CBRCA     BRCA                                              CRE083BD
     C                     MOVE CCNUM     CNUM                                              CRE083BD
     C                     MOVE CCCY      CCY                                               CRE083BD
     C                     MOVE CACOD     ACOD                                              CRE083BD
     C                     MOVE CACSQ     ACSQ                                              CRE083BD
     C                     MOVE ' '       PROT                                              CRE083BD
      *                                                                                     CRE083BD
      ** Output Timestamp.                                                                  CRE083BD
      *                                                                                     CRE083BD
     C                     CALL 'ZAGENTS'                                                   CRE083BD
     C                     PARM           TMST   26                                         CRE083BD
     C                     WRITEDRIVEF
     C                     ENDIF                                                            CRE083BD
      *                                                                                     CRE083BD
     C           TOT       ADD  1         TOT
     C                     ENDIF
      *
     C                     ENDDO
      *                                                                                     CRE083BD
      ** Write last record, if there is one.                                                CRE083BD
      *                                                                                     CRE083BD
     C           TOT       IFGT 0                                                           CRE083BD
     C                     MOVE 'Z'       RECID                                             CRE083BD
     C                     MOVE CBRCA     BRCA                                              CRE083BD
     C                     MOVE CCNUM     CNUM                                              CRE083BD
     C                     MOVE CCCY      CCY                                               CRE083BD
     C                     MOVE CACOD     ACOD                                              CRE083BD
     C                     MOVE CACSQ     ACSQ                                              CRE083BD
     C                     MOVE ' '       PROT                                              CRE083BD
      *                                                                                     CRE083BD
      ** Output Timestamp.                                                                  CRE083BD
      *                                                                                     CRE083BD
     C                     CALL 'ZAGENTS'                                                   CRE083BD
     C                     PARM           TMST                                              CRE083BD
     C                     WRITEDRIVEF                                                      CRE083BD
     C                     ENDIF                                                            CRE083BD
      *
      ** Set up fields for Index file with data from last record
      ** written to PF/RECOMCPD.
      *
     C                     MOVE RECID     WRECID                                            CRE083BD
     C                     MOVE BRCA      WBRCA                                             CRE083BD
     C                     MOVE CNUM      WCNUM                                             CRE083BD
     C                     MOVE CCY       WCCY                                              CRE083BD
     C                     Z-ADDACOD      WACOD                                             CRE083BD
     C                     Z-ADDACSQ      WACSQ                                             CRE083BD
     C                     MOVE PROT      WPROT                                             CRE083BD
     C                     MOVE TMST      WTMST                                             CRE083BD
     C**********           MOVE CRECI     WRECI                                             CRE083BD
     C**********           MOVE CBRCA     WBRCA                                             CRE083BD
     C**********           Z-ADDCCNUM     WCNUM                                               CSD027
     C**********           MOVE CCNUM     WCNUM                                               CSD027
     C**********           MOVE CCCY      WCCY                                              CRE083BD
     C**********           Z-ADDCACOD     WACOD                                             CRE083BD
     C**********           Z-ADDCACSQ     WACSQ                                             CRE083BD
     C**********           Z-ADDCHISD     WHISD                                             CRE083BD
     C**********           Z-ADDCHISB     WHISB                                             CRE083BD
     C**********           Z-ADDCMNBL     WMNBL                                             CRE083BD
     C**********           Z-ADDCPHGAR    WPHGAR                                            CRE083BD
     C**********           Z-ADDCTHGAR    WTHGAR                                            CRE083BD
     C**********           Z-ADDCPHGAN    WPHGAN                                            CRE083BD
     C**********           Z-ADDCTHGAN    WTHGAN                                            CRE083BD
     C**********           Z-ADDCDICT     WDICT                                             CRE083BD
     C**********           Z-ADDCDRCB     WDRCB                                             CRE083BD
     C**********           Z-ADDCDRIR     WDRIR                                             CRE083BD
     C**********           Z-ADDCDRCD     WDRCD                                             CRE083BD
     C**********           Z-ADDCDAIC     WDAIC                                             CRE083BD
     C**********           Z-ADDCPMADI    WPMADI                                            CRE083BD
     C**********           Z-ADDCTMADI    WTMADI                                            CRE083BD
     C**********           Z-ADDCLDID     WLDID                                             CRE083BD
     C**********           Z-ADDCDMINT    WDMINT                                            CRE083BD
     C**********           Z-ADDCSGADI    WSGADI                                            CRE083BD
     C**********           Z-ADDCDRIP     WDRIP                                             CRE083BD
     C**********           MOVE CDICI     WDICI                                             CRE083BD
     C**********           Z-ADDCDRIS     WDRIS                                             CRE083BD
     C**********           MOVE CSDACP    WSDACP                                            CRE083BD
     C**********           MOVE CSDCI     WSDCI                                             CRE083BD
     C**********           Z-ADDCCICT     WCICT                                             CRE083BD
     C**********           Z-ADDCCRCB     WCRCB                                             CRE083BD
     C**********           Z-ADDCCRIR     WCRIR                                             CRE083BD
     C**********           Z-ADDCCRCD     WCRCD                                             CRE083BD
     C**********           Z-ADDCCAIC     WCAIC                                             CRE083BD
     C**********           Z-ADDCPMACI    WPMACI                                            CRE083BD
     C**********           Z-ADDCTMACI    WTMACI                                            CRE083BD
     C**********           Z-ADDCLCID     WLCID                                             CRE083BD
     C**********           Z-ADDCCMINT    WCMINT                                            CRE083BD
     C**********           Z-ADDCSGACI    WSGACI                                            CRE083BD
     C**********           Z-ADDCCRIP     WCRIP                                             CRE083BD
     C**********           MOVE CCICI     WCICI                                             CRE083BD
     C**********           Z-ADDCCRIS     WCRIS                                             CRE083BD
     C**********           MOVE CSCACP    WSCACP                                            CRE083BD
     C**********           MOVE CSCCI     WSCCI                                             CRE083BD
     C**********           Z-ADDCSTBL     WSTBL                                             CRE083BD
     C**********           Z-ADDCCHGP     WCHGP                                             CRE083BD
     C**********           MOVE CSCHAC    WSCHAC                                            CRE083BD
     C**********           Z-ADDCMNBCP    WMNBCP                                            CRE083BD
     C**********           MOVE CSCHGI    WSCHGI                                            CRE083BD
     C                     MOVE LGID      WLGID
     C**********           MOVE DRBR      WDRBR                                             CRE083BD
     C**********           MOVE CRBR      WCRBR                                             CRE083BD
     C**********           MOVE CHBR      WCHBR                                             CRE083BD
      *
      ** If Index file is empty write new record to it, else update
      ** with details of last record written to PF/RECOMCPD.
      *
     C           *IN80     IFEQ '1'
     C                     WRITEINDEXF
     C                     ELSE
     C                     UPDATINDEXF
     C                     ENDIF
      *
     C                     COMIT
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * END - Exit program and return to calling program.             *
      *                                                               *
      * Called by: MAIN PROCESSING                                    *
      * Calls    : None                                               *
      *****************************************************************
     C           END       BEGSR
      *
      ** If end of file on RECAPML set return code to notify server
      *
     C           *IN81     IFEQ *ON
     C           TOT       IFEQ 0                                                           CRE083BD
     C                     MOVE 'NRF'     RTCODE                                            CRE083BD
     C                     ELSE                                                             CRE083BD
     C                     MOVE 'EOF'     RTCODE
     C                     ENDIF                                                            CRE083BD
     C                     ENDIF
      *
     C                     CLOSERECOMCPD                                                    CRE083BD
     C**********           SETON                     LR                                     CRE083BD
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * INIT - Initial processing.                                    *
      *                                                               *
      * Called by: MAIN PROCESSING                                    *
      * Calls    : None                                               *
      *****************************************************************
     C           INIT      BEGSR
      *
      ** KLIST for setting file pointer to next record to be copied
      *
     C           KEY       KLIST
     C                     KFLD           KLGID   2
     C                     KFLD           KBRCA   3
     C**********           KFLD           KCNUM   60                                          CSD027
     C                     KFLD           KCNUM   6                                           CSD027
     C                     KFLD           KCCY    3
     C**********           KFLD           KACOD   40                                          CGL029
     C                     KFLD           KACOD  100                                          CGL029
     C                     KFLD           KACSQ   20
      *
      ** Set up copyright parameter
     C                     MOVEACPY@      CPY2@  80
      *
      ** Define LDA
     C           *NAMVAR   DEFN           LDA
      *
      ** Dummy READ to RECOMCPD for compilation purpose
     C           *IN50     IFEQ '1'
     C                     READ RECOMCPD                 50
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      * Called by: (**calling routines**)                             *
      * Calls: None                                                   *
      *****************************************************************
     C           *PSSR     BEGSR
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'RE3121'  DBPGM     P
     C                     OUT  LDA
      *
     C                     SETON                     U7U8LR
     C                     DUMP
     C                     ROLBK
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
** CPY@ - Object Copyright
(c) Finastra International Limited 2001
