     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE T&N Accounts - Periods and Penalties')        *
      *****************************************************************
      *                                                               *
      *  Midas     - Retail T&N Accounts                              *
      *                                                               *
      *  RPG/RE4003  - Periods and Penalties                          *
      *                                                               *
      *  (c) Finastra International Limited 2009                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CGL154             Date 13Oct14               *
      *                 AR947093           Date 26Apr12               *
      *                 AR945681           Date 03Apr12               *
      *                 AR847249           Date 28Jan12               *
      *                 AR940109           Date 26Mar12               *
      *                 AR938402A          Date 26Mar12               *
      *                 AR939610           Date 23Mar12               *
      *                 AR938402           Date 23Feb12               *
      *                 AR935841           Date 20Feb12               *
      *                 AR845336           Date 10Jan12               *
      *                 AR835421           Date 05Oct11               *
      *                 CRE073             Date 06Dec10               *
      *                 CRE075             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 260558             Date 18Dec09               *
      *                 254071             Date 18Dec09               *
      *                 232019             Date 18Dec09               *
      *                 244324             Date 18Dec09               *
      *                 241299             Date 18Dec09               *
      *                 236070             Date 18Dec09               *
      *                 233487             Date 18Dec09               *
      *                 232997             Date 18Dec09               *
      *                 228715             Date 18Dec09               *
      *                 228407             Date 18Dec09               *
      *                 223607             Date 18Dec09               *
      *                 223606             Date 18Dec09               *
      *                 CRE015 *CREATE     Date 18Dec09               *
      *---------------------------------------------------------------*
      *  MD046248 - Finastra Rebranding                               *
      *  CGL154 - FATCA Reporting (Recompile)                         *
      *  AR947093 - Base Rate amendment resulted to 0 interest rate   *
      *  AR945681 - DBERRCTL encountered when resulting rate is 0     *
      *  AR847249 - Perform exception handling when Final rate is     *
      *             negative or zero.                                 *
      *  AR940109 - Validation issue for field Interest Fixing        *
      *             for Notice account                                *
      *  AR938402A- On/Off display of Spread if more than 1 period is *
      *             defined and showed incorrect (Reopen)             *
      *  AR939610 - Inconsistent spread sign in Period & Penalty      *
      *             details vs AMAD when the spread is negative       *
      *  AR938402 - On/Off display of Spread if more than 1 period is *
      *             defined and showed incorrect                      *
      *  AR935841 - System defaults the previous contractual spread   *
      *             that was inserted by the user                     *
      *  AR845336 - Zero contractual spread validation issue          *
      *  AR835421 - Separate debit and credit contractual spread rate *
      *  CRE073 - Interest Rate Rounding                              *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  260558 - Cleared Balance should be 0 in the window if 'I'.   *
      *  254071 - Ensure it is ossible to enter multiple periods for  *
      *           T&N Default.                                        *
      *  232019 - Not possible to enter a T&N Default                 *
      *           Include validation for SMDAT0 not equal to TRMDAT.  *
      *  244324 - Further validation on the "until" field (i.e.       *
      *           the field specifying the end of the period):        *
      *           ensure that the until date cannot be before start   *
      *           date of period.                                     *
      *  241299 - Wrong date accessed on REINTD and REINHSPD.         *
      *  236070 - No room to insert new period                        *
      *  233487 - When F6=Rate is used, cleared balance of alternative*
      *           account is being displayed instead.                 *
      *  232997 - Credit Interest Subtype not valid. Error msg TNN0352*
      *           Checking in the historical file is not required if  *
      *           the interest is calculated daily. Apply 228407.     *
      *           Also extend fix to set SCCY = 'SKK' if it is blank  *
      *           before chaining to REINT or calling AOBSRTR0.       *
      *           Also extend fix to set SCCY = 'SKK' if it is blank  *
      *           before chaining to REINT or calling AOBSRTR0.       *
      *           Also apply 228715 to allow deletion of unwanted     *
      *           default accounts.                                   *
      *  228715 - Unable to delete default periods and penalties due  *
      *           to mode being changed from delete to update. Correct*
      *           delete processing. Also bypass call to RETNCAP1 if  *
      *           in delete mode to prevent record locking problem.   *
      *  228407 - Credit Interest Subtype not valid.  Error msg       *
      *           TNN0352.                                            *
      *         - Checking in the historical file is not required     *
      *           if the interest is calculated daily.                *
      *  223607 - Change to calc basis only allowed on first on       *
      *   first workingt day of new term for periodic fixing.         *
      *  223606 - Validation for threshold interest calculation       *
      *  CRE015 - Retail Term and Notice Accounts                     *
      *                                                               *
      *****************************************************************
      *
     FRE4003DFCF  E                    WORKSTN
     F                                        SRRN  KSFILE RE4003S1
     FREINT   IF  E           K        DISK                           UC
     FREINHSL0IF  E           K        DISK
     FREPRPNL0IF  E           K        DISK
     FACNUM   IF  E           K        DISK         KINFSR *PSSR
      *
      *****************************************************************
      *
      ** Number of days in each month
      *
     E                    UFMD   12  12  2
      *                                                                                       CRE073
      * Error fields/message ID/message data Arrays                                           CRE073
      *                                                                                       CRE073
     E                    FNAR       20 10                                                    CRE073
     E                    MIAR       20  7                                                    CRE073
     E                    MDAR       20 45                                                    CRE073
      *                                                                                       CRE073
     E                    FNAX       20 10                                                    CRE073
     E                    MIAX       20  7                                                    CRE073
     E                    MDAX       20 45                                                    CRE073
      *                                                                                       CRE073
     I              'ZACALCSPRT'          C         ZCSPRT                                    CRE073
     I              'GBSDUSRMSG'          C         SDMSGF                                    CRE073
      *
      ** RE Interest type/subtypes                                                            223606
      *
     IREINTDF                                                                                 223606
     I              RECI                            RERECI                                    223606
     I              TNLU                            RETNLU                                    223606
     I              ORED                            REORED                                    223606
     I              LCD                             REILCD                                    223606
     I              CHTP                            RECHTP                                    223606
     I              ZZ053                           REZZ53                                    223606
     I              VDTC                            REVDTC                                    241299
      *
      ** Local data area for database error details
      ** *LOCK IN LDA immediately before and OUT LDA immediately
      ** after each database error handling.
      **
      **                                    134 141 DBFILE
      **       Defines:                     142 170 DBKEY
      **                                    171 180 DBPGM
      **                                    181 1830DBASE
      *
     ILDA       E DSLDA                         256
     I              SPARE                           W24
      *
      ** Program Status Data Structure - gives Job/Workstation name and
      ** User ID
      *
     IPSDS       SDS
      *
     I                                     *PROGRAM ##PGM
     I                                        1  10 SPGM
     I                                      244 253 SJOB
     I                                      244 246 WSID
     I                                      254 263 SUSER
      *
      ** Screen period details (one for each set)
      *
     ISVZSET      DS                                                                          CRE073
     I                                        1 256 SVZST1                                    CRE073
     I                                      257 283 SVZST2                                    CRE073
     INWSETS      DS                         26
     I                                        1   3 S1NDPD
     I                                        4   4 S1FREQ
     I                                        5  10 S1CEDE
     I                                       11  12 S1DRIB
     I                                       13  25 S1DRIS
     I                                       26  26 S1SIGD
     I                                       27  28 S1DICT
     I                                       29  33 S1DCST
     I                                       34  34 S1DRIC
     I                                       35  35 S1DNIR
     I                                       36  36 S1DRIF
     I                                       37  60 S1DACP
     I                                       61  65 S1RTTD
     I                                       66  66 S1DYBD
     I                                       67  68 S1CRIB
     I                                       69  81 S1CRIS
     I                                       82  82 S1SIGC
     I                                       83  84 S1CICT
     I                                       85  89 S1CCST
     I                                       90  90 S1CRIC
     I                                       91  91 S1CNIR
     I                                       92  92 S1CRIF
     I                                       93 116 S1CACP
     I                                      117 121 S1RTTC
     I                                      122 122 S1DYBC
     I                                      123 146 S1KEY1
     I                                      147 147 S1EVNT
     I                                      148 148 S1DRST
     I                                      149 149 S1CRST
     I                                      150 151 S1DAYM
     I                                      152 155 S1DRDY
     I                                      156 159 S1CRDY
      *
     I                                      169 174 S1CEDT
     I                                      175 1790S1CEDN
     I                                      189 195 UNTILT
     I                                      199 204 S1VDAT
     I                                      205 210 S1MDAT
     I                                      211 211 S1TPRD
     I                                      212 2140S1OLDS
     I                                      212 214 S1OLDA
     I                                      215 2160S1DAYN
     I                                      217 218 S1NMPD
     I                                      219 2330S1BALN
     I                                      234 246 S1DCSP                                    CRE073
     I                                      247 247 S1DCSG                                    CRE073
     I                                      248 254 S1DRMT                                    CRE073
     I                                      255 258 S1DRFD                                    CRE073
     I                                      259 271 S1CCSP                                    CRE073
     I                                      272 272 S1CCSG                                    CRE073
     I                                      273 279 S1CRMT                                    CRE073
     I                                      280 283 S1CRFD                                    CRE073
      *
      ** Old Screen period details (one for each set)
      *
     IOLSETS      DS                         26
     I                                        1   3 S2NDPD
     I                                        4   4 S2FREQ
     I                                        5  10 S2CEDE
     I                                       11  12 S2DRIB
     I                                       13  25 S2DRIS
     I                                       26  26 S2SIGD
     I                                       27  28 S2DICT
     I                                       29  33 S2DCST
     I                                       34  34 S2DRIC
     I                                       35  35 S2DNIR
     I                                       36  36 S2DRIF
     I                                       37  60 S2DACP
     I                                       61  65 S2RTTD
     I                                       66  66 S2DYBD
     I                                       67  68 S2CRIB
     I                                       69  81 S2CRIS
     I                                       82  82 S2SIGC
     I                                       83  84 S2CICT
     I                                       85  89 S2CCST
     I                                       90  90 S2CRIC
     I                                       91  91 S2CNIR
     I                                       92  92 S2CRIF
     I                                       93 116 S2CACP
     I                                      117 121 S2RTTC
     I                                      122 122 S2DYBC
     I                                      123 146 S2KEY1
     I                                      147 147 S2EVNT
     I                                      148 148 S2DRST
     I                                      149 149 S2CRST
     I                                      150 151 S2DAYM
     I                                      152 155 S2DRDY
     I                                      156 159 S2CRDY
     I                                      211 211 S2TPRD
     I                                      217 218 S2NMPD
     I                                      219 2330S2BALN
     I                                      234 246 S2DCSP                                    CRE073
     I                                      247 247 S2DCSG                                    CRE073
     I                                      248 254 S2DRMT                                    CRE073
     I                                      255 258 S2DRFD                                    CRE073
     I                                      259 271 S2CCSP                                    CRE073
     I                                      272 272 S2CCSG                                    CRE073
     I                                      273 279 S2CRMT                                    CRE073
     I                                      280 283 S2CRFD                                    CRE073
      *
     IW#ACNO      DS
     I                                        1   3 SBRCA
     I                                        4   9 SCNUM
     I                                       10  12 SCCY
     I                                       13  22 SACOD
     I                                       23  24 SACSQ
     IWSPDS       DS
     I                                        1  24 WSPOS1
     I                                        1   3 WSBRCA
     I                                        4   9 WSCNUM
     I                                       10  12 WSCCY
     I                                       13  22 WSACOD
     I                                       23  24 WSACSQ
     IQSPDS       DS
     I                                        1  24 QSPOS1
     I                                        1   3 QSBRCA
     I                                        4   9 QSCNUM
     I                                        4   9 QNCNUM
     I                                       10  12 QSCCY
     I                                       13  22 QSACOD
     I                                       13  220QNACOD
     I                                       23  24 QSACSQ
     I                                       23  240QNACSQ
      *
      ** Parameters
      *
     IP@FMT     E DSDSSDY
     IDSFDY     E DSDSFDY                                                                     CER059
      *
      ** Account details
      *
     IACFMT     E DSACCNTAB
      *
      ** Bank details
      *
     IBKFMT     E DSSDBANKPD
      *
      ** Base rates
      *
     IBRFMT     E DSSDBSRTPD
      *
      ** Ccy
      *
     ICYFMT     E DSSDCURRPD
      ** RE tran types
     ITTFMT     E DSSDRETRPD
      *
      ** Constants
      *
     I              '0123456789'          C         DIGITS
     I              '<........>'          C         CREPS
      *
      ** Global values
      *
     C           *ENTRY    PLIST
     C                     PARM           WMODE   7
      *
     C                     EXSR INIT
      *
     C           *IN03     DOUEQ'1'
      *
     C                     Z-ADD1         STRSET  20
     C                     Z-ADD2         ENDSET  20
      *
      ** Display account prompt details
      *
     C           W0PRTP    DOWEQ'PROMPT'
     C                     EXSR PROMPT
     C           *IN03     CABEQ'1'       ENDHRE
     C                     ENDDO
      *
      ** Validate account prompt details
      *
     C           W0PRTP    DOWEQ'VALPMT'
     C                     EXSR VALPMT
     C                     ENDDO
      *
      * Display default subfile
      *
     C           W0PRTP    DOWEQ'DEFAULTS'
     C                     EXSR DFTS
     C           *IN03     CABEQ'1'       ENDHRE
     C                     ENDDO
      *
      ** Validate default
      *
     C           W0PRTP    DOWEQ'VLDFTS'
     C                     EXSR VLDFTS
     C                     ENDDO
      *
      ** Display and validate period details
      *
     C           W0PRTP    DOWEQ'SPECIFIC'
     C                     EXSR DETAIL
     C           *IN03     CABEQ'1'       ENDHRE
     C           PRTCD     CABEQ'*CALL'   ENDHRE
     C                     ENDDO
      *
      ** Commit changes if called from RTS menu and confirmation
      ** acknowledged, otherwise rollback
      *
     C           W0PRTP    IFEQ 'COMMIT  '
     C                     EXSR COMMIT
     C                     ENDIF
      *
     C                     ENDDO
      *
     C           ENDHRE    TAG
     C           *IN03     IFEQ '1'
     C                     ROLBK
     C                     MOVEL'*EXIT'   WMODE     P
     C                     END
      *
     C           *IN12     IFEQ '1'
     C                     MOVEL'*PREV'   WMODE     P
     C                     END
      *
     C                     MOVEL'*FREE   'PMODE
     C                     CALL 'RE4010U' PLIST1
     C                     FREE 'RE4010U'              41
      *
     C                     SETON                     LR
      *****************************************************************
      *                                                               *
      *  COMMIT                                                       *
      *                                                               *
      *****************************************************************
     C           COMMIT    BEGSR
      *
     C                     MOVE ' '       CONFIR
     C           *IN12     IFEQ '1'
     C           *IN03     OREQ '1'
     C           WMODE     IFEQ '*INDEP'
     C                     ROLBK
     C                     ENDIF
     C                     MOVEL'SPECIFIC'W0PRTP  8
     C                     SETOF                     12
     C                     ELSE
     C           WMODE     IFEQ '*INDEP'
     C                     COMIT
     C                     MOVEL'PROMPT  'W0PRTP  8
     C                     ENDIF
     C                     ENDIF
      *
     C                     CALL 'ZA0250'                                                    AR945681
      *                                                                                     AR945681
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  PROMPT                                                       *
      *                                                               *
      *****************************************************************
     C           PROMPT    BEGSR
      *
      ** IF F12 (or start) then refresh prompts
     C           *IN12     IFEQ '1'
     C                     EXSR RESET
     C                     END
      *
      ** Set failed validation a/c to blanks, as if not passed to program
      *
     C                     WRITERE4003HH
     C                     WRITERE4003F1
     C                     WRITEPMSGCTL
     C                     EXFMTRE4003PP
      *
      ** If action code is blank, then assume action code is A
      *
     C           S1ACTN    IFEQ *BLANKS
     C                     MOVEL'A'       S1ACTN
     C                     ENDIF
      *
      ** Save Action Code passed to program
      *
     C                     MOVELS1ACTN    ZACTN
      *
     C                     CALL 'ZA0250'
      *
      ** Validate prompt details
      *
     C           *IN15     IFEQ '0'
     C           *IN03     ANDEQ'0'
     C                     MOVEL'VALPMT  'W0PRTP
     C                     ENDIF
      *
      ** If F15 pressed from prompt screen, show defaults subfile
      *
     C           *IN15     IFEQ *ON
     C           W0PRTP    ANDEQ'PROMPT  '
     C                     MOVEL'DEFAULTS'W0PRTP
     C                     MOVEL*OFF      *IN15
     C                     END
      *                                                                                     AR935841
      ** Clear Contractrual spreads and signs                                               AR935841
      *                                                                                     AR935841
     C           CRE073    IFEQ 'Y'                                                         AR935841
     C                     MOVE *BLANKS   SDCSP1                                            AR935841
     C                     MOVE *BLANKS   SDCSG1                                            AR935841
     C                     MOVE *BLANKS   SDCSP2                                            AR935841
     C                     MOVE *BLANKS   SDCSG2                                            AR935841
     C                     MOVE *BLANKS   SCCSP1                                            AR935841
     C                     MOVE *BLANKS   SCCSG1                                            AR935841
     C                     MOVE *BLANKS   SCCSP2                                            AR935841
     C                     MOVE *BLANKS   SCCSG2                                            AR935841
     C                     ENDIF                                                            AR935841
      *
     C           EPMT      ENDSR
      *****************************************************************
      *                                                               *
      *  VALPMT                                                       *
      *                                                               *
      *****************************************************************
     C           VALPMT    BEGSR
      *
     C                     EXSR RESET
      *
      ** Check if account number and full account details were both
      ** specified. (After checking Action Code.)
      *
     C           WMODE     IFEQ '*INDEP'
      *
     C           S1ACTN    IFEQ *BLANKS
     C                     SETON                     30
     C                     SETON                     31
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF
     C                     PARM 'TNN0032' P@MSGI
     C                     GOTO EVALP
     C                     ENDIF
      *
      ** Check account
      *
     C                     MOVEL*ALL'*'   ACFMT
     C                     MOVELSBRCA     BRCA
     C                     MOVELSCNUM     CNUM
     C                     MOVELSCCY      CCY
     C                     MOVELSACOD     ACOD
     C                     MOVELSACSQ     ACSQ
     C                     MOVEL*BLANKS   P@RTCD
      *
     C           SBRCA     IFNE *BLANKS
     C           SCNUM     ANDNE*BLANKS
     C           SCCY      ANDNE*BLANKS
     C           SACOD     ANDNE*BLANKS
     C           SACSQ     ANDNE*BLANKS
     C                     SETON                     30
     C                     SETON                     31
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF
     C                     PARM 'TNN0443' P@MSGI
     C                     GOTO EVALP
     C                     END
     C                     END
      *
      ** Check user authorisation
      *
     C           WMODE     IFEQ '*INDEP'
     C           BRCA      ANDNE*BLANKS
     C                     MOVELBRCA      ZBR
     C                     CALL 'ZVACTBU'
     C                     PARM           ZACTN   1
     C                     PARM           ZBR     3
     C                     PARM           ERR     10
     C           ERR       IFEQ 1
     C           ERR       OREQ 2
     C                     SETON                     30
     C                     SETON                     31
      *
      ** User is not authorised to this action for the branch of the account
      ** /MSGID TNN0407GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0407' P@MSGI 10
     C                     GOTO EVALP
     C                     END
     C                     END
      *
      ** Set full account details into prompt details
      *
     C                     MOVELBRCA      SBRCA
     C                     MOVE CNUM      SCNUM
     C                     MOVELCCY       SCCY
     C           ACOD      IFNE 0
     C                     MOVE ACOD      SACOD
     C                     ELSE
     C                     MOVE *BLANKS   SACOD
     C                     END
     C           ACSQ      IFNE 0
     C                     MOVE ACSQ      SACSQ
     C                     ELSE
     C                     MOVE *BLANKS   SACSQ
     C                     END
      *
      ** Get extra details from valid account
      *
     C           *IN30     IFEQ '0'
     C                     CALL 'AOCURRR0'
     C                     PARM *BLANKS   P@RTCD  7
     C                     PARM '*KEY'    P@OPTN  7
     C                     PARM SCCY      P@K101  3
     C           CYFMT     PARM           P@FMT
     C                     END
      *
      ** Capture account details for screen
      *
     C           SBRCA     IFGT '   '
     C                     MOVELSBRCA     STEXT     P
     C                     ELSE
     C                     MOVEL'<.>'     STEXT     P
     C                     END
     C           SCNUM     IFNE *BLANKS
     C           STEXT     CAT  SCNUM:0   STEXT
     C                     ELSE
     C           STEXT     CAT  '<....>':0STEXT
     C                     END
     C           SCCY      IFGT '   '
     C           STEXT     CAT  SCCY:0    STEXT
     C                     ELSE
     C           STEXT     CAT  '<.>':0   STEXT
     C                     END
     C           SACOD     IFGT *ALL'0'
     C           STEXT     CAT  SACOD:0   STEXT
     C                     ELSE
     C           STEXT     CAT  CREPS:0   STEXT
     C                     END
     C           SACSQ     IFGT '00'
     C           STEXT     CAT  SACSQ:0   STEXT
     C                     ELSE
     C           STEXT     CAT  '<>':0    STEXT
     C                     END
     C           STEXT     CAT  ANAM:1    STEXT
      *
      ** Get user main key
      *
     C                     MOVELDFTACN    PKEY1
      *
     C           EVALP     TAG
      *
      ** If account is valid go to detail, else go to prompt
      *
     C           *IN30     IFEQ '0'
     C                     MOVEL'SPECIFIC'W0PRTP
     C                     ELSE
     C                     MOVEL'PROMPT  'W0PRTP
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  DFTS                                                         *
      *                                                               *
      *****************************************************************
     C           DFTS      BEGSR
      *
      ** Get selection details if no previous errors
      *
     C           *IN30     IFEQ '0'
      *
      ** Refresh if req'd
      *
     C           *IN05     IFEQ '1'
     C                     SETOF                     99
     C                     SETOF                     05
     C                     MOVELS1POSN    QSPOS1
     C                     MOVEL*BLANKS   WSPOS1
      *
      ** Clear subfile
      *
     C                     Z-ADD0         SRRN    40
     C                     SETON                     80
     C                     SETON                     83
     C                     WRITERE4003C1
     C                     SETOF                     83
     C                     WRITERE4003C1
     C                     SETOF                     80
     C                     SETON                     28
     C                     SETOF                     81
     C                     END
      *
      ** Show records from next position
      *
     C           *IN28     IFEQ '1'
     C                     SETOF                     28
     C                     Z-ADD1         PCOUNT  40
     C                     MOVEL*BLANKS   LLKEY1 24
      *
     C                     MOVEL*ALL'9'   PKEY1  24
     C                     MOVE SRRN      PKEY1
     C                     MOVEL*ALL'8'   PNARR  55
      *
     C                     MOVE *BLANKS   KBRCA
     C           WSBRCA    IFNE '<.>'
     C                     MOVE WSBRCA    KBRCA
     C                     ENDIF
     C                     MOVE *BLANKS   KCNUM
     C           WSCNUM    IFNE *BLANKS
     C           WSCNUM    ANDNE'<....>'
     C                     MOVE WSCNUM    KCNUM
     C                     ENDIF
     C                     MOVE *BLANKS   KCCY
     C           WSCCY     IFNE '<.>'
     C                     MOVE WSCCY     KCCY
     C                     ENDIF
     C                     Z-ADD0         KACOD
     C           WSACOD    IFNE *BLANKS
     C           WSACOD    ANDNE*ALL'0'
     C           WSACOD    ANDNECREPS
     C                     MOVE WSACOD    KACOD
     C                     ENDIF
     C                     Z-ADD0         KACSQ
     C           WSACSQ    IFNE *BLANKS
     C           WSACSQ    ANDNE'<>'
     C                     MOVE WSACSQ    KACSQ
     C                     ENDIF
      *
     C                     MOVE 'XXX'     X2BRCA  3
     C                     MOVE *ALL'9'   X2CNUM  6
     C                     MOVE '999'     X2CCY   3
     C                     Z-ADD*ALL'9'   X2ACOD 100
     C                     Z-ADD99        X2ACSQ  20
      *
     C           RKEY1     SETLLREPRPNL0
     C           PKEY1     DOWLT*HIVAL
     C           PCOUNT    ANDLESFLPAG
     C           *IN99     ANDEQ'0'
      *
     C                     ADD  1         SRRN
      *
      ** Only output 1 record per account key
      *
     C                     READ REPRPNL0                 99
     C                     EXSR CHKQ
     C           E2BRCA    DOWEQX2BRCA
     C           E2CNUM    ANDEQX2CNUM
     C           E2CCY     ANDEQX2CCY
     C           E2ACOD    ANDEQX2ACOD
     C           E2ACSQ    ANDEQX2ACSQ
     C           *IN99     ANDEQ'0'
     C           QKEY      ORNE 'Y'
     C           *IN99     ANDEQ'0'
     C                     READ REPRPNL0                 99
     C                     EXSR CHKQ
     C                     ENDDO
     C                     MOVE E2BRCA    X2BRCA
     C                     MOVE E2CNUM    X2CNUM
     C                     MOVE E2CCY     X2CCY
     C                     Z-ADDE2ACOD    X2ACOD
     C                     Z-ADDE2ACSQ    X2ACSQ
      *
      ** If end of file, then subtract 1 from no of subfile records
      *
     C           *IN99     IFEQ '1'
     C           SRRN      SUB  1         SRRN
     C                     ENDIF
      *
     C           E2BRCA    IFGT '   '
     C                     MOVELE2BRCA    STEXT     P
     C                     ELSE
     C                     MOVEL'<.>'     STEXT     P
     C                     END
      *
     C           E2CNUM    IFNE *BLANKS
     C                     MOVE E2CNUM    SCNUM
     C           STEXT     CAT  SCNUM:0   STEXT
     C                     ELSE
     C           STEXT     CAT  '<....>':0STEXT
     C                     END
      *
     C           E2CCY     IFNE '   '
     C           STEXT     CAT  E2CCY:0   STEXT
     C                     ELSE
     C           STEXT     CAT  '<.>':0   STEXT
     C                     END
      *
     C           E2ACOD    IFGT 0
     C                     MOVE E2ACOD    SACOD
     C           STEXT     CAT  SACOD:0   STEXT
     C                     EXSR INSCR2
     C                     ELSE
     C           STEXT     CAT  CREPS:0   STEXT
     C                     END
      *
     C           E2ACSQ    IFGT 0
     C                     MOVE E2ACSQ    SACSQ
     C           STEXT     CAT  SACSQ:0   STEXT
     C                     ELSE
     C           STEXT     CAT  '<>':0    STEXT
     C                     END
     C                     MOVELSTEXT     PKEY1
      *
      ** Note first rcd
      *
     C           PCOUNT    IFEQ 1
     C                     MOVELPKEY1     WSPOS1 24
     C                     Z-ADDSRRN      S1POSR
     C                     END
      *
      ** Note last rcd
      *
     C           PCOUNT    IFEQ SFLPAG
     C                     MOVELPKEY1     WBPOS1 24
     C                     END
      *
      ** Fill screen
      *
     C                     MOVELPKEY1     S1KEY1
     C                     SETON                     81
     C                     SETOF                     84
     C                     MOVEL*BLANKS   S1ACTN
     C           *IN99     IFEQ '0'
     C                     WRITERE4003S1
     C                     ENDIF
      *
     C                     ADD  1         PCOUNT
     C                     MOVEL*ALL'9'   PKEY1  24
     C                     MOVE SRRN      PKEY1
     C                     MOVEL*ALL'8'   PNARR  55
     C                     END
      *
      ** Identify if following rcds
      *
     C                     SETOF                     82
     C           PKEY1     IFEQ *HIVAL
     C           *IN99     OREQ '1'
     C                     SETON                     82
     C                     END
     C                     END
     C                     END
      *
      ** No records shown
      *
     C           SRRN      IFEQ 0
     C                     SETON                     30
      *
      ** No details to display
      ** /MSGID TNN0379GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0379' P@MSGI 10
      *
      ** Ensure subfile completely cleared
      *
     C                     SETON                     80
     C                     SETON                     83
     C                     WRITERE4003C1
     C                     SETOF                     83
     C                     SETOF                     80
     C                     SETOF                     81
     C                     END
      *
      ** Show selection screen
      *
     C                     WRITERE4003HH
     C                     WRITERE4003F1
     C                     WRITEPMSGCTL
     C                     EXFMTRE4003C1
     C                     CALL 'ZA0250'
     C           *IN03     CABEQ'1'       ENDHRE
      *
     C                     SETOF                     3067
      *
      ** Refresh pressed
      *
     C           *IN05     IFEQ '1'
     C                     MOVEL*BLANKS   S1POSN
     C                     MOVEL*BLANKS   LLPOSN
     C                     END
      *
      ** Enter pressed
      *
     C           *IN05     IFEQ '0'
     C           *IN28     ANDEQ'0'
     C                     MOVEL'VLDFTS  'W0PRTP
     C                     END
      *
      ** New position entered
      *
     C           S1POSN    IFNE LLPOSN
     C           *IN28     ANDEQ'0'
     C                     SETON                     05
     C                     MOVELS1POSN    LLPOSN
     C                     END
      *
      ** Rollup pressed
      *
     C           *IN28     IFEQ '1'
     C           *IN99     ANDEQ'0'
     C                     MOVELWBPOS1    WSPOS1
     C                     END
      *
      ** Toggle pressed
      *
     C           *IN15     IFEQ *ON
     C                     MOVEL'PROMPT  'W0PRTP
     C                     MOVEL*OFF      *IN15
     C                     MOVEL*ON       *IN30
     C                     MOVE *BLANKS   SBRCA
     C                     MOVE *BLANKS   SCNUM
     C                     MOVE *BLANKS   SCCY
     C                     MOVE *BLANKS   SACOD
     C                     MOVE *BLANKS   SACSQ
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  CHKQ                                                         *
      *                                                               *
      *****************************************************************
     C           CHKQ      BEGSR
      *
     C                     MOVE 'Y'       QKEY    1
     C           QSBRCA    IFNE *BLANKS
     C           E2BRCA    ANDNEQSBRCA
     C           QSCNUM    ORNE *BLANKS
     C           E2CNUM    ANDNEQNCNUM
     C           QSCCY     ORNE *BLANKS
     C           E2CCY     ANDNEQSCCY
     C           QSACOD    ORNE *BLANKS
     C           E2ACOD    ANDNEQNACOD
     C           QSACSQ    ORNE *BLANKS
     C           E2ACSQ    ANDNEQNACSQ
     C                     MOVE 'N'       QKEY
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  VLDFTS                                                       *
      *                                                               *
      *****************************************************************
     C           VLDFTS    BEGSR
      *
      ** Save end of subfile pointer
      *
     C                     Z-ADDSRRN      SVSRRN  40
      *
      ** Identify first error record
      *
     C                     Z-ADD-1        ERRRRN  40
      *
      ** Read changed actions
      *
     C                     SETOF                     84
     C                     READCRE4003S1                 72
     C           *IN72     DOWEQ'0'
      *
      ** Increment internal subfile position to last changed record
      *
     C           S1ACTN    IFNE *BLANKS
     C                     Z-ADDSRRN      S1POSR
     C                     END
      *
      ** Check and perform action, if so far so good
      *
     C           S1ACTN    IFNE 'A'
     C           S1ACTN    ANDNE'E'
     C           S1ACTN    ANDNE'D'
     C           S1ACTN    ANDNE' '
     C                     SETON                     30
     C                     SETON                     67
      *
      ** Action must be A, E or D
      ** /MSGID TNN0380GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0380' P@MSGI 10
     C                     END
      *
      ** If action code valid
      *
     C           *IN30     IFEQ '0'
      *
     C                     MOVE S1KEY1    WSPOS1
      *
     C           WSBRCA    IFEQ *BLANKS
     C           WSBRCA    OREQ '<.>'
     C                     MOVE *BLANKS   SBRCA
     C                     ELSE
     C                     MOVE WSBRCA    SBRCA
     C                     ENDIF
      *
     C           WSCNUM    IFEQ *BLANKS
     C           WSCNUM    OREQ '000000'
     C           WSCNUM    OREQ '<....>'
     C                     MOVE *BLANKS   SCNUM
     C                     ELSE
     C                     MOVE WSCNUM    SCNUM
     C                     ENDIF
      *
     C           WSCCY     IFEQ *BLANKS
     C           WSCCY     OREQ '<.>'
     C                     MOVE *BLANKS   SCCY
     C                     ELSE
     C                     MOVE WSCCY     SCCY
     C                     ENDIF
      *
     C           WSACOD    IFEQ *BLANKS
     C           WSACOD    OREQ *ALL'0'
     C           WSACOD    OREQ CREPS
     C                     MOVE *BLANKS   SACOD
     C                     ELSE
     C                     MOVE WSACOD    SACOD
     C                     ENDIF
      *
     C           WSACSQ    IFEQ *BLANKS
     C           WSACSQ    OREQ '00'
     C           WSACSQ    OREQ '<>'
     C                     MOVE *BLANKS   SACSQ
     C                     ELSE
     C                     MOVE WSACSQ    SACSQ
     C                     ENDIF
      *
      ** Validate as if prompted
      *
     C                     EXSR VALPMT
     C                     MOVE S1KEY1    W#KEY1 24
     C                     ENDIF
      *
     C           *IN30     IFEQ '0'
     C           W0PRTP    DOWEQ'SPECIFIC'
     C                     MOVEL'A'       S1ACTN                                              232997
     C                     EXSR DETAIL
     C           *IN03     CABEQ'1'       ENDHRE
     C           PRTCD     CABEQ'*CALL'   ENDHRE
     C                     ENDDO
     C                     EXSR COMMIT
     C                     ENDIF
      *
     C                     MOVE W#KEY1    S1KEY1 24
     C                     MOVE *BLANKS   STEXT
     C                     MOVE *BLANKS   SBRCA
     C                     MOVE *BLANKS   SCNUM
     C                     MOVE *BLANKS   SCCY
     C                     MOVE *BLANKS   SACOD
     C                     MOVE *BLANKS   SACSQ
      *
      ** Action OK
      *
     C           *IN30     IFEQ '0'
     C           S1ACTN    IFEQ 'E'
     C                     MOVEL*BLANKS   S1ACTN
     C                     ENDIF
      *
     C           S1ACTN    IFEQ 'D'
     C                     MOVEL*BLANKS   S1ACTN
     C                     ENDIF
      *
     C           S1ACTN    IFEQ 'A'
     C                     MOVEL*BLANKS   S1ACTN
     C                     ENDIF
     C                     ENDIF
      *
      **  Error occurred
      *
     C           *IN30     IFEQ '1'
     C                     SETON                     84
      *
      ** Note first error to position subfile
      *
     C           ERRRRN    IFEQ -1
     C                     Z-ADDSRRN      ERRRRN
     C                     END
     C                     END
      *
     C                     UPDATRE4003S1
     C                     SETOF                     31
     C                     READCRE4003S1                 72
     C                     END
      *
      ** If error occurred, override internal subfile pos to this rcd
      *
     C           ERRRRN    IFGT 0
     C                     Z-ADDERRRRN    S1POSR
     C                     END
      *
      ** Restore end of subfile pointer
      *
     C                     Z-ADDSVSRRN    SRRN
     C                     MOVEL'DEFAULTS'W0PRTP  8
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  DETAIL                                                       *
      *                                                               *
      *****************************************************************
     C           DETAIL    BEGSR
      *
      ** If enquiry or delete or confirmation screen then display
      **   in non-amend mode
      *
     C           WMODE     IFEQ '*ENQ'
     C           S1ACTN    OREQ 'E'
     C           CONFIR    OREQ 'Y'
     C                     SETON                     70
     C                     ELSE
     C                     SETOF                     70
     C                     END
      *
      ** If delete mode then display confirmation screen
      *
     C                     MOVE ' '       DELETE  1
     C           S1ACTN    IFEQ 'D'
     C           *IN12     ANDNE'1'
     C           *IN03     ANDNE'1'
     C           *IN30     ANDNE'1'
     C           *IN10     OREQ '1'
     C           *IN30     ANDNE'1'
     C                     MOVE 'Y'       CONFIR
     C                     MOVE 'Y'       DELETE
     C                     SETOF                     10
     C                     ENDIF
      *
      ** If confirmation screen, update file details.
      **  show 'press enter', display screen again
      **  in non-amend mode etc.
      *
     C           CONFIR    IFEQ 'Y'
      *
      ** Press enter to continue
      ** /MSGID TNN0430GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0430' P@MSGI 10
      *
      ** display in non-amend mode and remove F7,F8 etc.
      *
     C                     SETON                     70
     C                     SETON                     73
      *
      ** Update file details
      *
     C                     EXSR UPDATE
      *
      **  and set next process to be 'Commit'
      *
     C                     MOVEL'COMMIT  'W0PRTP  8
      *
     C                     ENDIF
      *
      ** Clear and fetch set details, if clean start
      *
     C           REVIEW    IFNE 'Y'
     C           CONFIR    ANDNE'Y'
      *
      ** Fetch all sets for given a/c
      *
     C                     Z-ADD0         TOTSET  20
     C                     MOVE BJRDNB    PDATE
     C                     MOVEL'?'       PRVSID  1
     C           1         DO   26        CURSET  20
     C           CURSET    OCUR NWSETS
      *
      ** After Z, must be blanks
      *
     C           PRVSID    IFEQ 'Z'
     C           NWSETS    ANDNE*BLANKS
     C                     MOVEL*BLANKS   NWSETS
     C                     END
      *
     C           PRVSID    IFNE 'Z'
     C                     EXSR IDSET
     C                     EXSR FETCH
     C           PRTCD     IFEQ '*CALL'
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     MOVELPEVNT     PRVSID
      *
      ** Save old values (for amend)
      *
     C           MAINT     IFEQ '*EXIST'
     C           CURSET    OCUR OLSETS
     C                     MOVELNWSETS    OLSETS
     C                     ELSE
     C                     MOVEL*BLANKS   OLSETS
     C                     END
     C                     END
      *
      ** Count sets
      *
     C           NWSETS    IFGT *BLANKS
     C                     ADD  1         TOTSET
     C                     END
      *
     C                     END
     C                     END
      *
      ** Place 2 sets into screen
      *
     C                     Z-ADDSTRSET    CURSET  20
     C           1         ADD  STRSET    ENDSET
     C           1         DO   2         IX      20
     C           CURSET    OCUR NWSETS
     C                     EXSR PRDSCR
     C                     ADD  1         CURSET
     C                     END
      ** Display main details
      **  Show control fields only when showing first set
      **  in column 1
      *
     C           STRSET    IFEQ 1
     C                     SETOF                     71
     C                     ELSE
     C                     SETON                     71
     C                     END
      *
      **  Show second column only when there are two or more sets
      **   and final set is not shown in column 1
      *
     C           TOTSET    IFGE 2
     C           STRSET    ANDNETOTSET
     C                     SETOF                     72
     C                     ELSE
     C                     SETON                     72
     C                     END
      *
      ** Convert dates to user values
      *
     C           SMDAT1    IFEQ TRMDT2
     C                     MOVEL*ALL'*'   SMDAT1
     C                     ENDIF
     C           SMDAT2    IFEQ TRMDT2
     C                     MOVEL*ALL'*'   SMDAT2
     C                     ENDIF
     C           SMDAT1    IFEQ TRMDAT
     C                     MOVEL*BLANKS   SMDAT1
     C                     ENDIF
     C           SMDAT2    IFEQ TRMDAT
     C                     MOVEL*BLANKS   SMDAT2
     C                     ENDIF
     C           SCEDE1    IFEQ TRMDAT
     C                     MOVEL*BLANKS   SCEDE1
     C                     ENDIF
     C           SCEDE2    IFEQ TRMDAT
     C                     MOVEL*BLANKS   SCEDE2
     C                     ENDIF
     C           SMDAT0    IFEQ TRMDAT
     C                     MOVEL*BLANKS   SMDAT0
     C                     ENDIF
      *
     C                     WRITERE4003HH
     C                     WRITERE4003F2
     C                     WRITEPMSGCTL
     C                     EXFMTRE4003DD
     C                     CALL 'ZA0250'
      *
      ** F10 = Delete pressed
      *
     C           *IN10     IFEQ '1'
      *
     C           PSTAT     IFEQ 'N'
      *
      ** Term & Notice default screen not found in file
      ** /MSGID TNN0432GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0432' P@MSGI 10
     C                     SETON                     30
     C                     MOVEL' '       PSTAT
     C                     END
     C                     END
      *
      ** F12=Cancel pressed
      *
     C           *IN12     IFEQ '1'
     C           CONFIR    IFEQ 'Y'
     C                     MOVE ' '       CONFIR
     C                     MOVE 'Y'       REVIEW
     C                     MOVEL'SPECIFIC'W0PRTP
     C                     SETOF                     73
     C                     ROLBK
     C                     ELSE
     C                     MOVEL'PROMPT  'W0PRTP
     C                     ENDIF
     C                     ENDIF
      *
      ** F3=Exit pressed
      *
     C           *IN03     CABEQ'1'       EDET
      *
      ** Convert termination end date from user values
      *
     C           SMDAT1    IFEQ *ALL'*'
     C                     MOVELTRMDT2    SMDAT1
     C                     ENDIF
     C           SMDAT2    IFEQ *ALL'*'
     C                     MOVELTRMDT2    SMDAT2
     C                     ENDIF
     C           SMDAT1    IFEQ *BLANKS
     C                     MOVELTRMDAT    SMDAT1
     C                     ENDIF
     C           SMDAT2    IFEQ *BLANKS
     C                     MOVELTRMDAT    SMDAT2
     C                     ENDIF
     C           SCEDE1    IFEQ *BLANKS
     C                     MOVELTRMDAT    SCEDE1
     C                     ENDIF
     C           SCEDE2    IFEQ *BLANKS
     C                     MOVELTRMDAT    SCEDE2
     C                     ENDIF
     C           SMDAT0    IFEQ *BLANKS
     C                     MOVELTRMDAT    SMDAT0
     C                     ENDIF
      *
      ** Validate main details or change view
      ** Overlay screen columns onto 2 sets
      *
     C                     Z-ADDSTRSET    CURSET
     C           1         DO   2         IX
     C           CURSET    OCUR NWSETS
     C                     EXSR SCRPRD
     C                     ADD  1         CURSET
     C                     END
      *
      ** Insert pressed
      *
     C           *IN09     IFEQ '1'
     C           WMODE     IFEQ '*ENQ'
     C           S1ACTN    OREQ 'E'
     C                     SETOF                     09
     C                     SETON                     30
      *
      ** Insert not allowed in enquiry mode
      ** /MSGID TNN0312GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0312' P@MSGI 10
     C                     END
      *
     C           TOTSET    IFGE 20
     C                     SETOF                     09
     C                     SETON                     30
      *
      ** Maximum number of periods reached - insert not possible
      ** /MSGID TNN0313GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0313' P@MSGI 10
     C                     END
      *
     C           *IN30     IFNE '1'
     C                     EXSR INSRT
     C                     ENDIF
     C                     ENDIF
      *
      ** If F7=left pressed, change view
      *
     C           *IN07     IFEQ '1'
     C           STRSET    ANDGT1
     C                     SUB  1         STRSET
     C                     SUB  1         ENDSET
     C                     END
      *
      ** If F8=right pressed, change view
      *
     C           *IN08     IFEQ '1'
     C           STRSET    ANDLTTOTSET
     C                     ADD  1         STRSET
     C                     ADD  1         ENDSET
     C                     END
      *
      ** If not F3, F10, or F12, pressed, validate screen
      *
     C           *IN03     IFEQ '0'
     C           *IN10     ANDEQ'0'
     C           *IN12     ANDEQ'0'
     C           *IN30     ANDEQ'0'
      *
      ** Validate details
      *
     C                     EXSR VALDET
      *
     C                     ENDIF
      *
      ** If validation ok (i.e. *IN30 = 0), and not review
      ** and not confirmation screen, or other function
      *
     C           *IN03     IFEQ '0'
     C           *IN07     ANDEQ'0'
     C           *IN08     ANDEQ'0'
     C           *IN09     ANDEQ'0'
     C           *IN12     ANDEQ'0'
     C           *IN30     ANDEQ'0'
     C           CONFIR    ANDEQ*BLANKS
      *
      ** If enquiry then move onto next screen
      *
     C           WMODE     IFEQ '*ENQ'
     C           S1ACTN    OREQ 'E'
     C                     MOVEL'PROMPT  'W0PRTP  8
     C                     ELSE
      *
      ** Before update, show screen in non-amend mode for confirmation
      *
     C                     MOVE 'Y'       CONFIR  1
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** If F6, F7, F8 or F9 pressed, or error,
      ** then redisplay screen
      *
     C           *IN07     IFEQ '1'
     C           *IN08     OREQ '1'
     C           *IN09     OREQ '1'
     C           *IN30     OREQ '1'
     C                     MOVE 'Y'       REVIEW  1
     C                     MOVEL'SPECIFIC'W0PRTP  8
     C                     SETOF                     30
     C                     ENDIF
      *
     C           EDET      TAG
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  IDSET                                                        *
      *                                                               *
      *****************************************************************
     C           IDSET     BEGSR
      *
      ** Set number corresponds to sequential letter of set
      *
     C           PRVSID    IFEQ '?'                                                           254071
     C                     MOVEL'A'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'A'                                                           254071
     C                     MOVEL'B'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'B'                                                           254071
     C                     MOVEL'C'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'C'                                                           254071
     C                     MOVEL'D'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'D'                                                           254071
     C                     MOVEL'E'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'E'                                                           254071
     C                     MOVEL'F'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'F'                                                           254071
     C                     MOVEL'G'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'G'                                                           254071
     C                     MOVEL'H'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'H'                                                           254071
     C                     MOVEL'I'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'I'                                                           254071
     C                     MOVEL'J'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'J'                                                           254071
     C                     MOVEL'K'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'K'                                                           254071
     C                     MOVEL'L'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'L'                                                           254071
     C                     MOVEL'M'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'M'                                                           254071
     C                     MOVEL'N'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'N'                                                           254071
     C                     MOVEL'O'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'O'                                                           254071
     C                     MOVEL'P'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'P'                                                           254071
     C                     MOVEL'Q'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'Q'                                                           254071
     C                     MOVEL'R'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'R'                                                           254071
     C                     MOVEL'S'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'S'                                                           254071
     C                     MOVEL'T'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'T'                                                           254071
     C                     MOVEL'U'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'U'                                                           254071
     C                     MOVEL'V'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'V'                                                           254071
     C                     MOVEL'W'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'W'                                                           254071
     C                     MOVEL'X'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'X'                                                           254071
     C                     MOVEL'Y'       PEVNT
     C                     END
     C           PRVSID    IFEQ 'Y'                                                           254071
     C                     MOVEL'Z'       PEVNT
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  VALDET                                                       *
      *                                                               *
      *****************************************************************
     C           VALDET    BEGSR
      *
     C                     EXSR RESET
      *
      ** First pass
      *
     C                     MOVEL*BLANKS   LPDONE  1
     C                     MOVEL*BLANKS   NTBLNK  1                                           254071
     C                     MOVEL*BLANKS   WSPRT   1                                         AR945681
     C                     MOVEL*BLANKS   WMSG    1                                         AR945681
     C           1         DO   26        CURSET
     C           CURSET    OCUR NWSETS
      *
      ** Advance to next used set
      *
     C           NWSETS    DOUNE*BLANKS
     C           LPDONE    OREQ 'Y'
      *
      ** If all user fields blank, then blank out set
      *
     C           S1NDPD    IFEQ *BLANKS
     C           S1NMPD    ANDEQ*BLANKS
     C           S1FREQ    ANDEQ*BLANKS
     C           S1DRIB    ANDEQ*BLANKS
     C           S1DRIS    ANDEQ*BLANKS
     C           S1DICT    ANDEQ*BLANKS
     C           S1DCST    ANDEQ*BLANKS
     C           S1DRIC    ANDEQ*BLANKS
     C           S1DNIR    ANDEQ*BLANKS
     C           S1DRIF    ANDEQ*BLANKS
     C           S1DACP    ANDEQ*BLANKS
     C           S1DRDY    ANDEQ*BLANKS
     C           S1RTTD    ANDEQ*BLANKS
     C           S1DYBD    ANDEQ*BLANKS
     C           S1CRIS    ANDEQ*BLANKS
     C           S1CICT    ANDEQ*BLANKS
     C           S1CCST    ANDEQ*BLANKS
     C           S1CRIC    ANDEQ*BLANKS
     C           S1CNIR    ANDEQ*BLANKS
     C           S1CRIF    ANDEQ*BLANKS
     C           S1CACP    ANDEQ*BLANKS
     C           S1CRDY    ANDEQ*BLANKS
     C           S1RTTC    ANDEQ*BLANKS
     C           S1DYBC    ANDEQ*BLANKS
     C           S1DRST    ANDEQ*BLANKS
     C           S1CRST    ANDEQ*BLANKS
     C           S1DCSP    ANDEQ*BLANKS                                                       CRE073
     C           S1DCSG    ANDEQ*BLANKS                                                       CRE073
     C           S1DRMT    ANDEQ*BLANKS                                                       CRE073
     C           S1DRFD    ANDEQ*BLANKS                                                       CRE073
     C           S1CCSP    ANDEQ*BLANKS                                                       CRE073
     C           S1CCSG    ANDEQ*BLANKS                                                       CRE073
     C           S1CRMT    ANDEQ*BLANKS                                                       CRE073
     C           S1CRFD    ANDEQ*BLANKS                                                       CRE073
     C                     MOVEL*BLANKS   NWSETS
     C                     ELSE                                                               254071
     C                     MOVEL'Y'       NTBLNK                                              254071
     C                     END
      *
      ** Shuffle next set down if current set is blank
      *
     C           NWSETS    IFEQ *BLANKS
     C           LPDONE    ANDNE'Y'
     C                     Z-ADDCURSET    TMPSET  30
     C           TMPSET    DOUEQ26
     C           NWSETS    ORNE *BLANKS
     C                     ADD  1         TMPSET
     C           TMPSET    OCUR NWSETS
     C                     MOVELNWSETS    W256A 256
     C           CURSET    OCUR NWSETS
     C                     MOVELW256A     NWSETS
     C                     END
      *
      **   (If shuffle failed to find a valid set, put dummy one in)
      *
     C           TMPSET    IFEQ 26
     C           NWSETS    ANDEQ*BLANKS
     C           NTBLNK    IFNE 'Y'                                                           254071
     C                     MOVELSTPRDI    S1TPRD
     C                     MOVEL'Z'       S1EVNT
     C                     MOVELTRMDAT    S1CEDE
     C                     ENDIF                                                              254071
     C                     MOVE 'Y'       LPDONE                                              254071
     C                     END
     C                     END
     C           S1EVNT    IFEQ 'Z'                                                           254071
     C                     MOVELTRMDAT    S1CEDE                                              254071
     C                     ENDIF                                                              254071
     C                     END
      *
      ** Ensure all sets after last set are blank
      *
     C           NWSETS    IFNE *BLANKS
     C           LPDONE    ANDEQ'Y'
     C                     MOVEL*BLANKS   NWSETS
     C                     END
      *
      ** Find last used set
      *
     C           S1TPRD    IFEQ 'T'
     C           S1EVNT    ANDNE'Z'
     C           S1CEDE    ANDEQTRMDAT
     C                     MOVEL'Z'       S1EVNT
     C                     END
      *
     C           S1TPRD    IFEQ 'N'
     C           CURSET    ANDEQ1
     C           S1CEDE    ANDEQTRMDAT
     C                     MOVEL'A'       S1EVNT
     C                     MOVEL'T'       S1TPRD
     C                     MOVELTRMDAT    SMDAT0
     C                     END
      *
     C           S1CEDE    IFEQ TRMDAT
     C                     MOVEL'Y'       LPDONE
     C           CURSET    IFEQ 1
     C                     MOVEL'T'       STPRDI
     C                     END
     C                     END
      *
     C                     END
      *
      ** Validate all sets (even those not on screen)
      *
     C           1         DO   26        CURSET
     C           CURSET    OCUR NWSETS
      *
     C           NWSETS    IFNE *BLANKS
      *
     C                     Z-ADD0         IX
     C           CURSET    IFEQ STRSET
     C                     Z-ADD1         IX
     C                     END
      *
     C           CURSET    IFEQ ENDSET
     C                     Z-ADD2         IX
     C                     END
      *
      ** Syntax validation for common details
      *
     C           CURSET    IFEQ 1
      *
      **  Type of period
      *
     C           STPRDI    IFNE 'T'
     C           STPRDI    ANDNE'N'
     C                     SETON                     30
     C                     SETON                     32
      *
      ** Period Type must be T or N (for Term or Notice)
      ** /MSGID TNN0314GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0314' P@MSGI 10
     C                     END
      *
      ** Roll amount type
      *
     C           SIRLI     IFNE 'F'
     C           SIRLI     ANDNE'P'
     C                     SETON                     30
     C                     SETON                     64
      *
      ** Amount Type must be F or P (for Full or Principal)
      ** /MSGID TNN0315GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0315' P@MSGI 10
     C                     END
      *
      ** Next date/ Roll date
      ** Blanks only for default a/c
      *
     C           SMDAT0    IFEQ *BLANKS
     C           MAINT     ANDNE'*DFT'
     C           TOTSET    ANDGT1
     C                     SETON                     30
     C                     SETON                     33
      *
      ** Next Date must be non-blank for an account (existing or new)
      ** /MSGID TNN0316GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0316' P@MSGI 10
     C                     END
      *
      ** Valid date
      *
     C           SMDAT0    IFNE *BLANKS
     C                     MOVE SMDAT0    ZDATE
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM BJDFIN    ZDATFM  1
     C                     PARM 0         ZDAYNO  50
     C           ZERR      IFNE *BLANKS
     C           ZDAYNO    ORLT BJRDNB
     C                     SETON                     30
     C                     SETON                     33
      *
      ** Next Date must be a valid date on or after run date, when non-blank
      ** /MSGID TNN0317GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0317' P@MSGI 10
     C                     END
      *
     C                     Z-ADDZDAYNO    SMDATN  50
     C                     END
      *
     C                     MOVELSTPRDI    S1TPRD
     C                     END
      *
      ** Syntax validation for period specific details
      **  Roll days
      *
     C           S1EVNT    IFEQ 'A'
     C           S1EVNT    ANDLT'Z'
      *
      ** Numeric
      *
     C           S1NDPD    IFNE *BLANKS
     C                     MOVE S1NDPD    ZFIELD    P
     C                     Z-ADD3         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C           ZRTN      IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Period Days must be numeric, when non-blank
      ** /MSGID TNN0318GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0318' P@MSGI 10
     C                     ELSE
     C                     MOVE ZAFLD1    S1NDPD
     C                     END
     C                     END
     C                     END
     C           S1EVNT    IFEQ 'Z'
     C           S1NDPD    IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Period Days must be blank for the termination period
      ** /MSGID TNN0319GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0319' P@MSGI 10
     C                     END
     C                     END
      *
      **  Roll months
      *
     C           S1EVNT    IFEQ 'A'
     C           S1EVNT    ANDLT'Z'
      *
      ** Numeric
      *
     C           S1NMPD    IFNE *BLANKS
     C           S1NDPD    IFNE *BLANKS
     C           S1FREQ    ORNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
      *
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Period Months must be blank when Period Days or Frequency are
      ** non-blank
      ** /MSGID TNN0421GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0421' P@MSGI 10
     C                     END
      *
     C                     MOVE S1NMPD    ZFIELD    P
     C                     Z-ADD2         ZADIG
     C                     Z-ADD0         ZADEC
      *
     C                     EXSR NEDIT
      *
     C           ZRTN      IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Period Months must be numeric, when non-blank
      ** /MSGID TNN0422GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0422' P@MSGI 10
     C                     END
     C                     END
     C                     END
      *
     C           S1EVNT    IFEQ 'Z'
     C           S1NMPD    IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Period Months must be blank for the termination period
      ** /MSGID TNN0423GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0423' P@MSGI 10
     C                     END
     C                     END
      *
      **  Roll freq
      *
     C           S1FREQ    IFNE *BLANKS
     C           S1FREQ    ANDNE'M'
     C           S1FREQ    ANDNE'Q'
     C           S1FREQ    ANDNE'X'
     C           S1FREQ    ANDNE'Y'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Roll Frequency must be M, Q, X or Y (when non-blank)
      ** /MSGID TNN0402GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0402' P@MSGI 10
     C                     END
     C           S1EVNT    IFEQ 'Z'
     C           S1FREQ    IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Roll Frequency must be blank for the termination period
      ** /MSGID TNN0322GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0322' P@MSGI 10
     C                     END
     C                     END
      *
      **  Frequency day number
      *
     C           S1FREQ    IFEQ *BLANKS
     C           S1DAYM    ANDNE*BLANKS
     C           S1NMPD    ANDEQ*BLANKS
     C           S1FREQ    OREQ 'D'
     C           S1DAYM    ANDNE*BLANKS
     C           S1FREQ    ORNE *BLANKS
     C           S1FREQ    ANDNE'D'
     C           S1DAYM    ANDEQ*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Day Number is required for Roll Frequency
      ** /MSGID TNN0403GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0403' P@MSGI 10
     C                     END
      *
     C           S1DAYM    IFNE *BLANKS
     C           *IN30     ANDEQ'0'
     C                     MOVE S1DAYM    ZFIELD    P
     C                     Z-ADD2         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C           ZRTN      IFNE *BLANKS
     C           S1DAYM    OREQ '00'
     C           S1DAYM    ORGE '32'
     C           S1DAYM    ANDNE'99'
     C           S1DAYM    OREQ '99'
     C           MAINT     ANDNE'*DFT'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Day Number must range from 01 to 31, or be special value 99 for dft a/c
      ** /MSGID TNN0404GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0404' P@MSGI 10
      *
     C                     END
     C                     MOVE ZAFLD     S1DAYM
     C                     END
      *
     C                     MOVEL*BLANKS   UNTILT  7
     C           CURSET    IFEQ 1
     C                     Z-ADD0         SVDATF  50
     C           S1DAYM    IFNE *BLANKS
     C           MAINT     ANDNE'*DFT'
     C           *IN30     ANDEQ'0'
     C           S1FREQ    IFNE *BLANKS
     C                     MOVE S1DAYM    ZMDAY
      *
     C                     CALL 'ZFRQB5'
     C                     PARM S1FREQ    ZFREQ   1
     C                     PARM SMDATN    ZDAYNO  50
     C                     PARM           ZMDAY   20
     C                     PARM BJLCCY    ZCCY    3
     C                     PARM *BLANKS   ZLOC    3
     C                     PARM 'B'       ZDIREC  1
     C                     PARM *BLANKS   ZRTRN   7
      *
     C           ZDAYNO    ADD  1         SVDATF
     C                     MOVE S1DAYM    ZMDAY
      *
     C                     CALL 'ZFRQB5'
     C                     PARM S1FREQ    ZFREQ   1
     C                     PARM           ZDAYNO  50
     C                     PARM           ZMDAY   20
     C                     PARM BJLCCY    ZCCY    3
     C                     PARM *BLANKS   ZLOC    3
     C                     PARM 'F'       ZDIREC  1
     C                     PARM *BLANKS   ZRTRN   7
      *
     C                     ENDIF
      *
     C           S1NMPD    IFNE *BLANKS
     C                     MOVE *BLANKS   #SDATE
     C                     Z-ADDSMDATN    #SDAYN
     C                     MOVE S1NMPD    #NMTH
     C                     Z-SUB#NMTH     #NMTH
     C                     MOVE S1DAYM    #SDAYM
     C                     EXSR NOMTHS
     C                     MOVE *BLANKS   #SDATE
     C                     Z-ADD#EDAYN    #SDAYN
     C                     MOVE S1NMPD    #NMTH
     C                     MOVE S1DAYM    #SDAYM
     C                     EXSR NOMTHS
     C                     Z-ADD#EDAYN    ZDAYNO
     C                     ENDIF
      *
     C           ZDAYNO    IFNE SMDATN
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Day Number and Roll Frequency must synchronise with Next Date
      ** /MSGID TNN0405GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0405' P@MSGI 10
     C                     END
     C                     MOVE ZAFLD     S1DAYM
     C                     END
     C                     END
      *
      ** Period/Roll until
      ** Blanks/zeros
      *
     C           S1CEDE    IFEQ '000000'
     C           S1CEDE    OREQ *BLANKS
     C                     SETON                     30
     C                     MOVEL'ERROR'   UNTILT
     C           IX        IFEQ 1
     C                     SETON                     65
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     66
     C                     END
      *
      **Until value must not be blank
      **/MSGID TNN0325GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0325' P@MSGI 10
     C                     END
      *
      ** 31/12/44 for termination
      *
     C           MAINT     IFNE '*DFT'                                                        254071
     C           S1EVNT    IFEQ 'Z'
     C           S1CEDE    ANDNETRMDAT
     C                     SETON                     30
     C                     MOVEL'ERROR'   UNTILT
     C           IX        IFEQ 1
     C                     SETON                     65
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     66
     C                     END
      *
      ** Until value must be date=31 DEC 2044 for the termination period
      ** /MSGID TNN0326GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0326' P@MSGI 10
      *
     C                     END
     C                     END                                                                254071
      *
      ** Numeric greater than 0
      *
     C           UNTILT    IFNE 'ERROR'
     C           MAINT     ANDNE'*DFT'                                                        254071
     C                     MOVE S1CEDE    ZFIELD    P
     C                     Z-ADD6         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C           ZRTN      IFNE *BLANKS
     C           ZAFLD     OREQ *ZEROS
     C                     SETON                     30
     C                     MOVEL'ERROR'   UNTILT
     C           IX        IFEQ 1
     C                     SETON                     65
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     66
     C                     END
      *
      ** Until value must be numeric and greater than 0
      ** /MSGID TNN0327GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0327' P@MSGI 10
     C                     END
     C                     END
      *
     ** Determine validation type
      *
     C           UNTILT    IFNE 'ERROR'
     C           MAINT     ANDNE'*DFT'                                                        254071
     C                     MOVE ZAFLD     S1CEDE
     C                     MOVE ZAFLD1    S1CEDT
     C           3         SUBSTS1CEDE:1  W3A     3
     C           W3A       IFEQ '000'
     C                     MOVEL'REPEAT'  UNTILT
     C                     ELSE
     C                     MOVEL'DATE  '  UNTILT
     C                     END
     C                     END
      *
      ** Date
      *
     C           UNTILT    IFEQ 'DATE  '
      *
      ** Reformat to YYYYMMDD for alpha check
      *
     C           2         SUBSTS1CEDE:5  WWYYA   2
     C           BJDFIN    IFEQ 'D'
     C           2         SUBSTS1CEDE:1  WWDDA   2
     C                     ELSE
     C           2         SUBSTS1CEDE:3  WWDDA
     C                     END
     C           BJDFIN    IFEQ 'D'
     C           2         SUBSTS1CEDE:3  WWMMA   2
     C                     ELSE
     C           2         SUBSTS1CEDE:1  WWMMA
     C                     END
     C           WWYYA     IFGE '72'
     C                     MOVEL'19'      WYMDA   8 P
     C                     ELSE
     C                     MOVEL'20'      WYMDA     P
     C                     END
     C           WYMDA     CAT  WWYYA:0   WYMDA
     C           WYMDA     CAT  WWMMA:0   WYMDA
     C           WYMDA     CAT  WWDDA:0   WYMDA
     C           WYMDA     IFGT '20441231'
     C                     MOVEL'ERROR'   UNTILT
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     65
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     66
     C                     END
      *
      ** Until value must be on or before 31 DEC 2044 when a date
      ** /MSGID TNN0328GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0328' P@MSGI 10
     C                     END
     C                     END
      *
      ** OK now to use standard routine
      *
     C           UNTILT    IFEQ 'DATE  '
     C                     MOVE S1VDAT    ZDATE                                               244324
     C                     CALL 'ZDATE1'                                                      244324
     C                     PARM           ZERR    7                                           244324
     C                     PARM           ZDATE   60                                          244324
     C                     PARM BJDFIN    ZDATFM  1                                           244324
     C                     PARM 0         ZDAYNO  50                                          244324
     C                     Z-ADDZDAYNO    ZVALUE  50                                          244324
     C                     MOVE S1CEDE    ZDATE
      *
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM BJDFIN    ZDATFM  1
     C                     PARM 0         ZDAYNO  50
      *
     C           ZERR      IFNE *BLANKS
     C           ZDAYNO    ORLT BJRDNB
     C           ZDAYNO    ORLT ZVALUE                                                        244324
     C           S1EVNT    ORGE 'A'
     C           S1EVNT    ANDLT'Z'
     C           ZDAYNO    ANDGE26664
     C           S1EVNT    OREQ 'Z'
     C           ZDAYNO    ANDNE26664
     C                     MOVEL'ERROR'   UNTILT
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     65
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     66
     C                     END
      *
      ** End of period must be greater than start of period and run date                      244324
      ** /MSGID TNN0329GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0329' P@MSGI 10
     C                     END
     C                     MOVE ZDAYNO    S1CEDN  50
     C                     END
      *
      ** Number <= 999
      *
     C           UNTILT    IFEQ 'REPEAT'
     C                     MOVE S1CEDE    S1CEDN
      *           reformat without leading zeros
     C                     MOVE S1CEDT    S1CEDE
     C                     END
      *
      **  Place default sign
      *
     C           S1DRIS    IFNE *BLANKS
     C           S1SIGD    ANDEQ*BLANKS
     C                     MOVEL'+'       S1SIGD
     C                     END
     C           S1CRIS    IFNE *BLANKS
     C           S1SIGC    ANDEQ*BLANKS
     C                     MOVEL'+'       S1SIGC
     C                     END
      *
      **  DR Base rate
      *
     C           S1DRIB    IFNE *BLANKS
     C           SCCY      IFEQ *BLANKS                                                       232997
     C                     MOVEL'SKK'     WCCY                                                232997
     C                     ELSE                                                               232997
     C                     MOVELSCCY      WCCY                                                232997
     C                     ENDIF                                                              232997
     C                     CALL 'AOBSRTR0'
     C                     PARM *BLANKS   P@RTCD  7
     C                     PARM '*KEY'    P@OPTN  7
     C                     PARM WCCY      P@CYCD  3                                           232997
     C                     PARM S1DRIB    P@BSRC  2
     C           BRFMT     PARM           P@FMT
     C           S1DRIB    IFEQ '? '
     C           S1DRIB    OREQ ' ?'
     C                     SETON                     30
     C           SCCY      IFEQ P@CYCD
     C                     MOVE P@BSRC    S1DRIB
     C                     ELSE
     C                     MOVEL'Curr'    P@RTCD
     C                     ENDIF
     C                     ENDIF
     C           P@RTCD    IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     36
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     37
     C                     END
      *
      ** Debit Base Rate must exist in Standing Data
      ** /MSGID TNN0330GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0330' P@MSGI 10
     C                     END
      *
      * Additional rate checking if called independently from account
      *  maintenance or periodic fixing.                                                      223606
      ** Base rate change cannot be made if earlier than base rate
      **  value date
      *
     C           CURSET    OCUR OLSETS
     C           S1TPRD    IFEQ 'T'                                                           223606
     C           CURSET    ANDEQ1
     C           MAINT     ANDNE'*DFT'
     C           S1DRIB    ANDNES2DRIB
      *
     C                     Z-ADD0         W#VDAT  50
     C           S1VDAT    IFNE *BLANKS
     C                     MOVE S1VDAT    ZDATE
      *
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM           ZDATFM  1
     C                     PARM           ZDAYNO  50
      *
     C                     MOVE ZDAYNO    W#VDAT
     C                     END
      *
     C           WMODE     IFEQ '*INDEP'                                                      223606
     C           S1DNIR    ANDEQ'D'                                                           223606
     C           W#VDAT    ANDLTBAVDRC
     C           IX        IFEQ 1
     C                     SETON                     36
     C                     END
     C                     SETON                     30
      *
      * For daily fixing, base rate change cannot be made if term
      * start is earlier than base rate value date
      */MSGID TNN0435GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0435' P@MSGI 10
     C                     ENDIF
      *
     C           S1DNIR    IFEQ 'P'
     C           W#VDAT    ANDLTBAVDRC
     C                     MOVE S1DRIB    P@BSRT
     C                     CALL 'AOBSHSR0'
     C                     PARM *BLANKS   P@RTCD  7
     C                     PARM '*KEY'    P@OPTN  7
     C                     PARM SCCY      P@CCY   3
     C                     PARM           P@BSRT  20
     C                     PARM W#VDAT    P@DATE  50
     C                     PARM           P@FMT
      *
     C           P@RTCD    IFNE *BLANKS
     C           IX        IFEQ 1
     C                     SETON                     36
     C                     END
     C                     SETON                     30
      *
      ** For periodic fixing, base rate change cannot be made if term
      ** For periodic fixing, base rate change cannot be made if term
      ** start is earlier than earliest historic base rate date
      ** /MSGID TNN0436GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0436' P@MSGI 10
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     END
      *
      **  DR Rate/Spread
      *
     C           S1DRIS    IFNE *BLANKS
     C                     MOVE S1DRIS    ZFIELD    P
     C                     Z-ADD4         ZADIG
     C                     Z-ADD7         ZADEC
     C                     EXSR NEDIT
     C           ZRTN      IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     36
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     37
     C                     END
      *
      ** Debit Rate/Spread must be numeric
      ** /MSGID TNN0331GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0331' P@MSGI 10
     C                     ELSE
     C                     MOVE ZAFLD1    S1DRIS
     C                     END
     C                     END
      *
      **  DR Sign
      *
     C           S1DRIS    IFNE *BLANKS
     C           S1SIGD    IFNE '+'
     C           S1SIGD    ANDNE'-'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     36
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     37
     C                     END
      *
      ** Debit Rate Sign must be + or -
      ** /MSGID TNN0332GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0332' P@MSGI 10
     C                     END
     C                     END
     C           S1DRIS    IFEQ *BLANKS
     C           S1SIGD    ANDNE*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     36
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     37
     C                     END
      *
      *Debit Rate/Spread and Sign must both be blank or both be non-blank
      */MSGID TNN0333GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0333' P@MSGI 10
     C                     END
      *
      **  DR Int type
      *
     C           S1DICT    IFNE *BLANKS
     C           S1DICT    IFNE '01'
     C           S1DICT    ANDNE'02'
     C           S1DICT    ANDNE'03'
     C           S1DICT    ANDNE'04'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     38
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     39
     C                     END
      *
      ** Debit Interest Type must be 01, 02, 03 or 04
      ** /MSGID TNN0334GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0334' P@MSGI 10
     C                     END
     C                     END
      *
      **  DR Int s-type
      *
     C           S1DCST    IFNE *BLANKS
     C           S1DICT    ORNE *BLANKS
      *                                                                                       223606
     C                     Z-ADD0         H2VDAT  50                                          223606
     C           S1VDAT    IFNE *BLANKS                                                       223606
     C                     MOVE S1VDAT    ZDATE                                               223606
     C                     CALL 'ZDATE1'                                                      223606
     C                     PARM           ZERR    7                                           223606
     C                     PARM           ZDATE   60                                          223606
     C                     PARM           ZDATFM  1                                           223606
     C                     PARM           ZDAYNO  50                                          223606
     C                     MOVE ZDAYNO    H2VDAT                                              223606
     C                     END                                                                223606
      *                                                                                       223606
     C                     OPEN REINT
     C           ' '       CAT  S1DICT    HKEY   12 P                                         223606
     C                     CAT  S1DCST:0  HKEY                                                223606
     C           SCCY      IFEQ *BLANKS                                                       232997
     C                     MOVEL'SKK'     WCCY    3                                           232997
     C           HKEY      CAT  WCCY:0    HKEY                                                232997
     C                     ELSE                                                               232997
     C           HKEY      CAT  SCCY:0    HKEY                                                223606
     C                     ENDIF                                                              232997
     C                     MOVE 'D'       HKEY                                                223606
     C           HKEY      CHAINREINT                85                                       223606
     C                     CLOSEREINT
      *                                                                                       223606
     C           *IN85     IFEQ '1'                                                           223606
     C           REVDTC    ORGT H2VDAT                                                        241299
     C           S1DNIR    ANDNE'D'                                                           232997
      *                                                                                       223606
     C           H2KEY     SETGTREINHSL0             85                                       223606
     C           HKEY      REDPEREINHSL0                 85                                   223606
     C           *IN85     IFEQ '1'                                                           223606
     C           S1DCST    OREQ *BLANKS                                                       223606
     C           S1DNIR    ANDNE'D'                                                           228407
      *                                                                                       223606
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     38
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     39
     C                     END
      *
      ** Debit Interest Subtype not valid. (see second level text)                            223606
      ** Either the interest subtype does not exist, or                                       223606
      ** (for a term account) there is no historic record of this interest                    223606
      ** type/subtype at the start date of the term.                                          223606
      ** /MSGID TNN0335GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0335' P@MSGI 10
      *
     C                     END
     C                     END
     C                     ENDIF                                                              223606
      *
      **  DR calc basis
      *
     C           S1DRIC    IFNE '1'
     C           S1DRIC    ANDNE'2'
     C           S1DRIC    ANDNE'3'
     C           S1DRIC    ANDNE'4'
     C           S1DRIC    ANDNE'5'
     C           S1DRIC    ANDNE'6'
     C           S1DRIC    ANDNE'7'
     C           CER016    IFNE 'Y'                                                           CER059
     C           S1DRIC    ORNE '0'                                                           CER059
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     40
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     41
     C                     END
      *
      ** Debit Calculation Basis must be a number from 1 to 7
      ** /MSGID TNN0336GBREUSRMSG
      *
     C           CER016    IFEQ 'Y'                                                           CER059
     C                     MOVEL'TNN0500' P@MSGI 10                                           CER059
     C                     ELSE                                                               CER059
     C                     MOVEL'TNN0336' P@MSGI 10                                           CER059
     C                     ENDIF                                                              CER059
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C**********           PARM 'TNN0336' P@MSGI 10                                           CER059
     C                     PARM           P@MSGI                                              CER059
     C                     ENDIF                                                              CER059
     C                     END
      *
      ** DR int fixing
      ** Valid values
      *
     C           S1DNIR    IFNE 'P'
     C           S1DNIR    ANDNE'D'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     42
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     43
     C                     END
      *
      ** Debit Fixing must be P or D (for Periodic or Daily)
      ** /MSGID TNN0337GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0337' P@MSGI 10
     C                     END
      *
      ** P only with Term a/c and base rate
      *
     C                     MOVELSTPRDI    S1TPRD                                            AR940109
      *                                                                                     AR940109
     C           S1DNIR    IFEQ 'P'
     C           S1TPRD    ANDEQ'N'                                                         AR940109
      *
     C********** S1TPRD    IFEQ 'N'                        B2                               AR940109
     C**********           SETON                       4230                                 AR940109
      *****************************************************************                     AR940109
      **Periodic*fixing*not*valid*for*Notice*account*******************                     AR940109
      **/MSGID*TNN0429GBREUSRMSG***************************************                     AR940109
      *****************************************************************                     AR940109
     C**********           CALL 'ZA0340'                                                    AR940109
     C**********           PARM 'REUSRMSG'P@MSGF 10                                         AR940109
     C**********           PARM 'TNN0429' P@MSGI 10                                         AR940109
     C**********           ELSE                            X2                               AR940109
     C********** S1TPRD    IFEQ 'N'                                                         AR940109
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     42
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     43
     C                     END
      *
      ** Fixing can be periodic only with Term accounts.
      ** /MSGID TNN0425GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0429' P@MSGI 10
     C**********           END                                                              AR940109
     C**********           END                                                              AR940109
     C                     END
      *
      ** DR int capitalisation
      *
     C           S1DRIF    IFNE 'Z'
     C           S1DRIF    ANDNE'M'
     C           S1DRIF    ANDNE'Q'
     C           S1DRIF    ANDNE'X'
     C           S1DRIF    ANDNE'Y'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     44
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     45
     C                     END
      *
      ** Debit Capitalisation must be Z, M, Q, X or Y
      ** /MSGID TNN0339GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0339' P@MSGI 10
     C                     END
      *
      **  DR int capitalisation day+month
      *
     C           S1DRIF    IFEQ 'Z'
     C           S1DRDY    ANDNE*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     44
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     45
     C                     END
      *
      ** Debit Cap Day+month must blanks, where Capitalisation is Z
      ** /MSGID TNN0408GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0408' P@MSGI 10
     C                     END
      *
     C           S1DRIF    IFNE 'Z'
     C           S1DRDY    ANDEQ*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     44
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     45
     C                     END
      *
      ** Debit Cap Day+month must non-blank, where Capitalisation is not Z
      ** /MSGID TNN0409GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0409' P@MSGI 10
     C                     END
      *
     C           S1DRDY    IFNE *BLANKS
     C           *IN30     ANDEQ'0'
     C                     MOVEL*BLANKS   I#FLD
     C                     MOVELS1DRDY    I#FLD  35
     C           DIGITS    CHECKI#FLD     Y#      30     90
     C           *IN90     IFEQ '1'
     C           Y#        ANDLE4
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     44
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     45
     C                     END
      *
      ** Debit Cap Day+month must be formed as DDMM (invalid characters)
      ** /MSGID TNN0410GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0410' P@MSGI 10
     C                     END
     C                     END
      *
     C           S1DRDY    IFNE *BLANKS
     C           *IN30     ANDEQ'0'
     C                     MOVELS1DRDY    W2N1    20
     C                     MOVE S1DRDY    W2N2    20
     C           W2N1      IFEQ 00
     C           W2N1      ORGE 32
     C           W2N2      OREQ 00
     C           W2N2      ORGE 13
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     44
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     45
     C                     END
      *
      ** Debit Cap Day+month must be formed as DDMM (invalid range)
      ** /MSGID TNN0411GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0411' P@MSGI 10
     C                     END
     C                     END
      *
      **  DR alt a/c
      *
     C           S1DACP    IFNE *BLANKS
     C           8         SUBSTS1DACP:11 TESTRT  8
     C           TESTRT    IFNE *BLANKS
     C           3         SUBSTS1DACP:1  W8BRCA  3
     C           6         SUBSTS1DACP:4  W8CNUM  6
     C           3         SUBSTS1DACP:10 W8CCY   3
     C           10        SUBSTS1DACP:13 W8ACOD 10
     C           2         SUBSTS1DACP:23 W8ACSQ  2
     C                     CALL 'AOACCTR0'
     C                     PARM           P@RTCD  7
     C                     PARM '*KEY'    P@OPTN  7
     C                     PARM *BLANKS   P@RETL 10
     C                     PARM W8CNUM    P@CNUM  6
     C                     PARM W8CCY     P@CUCD  3
     C                     PARM W8ACOD    P@ACCD 10
     C                     PARM W8ACSQ    P@ACSQ  2
     C                     PARM W8BRCA    P@BRCA  3
     C           ACFMT     PARM *BLANKS   P@FMT
     C                     ELSE
     C                     MOVELS1DACP    SNDACP 100P
     C           SNDACP    CHAINACNUM                97
     C                     END
     C           ACFMT     IFEQ *BLANKS
     C           P@RTCD    ORNE *BLANKS
     C           *IN97     OREQ '1'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     46
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     47
     C                     END
      *
      ** Debit Alternative A/c is not valid
      ** /MSGID TNN0340GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0340' P@MSGI 10
      *
     C                     END
     C                     END
      *
      ** DR penalty type
      ** Not valid for termination
      *
     C           S1RTTD    IFNE *BLANKS
     C           S1EVNT    ANDEQ'Z'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     48
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     49
     C                     END
      *
      ** Debit Penalty Type must be blank for the termination period
      ** /MSGID TNN0341GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0341' P@MSGI 10
     C                     END
      ** Must exist as tran type
     C           S1RTTD    IFNE *BLANKS
     C           S1EVNT    ANDNE'Z'
     C                     CALL 'AORETRR0'
     C                     PARM *BLANKS   P@RTCD  7
     C                     PARM '*VERIFY' P@OPTN  7
     C                     PARM S1RTTD    P@RTTY  5
     C           TTFMT     PARM           P@FMT
     C           S1RTTD    IFEQ '?    '
     C                     MOVE P@RTTY    S1RTTD
     C                     END
     C           P@RTCD    IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     48
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     49
     C                     END
      *
      ** Debit Penalty Type must exist in Standing Data
      ** /MSGID TNN0342GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0342' P@MSGI 10
     C                     END
     C                     END
      *
      **  DR pen time basis
      *
     C           S1RTTD    IFEQ *BLANKS
     C           S1DYBD    ANDNE*BLANKS
     C           S1RTTD    ORNE *BLANKS
     C           S1DYBD    ANDNE'D'
     C           S1DYBD    ANDNE'S'
     C           S1DYBD    ANDNE'M'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     48
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     49
     C                     END
      *
      ** Debit Penalty Time must be D, M or S, where Penalty Type is non-blank
      ** /MSGID TNN0343GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0343' P@MSGI 10
     C                     END
      *
      ** Not valid for termination
      *
     C           S1DYBD    IFNE *BLANKS
     C           S1EVNT    ANDEQ'Z'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     48
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     49
     C                     END
      *
      ** Debit Penalty Time must be blank for the termination period
      ** /MSGID TNN0344GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0344' P@MSGI 10
     C                     END
      *
      **  DR penalty restriction
      *
     C           S1DRST    IFNE *BLANKS
     C           S1EVNT    ANDEQ'Z'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     48
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     49
     C                     END
      *
      ** Debit Penalty Restriction must be blank for the termination period
      ** /MSGID TNN0345GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0345' P@MSGI 10
     C                     END
      *
     C           S1EVNT    IFNE 'Z'
     C           S1DRST    IFNE 'N'
     C           S1DRST    ANDNE'I'
     C           S1RTTD    ANDNE*BLANKS
     C           S1DRST    ORNE *BLANKS
     C           S1RTTD    ANDEQ*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     48
     C                     END
      *
     C           IX        IFEQ 2
     C                     SETON                     49
     C                     END
      *
      ** Debit Penalty Restriction must be N or I (for None or Interest)
      ** /MSGID TNN0346GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0346' P@MSGI 10
      *
     C                     END
     C                     END
      *
      **  CR Base rate
      *
     C           S1CRIB    IFNE *BLANKS
     C           SCCY      IFEQ *BLANKS                                                       232997
     C                     MOVEL'SKK'     WCCY                                                232997
     C                     ELSE                                                               232997
     C                     MOVELSCCY      WCCY                                                232997
     C                     ENDIF                                                              232997
      *
     C                     CALL 'AOBSRTR0'
     C                     PARM *BLANKS   P@RTCD  7
     C                     PARM '*KEY'    P@OPTN  7
     C                     PARM WCCY      P@CYCD  3                                           232997
     C                     PARM S1CRIB    P@BSRC  2
     C           BRFMT     PARM           P@FMT
      *
     C           S1CRIB    IFEQ '? '
     C           S1CRIB    OREQ ' ?'
     C                     SETON                     30
     C           SCCY      IFEQ P@CYCD
     C                     MOVE P@BSRC    S1CRIB
     C                     ELSE
     C                     MOVEL'Curr'    P@RTCD
     C                     ENDIF
     C                     ENDIF
     C           P@RTCD    IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     50
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     51
     C                     END
      *
      ** Credit Base Rate must exist in Standing Data
      ** /MSGID TNN0347GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0347' P@MSGI 10
     C                     END
      *
      ** Additional rate checking if called independently from account
      ** maintenance or periodic fixing
      ** Base rate change cannot be made if earlier than base rate
      ** value date
      *
     C           CURSET    OCUR OLSETS
     C           S1TPRD    IFEQ 'T'
     C           CURSET    ANDEQ1
     C           MAINT     ANDNE'*DFT'
     C           S1CRIB    ANDNES2CRIB
     C                     Z-ADD0         W#VDAT  50
     C           S1VDAT    IFNE *BLANKS
     C                     MOVE S1VDAT    ZDATE
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM           ZDATFM  1
     C                     PARM           ZDAYNO  50
     C                     MOVE ZDAYNO    W#VDAT
     C                     END
     C           WMODE     IFEQ '*INDEP'                                                      223606
     C           S1CNIR    ANDEQ'D'                                                           223606
     C           W#VDAT    ANDLTBAVDRC
     C           IX        IFEQ 1
     C                     SETON                     50
     C                     END
     C                     SETON                     30
      *
      ** For daily fixing, base rate change cannot be made if term
      ** start is earlier than base rate value date
      ** /MSGID TNN0435GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0435' P@MSGI 10
     C                     ENDIF
      *
     C           S1CNIR    IFEQ 'P'
     C           W#VDAT    ANDLTBAVDRC
     C                     MOVE S1CRIB    P@BSRT
      *
     C                     CALL 'AOBSHSR0'
     C                     PARM *BLANKS   P@RTCD  7
     C                     PARM '*KEY'    P@OPTN  7
     C                     PARM SCCY      P@CCY   3
     C                     PARM           P@BSRT  20
     C                     PARM W#VDAT    P@DATE  50
     C                     PARM           P@FMT
      *
     C           P@RTCD    IFNE *BLANKS
     C           IX        IFEQ 1
     C                     SETON                     36
     C                     END
     C                     SETON                     30
      *
      ** For periodic fixing, base rate change cannot be made if term
      ** start is earlier than earliest historic base rate date
      ** /MSGID TNN0436GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0436' P@MSGI 10
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     END
      *
      **  CR Rate/Spread
      *
     C           S1CRIS    IFNE *BLANKS
     C                     MOVE S1CRIS    ZFIELD    P
     C                     Z-ADD4         ZADIG
     C                     Z-ADD7         ZADEC
     C                     EXSR NEDIT
     C           ZRTN      IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     50
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     51
     C                     END
      *
      ** Credit Rate/Spread must be numeric
      ** /MSGID TNN0348GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0348' P@MSGI 10
     C                     ELSE
     C                     MOVE ZAFLD1    S1CRIS
     C                     END
     C                     END
      *
      **  CR Sign
      *
     C           S1CRIS    IFNE *BLANKS
     C           S1SIGC    IFNE '+'
     C           S1SIGC    ANDNE'-'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     50
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     51
     C                     END
      *
      ** Credit Rate Sign must be + or -
      ** /MSGID TNN0349GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0349' P@MSGI 10
      *
     C                     END
     C                     END
     C           S1CRIS    IFEQ *BLANKS
     C           S1SIGC    ANDNE*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     50
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     51
     C                     END
      *
      ** Credit Rate/Spread and Sign must both be blank or both be non-blank
      ** /MSGID TNN0350GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0350' P@MSGI 10
     C                     END
      *                                                                                       CRE073
      **  Interest rate change validation                                                     CRE073
      *                                                                                       CRE073
     C           CRE073    IFEQ 'Y'                                                           CRE073
      *                                                                                       CRE073
      **    DEBIT Interest rate change fields                                                 CRE073
      *                                                                                       CRE073
     C                     MOVE 'Y'       Z@CSPK                                              CRE073
     C                     MOVE 'Y'       Z@CSGK                                              CRE073
     C                     MOVE 'Y'       Z@RMTK                                              CRE073
     C                     MOVE 'Y'       Z@RFDK                                              CRE073
      *                                                                                       CRE073
      **    DR Contractual Spread                                                             CRE073
      *                                                                                       CRE073
     C           S1DCSP    IFNE *BLANKS                                                       CRE073
     C           S1DCSG    ORNE *BLANKS                                                       CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   Z@BSRT                                              CRE073
     C                     MOVE *BLANKS   Z@BSCD                                              CRE073
     C                     MOVE *BLANKS   Z@CSPX 13                                           CRE073
     C                     MOVE *BLANKS   Z@CNSG                                              CRE073
     C                     MOVE S1DRIS    Z@BSRT                                              CRE073
     C                     MOVE S1DRIB    Z@BSCD                                              CRE073
     C                     MOVE S1DCSP    Z@CSPX                                              CRE073
     C                     MOVE S1DCSG    Z@CNSG                                              CRE073
      *                                                                                       CRE073
     C                     MOVE 'AMADDr'  PAMAD   6                                         AR835421
     C                     EXSR SRSPSG                                                        CRE073
      *                                                                                       CRE073
     C                     MOVE Z@CSPX    S1DCSP                                              CRE073
     C                     MOVE Z@CNSG    S1DCSG                                              CRE073
     C                     Z-ADDZ@TCSP    PDCSP                                               CRE073
      *                                                                                       CRE073
     C           Z@CSPK    IFEQ 'N'                                                           CRE073
     C           Z@CSGK    OREQ 'N'                                                           CRE073
     C                     SETON                     30                                       CRE073
     C           IX        IFEQ 1                                                             CRE073
     C                     SETON                     16                                       CRE073
     C                     ENDIF                                                              CRE073
     C           IX        IFEQ 2                                                             CRE073
     C                     SETON                     17                                       CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
      **    DR Rounding Method Fraction/Decimal                                               CRE073
      *                                                                                       CRE073
     C           S1DRMT    IFNE *BLANKS                                                       CRE073
     C           S1DRFD    ORNE *BLANKS                                                       CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   Z@CNSP                                              CRE073
     C                     MOVE *BLANKS   Z@RDMT                                              CRE073
     C                     MOVE *BLANKS   Z@RDFD                                              CRE073
     C                     MOVE S1DCSP    Z@CNSP                                              CRE073
     C                     MOVE S1DRMT    Z@RDMT                                              CRE073
     C                     MOVE S1DRFD    Z@RDFD                                              CRE073
      *                                                                                       CRE073
     C                     EXSR SRRNDM                                                        CRE073
     C                     EXSR SRRNDF                                                        CRE073
      *                                                                                       CRE073
      ** Since zero contractual spread is allowed                                           AR938402
      **  bypass switch on of reverse indicator                                             AR938402
     C           Z@CNSP    IFNE *BLANKS                                                     AR938402
     C           Z@RMTK    IFEQ 'N'                                                           CRE073
     C           Z@RFDK    OREQ 'N'                                                           CRE073
     C                     SETON                     30                                       CRE073
     C           IX        IFEQ 1                                                             CRE073
     C                     SETON                     18                                       CRE073
     C                     ENDIF                                                              CRE073
     C           IX        IFEQ 2                                                             CRE073
     C                     SETON                     19                                       CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                            AR938402
      *                                                                                       CRE073
      *     If all interest rate rounding related fields are valid                            CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   S1DRIS                                              CRE073
     C                     MOVE *BLANKS   S1SIGD                                              CRE073
      *                                                                                       CRE073
     C           Z@CSPK    IFEQ 'Y'                                                           CRE073
     C           Z@CSGK    ANDEQ'Y'                                                           CRE073
     C           Z@RMTK    ANDEQ'Y'                                                           CRE073
     C           Z@RFDK    ANDEQ'Y'                                                           CRE073
      *                                                                                       CRE073
      **      Compute for the new spread rate                                                 CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   Z@RDMT                                              CRE073
     C                     MOVE *BLANKS   Z@RDFD                                              CRE073
     C                     MOVE *BLANKS   Z@BSCD                                              CRE073
     C                     MOVE *BLANKS   Z@CSPX                                              CRE073
     C                     MOVE *BLANKS   Z@CSGX                                              CRE073
     C                     MOVE S1DRMT    Z@RDMT                                              CRE073
     C                     MOVE S1DRFD    Z@RDFD                                              CRE073
     C                     MOVE S1DRIB    Z@BSCD                                              CRE073
     C                     MOVE S1DCSP    Z@CSPX                                              CRE073
     C                     MOVE S1DCSG    Z@CSGX                                              CRE073
      *                                                                                       CRE073
     C                     MOVE 'D'       WDRCR   1                                         AR945681
      *                                                                                     AR945681
     C                     EXSR SRSPRT                                                        CRE073
      *                                                                                       CRE073
     C           IX        IFEQ 1                                                             CRE073
     C           *IN36     ANDEQ*OFF                                                          CRE073
     C           IX        OREQ 2                                                             CRE073
     C           *IN37     ANDEQ*OFF                                                          CRE073
     C           S1DCSP    IFNE *BLANKS                                                       CRE073
     C           S1DCSG    ANDNE*BLANK                                                        CRE073
     C                     MOVE Z@BSRX    S1DRIS                                              CRE073
     C                     MOVE Z@BSGX    S1SIGD                                              CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
      ** Interest rate should be updated for all record(s)                                 AR938402A
      ** especially for not displayed on the screen                                        AR938402A
     C           IX        IFEQ 0                                                          AR938402A
     C           S1DCSP    IFNE *BLANKS                                                    AR938402A
     C           S1DCSG    ANDNE*BLANK                                                     AR938402A
     C                     MOVE Z@BSRX    S1DRIS                                           AR938402A
     C                     MOVE Z@BSGX    S1SIGD                                           AR938402A
     C                     ENDIF                                                           AR938402A
     C                     ENDIF                                                           AR938402A
      *                                                                                    AR938402A
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
      **    CREDIT Interest rate change fields                                                CRE073
      *                                                                                       CRE073
     C                     MOVE 'Y'       Z@CSPK                                              CRE073
     C                     MOVE 'Y'       Z@CSGK                                              CRE073
     C                     MOVE 'Y'       Z@RMTK                                              CRE073
     C                     MOVE 'Y'       Z@RFDK                                              CRE073
      *                                                                                       CRE073
      **    CR Contractual Spread                                                             CRE073
      *                                                                                       CRE073
     C           S1CCSP    IFNE *BLANKS                                                       CRE073
     C           S1CCSG    ORNE *BLANKS                                                       CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   Z@BSRT                                              CRE073
     C                     MOVE *BLANKS   Z@BSCD                                              CRE073
     C                     MOVE *BLANKS   Z@CSPX 13                                           CRE073
     C                     MOVE *BLANKS   Z@CNSG                                              CRE073
     C                     MOVE S1CRIS    Z@BSRT                                              CRE073
     C                     MOVE S1CRIB    Z@BSCD                                              CRE073
     C                     MOVE S1CCSP    Z@CSPX                                              CRE073
     C                     MOVE S1CCSG    Z@CNSG                                              CRE073
      *                                                                                       CRE073
     C                     MOVE 'AMADCr'  PAMAD                                             AR835421
     C                     EXSR SRSPSG                                                        CRE073
      *                                                                                       CRE073
     C                     MOVE Z@CSPX    S1CCSP                                              CRE073
     C                     MOVE Z@CNSG    S1CCSG                                              CRE073
     C                     Z-ADDZ@TCSP    PCCSP                                               CRE073
      *                                                                                       CRE073
      ** Since zero contractual spread is allowed                                           AR938402
      **  bypass switch on of reverse indicator                                             AR938402
     C           Z@CNSP    IFNE *BLANKS                                                     AR938402
     C           Z@CSPK    IFEQ 'N'                                                           CRE073
     C           Z@CSGK    OREQ 'N'                                                           CRE073
     C                     SETON                     30                                       CRE073
     C           IX        IFEQ 1                                                             CRE073
     C                     SETON                     20                                       CRE073
     C                     ENDIF                                                              CRE073
     C           IX        IFEQ 2                                                             CRE073
     C                     SETON                     21                                       CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                            AR938402
      *                                                                                       CRE073
      **    CR Rounding Method Fraction/Decimal                                               CRE073
      *                                                                                       CRE073
     C           S1CRMT    IFNE *BLANKS                                                       CRE073
     C           S1CRFD    ORNE *BLANKS                                                       CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   Z@CNSP                                              CRE073
     C                     MOVE *BLANKS   Z@RDMT                                              CRE073
     C                     MOVE *BLANKS   Z@RDFD                                              CRE073
     C                     MOVE S1CCSP    Z@CNSP                                              CRE073
     C                     MOVE S1CRMT    Z@RDMT                                              CRE073
     C                     MOVE S1CRFD    Z@RDFD                                              CRE073
      *                                                                                       CRE073
     C                     EXSR SRRNDM                                                        CRE073
     C                     EXSR SRRNDF                                                        CRE073
      *                                                                                       CRE073
      ** Since zero contractual spread is allowed                                           AR938402
      **  bypass switch on of reverse indicator                                             AR938402
     C           Z@CNSP    IFNE *BLANKS                                                     AR938402
     C           Z@RMTK    IFEQ 'N'                                                           CRE073
     C           Z@RFDK    OREQ 'N'                                                           CRE073
     C                     SETON                     30                                       CRE073
     C           IX        IFEQ 1                                                             CRE073
     C                     SETON                     22                                       CRE073
     C                     ENDIF                                                              CRE073
     C           IX        IFEQ 2                                                             CRE073
     C                     SETON                     23                                       CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                            AR938402
      *                                                                                       CRE073
      *     If all interest rate rounding related fields are valid                            CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   S1CRIS                                              CRE073
     C                     MOVE *BLANKS   S1SIGC                                              CRE073
      *                                                                                       CRE073
     C           Z@CSPK    IFEQ 'Y'                                                           CRE073
     C           Z@CSGK    ANDEQ'Y'                                                           CRE073
     C           Z@RMTK    ANDEQ'Y'                                                           CRE073
     C           Z@RFDK    ANDEQ'Y'                                                           CRE073
      *                                                                                       CRE073
      **      Compute for the new spread rate                                                 CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   Z@RDMT                                              CRE073
     C                     MOVE *BLANKS   Z@RDFD                                              CRE073
     C                     MOVE *BLANKS   Z@BSCD                                              CRE073
     C                     MOVE *BLANKS   Z@CSPX                                              CRE073
     C                     MOVE *BLANKS   Z@CSGX  1                                           CRE073
     C                     MOVE S1CRMT    Z@RDMT                                              CRE073
     C                     MOVE S1CRFD    Z@RDFD                                              CRE073
     C                     MOVE S1CRIB    Z@BSCD                                              CRE073
     C                     MOVE S1CCSP    Z@CSPX                                              CRE073
     C                     MOVE S1CCSG    Z@CSGX                                              CRE073
      *                                                                                       CRE073
     C                     MOVE 'C'       WDRCR                                             AR945681
      *                                                                                     AR945681
     C                     EXSR SRSPRT                                                        CRE073
      *                                                                                       CRE073
     C           IX        IFEQ 1                                                             CRE073
     C           *IN50     ANDEQ*OFF                                                          CRE073
     C           IX        OREQ 2                                                             CRE073
     C           *IN51     ANDEQ*OFF                                                          CRE073
     C           S1CCSP    IFNE *BLANKS                                                       CRE073
     C           S1CCSG    ANDNE*BLANK                                                        CRE073
     C                     MOVE Z@BSRX    S1CRIS                                              CRE073
     C                     MOVE Z@BSGX    S1SIGC                                              CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
      ** Interest rate should be updated for all record(s)                                 AR938402A
      ** especially for not displayed on the screen                                        AR938402A
     C           IX        IFEQ 0                                                          AR938402A
     C           S1CCSP    IFNE *BLANKS                                                    AR938402A
     C           S1CCSG    ANDNE*BLANK                                                     AR938402A
     C                     MOVE Z@BSRX    S1CRIS                                           AR938402A
     C                     MOVE Z@BSGX    S1SIGC                                           AR938402A
     C                     ENDIF                                                           AR938402A
     C                     ENDIF                                                           AR938402A
      *                                                                                    AR938402A
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     ENDIF                                                              CRE073
      *
      **  CR Int type
      *
     C           S1CICT    IFNE *BLANKS
     C           S1CICT    IFNE '01'
     C           S1CICT    ANDNE'02'
     C           S1CICT    ANDNE'03'
     C           S1CICT    ANDNE'04'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     52
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     53
     C                     END
      *
      ** Credit Interest Type must be 01, 02, 03 or 04
      ** /MSGID TNN0351GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0351' P@MSGI 10
     C                     END
     C                     END
      *
      **  CR Int s-type
      *
     C           S1CCST    IFNE *BLANKS
     C           S1CICT    ORNE *BLANKS
      *                                                                                       223606
     C                     Z-ADD0         H2VDAT  50                                          223606
     C           S1VDAT    IFNE *BLANKS                                                       223606
     C                     MOVE S1VDAT    ZDATE                                               223606
     C                     CALL 'ZDATE1'                                                      223606
     C                     PARM           ZERR    7                                           223606
     C                     PARM           ZDATE   60                                          223606
     C                     PARM           ZDATFM  1                                           223606
     C                     PARM           ZDAYNO  50                                          223606
     C                     MOVE ZDAYNO    H2VDAT                                              223606
     C                     END                                                                223606
      *                                                                                       223606
     C                     OPEN REINT
     C           ' '       CAT  S1CICT    HKEY   12 P                                         223606
     C                     CAT  S1CCST:0  HKEY                                                223606
     C           SCCY      IFEQ *BLANKS                                                       232997
     C                     MOVEL'SKK'     WCCY    3                                           232997
     C           HKEY      CAT  WCCY:0    HKEY                                                232997
     C                     ELSE                                                               232997
     C           HKEY      CAT  SCCY:0    HKEY                                                223606
     C                     ENDIF                                                              232997
     C                     MOVE 'D'       HKEY                                                223606
     C           HKEY      CHAINREINT                85                                       223606
     C                     CLOSEREINT                                                         223606
      *                                                                                       223606
     C           *IN85     IFEQ '1'                                                           223606
     C           REVDTC    ORGT H2VDAT                                                        241299
     C           S1CNIR    ANDNE'D'                                                           228407
      *                                                                                       223606
     C           H2KEY     SETGTREINHSL0             85                                       223606
     C           HKEY      REDPEREINHSL0                 85                                   223606
     C           *IN85     IFEQ '1'
     C           S1CICT    OREQ *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     52
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     53
     C                     END
      *
      ** Credit Interest Subtype not valid. (see second level text)                           223606
      ** Either the interest subtype does not exist, or                                       223606
      ** (for a term account) there is no historic record of this interest                    223606
      ** type/subtype at the start date of the term.                                          223606
      ** /MSGID TNN0352GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0352' P@MSGI 10
      *
     C                     END
     C                     END
     C                     ENDIF                                                              223606
      *
      **  CR calc basis
      *
     C           S1CRIC    IFNE '1'
     C           S1CRIC    ANDNE'2'
     C           S1CRIC    ANDNE'3'
     C           S1CRIC    ANDNE'4'
     C           S1CRIC    ANDNE'5'
     C           S1CRIC    ANDNE'6'
     C           S1CRIC    ANDNE'7'
     C           CER016    IFNE 'Y'                                                           CER059
     C           S1CRIC    ORNE '0'                                                           CER059
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     54
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     55
     C                     END
      *
      ** Credit Calculation Basis must be a number from 1 to 7
      ** /MSGID TNN0353GBREUSRMSG
      *
     C           CER016    IFEQ 'Y'                                                           CER059
     C                     MOVEL'TNN0501' P@MSGI 10                                           CER059
     C                     ELSE                                                               CER059
     C                     MOVEL'TNN0353' P@MSGI 10                                           CER059
     C                     ENDIF                                                              CER059
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C**********           PARM 'TNN0353' P@MSGI 10                                           CER059
     C                     PARM           P@MSGI                                              CER059
     C                     ENDIF                                                              CER059
     C                     END
      *
      **  CR int fixing
      **         (valid values)
      *
     C           S1CNIR    IFNE 'P'
     C           S1CNIR    ANDNE'D'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     56
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     57
     C                     END
      *
      ** Credit Fixing must be P or D (for Periodic or Daily)
      ** /MSGID TNN0354GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0354' P@MSGI 10
     C                     END
      *
      **         (P only with Term a/c and base rate)
      *
     C           S1CNIR    IFEQ 'P'
      *
      ** if EPK041 is SWITCHED ON
      *
     C           S1TPRD    IFEQ 'N'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     56
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     57
     C                     END
      *
      ** Fixing can be periodic only with Term accounts.
      ** /MSGID TNN0425GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0429' P@MSGI 10
     C                     END
     C                     END
      *
      **  CR int capitalisation
      *
     C           S1CRIF    IFNE 'Z'
     C           S1CRIF    ANDNE'M'
     C           S1CRIF    ANDNE'Q'
     C           S1CRIF    ANDNE'X'
     C           S1CRIF    ANDNE'Y'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     58
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     59
     C                     END
      *
      ** Credit Capitalisation must be Z, M, Q, X or Y
      ** /MSGID TNN0356GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0356' P@MSGI 10
      *
     C                     END
      *
      **  CR int capitalisation day+month
      *
     C           S1CRIF    IFEQ 'Z'
     C           S1CRDY    ANDNE*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     58
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     59
     C                     END
      *
      ** Credit Cap Day+month must blanks, where Capitalisation is Z
      ** /MSGID TNN0412GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0412' P@MSGI 10
      *
     C                     END
      *
     C           S1CRIF    IFNE 'Z'
     C           S1CRDY    ANDEQ*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     58
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     59
     C                     END
      *
      ** Credit Cap Day+month must non-blank, where Capitalisation is not Z
      ** /MSGID TNN0413GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0413' P@MSGI 10
      *
     C                     END
      *
     C           S1CRDY    IFNE *BLANKS
     C           *IN30     ANDEQ'0'
     C                     MOVEL*BLANKS   I#FLD
     C                     MOVELS1CRDY    I#FLD  35
     C           DIGITS    CHECKI#FLD     Y#      30     90
     C           *IN90     IFEQ '1'
     C           Y#        ANDLE4
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     44
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     45
     C                     END
      *
      ** Credit Cap Day+month must be formed as DDMM (invalid characters)
      ** /MSGID TNN0414GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0414' P@MSGI 10
     C                     END
     C                     END
      *
     C           S1CRDY    IFNE *BLANKS
     C           *IN30     ANDEQ'0'
     C                     MOVELS1CRDY    W2N1    20
     C                     MOVE S1CRDY    W2N2    20
     C           W2N1      IFEQ 00
     C           W2N1      ORGE 32
     C           W2N2      OREQ 00
     C           W2N2      ORGE 13
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     44
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     45
     C                     END
      *
      ** Credit Cap Day+month must be formed as DDMM (invalid range)
      ** /MSGID TNN0415GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0415' P@MSGI 10
      *
     C                     END
     C                     END
      *
      **  CR alt a/c
      *
     C           S1CACP    IFNE *BLANKS
     C           8         SUBSTS1CACP:11 TESTRT  8
     C           TESTRT    IFNE *BLANKS
     C           3         SUBSTS1CACP:1  W8BRCA  3
     C           6         SUBSTS1CACP:4  W8CNUM  6
     C           3         SUBSTS1CACP:10 W8CCY   3
     C           10        SUBSTS1CACP:13 W8ACOD 10
     C           2         SUBSTS1CACP:23 W8ACSQ  2
      *
     C                     CALL 'AOACCTR0'
     C                     PARM           P@RTCD  7
     C                     PARM '*KEY'    P@OPTN  7
     C                     PARM *BLANKS   P@RETL 10
     C                     PARM W8CNUM    P@CNUM  6
     C                     PARM W8CCY     P@CUCD  3
     C                     PARM W8ACOD    P@ACCD 10
     C                     PARM W8ACSQ    P@ACSQ  2
     C                     PARM W8BRCA    P@BRCA  3
     C           ACFMT     PARM *BLANKS   P@FMT
      *
     C                     ELSE
     C                     MOVELS1CACP    SNCACP 100P
     C           SNCACP    CHAINACNUM                97
     C                     END
     C           ACFMT     IFEQ *BLANKS
     C           P@RTCD    ORNE *BLANKS
     C           *IN97     OREQ '1'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     60
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     61
     C                     END
      *
      ** Credit Alternative A/c is not valid
      ** /MSGID TNN0357GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0357' P@MSGI 10
     C                     END
     C                     END
      *
      ** CR penalty type
      ** Not valid for termination
      *
     C           S1RTTC    IFNE *BLANKS
     C           S1EVNT    ANDEQ'Z'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     62
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     63
     C                     END
      *
      ** Credit Penalty Type must be blank for the termination period
      ** /MSGID TNN0358GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0358' P@MSGI 10
     C                     END
      *
      ** Must exist as tran type
      *
     C           S1RTTC    IFNE *BLANKS
     C           S1EVNT    ANDNE'Z'
     C                     CALL 'AORETRR0'
     C                     PARM *BLANKS   P@RTCD  7
     C                     PARM '*VERIFY' P@OPTN  7
     C                     PARM S1RTTC    P@RTTY  5
     C           TTFMT     PARM           P@FMT
     C           S1RTTC    IFEQ '?    '
     C                     MOVELP@RTTY    S1RTTC
     C                     END
     C           P@RTCD    IFNE *BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     62
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     63
     C                     END
      *
      ** Credit Penalty Type must exist in Standing Data
      ** /MSGID TNN0359GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0359' P@MSGI 10
     C                     END
     C                     END
      *
      **  CR pen time basis
      *
     C           S1RTTC    IFEQ *BLANKS
     C           S1DYBC    ANDNE*BLANKS
     C           S1RTTC    ORNE *BLANKS
     C           S1DYBC    ANDNE'D'
     C           S1DYBC    ANDNE'S'
     C           S1DYBC    ANDNE'M'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     62
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     63
     C                     END
      *
      ** Credit Penalty Time must be D, M or S, where Penalty Type is non-blank
      ** /MSGID TNN0360GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0360' P@MSGI 10
     C                     END
      ** Not valid for termination
     C           S1DYBC    IFNE *BLANKS
     C           S1EVNT    ANDEQ'Z'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     62
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     63
     C                     END
      *
      ** Credit Penalty Time must be blank for the termination period
      ** /MSGID TNN0361GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0361' P@MSGI 10
     C                     END
      *
      ** CR penalty restriction
      *
     C           S1CRST    IFNE *BLANKS
     C           S1EVNT    ANDEQ'Z'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     62
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     63
     C                     END
      *
      ** Credit Penalty Restriction must be blank for the termination period
      ** /MSGID TNN0362GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0362' P@MSGI 10
     C                     END
     C           S1EVNT    IFNE 'Z'
     C           S1CRST    IFNE 'N'
     C           S1CRST    ANDNE'I'
     C           S1RTTC    ANDNE*BLANKS
     C           S1CRST    ORNE *BLANKS
     C           S1RTTC    ANDEQ*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     62
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     63
     C                     END
      *
      ** Credit Penalty Restriction must be N or I (for None or Interest)
      ** /MSGID TNN0363GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0363' P@MSGI 10
     C                     END
     C                     END
     C                     END
     C                     END
      *
      ** Semantic validation (if syntax OK)
      *
     C           *IN30     IFEQ '0'
     C           1         DO   26        CURSET
     C           CURSET    OCUR NWSETS
      *
      ** Find the set of original values
      *
     C           S1EVNT    IFGE 'A'
     C           S1EVNT    ANDLE'Z'
     C                     Z-ADD0         OLDSET  30
     C                     MOVEL*BLANKS   S1OLDA  3
     C           S1EVNT    DOUEQS2EVNT
     C           OLDSET    ORGE 26
     C                     ADD  1         OLDSET
     C           OLDSET    OCUR OLSETS
     C                     END
     C           S1EVNT    IFEQ S2EVNT
     C                     Z-ADDOLDSET    S1OLDS  30
     C                     ELSE
     C                     MOVEL*BLANKS   OLSETS
     C                     END
     C                     END
      *
     C           NWSETS    IFNE *BLANKS
     C                     Z-ADD0         IX
     C           CURSET    IFEQ STRSET
     C                     Z-ADD1         IX
     C                     END
     C           CURSET    IFEQ ENDSET
     C                     Z-ADD2         IX
     C                     END
      *
      **  Roll freq (only for rolling term)
      *
     C           S1FREQ    IFNE *BLANKS
     C           S1TPRD    ANDEQ'N'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** Roll Frequency must be blank for a Notice a/c
      ** /MSGID TNN0364GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0364' P@MSGI 10
     C                     END
      *
      ** One of Roll days or Roll freq or Roll months
      *
     C           S1EVNT    IFNE 'Z'
     C           S1NDPD    ANDEQ*BLANKS
     C           S1NMPD    ANDEQ*BLANKS
     C           S1FREQ    ANDEQ*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** One of Period Days and Roll Frequency and Period months
      ** must be non-blank
      ** /MSGID TNN0424GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0424' P@MSGI 10
     C                     END
      *
      **  Not both freq and roll days
      *
     C           S1FREQ    IFNE *BLANKS
     C           S1NDPD    ANDNE*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     34
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     35
     C                     END
      *
      ** One of Period Days and Roll Frequency must be blank
      ** /MSGID TNN0366GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0366' P@MSGI 10
     C                     END
      *
      ** Next date/ Roll date
      *
     C           CURSET    IFEQ 1
      *
      ** For Notice must same as end date
      *
     C           S1TPRD    IFEQ 'N'
     C           SMDAT0    ANDNES1CEDE
     C           S1CEDE    ANDNETRMDAT
     C                     MOVELS1CEDE    SMDAT0
     C                     END
      *
      ** For Term must be le termination
      *
     C           SMDAT0    IFNE *BLANKS
     C           SMDAT0    ANDNETRMDAT                                                        232019
     C           S1TPRD    ANDEQ'T'
     C           S1EVNT    ANDNE'Z'
     C           S1CEDN    ANDGT999
     C           SMDATN    ANDGTS1CEDN
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     65
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     66
     C                     END
      *
      ** Next Date must not be after Until value, where it is a date
      ** /MSGID TNN0406GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0406' P@MSGI 10
     C                     END
      *
      ** For Term must be non blank for exist/new account
      *
     C           MAINT     IFEQ '*EXIST'
     C           MAINT     OREQ '*NEW'
     C           SMDAT0    IFEQ *BLANKS
     C           S1TPRD    ANDEQ'T'
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     65
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     66
     C                     END
      *
      ** Next Date must be non-blank for a Term a/c
      ** /MSGID TNN0368GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0368' P@MSGI 10
     C                     END
     C                     END
      *
      ** For default, must be blank; note blank dft to maximum date
      *
     C           MAINT     IFEQ '*DFT'
     C           S1TPRD    ANDEQ'T'
     C           SMDAT0    ANDNETRMDAT
     C           MAINT     OREQ '*DFT'
     C           S1TPRD    ANDEQ'N'
     C           SMDAT0    ANDNES1CEDE
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     33
     C                     END
      *
      ** Next Date must be blank for a default
      ** /MSGID TNN0369GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0369' P@MSGI 10
     C                     END
      *
      ** Must be le 31/12/44
      *
     C           MAINT     IFEQ '*EXIST'
     C           MAINT     OREQ '*NEW'
     C           SMDAT0    IFNE *BLANKS
     C           SMDATN    ANDGT26664
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     33
     C                     END
      *
      ** Next Date must be on or before 31 DEC 2044 for an a/c
      ** /MSGID TNN0370GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0370' P@MSGI 10
     C                     END
     C                     END
      *
      **         (must cover run date for term a/c)
      *
     C           MAINT     IFEQ '*EXIST'
     C           MAINT     OREQ '*NEW'
     C           SMDAT0    IFNE *BLANKS
     C           S1TPRD    ANDEQ'T'
     C           S1EVNT    IFEQ 'Z'
     C                     Z-ADD*ALL'9'   W9DATE
     C           SMDATN    IFEQ 26664
     C                     Z-ADD0         W9DATE
     C                     END
     C                     ELSE
     C           S1FREQ    IFEQ *BLANKS
     C           S1NMPD    IFEQ *BLANKS
     C                     MOVE S1NDPD    SWBVAL  50
     C                     ELSE
     C                     Z-ADD0         #SDAYN
     C                     MOVE S1VDAT    #SDATE
     C                     MOVE S1NMPD    #NMTH
     C                     Z-ADD0         #SDAYM
     C           S1DAYM    IFNE *BLANKS
     C                     MOVE S1DAYM    #SDAYM
     C                     ENDIF
     C                     EXSR NOMTHS
     C                     Z-ADD#TERML    SWBVAL
     C                     ENDIF
     C                     ELSE
     C           SMDATN    SUB  SVDATF    SWBVAL
     C                     ADD  1         SWBVAL
     C                     END
     C           SMDATN    SUB  SWBVAL    W9DATE  50
     C                     ADD  1         W9DATE
     C                     END
     C           W9DATE    IFGT BJRDNB
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     33
     C                     SETON                     34
     C                     END
      *
      ** Next Date with Period Days or Roll Frequency must include run date
      ** /MSGID TNN0371GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0371' P@MSGI 10
     C                     END
     C                     END
     C                     END
     C                     END
      *
      ** Period/ Roll until
      ** Until=repeat only for rolling term
      *
     C           UNTILT    IFEQ 'REPEAT'
     C           S1TPRD    ANDEQ'N'
     C                     SETON                     30
     C                     MOVEL'ERROR'   UNTILT
     C           IX        IFEQ 1
     C                     SETON                     65
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     66
     C                     END
      *
      ** Until value must be a date for a Notice a/c
      ** /MSGID TNN0372GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0372' P@MSGI 10
     C                     END
      *
      ** DR Either simple interest or complex, not both
      *
     C           S1DRIB    CAT  S1DRIS    W16A1  16 P
     C           W16A1     CAT  S1SIGD:0  W16A1
     C           S1DICT    CAT  S1DCST    W16A2  16 P
     C           W16A1     IFNE *BLANKS
     C           W16A2     ANDNE*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     36
     C                     SETON                     38
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     37
     C                     SETON                     39
     C                     END
      *
      ** One of DR simple interest or complex interest details must be blank
      ** /MSGID TNN0373GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0373' P@MSGI 10
     C                     END
      *
      **  CR Either simple interest or complex, not both
      *
     C           S1CRIB    CAT  S1CRIS    W16A1  16 P
     C           W16A1     CAT  S1SIGC:0  W16A1
     C           S1CICT    CAT  S1CCST    W16A2  16 P
     C           W16A1     IFNE *BLANKS
     C           W16A2     ANDNE*BLANKS
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     50
     C                     SETON                     52
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     51
     C                     SETON                     53
     C                     END
      *
      ** One of CR simple interest or complex interest details must be blank
      ** /MSGID TNN0374GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0374' P@MSGI 10
     C                     END
      *
      **  Change to DR fixing not allowed
      *
     C           S2DNIR    IFNE *BLANKS
     C           S2DNIR    ANDNES1DNIR
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     42
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     43
     C                     END
      *
      ** A change to DR Fixing is not allowed
      ** /MSGID TNN0375GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0375' P@MSGI 10
     C                     END
      *
      **  Change to CR fixing not allowed
      *
     C           S2CNIR    IFNE *BLANKS
     C           S2CNIR    ANDNES1CNIR
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     56
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     57
     C                     END
      *
      ** A change to CR Fixing is not allowed
      ** /MSGID TNN0376GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0376' P@MSGI 10
     C                     END                                                                223607
      *                                                                                       223607
      ** Get next available date (i.e. first working day of                                   223607
      ** term)                                                                                223607
      *                                                                                       223607
     C                     Z-ADD0         A#VDAT  50                                          223607
     C           S1VDAT    IFNE *BLANKS                                                       223607
     C                     MOVE S1VDAT    ZDATE                                               223607
     C                     CALL 'ZDATE1'                                                      223607
     C                     PARM           ZERR    7                                           223607
     C                     PARM           ZDATE   60                                          223607
     C                     PARM           ZDATFM  1                                           223607
     C                     PARM           ZDAYNO  50                                          223607
     C                     MOVE ZDAYNO    A#VDAT                                              223607
     C                     END                                                                223607
      *                                                                                       223607
     C           A#VDAT    IFGT 0                                                             223607
     C           A#VDAT    SUB  1         ZDAYNO                                              223607
     C                     CALL 'ZFRQB5'                                                      223607
     C                     PARM 'D'       ZFREQ   1                                           223607
     C                     PARM           ZDAYNO  50                                          223607
     C                     PARM 0         ZMDAY   20                                          223607
     C                     PARM BJLCCY    ZCCY    3                                           223607
     C                     PARM *BLANKS   ZLOC    3                                           223607
     C                     PARM 'F'       ZDIREC  1                                           223607
     C                     PARM *BLANKS   ZRTRN   7                                           223607
     C                     END                                                                223607
      *                                                                                       223607
      ** Change to calc basis only allowed on first working day of new term                   223607
      ** for periodic fixing                                                                  223607
      *                                                                                       223607
     C           S1TPRD    IFEQ 'T'                                                           223607
     C           ZDAYNO    ANDNEBJRDNB                                                        223607
     C           CURSET    ANDEQ1                                                             223607
      *
     C           S2DRIC    IFNE *BLANKS
     C           S2DRIC    ANDNES1DRIC
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     40
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     41
     C                     END
      *
      ** A change to DR calc basis only allowed on first working day of new term              223607
      ** /MSGID TNN0377GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0377' P@MSGI 10
     C                     END
      *
      **  Change to CR calc basis not allowed
      *
     C           S2CRIC    IFNE *BLANKS
     C           S2CRIC    ANDNES1CRIC
     C                     SETON                     30
     C           IX        IFEQ 1
     C                     SETON                     54
     C                     END
     C           IX        IFEQ 2
     C                     SETON                     55
     C                     END
      *
      ** A Change to CR calc basis only allowed on first working day of new term              223607
      ** /MSGID TNN0378GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0378' P@MSGI 10
     C                     END
     C                     END
      *
      ** Additional rate checking if called independently from account
      ** maintenance.
      *
     C           CURSET    OCUR OLSETS
     C           WMODE     IFEQ '*INDEP'
     C           S1TPRD    ANDEQ'T'
     C           CURSET    ANDEQ1
     C           MAINT     ANDNE'*DFT'
      *
      ** Rate changes cannot be made if earlier than back value period
      *
     C           S1DRIB    IFNE S2DRIB
     C           S1DRIS    ORNE S2DRIS
     C           S1DICT    ORNE S2DICT
     C           S1DCST    ORNE S2DCST
     C           S1CRIB    ORNE S2CRIB
     C           S1CRIS    ORNE S2CRIS
     C           S1CICT    ORNE S2CICT
     C           S1CCST    ORNE S2CCST
     C           S1BALN    ORNE S2BALN
     C                     Z-ADD0         W#VDAT  50
     C           S1VDAT    IFNE *BLANKS
     C                     MOVE S1VDAT    ZDATE
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM           ZDATFM  1
     C                     PARM           ZDAYNO  50
     C                     MOVE ZDAYNO    W#VDAT
     C                     END
      *
      ** Get back value limit date
      *
     C           BJRDNB    SUB  BJBVPD    WWBKVD  50
     C           W#VDAT    IFLT WWBKVD
     C           IX        IFEQ 1
     C                     SETON                     36
     C                     SETON                     38
     C                     SETON                     50
     C                     SETON                     52
     C                     END
     C                     SETON                     30
      *
      ** Rate changes cannot be made if term start is earlier than
      ** back value period
      ** /MSGID TNN0437GBREUSRMSG
      *
     C                     CALL 'ZA0340'
     C                     PARM 'REUSRMSG'P@MSGF 10
     C                     PARM 'TNN0437' P@MSGI 10
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     END
     C                     END
     C                     END
      *
      ** Submit Errors                                                                        CRE073
      *                                                                                       CRE073
     C           CRE073    IFEQ 'Y'                                                           CRE073
     C           IDX       ANDNE0                                                             CRE073
     C                     Z-ADD1         I                                                   CRE073
     C           IDX       DOWGEI                                                             CRE073
     C           MDAR,I    IFNE *BLANKS                                                       CRE073
     C           WSPRT     ANDEQ*BLANKS                                                     AR945681
     C           '+ '      CAT  MDAR,I    MDAR,I                                              CRE073
     C                     ENDIF                                                              CRE073
     C                     CALL 'ZA0350'                                                      CRE073
     C                     PARM SDMSGF    P@MSGF                                              CRE073
     C                     PARM MIAR,I    P@MSGI                                              CRE073
     C                     PARM MDAR,I    P@MSGD 45                                           CRE073
     C                     ADD  1         I                                                   CRE073
     C                     ENDDO                                                              CRE073
      *                                                                                       CRE073
     C                     MOVEL*BLANKS   FNAR                                                CRE073
     C                     MOVEL*BLANKS   MIAR                                                CRE073
     C                     MOVEL*BLANKS   MDAR                                                CRE073
     C                     Z-ADD0         IDX                                                 CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     ENDSR
      *****************************************************************                       CRE073
      *                                                               *                       CRE073
      *  RESERR - Reset temporary Error fields/msg IDs/msg data       *                       CRE073
      *                                                               *                       CRE073
      *****************************************************************                       CRE073
     C           RESERR    BEGSR                                                              CRE073
      *                                                                                       CRE073
      ** Reset error fields/message IDs/message data (arrays)                                 CRE073
      *                                                                                       CRE073
     C                     MOVEL*BLANKS   FNAX                                                CRE073
     C                     MOVEL*BLANKS   MIAX                                                CRE073
     C                     MOVEL*BLANKS   MDAX                                                CRE073
      *                                                                                       CRE073
     C                     ENDSR                                                              CRE073
      *****************************************************************                       CRE073
      *                                                               *                       CRE073
      *  UPDERR - Update temporary Error fields/msg IDs/msg data      *                       CRE073
      *                                                               *                       CRE073
      *****************************************************************                       CRE073
     C           UPDERR    BEGSR                                                              CRE073
      *                                                                                       CRE073
      ** Update error fields/message IDs/message data (arrays)                                CRE073
      *                                                                                       CRE073
     C                     Z-ADD1         I       30                                          CRE073
     C           *BLANK    LOKUPFNAR,I                   99                                   CRE073
     C           *IN99     IFEQ *ON                                                           CRE073
     C                     MOVEAFNAX      FNAR,I                                              CRE073
     C                     MOVEAMIAX      MIAR,I                                              CRE073
     C                     MOVEAMDAX      MDAR,I                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
      ** Update error index                                                                   CRE073
      *                                                                                       CRE073
     C                     Z-ADD1         I                                                   CRE073
     C           *BLANK    LOKUPFNAR,I                   99                                   CRE073
     C           I         SUB  1         IDX                                                 CRE073
      *                                                                                       CRE073
     C                     ENDSR                                                              CRE073
      *****************************************************************                       CRE073
      *                                                               *                       CRE073
      *  SRSPSG - Validate Contractual Spread and Sign                *                       CRE073
      *                                                               *                       CRE073
      *****************************************************************                       CRE073
     C           SRSPSG    BEGSR                                                              CRE073
      *                                                                                       CRE073
     C                     EXSR RESERR                                                        CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   Z@CNSP                                              CRE073
     C           Z@CSPX    IFNE *BLANKS                                                       CRE073
     C                     MOVE Z@CSPX    ZFIELD    P                                         CRE073
     C                     Z-ADD4         ZADIG                                               CRE073
     C                     Z-ADD7         ZADEC                                               CRE073
     C                     EXSR NEDIT                                                         CRE073
     C           ZRTN      IFNE *BLANKS                                                       CRE073
     C                     MOVE 'ZZZZZZZZ'Z@CNSP                                              CRE073
     C                     ELSE                                                               CRE073
     C                     MOVE ZAFLD1    Z@CNSP                                              CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     CALL 'ZAVCSPSG'                                                    CRE073
      *    Inputs                                                                             CRE073
     C                     PARM *BLANKS   Z@RTCD 10        RetCodeIn                          CRE073
     C                     PARM           Z@BSRT 12        PBaseRate   Current                CRE073
     C                     PARM           Z@BSCD  2        PBaseCode   Current                CRE073
     C                     PARM *ZEROS    Z@FXRT 12        PFixRate                           CRE073
     C                     PARM           Z@CNSP 12        PConSprd    Current                CRE073
     C                     PARM           Z@CNSG  1        PConSign    Currnet                CRE073
      *    Outputs                                                                            CRE073
     C                     PARM           Z@TCSP 117       TMCNSP                             CRE073
     C**********           PARM 'AMADDr'  Z@PMOD  6        PModule                   CRE073 AR835421
     C                     PARM PAMAD     Z@PMOD  6                                         AR835421
     C                     PARM           Z@PCST  20       PCurset                            CRE073
     C                     PARM           FNAX             FldNamXAr                          CRE073
     C                     PARM           MIAX             MsgIDXAr                           CRE073
     C                     PARM           MDAX             MsgDtaXAr                          CRE073
     C                     PARM *ZEROS    IDX     30       Idx                                CRE073
     C                     PARM *BLANKS   Z@CSPK  1        DDCNSPOK                           CRE073
     C                     PARM *BLANKS   Z@CSGK  1        DDCNSGOK                           CRE073
      *                                                                                       CRE073
     C           Z@CSPK    IFNE 'N'                                                           CRE073
     C           Z@CNSP    ANDNE*BLANKS                                                       CRE073
     C                     MOVE *BLANKS   Z@CNSP                                              CRE073
     C           Z@TCSP    MULT 10000000  ZFLD15                                              CRE073
     C                     CALL 'ZSEDIT'                                                      CRE073
     C                     PARM           ZFLD15 150                                          CRE073
     C                     PARM 7         ZDECS   10                                          CRE073
     C                     PARM '3'       ZECODE  1                                           CRE073
     C                     PARM           ZOUT21 21                                           CRE073
     C           14        SUBSTZOUT21:8  Z@CSPX                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     EXSR UPDERR                                                        CRE073
      *                                                                                       CRE073
     C                     ENDSR                                                              CRE073
      *****************************************************************                       CRE073
      *                                                               *                       CRE073
      *  SRRNDM - Validate Rounding Method                            *                       CRE073
      *                                                               *                       CRE073
      *****************************************************************                       CRE073
     C           SRRNDM    BEGSR                                                              CRE073
      *                                                                                       CRE073
     C                     EXSR RESERR                                                        CRE073
      *                                                                                       CRE073
     C                     CALL 'ZAVRNDMT'                                                    CRE073
      *    Inputs                                                                             CRE073
     C                     PARM *BLANKS   Z@RTCD           RetCodeIn                          CRE073
     C                     PARM           Z@RDMT  7        PRoundMth   Current                CRE073
     C                     PARM           Z@CNSP           PConSprd    Current                CRE073
     C                     PARM           Z@RDFD           PFracDec    Current                CRE073
     C                     PARM 'AMADDr'  Z@PMOD           PModule                            CRE073
     C                     PARM           Z@PCST           PCurset                            CRE073
      *    Outputs                                                                            CRE073
     C                     PARM           FNAX             FldNamXAr                          CRE073
     C                     PARM           MIAX             MsgIDXAr                           CRE073
     C                     PARM           MDAX             MsgDtaXAr                          CRE073
     C                     PARM *ZEROS    IDX              Idx                                CRE073
     C                     PARM *BLANK    Z@RMTK  1        DDRDMTOK                           CRE073
      *                                                                                       CRE073
      ** Since zero contractual spread is allowed                                           AR938402
      **  bypass displaying of error message                                                AR938402
     C           Z@CNSP    IFNE *BLANKS                                                     AR938402
     C                     EXSR UPDERR                                                        CRE073
     C                     ENDIF                                                            AR938402
      *                                                                                       CRE073
     C                     ENDSR                                                              CRE073
      *****************************************************************                       CRE073
      *                                                               *                       CRE073
      *  SRRNDF - Validate Fraction/Decimal                           *                       CRE073
      *                                                               *                       CRE073
      *****************************************************************                       CRE073
     C           SRRNDF    BEGSR                                                              CRE073
      *                                                                                       CRE073
     C                     EXSR RESERR                                                        CRE073
      *                                                                                       CRE073
     C                     CALL 'ZAVRNDFD'                                                    CRE073
      *    Inputs                                                                             CRE073
     C                     PARM *BLANKS   Z@RTCD           RetCodeIn                          CRE073
     C                     PARM           Z@RDFD  4        PFracDec      Current              CRE073
     C                     PARM           Z@CNSP           PConSprd      Current              CRE073
     C                     PARM           Z@RDMT           PRoundMth     Current              CRE073
     C                     PARM 'AMADDr'  Z@PMOD           PModule                            CRE073
     C                     PARM           Z@PCST           PCurset                            CRE073
      *    Outputs                                                                            CRE073
     C                     PARM           FNAX             FldNamXAr                          CRE073
     C                     PARM           MIAX             MsgIDXAr                           CRE073
     C                     PARM           MDAX             MsgDtaXAr                          CRE073
     C                     PARM *ZEROS    IDX              Idx                                CRE073
     C                     PARM *BLANKS   Z@RFDK  1        DDRDFDOK                           CRE073
      *                                                                                       CRE073
      ** Since zero contractual spread is allowed                                           AR938402
      **  bypass displaying of error message                                                AR938402
     C           Z@CNSP    IFNE *BLANKS                                                     AR938402
     C                     EXSR UPDERR                                                        CRE073
     C                     ENDIF                                                            AR938402
      *                                                                                       CRE073
     C                     ENDSR                                                              CRE073
      *****************************************************************                       CRE073
      *                                                               *                       CRE073
      *  SRSPRT - Compute for the new spread rate based on the        *                       CRE073
      *           rounding rules                                      *                       CRE073
      *           Calls: ZACALCSPRT                                   *                       CRE073
      *                                                               *                       CRE073
      *****************************************************************                       CRE073
     C           SRSPRT    BEGSR                                                              CRE073
      *                                                                                       CRE073
     C                     EXSR RESERR                                                        CRE073
      *                                                                                       CRE073
     C                     Z-ADD0         Z@BASR                                              CRE073
     C                     CALL 'AOBSRTR0'                                                    CRE073
     C                     PARM *BLANKS   P@RTCD  7                                           CRE073
     C                     PARM '*KEY'    P@OPTN  7                                           CRE073
     C                     PARM WCCY      P@CYCD  3                                           CRE073
     C                     PARM Z@BSCD    P@BSRC  2                                           CRE073
     C           BRFMT     PARM           P@FMT                                               CRE073
     C           P@RTCD    IFEQ *BLANKS                                                       CRE073
     C                     Z-ADDBACBSR    Z@BASR                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     Z-ADD0         Z@CSPD                                              CRE073
     C           Z@CSPX    IFNE *BLANKS                                                       CRE073
     C                     MOVE Z@CSPX    ZFIELD    P                                         CRE073
     C                     Z-ADD4         ZADIG                                               CRE073
     C                     Z-ADD7         ZADEC                                               CRE073
     C                     EXSR NEDIT                                                         CRE073
     C                     MOVE ZAFLD     Z@CSPD                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C                     CALL ZCSPRT                                                        CRE073
      *    Inputs                                                                             CRE073
     C                     PARM *BLANKS   Z@RTCD           PRetCode                           CRE073
     C                     PARM           Z@BASR 117       PBaserate                          CRE073
     C                     PARM           Z@CSPD 117       PConSpread                         CRE073
     C                     PARM           Z@CNSG           PConInd                            CRE073
     C                     PARM           Z@RDMT           PRoundMth                          CRE073
     C                     PARM           Z@RDFD           PFracDeci                          CRE073
      *    Output                                                                             CRE073
     C                     PARM *ZEROS    Z@NSRT 117       PNewSpread                         CRE073
     C                     PARM *ZEROS    Z@FRAT 117                                        AR847249
      *                                                                                       CRE073
      ** Since zero contractual spread is allowed                                           AR938402
      **  bypass *PSSR subroutine                                                           AR938402
     C           Z@CSPD    IFGT 0                                                           AR938402
     C           Z@RTCD    IFNE *BLANKS                                                       CRE073
     C********** Z@FRAT    ORLE 0                                                  AR847249 AR945681
     C********** Z@RDMT    ANDNE*BLANKS                                            AR847249 AR945681
     C                     EXSR *PSSR                                                         CRE073
     C                     ENDIF                                                              CRE073
     C                     ELSE                                                             AR938402
     C                     Z-ADD0         Z@NSRT                                            AR938402
     C                     ENDIF                                                            AR938402
      *                                                                                       CRE073
     C                     MOVEL*BLANKS   Z@BSRX 13                                           CRE073
     C                     MOVEL*BLANKS   Z@BSGX  1                                           CRE073
     C**********           MOVEL'+'       Z@BSGX                                     CRE073 AR739610
     C           Z@NSRT    IFLT 0                                                             CRE073
     C                     Z-SUBZ@NSRT    Z@NSRT                                              CRE073
     C**********           MOVEL'-'       Z@BSGX                                     CRE073 AR739610
     C                     MOVEL'Y'       WMSG                                              AR945681
     C           Z@CNSG    IFEQ '+'                                                         AR945681
     C                     MOVEL'-'       Z@BSGX                                            AR945681
     C                     ELSE                                                             AR945681
     C                     MOVEL'+'       Z@BSGX                                            AR939610
     C                     ENDIF                                                            AR945681
      *                                                                                     AR945681
     C                     ELSE                                                             AR939610
     C                     MOVELZ@CNSG    Z@BSGX                                            AR939610
     C                     ENDIF                                                              CRE073
     C           Z@NSRT    MULT 10000000  ZFLD15                                              CRE073
     C                     CALL 'ZSEDIT'                                                      CRE073
     C                     PARM           ZFLD15 150                                          CRE073
     C                     PARM 7         ZDECS   10                                          CRE073
     C                     PARM '3'       ZECODE  1                                           CRE073
     C                     PARM           ZOUT21 21                                           CRE073
     C           14        SUBSTZOUT21:8  Z@BSRX                                              CRE073
      *                                                                                       CRE073
     C                     EXSR SNDMSG                                                      AR945681
      *                                                                                     AR945681
     C                     EXSR UPDERR                                                        CRE073
      *                                                                                       CRE073
     C                     ENDSR                                                              CRE073
      *****************************************************************                     AR945681
      *                                                               *                     AR945681
      *  SNDMSG - Send error and warning for ZACALCSPRT validation    *                     AR945681
      *                                                               *                     AR945681
      *****************************************************************                     AR945681
     C           SNDMSG    BEGSR                                                            AR945681
      *                                                                                     AR945681
      ***Send*error*when*Final*rate*is*zero                                        AR945681 AR947093
      **********                                                                   AR945681 AR947093
     C********** Z@FRAT    IFLE 0                                                  AR945681 AR947093
     C********** Z@RDMT    ANDNE*BLANKS                                            AR945681 AR947093
     C**********           MOVEL'N'       WSPRT   1                                AR945681 AR947093
     C**********           SETON                     30                            AR945681 AR947093
     C********** WDRCR     IFEQ 'D'                                                AR945681 AR947093
      **********                                                                   AR945681 AR947093
     C********** IX        IFEQ 1                                                  AR945681 AR947093
     C**********           SETON                     18                            AR945681 AR947093
     C**********           ENDIF                                                   AR945681 AR947093
     C********** IX        IFEQ 2                                                  AR945681 AR947093
     C**********           SETON                     19                            AR945681 AR947093
     C**********           ENDIF                                                   AR945681 AR947093
      **********                                                                   AR945681 AR947093
     C**********           ELSE                                                    AR945681 AR947093
     C********** IX        IFEQ 1                                                  AR945681 AR947093
     C**********           SETON                     22                            AR945681 AR947093
     C**********           ENDIF                                                   AR945681 AR947093
     C********** IX        IFEQ 2                                                  AR945681 AR947093
     C**********           SETON                     23                            AR945681 AR947093
     C**********           ENDIF                                                   AR945681 AR947093
      **********                                                                   AR945681 AR947093
     C**********           ENDIF                                                   AR945681 AR947093
      **********                                                                   AR945681 AR947093
     C********** Z@FRAT    MULT 10000000  ZFLD15                                   AR945681 AR947093
     C**********           CALL 'ZSEDIT'                                           AR945681 AR947093
     C**********           PARM           ZFLD15                                   AR945681 AR947093
     C**********           PARM 7         ZDECS                                    AR945681 AR947093
     C**********           PARM '3'       ZECODE                                   AR945681 AR947093
     C**********           PARM           ZOUT21                                   AR945681 AR947093
      **********                                                                   AR945681 AR947093
     C********** 12        SUBSTZOUT21:10 MDAX,1                                   AR945681 AR947093
     C**********           MOVEL'DDRDMT'  FNAX,1                                   AR945681 AR947093
     C**********           MOVEL'USS0015' MIAX,1                                   AR945681 AR947093
     C**********           ENDIF                                                   AR945681 AR947093
      *                                                                                     AR945681
      ** Send warning when Final spread is negative                                         AR945681
      *                                                                                     AR945681
     C           WMSG      IFEQ 'Y'                                                         AR945681
     C           WDRCR     IFEQ 'D'                                                         AR945681
      *                                                                                     AR945681
     C           IX        IFEQ 1                                                           AR945681
     C                     SETON                     16                                     AR945681
     C                     ENDIF                                                            AR945681
     C           IX        IFEQ 2                                                           AR945681
     C                     SETON                     17                                     AR945681
     C                     ENDIF                                                            AR945681
      *                                                                                     AR945681
     C                     ELSE                                                             AR945681
     C           IX        IFEQ 1                                                           AR945681
     C                     SETON                     20                                     AR945681
     C                     ENDIF                                                            AR945681
     C           IX        IFEQ 2                                                           AR945681
     C                     SETON                     21                                     AR945681
     C                     ENDIF                                                            AR945681
      *                                                                                     AR945681
     C                     ENDIF                                                            AR945681
      *                                                                                     AR945681
     C                     MOVEL*BLANKS   WMSG                                              AR945681
     C                     MOVEL'W'       WSPRT                                             AR945681
     C                     MOVE '-'       ZOUT21                                            AR945681
     C                     MOVEL'DDCNSP'  FNAX,1                                            AR945681
     C                     MOVEL'USS0016' MIAX,1                                            AR945681
     C           12        SUBSTZOUT21:10 MDAX,1                                            AR945681
     C                     ENDIF                                                            AR945681
      *                                                                                     AR945681
     C                     ENDSR                                                            AR945681
      *****************************************************************
      *                                                               *
      *  UPDATE                                                       *
      *                                                               *
      *****************************************************************
     C           UPDATE    BEGSR
      *
      ** Update and delete T&N default screen
      *
     C                     MOVEL*BLANKS   WIMOD   5                                           228715
     C           DELETE    IFEQ 'Y'
     C                     MOVE ' '       DELETE
      *
      ** Delete only possible if not called from account maintenance
      *
     C                     MOVEL'*DELT'   WIMOD                                               228715
     C                     MOVEL'*DELT'   PMODE
     C                     CALL 'RE4010U' PLIST1
      *
     C           P@RTCD    IFEQ '*ERROR'
     C           *INU7     OREQ '1'
     C           *INU8     OREQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD1         DBASE
     C                     MOVEL##PGM     DBPGM
     C                     MOVEL'RE4010U 'DBFILE
     C                     MOVEL'*CALL'   DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Else if not delete then update file
      *
     C                     ELSE
      *
      ** If insert, then delete records first, as will need to reorder
      ** them anyway.
      *
     C           INSERT    IFEQ 'Y'
     C                     MOVE ' '       INSERT
     C                     MOVEL'*DELT'   PMODE
     C                     CALL 'RE4010U' PLIST1
     C                     ENDIF
     C                     ENDIF
      *
      ** Send active details, starting from run date
      *
     C                     MOVE BJRDNB    PDATE
     C           1         DO   26        CURSET
     C           CURSET    OCUR NWSETS
     C           NWSETS    IFNE *BLANKS
     C                     EXSR SEND
     C                     EXSR INSCRN
     C                     END
     C                     END
      *
      ** Capitalisation processing
      *
     C           WIMOD     IFNE '*DELT'                                                       228715
     C           1         DO   26        CURSET
     C           CURSET    OCUR NWSETS
     C           NWSETS    IFNE *BLANKS
      *
      ** Move screen details into file
      *
     C                     EXSR FRSCRN
      *
     C                     Z-ADDBJRDNB    P#DATE  50
     C                     MOVE PBRCA     P#BRCA  3
     C                     MOVE PCNUM     P#CNUM  6
     C                     MOVE PCCY      P#CCY   3
     C                     MOVE PACOD     P#ACOD 100
     C                     MOVE PACSQ     P#ACSQ  20
     C                     MOVE PEVNT     P#EVNT  1
     C                     MOVE PITEM     P#ITEM  50
     C                     MOVELWMODE     P#MODE  7
     C                     CALL 'RETNCAP1'
     C                     PARM           P#DATE
     C                     PARM           P#BRCA
     C                     PARM           P#CNUM
     C                     PARM           P#CCY
     C                     PARM           P#ACOD
     C                     PARM           P#ACSQ
     C                     PARM           P#MODE
     C                     PARM           PRTCD
      *
     C           PRTCD     IFEQ '*ERROR'
     C           *INU7     OREQ '1'
     C           *INU8     OREQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD1         DBASE
     C                     MOVEL##PGM     DBPGM
     C                     MOVEL'RE4010U 'DBFILE
     C                     MOVEL'*CALL'   DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     EXSR INSCRN
      *
     C                     ENDIF
     C                     ENDDO
     C                     ENDIF                                                              228715
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  RESET                                                        *
      *                                                               *
      *****************************************************************
     C           RESET     BEGSR
      *
     C                     MOVEL'0'       *IN10
     C                     MOVEL'0'       *IN12
     C                     MOVEL'0'       *IN30
     C                     MOVEA'00000000'*IN,16                                              CRE073
     C                     MOVEA'00000000'*IN,31
     C                     MOVEA'00000000'*IN,39
     C                     MOVEA'00000000'*IN,47
     C                     MOVEA'00000000'*IN,55
     C                     MOVEA'0000'    *IN,63
     C                     MOVEL'0'       *IN73
     C                     MOVEL*BLANKS   P@RTCD
     C                     MOVEL*BLANKS   REVIEW  1
      *
     C                     MOVEL*BLANKS   FNAR                                                CRE073
     C                     MOVEL*BLANKS   MIAR                                                CRE073
     C                     MOVEL*BLANKS   MDAR                                                CRE073
     C                     Z-ADD0         IDX     30                                          CRE073
      *                                                                                       CRE073
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  FETCH                                                        *
      *                                                               *
      *****************************************************************
     C           FETCH     BEGSR
      *
      ** Access P&P details, using given date
      *
     C                     MOVELPEVNT     SVEVNT  1
     C                     MOVEL'*ENQ    'PMODE
     C                     EXSR EXTERN
      *
      ** Move file details into screen
      *
     C                     EXSR INSCRN
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  INSRT - Insert new period                                    *
      *                                                               *
      *****************************************************************
     C           INSRT     BEGSR
      *
     C**********           MOVEL*BLANKS   SVZSET256                                           CRE073
     C                     MOVEL*BLANKS   SVZSET                                              CRE073
     C                     MOVE 'Y'       INSERT  1
     C                     MOVE '?'       PRVSID                                              254071
      *
      ** On insert, need to stop termination rcd (for 1 cycle)
      **  and substitute dummy rcd (provided 1 day can be borrowed)
      *
     C           1         DO   26        CURSET  20
     C           CURSET    OCUR NWSETS
      *                                                                                       236070
     C           S1EVNT    IFEQ 'Z'                                                           236070
     C           S1VDAT    ANDEQ'010141'                                                      236070
     C                     SETOF                     09                                       236070
     C                     SETON                     30                                       236070
      *                                                                                       236070
      ** No room to insert period - see second level text                                     236070
      ** The new period cannot be inserted if start date of final Z period is 01/01/41.       236070
      ** Shorten the length of the other periods (e.g. the A period) so that there is         236070
      ** enough space for the inserted period.                                                236070
      ** /MSGID TNN0440GBREUSRMSG                                                             236070
      *                                                                                       236070
     C                     CALL 'ZA0340'                                                      236070
     C                     PARM 'REUSRMSG'P@MSGF 10                                           236070
     C                     PARM 'TNN0440' P@MSGI 10                                           236070
      *                                                                                       236070
     C                     END                                                                236070
      *                                                                                       236070
     C           S1EVNT    IFEQ 'Z'
     C           CURSET    ANDLT26
     C           S1VDAT    ANDNE'010141'
      *
      ** Capture this termin set before overwriting it with insert values
      *
     C**********           MOVELNWSETS    SVZSET256                                           CRE073
     C                     MOVELNWSETS    SVZSET                                              CRE073
     C                     MOVELS1EVNT    PEVNT
      *
     C                     EXSR IDSET
      *
     C                     MOVELPEVNT     S1EVNT
      *
      ** If 'A' record then use run date as value date
      *
     C           PEVNT     IFEQ 'A'
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     CALL 'ZDATE2'
     C                     PARM           ZDAYNO  50
     C                     PARM           BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
     C                     MOVELZDATE     S1VDAT
     C                     MOVELZDATE     SMDAT0
     C                     ENDIF
      *
      ** Set maturity = value date so there is only 1 day's period
      *
     C                     MOVELS1VDAT    S1MDAT
     C                     MOVELS1VDAT    S1CEDE
     C                     MOVE '1'       S1NDPD
     C                     Z-ADDCURSET    STRSET
     C                     ADD  1         TOTSET
     C                     MOVE S1VDAT    S#VDAT  6
      *
      ** Put back old values for next set
      *
     C                     ADD  1         CURSET
     C           CURSET    OCUR NWSETS
     C                     MOVELSVZSET    NWSETS
      *
      ** Use previous value date + 1
      ** for new value date
      *
     C                     MOVE S#VDAT    ZDATE
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM BJDFIN    ZDATFM  1
     C                     PARM 0         ZDAYNO  50
     C                     ADD  1         ZDAYNO
     C                     CALL 'ZDATE2'
     C                     PARM           ZDAYNO  50
     C                     PARM           BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
      *
     C                     MOVELZDATE     S1VDAT
     C                     ENDIF
      *
     C                     MOVE S1EVNT    PRVSID                                              254071
     C                     ENDDO
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  INSCRN                                                       *
      *                                                               *
      *****************************************************************
     C           INSCRN    BEGSR
      *
      ** Move db fields into screen fields
      **   Details common to all sets, take from first only
      *
     C           CURSET    IFEQ 1
      *
      **    Period type
      *
     C                     MOVELPTPRD     STPRDI
      *
      **    Roll amount type
      *
     C                     MOVELPIRLI     SIRLI
      *
      **    Next maturity
      *
     C           PEVNT     IFEQ 'Z'
     C                     MOVE TRMDAT    SMDAT0
     C                     ELSE
     C                     MOVEL*BLANKS   SMDAT0
     C           PVDAT     IFGT 0
     C           PMDAT     ANDGT0
     C           PMDAT     ANDLT26664
     C                     Z-ADDPMDAT     ZDAYNO
     C                     CALL 'ZDATE2'
     C                     PARM           ZDAYNO  50
     C                     PARM           BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
     C                     MOVELZDATE     SMDAT0
     C                     ENDIF
     C                     ENDIF
      *
      ** Get next available date (i.e. next working date after
      ** maturity, i.e. first working day of new term)
      *
     C                     MOVEL*BLANKS   SAVAL0
     C           PVDAT     IFGT 0
     C           PMDAT     ANDGT0
     C           PMDAT     ANDLT26664
     C                     Z-ADDPMDAT     ZDAYNO
     C                     CALL 'ZFRQB5'
     C                     PARM 'D'       ZFREQ   1
     C                     PARM           ZDAYNO  50
     C                     PARM 0         ZMDAY   20
     C                     PARM BJLCCY    ZCCY    3
     C                     PARM *BLANKS   ZLOC    3
     C                     PARM 'F'       ZDIREC  1
     C                     PARM *BLANKS   ZRTRN   7
     C                     CALL 'ZDATE2'
     C                     PARM           ZDAYNO  50
     C                     PARM           BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
     C                     MOVELZDATE     SAVAL0
     C                     END
     C                     END
      *
      ** Other details, specific to set
      ** Active period code
      *
     C                     MOVELPEVNT     S1EVNT
     C**********           MOVELPTPRD     S1TPRD                                            AR940109
     C                     MOVELSTPRDI    S1TPRD                                            AR940109
      *
      ** Notice/Roll days
      ** and Notice/Roll months
      *
     C                     MOVEL*BLANKS   S1NDPD
     C           PEVNT     IFGE 'A'
     C           PEVNT     ANDLT'Z'
      *
      ** Roll days is variable when freq code used
      *
     C           PFREQ     ANDEQ*BLANKS
     C           PNMPD     IFEQ 0
     C                     MOVE PNDPD     ZFIELD    P
     C                     Z-ADD3         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD1    S1NDPD
     C                     ELSE
     C                     MOVE PNMPD     ZFIELD    P
     C                     Z-ADD2         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD1    S1NMPD
     C                     ENDIF
     C                     END
      *
      ** Roll freq
      *
     C                     MOVELPFREQ     S1FREQ
      *
      ** End of period date
      *
     C                     MOVEL*ALL'?'   S1CEDE
     C           PCEDE     IFLE 999
     C                     MOVE PCEDE     ZFIELD    P
     C                     Z-ADD6         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD1    S1CEDE
     C                     ELSE
     C                     Z-ADDPCEDE     ZDAYNO
     C                     CALL 'ZDATE2'
     C                     PARM           ZDAYNO  50
     C                     PARM           BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
     C                     MOVELZDATE     S1CEDE
     C                     END
      *
      **    Active period start
      *
     C                     MOVEL*ALL'?'   S1VDAT
     C           PVDAT     IFGT 26
     C           PVDAT     ANDLT26664
     C                     Z-ADDPVDAT     ZDAYNO
     C                     CALL 'ZDATE2'
     C                     PARM           ZDAYNO  50
     C                     PARM           BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
     C                     MOVELZDATE     S1VDAT
     C                     END
      *
      **    Active period maturity
      *
     C                     MOVEL*ALL'?'   S1MDAT
     C           PVDAT     IFEQ 0
     C           PEVNT     IFEQ 'Z'
     C                     MOVELTRMDAT    S1MDAT
     C                     ELSE
     C           PNDPD     IFGT 0
     C                     MOVE PNDPD     S1MDAT    P
     C                     ELSE
     C           PNMPD     IFGT 0
     C                     Z-ADDPVDAT     #SDAYN
     C                     MOVE *BLANKS   #SDATE
     C                     Z-ADDPNMPD     #NMTH
     C                     Z-ADDPDAYM     #SDAYM
     C                     EXSR NOMTHS
     C                     MOVE #EDATE    S1MDAT    P
     C                     ENDIF
     C                     MOVE PFREQ     S1MDAT    P
     C                     END
     C                     MOVEL'+'       S1MDAT
     C                     END
     C                     END
     C           PVDAT     IFGT 0
     C           PMDAT     IFLE 26664
     C                     MOVELPMDAT     ZDAYNO
     C                     CALL 'ZDATE2'
     C                     PARM           ZDAYNO  50
     C                     PARM           BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
     C                     MOVELZDATE     S1MDAT
     C                     END
     C                     END
     C           PEVNT     IFEQ 'Z'
     C                     MOVELTRMDAT    S1MDAT
     C                     ENDIF
      *
      **    DR interest details
      *
     C                     MOVEL*BLANKS   S1DRIB
     C           PDRIB     IFNE '00'
     C                     MOVELPDRIB     S1DRIB
     C                     END
     C                     MOVEL*BLANKS   S1DRIS
     C                     MOVEL*BLANKS   S1SIGD
     C           PDRIS     IFNE 0
     C           CRE073    OREQ 'Y'                                                           CRE073
     C           S1DCSP    ANDNE*BLANKS                                                       CRE073
     C           S1DCSG    ANDNE*BLANK                                                        CRE073
     C                     MOVEL'+'       S1SIGD
     C           PDRIS     IFLT 0
     C                     Z-SUBPDRIS     PDRIS
     C                     MOVEL'-'       S1SIGD
     C                     END
     C           PDRIS     MULT 10000000  ZFLD15
     C                     CALL 'ZSEDIT'
     C                     PARM           ZFLD15 150
     C                     PARM 7         ZDECS   10
     C                     PARM '3'       ZECODE  1
     C                     PARM           ZOUT21 21
     C           14        SUBSTZOUT21:7  S1DRIS
     C                     END
     C                     MOVEL*BLANKS   S1DICT
     C           PDICT     IFNE '00'
     C                     MOVELPDICT     S1DICT
     C                     END
     C                     MOVEL*BLANKS   S1DCST
     C           PDCST     IFNE 0
     C                     MOVELPDCST     S1DCST
     C                     END
     C**********           MOVEL*BLANKS   S1DRIC                                              CER059
     C********** PDRIC     IFNE 0                                                             CER059
     C                     MOVELPDRIC     S1DRIC
     C**********           END                                                                CER059
     C                     MOVELPDNIR     S1DNIR
     C                     MOVELPDRIF     S1DRIF
     C                     MOVELPDACP     S1DACP
     C           PDRDY     IFEQ *ZEROS
     C                     MOVEL*BLANKS   S1DRDY
     C                     ELSE
     C                     MOVELPDRDY     S1DRDY
     C                     END
      *                                                                                       CRE073
      ** Interest rate change Details                                                         CRE073
      *                                                                                       CRE073
     C           CRE073    IFEQ 'Y'                                                           CRE073
      *                                                                                       CRE073
      **    DR Contractual Spread Details                                                     CRE073
      *                                                                                       CRE073
     C                     MOVEL*BLANKS   S1DCSP                                              CRE073
     C                     MOVEL*BLANKS   S1DCSG                                              CRE073
      ***Convert*zero*contractrual*spread*when*Rounding*method                     AR845336 AR938402
      ***are*not*blanks                                                            AR845336 AR938402
     C           PDCSP     IFNE 0                                                             CRE073
      ** Revert changes for AR845336, causes error for AR938402                             AR938402
     C********** PDRMT     ORNE *BLANKS                                            AR845336 AR938402
     C********** PDRFD     ANDNE*BLANKS                                            AR845336 AR938402
     C                     MOVEL'+'       S1DCSG                                              CRE073
     C           PDCSP     IFLT 0                                                             CRE073
     C                     Z-SUBPDCSP     PDCSP                                               CRE073
     C                     MOVEL'-'       S1DCSG                                              CRE073
     C                     ENDIF                                                              CRE073
     C           PDCSP     MULT 10000000  ZFLD15                                              CRE073
     C                     CALL 'ZSEDIT'                                                      CRE073
     C                     PARM           ZFLD15 150                                          CRE073
     C                     PARM 7         ZDECS   10                                          CRE073
     C                     PARM '3'       ZECODE  1                                           CRE073
     C                     PARM           ZOUT21 21                                           CRE073
     C           14        SUBSTZOUT21:8  S1DCSP                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
      **    DR Rounding Method Frac/Dec.                                                      CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   S1DRMT                                              CRE073
     C                     MOVE *BLANKS   S1DRFD                                              CRE073
     C                     MOVE PDRMT     S1DRMT                                              CRE073
     C                     MOVE PDRFD     S1DRFD                                              CRE073
      *                                                                                       CRE073
      **    CR Contractual Spread Details                                                     CRE073
      *                                                                                       CRE073
     C                     MOVEL*BLANKS   S1CCSP                                              CRE073
     C                     MOVEL*BLANKS   S1CCSG                                              CRE073
     C           PCCSP     IFNE 0                                                             CRE073
      ***Convert*zero*contractrual*spread*when*Rounding*method                     AR845336 AR938402
      ***are*not*blanks                                                            AR845336 AR938402
      ** Revert changes for AR845336, causes error for AR938402                             AR938402
     C********** PCRMT     ORNE *BLANKS                                            AR845336 AR938402
     C********** PCRFD     ANDNE*BLANKS                                            AR845336 AR938402
     C                     MOVEL'+'       S1CCSG                                              CRE073
     C           PCCSP     IFLT 0                                                             CRE073
     C                     Z-SUBPCCSP     PCCSP                                               CRE073
     C                     MOVEL'-'       S1CCSG                                              CRE073
     C                     ENDIF                                                              CRE073
     C           PCCSP     MULT 10000000  ZFLD15                                              CRE073
     C                     CALL 'ZSEDIT'                                                      CRE073
     C                     PARM           ZFLD15 150                                          CRE073
     C                     PARM 7         ZDECS   10                                          CRE073
     C                     PARM '3'       ZECODE  1                                           CRE073
     C                     PARM           ZOUT21 21                                           CRE073
     C           14        SUBSTZOUT21:8  S1CCSP                                              CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
      **    CR Rounding Method Frac/Dec.                                                      CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   S1CRMT                                              CRE073
     C                     MOVE *BLANKS   S1CRFD                                              CRE073
     C                     MOVE PCRMT     S1CRMT                                              CRE073
     C                     MOVE PCRFD     S1CRFD                                              CRE073
      *                                                                                       CRE073
     C                     ELSE                                                               CRE073
      *                                                                                       CRE073
     C                     MOVEL*BLANKS   S1DCSP                                              CRE073
     C                     MOVEL*BLANKS   S1DCSG                                              CRE073
     C                     MOVE *BLANKS   S1DRMT                                              CRE073
     C                     MOVE *BLANKS   S1DRFD                                              CRE073
     C                     MOVEL*BLANKS   S1CCSP                                              CRE073
     C                     MOVEL*BLANKS   S1CCSG                                              CRE073
     C                     MOVE *BLANKS   S1CRMT                                              CRE073
     C                     MOVE *BLANKS   S1CRFD                                              CRE073
      *                                                                                       CRE073
     C                     ENDIF                                                              CRE073
      *
      **    CR interest details
      *
     C                     MOVEL*BLANKS   S1CRIB
     C           PCRIB     IFNE '00'
     C                     MOVELPCRIB     S1CRIB
     C                     END
     C                     MOVEL*BLANKS   S1CRIS
     C                     MOVEL*BLANKS   S1SIGC
     C           PCRIS     IFNE 0
     C           CRE073    OREQ 'Y'                                                           CRE073
     C           S1CCSP    ANDNE*BLANKS                                                       CRE073
     C           S1CCSG    ANDNE*BLANK                                                        CRE073
     C                     MOVEL'+'       S1SIGC
     C           PCRIS     IFLT 0
     C                     Z-SUBPCRIS     PCRIS
     C                     MOVEL'-'       S1SIGC
     C                     END
     C           PCRIS     MULT 10000000  ZFLD15
     C                     CALL 'ZSEDIT'
     C                     PARM           ZFLD15 150
     C                     PARM 7         ZDECS   10
     C                     PARM '3'       ZECODE  1
     C                     PARM           ZOUT21 21
     C           14        SUBSTZOUT21:7  S1CRIS
     C                     END
     C                     MOVEL*BLANKS   S1CICT
     C           PCICT     IFNE '00'
     C                     MOVELPCICT     S1CICT
     C                     END
     C                     MOVEL*BLANKS   S1CCST
     C           PCCST     IFNE 0
     C                     MOVELPCCST     S1CCST
     C                     END
     C**********           MOVEL*BLANKS   S1CRIC                                              CER059
     C********** PCRIC     IFNE 0                                                             CER059
     C                     MOVELPCRIC     S1CRIC
     C**********           END                                                                CER059
     C                     MOVELPCNIR     S1CNIR
     C                     MOVELPCRIF     S1CRIF
     C                     MOVELPCACP     S1CACP
     C           PCRDY     IFEQ *ZEROS
     C                     MOVEL*BLANKS   S1CRDY
     C                     ELSE
     C                     MOVELPCRDY     S1CRDY
     C                     END
      *
      **    DR penalties
      *
     C                     MOVELPRTTD     S1RTTD
     C                     MOVELPDYBD     S1DYBD
     C                     MOVELPDRST     S1DRST
      *
      **    CR penalties
      *
     C                     MOVELPRTTC     S1RTTC
     C                     MOVELPDYBC     S1DYBC
     C                     MOVELPCRST     S1CRST
      *
      **    Frequency day number
      *
     C                     MOVEL*BLANKS   S1DAYM
     C           PDAYM     IFNE 0
     C                     MOVELPDAYM     S1DAYM
     C                     END
      *
     C                     MOVELPKEY1     S1KEY1
     C                     MOVELPBALN     S1BALN
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  INSCR2 - Move db fields into screen fields                   *
      *                                                               *
      *****************************************************************
     C           INSCR2    BEGSR
      *
      ** Move db fields into screen fields
      *
     C                     MOVEL*BLANKS   S1NARR
     C                     MOVELE2TPRD    J2TPRD  1
     C           S1NARR    CAT  J2TPRD:0  S1NARR
      *
      ** Roll amount type
      *
     C                     MOVELE2IRLI    J2IRLI  1
     C           S1NARR    CAT  J2IRLI:0  S1NARR
      *
      ** Other details, specific to set
      **  Active period code
      **  Notice/Roll days
      **  and Notice/Roll months
      *
     C                     MOVEL*BLANKS   J2NDPD  3
     C                     MOVEL*BLANKS   J2NMPD  2
      *
      ** Roll days is variable when freq code used
      *
     C           E2FREQ    IFEQ *BLANKS
     C           E2NMPD    IFEQ 0
     C                     MOVE E2NDPD    ZFIELD    P
     C                     Z-ADD3         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD1    J2NDPD
     C                     ELSE
     C                     MOVE E2NMPD    ZFIELD    P
     C                     Z-ADD2         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD1    J2NMPD
     C                     ENDIF
     C                     ENDIF
     C           S1NARR    CAT  J2NDPD:0  S1NARR
     C           S1NARR    CAT  J2NMPD:0  S1NARR
      *
      ** Roll freq
      *
     C                     MOVELE2FREQ    J2FREQ  1
     C           S1NARR    CAT  J2FREQ:0  S1NARR
      *
      ** Day number
      *
     C                     MOVELE2DAYM    J2DAYM  2
     C           S1NARR    CAT  J2DAYM:0  S1NARR
      *
      ** End of period date
      *
     C                     MOVEL*ALL'?'   J2CEDE  6
     C           E2CEDE    IFLE 999
     C                     MOVE E2CEDE    ZFIELD    P
     C                     Z-ADD6         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD1    J2CEDE
     C                     ELSE
     C                     Z-ADDE2CEDE    ZDAYNO
     C                     CALL 'ZDATE2'
     C                     PARM           ZDAYNO  50
     C                     PARM           BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
     C                     MOVELZDATE     J2CEDE
     C                     END
     C           S1NARR    CAT  J2CEDE:0  S1NARR
      *
      ** Active period maturity
      *
     C                     MOVEL*ALL'?'   J2MDAT  6
     C           E2VDAT    IFEQ 0
     C           E2EVNT    IFEQ 'Z'
     C                     MOVELTRMDAT    J2MDAT
     C                     ELSE
     C           E2NDPD    IFGT 0
     C                     MOVE E2NDPD    J2MDAT    P
     C                     ELSE
     C           E2NMPD    IFGT 0
     C                     Z-ADDE2VDAT    #SDAYN
     C                     MOVE *BLANKS   #SDATE
     C                     Z-ADDE2NMPD    #NMTH
     C                     Z-ADDE2DAYM    #SDAYM
     C                     EXSR NOMTHS
     C                     MOVE #EDATE    J2MDAT    P
     C                     ENDIF
     C                     MOVE E2FREQ    J2MDAT    P
     C                     END
     C                     END
     C                     END
     C           E2VDAT    IFGT 0
     C           E2MDAT    IFLE 26664
     C                     MOVELE2MDAT    ZDAYNO
     C                     CALL 'ZDATE2'
     C                     PARM           ZDAYNO  50
     C                     PARM           BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
     C                     MOVELZDATE     J2MDAT
     C                     END
     C                     END
     C           E2EVNT    IFEQ 'Z'
     C                     MOVELTRMDAT    J2MDAT
     C                     ENDIF
     C           S1NARR    CAT  J2MDAT:0  S1NARR
      *
      **    DR interest details
      *
     C                     MOVEL*BLANKS   J2DRIB  2
     C           E2DRIB    IFNE 0
     C                     MOVELE2DRIB    J2DRIB
     C                     END
     C           S1NARR    CAT  J2DRIB:0  S1NARR
     C                     MOVEL*BLANKS   J2DRIS 13
     C                     MOVEL*BLANKS   J2SIGD  1
     C           E2DRIS    IFNE 0
     C                     MOVEL'+'       J2SIGD
     C                     Z-ADDE2DRIS    W#DRIS 117
     C           W#DRIS    IFLT 0
     C                     Z-SUBW#DRIS    W#DRIS 117
     C                     MOVEL'-'       J2SIGD
     C                     END
     C           W#DRIS    MULT 10000000  ZFLD15
     C                     CALL 'ZSEDIT'
     C                     PARM           ZFLD15 150
     C                     PARM 7         ZDECS   10
     C                     PARM '3'       ZECODE  1
     C                     PARM           ZOUT21 21
     C           14        SUBSTZOUT21:7  J2DRIS
     C                     END
     C           S1NARR    CAT  J2SIGD:0  S1NARR
     C           S1NARR    CAT  J2DRIS:0  S1NARR
     C                     MOVEL*BLANKS   J2DICT  2
     C           E2DICT    IFNE 0
     C                     MOVELE2DICT    J2DICT
     C                     END
     C           S1NARR    CAT  J2DICT:0  S1NARR
     C                     MOVEL*BLANKS   J2DCST  5
     C           E2DCST    IFNE 0
     C                     MOVELE2DCST    J2DCST
     C                     END
     C           S1NARR    CAT  J2DCST:0  S1NARR
     C                     MOVEL*BLANKS   J2DRIC  1
     C           E2DRIC    IFNE 0
     C                     MOVELE2DRIC    J2DRIC
     C                     END
     C           S1NARR    CAT  J2DRIC:0  S1NARR
     C                     MOVELE2DNIR    J2DNIR  1
     C           S1NARR    CAT  J2DNIR:0  S1NARR
     C                     MOVELE2DRIF    J2DRIF  1
     C           S1NARR    CAT  J2DRIF:0  S1NARR
     C           E2DRDY    IFEQ *ZEROS
     C                     MOVEL*BLANKS   J2DRDY  4
     C                     ELSE
     C                     MOVELE2DRDY    J2DRDY
     C                     END
     C           S1NARR    CAT  J2DRDY:0  S1NARR
      *
      ** CR interest details
      *
     C                     MOVEL*BLANKS   J2CRIB  2
     C           E2CRIB    IFNE 0
     C                     MOVELE2CRIB    J2CRIB
     C                     END
     C           S1NARR    CAT  J2CRIB:0  S1NARR
     C                     MOVEL*BLANKS   J2CRIS 13
     C                     MOVEL*BLANKS   J2SIGC  1
     C           E2CRIS    IFNE 0
     C                     MOVEL'+'       J2SIGC
     C                     Z-ADDE2CRIS    W#CRIS 117
     C           W#CRIS    IFLT 0
     C                     Z-SUBW#CRIS    PCRIS
     C                     MOVEL'-'       J2SIGC
     C                     END
     C           W#CRIS    MULT 10000000  ZFLD15
     C                     CALL 'ZSEDIT'
     C                     PARM           ZFLD15 150
     C                     PARM 7         ZDECS   10
     C                     PARM '3'       ZECODE  1
     C                     PARM           ZOUT21 21
     C           14        SUBSTZOUT21:7  J2CRIS
     C                     END
     C           S1NARR    CAT  J2SIGC:0  S1NARR
     C           S1NARR    CAT  J2CRIS:0  S1NARR
     C                     MOVEL*BLANKS   J2CICT
     C           E2CICT    IFNE 0
     C                     MOVELE2CICT    J2CICT  2
     C                     END
     C           S1NARR    CAT  J2CICT:0  S1NARR
     C                     MOVEL*BLANKS   J2CCST  5
     C           E2CCST    IFNE 0
     C                     MOVELE2CCST    J2CCST
     C                     END
     C           S1NARR    CAT  J2CCST:0  S1NARR
     C                     MOVEL*BLANKS   J2CRIC  1
     C           E2CRIC    IFNE 0
     C                     MOVELE2CRIC    J2CRIC
     C                     END
     C           S1NARR    CAT  J2CRIC:0  S1NARR
     C                     MOVELE2CNIR    J2CNIR  1
     C           S1NARR    CAT  J2CNIR:0  S1NARR
     C                     MOVELE2CRIF    J2CRIF  1
     C           S1NARR    CAT  J2CRIF:0  S1NARR
     C           E2CRDY    IFEQ *ZEROS
     C                     MOVEL*BLANKS   J2CRDY  4
     C                     ELSE
     C                     MOVELE2CRDY    J2CRDY
     C                     END
     C           S1NARR    CAT  J2CRDY:0  S1NARR
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  SEND                                                         *
      *                                                               *
      *****************************************************************
     C           SEND      BEGSR
      *
      ** Move screen details into file
      *
     C                     EXSR FRSCRN
      *
      ** Update P&P details, using given date
      *
     C           WIMOD     IFNE '*DELT'                                                       228715
     C           WMODE     IFEQ '*INDEP'
     C                     MOVEL'*UPDIND' PMODE     P
     C                     ELSE
     C                     MOVEL'*UPD    'PMODE
     C                     ENDIF
     C                     ENDIF                                                              228715
      *
     C                     Z-ADDS1BALN    PBALN
     C                     EXSR EXTERN
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  FRSCRN                                                       *
      *                                                               *
      *****************************************************************
     C           FRSCRN    BEGSR
      *
      **    Period type
      *
     C                     MOVELS1EVNT    PEVNT
     C                     MOVELS1TPRD    PTPRD
      *
      **    Roll amount type
      *
     C                     MOVELSIRLI     PIRLI
      *
      **    Notice/Roll days
      *
     C                     Z-ADD0         PNDPD
     C           PEVNT     IFGE 'A'
     C           PEVNT     ANDLT'Z'
     C                     MOVE S1NDPD    ZFIELD    P
     C                     Z-ADD3         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD     PNDPD
     C                     END
      *
      **    Notice/Roll months
      *
     C                     Z-ADD0         PNMPD
     C           PEVNT     IFGE 'A'
     C           PEVNT     ANDLT'Z'
     C                     MOVE S1NMPD    ZFIELD    P
     C                     Z-ADD2         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD     PNMPD
     C                     END
      *
      ** Roll freq
      *
     C                     MOVELS1FREQ    PFREQ
      *
      ** End of period date
      *
     C                     MOVE S1CEDE    W#CEDE  60
     C           W#CEDE    IFLE 999
     C                     MOVE S1CEDE    PCEDE
     C                     ELSE
     C                     MOVE S1CEDE    ZDATE
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM           ZDATFM  1
     C                     PARM           ZDAYNO  50
     C                     MOVE ZDAYNO    PCEDE
     C                     END
      *
      ** Period start
      *
     C                     Z-ADD0         PVDAT
     C           S1VDAT    IFNE *BLANKS
     C                     MOVE S1VDAT    ZDATE
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM           ZDATFM  1
     C                     PARM           ZDAYNO  50
     C                     MOVE ZDAYNO    PVDAT
     C                     END
      *
      **    Period maturity
      *
     C                     Z-ADD0         PMDAT
     C           CURSET    IFEQ 1
     C           SMDAT0    IFNE *BLANKS
     C                     MOVE SMDAT0    ZDATE
     C                     END
     C                     ELSE
     C           S1MDAT    IFNE *BLANKS
     C                     MOVE S1MDAT    ZDATE
     C                     END
     C                     END
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM           ZDATFM  1
     C                     PARM           ZDAYNO  50
     C                     MOVE ZDAYNO    PMDAT
      *
      ** DR interest details
      *
     C                     MOVEL'00'      PDRIB
     C           S1DRIB    IFNE *BLANKS
     C                     MOVELS1DRIB    PDRIB
     C                     END
     C                     Z-ADD0         PDRIS
     C           S1DRIS    IFNE *BLANKS
     C                     MOVE S1DRIS    ZFIELD    P
     C                     Z-ADD4         ZADIG
     C                     Z-ADD7         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD     PDRIS
     C           S1SIGD    IFEQ '-'
     C                     Z-SUBPDRIS     PDRIS
     C                     END
     C                     END
     C                     MOVEL'00'      PDICT
     C           S1DICT    IFNE *BLANKS
     C                     MOVELS1DICT    PDICT
     C                     END
     C                     Z-ADD0         PDCST
     C           S1DCST    IFNE *BLANKS
     C                     MOVELS1DCST    PDCST
     C                     END
     C                     MOVELS1DRIC    PDRIC
     C                     MOVELS1DNIR    PDNIR
     C                     MOVELS1DRIF    PDRIF
     C                     MOVELS1DACP    PDACP
     C           S1DRDY    IFEQ *BLANKS
     C                     Z-ADD0         PDRDY
     C                     ELSE
     C                     MOVELS1DRDY    PDRDY
     C                     END
      *                                                                                       CRE073
      ** Interest rate change details                                                         CRE073
      *                                                                                       CRE073
     C           CRE073    IFEQ 'Y'                                                           CRE073
      *                                                                                       CRE073
      ** DR Contractual Interest Details                                                      CRE073
      *                                                                                       CRE073
     C                     Z-ADD0         PDCSP                                               CRE073
     C           S1DCSP    IFNE *BLANKS                                                       CRE073
     C                     MOVE S1DCSP    ZFIELD    P                                         CRE073
     C                     Z-ADD4         ZADIG                                               CRE073
     C                     Z-ADD7         ZADEC                                               CRE073
     C                     EXSR NEDIT                                                         CRE073
     C                     MOVE ZAFLD     PDCSP                                               CRE073
     C           S1DCSG    IFEQ '-'                                                           CRE073
     C                     Z-SUBPDCSP     PDCSP                                               CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                              CRE073
     C                     MOVE S1DCSG    PDCSG                                               CRE073
      *                                                                                       CRE073
      ** DR Rounding Method & Frac/Dec.                                                       CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   PDRMT                                               CRE073
     C                     MOVE *BLANKS   PDRFD                                               CRE073
     C                     MOVE S1DRMT    PDRMT                                               CRE073
     C                     MOVE S1DRFD    PDRFD                                               CRE073
      *                                                                                       CRE073
      ** CR Contractual Interest Details                                                      CRE073
      *                                                                                       CRE073
     C                     Z-ADD0         PCCSP                                               CRE073
     C           S1CCSP    IFNE *BLANKS                                                       CRE073
     C                     MOVE S1CCSP    ZFIELD    P                                         CRE073
     C                     Z-ADD4         ZADIG                                               CRE073
     C                     Z-ADD7         ZADEC                                               CRE073
     C                     EXSR NEDIT                                                         CRE073
     C                     MOVE ZAFLD     PCCSP                                               CRE073
     C           S1CCSG    IFEQ '-'                                                           CRE073
     C                     Z-SUBPCCSP     PCCSP                                               CRE073
     C                     ENDIF                                                              CRE073
     C                     ENDIF                                                              CRE073
     C                     MOVE S1CCSG    PCCSG                                               CRE073
      *                                                                                       CRE073
      ** CR Rounding Method & Frac/Dec.                                                       CRE073
      *                                                                                       CRE073
     C                     MOVE *BLANKS   PCRMT                                               CRE073
     C                     MOVE *BLANKS   PCRFD                                               CRE073
     C                     MOVE S1CRMT    PCRMT                                               CRE073
     C                     MOVE S1CRFD    PCRFD                                               CRE073
      *                                                                                       CRE073
     C                     ELSE                                                               CRE073
      *                                                                                       CRE073
     C                     Z-ADD0         PDCSP                                               CRE073
     C                     MOVE *BLANK    PDCSG                                               CRE073
     C                     MOVE *BLANKS   PDRMT                                               CRE073
     C                     MOVE *BLANKS   PDRFD                                               CRE073
     C                     Z-ADD0         PCCSP                                               CRE073
     C                     MOVE *BLANK    PCCSG                                               CRE073
     C                     MOVE S1CRMT    PCRMT                                               CRE073
     C                     MOVE S1CRFD    PCRFD                                               CRE073
      *                                                                                       CRE073
     C                     ENDIF                                                              CRE073
      *
      **    CR interest details
      *
     C                     MOVEL'00'      PCRIB
     C           S1CRIB    IFNE *BLANKS
     C                     MOVELS1CRIB    PCRIB
     C                     END
     C                     Z-ADD0         PCRIS
     C           S1CRIS    IFNE *BLANKS
     C                     MOVE S1CRIS    ZFIELD    P
     C                     Z-ADD4         ZADIG
     C                     Z-ADD7         ZADEC
     C                     EXSR NEDIT
     C                     MOVE ZAFLD     PCRIS
     C           S1SIGC    IFEQ '-'
     C                     Z-SUBPCRIS     PCRIS
     C                     END
     C                     END
     C                     MOVEL'00'      PCICT
     C           S1CICT    IFNE *BLANKS
     C                     MOVELS1CICT    PCICT
     C                     END
     C                     Z-ADD0         PCCST
     C           S1CCST    IFNE *BLANKS
     C                     MOVELS1CCST    PCCST
     C                     END
     C                     MOVELS1CRIC    PCRIC
     C                     MOVELS1CNIR    PCNIR
     C                     MOVELS1CRIF    PCRIF
     C                     MOVELS1CACP    PCACP
     C           S1CRDY    IFEQ *BLANKS
     C                     Z-ADD0         PCRDY
     C                     ELSE
     C                     MOVELS1CRDY    PCRDY
     C                     END
      *
      ** DR penalties
      *
     C                     MOVELS1RTTD    PRTTD
     C                     MOVELS1DYBD    PDYBD
     C                     MOVELS1DRST    PDRST
      *
      ** CR penalties
      *
     C                     MOVELS1RTTC    PRTTC
     C                     MOVELS1DYBC    PDYBC
     C                     MOVELS1CRST    PCRST
      *
      ** Frequency day number
      *
     C                     Z-ADD0         PDAYM
     C           S1DAYM    IFNE *BLANKS
     C                     MOVELS1DAYM    PDAYM
     C                     END
      *
     C                     MOVELS1KEY1    PKEY1
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  EXTERN                                                       *
      *                                                               *
      *****************************************************************
     C           EXTERN    BEGSR
      *
      ** Call external rtv/update routine
      *
     C                     MOVELSBRCA     PBRCA
     C                     MOVE SCNUM     PCNUM
     C                     MOVELSCCY      PCCY
     C           SACOD     IFEQ *BLANKS
     C                     MOVE *ZEROS    PACOD
     C                     ELSE
     C                     MOVE SACOD     PACOD
     C                     END
     C           SACSQ     IFEQ *BLANKS
     C                     MOVE *ZEROS    PACSQ
     C                     ELSE
     C                     MOVE SACSQ     PACSQ
     C                     END
     C           PMODE     IFEQ '*ENQ'
     C                     CALL 'RE4010E' PLIST1       99
     C                     ELSE
     C                     CALL 'RE4010U' PLIST1       99
     C                     ENDIF
      *
     C           P@RTCD    IFEQ '*ERROR'
     C           *INU7     OREQ '1'
     C           *INU8     OREQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD2         DBASE
     C                     MOVEL##PGM     DBPGM
     C                     MOVEL'RE4010* 'DBFILE
     C                     MOVEL'*CALL'   DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           *IN99     IFEQ '1'
     C                     MOVEL'*CALL'   PRTCD
     C                     END
      *
     C           PMODE     IFEQ '*EXIST'
     C                     MOVEL'*EXIST ' MAINT   7
     C                     END
     C           PMODE     IFEQ '*NEW'
     C                     MOVEL'*NEW   ' MAINT   7
     C                     END
     C           PMODE     IFEQ '*DFT   '
     C                     MOVEL'*DFT   ' MAINT   7
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  PRDSCR                                                       *
      *                                                               *
      *****************************************************************
     C           PRDSCR    BEGSR
      *
      ** Move period into screen
      *
     C           IX        IFEQ 1
     C                     MOVELS1EVNT    SEVNT1
     C                     MOVELS1NDPD    SNDPD1
     C                     MOVELS1NMPD    SNMPD1
     C                     MOVELS1FREQ    SFREQ1
     C                     MOVELS1CEDE    SCEDE1
     C                     MOVELS1VDAT    SVDAT1
     C                     MOVELS1MDAT    SMDAT1
     C                     MOVELS1DRIB    SDRIB1
     C                     MOVELS1DRIS    SDRIS1
     C                     MOVELS1SIGD    SSIGD1
     C                     MOVELS1DICT    SDICT1
     C                     MOVELS1DCST    SDCST1
     C                     MOVELS1DRIC    SDRIC1
     C                     MOVELS1DNIR    SDNIR1
     C                     MOVELS1DRIF    SDRIF1
     C                     MOVELS1DACP    SDACP1
     C                     MOVELS1DRDY    SDRDY1
     C                     MOVELS1CRIB    SCRIB1
     C                     MOVELS1CRIS    SCRIS1
     C                     MOVELS1SIGC    SSIGC1
     C                     MOVELS1CICT    SCICT1
     C                     MOVELS1CCST    SCCST1
     C                     MOVELS1CRIC    SCRIC1
     C                     MOVELS1CNIR    SCNIR1
     C                     MOVELS1CRIF    SCRIF1
     C                     MOVELS1CACP    SCACP1
     C                     MOVELS1CRDY    SCRDY1
     C                     MOVELS1RTTD    SRTTD1
     C                     MOVELS1DYBD    SDYBD1
     C                     MOVELS1DRST    SDRST1
     C                     MOVELS1RTTC    SRTTC1
     C                     MOVELS1DYBC    SDYBC1
     C                     MOVELS1CRST    SCRST1
     C                     MOVELS1DAYM    SDAYM1
     C********** SDCSP1    IFEQ *BLANKS                                            AR845336 AR938402
     C********** SDCSG1    ANDEQ*BLANKS                                            AR845336 AR938402
     C                     MOVELS1DCSP    SDCSP1                                              CRE073
     C                     MOVELS1DCSG    SDCSG1                                              CRE073
     C**********           ENDIF                                                   AR845336 AR938402
     C                     MOVELS1DRMT    SDRMT1                                              CRE073
     C                     MOVELS1DRFD    SDRFD1                                              CRE073
     C********** SCCSP1    IFEQ *BLANKS                                            AR845336 AR938402
     C********** SCCSG1    ANDEQ*BLANKS                                            AR845336 AR938402
     C                     MOVELS1CCSP    SCCSP1                                              CRE073
     C                     MOVELS1CCSG    SCCSG1                                              CRE073
     C**********           ENDIF                                                   AR845336 AR938402
     C                     MOVELS1CRMT    SCRMT1                                              CRE073
     C                     MOVELS1CRFD    SCRFD1                                              CRE073
     C                     END
      *
     C           IX        IFEQ 2
     C                     MOVELS1EVNT    SEVNT2
     C                     MOVELS1NDPD    SNDPD2
     C                     MOVELS1NMPD    SNMPD2
     C                     MOVELS1FREQ    SFREQ2
     C                     MOVELS1CEDE    SCEDE2
     C                     MOVELS1VDAT    SVDAT2
     C                     MOVELS1MDAT    SMDAT2
     C                     MOVELS1DRIB    SDRIB2
     C                     MOVELS1DRIS    SDRIS2
     C                     MOVELS1SIGD    SSIGD2
     C                     MOVELS1DICT    SDICT2
     C                     MOVELS1DCST    SDCST2
     C                     MOVELS1DRIC    SDRIC2
     C                     MOVELS1DNIR    SDNIR2
     C                     MOVELS1DRIF    SDRIF2
     C                     MOVELS1DACP    SDACP2
     C                     MOVELS1DRDY    SDRDY2
     C                     MOVELS1CRIB    SCRIB2
     C                     MOVELS1CRIS    SCRIS2
     C                     MOVELS1SIGC    SSIGC2
     C                     MOVELS1CICT    SCICT2
     C                     MOVELS1CCST    SCCST2
     C                     MOVELS1CRIC    SCRIC2
     C                     MOVELS1CNIR    SCNIR2
     C                     MOVELS1CRIF    SCRIF2
     C                     MOVELS1CACP    SCACP2
     C                     MOVELS1CRDY    SCRDY2
     C                     MOVELS1RTTD    SRTTD2
     C                     MOVELS1DYBD    SDYBD2
     C                     MOVELS1DRST    SDRST2
     C                     MOVELS1RTTC    SRTTC2
     C                     MOVELS1DYBC    SDYBC2
     C                     MOVELS1CRST    SCRST2
     C                     MOVELS1DAYM    SDAYM2
     C********** SDCSP2    IFEQ *BLANKS                                            AR845336 AR938402
     C********** SDCSG2    ANDEQ*BLANKS                                            AR845336 AR938402
     C                     MOVELS1DCSP    SDCSP2                                              CRE073
     C                     MOVELS1DCSG    SDCSG2                                              CRE073
     C**********           ENDIF                                                   AR845336 AR938402
     C                     MOVELS1DRMT    SDRMT2                                              CRE073
     C                     MOVELS1DRFD    SDRFD2                                              CRE073
     C********** SCCSP2    IFEQ *BLANKS                                            AR845336 AR938402
     C********** SCCSG2    ANDEQ*BLANKS                                            AR845336 AR938402
     C                     MOVELS1CCSP    SCCSP2                                              CRE073
     C                     MOVELS1CCSG    SCCSG2                                              CRE073
     C**********           ENDIF                                                   AR845336 AR938402
     C                     MOVELS1CRMT    SCRMT2                                              CRE073
     C                     MOVELS1CRFD    SCRFD2                                              CRE073
     C                     END
      *
      ** Defaults
      *
     C           CURSET    IFEQ 1
     C           SMDAT0    IFEQ *BLANKS
     C           S1EVNT    ANDGE'A'
     C           S1EVNT    ANDLT'Z'
     C           MAINT     ANDNE'*DFT'
     C                     MOVELS1MDAT    SMDAT0
     C                     END
     C           SMDAT0    IFEQ *BLANKS
     C           S1EVNT    ANDEQ'Z'
     C           MAINT     ANDNE'*DFT'
     C                     MOVELS1CEDE    SMDAT0
     C                     END
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  SCRPRD                                                       *
      *                                                               *
      *****************************************************************
     C           SCRPRD    BEGSR
      *
      ** Move screen into period
      *
     C           IX        IFEQ 1
     C                     MOVELSEVNT1    S1EVNT
     C                     MOVELSNDPD1    S1NDPD
     C                     MOVELSNMPD1    S1NMPD
     C                     MOVELSFREQ1    S1FREQ
     C                     MOVELSCEDE1    S1CEDE
     C                     MOVELSVDAT1    S1VDAT
     C                     MOVELSMDAT1    S1MDAT
     C                     MOVELSDRIB1    S1DRIB
     C                     MOVELSDRIS1    S1DRIS
     C                     MOVELSSIGD1    S1SIGD
     C                     MOVELSDICT1    S1DICT
     C                     MOVELSDCST1    S1DCST
     C                     MOVELSDRIC1    S1DRIC
     C                     MOVELSDNIR1    S1DNIR
     C                     MOVELSDRIF1    S1DRIF
     C                     MOVELSDACP1    S1DACP
     C                     MOVELSDRDY1    S1DRDY
     C                     MOVELSCRIB1    S1CRIB
     C                     MOVELSCRIS1    S1CRIS
     C                     MOVELSSIGC1    S1SIGC
     C                     MOVELSCICT1    S1CICT
     C                     MOVELSCCST1    S1CCST
     C                     MOVELSCRIC1    S1CRIC
     C                     MOVELSCNIR1    S1CNIR
     C                     MOVELSCRIF1    S1CRIF
     C                     MOVELSCACP1    S1CACP
     C                     MOVELSCRDY1    S1CRDY
     C                     MOVELSRTTD1    S1RTTD
     C                     MOVELSDYBD1    S1DYBD
     C                     MOVELSDRST1    S1DRST
     C                     MOVELSRTTC1    S1RTTC
     C                     MOVELSDYBC1    S1DYBC
     C                     MOVELSCRST1    S1CRST
     C                     MOVELSDAYM1    S1DAYM
     C                     MOVELSDCSP1    S1DCSP                                              CRE073
     C                     MOVELSDCSG1    S1DCSG                                              CRE073
     C                     MOVELSDRMT1    S1DRMT                                              CRE073
     C                     MOVELSDRFD1    S1DRFD                                              CRE073
     C                     MOVELSCCSP1    S1CCSP                                              CRE073
     C                     MOVELSCCSG1    S1CCSG                                              CRE073
     C                     MOVELSCRMT1    S1CRMT                                              CRE073
     C                     MOVELSCRFD1    S1CRFD                                              CRE073
     C                     END
      *
     C           IX        IFEQ 2
     C                     MOVELSEVNT2    S1EVNT
     C                     MOVELSNDPD2    S1NDPD
     C                     MOVELSNMPD2    S1NMPD
     C                     MOVELSFREQ2    S1FREQ
     C                     MOVELSCEDE2    S1CEDE
     C                     MOVELSVDAT2    S1VDAT
     C                     MOVELSMDAT2    S1MDAT
     C                     MOVELSDRIB2    S1DRIB
     C                     MOVELSDRIS2    S1DRIS
     C                     MOVELSSIGD2    S1SIGD
     C                     MOVELSDICT2    S1DICT
     C                     MOVELSDCST2    S1DCST
     C                     MOVELSDRIC2    S1DRIC
     C                     MOVELSDNIR2    S1DNIR
     C                     MOVELSDRIF2    S1DRIF
     C                     MOVELSDACP2    S1DACP
     C                     MOVELSDRDY2    S1DRDY
     C                     MOVELSCRIB2    S1CRIB
     C                     MOVELSCRIS2    S1CRIS
     C                     MOVELSSIGC2    S1SIGC
     C                     MOVELSCICT2    S1CICT
     C                     MOVELSCCST2    S1CCST
     C                     MOVELSCRIC2    S1CRIC
     C                     MOVELSCNIR2    S1CNIR
     C                     MOVELSCRIF2    S1CRIF
     C                     MOVELSCACP2    S1CACP
     C                     MOVELSCRDY2    S1CRDY
     C                     MOVELSRTTD2    S1RTTD
     C                     MOVELSDYBD2    S1DYBD
     C                     MOVELSDRST2    S1DRST
     C                     MOVELSRTTC2    S1RTTC
     C                     MOVELSDYBC2    S1DYBC
     C                     MOVELSCRST2    S1CRST
     C                     MOVELSDAYM2    S1DAYM
     C                     MOVELSDCSP2    S1DCSP                                              CRE073
     C                     MOVELSDCSG2    S1DCSG                                              CRE073
     C                     MOVELSDRMT2    S1DRMT                                              CRE073
     C                     MOVELSDRFD2    S1DRFD                                              CRE073
     C                     MOVELSCCSP2    S1CCSP                                              CRE073
     C                     MOVELSCCSG2    S1CCSG                                              CRE073
     C                     MOVELSCRMT2    S1CRMT                                              CRE073
     C                     MOVELSCRFD2    S1CRFD                                              CRE073
     C                     END
      *
     C           S1CEDE    IFEQ TRMDAT
     C           S1EVNT    ANDNE'Z'
     C           S1EVNT    ANDNE*BLANKS
     C                     MOVEL'Z'       S1EVNT
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  NEDIT                                                        *
      *                                                               *
      *****************************************************************
     C           NEDIT     BEGSR
      *
      ** Use standard routine to check and format
      *
     C                     MOVE ZFIELD    ZAFLD1 16 P
     C                     CALL 'ZALIGN'
     C                     PARM *BLANKS   ZRTN    7
     C                     PARM           ZFIELD 16
     C                     PARM           ZADEC   10
     C                     PARM           ZADIG   20
     C                     PARM           ZAFLD  16
     C           ZRTN      IFEQ *BLANKS
     C                     MOVE ZAFLD     ZFLD15
     C                     CALL 'ZSEDIT'
     C                     PARM           ZFLD15 150
     C                     PARM ZADEC     ZDECS   10
     C                     PARM '3'       ZECODE  1
     C                     PARM           ZOUT21 21
     C           16        SUBSTZOUT21:5  ZAFLD1
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  NOMTHS - Calculate term length in days and end date given    *
      *           start date and number of months. Note that number of*
      *           months can also be a negative number, in which case *
      *           the end date will be earlier than the start date.   *
      *                                                               *
      *****************************************************************
     C           NOMTHS    BEGSR
      *
      ** Calculations to define/clear fields
      ** Inputs
      *
     C                     MOVE #SDATE    #SDATE  6 P
     C                     Z-ADD#SDAYN    #SDAYN  50
     C                     Z-ADD#NMTH     #NMTH   20
     C                     Z-ADD#SDAYM    #SDAYM  20
      *
      ** Outputs
      *
     C                     Z-ADD0         EDD     20
     C                     Z-ADD0         EMM     20
     C                     Z-ADD0         EYY     20
     C                     MOVE *BLANKS   #EDATE  6
     C                     Z-ADD0         #EDAYN  50
     C                     Z-ADD0         #TERML  50
     C                     MOVE *BLANK    ZZERR@  7
      *
     C           #SDATE    IFEQ *BLANKS
      *
      ** Convert day number to date (DDMMYY)
      *
     C                     CALL 'ZDATE2'
     C                     PARM #SDAYN    ZDAYNO  50
     C                     PARM 'D'       BJDFIN  1
     C                     PARM           ZDATE   60
     C                     PARM           ZADATE  7
     C                     MOVE ZDATE     #SDATE
     C                     ENDIF
      *
     C           #SDAYN    IFEQ 0
      *
      ** Convert date to day number
      *
     C                     MOVE #SDATE    ZDATE
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM 'D'       ZDATFM  1
     C                     PARM           ZDAYNO  50
     C                     Z-ADDZDAYNO    #SDAYN
     C                     ENDIF
      *
      ** Set end day number to be same as start day number
      ** or eqaul to day number
      *
     C           #SDAYM    IFEQ 0
     C                     MOVEL#SDATE    UUWRK2  2
     C                     MOVE UUWRK2    EDD     20
     C                     ELSE
     C                     Z-ADD#SDAYM    EDD
     C                     ENDIF
      *
      ** Calculate date NMTH no of months ahead
      *
     C                     Z-ADD0         UMTH    20
     C                     MOVEL#SDATE    UWRK4   4
     C                     MOVE UWRK4     UMTH
     C           UMTH      ADD  #NMTH     UMTH
      *
      **  Convert into months and years
      *
     C                     Z-ADDUMTH      EMM
     C                     MOVE #SDATE    EYY     20
     C           UMTH      IFGE 12
     C           UMTH      ORLE -12
     C           UMTH      DIV  12        UMYR    20
     C                     MVR            UMY     20
     C                     Z-ADDUMY       EMM
     C           EYY       ADD  UMYR      EYY
     C                     END
      *
     C**  If negative values of month and year, make valid values
      *
     C           EMM       IFLT 1
     C           12        ADD  EMM       EMM
     C           EYY       SUB  1         EYY
     C                     ENDIF
     C           EYY       IFLT 0
     C           100       ADD  EYY       EYY
     C                     ENDIF
      *
      ** Check for LEAP YEAR
      *
     C           EYY       DIV  4         ULYR    20
     C                     MVR            ULY     10
      *
      ** Check day number is within end of month
      *
     C                     MOVE UFMD,EMM  UWRK2   20
     C           EMM       IFEQ 2
     C           ULY       ANDEQ0
     C                     Z-ADD29        UWRK2
     C                     END
      *
     C           EDD       IFGT UWRK2
     C                     Z-ADDUWRK2     EDD
     C                     END
      *
      ** Reformat Date, DDMMYY, and convert to day number
      *
     C                     MOVELEDD       ZWRK4   40
     C                     MOVE EMM       ZWRK4
     C                     MOVELZWRK4     ZDATE     P
     C                     MOVE EYY       ZDATE
     C                     MOVE ZDATE     #EDATE  6 P
      *
     C                     CALL 'ZDATE1'
     C                     PARM           ZERR    7
     C                     PARM           ZDATE   60
     C                     PARM 'D'       ZDATFM  1
     C                     PARM 0         ZDAYNO  50
     C                     Z-ADDZDAYNO    #EDAYN
      *
      **   Determine length of term
      *
     C           #EDAYN    SUB  #SDAYN    #TERML
     C           #TERML    ADD  1         #TERML
      *
     C                     ENDSR
      *****************************************************************
      *                                                               *
      *  INIT                                                         *
      *                                                               *
      *****************************************************************
     C           INIT      BEGSR
      *
     C           PLIST1    PLIST
     C                     PARM           PMODE   7
     C                     PARM           PBRCA   3
     C                     PARM           PCNUM   6
     C                     PARM           PCCY    3
     C                     PARM           PACOD  10
     C                     PARM           PACSQ   2
     C                     PARM           PDATE   50
      *
     C                     PARM           PEVNT   1
     C                     PARM           PITEM   50
     C                     PARM           PVDAT   50
     C                     PARM           PMDAT   50
     C                     PARM           PCEDE   50
     C                     PARM           PFREQ   1
     C                     PARM           PNDPD   30
     C                     PARM           PNMPD   20
     C                     PARM           PIRLI   1
     C                     PARM           PTPRD   1
      *
     C                     PARM           PDRIB   2
     C                     PARM           PDRIS  117
     C                     PARM           PDICT   2
     C                     PARM           PDCST   50
     C                     PARM           PDRIC   10
     C                     PARM           PDNIR   1
     C                     PARM           PDRIF   1
     C                     PARM           PDACP  24
     C                     PARM           PNDID   50
     C                     PARM           PDRDY   40
      *
     C                     PARM           PCRIB   2
     C                     PARM           PCRIS  117
     C                     PARM           PCICT   2
     C                     PARM           PCCST   50
     C                     PARM           PCRIC   10
     C                     PARM           PCNIR   1
     C                     PARM           PCRIF   1
     C                     PARM           PCACP  24
     C                     PARM           PNCID   50
     C                     PARM           PCRDY   40
      *
     C                     PARM           PRTTD   5
     C                     PARM           PDYBD   1
     C                     PARM           PDRST   1
     C                     PARM           PRTTC   5
     C                     PARM           PDYBC   1
     C                     PARM           PCRST   1
     C                     PARM           PDAYM   20
     C                     PARM           PKEY1  24
     C                     PARM           PBALN  150
      *
     C                     PARM           PRTCD   7
      *
     C                     PARM           PSTAT   1
     C                     PARM           MAINT   7
      *                                                                                       CRE073
     C                     PARM           PDCSP  117                                          CRE073
     C                     PARM           PDCSG   1                                           CRE073
     C                     PARM           PDRMT   7                                           CRE073
     C                     PARM           PDRFD   4                                           CRE073
      *                                                                                       CRE073
     C                     PARM           PCCSP  117                                          CRE073
     C                     PARM           PCCSG   1                                           CRE073
     C                     PARM           PCRMT   7                                           CRE073
     C                     PARM           PCRFD   4                                           CRE073
      *
      **   Define the LDA for error handling
      *
     C           *NAMVAR   DEFN           LDA
      *
     C           RKEY1     KLIST
     C                     KFLD           KBRCA   3
     C                     KFLD           KCNUM   6
     C                     KFLD           KCCY    3
     C                     KFLD           KACOD  100
     C                     KFLD           KACSQ   20
      *
      ** Key for REINHSL0                                                                     223606
     C           H2KEY     KLIST                                                              223606
     C                     KFLD           HKEY                                                223606
     C                     KFLD           H2VDAT  50                                          223606
      *                                                                                       223606
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   P@RTCD  7
     C                     PARM '*FIRST'  P@OPTN  7
     C           BKFMT     PARM *BLANKS   P@FMT
      *
     C                     MOVELBJMRDT    SRUNA
     C                     MOVEL'.'       DECPT   1
      *
     C           BJDFIN    IFEQ 'D'
     C                     MOVEL'311244'  TRMDAT  6
     C                     MOVEL'301244'  TRMDT2  6
     C                     END
     C           BJDFIN    IFEQ 'M'
     C                     MOVEL'123144'  TRMDAT
     C                     MOVEL'123044'  TRMDT2
     C                     END
      *                                                                                       CER059
      ** Check if CER016 is installed                                                         CER059
      *                                                                                       CER059
     C                     CALL 'AOSARDR0'                                                    CER059
     C                     PARM *BLANKS   P@RTCD                                              CER059
     C                     PARM '*VERIFY' P@OPTN                                              CER059
     C                     PARM 'CER016'  P@SARD  8                                           CER059
     C                     PARM *BLANKS   DSFDY                                               CER059
      *                                                                                       CER059
      ** If CER016 is installed                                                               CER059
      *                                                                                       CER059
     C           P@RTCD    IFEQ *BLANKS                                                       CER059
      *                                                                                       CER059
      ** Store indicator                                                                      CER059
      *                                                                                       CER059
     C                     MOVE 'Y'       CER016  1                                           CER059
     C                     ELSE                                                               CER059
     C                     MOVE 'N'       CER016                                              CER059
     C                     ENDIF                                                              CER059
      *                                                                                       CER059
     C           P@RTCD    IFNE *BLANKS                                                       CER059
     C           P@RTCD    ANDNE'*NRF   '                                                     CER059
      *                                                                                       CER059
     C           *LOCK     IN   LDA                                                           CER059
     C                     MOVEL'CER016'  DBKEY                                               CER059
     C                     MOVEL'SCSARDPD'DBFILE                                              CER059
     C                     Z-ADD097       DBASE                                               CER059
     C                     OUT  LDA                                                           CER059
      *                                                                                       CER059
     C                     EXSR *PSSR                                                         CER059
      *                                                                                       CER059
     C                     ENDIF                                                              CER059
      *                                                                                       CRE073
      ** Check if CRE073 is installed                                                         CRE073
      *                                                                                       CRE073
     C                     CALL 'AOSARDR0'                                                    CRE073
     C                     PARM *BLANKS   P@RTCD                                              CRE073
     C                     PARM '*VERIFY' P@OPTN                                              CRE073
     C                     PARM 'CRE073'  P@SARD  8                                           CRE073
     C                     PARM *BLANKS   DSFDY                                               CRE073
      *                                                                                       CRE073
      ** If CRE073 is installed                                                               CRE073
      *                                                                                       CRE073
     C           P@RTCD    IFEQ *BLANKS                                                       CRE073
      *                                                                                       CRE073
      ** Store indicator                                                                      CRE073
      *                                                                                       CRE073
     C                     MOVE 'Y'       CRE073  1                                           CRE073
     C                     MOVE *ON       *IN11                                               CRE073
     C                     ELSE                                                               CRE073
     C                     MOVE 'N'       CRE073                                              CRE073
     C                     MOVE *OFF      *IN11                                               CRE073
     C                     ENDIF                                                              CRE073
      *                                                                                       CRE073
     C           P@RTCD    IFNE *BLANKS                                                       CRE073
     C           P@RTCD    ANDNE'*NRF   '                                                     CRE073
      *                                                                                       CRE073
     C           *LOCK     IN   LDA                                                           CRE073
     C                     MOVEL'CRE073'  DBKEY                                               CRE073
     C                     MOVEL'SCSARDPD'DBFILE                                              CRE073
     C                     Z-ADD098       DBASE                                               CRE073
     C                     OUT  LDA                                                           CRE073
      *                                                                                       CRE073
     C                     EXSR *PSSR                                                         CRE073
      *                                                                                       CRE073
     C                     ENDIF                                                              CRE073
      *
     C                     SETON                     05
     C                     SETON                     28
     C                     MOVEL*BLANKS   S1POSN
     C                     MOVEL*BLANKS   LLPOSN 24
     C                     Z-ADD15        SFLPAG  20
      *
     C                     SETON                     12
      *
      ** If account not passed to program, then prompt
      *
     C           W0PRTP    IFEQ *BLANKS
     C                     MOVEL'PROMPT  'W0PRTP  8
     C                     SETON                     30
     C                     END
      *
      ** If account passed to program,
      *
     C           W0PRTP    IFEQ *BLANKS
      *
      ** Access account details
      *
     C                     MOVEL*ZEROS    DFTACN 10
      *
      ** Place valid account in prompt details, as if user had typed them
      ** then validate these prompt details
      *
     C                     MOVELBRCA      SBRCA
     C                     MOVE CNUM      SCNUM
     C                     MOVELCCY       SCCY
     C                     MOVE ACOD      SACOD
     C                     MOVE ACSQ      SACSQ
     C                     MOVEL'VALPMT  'W0PRTP  8
     C                     SETON                     30
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
     C           @RUN      IFEQ *BLANK
     C                     MOVE 'Y'       @RUN    1
     C                     SETON                     U7U8LR
     C                     DUMP
      *
     C                     CALL 'DBERRCTL'
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      ********************************************************************
**   UFMD  -  NUMBER OF DAYS IN THE MONTH
312831303130313130313031
