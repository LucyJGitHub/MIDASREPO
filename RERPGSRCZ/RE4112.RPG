     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE Retail account transfer')                     *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Retail Module                                        *
     F*                                                               *
     F*  RE4112 - Retail Account Transfer                             *
     F*                                                               *
     F*  Function:  This program accepts and validates retail account *
     F*  (I/C)      transfers and performs file updates to the teller *
     F*             system master files.  A transaction confirmation  *
     F*             slip is generated during this transaction, as a   *
     F*             receipt for the customer.                         *
     F*                                                               *
     F*  Called By: REC4112 - Retail Account Transfer Control         *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD054623           Date 14Jan20               *
      *  Prev Amend No. MD054057           Date 05Nov19               *
      *                 CER050             Date 16Jun19               *
      *                 CSD101             Date 07Dec18               *
      *                 MD050139           Date 23Mar18               *
      *                 MD046248           Date 27Oct17               *
      *                 MD034451C          Date 02Mar16               *
      *                 CGL184             Date 07Dec16               *
      *                 CGL154             Date 13Oct14               *
      *                 218877             Date 26Aug15               *
      *                 MD042745           Date 20Nov16               *
      *                 CCG016             Date 13Sep16               *
      *                 252150             Date 03Sep12               *
      *                 263834             Date 17Mar10               *
      *                 CRE073             Date 06Dec10               *
      *                 CRE075             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016             Date 19May08               *
      *                 CER047             Date 19May08               *
      *                 CER030             Date 09Jul08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 BUG27532           Date 26Apr10               *
      *                 BUG27045A          Date 13Apr10               *
      *                 BUG27045           Date 18Feb10               *
      *                 CAP205             Date 23Feb10               *
      *                 CAP204             Date 09Feb10               *
      *                 CRE401             Date 26Nov09               *
      *                 CDL081             Date 14Dec09               *
      *                 CAP187             Date 21Aug09               *
      *                 260297             Date 19May09               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 253892 (BUG17968)  Date 28Apr08               *
      *                 253689 (BUG17640)  Date 09Apr08               *
      *                 247188             Date 04Jun07               *
      *                 250891             Date 16Oct07               *
      *                 249968             Date 12Sep07               *
      *                 249218             Date 15Aug07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 26Sep06               *
      *                 241729             Date 23Aug06               *
      *                 CDL013             Date 08Jun06               *
      *                 165543             Date 06Jun06               *
      *                 CSD031             Date 10Apr06               *
      *                 BUG8514            Date 14Jun06               *
      *                 CRT026             Date 22May06               *
      *                 CSD027             Date 09Dec05               *
      *                 BUG7819            Date 30Aug05               *
      *                 BUG8168            Date 25Aug05               *
      *                 BUG7638            Date 20Jul05               *
      *                 BUG6342            Date 15Apr05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG4470            Date 01Dec04               *
      *                 BUG3229            Date 23Aug04               *
      *                 Bug3855            Date 03Aug04               *
      *                 BUG2849            Date 06Jun04               *
      *                 CLE025             Date 20Oct03               *
      *                 CAAA03             Date 30Apr04               *
      *                 CRE019             Date 12Mar04               *
      *                 CGL029             Date 01Sep03               *
      *                 CRT012             Date 26Nov02               *
      * Midas Release 4.01 -------------------------------------------*
     F*                 201732             Date 24Jan02               *
     F*                 CRT007             Date 14Jan02               *
     F*                 CRT005             Date 27Nov01               *
     F*                 198870             Date 12Oct01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 194978             Date 28Jun01               *
      *                 CRT006             Date 17Apr01               *
      *                 CDE002             Date 21Dec99               *
      *                 184205             Date 19Apr01               *
      *                 190137             Date 18Apr01               *
     F*                 174972             Date 17Apr01               *
     F*                 159251             Date 17Apr01               *
     F*                 158833             Date 17Apr01               *
     F*                 101578             Date 17Apr01               *
      * Midas DBA 3.04 -----------------------------------------------*
     F*                 166612             Date 18Oct00               *
      * Midas DBA 3.03 -----------------------------------------------*
     F*                 145752             Date 15Aug00               *
     F*                 179321             Date 26May00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 162643             Date 30Jun99               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 142092             Date 06Jul99               *
      *                 163583             Date 02Jul99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 153001             Date 26Apr99               *
      *                 CSD005             Date 02MAR99               *
      *                 CTI002             DATE 09Sep98               *
      *                 140802             Date 17Aug98               *
      *                 130543             Date 13FEB98               *
     F*                 106661             DATE 17SEP97               *
     F*                 120880             Date 05AUG97               *
     F*                 120470             Date 05AUG97               *
     F*                 114621             DATE 21FEB97               *
     F*                 CRT002             DATE 01DEC95               *
     F*                 CCB002             DATE 15JUL96               *
     F*                 S01408             DATE 30SEP96               *
     F*                 102740             DATE 28MAY96               *
     F*                 S01408             DATE 14MAR96               *
     F*                 S01408             DATE 11JAN96               *
     F*                 093546             DATE 11SEP95               *
     F*                 093545             DATE  8SEP95               *
     F*                 092429             DATE 24AUG95               *
     F*                 067827             DATE 24AUG95               *
     F*                 S01408             DATE 06SEP95               *
     F*                 091241             DATE 17JUL95               *
     F*                 CRT001  *CREATE    DATE 28FEB95               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD054623 - Use the format 'Transation Number/Teller ID +     *
      *             Narrative or Transaction Title if the             *
      *             RTSNarrFormat = 'Y'                               *
      *  MD054057 - Failure to close an account.  Check correct       *
      *             network files during account closure.             *
      *  CER050 - Annualised Percentage Rate (Recompile)              *
      *  CSD101 - Password Encryption                                 *
      *  MD050139- AOSARDR0 called every time causing performance     *
      *            issue. Recompile due to changes in /COPY           *
      *            ZFREQ/ZFRQ*.                                       *
      *  MD046248 - Finastra Rebranding                               *
      *  MD034451C - API: Repeated Held Item reversals are allowed.   *
      *              Recompiled due to changed PF/HELDIHB.            *
      *  CGL184 - New Frequencies for Account Statements (Recompile)  *
      *  CGL154 - FATCA Reporting (Recompile)                         *
      *  218877 - Recompiled due to changes in RTCCYSC1               *
      *         - Applied for MD-28376                                *
      *  MD042745 - Travellers Cheque Number is 12 char long.         *
      *  CCG016 - Correspondence Manager for Retail Teller System.    *
      *  252150 - COB component MEC103/GLC48 fails due to FOOB.       *
      *           Amend the program to match MOD/GLAMADUPD process    *
      *           when closing an account that is inserted the same   *
      *           day. Recompiled over changes ZSRSRC.RTACLSC1        *
      *           Applied for AR980794 (Child: AR980795)              *
      *  263834 - Account with Swift reference is deleted causing     *
      *           MEC105 fallover. Amended program in a way that      *
      *           that deletion is not allowed when record exists in  *
      *           file SWACSSB. Applied fix 263818.                   *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016 - German Interest Calculation: Upgarde of FGE059      *
      *           to Midas Plus (Recompile)                           *
      *  CER047 - German Features LF037-00 Reporting §24c KWG         *
      *           (Recompile)                                         *
      *  CER030 - Multicash German Feature (Recompile)                *
      *  BUG27532 - Several fields are blank in the confirmation page *
      *             (Recompile)                                       *
      *  BUG27045A - Override the fix of Bug 27045 (Recompile)        *
      *  BUG27045 - Amend via SOAP removes Document Linkage           *
      *             (Recompile)                                       *
      *  CAP205 - Teller Related APIs - Account Balance Check         *
      *  CAP204 - Teller Related APIs - Account Transfer (Recompile)  *
      *  CRE401 - 4-Eyes Checking Gaps - Sweeps (Recompile)           *
      *  CDL081 - Tiered withholding tax rounding upgrade             *
      *  CAP187 - Document Linkage (Recompile)                        *
      *  260297 - Incorrect interest calculation w/ calc basis 6.     *
      *           Recompiled over changes in RTINDEF1 and RTINDEF2    *
      *           Applied fix 220323.                                 *
      *  253892 - Amended source to avoid overlay of record formats   *
      *  253689 - Check for outstanding sweep accounts by using       *
      *           full account number and retail account number       *
      *           as search keys (BUG17640)                           *
      *  247188 - Recompile due to changes in display file.           *
      *  250891 - Initialise field @SKIP.                             *
      *  249968 - Add Validations if there are Outstanding            *
      *           Held Items, Stopped Checks, Standing Orders         *
      *           and SWEEP before an account is close.               *
      *  249218 - Applied fix 239004.                                 *
      *  239004 - 'Transaction Terminated' not shown when account's   *
      *           branch is not matched with teller ID branch.        *
      *  242286 - Recompile over changes in /COPY RTINTRE.            *
      *  241729 - Rename the field ACNO in CHQBKPT to make sure       *
      *           account number is not overwritten with wrong value. *
      *  CDL013 - Tiered Withholding Tax                              *
      *  165543 - Wrong CCY for Account Closure.                      *
      *           Recompile for changes in ZSRSRC/RTCLOSC1.           *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  BUG8514 - Issue regarding teller overrides(Recompile)        *
      *  CRT026 - Retail Teller Password Change                       *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  BUG7819 - If a retail account has insufficient funds,        *
      *            the system simply drop a Cash Withdrawal           *
      *            (non-account currency) transaction                 *
      *            Recompiled due to changes in the dspf RE4112DF     *
      *  BUG8168 - Display terminal error messages                    *
      *  BUG7638 - Some Tellers' transactions go to another teller    *
      *            in another branch.                                 *
      *            Recompiled due to change in the /COPY RBLDTLC1,    *
      *            RBLDTLE1, and RBLDTLI1.                            *
      *  BUG6342 - Interest calculation has 0.01 discrepancy.         *
      *            Recompiled over changes in RTINDEF1/2 and RTINTRE. *
      *            Applied fix 220323.                                *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG4470 - BOI cashier error 26. Recompiled due to changes in *
      *            /COPY RBMODTC1.                                    *
      *  BUG3229 - Process Cheque Books only, not GIRO.               *
      *  Bug3855 - Incorrect field definitions by CRT002              *
      *  BUG2849 - CRE019 amendments for Cashier Interface (Recompile)*
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CAAA03 - Recompile due to changes in RE4112DF.  Webfacing    *
      *           changes.                                            *
      *  CRE019 - Cheque Processing and Maintenance                   *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CRT012 - Recompiled due to changes in RBOITMI1               *
      *  201732 - Recompiled due to changes in RBMODTC1               *
      *  CRT007 - Cashier Branch Offline Checking                     *
      *  CRT005 - Recompiled due to changes in RTTWIDC1               *
     F*  198870 - Terminal errors missed in cashier, pad available    *
     F*           balance and uncleared funds with leading zeros,     *
     F*           reverse available balance convention for display    *
     F*           in cashier.  Display correct available balance and  *
     F*           recompilation of RBMODTC1. Don't pass host ref back *
     F*           to cashier when forwarding has terminal error.      *
     F*           Applies 166478,194391,198408,198448.                *
      *  194978 - Recompiled due to changes in RBMODTC1, RTTWIDC1 and *
      *           RTODCKC1.                                           *
      *  CRT006 - Cashier Reserve Transactions.                       *
      *  CDE002 - Revenue Analysis - Recompiled due to changes in     *
      *           PF/REFXAJL0.                                        *
      *  184205 - Recompiled due to change in RTSTPCC1.               *
      *  190137 - Addition of further warning messages.               *
     F*  174972 - Recompiled due to changes in /COPY RTCHQRC1.        *
     F*  159251 - Recompiled due to changes in RTCHQRC1.              *
     F*  158833 - Store value of element @O,@DF before calling RTBRCH *
     F*           and copy back if new value of @O,@DF is not 'Y'.    *
     F*  101578 - Recompiled due to changes in RTCCYXC1
      *  166612 - Recompile due to change in COPY source RBMODTC1     *
      *  145752 - Recompile due to change in COPY source RTBALCC1.    *
      *  179321 - Addition of extra warning messages, includes        *
      *           existing fix number 166475.                         *
     F*  162643 - Database error in SDBRCHPD when ccy entered and F10 *
     F*           taken for a/c closure in RTS mode.                  *
      *  142092 - Cannot get full description of errors appearing on  *
      *           teller screen in Cashier.                           *
      *  163583 - Terminal Errors are overwritten by Warning Errors   *
      *  153001 - A/c failed to close because minimum charge posted   *
      *           so balance was not zero. File RECRG no longer used  *
      *           as actual charges shown, ie. no minimum or maximum. *
      *           Includes changes to /COPYs RTCHRGC1, RTCLSCC1 &     *
      *           RTCOMMC1.                                           *
      *  CSD005 - Standing Data Account Narrative.  Add new field     *
      *           to SDACODPD.  Recompilation of programs.            *
      *  CTI002 - Recompiled : File SDACODPD changed                  *
     F*  140802 - /COPY RTCCYSC1 changes.  Change currency validation *
     F*           to check for @RTCD instead of *IN80 (not used)      *
     F*  130543 - Changed the array index for teller processing from  *
     F*           @I (2,0) to @J (3,0).  /COPY RBLDTLC1 and RBLDTLE1  *
     F*           were likewise amended.                              *
     F*  106661 - Include Closing Account projected movements         *
     F*           in RSACMTPD to allow passbook printing.             *
     F*           Note that this may cause a problem if Closed        *
     F*           Accounts (RECI = C) are allowed to have passbooks   *
     F*           printed in that these entries may be printed twice. *
     F*           This is not the case at the moment.(Upgrade 073990).*
     F*           Also supply 102740 for prventative maintenance.     *
     F*         102740-Using wrong field for number of decimal places.*
     F*  120880 - Recompiled due to change in RBMODTC1.               *
     F*  120470 - Ensure that the correct DR account branch code is   *
     F*           assigned before SR/MOVDET which chains to LF/REIAC. *
     F*  114621 - Replace blank with 'X' to mean not to validate      *
     F*           condition.                                          *
     F*  CRT002 - Retail Branch Access.                               *
     F*  CCB002 - COB Performance Enhancements                        *
     F*           Access now via access object                        *
     F*           MEMOS is now accessed via GL/RE key rather than old *
     F*           relative record number.                             *
     F*  S01408 - Addition of core hooks RE4112CP15                   *
     F*  102740 - Using wrong field for number of decimal places      *
     F*  S01408 - Addition of core hooks RE4112FFP1                   *
     F*           Addition of core hooks RE4112CP10                   *
     F*           Addition of core hooks RE4112CP11                   *
     F*           Addition of core hooks RE4112CP12                   *
     F*           Addition of core hooks RE4112CP13                   *
     F*           Addition of core hooks RE4112CP14                   *
     F*  S01408 - Addition of core hooks RE4112CCP8                   *
     F*                                  RE4112CCP9                   *
     F*  093546 - Recompile due to changes in DSPF/RE4112DF -- text   *
     F*           amendment and alignment of fields.                  *
     F*  093545 - Recompile due to changes in PRTF/RE4112P1 --        *
     F*           standardization of pagesize.                        *
     F*  092429 - Include RTS transaction narrative.                  *
     F*  067827 - Update TTRANPD with the narrative keyed in by the   *
     F*           user and cotvert the initial character 'R' of the   *
     F*           cheque reference number to '0' or this will be      *
     F*           converted to '9' when moved to a numeric field.     *
     F*  S01408 - Addition of hook RE4112IIP1.                        *
     F*           Addition of hook RE4112IIP2.                        *
     F*           Addition of hook RE4112CCP1.                        *
     F*           Addition of hook RE4112CCP2.                        *
     F*           Addition of hook RE4112CCP3.                        *
     F*           Addition of hook RE4112CCP4.                        *
     F*           Addition of hook RE4112CCP5.                        *
     F*           Addition of hook RE4112CCP6.                        *
     F*           Addition of hook RE4112CCP7.                        *
     F*  091241 - ATM Interface.  Recompiled.                         *
     F*  CRT001 - Retail Teller System                                *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F*
     FRE4112P1O   E                    PRINTER                        UC
     F** Validation Prints
     F*
     F*
     F***CHQBKPD UF  E           K        DISK         KINFSR *PSSR                           CRE019
     FCHQBKPD UF  E           K        DISK         KINFSR *PSSR A                            CRE019
     F                                              KCOMIT
     F** Cheque book details
     F*
     FCHQBKPT UF  E           K        DISK         KINFSR *PSSR                              CRE019
     F                                              KCOMIT                                    CRE019
      ** Cheque book trailer file                                                             CRE019
      *                                                                                       249968
     FHELDITL0IF  E           K        DISK                                                   249968
      ** Held Items                                                                           249968
      *                                                                                       CRE019
     FSTOPC   IF  E           K        DISK
     F** Stopped cheques
     F*
     FSTOPCL3 IF  E           K        DISK                                                   249968
     F            STOPCSDF                          KRENAMESTOPCSL3                           249968
      ** Stopped cheques detail                                                               249968
      *                                                                                       249968
     FSTANDL4 IF  E           K        DISK                                                   249968
      ** Standing Orders                                                                      249968
      *                                                                                       249968
     FSTANDL5 IF  E           K        DISK                                                   249968
     F            STANDSBF                          KRENAMESTANDSBG                           249968
      ** Standing Orders                                                                      249968
      *                                                                                       249968
     FRESWEPL5IF  E           K        DISK                                                   249968
     F            RESWEPD0                          KRENAMERESWEP5F                           253689
     FRESWEPL7IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP7F                           253689
     FRESWEPL8IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP8F                           253689
     FRESWEPL6IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP6F                           253689
      ** SWEEP                                                                                249968
      *                                                                                       249968
     FRSACMTPDO   E                    DISK         KINFSR *PSSR
     F                                              KCOMIT
     F** Shadow posting file
     F*
     FACCNT   UF  E           K        DISK         KINFSR *PSSR      UC
     F                                              KCOMIT
     F** Account master
     F*
     F***TTRANPD*O   E                    DISK         KINFSR *PSSR       CRT002
     FTTRANPD O   E                    DISK         KINFSR *PSSR      UC  CRT002
     F                                              KCOMIT
     F** Teller Transactions Details
     F*
     F***TTRANPT*UF  E                    DISK         KINFSR *PSSR       CRT002
     FTTRANPT UF  E                    DISK         KINFSR *PSSR      UC  CRT002
     F                                              KCOMIT
     F** Teller Transactions Trailer
     F*
     F/COPY WNCPYSRC,RE4112F001
     F**RECRG***IF  E           K        DISK                         UC  153001
     F***Retail*charges*file                                              153001
     F*
     FREIAC   IF  E           K        DISK                           UC
     F** Retail interest and charges
     F*
     FREACR   IF  E           K        DISK                           UC
     F** Retail interest accrual ITD
     F*
     FACNUM   IF  E           K        DISK
     F** Account Numbers Cross Reference File
     F            ACCNTABF                          KRENAMEACNUMABF
     F*
     FTTRNT   UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
     F** Teller Controls/Totals
     F*
     F****MEMOS***UF**E                    DISK         KINFSR *PSSR      CCB002
     F****************                              KCOMIT                CCB002
     F** Retail Shadow Balances
     F*
     FREFXAJL0IF  E           K        DISK
     F** Fixed accounts file
     F*
     F***RE4112DFCF  E                    WORKSTN                         CRT002
     FRE4112DFCF  E                    WORKSTN                        UC  CRT002
     F** Display file - Retail account transfer
     F*
     F** Retail savings account password file
     F/COPY ZSRSRC,RTPSWDF
     F*
     FSDSTAXPDIF  E                    DISK                           UC
     F** SD Tax File
     F*                                                                   092429
      *                                                                                       CDL013
     FACCNTBY0IF  E           K        DISK                           UC                      CDL013
     FSDSTAAL1IF  E           K        DISK                           UC                      CDL013
      *                                                                                       CDL013
     FTTNARPD O   E                    DISK         KINFSR *PSSR          092429
     F** Teller Narratives file (DR and CR)                               092429
     F                                              KCOMIT                092429
     FSWACB   IF  E           K        DISK         KINFSR *PSSR                              263834
     F            SWACSSAF                          KIGNORE                                   263834
     F            SWACSSCF                          KIGNORE                                   263834
      *                                                                                     MD054057
     FGLNWACL5IF  E           K        DISK         KINFSR *PSSR                            MD054057
      **  Midas GL GLNWACPD - By Brch/Custno/ccy/acod/accseq       PREFIX 'G'               MD054057
     FGLNW94L7IF  E           K        DISK         KINFSR *PSSR                            MD054057
      ** Midas GL GLNW94PD - By Brch/Custno/ccy/acod/accseq        PREFIX 'H'               MD054057
     F*
     F/COPY ZSRSRC,RTINDEF3
     F*
     F/COPY ZSRSRC,RTCOMMF1
     F*                                                                   CRT002
     F/COPY ZSRSRC,RBWLOGF1                                               CRT002
     F*                                                                   CRT002
     F/COPY ZSRSRC,RBLDTLF1                                               CRT002
     F*                                                                   CRT002
     F/COPY ZSRSRC,RTCCYSF1                                               CRT002
     F*                                                                   S01408
     F/COPY WNCPYSRC,RE4112FFP1                                           S01408
     F*                                                                   S01408
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   10  - Message Subfile End Indicator (SFLEND)                *
     F*                                                               *
     F*   20  - Display transaction terminated message                *
     F*   21  - Display "OVERRIDE REQUIRED" message                   *
     F*   22  - Display terminal or warning message codes             *
     F*   23  - Display override user id / password                   *                       CRT026
     F*   26  - Display override prompt                               *
     F*   27  - Display underline attributes                          *
     F*   28  - Display account balances                              *
     F*   29  - Display account closing balances                      *
     F*                                                               *
     F*   30  - Error in retail a/c number                            *
     F*   31  - Error in currency code                                *
     F*   32  - Error in credit account number                        *
     F*   33  - Error in amount                                       *
     F*   34  - Error in value date                                   *
     F*   35  - Error in cheque/reference                             *
     F*   36  - Error in narrative code                               *
     F*   37  - Error in department code                              *
     F*   38  - Error in override teller identifier                   *
     F*   39  - Error in override passcode                            *
     F*                                                               *
     F*   40  - Account closure selected                              *
     F*   41  - Account closure successful                            *
     F*   42  - Account closure unsuccessful                          *
     F*                                                               *
     F*   45  - Display "TRANSACTION COMPLETED" message               *
     F*                                                               *
     F*   59  - Work indicator for TESTN operation                    *
      *   60  - LOKUP 'equal to' on commas in available bal           *   198870
     F*                                                               *
      *   65  - NR indicator for SWACB                                *                       263834
     F*   67  - Update indicator                                      *
     F*   68  - Unsuccessful override                                 *
     F*   69  - Validation error                                      *
     F*                                                               *
     F*   70  - Record not found                                      *
     F*                                                               *
     F*   71  - Display retail account password                       *
     F*   72  - Narrative entered (DR)                                *   092429
     F*   73  - Narrative entered (CR)                                *   092429
     F*   76  - Display Withholding Tax                               *
     F*                                                               *
     F* 80-89 - Standard RTS subroutines                              *
     F*                                                               *
     F* 90-99 - Standard MIDAS subroutines                            *
     F*                                                               *
     F*   KA  - Accept transaction with override                      *
     F*   KB  - Display account balances                              *
     F*   KC  - Exit program.                                         *
     F*   KE  - Refresh screen                                        *
     F*   KJ  - A/C closure enquiry                                   *
     F*   KL  - Previous                                              *
     F*                                                               *
     F*   LR  - Last record indicator                                 *
     F*                                                               *
     F*   U6  - System error                                          *
     F* U7-U8 - Database error occurs                                 *
     F*                                                               *
     F*****************************************************************
      /SPACE 3
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  Control Subroutines                                          *
     F*                                                               *
     F*  ACLOSE - A/C closure enquiry                                 *
     F*  ACCDET - Accept details                                      *
     F*  CHKACC - Check account status                                *
     F*  DBERR  - Database error handling                             *
     F*  FIRST  - Initial Processing                                  *
     F*  LAST   - Final Processing                                    *
     F*  MAIN   - Main Processing                                     *
     F*  PCMTXT - Prepare Commitment Text                             *   CRT002
     F*  SNDMSG - Send program message parameters                     *
     F*  WRKACC - Work with account                                   *
     F*  WRKDET - Work with details                                   *
     F*  WRKOVR - Work with override                                  *
     F*  WRKTRN - Work with transaction                               *
     F*  *PSSR  - Program error                                       *
     F*                                                               *
     F*  Screen Handling                                              *
     F*                                                               *
     F*  DSPBAL - Display account balances                            *
     F*  DSPDET - Display details                                     *
     F*  DSPINL - Display initial screen                              *
     F*  DSPOVR - Display overrride screen                            *
     F*  EXTDET - Exit details    screen                              *
     F*  EXTOVR - Exit override screen                                *
     F*                                                               *
     F*  Screen Initialisation / Resets                               *
     F*                                                               *
     F*  RFRDET - Refresh details    screen                           *
     F*  RFRERR - Refresh warning/terminal error screen               *
     F*  RFRINL - Refresh initial screen                              *
     F*  RFROVR - Refresh override screen                             *
     F*                                                               *
     F*  Validation Subroutines                                       *
     F*                                                               *
     F*  VACCLO - Validate account closure                            *
     F*  VALINL - Validate initial screen                             *
     F*  VALTRN - Validate transaction                                *
     F*  VALDET - Validate details                                    *
     F*  VALOVR - Validate override                                   *
     F*  VOCOND - Validate override conditions                        *
     F*  VSACNO - Validate account number                             *
     F*  VSCCY  - Validate currency code                              *
     F*  VSCACN - Validate credit account number                      *
     F*  VSTNAM - Validate transaction amount                         *
     F*  VSVLDT - Validate value date                                 *
     F*  VSCQNF - Validate check number reference                     *
     F*  VSDEPC - Validate department code                            *
     F*  VSNRR1 - Validate narrative code                             *
     F*  VTCOND - Validate teller transaction conditions              *
     F*                                                               *
     F*  Updates Subroutines                                          *
     F*                                                               *
     F*  UACNUM - Update accounts                                     *
     F*  UCHQBK - Update cheque book                                  *
     F*  UMEMOC - Update credit memos                                 *
     F*  UMEMOD - Update debit memos                                  *
     F*  UPDATE - Update control                                      *
     F*  UTNTM2 - Update teller controls                              *
     F*  UTNTM3 - Update teller totals                                *
     F*  UTRANT - Update teller transaction trailer                   *
      *  UPTRL  - Update Control Trailer Record                       *                       CRE019
     F*  WRSACM - Write shadow postings                               *
     F*  WRSAC2 - Write shadow postings for Closure capitalisation.   *   106661
     F*  WTRAND - Write teller transacton details                     *
     F*                                                               *
     F*  Printing Subroutines                                         *
     F*                                                               *
     F*  PRTTRN - Print transaction                                   *
     F*                                                               *
     F*  Standard RTS Subroutines                                     *
     F*                                                               *
     F*  MOVDET - Move details to send to outgoing data queue         *   CRT002
     F*  PASSWD - Retail account password                             *
     F*  RTABAL - Account available balance check                     *
     F*  RTACLG - Account closing check                               *
     F*  RTACLS - Account closure updates                             *
     F*  RTBALC - Calculate available balances                        *
     F*  RTBDPT - Bad Debt check                                      *
     F*  RTBKCR - Block credit check                                  *
     F*  RTBKDR - Block debit check                                   *
     F*  RTBKPT - Bankrupt/Liquidation check                          *
     F*  RTBVIC - Back value check                                    *
     F*  RTRFCR - Refer credit check                                  *
     F*  RTRFDR - Refer debit check                                   *
     F*  RTBRCH - Branch different check                              *
     F*  RTCCYS - Currency setup                                      *
     F*  RTCCYX - Convert an amount in one ccy to another ccy         *
     F*           using exchange rate                                 *
     F*  RTCHQR - Cheque out of range check                           *
     F*  RTCHQP - Cheque present check                                *
     F*  RTCHRG - Calculate charges                                   *
     F*  RTCLSC - Calculate close details                             *
     F*  RTCLSE - Close account condition check                       *
     F*  RTCOMM - Calculate commission for account closure            *
     F*  RTIACT - Inactive account check                              *
     F*  RTINTR - Calculate interest                                  *
     F*  RTLCNV - Local currency conversion                           *
     F*  RTODCK - Exceed overdraft check                              *
     F*  RTSTPC - Stopped cheque check                                *
     F*  RTTCCY - Teller currency conditions check                    *
     F*  RTTLMT - Teller limit check                                  *
     F*  RTTOTS - Teller total updates                                *
     F*  RTTWID - Teller workstation conditions check                 *
     F*  RTVMSG  - Retrieve message from Message file                 *   CRT002
      *  SBTOFF - Set bit off                                         *                       CRE019
     F*  RTENCP - Encript passcode                                    *
     F*  RTWDAY - Non-working day check                               *
     F*                                                               *
     F*  Standard MIDAS Subroutines                                   *
     F*                                                               *
      *  PAD    - Pad field with leading zeros                        *   198870
     F*  CRINIT - Credit rates loading                                *
     F*  DATEIN - Date init processing                                *
     F*  DRINIT - Debit rates loading                                 *
     F*  INTCAL - Interest calculation between two dates              *
     F*  ZACCH  - Holiday standard subroutine                         *
     F*  ZALIGN - Validate amount fields                              *
     F*  ZCHKH  - Check holiday for ccy/locn subroutine               *
     F*  ZDATE1 - Validate dates submitted and convert to a           *
     F*           number of days                                      *
     F*  ZDATE2 - Convert date to dayno. to date formats              *
     F*  ZFRPED - Format and edit amount field                        *
     F*  ZICD   - Find number of days to calculate interest           *
     F*           according to calculation basis                      *
     F*  ZIC00  - Calculate interest (type=00)                        *
     F*  ZIC01  - Calculate interest (type=01)                        *
     F*  ZIC02  - Calculate interest (type=02)                        *
     F*  ZTNLU1 - Access dataarea for next transaction no.            *
     F*                                                               *
     F*  External Subroutines                                         *
     F*                                                               *
     F*  SCC0250 - Clear Message Queue                                *
     F*  SCC0240 - Send Message                                       *
     F*                                                               *
     F*  DBERRCTL Program error                                       *
     F*                                                               *
     F*****************************************************************
      /EJECT
     E*****************************************************************
     E*
     E/COPY WNCPYSRC,RE4112E001
     E                    CPY@    1   1 80               COPYRIGHT STATEMENT
     E*
     E/COPY ZSRSRC,ZDATE2Z1
     E** Array for SR.ZDATE1, SR.ZDATE2
     E*
     E/COPY ZSRSRC,RTXXXXE1
     E** Array for SR.RTBKDR, SR.RTBKCR, SR.RTRFDR, SR.RTRFCR, SR.RTIACT
     E*
     E/COPY ZSRSRC,ZALIGNZ1
     E** Array for both SR.ZALIGN, SR.ZEDIT
     E*
     E/COPY ZSRSRC,ZFRPEDZ1
     E** Array for SR.ZFRPED
     E*
     E                    @CY        24  3
     E** Teller currencies array
     E*
     E                    @CA        20  1
     E** Cheque presented status array
     E*
     E/COPY ZSRSRC,RTINDEF1
     E*
     E/COPY ZSRSRC,RTCOMME1
     E*
     E/COPY ZSRSRC,RTCCYSE1
     E** Array for SR.RTCCYS
     E*
     E/COPY ZSRSRC,RTENCPE1
     E** Array for SR.RTENCP
     E*
     E                    POWER   1   7  7 3             POWER ARRAY
     E*
     E                    @TXT    1   4 80               Text strings     CRT002
     E*                                                                   CRT002
     E/COPY ZSRSRC,ZHOLE
     E*
     E/COPY ZSRSRC,RTCHQPE1
     E*
     E/COPY ZSRSRC,RBMODTE1                                               CRT002
     E**  Array for SR.MOVDET                                             CRT002
     E*                                                                   CRT002
     E/COPY ZSRSRC,RBLDTLE1                                               CRT002
     E**  Array for SR.LODTLR                                             CRT002
     E*                                                                   CRT002
      /COPY ZSRSRC,ZDATE9Z1                                               CRT002
      ** Array for ZDATE9                                                 CRT002
      *                                                                   CRT002
      ** Array for padding with zeros                                     198870
     E                    RTE        16  1  A            Padding          198870
     E*****************************************************************
      /EJECT
     I*****************************************************************
     I/COPY WNCPYSRC,RE4112I002
     I*
     ISTOPCSCF
      ** Renamed fields in PF/STOPCSC
     I              FLSZ                            SCFLSZ
      *
     ISTOPCSDF
      ** Renamed fields in PF/STOPCSD
     I              ACNO                            SCACNO
      *
      /COPY ZSRSRC,RTINDEF4
     ITTRANPTF
      ** Renamed fields in PF/TTRANPT
     I              NORE                            TTNORE
      *
     ITTRNTM2F
      ** Renamed fields in PF/TTRNTM2
     I              RECI                            T2RECI
     I              NATN                            T2NATN
     I              RUND                            T2RUND
     ISTANDSBF                                                                                249968
      ** Renamed fields in LF/STANDL4                                                         249968
     I              TRAT                            BRAT                                      249968
     ISTANDSBG                                                                                249968
      ** Renamed fields in LF/STANDL5                                                         249968
     I              TRAT                            CRAT                                      249968
      *
      ** Rename fields to prevent overwrite                                                   263834
      *                                                                                       263834
     ISWACSSBF                                                                                263834
     I              RECI                            RECISW                                    263834
     I              CNUMA                           CNUMSW                                    263834
     I              CCY                             CCYSW                                     263834
     I              ACODQQ                          ACDQSW                                    263834
     I              ACSQ                            ACSQSW                                    263834
     I              CFSB                            CFSBSW                                    263834
     I              LSTD                            LSTDSW                                    263834
     I              NSTD                            NSTDSW                                    263834
     I              ACNO                            ACNOSW                                    263834
     I              STFQ                            STFQSW                                    263834
     I              STDY                            STDYSW                                    263834
     I              LSNO                            LSNOSW                                    263834
     I              UPRI                            UPRISW                                    263834
     I              DDIS                            DDISSW                                    263834
     I              BRCA                            BRCASW                                    263834
     I              IND                             INDSW                                     263834
     I              ZZ006                           ZZ06SW                                    263834
     I              LCD                             LCDSW                                     263834
     I              CHTP                            CHTPSW                                    263834
     I              TNLU                            TNLUSW                                    263834
     I              MT94                            MT94SW                                    263834
     I              ACOD                            ACODSQ                                    263834
      *                                                                                       263834
     IGLNWACD0                                                                              MD054057
     I              NARECI                          GRECI                                   MD054057
     I              NANWRK                          GNWRK                                   MD054057
     I              NABRCH                          GBRCA                                   MD054057
     I              NACNUM                          GCNUM                                   MD054057
     I              NACCY                           GCCY                                    MD054057
     I              QQACOD                          GQACOD                                  MD054057
     I              NAACSQ                          GACSQ                                   MD054057
     I              NANATY                          GNATY                                   MD054057
     I              NAG950                          GG950                                   MD054057
     I              NA5SFQ                          G5SFQ                                   MD054057
     I              NA5SDY                          G5SDY                                   MD054057
     I              NA5NSD                          G5NSD                                   MD054057
     I              NA5DSI                          G5DSI                                   MD054057
     I              NA5LCB                          G5LCB                                   MD054057
     I              NA5LSD                          G5LSD                                   MD054057
     I              NA5LST                          G5LST                                   MD054057
     I              NA5LSN                          G5LSN                                   MD054057
     I              NALCDT                          GLCDT                                   MD054057
     I              NACHTP                          GCHTP                                   MD054057
     I              NAUSER                          GUSER                                   MD054057
     I              NAACOD                          GACOD                                   MD054057
      *                                                                                     MD054057
     IGLNW94D0                                                                              MD054057
     I              N4RECI                          HRECI                                   MD054057
     I              N4NWRK                          HNWRK                                   MD054057
     I              N4BRCA                          HBRCA                                   MD054057
     I              N4CNUM                          HCNUM                                   MD054057
     I              N4CCY                           HCCY                                    MD054057
     I              QQACCD                          HQACCD                                  MD054057
     I              N4ACSQ                          HACSQ                                   MD054057
     I              N4NATY                          HNATY                                   MD054057
     I              N4DSTN                          HDSTN                                   MD054057
     I              N4DSTD                          HDSTD                                   MD054057
     I              N4LCDT                          HLCDT                                   MD054057
     I              N4CHTP                          HCHTP                                   MD054057
     I              N4USER                          HUSER                                   MD054057
     I              N4ACCD                          HACCD                                   MD054057
      *                                                                                     MD054057
     IACNUMABF
      ** Renamed fields in LF/ACNUM
     I              CCY                             ACCY
      *
     ICHQBKPDF
      ** Renamed fields in PF/CHQBKPD
     I              ACNO                            CQACNO
     I              BRCA                            CQBRCA                                    CRE019
     I              CHAC                            CQCHAC                                    CRE019
     I              CHAM                            CQCHAM                                    CRE019
      *                                                                                       CRE019
     ICHQBKPTF                                                                                CRE019
      ** Renamed fields in PF/CHQBKPT                                                         CRE019
     I              NORE                            NORET                                     CRE019
     I              ACNO                            ACNOT                                     241729
      *                                                                                       CRE019
      *
      /COPY ZSRSRC,RTXXXXI1
      ** Arrays for standard RTS subroutines
      *
      /COPY ZSRSRC,RTXXXXI2
      ** Data structure for 15 character account number
      *
      /COPY ZSRSRC,RTINDEF5
      *
      /COPY ZSRSRC,RTCOMMI1
      *
     I            DS
      ** 12 Character key
     I                                        1  12 @KEY
     I                                        2   30@CHGT
     I                                        4   80@CHST
     I                                        9  11 @CHCY
     I                                       12  12 @DDDD
     I*                                                                   092429
     I@@NARR      DS                             30                       092429
      ** Data structure to setup narrative for file                       092429
     I                                        1   50@@TBTN                092429
     I                                        6   6 @@SLSH                092429
     I                                        7   9 @@TBID                092429
     I                                       10  10 @@UNDS                092429
     I                                       11  30 SNARR                 092429
     I*                                                                   092429
     I@2NARR      DS                             30                       092429
      ** Data structure to setup narrative for file                       092429
     I                                        1   50@2TBTN                092429
     I                                        6   6 @2SLSH                092429
     I                                        7   9 @2TBID                092429
     I                                       10  10 @2UNDS                092429
     I                                       11  30 S2NARR                092429
      *
     I            DS                             72
      ** Data structure to initialise arrays
     I                                        1  72 CCYR1
     I                                        1  72 @CY
      *
     I@CADS       DS
      ** Data structure to initialise cheque presented status array
     I                                        1  20 CQPS
     I                                        1  20 @CA
      *                                                                   CCB002
     IUMEMER      DS                                                      CCB002
      ** Data structure for database error on call to AOMEMSR0.           CCB002
     I**********                              1   60U0CNUM                             CCB002 CSD027
     I                                        1   6 U0CNUM                                    CSD027
     I                                        7   9 U0CUCD                CCB002
     I**********                             10  130U0ACCD                             CCB002 CGL029
     I**********                             14  150U0ACSQ                             CCB002 CGL029
     I**********                             16  18 U0BRCA                             CCB002 CGL029
     I                                       10  190U0ACCD                                    CGL029
     I                                       20  210U0ACSQ                                    CGL029
     I                                       22  24 U0BRCA                                    CGL029
      *
      /COPY ZSRSRC,RTTOTSI1
      ** Data structures definitions for SR.RTTOTS
      *
     I            DS
      ** Data structure to hold key fields of LF/TTRNT
     I                                        1   5 @TTRNT
     I                                        1   1 KTBRI
     I                                        2   4 KTBID
     I                                        5   5 KRCTP
      *
     I            DS
      ** Data structure to amend output to cheque no field
     I                                        1   8 @SCQNF
     I                                        1   1 @RTEST
      *
     IPSDS       SDS
      ** Program Status Data Structure
      *
      ** Field containing program ID
     I                                        1  10 @PGM
      *
      ** Field containing workstation ID
     I                                      244 253 @JOB
      *
      ** Field containing user ID
     I                                      254 263 SUSER
      *
     I**  Data structure to for holding key list of cheque book file                          CRE019
     I@CHQBK      DS                             18                                           CRE019
     I                                        1  100KACNO                                     CRE019
     I                                       11  180KSCQN                                     CRE019
      *                                                                                       CRE019
     ICMTTXT      DS                            256
      ** Commitment Control Commit Text
     I                                        1   50NATN
     I                                        6   7 MDID
     I                                        8  15 PGMN
     I                                       16  18 WSIDX
     I                                       19  240MTIME
     I                                       25  25 ACTCDX
     I                                       26  35 USRIDX
      *
      ** Data structure for initial screen
     I                                       51 100 @INLDS
     I                                       51  60 SACNO1
     I                                       61  63 SCCY1
      *
      ** Data structure for details screen
     I                                      101 200 @DETDS
     I                                      101 110 SCACN
     I                                      111 124 STNAM
     I                                      125 130 SVLDT
     I                                      131 138 SCQNF
     I                                      139 168 SNRR1
     I                                      169 171 SDEPC
      *
      ** Data structure for override screen
     I                                      201 256 @OVRDS
     I                                      201 203 SOVTI
     I                                      204 209 SOVPC
     I                                      210 219 SOVUR                                     CRT026
     I                                      220 229 SOVPW                                     CRT026
      *                                                                   CRT002
     ITTIME       DS                             12                       CRT002
      *                                                                   CRT002
     I                                        1   2 WTHR                  CRT002
     I                                        3   4 WTMN                  CRT002
     I                                        5   6 WTSS                  CRT002
     I                                        1   60WTIME                 CRT002
      *                                                                   CRT002
     I                                        7   8 WDT1                  CRT002
     I                                        9  10 WDT2                  CRT002
     I                                       11  12 WDT3                  CRT002
     I                                        7  120WDATE                 CRT002
      *                                                                   CRT002
     I                                        1  120WTMDS                 CRT002
      * Data structure for AOSVALR0 string                                CRT012
     I            DS                                                      CRT012
     I                                        1 200 SVAL1                 CRT012
     I                                        1   1 SVAL11                CRT012
     I            DS                                                                        MD054623
     I                                        1 200 RTSN1                                   MD054623
     I                                        1   1 RTSN11                                  MD054623
      *                                                                   CRT012
      * System Value                                                      CRT012
     I            DS                                                      CRT012
     I I            'CashierMultCharge'       1  20 SVALK1                CRT012
     I            DS                                                                        MD054623
     I I            'RTSNarrFormat'           1  20 RTSNK1                                  MD054623
      *                                                                   CRT012
      *
      /COPY ZSRSRC,ZTNLU1Z1
      ** Array for SR.ZTNLU1
      *
      /COPY ZSRSRC,ZFRPEDZ2
      ** Data structure for SR.ZFRPED
      *
     I*                                                                   S01408
     I/COPY WNCPYSRC,RE4112IIP1                                           S01408
     I*                                                                   S01408
     I/COPY ZSRSRC,ZHOLI
     I*
     IRTSDTA     UDS                            256
      ** RTS job data area data structure
     I                                        1   3 PTLID
     I                                        4   6 PTLBC
     I                                        7   7 PSPVI
     I                                        8  32 POVIN
     I                                    P  33  390PCHTL
     I                                    P  40  460PNCTL
     I                                       90  92 PDEPC
      *
     ILDA         DS                            256
     I**  Local data area for data base errors.
     I*
     I                                        1   3 ERTLID
     I                                       11  20 ERTWID
     I                                       21  30 ERWSID
     I**  Field combining the following fields
     I                                      134 183 DBLOT
     I**  Name of database file in error
     I                                      134 141 DBFILE
     I**  Key value causing database error
     I                                      142 170 DBKEY
     I**  Name of program causing database error
     I                                      171 180 DBPGM
     I**  Number of database error
     I                                      181 1830DBASE
     I*
     I            DS                                                      CRT002
     I**  Data structure to hold string constants for QCMDEXC             CRT002
     I*                                                                   CRT002
     I                                        1  80 @CMD                  CRT002
     I                                       30  30 @BRI                  CRT002
     I                                       31  33 @BID                  CRT002
     I*                                                                   CRT002
     I            DS                                                      CRT002
     I**  Data structure to hold string constants for QCMDEXC             CRT002
     I*                                                                   CRT002
     I                                        1  80 @CMDT                 CRT002
     I                                       30  30 @BRIT                 CRT002
     I                                       31  33 @BIDT                 CRT002
     I*                                                                   CRT002
     ICITFTS    E DSCITFTS                        2                       CRT002
      ** Data area for Trickle Feed Time Stamp                            CRT002
      *                                                                   CRT002
     I                                        1   2 WNNSS                 CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBOITMI1                                               CRT002
     I*                                                                   CRT002
     I/COPY ZSRSRC,RBWLOGI1                                               CRT002
     I*                                                                   CRT002
     I/COPY ZSRSRC,RBMODTI1                                               CRT002
     I*                                                                   CRT002
     I/COPY ZSRSRC,RBLDTLI1                                               CRT002
     I*                                                                   CRT002
      /COPY ZSRSRC,ZDATE9Z2                                               CRT002
      ** Data structure for ZDATE9                                        CRT002
      *                                                                   CRT002
     I/COPY WNCPYSRC,RE4112I001
     ISDBANK    E DSSDBANKPD
     I** External data structure for Bank Details
     I*
     ISDBRCH    E DSSDBRCHPD                                              CRT002
     I**  Branch Codes                                                    CRT002
     I*                                                                   CRT002
     ISDGELR    E DSSDGELRPD                                              CRT002
     I**  General Ledger Details                                          CRT002
     I*                                                                   CRT002
     ISDRETL    E DSSDRETLPD
     I** External data structure for Retail Details
     I              QQACCD                          QQACD1                                    CGL029
     I*
     ISDNARR    E DSSDNARRPD
     I** External data structure for Narrative Codes
     I*
     ISDDEPT    E DSSDDEPTPD
     I** External data structure for Department Codes
     I*
     ISDCURR    E DSSDCURRPD
     I** External data structure for Currency Codes
     I*
     ISDRETR    E DSSDRETRPD
     I** External data structure for Retail Transaction Types
     I*
     ISDTELD    E DSSDTELDPD
     I** External data structure for Teller Identification Details
     I*
     ISDFNCD    E DSSDFNCDPD
     I** External data structure for Function Codes Details
     I*
     ISCSARD    E DSSCSARDPD
     I** External data structure for Switchable Features
     I*
     ISDACOD    E DSSDACODPD
     I** External data structure for Account Code Details
     I              QQACCD                          QQACD2                                    CGL029
     I*
     ISDCUST    E DSSDCUSTPD
     I** External data structure for Customer Details
     I              QQDFAC                          QQDFC1                                    CGL029
     I*
     IDSSDY     E DSDSSDY
     I** Second DS for access programs, Long data structure
     I*
     IDSFDY     E DSDSFDY
     I** First DS for access programs, Short data structure
     II#PARM      DS                           1024                                           CCG016
      ** Passed fields                                                                        CCG016
      **  Classification                                                                      CCG016
     I                                        1   3 I#BRCT                                    CCG016
     I                                        4   6 I#TLID                                    CCG016
     I                                        7   9 I#TBID                                    CCG016
     I                                       10  14 I#TBTN                                    CCG016
     I                                       15  17 I#FUNC                                    CCG016
     I                                       18  18 I#CLOS                                    CCG016
     I**********                             19  28 I#CHQN                           CCG016 MD042745
     I                                       19  30 I#CHQN                                  MD042745
      **  Accounts single, dr and cr                                                          CCG016
     I                                       41  46 I#CNUM                                    CCG016
     I                                       47  49 I#CCY                                     CCG016
     I                                       50  59 I#ACOD                                    CCG016
     I                                       60  61 I#ACSQ                                    CCG016
     I                                       62  64 I#BRCA                                    CCG016
     I                                       41  64 I#GLAR                                    CCG016
     I                                       65  74 I#ACNO                                    CCG016
     I                                       77  82 I#CNU1                                    CCG016
     I                                       83  85 I#CCY1                                    CCG016
     I                                       86  89 I#ACO1                                    CCG016
     I                                       90  91 I#ACS1                                    CCG016
     I                                       92  94 I#BRC1                                    CCG016
     I                                       77  94 I#GLA1                                    CCG016
     I                                       95 104 I#ACN1                                    CCG016
     I                                      107 112 I#CNU2                                    CCG016
     I                                      113 115 I#CCY2                                    CCG016
     I                                      116 119 I#ACO2                                    CCG016
     I                                      120 121 I#ACS2                                    CCG016
     I                                      122 124 I#BRC2                                    CCG016
     I                                      107 124 I#GLA2                                    CCG016
     I                                      125 134 I#ACN2                                    CCG016
      **  Transaction dets                                                                    CCG016
     I                                    P 137 1440I#AMNT                                    CCG016
     I                                      145 147 I#CCYT                                    CCG016
     I                                      148 198 I#NARR                                    CCG016
     I                                    P 199 2060I#CHQA                                    CCG016
     I                                    P 207 2138I#EXRT                                    CCG016
     I                                    P 217 2240I#BUYA                                    CCG016
     I                                      225 227 I#BUYC                                    CCG016
     I                                    P 228 2350I#SELA                                    CCG016
     I                                      236 238 I#SELC                                    CCG016
     I                                      239 288 I#NAR1                                    CCG016
     I                                      289 338 I#NAR2                                    CCG016
     I                                    P 347 3540I#INTA                                    CCG016
     I                                      355 357 I#INTC                                    CCG016
     I                                      358 407 I#INTN                                    CCG016
     I                                    P 417 4240I#TAXA                                    CCG016
     I                                      425 427 I#TAXC                                    CCG016
     I                                      428 477 I#TAXN                                    CCG016
     I                                    P 487 4940I#CHGA                                    CCG016
     I                                      495 497 I#CHGC                                    CCG016
     I                                      498 557 I#CHGN                                    CCG016
     I                                    P 567 5740I#TOTA                                    CCG016
     I                                      575 577 I#TOTC                                    CCG016
     I                                      578 627 I#TOTN                                    CCG016
     IO#PARM      DS                            256                                           CCG016
     I                                        1  10 O#ITEM                                    CCG016
     I                                       11  20 O#CUST                                    CCG016
     I                                       21  25 O#RSEQ                                    CCG016
     I                                       26  26 O#RLVL                                    CCG016
     I                                       27  29 O#RBCH                                    CCG016
     I                                       30  30 O#RARC                                    CCG016
      *                                                                                       CCG016
     I*                                                                   S01408
     I/COPY WNCPYSRC,RE4112IIP2                                           S01408
     I*                                                                   S01408
     IDSMEMS    E DSMEMOS                                                 CCB002
     I** External data structure for MEMOS Details                        CCB002
     I** Renamed fields in PF/MEMOS                                       CCB002
     I              CNUM                            MECNUM                CCB002
     I              CCY                             MECCY                 CCB002
     I              ACOD                            MEACOD                CCB002
     I              ACSQ                            MEACSQ                CCB002
      *
     IMUSER     E DSMUSERDD                                                                   CRT026
     I** External data structure for User Details                                             CRT026
     I** Renamed fields in PF/MUSERDD                                                         CRT026
     I              RECI                            RECIU                                     CRT026
     I              LCD                             LCDU                                      CRT026
      *                                                                                       CRT026
      ** Named constants                                                                      CDL081
      *                                                                                       CDL081
     I              'BasCcyTaxRoundDown'  C         C#BASE                                    CDL081
     I              'NBasCcyTaxRoundDown' C         C#NBAS                                    CDL081
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            MAIN   - Main Control Processing                   *
      *                                                               *
      * CALLS      ACLOSE - A/C closure enquiry                       *
      *            DSPINL - Display initial screen                    *
      *            FIRST  - Initial Processing                        *
      *            LAST   - Final Processing                          *
      *            RFRINL - Refresh initial screen                    *
      *            WRKACC - Work with account                         *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C*
      /COPY ZSRSRC,RTINDEF2
     C*
      *
      ** Initial Processing
     C                     EXSR FIRST
      *
      ** Main Processing
      *
      ** Refresh initial screen
     C                     EXSR RFRINL
      *
      ** Display initial screen
     C                     EXSR DSPINL
      *
      ** Do while Cmd/3 is not pressed
     C           *INKC     DOWEQ'0'
      *                                                                   106661
      ** Save the Closure intention for the Close Balance check.          106661
     C           *INKJ     IFEQ '1'                                       106661
     C                     MOVE 'Y'       CLREQ   1                       106661
     C                     ELSE                                           106661
     C                     MOVE 'N'       CLREQ                           106661
     C                     END                                            106661
      *
      ** If Cmd/5 is pressed, refresh initial screen
     C           *INKE     CASEQ'1'       RFRINL
      *
      ** If Cmd/10 is pressed, perform account closure enquiry
     C           *INKJ     CASEQ'1'       ACLOSE
      ** If Enter key is pressed, work with account
     C                     CAS            WRKACC
      *
     C                     END
      *
      ** Redisplay initial screen
     C                     EXSR DSPINL
      *
     C                     END
      *
      ** When Cmd/3 is pressed, perform last processing
     C                     EXSR LAST
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPINL - Display Initial Screen                    *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *            RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPINL    BEGSR                           ** DSPINL **
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
      *
      ** Display program message subfile for any messages
     C                     WRITERE4112C0
      *
     C/COPY WNCPYSRC,RE4112C005
      ***Display*warning/terminal*error(s)*screen**********************                       239004
     C**********           WRITERE4112F1                                                      239004
      *
      ** Display and accept initial screen
     C                     EXFMTRE4112F0
     C/COPY WNCPYSRC,RE4112C006
      *                                                                   CRT002
     C           PMODE     WHEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   REPOII                          CRT002
     C                     EXSR RDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
     C                     MOVE P@QDR     REPOII                          CRT002
      *                                                                   CRT002
     C           RAMSTY    IFNE '*END'                                    CRT002
      *                                                                   CRT002
      **  Move field RAFWST to work field WFWST                           CRT002
      *                                                                   CRT002
     C                     MOVE RAFWST    WFWST   1                       CRT002
     C                     MOVELRAUSID    SOVTI                           CRT002
     C                     MOVELWMAC1     SACNO1                          CRT002
     C                     MOVELRACCY1    SCCY1                           CRT002
     C                     MOVE RATRA1    STNAM                           CRT002
     C                     MOVELRAVLD1    SVLDT                           CRT002
     C                     MOVELWMAC2     SCACN                           CRT002
     C                     MOVELRARFLN    SCQNF                           CRT002
     C                     MOVELRANRL1    NARRI                           CRT002
     C                     MOVELRANRL3    NAR2I                           CRT002
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
     C                     CLEARWCMSG                                     CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVE 'N'       WSUCM                           CRT002
     C                     MOVE 'DR'      WSTAT                           CRT002
     C                     TIME           WTMDS  120                      CRT002
     C           WTHR      CAT  ':'       WA      3                       CRT002
     C           WTMN      CAT  ':'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WTSS      WSTTM                           CRT002
     C                     MOVE WSTTM     WRCTM   8                       CRT002
     C           WDT1      CAT  '/'       WA      3                       CRT002
     C           WDT2      CAT  '/'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WDT3      WRCDT   8                       CRT002
     C                     MOVELP@QDR     WCMSG                           CRT002
     C                     EXSR WRLOG                                     CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
      *                                                                   CRT002
     C                     MOVE '0'       *INKA                           CRT002
     C                     MOVE '0'       *INKB                           CRT002
     C                     MOVE '0'       *INKC                           CRT002
     C                     MOVE '0'       *INKE                           CRT002
     C                     MOVE '0'       *INKJ                           CRT002
     C                     MOVE '0'       *INKL                           CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
     C                     MOVE '1'       *INKC                           CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
      ** Clear warning/terminal error screen
     C                     EXSR RFRERR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  DSPINL - Display initial screen                    *
      *            RFRINL - Refresh initial screen                    *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRERR    BEGSR                           ** RFRERR **
      *
     C                     SETOF                     202122
     C                     SETOF                     29
     C                     MOVE *BLANKS   SACNO2
     C                     MOVE *BLANKS   SDANAM
     C                     MOVE *BLANKS   SCCY2
     C                     MOVEA*BLANKS   @W
     C                     MOVEA*BLANKS   @T
     C                     MOVEL*BLANKS   SMSG1
     C                     MOVEL*BLANKS   SMSG2
      *
      ** reset password field & indicator
      /COPY ZSRSRC,RTPSWDC3
      *
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKACC - Work with account                         *
      *                                                               *
      * CALLS      CHKACC - Check account status                      *
      *            RFRINL - Refresh initial screen                    *
      *            RTTWID - Teller workstation conditions check       *
      *            VALINL - Validate initial screen                   *
      *            WRKDET - Work with details                         *
      *            PAD    - Pad field with leading zeros              *   198870
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *            ACLOSE - A/C closure enquiry                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKACC    BEGSR                           ** WRKACC **
      *
     C                     SETOF                     4569
     C                     MOVE '0'       *IN41
     C                     MOVE '0'       *IN42
      *                                                                   CRT002
      ****Initialise*WSUS*(Posting-Was-Done-Against-Suspense ind)  CRT002 162643
     C**********           MOVE 'N'       WSUS    1                CRT002 162643
      *                                                                   CRT002
      **  Initialise account in error indicator to blank                  CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVE *BLANK    @RBAE                           CRT002
     C                     ENDIF                                          CRT002
      *
      ** If account closure not requested?  validate initial screen
     C           *IN40     IFEQ '0'
     C                     EXSR VALINL
     C                     END
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** Check for multiple sign on
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C***********          Z-ADD1         @I                       CRT002 130543
     C                     Z-ADD1         @J                              130543
     C                     MOVEL@TLID     @@PTL                           CRT002
     C                     MOVELRAUSID    @TLID                           CRT002
     C           @TLID     IFNE @@PTL                                     CRT002
     C***********@TLID     LOKUPWTL,@I                   60        CRT002 130543
     C           @TLID     LOKUPWTL,@J                   60               130543
     C           *IN60     IFEQ '1'                                       CRT002
     C***********@I        OCUR TELDS                  60          CRT002 130543
     C           @J        OCUR TELDS                  60                 130543
     C           *IN60     IFEQ '0'                                       CRT002
     C                     MOVELD@TLID    PTLID                           CRT002
     C                     MOVELD@TLBC    PTLBC                           CRT002
     C                     MOVELD@SPVI    PSPVI                           CRT002
     C                     MOVELD@OVRI    POVIN                           CRT002
     C**********           MOVELD@CHTL    PCHTL                                       CRT002 Bug3855
     C**********           MOVELD@NCTL    PNCTL                                       CRT002 Bug3855
     C                     Z-ADDD@CHTL    PCHTL                                              Bug3855
     C                     Z-ADDD@NCTL    PNCTL                                              Bug3855
     C                     MOVELD@DEPC    PDEPC                           CRT002
     C                     MOVELD@DEPC    SDEPC                           CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     MOVELPTLID     @TLID
     C                     EXSR RTTWID
      *
      ** If record not found?
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD1         DBASE            ***************
     C                     MOVE 'TTRNT'   DBFILE           ** DBERR 001 **
     C                     MOVEL@TTRNT    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
     C                     Z-ADDT2NATN    @NATN   50
      *
      ** Check for terminal conditions for DEBIT account
      *
     C                     MOVE SCCY1     SCCY2
     C                     MOVE ANAM      SDANAM
     C                     MOVE SACNO1    SACNO2
     C                     MOVE '1 '      @ACIN   2
      *                                                                   CRT002
      **  If transaction is not to be posted against suspense             CRT002
      *                                                                   CRT002
     C***********WSUS      IFEQ 'N'                                CRT002 163583
     C           PMODE     IFEQ 'I'                                       163583
     C                     EXSR CHKACC
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Retrieve Available Balance before transaction is carried out.   CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
      **  If transaction is not to be posted against suspense             CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'N'                                       CRT002
      *                                                                   CRT002
     C                     MOVELACCY      @CCY                            CRT002
     C                     Z-ADDRRNM      @RRNM                           CRT002
     C                     Z-ADDODLN      @ODLN                           CRT002
     C                     Z-ADDODED      @ODED                           CRT002
     C                     Z-ADDHELD      @HELD                           CRT002
     C                     MOVELSACNO1    @ACNOM                          198870
     C                     EXSR RTBALC                                    CRT002
      *                                                                   CRT002
     C           *IN80     IFEQ '0'                                       CRT002
      *                                                                   CRT002
     C**********           MOVEL'+'       RBAVBS                   CRT002 198870
      *                                                                   CRT002
     C           @AVBL     IFLT 0                                         CRT002
     C                     Z-SUB@AVBL     @AVBL                           CRT002
     C**********           MOVEL'-'       RBAVBS                   CRT002 198870
     C                     MOVEL'+'       RBAVBS                          198870
     C                     ELSE                                           198870
     C           @AVBL     IFGT 0                                         198870
     C                     MOVEL'-'       RBAVBS                          198870
     C                     ELSE                                           198870
     C                     MOVE ' '       RBAVBS                          198870
     C                     ENDIF                                          198870
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     MOVE @AVBL     ZFIELD                          CRT002
     C                     Z-ADD@CYDP     ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    RBAVBL                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVE '2'       @RBAE                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   198870
     C           PMODE     IFEQ 'P'                                       198870
     C           WSUS      ANDEQ'N'                                       198870
      *                                                                   198870
      ** If no validation error(s) exist?                                 198870
      *                                                                   198870
     C           *IN69     IFEQ '0'                                       198870
     C                     MOVE '1 '      @ACIN                           198870
     C                     EXSR CHKACC                                    198870
     C                     ENDIF                                          198870
     C                     ENDIF                                          198870
      *
      ** If no terminal error(s) exist?
     C           @TI       IFEQ 0
     C***********PMODE     ANDEQ'I'                                CRT002 163583
     C***********PMODE     OREQ 'P'                                CRT002 163583
      *
      ** Process transaction details
     C                     EXSR WRKDET
      *
      *                                                                   163583
     C********** PMODE     IFEQ 'P'                                163583 198870
     C********** WSUS      ANDEQ'N'                                163583 198870
      **********                                                   163583 198870
      ***If*no*validation error(s) exist?                          163583 198870
      **********                                                   163583 198870
     C********** *IN69     IFEQ '0'                                163583 198870
     C**********           MOVE '1 '      @ACIN                    163583 198870
     C**********           EXSR CHKACC                             163583 198870
     C**********           ENDIF                                   163583 198870
     C**********           ENDIF                                   163583 198870
      *                                                                   163583
      ** Refresh initial screen
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR RFRINL
     C                     END                                            CRT002
      *
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     MOVEL@BRCA     @WRK3   3                       120470
     C                     MOVEL@BRCAD    @BRCA                           120470
      *                                                                   120470
     C                     EXSR MOVDET                                    CRT002
      *                                                                   120470
     C                     MOVEL@WRK3     @BRCA                           120470
      *                                                                   CRT002
      **  Retrieve Available Balance after transaction is carried out for CRT002
      **  CR.                                                             CRT002
      *                                                                   CRT002
     C                     MOVEL@CCYC     @CCY                            CRT002
     C                     Z-ADD@RRNMC    @RRNM                           CRT002
     C                     Z-ADD@ODLNC    @ODLN                           CRT002
     C                     Z-ADD@ODEDC    @ODED                           CRT002
     C                     Z-ADD@HELDC    @HELD                           CRT002
     C                     MOVE SACNO1    @ACNOM                          198870
     C                     EXSR RTBALC                                    CRT002
      *                                                                   CRT002
      **  Account Balance Sign (after).                                   CRT002
      *                                                                   CRT002
     C           *IN80     IFEQ '0'                                       CRT002
      *                                                                   CRT002
     C**********           MOVEL'+'       RBABCS                   CRT002 198870
      *                                                                   CRT002
     C           @AVBL     IFLT 0                                         CRT002
     C                     Z-SUB@AVBL     @AVBL                           CRT002
     C***********          MOVEL'-'       RBABCS                   CRT002 198870
     C                     MOVEL'+'       RBABCS                          198870
     C                     ELSE                                           198870
      *                                                                   198870
     C           @AVBL     IFGT 0                                         198870
     C                     MOVEL'-'       RBABCS                          198870
     C                     ELSE                                           198870
     C                     MOVE ' '       RBABCS                          198870
     C                     ENDIF                                          198870
      *                                                                   198870
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Account Balance (after).                                        CRT002
      *                                                                   CRT002
     C                     MOVE @AVBL     ZFIELD                          CRT002
     C                     Z-ADDA6NBDP    ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    RBCAAB                          CRT002
     C                     MOVE *BLANKS   WFIELD                          198870
     C                     MOVE RBCAAB    WFIELD                          198870
     C                     EXSR PAD                                       198870
     C                     MOVEARTE       RBCAAB                          198870
     C                     MOVEA*BLANKS   RTE                             198870
      *                                                                   CRT002
      **  Account Name.                                                   CRT002
      *                                                                   CRT002
     C                     MOVELANAM      RBCCNM                          CRT002
      *                                                                   CRT002
      **  Uncleared Funds.                                                CRT002
      *                                                                   CRT002
     C                     MOVEL*ZEROS    ZFIELD                          CRT002
     C                     Z-ADDA6NBDP    ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    RBCAUF                          CRT002
      *                                                                   CRT002
      **  Timestamp.                                                      CRT002
      *                                                                   CRT002
     C           *LOCK     IN   CITFTS                                    CRT002
     C                     Z-ADD0         WNSN    20                      CRT002
     C                     MOVE WNNSS     WNSN                            CRT002
     C                     ADD  1         WNSN                            CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   WNNSS                           CRT002
     C                     MOVE WNSN      WNNSS                           CRT002
     C                     OUT  CITFTS                                    CRT002
      *                                                                   CRT002
     C                     Z-ADDBJRDNB    @@DAYN  50                      CRT002
     C                     EXSR ZDATE9                                    CRT002
     C           @@RTN     IFEQ '0'                                       CRT002
     C                     MOVE @@VDT     WCDAT   7                       CRT002
     C                     END                                            CRT002
     C           @@YR      IFGE 2000                                      CRT002
     C                     MOVEL'1'       WCDAT                           CRT002
     C                     ELSE                                           CRT002
     C                     MOVEL'0'       WCDAT                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     TIME           WTIME   60                      CRT002
     C                     MOVE WTIME     WTIMEC  6                       CRT002
      *                                                                   CRT002
     C           WCDAT     CAT  WTIMEC    WDT13  13                       CRT002
     C           WDT13     CAT  WNNSS     RBCTMS                          CRT002
      *                                                                   CRT002
      **  Retrieve Available Balance after transaction is carried out.    CRT002
      *                                                                   CRT002
     C                     MOVELACCY      @CCY                            CRT002
     C                     Z-ADD@RRNMD    @RRNM                           CRT002
     C                     Z-ADD@ODLND    @ODLN                           CRT002
     C                     Z-ADD@ODEDD    @ODED                           CRT002
     C                     Z-ADD@HELDD    @HELD                           CRT002
     C                     EXSR RTBALC                                    CRT002
      *                                                                   CRT002
      **  Account Balance Sign (after).                                   CRT002
      *                                                                   CRT002
     C           *IN80     IFEQ '0'                                       CRT002
      *                                                                   CRT002
     C**********           MOVEL'+'       RBABDS                   CRT002 198870
      *                                                                   CRT002
     C           @AVBL     IFLT 0                                         CRT002
     C                     Z-SUB@AVBL     @AVBL                           CRT002
     C**********           MOVEL'-'       RBABDS                   CRT002 198870
     C                     MOVEL'+'       RBAVBS                          198870
      *                                                                   198870
     C                     ELSE                                           198870
      *                                                                   198870
     C           @AVBL     IFGT 0                                         198870
     C                     MOVEL'-'       RBAVBS                          198870
     C                     ELSE                                           198870
     C                     MOVE ' '       RBAVBS                          198870
     C                     ENDIF                                          198870
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Account Balance (after).                                        CRT002
      *                                                                   CRT002
     C                     MOVE @AVBL     ZFIELD                          CRT002
     C                     Z-ADDA6NBDP    ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    RBDAAB                          CRT002
     C                     MOVE *BLANKS   WFIELD 16                       198870
     C                     MOVE RBDAAB    WFIELD                          198870
     C                     EXSR PAD                                       198870
     C                     MOVEARTE       RBDAAB                          198870
     C                     MOVEA*BLANKS   RTE                             198870
      *                                                                   CRT002
     C                     MOVELREPOIO    P@QDS                           CRT002
     C                     EXSR SDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVELREPOIO    WCMSG                           CRT002
     C                     EXSR WRLOG                                     CRT002
      *                                                                   CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
     C                     MOVEL*BLANKS   REPOIO                          CRT002
      *                                                                   CRT002
      **  Refresh initial screen                                          CRT002
      *                                                                   CRT002
     C                     EXSR RFRINL                                    CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALINL - Validate initial screen                   *
      *                                                               *
      * CALLS      VSACNO - Validate account number                   *
      *            VSCCY  - Validate currency code                    *
      *                                                               *
      * CALLED BY  WRKACC - Work with account                         *
      *            ACLOSE - A/C closure enquiry                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALINL    BEGSR                           ** VALINL **
      *
      ** Set off Validation error fields and indicators
     C                     SETOF                     202122
     C                     Z-ADD0         @TI     20
     C                     Z-ADD0         @WI     20
      *
      ** Validate Account Number
     C           *IN69     CASEQ'0'       VSACNO
     C                     END
      *
      ** Validate Currency Code
     C           *IN69     CASEQ'0'       VSCCY
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSACNO - Validate account number                   *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALINL - Validate initial screen                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSACNO    BEGSR                           ** VSACNO **
      *
      ** Set off error indicator(s)
     C                     SETOF                     30
     C                     SETOF                     70
      * Initialise suspense indicator                                     162643
     C                     MOVEL'N'       WSUS    1                       162643
      *
     C                     MOVE *BLANKS   SACN20 10
     C/COPY WNCPYSRC,RE4112C025
      *
      * Move fields to key list.
     C                     MOVELSACNO1    KACNO
     C                     MOVELKACNO     SACN20
      *
     C           SACNO1    IFNE SACN20
     C           KACNO     ORLT 0
     C                     SETON                     70
     C                     END
      *
      ** Get Account Details
     C           *IN70     IFEQ '0'
     C           KLACNO    CHAINACNUM                70
     C                     END
      *
      ** If debit account number not found?
     C           *IN70     IFEQ '1'
     C                     SETON                     30
      *                                                                   CRT002
      **  If not in Store and Forward Mode and no account is found        CRT002
      *                                                                   CRT002
     C           WFWST     IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       CRT002
     C                     MOVE 'USR0050' @MSGID
     C                     EXSR SNDMSG
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Post transaction to suspense                                    CRT002
      *                                                                   CRT002
     C                     MOVEL'Y'       WSUS                            CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ELSE
      *
      ** If account is a 'live' record?
     C           RECI      IFEQ 'D'
      *
      ** set up DEBIT account details
     C**********           Z-ADDCNUM      @CNUM                                               CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     Z-ADDACOD      @ACOD
     C                     Z-ADDACSQ      @ACSQ
     C**********           Z-ADDCNUM      @CNUMD  60                                   CCB002 CSD027
     C                     MOVE CNUM      @CNUMD  6                                           CSD027
     C**********           Z-ADDACOD      @ACODD  40                                   CCB002 CGL029
     C                     Z-ADDACOD      @ACODD 100                                          CGL029
     C                     Z-ADDACSQ      @ACSQD  20                      CCB002
     C                     Z-ADDRRNM      @RRNMD  50
     C                     MOVE BRCA      @BRCAD  3
     C                     MOVE RETB      @RETBD  1
     C                     Z-ADDODLN      @ODLND 110
     C                     Z-ADDODED      @ODEDD  50
     C                     Z-ADDMINB      @MINBD 150
     C                     Z-ADDHELD      @HELDD 150
     C                     Z-ADDLDID      @LDID1  50
     C                     MOVE DRIF      @DRIF1  1
     C                     Z-ADDLCID      @LCID1  50
     C                     MOVE CRIF      @CRIF1  1
     C                     MOVE STYP      @DSTYP  1
     C                     MOVE ACST      @DACST  1
      *
      ** Account referred must not be closed
     C                     ELSE
     C                     SETON                     30
      *                                                                   CRT002
      **  If not in Store and Forward Mode and account is closed          CRT002
      *                                                                   CRT002
     C           WFWST     IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       CRT002
     C                     MOVE 'USR0051' @MSGID
     C                     EXSR SNDMSG
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Post transaction to suspense                                    CRT002
      *                                                                   CRT002
     C                     MOVEL'Y'       WSUS                            CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     END
      *
      ** Save customer number for chain to Customer file
     C                     MOVE CNUM      @@CNUM  6
      *                                                                   CRT002
      **  If transaction is not to be posted to suspense                  CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'N'                                       CRT002
      *
      ** Retrieve Customer details
     C           *IN30     IFEQ '0'
     C*
     C                     MOVEL@@CNUM    @KEY1
     C                     CALL 'AOCUSTR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @KEY1  10
     C                     PARM *BLANKS   @KYST   7
     C           SDCUST    PARM SDCUST    DSSDY
     C*
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
      *                                                                   CRT002
      **  If not in Store and Forward Mode and no customer is found       CRT002
      *                                                                   CRT002
     C           WFWST     IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       CRT002
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD22        DBASE            ** DBERR 022 **
     C                     MOVE 'SDCUSTPD'DBFILE           ***************
     C                     MOVEL@KEY1     DBKEY
     C                     EXSR DBERR
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Post transaction to suspense                                    CRT002
      *                                                                   CRT002
     C                     MOVEL'Y'       WSUS                            CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     END
     C/COPY WNCPYSRC,RE4112C001
     C                     END
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                               *
     C                     END
      *                                                                                       263834
      ** For delete, Account should not have an attached SWACSSB record                       263834
      *                                                                                       263834
     C           *IN40     IFEQ '1'                                                           263834
     C                     MOVELCNUM      WWCNBR                                              263834
     C                     Z-ADDACOD      WWACOD                                              263834
     C                     Z-ADDACSQ      WWACSQ                                              263834
     C                     MOVELBRCA      WWBRCA                                              263834
     C                     MOVELACCY      WWCCY                                               263834
      *                                                                                       263834
      ** If CGL013 is on, account should not have an attached GLNW record.                  MD054057
      *                                                                                     MD054057
     C           CGL013    IFEQ 'Y'                                                         MD054057
     C           SWAKEY    CHAINGLNWACL5             80                                     MD054057
     C           *IN80     IFEQ '0'                                                         MD054057
     C           GRECI     ANDNE'*'                                                         MD054057
     C                     MOVE '1'       *IN30                                             MD054057
     C                     MOVE '1'       *IN69                                             MD054057
     C                     MOVE 'USR1147' ZAMSID                                            MD054057
     C                     CALL 'Y2SNMGC'                                                   MD054057
     C                     PARM           ZAPGM                                             MD054057
     C                     PARM           ZAPGRL                                            MD054057
     C                     PARM           ZAMSID                                            MD054057
     C                     PARM           ZAMSGF                                            MD054057
     C                     PARM *BLANK    ZAMSDA                                            MD054057
     C                     PARM           ZAMSTP                                            MD054057
     C                     ELSE                                                             MD054057
     C           SWAKEY    CHAINGLNW94L7             80                                     MD054057
     C           *IN80     IFEQ '0'                                                         MD054057
     C           HRECI     ANDNE'*'                                                         MD054057
     C                     MOVE '1'       *IN30                                             MD054057
     C                     MOVE '1'       *IN69                                             MD054057
     C                     MOVE 'USR1147' ZAMSID                                            MD054057
     C                     CALL 'Y2SNMGC'                                                   MD054057
     C                     PARM           ZAPGM                                             MD054057
     C                     PARM           ZAPGRL                                            MD054057
     C                     PARM           ZAMSID                                            MD054057
     C                     PARM           ZAMSGF                                            MD054057
     C                     PARM *BLANK    ZAMSDA                                            MD054057
     C                     PARM           ZAMSTP                                            MD054057
     C                     ENDIF                                                            MD054057
     C                     ENDIF                                                            MD054057
     C                     ELSE                                                             MD054057
     C           SWAKEY    CHAINSWACSSBF             65                                       263834
     C           *IN65     IFEQ '0'                                                           263834
     C           RECISW    ANDNE'*'                                                           263834
     C                     MOVE '1'       *IN30                                               263834
     C                     MOVE '1'       *IN69                                               263834
     C***********          MOVE '5045554' ZAMSID                                     263834 MD054057
     C                     MOVE 'USR1147' ZAMSID                                            MD054057
     C                     CALL 'Y2SNMGC'                                                     263834
     C                     PARM           ZAPGM                                               263834
     C                     PARM           ZAPGRL                                              263834
     C                     PARM           ZAMSID                                              263834
     C                     PARM           ZAMSGF                                              263834
     C                     PARM *BLANK    ZAMSDA                                              263834
     C                     PARM           ZAMSTP                                              263834
      *                                                                                       263834
      ** Clear all fields for default mechanism next time.                                    263834
      *                                                                                       263834
     C                     MOVEL*BLANK    ZAPGM                                               263834
     C                     MOVEL*BLANK    ZAPGRL                                              263834
     C                     MOVEL*BLANK    ZAMSDA                                              263834
     C                     MOVEL*BLANK    ZAMSTP                                              263834
     C                     ENDIF                                                              263834
     C                     ENDIF                                                            MD054057
     C                     ENDIF                                                              263834
      *                                                               *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSCCY  - Validate currency code                    *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            RTCCYS - Currency setup                            *
      *            DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  VALINL - Validate initial screen                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSCCY     BEGSR                           ** VSCCY  **
      *
      ** Set off error indicator(s)
     C                     SETOF                     31
      *
      ** If currency field is entered?
     C           SCCY1     IFNE *BLANKS
      *                                                                   CRT002
      **  When posting is not made against suspense                       CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       162643
      *
      ** Currency must be the same as the currency code
      ** of the account referred to?
     C           SCCY1     IFNE ACCY
     C                     SETON                     31
     C                     MOVE 'USR0052' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Get Branch Internal Customer Number                             CRT002
      *                                                                   CRT002
     C**********           CALL 'AOBRCHR0'                                             CRT002 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*KEY  '  @OPTN   7                       CRT002
     C                     PARM RABRNM    @BRCD   3                       CRT002
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        CRT002 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *                                                                   CRT002
      **  If record not found?                                            CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     Z-ADD34        DBASE                           CRT002
     C                     MOVEL'SDBRCHPD'DBFILE                          CRT002
     C                     MOVEL@BRCD     DBKEY                           CRT002
     C                     EXSR DBERR                                     CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     MOVELA8BICN    @@CNUM                          CRT002
     C                     MOVELA8BICN    @CNUM                           CRT002
     C                     MOVELRABRNM    @BRCA                           CRT002
      *                                                                   CRT002
      **  Get customer report name                                        CRT002
      *                                                                   CRT002
     C                     CALL 'AOCUSTR0'                                CRT002
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*KEY   ' @OPTN   7                       CRT002
     C                     PARM @@CNUM    @KEY1  10                       CRT002
     C                     PARM *BLANKS   @KYST   7                       CRT002
     C           SDCUST    PARM SDCUST    DSSDY                           CRT002
      *                                                                   CRT002
      **  If record not found?                                            CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     Z-ADD35        DBASE                           CRT002
     C                     MOVE 'SDCUSTPD'DBFILE                          CRT002
     C                     MOVEL@@CNUM    DBKEY                           CRT002
     C                     EXSR DBERR                                     CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     MOVELBKACCD    @ACOD                           CRT002
     C                     Z-ADD01        @ACSQ                           CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
      ** Else assume account currency code
     C                     ELSE
     C                     MOVE ACCY      SCCY1
     C                     END
      *
      ** If no validation errors?  get currency details
     C           *IN69     IFEQ '0'
     C                     MOVE SCCY1     @CCY
     C                     EXSR RTCCYS
      *
     C           @RTCD     IFEQ *BLANKS
     C                     Z-ADDTDP,@I    @CYDP
     C                     ELSE
     C           *LOCK     IN   LDA
     C                     Z-ADD2         DBASE            ***************
     C                     MOVE 'SDCURRL0'DBFILE           ** DBERR 002 **
     C                     MOVEL@CCY      DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            CHKACC - Check account status                      *
      *                                                               *
      * CALLS      RTBKDR - Block debit check                         *
      *            RTRFDR - Refer debit check                         *
      *            RTBKCR - Block credit check                        *
      *            RTRFCR - Refer credit check                        *
      *            RTIACT - Inactive account check                    *
      *            RTBKPT - Bankrupt/Liquidation check                *
      *            RTBDPT - Bad Debt check                            *
      *            RTBRCH - Branch different check                    *
      *            RTACLG - Account closing check                     *
      *                                                               *
      * CALLED BY  WRKACC - Work with account                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           CHKACC    BEGSR                           ** CHKACC **
      *
      ** If debit account?
     C           @ACIN     IFEQ '1'
     C                     MOVE @RETBD    @RETB
     C                     MOVE @BRCAD    @BRCA
      *
      ** Block debit check
     C***********@V,@BD    IFNE ' '                                       114621
     C           @V,@BD    IFNE 'X'                                       114621
     C                     EXSR RTBKDR
     C                     END
      *
      ** Refer debit check
     C***********@V,@RD    IFNE ' '                                       114621
     C           @V,@RD    IFNE 'X'                                       114621
     C                     EXSR RTRFDR
     C                     END
      *
     C                     END
      *
      ** If credit account?
     C           @ACIN     IFEQ '2'
     C                     MOVE @RETBC    @RETB
     C                     MOVE @BRCAC    @BRCA
      *
      ** Block credit check
     C***********@V,@BC    IFNE ' '                                       114621
     C           @V,@BC    IFNE 'X'                                       114621
     C                     EXSR RTBKCR
     C                     END
      *
      ** Refer credit check
     C***********@V,@RC    IFNE ' '                                       114621
     C           @V,@RC    IFNE 'X'                                       114621
     C                     EXSR RTRFCR
     C                     END
      *
     C                     END
      *
      ** Inactive account check
     C***********@V,@IA    IFNE ' '                                       114621
     C           @V,@IA    IFNE 'X'                                       114621
     C                     EXSR RTIACT
     C                     END
      *
      ** Bankrupt/Liquidation check
     C***********@V,@BL    IFNE ' '                                       114621
     C           @V,@BL    IFNE 'X'                                       114621
     C                     EXSR RTBKPT
     C                     END
      *
      ** Bad Debt check
     C***********@V,@DB    IFNE ' '                                       114621
     C           @V,@DB    IFNE 'X'                                       114621
     C                     EXSR RTBDPT
     C                     END
      *
      ** Branch different check
     C***********@V,@DF    IFNE ' '                                       114621
     C           @V,@DF    IFNE 'X'                                       114621
     C                     MOVELPTLBC     @TLBC
     C                     MOVE @O,@DF    WODF    1                       158833
     C                     EXSR RTBRCH
     C           @O,@DF    IFNE 'Y'                                       158833
     C                     MOVE WODF      @O,@DF                          158833
     C                     END                                            158833
     C                     END
      *
      ** Account closing check
     C***********@V,@AC    IFNE ' '                                       114621
     C           @V,@AC    IFNE 'X'                                       114621
     C                     MOVEL@DACST    @ACST
     C                     EXSR RTACLG
     C                     END
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
     C                     SETON                     2022
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
     C                     ELSE
      *
      ** If warning error(s) exist?
     C           @WI       IFGT 0
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
     C                     SETON                     22
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKDET - Work with details                         *
      *                                                               *
      * CALLS      ACCDET - Accept details                            *
      *            DSPDET - Display details                           *
      *            EXTDET - Exit details    screen                    *
      *            LAST   - Final Processing                          *
      *            RFRDET - Refresh detail screen                     *
      *                                                               *
      * CALLED BY  WRKACC -  Work with account                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKDET    BEGSR                           ** WRKDET **
      *
      ** Initialise work fields
     C           @WI       ADD  1         @WX     20
      *
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR RFRDET
      *
     C                     EXSR DSPDET
     C                     ENDIF                                          CRT002
      *
     C           *INKL     DOWEQ'0'
     C**                                                                  S01408
     C/COPY WNCPYSRC,RE4112CCP8                                           S01408
     C**                                                                  S01408
      *
      ** If Cmd/3 is pressed, exit this program
     C           *INKC     CASEQ'1'       LAST
      *
      ** If Cmd/5 is pressed, refresh details screen
     C           *INKE     CASEQ'1'       RFRDET
      *
      ** If Cmd/12 is pressed, return to previous routine
     C           *INKL     CASEQ'1'       EXTDET
      ** If Enter key is pressed, process screen input
     C                     CAS            ACCDET
      *
     C                     END
      *                                                                   CRT002
     C           *IN69     IFEQ '1'                                       CRT002
     C           PMODE     ANDEQ'P'                                       CRT002
     C                     LEAVE                                          CRT002
     C                     ENDIF                                          CRT002
      *
      ** Redisplay appropriate screen ( details    )
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR DSPDET
     C                     ENDIF                                          CRT002
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPDET - Display details                           *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPDET    BEGSR                           ** DSPDET **
      *
      ** If previous key has not been pressed or set on?
     C           *INKL     IFEQ '0'
      *
      ** Display program message subfile for any messages
     C                     WRITERE4112C0
      *
      ** Call password retrieval subroutine
      /COPY ZSRSRC,RTPSWDC1
      *
      ***Display*warning/terminal*error(s)*screen**********************                       239004
     C**********           WRITERE4112F1                                                      239004
      *
      ** Display and accept input screen
     C                     EXFMTRE4112F2
      *
     C**                                                                  S01408
     C/COPY WNCPYSRC,RE4112CCP9                                           S01408
     C**                                                                  S01408
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            ACCDET - Accept details                            *
      *                                                               *
      * CALLS      PRTTRN - Print transaction                         *
      *            UPDATE - Update control                            *
      *            VALDET - Validate details                          *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ACCDET    BEGSR                           ** ACCDET **
      *
     C                     SETOF                     21
      *
     C                     EXSR VALDET
      *
      ** If proceed to update?
     C           *IN67     IFEQ '1'
     C*                                                                   S01408
      ** Proceed to update? (i.e. no Outstanding Held Items, Stopped                          249968
      **                          Cheques, Standing Orders, SWEEPS  )                         249968
     C           @SKIP     IFEQ 'N'                                                           249968
     C/COPY WNCPYSRC,RE4112CCP1                                           S01408
     C*                                                                   S01408
      *
     C                     EXSR UPDATE
      *
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4112CCP2                                           S01408
     C                     MOVEL'N'       ##COPD                                              CCG016
     C           CCG016    IFEQ 'Y'                                                           CCG016
     C                     EXSR SNDUDC                                                        CCG016
     C                     END                                                                CCG016
     C           ##COPD    IFEQ 'N'                                                           CCG016
     C*                                                                   S01408
     C           PMODE     IFEQ 'I'                                       CRT002
     C/COPY WNCPYSRC,RE4112C016
     C                     EXSR PRTTRN
     C                     ENDIF                                                              CCG016
     C/COPY WNCPYSRC,RE4112C013
     C                     ENDIF                                          CRT002
      *
      ** End of commitment cycle
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C           CMTTXT    COMIT
     C                     ENDIF                                          CRT002
      *
      ** Display transaction completed
     C                     SETON                     45
     C                     ENDIF                                                              249968
      *
      ** If account closure is not requested?
     C           @CLOS     IFEQ ' '
     C                     SETOF                     4142
     C                     END
      *
      ** If account closure is successful?
     C           @CLOS     IFEQ 'Y'
     C                     SETON                     41
     C                     END
      *
      ** If account closure is unsuccessful?
     C           @CLOS     IFEQ 'N'
     C                     SETON                     42
     C                     END
      *
      ** Exit out of details screen and back to initial screen
     C                     MOVE '1'       *INKL
      *
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4112CCP3                                           S01408
     C*                                                                   S01408
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALDET - Validate details                          *
      *                                                               *
      * CALLS      RTODCK - Exceed OD check                           *
      *            RTTCCY - Teller currency conditions check          *
      *            VALTRN - Validate transaction                      *
      *            VACCLO - Validate account closure                  *
      *            VOCOND - Validate override conditions              *
      *            VTCOND - Validate teller transaction conditions    *
      *            VACCLO - Validate account closure                  *
      *            WRKOVR - Work with override                        *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALDET    BEGSR                           ** VALDET **
      *
     C                     SETOF                     6769
     C                     MOVEA*BLANKS   @W,@WX
      *
      ** Validate transaction
     C                     EXSR VALTRN
      *
      ** If error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** Perform teller currency conditions check
     C                     MOVELSCCY1     @CCY
     C                     EXSR RTTCCY
      *
     C           *IN89     IFEQ '1'
     C***********          SETON                     2269                 CRT002
     C                     MOVE *ON       *IN22                           CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     MOVE *ON       *IN69                           CRT002
     C                     ENDIF                                          CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C**********           MOVE *ON       *IN67                    CRT002 198870
     C                     MOVE *OFF      *IN67                           198870
     C                     ENDIF                                          CRT002
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
     C                     END
      *
      ** Validate teller transaction conditions
     C                     EXSR VTCOND
      *                                                                                       249968
      ** Initialise Skip Update Flag to 'N'                                                   249968
     C                     MOVEL'N'       @SKIP   1                                           249968
      *
      ** If a/c closure requested?  perform account closure check
     C           *IN40     IFEQ '1'
     C                     EXSR VACCLO
     C                     END
      *
      ** If a/c closure not requested  OR  unsuccessful a/c closure
      ** perform exceed overdraft check?
     C           *IN40     IFEQ '0'
     C           @CLOS     OREQ 'N'
     C                     Z-ADDCLBLN     @CLBL
     C                     MOVEL@DACST    @ACST
     C                     MOVEL@DSTYP    @STYP
     C                     EXSR RTODCK
     C                     END
      *
      ** Check for terminal conditions for CREDIT account
     C                     MOVE '2 '      @ACIN
     C                     EXSR CHKACC
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
      *
     C***********          SETON                     202269               CRT002
      ** Turn OFF *IN20, do not display TRANSACTION TERMINATED                               BUG8168
      **   error message                                                                     BUG8168
     C**********           MOVE *ON       *IN20                                       CRT002 BUG8168
     C                     MOVE *OFF      *IN20                                              BUG8168
     C                     MOVE *ON       *IN22                           CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     MOVE *ON       *IN69                           CRT002
     C                     ENDIF                                          CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C**********           MOVE *ON       *IN67                    CRT002 198870
     C                     MOVE *OFF      *IN67                           198870
     C                     ENDIF                                          CRT002
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
      ** exit out of details screen
     C**********           MOVE '1'       *INKL                                              BUG8168
      *
     C                     ELSE
      *
      ** If warning error(s) exist?
     C           @WI       IFGT 0
      *
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
     C                     SETON                     22
      *
      ** Move teller override indicators from DTAARA/RTSDTA
      ** to teller override array
     C                     MOVEAPOVIN     @R
      *
      ** Perform override validate process
     C                     EXSR VOCOND
      *
      ** Do not display override teller prompt if sign-on teller has
      ** authority to override?
     C           *IN68     IFEQ '0'
     C                     SETOF                     26
     C                     MOVE *OFF      *IN23                                               CRT026
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE *ON       *IN23                                               CRT026
     C                     ELSE                                                               CRT026
     C                     SETON                     26
     C                     ENDIF                                                              CRT026
     C                     END
      *
     C                     EXSR WRKOVR
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVE *ON       *IN67                           CRT002
     C                     ENDIF                                          CRT002
      *
     C                     ELSE
      *
     C                     SETON                     67
      *
     C                     END
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKOVR - Work with override                        *
      *                                                               *
      * CALLS      DSPBAL - Display account balances                  *
      *            DSPOVR - Display overrride screen                  *
      *            EXTOVR - Exit override screen                      *
      *            LAST   - Final Processing                          *
      *            RFROVR - Refresh override screen                   *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKOVR    BEGSR                           ** WRKOVR **
      *
      ** Set off underline attributes
     C                     SETOF                     27
      *
      ** Refresh override screen
     C                     EXSR RFROVR
      *
      ** If Display 'OVERRIDE REQUIRED' message required?
     C           @WI       IFGT 0
     C                     SETON                     21
     C                     END
      *
      ** Display override screen
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR DSPOVR
      *
     C           *INKL     DOWEQ'0'
      *
      ** If Cmd/1 is pressed, work with transaction
     C           *INKA     CASEQ'1'       WRKTRN
      *
      ** If Cmd/2 is pressed, display account balances
     C           *INKB     CASEQ'1'       DSPBAL
      *
      ** If Cmd/3 is pressed, exit this program
     C           *INKC     CASEQ'1'       LAST
      *
     C                     END
      *
      ** Redisplay appropriate screen ( override )
     C                     EXSR DSPOVR
      *
     C                     END
      *
      ** Return to previous screen
     C                     EXSR EXTOVR
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPOVR - Display overrride screen                  *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPOVR    BEGSR                           ** DSPOVR **
      *
      ** If previous key has not been pressed or set on?
     C           *INKL     IFEQ '0'
      *
      ** Display program message subfile for any messages
     C                     WRITERE4112C0
      *
      ** Call password retrieval subroutine
      /COPY ZSRSRC,RTPSWDC1
      *
      ***Display*warning/terminal*error*screen*************************                       239004
     C**********           WRITERE4112F1                                                      239004
      *
      ***Display*withdrwal*screen**************************************                       253892
     C**********           WRITERE4112F2                                                      253892
      *
      ** Display and accept override screen
     C                     EXFMTRE4112F3
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
      ** Set off account balances display
     C                     SETOF                     28
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            EXTOVR - Exit override screen                      *
      *                                                               *
      * CALLS      RFROVR - Refresh override screen                   *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           EXTOVR    BEGSR                           ** EXTOVR **
      *
      ** Refresh override screen
     C                     EXSR RFROVR
      *
      ** If no terminal error(s) exist?
     C           @TI       IFEQ 0
      *
     C           @WX       SUB  1         @WI
     C                     MOVEA*BLANKS   @W,@WX
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
      *
     C           @WI       IFGT 0
     C                     SETON                     22
     C                     ELSE
     C                     SETOF                     22
     C                     END
      *
      ** Set previous screen indicator off to return to details    screen
     C                     SETOF                     KL
      *
     C                     END
      *
      ** Set on underline attributes
     C                     SETON                     27
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPBAL - Display account balances                  *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTBALC - Calculate available balances              *
      *            ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPBAL    BEGSR                           ** DSPBAL **
      *
      ** Calculate available balances
     C                     MOVELSCCY1     @CCY
     C*********************Z-ADD@RRNMD    @RRNM                           CCB002
     C                     MOVE SACNO1    @ACNOM 100                      CCB002
      *                                                                   CCB002
     C                     Z-ADD@ODLND    @ODLN
     C                     Z-ADD@ODEDD    @ODED
     C                     Z-ADD@HELDD    @HELD
     C                     EXSR RTBALC
      *
      ** If MEMOS record not found?
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD3         DBASE            ***************
     C*********************MOVE 'MEMOS '  DBFILE           ** DBERR 003 **CCB002
     C*********************MOVEL@RRNM     DBKEY            ***************CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      *
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADDLDBLN     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SLDBL
      *
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@AVBL     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SAVBL
      *
     C                     SETON                     28
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * CALLS      RTODCK - Exceed OD check                           *
      *            SNDMSG - Send program message parameters           *
      *            VACCLO - Validate account closure                  *
      *            VALOVR - Validate override                         *
      *            VOCOND - Validate override conditions              *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKTRN    BEGSR                           ** WRKTRN **
      *
      ** If override teller id is prompted?
     C           *IN26     IFEQ '1'
     C           *IN23     OREQ *ON                                                           CRT026
      *
     C                     EXSR VALOVR
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** Move teller override indicators from PF/SDTELDPD
      ** to teller override array
     C                     MOVEAFROVRI    @R
      *
      ** Perform override validate process
     C                     EXSR VOCOND
      *
      ** If successful override?  Set on Previous screen indicator
      ** to return to update handling
     C           *IN68     IFEQ '0'
      *
      ** If a/c closure requested?  perform account closure check
     C           *IN40     IFEQ '1'
     C                     EXSR VACCLO
     C                     END
      *
      ** If a/c closure not requested  OR  unsuccessful a/c closure
      ** perform exceed overdraft check?
     C           *IN40     IFEQ '0'
     C           @CLOS     OREQ 'N'
     C                     Z-ADDCLBLN     @CLBL
     C                     MOVEL@DACST    @ACST
     C                     MOVEL@DSTYP    @STYP
     C                     EXSR RTODCK
     C                     END
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
      *
     C                     SETON                     202269
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
      ** exit out of details screen
     C                     MOVE '1'       *INKL
      *
     C                     ELSE
     C                     SETOF                     69
     C                     SETON                     67
     C                     MOVE '1'       *INKL
     C                     END
      *
      ** Else teller override failed
     C                     ELSE
     C                     MOVE 'USR0029' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     69
     C                     END
      *
     C                     END
      *
      ** Else no override prompted, set on indicator to update files
     C                     ELSE
     C                     SETON                     67
      *
      ** and exit out of override screen
     C                     MOVE '1'       *INKL
      *
     C                     END
      *
      ** Save screen error messages (later to be used for output)
     C                     MOVE *BLANKS   @MSG1  72
     C                     MOVE *BLANKS   @MSG2  72
     C                     MOVELSMSG1     @MSG1  72
     C                     MOVELSMSG2     @MSG2  72
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALOVR - Validate override                         *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            RTENCP - Encript passcode                          *
      *                                                               *
      * CALLED BY  DSPBAL - Display account balances                  *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALOVR    BEGSR                           ** VALOVR **
      *
      ** Set off validation error indicator
      ** and save field for override teller identifier
     C                     SETOF                     69
     C                     MOVE *BLANKS   @OVTI   3
      *
      ** If override teller identifier is not blank?
      ** If CRT026 is switch ON check user id if not blank                                    CRT026
      *                                                                                       CRT026
     C           SOVTI     IFNE *BLANK
     C           SOVUR     ORNE *BLANK                                                        CRT026
      *                                                                                       CRT026
      ** Access user id details to obtain the teller id attached                              CRT026
      ** to the user id                                                                       CRT026
      *                                                                                       CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'AOUSERR0'                                                    CRT026
     C                     PARM *BLANKS   PRTCD                                               CRT026
     C                     PARM '*KEY'    POPTN                                               CRT026
     C                     PARM SOVUR     @USRP  10                                           CRT026
     C           MUSER     PARM MUSER     DSSDY                                               CRT026
      *                                                                                       CRT026
     C           PRTCD     IFNE *BLANKS                                                       CRT026
     C           PRTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'MUSERDD' DBFILE           ***************                    CRT026
     C                     Z-ADD39        DBASE            ** DB ERR 39 **                    CRT026
     C                     MOVELSOVUR     DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           PRTCD     IFNE *BLANKS                                                       CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C                     MOVEL'USR1501' @MSGID                                              CRT026
     C                     EXSR SNDMSG                                                        CRT026
      ** If user id is valid use the teller attached to this user                             CRT026
      ** to obtain the teller details                                                         CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE TLID      @TELI                                               CRT026
     C                     ENDIF                                                              CRT026
      ** If CRT026 enhancement is switch OFF use the teller id                                CRT026
      ** entered to obtain the teller details                                                 CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE SOVTI     @TELI                                               CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
      ** If no validation errors exist                                                        CRT026
      *
      ** Get teller identifier details
     C*
     C           *IN69     IFEQ *OFF                                                          CRT026
     C                     CALL 'AOTELDR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C**********           PARM SOVTI     @TELI   3                                           CRT026
     C                     PARM           @TELI   3                                           CRT026
     C           SDTELD    PARM SDTELD    DSFDY
      *
      ** If record found?
     C           @RTCD     IFEQ *BLANKS
     C**********           MOVE SOVTI     @OVTI                                               CRT026
     C                     MOVE @TELI     @OVTI                                               CRT026
      *
      ** Teller Identifier not found
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVEL'USR1509' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0030' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     38
     C                     END
     C                     ENDIF                                                              CRT026
      *
      ** Teller identifier is required
      ** If CRT026 is switch ON User identifier is required                                   CRT026
      *                                                                                       CRT026
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1500' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0032' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     38
     C                     END
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** If teller passcode is not blank?
      ** If CRT026 is switch ON check user password if not blank                              CRT026
      *                                                                                       CRT026
     C           SOVPC     IFNE *BLANK
     C           SOVPW     ORNE *BLANK                                                        CRT026
      ** If CRT026 is switch ON check the password via REC4170                                CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'REC4170'                                                     CRT026
     C                     PARM           SOVUR                                               CRT026
     C                     PARM           SOVPW                                               CRT026
     C                     PARM *BLANKS   @RTCD   7                                           CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     SELEC                                                              CRT026
     C           @RTCD     WHEQ 'CPF2204'                                                     CRT026
     C                     MOVE 'USR1501' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF22E3'                                                     CRT026
     C                     MOVE 'USR1506' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF2203'                                                     CRT026
     C                     MOVE 'USR1507' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF2213'                                                     CRT026
     C                     MOVE 'USR1508' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF22E5'                                                     CRT026
     C                     MOVE 'USR1505' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E2'                                                     CRT026
     C                     MOVE 'USR1503' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E4'                                                     CRT026
     C                     MOVE 'USR1504' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E6'                                                     CRT026
     C                     MOVE 'USR1510' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E9'                                                     CRT026
     C                     MOVE 'USR1511' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF2225'                                                     CRT026
     C                     MOVE 'USR1512' @MSGID                                              CRT026
     C                     ENDSL                                                              CRT026
     C                     MOVE *ON       *IN39                                               CRT026
     C                     EXSR SNDMSG                                                        CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C                     ELSE                                                               CRT026
      *
      ** If teller passcode does not match?
      *
      ** Encript the passcode
     C                     MOVEASOVPC     BPWD
     C                     Z-ADD6         X       10
     C                     EXSR RTENCP
     C                     MOVEAEPWD      SOVPC
      *
     C           SOVPC     IFNE FRTLPC
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE 'USR0039' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     39
     C                     END
     C                     ENDIF                                                              CRT026
      *
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1502' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE 'USR0033' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     39
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFROVR - Refresh override screen                   *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *            EXTOVR - Exit override screen                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFROVR    BEGSR                           ** RFROVR **
      *
     C                     SETOF                     21
     C                     SETOF                     38
     C                     MOVEL*BLANKS   @OVRDS
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VTCOND - Validate teller transaction conditions    *
      *                                                               *
      * CALLS      RTABAL - Account available balance check           *
      *            RTCHQP - Cheque present check                      *
      *            RTCHQR - Cheque out of range check                 *
      *            RTSTPC - Stopped cheque check                      *
      *            RTTLMT - Teller limit check                        *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VTCOND    BEGSR                           ** VTCOND **
      *
     C*********************Z-ADD@RRNMD    @RRNM                          CCB002
     C                     MOVE SACNO1    @ACNOM                         CCB002
      *                                                                  CCB002
     C                     Z-ADD@ODLND    @ODLN
     C                     Z-ADD@ODEDD    @ODED
     C                     Z-ADD@HELDD    @HELD
     C                     Z-ADD@MINBD    @MINB
     C                     MOVE ' '       @UCQB
      *
      ** Insufficient funds check
      ** Exceed OD limit    check
      ** Minimum balance check
     C***********@V,@IF    IFNE ' '                                       114621
     C***********@V,@OD    ORNE ' '                                       114621
     C***********@V,@MB    ORNE ' '                                       114621
     C           @V,@IF    IFNE 'X'                                       114621
     C           @V,@OD    ORNE 'X'                                       114621
     C           @V,@MB    ORNE 'X'                                       114621
     C                     EXSR RTABAL
     C                     END
      *
      ** If cheque number entered & first character is Not 'R'?
     C           @CQNF     IFNE 0
     C           @RCHAR    ANDNE'R'
      *
      ** Stopped cheque check
     C***********@V,@SC    IFNE ' '                                       114621
     C           @V,@SC    IFNE 'X'                                       114621
     C                     MOVELSCCY1     @CCY
     C                     EXSR RTSTPC
     C                     END
      *
      ** Cheque out of range check
     C***********@V,@OR    IFNE ' '                                       114621
     C           @V,@OR    IFNE 'X'                                       114621
      *
      ** Save the existing ACNO before move
     C                     MOVELACNO      @ACNOB 10
     C                     MOVELSACNO1    ACNO
     C                     EXSR RTCHQR
     C                     MOVEL@ACNOB    ACNO
     C                     END
      *                                                                                       CRE019
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C           *IN81     ANDEQ*ON                                                           CRE019
     C                     MOVEL'Y'       WRNG    1                                           CRE019
     C                     ELSE                                                               CRE019
     C                     MOVEL'N'       WRNG                                                CRE019
     C                     ENDIF                                                              CRE019
      *
      ** Cheque present check and if no cheque out of range error?
     C***********@V,@CP    IFNE ' '                                       114621
     C           @V,@CP    IFNE 'X'                                       114621
     C           *IN81     ANDEQ'0'
     C                     MOVEA*ZEROS    @CQN
     C                     EXSR RTCHQP
     C                     END
      *
     C                     END
      *
      ** Teller limit check
     C***********@V,@TL    IFNE ' '                                       114621
     C           @V,@TL    IFNE 'X'                                       114621
     C                     MOVELSCCY1     @TCCY
     C                     MOVELBJLCCY    @LCCY
     C                     Z-ADD@TNAM     @TAM1
     C                     Z-ADD0         @TAM2
     C                     MOVEL@CSIN1    @TCI1
     C                     MOVEL' '       @TCI2
     C                     Z-ADDPCHTL     @CHTL
     C                     Z-ADDPNCTL     @NCTL
     C                     EXSR RTTLMT
     C                     END
      *
      ** Non-working day check
     C***********@V,@NW    IFNE ' '                                       114621
     C           @V,@NW    IFNE 'X'                                       114621
     C                     Z-ADD@VLDT     ZDAYNO
     C                     MOVELSCCY1     ZCCY
     C                     MOVE *BLANKS   ZLOC
     C                     EXSR RTWDAY
     C                     END
      *
      ** Backvaluation/ic check
     C***********@V,@BV    IFNE ' '                                       114621
     C           @V,@BV    IFNE 'X'                                       114621
      *
     C                     Z-ADD@LDID1    @LDID
     C                     MOVE @DRIF1    @DRIF
     C                     Z-ADD@LCID1    @LCID
     C                     MOVE @CRIF1    @CRIF
     C                     MOVE '1 '      @ACIN
     C                     EXSR RTBVIC
      *
     C                     Z-ADD@LDID2    @LDID
     C                     MOVE @DRIF2    @DRIF
     C                     Z-ADD@LCID2    @LCID
     C                     MOVE @CRIF2    @CRIF
     C                     MOVE '2 '      @ACIN
     C                     EXSR RTBVIC
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTBVICC1
      ** Backvaluation/IC check
      *
      /EJECT
      /COPY ZSRSRC,RTWDAYC1
      ** Non-working day check
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            VOCOND - Validate override conditions              *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VOCOND    BEGSR                           ** VOCOND **
      *
     C                     SETOF                     68
     C                     Z-ADD1         @I
      *
      ** Do until end of array reached or unsuccessful override found
     C           @I        DOUGT25
      *
      ** If element of override conditions is yes
      ** and teller override indicators array element is no?
     C           @O,@I     IFEQ 'Y'
     C           @R,@I     ANDEQ'N'
      *
      ** Return as unsuccessful override
     C                     SETON                     68
     C                     Z-ADD25        @I
     C                     END
      *
      ** Check next element
     C                     ADD  1         @I
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTABALC1
      ** Account available balance check for debit transaction
      *
      /COPY ZSRSRC,RTINTRE
      ** CALCULATION OF INTEREST
      *
      /EJECT
      /COPY ZSRSRC,RTSTPCC1
      ** Stopped cheque check
      *
      /EJECT
      /COPY ZSRSRC,RTCHQRC1
      ** Cheque out of range check
      *
      /EJECT
      /COPY ZSRSRC,RTCHQPC1
      ** Cheque present check
      *
      /EJECT
      /COPY ZSRSRC,RTODCKC1
      ** Overdraft check
      *
      /EJECT
      /COPY ZSRSRC,RTTLMTC1
      ** Teller limit check
      *
      /EJECT
      /COPY ZSRSRC,RTLCNVC1
      ** local currency conversion
      *
      /EJECT
      /COPY ZSRSRC,RTTCCYC1
      ** Teller currency conditions
      *
      /EJECT
      /COPY ZSRSRC,RTBALCC1
      ** calculate available balance
      *
      /EJECT
      /COPY ZSRSRC,RTCCYSC1
      ** currency setup
      *
      /EJECT
      /COPY ZSRSRC,RTACLSC1
      ** Account closure
      *
      /EJECT
      /COPY ZSRSRC,RTTWIDC1
      ** teller workstation-id conditions check
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRDET - Refresh detail screen                     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *            EXTDET - Exit details screen                       *
      *            RFRINL - Refresh initial screen                    *   CRT002
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRDET    BEGSR                           ** RFRDET **
      *
     C                     SETON                     27
     C                     SETOF                     323334
     C                     SETOF                     353637
     C                     SETOF                     2169
      *
     C/COPY WNCPYSRC,RE4112C007
      * If no warning errors exist?
     C           @WI       IFEQ 0
     C                     SETOF                     22
     C                     END
      *
     C                     MOVEL*BLANKS   @DETDS
     C*
     C** Load the teller's default department code
     C*
     C                     MOVE PDEPC     SDEPC
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALTRN - Validate transaction                      *
      *                                                               *
      * CALLS      VSCACN - Validate credit account number            *
      *            VSDEPC - Validate department code                  *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALTRN    BEGSR                           ** VALTRN **
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
      *
      ** Validate credit account number
     C                     EXSR VSCACN
      *
      ** Validate transaction amount
     C                     EXSR VSTNAM
      *
      ** Validate value date
     C                     EXSR VSVLDT
      *
      ** Validate cheque reference number
     C                     EXSR VSCQNF
      *
      ** Validate department code
     C                     EXSR VSDEPC
      *
      ** Validate narrative code
     C                     EXSR VSNRR1
      *                                                                   CRT002
     C           PMODE     WHEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     EXSR VSCACN                                    CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSTNAM                                    CRT002
     C                     ENDIF                                          CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSVLDT                                    CRT002
     C                     ENDIF                                          CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSCQNF                                    CRT002
     C                     ENDIF                                          CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSDEPC                                    CRT002
     C                     ENDIF                                          CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSNRR1                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSCACN - Validate credit account number            *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            ZALIGN - Validate amount fields                    *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSCACN    BEGSR                           ** VSCACN **
      *
     C                     SETOF                     32
     C                     SETOF                     70
      *
      ** If credit account is blanks?
     C           SCACN     IFNE *BLANKS
      *
     C                     MOVE *BLANKS   SACN20 10
      *
      ** Set up key list
     C                     MOVELSCACN     KACNO
     C                     MOVELKACNO     SACN20
      *
     C           SCACN     IFNE SACN20
     C           KACNO     ORLT 0
     C                     SETON                     70
     C                     END
      *
      ** Get Account Details
     C           *IN70     IFEQ '0'
     C           KLACNO    CHAINACNUM                70
     C                     END
      *
      ** If record found?
     C           *IN70     IFEQ '0'
      *
      ** If account is not a 'live' record?
     C           RECI      IFNE 'D'
     C                     SETON                     32
      *                                                                   CRT002
      **  If not in Store and Forward Mode and not a 'live' record        CRT002
      *                                                                   CRT002
     C           WFWST     IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     MOVE 'USR0051' @MSGID
     C                     EXSR SNDMSG
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Post transaction to suspense                                    CRT002
      *                                                                   CRT002
     C                     MOVEL'Y'       WSUS                            CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN69     ANDEQ'1'                                       CRT002
     C                     GOTO VSCAC9                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** If account entered is the same as the debit account?
     C           SCACN     IFEQ SACNO1
     C                     SETON                     32
     C                     MOVE 'USR0080' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN69     ANDEQ'1'                                       CRT002
     C                     GOTO VSCAC9                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** If credit a/c ccy is not the same as the debit a/c ccy?
     C           ACCY      IFNE SCCY1
     C                     SETON                     32
     C                     MOVE 'USR0081' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** If no validation error(s) exist?
     C           *IN32     IFEQ '0'
     C**********           Z-ADDCNUM      @CNUMC  60                                          CSD027
     C                     MOVE CNUM      @CNUMC  6                                           CSD027
     C                     MOVELACCY      @CCYC   3
     C**********           Z-ADDACOD      @ACODC  40                                          CGL029
     C                     Z-ADDACOD      @ACODC 100                                          CGL029
     C                     Z-ADDACSQ      @ACSQC  20
     C           PMODE     IFEQ 'P'                                       CRT002
     C**********           Z-ADD@CNUMC    @CNUM2                                       CRT002 CSD027
     C                     MOVE @CNUMC    @CNUM2                                              CSD027
     C                     MOVEL@CCYC     @CCY2                           CRT002
     C                     Z-ADD@ACODC    @ACOD2                          CRT002
     C                     Z-ADD@ACSQC    @ACSQ2                          CRT002
     C                     ENDIF                                          CRT002
     C                     Z-ADDRRNM      @RRNMC  50
     C                     Z-ADDODLN      @ODLNC 110                      CRT002
     C                     Z-ADDODED      @ODEDC  50                      CRT002
     C                     Z-ADDHELD      @HELDC 150                      CRT002
     C                     MOVE BRCA      @BRCAC  3
     C                     MOVE RETB      @RETBC  1
     C                     MOVELANAM      OCANAM
     C                     Z-ADDLDID      @LDID2  50
     C                     MOVE DRIF      @DRIF2  1
     C                     Z-ADDLCID      @LCID2  50
     C                     MOVE CRIF      @CRIF2  1
     C                     END
      *
      ** Else account number must refer to a live record
     C                     ELSE
     C                     SETON                     32
      *                                                                   CRT002
      **  If not in Store and Forward Mode and account is closed          CRT002
      *                                                                   CRT002
     C           WFWST     IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     MOVE 'USR0050' @MSGID
     C                     EXSR SNDMSG
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Post transaction to suspense                                    CRT002
      *                                                                   CRT002
     C                     MOVEL'Y'       WSUS                            CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     END
      *
      ** Else account must not be blanks or zeroes
     C                     ELSE
     C                     SETON                     32
      *                                                                   CRT002
      **  If not in Store and Forward Mode and account is blank           CRT002
      *                                                                   CRT002
     C           WFWST     IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     MOVE 'USR0079' @MSGID
     C                     EXSR SNDMSG
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Post transaction to suspense                                    CRT002
      *                                                                   CRT002
     C                     MOVEL'Y'       WSUS                            CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     END
      *                                                                   CRT002
      **  If transaction is posted to suspense                            CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'Y'                                       CRT002
      *                                                                   CRT002
      **  Get Branch Internal Customer Number                             CRT002
      *                                                                   CRT002
     C**********           CALL 'AOBRCHR0'                                             CRT002 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*KEY  '  @OPTN   7                       CRT002
     C                     PARM RABRNM    @BRCD   3                       CRT002
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        CRT002 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *                                                                   CRT002
      **  If record not found?                                            CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     Z-ADD36        DBASE                           CRT002
     C                     MOVEL'SDBRCHPD'DBFILE                          CRT002
     C                     MOVEL@BRCD     DBKEY                           CRT002
     C                     EXSR DBERR                                     CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     MOVELA8BICN    @CNUMC                          CRT002
     C                     MOVELA8BICN    @CNUM2                          CRT002
     C                     MOVELRABRNM    @BRCAC                          CRT002
      *                                                                   CRT002
      **  Get customer report name                                        CRT002
      *                                                                   CRT002
     C                     CALL 'AOCUSTR0'                                CRT002
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*KEY   ' @OPTN   7                       CRT002
     C                     PARM @@CNUM    @KEY1  10                       CRT002
     C                     PARM *BLANKS   @KYST   7                       CRT002
     C           SDCUST    PARM SDCUST    DSSDY                           CRT002
      *                                                                   CRT002
      **  If record not found?                                            CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     Z-ADD37        DBASE                           CRT002
     C                     MOVE 'SDCUSTPD'DBFILE                          CRT002
     C                     MOVEL@@CNUM    DBKEY                           CRT002
     C                     EXSR DBERR                                     CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     MOVELBKACCD    @ACODC                          CRT002
     C                     MOVELBKACCD    @ACOD2                          CRT002
     C                     Z-ADD01        @ACSQC                          CRT002
     C                     Z-ADD01        @ACSQ2                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
     C***********          ENDSR                                          CRT002
     C           VSCAC9    ENDSR                                          CRT002
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSTNAM - Validate transaction amount               *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            ZALIGN - Validate amount fields                    *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSTNAM    BEGSR                           ** VSTNAM **
      *
     C                     SETOF                     33
      *
      ** If amount field is entered?
     C           STNAM     IFNE ' '
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C                     MOVE STNAM     ZFIELD                          CRT002
     C                     Z-ADDA6NBDP    ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    STNAM                           CRT002
     C                     ENDIF                                          CRT002
      *
      ** Set up decimal values
     C***********          Z-ADDA6NBDP    ZADEC                           102740
     C***********13        SUB  A6NBDP    ZADIG                           102740
     C                     Z-ADD@CYDP     ZADEC                           102740
     C           13        SUB  @CYDP     ZADIG                           102740
      *
      ** Align amount
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE STNAM     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @TNAM  130                      E14168
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     33
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** Amount must not be blank or zero
     C                     ELSE
     C                     SETON                     33
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSVLDT - Validate value date                       *
      *                     Assign defaults if not entered            *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            ZDATE1 - Validate dates submitted and convert to a *
      *                     number of days                            *
      *            ZDATE2 - Convert date to dayno. to date formats    *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSVLDT    BEGSR                           ** VSVLDT **
      *
     C                     SETOF                     3499
      *
      ** If value date is blanks?  use run day number as value date
     C           SVLDT     IFEQ *BLANKS
     C                     Z-ADDBJRDNB    @VLDT
     C                     Z-ADD@VLDT     ZDAYNO
     C                     EXSR ZDATE2
      *
      ** Else validate input screen value date
     C                     ELSE
     C                     MOVE SVLDT     ZDATE
     C                     EXSR ZDATE1
      *
      ** If date is valid?
     C           *IN99     IFEQ '0'
     C                     Z-ADDZDAYNO    @VLDT   50
     C                     END
     C                     END
      *
      ** If Invalid date?
     C           *IN99     IFEQ '1'
     C                     MOVE 'USR0009' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     34
      *
      ** Else is value date prior to date account opened?
     C                     ELSE
      *
     C/COPY WNCPYSRC,RE4112C021
     C           @VLDT     IFLT DACO
     C                     MOVE 'USR0056' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     34
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN69     ANDEQ'1'                                       CRT002
     C                     GOTO VSVLD9                                    CRT002
     C                     ENDIF                                          CRT002
      *
     C* VALUE DATE MUST NOT BE LATER THAN RUN DATE
     C*
     C           @VLDT     IFGT BJRDNB
     C                     MOVE 'USR0088' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     34
     C                     END
      *
      ** If A/C closure requested?  value date must be equal to run-date
     C           *IN40     IFEQ '1'
     C           @VLDT     ANDNEBJRDNB
     C                     MOVE 'USR0058' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     34
     C                     END
      *
     C/COPY WNCPYSRC,RE4112C022
     C                     END
      *
     C***********          ENDSR                                          CRT002
     C           VSVLD9    ENDSR                                          CRT002
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSCQNF - Validate check number reference           *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSCQNF    BEGSR                           ** VSCQNF **
      *
     C                     SETOF                     35
     C                     MOVELSCQNF     @RCHAR  1
      *
      ** If cheque reference entered?
     C           SCQNF     IFNE *BLANKS
      *
      ** If cheque reference is numeric?
     C                     TESTN          SCQNF      59
     C           *IN59     IFEQ '1'
      *
      ** If numeric?  then debit account sub-type must be 'C'
     C           @DSTYP    IFEQ 'C'
     C                     MOVE SCQNF     @CQNF   80
     C                     ELSE
     C                     MOVE 'USR0074' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     35
     C                     END
      *
      ** Else if first character is not 'R', cheque reference is invalid
     C                     ELSE
      *
     C           @RCHAR    IFNE 'R'
     C                     MOVE 'USR0053' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     35
     C                     END
      *
     C                     END
      *
      ** Else if cheque reference = blank?   debit account sub-type must be 'S'
     C                     ELSE
      *
      ** Clear @CQNF to prevent error in validation.
     C                     MOVE *BLANKS   @CQNF
      *
     C/COPY WNCPYSRC,RE4112C023
     C           @DSTYP    IFNE 'S'
     C                     MOVE 'USR0075' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     35
     C                     END
     C/COPY WNCPYSRC,RE4112C024
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSNRR1 - Validate narrative code                   *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSNRR1    BEGSR                           ** VSNRR1 **
      *
     C                     SETOF                     36
      *
      ** If narrative code entered?
     C           SNRR1     IFNE *BLANKS
     C                     MOVELSNRR1     @NRR02  2
     C                     MOVE SNRR1     @NRR28 28
     C                     TESTN          @NRR02     59
      *
      ** If the first two positions are digits and the rest blanks
      ** Chain to narrative codes file?
     C           *IN59     IFEQ '1'
     C           @NRR28    ANDEQ*BLANKS
     C*
     C                     CALL 'AONARRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM @NRR02    @NVCD   2
     C           SDNARR    PARM SDNARR    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANK
     C                     MOVE 'USR0101' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     36
     C                     ELSE
     C                     MOVELALDON     SNRR1
     C                     END
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSDEPC - Validate department code                  *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSDEPC    BEGSR                           ** VSDEPC **
      *
     C                     SETOF                     37
      *
      ** If department code is not blank?
     C           SDEPC     IFNE *BLANK
      *
      ** Get department code details
     C*
     C                     CALL 'AODEPTR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           SDEPC   3
     C           SDDEPT    PARM SDDEPT    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANK
     C                     MOVE 'USR0054' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     37
     C                     END
      *
      ** Else department code is required
     C                     ELSE
     C                     MOVE 'USR0055' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     37
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            EXTDET - Exit details    screen                    *
      *                                                               *
      * CALLS      RFRDET - Refresh details    screen                 *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           EXTDET    BEGSR                           ** EXTDET **
      *
      ** Clear details    screen
     C                     EXSR RFRDET
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *           SNDMSG  - Send program message parameters           *
      *                                                               *
      * CALLS     SCC0240 - Send message to program queue             *
      *                                                               *
      * CALLED BY  DSPBAL - Display account balances                  *
      *            VALOVR - Validate override                         *
      *            VSACNO - Validate account number                   *
      *            VSCCY  - Validate currency code                    *
      *            VSCQNF - Validate check number reference           *
      *            VSCACN - Validate credit account number            *
      *            VSDEPC - Validate department code                  *
      *            VSNRR1 - Validate narrative code                   *
      *            VSVLDT - Validate value date                       *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED  @MSGID - Message id                                *
      *            @MSGF  - Message file                              *
      *                                                               *
      *****************************************************************
     C           SNDMSG    BEGSR                           ** SNDMSG **
      *
     C                     SETON                     69
      *
     C                     CALL 'SCC0240'
     C                     PARM           @MSGID
     C                     PARM           @MSGF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRINL - Refresh initial screen                    *
      *                                                               *
      * CALLS      RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRINL    BEGSR                           ** RFRINL **
      *
     C                     SETOF                     303132
     C                     SETOF                     353740
     C                     SETOF                     8182
     C                     MOVEL*BLANKS   @INLDS
     C                     MOVE ' '       @CLOS
      *
      ** If Cmd/5 is pressed?
     C           *INKE     IFEQ '1'
     C           @TI       OREQ 0
     C                     EXSR RFRERR
     C      KE             SETOF                     454142
     C                     END
      *
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     EXSR RFRDET                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VACCLO - Validate account closure                  *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VACCLO    BEGSR                           ** VACCLO **
      *
      ** Access shadow balances
     C***********@RRNM*****CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
     C** Chain access object AOMEMSR0                                     CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANK    W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' W0OPTN           O:Option       CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM SCCY1     W0CCY   3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACDD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACDD 100                                          CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
      ** If record not found?
     C************IN70*****IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE *BLANK                                    CCB002
     C           *LOCK     IN   LDA
     C           *LOCK     IN   LDA
     C                     Z-ADD4         DBASE            ***************
     C*********************MOVE 'MEMOS  ' DBFILE           ** DBERR 004 **CCB002
     C*********************MOVEL@RRNM     DBKEY            ***************CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      *
      ** Release record
     C*********************EXCPT@RLMEM                                    CCB002
      *
     C           @INTR     ADD  CLBLN     @WKBL  150
     C                     ADD  @WTAX     @WKBL
     C                     ADD  @CHRG     @WKBL
     C                     ADD  @TNAM     @WKBL
      *
      ** If record not found?
     C           @WKBL     IFEQ 0
     C                     MOVE 'Y'       @CLOS
     C                     ELSE
     C                     MOVE 'N'       @CLOS
     C                     END
      *
      ** If Held Amount Item is Found                                                         249968
     C           KACO      CHAINHELDIHBF             62                                       249968
     C           *IN62     IFEQ '0'                                                           249968
     C                     MOVEL'USR2412' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVEL'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              248968
      *                                                                                       249968
      ** If Stopped Cheque is Found                                                           249968
     C           KACO      CHAINSTOPCSL3             61                                       249968
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2413' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVEL'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
      ** If Standing Orders is Found using Debit Retail Account                               249968
     C           KACO      CHAINSTANDSBF             61                                       249968
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2414' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVE 'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
      ** If Standing Orders is Found using Credit Retail Account                              249968
     C           KACO      CHAINSTANDSBG             61                                       249968
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2414' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVE 'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
      ** If SWEEP is Found                                                                    249968
      ** Check for Credit Sweep Account                                                       253689
      *                                                                                       253689
     C********** KSWEEP    CHAINRESWEPD0             61                                249968 253689
     C           KSWEEP    CHAINRESWEP5F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP2     CHAINRESWEP6F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP1     CHAINRESWEP7F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP2     CHAINRESWEP8F             61                                       253689
     C                     ENDIF                                                              253689
     C                     ENDIF                                                              253689
     C                     ENDIF                                                              253689
      *                                                                                       253689
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2415' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVE 'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPDATE - Update control                            *
      *                                                               *
      * CALLS      UACNUM - Update accounts                           *
      *            UMEMOD - Update debit memos                        *
      *            UMEMOC - Update credit memos                       *
      *            UPDATE - Update control                            *
      *            UTNTM2 - Update teller controls                    *
      *            UTNTM3 - Update teller totals                      *
      *            UTRANT - Update teller transaction trailer         *
      *            WRSACM - Write shadow postings                     *
      *            WRSAC2 - Write shadow postings for Closure         *   106661
      *            WTRAND - Write teller transacton details           *
      *            ZTNLU1 - Access dataarea for next transaction no.  *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UPDATE    BEGSR                           ** UPDATE **
      *
      ** Access and update next available transaction number
     C                     EXSR ZTNLU1
      *
     C                     TIME           STIME   60
     C                     Z-ADD@NATN     STTLU
      *
     C/COPY WNCPYSRC,RE4112C004
      ** Update all files
     C                     EXSR WTRAND
     C/COPY WNCPYSRC,RE4112C012
     C*                                                                   092429
     C** WRITE DETAILS TO THE NARRATIVE FILE                              092429
     C*                                                                   092429
     C                     EXSR NARRUP                                    092429
      *
     C                     EXSR UTRANT
      *
     C                     EXSR UTNTM2
      *
     C                     EXSR UTNTM3
      *
      **  If transaction is not posted to suspense                        CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'N'                                       CRT002
     C                     EXSR UMEMOD
      *
     C                     EXSR UMEMOC
     C                     ENDIF                                          CRT002
      *
     C                     EXSR UACNUM
      *
      ** If first character of cheque number is Not 'R'
      ** and cheque book indicator indicates update? update cheque book
     C           @RCHAR    IFNE 'R'
     C           @UCQB     ANDEQ'Y'
     C           GCQI      ANDEQ*ZERO                                                        BUG3229
     C           WRNG      OREQ 'Y'                                                           CRE019
     C           GCQI      ANDEQ*ZERO                                                        BUG3229
     C                     EXSR UCHQBK
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WTRAND - Write teller transacton details           *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WTRAND    BEGSR                           ** WTRAND **
      *                                                                   CRT002
      **  If not the first time, delete previous overrides                CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C           @CMD      IFNE *BLANKS                                   CRT002
     C                     MOVEL*BLANKS   @CMD                            CRT002
     C                     MOVEL@TXT,3    @CMD                            CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMD                            CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Perform override to PF/TTRANPD & open file                      CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   @CMD                            CRT002
     C                     MOVEL@TXT,1    @CMD                            CRT002
     C                     MOVEL'T'       @BRI                            CRT002
     C                     MOVEL@TLID     @BID                            CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMD                            CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     MOVEL'QCMDEXC' P@QRS                           CRT002
     C                     MOVEL@CMDT     P@QKY                           CRT002
     C                     EXSR DQERR                                     CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     OPEN TTRANPD                70                 CRT002
      *                                                                                       CRT006
      ** Acknowledged Flag will be processed from the transaction                             CRT006
      ** application data queue message if running in batch mode.                             CRT006
      ** Interactively, Acknowledged Flag will be set to 'Y'.                                 CRT006
     C           PMODE     IFEQ 'P'                                                           CRT006
     C                     MOVE RAACKF    ACKF                                                CRT006
     C                     ELSE                                                               CRT006
     C                     MOVE 'Y'       ACKF                                                CRT006
     C                     ENDIF                                                              CRT006
      *
      ** Format record details
     C                     MOVEL'D'       RECI
     C                     MOVEL'T'       TBRI
     C                     MOVELPTLID     TBID
     C                     MOVEL@NATN     TBTN
      *                                                                   CRT002
      **  If transaction is not posted to suspense                        CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'N'                                       CRT002
     C                     MOVE SACNO1    ACNO
     C                     MOVEL*BLANKS   CUS1                            CRT002
     C                     MOVEL*BLANKS   CCY1                            CRT002
     C                     MOVEL*BLANKS   ACD1                            CRT002
     C                     MOVEL*BLANKS   ACSQ1                           CRT002
     C                     ELSE                                           CRT002
     C                     MOVEL*BLANKS   ACNO                            CRT002
     C                     MOVEL*BLANKS   ANAM                            CRT002
     C                     MOVEL@CNUM     CUS1                            CRT002
     C                     MOVELSCCY1     CCY1                            CRT002
     C                     MOVEL@ACOD     ACD1                            CRT002
     C                     MOVEL@ACSQ     ACSQ1                           CRT002
     C                     ENDIF                                          CRT002
     C                     MOVELPFNCD     FNCD
     C                     MOVELSCCY1     CCY1
     C                     MOVELSCACN     TTAC
     C                     Z-ADD@TNAM     AMT1
     C                     MOVELPTLBC     ITLB
     C*                                                                   067827
     C** If initial character of reference cheque number is 'R',          067827
     C** convert it to '0'.                                               067827
     C                     MOVE SCQNF     @SCQNF                          067827
     C           @RTEST    IFNE 'R'                                       067827
     C                     MOVELSCQNF     CQNF
     C                     ELSE                                           067827
     C                     MOVE '0'       @RTEST                          067827
     C                     MOVEL@SCQNF    CQNF                            067827
     C                     END                                            067827
     C                     MOVELSDEPC     DEPC
     C                     MOVEL@JOB      TWID
     C                     MOVELSTIME     TIME
     C                     MOVEL@OVTI     OVTI
     C                     MOVEL@CLOS     CLOS
     C                     Z-ADD@RRNM     MRR1
     C                     MOVEL@MSG1     MSG1
     C                     MOVEL@MSG2     MSG2
     C                     Z-ADD@VLDT     VLDT
     C                     MOVE SNRR1     TTNR
     C                     MOVEL@UCQB     UCQB
     C           WRNG      IFEQ 'Y'                                                           CRE019
     C                     MOVEL'Y'       UCQB                                                CRE019
     C                     ENDIF                                                              CRE019
      *
     C/COPY WNCPYSRC,RE4112C008
      *                                                                                       CRT012
      * Move Transaction Type passed in from Cashier to new field on                          CRT012
      * TTRANPD                                                                               CRT012
     C           CRT012    IFEQ 'Y'                                                           CRT012
     C                     MOVELWCSHTT    CSHTT                                               CRT012
     C                     ENDIF                                                              CRT012
     C                     WRITETTRANPDF
      *
     C                     CLOSETTRANPD                70                 CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTRANT - Update teller transaction trailer         *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTRANT    BEGSR                           ** UTRANT **
      *                                                                   CRT002
      **  If not the first time, delete previous overrides                CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C           @CMDT     IFNE *BLANKS                                   CRT002
     C                     MOVEL*BLANKS   @CMDT                           CRT002
     C                     MOVEL@TXT,4    @CMDT                           CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMDT                           CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Perform override to PF/TTRANPT & open file                      CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   @CMDT                           CRT002
     C                     MOVEL@TXT,2    @CMDT                           CRT002
     C                     MOVEL'T'       @BRIT                           CRT002
     C                     MOVEL@TLID     @BIDT                           CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMDT                           CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     MOVEL'QCMDEXC' P@QRS                           CRT002
     C                     MOVEL@CMDT     P@QKY                           CRT002
     C                     EXSR DQERR                                     CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     OPEN TTRANPT                70                 CRT002
      *
      ** Access teller transaction trailer
     C           1         CHAINTTRANPTF             70
      *
      ** If record not found?
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD5         DBASE            ***************
     C                     MOVE 'TTRANPT' DBFILE           ** DBERR 005 **
     C                     MOVEL'1'       DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
      ** Increment no. of records
     C                     ADD  1         TTNORE
      *
      ** Update teller transaction trailer
     C                     UPDATTTRANPTF
      *
     C                     CLOSETTRANPT                70                 CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTNTM2 - Update teller controls                    *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTTCCY - Teller currency conditions check          *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTNTM2    BEGSR                           ** UTNTM2 **
      *
      * Move fields to key list.
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     MOVEL'1'       KRCTP
      *
      ** Get Teller Control Details
     C           KLTRNT    CHAINTTRNT                70
      *
      ** If record not found?
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD6         DBASE            ***************
     C                     MOVE 'TTRNT'   DBFILE           ** DBERR 006 **
     C                     MOVEL@TTRNT    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
      ** Format record details
     C                     ADD  1         T2NATN
      *
      ** If currency of account is not present on currencies array?
      ** in PF/TTRNTM2, update array with account currency
     C                     MOVELSCCY1     @CCY
     C                     EXSR RTTCCY
     C           @CY,@I    IFEQ '   '
     C                     MOVELSCCY1     @CY,@I
     C                     END
      *
      ** Update teller controls
     C                     UPDATTTRNTM2F
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTNTM3 - Update teller totals                      *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTTOTS - Teller total updates                      *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTNTM3    BEGSR                           ** UTNTM3 **
      *
      * Move fields to key list.
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     MOVEL'2'       KRCTP
      *
      ** Get Teller Control Details
     C           KLTRNT    CHAINTTRNT                70
      *
      ** If record not found?
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD7         DBASE            ***************
     C                     MOVE 'TTRNT'   DBFILE           ** DBERR 007 **
     C                     MOVEL@TTRNT    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
      ** Obtain currency totals using debit transaction type 1 details
     C                     MOVELSCCY1     @CCY
     C                     Z-ADD@TNAM     @TAMT
     C                     MOVEL@RVIN1    @RVIN
     C                     MOVEL@DCIN1    @DCIN
     C                     MOVEL@CSIN1    @CSIN
     C                     MOVEL@CLIN1    @CLIN
     C                     EXSR RTTOTS
      *
      ** Obtain currency totals using crebit transaction type 1 details
     C                     MOVELSCCY1     @CCY
     C                     Z-ADD@TNAM     @TAMT
     C                     MOVEL@RVIN2    @RVIN
     C                     MOVEL@DCIN2    @DCIN
     C                     MOVEL@CSIN2    @CSIN
     C                     MOVEL@CLIN2    @CLIN
     C                     EXSR RTTOTS
      *
      ** Update teller tansaction no. of last update
     C                     Z-ADD@NATN     TTLU
      *
      ** Update teller totals
     C                     UPDATTTRNTM3F
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UMEMOD - Update debit memos                        *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UMEMOD    BEGSR                           ** UMEMOD **
      *
      ** Retrieve PF/MEMOS details
     C***********@RRNMD****CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
     C** Chain access object AOMEMSU0                                     CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUMD    W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUMD    W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM @CCY      W0CCY   3        O:Currency     CCB002
     C**********           PARM @ACODD    W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACODD    W0ACCD 100                                          CGL029
     C                     PARM @ACSQD    W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCAD    W0BRCA  3        O:Branch       CCB002
     C                     PARM BJRDNB    W0PSTD  50       O:Posting date CCB002
     C                     PARM @VLDT     W0VDAT  50       O:Value date   CCB002
     C                     PARM @TNAM     W0AMT  150       O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV  1        O:FT override  CCB002
      *
      ** If record not found?
     C************IN70*****IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE *BLANKS                                   CCB002
     C           *LOCK     IN   LDA
     C                     Z-ADD8         DBASE            ***************
     C*********************MOVE 'MEMOS  ' DBFILE           ** DBERR 008 **CCB002
     C                     MOVE 'AOMEMSU0'DBFILE           ***************CCB002
     C*********************MOVEL@RRNM     DBKEY            ***************
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
     C/COPY WNCPYSRC,RE4112C017
      *
      ** If value date is less than or equal to today's date?
      ** add transaction amount to cleared balance
     C***********@VLDT*****IFLE BJRDNB                                    CCB002
     C*********************ADD  @TNAM     CLBLN                           CCB002
     C*********************END                                            CCB002
      *
      ** add transaction amount to ledger balance
     C*********************ADD  @TNAM     LDBLN                           CCB002
      ** include net interest amount if closing.                          106661
     C           CLREQ     IFEQ 'Y'                                       106661
     C           @CLOS     ANDEQ'Y'                                       106661
     C                     Z-ADD@INTRS    SUMT   150                      106661
     C                     ADD  @CHRG     SUMT                            106661
      *                                                                   106661
     C** Chain access object AOMEMSU0                                     106661
     C                     CALL 'AOMEMSU0'                                106661
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  106661
     C                     PARM 0         W0RETL 100       O:Retail A/C No106661
     C**********           PARM @CNUMD    W0CNUM  60       O:Customer No.              106661 CSD027
     C                     PARM @CNUMD    W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM @CCY      W0CCY   3        O:Currency     106661
     C**********           PARM @ACODD    W0ACCD  40       O:Account Code              106661 CGL029
     C                     PARM @ACODD    W0ACCD                                              CGL029
     C                     PARM @ACSQD    W0ACSQ  20       O:Account Seq. 106661
     C                     PARM @BRCAD    W0BRCA  3        O:Branch       106661
     C                     PARM BJRDNB    W0PSTD  50       O:Posting date 106661
     C                     PARM BJRDNB    W0VDAT  50       O:Value date   106661
     C                     PARM SUMT      W0AMT  150       O:Movement amt 106661
     C                     PARM 'N'       W0FTOV  1        O:FT override  106661
      *                                                                   106661
      ** If record not found?                                             106661
     C           W0RTCD    IFNE *BLANKS                                   106661
     C           *LOCK     IN   LDA                                       106661
     C                     Z-ADD20        DBASE            ***************106661
     C                     MOVE 'AOMEMSU0'DBFILE           ** DBERR 020 **106661
     C**********           Z-ADDW0CNUM    U0CNUM           ***************             106661 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          106661
     C                     Z-ADDW0ACCD    U0ACCD                          106661
     C                     Z-ADDW0ACSQ    U0ACSQ                          106661
     C                     MOVE W0BRCA    U0BRCA                          106661
     C                     MOVELUMEMER    DBKEY                           106661
     C                     EXSR DBERR                                     106661
     C                     END                                            106661
     C/COPY WNCPYSRC,RE4112C018
     C                     END                                            106661
      *
      ** Update PF/MEMOS record
     C*********************UPDATMEMOSMDF                                  CCB002
      *
      ** Write shadow postings
     C                     Z-ADD0         DORC
     C                     EXSR WRSACM
      *                                                                   106661
      ** Write interest and charge records to RSACMTPD if required        106661
     C                     EXSR WRSAC2                                    106661
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UMEMOC - Update credit memos                       *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UMEMOC    BEGSR                           ** UMEMOC **
      *
      ** Retrieve PF/MEMOS details
     C***********@RRNMC****CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
      ** Reverse sign of @TNAM                                            CCB002
     C                     Z-SUB@TNAM     @NTNAM 130                      CCB002
      *                                                                   CCB002
     C** Chain access object AOMEMSU0                                     CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUMC    W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUMC    W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM @CCYC     W0CCY   3        O:Currency     CCB002
     C**********           PARM @ACODC    W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACODC    W0ACCD                                              CGL029
     C                     PARM @ACSQC    W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCAC    W0BRCA  3        O:Branch       CCB002
     C                     PARM BJRDNB    W0PSTD  50       O:Posting date CCB002
     C                     PARM @VLDT     W0VDAT  50       O:Value date   CCB002
     C                     PARM @NTNAM    W0AMT  150       O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV  1        O:FT override  CCB002
      *
      ** If record not found?
     C************IN70*****IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE *BLANKS                                   CCB002
     C           *LOCK     IN   LDA
     C                     Z-ADD9         DBASE            ***************
     C*********************MOVE 'MEMOS  ' DBFILE           ***************CCB002
     C                     MOVE 'AOMEMSU0'DBFILE           ** DBERR 009 **CCB002
     C*********************MOVEL@RRNMC    DBKEY            ***************CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
     C/COPY WNCPYSRC,RE4112C019
      *
      ** If value date is less than or equal to today's date?
      ** add transaction amount to cleared balance
     C***********@VLDT*****IFLE BJRDNB                                    CCB002
     C*********************SUB  @TNAM     CLBLN                           CCB002
     C*********************END                                            CCB002
      *
      ** add transaction amount to ledger balance
     C*********************SUB  @TNAM     LDBLN                           CCB002
      *
      ** Update PF/MEMOS record
     C*********************UPDATMEMOSMDF                                  CCB002
      *
      ** Write shadow postings
     C                     Z-ADD1         DORC
     C                     EXSR WRSACM
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRSACM - Write shadow postings                     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRSACM    BEGSR                           ** WRSACM **
      *
      ** If DEBIT postings?
     C           DORC      IFEQ 0
     C**********           Z-ADD@CNUM     CUSN                                                CSD027
     C                     MOVE @CNUM     CUSN                                                CSD027
     C                     MOVEL@CCY      CCYD
     C                     Z-ADD@ACOD     ACDE
     C                     Z-ADD@ACSQ     ASNC
     C                     MOVEL@BRCAD    BRCA
     C                     MOVEL@PASS1    PASS
     C                     END
      *
      ** If CREDIT postings?
     C           DORC      IFEQ 1
     C**********           Z-ADD@CNUMC    CUSN                                                CSD027
     C                     MOVE @CNUMC    CUSN                                                CSD027
     C                     MOVEL@CCYC     CCYD
     C                     Z-ADD@ACODC    ACDE
     C                     Z-ADD@ACSQC    ASNC
     C                     MOVEL@BRCAC    BRCA
     C                     MOVEL@PASS2    PASS
     C                     END
      *
     C                     Z-ADDBJRDNB    PTDT
     C                     Z-ADD@VLDT     VUDT
     C                     MOVEL'TT'      TRYP
     C                     MOVELSNRR1     NRTD
     C                     MOVE @NATN     TNMR
     C* if reference number remove initial 'R'
     C                     MOVE SCQNF     @SCQNF
     C           @RTEST    IFNE 'R'
     C                     MOVELSCQNF     CQNR
     C                     ELSE
     C                     MOVE '0'       @RTEST
     C                     MOVEL@SCQNF    CQNR
     C                     END
     C                     Z-ADD@TNAM     MVAM
     C                     MOVELPTLID     TBID
     C                     MOVEL'N'       APBI
      *                                                                                       CAP205
      ** Set up Module and Movement Type fields                                               CAP205
      *                                                                                       CAP205
     C           CAP205    IFEQ 'Y'                                                           CAP205
     C                     MOVE 'RE'      CMOD                                                CAP205
     C                     MOVE 'S'       MTYP                                                CAP205
     C                     ENDIF                                                              CAP205
      *
     C                     WRITERSACMTPO
     C/COPY WNCPYSRC,RE4112C020
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              092429
     C*****************************************************************   092429
     C*                                                               *   092429
     C*            NARRUP - UPDATE NARRATIVES FILE TTNARPD            *   092429
     C*                                                               *   092429
     C* CALLS             -                                           *   092429
     C*                                                               *   092429
     C* CALLED BY  UPDATE - UPDATE CONTROL                            *   092429
     C*                                                               *   092429
     C*                                                               *   092429
     C*****************************************************************   092429
     C           NARRUP    BEGSR                                          092429
     C*                                                                   092429
     C** CLEAR THE OUTPUT FIELDS AND DATA STRUCTURE AND SET UP            092429
     C** COMMON DETAILS FOR THE NARRATIVE FILE.                           092429
     C*                                                                   092429
     C                     CLEARSNARR                                     092429
     C                     CLEARS2NARR                                    092429
     C                     CLEARTTNARR                                    092429
     C                     MOVEL'D'       RECI                            092429
     C                     MOVEL'T'       TBRI                            092429
     C                     MOVELPTLID     TBID                            092429
     C                     MOVE @NATN     TBTN                            092429
     C                     MOVE @NATN     @@TBTN                          092429
     C                     MOVE @NATN     @2TBTN                          092429
     C                     MOVE TBID      @@TBID                          092429
     C                     MOVE TBID      @2TBID                          092429
     C                     MOVE '/'       @@SLSH                          092429
     C                     MOVE '/'       @2SLSH                          092429
     C*                                                                   092429
     C** IF NARRATIVE IS ENTERED THEN SET UP THE NARRATIVE FIELD FOR      092429
     C** THE NARRATIVE FILE TTNARPD AND THEN WRITE THE DETAILS TO         092429
     C** NARRATIVE FILE.                                                  092429
     C*                                                                   092429
     C/COPY WNCPYSRC,RE4112C009
     C           NARRI     IFNE *BLANKS                                   092429
     C                     MOVE *ON       *IN72                           092429
     C                     MOVELNARRI     SNARR                           092429
     C                     MOVE @@NARR    TTNARR                          092429
     C*                                                                   092429
     C                     ELSE                                           092429
     C*                                                                   092429
     C                     MOVE *OFF      *IN72                           092429
     C           RTSNAR    IFEQ 'Y'                                                         MD054623
     C                     MOVEL@NRTD1    SNARR                                             MD054623
     C                     ENDIF                                                            MD054623
     C                     MOVE @@NARR    TTNARR                          092429
     C                     ENDIF                                          092429
     C*                                                                   092429
     C           NAR2I     IFNE *BLANKS                                   092429
     C                     MOVE *ON       *IN73                           092429
     C                     MOVELNAR2I     S2NARR                          092429
     C                     MOVE @2NARR    TTNAR2                          092429
     C*                                                                   092429
     C                     ELSE                                           092429
     C*                                                                   092429
     C                     MOVE *OFF      *IN73                           092429
     C           RTSNAR    IFEQ 'Y'                                                         MD054623
     C                     MOVEL@NRTD2    S2NARR                                            MD054623
     C                     ENDIF                                                            MD054623
     C                     MOVE @2NARR    TTNAR2                          092429
     C                     ENDIF                                          092429
     C*                                                                   092429
     C                     WRITETTNARPDF                                  092429
     C*                                                                   092429
     C                     ENDSR                                          092429
     C*****************************************************************   092429
      /EJECT
      *****************************************************************
      *                                                               *
      *            UACNUM - Update accounts                           *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTACLS - Account closure updates                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UACNUM    BEGSR                           ** UACNUM **
      *
      ** If account closure is successful?
     C           @CLOS     IFEQ 'Y'
     C                     MOVEL' '       @RVIN
      *                                                                   106661
      * If the debit and credit account branches are different,           106661
      * ensure that the debit branch is used in the closure routine.      106661
      *                                                                   106661
     C           @BRCAD    IFNE @BRCAC                                    106661
     C           @BRCAD    ANDNE*BLANKS                                   106661
     C                     MOVEL@BRCAD    @BRCA                           106661
     C                     ENDIF                                          106661
      *                                                                   106661
     C                     EXSR RTACLS
      *
      ** If LF/ACCNT record not found?
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD10        DBASE            ***************
     C                     MOVE 'ACCNT '  DBFILE           ** DBERR 010 **
     C                     MOVEL@ACCN     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UCHQBK - Update cheque book                        *
      *                                                               *
      * CALLS             -                                           *
      *            UPTRL  - Update Control Trailer Record             *                       CRE019
      *            SBTOFF - Set bit off                               *                       CRE019
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED  @CA    - Cheque presented status array             *
      *            @CAI   - Cheque presented status array element     *
      *            @BITN  - Bit position representing cheque number   *
      *                                                               *
      *****************************************************************
     C           UCHQBK    BEGSR                           ** UCHQBK **
      *
     C                     MOVEL'N'       WINS    1                                           CRE019
      *                                                                                       CRE019
     C           KLCQBK    CHAINCHQBKPD              70
      *
      ** If record not found.
     C           *IN70     IFEQ '1'
      *                                                                                       CRE019
     C           CRE019    IFNE 'Y'                                                           CRE019
     C           *LOCK     IN   LDA
     C                     Z-ADD11        DBASE            ***************
     C                     MOVE 'CHQBKPD' DBFILE           ** DBERR 011 **
     C                     MOVELKACNO     DBKEY            ***************
     C                     MOVE KSCQN     DBKEY
     C                     EXSR DBERR
      *                                                                                       CRE019
     C                     ELSE                                                               CRE019
      *                                                                                       CRE019
      ** format fields for new cheque book record                                             CRE019
      *                                                                                       CRE019
     C                     MOVEL'D'       RECID                                               CRE019
     C                     MOVE SACNO1    CQACNO                                              CRE019
     C                     Z-ADD0         GCQI                                                CRE019
     C                     MOVE SCQNF     SCQN                                                CRE019
     C                     MOVE SCQNF     ECQN                                                CRE019
     C                     Z-ADD1         NOCQ                                                CRE019
     C                     Z-ADD@VLDT     DISS                                                CRE019
     C                     Z-ADD@VLDT     DCOL                                                CRE019
     C                     Z-ADDBJRDNB    OEDT                                                CRE019
     C                     MOVELBRCA      CQBRCA                                              CRE019
     C                     MOVEL'I'       CHTP                                                CRE019
     C                     Z-ADD0         CQCHAM                                              CRE019
     C                     Z-ADD0         CQCHAC                                              CRE019
     C                     Z-ADD0         CHTT                                                CRE019
     C                     MOVEL'Y'       OUTR                                                CRE019
     C                     MOVEL'Y'       WINS                                                CRE019
      *                                                                                       CRE019
      ** initialise cheque presented array and on corresponding bit                           CRE019
      *                                                                                       CRE019
     C                     EXSR SBTOFF                                                        CRE019
     C                     BITON'0'       @CA,1                                               CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C                     END
      *                                                                                       CRE019
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C                     Z-ADDFNATN     TNLU                                                CRE019
     C                     Z-ADDBJRDNB    LCD                                                 CRE019
     C                     ENDIF                                                              CRE019
      *
     C           WINS      IFEQ 'N'                                                           CRE019
      *                                                                                       CRE019
     C                     Z-ADD@CAI      @I
     C           @BITN     IFEQ 0
     C                     BITON'0'       @CA,@I
     C                     END
     C           @BITN     IFEQ 1
     C                     BITON'1'       @CA,@I
     C                     END
     C           @BITN     IFEQ 2
     C                     BITON'2'       @CA,@I
     C                     END
     C           @BITN     IFEQ 3
     C                     BITON'3'       @CA,@I
     C                     END
     C           @BITN     IFEQ 4
     C                     BITON'4'       @CA,@I
     C                     END
     C           @BITN     IFEQ 5
     C                     BITON'5'       @CA,@I
     C                     END
     C           @BITN     IFEQ 6
     C                     BITON'6'       @CA,@I
     C                     END
     C           @BITN     IFEQ 7
     C                     BITON'7'       @CA,@I
     C                     END
      *
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C                     MOVEL'A'       CHTP                                                CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C                     UPDATCHQBKPDF
      *                                                                                       CRE019
     C                     ELSE                                                               CRE019
      *                                                                                       CRE019
      ** Create new cheque book record for out of range cheques                               CRE019
      *                                                                                       CRE019
     C                     WRITECHQBKPDF                                                      CRE019
     C                     EXSR UPTRL                                                         CRE019
     C                     ENDIF                                                              CRE019
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                                                  CRE019
      *****************************************************************                       CRE019
      *                                                               *                       CRE019
      * SBTOFF - Set bit off                                          *                       CRE019
      *                                                               *                       CRE019
      * CALLS             -                                           *                       CRE019
      *                                                               *                       CRE019
      * CALLED BY  UCHQBK - Update Cheque Book                        *                       CRE019
      *                                                               *                       CRE019
      *****************************************************************                       CRE019
     C           SBTOFF    BEGSR                                                              CRE019
      *                                                                                       CRE019
      ** Set bit of for all the 160 cheque presented array                                    CRE019
      *                                                                                       CRE019
     C                     Z-ADD1         WI      20                                          CRE019
      *                                                                                       CRE019
     C           WI        DOWLE20                                                            CRE019
     C                     BITON'01234567'@CA,WI  1                                           CRE019
     C                     BITOF'01234567'@CA,WI  1                                           CRE019
     C                     ADD  1         WI                                                  CRE019
     C                     END                                                                CRE019
      *                                                                                       CRE019
     C                     ENDSR                                                              CRE019
      *****************************************************************                       CRE019
      /EJECT                                                                                  CRE019
      *****************************************************************                       CRE019
      *                                                               *                       CRE019
      * UPTRL  - Update Control Trailer Record                        *                       CRE019
      *                                                               *                       CRE019
      * CALLS :    DBERR  - Database error handling                   *                       CRE019
      * CALLED BY: UCHQBK - Update control routine                    *                       CRE019
      *                                                               *                       CRE019
      *****************************************************************                       CRE019
     C           UPTRL     BEGSR                                                              CRE019
      *                                                                                       CRE019
     C                     MOVE *ALL'9'   @CHQBK                                              CRE019
     C           KLCQBK    CHAINCHQBKPTF             70                                       CRE019
      *                                                                                       CRE019
      **  If no record found                                                                  CRE019
      *                                                                                       CRE019
     C           *IN70     IFEQ '1'                                                           CRE019
     C           *LOCK     IN   LDA                                                           CRE019
     C                     Z-ADD27        DBASE                                               CRE019
     C                     MOVEL'CHQBKPTF'DBFILE                                              CRE019
     C                     MOVELKACNO     DBKEY                                               CRE019
     C                     MOVE KSCQN     DBKEY                                               CRE019
     C                     EXSR DBERR                                                         CRE019
     C                     ELSE                                                               CRE019
     C                     ADD  1         NORET                                               CRE019
     C                     UPDATCHQBKPTF                                                      CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C                     ENDSR                                                              CRE019
      *****************************************************************                       CRE019
      /EJECT
      *****************************************************************
      *                                                               *
      *            PRTTRN - Print transaction                         *
      *                                                               *
      * CALLS      ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           PRTTRN    BEGSR                           ** PRTTRN **
      *
     C                     OPEN RE4112P1
     C/COPY WNCPYSRC,RE4112C002
     C*                                                                   092429
     C* IF NARRATIVE IS ENTERED THEN PRINT AND CLEAR ITS OUTPUT           092429
     C* FIELD, OTHERWISE JUST CLEAR THE OUTPUT FIELD.                     092429
     C*                                                                   092429
     C                     MOVE *BLANKS   NARRO                           092429
     C           NARRI     IFNE *BLANKS                                   092429
     C           'DR'      CAT  NARRI:1   NARRO                           092429
     C                     ENDIF                                          092429
     C           NAR2I     IFNE *BLANKS                                   092429
     C           NARRO     CAT  'CR':2    NARRO                           092429
     C           NARRO     CAT  NAR2I:1   NARRO                           092429
     C                     ENDIF                                          092429
     C/COPY WNCPYSRC,RE4112C003
      *
      ** Format cash amount
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@TNAM     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    OTNAM
      *
     C/COPY WNCPYSRC,RE4112C010
     C                     WRITEDETAIL
     C*                                                                   092429
     C                     CLEARNARRI                                     092429
     C                     CLEARNAR2I                                     092429
     C                     CLEARNARRO                                     092429
      *
     C                     CLOSERE4112P1
      *
     C                     ENDSR
      *****************************************************************
      *****************************************************************                       CCG016
      /EJECT                                                                                  CCG016
      *****************************************************************                       CCG016
      *                                                               *                       CCG016
      *            SNDUDC - Send advice to UDC                        *                       CCG016
      *                                                               *                       CCG016
      * CALLS      external pgm                                       *                       CCG016
      *                                                               *                       CCG016
      * CALLED BY  same as PRTTRN                                     *                       CCG016
      *                                                               *                       CCG016
      * FLDS USED         -                                           *                       CCG016
      *                                                               *                       CCG016
      *****************************************************************                       CCG016
     C           SNDUDC    BEGSR                                                              CCG016
      *                                                                                       CCG016
     C                     MOVELITLB      I#BRCT    P                                         CCG016
     C                     MOVELPTLID     I#TLID    P                                         CCG016
     C                     MOVELTBID      I#TBID    P                                         CCG016
     C                     MOVELSTTLU     I#TBTN    P                                         CCG016
     C                     MOVELPFNCD     I#FUNC    P                                         CCG016
     C           *IN40     IFEQ '0'                                                           CCG016
     C                     MOVEL'N'       I#CLOS    P                                         CCG016
     C                     ELSE                                                               CCG016
     C                     MOVEL'Y'       I#CLOS    P                                         CCG016
     C                     END                                                                CCG016
     C                     MOVEL*ZEROS    I#CHQN                                              CCG016
     C                     MOVEL*ZEROS    I#CNUM                                              CCG016
     C                     MOVEL*BLANKS   I#CCY                                               CCG016
     C                     MOVEL*ZEROS    I#ACOD                                              CCG016
     C                     MOVEL*ZEROS    I#ACSQ                                              CCG016
     C                     MOVEL*ZEROS    I#BRCA                                              CCG016
     C                     MOVELSACNO1    I#ACNO    P                                         CCG016
     C                     MOVEL*ZEROS    I#CNU1                                              CCG016
     C                     MOVEL*BLANKS   I#CCY1                                              CCG016
     C                     MOVEL*ZEROS    I#ACO1                                              CCG016
     C                     MOVEL*ZEROS    I#ACS1                                              CCG016
     C                     MOVEL*BLANKS   I#BRC1                                              CCG016
     C                     MOVELSACNO1    I#ACN1                                              CCG016
     C                     MOVEL*ZEROS    I#CNU2                                              CCG016
     C                     MOVEL*BLANKS   I#CCY2                                              CCG016
     C                     MOVEL*ZEROS    I#ACO2                                              CCG016
     C                     MOVEL*ZEROS    I#ACS2                                              CCG016
     C                     MOVEL*BLANKS   I#BRC2                                              CCG016
     C                     MOVELSCACN     I#ACN2                                              CCG016
     C                     Z-ADD@TNAM     I#AMNT                                              CCG016
     C                     MOVELSCCY1     I#CCYT    P                                         CCG016
     C                     MOVEL*BLANKS   I#NARR    P                                         CCG016
     C                     Z-ADD0         I#CHQA                                              CCG016
     C                     Z-ADD0         I#EXRT                                              CCG016
     C                     Z-ADD0         I#BUYA                                              CCG016
     C                     MOVEL*BLANKS   I#BUYC                                              CCG016
     C                     Z-ADD0         I#SELA                                              CCG016
     C                     MOVEL*BLANKS   I#SELC                                              CCG016
     C                     MOVE *BLANKS   I#NAR1                                              CCG016
     C           I#NAR1    CAT  SCQNF:0   I#NAR1                                              CCG016
     C           SCQNF     IFEQ *BLANKS                                                       CCG016
     C                     MOVELSNRR1     I#NAR1                                              CCG016
     C                     ELSE                                                               CCG016
     C           I#NAR1    CAT  SNRR1:1   I#NAR1                                              CCG016
     C                     ENDIF                                                              CCG016
     C                     MOVE *BLANKS   I#NAR2                                              CCG016
     C           NARRI     IFNE *BLANKS                                                       CCG016
     C           I#NAR2    CAT  'DR':0    I#NAR2                                              CCG016
     C           I#NAR2    CAT  NARRI:1   I#NAR2                                              CCG016
     C                     ENDIF                                                              CCG016
     C           NAR2I     IFNE *BLANKS                                                       CCG016
     C           I#NAR2    CAT  'CR':2    I#NAR2                                              CCG016
     C           I#NAR2    CAT  NAR2I:1   I#NAR2                                              CCG016
     C                     ENDIF                                                              CCG016
     C                     Z-ADD0         I#INTA                                              CCG016
     C                     MOVEL*BLANKS   I#INTC                                              CCG016
     C                     MOVEL*BLANKS   I#INTN                                              CCG016
     C                     Z-ADD0         I#TAXA                                              CCG016
     C                     MOVEL*BLANKS   I#TAXC                                              CCG016
     C                     MOVEL*BLANKS   I#TAXN                                              CCG016
     C                     Z-ADD0         I#CHGA                                              CCG016
     C                     MOVEL*BLANKS   I#CHGC                                              CCG016
     C                     MOVEL*BLANKS   I#CHGN                                              CCG016
     C                     Z-ADD0         I#TOTA                                              CCG016
     C                     MOVEL*BLANKS   I#TOTC                                              CCG016
     C                     MOVEL*BLANKS   I#TOTN                                              CCG016
      *                                                                                       CCG016
     C                     CALL 'CGC3605'                                                     CCG016
     C                     PARM '*PREPARE'ACTION  8                                           CCG016
      *                                                                                       CCG016
     C                     CALL 'CG0501'                                                      CCG016
     C                     PARM           W0RTN   7                                           CCG016
     C                     PARM 'YES'     W0CMT   3                                           CCG016
     C                     PARM *BLANKS   ##COPD  1                                           CCG016
     C                     PARM *BLANKS   ##AUTO  1                                           CCG016
     C                     PARM           I#PARM                                              CCG016
     C                     PARM           O#PARM                                              CCG016
      *                                                                                       CCG016
     C                     CALL 'CGC3604'                                                     CCG016
      *                                                                                       CCG016
     C           ##COPD    IFNE 'N'                                                           CCG016
     C                     CALL 'CGC0524'                                                     CCG016
     C                     PARM *BLANKS   W7A1    7                                           CCG016
     C                     PARM O#PARM    W50A1  50                                           CCG016
     C                     PARM *BLANKS   W10A1  10                                           CCG016
     C                     END                                                                CCG016
      *                                                                                       CCG016
     C                     CLEARNARRI                                                         CCG016
     C                     CLEARNAR2I                                                         CCG016
     C                     CLEARNARRO                                                         CCG016
      *                                                                                       CCG016
     C                     ENDSR                                                              CCG016
      *****************************************************************                       CCG016
     C/COPY WNCPYSRC,RE4112C014
      /EJECT
      /COPY ZSRSRC,RTBKDRC1
      ** Block debit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTBKCRC1
      ** Block credit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTRFDRC1
      ** Refer debit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTRFCRC1
      ** Refer credit check subroutine
      *
      /COPY ZSRSRC,RTIACTC1
      ** Inactive account check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTBKPTC1
      ** Bankrupt/Liquidation check
      *
      /EJECT
      /COPY ZSRSRC,RTBDPTC1
      ** Bad Debt check
      *
      /EJECT
      /COPY ZSRSRC,RTBRCHC1
      ** Branch different check
      *
      /EJECT
      /COPY ZSRSRC,RTACLGC1
      ** Account closing check
      *
      /EJECT
      /COPY ZSRSRC,RTCLSCC1
      ** Calculate close details
      *
      /EJECT
      /COPY ZSRSRC,RTCHRGC1
      ** Calculate service charges
      *
      /EJECT
      /COPY ZSRSRC,RTINTRC1
      ** Calculate net interest
      *
      /EJECT
      /COPY ZSRSRC,RTCLSEC1
      ** Close account conditions check
      *
      /EJECT
      /COPY ZSRSRC,RTTOTSC1
      ** Calculate teller totals updates
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            ACLOSE - A/C Closure Enquiry                       *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTCLSC - Calculate close details                   *
      *            RTCLSE - Close account condition check             *
      *            VALINL - Validate initial screen                   *
      *            WRKACC - Work with account                         *
      *            ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ACLOSE    BEGSR                           ** ACLOSE **
      *
     C                     SETOF                     4569
     C                     SETON                     40
     C**********           OPEN RECRG                                     153001
     C                     OPEN REIAC
     C                     OPEN REACR
      *
      ** Validate initial screen
     C                     EXSR VALINL
      *
      ** If no validation error(s)?
     C           *IN69     IFEQ '0'
      *
      ** Set up variables
     C                     MOVE ' '       @CLOS   1
     C                     MOVE RETB      @RETB
     C                     Z-ADDRRNM      @RRNM
     C**********           Z-ADDCNUM      @CNUM                                               CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     MOVELSCCY1     @CCY
     C                     Z-ADDACOD      @ACOD
     C                     Z-ADDACSQ      @ACSQ
     C                     Z-ADDHELD      @HELD
      *
      ** Retrieve PF/MEMOS details
     C***********@RRNM*****CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
     C** Chain access object AOMEMSR0                                     CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANK    W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' P@OPTN  7        O:Option       CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM @CCY      W0CCY   3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACCD                                              CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCAD    W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
      ** If record not found?
     C************IN70*****IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE *BLANK                                    CCB002
     C           *LOCK     IN   LDA
     C                     Z-ADD12        DBASE            ***************
     C*********************MOVE 'MEMOS  ' DBFILE           ** DBERR 012 **CCB002
     C*********************MOVEL@RRNM     DBKEY            ***************CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      *
      ** Release record
     C*********************EXCPT@RLMEM                                    CCB002
      *
      ** Perform close account condition check
     C                     MOVE SCCY1     SCCY2
     C                     MOVE ANAM      SDANAM
     C                     MOVE SACNO1    SACNO2
     C                     MOVE '1 '      @ACIN   2
     C                     Z-ADDCLBLN     @CLBL
      *                                                                   CCB002
      ** Set parameters for amended SR/RTCLSE                             CCB002
     C                     Z-ADD*ZEROS    @ACNOM 100                      CCB002
     C**********           MOVE @CNUM     @CNUMM  60                                   CCB002 CSD027
     C                     MOVE @CNUM     @CNUMM  6                                           CSD027
     C                     MOVE @CCY      @CCYM   3                       CCB002
     C**********           MOVE @ACOD     @ACCDM  40                                   CCB002 CGL029
     C                     MOVE @ACOD     @ACCDM 100                                          CGL029
     C                     MOVE @ACSQ     @ACSQM  20                      CCB002
     C                     MOVE @BRCAD    @BRCAM  3                       CCB002
      *                                                                   CCB002
      *
      ** Calculate close account condition check
     C                     EXSR RTCLSE
     C**                                                                  S01408
     C/COPY WNCPYSRC,RE4112CP12                                           S01408
     C**                                                                  S01408
      *
      ** If no terminal error(s) exist?
     C           @TI       IFEQ 0
      *
      ** Calculate close details
     C                     MOVELSCCY1     @CCY
     C**                                                                  S01408
     C/COPY WNCPYSRC,RE4112CP11                                           S01408
     C**                                                                  S01408
      *                                                                                       CDL013
     C           CDL013    IFEQ 'Y'                                                           CDL013
     C                     EXSR #ERTCL                                                        CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C                     EXSR RTCLSC
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C**                                                                  S01408
     C/COPY WNCPYSRC,RE4112CP15                                           S01408
     C**                                                                  S01408
      *
      ** If record not found?
     C           *IN80     IFEQ '1'
      *                                                    ***************
     C                     Z-ADD13        DBASE            ** DBERR 013 **
     C                     EXSR DBERR                      ***************
     C                     END
      *
      ** If no terminal error(s) exist?
     C           @TI       IFEQ 0
      *
      ** Remove any warning messages since same routines will validate again
     C                     Z-ADD0         @WI
     C                     MOVEA*BLANKS   @W
      *
      ** Prepare output fields for account closing balances
      ** and set on display indicator
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@INTR     ZFLD15
     C                     Z-ADD@INTR     @INTRS 150                      106661
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SINTR
     C*
     C** Show W/TAX if the customer is liable to tax and WT is not 0
     C           BBTAIN    IFEQ 'Y'
     C**                                                                  S01408
     C/COPY WNCPYSRC,RE4112CP14                                           S01408
     C**                                                                  S01408
      *                                                                                       CDL013
     C** Show W/TAX if Tax indicator is valid and tax is not zero.                            CDL013
     C           CDL013    OREQ 'Y'                                                           CDL013
     C           BBTAIN    ANDNE'0'                                                           CDL013
     C           @WTAX     ANDNE0
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@WTAX     ZFLD15
     C                     ADD  @WTAX     @INTRS                          106661
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SWTAX
     C*
     C                     MOVE '1'       *IN76
     C*
     C                     ELSE
     C*
     C                     MOVE '0'       *IN76
     C*
     C                     END
      *
      *
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@CHRG     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SCHRG
      *
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@CLOB     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SCLOB
      *
     C                     SETON                     29
      *
      ** Perform work with account
     C                     EXSR WRKACC
      *
     C                     END
      *
     C                     END
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
     C                     SETON                     2022
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
     C                     END
      *
     C                     END
      *
     C                     SETOF                     40
      *
     C**********           CLOSERECRG                                     153001
     C                     CLOSEREIAC
     C                     CLOSEREACR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      ** SR.ZALIGN subroutine
      /COPY ZSRSRC,ZALIGNZ2
      *
      *****************************************************************
      /EJECT
      ** SR.ZDATE1 subroutine
      /COPY ZSRSRC,ZDATE1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZDATE2 subroutine
      /COPY ZSRSRC,ZDATE2Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZTNLU1 Subroutine
      /COPY ZSRSRC,ZTNLU1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZFRPED Subroutine
      /COPY ZSRSRC,ZFRPEDZ3
      *
      *****************************************************************
      *
      ** SR.ZACCH  Subroutine
      /COPY ZSRSRC,ZACCH
      *****************************************************************
      /EJECT
      ** SR.ZFWDT  Subroutine
      /COPY ZSRSRC,ZCHKH
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FIRST  - Initial Processing                        *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           FIRST     BEGSR                           ** FIRST  **
      *
      ** Input parameter(s) :
     C           *ENTRY    PLIST                           Entry parameter list
     C                     PARM           PFNCD   3        Function code
     C                     PARM           PMODE   1        Processing ModeCRT002
     C*
     C** Copyright statement
     C*
     C                     MOVEACPY@      BIS@   80
      *                                                                                       250891
      ** Initialise Skip Update Flag to 'N'                                                   250891
     C                     MOVEL'N'       @SKIP   1                                           250891
      *
      ** Define Keylist(s)
      *
      ** Currency Details
     C           KLBANK    KLIST
     C                     KFLD           BJBANK
      *
      ** Retail Details
     C           KLRETD    KLIST
     C                     KFLD           BMRETL
      *
      ** Account Numbers Cross Reference
     C           KLACNO    KLIST
     C                     KFLD           KACNO  100
      *
      ** Account master
     C           KLACNT    KLIST
     C                     KFLD           @CNUM
     C                     KFLD           @CCY
     C                     KFLD           @ACOD
     C                     KFLD           @ACSQ
     C                     KFLD           @BRCA
     C*
     C/COPY WNCPYSRC,RE4112C011
     C** Retail commission
     C*
     C           KLCOMM    KLIST
     C                     KFLD           @BRCA
     C                     KFLD           @CNUM
     C                     KFLD           @CCY
     C                     KFLD           @ACOD
     C                     KFLD           @ACSQ
      *                                                                                       249968
     C           KSWEEP    KLIST                                                              249968
     C                     KFLD           @CNUM                                               249968
     C                     KFLD           CCY                                                 249968
     C                     KFLD           @ACOD                                               249968
     C                     KFLD           @ACSQ                                               249968
     C                     KFLD           @BRCA                                               249968
      *                                                                                       253689
     C           KSWP1     KLIST                                                              253689
     C                     KFLD           @BRCA                                               253689
     C                     KFLD           @CNUM                                               253689
     C                     KFLD           CCY                                                 253689
     C                     KFLD           @ACOD                                               253689
     C                     KFLD           @ACSQ                                               253689
      *                                                                                       253689
      ** Klist for chaining retail account number                                             253689
      *                                                                                       253689
     C           KSWP2     KLIST                                                              253689
     C                     KFLD           @ACNO                                               253689
      *
     C           KACO      KLIST                                                              249968
     C                     KFLD           @ACNO                                               249968
     C                     KFLD           @ACSQ                                               249968
      *                                                                                       263834
     C           SWAKEY    KLIST                                                              263834
     C                     KFLD           WWBRCA  3                                           263834
     C                     KFLD           WWCNBR  6                                           263834
     C                     KFLD           WWCCY   3                                           263834
     C                     KFLD           WWACOD 100                                          263834
     C                     KFLD           WWACSQ  20                                          263834
      *                                                                                       263834
      ** Retrieve RTS job dataarea
     C           *NAMVAR   DEFN           RTSDTA
     C                     IN   RTSDTA
      *                                                                   CRT002
     C           *NAMVAR   DEFN           CITFTS                          CRT002
     C                     IN   CITFTS                                    CRT002
      *
      ** Reset LDA
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBLOT
     C                     OUT  LDA
      *                                                                   CRT002
      **  If PMODE = 'I', open display file RE4112DF                      CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     OPEN RE4112DF                                  CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Initialise MSG text and MSG return code                         CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   @MSGTX                          CRT002
      *                                                                   CRT002
      **  Initialise MSDID and MSG file fields                            CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   @MSGID                          CRT002
     C                     MOVEL'RTSMSGF' @MSGF                           CRT002
      *                                                                   CRT002
     C                     MOVE '1'       @FIRST  1                       CRT002
      *                                                                                       263834
      ** Initialise fields to be used for message text retrieval                              263834
      *                                                                                       263834
     C                     MOVEL*BLANK    ZAPGM  10                                           263834
     C                     MOVEL'RTSMSGF' ZAMSGF 10                                           263834
     C                     MOVEL*BLANK    ZAPGRL  5                                           263834
     C                     MOVEL*BLANK    ZAMSID  7                                           263834
     C                     MOVEL*BLANK    ZAMSDA132                                           263834
     C                     MOVEL*BLANK    ZAMSTP  7                                           263834
      *
      ** Get Base Currency - Bank Details
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
     C*
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE           ***************
     C                     MOVEL@OPTN     DBKEY            ** DBERR 014 **
     C                     Z-ADD14        DBASE            ***************
     C                     EXSR DBERR
     C                     END
      *
      ** Set up local currency
     C                     MOVE BJLCCY    @CCY
     C                     EXSR RTCCYS
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD15        DBASE            ***************
     C                     MOVE 'SDCURRL0'DBFILE           ** DBERR 015 **
     C                     MOVELBJLCCY    DBKEY            **************
     C                     EXSR DBERR
     C                     END
      *
      ** Set up base currency
     C           BJLCCY    IFNE BJCYCD
     C                     MOVE BJCYCD    @CCY
     C                     EXSR RTCCYS
      *
      ** If record not found?
     C************IN80     IFEQ '1'                                       140802
     C           @RTCD     IFNE *BLANKS                                   140802
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD23        DBASE            ** DBERR 023 **
     C                     MOVE 'SDCURRL0'DBFILE           **************
     C                     MOVEL@CCY      DBKEY
     C                     EXSR DBERR
     C                     END
     C                     END
     C*
      ** Set up date format indicator
     C           BJDFIN    IFEQ 'D'
     C                     SETOF                     98
     C                     ELSE
     C                     SETON                     98
     C                     END
     C*
     C** Access Tax ICD for rate. Default is ZERO.
     C*
     C                     Z-ADD0         TXWTRR
     C                     OPEN SDSTAXPD
     C           1         CHAINSDSTAXPD             70
     C                     CLOSESDSTAXPD
     C*
     C** Error in SDSTAXPD
     C*
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        **************
     C                     Z-ADD24        DBASE            ** DBERR 024 **
     C                     MOVE 'SDSTAXPD'DBFILE           ***************
     C                     MOVEL'1'       DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Get Retail Details
     C*
     C                     CALL 'AORETLR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDRETL    PARM SDRETL    DSFDY
     C*
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA                        ***************
     C                     MOVEL'SDRETLPD'DBFILE           ** DBERR 016 **
     C                     MOVEL@OPTN     DBKEY            ***************
     C                     Z-ADD16        DBASE
     C                     EXSR DBERR
     C                     END
     C*
     C** Check if Account Password facility processing is switched on
     C*
     C                     CALL 'AOSARDR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*VERIFY' @OPTN
     C                     PARM 'CRT101'  @SARD   6
     C           SCSARD    PARM SCSARD    DSFDY
     C*
     C           @RTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CRT101  1
     C                     ELSE
     C                     MOVE 'N'       CRT101
     C                     END
      *                                                                                     MD054057
      ** Check if CGL013 is switched on                                                     MD054057
     C*                                                                                     MD054057
     C                     CALL 'AOSARDR0'                                                  MD054057
     C                     PARM '*BLANKS' @RTCD                                             MD054057
     C                     PARM '*VERIFY' @OPTN                                             MD054057
     C                     PARM 'CGL013'  @SARD                                             MD054057
     C           SCSARD    PARM SCSARD    DSFDY                                             MD054057
      *                                                                                     MD054057
     C           @RTCD     IFEQ *BLANKS                                                     MD054057
     C                     MOVE 'Y'       CGL013  1                                         MD054057
     C                     ELSE                                                             MD054057
     C                     MOVE 'N'       CGL013                                            MD054057
     C                     END                                                              MD054057
     C**                                                                  S01408
     C/COPY WNCPYSRC,RE4112CP10                                           S01408
     C**                                                                  S01408
      *
      ** Get Function Code Details
     C*
     C                     CALL 'AOFNCDR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM PFNCD     @FNCD   3
     C           SDFNCD    PARM SDFNCD    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD17        DBASE            ***************
     C                     MOVE 'SDFNCDPD'DBFILE           ** DBERR 017 **
     C                     MOVELPFNCD     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C** Store validation indicators
     C*
     C                     MOVEAFQVWIN    @V
      *
      ** Get Transaction Type Details
      *
      ** Debit transaction type 1 details
     C*
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM FQDRC1    @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD18        DBASE            ***************
     C                     MOVE 'SDRETRPD'DBFILE           ** DBERR 018 **
     C                     MOVELFQDRC1    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
     C                     MOVEL' '       @RVIN1  1
     C                     MOVELA1DCIN    @DCIN1  1
     C                     MOVELA1RTNM    @NRTD1 30
     C                     MOVELA1PASB    @PASS1  2
     C                     MOVELA1CIND    @CSIN1  1
     C                     MOVELA1CLIN    @CLIN1  1
      *
      ** Credit transaction type 1 details
     C*
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM FQCRC1    @RETR
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     Z-ADD19        DBASE            **************
     C                     MOVE 'SDRETRPD'DBFILE           ** DBERR 019 **
     C                     MOVELFQCRC1    DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
     C                     MOVEL' '       @RVIN2  1
     C                     MOVELA1DCIN    @DCIN2  1
     C                     MOVELA1RTNM    @NRTD2 30
     C                     MOVELA1PASB    @PASS2  2
     C                     MOVELA1CIND    @CSIN2  1
     C                     MOVELA1CLIN    @CLIN2  1
      *                                                                   CRT002
      **  General Ledger details                                          CRT002
      *                                                                   CRT002
     C**********           CALL 'AOGELRR0'                                             CRT002 CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*FIRST ' @OPTN   7                       CRT002
     C********** SDGELR    PARM SDGELR    DSFDY                                        CRT002 CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANK                                    CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     MOVEL'SDGELRPD'DBFILE                          CRT002
     C                     MOVEL@OPTN     DBKEY                           CRT002
     C                     Z-ADD27        DBASE                           CRT002
     C                     EXSR DBERR                                     CRT002
     C                     END                                            CRT002
      *
      *                                                                   CRT007
      ** Determine if SAR CRT003 Cashier Interface is installed           CRT007
      *                                                                   CRT007
     C                     CALL 'AOSARDR0'                                CRT007
     C                     PARM *BLANKS   PRTCD   7                       CRT007
     C                     PARM '*VERIFY 'POPTN   7                       CRT007
     C                     PARM 'CRT003'  PSARD   6                       CRT007
     C           SCSARD    PARM SCSARD    DSFDY                           CRT007
      *                                                                   CRT007
     C           PRTCD     IFNE *BLANKS                                   CRT007
     C           PRTCD     ANDNE'*NRF   '                                 CRT007
     C           *LOCK     IN   LDA                                       CRT007
     C                     MOVEL'SCSARDPD'DBFILE                          CRT007
     C                     Z-ADD8         DBASE                           CRT007
     C                     MOVEL'CRT003'  DBKEY                           CRT007
     C                     EXSR DBERR                                     CRT007
     C                     ENDIF                                          CRT007
      *                                                                   CRT007
     C           PRTCD     IFEQ *BLANKS                                   CRT007
     C                     MOVE 'Y'       CRT003                          CRT007
     C                     ELSE                                           CRT007
     C                     MOVE 'N'       CRT003                          CRT007
     C                     ENDIF                                          CRT007
      * Check if CRT012 is switched on                                    CRT012
     C                     CALL 'AOSARDR0'                                CRT012
     C                     PARM           PRTCD   7                       CRT012
     C                     PARM '*VERIFY' POPTN   7                       CRT012
     C                     PARM 'CRT012'  PSARD   6                       CRT012
      *                                                                   CRT012
     C           PRTCD     IFEQ *BLANKS                                   CRT012
      *                                                                   CRT012
      * Check if Cashier Multiple Charges is On                           CRT012
     C                     MOVE *BLANKS   SVALK2                          CRT012
     C                     MOVE *BLANKS   SVALK3                          CRT012
     C                     MOVE *BLANKS   SVALK4                          CRT012
     C                     MOVE *BLANKS   SVALK5                          CRT012
     C                     MOVE *BLANKS   SVALK6                          CRT012
     C                     MOVE *BLANKS   SVALK7                          CRT012
     C                     MOVE *BLANKS   SVALK8                          CRT012
     C                     MOVE *BLANKS   SVALK7                          CRT012
     C                     MOVE *BLANKS   SVALK8                          CRT012
      *                                                                   CRT012
     C                     CALL 'AOSVALR0'                                CRT012
     C                     PARM *BLANKS   RTNCDE  7                       CRT012
     C                     PARM           SVALK1 20                       CRT012
     C                     PARM           SVAL1 200                       CRT012
     C                     PARM           SVALK2 20                       CRT012
     C                     PARM           SVAL2 200                       CRT012
     C                     PARM           SVALK3 20                       CRT012
     C                     PARM           SVAL3 200                       CRT012
     C                     PARM           SVALK4 20                       CRT012
     C                     PARM           SVAL4 200                       CRT012
     C                     PARM           SVALK5 20                       CRT012
     C                     PARM           SVAL5 200                       CRT012
     C                     PARM           SVALK6 20                       CRT012
     C                     PARM           SVAL6 200                       CRT012
     C                     PARM           SVALK7 20                       CRT012
     C                     PARM           SVAL7 200                       CRT012
     C                     PARM           SVALK8 20                       CRT012
     C                     PARM           SVAL8 200                       CRT012
     C                     PARM           SVALK9 20                       CRT012
     C                     PARM           SVAL9 200                       CRT012
     C                     PARM           SVALK0 20                       CRT012
     C                     PARM           SVAL10200                       CRT012
      *                                                                   CRT012
     C           RTNCDE    IFNE *BLANKS                                   CRT012
     C           SVAL10    IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK0    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL9     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK9    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL8     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK8    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL7     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK7    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL6     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK6    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL5     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK5    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL4     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK4    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL3     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK3    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL2     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK2    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL1     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK1    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           *LOCK     IN   LDA                                       CRT012
     C                     MOVEL'SDSVALPD'DBFILE           *************  CRT012
     C                     Z-ADD37        DBASE            * DB ERR 37 *  CRT012
     C                     EXSR DBERR                      *************  CRT012
     C                     ENDIF                                          CRT012
     C           SVAL11    IFEQ 'Y'                                       CRT012
     C                     MOVE 'Y'       CRT012  1                       CRT012
     C                     ELSE                                           CRT012
     C                     MOVE 'N'       CRT012                          CRT012
     C                     ENDIF                                          CRT012
     C*                                                                   CRT012
     C                     ELSE                                           CRT012
     C                     MOVE 'N'       CRT012                          CRT012
     C                     ENDIF                                          CRT012
      *                                                                                       CRE019
      ** Check if CRE019 is switched on                                                       CRE019
      *                                                                                       CRE019
     C                     CALL 'AOSARDR0'                                                    CRE019
     C                     PARM           PRTCD                                               CRE019
     C                     PARM '*VERIFY' POPTN                                               CRE019
     C                     PARM 'CRE019'  PSARD                                               CRE019
     C           SCSARD    PARM SCSARD    DSFDY                                               CRE019
      *                                                                                       CRE019
     C           PRTCD     IFNE *BLANKS                                                       CRE019
     C           PRTCD     ANDNE'*NRF   '                                                     CRE019
     C           *LOCK     IN   LDA                                                           CRE019
     C                     MOVEL'SCSARDPD'DBFILE                                              CRE019
     C                     Z-ADD28        DBASE                                               CRE019
     C                     MOVEL'CRE019'  DBKEY                                               CRE019
     C                     EXSR DBERR                                                         CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C           PRTCD     IFEQ *BLANKS                                                       CRE019
     C                     MOVE 'Y'       CRE019  1                                           CRE019
     C                     ELSE                                                               CRE019
     C                     MOVE 'N'       CRE019                                              CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
      ** Check if CRT026 is switched on                                                       CRT026
      *                                                                                       CRT026
     C                     CALL 'AOSARDR0'                                                    CRT026
     C                     PARM *BLANKS   PRTCD                                               CRT026
     C                     PARM '*VERIFY' POPTN                                               CRT026
     C                     PARM 'CRT026'  PSARD                                               CRT026
     C           SCSARD    PARM SCSARD    DSFDY                                               CRT026
      *                                                                                       CRT026
     C           PRTCD     IFNE *BLANKS                                                       CRT026
     C           PRTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'SCSARDPD'DBFILE           ***************                    CRT026
     C                     Z-ADD38        DBASE            ** DB ERR 38 **                    CRT026
     C                     MOVEL'CRT026'  DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           PRTCD     IFEQ *BLANKS                                                       CRT026
     C                     MOVE 'Y'       CRT026  1                                           CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'N'       CRT026                                              CRT026
     C                     ENDIF                                                              CRT026
      *
      ** Define Error Message Fields
     C                     MOVE *BLANKS   @MSGID  7
     C                     MOVEL'RTSMSGF' @MSGF  10
      *
      ** Initialise Screen fields
     C                     SETON                     10
     C                     MOVEL@PGM      SPGMQ
     C                     MOVEL@JOB      SWSID
     C                     MOVE BJMRDT    SRUNA
      *                                                                                       CDL013
      *** Check if CAR CDL013 is installed                                                    CDL013
     C                     CALL 'AOSARDR0'                                                    CDL013
     C                     PARM '*BLANKS' @RTCD                                               CDL013
     C                     PARM '*VERIFY' @OPTN                                               CDL013
     C                     PARM 'CDL013'  @SARD                                               CDL013
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL013
      *                                                                                       CDL013
      *** CAR CDL013 is NOT installed                                                         CDL013
     C           @RTCD     IFNE *BLANKS                                                       CDL013
     C                     MOVE 'N'       CDL013  1                                           CDL013
      *                                                                                       CDL013
      *** CAR CDL013 is installed                                                             CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C                     MOVE 'Y'       CDL013  1                                           CDL013
     C                     MOVEL'RETAIL'  ULSTAX 10 P                                         CDL013
      *                                                                                       CDL013
      *** Access WHT ICD record to determine WHT rate.                                        CDL013
     C                     OPEN SDSTAAL1                                                      CDL013
     C           ULSTAX    CHAINSDSTAAL1             70                                       CDL013
      *                                                                                       CDL013
     C           *IN70     IFEQ *ON                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'SDSTAAL1'DBFILE           ************                       CDL013
     C                     MOVEL'RETAIL'  DBKEY            * DBERR 50 *                       CDL013
     C                     Z-ADD50        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      *** Open Account Details Extension file                                                 CDL013
     C                     OPEN ACCNTBY0                                                      CDL013
      *                                                                                       CDL013
      *** Retrieve Base CCy details                                                           CDL013
     C                     MOVE BJCYCD    @CCY                                                CDL013
     C                     EXSR RTCCYS                                                        CDL013
     C                     MOVE @CCY      ZCCYT                                               CDL013
     C                     Z-ADDTRT,@I    ZRATET                                              CDL013
     C                     MOVE TDP,@I    ZCDPT                                               CDL013
     C                     MOVE TMD,@I    ZMDINT                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CAP205
      ** Access SAR details file to see if CAP205 is installed.                               CAP205
      *                                                                                       CAP205
     C                     CALL 'AOSARDR0'                                                    CAP205
     C                     PARM *BLANKS   PRTCD                                               CAP205
     C                     PARM '*VERIFY' POPTN                                               CAP205
     C                     PARM 'CAP205'  PSARD                                               CAP205
     C           SCSARD    PARM SCSARD    DSFDY                                               CAP205
      *                                                                                       CAP205
     C                     MOVE 'N'       CAP205  1                                           CAP205
     C           PRTCD     IFEQ *BLANKS                                                       CAP205
     C                     MOVE 'Y'       CAP205                                              CAP205
     C                     ELSE                                                               CAP205
     C           PRTCD     IFNE '*NRF    '                                                    CAP205
     C           *LOCK     IN   LDA                                                           CAP205
     C                     MOVEL'SCSARDPD'DBFILE                                              CAP205
     C                     MOVEL'CAP205'  DBKEY                                               CAP205
     C                     Z-ADD58        DBASE                                               CAP205
     C                     EXSR DBERR                                                         CAP205
     C                     ENDIF                                                              CAP205
     C                     ENDIF                                                              CAP205
     C/COPY WNCPYSRC,REH00181
      *                                                                                       CDL081
      ** Check if CDL081 is installed                                                         CDL081
      *                                                                                       CDL081
     C                     MOVE 'N'       CDL081  1                                           CDL081
     C                     CALL 'AOSARDR0'                                                    CDL081
     C                     PARM *BLANKS   PRTCD                                               CDL081
     C                     PARM '*VERIFY' POPTN                                               CDL081
     C                     PARM 'CDL081'  PSARD                                               CDL081
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL081
      *                                                                                       CDL081
     C           PRTCD     IFNE *BLANKS                                                       CDL081
     C           PRTCD     ANDNE'*NRF   '                                                     CDL081
     C           *LOCK     IN   LDA                                                           CDL081
     C                     Z-ADD056       DBASE                                               CDL081
     C                     MOVE 'SCSARDPD'DBFILE                                              CDL081
     C                     MOVEL'CDL081'  DBKEY                                               CDL081
     C                     EXSR DBERR                                                         CDL081
     C                     END                                                                CDL081
      *                                                                                       CDL081
     C           PRTCD     IFEQ *BLANKS                                                       CDL081
     C                     MOVE 'Y'       CDL081                                              CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL081
      ** Access withholding tax round down system values if CDL081 is on                      CDL081
      *                                                                                       CDL081
     C           CDL081    IFEQ 'Y'                                                           CDL081
     C                     CALL 'AOSVALR0'                                                    CDL081
     C                     PARM *BLANKS   PRTCD                                               CDL081
     C                     PARM C#BASE    SVALK1 20                                           CDL081
     C                     PARM           SVAL1 200                                           CDL081
     C                     PARM C#NBAS    SVALK2 20                                           CDL081
     C                     PARM           SVAL2 200                                           CDL081
     C                     PARM *BLANK    SVALK3 20                                           CDL081
     C                     PARM           SVAL3 200                                           CDL081
     C                     PARM *BLANK    SVALK4 20                                           CDL081
     C                     PARM           SVAL4 200                                           CDL081
     C                     PARM *BLANK    SVALK5 20                                           CDL081
     C                     PARM           SVAL5 200                                           CDL081
     C                     PARM *BLANK    SVALK6 20                                           CDL081
     C                     PARM           SVAL6 200                                           CDL081
     C                     PARM *BLANK    SVALK7 20                                           CDL081
     C                     PARM           SVAL7 200                                           CDL081
     C                     PARM *BLANK    SVALK8 20                                           CDL081
     C                     PARM           SVAL8 200                                           CDL081
     C                     PARM *BLANK    SVALK9 20                                           CDL081
     C                     PARM           SVAL9 200                                           CDL081
     C                     PARM *BLANK    SVALK0 20                                           CDL081
     C                     PARM           SVAL10200                                           CDL081
      *                                                                                       CDL081
     C           PRTCD     IFNE *BLANKS                                                       CDL081
     C           *LOCK     IN   LDA                                                           CDL081
     C                     Z-ADD057       DBASE                                               CDL081
     C                     MOVE 'SDSVALPD'DBFILE                                              CDL081
     C           SVAL1     IFEQ '*NRF'                                                        CDL081
     C                     MOVELSVALK1    DBKEY                                               CDL081
     C                     ENDIF                                                              CDL081
     C           SVAL2     IFEQ '*NRF'                                                        CDL081
     C                     MOVELSVALK2    DBKEY                                               CDL081
     C                     ENDIF                                                              CDL081
     C                     EXSR DBERR                                                         CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL081
      ** Setup tax amount rounding down indicators                                            CDL081
      *                                                                                       CDL081
     C                     MOVELSVAL1     W#BSRD  1                                           CDL081
     C                     MOVELSVAL2     W#NBRD  1                                           CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                     MD054623
      ** Check if RTSNarrFormat is set to 'Y'                                               MD054623
      *                                                                                     MD054623
     C                     MOVE *BLANKS   RTSNK2                                            MD054623
     C                     MOVE *BLANKS   RTSNK3                                            MD054623
     C                     MOVE *BLANKS   RTSNK4                                            MD054623
     C                     MOVE *BLANKS   RTSNK5                                            MD054623
     C                     MOVE *BLANKS   RTSNK6                                            MD054623
     C                     MOVE *BLANKS   RTSNK7                                            MD054623
     C                     MOVE *BLANKS   RTSNK8                                            MD054623
     C                     MOVE *BLANKS   RTSNK7                                            MD054623
     C                     MOVE *BLANKS   RTSNK8                                            MD054623
      *                                                                                     MD054623
     C                     CALL 'AOSVALR0'                                                  MD054623
     C                     PARM *BLANKS   RTNCDE  7                                         MD054623
     C                     PARM           RTSNK1 20                                         MD054623
     C                     PARM           RTSN1 200                                         MD054623
     C                     PARM           RTSNK2 20                                         MD054623
     C                     PARM           RTSN2 200                                         MD054623
     C                     PARM           RTSNK3 20                                         MD054623
     C                     PARM           RTSN3 200                                         MD054623
     C                     PARM           RTSNK4 20                                         MD054623
     C                     PARM           RTSN4 200                                         MD054623
     C                     PARM           RTSNK5 20                                         MD054623
     C                     PARM           RTSN5 200                                         MD054623
     C                     PARM           RTSNK6 20                                         MD054623
     C                     PARM           RTSN6 200                                         MD054623
     C                     PARM           RTSNK7 20                                         MD054623
     C                     PARM           RTSN7 200                                         MD054623
     C                     PARM           RTSNK8 20                                         MD054623
     C                     PARM           RTSN8 200                                         MD054623
     C                     PARM           RTSNK9 20                                         MD054623
     C                     PARM           RTSN9 200                                         MD054623
     C                     PARM           RTSNK0 20                                         MD054623
     C                     PARM           RTSN10200                                         MD054623
      *                                                                                     MD054623
     C           RTNCDE    IFNE *BLANKS                                                     MD054623
     C           RTSN10    IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK0    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN9     IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK9    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN8     IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK8    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN7     IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK7    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN6     IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK6    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN5     IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK5    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN4     IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK4    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN3     IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK3    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN2     IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK2    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN1     IFEQ '*NRF'                                                      MD054623
     C                     MOVE RTSNK1    DBKEY                                             MD054623
     C                     ENDIF                                                            MD054623
     C           *LOCK     IN   LDA                                                         MD054623
     C                     MOVEL'SDSVALPD'DBFILE           *************                    MD054623
     C                     Z-ADD40        DBASE            ** DB ERR 40 **                  MD054623
     C                     EXSR DBERR                      *************                    MD054623
     C                     ENDIF                                                            MD054623
     C           RTSN11    IFEQ 'Y'                                                         MD054623
     C                     MOVE 'Y'       RTSNAR  1                                         MD054623
     C                     ELSE                                                             MD054623
     C                     MOVE 'N'       RTSNAR                                            MD054623
     C                     ENDIF                                                            MD054623
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4112CCP4                                           S01408
     C*                                                                   S01408
      *
      ** Initialise work fields and indicators
     C                     Z-ADD0         @TAMT  150
     C                     Z-ADD1         @WX     20
     C                     Z-ADDPCHTL     @CHTL
     C                     Z-ADDPNCTL     @NCTL
     C                     Z-ADDBJRDNB    @VLDT
     C                     Z-ADDBJRDNB    @RUND
     C                     Z-ADDBJRDNB    RUND    50
     C                     Z-ADD1         @COUNT  10
     C/COPY WNCPYSRC,RE4112C015
      *                                                                   CRT002
      **  Load tellers to array.                                          CRT002
      *                                                                   CRT002
     C                     EXSR LODTLR                                    CRT002
      *
     C                     MOVE '0'       @FIRST                          CRT002
      *                                                                   CRT002
     C                     MOVEL'RE4112'  P@QRC                           CRT002
     C                     MOVE '00A '    P@QRC                           CRT002
      *                                                                   CRT002
     C/COPY ZSRSRC,RBOITMC1                                               CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   CCG016  1                                           CCG016
     C                     CALL 'AOSARDR0'                                                    CCG016
     C                     PARM *BLANKS   PRTCD   7                                           CCG016
     C                     PARM '*VERIFY' POPTN   7                                           CCG016
     C                     PARM 'CCG016'  PSAR    6                                           CCG016
     C           PRTCD     IFEQ *BLANKS                                                       CCG016
     C                     MOVEL'Y'       CCG016                                              CCG016
     C                     END                                                                CCG016
      *                                                                                       CCG016
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            PCMTXT - Prepare Commitment Text                   *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY         -                                           *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           PCMTXT    BEGSR                           ** PCMTXT **   CRT002
      *                                                                   CRT002
      **  Prepare the comit text CMTTXT                                   CRT002
      *                                                                   CRT002
     C                     MOVE 'RE'      MDID                            CRT002
     C                     MOVEL@PGM      PGMN                            CRT002
     C                     MOVE SWSID     WSIDX                           CRT002
     C                     MOVELSUSER     USRIDX                          CRT002
     C                     TIME           MTIME                           CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT
      *****************************************************************
      *                                                               *
      *            DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLS      *PSSR  - Program  error                            *
      *                                                               *
      * CALLED BY  FIRST  - Initial Processing                        *
      *            UPTRL  - Update Control Trailer Record             *                       CRE019
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DBERR     BEGSR                           ** DBERR  **
      *
     C                     MOVEL@PGM      DBPGM
     C                     OUT  LDA
      *
     C                     EXSR *PSSR
      *
     C                     ENDSR
      *****************************************************************
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4112CCP5                                           S01408
     C*                                                                   S01408
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4112CCP7                                           S01408
     C*                                                                   S01408
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4112CCP6                                           S01408
     C*                                                                   S01408
      /EJECT
      *****************************************************************
      *                                                               *
      *            LAST   - Final Processing                          *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           LAST      BEGSR                           ** LAST   **
      *
     C                     CLOSE*ALL                   69
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR             - Program error                             *
      *                                                               *
      * CALLS      DBERRCTL                                           *
      *                                                               *
      * CALLED BY  DBERR  - Database Error Handling                   *
      *                                                               *
      *****************************************************************
     C           *PSSR     BEGSR                           ** *PSSR  **
      *
     C*
     C** Check to see that *PSSR has not been called yet
     C*
     C           WRUN      IFEQ *BLANK
     C                     MOVE 'Y'       WRUN    1
     C                     SETON                     U7U8LR
     C                     DUMP
     C*
     C** Call standard database error program
     C*
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     CALL 'DBERRCTL'
     C                     END                                            CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           @FIRST    ANDEQ'0'                                       CRT002
      *                                                                   CRT002
     C                     ROLBK                                          CRT002
      *                                                                   CRT002
     C                     MOVELRAMSTY    RBMSTY                          CRT002
     C                     MOVELDBLOT     RBHSMS                          CRT002
     C                     MOVEL'DBER'    RBHMSI                          CRT002
     C                     MOVEL'1'       RBAEFL                          CRT002
     C                     MOVEL'E'       RBHMSS                          CRT002
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
      *                                                                   CRT002
     C                     MOVEL'USR0010' @MSGID                          CRT002
     C                     MOVELDBLOT     @MSGDT                          CRT002
     C                     EXSR RTVMSG                                    CRT002
     C                     MOVEL@MSGTX    RBHSMS                          CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVE 'N'       WSUCM                           CRT002
     C                     MOVE 'DS'      WSTAT                           CRT002
     C                     TIME           WTMDS                           CRT002
     C           WTHR      CAT  ':'       WA                              CRT002
     C           WTMN      CAT  ':'       WB                              CRT002
     C           WA        CAT  WB        WC                              CRT002
     C           WC        CAT  WTSS      WSTTM                           CRT002
      *                                                                   CRT002
     C                     MOVELREPOIO    P@QDS                           CRT002
      *                                                                   CRT002
     C                     CLEARWCMSG                                     CRT002
     C                     MOVELREPOIO    WCMSG                           CRT002
      *                                                                   CRT002
     C                     EXSR SDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
     C                     EXSR WRLOG                                     CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
     C                     MOVEL*BLANKS   REPOIO                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
     C*
     C                     END
     C*
     C** If *PSSR already run, then just end the program here
     C*
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              198870
      *****************************************************************   198870
      *                                                               *   198870
      *            PAD    - Pad field with leading zeros.             *   198870
      *                                                               *   198870
      * CALLS             -                                           *   198870
      *                                                               *   198870
      * CALLED BY  WRKACC - Work with account                         *   198870
      *                                                               *   198870
      * FLDS USED         -                                           *   198870
      *                                                               *   198870
      *****************************************************************   198870
     C           PAD       BEGSR                                          198870*** PAD    ***
      *                                                                   198870
      **  Pad field with zeros to coincide with Cashier format.           198870
      *                                                                   198870
     C                     Z-ADD1         L       20                      198870
     C                     Z-ADD0         WEND    20                      198870
     C           ' '       CHECKWFIELD    WEND                            198870
     C                     MOVEA*BLANKS   RTE,1                           198870
     C                     MOVEAWFIELD    RTE,1                           198870
      *                                                                   198870
     C           L         DOWLTWEND                                      198870
     C                     MOVEL'0'       RTE,L                           198870
     C                     ADD  1         L                               198870
     C                     ENDDO                                          198870
      *                                                                   198870
      **  Replace any commas caused by County-specific character sets     198870
      **  by decimal points to ensure Cashier compatibility.              198870
      *                                                                   198870
     C                     Z-ADD1         X                               198870
     C                     MOVE '0'       *IN68                           198870
      *                                                                   198870
     C           ','       LOKUPRTE,X                  60                 198870
     C           *IN60     IFEQ *ON                                       198870
     C                     MOVEL'.'       RTE,X                           198870
     C                     ENDIF                                          198870
      *                                                                   198870
     C                     ENDSR                                          198870
      *                                                                   198870
      *****************************************************************   198870
      *****************************************************************                       CDL013
     C           #ERTCL    BEGSR                                                              CDL013
      *                                                                                       CDL013
      ** Define parameters                                                                    CDL013
      *                                                                                       CDL013
     C                     Z-ADD@ACNO     @ACNO  100                                          CDL013
     C                     Z-ADD@CLBL     @CLBL  150                                          CDL013
     C                     Z-ADD@CHRG     @CHRG  150                                          CDL013
     C                     Z-ADD@INTR     @INTR  150                                          CDL013
     C                     Z-ADD@CLOB     @CLOB  150                                          CDL013
      *                                                                                       CDL013
     C                     Z-ADD@INTT     @INTT  150                                          CDL013
     C                     Z-ADD@WTAX     @WTAX  150                                          CDL013
     C                     Z-ADD@ACOD     @ACOD  100                                          CDL013
     C                     Z-ADDRHISD     RHISD   50                                          CDL013
     C                     Z-ADDRHISB     RHISB  150                                          CDL013
      *                                                                                       CDL013
      * Retrieve retail interest and charges                                                  CDL013
      *                                                                                       CDL013
     C           KLACNT    CHAINREIAC                80                                       CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '1'                                                           CDL013
      *                                                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL@ACCN     DBKEY                                               CDL013
     C                     MOVEL'REIAC'   DBFILE                                              CDL013
      *                                                                                       CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      * Retrieve retail interest accrual ITD                                                  CDL013
      *                                                                                       CDL013
     C           KLACNT    CHAINREACR                80                                       CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '1'                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL@ACNO     DBKEY                                               CDL013
     C                     MOVEL'REACR'   DBFILE                                              CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** If no database errors                                                                CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '0'                                                           CDL013
      *                                                                                       CDL013
      ** Calculate charges                                                                    CDL013
      *                                                                                       CDL013
     C                     Z-ADDCHGT      @CHGT                                               CDL013
     C                     Z-ADDCHST      @CHST                                               CDL013
     C                     MOVEL@CCY      @CHCY                                               CDL013
     C                     MOVELCHAC      @CHAC                                               CDL013
     C                     Z-ADDRCA       @RCA                                                CDL013
     C                     Z-ADDNRCA      @NRCA                                               CDL013
     C                     Z-ADDLCD       RHISD                                               CDL013
     C                     Z-ADDHISB      RHISB                                               CDL013
      *                                                                                       CDL013
      *                                                                                       CDL013
      ** Get fixed account charge                                                             CDL013
      *                                                                                       CDL013
     C                     MOVE @BRCA     @BRCDX  3                                           CDL013
     C           KFXA      CHAINREFXAJL0             88                                       CDL013
     C                     Z-ADDRYACCH    @FXACM                                              CDL013
      *                                                                                       CDL013
     C                     EXSR RTCHRG                                                        CDL013
      *                                                                                       CDL013
      *  Calculate commissions - added to @CHRG                                               CDL013
      *                                                                                       CDL013
     C                     EXSR RTCOMM                                                        CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '0'                                                           CDL013
      *                                                                                       CDL013
      ** Calculate interest                                                                   CDL013
      *                                                                                       CDL013
     C                     MOVELDACP      @DACP  21                                           CDL013
     C                     MOVELCACP      @CACP  21                                           CDL013
     C                     Z-ADDMADI      @MADI  130                                          CDL013
     C                     Z-ADDMACI      @MACI  130                                          CDL013
     C                     Z-ADDGADI      @GADI  130                                          CDL013
     C                     Z-ADDGACI      @GACI  130                                          CDL013
     C                     Z-ADDDAIC1     @DAIC1 130                                          CDL013
     C                     Z-ADDCAIC1     @CAIC1 130                                          CDL013
      *                                                                                       CDL013
     C                     EXSR RTINTR                                                        CDL013
      *                                                                                       CDL013
      ** Add net-interest & service charge to close balance                                   CDL013
      *                                                                                       CDL013
     C           @INTR     ADD  @CHRG     @CLOB                                               CDL013
      *                                                                                       CDL013
      ** If the customer is liable calculate tax                                              CDL013
      *                                                                                       CDL013
     C           BBCSTY    IFNE 'N'                                                           CDL013
      *                                                                                       CDL013
      ** Include withholding tax in closing balance                                           CDL013
      *                                                                                       CDL013
      ** If SDSTAXPD/TXWNDI is 'Y', compute tax from net interest (sum                        CDL013
      ** of DR and CR interests).  Else, compute tax from gross                               CDL013
      ** interest (CR interest only).                                                         CDL013
      *                                                                                       CDL013
     C           TXWNDI    IFEQ 'Y'                                                           CDL013
     C                     Z-ADD@INTR     @INTT                                               CDL013
     C                     ELSE                                                               CDL013
     C                     Z-SUB@CRINT    @INTT                                               CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** If the resulting interest is zero or debit, no need to compute                       CDL013
      ** for the w/holding tax.  It is automatically equal to zero.                           CDL013
      *                                                                                       CDL013
     C           @INTT     IFGE *ZERO                                                         CDL013
     C                     Z-ADD*ZERO     @WTAX                                               CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      * Retrieve Taxable indicator for this Account.                                          CDL013
      *                                                                                       CDL013
     C           ACNTXF    KLIST                                                              CDL013
     C                     KFLD           @CNUM                                               CDL013
     C                     KFLD           @CCY                                                CDL013
     C                     KFLD           @ACOD                                               CDL013
     C                     KFLD           @ACSQ                                               CDL013
     C                     KFLD           @BRCDX                                              CDL013
      *                                                                                       CDL013
     C           ACNTXF    CHAINACCNTBY0             70                                       CDL013
     C           *IN70     IFEQ *ON                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'ACCNTBY0'DBFILE           ************                       CDL013
     C                     MOVEL@CNUM     DBKEY            * DBERR 25 *                       CDL013
     C                     Z-ADD25        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      *** If Tax indicator is ZERO set WHT rate to ZERO,                                      CDL013
      *** otherwise set WHT rate.                                                             CDL013
     C                     SELEC                                                              CDL013
     C           ATITAX    WHEQ '0'                                                           CDL013
     C                     Z-ADD0         ULWHTR  52                                          CDL013
     C           ATITAX    WHEQ '1'                                                           CDL013
     C                     Z-ADDETXR1     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '2'                                                           CDL013
     C                     Z-ADDETXR2     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '3'                                                           CDL013
     C                     Z-ADDETXR3     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '4'                                                           CDL013
     C                     Z-ADDETXR4     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '5'                                                           CDL013
     C                     Z-ADDETXR5     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '6'                                                           CDL013
     C                     Z-ADDETXR6     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '7'                                                           CDL013
     C                     Z-ADDETXR7     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '8'                                                           CDL013
     C                     Z-ADDETXR8     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '9'                                                           CDL013
     C                     Z-ADDETXR9     ULWHTR                                              CDL013
     C                     ENDSL                                                              CDL013
      *                                                                                       CDL013
      *** If WHT rate is ZERO set tax amount to ZERO.                                         CDL013
     C           ULWHTR    IFEQ *ZERO                                                         CDL013
     C                     Z-ADD0         @WTAX                                               CDL013
      *                                                                                       CDL013
      *** otherwise calculate tax amount.                                                     CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      *** If Account currency is in Base Currency.                                            CDL013
      *** and CDL081 is off                                                                   CDL081
      *                                                                                       CDL081
     C           @CCY      IFEQ BJCYCD                                                        CDL013
     C           CDL081    ANDEQ'N'                                                           CDL081
      *                                                                                       CDL013
      *** Set work adjustment field according to number of decimal                            CDL013
      *** places in currency before calculating the tax amount.                               CDL013
     C                     SELEC                                                              CDL013
     C           ZCDPT     WHEQ 0                                                             CDL013
     C                     Z-ADD1         ULWKAD  40                                          CDL013
     C           ZCDPT     WHEQ 1                                                             CDL013
     C                     Z-ADD10        ULWKAD                                              CDL013
     C           ZCDPT     WHEQ 2                                                             CDL013
     C                     Z-ADD100       ULWKAD                                              CDL013
     C           ZCDPT     WHEQ 3                                                             CDL013
     C                     Z-ADD1000      ULWKAD                                              CDL013
     C                     ENDSL                                                              CDL013
      *                                                                                       CDL013
      *** Account currency is in Base Currency round down gross                               CDL013
      *** Interest Amount.                                                                    CDL013
     C           @INTT     DIV  ULWKAD    ULTINT 150                                          CDL013
     C                     MULT ULWKAD    ULTINT                                              CDL013
      *                                                                                       CDL013
      *** calculate Tax Amount.                                                               CDL013
     C           ULTINT    MULT ULWHTR    @WTAX                                               CDL013
     C                     DIV  100       @WTAX                                               CDL013
      *                                                                                       CDL013
      *** round down Tax Amount.                                                              CDL013
     C           @WTAX     DIV  ULWKAD    @WTAX  150                                          CDL013
     C                     MULT ULWKAD    @WTAX                                               CDL013
      *                                                                                       CDL013
      *** otherwise (Account Ccy NOT = Base Ccy) calculate                                    CDL013
      *** Tax amount without rounding down.                                                   CDL013
     C                     ELSE                                                               CDL013
     C           @INTT     MULT ULWHTR    @WTAX                                               CDL013
      *                                                                                       CDL081
      ** Check if tax amount is to be rounded down                                            CDL081
      *                                                                                       CDL081
     C           @CCY      IFEQ BJCYCD                                                        CDL081
     C           CDL081    ANDEQ'Y'                                                           CDL081
     C           W#BSRD    ANDEQ'Y'                                                           CDL081
     C           @CCY      ORNE BJCYCD                                                        CDL081
     C           CDL081    ANDEQ'Y'                                                           CDL081
     C           W#NBRD    ANDEQ'Y'                                                           CDL081
     C                     DIV  100       @WTAX                                               CDL081
     C                     ELSE                                                               CDL081
     C                     DIV  100       @WTAX     H                                         CDL013
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL013
      ** Calculate the interest amount in base currency (ULTINT)                              CDL013
      *                                                                                       CDL013
      ** Retrieve Account Ccy details                                                         CDL013
     C                     EXSR RTCCYS                                                        CDL013
     C                     MOVE @CCY      ZCCYF                                               CDL013
     C                     Z-ADDTRT,@I    ZRATEF                                              CDL013
     C                     MOVE TDP,@I    ZCDPF                                               CDL013
     C                     MOVE TMD,@I    ZMDINF                                              CDL013
      *                                                                                       CDL013
      ** Set amount in the Account Ccy                                                        CDL013
     C                     Z-ADD@INTT     ZAMTF                                               CDL013
      *                                                                                       CDL013
      ** Convert the amount to the Base Ccy                                                   CDL013
     C                     EXSR RTCCYX                                                        CDL013
      *                                                                                       CDL013
      ** Set amount in the Base Ccy                                                           CDL013
     C                     Z-ADDZAMTT     ULTINT                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Access account code details                                                          CDL013
      *                                                                                       CDL013
     C                     MOVE @ACOD     @ACODA 10                                           CDL013
      *                                                                                       CDL013
     C                     CALL 'AOACODR0'                                                    CDL013
     C                     PARM *BLANKS   @RTCD                                               CDL013
     C                     PARM '*KEY   ' @OPTN                                               CDL013
     C                     PARM           @ACODA                                              CDL013
     C           SDACOD    PARM SDACOD    DSFDY                                               CDL013
      *                                                                                       CDL013
      ** Error in SDACODPA                                                                    CDL013
      *                                                                                       CDL013
     C           @RTCD     IFNE *BLANKS                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'SDACODPD'DBFILE           ************                       CDL013
     C                     MOVEL@ACODA    DBKEY            * DBERR 21 *                       CDL013
     C                     Z-ADD21        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Check if the interest amount in base ccy is below minimum                            CDL013
     C                     Z-SUBULTINT    ULTINT                                              CDL013
     C           ULTINT    IFLT A5MISU                                                        CDL013
     C                     Z-ADD*ZERO     @WTAX                                               CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Subtract Withholding Tax from Close Balance                                          CDL013
      *                                                                                       CDL013
     C                     Z-SUB@WTAX     @WTAX                                               CDL013
     C                     ADD  @WTAX     @CLOB                                               CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Add cleared balance to close balance                                                 CDL013
      *                                                                                       CDL013
     C                     ADD  @CLBL     @CLOB                                               CDL013
      *                                                                                       CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVE 'RECRG'   DBFILE                                              CDL013
     C                     MOVEL@KEY      DBKEY                                               CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDSR                                                              CDL013
      *****************************************************************                       CDL013
      *****************************************************************                       CDL013
      /EJECT
      /COPY ZSRSRC,RTENCPC1
      ** Passcode encription
      *
      *****************************************************************
      /EJECT
      ** Password retrieval subroutine
      /COPY ZSRSRC,RTPSWDC2
      *
      *****************************************************************
      /EJECT
      ** Password retrieval subroutine
      /COPY ZSRSRC,RTCCYXC1
      *
      *****************************************************************
      *
      /EJECT
      /COPY ZSRSRC,RTCOMMC1
      *                                                                   106661
      /COPY ZSRSRC,RTCLOSC1                                               106661
     C**                                                                  S01408
     C/COPY WNCPYSRC,RE4112CP13                                           S01408
     C**                                                                  S01408
      *
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBSDQMS                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBRDQMS                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBDQERR                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBMODTC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBRMSGC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBWLOGC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,ZEDITZ2                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBLDTLC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,ZDATE9Z3                                               CRT002
      *                                                                   CRT002
      ** Account Details
     OACCNTABFE                @RLACC
      *
      ** Account Trailer
     OACCNTACFE                @UPACC
      *
     O                         NORE
     O                         NINU
     O                         NOAM
     O                         NOCL
     O                         NOAU
     O                         LCD
     O                         TNLU
      *
      ** Retail Shadow Balances
     O****MEMOSMDFE******          @RLMEM                                 CCB002
      *
      ** Cheque book details
     OCHQBKPDFE                @RLCQB
      *
      ** Teller controls
     OTTRNTM2FE                @RELTT
      *
      *****************************************************************
     O/COPY WNCPYSRC,RE4112O001
**  CPY@  OBJECT COPYRIGHT
(c) Finastra International Limited 2001
**   ZYDY - Years in days cumulative, four year span
0366073110961461
**   ZMDY - Months in days cumulative through year
000031059090120151181212243273304334365
**   ZMNM - Months short names
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** - @P   - Array to hold the positions of the validation indicators
01020304050607080910111213141516171819202122232425
**  alphanumeric table
ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789
**  encription code table
SDKJFIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJ
FIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJFIEN
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
** @TXT - Large text strings                                              CRT002
OVRDBF     FILE(TTRANPD) MBR(XXXX) SECURE(*YES) SHARE(*YES) SEQONLY(*NO)
OVRDBF     FILE(TTRANPT) MBR(XXXX) SECURE(*YES) SHARE(*YES) SEQONLY(*NO)
DLTOVR     FILE(TTRANPD)
DLTOVR     FILE(TTRANPT)
**  WTEXT WARNING TEXT MESSAGE                                            CRT002
KSM2329  Multiple referrals exist ( ) -                                   CRT002
**  TABC1/TABC2 - WARNING MESSAGE CONVERTION TABLE                        CRT002
HOLDS   HLDS                                                              CRT002
EXCESS  EXCS                                                              CRT002
FLOAT   FLOT                                                              CRT002
CLS.O/D CSOD                                                              CRT002
SVG.O/D SVOD                                                              CRT002
MAX.CCY MXCY                                                              CRT002
CHQBKER CQBK                                                              CRT002
N.S.F.  NSF                                                               CRT002
EX.O/D  EXOD                                                              CRT002
BLW.MIN BLMN                                                              CRT002
AC.CLG  ACCL                                                              CRT002
N.ASGL1 NAG1                                                              CRT002
N.ASGL2 NAG2                                                              CRT002
N.ASGL3 NAG3                                                              179321
BADDPT  BDDT                                                              CRT002
BLOCKCR BLCR                                                              CRT002
BLOCKDR BLDR                                                              CRT002
BNKRPT  BKRP                                                              CRT002
BR.DIF  BRDF                                                              CRT002
BR.DIF1 BRD1                                                              190137
BR.DIF2 BRD2                                                              190137
BFBVIC  BVCQ                                                              CRT002
CHQPRES CQPR                                                              CRT002
CHQRNG  CQRN                                                              CRT002
INACTV  INAC                                                              CRT002
INACTV1 INA1                                                              179321
INACTV2 INA2                                                              179321
REFERCR RFCR                                                              CRT002
REFERDR RFDR                                                              CRT002
STOPCHQ STCQ                                                              CRT002
TLIMIT  TLLM                                                              CRT002
N.WKDAY NWKD                                                              CRT002
XRTWARN XRTW                                                              CRT002
TLIMIT1 TLLM                                                              142092
TLIMIT2 TLLM                                                              142092
CLOSED  CLOS                                                              142092
BLOCKED BLOK                                                              142092
NOTZERO NZRO                                                              142092
BR.OFF  BOFF                                                              CRT007
BR.OFF1 BOF1                                                              CRT007
BR.OFF2 BOF2                                                              CRT007
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
