     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE Cheque Withdrawal (Non-Account Currency)')    *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Retail Module                                        *
     F*                                                               *
     F*  RE4119 - Cheque Withdrawal - Non-Account Currency            *
     F*                                                               *
     F*  Function:  This program accepts and validates cheque         *
     F*  (I/C)      withdrawals in non-account currency and performs  *
     F*             file updates to the teller system master files.   *
     F*             A transaction confirmation slip is generated      *
     F*             during this transaction, as a receipt for the     *
     F*             customer.                                         *
     F*                                                               *
     F*  Called By: REC4119 - Cheque Withdrawal in Non A/C Ccy        *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. 218877             Date 26Aug15               *     
      *  Prev Amend No. MD042745           Date 20Nov16               *
      *                 CCG016             Date 13Sep16               *
      *                 CGL165             Date 17Feb15               *
      *                 AR1087355          Date 30Sep13               *
      *                 MD020701           Date 30Sep13               *
      *                 MD020635           Date 30Sep13               *
      *                 AR1083178          Date 30Sep13               *
      *                 CRE081             Date 30Sep13               *
      *                 252150             Date 03Sep12               *
      *                 263834             Date 17Mar10               *
      *                 CRE073             Date 06Dec10               *
      *                 CRE075             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016             Date 19May08               *
      *                 CER047             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 BUG27532           Date 26Apr10               *
      *                 BUG27045A          Date 13Apr10               *
      *                 BUG27045           Date 18Feb10               *
      *                 CAP205             Date 23Feb10               *
      *                 CAP204             Date 09Feb10               *
      *                 CRE401             Date 26Nov09               *
      *                 CDL081             Date 14Dec09               *
      *                 CAP187             Date 21Aug09               *
      *                 260297             Date 19May09               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 BUG15976A          Date 25Apr08               *
      *                 253689 (BUG17640)  Date 09Apr08               *
      *                 BUG16738A          Date 04Apr08               *
      *                 BUG15976           Date 04Apr08               *
      *                 250891             Date 16Oct07               *
      *                 249968             Date 12Sep07               *
      *                 249909             Date 04Sep07               *
      *                 249218             Date 15Aug07               *
      *                 BUG13078           Date 31Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 26Sep06               *
      *                 241729             Date 23Aug06               *
      *                 CDL013             Date 09Jun06               *
      *                 CSD031             Date 10Apr06               *
      *                 BUG8798            Date 10Oct05               *
      *                 BUG8514            Date 14Jun06               *
      *                 165543             Date 06Jun06               *
      *                 CRT026             Date 23May06               *
      *                 CSD027             Date 09Dec05               *
      *                 BUG8067            Date 05Sep05               *
      *                 BUG7819            Date 30Aug05               *
      *                 BUG8168            Date 25Aug05               *
      *                 BUG7638            Date 20Jul05               *
      *                 BUG6342            Date 15Apr05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG4470            Date 01Dec04               *
      *                 BUG4169            Date 29Sep04               *
      *                 BUG3229            Date 23Aug04               *
      *                 BUG3845            Date 27Aug04               *
      *                 BUG3855            Date 03Aug04               *
      *                 BUG2849            Date 06Jun04               *
      *                 BUG3734            Date 21Jul03               *
      *                 CLE025             Date 20Oct03               *
      *                 CAAA03             Date 30Apr04               *
      *                 CRE019             Date 15Mar04               *
      *                 CGL029             Date 01Sep03               *
      *                 CRT012             Date 26Nov02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 201732             Date 24Jan02               *
      *                 CRT007             Date 14Jan02               *
     F*                 CRT005             Date 27Nov01               *
     F*                 198870             Date 12Oct01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 194978             Date 28Jun01               *
      *                 CRT006             Date 17Apr01               *
      *                 190687             Date 05Mar01               *
      *                 CDE002             Date 21Dec99               *
      *                 193529             Date 29May01               *
      *                 184205             Date 19Apr01               *
      *                 190137             Date 18Apr01               *
      *                 174972             Date 17Apr01               *
      *                 159251             Date 17Apr01               *
      *                 101578             Date 17Apr01               *
      * Midas DBA 3.04 -----------------------------------------------*
     F*                 166612             Date 18Oct00               *
     F*                 184553             Date 05Oct00               *
     F*                 180663             Date 05Oct00               *
     F*                 171139             Date 04Oct00               *
      * Midas DBA 3.03 -----------------------------------------------*
     F*                 144506             Date 15Aug00               *
     F*                 145752             Date 15Aug00               *
     F*                 140770             Date 14Aug00               *
     F*                 179321             Date 26May00               *
      *                 176510             Date 17Mar00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 162643             Date 01Jul99               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 142092             Date 06Jul99               *
      *                 163583             Date 02Jul99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 153001             Date 27Apr99               *
      *                 CSD005             Date 02MAR99               *
      *                 121425             Date 27Apr99               *
      *                 CTI002             Date 09Sep98               *
      *                 151260             Date 26Jan99               *
      *                 150864             Date 26Jan99               *
      *                 147915             Date 20Nov98               *
      *                 146200             Date 05Oct98               *
      *                 141862             Date 03Sep98               *
      *                 140802             Date 17Aug98               *
      *                 140255             Date 03Aug98               *
      *                 CEU024             Date 14Jul98               *
      *                 130543             Date 13Feb98               *
      *                 106661             Date 19Sep97               *
     F*                 120885             Date 05AUG97               *
     F*                 120880             Date 05Aug97               *
     F*                 118796             Date 05Aug97               *
     F*                 118131             Date 02Jun97               *
     F*                 118133             Date 02Jun97               *
     F*                 118271             Date 02Jun97               *
     F*                 114621             Date 21Feb97               *
     F*                 098166             Date 11JAN96               *
     F*                 CRT002             Date  1DEC95               *
     F*                 CBB002             DATE 26JUL96               *
     F*                 S01408             DATE 25APR96               *
     F*                 S01408             DATE 05MAR96               *
     F*                 S01408             DATE 14FEB96               *
     F*                 S01408             DATE 12FEB96               *
     F*                 S01408             DATE 11JAN96               *
     F*                 093546             DATE 12SEP95               *
     F*                 093545             DATE  8SEP95               *
     F*                 092429             DATE 24AUG95               *
     F*                 S01408             DATE 06SEP95               *
     F*                 091241             DATE 17JUL95               *
     F*                 CRT001  *CREATE    DATE 28FEB95               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  218877 - Recompiled due to changes in RTCCYSC1               *
      *         - Applied for MD-28376                                *     
      *  MD042745 - Travellers Cheque Number is 12 char long.         *
      *  CCG016 - Correspondence Manager for Retail Teller System.    *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  AR1087355C - Do not issue 'EX.O/D' error if withdrawal amnt  *
      *               is withn the range of Available Balance and     *
      *               Closing Balance.                                *
      *  MD020701  - Issue 'N.S.F.' error message instead of          *
      *              'EX.O/D' when account does not have overdraft.   *
      *  MD020635  - Warning errors for NSF, BLMN and EXOD were not   *
      *              initialised causing other warning messages to    *
      *              appear as failing override validation.           *
      *              Initialise override array @O to blanks.          *
      *  AR1083178 - Cannot withdraw from savings accounts, @CLBL is  *
      *              not set-up if CRE081 is ON.                      *
      *  CRE081 - Account Balance Check in RPG                        *
      *         - Consider the following programs in CRE081 changes:  *
      *           RE4116 RE4117 RE4118 RE4119 RE4121 RE4124           *
      *  252150 - COB component MEC103/GLC48 fails due to FOOB.       *
      *           Amend the program to match MOD/GLAMADUPD process    *
      *           when closing an account that is inserted the same   *
      *           day. Recompiled over changes ZSRSRC.RTACLSC1        *
      *           Applied for AR980794 (Child: AR980795)              *
      *  263834 - Account with Swift reference is deleted causing     *
      *           MEC105 fallover. Amended program in a way that      *
      *           that deletion is not allowed when record exists in  *
      *           file SWACSSB. Applied fix 263818.                   *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016 - German Interest Calculation: Upgarde of FGE059      *
      *           to Midas Plus (Recompile)                           *
      *  CER047 - German Features LF037-00 Reporting §24c KWG         *
      *           (Recompile)                                         *
      *  BUG27532 - Several fields are blank in the confirmation page *
      *             (Recompile)                                       *
      *  BUG27045A - Override the fix of Bug 27045 (Recompile)        *
      *  BUG27045 - Amend via SOAP removes Document Linkage           *
      *             (Recompile)                                       *
      *  CAP205 - Teller Related APIs - Account Balance Check         *
      *  CAP204 - Teller Related APIs - Account Transfer (Recompile)  *
      *  CRE401 - 4-Eyes Checking Gaps - Sweeps (Recompile)           *
      *  CDL081 - Tiered withholding tax rounding upgrade             *
      *  CAP187 - Document Linkage (Recompile)                        *
      *  260297 - Incorrect interest calculation w/ calc basis 6.     *
      *           Recompiled over changes in RTINDEF1 and RTINDEF2.   *
      *           Applied fix 220323.                                 *
      *  BUG15976A - Recompile due to changes in RE4119DF             *
      *  253689 - Check for outstanding sweep accounts by using       *
      *           full account number and retail account number       *
      *           as search keys (BUG17640)                           *
      *  BUG16738A- Error with Selling travellers cqs if Issuer is an *
      *             Alphanumeric Customer. Recompile due to changes in*
      *             RBSLTCC1                                          *
      *  BUG15976 - Screen looks as if text is overwritten            *
      *  250891 - Initialise field @SKIP.                             *
      *  249968 - Add Validations if there are Outstanding            *
      *           Held Items, Stopped Checks, Standing Orders         *
      *           and SWEEP before an account is close.               *
      *  249909 - Recompiled due to changes in RE4119DF.              *
      *  249218 - Applied fix 239004.                                 *
      *  239004 - 'Transaction Terminated' not shown when account's   *
      *           branch is not matched with teller ID branch.        *
      *  BUG13078 - DBERRCTL-Database error control (Recompile)       *
      *  242286 - Recompile over changes in /COPY RTINTRE.            *
      *  241729 - Rename the field ACNO in CHQBKPT to make sure       *
      *           account number is not overwritten with wrong value. *
      *  CDL013 - Tiered Withholding Tax                              *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  BUG8798 - Wrong heading show on advice (Recompile)           *
      *  BUG8514 - Issue regarding teller overrides(Recompile)        *
      *  165543 - Wrong CCY for Account Closure.                      *
      *           Recompile for changes in ZSRSRC/RTCLOSC1.           *
      *  CRT026  - Retail Teller Password Change                      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  BUG8067 - Add Transaction Time (Recompile)                   *
      *  BUG7819 - If a retail account has insufficient funds,        *
      *            the system simply drop a Cash Withdrawal           *
      *            (non-account currency) transaction                 *
      *            Recompiled due to changes in the dspf RE4119DF     *
      *  BUG8168 - Display terminal error messages                    *
      *  BUG7638 - Some Tellers' transactions go to another teller    *
      *            in another branch.                                 *
      *            Recompiled due to change in the /COPY RBLDTLC1,    *
      *            RBLDTLE1, and RBLDTLI1.                            *
      *  BUG6342 - Interest calculation has 0.01 discrepancy.         *
      *            Recompiled over changes in RTINDEF1/2 and RTINTRE. *
      *            Applied fix 220323.                                *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG4470 - BOI cashier error 26. Recompiled due to changes in *
      *            /COPY RBMODTC1.                                    *
      *  BUG4169 - If account does not exists in STOPCHECK file, ACNO *
      *            is corrupted.                                      *
      *  BUG3229 - Process Cheque Books only, not GIRO.               *
      *  BUG3845 - Reversed fix BUG3734. Causes update error in       *
      *            Cashier. Original symptoms not reproduced.         *
      *  Bug3855 - Incorrect field definitions by CRT002              *
      *  BUG2849 - CRE019 amendments for Cashier Interface (Recompile)*
      *  BUG3734 - Display the override message accordingly           *
      *  CLE025 - Credit Lines                                        *
      *  CAAA03 - Webfacing changes.                                  *
      *  CRE019 - Cheque Processing and Maintenance                   *
      *  CGL029 - Increase Account Code to 10 digits                  *
     F*  CRT012 - Midas/Cashier Interface - Multiple Charges         *
     F*  201732 - Pass correct parameters to AOPRFMR0 and also change *
     F*           in RBMODTC1.                                        *
      *  CRT007 - Cashier Branch Offline Checking                     *
     F*  CRT005 - Recompiled due to changes in RTTWIDC1               *
     F*  198870 - Terminal errors missed in cashier, pad available    *
     F*           balance and uncleared funds with leading zeros,     *
     F*           reverse available balance convention for display    *
     F*           in cashier.  Display correct available balance and  *
     F*           recompilation of RBMODTC1. Don't pass host ref back *
     F*           to cashier when forwarding has terminal error.      *
     F*           applies 166478,194391,198408,198448,195422,198444   *
      *  194978 - Recompiled due to changes in RBMODTC1, RTTWIDC1 and *
      *           RTODCKC1.                                           *
      *  CRT006 - Cashier Reserve Transactions.                       *
      *  190687 - Even after the Euro transition period, the Euro spot*
      *           rate should still be used to determine the exchange *
      *           rate between the two currencies.                    *
      *  CDE002 - Revenue Analysis - Recompiled due to changes in     *
      *           PF/REFXAJL0.                                        *
     F*  193529 - Array index error in RE4120                         *
     F*           /COPY RBCXRTC1 changed - recompile only             *
     F*  184205 - Recompiled due to changes in RTSTPCC1               *
     F*  190137 - Addition of further warning messages.               *
     F*  174972 - Recompiled due to changes in /COPY RTCHQRC1.        *
     F*  159251 - Value date check against chequebook collection date *
     F*           not working correctly. Also if collection date is   *
     F*           zero check value date is not before issued date     *
     F*           (change to /COPY RTCHQRC1). Also the backvalue,     *
     F*           non-working day & stopped cheque checks don't work  *
     F*           (errors found while testing).                       *
     F*  101578 - Recompiled due to change in RTCCYXC1                *
     F*  166612 - Recompile due to change in COPY source RBMODTC1     *
     F*  184553 - Further processing to ensure that travellers        *
     F*           cheques can be sold more than one at a time         *
     F*  180663 - Travellers chqs can only be sold on at a time in    *
     F*           in cashier.  Process a range of cheques copied in   *
     F*           RBSLTCF1 and RBSLTCC1.  All changes must be in the  *
     F*           same denom.  New file RETCRCL2.  Fix patterned      *
     F*           after 134981.                                       *
     F*  171139 - Preventative fix: Removed blanking operation on     *
     F*           SCTRTY in subroutine FMTCHG, so that field TTP3 in  *
     F*           PF/TTCHGPD will not have a blank value when PMODE   *
     F*           equal to 'P'.                                       *
     F*  144506 - Program does not give default trans. type, charge   *
     F*           percentage or amount which was already set up in    *
     F*           the system.                                         *
     F*  145752 - Recompile due to changes in COPY source RTBALCC1.   *
     F*  140770 - Recompile due to changes in copy source             *
     F*           ZSRSRC,RBSLTCCL1 .                                  *
     F*  179321 - Addition of extra warning messages, includes        *
     F*           fix number 166475.                                  *
     F*  176510 - Incorp. of fix 166073 to default the Profit centre  *
     F*           from the Profit Centre default matrix.              *
     F*  162643 - Database error in MEMOS when F10 taken for a/c      *
     F*           closure in RTS mode.                                *
     F*  142092 - Cannot get full description of errors appearing on  *
     F*           teller screen in Cashier.                           *
     F*  163583 - Terminal Errors are overwritten by Warning Errors   *
     F*  153001 - A/c failed to close because minimum charge posted   *
     F*           so balance was not zero. File RECRG no longer used  *
     F*           as actual charges shown, ie. no minimum or maximum. *
     F*           Includes changes to /COPYs RTCHRGC1, RTCLSCC1 &     *
     F*           RTCOMMC1.                                           *
      *  CSD005 - Standing Data Account Narrative.  Add new field     *
      *           to SDACODPD.  Recompilation of programs.            *
     F*  121425 - If base & local ccy are the same, @BSCY is not set  *
     F*           up so both transaction & a/c ccy are treated as     *
     F*           non-base. This forces the exchange rate to be input *
     F*           as a reciprocal for correct ccy conversion if the   *
     F*           transaction ccy is base.                            *
      *  CTI002 - Recompiled : File SDACODPD changed                  *
     F*  151260 - EMU processing does not check multiply/divide ind.  *
     F*           when currency conversion involves an 'out' ccy.     *
     F*           Also do not invert 'in' to Euro rate, make 'in' to  *
     F*           'in' cross rate more accurate and do not check rate *
     F*           is within 10% of spot for 'in'/Euro or 'in'/'in'.   *
     F*           Includes changes made to /COPY RTCOEUC1.            *
     F*           *** Should be applied with 150864 ***               *
     F*  150864 - Bureau de Change rates are expressed in the same    *
     F*           format (multiply/divide) as the spot rate, so       *
     F*           calculation of cross-rate must check M/D ind.       *
     F*           Includes new /COPY RTZXRTC1.                        *
     F*           *** Should be applied with 151260 ***               *
     F*  147915 - When transaction involves in ccys and Euro, rate    *
     F*           computed should always be via Euro rates, whether or*
     F*           not the base ccy is in and whether or not CRT104 is *
     F*           switched on.                                        *
      *  146200 - Euro ccy rates become zero                          *
      *  141862 - Computed Amounts are incorrect in some transactions:*
      *           - Recompiled over changed /COPY RTCOEUC1.           *
      *  140802 - /COPY RTCCYSC1 changes.  Change currency validation *
      *           to check for @RTCD instead of *IN80 (not used)      *
      *  140255 - Database error on input of transaction              *
      *           (Applied fix 105453)                                *
      *  CEU024 - EMU Retail Teller Support Enhancement               *
     F*  130543 - Changed the array index for teller processing from  *
     F*           @I (2,0) to @J (3,0).  /COPY RBLDTLC1 and RBLDTLE1  *
     F*           were likewise amended.                              *
     F*  106661 - Include Closing Account projected movements         *
     F*           in RSACMTPD to allow passbook printing.             *
     F*           Note that this may cause a problem if Closed        *
     F*           Accounts (RECI = C) are allowed to have passbooks   *
     F*           printed in that these entries may be printed twice. *
     F*           This is not the case at the moment.(Upgrade 073990).*
     F*  120885 - Check not only *ZEROS but also for *BLANKS as       *
     F*           Cashier R8.02B does not pad field with zeros.       *
     F*  120880 - Recompiled due to change in RBMODTC1.               *
     F*  118796 - Recompile due to change in /COPY REBCRTX1.          *
     F*  118131 - Blank out Round CCY and Pay/Receive Flags.          *
     F*  118133 - Execute SR/FMTCHG before SR/VSCHRG in SR/VALTRN.    *
     F*           Change MOVE to MOVEL for WCHAMT into SCAMT in       *
     F*           SR/FMTCHG.                                          *
     F*  118271 - Correct non-account CCY transaction balances and    *
     F*           generated entries posting amounts.                  *
     F*  114621 - Replace blank with 'X' to mean not to validate      *
     F*           condition.                                          *
     F*  098166 - Correct various errors in profit center.            *
     F*  CRT002 - Retail Branch Access.                               *
     F*  CCB002 - COB Performance Enhancements                        *
     F*           Access now via access object                        *
     F*           MEMOS is now accessed via GL/RE key rather than old *
     F*           relative record number.                             *
     F*  S01408 - Addition of hook RE4119CP22 - EEE002                *
     F*           Addition of hook RE4119CP21 - EEE002                *
     F*           Addition of hook RE4119CP20 - EEE002                *
     F*           Addition of hook RE4119CP19 - EEE002                *
     F*           Addition of hook RE4119CP18                         *
     F*  S01408 - Addition of hook RE4119FFP2.                        *
     F*           Addition of hook RE4119CP13.                        *
     F*           Addition of hook RE4119CP14.                        *
     F*           Addition of hook RE4119CP15.                        *
     F*           Addition of hook RE4119CP16.                        *
     F*           Addition of hook RE4119CP17.                        *
     F*  S01408 - Addition of hook RE4119OOP1.- EAU016                *
     F*  S01408 - Addition of hook RE4119CP10.- EAU016                *
     F*           Addition of hook RE4119CP11.- EAU016                *
     F*           Addition of hook RE4119CP12.- EAU016                *
     F*           Addition of hook RE4119EEP1.- EAU016                *
     F*           Addition of hook RE4119FFP1.- EEE002 EAU016         *
     F*  S01408 - Addition of hook RE4119CCP8.                        *
     F*           Addition of hook RE4119CCP9.                        *
     F*  093546 - Recompile due to changes in DSPF/RE4119DF -- text   *
     F*           amendment and alignment of fields.                  *
     F*  093545 - Recompile due to changes in PRTF/RE4119P1 --        *
     F*           standardize pagesize.                               *
     F*  092429 - Recompile due to changes in TTNARPD.                *
     F*  S01408 - Addition of hook RE4119IIP1.                        *
     F*           Addition of hook RE4119IIP2.                        *
     F*           Addition of hook RE4119CCP1.                        *
     F*           Addition of hook RE4119CCP2.                        *
     F*           Addition of hook RE4119CCP3.                        *
     F*           Addition of hook RE4119CCP4.- EEE002                *
     F*           Addition of hook RE4119CCP5.                        *
     F*           Addition of hook RE4119CCP6.                        *
     F*           Addition of hook RE4119CCP7.                        *
     F*  091241 - ATM Interface.  Recompiled.                         *
     F*  CRT001 - Retail Teller System                                *
     F*                                                               *
      *****************************************************************
      /EJECT
      *****************************************************************
      *
     FREBDCRPDIF  E           K        DISK         KINFSR *PSSR      UC
      ** Currency Details Extention No. 2
      *
     FREBDCCPDIF  E           K        DISK         KINFSR *PSSR      UC
      ** Exchange Rate Control Table
      *
     FRE4119P1O   E                    PRINTER                        UC
      ** Validation Prints
      *                                                                                       249968
     FHELDITL0IF  E           K        DISK                                                   249968
      ** Held Items                                                                           249968
      *
     FSTOPC   IF  E           K        DISK                           UC
      ** Stopped cheques
      *                                                                                       249968
     FSTOPCL3 IF  E           K        DISK                                                   249968
     F            STOPCSDF                          KRENAMESTOPCSL3                           249968
      ** Stopped cheques detail                                                               249968
      *                                                                                       249968
     FSTANDL4 IF  E           K        DISK                                                   249968
      ** Standing Orders                                                                      249968
      *                                                                                       249968
     FSTANDL5 IF  E           K        DISK                                                   249968
     F            STANDSBF                          KRENAMESTANDSBG                           249968
      ** Standing Orders                                                                      249968
      *                                                                                       249968
     FRESWEPL5IF  E           K        DISK                                                   249968
     F            RESWEPD0                          KRENAMERESWEP5F                           253689
     FRESWEPL7IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP7F                           253689
     FRESWEPL8IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP8F                           253689
     FRESWEPL6IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP6F                           253689
      ** SWEEP                                                                                249968
      *                                                                                       249968
      *
     F***CHQBKPD UF  E           K        DISK         KINFSR *PSSR      UC                   CRE019
     FCHQBKPD UF  E           K        DISK         KINFSR *PSSR A    UC                      CRE019
     F                                              KCOMIT
      ** Cheque book details
      *
     FCHQBKPT UF  E           K        DISK         KINFSR *PSSR                              CRE019
     F                                              KCOMIT                                    CRE019
      ** Cheque book trailer file                                                             CRE019
      *                                                                                       CRE019
     FRSACMTPDO   E                    DISK         KINFSR *PSSR
     F                                              KCOMIT
      ** Shadow posting file
      *
     FACCNT   UF  E           K        DISK         KINFSR *PSSR      UC
     F                                              KCOMIT
      ** Account master
      *
     F***TTRANPD*O   E                    DISK         KINFSR *PSSR       CRT002
     FTTRANPD O   E                    DISK         KINFSR *PSSR      UC  CRT002
     F                                              KCOMIT
      ** Teller Transactions Details
      *
     F***TTRANPT*UF  E                    DISK         KINFSR *PSSR       CRT002
     FTTRANPT UF  E                    DISK         KINFSR *PSSR      UC  CRT002
     F                                              KCOMIT
      ** Teller Transactions Trailer
      *
     F**RECRG***IF  E           K        DISK                         UC  153001
      ***Retail*charges*file                                              153001
      *
     FREIAC   IF  E           K        DISK                           UC
      ** Retail interest and charges
      *
     FREACR   IF  E           K        DISK                           UC
      ** Retail interest accrual ITD
      *
     FACNUM   IF  E           K        DISK
      ** Account Numbers Cross Reference File
     F            ACCNTABF                          KRENAMEACNUMABF
      *
     FTTRNT   UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
      ** Teller Controls/Totals
      *
     F****MEMOS***UF**E                    DISK         KINFSR *PSSR      CCB002
     F****************                              KCOMIT                CCB002
      ** Retail Shadow Balances
      *
     FREFXAJL0IF  E           K        DISK
     F** Fixed accounts file
     F*
     F***RE4119DFCF  E                    WORKSTN                         CRT002
     FRE4119DFCF  E                    WORKSTN                        UC  CRT002
      ** Display file - Cheque withdrawal - A/C CCY
      *
     FTTCHGPD O   E                    DISK         KINFSR *PSSR
      ** Teller Charge Details file
     F                                              KCOMIT
     F*                                                                   092429
     FTTNARPD O   E                    DISK         KINFSR *PSSR          092429
     F** Teller narratives file                                           092429
     F                                              KCOMIT                092429
     F/COPY WNCPYSRC,RE4119F001
     FSDSTAXPDIF  E                    DISK                           UC
      ** SD Tax File
      *
      *                                                                                       CDL013
     FACCNTBY0IF  E           K        DISK                           UC                      CDL013
     FSDSTAAL1IF  E           K        DISK                           UC                      CDL013
      *                                                                                       CDL013
     F*                                                                   S01408
     FSWACB   IF  E           K        DISK         KINFSR *PSSR                              263834
     F            SWACSSAF                          KIGNORE                                   263834
     F            SWACSSCF                          KIGNORE                                   263834
      *                                                                                       263834
     F/COPY WNCPYSRC,RE4119FFP1                                           S01408
     F*                                                                   S01408
      /COPY ZSRSRC,RTINDEF3
      *
      /COPY ZSRSRC,RTCOMMF1
      *                                                                   CRT002
      /COPY ZSRSRC,RBWLOGF1                                               CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBLDTLF1                                               CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBSLTCF1                                               CRT002
      **  Travellers Cheque Register Control and Detail                   CRT002
     F*                                                                   S01408
     F/COPY WNCPYSRC,RE4119FFP2                                           S01408
     F*                                                                   S01408
     FRETRG   IF  E           K        DISK                               144506
      ** Transaction charges file                                         144506
      *****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   KA  - Accept transaction with override                      *
     F*   KB  - Display account balances                              *
     F*   KC  - Exit program.                                         *
     F*   KE  - Refresh screen                                        *
     F*   KJ  - A/C closure enquiry                                   *
     F*   KL  - Previous                                              *
     F*                                                               *
     F*   10  - Message Subfile End Indicator (SFLEND)                *
     F*   12  - Transaction does not involve local ccy                *   CRT002
     F*                                                               *
     F*   14  - Print charge percentage                               *
     F*   15  - Charge entered                                        *
     F*   16  - Error in profit center                                *
     F*   17  - Error in charge amount                                *
     F*   18  - Error in charge transaction type                      *
     F*   19  - Error in charge percentage                            *
     F*                                                               *
     F*   20  - Display transaction terminated message                *
     F*   21  - Display "OVERRIDE REQUIRED" message                   *
     F*   22  - Display terminal or warning message codes             *
     F*   23  - Display override user id / password                   *                       CRT026
     F*   26  - Display override prompt                               *
     F*   27  - Display underline attributes                          *
     F*   28  - Display account balances                              *
     F*   29  - Display account closing balances                      *
     F*                                                               *
     F*   30  - Error in Retail A/C number                            *
     F*   31  - Error in Currency code                                *
     F*   32  - Error in Cheque amount                                *
     F*   33  - Error in Value date                                   *
     F*   34  - Error in Exchange rate                                *
     F*   35  - Error in Cheque number                                *
     F*   37  - Error in Department code                              *
     F*   38  - Error in Override teller identifier                   *
     F*   39  - Error in Override passcode                            *
     F*                                                               *
     F*   40  - Account closure selected                              *
     F*   41  - Account closure successful                            *
     F*   42  - Account closure unsuccessful                          *
     F*   44  - Error in Profit Centre                                *   098166
     F*   45  - Display "TRANSACTION COMPLETED" message               *
     F*   46  - Error in Cheque issuer no                             *   CRT002
     F*   47  - Error in Cheque serial no                             *   CRT002
     F*   49  - Error in Travellers chq amt                           *   CRT002
     F*   51  - '?' present in cheque issuer no field                 *   CRT002
     F*   53  - Error in cheque amount                                *   180663
     F*   54  - Error in cheque book status                           *   180663
     F*   55  - Func '0JW', Selling travellers cheque in non a/c ccy  *   CRT002
     F*                                                               *
     F*   50  - Error in Exchange Rate field                          *
     F*   59  - Cheque number numeric                                 *
      *   60  - LOKUP 'equal to' on commas in available bal           *   198870
     F*                                                               *
     F*   61  - Error in round currency flag                          *   CRT002
     F*   62  - Error in pay/receive flag                             *   CRT002
     F*   63  - Error in round amount                                 *   CRT002
     F*   64  - Error in pay/receive amount                           *   CRT002
      *   65  - NR indicator for SWACB                                *                       263834
     F*   67  - Update indicator                                      *
     F*   68  - Unsuccessful override                                 *
     F*   69  - Validation error                                      *
     F*                                                               *
     F*   70  - Record not found                                      *
     F*   72  - Narrative entered                                     *   092429
     F*                                                               *
     F*   76  - Display Withholding Tax                               *
     F*                                                               *
     F* 80-89 - Standard RTS subroutines                              *
     F*                                                               *
     F* 90-99 - Standard MIDAS subroutines                            *
     F*                                                               *
     F*    U6 - System error                                          *
     F* U7+U8 - Database error occurs                                 *
     F*                                                               *
      *****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  Control Subroutines                                          *
     F*                                                               *
     F*  ACLOSE - A/C closure enquiry                                 *
     F*  ACCDET - Accept details                                      *
     F*  CHKACC - Check account status                                *
     F*  DBERR  - Database error handling                             *
     F*  FIRST  - Initial Processing                                  *
     F*  LAST   - Final Processing                                    *
     F*  MAIN   - Main Processing                                     *
     F*  PCMTXT - Prepare Commitment Text                             *   CRT002
     F*  MOVDET - Move details to send to outgoing data queue         *   CRT002
     F*  RTVMSG - Retrieve message from message file                  *   CRT002
      *  SBTOFF - Set bit off                                         *                       CRE019
     F*  SNDMSG - Send program message parameters                     *
     F*  WRKACC - Work with account                                   *
     F*  WRKDET - Work with details                                   *
     F*  WRKOVR - Work with override                                  *
     F*  WRKTRN - Work with transaction                               *
     F*  WRKCYC - Currency conversion                                 *
     F*  *PSSR  - Program error                                       *
     F*                                                               *
     F*  Screen Handling                                              *
     F*                                                               *
     F*  DSPBAL - Display account balances                            *
     F*  DSPDET - Display transaction details                         *
     F*  DSPINL - Display initial screen                              *
     F*  DSPOVR - Display overrride screen                            *
     F*  EXTDET - Exit details  screen                                *
     F*  EXTOVR - Exit override screen                                *
     F*                                                               *
     F*  Screen Initialisation / Resets                               *
     F*                                                               *
     F*  RFRDET - Refresh details screen                              *
     F*  RFRERR - Refresh warning/terminal error screen               *
     F*  RFRINL - Refresh initial screen                              *
     F*  RFROVR - Refresh override screen                             *
     F*                                                               *
     F*  Validation Subroutines                                       *
     F*                                                               *
     F*  VACCLO - Validate account closure                            *
     F*  VALINL - Validate initial screen                             *
     F*  VALTRN - Validate transaction                                *
     F*  VALDET - Validate details                                    *
     F*  VALOVR - Validate override                                   *
     F*  VALAGN - Check again before update                           *
     F*  VOCOND - Validate override conditions                        *
     F*  VSACNO - Validate account number                             *
     F*  VSCCY  - Validate currency code                              *
     F*  VSCHRG - Validate charge fields                              *
     F*  VSCQNF - Validate check number                               *
     F*  VSEXRT - Validate exchange rate                              *
     F*  VSVLDT - Validate value date                                 *
     F*  VSCSAM - Validate cheque amount                              *
     F*  VSDEPC - Validate department code                            *
     F*  VTCOND - Validate teller transaction conditions              *
     F*  INSRAT - Insert default exchange rate                        *
      *  SREURO - Set-up Euro details for the currency                *   CEU024
     F*                                                               *
     F*  Updates Subroutines                                          *
     F*                                                               *
     F*  UACCNT - Update accounts                                     *
     F*  UCHQBK - Update cheque book                                  *
     F*  UMEMOS - Update memos                                        *
     F*  UPDATE - Update control                                      *
     F*  UPDTCC - Update travellers cheque control                    *   CRT002
     F*  UTNTM2 - Update teller controls                              *
     F*  UTNTM3 - Update teller totals                                *
     F*  UTRANT - Update teller transaction trailer                   *
      *  UPTRL  - Update Control Trailer Record                       *                       CRE019
     F*  WRSACM - Write shadow postings                               *
     F*  WRSAC2 - Write shadow postings for Closure capitalisation.   *   106661
     F*  WRTTCD - Write travellers cheque detail                      *   CRT002
     F*  WTRAND - Write teller transacton details                     *
     F*  WTTCHG - Write Teller charges detail                         *
     F*                                                               *
     F*  Printing Subroutines                                         *
     F*                                                               *
     F*  PRTTRN - Print transaction                                   *
     F*                                                               *
     F*  Standard RTS Subroutines                                     *
     F*                                                               *
     F*  CMPXRT - Compute exchange rate from two amounts.             *   CRT002
     F*  FMTCHG - Format charge amount.                               *   CRT002
     F*  RTABAL - Account available balance check                     *
     F*  RTACLG - Account closing check                               *
     F*  RTACLS - Account closure updates                             *
     F*  RTBALC - Calculate available balances                        *
     F*  RTBDPT - Bad Debt check                                      *
     F*  RTBKCR - Block credit check                                  *
     F*  RTBKDR - Block debit check                                   *
     F*  RTBKPT - Bankrupt/Liquidation check                          *
     F*  RTRFCR - Refer credit check                                  *
     F*  RTRFDR - Refer debit check                                   *
     F*  RTBRCH - Branch different check                              *
     F*  RTCCYS - Currency setup                                      *
     F*  RTCCYX - Convert an amount to another CCY using exchange     *
     F*           rates between both CCYs                             *
     F*  RTCHQR - Cheque out of range check                           *
     F*  RTCHQP - Cheque present check                                *
     F*  RTCOEU - Currency conversion based on Euro                   *   CEU024
     F*  RTCOMM - Calculate commissions for A/c closure               *
     F*  RTCONV - Currency conversion                                 *
     F*  RTXRAT - Exchange rate check                                 *
     F*  RTWDAY - Non-working days check                              *
     F*  RTBVIC - Back value/IC check                                 *
     F*  RTCHRG - Calculate charges                                   *
     F*  RTCLSC - Calculate close details                             *
     F*  RTCLSE - Close account condition check                       *
     F*  RTIACT - Inactive account check                              *
     F*  RTINTR - Calculate interest                                  *
     F*  RTLCNV - Local currency conversion                           *
     F*  RTODCK - Exceed OD check                                     *
     F*  RTSTPC - Stopped cheque check                                *
     F*  RTTCCY - Teller currency conditions check                    *
     F*  RTTLMT - Teller limit check                                  *
     F*  RTTOTS - Teller total updates                                *
     F*  RTTWID - Teller workstation conditions check                 *
     F*  RTENCP - Encript passcode                                    *
     F*  VALCQS - Validate cheque serial no                           *   CRT002
     F*                                                               *
     F*  Standard MIDAS Subroutines                                   *
     F*                                                               *
      *  PAD    - Pad field with leading zeros                        *   198870
     F*  CRINIT - Credit rates loading.                               *
     F*  DATEIN - Date init processing.                               *
     F*  DRINIT - Debit rates loading.                                *
     F*  INTCAL - Interest calculation between two dates              *
     F*  ZACCH  - Determine if AOHOLS0 needs to be called             *
     F*  ZALIGN - Validate amount fields                              *
     F*  ZCHKH  - Determine if a Midas day no. is a holiday or working*
     F*           day for a given currency and location (optional)    *
     F*  ZDATE1 - Validate dates submitted and convert to a           *
     F*           number of days                                      *
     F*  ZDATE2 - Convert date to dayno. to date formats              *
     F*  ZEDIT  - To insert a decimal point into a numeric field      *
     F*  ZFRPED - Format and edit amount field                        *
     F*  ZICD   - Find number of days to calculate interest according *
     F*           to calculation basis                                *
     F*  ZIC00  - Calculate interest type 00                          *
     F*  ZIC01  - Calculate interest type 01                          *
     F*  ZIC02  - Calculate interest type 02                          *
      *  ZSEFMT - Format rate for output                              *   144506
     F*  ZTNLU1 - Access dataarea for next transaction no.            *
     F*                                                               *
     F*  External Subroutines                                         *
     F*                                                               *
     F*  SCC0250 - Clear message queue                                *
     F*  SCC0240 - Send program message queue                         *
     F*                                                               *
     F*****************************************************************
      /EJECT
      *****************************************************************
     E*                                                                   S01408
     E/COPY WNCPYSRC,RE4119EEP1                                           S01408
     E*                                                                   S01408
     E                    CPY@    1   1 80
      *                                                                   CEU024
     E                    TEU        50  1                                CEU024
      ** To determine if ccy is euro, 'in' or 'out'                       CEU024
      *                                                                   CEU024
     E                    EUI        50  1                                CEU024
      ** To get Euro Multiply/Divide Indicator of ccys                    CEU024
      *                                                                   CEU024
     E                    EUR        50 13 8                              CEU024
      ** To get Euro Exchange Rate of ccys                                CEU024
      *                                                                   CEU024
     E                    STP        50  5 0                              CEU024
      *                                                                   CEU024
     E                    ETP        50  5 0                              CEU024
      *                                                                   CRT002
      *
      /COPY ZSRSRC,ZDATE2Z1
      ** Array for SR.ZDATE1, SR.ZDATE2
      *
      /COPY ZSRSRC,RTXXXXE1
      ** Array for SR.RTBKDR, SR.RTBKCR, SR.RTRFDR, SR.RTRFCR, SR.RTIACT
      *
      /COPY ZSRSRC,ZALIGNZ1
      ** Array for both SR.ZALIGN, SR.ZEDIT
      *
      /COPY ZSRSRC,ZHOLE
      ** Array for SR.ZACCH
      *
      /COPY ZSRSRC,ZFRPEDZ1
      ** Array for SR.ZFRPED
      *
     E                    @CY        24  3
      ** Teller currencies array
      *
     E                    @CA        20  1
      ** Cheque presented status array
      *
      /COPY ZSRSRC,RTINDEF1
      *
      /COPY ZSRSRC,RTCOMME1
      *
      /COPY ZSRSRC,RTCCYSE1
      ** Array for SR.RTCCYS
      *
      /COPY ZSRSRC,RTENCPE1
      ** Array for SR.RTENCP
      *
     E                    POWER   1   7  7 3             POWER ARRAY
      *                                                                   CRT002
     E                    @TXT    1   4 80               Text strings     CRT002
      *                                                                   CRT002
     E                    INP         6  1                                CRT002
      **  Array for chq issuer no                                         CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RTCHQPE1
      ** Array for SR.RTCHQP
      *
      /COPY ZSRSRC,RBMODTE1                                               CRT002
      **  Array for SR.MOVDET                                             CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBLDTLE1                                               CRT002
      **  Array for SR.LODTLR                                             CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,ZDATE9Z1                                               CRT002
      ** Array for ZDATE9                                                 CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBCXRTE1                                               CRT002
      **  Array for SR.CMPXRT                                             CRT002
      *                                                                   CRT002
     E                    OUT        14  1               ZSEFMT SR. ARRAY 144506
     E                    OUT2       14  1               ZSEFMT SR. ARRAY 144506
     E                    RAT        13  1 0             ZSEFMT SR. ARRAY 144506
      *                                                                   144506
      ** Array for padding with zeros                                     198870
     E                    RTE        16  1  A            Padding          198870
      *****************************************************************
      /EJECT
      *****************************************************************
      *
     ISTOPCSCF
      ** Renamed fields in PF/STOPCSC
     I              FLSZ                            SCFLSZ
     ISTOPCSDF                                                                              BUG4169
      ** Renamed fields in PF/STOPCSD                                                       BUG4169
     I              ACNO                            STACNO                                  BUG4169
      *
      /COPY ZSRSRC,RTINDEF4
      *
     ITTRANPTF
      ** Renamed fields in PF/TTRANPT
     I              NORE                            TTNORE
      *
     ITTRNTM2F
      ** Renamed fields in PF/TTRNTM2
     I              RECI                            T2RECI
     I              NATN                            T2NATN
     I              RUND                            T2RUND
      *
      ** Rename fields to prevent overwrite                                                   263834
      *                                                                                       263834
     ISWACSSBF                                                                                263834
     I              RECI                            RECISW                                    263834
     I              CNUMA                           CNUMSW                                    263834
     I              CCY                             CCYSW                                     263834
     I              ACODQQ                          ACDQSW                                    263834
     I              ACSQ                            ACSQSW                                    263834
     I              CFSB                            CFSBSW                                    263834
     I              LSTD                            LSTDSW                                    263834
     I              NSTD                            NSTDSW                                    263834
     I              ACNO                            ACNOSW                                    263834
     I              STFQ                            STFQSW                                    263834
     I              STDY                            STDYSW                                    263834
     I              LSNO                            LSNOSW                                    263834
     I              UPRI                            UPRISW                                    263834
     I              DDIS                            DDISSW                                    263834
     I              BRCA                            BRCASW                                    263834
     I              IND                             INDSW                                     263834
     I              ZZ006                           ZZ06SW                                    263834
     I              LCD                             LCDSW                                     263834
     I              CHTP                            CHTPSW                                    263834
     I              TNLU                            TNLUSW                                    263834
     I              MT94                            MT94SW                                    263834
     I              ACOD                            ACODSW                                    263834
      *                                                                                       263834
     IACNUMABF
      ** Renamed fields in LF/ACNUM
     I              CCY                             ACCY
      *                                                                                       CLE025
     IACCNTABF                                                                                CLE025
      ** Renamed fields in LF/ACCNT                                                           CLE025
     I              PFCU                            APFCU                                     CLE025
     ISTANDSBF                                                                                249968
      ** Renamed fields in LF/STANDL4                                                         249968
     I              TRAT                            BRAT                                      249968
      *
     ISTANDSBG                                                                                249968
      ** Renamed fields in LF/STANDL5                                                         249968
     I              TRAT                            CRAT                                      249968
     ICHQBKPDF
      ** Renamed fields in PF/CHQBKPD
     I              ACNO                            CQACNO
     I              BRCA                            CQBRCA                                    CRE019
     I              CHAC                            CQCHAC                                    CRE019
     I              CHAM                            CQCHAM                                    CRE019
      *                                                                                       CRE019
     ICHQBKPTF                                                                                CRE019
      ** Renamed fields in PF/CHQBKPT                                                         CRE019
     I              NORE                            NORET                                     CRE019
     I              ACNO                            ACNOT                                     241729
      *                                                                                       CRE019
     I/COPY WNCPYSRC,RE4119I001
      *
      *
      /COPY ZSRSRC,RTXXXXI1
      ** Data structure to positions of validation indicators
      *
      /COPY ZSRSRC,RTXXXXI2
      ** Data structure for 15 character account number
      *
      /COPY ZSRSRC,RTINDEF5
      *
      /COPY ZSRSRC,RTCOMMI1
      *
     I            DS
      ** 12 Character key
     I                                        1  12 @KEY
     I                                        2   30@CHGT
     I                                        4   80@CHST
     I                                        9  11 @CHCY
     I                                       12  12 @DDDD
     I*                                                                   092429
     I@@NARR      DS                             30                       092429
      ** Data structure to setup narrative for file                       092429
     I                                        1   50@@TBTN                092429
     I                                        6   6 @@SLSH                092429
     I                                        7   9 @@TBID                092429
     I                                       10  10 @@UNDS                092429
     I                                       11  30 SNARR                 092429
      *
     I@VDS        DS
      ** Data structure to initialise validation indicators
     I                                        1  25 VWIN
     I                                        1  25 @V
      *
     I            DS                             72
      ** Data structure to initialise arrays
      *
     I                                        1  72 CCYR1
     I                                        1  72 @CY
      *                                                                   CCB002
     IUMEMER      DS                                                      CCB002
      ** Data structure for database error on call to AOMEMSR0.           CCB002
     I**********                              1   60U0CNUM                             CCB002 CSD027
     I                                        1   6 U0CNUM                                    CSD027
     I                                        7   9 U0CUCD                CCB002
     I**********                             10  130U0ACCD                             CCB002 CGL029
     I**********                             14  150U0ACSQ                             CCB002 CGL029
     I**********                             16  18 U0BRCA                             CCB002 CGL029
     I                                       10  190U0ACCD                                    CGL029
     I                                       20  210U0ACSQ                                    CGL029
     I                                       22  24 U0BRCA                                    CGL029
      *
      /COPY ZSRSRC,RTTOTSI1
      ** Data structures definitions for SR.RTTOTS
      *
      /COPY ZSRSRC,RTCHQPI1
      ** Data structures definitions for SR.RTCHQP
      *
     I            DS
      ** Data structure to hold key fields of LF/TTRNT
     I                                        1   5 @TTRNT
     I                                        1   1 KTBRI
     I                                        2   4 KTBID
     I                                        5   5 KRCTP
      *                                                                   144506
     I            DS                                                      144506
      ** Data structure to hold key fields of LF/RETRG                    144506
     I                                        1  12 TRGKEY                144506
     I                                        4   8 TRTYP                 144506
     I                                        9  11 TRCURR                144506
     I                                       12  12 DSRECT                144506
      *
     IENUM        DS                             19
      ** Data structure for splitting the edited numeric which
      ** has a value with 2 spaces to the right (CR,-)
      *
     I                                        1  17 @EN
     I                                       18  19 @FL
     IRTSDTA     UDS                            256
      ** RTS job data area data structure
     I                                        1   3 PTLID
     I                                        4   6 PTLBC
     I                                        7   7 PSPVI
     I                                        8  32 POVIN
     I                                    P  33  390PCHTL
     I                                    P  40  460PNCTL
     I                                       90  92 PDEPC
      *
     I@PERDS      DS                             16
      ** Data structure to hold Charge percentage
     I                                       10  14 @SCPER
      *
      *
     ILDA         DS                            256
      **  Local data area for data base errors.
     I                                        1   3 ERTLID
     I                                       11  20 ERTWID
     I                                       21  30 ERWSID
      **  Field combining the following fields
     I                                      134 183 DBLOT
      **  Name of database file in error
     I                                      134 141 DBFILE
      **  Key value causing database error
     I                                      142 170 DBKEY
      **  Name of program causing database error
     I                                      171 180 DBPGM
      **  Number of database error
     I                                      181 1830DBASE
     I*
     IZMUSER      DS                             17
     I** Data area of menu user
     I                                        1  10 USRPRF
      *                                                                   CRT002
     I            DS                                                      CRT002
      **  Data structure to hold string constants for QCMDEXC             CRT002
      *                                                                   CRT002
     I                                        1  80 @CMD                  CRT002
     I                                       30  30 @BRI                  CRT002
     I                                       31  33 @BID                  CRT002
      *                                                                   CRT002
     I            DS                                                      CRT002
      **  Data structure to hold string constants for QCMDEXC             CRT002
      *                                                                   CRT002
     I                                        1  80 @CMDT                 CRT002
     I                                       30  30 @BRIT                 CRT002
     I                                       31  33 @BIDT                 CRT002
      *                                                                   CRT002
     I            DS                                                      CRT002
      *                                                                   CRT002
      ** Traveller's Cheques Processing                                   CRT002
     I**    Narrative Line 2 positions 1 - 6 :  issuer number             CRT002
     I**                               7 - 26:  buyer's name              CRT002
     I**                              27 - 28:  buyer's ID type           CRT002
      *                                                                   CRT002
     I                                        1  35 @RANR2                CRT002
     I                                        1   6 @SCIN                 CRT002
      *                                                                   CRT002
     I            DS                                                      CRT002
      *                                                                   CRT002
      ** Traveller's Cheques Processing                                   CRT002
     I**    Narrative Line 3 positions 1 - 12:  serial number             CRT002
     I**                              13 - 32:  buyer's ID number         CRT002
      *                                                                   CRT002
     I                                        1  35 @RANR3                CRT002
     I                                        1  12 @SCSN                 CRT002
      *                                                                   CRT002
     I            DS                              6                       CRT002
      **  Data structure to redefine chq issuer no field                  CRT002
      *                                                                   CRT002
     I                                        1   6 SCIN                  CRT002
     I                                        1   6 INP                   CRT002
      *                                                                   CRT002
     IPSDS       SDS
      ** Program Status Data Structure
      *
      ** Field containing program ID
     I                                        1  10 @PGM
      *
      ** Field containing workstation ID
     I                                      244 253 @JOB
      *
      ** Field containing user ID
     I                                      254 263 @USER
      *
     I**  Data structure to for holding key list of cheque book file                          CRE019
     I@CHQBK      DS                             18                                           CRE019
     I                                        1  100KACNO                                     CRE019
     I                                       11  180KSCQN                                     CRE019
      *                                                                                       CRE019
     ICMTTXT      DS                             88
      ** Commitment Control Commit Text
     I                                        1   50NATN
     I                                        6   7 MDID
     I                                        8  15 PGMN
     I                                       16  18 WSIDX
     I                                       19  240MTIME
     I                                       25  25 ACTCDX
     I                                       26  35 USRIDX
      ** Data structure for initial screen
     I                                       51  63 SINLDS
     I                                       51  60 SACNO
     I                                       61  63 SCCY
      *
      * Data structure for AOSVALR0 string                                CRT012
     I            DS                                                      CRT012
     I                                        1 200 SVAL1                 CRT012
     I                                        1   1 SVAL11                CRT012
      *                                                                   CRT012
      * System Value                                                      CRT012
     I            DS                                                      CRT012
     I I            'CashierMultCharge'       1  20 SVALK1                CRT012
      *                                                                   CRT012
     I/COPY WNCPYSRC,REH00188
      /COPY ZSRSRC,ZTNLU1Z1
      ** Array for SR.ZTNLU1
      *
      /COPY ZSRSRC,ZFRPEDZ2
      ** Data structure for SR.ZFRPED
      *                                                                   CRT002
     ITTIME       DS                             12                       CRT002
      *                                                                   CRT002
     I                                        1   2 WTHR                  CRT002
     I                                        3   4 WTMN                  CRT002
     I                                        5   6 WTSS                  CRT002
     I                                        1   60WTIME                 CRT002
      *                                                                   CRT002
     I                                        7   8 WDT1                  CRT002
     I                                        9  10 WDT2                  CRT002
     I                                       11  12 WDT3                  CRT002
     I                                        7  120WDATE                 CRT002
      *                                                                   CRT002
     I                                        1  120WTMDS                 CRT002
      *                                                                   CRT002
     I            DS                                                      CRT002
     I                                        1   7 WUMSID                CRT002
     I                                        1   7 @MSGID                CRT002
      *                                                                   CRT002
     I            DS                                                      CRT002
     I                                        1  10 WUMSGF                CRT002
     I                                        1  10 @MSGF                 CRT002
      *
     I/COPY ZSRSRC,ZHOLI
      *
     I*                                                                   S01408
     I/COPY WNCPYSRC,RE4119IIP1                                           S01408
     I*                                                                   S01408
     ICITFTS    E DSCITFTS                        2                       CRT002
      ** Data area for Trickle Feed Time Stamp                            CRT002
      *                                                                   CRT002
     I                                        1   2 WNNSS                 CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBOITMI1                                               CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBWLOGI1                                               CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBMODTI1                                               CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBLDTLI1                                               CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBSLTCI1                                               CRT002
      **  Data structure for trav chq amt's decimal and integer values    CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,ZDATE9Z2                                               CRT002
      ** Data structure for ZDATE9                                        CRT002
      *                                                                   CRT002
     I            DS                                                      144506
      **   DATA STRUCTURE RATE AMOUNT                                     144506
      *                                                                   144506
     I                                        1  130RAT                   144506
     I                                        1  138ZRT13                 144506
      *                                                                   144506
     II#PARM      DS                           1024                                           CCG016
      ** Passed fields                                                                        CCG016
      **  Classification                                                                      CCG016
     I                                        1   3 I#BRCT                                    CCG016
     I                                        4   6 I#TLID                                    CCG016
     I                                        7   9 I#TBID                                    CCG016
     I                                       10  14 I#TBTN                                    CCG016
     I                                       15  17 I#FUNC                                    CCG016
     I                                       18  18 I#CLOS                                    CCG016
     I**********                             19  28 I#CHQN                           CCG016 MD042745
     I                                       19  30 I#CHQN                                  MD042745
      **  Accounts single, dr and cr                                                          CCG016
     I                                       41  46 I#CNUM                                    CCG016
     I                                       47  49 I#CCY                                     CCG016
     I                                       50  59 I#ACOD                                    CCG016
     I                                       60  61 I#ACSQ                                    CCG016
     I                                       62  64 I#BRCA                                    CCG016
     I                                       41  64 I#GLAR                                    CCG016
     I                                       65  74 I#ACNO                                    CCG016
     I                                       77  82 I#CNU1                                    CCG016
     I                                       83  85 I#CCY1                                    CCG016
     I                                       86  89 I#ACO1                                    CCG016
     I                                       90  91 I#ACS1                                    CCG016
     I                                       92  94 I#BRC1                                    CCG016
     I                                       77  94 I#GLA1                                    CCG016
     I                                       95 104 I#ACN1                                    CCG016
     I                                      107 112 I#CNU2                                    CCG016
     I                                      113 115 I#CCY2                                    CCG016
     I                                      116 119 I#ACO2                                    CCG016
     I                                      120 121 I#ACS2                                    CCG016
     I                                      122 124 I#BRC2                                    CCG016
     I                                      107 124 I#GLA2                                    CCG016
     I                                      125 134 I#ACN2                                    CCG016
      **  Transaction dets                                                                    CCG016
     I                                    P 137 1440I#AMNT                                    CCG016
     I                                      145 147 I#CCYT                                    CCG016
     I                                      148 198 I#NARR                                    CCG016
     I                                    P 199 2060I#CHQA                                    CCG016
     I                                    P 207 2138I#EXRT                                    CCG016
     I                                    P 217 2240I#BUYA                                    CCG016
     I                                      225 227 I#BUYC                                    CCG016
     I                                    P 228 2350I#SELA                                    CCG016
     I                                      236 238 I#SELC                                    CCG016
     I                                      239 288 I#NAR1                                    CCG016
     I                                      289 338 I#NAR2                                    CCG016
     I                                    P 347 3540I#INTA                                    CCG016
     I                                      355 357 I#INTC                                    CCG016
     I                                      358 407 I#INTN                                    CCG016
     I                                    P 417 4240I#TAXA                                    CCG016
     I                                      425 427 I#TAXC                                    CCG016
     I                                      428 477 I#TAXN                                    CCG016
     I                                    P 487 4940I#CHGA                                    CCG016
     I                                      495 497 I#CHGC                                    CCG016
     I                                      498 557 I#CHGN                                    CCG016
     I                                    P 567 5740I#TOTA                                    CCG016
     I                                      575 577 I#TOTC                                    CCG016
     I                                      578 627 I#TOTN                                    CCG016
     IO#PARM      DS                            256                                           CCG016
     I                                        1  10 O#ITEM                                    CCG016
     I                                       11  20 O#CUST                                    CCG016
     I                                       21  25 O#RSEQ                                    CCG016
     I                                       26  26 O#RLVL                                    CCG016
     I                                       27  29 O#RBCH                                    CCG016
     I                                       30  30 O#RARC                                    CCG016
      *                                                                                       CCG016
     ISDBANK    E DSSDBANKPD
     I** Bank Details
     I*
     ISDBRCH    E DSSDBRCHPD                                              CRT002
      **  Branch Details                                                  CRT002
      *                                                                   CRT002
     ISDCUST    E DSSDCUSTPD
     I** Customer Details
     I              QQDFAC                          QQDFC1                                    CGL029
     I*
     ISDRETR    E DSSDRETRPD
     I** Retail Transaction Types Details
     I*
     ISDGELR    E DSSDGELRPD
     I** General Ledger ICD Details
     I              BKPRCU                          PFCU
     I              BKPCDU                          PFCD
     ISDDEPT    E DSSDDEPTPD
     I** Department Codes Details
     I*
     ISDCURR    E DSSDCURRPD
     I** Currency file Details
     I*
     ISCSARD    E DSSCSARDPD
      *
     ISDACOD    E DSSDACODPD
     I** External data structure for Account Code Details
     I              QQACCD                          QQACD1                                    CGL029
     I*
     ISDPRFC    E DSSDPRFCPD
     I** Profit Centre Details
      *
     ISDPRFM    E DSSDPRFMPD
     I** Profit Centre Default Matrix Retrieval Index
     I*
     ISDTELD    E DSSDTELDPD
     I** Teller ID Details
     I*
     ISDFNCD    E DSSDFNCDPD
     I** Function Code  Details
     I*
     ISDTCHG    E DSSDTCHGPD
     I** RTS Default Charges Transaction Type
     I*
     IDSMEMS    E DSMEMOS                                                 CCB002
     I** External data structure for MEMOS Details                        CCB002
     I** Renamed fields in PF/MEMOS                                       CCB002
     I              CNUM                            MECNUM                CCB002
     I              CCY                             MECCY                 CCB002
     I              ACOD                            MEACOD                CCB002
     I              ACSQ                            MEACSQ                CCB002
     I*
     IDSFDY     E DSDSFDY
     I*
     I** First DS for access programs, Short data structure
     I*
     IDSSDY     E DSDSSDY
     I*
     I** Second DS for access programs, Long data structure
     I*
     I*                                                                   S01408
     I/COPY WNCPYSRC,RE4119IIP2                                           S01408
     I*                                                                   S01408
     IMUSER     E DSMUSERDD                                                                   CRT026
     I** External data structure for User Details                                             CRT026
     I** Renamed fields in PF/MUSERDD                                                         CRT026
     I              RECI                            RECIU                                     CRT026
     I              LCD                             LCDU                                      CRT026
      *                                                                                       CRT026
     IZONEDP      DS                                                                          CRE081
     I                                        1  100PRTAC                                     CRE081
     I                                       11  200PACOD                                     CRE081
     I                                       21  220PASEQ                                     CRE081
     I                                       23  270PVLDAT                                    CRE081
     I                                       28  420PAMT                                      CRE081
     I                                       43  570PACBAL                                    CRE081
     I                                       58  720PAVBAL                                    CRE081
     I                                       73  770PFLDAT                                    CRE081
     I                                       78  920PFLBAL                                    CRE081
      *                                                                                       CRE081
      ** Named constants                                                                      CDL081
      *                                                                                       CDL081
     I              'BasCcyTaxRoundDown'  C         C#BASE                                    CDL081
     I              'NBasCcyTaxRoundDown' C         C#NBAS                                    CDL081
     I              'RIBALENQY'           C         RIBALQ                                AR1087355C
      *                                                                                   AR1087355C
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            MAIN   - Main Control Processing                   *
      *                                                               *
      * CALLS      ACLOSE - A/C closure enquiry                       *
      *            DSPINL - Display initial screen                    *
      *            FIRST  - Initial Processing                        *
      *            LAST   - Final Processing                          *
      *            RFRINL - Refresh initial screen                    *
      *            WRKACC - Work with account                         *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
      *
     C                     MOVEACPY@      BIS@   80
      *                                                                                       250891
      ** Initialise Skip Update Flag to 'N'                                                   250891
     C                     MOVEL'N'       @SKIP   1                                           250891
      *                                                                                       250891
     C*
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*VERIFY' @OPTN   7
     C                     PARM 'CRT104'  @SARD   6
     C           SCSARD    PARM SCSARD    DSFDY
     C*
     C           @RTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CRT104  1
     C                     ELSE
     C                     MOVE 'N'       CRT104
     C                     END
      *                                                                   CEU024
      ** Check if CEU024 is on                                            CEU024
      *                                                                   CEU024
     C                     MOVE 'N'       CEU024  1                       CEU024
     C                     CALL 'AOSARDR0'                                CEU024
     C                     PARM *BLANKS   PRTCD   7                       CEU024
     C                     PARM '*VERIFY' POPTN   7                       CEU024
     C                     PARM 'CEU024'  PSARD   6                       CEU024
     C           SCSARD    PARM SCSARD    DSFDY                           CEU024
      *                                                                   CEU024
     C           PRTCD     IFEQ *BLANKS                                   CEU024
     C                     MOVE 'Y'       CEU024                          CEU024
     C                     MOVE CRT104    @C104   1                       CEU024
     C                     ELSE                                           CEU024
      *                                                                   CEU024
      ** Handle Database Error                                            CEU024
      *                                                                   CEU024
     C           PRTCD     IFNE '*NRF    '                                CEU024
     C           *LOCK     IN   LDA                                       CEU024
     C                     MOVEL'SCSARDPD'DBFILE           ************** CEU024
     C                     MOVEL'CEU024'  DBKEY            * DBERROR 09 * CEU024
     C                     Z-ADD9         DBASE            ************** CEU024
     C                     OUT  LDA                                       CEU024
     C                     EXSR *PSSR                                     CEU024
     C                     ENDIF                                          CEU024
      *
     C                     ENDIF
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP18                                           S01408
     C*                                                                   S01408
      *
      /COPY ZSRSRC,RTINDEF2
      *
      *
      ** Initial Processing
     C                     EXSR FIRST
      *
      ** Main Processing
      *
      ** Refresh initial screen
     C                     EXSR RFRINL
      *
      ** Display initial screen
     C                     EXSR DSPINL
      *
      ** Do while Cmd/3 is not pressed
     C           *INKC     DOWEQ'0'
      *                                                                   106661
      ** Save the Closure intention for the Close Balance check.          106661
     C           *INKJ     IFEQ '1'                                       106661
     C                     MOVE 'Y'       CLREQ   1                       106661
     C                     ELSE                                           106661
     C                     MOVE 'N'       CLREQ                           106661
     C                     END                                            106661
      *
      ** If Cmd/5 is pressed, refresh initial screen
     C           *INKE     CASEQ'1'       RFRINL
      *
      ** If Cmd/10 is pressed, perform account closure enquiry
     C           *INKJ     CASEQ'1'       ACLOSE
      *
      ** If Enter key is pressed, work with account
     C                     CAS            WRKACC
      *
     C                     END
      *
      ** Redisplay initial screen
     C                     EXSR DSPINL
      *
     C                     END
      *
      ** When Cmd/3 is pressed, perform last processing
     C                     EXSR LAST
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPINL - Display Initial Screen                    *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *            RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPINL    BEGSR                           ** DSPINL **
      *                                                                   CRT002
     C                     MOVEL*BLANKS   WRDAM  15                       CRT002
     C                     MOVEL*BLANKS   WRDCY   1                       CRT002
     C                     MOVEL*BLANKS   WPRAM  15                       CRT002
     C                     MOVEL*BLANKS   WPYRC   1                       CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
      *
      ** Display program message subfile for any messages
     C                     WRITERE4119C0
      *
      ***Display*warning/terminal*error(s)*screen**********************                       239004
     C**********           WRITERE4119F1                                                      239004
      *
      ** Display and accept initial screen
     C/COPY WNCPYSRC,RE4119C018
     C                     EXFMTRE4119F0
      *                                                                   CRT002
     C/COPY WNCPYSRC,RE4119C003
     C           PMODE     WHEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   REPOII                          CRT002
     C                     EXSR RDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
      *                                                                   CRT002
     C                     MOVELP@QDR     REPOII                          CRT002
      *                                                                   CRT002
     C           RAMSTY    IFNE '*END'                                    CRT002
      *                                                                   CRT002
      **  Retrieve Forward Status inidicator                              CRT002
      *                                                                   CRT002
     C                     MOVELRAFWST    WFWST   1                       CRT002
      *                                                                   CRT002
     C                     MOVELRAUSID    SOVTI                           CRT002
     C                     MOVELRAMRDA    WRDAM                           CRT002
     C                     MOVELRAMTCY    WRDCY                           CRT002
     C                     MOVELRAMLCA    WPRAM                           CRT002
     C                     MOVELRAPYRC    WPYRC   1                       CRT002
     C                     MOVELRAVLD1    SVLDT                           CRT002
     C                     MOVELRANRL1    NARRI                           CRT002
     C                     MOVEL'0'       *IN12                           CRT002
     C           RACCY1    IFNE BJLCCY                                    CRT002
     C           RACCY2    ANDNEBJLCCY                                    CRT002
     C                     MOVEL'1'       *IN12                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JL'                                     CRT002
     C                     MOVELWMAC1     SACNO1                          CRT002
     C                     MOVELRACCY1    SCCY2                           CRT002
     C                     MOVELRACCY1    SCCY3                                               CAAA03
     C                     MOVELRACCY2    SCCY                            CRT002
     C           *IN12     IFEQ '1'                                       CRT002
     C                     MOVE RATRA2    SCSAM                           CRT002
     C                     ELSE                                           CRT002
     C                     MOVE RAMNA2    SCSAM                           CRT002
     C                     ENDIF                                          CRT002
     C                     MOVELRARFLN    SCQNF                           CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JW'                                     CRT002
     C                     MOVELWMAC2     SACNO1                          CRT002
     C                     MOVELRACCY1    SCCY                            CRT002
     C                     MOVELRACCY2    SCCY2                           CRT002
     C                     MOVELRACCY2    SCCY3                                               CAAA03
     C                     MOVE RATRA1    SCSAM                           CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   @RANR2                          CRT002
     C                     MOVELRANRL2    @RANR2                          CRT002
     C                     MOVEL@SCIN     SCIN                            CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   @RANR3                          CRT002
     C                     MOVELRANRL3    @RANR3                          CRT002
     C                     MOVEL@SCSN     SCSN                            CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
      **  Reset Function Keys                                             CRT002
      *                                                                   CRT002
     C                     MOVE '0'       *INKA                           CRT002
     C                     MOVE '0'       *INKB                           CRT002
     C                     MOVE '0'       *INKC                           CRT002
     C                     MOVE '0'       *INKE                           CRT002
     C                     MOVE '0'       *INKJ                           CRT002
     C                     MOVE '0'       *INKL                           CRT002
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
     C                     CLEARWCMSG                                     CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVELP@QDR     WCMSG                           CRT002
     C                     MOVE 'DR'      WSTAT                           CRT002
     C                     MOVE 'N'       WSUCM                           CRT002
     C                     TIME           WTMDS  120                      CRT002
     C           WTHR      CAT  ':'       WA      3                       CRT002
     C           WTMN      CAT  ':'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WTSS      WSTTM                           CRT002
     C                     MOVE WSTTM     WRCTM   8                       CRT002
     C           WDT1      CAT  '/'       WA      3                       CRT002
     C           WDT2      CAT  '/'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WDT3      WRCDT   8                       CRT002
     C                     EXSR WRLOG                                     CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
     C                     MOVE '1'       *INKC                           CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
      ** Clear warning/terminal error screen
     C                     EXSR RFRERR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  DSPINL - Display initial screen                    *
      *            RFRINL - Refresh initial screen                    *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRERR    BEGSR                           ** RFRERR **
      *
     C                     SETOF                     202122
     C                     SETOF                     29
     C                     MOVE *BLANKS   SACNO2
     C                     MOVE *BLANKS   SANAM
     C                     MOVE *BLANKS   SCCY2
     C                     MOVE *BLANKS   SCCY3                                               CAAA03
     C                     MOVEA*BLANKS   @W
     C                     MOVEA*BLANKS   @T
     C                     MOVEL*BLANKS   SMSG1
     C                     MOVEL*BLANKS   SMSG2
     C                     MOVEL*BLANKS   @MSG1
     C                     MOVEL*BLANKS   @MSG2
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKACC - Work with account                         *
      *                                                               *
      * CALLS      VALINL - Validate initial screen                   *
      *            RTTWID - Teller workstation conditions check       *
      *            DBERR  - Database error handling                   *
      *            CHKACC - Check account status                      *
      *            WRKDET - Work with details                         *
      *            RFRINL - Refresh initial screen                    *
      *            PAD    - Pad field with leading zeros              *   198870
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *            ACLOSE - A/C closure enquiry                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKACC    BEGSR                           ** WRKACC **
      *                                                                   CRT002
      ****Initialise*suspense*account*indicator                    CRT002 162643
     C**********           MOVEL'N'       WSUS    1                CRT002 162643
      *
     C                     SETOF                     4569
      *
      ** If account closure not requested, validate initial screen
     C           *IN40     IFEQ '0'
     C                     EXSR VALINL
     C                     END
      *
      ** If no validation error(s) exist
     C           *IN69     IFEQ '0'
      *
      ** Check for multiple sign on
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C***********          Z-ADD1         @I                       CRT002 130543
     C                     Z-ADD1         @J                              130543
     C                     MOVEL@TLID     @@PTL                           CRT002
     C                     MOVELRAUSID    @TLID                           CRT002
      *                                                                   CRT002
     C           @TLID     IFNE @@PTL                                     CRT002
     C***********@TLID     LOKUPWTL,@I                   60        CRT002 130543
     C           @TLID     LOKUPWTL,@J                   60               130543
     C           *IN60     IFEQ '1'                                       CRT002
     C***********@I        OCUR TELDS                  60          CRT002 130543
     C           @J        OCUR TELDS                  60                 130543
     C           *IN60     IFEQ '0'                                       CRT002
     C                     MOVELD@TLID    PTLID                           CRT002
     C                     MOVELD@TLBC    PTLBC                           CRT002
     C                     MOVELD@SPVI    PSPVI                           CRT002
     C                     MOVELD@OVRI    POVIN                           CRT002
     C**********           MOVELD@CHTL    PCHTL                                       CRT002 Bug3855
     C**********           MOVELD@NCTL    PNCTL                                       CRT002 Bug3855
     C                     Z-ADDD@CHTL    PCHTL                                              Bug3855
     C                     Z-ADDD@NCTL    PNCTL                                              Bug3855
     C                     MOVELD@DEPC    PDEPC                           CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
     C                     MOVE PDEPC     SDEPC                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     MOVELPTLID     @TLID
     C                     EXSR RTTWID
      *
      ** Record not found.
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD1         DBASE            ** DB ERR 01 **
     C                     MOVE 'TTRNT'   DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C                     Z-ADDT2NATN    @NATN   50
      *                                                                   CRT002
      **  If transaction is not posted to suspense                        CRT002
      *                                                                   CRT002
     C***********WSUS      IFEQ 'N'                                CRT002 163583
     C           PMODE     IFEQ 'I'                                       163583
      *
      ** Check for account terminal conditions
     C                     EXSR CHKACC
     C                     ENDIF                                          198870
      *                                                                   CRT002
      **  Retrieve Available Balance before transactionis carried out.    CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     MOVELACCY      @CCY                            CRT002
     C                     Z-ADDRRNM      @RRNM                           CRT002
     C                     Z-ADDODLN      @ODLN                           CRT002
     C                     Z-ADDODED      @ODED                           CRT002
     C                     Z-ADDHELD      @HELD                           CRT002
     C                     MOVE SACNO1    @ACNOM                          198870
     C                     EXSR RTBALC                                    CRT002
      *                                                                   CRT002
     C           *IN80     IFEQ '0'                                       CRT002
      *                                                                   CRT002
     C                     MOVEL'+'       RBAVBS                          CRT002
      *                                                                   CRT002
     C           @AVBL     IFLT 0                                         CRT002
     C                     Z-SUB@AVBL     @AVBL                           CRT002
     C***********          MOVEL'-'       RBAVBS                   CRT002 198870
     C                     MOVEL'+'       RBAVBS                          198870
     C                     ELSE                                           198870
     C           @AVBL     IFGT 0                                         198870
     C                     MOVEL'-'       RBAVBS                          198870
     C                     ELSE                                           198870
     C                     MOVE ' '       RBAVBS                          198870
     C                     ENDIF                                          198870
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     MOVE @AVBL     ZFIELD                          CRT002
     C                     Z-ADD@EQDP     ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    RBAVBL                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C**********           ENDIF                                   CRT002 198870
      *                                                                   198870
     C           PMODE     IFEQ 'P'                                       198870
     C           WSUS      ANDEQ'N'                                       198870
      *                                                                   198870
      ** If no validation error(s) exist?                                 198870
     C           *IN69     IFEQ '0'                                       198870
     C                     MOVE '1 '      @ACIN                           198870
     C                     EXSR CHKACC                                    198870
     C                     ENDIF                                          198870
     C                     ENDIF                                          198870
      *
      ** If no terminal error(s) exist
     C           @TI       IFEQ 0
     C***********PMODE     ANDEQ'I'                                CRT002 163583
     C***********PMODE     OREQ 'P'                                CRT002 163583
      *
      ** Process transaction details
     C                     EXSR WRKDET
      *                                                                   163583
      *                                                                   163583
     C********** PMODE     IFEQ 'P'                                163583 198870
     C********** WSUS      ANDEQ'N'                                163583 198870
      **********                                                   163583 198870
      ***If*no*validation error(s) exist?                          163583 198870
     C********** *IN69     IFEQ '0'                                163583 198870
     C**********           MOVE '1 '      @ACIN                    163583 198870
     C**********           EXSR CHKACC                             163583 198870
     C**********           ENDIF                                   163583 198870
     C**********           ENDIF                                   163583 198870
      *
      ** Refresh initial screen
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR RFRINL
     C                     END                                            CRT002
      *
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
     C                     CLEARWCMSG                                     CRT002
     C                     MOVE ACCY      @CCY                            CRT002
     C                     EXSR MOVDET                                    CRT002
      *                                                                   CRT002
     C           *IN30     IFEQ '0'                                       CRT002
      *                                                                   CRT002
     C                     MOVELACCY      @CCY                            CRT002
     C                     Z-ADDRRNM      @RRNM                           CRT002
     C                     Z-ADDODLN      @ODLN                           CRT002
     C                     Z-ADDODED      @ODED                           CRT002
     C                     Z-ADDHELD      @HELD                           CRT002
     C                     EXSR RTBALC                                    CRT002
      *                                                                   CRT002
      **  Account Balance Sign (after).                                   CRT002
      *                                                                   CRT002
     C           *IN80     IFEQ '0'                                       CRT002
      *                                                                   CRT002
     C***********          MOVEL'+'       RBABDS                   CRT002 198870
      *                                                                   CRT002
     C           @AVBL     IFLT 0                                         CRT002
     C                     Z-SUB@AVBL     @AVBL                           CRT002
     C***********          MOVEL'-'       RBABDS                   CRT002 198870
     C                     MOVEL'+'       RBABDS                          198870
     C                     ELSE                                           198870
      *                                                                   198870
     C           @AVBL     IFGT 0                                         198870
     C                     MOVEL'-'       RBABDS                          198870
     C                     ELSE                                           198870
     C                     MOVE ' '       RBABDS                          198870
     C                     ENDIF                                          198870
      *                                                                   198870
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Account Balance (after).                                        CRT002
      *                                                                   CRT002
     C                     MOVE @AVBL     ZFIELD                          CRT002
     C                     Z-ADD@EQDP     ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    RBDAAB                          CRT002
     C                     MOVE *BLANKS   WFIELD 16                       198870
     C                     MOVE RBDAAB    WFIELD                          198870
     C                     EXSR PAD                                       198870
     C                     MOVEARTE       RBDAAB                          198870
     C                     MOVE *BLANKS   RTE                             198870
      *                                                                   CRT002
      **  If transaction is posted to suspense                            CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'Y'                                       CRT002
     C                     MOVEL*BLANKS   RBASN1                          CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     MOVELREPOIO    P@QDS                           CRT002
     C                     MOVELP@QDS     WCMSG                           CRT002
     C                     EXSR SDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
     C                     MOVEL*BLANKS   REPOIO                          CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     EXSR WRLOG                                     CRT002
      *                                                                   CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
      *                                                                   CRT002
      **  Refresh initial screen                                          CRT002
      *                                                                   CRT002
     C                     EXSR RFRINL                                    CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALINL - Validate initial screen                   *
      *                                                               *
      * CALLS      VSACNO - Validate account number                   *
      *            VSCCY  - Validate currency code                    *
      *                                                               *
      * CALLED BY  WRKACC - Work with account                         *
      *            ACLOSE - A/C closure enquiry                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALINL    BEGSR                           ** VALINL **
      *
      ** Set off Validation error fields and indicators
     C                     SETOF                     202122
     C                     Z-ADD0         @TI     20
     C                     Z-ADD0         @WI     20
      *
      ** Validate Account Number
     C           *IN69     CASEQ'0'       VSACNO
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSACNO - Validate account number                   *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  VALINL - Validate initial screen                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSACNO    BEGSR                           ** VSACNO **
      *
      ** Set off error indicator(s)
     C                     SETOF                     30
     C                     SETOF                     70
      * Initialise suspense indicator                                     162643
     C                     MOVEL'N'       WSUS    1                       162643
      *
     C                     MOVE *BLANKS   SACN20 10
     C/COPY WNCPYSRC,RE4119C019
      *
      * Move fields to key list.
     C                     MOVELSACNO1    KACNO
     C                     MOVELKACNO     SACN20
      *
     C           SACNO1    IFNE SACN20
     C           KACNO     ORLT 0
     C                     SETON                     70
     C                     END
      *
      ** Get Account Details
     C           *IN70     IFEQ '0'
     C           KLACNO    CHAINACNUM                70
     C                     END
      *
      ** Account number must refer to a live record
     C           *IN70     IFEQ '1'
     C                     SETON                     30
      *                                                                   CRT002
      **  If not Store and Forward Mode and no account is found           CRT002
      *                                                                   CRT002
     C           WFWST     IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     MOVE 'USR0050' @MSGID
     C                     EXSR SNDMSG
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Post transaction to suspense                                    CRT002
      *                                                                   CRT002
     C                     MOVEL'Y'       WSUS                            CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ELSE
      *
      ** If account is a 'live' record
     C           RECI      IFEQ 'D'
      *
      ** If account sub-type is not 'S'
     C           STYP      IFNE 'S'
      *
      ** set up account details
     C**********           Z-ADDCNUM      @CNUM                                               CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     Z-ADDACOD      @ACOD
     C                     Z-ADDACSQ      @ACSQ
     C                     MOVELBRCA      @BRCA
     C                     Z-ADDRRNM      @RRNM
     C                     Z-ADDDACO      @DACO   50
     C                     MOVE ACCY      SCCY1
     C                     MOVE ACCY      SCCY2
     C                     MOVE ACCY      SCCY3                                               CAAA03
     C                     MOVE ACCY      @CCY
     C                     EXSR RTCCYS
      *
     C************IN80     IFEQ '0'                                       140802
     C           @RTCD     IFEQ *BLANKS                                   140802
     C                     Z-ADDTDP,@I    @EQDP
     C                     MOVELTMD,@I    @EQMD
     C                     MOVELTRT,@I    @EQSP  138                      CRT002
      *                                                                   CEU024
      ** Check if EMU Retail Teller Support Enhancement is installed      CEU024
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
      *                                                                   CEU024
     C           TEU,@I    IFEQ *BLANKS                                   CEU024
     C                     EXSR SREURO                                    CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     MOVE TEU,@I    WACCY   1                       CEU024
     C           ACCY      IFEQ BKEURO                                    151260
     C                     MOVE 'E'       WACCY                           151260
     C                     ENDIF                                          151260
     C                     Z-ADDEUR,@I    WARAT  138                      CEU024
     C                     MOVE EUI,@I    WAIND   1                       CEU024
     C                     Z-ADDSTP,@I    WASTP   50                      CEU024
     C                     Z-ADDETP,@I    WAETP   50                      CEU024
      *                                                                   CEU024
     C                     ENDIF                                          CEU024
      *
      ** if currency not present in the currency table,display error
     C                     ELSE
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD2         DBASE            ** DB ERR 02 **
     C                     MOVE 'SDCURRPD'DBFILE
     C                     MOVELACCY      DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Error if account sub-type is 'S'
     C                     ELSE
     C                     SETON                     30
      *                                                                   CRT002
      **  If not Store and Forward Mode and account sub-type is 'S'       CRT002
      *                                                                   CRT002
     C           WFWST     IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     MOVE 'USR0116' @MSGID
     C                     EXSR SNDMSG
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Post transaction to suspense                                    CRT002
      *                                                                   CRT002
     C                     MOVEL'Y'       WSUS                            CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     END
      *
      ** Account referred must not be closed
     C                     ELSE
     C                     SETON                     30
      *                                                                   CRT002
      **  If not Store and Forward Mode and account is closed             CRT002
      *                                                                   CRT002
     C           WFWST     IFEQ 'N'                                       CRT002
     C           PMODE     OREQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     MOVE 'USR0051' @MSGID
     C                     EXSR SNDMSG
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Post transaction to suspense                                    CRT002
      *                                                                   CRT002
     C                     MOVEL'Y'       WSUS                            CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     END
      *                                                                   CRT002
     C                     MOVE CNUM      @@CNUM  6                       CRT002
      *                                                               *
     C                     END
      *                                                                   CRT002
      **  Set up the fields to be moved to TC buyer's id type,            CRT002
      **  id no, and name.                                                CRT002
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JW'                                     CRT002
     C           *IN70     ANDEQ'0'                                       CRT002
     C           *IN30     ANDEQ'0'                                       CRT002
     C                     MOVE *BLANKS   B@BIT   2                       CRT002
     C                     MOVELATYP      B@BIT                           CRT002
     C                     MOVE STYP      B@BIT                           CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   B@BIN  20                       CRT002
     C                     MOVE *BLANKS   @BIN17 17                       CRT002
     C                     MOVEL'      / '@BIN17                          CRT002
     C                     MOVELCNUM      @BIN17                          CRT002
     C                     MOVE ACNO      @BIN17                          CRT002
     C                     MOVEL@BIN17    B@BIN                           CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   B@BNM  20                       CRT002
     C                     MOVELANAM      B@BNM                           CRT002
     C                     END                                            CRT002
      *                                                                                       263834
      ** For delete, Account should not have an attached SWACSSB record                       263834
      *                                                                                       263834
     C           *IN40     IFEQ '1'                                                           263834
     C                     MOVELCNUM      WWCNBR                                              263834
     C                     Z-ADDACOD      WWACOD                                              263834
     C                     Z-ADDACSQ      WWACSQ                                              263834
     C                     MOVELBRCA      WWBRCA                                              263834
     C                     MOVELACCY      WWCCY                                               263834
      *                                                                                       263834
     C           SWAKEY    CHAINSWACSSBF             65                                       263834
     C           *IN65     IFEQ '0'                                                           263834
     C           RECISW    ANDNE'*'                                                           263834
     C                     MOVE '1'       *IN30                                               263834
     C                     MOVE '1'       *IN69                                               263834
     C                     MOVE '5045554' ZAMSID                                              263834
     C                     CALL 'Y2SNMGC'                                                     263834
     C                     PARM           ZAPGM                                               263834
     C                     PARM           ZAPGRL                                              263834
     C                     PARM           ZAMSID                                              263834
     C                     PARM           ZAMSGF                                              263834
     C                     PARM *BLANK    ZAMSDA                                              263834
     C                     PARM           ZAMSTP                                              263834
      *                                                                                       263834
      ** Clear all fields for default mechanism next time.                                    263834
      *                                                                                       263834
     C                     MOVEL*BLANK    ZAPGM                                               263834
     C                     MOVEL*BLANK    ZAPGRL                                              263834
     C                     MOVEL*BLANK    ZAMSDA                                              263834
     C                     MOVEL*BLANK    ZAMSTP                                              263834
     C                     ENDIF                                                              263834
     C                     ENDIF                                                              263834
      *                                                               *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            CHKACC - Check account status                      *
      *                                                               *
      * CALLS      RTBKDR - Block debit check                         *
      *            RTRFDR - Refer debit check                         *
      *            RTIACT - Inactive account check                    *
      *            RTBKPT - Bankrupt/Liquidation check                *
      *            RTBDPT - Bad Debt check                            *
      *            RTBRCH - Branch different check                    *
      *            RTACLG - Account closing check                     *
      *                                                               *
      * CALLED BY  WRKACC - Work with account                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           CHKACC    BEGSR                           ** CHKACC **
      *
     C                     MOVE RETB      @RETB
     C                     MOVE SCCY1     SCCY2
     C                     MOVE SCCY1     SCCY3                                               CAAA03
     C                     MOVE ANAM      SANAM
     C                     MOVE SACNO1    SACNO2
     C                     MOVE '  '      @ACIN   2
      *
      ** Block debit check
     C***********@V,@BD    IFNE ' '                                       114621
     C           @V,@BD    IFNE 'X'                                       114621
     C                     EXSR RTBKDR
     C                     END
      *
      ** Refer debit check
     C***********@V,@RD    IFNE ' '                                       114621
     C           @V,@RD    IFNE 'X'                                       114621
     C                     EXSR RTRFDR
     C                     END
      *
      ** Inactive account check
     C***********@V,@IA    IFNE ' '                                       114621
     C           @V,@IA    IFNE 'X'                                       114621
     C                     EXSR RTIACT
     C                     END
      *
      ** Bankrupt/Liquidation check
     C***********@V,@BL    IFNE ' '                                       114621
     C           @V,@BL    IFNE 'X'                                       114621
     C                     EXSR RTBKPT
     C                     END
      *
      ** Bad Debt check
     C***********@V,@DB    IFNE ' '                                       114621
     C           @V,@DB    IFNE 'X'                                       114621
     C                     EXSR RTBDPT
     C                     END
      *
      ** Branch different check
     C***********@V,@DF    IFNE ' '                                       114621
     C           @V,@DF    IFNE 'X'                                       114621
     C                     MOVELBRCA      @BRCA
     C                     MOVELPTLBC     @TLBC
     C                     EXSR RTBRCH
     C                     END
      *
      ** Account closing check
     C***********@V,@AC    IFNE ' '                                       114621
     C           @V,@AC    IFNE 'X'                                       114621
     C                     MOVELACST      @ACST
     C                     EXSR RTACLG
     C                     END
      *
      ** If terminal error(s) found
     C           @TI       IFGT 0
     C                     SETON                     2022
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
     C                     ELSE
      *
      ** If warning error(s) found
     C           @WI       IFGT 0
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
     C                     SETON                     22
      **********                                                                     BUG3734 BUG3845
      ***Move*teller override indicators from DTAARA/RTSDTA                          BUG3734 BUG3845
      ***to*teller override array                                                    BUG3734 BUG3845
      **********                                                                     BUG3734 BUG3845
     C**********           MOVEAPOVIN     @R                                         BUG3734 BUG3845
      **********                                                                     BUG3734 BUG3845
      ***Perform override validate process                                           BUG3734 BUG3845
      **********                                                                     BUG3734 BUG3845
     C**********           EXSR VOCOND                                               BUG3734 BUG3845
      **********                                                                     BUG3734 BUG3845
      ***Do*not*display override teller prompt if sign-on teller has                 BUG3734 BUG3845
      ***authority to override?                                                      BUG3734 BUG3845
      **********                                                                     BUG3734 BUG3845
     C********** *IN68     IFEQ '0'                                                  BUG3734 BUG3845
     C**********           SETOF                     26                              BUG3734 BUG3845
     C**********           ELSE                                                      BUG3734 BUG3845
     C**********           SETON                     26                              BUG3734 BUG3845
     C**********           END                                                       BUG3734 BUG3845
      **********                                                                     BUG3734 BUG3845
     C**********           EXSR WRKOVR                                               BUG3734 BUG3845
      **********                                                                     BUG3734 BUG3845
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKDET - Work with details                         *
      *                                                               *
      * CALLS      RFRDET - Refresh details    screen                 *
      *            DSPDET - Display combined cheque details           *
      *            LAST   - Final Processing                          *
      *            ACCDET - Accept details                            *
      *            EXTDET - Exit details    screen                    *
      *                                                               *
      * CALLED BY  WRKACC -  Work with account                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKDET    BEGSR                           ** WRKDET **
      *
      ** Initialise work fields
     C           @WI       ADD  1         @WX     20
      *
     C           PMODE     IFEQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     EXSR RFRDET
      *
     C                     EXSR DSPDET
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
     C           *INKL     DOWEQ'0'
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CCP8                                           S01408
     C*                                                                   S01408
      *
      ** If Cmd/3 is pressed, exit this program
     C           *INKC     CASEQ'1'       LAST
      *
      ** If Cmd/5 is pressed, refresh details    screen
     C           *INKE     CASEQ'1'       RFRDET
      *
      ** If Cmd/12 is pressed, return to previous routine
     C           *INKL     CASEQ'1'       EXTDET
      *
      ** If Enter key is pressed, process screen input
     C                     CAS            ACCDET
      *
     C                     END
      *                                                                   CRT002
     C           *IN69     IFEQ '1'                                       CRT002
     C           PMODE     ANDEQ'P'                                       CRT002
     C                     LEAVE                                          CRT002
     C                     ENDIF                                          CRT002
      *
      ** Redisplay appropriate screen ( detail )
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR DSPDET
     C                     ENDIF                                          CRT002
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPDET - Display combined cheque details           *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPDET    BEGSR                           ** DSPDET **
      *
      ** If previous key has not been pressed or set on
     C           *INKL     IFEQ '0'
      *
      ** Display program message subfile for any messages
     C                     WRITERE4119C0
      *
      ***Display*warning/terminal*error(s)*screen**********************                       239004
     C**********           WRITERE4119F1                                                      239004
     C/COPY WNCPYSRC,RE4119C004
      *
      ** Display and accept input details
     C                     EXFMTRE4119F2
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CCP9                                           S01408
     C*                                                                   S01408
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            ACCDET - Accept details                            *
      *                                                               *
      * CALLS      PRTTRN - Print transaction                         *
      *            VALDET - Validate details                          *
      *            VALAGN - Check again before update                 *
      *            UPDATE - Update control                            *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ACCDET    BEGSR                           ** ACCDET **
      *
     C                     SETOF                     21
      *
     C                     EXSR VALDET
      *
      ** Proceed to update? (i.e. no validation or terminal errors)
     C           *IN67     IFEQ '1'
      *
      ** Check condition again before update
     C                     EXSR VALAGN
     C*                                                                   S01408
      ** Proceed to update? (i.e. no Outstanding Held Items, Stopped                          249968
      **                          Cheques, Standing Orders, SWEEPS  )                         249968
     C           @SKIP     IFEQ 'N'                                                           249968
     C/COPY WNCPYSRC,RE4119CCP1                                           S01408
     C*                                                                   S01408
      *
     C                     EXSR UPDATE
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CCP2                                           S01408
     C*                                                                   S01408
      *                                                                                       CCG016
     C                     MOVEL'N'       ##COPD                                              CCG016
     C           CCG016    IFEQ 'Y'                                                           CCG016
     C                     EXSR SNDUDC                                                        CCG016
     C                     END                                                                CCG016
     C           ##COPD    IFEQ 'N'                                                           CCG016
      *                                                                                       CCG016
      *
     C           PMODE     IFEQ 'I'                                       CRT002
     C/COPY WNCPYSRC,RE4119C014
     C                     EXSR PRTTRN
     C/COPY WNCPYSRC,RE4119C015
     C                     ENDIF                                          CRT002
     C                     ENDIF                                                              CCG016
      *
      ** End of commitment cycle
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT
     C                     END                                            CRT002
      *
      ** Display transaction completed
     C                     SETON                     45
     C                     ENDIF                                                              249968
      *
      ** If account closure is not requested?
     C           @CLOS     IFEQ ' '
     C                     SETOF                     4142
     C                     END
      *
      ** If account closure is successful
     C           @CLOS     IFEQ 'Y'
     C                     SETON                     41
     C                     END
      *
      ** If account closure is unsuccessful
     C           @CLOS     IFEQ 'N'
     C                     SETON                     42
     C                     END
      *
      ** Exit out of details screen and back to initial screen
     C                     MOVE '1'       *INKL
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CCP3                                           S01408
     C*                                                                   S01408
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALAGN - Check again before update                 *
      *                                                               *
      * CALLS      VACCLO - Validate account closure                  *
      *            RTODCK - Exceed OD check                           *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALAGN    BEGSR                           ** VALAGN **
      *
      ** If a/c closure requested, perform account closure check
     C           *IN40     IFEQ '1'
     C                     EXSR VACCLO
     C                     END
      *
      ** If a/c closure not requested  OR  unsuccessful a/c closure
      ** perform exceed overdraft check once more before update
     C           *IN40     IFEQ '0'
     C           @CLOS     OREQ 'N'
     C                     Z-ADDCLBLN     @CLBL
     C                     MOVELACST      @ACST
     C                     MOVELSTYP      @STYP
     C                     EXSR RTODCK
     C                     END
      *
      ** If terminal error(s) found
     C           @TI       IFGT 0
      *
     C                     SETON                     202269
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
      ** exit out of details screen
     C                     MOVE '1'       *INKL
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALDET - Validate details                          *
      *                                                               *
      * CALLS      VALTRN - Validate transaction                      *
      *            WRKCYC - Currency conversion                       *
      *            RTTCCY - Teller currency conditions check          *
      *            VTCOND - Validate teller transaction conditions    *
      *            VACCLO - Validate account closure                  *
      *            RTODCK - Exceed OD check                           *
      *            VOCOND - Validate override conditions              *
      *            WRKOVR - Work with override                        *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALDET    BEGSR                           ** VALDET **
      *
     C                     SETOF                     6769
     C                     SETOF                     26
     C                     SETOF                     616263               CRT002
     C                     SETOF                     64                   CRT002
     C                     MOVE *OFF      *IN23                                               CRT026
     C                     MOVEA*BLANKS   @W,@WX
     C                     MOVEL*BLANKS   @OVTI
      *
      ** Validate transaction based on function code
     C                     EXSR VALTRN
      *
      ** If no error(s) exist?
     C           *IN69     IFEQ '0'
      *                                                                   CRT002
      **  Convert amounts only when in interactive mode.                  CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
      *
      ** amount conversion into account ccy equivalent
     C                     EXSR WRKCYC
      *                                                                   CRT002
     C           PMODE     WHEQ 'P'                                       CRT002
      *                                                                   CRT002
      **  Align net equivalent amount (RATRA1)                            CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   WTRA1  14                       CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C           PFNCD     IFEQ '0JL'                                     CRT002
     C                     MOVE RATRA1    ZFIELD                          CRT002
     C                     ELSE                                           CRT002
     C           *IN12     IFEQ '1'                                       CRT002
     C                     MOVE RATRA2    ZFIELD                          CRT002
     C                     ELSE                                           CRT002
     C                     MOVE RAMNA2    ZFIELD                          CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
     C                     Z-ADD@EQDP     ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    WTRA1                           CRT002
      *                                                                   CRT002
     C                     Z-ADD@EQDP     ZADEC                           CRT002
     C           13        SUB  @EQDP     ZADIG                           CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANK    ZFIELD                          CRT002
     C                     MOVE WTRA1     ZFIELD                          CRT002
     C                     EXSR ZALIGN                                    CRT002
     C                     MOVE ZFIELD    @TNAM                           CRT002
      *                                                                   CRT002
      **  If error found?  Set up error message                           CRT002
      *                                                                   CRT002
     C           *IN99     IFEQ '1'                                       CRT002
     C                     SETON                     32                   CRT002
     C                     MOVE 'USR0008' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     GOTO VALDE9                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Subtract the charges from the equivalent amount to get          CRT002
      **  the gross equivalent amount.                                    CRT002
      *                                                                   CRT002
     C***********PMODE     IFEQ 'P'                                 CRT002118271
     C***********PFNCD     ANDEQ'0JW'                               CRT002118271
     C           WCHCCY    IFEQ ACCY                                      118271
     C                     SUB  @TCHG     @TNAM                           CRT002
     C                     ENDIF                                          CRT002
     C                     Z-ADD@TNAM     @CNAM                           CRT002
     C                     Z-ADD@TNAM     @EQAM                           CRT002
      *                                                                   CRT002
     C                     Z-ADD@EQDP     ZDECS                           CRT002
     C                     MOVE 'J'       ZECODE                          CRT002
     C                     MOVE @TNAM     ZFLD15                          CRT002
     C                     EXSR ZFRPED                                    CRT002
     C                     MOVE ZOUT22    SCHEQ                           CRT002
      *                                                                   CRT002
      **  Compute the exchange rate                                       CRT002
      *                                                                   CRT002
     C           CEU024    IFEQ 'Y'                                       CEU024
     C           WEXDF     ANDEQ'Y'                                       CEU024
     C                     MOVELWTIND     W@TMD                           CEU024
     C                     MOVELWAIND     W@EMD                           CEU024
     C                     ELSE                                           CEU024
     C                     MOVEL@TCMD     W@TMD                           CRT002
     C                     MOVEL@EQMD     W@EMD                           CRT002
     C                     ENDIF                                          CEU024
     C           PFNCD     IFEQ '0JL'                                     CRT002
     C                     MOVELRACCY2    W@TCY                           CRT002
     C                     ELSE                                           CRT002
     C                     MOVELRACCY1    W@TCY                           CRT002
     C                     ENDIF                                          CRT002
     C                     MOVELACCY      W@ECY                           CRT002
      *                                                                   CRT002
     C                     EXSR CMPXRT                                    CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *
      ** If charge percentage entered calculate charge amount
     C           SCPER     IFNE *BLANKS
     C           @TNAM     MULT @CHPER    @@WRK  190
     C           @@WRK     DIV  10000     @TCHG
      *
      ** if charge entered get cash amount for customer
      ** this amount will appear on advice & screen and will be
      ** output to TTRANPD
     C           PMODE     IFEQ 'I'                                       118271
     C           PMODE     OREQ 'P'                                       118271
     C           WCHCCY    ANDEQACCY                                      118271
     C           @TCHG     IFNE *ZERO
     C                     SETON                     15
     C           @TNAM     ADD  @TCHG     @CSAMT 130
     C                     END
     C                     ENDIF                                          118271
     C                     END
      *
      ** Perform teller currency conditions check
     C                     MOVE SCCY      @CCY
     C                     EXSR RTTCCY
      *                                                                   CEU024
      ** Check if EMU Retail Teller Support Enhancement is installed      CEU024
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C           TEU,@I    ANDEQ*BLANKS                                   CEU024
     C           *IN82     ANDEQ'*ON'                                     CEU024
     C                     EXSR SREURO                                    CEU024
     C                     ENDIF                                          CEU024
      *
      ** If an empty element is found? insert currency into array
     C           *IN82     IFEQ '1'
     C           @CY,@I    ANDEQ'   '
     C                     MOVE SCCY      @CY,@I
     C                     END
      *
     C           *IN89     IFEQ '1'
     C***********          SETON                     2269
     C                     MOVE '1'       *IN22                           CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     MOVE '1'       *IN69                           CRT002
     C                     END                                            CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C**********           MOVE '1'       *IN67                    CRT002 198870
     C                     MOVE '0'       *IN67                           198870
     C                     END                                            CRT002
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
     C                     END
      *
      ** Validate teller transaction conditions
     C                     EXSR VTCOND
      *
      ** Exceeds overdraft check
     C                     EXSR RTODCK
      *
      ** If terminal error(s) found
     C           @TI       IFGT 0
      *
     C***********          SETON                     202269               CRT002
      ** Turn OFF *IN20, do not display TRANSACTION TERMINATED                               BUG8168
      **   error message                                                                     BUG8168
     C**********           MOVE '1'       *IN20                                       CRT002 BUG8168
     C                     MOVE '0'       *IN20                                              BUG8168
     C                     MOVE '1'       *IN22                           CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     MOVE '1'       *IN69                           CRT002
     C                     ENDIF                                          CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C**********           MOVE '1'       *IN67                    CRT002 198870
     C                     MOVE '0'       *IN67                           198870
     C                     ENDIF                                          CRT002
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
      ** exit out of details screen
     C**********           MOVE '1'       *INKL                                              BUG8168
      *
     C                     ELSE
      *
      ** If warning error(s) found and different from previous error(s)
     C           @WI       IFGT 0
      *
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
     C                     SETON                     22
      *
      ** Move teller override indicators from DTAARA/RTSDTA
      ** to teller override array
     C                     MOVEAPOVIN     @R
      *
      ** Perform override validate process
     C                     EXSR VOCOND
      *
      ** If sign-on teller has authority to override
      ** Do not display override teller prompt
     C           *IN68     IFEQ '0'
     C                     SETOF                     26
     C                     MOVE *OFF      *IN23                                               CRT026
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE *ON       *IN23                                               CRT026
     C                     ELSE                                                               CRT026
     C                     SETON                     26
     C                     ENDIF                                                              CRT026
     C                     END
      *
     C                     END
      *
      ** transaction acceptance with or without override
     C                     EXSR WRKOVR
      *
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVE '1'       *IN67                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     END
      *
     C                     END
      *
     C           VALDE9    TAG                                            CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKCYC - Currency conversion                       *
      *                                                               *
      * CALLS      RTCONV - Currency conversion                       *
      *            DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKCYC    BEGSR                           ** WRKCYC **
      *
     C                     MOVELACCY      @EQCY
     C                     MOVELSCCY      @TCCY
     C                     Z-ADD@TRNAM    @TCAM
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C********** CRT104    IFEQ 'N'                                CEU024 151260
     C           WEXDF     IFEQ 'Y'                                       151260
     C                     MOVELWTIND     @TCMD                           CEU024
     C                     MOVELWAIND     @EQMD                           CEU024
     C                     ENDIF                                          CEU024
     C                     MOVELBKEURO    @EUCY   3                       CEU024
     C                     MOVE WEXDF     @INEU   1                       151260
     C                     EXSR RTCOEU                                    CEU024
     C                     ELSE                                           CEU024
      *
      ** Calculate the conversion equiv. from the exchange rate
     C                     EXSR RTCONV
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     Z-ADD@EQAM     @CNAM  150
     C                     Z-ADD@EQAM     @TNAM  130
      *
     C                     Z-ADD@EQDP     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     MOVE @EQAM     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SCHEQ
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKOVR - Work with override                        *
      *                                                               *
      * CALLS      DSPBAL - Display account balances                  *
      *            DSPOVR - Display overrride screen                  *
      *            EXTOVR - Exit override screen                      *
      *            LAST   - Final Processing                          *
      *            RFROVR - Refresh override screen                   *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKOVR    BEGSR                           ** WRKOVR **
      *
      ** Set off underline attributes
     C                     SETOF                     27
      *
      ** Refresh override screen
     C                     EXSR RFROVR
      *
      ** Display 'OVERRIDE REQUIRED' message
     C           @WI       IFGT 0
     C                     SETON                     21
     C                     END
      *
      ** Display override screen
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR DSPOVR
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           @WI       IFEQ 0                                         CRT002
     C           @TI       ANDEQ0                                         CRT002
     C                     MOVE '1'       *INKA                           CRT002
     C                     ELSE                                           CRT002
     C                     MOVE '1'       *INKL                           CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
     C           *INKL     DOWEQ'0'
      *
      ** If Cmd/1 is pressed, work with transaction
     C           *INKA     CASEQ'1'       WRKTRN
      *
      ** If Cmd/2 is pressed, display account balances
     C           *INKB     CASEQ'1'       DSPBAL
      *
      ** If Cmd/3 is pressed, exit this program
     C           *INKC     CASEQ'1'       LAST
      *
     C                     END
      *
      ** Redisplay appropriate screen ( override )
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR DSPOVR
     C                     ENDIF                                          CRT002
      *
     C                     END
      *
      ** Return to previous screen
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR EXTOVR
     C                     ENDIF                                          CRT002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPOVR - Display overrride screen                  *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPOVR    BEGSR                           ** DSPOVR **
      *
      ** If previous key has not been pressed or set on
     C           *INKL     IFEQ '0'
      *
      ** Display program message subfile for any messages
     C                     WRITERE4119C0
      *
      ***Display*warning/terminal*error*screen*************************                       239004
     C**********           WRITERE4119F1                                                      239004
     C/COPY WNCPYSRC,RE4119C005
      *
      ** Display withdrwal screen
     C**********           WRITERE4119F2                                                    BUG15976
      *
      ** Display and accept override screen
     C                     EXFMTRE4119F3
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
      ** Set off account balances display
     C                     SETOF                     28
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            EXTOVR - Exit override screen                      *
      *                                                               *
      * CALLS      RFROVR - Refresh override screen                   *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           EXTOVR    BEGSR                           ** EXTOVR **
      *
      ** Refresh override screen
     C                     EXSR RFROVR
      *
      ** If no terminal error(s) exist
     C           @TI       IFEQ 0
      *
     C           @WX       SUB  1         @WI
     C                     MOVEA*BLANKS   @W,@WX
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
      *
     C           @WI       IFGT 0
     C                     SETON                     22
     C                     ELSE
     C                     SETOF                     22
     C                     END
      *
      ** Set previous screen indicator off to return to details screen
     C                     MOVE '0'       *INKL
      *
     C                     END
      *
      ** Set on underline attributes
     C                     SETON                     27
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPBAL - Display account balances                  *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTBALC - Calculate available balances              *
      *            ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPBAL    BEGSR                           ** DSPBAL **
      *
     C                     SETON                     28
      *
      **  If CRE081 is OFF or Available Balance is zero                                       CRE081
      *                                                                                       CRE081
     C           CRE081    IFEQ 'N'                                                           CRE081
     C           PAVBAL    OREQ 0                                                             CRE081
      *                                                                                       CRE081
      ** Calculate available balances
     C                     Z-ADD@EQDP     @CYDP
     C*********************Z-ADDRRNM      @RRNM                           CCB002
     C                     MOVE SACNO1    @ACNOM                          CCB002
     C                     Z-ADDODLN      @ODLN
     C                     Z-ADDODED      @ODED
     C                     Z-ADDHELD      @HELD
     C                     EXSR RTBALC
      *
      ** If MEMOS record not found.
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD3         DBASE            ** DB ERR 03 **
     C*********************MOVE 'MEMOS '  DBFILE           ***************CCB002
     C*********************MOVEL@RRNM     DBKEY                           CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C                     MOVEL@ACNOM    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      *
      **  Set-up Available Balance                                                            CRE081
      *                                                                                       CRE081
     C                     ELSE                                                               CRE081
     C                     Z-ADDPAVBAL    @AVBL                                               CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     Z-ADD@EQDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADDLDBLN     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SLDBL
      *
     C                     Z-ADD@EQDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@AVBL     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SAVBL
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * CALLS      RTODCK - Exceed OD check                           *
      *            SNDMSG - Send program message parameters           *
      *            VACCLO - Validate account closure                  *
      *            VALOVR - Validate override                         *
      *            VOCOND - Validate override conditions              *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKTRN    BEGSR                           ** WRKTRN **
      *
     C                     SETOF                     69
      *
      ** If override teller id is prompted?
     C           *IN26     IFEQ '1'
     C           *IN23     OREQ *ON                                                           CRT026
      *
     C                     EXSR VALOVR
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** Move teller override indicators from PF/SDTELDPD
      ** to teller override array
     C                     MOVEAFROVRI    @R
      *
      ** Perform override validate process
     C                     EXSR VOCOND
      *
      ** If successful override?  Set on Previous screen indicator
      ** to return to update handling
     C           *IN68     IFEQ '0'
      *
      ** exit out of details screen after setting on update indicator
     C                     SETOF                     69
     C                     SETON                     67
     C                     MOVE '1'       *INKL
      *
      ** Else teller override failed
     C                     ELSE
     C                     MOVE 'USR0029' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     69
     C                     END
      *
     C                     END
      *
      ** Else no override prompted, set on indicator to update files
     C                     ELSE
     C                     SETON                     67
      *
      ** and exit out of override screen
     C                     MOVE '1'       *INKL
      *
     C                     END
      *
      ** Save screen error messages (later to be used for output)
     C                     MOVE *BLANK    @MSG1  72
     C                     MOVE *BLANK    @MSG2  72
     C                     MOVELSMSG1     @MSG1  72
     C                     MOVELSMSG2     @MSG2  72
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALOVR - Validate override                         *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            RTENCP - Encript passcode                          *
      *                                                               *
      * CALLED BY  DSPBAL - Display account balances                  *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALOVR    BEGSR                           ** VALOVR **
      *
      ** Set off validation error indicator
     C                     SETOF                     69
     C                     MOVE *BLANKS   @OVTI   3
      *
      ** If override teller identifier is not blank
      ** If CRT026 is switch ON check user id if not blank                                    CRT026
      *                                                                                       CRT026
     C           SOVTI     IFNE *BLANK
     C           SOVUR     ORNE *BLANK                                                        CRT026
      *                                                                                       CRT026
      ** Access user id details to obtain the teller id attached                              CRT026
      ** to the user id                                                                       CRT026
      *                                                                                       CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'AOUSERR0'                                                    CRT026
     C                     PARM *BLANKS   @RTCD                                               CRT026
     C                     PARM '*KEY'    @OPTN                                               CRT026
     C                     PARM SOVUR     @USRP  10                                           CRT026
     C           MUSER     PARM MUSER     DSSDY                                               CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C           @RTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'MUSERDD' DBFILE           ***************                    CRT026
     C                     Z-ADD39        DBASE            ** DB ERR 39 **                    CRT026
     C                     MOVELSOVUR     DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C                     MOVEL'USR1501' @MSGID                                              CRT026
     C                     EXSR SNDMSG                                                        CRT026
      ** If user id is valid use the teller attached to this user                             CRT026
      ** to obtain the teller details                                                         CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE TLID      @TLID                                               CRT026
     C                     ENDIF                                                              CRT026
      ** If CRT026 enhancement is switch OFF use the teller id                                CRT026
      ** entered to obtain the teller details                                                 CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE SOVTI     @TLID                                               CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
      ** If no validation errors exist                                                        CRT026
      *
      ** Get teller identifier details
      ** Move fields to key list.
      *
     C           *IN69     IFEQ *OFF                                                          CRT026
     C                     CALL 'AOTELDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C**********           PARM SOVTI     @TLID   3                                           CRT026
     C                     PARM           @TLID   3                                           CRT026
     C           SDTELD    PARM SDTELD    DSFDY
      *
      ** If record found?
     C           @RTCD     IFNE *BLANKS
      *
      ** If record has been deleted?
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVEL'USR1509' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0030' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     38
     C                     END
     C                     ENDIF                                                              CRT026
      *
      ** Teller identifier is required
      ** If CRT026 is switch ON User identifier is required                                   CRT026
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1500' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0032' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     38
     C                     END
      *
      ** Store override teller-id for updating on file
     C**********           MOVELSOVTI     @OVTI                                               CRT026
     C                     MOVE @TLID     @OVTI                                               CRT026
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** If teller passcode is not blank?
      ** If CRT026 is switch ON check user password if not blank                              CRT026
      *                                                                                       CRT026
     C           SOVPC     IFNE *BLANK
     C           SOVPW     ORNE *BLANK                                                        CRT026
      ** If CRT026 is switch ON check the password via REC4170                                CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'REC4170'                                                     CRT026
     C                     PARM           SOVUR                                               CRT026
     C                     PARM           SOVPW                                               CRT026
     C                     PARM *BLANKS   @RTCD   7                                           CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     SELEC                                                              CRT026
     C           @RTCD     WHEQ 'CPF2204'                                                     CRT026
     C                     MOVE 'USR1501' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF22E3'                                                     CRT026
     C                     MOVE 'USR1506' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF2203'                                                     CRT026
     C                     MOVE 'USR1507' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF2213'                                                     CRT026
     C                     MOVE 'USR1508' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF22E5'                                                     CRT026
     C                     MOVE 'USR1505' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E2'                                                     CRT026
     C                     MOVE 'USR1503' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E4'                                                     CRT026
     C                     MOVE 'USR1504' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E6'                                                     CRT026
     C                     MOVE 'USR1510' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E9'                                                     CRT026
     C                     MOVE 'USR1511' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF2225'                                                     CRT026
     C                     MOVE 'USR1512' @MSGID                                              CRT026
     C                     ENDSL                                                              CRT026
     C                     MOVE *ON       *IN39                                               CRT026
     C                     EXSR SNDMSG                                                        CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C                     ELSE                                                               CRT026
      *
      ** If teller passcode does not match
      *
      ** Encript the passcode
     C                     MOVEASOVPC     BPWD
     C                     Z-ADD6         X       10
     C                     EXSR RTENCP
     C                     MOVEAEPWD      SOVPC
      *
     C           SOVPC     IFNE FRTLPC
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE 'USR0039' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     39
     C                     END
     C                     ENDIF                                                              CRT026
      *
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1502' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE 'USR0033' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     39
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFROVR - Refresh override screen                   *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLS      WRKOVR - Work with override                        *
      *            EXTOVR - Exit override screen                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFROVR    BEGSR                           ** RFROVR **
      *
     C                     SETOF                     21
     C                     MOVE *BLANKS   SOVTI
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE *BLANKS   SOVUR                                               CRT026
     C                     MOVE *BLANKS   SOVPW                                               CRT026
     C                     MOVE *OFF      *IN38                                               CRT026
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VTCOND - Validate teller transaction conditions    *
      *                                                               *
      * CALLS      RTABAL - Account available balance check           *
      *            RTCHQP - Cheque present check                      *
      *            RTCHQR - Cheque out of range check                 *
      *            RTSTPC - Stopped cheque check                      *
      *            RTTLMT - Teller limit check                        *
      *            RTXRAT - Exchange rate check                       *
      *            RTWDAY - Non-working days check                    *
      *            RTBVIC - Back valuation/IC check                   *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VTCOND    BEGSR                           ** VTCOND **
      *
      **  If CRE081 is OFF                                                                    CRE081
      *                                                                                       CRE081
     C           CRE081    IFEQ 'N'                                                           CRE081
      *                                                                                       CRE081
     C*********************Z-ADDRRNM      @RRNM                           CCB002
     C                     MOVE SACNO1    @ACNOM                          CCB002
     C                     Z-ADDODLN      @ODLN
     C                     Z-ADDODED      @ODED
     C                     Z-ADDHELD      @HELD
     C                     Z-ADDMINB      @MINB
     C                     MOVE ' '       @UCQB
     C                     Z-ADD@EQDP     @CYDP
     C                     Z-ADD@VLDN     @VLDT                           159251
      *
      ** Insufficient funds check
      ** Exceed OD limit    check
      ** Minimum balance    check
     C***********@V,@IF    IFNE ' '                                       114621
     C***********@V,@OD    ORNE ' '                                       114621
     C***********@V,@MB    ORNE ' '                                       114621
     C           @V,@IF    IFNE 'X'                                       114621
     C           @V,@OD    ORNE 'X'                                       114621
     C           @V,@MB    ORNE 'X'                                       114621
     C                     EXSR RTABAL
     C                     END
      *
      **  If CRE081 is ON, perform Account Balance Check                                      CRE081
      *                                                                                       CRE081
     C                     ELSE                                                               CRE081
      *                                                                                       CRE081
     C           @V,@IF    IFNE 'X'                                                           CRE081
     C           @V,@OD    ORNE 'X'                                                           CRE081
     C           @V,@MB    ORNE 'X'                                                           CRE081
     C                     EXSR VALABC                                                        CRE081
     C                     Z-ADDPAVBAL    CLBLN                                            AR1083178
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     OPEN CHQBKPD
      *
      ** Stopped cheque check
     C***********@V,@SC    IFNE ' '                                       114621
     C           @V,@SC    IFNE 'X'                                       114621
     C                     OPEN STOPC
     C                     MOVELSCCY1     @CCY                            159251
     C                     EXSR RTSTPC
     C                     CLOSESTOPC
     C                     END
      *                                                                   CRT002
     C           PFNCD     IFNE '0JW'                                     CRT002
      *
      ** Cheque out of range check
     C***********@V,@OR    IFNE ' '                                       114621
     C           @V,@OR    IFNE 'X'                                       114621
     C                     MOVELSACNO1    ACNO
     C                     EXSR RTCHQR
     C                     END
      *                                                                                       CRE019
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C           *IN81     ANDEQ*ON                                                           CRE019
     C                     MOVEL'Y'       WRNG    1                                           CRE019
     C                     ELSE                                                               CRE019
     C                     MOVEL'N'       WRNG                                                CRE019
     C                     ENDIF                                                              CRE019
      *
      ** Cheque present check and if no cheque out of range error?
     C***********@V,@CP    IFNE ' '                                       114621
     C           @V,@CP    IFNE 'X'                                       114621
     C           *IN81     ANDEQ'0'
     C                     Z-ADD0         @CQN
     C                     EXSR RTCHQP
     C                     END
      *                                                                   CRT002
     C                     END                                            CRT002
      *
     C                     CLOSECHQBKPD
      *
      ** Teller limit check
     C***********@V,@TL    IFNE ' '                                       114621
     C           @V,@TL    IFNE 'X'                                       114621
     C                     MOVELSCCY      @TCCY
     C                     MOVELBJLCCY    @LCCY
     C                     Z-ADD@TRNAM    @TAM1
     C                     Z-ADD0         @TAM2
     C                     MOVEL@CSIN1    @TCI1
     C                     MOVEL' '       @TCI2
     C                     Z-ADDPCHTL     @CHTL
     C                     Z-ADDPNCTL     @NCTL
     C                     EXSR RTTLMT
     C                     END
      *
      ** Exchange rate check
      ** Not for 'in'/'in' or 'in'/Euro ccys.                             151260
     C                     MOVELSCCY      @CCY1                           151260
     C                     MOVELACCY      @CCY2                           151260
     C***********@V,@XR    IFNE ' '                                       114621
     C           @V,@XR    IFNE 'X'                                       114621
     C           WEXDF     ANDNE'Y'                                       151260
     C**********           MOVELSCCY      @CCY1                           151260
     C**********           MOVELACCY      @CCY2                           151260
     C                     EXSR RTXRAT
     C                     END
      *
      ** Non-working days check
     C***********@V,@NW    IFNE ' '                                       114621
     C           @V,@NW    IFNE 'X'                                       114621
     C                     MOVEL@VLDN     ZDAYNO
     C                     MOVELSCCY      ZCCY                            159251
     C                     MOVE *BLANKS   ZLOC                            159251
     C                     EXSR RTWDAY
     C                     END
      *
      ** Back valuation/IC check
     C***********@V,@BV    IFNE ' '                                       114621
     C           @V,@BV    IFNE 'X'                                       114621
     C                     MOVEL@VLDN     ZDAYNO
     C                     Z-ADDLDID      @LDID                           159251
     C                     MOVE DRIF      @DRIF                           159251
     C                     Z-ADDLCID      @LCID                           159251
     C                     MOVE CRIF      @CRIF                           159251
     C                     MOVE '  '      @ACIN                           159251
     C                     EXSR RTBVIC
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VOCOND - Validate override conditions              *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VOCOND    BEGSR                           ** VOCOND **
      *
     C                     SETOF                     68
     C                     Z-ADD1         @I
      *
      ** Do until end of array reached or unsuccessful override found
     C           @I        DOUGT25
      *
      ** If element of override conditions is yes
      ** and teller override indicators array element is no
     C           @O,@I     IFEQ 'Y'
     C           @R,@I     ANDEQ'N'
      *
      ** Return as unsuccessful override
     C                     SETON                     68
     C                     Z-ADD25        @I
     C                     END
      *
      ** Check next element
     C                     ADD  1         @I
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTABALC1
      ** Account available balance check for debit transaction
      *
      /COPY ZSRSRC,RTINTRE
      ** CALCULATION OF INTEREST
      *
      /EJECT
      /COPY ZSRSRC,RTSTPCC1
      ** Stopped cheque check
      *
      /EJECT
      /COPY ZSRSRC,RTCHQRC1
      ** Cheque out of range check
      *
      /EJECT
      /COPY ZSRSRC,RTCHQPC1
      ** Cheque present check
      *
      /EJECT
      /COPY ZSRSRC,RTXRATC1
      ** Exchange rate check
      *
      /EJECT
      /COPY ZSRSRC,RTWDAYC1
      ** Non-working day check
      *
      /EJECT
      /COPY ZSRSRC,RTBVICC1
      ** Back valuation check
      *
      /EJECT
      /COPY ZSRSRC,RTODCKC1
      ** Overdraft check
      *
      /EJECT
      /COPY ZSRSRC,RTTLMTC1
      ** Teller limit check
      *
      /EJECT
      /COPY ZSRSRC,RTLCNVC1
      ** local currency conversion
      *
      /EJECT
      /COPY ZSRSRC,RTCONVC1
      ** Currency conversion
      *
      /EJECT
      /COPY ZSRSRC,RTTCCYC1
      ** Teller currency conditions
      *
      /EJECT
      /COPY ZSRSRC,RTBALCC1
      ** calculate available balance
      *
      /EJECT
      /COPY ZSRSRC,RTCCYSC1
      ** currency setup
      *
      /EJECT
      /COPY ZSRSRC,RTACLSC1
      ** Account closure
      *
      /EJECT
      /COPY ZSRSRC,RTTWIDC1
      ** teller workstation-id conditions check
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRDET - Refresh details screen                    *
      *                                                               *
      **CALLS**********************************************************   144506
      * CALLS      ZEDIT  -                                           *   144506
      *            ZSEFMT - Format rate for output                    *   144506
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *            EXTDET - Exit details screen                       *
      *            RFRINL - Refresh initial screen                    *   CRT002
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRDET    BEGSR                           ** RFRDET **
      *
     C                     SETON                     27
     C                     SETOF                     323537
     C                     SETOF                     3334
     C                     SETOF                     2169
     C                     SETOF                     171819
     C                     MOVE '0'       *IN31
      *
     C           @WI       IFEQ 0
     C                     SETOF                     22
     C                     END
      *                                                                   CRT002
     C                     MOVE '0'       *IN46                           CRT002
     C                     MOVE '0'       *IN47                           CRT002
     C                     MOVE '0'       *IN49                           CRT002
      *
     C                     MOVE *BLANKS   SCCY
     C                     MOVE *BLANKS   SCSAM
     C                     MOVE *BLANKS   SEXRT
     C                     MOVE *BLANKS   SCQNF
     C                     MOVE PDEPC     SDEPC
     C                     MOVE *BLANKS   SPRFC
     C                     MOVE *BLANKS   SVLDT
     C                     MOVE FSF0JL    SCTRTY
     C                     MOVE *BLANKS   SCPER
     C                     MOVE *BLANKS   SCAMT
     C                     MOVE *BLANKS   NARRI                           CRT002
      *                                                                   144506
     C           SCTRTY    IFNE *BLANKS                                   144506
     C           *INKL     ANDEQ'0'                                       144506
     C                     MOVE SCTRTY    TRTYP                           144506
     C                     MOVE ACCY      TRCURR                          144506
     C                     MOVE 'D'       DSRECT                          144506
     C           TRGKEY    CHAINRETRG                70                   144506
     C           *IN70     IFEQ '0'                                       144506
     C           CHAM      IFNE 0                                         144506
     C                     Z-ADDA6NBDP    ZADEC                           144506
     C                     MOVE CHAM      ZFIELD                          144506
     C           13        SUB  A6NBDP    ZADIG                           144506
     C                     EXSR ZEDIT                                     144506
     C                     MOVE ZFIELD    SCAMT                           144506
     C                     ENDIF                                          144506
     C           CHPC      IFNE 0                                         144506
     C                     Z-ADDCHPC      ZRT13                           144506
     C                     MOVE ' '       ZPBAS                           144506
     C                     EXSR ZSEFMT                                    144506
     C                     MOVELZRT13A    SCPER                           144506
     C                     ENDIF                                          144506
     C                     ENDIF                                          144506
     C                     ENDIF                                          144506
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JW'                                     CRT002
     C                     MOVE *BLANKS   SCIN                            CRT002
     C                     MOVE *BLANKS   SCSN                            CRT002
     C                     MOVE *BLANKS   SFCN                            CRT002
     C                     END                                            CRT002
      *
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP13                                           S01408
     C*                                                                   S01408
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSCCY  - Validate currency code                    *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            RTCCYS - Currency setup                            *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSCCY     BEGSR                           ** VSCCY  **
      *
      ** Set off error indicator(s)
     C                     SETOF                     31
      *
      ** If currency field is entered
     C           SCCY      IFNE ' '
      *                                                                   CRT002
      **  If transaction is not posted to suspense                        CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'N'                                       CRT002
      *
      ** Currency must not be the same as the currency code
      ** of the account referred to
     C           SCCY      IFEQ ACCY
     C                     SETON                     31
     C                     MOVE 'USR0117' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Get Branch Internal Customer Number                             CRT002
      *                                                                   CRT002
     C**********           CALL 'AOBRCHR0'                                             CRT002 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*KEY  '  @OPTN   7                       CRT002
     C                     PARM RABRNM    @BRCD   3                       CRT002
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        CRT002 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *                                                                   CRT002
      **  If record not found?                                            CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     Z-ADD31        DBASE                           CRT002
     C                     MOVEL'SDBRCHPD'DBFILE                          CRT002
     C                     MOVEL@BRCD     DBKEY                           CRT002
     C                     EXSR DBERR                                     CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     MOVELA8BICN    @@CNUM                          CRT002
     C                     MOVELA8BICN    @CNUM                           CRT002
     C                     MOVELRABRNM    @BRCA                           CRT002
      *                                                                   CRT002
      **  Get customer report name                                        CRT002
      *                                                                   CRT002
     C                     CALL 'AOCUSTR0'                                CRT002
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*KEY   ' @OPTN   7                       CRT002
     C                     PARM @@CNUM    @KEY1  10                       CRT002
     C                     PARM *BLANKS   @KYST   7                       CRT002
     C           SDCUST    PARM SDCUST    DSSDY                           CRT002
      *                                                                   CRT002
      **  If record not found?                                            CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     Z-ADD20        DBASE                           CRT002
     C                     MOVE 'SDCUSTPD'DBFILE                          CRT002
     C                     MOVEL@@CNUM    DBKEY                           CRT002
     C                     EXSR DBERR                                     CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     MOVELBKACCD    @ACOD                           CRT002
     C                     Z-ADD01        @ACSQ                           CRT002
     C                     MOVELBBACOC    @ACOF                           176510
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
      ** if not entered display message
     C                     ELSE
     C                     SETON                     31
     C                     MOVE 'USR0076' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** If no validation errors, get currency details
     C           *IN69     IFEQ '0'
     C                     MOVE SCCY      @TCCY
     C                     MOVE SCCY      @CCY
     C                     EXSR RTCCYS
      *
     C           SCCY      IFEQ '?'
     C                     MOVEL@CURR     SCCY
     C                     ENDIF
      *
     C************IN80     IFEQ '0'                                       140802
     C           @RTCD     IFEQ *BLANKS                                   140802
     C                     Z-ADDTDP,@I    @CYDP
     C                     MOVELTMD,@I    @CYMD   1                       CRT002
     C                     Z-ADDTDP,@I    @TCDP
     C                     MOVELTMD,@I    @TCMD
     C                     Z-ADDTRT,@I    @TCRT
     C                     Z-ADD@TCRT     @TCSP  138                      CRT002
      *                                                                   CEU024
      ** Check if EMU Retail Teller Support Enhancement is installed      CEU024
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
      *                                                                   CEU024
     C           TEU,@I    IFEQ *BLANKS                                   CEU024
     C                     EXSR SREURO                                    CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     MOVE TEU,@I    WTCCY   1                       CEU024
     C           SCCY      IFEQ BKEURO                                    151260
     C                     MOVE 'E'       WTCCY                           151260
     C                     ENDIF                                          151260
     C                     Z-ADDEUR,@I    WTRAT  138                      CEU024
     C                     MOVE EUI,@I    WTIND   1                       CEU024
     C                     Z-ADDSTP,@I    WTSTP   50                      CEU024
     C                     Z-ADDETP,@I    WTETP   50                      CEU024
      *                                                                   CEU024
     C                     ENDIF                                          CEU024
      *
      ** if currency not present in the currency table,display error
     C                     ELSE
     C                     SETON                     31
     C                     MOVE 'USR0049' @MSGID
     C                     EXSR SNDMSG
     C                     MOVEL*BLANKS   @RTCD
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSCSAM - Validate cheque amount                    *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            ZALIGN - Validate amount fields                    *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSCSAM    BEGSR                           ** VSCSAM **
      *
     C                     SETOF                     32
      *
      ** Check if amount field is entered
     C           SCSAM     IFNE ' '
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C                     MOVE SCSAM     ZFIELD                          CRT002
     C                     Z-ADD@CYDP     ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    SCSAM                           CRT002
     C                     ENDIF                                          CRT002
      *
      ** Set up decimal values
     C                     Z-ADD@CYDP     ZADEC
     C           13        SUB  @CYDP     ZADIG
      *
      ** Align amount
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SCSAM     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @TRNAM 130
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     32
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
      **  Set H@AMT for checking the travellers cheque amt.  Insert       CRT002
      **  the decimal point in the right aligned amt value.               CRT002
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JW'                                     CRT002
     C           *IN32     ANDEQ'0'                                       CRT002
     C                     MOVE *BLANKS   H@AMT                           CRT002
     C                     MOVE *BLANKS   ZFIELD                          CRT002
     C                     MOVE @TRNAM    ZFIELD                          CRT002
     C                     Z-ADD@CYDP     ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    H@AMT                           CRT002
     C                     END                                            CRT002
      *
      ** Amount must not be blank or zero
     C                     ELSE
     C                     SETON                     32
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSVLDT - Validate value date                       *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            ZDATE1 - Validate dates submitted and convert to a *
      *                     number of days                            *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSVLDT    BEGSR                           ** VSVLDT **
      *
     C                     SETOF                     33
      *
      ** to be validated if entered
     C           SVLDT     IFNE *BLANK
     C                     MOVE SVLDT     ZDATE
      *
     C                     EXSR ZDATE1
      *
     C           *IN99     IFNE '1'
     C                     MOVE ZDAYNO    @VLDN   50
      *
      ** must not be prior to date of account opening
     C           @VLDN     IFLT @DACO
     C                     SETON                     33
     C                     MOVEL'USR0056' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN33     ANDEQ'1'                                       CRT002
     C                     GOTO VSVLD9                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** must not be later than midas run date
     C           @VLDN     IFGT BJRDNB
     C                     SETON                     33
     C                     MOVEL'USR0088' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN33     ANDEQ'1'                                       CRT002
     C                     GOTO VSVLD9                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** must not be equal to midas run date if a/c closure requested
     C           *IN40     IFEQ '1'
     C           @VLDN     ANDNEBJRDNB
     C                     SETON                     33
     C                     MOVEL'USR0058' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ELSE
      *
      ** if invalid date i.e. 99 is on
     C                     SETON                     33
     C                     MOVEL'USR0009' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ELSE
      *
      ** if date not entered move midas run date
     C                     Z-ADDBJRDNB    @VLDN
     C                     END
      *
     C           VSVLD9    TAG                                            CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSEXRT - Validate exchange rate                    *
      *                                                               *
      * CALLS      ZALIGN - Validate amount fields                    *
      *            SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSEXRT    BEGSR                           ** VSEXRT **
      *
     C                     SETOF                     34
      *                                                                   CEU024
      ** Check if EMU Retail Teller Support Enhancement is installed      CEU024
      *                                                                   CEU024
     C                     MOVE *BLANKS   @BDCD   1                       CEU024
     C                     MOVE *BLANK    WEXDF   1                       CEU024
     C                     MOVE *BLANKS   WAINCY  1                       CEU024
     C                     MOVE *BLANKS   WTINCY  1                       CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C           *IN31     ANDEQ*OFF                                      CEU024
     C           *IN33     ANDEQ*OFF                                      CEU024
      *                                                                   CEU024
     C                     MOVE *BLANKS   WRTDF   1                       CEU024
      *                                                                   CEU024
     C           WACCY     IFEQ 'Y'                                       CEU024
     C           @VLDN     ANDGEWASTP                                     CEU024
     C********** @VLDN     ANDLEWAETP                              CEU024 190687
     C                     MOVE 'Y'       WAINCY                          CEU024
     C                     ENDIF                                          CEU024
     C           WTCCY     IFEQ 'Y'                                       CEU024
     C           @VLDN     ANDGEWTSTP                                     CEU024
     C********** @VLDN     ANDLEWTETP                              CEU024 190687
     C                     MOVE 'Y'       WTINCY                          CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C           WAINCY    IFEQ 'Y'                                       CEU024
     C           WTINCY    ANDEQ'Y'                                       CEU024
     C           WACCY     OREQ 'E'                                       CEU024
     C           WTINCY    ANDEQ'Y'                                       CEU024
     C           WAINCY    OREQ 'Y'                                       CEU024
     C           WTCCY     ANDEQ'E'                                       CEU024
      *                                                                   CEU024
     C                     MOVE 'Y'       WRTDF                           CEU024
     C                     MOVE 'Y'       WEXDF                           CEU024
      *                                                                   CEU024
     C***********CRT104    IFEQ 'Y'                                CEU024 147915
     C***********          EXSR INSRAT                             CEU024 147915
     C***********          ELSE                                    CEU024 147915
     C***********          SELEC                                   146200 147915
     C***********ACCY      WHEQ BKEURO                             146200 147915
     C***********          Z-ADDWTRAT     ZRATEX                   146200 147915
      ***********                                                  146200 147915
     C***********SCCY      WHEQ BKEURO                             146200 147915
     C***********          Z-ADDWARAT     ZRATEX                   146200 147915
      ***********                                                  146200 147915
     C***********          OTHER                                   146200 147915
      *                                                                   147915
     C           ACCY      IFEQ BKEURO                                    147915
     C**********           Z-ADD1         WARAT                    147915 151260
     C                     Z-ADDWTRAT     W#RT                            151260
      *                                                                   147915
     C                     ELSE                                           147915
      *                                                                   147915
     C           SCCY      IFEQ BKEURO                                    147915
     C**********           Z-ADD1         WTRAT                    147915 151260
     C                     Z-ADDWARAT     W#RT                            151260
      *                                                                   151260
     C                     ELSE                                           151260
      *                                                                   151260
     C**********           ENDIF                                   147915 151260
      *                                                                   147915
     C**********           ENDIF                                   147915 151260
      *                                                                   147915
     C                     Z-ADDWTRAT     ZRATE1 138                      CEU024
     C                     MOVE WTIND     ZMDI1   1                       CEU024
     C                     Z-ADDWARAT     ZRATE2 138                      CEU024
     C                     MOVE WAIND     ZMDI2   1                       CEU024
     C**********           EXSR ZXRATE                             CEU024 151260
     C                     EXSR RTZXRT                                    151260
      *                                                                   CEU024
     C***********SCCY      IFNE BKEURO                             CEU024 146200
     C***********ACCY      ANDNEBKEURO                             CEU024 146200
     C********** ZMDIX     IFEQ 'D'                                CEU024 151260
     C********** 1         DIV  ZRATEX    ZRATEX                   CEU024 151260
     C**********           ENDIF                                   CEU024 151260
     C***********          ENDIF                                   CEU024 146200
     C***********          ENDSL                                   146200 147915
      *                                                                   146200
     C                     Z-ADDZRATEX    W#RT                            CEU024
      *                                                                   151260
     C                     ENDIF                                          151260
     C                     ENDIF                                          151260
      *                                                                   151260
     C                     MOVE *BLANKS   WRTDF                           CEU024
     C***********          ENDIF                                   CEU024 147915
      *                                                                   CEU024
     C           SEXRT     IFEQ *BLANKS                                   CEU024
     C                     MOVE *BLANKS   ZFIELD                          CEU024
     C                     MOVE W#RT      ZFIELD                          CEU024
     C                     Z-ADD8         ZADEC                           CEU024
     C                     EXSR ZEDIT                                     CEU024
     C                     MOVE ZFIELD    SEXRT                           CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     ENDIF                                          CEU024
     C                     ENDIF                                          CEU024
      *
     C           CRT104    IFEQ 'Y'
      *
      * If exchange rate is blank insert default one
     C           SEXRT     IFEQ *BLANKS
     C           SCCY      ANDNE*BLANKS
     C           *IN31     ANDEQ*OFF                                      CEU024
     C                     EXSR INSRAT
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Check if ex.rate field is blanks or zeros
     C           SEXRT     IFEQ *ZEROS
     C           SEXRT     OREQ *BLANKS
     C                     SETON                     3450
     C                     MOVE 'USR0089' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Set up decimal values
     C                     Z-ADD8         ZADEC
     C           13        SUB  ZADEC     ZADIG
      *
      ** Align amount - and move it to numeric field
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SEXRT     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @EXRT  138
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     3450
     C                     MOVE 'USR0089' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C           @EXRT     ANDNEW#RT                                      CEU024
     C           WEXDF     ANDEQ'Y'                                       CEU024
     C                     MOVE *ON       *IN34                           CEU024
     C                     MOVEL'USR0400' @MSGID                          CEU024
     C                     EXSR SNDMSG                                    CEU024
     C                     ENDIF                                          CEU024
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            INSRAT - Insert dafault exchange rate              *
      *                                                               *
      * CALLS      ZEDIT  - Insert decimal point                      *
      * CALLED BY  VSEXRT - Validate exchange rate                    *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           INSRAT    BEGSR
     C                     OPEN REBDCCPD
      *
     C                     OPEN REBDCRPD
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JR'                                     CRT002
     C                     MOVEL'0JK'     WKEY                            CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JW'                                     CRT002
     C                     MOVEL'0JL'     WKEY                            CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JS'                                     CRT002
     C           PFNCD     OREQ '0JX'                                     CRT002
     C                     MOVEL'0JI'     WKEY                            CRT002
      *                                                                   CRT002
     C                     OTHER                                          CRT002
      *                                                                   CRT002
     C                     MOVELPFNCD     WKEY    3                       CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *
      ** Find function code in Exchange Rate Control Table
     C***********PFNCD     CHAINREBDCCD0             70                   CRT002
     C           WKEY      CHAINREBDCCD0             70                   CRT002
      *
      ** If record not found?
     C           *IN70     IFEQ *ON
      *                                                                   140255
     C                     GOTO INSEND                     Just return    140255
      *                                                    blank rate.    140255
     C************LOCK     IN   LDA                        ***************140255
     C***********          Z-ADD22        DBASE            ** DB ERR 22 * 140255
     C***********          MOVE 'REBDCCPD'DBFILE           ***************140255
     C***********          MOVELPFNCD     DBKEY                           140255
     C***********          EXSR DBERR                                     140255
     C                     END
      *
      ** Check if trans. currency or account currency are not base one
     C           SCCY      IFNE @BSCY
     C           SCCY2     ANDNE@BSCY
      *
      ** Find Transaction Currency in Currency Details Extension File
     C           SCCY      CHAINREBDCRD0             70
      *
      ** If record not found?
     C           *IN70     IFEQ *ON
     C           *LOCK     IN   LDA                        **************
     C                     Z-ADD23        DBASE            ** DB ERR 23 **
     C                     MOVE 'REBDCRPD'DBFILE           ***************
     C                     MOVELSCCY      DBKEY
     C                     EXSR DBERR
     C                     ENDIF
      *
      ** Move exchange rate in accordance with function and currency codes
     C                     Z-ADD0         W#RT   138
     C                     SELEC
     C           NAC       WHEQ 'DN'
     C           FEDNRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'DP'
     C           FEDPRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'DS'
     C           FEDSRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VN'
     C           FEVNRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VP'
     C           FEVPRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VS'
     C           FEVSRT    DIV  FEAMNT    W#RT      H
     C                     ENDSL
      *
      ** Find Account Currency in Currency Details Extension File
     C           SCCY2     CHAINREBDCRD0             70
      *
      ** If record not found?
     C           *IN70     IFEQ *ON
     C           *LOCK     IN   LDA                        **************
     C                     Z-ADD24        DBASE            ** DB ERR 24 *
     C                     MOVE 'REBDCRPD'DBFILE           **************
     C                     MOVELSCCY2     DBKEY
     C                     EXSR DBERR
     C                     ENDIF
      *
      ** Move exchange rate in accordance with function and currency codes
     C                     Z-ADD0         W#RT2  138
     C                     SELEC
     C           ACC       WHEQ 'DN'
     C           FEDNRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'DP'
     C           FEDPRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'DS'
     C           FEDSRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'VN'
     C           FEVNRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'VP'
     C           FEVPRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'VS'
     C           FEVSRT    DIV  FEAMNT    W#RT2     H
     C                     ENDSL
      *
      ** Calculate Exchange Rate through Basic Currency
     C********** W#RT      DIV  W#RT2     W#RT      H                     150864
      *                                                                   150864
      * Don't assume B de C rates are multiply                            150864
     C                     Z-ADDW#RT      ZRATE1                          150864
     C                     MOVE @CYMD     ZMDI1                           150864
     C                     Z-ADDW#RT2     ZRATE2                          150864
     C                     MOVE @EQMD     ZMDI2                           150864
     C                     EXSR RTZXRT                                    150864
     C                     Z-ADDZRATEX    W#RT                            150864
      *
     C                     ELSE
      *
      ** If Transaction Currency is Basic one, look for Account Curr. Det
     C           SCCY      IFEQ @BSCY
     C           SCCY2     CHAINREBDCRD0             70
      *
      ** If record not found?
     C           *IN70     IFEQ *ON
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD25        DBASE            ** DB ERR 25 **
     C                     MOVE 'REDBCRPD'DBFILE           ***************
     C                     MOVELSCCY2     DBKEY
     C                     EXSR DBERR
     C                     ENDIF
      *
     C                     Z-ADD0         W#RT   138
     C                     SELEC
     C           ACC       WHEQ 'DN'
     C           FEDNRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'DP'
     C           FEDPRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'DS'
     C           FEDSRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'VN'
     C           FEVNRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'VP'
     C           FEVPRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'VS'
     C           FEVSRT    DIV  FEAMNT    W#RT      H
     C                     ENDSL
      *
     C                     ELSE
      *
      ** Else look for Transaction Currency details
     C           SCCY      CHAINREBDCRD0             70
      *
      ** If record not found?
     C           *IN70     IFEQ *ON
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD26        DBASE            ** DB ERR 26 *
     C                     MOVE 'REBRCRPD'DBFILE           ***************
     C                     MOVELSCCY      DBKEY
     C                     EXSR DBERR
     C                     ENDIF
      *
      ** Move exchange rate in accordance with function and currency codes
     C                     Z-ADD0         W#RT   138
     C                     SELEC
     C           NAC       WHEQ 'DN'
     C           FEDNRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'DP'
     C           FEDPRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'DS'
     C           FEDSRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VN'
     C           FEVNRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VP'
     C           FEVPRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VS'
     C           FEVSRT    DIV  FEAMNT    W#RT      H
     C                     ENDSL
     C                     ENDIF
      *
     C                     ENDIF
      *                                                                   CEU024
      ** Check if EMU Retail Teller Support Enhancement is Installed      CEU024
      ** and WRTDF is set to 'Y'                                          CEU024
      *                                                                   CEU024
     C           CEU024    IFEQ 'N'                                       CEU024
     C           CEU024    OREQ 'Y'                                       CEU024
     C           WRTDF     ANDNE'Y'                                       CEU024
      *
      ** Insert decimal point
     C                     MOVEL*BLANKS   ZFIELD
     C                     MOVE W#RT      ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SEXRT
     C                     ENDIF                                          CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C                     MOVE 'Y'       @BDCD                           CEU024
     C                     ENDIF                                          CEU024
      *
     C           INSEND    TAG                                            140255
      *                                                                   140255
     C                     CLOSEREBDCCPD
     C                     CLOSEREBDCRPD
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSCQNF - Validate check number                     *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSCQNF    BEGSR                           ** VSCQNF **
      *
     C                     SETOF                     35
      *
      ** If cheque reference is numeric?
     C                     TESTN          SCQNF      59
     C           *IN59     IFNE '1'
     C           SCQNF     OREQ *ZEROS
      *
     C                     MOVE 'USR0053' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     35
     C*
     C                     ELSE
     C                     MOVELSCQNF     @CQNF
     C*
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSDEPC - Validate department code                  *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSDEPC    BEGSR                           ** VSDEPC **
      *
     C                     SETOF                     37
      *
      ** If department code is not blank
     C           SDEPC     IFNE *BLANK
      *
      ** Get department code details
     C*
     C                     CALL 'AODEPTR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           SDEPC
     C           SDDEPT    PARM SDDEPT    DSFDY
      *
      ** If record not found
     C           @RTCD     IFNE *BLANK
     C                     MOVE 'USR0054' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     37
     C                     END
      *
      ** Department code is required
     C                     ELSE
     C                     MOVE 'USR0055' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     37
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN69     ANDEQ'1'                                       CRT002
     C                     GOTO VSDEP9                                    CRT002
     C                     ENDIF                                          CRT002
     C*
     C*  Validate the input Profit Centre if entered
     C*
     C                     SETOF                     44                   098166
      *                                                                   098166
     C           PFCU      IFEQ 'Y'
     C*
     C           SPRFC     IFNE *BLANK
     C                     MOVE *BLANKS   @KEY
     C                     CALL 'AOPRFCR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY    '@OPTN   7
     C                     PARM SPRFC     @KEY4   4
     C           SDPRFC    PARM SDPRFC    DSFDY
     C*
     C           @RTCD     IFNE *BLANK
     C                     MOVE 'USR1199' @MSGID
     C                     EXSR SNDMSG
     C***********          SETON                     38                   098166
     C                     SETON                     44                   098166
     C                     ELSE
     C                     MOVE DSPCCD    SPRFC
     C                     MOVE SPRFC     PRFC
     C                     END
     C*
     C                     ELSE
     C*
     C                     MOVE @CNUM     @CNUM1  6
     C           PFCD      IFEQ 'Y'
     C                     CALL 'AOPRFMR0'
     C                     PARM *BLANKS   @RTC1   1
     C**********           PARM A1RTTY    @BOOK   2                       201732
     C                     PARM *BLANKS   @BOOK   2                       201732
     C                     PARM *BLANKS   @TRPT   5
     C                     PARM *BLANKS   @SUTP   2
     C**********           PARM *BLANKS   @BRAN   3                       201732
     C                     PARM PTLBC     @BRAN   3                       201732
     C                     PARM SDEPC     @DEPT   3
     C                     PARM USRPRF    @USRID 10
     C*******************  PARM *BLANKS   @ACOF   2                       176510
     C                     PARM           @ACOF   2                       176510
     C                     PARM           @CNUM1
     C                     PARM *BLANKS   @PRFC   4
     C*
     C                     SELEC
     C           @RTC1     WHEQ '0'
     C                     MOVE @PRFC     SPRFC
     C                     MOVE SPRFC     PRFC
     C           @RTC1     WHEQ '2'
     C           @RTC1     OREQ '1'                                       098166
     C                     MOVE @PRFC     SPRFC
     C                     MOVE 'USR1199' @MSGID
     C                     EXSR SNDMSG
     C***********          SETON                     38                   098166
     C                     SETON                     44                   098166
     C                     ENDSL
      *                                                                   098166
      **  Else, if default profit centre usage is off and profit centre   098166
      **  is blank, then error.                                           098166
      *                                                                   098166
     C                     ELSE                                           098166
     C                     MOVE 'USR1199' @MSGID                          098166
     C                     MOVE '1'       *IN44                           098166
     C                     EXSR SNDMSG                                    098166
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C           VSDEP9    TAG                                            CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALTRN - Validate transaction                      *
      *                                                               *
      * CALLS      VSCQNF - Validate check number                     *
      *            VSVLDT - Validate value date                       *
      *            VSCSAM - Validate cheque amount                    *
      *            VSDEPC - Validate department code                  *
      *            VSCHRG - Validate charge fields                    *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALTRN    BEGSR                           ** VALTRN **
      *                                                                   CRT002
     C                     Z-ADD0         @RDAM  150                      CRT002
     C                     Z-ADD0         @PYAM  150                      CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
      *
      ** Validate currency code
     C                     EXSR VSCCY
      *
      ** Validate cheque amount
     C                     EXSR VSCSAM
      *
      ** Validate value date
     C                     EXSR VSVLDT
      *
      ** Validate exchange rate
     C                     EXSR VSEXRT
      *
      ** Validate cheque number
      *                                                                   CRT002
     C           PFNCD     IFNE '0JW'                                     CRT002
     C                     EXSR VSCQNF
     C                     END                                            CRT002
      *
      ** Validate department code
     C                     EXSR VSDEPC
      *
     C                     EXSR VSCHRG
      *                                                                   CRT002
      **  Validate chq issuer no, chq serial no, and chq amt              CRT002
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JW'                                     CRT002
      *                                                                   CRT002
     C                     MOVE '0'       *IN46                           CRT002
     C                     MOVE '0'       *IN47                           CRT002
     C                     MOVE '0'       *IN49                           CRT002
      *                                                                   CRT002
      **  Validate Cheque issuer no.                                      CRT002
      *                                                                   CRT002
     C           SCIN      IFNE *BLANKS                                   CRT002
     C           SCIN      ANDNE*ZEROS                                    CRT002
      *                                                                   CRT002
      **  Resolve ? before validation                                     CRT002
      *                                                                   CRT002
     C           '?'       LOKUPINP                      51               CRT002
      *                                                                   CRT002
     C           *IN51     IFEQ '1'                                       CRT002
     C                     CALL 'AOCUSTR0'                                CRT002
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*KEY'    @OPTN   7                       CRT002
     C                     PARM '?'       @KEY1  10                       CRT002
     C                     PARM *BLANKS   @KYST   7                       CRT002
     C           SDCUST    PARM SDCUST    DSSDY                           CRT002
      *                                                                   CRT002
      **  If selection made, move value to screen field                   CRT002
      *                                                                   CRT002
     C           @RTCD     IFEQ *BLANKS                                   CRT002
     C                     MOVELBBCUST    SCIN                            CRT002
     C                     ELSE                                           CRT002
     C                     MOVE *BLANKS   SCIN                            CRT002
     C                     END                                            CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  If issuer selected through '?', bypass validation               CRT002
      *                                                                   CRT002
     C           *IN51     IFNE '1'                                       CRT002
     C                     CALL 'AOCUSTR0'                                CRT002
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*KEY'    @OPTN   7                       CRT002
     C                     PARM SCIN      @KEY1  10                       CRT002
     C                     PARM *BLANKS   @KYST   7                       CRT002
     C           SDCUST    PARM SDCUST    DSSDY                           CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           @KYST     OREQ '*SHNAME'                                 CRT002
     C                     MOVE '1'       *IN46                           CRT002
     C                     MOVE 'USR1025' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     END                                            CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C           SCIN      IFEQ *BLANKS                                   CRT002
     C           SCIN      OREQ *ZEROS                                    CRT002
     C                     MOVE '1'       *IN46                           CRT002
     C                     MOVE 'USR0083' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Validate the cheque serial no and amount                        CRT002
      *                                                                   CRT002
     C           *IN46     IFEQ '0'                                       CRT002
     C           *IN31     ANDEQ'0'                                       CRT002
     C           *IN32     ANDEQ'0'                                       CRT002
     C                     MOVELSCIN      H@CIN                           CRT002
     C                     MOVELSCCY      H@CCY                           CRT002
     C                     MOVELH@AMT     H@AMT                           CRT002
     C                     MOVELSCSN      H@CSN                           CRT002
     C                     Z-ADD@CYDP     H@NDC                           CRT002
     C                     EXSR VALCQS                                    CRT002
     C                     MOVE *IN49     *IN32                           CRT002
     C                     MOVE '0'       *IN53                           180663
     C                     MOVE '0'       *IN54                           180663
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     END                             {0JW}          CRT002
      *                                                                   CRT002
      **  P mode                                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'P'                                       CRT002
      *                                                                   CRT002
      **  Validate currency code                                          CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSCCY                                     CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Validate cheque amount                                          CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSCSAM                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Validate round currency flag.                                   CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSRDCY                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Validate pay/receive flag.                                      CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSPYRC                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Validate round amount.                                          CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSRDAM                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Validate pay/receive amount.                                    CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSPRAM                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Validate value date                                             CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSVLDT                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Validate cheque number                                          CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C           PFNCD     ANDNE'0JW'                                     CRT002
     C                     EXSR VSCQNF                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Validate department code                                        CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSDEPC                                    CRT002
     C                     END                                            CRT002
      *                                                                   118133
      **  Format charge details                                           118133
      *                                                                   118133
     C           *IN69     IFEQ '0'                                       118133
     C                     EXSR FMTCHG                                    118133
     C                     ENDIF                                          118133
      *                                                                   CRT002
      **  Validate charge details                                         CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '0'                                       CRT002
     C                     EXSR VSCHRG                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Validate chq issuer no, chq serial no, and chq amt              CRT002
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JW'                                     CRT002
     C           *IN69     ANDEQ'0'                                       CRT002
      *                                                                   CRT002
     C                     MOVE '0'       *IN46                           CRT002
     C                     MOVE '0'       *IN47                           CRT002
     C                     MOVE '0'       *IN49                           CRT002
      *                                                                   CRT002
      **  Validate Cheque issuer no.                                      CRT002
      *                                                                   CRT002
     C           SCIN      IFNE *BLANKS                                   CRT002
     C           SCIN      ANDNE*ZEROS                                    CRT002
      *                                                                   CRT002
     C           '?'       LOKUPINP                      51               CRT002
      *                                                                   CRT002
     C           *IN51     IFEQ '1'                                       CRT002
     C                     MOVE '1'       *IN46                           CRT002
     C                     MOVE 'USR1025' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
     C                     CALL 'AOCUSTR0'                                CRT002
     C                     PARM *BLANKS   @RTCD   7                       CRT002
     C                     PARM '*KEY'    @OPTN   7                       CRT002
     C                     PARM SCIN      @KEY1  10                       CRT002
     C                     PARM *BLANKS   @KYST   7                       CRT002
     C           SDCUST    PARM SDCUST    DSSDY                           CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           @KYST     OREQ '*SHNAME'                                 CRT002
     C                     MOVE '1'       *IN46                           CRT002
     C                     MOVE 'USR1025' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     END                                            CRT002
     C                     END                                            CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C           SCIN      IFEQ *BLANKS                                   CRT002
     C           SCIN      OREQ *ZEROS                                    CRT002
     C                     MOVE '1'       *IN46                           CRT002
     C                     MOVE 'USR0083' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Validate the cheque serial no and amount                        CRT002
      *                                                                   CRT002
     C           *IN46     IFEQ '0'                                       CRT002
     C           *IN31     ANDEQ'0'                                       CRT002
     C           *IN32     ANDEQ'0'                                       CRT002
     C                     MOVELSCIN      H@CIN                           CRT002
     C                     MOVELSCCY      H@CCY                           CRT002
     C                     MOVELH@AMT     H@AMT                           CRT002
     C                     MOVELSCSN      H@CSN                           CRT002
     C                     Z-ADD@CYDP     H@NDC                           CRT002
     C                     Z-ADD0         ZADEC                           184553
     C                     Z-ADD3         ZADIG                           184553
     C                     MOVE *BLANKS   ZFIELD                          184553
     C                     MOVE WCHQNM    ZFIELD                          184553
     C                     EXSR ZALIGN                                    184553
     C                     MOVE ZFIELD    WCQNUM  30                      184553
     C                     EXSR VALCQS                                    CRT002
     C                     MOVE *IN49     *IN32                           CRT002
     C                     MOVE '0'       *IN53                           180663
     C                     MOVE '0'       *IN54                           180663
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     END                             {0JW}          CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            VSRDCY - Validate round currency flag.             *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY         -                                           *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           VSRDCY    BEGSR                           ** VSRDCY **   CRT002
      *                                                                   CRT002
     C           WRDCY     IFNE *BLANK                                    CRT002
     C           WRDCY     ANDNE'1'                                       CRT002
     C           WRDCY     ANDNE'2'                                       CRT002
     C                     SETON                     61                   CRT002
     C                     MOVEL'USR0152' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           WRDAM     IFNE *ZEROS                                    CRT002
     C           WRDAM     ANDNE*BLANKS                                   120885
     C           WRDCY     ANDNE'1'                                       CRT002
     C           WRDCY     ANDNE'2'                                       CRT002
     C                     SETON                     61                   CRT002
     C                     MOVEL'USR0153' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   118131
     C           WRDAM     IFEQ *ZEROS                                    118131
     C           WRDAM     OREQ *BLANKS                                   118131
     C                     MOVEL*BLANK    WRDCY                           118131
     C                     ENDIF                                          118131
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            VSPYRC - Validate pay/receive flag.                *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY         -                                           *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           VSPYRC    BEGSR                           ** VSPYRC **   CRT002
      *                                                                   CRT002
     C           WPYRC     IFNE *BLANK                                    CRT002
     C           WPYRC     ANDNE'P'                                       CRT002
     C           WPYRC     ANDNE'R'                                       CRT002
     C                     SETON                     62                   CRT002
     C                     MOVEL'USR0154' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           WPRAM     IFNE *ZEROS                                    CRT002
     C           WPRAM     ANDNE*BLANKS                                   120885
     C           WPYRC     ANDNE'P'                                       CRT002
     C           WPYRC     ANDNE'R'                                       CRT002
     C                     SETON                     62                   CRT002
     C                     MOVEL'USR0155' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   118131
     C           WPRAM     IFEQ *ZEROS                                    118131
     C           WPRAM     OREQ *BLANKS                                   118131
     C                     MOVEL*BLANK    WPYRC                           118131
     C                     ENDIF                                          118131
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            VSRDAM - Validate round amount.                    *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY         -                                           *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           VSRDAM    BEGSR                           ** VSRDAM **   CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   WAMT   15                       CRT002
     C                     Z-ADD0         @DEC    10                      CRT002
     C                     Z-ADD0         @RDAM  150                      CRT002
      *                                                                   CRT002
     C                     MOVE WRDAM     WAMT                            CRT002
     C           WRDCY     IFEQ '1'                                       CRT002
     C                     Z-ADD@CYDP     @DEC                            CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD@EQDP     @DEC                            CRT002
     C                     ENDIF                                          CRT002
     C                     EXSR NUMCHK                                    CRT002
     C           *IN69     IFEQ '1'                                       CRT002
     C                     MOVEL'1'       *IN63                           CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD@AMT      @RDAM                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            VSPRAM - Validate pay/receive amount.              *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY         -                                           *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           VSPRAM    BEGSR                           ** VSPRAM **   CRT002
      *                                                                   CRT002
     C                     Z-ADD0         @PYAM  150                      CRT002
      *                                                                   CRT002
     C                     MOVE WPRAM     WAMT                            CRT002
     C                     Z-ADD@BDEC     @DEC                            CRT002
     C                     EXSR NUMCHK                                    CRT002
     C           *IN69     IFEQ '1'                                       CRT002
     C                     MOVEL'1'       *IN64                           CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD@AMT      @PYAM                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            NUMCHK - Check if amount passed is numeric.        *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY  VALDET - Validate details                          *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           NUMCHK    BEGSR                           ** NUMCHK **   CRT002
      *                                                                   CRT002
     C                     Z-ADD0         @AMT                            CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C                     MOVE WAMT      ZFIELD                          CRT002
     C                     Z-ADD@DEC      ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    WAMT                            CRT002
      *                                                                   CRT002
     C           WAMT      IFEQ *BLANKS                                   CRT002
     C                     SETON                       69                 CRT002
     C                     MOVE 'USR0008' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      ** Set up decimal values                                            CRT002
      *                                                                   CRT002
     C                     Z-ADD@DEC      ZADEC                           CRT002
     C           13        SUB  @DEC      ZADIG                           CRT002
      *                                                                   CRT002
      ** Align amount - and move it to numeric field                      CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANK    ZFIELD                          CRT002
     C                     MOVE WAMT      ZFIELD                          CRT002
     C                     EXSR ZALIGN                                    CRT002
     C                     MOVE ZFIELD    @AMT   150                      CRT002
      *                                                                   CRT002
      ** If error found?  Set up error message                            CRT002
      *                                                                   CRT002
     C           *IN99     IFEQ '1'                                       CRT002
     C                     SETON                       69                 CRT002
     C                     MOVE 'USR0008' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSCHRG - Validate charge fields                    *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            ZALIGN - Validate amount fields                    *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSCHRG    BEGSR                           ** VSCHRG **
      *
     C                     SETOF                     15
     C                     SETOF                     171819
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     Z-ADD0         @TCHG  150
     C                     ENDIF                                          CRT002
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP14                                           S01408
     C*                                                                   S01408
      *
      ** Exit validation if no fields are entered
     C           SCTRTY    IFEQ *BLANK
     C           SCPER     ANDEQ*BLANK
     C           SCAMT     ANDEQ*BLANK
     C           PMODE     OREQ 'P'                                       171139
     C           SCTRTY    ANDNE*BLANK                                    171139
     C           SCPER     ANDEQ*BLANK                                    171139
     C           SCAMT     ANDEQ*BLANK                                    171139
     C                     GOTO VSCHRX
     C                     END
      *
      ** Can not enter both percent. and amount field
     C           SCPER     IFNE *BLANK
     C           SCAMT     ANDNE*BLANK
     C                     SETON                     171969
     C                     MOVE 'USR0206' @MSGID
     C                     EXSR SNDMSG
     C                     GOTO VSCHRX
     C                     END
      *
      ** If trans. type entered either percent or amount must also be
      ** entered
     C           SCTRTY    IFNE *BLANK
     C           SCPER     IFEQ *BLANK
     C           SCAMT     ANDEQ*BLANK
     C                     SETON                     171969
     C                     MOVE 'USR0210' @MSGID
     C                     EXSR SNDMSG
     C                     GOTO VSCHRX
     C                     END
      *
     C                     ELSE
      ** else percent and amount must both be blank
     C           SCPER     IFNE *BLANK
     C           SCAMT     ORNE *BLANK
     C                     SETON                     171969
     C                     MOVE 'USR0211' @MSGID
     C                     EXSR SNDMSG
     C                     GOTO VSCHRX
     C                     END
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP15                                           S01408
     C*                                                                   S01408
      *
      *
      ** Transaction type must exist
     C*
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C           SCTRTY    PARM SCTRTY    @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record does not exist or is deleted -
     C           @RTCD     IFNE *BLANKS
     C                     SETON                     1869
     C                     MOVEL'USR0086' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP16                                           S01408
     C*                                                                   S01408
      *
      ** Transaction type must be debit only
     C           A1DCIN    IFNE 'D'
     C                     SETON                     1869
     C                     MOVEL'USR0087' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Associated GL code must be set up
     C           A1ASGL    IFEQ *BLANKS
     C                     SETON                     1869
     C                     MOVEL'USR0106' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
     C                     END
      *
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN69     ANDEQ'1'                                       CRT002
     C                     GOTO VSCHRX                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** Charge percentage
      *
      ** Validate percent charge if entered
      *
     C           SCPER     IFNE *BLANKS
      *
      ** Set up decimal values to align amount & move to numeric field
     C                     Z-ADD2         ZADEC
     C                     Z-ADD2         ZADIG
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SCPER     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @CHPER  50
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     1969
     C                     MOVE 'USR0203' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** If there are no errors - edit the field - insert dec.pt
     C           *IN19     IFEQ '0'
     C                     Z-ADD2         ZDECS
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @CHPER    ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @PERDS
     C                     MOVE *BLANKS   SCPER
     C                     MOVE ZOUT22    @PERDS
     C                     MOVEL@SCPER    SCPER
      *
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN69     ANDEQ'1'                                       CRT002
     C                     GOTO VSCHRX                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** Validate charge amount if entered
      *
     C           SCAMT     IFNE *BLANKS
      *
      ** Set up decimal values
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     Z-ADD@EQDP     ZADEC
     C           13        SUB  ZADEC     ZADIG
      *
      ** Align amount - and move it to numeric field
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SCAMT     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @TCHG
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     1769
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
     C                     END
      *
     C           VSCHRX    ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            EXTDET - Exit details    screen                    *
      *                                                               *
      * CALLS      RFRDET - Refresh details    screen                 *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           EXTDET    BEGSR                           ** EXTDET **
      *
      ** Clear details    screen
     C                     EXSR RFRDET
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *           SNDMSG  - Send program message parameters           *
      *                                                               *
      * CALLS     SCC0240 - Send message to program queue             *
      *                                                               *
      * CALLED BY  DSPBAL - Display account balances                  *
      *            VALOVR - Validate override                         *
      *            VSACNO - Validate account number                   *
      *            VSCCY  - Validate currency code                    *
      *            VSCQNF - Validate check number                     *
      *            VSCSAM - Validate cheque amount                    *
      *            VSVLDT - Validate value date                       *
      *            VSDEPC - Validate department code                  *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED  @MSGID - Message id                                *
      *            @MSGF  - Message file                              *
      *                                                               *
      *****************************************************************
     C           SNDMSG    BEGSR                           ** SNDMSG **
      *
     C                     SETON                     69
      *
     C                     CALL 'SCC0240'
     C                     PARM           @MSGID
     C                     PARM           @MSGF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRINL - Refresh initial screen                    *
      *                                                               *
      * CALLS      RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *            WRKACC - Work with account                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRINL    BEGSR                           ** RFRINL **
      *
     C                     SETOF                     303132
     C                     SETOF                     3334
     C                     SETOF                     353740
     C                     SETOF                     8182
     C                     MOVE *BLANKS   SACNO1
     C                     MOVE *BLANKS   SCCY1   3
     C                     MOVE ' '       @CLOS
      *
     C           *INKE     IFEQ '1'
     C           @TI       OREQ 0
     C                     EXSR RFRERR
     C      KE             SETOF                     454142
     C                     END
      *
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     EXSR RFRDET                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VACCLO - Validate account closure                  *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VACCLO    BEGSR                           ** VACCLO **
      *
      ** Access shadow balances
     C***********@RRNM*****CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
     C** Chain access object AOMEMSR0                                     CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANK    W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' W0OPTN           O:Option       CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM SCCY1     W0CCY   3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACDD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACDD 100                                          CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
      ** If record not found?
     C************IN70*****IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE *BLANK                                    CCB002
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD4         DBASE            ** DB ERR 04 **
     C*********************MOVE 'MEMOS  ' DBFILE           ***************CCB002
     C*********************MOVEL@RRNM     DBKEY                           CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C                     MOVEL@ACNOM    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      *
      ** Release record
     C*********************EXCPT@RLMEM                                    CCB002
      *
      ** Add interest rate to cleared balances and store it
     C           @INTR     ADD  CLBLN     @WKBL  150
      *
      ** Add service charges to the stored feild
     C                     ADD  @CHRG     @WKBL
      *                                                                   CCB002
      ** Add Transaction charge to the stored feild                       CCB002
     C                     ADD  @TCHG     @WKBL                           CCB002
     C                     ADD  @WTAX     @WKBL
      *
      ** Add service charges to the stored feild
     C                     ADD  @CNAM     @WKBL
      *                                                                   106661
      ** Include charge in check.                                         106661
     C                     ADD  @TCHG     @WKBL                           106661
      *
      ** If record not found?
     C           @WKBL     IFEQ 0
     C                     MOVE 'Y'       @CLOS
     C                     ELSE
     C                     MOVE 'N'       @CLOS
     C                     END
      *                                                                                       249968
      ** Initialise Skip Update Flag to 'N'                                                   249968
     C                     MOVEL'N'       @SKIP   1                                           249968
      *
      ** If Held Amount Item is Found                                                         249968
     C           KACO      CHAINHELDIHBF             62                                       249968
     C           *IN62     IFEQ '0'                                                           249968
     C                     MOVEL'USR2412' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVEL'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              248968
      *                                                                                       249968
      ** If Stopped Cheque is Found                                                           249968
     C           KACO      CHAINSTOPCSL3             61                                       249968
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2413' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVEL'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
      ** If Standing Orders is Found using Debit Retail Account                               249968
     C           KACO      CHAINSTANDSBF             61                                       249968
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2414' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVE 'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
      ** If Standing Orders is Found using Credit Retail Account                              249968
     C           KACO      CHAINSTANDSBG             61                                       249968
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2414' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVE 'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
      ** If SWEEP is Found                                                                    249968
      ** Check for Credit Sweep Account                                                       253689
      *                                                                                       253689
     C********** KSWEEP    CHAINRESWEPD0             61                                249968 253689
     C           KSWEEP    CHAINRESWEP5F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP2     CHAINRESWEP6F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP1     CHAINRESWEP7F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP2     CHAINRESWEP8F             61                                       253689
     C                     ENDIF                                                              253689
     C                     ENDIF                                                              253689
     C                     ENDIF                                                              253689
      *                                                                                       253689
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2415' WUMSID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVE 'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPDATE - Update control                            *
      *                                                               *
      * CALLS      UACCNT - Update accounts                           *
      *            UMEMOS - Update memos                              *
      *            UPDATE - Update control                            *
      *            UTNTM2 - Update teller controls                    *
      *            UTNTM3 - Update teller totals                      *
      *            UTRANT - Update teller transaction trailer         *
      *            WRSACM - Write shadow postings                     *
      *            WRSAC2 - Write shadow postings for Closure         *   106661
      *            WTRAND - Write teller transacton details           *
      *            WTTCHG - Write charge record                       *
      *            ZTNLU1 - Access dataarea for next transaction no.  *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UPDATE    BEGSR                           ** UPDATE **
      *
      ** Access and update next available transaction number
     C                     EXSR ZTNLU1
      *
     C                     TIME           STIME   60
     C                     Z-ADD@NATN     STTLU
      *
     C/COPY WNCPYSRC,RE4119C008
      ** Update all files
     C                     EXSR WTRAND
     C*                                                                   092429
     C** WRITE DETAILS TO THE NARRATIVE FILE                              092429
     C*                                                                   092429
     C                     EXSR NARRUP                                    092429
      *
     C                     EXSR UTRANT
      *
     C                     EXSR UTNTM2
      *
     C                     EXSR UTNTM3
      *                                                                   CRT002
      **  If transaction is not posted to suspense                        CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'N'                                       CRT002
      *
     C                     EXSR UMEMOS
      *                                                                   106661
      ** Write interest and charge records to RSACMTPD if required        106661
     C                     EXSR WRSAC2                                    106661
      *
     C                     EXSR WRSACM
     C/COPY WNCPYSRC,REH00189
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
     C                     EXSR UACCNT
      *
     C           PFNCD     IFNE '0JW'                                     CRT002
     C                     EXSR UCHQBK
     C                     END                                            CRT002
      *
     C           @TCHG     IFNE *ZERO
     C                     EXSR WTTCHG
     C                     END
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JW'                                     CRT002
     C/COPY WNCPYSRC,RE4119C009
      *                                                                   180663
      ** Process range of Travellers cheques by looping round existing    180663
      ** code for each cheque                                             180663
      *                                                                   180663
     C           KSERE     KLIST                                          180663
     C                     KFLD           ROISSU                          180663
     C                     KFLD           ROTCSN                          180663
     C                     Z-ADD0         @@AMT                           180663
      *                                                                   180663
      ** Replace purchased amount by denomination to comply with previous 180663
      ** processing.                                                      180663
      *                                                                   180663
     C                     Z-ADD@IVLN     @@IVLN 130                      180663
     C                     Z-ADDRNDNOM    @IVLN                           180663
     C**********           Z-ADDH@CINN    ROISSU                                       180663 CSD027
     C                     MOVELH@CINN    ROISSU                                              CSD027
      *                                                                   180663
      ** Process individual cheques bypassing existing ones               180663
      *                                                                   180663
     C           @@AMT     DOWLT@@IVLN                                    180663
     C**********           Z-ADDH@CINN    ROISSU                                       184553 CSD027
     C                     MOVELH@CINN    ROISSU                                              CSD027
     C                     Z-ADDH@CSNN    ROTCSN                          180663
     C           KSERE     CHAINRETCRDD0             70                   180663
     C           *IN70     IFEQ '1'                                       180663
     C                     EXSR WRTTCD                                    CRT002
      *                                                                   180663
      ** Update cheque book using correct starting number to allow for    180663
      ** previously used cheques and cheque books within range            180663
      *                                                                   180663
     C           KRCRE     SETLLRETCRCD0             71                   180663
     C           ROTCSN    DOUGERNSTCN                                    180663
     C           ROTCSN    ANDLERNETCN                                    180663
     C                     READ RETCRCD0                 71               180663
     C                     END                                            180663
      *                                                                   180663
      ** When cheque book has been found, update for each cheque          180663
      *                                                                   180663
     C           *IN71     IFEQ '0'                                       180663
     C                     EXSR UPDTCC                                    CRT002
     C/COPY WNCPYSRC,RE4119C011
     C                     END                                            180663
     C                     ADD  RNDNOM    @@AMT                           180663
     C                     END                                            180663
     C                     ADD  1         H@CSNN                          180663
     C                     END                                            180663
     C*                                                                   180663
     C                     END                                            CRT002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WTRAND - Write teller transacton details           *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WTRAND    BEGSR                           ** WTRAND **
      *                                                                   CRT002
      **  If not the first time, delete previous overrides                CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C           @CMD      IFNE *BLANKS                                   CRT002
     C                     MOVEL*BLANKS   @CMD                            CRT002
     C                     MOVEL@TXT,3    @CMD                            CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMD                            CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Perform override to PF/TTRANPD & open file                      CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   @CMD                            CRT002
     C                     MOVEL@TXT,1    @CMD                            CRT002
     C                     MOVEL'T'       @BRI                            CRT002
     C                     MOVEL@TLID     @BID                            CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMD                            CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     MOVEL'QCMDEXC' P@QRS                           CRT002
     C                     MOVEL@CMDT     P@QKY                           CRT002
     C                     EXSR DQERR                                     CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     OPEN TTRANPD                70                 CRT002
      *                                                                                       CRT006
      ** Acknowledged Flag will be processed from the transaction                             CRT006
      ** application data queue message if running in batch mode.                             CRT006
      ** Interactively, Acknowledged Flag will be set to 'Y'.                                 CRT006
     C           PMODE     IFEQ 'P'                                                           CRT006
     C                     MOVE RAACKF    ACKF                                                CRT006
     C                     ELSE                                                               CRT006
     C                     MOVE 'Y'       ACKF                                                CRT006
     C                     ENDIF                                                              CRT006
      *
      ** Format record details
     C                     MOVEL'D'       RECI
     C                     MOVEL'T'       TBRI
     C                     MOVELPTLID     TBID
     C                     MOVEL@NATN     TBTN
      *                                                                   CRT002
      **  If transaction is not posted to suspense                        CRT002
      *                                                                   CRT002
     C           WSUS      IFEQ 'N'                                       CRT002
     C                     MOVELSACNO1    ACNO
     C                     MOVEL*BLANKS   CUS1                            CRT002
     C                     MOVEL*BLANKS   CCY1                            CRT002
     C                     MOVEL*BLANKS   ACD1                            CRT002
     C                     MOVEL*BLANKS   ACSQ1                           CRT002
     C                     ELSE                                           CRT002
     C                     MOVEL*BLANKS   ACNO                            CRT002
     C                     MOVEL*BLANKS   ANAM                            CRT002
     C                     MOVEL@CNUM     CUS1                            CRT002
     C                     MOVELSCCY1     CCY1                            CRT002
     C                     MOVEL@ACOD     ACD1                            CRT002
     C                     MOVEL@ACSQ     ACSQ1                           CRT002
     C                     ENDIF                                          CRT002
     C                     MOVELPFNCD     FNCD
     C                     MOVELSCCY      CCY1
     C                     Z-ADD@TRNAM    AMT1
     C                     Z-ADD@CNAM     CVAM
     C                     Z-ADD@EXRT     EXCR
     C                     MOVELSVLDT     IVLD
     C                     MOVELSCQNF     CQNF
     C                     MOVELSDEPC     DEPC
     C                     MOVELSPRFC     PRFC
     C                     MOVELPTLBC     ITLB
     C                     Z-ADD@RDAM     RDAM                            CRT002
     C                     MOVELWRDCY     RDCY                            CRT002
     C                     Z-ADD@PYAM     PRAM                            CRT002
     C                     MOVELWPYRC     PYRC                            CRT002
     C                     MOVEL@JOB      TWID
     C                     MOVELSTIME     TIME
     C                     MOVEL@OVTI     OVTI
     C                     MOVEL@CLOS     CLOS
     C                     Z-ADD@RRNM     MRR1
     C                     MOVEL@MSG1     MSG1
     C                     MOVEL@MSG2     MSG2
      *
     C                     Z-ADD@VLDN     VLDT
     C                     MOVEL@UCQB     UCQB
     C           WRNG      IFEQ 'Y'                                                           CRE019
     C           PFNCD     ANDEQ'0JL'                                                         CRE019
     C                     MOVEL'Y'       UCQB                                                CRE019
     C                     ENDIF                                                              CRE019
      *
      *                                                                                       CRT012
      * Move Transaction Type passed in from Cashier to new field on                          CRT012
      * TTRANPD                                                                               CRT012
     C           CRT012    IFEQ 'Y'                                                           CRT012
     C                     MOVELWCSHTT    CSHTT                                               CRT012
     C                     ENDIF                                                              CRT012
     C                     WRITETTRANPDF
     C/COPY WNCPYSRC,RE4119C006
      *
     C                     CLOSETTRANPD                70                 CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTRANT - Update teller transaction trailer         *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTRANT    BEGSR                           ** UTRANT **
      *                                                                   CRT002
      **  If not the first time, delete previous overrides                CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C           @CMDT     IFNE *BLANKS                                   CRT002
     C                     MOVEL*BLANKS   @CMDT                           CRT002
     C                     MOVEL@TXT,4    @CMDT                           CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMDT                           CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Perform override to PF/TTRANPT & open file                      CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   @CMDT                           CRT002
     C                     MOVEL@TXT,2    @CMDT                           CRT002
     C                     MOVEL'T'       @BRIT                           CRT002
     C                     MOVEL@TLID     @BIDT                           CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMDT                           CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     MOVEL'QCMDEXC' P@QRS                           CRT002
     C                     MOVEL@CMDT     P@QKY                           CRT002
     C                     EXSR DQERR                                     CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     OPEN TTRANPT                70                 CRT002
      *
      ** Retrieve teller transaction trailer
     C           1         CHAINTTRANPTF             70
      *
      ** If record not found?
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD5         DBASE            ** DB ERR 05 **
     C                     MOVE 'TTRANPT' DBFILE           ***************
     C                     MOVEL'1'       DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Increment no. of records
     C                     ADD  1         TTNORE
      *
      ** Update teller transaction trailer
     C                     UPDATTTRANPTF
      *
     C                     CLOSETTRANPT                70                 CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTNTM2 - Update teller controls                    *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTTCCY - Teller currency conditions check          *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTNTM2    BEGSR                           ** UTNTM2 **
      *
      * Move fields to key list.
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     MOVEL'1'       KRCTP
      *
      ** Get Teller Control Details
     C           KLTRNT    CHAINTTRNT                70
      *
      ** Record not found.
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD6         DBASE            ** DB ERR 06 **
     C                     MOVE 'TTRNT'   DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Format record details
     C                     ADD  1         T2NATN
      *
      ** If the input currency is not present on currencies array
      ** in PF/TTRNTM2, update array with the input currency
     C                     MOVELSCCY      @CCY
     C                     EXSR RTTCCY
     C           @CY,@I    IFEQ '   '
     C                     MOVELSCCY      @CY,@I
     C                     END
      *
      ** Update teller controls
     C                     UPDATTTRNTM2F
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTNTM3 - Update teller totals                      *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTTOTS - Teller total updates                      *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTNTM3    BEGSR                           ** UTNTM3 **
      *
      * Move fields to key list.
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     MOVEL'2'       KRCTP
      *
      ** Get Teller Control Details
     C           KLTRNT    CHAINTTRNT                70
      *
      ** Record not found.
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD7         DBASE            ** DB ERR 07 **
     C                     MOVE 'TTRNT'   DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C                     MOVELSCCY      @CCY
     C                     Z-ADD@TRNAM    @TAMT
     C                     MOVEL@RVIN1    @RVIN
     C                     MOVEL@DCIN1    @DCIN
     C                     MOVEL@CSIN1    @CSIN
     C                     MOVEL@CLIN1    @CLIN
     C                     EXSR RTTOTS
      *
      ** Update teller tansaction no. of last update
     C                     Z-ADD@NATN     TTLU
      *
      ** Update teller totals
     C                     UPDATTTRNTM3F
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UMEMOS - Update memos                              *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UMEMOS    BEGSR                           ** UMEMOS **
      *
      ** Retrieve PF/MEMOS details
     C***********@RRNM*****CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
      ** Set the posting amount to transaction amount                     CCB002
     C                     Z-ADD@TNAM     W0AMT                           CCB002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
     C           PMODE     OREQ 'P'                                       118271
     C           WCHCCY    ANDEQACCY                                      118271
      *                                                                   CRT002
     C                     ADD  @TCHG     W0AMT                           CCB002
      *****************                                             CRT002118271
     C***********PMODE*    WHEQ 'P'                                 CRT002118271
     C***********PFNCD*    ANDEQ'0JW'                               CRT002118271
     C***********WCHCCY    ANDNEACCY                                CRT002118271
      *****************                                             CRT002118271
     C*****************    Z-ADD0         @XCHG  150                CRT002118271
     C*****************    Z-ADD1         @I                        CRT002118271
     C***********WCHCCY    LOKUPTCY,@I                   13         CRT002118271
     C************IN13*    IFEQ *BLANKS                             CRT002118271
     C*****************    MOVELTMD,@I    W@TMD                     CRT002118271
     C*****************    MOVELTDP,@I    @TCDP                     CRT002118271
      *****************                                             CRT002118271
      ***If*currency*not found display error                        CRT002118271
      *****************                                             CRT002118271
     C*****************    ELSE                                     CRT002118271
     C************LOCK*    IN   LDA                        *********CRT002118271
     C*****************    Z-ADD34        DBASE            ** DB ERRCRT002118271
     C*****************    MOVE 'SDCURRPD'DBFILE           *********CRT002118271
     C*****************    MOVELACCY      DBKEY                     CRT002118271
     C*****************    EXSR DBERR                               CRT002118271
     C*****************    ENDIF                                    CRT002118271
      *****************                                             CRT002118271
     C*****************    Z-ADD1         @I                        CRT002118271
     C***********ACCY**    LOKUPTCY,@I                   13         CRT002118271
     C************IN13*    IFEQ '1'                                 CRT002118271
     C*****************    MOVELTMD,@I    @EQMD                     CRT002118271
     C*****************    MOVELTDP,@I    @EQDP                     CRT002118271
     C*****************    ENDIF                                    CRT002118271
      *****************                                             CRT002118271
     C*****************    MOVEL@TCHG     @TCAM                     CRT002118271
     C*****************    MOVELWCHCCY    @TCCY                     CRT002118271
     C*****************    MOVELACCY      @EQCY                     CRT002118271
     C*****************    EXSR RTCONV                              CRT002118271
     C*****************    Z-ADD@EQAM     @XCHG                     CRT002118271
      *****************                                             CRT002118271
     C*****************    ADD  @XCHG     W0AMT                     CRT002118271
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
      ** Call Access Object AOMEMSU0                                      CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM SCCY1     W0CUCD  3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACCD 100                                          CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C                     PARM BJRDNB    W0PSTD  50       O:Posting date CCB002
     C                     PARM BJRDNB    W0VDAT  50       O:Value date   CCB002
     C                     PARM           W0AMT  150       O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV  1        O:FT override  CCB002
      *
      ** If record not found?
     C************IN70*****IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD8         DBASE            ** DB ERR 08 **
     C*********************MOVE 'MEMOS  ' DBFILE           ***************CCB002
     C*********************MOVEL@RRNM     DBKEY                           CCB002
     C                     MOVE 'AOMEMSU0'DBFILE                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
     C/COPY WNCPYSRC,RE4119C016
      *
      ** add cheque amount from ledger balance and cleared balance
     C*********************ADD  @CNAM     LDBLN                           CCB002
     C*********************ADD  @CNAM     CLBLN                           CCB002
     C*********************ADD  @TCHG     LDBLN                           CCB002
     C*********************ADD  @TCHG     CLBLN                           CCB002
      ** include net interest amount if closing.                          106661
     C           CLREQ     IFEQ 'Y'                                       106661
     C           @CLOS     ANDEQ'Y'                                       106661
     C                     Z-ADD@INTRS    SUMT   150                      106661
     C                     ADD  @CHRG     SUMT                            106661
      *                                                                   106661
     C** Chain access object AOMEMSU0                                     106661
     C                     CALL 'AOMEMSU0'                                106661
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  106661
     C                     PARM 0         W0RETL 100       O:Retail A/C No106661
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              106661 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C**********           PARM @CCY      W0CCY   3        O:Curr  106661 162643
     C                     PARM SCCY1     W0CCY   3        O:Currency     162643
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              106661 CGL029
     C                     PARM @ACOD     W0ACCD                                              CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. 106661
     C                     PARM @BRCA     W0BRCA  3        O:Branch       106661
     C                     PARM BJRDNB    W0PSTD  50       O:Posting date 106661
     C                     PARM BJRDNB    W0VDAT  50       O:Value date   106661
     C                     PARM SUMT      W0AMT  150       O:Movement amt 106661
     C                     PARM 'N'       W0FTOV  1        O:FT override  106661
      *                                                                   106661
      ** If record not found?                                             106661
     C           W0RTCD    IFNE *BLANKS                                   106661
     C           *LOCK     IN   LDA                                       106661
     C                     Z-ADD30        DBASE            ***************106661
     C                     MOVE 'AOMEMSU0'DBFILE           ** DBERR 030 **106661
     C**********           Z-ADDW0CNUM    U0CNUM           ***************             106661 CSD027
     C                     MOVE W0CNUM    U0CNUM           ***************                    CSD027
     C**********           MOVE W0CUCD    U0CUCD                   106661 162643
     C                     MOVE W0CCY     U0CUCD                          162643
     C                     Z-ADDW0ACCD    U0ACCD                          106661
     C                     Z-ADDW0ACSQ    U0ACSQ                          106661
     C                     MOVE W0BRCA    U0BRCA                          106661
     C                     MOVELUMEMER    DBKEY                           106661
     C                     EXSR DBERR                                     106661
     C                     END                                            106661
     C/COPY WNCPYSRC,RE4119C017
     C                     END                                            106661
      *
      ** Update PF/MEMOS record
     C*********************UPDATMEMOSMDF                                  CCB002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRSACM - Write shadow postings                     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRSACM    BEGSR                           ** WRSACM **
      *
     C**********           Z-ADD@CNUM     CUSN                                                CSD027
     C                     MOVE @CNUM     CUSN                                                CSD027
     C                     MOVELACCY      CCYD
     C                     Z-ADD@ACOD     ACDE
     C                     Z-ADD@ACSQ     ASNC
     C                     MOVEL@BRCA     BRCA
     C                     Z-ADDBJRDNB    PTDT
     C                     Z-ADD@VLDN     VUDT
     C                     MOVEL'TT'      TRYP
     C                     MOVEL@NRTD1    NRTD
     C                     MOVE @NATN     TNMR
     C                     MOVELSCQNF     CQNR
     C                     Z-ADD@EQAM     MVAM
      *                                                                   CRT002
      ** include charge amount
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
     C           PMODE     OREQ 'P'                                       CRT002
     C***********PFNCD     ANDNE'0JW'                               CRT002118271
     C***********PMODE     OREQ 'P'                                 CRT002118271
     C***********PFNCD     ANDEQ'0JW'                               CRT002118271
     C           WCHCCY    ANDEQACCY                                      CRT002
     C                     ADD  @TCHG     MVAM
      *                                                                   CRT002
     C***********PMODE     WHEQ 'P'                                 CRT002118271
     C***********PFNCD     ANDEQ'0JW'                               CRT002118271
     C***********WCHCCY    ANDNEACCY                                CRT002118271
     C*********************ADD  @XCHG     MVAM                      CRT002118271
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
     C                     Z-ADD0         DORC
     C                     MOVELPTLID     TBID
     C                     MOVEL'N'       APBI
     C                     MOVEL@PASS1    PASS
      *                                                                                       CAP205
      ** Set up Module and Movement Type fields                                               CAP205
      *                                                                                       CAP205
     C           CAP205    IFEQ 'Y'                                                           CAP205
     C                     MOVE 'RE'      CMOD                                                CAP205
     C                     MOVE 'S'       MTYP                                                CAP205
     C                     ENDIF                                                              CAP205
      *
     C/COPY WNCPYSRC,RE4119C002
     C                     WRITERSACMTPO
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              092429
     C*****************************************************************   092429
     C*                                                               *   092429
     C*            NARRUP - UPDATE NARRATIVES FILE TTNARPD            *   092429
     C*                                                               *   092429
     C* CALLS             -                                           *   092429
     C*                                                               *   092429
     C* CALLED BY  UPDATE - UPDATE CONTROL                            *   092429
     C*                                                               *   092429
     C*                                                               *   092429
     C*****************************************************************   092429
     C           NARRUP    BEGSR                                          092429
     C*                                                                   092429
     C** CLEAR THE OUTPUT FIELDS AND DATA STRUCTURE AND SET UP            092429
     C** COMMON DETAILS FOR THE NARRATIVE FILE.                           092429
     C*                                                                   092429
     C/COPY WNCPYSRC,RE4119C007
     C                     CLEARSNARR                                     092429
     C                     CLEARTTNARR                                    092429
     C                     MOVEL'D'       RECI                            092429
     C                     MOVEL'T'       TBRI                            092429
     C                     MOVELPTLID     TBID                            092429
     C                     MOVE @NATN     TBTN                            092429
     C                     MOVE @NATN     @@TBTN                          092429
     C                     MOVE TBID      @@TBID                          092429
     C                     MOVE '/'       @@SLSH                          092429
     C*                                                                   092429
     C** IF NARRATIVE IS ENTERED THEN SET UP THE NARRATIVE FIELD FOR      092429
     C** THE NARRATIVE FILE TTNARPD AND THEN WRITE THE DETAILS TO         092429
     C** NARRATIVE FILE.                                                  092429
     C*                                                                   092429
     C           NARRI     IFNE *BLANKS                                   092429
     C                     MOVE *ON       *IN72                           092429
     C                     MOVELNARRI     SNARR                           092429
     C                     MOVE @@NARR    TTNARR                          092429
     C*                                                                   092429
     C                     ELSE                                           092429
     C*                                                                   092429
     C                     MOVE *OFF      *IN72                           092429
     C                     MOVE @@NARR    TTNARR                          092429
     C                     ENDIF                                          092429
     C*                                                                   092429
     C                     WRITETTNARPDF                                  092429
     C*                                                                   092429
     C                     ENDSR                                          092429
     C*****************************************************************   092429
      /EJECT
      *****************************************************************
      *                                                               *
      *            UACCNT - Update accounts                           *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTACLS - Account closure updates                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UACCNT    BEGSR                           ** UACCNT **
      *
      ** If account closure is successful
     C           @CLOS     IFEQ 'Y'
     C                     MOVEL' '       @RVIN
     C*********************MOVE CCY       @CCY                            CCB002
     C                     MOVE ACCY      @CCY                            CCB002
     C                     EXSR RTACLS
      *
      ** If LF/ACCNT record not found.
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD9         DBASE            ** DB ERR 09 **
     C                     MOVE 'ACCNT '  DBFILE           ***************
     C                     MOVEL@ACCN     DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UCHQBK - Update cheque book                        *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            UPTRL  - Update Control Trailer Record             *                       CRE019
      *            SBTOFF - Set bit off                               *                       CRE019
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED  @CA    - Cheque presented status array             *
      *            @CAI   - Cheque presented status array element     *
      *            @BITN  - Bit position representing cheque number   *
      *                                                               *
      *****************************************************************
     C           UCHQBK    BEGSR                           ** UCHQBK **
     C                     MOVEL'N'       WINS    1                                           CRE019
      *                                                                                       CRE019
      *
      ** update only if update cheque presented indicator
      ** received from RTCHQP is 'Y'
      ** OR create new record if cheque is out of range                                       CRE019
     C           @UCQB     IFEQ 'Y'
     C           GCQI      ANDEQ*ZERO                                                        BUG3229
     C           WRNG      OREQ 'Y'                                                           CRE019
     C           GCQI      ANDEQ*ZERO                                                        BUG3229
      *
     C                     OPEN CHQBKPD
      *
     C           KLCQBK    CHAINCHQBKPD              70
      *
      ** If record not found.
     C           *IN70     IFEQ '1'
      *                                                                                       CRE019
     C           CRE019    IFEQ 'N'                                                           CRE019
     C           CRE019    OREQ 'Y'                                                           CRE019
     C           PFNCD     ANDNE'0JL'                                                         CRE019
      *                                                                                       CRE019
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD10        DBASE            ** DB ERR 10 **
     C                     MOVE 'CHQBKPD' DBFILE           ***************
     C                     MOVELKACNO     DBKEY
     C                     MOVE KSCQN     DBKEY
     C                     EXSR DBERR
      *                                                                                       CRE019
     C                     ELSE                                                               CRE019
      *                                                                                       CRE019
      ** format fields for new cheque book record                                             CRE019
      *                                                                                       CRE019
     C                     MOVEL'D'       RECID                                               CRE019
     C                     MOVE SACNO1    CQACNO                                              CRE019
     C                     Z-ADD0         GCQI                                                CRE019
     C                     MOVE SCQNF     SCQN                                                CRE019
     C                     MOVE SCQNF     ECQN                                                CRE019
     C                     Z-ADD1         NOCQ                                                CRE019
     C                     Z-ADD@VLDN     DISS                                                CRE019
     C                     Z-ADD@VLDN     DCOL                                                CRE019
     C                     Z-ADDBJRDNB    OEDT                                                CRE019
     C                     MOVELBRCA      CQBRCA                                              CRE019
     C                     MOVEL'I'       CHTP                                                CRE019
     C                     Z-ADD0         CQCHAM                                              CRE019
     C                     Z-ADD0         CQCHAC                                              CRE019
     C                     Z-ADD0         CHTT                                                CRE019
     C                     MOVEL'Y'       OUTR                                                CRE019
     C                     MOVEL'Y'       WINS                                                CRE019
      *                                                                                       CRE019
      ** initialise cheque presented array and on corresponding bit                           CRE019
      *                                                                                       CRE019
     C                     EXSR SBTOFF                                                        CRE019
     C                     BITON'0'       @CA,1                                               CRE019
     C                     ENDIF                                                              CRE019
     C                     END
      *                                                                                       CRE019
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C                     Z-ADDFNATN     TNLU                                                CRE019
     C                     Z-ADDBJRDNB    LCD                                                 CRE019
     C                     ENDIF                                                              CRE019
      *
     C           WINS      IFEQ 'N'                                                           CRE019
      *                                                                                       CRE019
     C                     Z-ADD@CAI      @I
     C           @BITN     IFEQ 0
     C                     BITON'0'       @CA,@I
     C                     END
     C           @BITN     IFEQ 1
     C                     BITON'1'       @CA,@I
     C                     END
     C           @BITN     IFEQ 2
     C                     BITON'2'       @CA,@I
     C                     END
     C           @BITN     IFEQ 3
     C                     BITON'3'       @CA,@I
     C                     END
     C           @BITN     IFEQ 4
     C                     BITON'4'       @CA,@I
     C                     END
     C           @BITN     IFEQ 5
     C                     BITON'5'       @CA,@I
     C                     END
     C           @BITN     IFEQ 6
     C                     BITON'6'       @CA,@I
     C                     END
     C           @BITN     IFEQ 7
     C                     BITON'7'       @CA,@I
     C                     END
      *
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C           PFNCD     ANDEQ'0JL'                                                         CRE019
     C                     MOVEL'A'       CHTP                                                CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C                     UPDATCHQBKPDF
      *                                                                                       CRE019
     C                     ELSE                                                               CRE019
      *                                                                                       CRE019
      ** Create new cheque book record for out of range cheques                               CRE019
      *                                                                                       CRE019
     C                     WRITECHQBKPDF                                                      CRE019
     C                     EXSR UPTRL                                                         CRE019
      *                                                                                       CRE019
     C                     ENDIF                                                              CRE019
      *
     C                     CLOSECHQBKPD
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                                                  CRE019
      *****************************************************************                       CRE019
      *                                                               *                       CRE019
      * SBTOFF - Set bit off                                          *                       CRE019
      *                                                               *                       CRE019
      * CALLS             -                                           *                       CRE019
      *                                                               *                       CRE019
      * CALLED BY  UCHQBK - Update Cheque Book                        *                       CRE019
      *                                                               *                       CRE019
      *****************************************************************                       CRE019
     C           SBTOFF    BEGSR                                                              CRE019
      *                                                                                       CRE019
      ** Set bit of for all the 160 cheque presented array                                    CRE019
      *                                                                                       CRE019
     C                     Z-ADD1         WI      20                                          CRE019
      *                                                                                       CRE019
     C           WI        DOWLE20                                                            CRE019
     C                     BITON'01234567'@CA,WI  1                                           CRE019
     C                     BITOF'01234567'@CA,WI  1                                           CRE019
     C                     ADD  1         WI                                                  CRE019
     C                     END                                                                CRE019
      *                                                                                       CRE019
     C                     ENDSR                                                              CRE019
      *****************************************************************                       CRE019
      /EJECT                                                                                  CRE019
      *****************************************************************                       CRE019
      *                                                               *                       CRE019
      * UPTRL  - Update Control Trailer Record                        *                       CRE019
      *                                                               *                       CRE019
      * CALLS :    DBERR  - Database error handling                   *                       CRE019
      * CALLED BY: UCHQBK - Update control routine                    *                       CRE019
      *                                                               *                       CRE019
      *****************************************************************                       CRE019
     C           UPTRL     BEGSR                                                              CRE019
      *                                                                                       CRE019
     C                     MOVE *ALL'9'   @CHQBK                                              CRE019
     C           KLCQBK    CHAINCHQBKPTF             70                                       CRE019
      *                                                                                       CRE019
      **  If no record found                                                                  CRE019
      *                                                                                       CRE019
     C           *IN70     IFEQ '1'                                                           CRE019
     C           *LOCK     IN   LDA                                                           CRE019
     C                     Z-ADD27        DBASE                                               CRE019
     C                     MOVEL'CHQBKPTF'DBFILE                                              CRE019
     C                     MOVELKACNO     DBKEY                                               CRE019
     C                     MOVE KSCQN     DBKEY                                               CRE019
     C                     EXSR DBERR                                                         CRE019
     C                     ELSE                                                               CRE019
     C                     ADD  1         NORET                                               CRE019
     C                     UPDATCHQBKPTF                                                      CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C                     ENDSR                                                              CRE019
      *****************************************************************                       CRE019
      /EJECT
      *****************************************************************
      *                                                               *
      *            WTTCHG - Write Teller charges detail               *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           WTTCHG    BEGSR                           ** WTTCHG **
      *
     C                     MOVEL'D'       RECI
     C                     MOVEL'T'       TBRI
     C                     MOVELPTLID     TBID
     C                     Z-ADDSTTLU     TBTN
      *                                                                   CRT012
      * If CRT012 is On then                                              CRT012
      * ouput each individual charge and charge code.                     CRT012
     C           CRT012    IFEQ 'Y'                                       CRT012
     C           WCHC1     ANDNE*BLANKS                                   CRT012
     C                     EXSR SRCHRG                                    CRT012
     C                     ELSE                                           CRT012
     C                     Z-ADD@TCHG     AMT3
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP17                                           S01408
     C*                                                                   S01408
     C                     MOVELSCTRTY    TTP3
     C                     SELEC                                          CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
     C                     MOVELACCY      CCY3
     C           PMODE     WHEQ 'P'                                       CRT002
     C                     MOVELWCHCCY    CCY3                            CRT002
     C                     ENDSL                                          CRT002
      *
     C                     WRITETTCHGPDF
     C                     ENDIF                                          CRT012
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            WRTTCD - Write travellers cheque register detail   *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY  UPDATE - Update control                            *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           WRTTCD    BEGSR                           ** WRTTCD **   CRT002
      *                                                                   CRT002
     C**********           Z-ADDH@CINN    ROISSU                                       CRT002 CSD027
     C                     MOVELH@CINN    ROISSU                                              CSD027
     C                     Z-ADDH@CSNN    ROTCSN                          CRT002
     C                     MOVELSFCN      ROTCNO                          CRT002
     C                     MOVELB@BNM     ROBYNM                          CRT002
     C                     MOVELB@BIT     ROIDTP                          CRT002
     C                     MOVELB@BIN     ROBYID                          CRT002
      *                                                                   CRT002
     C                     Z-ADD@VLDN     ROSOLD                          CRT002
     C                     MOVELPTLBC     ROBRCA                          CRT002
     C                     MOVE 'Y'       ROTCSE                          CRT002
     C                     MOVE 'I'       ROCHTP                          CRT002
     C                     Z-ADDBJRDNB    ROLCD                           CRT002
     C                     WRITERETCRDD0                                  CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            UPDTCC - Update travellers cheque register control *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY  UPDATE - Update control                            *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           UPDTCC    BEGSR                           ** UPDTCC **   CRT002
      *                                                                   CRT002
     C           KSERN     KLIST                                          CRT002
     C                     KFLD           RNISSU                          CRT002
     C                     KFLD           RNSTCN                          CRT002
      *                                                                   CRT002
      **  If the cheque serial no is valid, the last read record in       CRT002
      **  RETCRCL0 (subr VALCQS) is the one to be amended if needed.      CRT002
      *                                                                   CRT002
     C           RNBSTS    IFEQ 'U'                                       CRT002
     C                     MOVE 'P'       RNBSTS                          CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C           RNBSTS    IFEQ 'P'                                       CRT002
     C           KSERN     SETLLRETCRDD0             70                   CRT002
     C                     READ RETCRDD0                 70               CRT002
     C                     Z-ADDRNSTCN    H@SERN 120                      CRT002
      *                                                                   CRT002
     C           RNISSU    DOWEQROISSU                                    CRT002
     C           H@SERN    ANDLERNETCN                                    CRT002
     C           *IN70     ANDEQ'0'                                       CRT002
      *                                                                   CRT002
      **  The range of chq serial no is all used up                       CRT002
      *                                                                   CRT002
     C           H@SERN    IFEQ ROTCSN                                    CRT002
     C           H@SERN    ANDEQRNETCN                                    CRT002
     C                     MOVE 'S'       RNBSTS                          CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  A still available chq serial no was found                       CRT002
      *                                                                   CRT002
     C           H@SERN    IFNE ROTCSN                                    CRT002
     C                     LEAVE                                          CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     ADD  1         H@SERN                          CRT002
     C                     READ RETCRDD0                 70               CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Update cheque sold status array                                 CRT002
      *                                                                   CRT002
     C                     MOVEARNCOPS    @CA,1                           CRT002
      *                                                                   CRT002
      **  Calculate cheque presented status array index                   CRT002
      *                                                                   CRT002
     C           H@CSNN    SUB  RNSTCN    @OFSET  80                      CRT002
     C           @OFSET    DIV  8         @I      20                      CRT002
     C                     MVR            @BITN   10                      CRT002
     C                     ADD  1         @I                              CRT002
      *                                                                   CRT002
     C           @BITN     IFEQ 0                                         CRT002
     C                     BITON'0'       @CA,@I                          CRT002
     C                     END                                            CRT002
     C           @BITN     IFEQ 1                                         CRT002
     C                     BITON'1'       @CA,@I                          CRT002
     C                     END                                            CRT002
     C           @BITN     IFEQ 2                                         CRT002
     C                     BITON'2'       @CA,@I                          CRT002
     C                     END                                            CRT002
     C           @BITN     IFEQ 3                                         CRT002
     C                     BITON'3'       @CA,@I                          CRT002
     C                     END                                            CRT002
     C           @BITN     IFEQ 4                                         CRT002
     C                     BITON'4'       @CA,@I                          CRT002
     C                     END                                            CRT002
     C           @BITN     IFEQ 5                                         CRT002
     C                     BITON'5'       @CA,@I                          CRT002
     C                     END                                            CRT002
     C           @BITN     IFEQ 6                                         CRT002
     C                     BITON'6'       @CA,@I                          CRT002
     C                     END                                            CRT002
     C           @BITN     IFEQ 7                                         CRT002
     C                     BITON'7'       @CA,@I                          CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     MOVEA@CA,1     RNCOPS                          CRT002
      *                                                                   CRT002
     C                     MOVE 'A'       RNCHTP                          CRT002
     C                     Z-ADDBJRDNB    RNLCD                           CRT002
     C                     UPDATRETCRCD0                                  CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT
      *****************************************************************
      *                                                               *
      *            PRTTRN - Print transaction                         *
      *                                                               *
      * CALLS      ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           PRTTRN    BEGSR                           ** PRTTRN **
      *
     C                     OPEN RE4119P1
     C*                                                                   092429
     C* IF NARRATIVE IS ENTERED THEN PRINT AND CLEAR ITS OUTPUT           092429
     C* FIELD, OTHERWISE JUST CLEAR THE OUTPUT FIELD.                     092429
     C*                                                                   092429
     C           NARRI     IFEQ *BLANKS                                   092429
     C                     MOVE *BLANKS   NARRO                           092429
     C                     ELSE                                           092429
     C                     MOVE NARRI     NARRO                           092429
     C                     ENDIF                                          092429
      *
      ** Format cheque amount
     C                     Z-ADD@TCDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@TRNAM    ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    ENUM
     C                     MOVE @EN       OTNAM
     C                     Z-ADD@EXRT     OEXRT
      *
      ** editing the currency equivalent
     C                     Z-ADD@EQDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@CNAM     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    ENUM
     C                     MOVE @EN       OCHEQ
      *
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP10                                           S01408
     C*                                                                   S01408
     C                     WRITEDETAIL
     C*                                                                   092429
     C                     CLEARNARRI                                     092429
     C                     CLEARNARRO                                     092429
      *
     C           @TCHG     IFNE *ZERO
      ** Format charge amount
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@TCHG     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    OTNAM
      ** Charge entered as amount or %?
     C           SCPER     IFNE *BLANKS
     C                     SETON                     14
     C                     ELSE
     C                     SETOF                     14
     C                     END
     C                     WRITECHARGE
     C                     END
      *
      ** Format total amount
      ** - subtract charge amount
     C           @TNAM     ADD  @TCHG     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    OTNAM
      *
     C                     WRITETOTAL
     C/COPY WNCPYSRC,RE4119C001
     C                     CLOSERE4119P1
      *
     C                     ENDSR
      *****************************************************************
      *****************************************************************                       CCG016
      /EJECT                                                                                  CCG016
      *****************************************************************                       CCG016
      *                                                               *                       CCG016
      *            SNDUDC - Send advice to UDC                        *                       CCG016
      *                                                               *                       CCG016
      * CALLS      external pgm                                       *                       CCG016
      *                                                               *                       CCG016
      * CALLED BY  same as PRTTRN                                     *                       CCG016
      *                                                               *                       CCG016
      * FLDS USED         -                                           *                       CCG016
      *                                                               *                       CCG016
      *****************************************************************                       CCG016
     C           SNDUDC    BEGSR                                                              CCG016
      *                                                                                       CCG016
     C                     MOVELITLB      I#BRCT    P                                         CCG016
     C                     MOVELPTLID     I#TLID    P                                         CCG016
     C                     MOVELTBID      I#TBID    P                                         CCG016
     C                     MOVELSTTLU     I#TBTN    P                                         CCG016
     C                     MOVELPFNCD     I#FUNC    P                                         CCG016
     C           *IN40     IFEQ '0'                                                           CCG016
     C                     MOVEL'N'       I#CLOS    P                                         CCG016
     C                     ELSE                                                               CCG016
     C                     MOVEL'Y'       I#CLOS    P                                         CCG016
     C                     END                                                                CCG016
     C                     MOVELSCQNF     I#CHQN    P                                         CCG016
     C           PFNCD     IFEQ '0JW'                                                       MD042745
     C                     MOVELSCSN      I#CHQN    P                                       MD042745
     C                     ENDIF                                                            MD042745
     C                     MOVEL*ZEROS    I#CNUM                                              CCG016
     C                     MOVEL*BLANKS   I#CCY                                               CCG016
     C                     MOVEL*ZEROS    I#ACOD                                              CCG016
     C                     MOVEL*ZEROS    I#ACSQ                                              CCG016
     C                     MOVEL*ZEROS    I#BRCA                                              CCG016
     C                     MOVELACNO      I#ACNO    P                                         CCG016
     C                     MOVEL*ZEROS    I#CNU1                                              CCG016
     C                     MOVEL*BLANKS   I#CCY1                                              CCG016
     C                     MOVEL*ZEROS    I#ACO1                                              CCG016
     C                     MOVEL*ZEROS    I#ACS1                                              CCG016
     C                     MOVEL*BLANKS   I#BRC1                                              CCG016
     C                     MOVEL*ZEROS    I#ACN1                                              CCG016
     C                     MOVEL*ZEROS    I#CNU2                                              CCG016
     C                     MOVEL*BLANKS   I#CCY2                                              CCG016
     C                     MOVEL*ZEROS    I#ACO2                                              CCG016
     C                     MOVEL*ZEROS    I#ACS2                                              CCG016
     C                     MOVEL*BLANKS   I#BRC2                                              CCG016
     C                     MOVEL*ZEROS    I#ACN2                                              CCG016
     C                     Z-ADD0         I#AMNT                                              CCG016
     C                     MOVELSCCY      I#CCYT    P                                         CCG016
     C                     MOVELNARRI     I#NARR    P                                         CCG016
     C                     Z-ADD@TRNAM    I#CHQA                                              CCG016
     C                     Z-ADD@EXRT     I#EXRT                                              CCG016
     C                     Z-ADD@CNAM     I#BUYA                                              CCG016
     C                     MOVELSCCY1     I#BUYC                                              CCG016
     C                     Z-ADD0         I#SELA                                              CCG016
     C                     MOVEL*BLANKS   I#SELC                                              CCG016
     C                     MOVEL*BLANKS   I#NAR1                                              CCG016
     C                     MOVEL*BLANKS   I#NAR2                                              CCG016
     C                     Z-ADD0         I#INTA                                              CCG016
     C                     MOVEL*BLANKS   I#INTC                                              CCG016
     C                     MOVEL*BLANKS   I#INTN                                              CCG016
     C                     Z-ADD0         I#TAXA                                              CCG016
     C                     MOVEL*BLANKS   I#TAXC                                              CCG016
     C                     MOVEL*BLANKS   I#TAXN                                              CCG016
     C                     Z-ADD@TCHG     I#CHGA                                              CCG016
     C                     MOVELSCCY1     I#CHGC    P                                         CCG016
     C                     MOVELTTP3      I#CHGN    P                                         CCG016
     C           @TNAM     ADD  @TCHG     I#TOTA                                              CCG016
     C                     MOVELSCCY1     I#TOTC    P                                         CCG016
     C                     MOVEL*BLANKS   I#TOTN                                              CCG016
      *                                                                                       CCG016
     C                     CALL 'CGC3605'                                                     CCG016
     C                     PARM '*PREPARE'ACTION  8                                           CCG016
      *                                                                                       CCG016
     C                     CALL 'CG0501'                                                      CCG016
     C                     PARM           W0RTN   7                                           CCG016
     C                     PARM 'YES'     W0CMT   3                                           CCG016
     C                     PARM *BLANKS   ##COPD  1                                           CCG016
     C                     PARM *BLANKS   ##AUTO  1                                           CCG016
     C                     PARM           I#PARM                                              CCG016
     C                     PARM           O#PARM                                              CCG016
      *                                                                                       CCG016
     C                     CALL 'CGC3604'                                                     CCG016
      *                                                                                       CCG016
     C           ##COPD    IFNE 'N'                                                           CCG016
     C                     CALL 'CGC0524'                                                     CCG016
     C                     PARM *BLANKS   W7A1    7                                           CCG016
     C                     PARM O#PARM    W50A1  50                                           CCG016
     C                     PARM *BLANKS   W10A1  10                                           CCG016
     C                     END                                                                CCG016
      *                                                                                       CCG016
     C                     ENDSR                                                              CCG016
      *****************************************************************                       CCG016
     C/COPY WNCPYSRC,RE4119C012
      /EJECT
      /COPY ZSRSRC,RTBKDRC1
      ** Block debit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTBKCRC1
      ** Block credit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTRFDRC1
      ** Refer debit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTRFCRC1
      ** Refer credit check subroutine
      *
      /COPY ZSRSRC,RTIACTC1
      ** Inactive account check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTBKPTC1
      ** Bankrupt/Liquidation check
      *
      /EJECT
      /COPY ZSRSRC,RTBDPTC1
      ** Bad Debt check
      *
      /EJECT
      /COPY ZSRSRC,RTBRCHC1
      ** Branch different check
      *
      /EJECT
      /COPY ZSRSRC,RTACLGC1
      ** Account closing check
      *
      /EJECT
      /COPY ZSRSRC,RTCLSCC1
      ** Calculate close details
      *
      /EJECT
      /COPY ZSRSRC,RTCHRGC1
      ** Calculate service charges
      *
      /EJECT
      /COPY ZSRSRC,RTINTRC1
      ** Calculate net interest
      *
      /EJECT
      /COPY ZSRSRC,RTCLSEC1
      ** Close account conditions check
      *
      /EJECT
      /COPY ZSRSRC,RTTOTSC1
      ** Calculate teller totals updates
      *
     C/COPY WNCPYSRC,REH00190
      /EJECT
      *****************************************************************
      *                                                               *
      *            ACLOSE - A/C Closure Enquiry                       *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTCLSC - Calculate close details                   *
      *            RTCLSE - Close account condition check             *
      *            VALINL - Validate initial screen                   *
      *            WRKACC - Work with account                         *
      *            ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ACLOSE    BEGSR                           ** ACLOSE **
      *
     C                     SETOF                     4569
     C                     SETON                     40
     C**********           OPEN RECRG                                     153001
     C                     OPEN REIAC
     C                     OPEN REACR
      *
      ** Validate initial screen
     C                     EXSR VALINL
      *
      ** No validation error(s)
     C           *IN69     IFEQ '0'
      *
      ** Set up variables
     C                     MOVE ' '       @CLOS   1
     C                     MOVE RETB      @RETB
     C                     Z-ADDRRNM      @RRNM
     C**********           Z-ADDCNUM      @CNUM                                               CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     MOVELSCCY1     @CCY
     C                     Z-ADDACOD      @ACOD
     C                     Z-ADDACSQ      @ACSQ
     C                     MOVELBRCA      @BRCA
      *
      ** Retrieve PF/MEMOS details
     C***********@RRNM*****CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
     C** Chain access object AOMEMSR0                                     CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANK    W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' P@OPTN  7        O:Option       CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM @CCY      W0CCY   3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACCD                                              CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
      ** If record not found?
     C************IN70*****IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE *BLANK                                    CCB002
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD11        DBASE            ** DB ERR 11 **
     C*********************MOVE 'MEMOS  ' DBFILE           ***************CCB002
     C*********************MOVEL@RRNM     DBKEY                           CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C                     MOVEL@CNUM     DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      *
      ** Release record
     C*********************EXCPT@RLMEM                                    CCB002
      *
      ** Perform close account condition check
     C                     MOVE SCCY1     SCCY2
     C                     MOVE SCCY1     SCCY3                                               CAAA03
     C                     MOVE ANAM      SANAM
     C                     MOVE SACNO1    SACNO2
     C                     MOVE '  '      @ACIN   2
     C                     Z-ADDCLBLN     @CLBL
      *                                                                   CCB002
      ** Set parameters for amended SR/RTCLSE                             CCB002
     C                     Z-ADD*ZEROS    @ACNOM 100                      CCB002
     C**********           MOVE @CNUM     @CNUMM  60                                   CCB002 CSD027
     C                     MOVE @CNUM     @CNUMM  6                                           CSD027
     C                     MOVE @CCY      @CCYM   3                       CCB002
     C**********           MOVE @ACOD     @ACCDM  40                                   CCB002 CGL029
     C                     MOVE @ACOD     @ACCDM 100                                          CGL029
     C                     MOVE @ACSQ     @ACSQM  20                      CCB002
     C                     MOVE @BRCA     @BRCAM  3                       CCB002
      *
      ** Calculate close account condition check
     C                     EXSR RTCLSE
      *
      ** If no terminal error(s) exist
     C           @TI       IFEQ 0
      *
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP19                                           S01408
     C*                                                                   S01408
      *                                                                                       CDL013
     C           CDL013    IFEQ 'Y'                                                           CDL013
     C                     EXSR #ERTCL                                                        CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      ** Calculate close details
     C                     EXSR RTCLSC
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP20                                           S01408
     C*                                                                   S01408
      *
      ** If record not found?
     C           *IN80     IFEQ '1'
      *                                                    ***************
     C                     Z-ADD12        DBASE            ** DB ERR 12 **
     C                     EXSR DBERR                      ***************
     C                     END
      *
      ** If no terminal error(s) exist
     C           @TI       IFEQ 0
      *
      ** Remove any warning messages since same routines will validate again
     C                     Z-ADD0         @WI
     C                     MOVEA*BLANKS   @W
      *
      ** Prepare output fields for account closing balances
      ** and set on display indicator
     C                     Z-ADD@EQDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@INTR     ZFLD15
     C                     Z-ADD@INTR     @INTRS 150                      106661
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SINTR
      *
      *  Show W/TAX if the customer is liable to tax and WT is not 0
      *
     C           BBTAIN    IFEQ 'Y'
      *                                                                                       CDL013
     C** Show W/TAX if Tax indicator is valid and tax is not zero.                            CDL013
     C           CDL013    OREQ 'Y'                                                           CDL013
     C           BBTAIN    ANDNE'0'                                                           CDL013
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP22                                           S01408
     C*                                                                   S01408
     C           @WTAX     ANDNE0
     C                     Z-ADD@EQDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@WTAX     ZFLD15
     C                     ADD  @WTAX     @INTRS                          106661
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SWTAX
     C*
     C                     MOVE '1'       *IN76
     C*
     C                     ELSE
     C*
     C                     MOVE '0'       *IN76
     C*
     C                     END
      *
     C                     Z-ADD@EQDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@CHRG     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SCHRG
      *
     C                     Z-ADD@EQDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@CLOB     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SCLOB
      *
     C                     SETON                     29
      *
      ** Perform work with account
     C                     EXSR WRKACC
      *
     C                     END
      *
     C                     END
      *
      ** If terminal error(s) found
     C           @TI       IFGT 0
     C                     SETON                     2022
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
     C                     END
      *
     C                     END
      *
     C                     SETOF                     40
      *
     C**********           CLOSERECRG                                     153001
     C                     CLOSEREIAC
     C                     CLOSEREACR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      ** SR.ZALIGN subroutine
      /COPY ZSRSRC,ZALIGNZ2
      *
      /EJECT
      ** SR.ZEDIT subroutine
      /COPY ZSRSRC,ZEDITZ2
      *
      *****************************************************************
      /EJECT
      ** SR.ZDATE1 subroutine
      /COPY ZSRSRC,ZDATE1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZDATE2 subroutine
      /COPY ZSRSRC,ZDATE2Z2
      *
      *****************************************************************
      ** SR.ZCHKH  Subroutine
      /COPY ZSRSRC,ZCHKH
      *
      /EJECT
      ** SR.ZACCH  Subroutine
      /COPY ZSRSRC,ZACCH
      *****************************************************************
      /EJECT
      ** SR.ZTNLU1 Subroutine
      /COPY ZSRSRC,ZTNLU1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZFRPED Subroutine
      /COPY ZSRSRC,ZFRPEDZ3
      *
      *****************************************************************                       CRE081
      /EJECT                                                                                  CRE081
      *****************************************************************                       CRE081
      *                                                               *                       CRE081
      *  VALABC - Validate Account Balance Check in RPG               *                       CRE081
      *                                                               *                       CRE081
      *       NOTE: Any changes done to this subroutine must          *                       CRE081
      *             be done also to the following programs:           *                       CRE081
      *             RE4116, RE4117, RE4118, RE4119, and RE4121        *                       CRE081
      *                                                               *                       CRE081
      *****************************************************************                       CRE081
      *                                                                                       CRE081
     C           VALABC    BEGSR                                                              CRE081
      *                                                                                       CRE081
      ** Initialise override array elements as per SR RTABAL                                MD020635
      *                                                                                     MD020635
     C           PFNCD     IFNE '***'                                                       MD020635
     C                     MOVE ' '       @O,@IF                                            MD020635
     C                     MOVE ' '       @O,@OD                                            MD020635
     C                     MOVE ' '       @O,@MB                                            MD020635
     C                     ENDIF                                                            MD020635
      *                                                                                     MD020635
     C                     MOVE SACNO1    PRTAC                                               CRE081
     C                     CALL 'RE001590'                                                    CRE081
     C                     PARM           PRTAC                                               CRE081
     C                     PARM *BLANKS   PCUSN   6                                           CRE081
     C                     PARM *BLANKS   PCURR   3                                           CRE081
     C                     PARM 0         PACOD                                               CRE081
     C                     PARM 0         PASEQ                                               CRE081
     C                     PARM *BLANKS   PBRCH   3                                           CRE081
     C                     PARM 'RETELD'  PTRTYP 10                                           CRE081
     C                     PARM @VLDT     PVLDAT                                              CRE081
     C                     PARM @TNAM     PAMT                                                CRE081
     C                     PARM *BLANKS   PERR01  7                                           CRE081
     C                     PARM *BLANKS   PERR02  7                                           CRE081
     C                     PARM 0         PACBAL                                              CRE081
     C                     PARM 0         PAVBAL                                              CRE081
     C                     PARM 0         PFLDAT                                              CRE081
     C                     PARM 0         PFLBAL                                              CRE081
      *                                                                                       CRE081
     C           PERR01    IFEQ 'ABC0001'                                                     CRE081
      *                                                                                       CRE081
     C           @V,@MB    IFEQ 'Y'                                                           CRE081
     C                     ADD  1         @WI                                                 CRE081
     C                     MOVEL'BLW.MIN' @W,@WI                                              CRE081
     C                     MOVEL'Y'       @O,@MB                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C           @V,@MB    IFEQ 'N'                                                           CRE081
     C                     ADD  1         @TI                                                 CRE081
     C                     MOVEL'BLW.MIN' @T,@TI                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C           PERR02    IFNE *BLANKS                                                       CRE081
      *                                                                                   AR1087355C
      ** Call RIBALENQY to get Closing Balance                                            AR1087355C
      *                                                                                   AR1087355C
     C                     CALL RIBALQ                                                    AR1087355C
     C                     PARM '00N'     @@FNCD  3                                       AR1087355C
     C                     PARM SACNO1    @@ACNO 10                                       AR1087355C
     C                     PARM *BLANKS   @ACCY   3                                       AR1087355C
     C                     PARM *BLANKS   @ACBL  22                                       AR1087355C
      *                                                                                   AR1087355C
     C                     MOVE *BLANKS   ZWLFLD                                          AR1087355C
     C                     MOVEL@ACBL     ZWLFLD                                          AR1087355C
      *                                                                                   AR1087355C
      ** Get currency details                                                             AR1087355C
      *                                                                                   AR1087355C
     C                     CALL 'AOCURRR0'                                                AR1087355C
     C                     PARM '*BLANK ' @RTCD   7                                       AR1087355C
     C                     PARM '*KEY   ' @OPTN   7                                       AR1087355C
     C           @ACCY     PARM @ACCY     @CCY                                            AR1087355C
     C           SDCURR    PARM SDCURR    DSSDY                                           AR1087355C
      *                                                                                   AR1087355C
      ** If record found                                                                  AR1087355C
      *                                                                                   AR1087355C
     C           @RTCD     IFNE *BLANK                                                    AR1087355C
     C           *LOCK     IN   LDA                        ***************                AR1087355C
     C                     Z-ADD900       DBASE            ** DB ERR 900**                AR1087355C
     C                     MOVE 'SDCURR'  DBFILE           ***************                AR1087355C
     C                     MOVEL@CCY      DBKEY                                           AR1087355C
     C                     EXSR DBERR                                                     AR1087355C
     C                     ENDIF                                                          AR1087355C
      *                                                                                   AR1087355C
     C                     Z-ADDA6NBDP    ZADEC                                           AR1087355C
     C           15        SUB  A6NBDP    ZADIG                                           AR1087355C
      *                                                                                   AR1087355C
     C                     CALL 'ZALIGNB'                                                 AR1087355C
     C                     PARM *BLANKS   ZRTN    7                                       AR1087355C
     C                     PARM           ZWLFLD 20                                       AR1087355C
     C                     PARM *BLANKS   ZFIELD 16                                       AR1087355C
     C                     PARM           ZADEC   10                                      AR1087355C
     C                     PARM           ZADIG   20                                      AR1087355C
     C                     PARM *BLANKS   ZAFLD  16                                       AR1087355C
      *                                                                                   AR1087355C
     C                     Z-ADD0         @@CLOB 150                                      AR1087355C
     C                     MOVE ZAFLD     @@CLOB                                          AR1087355C
      *                                                                                   AR1087355C
     C           @TNAM     IFGT PAVBAL                                                    AR1087355C
     C           @TNAM     ANDLE@@CLOB                                                    AR1087355C
     C                     ELSE                                                           AR1087355C
      *                                                                                     MD020701
     C           @ODLN     IFEQ 0                                                           MD020701
     C           @ODED     ORLT @RUND                                                       MD020701
     C           @V,@IF    IFEQ 'Y'                                                         MD020701
     C                     ADD  1         @WI                                               MD020701
     C                     MOVEL'N.S.F.'  @W,@WI                                            MD020701
     C                     MOVE 'Y'       @O,@IF                                            MD020701
     C                     ENDIF                                                            MD020701
     C           @V,@IF    IFEQ 'N'                                                         MD020701
     C                     ADD  1         @TI                                               MD020701
     C                     MOVEL'N.S.F.'  @T,@TI                                            MD020701
     C                     ENDIF                                                            MD020701
     C                     ELSE                                                             MD020701
      *                                                                                     MD020701
     C           @V,@OD    IFEQ 'Y'                                                           CRE081
     C                     ADD  1         @WI                                                 CRE081
     C                     MOVEL'EX.O/D'  @W,@WI                                              CRE081
     C                     MOVEL'Y'       @O,@OD                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C           @V,@OD    IFEQ 'N'                                                           CRE081
     C                     ADD  1         @TI                                                 CRE081
     C                     MOVEL'EX.O/D'  @T,@TI                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDIF                                                            MD020701
      *                                                                                     MD020701
     C                     ENDIF                                                          AR1087355C
      *                                                                                   AR1087355C
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDSR                                                              CRE081
      *                                                                                       CRE081
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FIRST  - Initial Processing                        *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           FIRST     BEGSR                           ** FIRST  **
      *
      ** Input parameter(s) :
     C           *ENTRY    PLIST                           Entry parameter list
     C                     PARM           PFNCD   3        Function code
     C                     PARM           PMODE   1        Processing ModeCRT002
      *
      ** Define Keylist(s)
      *
      ** Currency Details
     C           KLBANK    KLIST
     C                     KFLD           BJBANK
      *
      ** Account Numbers Cross Reference
     C           KLACNO    KLIST
     C                     KFLD           KACNO  100
      *
      ** Account master
     C           KLACNT    KLIST
     C                     KFLD           @CNUM
     C                     KFLD           @CCY
     C                     KFLD           @ACOD
     C                     KFLD           @ACSQ
     C                     KFLD           @BRCA
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP11                                           S01408
     C*                                                                   S01408
     C*
     C** Retail commission
     C*
     C           KLCOMM    KLIST
     C                     KFLD           @BRCA
     C                     KFLD           @CNUM
     C                     KFLD           @CCY
     C                     KFLD           @ACOD
     C                     KFLD           @ACSQ
     C           KSWEEP    KLIST                                                              249968
     C                     KFLD           @CNUM                                               249968
     C                     KFLD           CCY                                                 249968
     C                     KFLD           @ACOD                                               249968
     C                     KFLD           @ACSQ                                               249968
     C                     KFLD           @BRCA                                               249968
      *                                                                                       253689
     C           KSWP1     KLIST                                                              253689
     C                     KFLD           @BRCA                                               253689
     C                     KFLD           @CNUM                                               253689
     C                     KFLD           CCY                                                 253689
     C                     KFLD           @ACOD                                               253689
     C                     KFLD           @ACSQ                                               253689
      *                                                                                       253689
      ** Klist for chaining retail account number                                             253689
      *                                                                                       253689
     C           KSWP2     KLIST                                                              253689
     C                     KFLD           @ACNO                                               253689
      *
     C           KACO      KLIST                                                              249968
     C                     KFLD           @ACNO                                               249968
     C                     KFLD           @ACSQ                                               249968
      *                                                                                       263834
     C           SWAKEY    KLIST                                                              263834
     C                     KFLD           WWBRCA  3                                           263834
     C                     KFLD           WWCNBR  6                                           263834
     C                     KFLD           WWCCY   3                                           263834
     C                     KFLD           WWACOD 100                                          263834
     C                     KFLD           WWACSQ  20                                          263834
      *                                                                                       263834
      ** Retrieve RTS job dataarea
     C           *NAMVAR   DEFN           RTSDTA
     C                     IN   RTSDTA
      *                                                                   CRT002
     C           *NAMVAR   DEFN           CITFTS                          CRT002
     C                     IN   CITFTS                                    CRT002
      *
      **   Reset LDA
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBLOT
     C                     OUT  LDA
     C*
     C** IN the data are ZMUSER
     C*
     C           *NAMVAR   DEFN           ZMUSER
     C                     IN   ZMUSER
      *                                                                   CRT002
      **  If PMODE = 'I', open display file RE4119DF                      CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     OPEN RE4119DF                                  CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Initialise MSG text and MSG return code                         CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   @MSGTX                          CRT002
     C                     MOVEL*BLANKS   WUMSID                          CRT002
     C                     MOVEL'RTSMSGF' WUMSGF                          CRT002
      *                                                                   CRT002
     C                     MOVE '1'       @FIRST  1                       CRT002
     C/COPY WNCPYSRC,RE4119C010
      *                                                                                       263834
      ** Initialise fields to be used for message text retrieval                              263834
      *                                                                                       263834
     C                     MOVEL*BLANK    ZAPGM  10                                           263834
     C                     MOVEL'RTSMSGF' ZAMSGF 10                                           263834
     C                     MOVEL*BLANK    ZAPGRL  5                                           263834
     C                     MOVEL*BLANK    ZAMSID  7                                           263834
     C                     MOVEL*BLANK    ZAMSDA132                                           263834
     C                     MOVEL*BLANK    ZAMSTP  7                                           263834
      *
      ** Get Base Currency - Bank Details
      *
      ** Set up key list
     C*
     C                     CALL 'AOBANKR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD13        DBASE            ** DB ERR 13 **
     C                     MOVE 'SDBANKPD'DBFILE           ***************
     C                     MOVELBJBANK    DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Set up the base currency details
     C********** BJLCCY    IFNE BJCYCD                                    121425
     C                     MOVE BJCYCD    @BSCY   3
     C                     MOVE BJCYCD    @CCY    3
     C                     EXSR RTCCYS
      *                                                                   CEU024
      ** Check if EMU Retail Teller Support Enhancement is installed      CEU024
      ** and Return Code is Blank                                         CEU024
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C           @RTCD     ANDEQ*BLANKS                                   CEU024
     C                     EXSR SREURO                                    CEU024
     C                     ENDIF                                          CEU024
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD14        DBASE
     C                     MOVE 'SDCURRPD'DBFILE
     C                     MOVELBJCYCD    DBKEY
     C                     EXSR DBERR
     C                     END
      *                                                                   CRT002
     C                     Z-ADDA6NBDP    @BDEC   10                      CRT002
      *                                                                   CRT002
     C**********           END                                            121425
      *
      ** Set up the local currency details
     C                     MOVE BJLCCY    @LCCY   3
     C           BJLCCY    IFNE BJCYCD                                    121425
     C                     MOVE BJLCCY    @CCY
     C                     EXSR RTCCYS
      *                                                                   CEU024
      ** Check if EMU Retail Teller Support Enhancement is installed      CEU024
      ** and Return Code is Blank                                         CEU024
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C           @RTCD     ANDEQ*BLANKS                                   CEU024
     C                     EXSR SREURO                                    CEU024
     C                     ENDIF                                          CEU024
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD15        DBASE            ** DB ERR 15 **
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVELBJLCCY    DBKEY
     C                     EXSR DBERR
     C                     END
      *                                                                   121425
     C                     END                                            121425
      *
      ** Set up date format indicator
     C           BJDFIN    IFEQ 'D'
     C                     SETOF                     98
     C                     ELSE
     C                     SETON                     98
     C                     END
     C*
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C********** SDGELR    PARM SDGELR    DSFDY                                               CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
      *
      ** If record not found?
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD19        DBASE            ** DB ERR 19 *
     C                     MOVE 'SDGELDPD'DBFILE           ***************
     C                     MOVEL@RTCD     DBKEY
     C                     EXSR DBERR
     C                     END
     C*
     C** Check if 'PROFIT CENTRE USED'
     C           PFCU      IFEQ 'Y'
     C                     SETON                     16
     C                     END
     C*
     C** Access Tax ICD for rate. Default is ZERO.
     C*
     C                     Z-ADD0         TXWTRR
     C                     OPEN SDSTAXPD
     C           1         CHAINSDSTAXPD             70
     C                     CLOSESDSTAXPD
     C*
     C** Error in SDSTAXPD
     C*
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD18        DBASE            ** DB ERR 18 **
     C                     MOVE 'SDSTAXPD'DBFILE           **************
     C                     MOVEL'1'       DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Get Function Code Details
      *
     C                     CALL 'AOFNCDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM PFNCD     @FNCD   3
     C           SDFNCD    PARM SDFNCD    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD16        DBASE            ** DB ERR 16 **
     C                     MOVELPFNCD     DBKEY            ***************
     C                     MOVE 'SDFNCDPD'DBFILE
     C                     MOVELPFNCD     DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Store validation indicators in an array
      *
     C                     MOVEAFQVWIN    @V
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JW'                                     CRT002
     C                     MOVE '1'       *IN55                           CRT002
     C                     END                                            CRT002
      *
      ** Get Transaction Type Details
     C*
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM FQDRC1    @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD17        DBASE            ** DB ERR 17 **
     C                     MOVE 'SDRETRPD'DBFILE           ***************
     C                     MOVELFQDRC1    DBKEY
     C                     EXSR DBERR
     C                     END
     C*                                                                   S01408
      *                                                                                       CDL013
      *** Check if CAR CDL013 is installed                                                    CDL013
     C                     CALL 'AOSARDR0'                                                    CDL013
     C                     PARM '*BLANKS' @RTCD                                               CDL013
     C                     PARM '*VERIFY' @OPTN                                               CDL013
     C                     PARM 'CDL013'  @SARD                                               CDL013
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL013
      *                                                                                       CDL013
      *** CAR CDL013 is NOT installed                                                         CDL013
     C           @RTCD     IFNE *BLANKS                                                       CDL013
     C                     MOVE 'N'       CDL013  1                                           CDL013
      *                                                                                       CDL013
      *** CAR CDL013 is installed                                                             CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C                     MOVE 'Y'       CDL013  1                                           CDL013
     C                     MOVEL'RETAIL'  ULSTAX 10 P                                         CDL013
      *                                                                                       CDL013
      *** Access WHT ICD record to determine WHT rate.                                        CDL013
     C                     OPEN SDSTAAL1                                                      CDL013
     C           ULSTAX    CHAINSDSTAAL1             70                                       CDL013
      *                                                                                       CDL013
     C           *IN70     IFEQ *ON                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'SDSTAAL1'DBFILE           ************                       CDL013
     C                     MOVEL'RETAIL'  DBKEY            * DBERR 50 *                       CDL013
     C                     Z-ADD50        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      *** Open Account Details Extension file                                                 CDL013
     C                     OPEN ACCNTBY0                                                      CDL013
      *                                                                                       CDL013
      *** Retrieve Base CCy details                                                           CDL013
     C                     MOVE BJCYCD    @CCY                                                CDL013
     C                     EXSR RTCCYS                                                        CDL013
     C                     MOVE @CCY      ZCCYT                                               CDL013
     C                     Z-ADDTRT,@I    ZRATET                                              CDL013
     C                     MOVE TDP,@I    ZCDPT                                               CDL013
     C                     MOVE TMD,@I    ZMDINT                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CCG016
     C                     MOVEL*BLANKS   CCG016  1                                           CCG016
     C                     CALL 'AOSARDR0'                                                    CCG016
     C                     PARM *BLANKS   PRTCD   7                                           CCG016
     C                     PARM '*VERIFY' POPTN   7                                           CCG016
     C                     PARM 'CCG016'  PSAR    6                                           CCG016
     C           PRTCD     IFEQ *BLANKS                                                       CCG016
     C                     MOVEL'Y'       CCG016                                              CCG016
     C                     END                                                                CCG016
      *                                                                                       CCG016
     C/COPY WNCPYSRC,RE4119CCP4                                           S01408
     C*                                                                   S01408
      *
      ** Define Transaction Type 1 details
     C                     MOVEL' '       @RVIN1  1
     C                     MOVELA1DCIN    @DCIN1  1
     C                     MOVELA1CIND    @CSIN1  1
     C                     MOVELA1CLIN    @CLIN1  1
     C                     MOVELA1PASB    @PASS1  2
     C                     MOVELA1RTNM    @NRTD1 30
      *
      ** Define Error Message Fields
     C                     MOVE *BLANKS   @MSGID  7
     C                     MOVEL'RTSMSGF' @MSGF  10
      *
      ** Initialise Screen fields
     C                     SETON                     10
     C                     MOVEL@PGM      SPGMQ
     C                     MOVEL@JOB      SWSID
     C                     MOVELBJMRDT    SMRDT
     C                     MOVEL@USER     SUSER
      *
      ** Initialise work fields and indicators
     C                     Z-ADD0         @TAMT  150
     C                     Z-ADD1         @WX     20
     C                     Z-ADDPCHTL     @CHTL
     C                     Z-ADDPNCTL     @NCTL
     C                     Z-ADDBJRDNB    @VLDT
     C                     Z-ADDBJRDNB    @RUND
     C                     Z-ADDBJRDNB    RUND    50
     C                     Z-ADD1         @COUNT  10
      *
      ** Get default charge transaction type for function
      *
     C                     CALL 'AOTCHGR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDTCHG    PARM SDTCHG    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD21        DBASE            ** DB ERR 21 *
     C                     MOVE 'SDTCHGPD'DBFILE           ***************
     C                     MOVEL'FIRST'   DBKEY
     C                     EXSR DBERR
     C                     END
      *                                                                   CRT007
      ** Determine if SAR CRT003 Cashier Interface is installed           CRT007
      *                                                                   CRT007
     C                     CALL 'AOSARDR0'                                CRT007
     C                     PARM *BLANKS   PRTCD   7                       CRT007
     C                     PARM '*VERIFY 'POPTN   7                       CRT007
     C                     PARM 'CRT003'  PSARD   6                       CRT007
     C           SCSARD    PARM SCSARD    DSFDY                           CRT007
      *                                                                   CRT007
     C           PRTCD     IFNE *BLANKS                                   CRT007
     C           PRTCD     ANDNE'*NRF   '                                 CRT007
     C           *LOCK     IN   LDA                                       CRT007
     C                     MOVEL'SCSARDPD'DBFILE                          CRT007
     C                     Z-ADD8         DBASE                           CRT007
     C                     MOVEL'CRT003'  DBKEY                           CRT007
     C                     EXSR DBERR                                     CRT007
     C                     ENDIF                                          CRT007
      *                                                                   CRT007
     C           PRTCD     IFEQ *BLANKS                                   CRT007
     C                     MOVE 'Y'       CRT003                          CRT007
     C                     ELSE                                           CRT007
     C                     MOVE 'N'       CRT003                          CRT007
     C                     ENDIF                                          CRT007
      *                                                                   CRT002
      **  Load tellers to array.                                          CRT002
      *                                                                   CRT002
     C                     EXSR LODTLR                                    CRT002
     C/COPY WNCPYSRC,RE4119C013
      *
     C                     MOVE '0'       @FIRST                          CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
      **  Cheque Withdrawal in Non-Account Currency                       CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JL'                                     CRT002
     C                     MOVEL'RE4119'  P@QRC                           CRT002
     C                     MOVE '0JL '    P@QRC                           CRT002
      *                                                                   CRT002
      **  Sell Travellers Cheque in Non-Account Currency                  CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JW'                                     CRT002
     C                     MOVEL'RE4119'  P@QRC                           CRT002
     C                     MOVE '0JW '    P@QRC                           CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
     C/COPY ZSRSRC,RBOITMC1                                               CRT002
      *                                                                   CRT002
      * Check if CRT012 is switched on                                    CRT012
     C                     CALL 'AOSARDR0'                                CRT012
     C                     PARM           PRTCD   7                       CRT012
     C                     PARM '*VERIFY' POPTN   7                       CRT012
     C                     PARM 'CRT012'  PSARD   6                       CRT012
      *                                                                   CRT012
     C           PRTCD     IFEQ *BLANKS                                   CRT012
      *                                                                   CRT012
      * Check if Cashier Multiple Charges is On                           CRT012
     C                     MOVE *BLANKS   SVALK2                          CRT012
     C                     MOVE *BLANKS   SVALK3                          CRT012
     C                     MOVE *BLANKS   SVALK4                          CRT012
     C                     MOVE *BLANKS   SVALK5                          CRT012
     C                     MOVE *BLANKS   SVALK6                          CRT012
     C                     MOVE *BLANKS   SVALK7                          CRT012
     C                     MOVE *BLANKS   SVALK8                          CRT012
     C                     MOVE *BLANKS   SVALK7                          CRT012
     C                     MOVE *BLANKS   SVALK8                          CRT012
      *                                                                   CRT012
     C                     CALL 'AOSVALR0'                                CRT012
     C                     PARM *BLANKS   RTNCDE  7                       CRT012
     C                     PARM           SVALK1 20                       CRT012
     C                     PARM           SVAL1 200                       CRT012
     C                     PARM           SVALK2 20                       CRT012
     C                     PARM           SVAL2 200                       CRT012
     C                     PARM           SVALK3 20                       CRT012
     C                     PARM           SVAL3 200                       CRT012
     C                     PARM           SVALK4 20                       CRT012
     C                     PARM           SVAL4 200                       CRT012
     C                     PARM           SVALK5 20                       CRT012
     C                     PARM           SVAL5 200                       CRT012
     C                     PARM           SVALK6 20                       CRT012
     C                     PARM           SVAL6 200                       CRT012
     C                     PARM           SVALK7 20                       CRT012
     C                     PARM           SVAL7 200                       CRT012
     C                     PARM           SVALK8 20                       CRT012
     C                     PARM           SVAL8 200                       CRT012
     C                     PARM           SVALK9 20                       CRT012
     C                     PARM           SVAL9 200                       CRT012
     C                     PARM           SVALK0 20                       CRT012
     C                     PARM           SVAL10200                       CRT012
      *                                                                   CRT012
     C           RTNCDE    IFNE *BLANKS                                   CRT012
     C           SVAL10    IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK0    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL9     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK9    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL8     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK8    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL7     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK7    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL6     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK6    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL5     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK5    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL4     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK4    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL3     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK3    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL2     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK2    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL1     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK1    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           *LOCK     IN   LDA                                       CRT012
     C                     MOVEL'SDSVALPD'DBFILE           *************  CRT012
     C                     Z-ADD37        DBASE            * DB ERR 37 *  CRT012
     C                     EXSR DBERR                      *************  CRT012
     C                     ENDIF                                          CRT012
     C           SVAL11    IFEQ 'Y'                                       CRT012
     C                     MOVE 'Y'       CRT012  1                       CRT012
     C                     ELSE                                           CRT012
     C                     MOVE 'N'       CRT012                          CRT012
     C                     ENDIF                                          CRT012
     C*                                                                   CRT012
     C                     ELSE                                           CRT012
     C                     MOVE 'N'       CRT012                          CRT012
     C                     ENDIF                                          CRT012
      *                                                                   CRT012
      ** Check if CRE019 is switched on                                                       CRE019
      *                                                                                       CRE019
     C                     CALL 'AOSARDR0'                                                    CRE019
     C                     PARM           PRTCD                                               CRE019
     C                     PARM '*VERIFY' POPTN                                               CRE019
     C                     PARM 'CRE019'  PSARD                                               CRE019
     C           SCSARD    PARM SCSARD    DSFDY                                               CRE019
      *                                                                                       CRE019
     C           PRTCD     IFNE *BLANKS                                                       CRE019
     C           PRTCD     ANDNE'*NRF   '                                                     CRE019
     C           *LOCK     IN   LDA                                                           CRE019
     C                     MOVEL'SCSARDPD'DBFILE                                              CRE019
     C                     Z-ADD28        DBASE                                               CRE019
     C                     MOVEL'CRE019'  DBKEY                                               CRE019
     C                     EXSR DBERR                                                         CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C           PRTCD     IFEQ *BLANKS                                                       CRE019
     C                     MOVE 'Y'       CRE019  1                                           CRE019
     C                     ELSE                                                               CRE019
     C                     MOVE 'N'       CRE019                                              CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
      ** Check if CRT026 is switched on                                                       CRT026
      *                                                                                       CRT026
     C                     CALL 'AOSARDR0'                                                    CRT026
     C                     PARM *BLANKS   PRTCD                                               CRT026
     C                     PARM '*VERIFY' POPTN                                               CRT026
     C                     PARM 'CRT026'  PSARD                                               CRT026
     C           SCSARD    PARM SCSARD    DSFDY                                               CRT026
      *                                                                                       CRT026
     C           PRTCD     IFNE *BLANKS                                                       CRT026
     C           PRTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'SCSARDPD'DBFILE           ***************                    CRT026
     C                     Z-ADD38        DBASE            ** DB ERR 38 **                    CRT026
     C                     MOVEL'CRT026'  DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           PRTCD     IFEQ *BLANKS                                                       CRT026
     C                     MOVE 'Y'       CRT026  1                                           CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'N'       CRT026                                              CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CAP205
      ** Access SAR details file to see if CAP205 is installed.                               CAP205
      *                                                                                       CAP205
     C                     CALL 'AOSARDR0'                                                    CAP205
     C                     PARM *BLANKS   PRTCD                                               CAP205
     C                     PARM '*VERIFY' POPTN                                               CAP205
     C                     PARM 'CAP205'  PSARD                                               CAP205
     C           SCSARD    PARM SCSARD    DSFDY                                               CAP205
      *                                                                                       CAP205
     C                     MOVE 'N'       CAP205  1                                           CAP205
     C           PRTCD     IFEQ *BLANKS                                                       CAP205
     C                     MOVE 'Y'       CAP205                                              CAP205
     C                     ELSE                                                               CAP205
     C           PRTCD     IFNE '*NRF    '                                                    CAP205
     C           *LOCK     IN   LDA                                                           CAP205
     C                     MOVEL'SCSARDPD'DBFILE                                              CAP205
     C                     MOVEL'CAP205'  DBKEY                                               CAP205
     C                     Z-ADD58        DBASE                                               CAP205
     C                     EXSR DBERR                                                         CAP205
     C                     ENDIF                                                              CAP205
     C                     ENDIF                                                              CAP205
      *                                                                                       CRT026
      ** Check if CDL081 is installed                                                         CDL081
      *                                                                                       CDL081
     C                     MOVE 'N'       CDL081  1                                           CDL081
     C                     CALL 'AOSARDR0'                                                    CDL081
     C                     PARM *BLANKS   PRTCD                                               CDL081
     C                     PARM '*VERIFY' POPTN                                               CDL081
     C                     PARM 'CDL081'  PSARD                                               CDL081
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL081
      *                                                                                       CDL081
     C           PRTCD     IFNE *BLANKS                                                       CDL081
     C           PRTCD     ANDNE'*NRF   '                                                     CDL081
     C           *LOCK     IN   LDA                                                           CDL081
     C                     Z-ADD056       DBASE                                               CDL081
     C                     MOVE 'SCSARDPD'DBFILE                                              CDL081
     C                     MOVEL'CDL081'  DBKEY                                               CDL081
     C                     EXSR DBERR                                                         CDL081
     C                     END                                                                CDL081
      *                                                                                       CDL081
     C           PRTCD     IFEQ *BLANKS                                                       CDL081
     C                     MOVE 'Y'       CDL081                                              CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL081
      ** Access withholding tax round down system values if CDL081 is on                      CDL081
      *                                                                                       CDL081
     C           CDL081    IFEQ 'Y'                                                           CDL081
     C                     CALL 'AOSVALR0'                                                    CDL081
     C                     PARM *BLANKS   PRTCD                                               CDL081
     C                     PARM C#BASE    SVALK1 20                                           CDL081
     C                     PARM           SVAL1 200                                           CDL081
     C                     PARM C#NBAS    SVALK2 20                                           CDL081
     C                     PARM           SVAL2 200                                           CDL081
     C                     PARM *BLANK    SVALK3 20                                           CDL081
     C                     PARM           SVAL3 200                                           CDL081
     C                     PARM *BLANK    SVALK4 20                                           CDL081
     C                     PARM           SVAL4 200                                           CDL081
     C                     PARM *BLANK    SVALK5 20                                           CDL081
     C                     PARM           SVAL5 200                                           CDL081
     C                     PARM *BLANK    SVALK6 20                                           CDL081
     C                     PARM           SVAL6 200                                           CDL081
     C                     PARM *BLANK    SVALK7 20                                           CDL081
     C                     PARM           SVAL7 200                                           CDL081
     C                     PARM *BLANK    SVALK8 20                                           CDL081
     C                     PARM           SVAL8 200                                           CDL081
     C                     PARM *BLANK    SVALK9 20                                           CDL081
     C                     PARM           SVAL9 200                                           CDL081
     C                     PARM *BLANK    SVALK0 20                                           CDL081
     C                     PARM           SVAL10200                                           CDL081
      *                                                                                       CDL081
     C           PRTCD     IFNE *BLANKS                                                       CDL081
     C           *LOCK     IN   LDA                                                           CDL081
     C                     Z-ADD057       DBASE                                               CDL081
     C                     MOVE 'SDSVALPD'DBFILE                                              CDL081
     C           SVAL1     IFEQ '*NRF'                                                        CDL081
     C                     MOVELSVALK1    DBKEY                                               CDL081
     C                     ENDIF                                                              CDL081
     C           SVAL2     IFEQ '*NRF'                                                        CDL081
     C                     MOVELSVALK2    DBKEY                                               CDL081
     C                     ENDIF                                                              CDL081
     C                     EXSR DBERR                                                         CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL081
      ** Setup tax amount rounding down indicators                                            CDL081
      *                                                                                       CDL081
     C                     MOVELSVAL1     W#BSRD  1                                           CDL081
     C                     MOVELSVAL2     W#NBRD  1                                           CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL081
      ** Perform Account Balance Check in RPG if feature CRE081 is ON                         CRE081
      *                                                                                       CRE081
     C                     CALL 'AOSARDR0'                                                    CRE081
     C                     PARM *BLANKS   PRTCD                                               CRE081
     C                     PARM '*KEY   ' POPTN                                               CRE081
     C                     PARM 'CRE081'  PSARD                                               CRE081
     C           SCSARD    PARM SCSARD    DSFDY                                               CRE081
      *                                                                                       CRE081
     C                     MOVE 'N'       CRE081  1                                           CRE081
     C           PRTCD     IFEQ *BLANKS                                                       CRE081
     C                     MOVE 'Y'       CRE081                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C/COPY WNCPYSRC,REH00175
     C                     ENDSR
      *****************************************************************
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CCP5                                           S01408
     C*                                                                   S01408
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CCP7                                           S01408
     C*                                                                   S01408
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CCP6                                           S01408
     C*                                                                   S01408
      *****************************************************************   CRT002
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            PCMTXT - Prepare Commitment Text                   *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY         -                                           *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           PCMTXT    BEGSR                           ** PCMTXT **   CRT002
      *                                                                   CRT002
      **  Prepare the comit text CMTTXT                                   CRT002
      *                                                                   CRT002
     C                     MOVE 'RE'      MDID                            CRT002
     C                     MOVEL@PGM      PGMN                            CRT002
     C                     MOVE SWSID     WSIDX                           CRT002
     C                     MOVEL@USER     USRIDX                          CRT002
     C                     TIME           MTIME                           CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            FMTCHG - Format Charge Amount.                     *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY         -                                           *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           FMTCHG    BEGSR                           ** FMTCHG **   CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   SCAMT                           CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C                     Z-ADD0         ZADIG                           CRT002
     C                     Z-ADD0         ZADEC                           CRT002
      *                                                                   CRT002
      * If in batch mode then simply move amount into WCHAMT field        CRT012
      * to @TCHG field as no need to use ZALIGN.                          CRT012
     C           PMODE     IFEQ 'P'                                       CRT012
     C                     MOVE WCHAMT    @TCHG                           CRT012
     C                     ELSE                                           CRT012
     C                     MOVELWCHAMT    ZFIELD                          CRT002
      *                                                                   CRT002
     C           WCHCCY    IFEQ SCCY2                                     CRT002
     C                     Z-ADD@EQDP     ZADEC                           CRT002
     C                     ELSE                                           CRT002
     C           WCHCCY    IFEQ SCCY1                                     CRT002
     C           WCHCCY    OREQ SCCY                                      118271
     C                     Z-ADD@TCDP     ZADEC                           CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           15        SUB  ZADEC     ZADIG                           CRT002
      *                                                                   CRT002
     C                     EXSR ZALIGN                                    CRT002
      *                                                                   CRT002
     C           *IN99     IFEQ '0'                                       CRT002
     C           ZFIELD    ANDNE*ZERO                                     CRT002
      *                                                                   CRT002
     C******************   MOVE WCHAMT    SCAMT                     CRT002118133
     C                     MOVELWCHAMT    SCAMT                           118133
     C                     MOVE ZFIELD    @TCHG                           CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
     C           *IN99     IFEQ '1'                                       CRT002
     C                     SETON                     1769                 CRT002
     C                     MOVE 'USR0008' WUMSID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT012
      ************************************************************ CRT002 171139
      ****Blank*out*default*transaction*type*when*charge*amount*is CRT002 171139
      ************************************************************ CRT002 171139
     C***********SCAMT     IFEQ *BLANKS                            CRT002 171139
     C***********          MOVEL*BLANKS   SCTRTY                   CRT002 171139
     C***********          ENDIF                                   CRT002 171139
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT
      *****************************************************************
      *                                                               *
      *            DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLS      *PSSR  - Program  error                            *
      *                                                               *
      * CALLED BY  WRKACC - Work with account                         *
      *            VSACNO - Validate account number                   *
      *            DSPBAL - Display account balances                  *
      *            VACCLO - Validate account closure                  *
      *            UTRANT - Update teller transaction trailer         *
      *            UTNTM2 - Update teller controls                    *
      *            UTNTM3 - Update teller totals                      *
      *            UMEMOS - Update memos                              *
      *            UACNUM - Update accounts                           *
      *            UCHQBK - Update cheque book                        *
      *            ACLOSE - A/C closure enquiry                       *
      *            FIRST  - Initial Processing                        *
      *            UPTRL  - Update Control Trailer Record             *                       CRE019
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DBERR     BEGSR                           ** DBERR  **
      *
     C                     MOVEL@PGM      DBPGM
     C                     OUT  LDA
      *
     C                     EXSR *PSSR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            LAST   - Final Processing                          *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           LAST      BEGSR                           ** LAST   **
      *
     C                     CLOSE*ALL                   69
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              CEU024
      *****************************************************************   CEU024
      *                                                               *   CEU024
      *  SREURO - Retrieval of currency details                       *   CEU024
      *                                                               *   CEU024
      *  Called by: VSACNO - Validate account number                  *   CEU024
      *             VALDET - Validate details                         *   CEU024
      *             VSCCY  - Validate currency code                   *   CEU024
      *             FIRST  - Initial Processing                       *   CEU024
      *                                                               *   CEU024
      *  Calls:     None                                              *   CEU024
      *                                                               *   CEU024
      *****************************************************************   CEU024
      *                                                                   CEU024
     C           SREURO    BEGSR                                          CEU024
      *                                                                   CEU024
     C           @CCY      IFEQ BKEURO                                    CEU024
     C                     MOVE 'E'       TEU,@I                          CEU024
     C                     ELSE                                           CEU024
     C                     MOVE A6INCY    TEU,@I                          CEU024
     C                     Z-ADDA6TPSD    STP,@I                          CEU024
     C                     Z-ADDA6TPED    ETP,@I                          CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     Z-ADDA6EUER    EUR,@I                          CEU024
     C                     MOVE A6EUMD    EUI,@I                          CEU024
      *                                                                   CEU024
     C                     ENDSR                                          CEU024
      *****************************************************************   CEU024
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR             - Program error                             *
      *                                                               *
      * CALLS      DBERRCTL                                           *
      *                                                               *
      * CALLED BY  DBERR  - Database Error Handling                   *
      *                                                               *
      *****************************************************************
     C           *PSSR     BEGSR                           ** *PSSR  **
     C*
     C** Check to see that *PSSR has not been called yet
     C*
     C           WRUN      IFEQ *BLANK
     C                     MOVE 'Y'       WRUN    1
     C                     SETON                     U7U8LR
     C                     DUMP
     C*
     C** Call standard database error program
     C*
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     CALL 'DBERRCTL'
     C                     END                                            CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           @FIRST    ANDEQ'0'                                       CRT002
      *                                                                   CRT002
     C                     ROLBK                                          CRT002
      *                                                                   CRT002
     C                     MOVELRAMSTY    RBMSTY                          CRT002
     C                     MOVELDBKEY     RBHSMS                          CRT002
     C                     MOVEL'DBER'    RBHMSI                          CRT002
     C                     MOVEL'1'       RBAEFL                          CRT002
     C                     MOVEL'E'       RBHMSS                          CRT002
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
      *                                                                   CRT002
     C                     MOVEL'USR0010' @MSGID                          CRT002
     C                     MOVELDBLOT     @MSGDT                          CRT002
     C                     EXSR RTVMSG                                    CRT002
     C                     MOVEL@MSGTX    RBHSMS                          CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVE 'DS'      WSTAT                           CRT002
     C                     MOVE 'N'       WSUCM                           CRT002
     C                     TIME           WTMDS                           CRT002
     C           WTHR      CAT  ':'       WA                              CRT002
     C           WTMN      CAT  ':'       WB                              CRT002
     C           WA        CAT  WB        WC                              CRT002
     C           WC        CAT  WTSS      WSTTM                           CRT002
      *                                                                   CRT002
     C                     MOVELREPOIO    P@QDS                           CRT002
      *                                                                   CRT002
     C                     CLEARWCMSG                                     CRT002
     C                     MOVELP@QDS     WCMSG                           CRT002
      *                                                                   CRT002
     C                     EXSR SDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
     C                     EXSR WRLOG                                     CRT002
      *                                                                   CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   REPOIO                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
     C*
     C                     END
     C*
     C** If *PSSR already run, then just end the program here
     C*
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP12                                           S01408
     C*                                                                   S01408
      *****************************************************************
      /EJECT                                                              144506
      *****************************************************************   144506
      *                                                               *   144506
      *            ZSEFMT - Format rate field for output              *   144506
      *                                                               *   144506
      * CALLS             -                                           *   144506
      *                                                               *   144506
      * CALLED BY  RFRDET - Refresh details screen                    *   144506
      *                                                               *   144506
      * FLDS USED         -                                           *   144506
      *                                                               *   144506
      *****************************************************************   144506
     C           ZSEFMT    BEGSR                           ** ZSEFMT **   144506
      *                                                                   144506
     C                     MOVE *BLANK    ZRT13A 14        O/P FIELD      144506
     C                     MOVE ZPBAS     ZPBAS   1        I/P FIELD      144506
     C                     MOVE '0'       *IN94                           144506
     C*                                                                   144506
     C                     MOVEA*BLANKS   OUT                             144506
     C                     Z-ADD1         J       20                      144506
     C*                                                                   144506
     C** CLEAR LEADING ZEROS                                              144506
     C*                                                                   144506
     C           J         DOWLE5                                         144506
     C           *IN94     IFEQ '0'                                       144506
     C           RAT,J     IFEQ 0                                         144506
     C                     MOVE ' '       OUT,J                           144506
     C                     ELSE                                           144506
     C                     MOVE RAT,J     OUT,J                           144506
     C                     SETON                     94                   144506
     C                     END                                            144506
     C                     ELSE                                           144506
     C                     MOVE RAT,J     OUT,J                           144506
     C                     END                                            144506
     C                     ADD  1         J                               144506
     C                     END                                            144506
     C*                                                                   144506
     C** MOVE IN DECIMAL POINT                                            144506
     C*                                                                   144506
     C           J         IFEQ 6                                         144506
     C           *IN94     IFEQ '0'                                       144506
     C                     MOVE '0'       OUT,5                           144506
     C                     END                                            144506
     C                     MOVE '.'       OUT,J                           144506
     C                     END                                            144506
     C*                                                                   144506
     C** POSITION DECIMALS                                                144506
     C*                                                                   144506
     C                     Z-ADD13        J                               144506
     C                     Z-ADD14        K       20                      144506
     C           J         DOWGE6                                         144506
     C                     MOVE RAT,J     OUT,K                           144506
     C                     SUB  1         J                               144506
     C                     SUB  1         K                               144506
     C                     END                                            144506
     C*                                                                   144506
     C** LEFT-ALIGN VALUES INTO O/P FIELD                                 144506
     C*                                                                   144506
     C                     Z-ADD0         P                               144506
     C           1         DO   14        K                               144506
     C           OUT,K     IFNE ' '                                       144506
     C                     ADD  1         P                               144506
     C                     MOVE OUT,K     OUT2,P                          144506
     C                     END                                            144506
     C                     ENDDO                                          144506
     C*                                                                   144506
     C           OUT2,5    IFEQ '.'                                       144506
     C                     MOVE ' '       OUT2,5                          144506
     C                     END                                            144506
     C*                                                                   144506
     C** FINALLY MOVE  EDITED FIELD INTO O/P FIELD                        144506
     C*                                                                   144506
     C                     MOVEAOUT2      ZRT13A                          144506
      *                                                                   144506
     C                     ENDSR                                          144506
      *****************************************************************   144506
      *****************************************************************   198870
      /EJECT                                                              198870
      *****************************************************************   198870
      *                                                               *   198870
      *            PAD    - Pad field with leading zeros.             *   198870
      *                                                               *   198870
      * CALLS             -                                           *   198870
      *                                                               *   198870
      * CALLED BY  WRKACC - Work with account                         *   198870
      *                                                               *   198870
      * FLDS USED         -                                           *   198870
      *                                                               *   198870
      *****************************************************************   198870
     C           PAD       BEGSR                                          198870*** PAD    ***
      *                                                                   198870
      **  Pad field with zeros to coincide with Cashier format.           198870
      *                                                                   198870
     C                     Z-ADD1         L       20                      198870
     C                     Z-ADD0         WEND    20                      198870
     C           ' '       CHECKWFIELD    WEND                            198870
     C                     MOVEA*BLANKS   RTE,1                           198870
     C                     MOVEAWFIELD    RTE,1                           198870
      *                                                                   198870
     C           L         DOWLTWEND                                      198870
     C                     MOVEL'0'       RTE,L                           198870
     C                     ADD  1         L                               198870
     C                     ENDDO                                          198870
      *                                                                   198870
      **  Replace any commas caused by County-specific character sets     198870
      **  by decimal points to ensure Cashier compatibility.              198870
      *                                                                   198870
     C                     Z-ADD1         X                               198870
     C                     MOVE '0'       *IN68                           198870
      *                                                                   198870
     C           ','       LOKUPRTE,X                  60                 198870
     C           *IN60     IFEQ *ON                                       198870
     C                     MOVEL'.'       RTE,X                           198870
     C                     ENDIF                                          198870
      *                                                                   198870
     C                     ENDSR                                          198870
      *                                                                   198870
      *****************************************************************   198870
      *---------------------------------------------------------------*                       CDL013
     C           #ERTCL    BEGSR                                                              CDL013
      *                                                                                       CDL013
      ** Define parameters                                                                    CDL013
      *                                                                                       CDL013
     C                     Z-ADD@ACNO     @ACNO  100                                          CDL013
     C                     Z-ADD@CLBL     @CLBL  150                                          CDL013
     C                     Z-ADD@CHRG     @CHRG  150                                          CDL013
     C                     Z-ADD@INTR     @INTR  150                                          CDL013
     C                     Z-ADD@CLOB     @CLOB  150                                          CDL013
      *                                                                                       CDL013
     C                     Z-ADD@INTT     @INTT  150                                          CDL013
     C                     Z-ADD@WTAX     @WTAX  150                                          CDL013
     C                     Z-ADD@ACOD     @ACOD  100                                          CDL013
     C                     Z-ADDRHISD     RHISD   50                                          CDL013
     C                     Z-ADDRHISB     RHISB  150                                          CDL013
      *                                                                                       CDL013
      * Retrieve retail interest and charges                                                  CDL013
      *                                                                                       CDL013
     C           KLACNT    CHAINREIAC                80                                       CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '1'                                                           CDL013
      *                                                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL@ACCN     DBKEY                                               CDL013
     C                     MOVEL'REIAC'   DBFILE                                              CDL013
      *                                                                                       CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      * Retrieve retail interest accrual ITD                                                  CDL013
      *                                                                                       CDL013
     C           KLACNT    CHAINREACR                80                                       CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '1'                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL@ACNO     DBKEY                                               CDL013
     C                     MOVEL'REACR'   DBFILE                                              CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** If no database errors                                                                CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '0'                                                           CDL013
      *                                                                                       CDL013
      ** Calculate charges                                                                    CDL013
      *                                                                                       CDL013
     C                     Z-ADDCHGT      @CHGT                                               CDL013
     C                     Z-ADDCHST      @CHST                                               CDL013
     C                     MOVEL@CCY      @CHCY                                               CDL013
     C                     MOVELCHAC      @CHAC                                               CDL013
     C                     Z-ADDRCA       @RCA                                                CDL013
     C                     Z-ADDNRCA      @NRCA                                               CDL013
     C                     Z-ADDLCD       RHISD                                               CDL013
     C                     Z-ADDHISB      RHISB                                               CDL013
      *                                                                                       CDL013
      *                                                                                       CDL013
      ** Get fixed account charge                                                             CDL013
      *                                                                                       CDL013
     C                     MOVE @BRCA     @BRCDX  3                                           CDL013
     C           KFXA      CHAINREFXAJL0             88                                       CDL013
     C                     Z-ADDRYACCH    @FXACM                                              CDL013
      *                                                                                       CDL013
     C                     EXSR RTCHRG                                                        CDL013
      *                                                                                       CDL013
      *  Calculate commissions - added to @CHRG                                               CDL013
      *                                                                                       CDL013
     C                     EXSR RTCOMM                                                        CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '0'                                                           CDL013
      *                                                                                       CDL013
      ** Calculate interest                                                                   CDL013
      *                                                                                       CDL013
     C                     MOVELDACP      @DACP  21                                           CDL013
     C                     MOVELCACP      @CACP  21                                           CDL013
     C                     Z-ADDMADI      @MADI  130                                          CDL013
     C                     Z-ADDMACI      @MACI  130                                          CDL013
     C                     Z-ADDGADI      @GADI  130                                          CDL013
     C                     Z-ADDGACI      @GACI  130                                          CDL013
     C                     Z-ADDDAIC1     @DAIC1 130                                          CDL013
     C                     Z-ADDCAIC1     @CAIC1 130                                          CDL013
      *                                                                                       CDL013
     C                     EXSR RTINTR                                                        CDL013
      *                                                                                       CDL013
      ** Add net-interest & service charge to close balance                                   CDL013
      *                                                                                       CDL013
     C           @INTR     ADD  @CHRG     @CLOB                                               CDL013
      *                                                                                       CDL013
      ** If the customer is liable calculate tax                                              CDL013
      *                                                                                       CDL013
     C           BBCSTY    IFNE 'N'                                                           CDL013
      *                                                                                       CDL013
      ** Include withholding tax in closing balance                                           CDL013
      *                                                                                       CDL013
      ** If SDSTAXPD/TXWNDI is 'Y', compute tax from net interest (sum                        CDL013
      ** of DR and CR interests).  Else, compute tax from gross                               CDL013
      ** interest (CR interest only).                                                         CDL013
      *                                                                                       CDL013
     C           TXWNDI    IFEQ 'Y'                                                           CDL013
     C                     Z-ADD@INTR     @INTT                                               CDL013
     C                     ELSE                                                               CDL013
     C                     Z-SUB@CRINT    @INTT                                               CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** If the resulting interest is zero or debit, no need to compute                       CDL013
      ** for the w/holding tax.  It is automatically equal to zero.                           CDL013
      *                                                                                       CDL013
     C           @INTT     IFGE *ZERO                                                         CDL013
     C                     Z-ADD*ZERO     @WTAX                                               CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      * Retrieve Taxable indicator for this Account.                                          CDL013
      *                                                                                       CDL013
     C           ACNTXF    KLIST                                                              CDL013
     C                     KFLD           @CNUM                                               CDL013
     C                     KFLD           @CCY                                                CDL013
     C                     KFLD           @ACOD                                               CDL013
     C                     KFLD           @ACSQ                                               CDL013
     C                     KFLD           @BRCDX                                              CDL013
      *                                                                                       CDL013
     C           ACNTXF    CHAINACCNTBY0             70                                       CDL013
     C           *IN70     IFEQ *ON                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'ACCNTBY0'DBFILE           ************                       CDL013
     C                     MOVEL@CNUM     DBKEY            * DBERR 22 *                       CDL013
     C                     Z-ADD22        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      *** If Tax indicator is ZERO set WHT rate to ZERO,                                      CDL013
      *** otherwise set WHT rate.                                                             CDL013
     C                     SELEC                                                              CDL013
     C           ATITAX    WHEQ '0'                                                           CDL013
     C                     Z-ADD0         ULWHTR  52                                          CDL013
     C           ATITAX    WHEQ '1'                                                           CDL013
     C                     Z-ADDETXR1     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '2'                                                           CDL013
     C                     Z-ADDETXR2     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '3'                                                           CDL013
     C                     Z-ADDETXR3     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '4'                                                           CDL013
     C                     Z-ADDETXR4     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '5'                                                           CDL013
     C                     Z-ADDETXR5     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '6'                                                           CDL013
     C                     Z-ADDETXR6     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '7'                                                           CDL013
     C                     Z-ADDETXR7     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '8'                                                           CDL013
     C                     Z-ADDETXR8     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '9'                                                           CDL013
     C                     Z-ADDETXR9     ULWHTR                                              CDL013
     C                     ENDSL                                                              CDL013
      *                                                                                       CDL013
      *** If WHT rate is ZERO set tax amount to ZERO.                                         CDL013
     C           ULWHTR    IFEQ *ZERO                                                         CDL013
     C                     Z-ADD0         @WTAX                                               CDL013
      *                                                                                       CDL013
      *** otherwise calculate tax amount.                                                     CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      *** If Account currency is in Base Currency.                                            CDL013
      *** and CDL081 is off                                                                   CDL081
      *                                                                                       CDL081
     C           @CCY      IFEQ BJCYCD                                                        CDL013
     C           CDL081    ANDEQ'N'                                                           CDL081
      *                                                                                       CDL013
      *** Set work adjustment field according to number of decimal                            CDL013
      *** places in currency before calculating the tax amount.                               CDL013
     C                     SELEC                                                              CDL013
     C           ZCDPT     WHEQ 0                                                             CDL013
     C                     Z-ADD1         ULWKAD  40                                          CDL013
     C           ZCDPT     WHEQ 1                                                             CDL013
     C                     Z-ADD10        ULWKAD                                              CDL013
     C           ZCDPT     WHEQ 2                                                             CDL013
     C                     Z-ADD100       ULWKAD                                              CDL013
     C           ZCDPT     WHEQ 3                                                             CDL013
     C                     Z-ADD1000      ULWKAD                                              CDL013
     C                     ENDSL                                                              CDL013
      *                                                                                       CDL013
      *** Account currency is in Base Currency round down gross                               CDL013
      *** Interest Amount.                                                                    CDL013
     C           @INTT     DIV  ULWKAD    ULTINT 150                                          CDL013
     C                     MULT ULWKAD    ULTINT                                              CDL013
      *                                                                                       CDL013
      *** calculate Tax Amount.                                                               CDL013
     C           ULTINT    MULT ULWHTR    @WTAX                                               CDL013
     C                     DIV  100       @WTAX                                               CDL013
      *                                                                                       CDL013
      *** round down Tax Amount.                                                              CDL013
     C           @WTAX     DIV  ULWKAD    @WTAX  150                                          CDL013
     C                     MULT ULWKAD    @WTAX                                               CDL013
      *                                                                                       CDL013
      *** otherwise (Account Ccy NOT = Base Ccy) calculate                                    CDL013
      *** Tax amount without rounding down.                                                   CDL013
     C                     ELSE                                                               CDL013
     C           @INTT     MULT ULWHTR    @WTAX                                               CDL013
      *                                                                                       CDL081
      ** Check if tax amount is to be rounded down                                            CDL081
      *                                                                                       CDL081
     C           @CCY      IFEQ BJCYCD                                                        CDL081
     C           CDL081    ANDEQ'Y'                                                           CDL081
     C           W#BSRD    ANDEQ'Y'                                                           CDL081
     C           @CCY      ORNE BJCYCD                                                        CDL081
     C           CDL081    ANDEQ'Y'                                                           CDL081
     C           W#NBRD    ANDEQ'Y'                                                           CDL081
     C                     DIV  100       @WTAX                                               CDL081
     C                     ELSE                                                               CDL081
     C                     DIV  100       @WTAX     H                                         CDL013
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL013
      ** Calculate the interest amount in base currency (ULTINT)                              CDL013
      *                                                                                       CDL013
      ** Retrieve Account Ccy details                                                         CDL013
     C                     EXSR RTCCYS                                                        CDL013
     C                     MOVE @CCY      ZCCYF                                               CDL013
     C                     Z-ADDTRT,@I    ZRATEF                                              CDL013
     C                     MOVE TDP,@I    ZCDPF                                               CDL013
     C                     MOVE TMD,@I    ZMDINF                                              CDL013
      *                                                                                       CDL013
      ** Set amount in the Account Ccy                                                        CDL013
     C                     Z-ADD@INTT     ZAMTF                                               CDL013
      *                                                                                       CDL013
      ** Convert the amount to the Base Ccy                                                   CDL013
     C                     EXSR RTCCYX                                                        CDL013
      *                                                                                       CDL013
      ** Set amount in the Base Ccy                                                           CDL013
     C                     Z-ADDZAMTT     ULTINT                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Access account code details                                                          CDL013
      *                                                                                       CDL013
     C                     MOVE @ACOD     @ACODA 10                                           CDL013
      *                                                                                       CDL013
     C                     CALL 'AOACODR0'                                                    CDL013
     C                     PARM *BLANKS   @RTCD                                               CDL013
     C                     PARM '*KEY   ' @OPTN                                               CDL013
     C                     PARM           @ACODA                                              CDL013
     C           SDACOD    PARM SDACOD    DSFDY                                               CDL013
      *                                                                                       CDL013
      ** Error in SDACODPA                                                                    CDL013
      *                                                                                       CDL013
     C           @RTCD     IFNE *BLANKS                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'SDACODPD'DBFILE           ************                       CDL013
     C                     MOVEL@ACODA    DBKEY            * DBERR 29 *                       CDL013
     C                     Z-ADD29        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Check if the interest amount in base ccy is below minimum                            CDL013
     C                     Z-SUBULTINT    ULTINT                                              CDL013
     C           ULTINT    IFLT A5MISU                                                        CDL013
     C                     Z-ADD*ZERO     @WTAX                                               CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Subtract Withholding Tax from Close Balance                                          CDL013
      *                                                                                       CDL013
     C                     Z-SUB@WTAX     @WTAX                                               CDL013
     C                     ADD  @WTAX     @CLOB                                               CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Add cleared balance to close balance                                                 CDL013
      *                                                                                       CDL013
     C                     ADD  @CLBL     @CLOB                                               CDL013
      *                                                                                       CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVE 'RECRG'   DBFILE                                              CDL013
     C                     MOVEL@KEY      DBKEY                                               CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDSR                                                              CDL013
      *****************************************************************                       CDL013
      *****************************************************************                       CDL013
      /EJECT
      /COPY ZSRSRC,RTENCPC1
      ** Passcode encription
      *
      *****************************************************************
      *
      *****************************************************************
      /EJECT
      *
      /COPY ZSRSRC,RTCOMMC1
      *                                                                   106661
      /EJECT                                                              106661
      /COPY ZSRSRC,RTCLOSC1                                               106661
     C********************************************************************
      /EJECT
      *
      /COPY ZSRSRC,RTCCYXC1
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4119CP21                                           S01408
     C*                                                                   S01408
     C********************************************************************
      /EJECT
      *
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBSDQMS                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBRDQMS                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBDQERR                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBMODTC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBRMSGC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBWLOGC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBCXRTC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBLDTLC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBSLTCC1                                               CRT002
      **  SR.VALCQS Subroutine                                            CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,ZDATE9Z3                                               CRT002
      *                                                                   CEU024
      */EJECT                                                      CEU024 151260
     C*/C*PY*ZSRSRC,ZXRATEZ1******                                 CEU024 151260
      *                                                                   150864
      /EJECT                                                              150864
     C/COPY ZSRSRC,RTZXRTC1                                               150864
      *                                                                   CEU024
      /EJECT                                                              CEU024
      /COPY ZSRSRC,RTCOEUC1                                               CEU024
      *                                                                   CRT002
      /COPY ZSRSRC,RBCCHGC1                                               CRT012
      ** Charges Split                                                    CRT012
      *                                                                   CRT012
      ** Account Details
     OACCNTABFE                @RLACC
      *
      ** Account Trailer
     OACCNTACFE                @UPACC
      *
     O                         NORE
     O                         NINU
     O                         NOAM
     O                         NOCL
     O                         NOAU
     O                         LCD
     O                         TNLU
      *
      ** Retail Shadow Balances
     O****MEMOSMDFE*****           @RLMEM                                 CCB002
      *
      ** Cheque book details
     OCHQBKPDFE                @RLCQB
      *
      ** Teller controls
     OTTRNTM2FE                @RELTT
      *
      *****************************************************************
     O*                                                                   S01408
     O/COPY WNCPYSRC,RE4119OOP1                                           S01408
**   CPY@  **        OBJECT COPYRIGHT
(c) Misys International Banking Systems Ltd. 2001
**   ZYDY - Years in days cumulative, four year span
0366073110961461
**   ZMDY - Months in days cumulative through year
000031059090120151181212243273304334365
**   ZMNM - Months short names
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** - @P   - Array to hold the positions of the validation indicators
01020304050607080910111213141516171819202122232425
**  alphanumeric table
ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789
**  encription code table
SDKJFIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJ
FIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJFIEN
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
** @TXT - Large text strings                                              CRT002
OVRDBF     FILE(TTRANPD) MBR(XXXX) SECURE(*YES) SHARE(*YES) SEQONLY(*NO)
OVRDBF     FILE(TTRANPT) MBR(XXXX) SECURE(*YES) SHARE(*YES) SEQONLY(*NO)
DLTOVR     FILE(TTRANPD)
DLTOVR     FILE(TTRANPT)
**  WTEXT WARNING TEXT MESSAGE                                            CRT002
KSM2329  Multiple referrals exist ( ) -                                   CRT002
**  TABC1/TABC2 - WARNING MESSAGE CONVERTION TABLE                        CRT002
HOLDS   HLDS                                                              CRT002
EXCESS  EXCS                                                              CRT002
FLOAT   FLOT                                                              CRT002
CLS.O/D CSOD                                                              CRT002
SVG.O/D SVOD                                                              CRT002
MAX.CCY MXCY                                                              CRT002
CHQBKER CQBK                                                              CRT002
N.S.F.  NSF                                                               CRT002
EX.O/D  EXOD                                                              CRT002
BLW.MIN BLMN                                                              CRT002
AC.CLG  ACCL                                                              CRT002
N.ASGL1 NAG1                                                              CRT002
N.ASGL2 NAG2                                                              CRT002
N.ASGL3 NAG3                                                              179321
BADDPT  BDDT                                                              CRT002
BLOCKCR BLCR                                                              CRT002
BLOCKDR BLDR                                                              CRT002
BNKRPT  BKRP                                                              CRT002
BR.DIF  BRDF                                                              CRT002
BR.DIF1 BRD1                                                              190137
BR.DIF2 BRD2                                                              190137
BFBVIC  BVCQ                                                              CRT002
CHQPRES CQPR                                                              CRT002
CHQRNG  CQRN                                                              CRT002
INACTV  INAC                                                              CRT002
INACTV1 INA1                                                              179321
INACTV2 INA2                                                              179321
REFERCR RFCR                                                              CRT002
REFERDR RFDR                                                              CRT002
STOPCHQ STCQ                                                              CRT002
TLIMIT  TLLM                                                              CRT002
N.WKDAY NWKD                                                              CRT002
XRTWARN XRTW                                                              CRT002
TLIMIT1 TLLM                                                              142092
TLIMIT2 TLLM                                                              142092
CLOSED  CLOS                                                              142092
BLOCKED BLOK                                                              142092
NOTZERO NZRO                                                              142092
BR.OFF  BOFF                                                              CRT007
BR.OFF1 BOF1                                                              CRT007
BR.OFF2 BOF2                                                              CRT007
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
