     H        1
     F*****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE Foreign exchange transactions')               *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Retail Module                                        *
     F*                                                               *
     F*  RE4120 - Foreign Exchange Transactions                       *
     F*                                                               *
     F*  Function:  This program accepts and validates foreign        *
     F*   (I/C)     exchange (Bureau de Change) transactions and      *
     F*             performs file updates to the teller system        *
     F*             master files.  A transaction confirmation slip    *
     F*             is generated during this transaction, a a         *
     F*             receipt for the customer.                         *
     F*                                                               *
     F*  Called By: REC4120 - Foreign Exchange Transactions           *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. MD042577           Date 28Nov16               *
      *  Prev Amend No. 218877             Date 26Aug15               * 
      *                 MD042745           Date 20Nov16               *
      *                 CCG016             Date 13Sep16               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 CAP187             Date 21Aug09               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 253895 (BUG17972)  Date 28Apr08               *
      *                 249179             Date 19Jul07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 BUG8514            Date 14Jun06               *
      *                 CRT026             Date 23May06               *
      *                 CSD027             Date 09Dec05               *
      *                 BUG7819            Date 30Aug05               *
      *                 Bug3855            Date 03Aug04               *
      *                 BUG2849            Date 06Jun04               *
      *                 CRE019             Date 15Mar04               *
      *                 CGL029             Date 01Sep03               *
      *                 222373             Date 24Oct03               *
     F*                 CRT012             Date 26Nov02               *
      * Midas Release 4.01 -------------------------------------------*
     F*                 CRT007             Date 14Jan02               *
     F*                 CRT005             Date 27Nov01               *
      *                 198870             Date 12Oct01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 194978             Date 28Jun01               *
      *                 CRT006             Date 17Apr01               *
      *                 190687             Date 05Mar01               *
      *                 193529             Date 29May01               *
      *                 190137             Date 18Apr01               *
     F*                 152325             Date 17Apr01               *
      * Midas DBA 3.04 -----------------------------------------------*
     F*                 184553             Date 16Oct00               *
     F*                 171139             Date 15Sep00               *
      * Midas DBA 3.03 -----------------------------------------------*
     F*                 143087             Date 14Aug00               *
     F*                 159194             Date 11Aug00               *
     F*                 179321             Date 26May00               *
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.01 -----------------------------------------------*
      *                 142092             Date 06Jul99               *
      *                 153383             Date 06JUL99               *
      *                 139596             Date 05JUL99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 151340             Date 22Jan99               *
      *                 151260             Date 22Jan99               *
      *                 147915             Date 20Nov98               *
      *                 146200             Date 05Oct98               *
      *                 145083             Date 15Oct98               *
      *                 141862             Date 03Sep98               *
      *                 140802             Date 17Aug98               *
      *                 140255             Date 03Aug98               *
      *                 CEU024             Date 14Jul98               *
      *                 130543             Date 13Feb98               *
      *                 123715             Date 02Oct97               *
     F*                 120880             Date 06Aug97               *
     F*                 120885             Date 06Jul97               *
     F*                 118796             Date 05Aug97               *
     F*                 118789             Date 05Aug97               *
     F*                 118131             Date 02Jun97               *
     F*                 118133             Date 02Jun97               *
     F*                 114621             Date 21Feb97               *
     F*                 099360             Date 12FEB96               *
     F*                 098166             Date 11JAN96               *
     F*                 CRT002             DATE  1DEC95               *
     F*                 S01408             DATE 14FEB96               *
     F*                 S01408             DATE 12FEB96               *
     F*                 093692             DATE 18SEP95               *
     F*                 093545             DATE  8SEP95               *
     F*                 092429             DATE 24AUG95               *
     F*                 091241             DATE 17JUL95               *
     F*                 CRT001  *CREATE    DATE 28FEB95               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD042577 - Create screen format for each option in order to  *
      *             display help text correctly.                      *
      *  218877 - Recompiled due to changes in RTCCYSC1               *
      *         - Applied for MD-28376                                *
      *  MD042745 - Travellers Cheque Number is 12 char long.         *
      *  CCG016 - Correspondence Manager for Retail Teller System.    *
      *  CAP187 - Document Linkage (Recompile)                        *
      *  253895 - Recompiled due to changes in display file RE4120DF  *
      *  249179 - Extend account code variable.  Recompile due to     *
      *           changes in /copy RTASGLC1.                          *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  BUG8514 - Issue regarding teller overrides(Recompile)        *
      *  CRT026 - Retail Teller Password Change                       *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  BUG7819 - If a retail account has insufficient funds,        *
      *            the system simply drop a Cash Withdrawal           *
      *            (non-account currency) transaction                 *
      *            Recompiled due to changes in the dspf RE4120DF     *
      *  Bug3855 - Incorrect field definitions by CRT002              *
      *  BUG2849 - CRE019 amendments for Cashier Interface (Recompile)*
      *  CRE019 - Cheque Processing and Maintenance (Recompile)       *
      *  CGL029 - Increase Account Code to 10 digits                  *
     F*  222373 - Parameter Mismatch                                  *
     F*  CRT012 - Midas/Cashier Interface - Multiple Charges         *
     F*  CRT007 - Cashier Branch Offline Checking                     *
     F*  CRT005 - Recompiled due to changes in RTTWIDC1               *
      *  198870 - Recompile due to changes in RBCXRTC1                *
      *  194978 - Error in reversing Exchange Cash transaction '0JI'  *
      *           (Cashier).                                          *
      *  CRT006 - Cashier Reserve Transactions.                       *
      *  190687 - Even after the Euro transition period, the Euro spot*
      *           rate should still be used to determine the exchange *
      *           rate between the two currencies.                    *
     F*  193529 - Array index error in RE4120                         *
     F*           /COPY RBCXRTC1 changed - recompile only             *
     F*  190137 - Addition of further warning messages.               *
     F*  152325 - Teller totals error. For FX, if sell/buy transaction*
     F*           type cash indicator is N  disallow update. Message  *
     F*           USR2319 is added . Additionally if seller ccy is not*
     F*           on currency array then add it to it.                *
     F*  184553 - Correct processing to ensure that travellers cheques*
     F*           can be sold more than one at a time.                *
     F*  171139 - Preventative fix: Removed blanking operation on     *
     F*           SCTRTY in subroutine FMTCHG, so that field TTP3 in  *
     F*           PF/TTCHGPD will not have a blank value when PMODE   *
     F*           equal to 'P'.                                       *
     F*  143087 - Allow charges in non-base ccy. Also check charge    *
     F*           less than transaction amount in all cases and add   *
     F*           half-adjust to calculation of charge percentage.    *
     F*  159194 - Changes to /COPY member RTCCYSC1 to prevent divide  *
     F*           by zero error - recompile.                          *
     F*  179321 - Addition of extra warning messages, includes        *
     F*           fix number 166475.                                  *
     F*  142092 - Cannot get full description of errors appearing on  *
     F*           teller screen in Cashier.                           *
     F*  153383 - Charges should not be subtracted from amounts as    *
     F*           results in incorrect postings - the net value should*
     F*           be used for Cashier. This also corrects problem     *
     F*           where charge was being subtracted from sell currency*
     F*           when charge currency is buy currency                *
     F*  139596 - Only check cashbox excess when PMODE = I (intractiv)*
     F*  151340 - EMU changes: Do not invert rate unnecessarily (for  *
     F*           'in' or 'out' ccys). Allow cross rate to be entered *
     F*           either way round and ensure correct way round used. *
     F*           Make 'in' to 'in' cross rate more accurate. Ensure  *
     F*           correct rate used for exchange rate check against   *
     F*           spot and do not check for 'in'/'in' or 'in'/Euro.   *
     F*           Includes /COPY RTZXRTC1.                            *
     F*           *** Should be applied with 151260 ***               *
     F*  151260 - EMU processing does not check multiply/divide ind.  *
     F*           when currency conversion involves an 'out' ccy.     *
     F*           Includes changes made to /COPY RTCOEUC1.            *
     F*           *** Should be applied with 151340 ***               *
     F*  147915 - When transaction involves in ccys and Euro, rate    *
     F*           computed should always be via Euro rates, whether or*
     F*           not the base ccy is in and whether or not CRT104 is *
     F*           switched on.                                        *
      *  146200 - Euro ccy rates become zero                          *
      *  145083 - RBA: Charge amount is deducted twice.               *
      *  141862 - Computed Amounts are incorrect in some transactions:*
      *           - Recompiled over changed /COPY RTCOEUC1.           *
      *  140802 - Recompiled due to change in /COPY RTCCYSC1          *
      *  140255 - Database error on input of transaction              *
      *           (Applied fix 105453)                                *
      *  CEU024 - EMU: RTS Enhancement                                *
     F*  130543 - Changed the array index for teller processing from  *
     F*           @I (2,0) to @J (3,0).  /COPY RBLDTLC1 and RBLDTLE1  *
     F*           were likewise amended.                              *
     F*  123715 - Do not write teller charge record if charge is zero *
     F*  120880 - Store and Forward Function.                         *
     F*  120885 - Check not only *ZEROS but also for *BLANKS as       *
     F*           Cashier R8.02B does not pad field with zeros.       *
     F*  118796 - Recompile due to change in /COPY REBCRTX1.          *
     F*  118789 - Execute SR/CHARGE only when non-zero. Include extra *
     F*           condition.                                          *
     F*  118131 - BLANK OUT ROUND CCY AND PAY/RECEIVE FLAG.           *
     F*  118133 - Change MOVE to MOVEL for WCHAMT into SCMT in SR/    *
     F*           FMTCHG.                                             *
     F*  114621 - Replace blank with 'X' to mean not to validate      *
     F*           condition.                                          *
     F*  099360 - Ccy conversion incorrect when mult/div ind. is 'D'  *
     F*           or if neither ccy is base.                          *
     F*  098166 - Correct various errors in profit centre.            *
     F*  CRT002 - Retail Branch Access.                               *
     F*  S01408 - Addition of core hook RE4120OOP1
     F*  S01408 - Addition of core hook RE4120FFP1
     F*           Addition of core hook RE4120EEP1
     F*           Addition of core hook RE4120CCP1
     F*           Addition of core hook RE4120CCP2
     F*           Addition of core hook RE4120CCP3
     F*           Addition of core hook RE4120CCP4
     F*           Addition of core hook RE4120CCP5
     F*           Addition of core hook RE4120CCP6
     F*  093692 - Foreign exchange transaction should allow the user  *
     F*           to enter the rate both ways (not relative to which- *
     F*           ever is the buy or sell CCYs).                      *
     F*  093545 - Recompile due to changes in PRTF/RE4120P1 --        *
     F*           standardize pagesize.                               *
     F*  092429 - Include RTS transaction narrative.                  *
     F*  091241 - ATM Interface.  Recompiled.                         *
     F*  CRT001 - Retail Teller System                                *
     F*                                                               *
     F*****************************************************************
      *
     FREBDCRPDIF  E           K        DISK         KINFSR *PSSR      UC
      ** Currency Details Extention No. 2
      *
     FREBDCCPDIF  E           K        DISK         KINFSR *PSSR      UC
      *
     FTTRNT   UF  E           K        DISK         KINFSR *PSSR
      ** Teller Trans. Control file
     F                                              KCOMIT
     F***TTRANPD*O   E                    DISK         KINFSR *PSSR       CRT002
     FTTRANPD O   E                    DISK         KINFSR *PSSR      UC  CRT002
      ** Teller Trans. Details file
     F                                              KCOMIT
      *
     F***TTRANPT*UF  E                    DISK         KINFSR *PSSR       CRT002
     FTTRANPT UF  E                    DISK         KINFSR *PSSR      UC  CRT002
      ** Teller Trans. Trailer file
     F                                              KCOMIT
      *
     F/COPY WNCPYSRC,RE4120F001
     FRE4120P1O   E                    PRINTER                        UC
      ** Validation Prints
      *
     F***RE4120DFCF  E                    WORKSTN      KINFSR *PSSR       CRT002
     FRE4120DFCF  E                    WORKSTN      KINFSR *PSSR      UC  CRT002
      ** Display file - Foreign Exchange transactions
      *
     FTTCHGPD O   E                    DISK         KINFSR *PSSR
      ** Teller FX Charge Details file
     F                                              KCOMIT
      *                                                                   CRT002
      /COPY ZSRSRC,RBWLOGF1                                               CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBLDTLF1                                               CRT002
     F*
     F/COPY WNCPYSRC,RE4120FFP1
     F*
      *****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   KA  - Accept transaction with override                      *
     F*   KC  - Exit Program                                          *
     F*   KE  - Refresh Screen                                        *
     F*   KL  - Previous                                              *
     F*                                                               *
     F*                                                               *
     F*   10  - Message Subfile End Indicator (SFLEND)                *
     F*   11  - Error in SBTRTY- Buy trans.type                       *
     F*                  SOTLI - Override teller-id                   *
     F*   12  - Error in SBCCY - Buy currency                         *
     F*                  SOTPC - Override teller passcode             *
     F*   13  - Error in SBAMT - Buy amount                           *
     F*   14  - Error in SEXRT - Exchange rate                        *
     F*   15  - Error in SSRTY - Sell trans.type                      *
     F*   16  - Error in SSCCY - Sell currency                        *
     F*   17  - Error in SDEPC - Department code                      *
     F*   18  - Error in SCTRTY - Charge trans. type                  *
     F*   19  - Error in SCPER - Charge percentage                    *
     F*                                                               *
     F*   20  - Terminal errors found                                 *
     F*   21  - Override prompt required                              *
     F*   22  - Transaction completed successfully once               *
     F*   23  - Condition display of warning messages                 *
     F*   24  - Condition display of transaction comp.succ            *
     F*   25  - Non-display profit centre                             *
     F*   26  - Error in profit centre                                *
     F*   27  - Error in round currency flag                          *   CRT002
     F*   28  - Error in transaction amount 1                         *   CRT002
     F*   29  - Error in pay/receive flag                             *   CRT002
     F*                                                               *
     F*   30  - Error in SCHIND - Charge buy/sell ind                 *
     F*   31  - Error in SCAMT - Charge amount                        *
     F*   32  - Charge entered as % not amount (for advice)           *
     F*   33  - Error in SSAMT - Sell amount                          *
     F*   34  - Sell amount entered                                   *
     F*   36  - Selling Travellers Cheques in Non Cash Ccy menu       *   CRT002
     F*                                                               *
     F*   40  - Error in transaction amount 2                         *   CRT002
     F*   42  - Error in round amount                                 *   CRT002
     F*   43  - Error in pay/receive amount                           *   CRT002
     F*                                                               *   CRT002
     F*   50  - Invalid input indicator                               *
     F*   51  - Error in override validation                          *
     F*   52  - Error in override details validation                  *
     F*   54  - Display override user id / password                   *                       CRT026
     F*                                                               *
     F*   69  - General error indicator                               *
     F*                                                               *
     F*   70  - General Indicator Used For CHAIN                      *
     F*                                                               *
     F* 80-89 - Standard RTS subroutines                              *
     F*                                                               *
     F* 90-99 - Standard MIDAS subroutines                            *
     F*                                                               *
     F*   LR  - Last record indicator                                 *
     F*                                                               *
     F*   U6  - System error                                          *
     F* U7-U8 - Set on if database error occurs                       *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  CALBUY - Calculate buy amount equivalent of                  *
     F*           sell amount                                         *
     F*  CHARGE - Validate Charge Details                             *
     F*  DBERR  - Database Error Handling                             *
     F*  DSPFMT - Display screen formats                              *
     F*  FIRST  - Initial Processing                                  *
     F*  FMTBUY - Format buy amount for display                       *
     F*  FMTCHG - Format charge amount for display                    *
     F*  FMTSEL - Format sell amount for display                      *
     F*  FMTSEQ - Format sell currency equivalent                     *
     F*  FORMAT - Format amounts for printing                         *
     F*  IFLDS  - Initialize screen/work fields                       *
     F*  INSRAT - Insert default exchange rate                        *
     F*  INT01  - Initialise error indicators                         *
     F*  LAST   - Final processing - terminate pgm.                   *
     F*  MAIN   - Control Process                                     *
     F*  NUMCHK - Check if amount passed is numeric                   *   CRT002
     F*  PCMTXT - Prepare comit text                                  *
     F*  RFRESH - Refresh screen                                      *
     F*  ROUND  - Round buy/sell amount to smallest                   *
     F*           denomination in currency                            *
     F*  SCRINP - Detail screen input                                 *
     F*  SETDSP - Set indicators for display                          *
     F*  SNDMSG - Send program message parameters                     *
     F*  TRCHEK - Transaction conditions check                        *
     F*  TRNOVR - Transaction override process                        *
     F*  UPDRTN - Control rtn. for updates                            *
     F*  UPTRL  - Update Control Trailer Record                       *
     F*  VALAMT - Validate amount                                     *
     F*  VALSAM - Validate sell amount                                *
     F*  VALDET - Validate Details                                    *
     F*  VALFMT - Validate input formats                              *
     F*  VALOVR - Validate override conditions                        *
     F*  VALXRT - Validate exchange rate                              *
     F*  VOVDET - Validate override details                           *
     F*  WRTLPD - Write TELIDPD Record                                *
     F*  WRCHPD - Write Teller charges detail                         *
     F*  ZA0150 - Get Midas Rundate & Setup Indicator                 *
     F*  *PSSR  - Program error                                       *
     F*                                                               *
     F*  Standard RTS Subroutines                                     *
     F*                                                               *
     F*  CMPXRT - Compute exchange rate from two amounts              *   CRT002
     F*  MOVDTL - Move details to send to outgoing dataQ              *   CRT002
     F*  RDQMS  - Receive dataqueue message                           *   CRT002
     F*  RTASGL - No associated GL code check                         *
     F*  RTCASH - Excess cash check                                   *
     F*  RTCCYS - Currency setup                                      *
     F*  RTCOEU - Currency conversion based on Euro                   *   CEU024
     F*  RTCONV - Currency conversion                                 *
     F*  RTLCNV - Local currency conversion                           *
     F*  RTTCCY - Teller currency conditions check                    *
     F*  RTTLMT - Teller limit check                                  *
     F*  RTTOTS - Teller total updates                                *
     F*  RTTWID - Teller workstation conditions check                 *
     F*  RTVMSG  - Retrieve message from Message file                 *   CRT002
     F*  RTXRAT - Validate exchange rate                              *
     F*  RTENCP - Encript passcode                                    *
     F*  SDQMS  - Send dataqueue messages                             *   CRT002
     F*  WRLOG  - Update corresponding record in log file             *   CRT002
     F*  ZABRCA - Get Teller branch name                              *
     F*                                                               *
     F*  Standard MIDAS Subroutines                                   *
     F*                                                               *
     F*  ZALIGN - Validate amount fields                              *
     F*  ZEDIT  - Insert decimal point into a numeric field           *
     F*  ZFRPED - Format and edit amount field                        *
     F*  ZTNLU1 - Access dataarea for next transaction no.            *
     F*                                                               *
     F*  External Routines                                            *
     F*                                                               *
     F*  SCC0250- Clear Message Queue                                 *
     F*  SCC0240- Send Message to program queue                       *
     F*                                                               *
     F*  DBERRCTL Program error                                       *
     F*                                                               *
     F*****************************************************************
      /EJECT
      *****************************************************************
     E*
     E/COPY WNCPYSRC,RE4120EEP1
     E*
     E                    CPY@    1   1 80
      /COPY ZSRSRC,RTXXXXE1
      ** Array for SR.RTBKDR, SR.RTBKCR, SR.RTRFDR, SR.RTRFCR, SR.RTIACT
      *
      /COPY ZSRSRC,RTCCYSE1
      ** Array for SR.RTTCCY
      *
      /COPY ZSRSRC,ZALIGNZ1
      ** Array for both SR.ZALIGN AND SR.ZEDIT
      *
      /COPY ZSRSRC,ZFRPEDZ1
      ** Array for SR.ZFRPED
      *
     E                    @CY        24  3
      ** Teller currencies array
      *
      /COPY ZSRSRC,RTENCPE1
      ** Array for SR.RTENCP
      *
     E                    @TXT    1   4 80               Text strings     CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBMODTE1                                               CRT002
      **  Array for SR.MOVDET/SR.MOVDTL                                   CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBLDTLE1                                               CRT002
      **  Array for SR.LODTLR                                             CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBCXRTE1                                               CRT002
      ** Buy/Sell Rates Arrays                                            CRT002
      *                                                                   CRT002
      *****************************************************************
      /EJECT
      *****************************************************************
      *
     ITTRNTM2F
      ** Renamed fields in PF/TTRNTM2
     I              NATN                            TTNATN
      *
     ITTRANPTF
      ** Renamed fields in PF/TTRANPT
     I              TBTN                            TRTBTN
      *
      *
      /COPY ZSRSRC,RTTOTSI1
      ** Multiple occurrence data structures for SR.RTTOTS
      *
     I            DS                              5
      ** Data structure to hold key fields of LF/TTRNT
     I                                        1   5 @TTRNT
     I                                        1   1 KTBRI
     I                                        2   4 KTBID
     I                                        5   5 KRCTP
      *
      *
      *
     I@AMTDS      DS                             16
      ** Data structure to hold amount returned by zfrped
     I                                        1  14 @SBAMT
      *
      *
     I@XRTDS      DS                             16
      ** Data structure to hold ex.rt  returned by zfrped
     I                                        1  14 @XRT
      *
      *
     I@PAMT1      DS                             19
      ** Data structure to hold Buy amount for print returned by zfrped
     I                                        1  17 OBAMT
      *
      *
     I@PAMT2      DS                             19
      ** Data structure to hold sell amt.  for print returned by zfrped
     I                                        1  17 OSAMT
      *
     I@SAR        DS                             25
      ** Data structure for validating charges fields
     I                                        1   5 SCTRTY
     I                                        6   6 SCHIND
     I                                        7  11 SCPER
     I                                       12  25 SCAMT
      *
     I@PAMT3      DS                             19
      ** Data structure to hold Charge amount for print
     I                                        1  17 OCAMT
      *
     I@CHGDS      DS                             16
      ** Data structure to hold Charge amount from zfrped
     I                                        1  14 @SCAMT
      *
     I@EXCRT      DS                             19
      ** Data structure to hold exchange rate from zfrped
     I                                        1  17 OEXRT
      *
     I@EXAMT      DS                             19
      ** Data structure to hold Exchange amount for print
     I                                        1  17 OEXAMT
      *
     I@PERDS      DS                             16
      ** Data structure to hold Charge percentage from zfrped
     I                                       10  14 @SCPER
      *
     I@SAMDS      DS                             16
      ** Data structure to hold Sell amount from zfrped
     I                                        1  14 @SSAMT
     I/COPY WNCPYSRC,RE4120I003
      *
      *
     IPSDS       SDS
      **  Program Status Data Structure
      *
     I                                        1  10 @PGM
      **  Field containing Program name
     I                                      244 253 @JOB
      **  Field containing Workstation ID
     I                                      254 263 @USER
      **  Field Containing User ID
      *
     IDATA        DS                           1024                       CRT002
      **  Data to be passed to window manager                             CRT002
      *                                                                   CRT002
     I                                        1   1 WMODE                 CRT002
     I                                        2   4 WSCCY                 CRT002
     I                                        5  18 WSAMT                 CRT002
     I                                       19  21 WTLBC                 CRT002
     I                                       22  27 WISSU                 CRT002
     I                                       28  39 WTCSN                 CRT002
     I                                       40  41 WIDTP                 CRT002
     I                                       42  61 WBYID                 CRT002
     I                                       62  81 WBYNM                 CRT002
     I                                       82 105 WTCNO                 CRT002
     I                                      106 155 WEMSG                 CRT002
      *                                                                   CRT002
     I/COPY WNCPYSRC,RE4120I002
     I            DS                                                      CRT002
      *                                                                   CRT002
      ** Traveller's Cheques Processing                                   CRT002
     I**    Narrative Line 2 positions 1 - 6 :  issuer number             CRT002
     I**                               7 - 26:  buyer's name              CRT002
     I**                              27 - 28:  buyer's ID type           CRT002
      *                                                                   CRT002
     I                                        1  35 @RANR2                CRT002
     I                                        1   6 @SCIN                 CRT002
     I                                        7  26 @SBNM                 CRT002
     I                                       27  28 @SBIT                 CRT002
      *                                                                   CRT002
     I            DS                                                      CRT002
      *                                                                   CRT002
      ** Traveller's Cheques Processing                                   CRT002
     I**    Narrative Line 3 positions 1 - 12:  serial number             CRT002
     I**                              13 - 32:  buyer's ID number         CRT002
      *                                                                   CRT002
     I                                        1  35 @RANR3                CRT002
     I                                        1  12 @SCSN                 CRT002
     I                                       13  32 @SBIN                 CRT002
      *                                                                   CRT002
     ILDA         DS                            256
      **  Local data area for data base errors.
     I                                        1   3 ERTLID
     I                                       11  20 ERTWID
     I                                       21  30 ERWSID
      *
      **  Field combining the following fields
     I                                      134 183 DBLOT
      **  Name of database file in error
     I                                      134 141 DBFILE
      **  Key value causing database error
     I                                      142 170 DBKEY
      **  Name of program causing database error
     I                                      172 180 DBPGM
      **  Number of database error
     I                                      181 1830DBASE
     I*
     IZMUSER      DS                             17
     I** Data area of menu user
     I                                        1  10 USRPRF
     I            DS                                                      CRT002
      ** Data structure to hold string constants for QCMDEXC              CRT002
      *                                                                   CRT002
     I                                        1  80 @CMD                  CRT002
     I                                       30  30 @BRI                  CRT002
     I                                       31  33 @BID                  CRT002
      *                                                                   CRT002
     I            DS                                                      CRT002
      ** Data structure to hold string constants for QCMDEXC              CRT002
      *                                                                   CRT002
     I                                        1  80 @CMDT                 CRT002
     I                                       30  30 @BRIT                 CRT002
     I                                       31  33 @BIDT                 CRT002
      *
     I/COPY WNCPYSRC,REH00348
     I/COPY ZSRSRC,RBOITMI1                                               CRT002
     I/COPY WNCPYSRC,REH00349
      *                                                                   CRT002
     I/COPY ZSRSRC,RBWLOGI1                                               CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBMODTI1                                               CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBLDTLI1                                               CRT002
      *                                                                   CRT002
     I***CMTTXT*      DS                             84                                       CRT026
     ICMTTXT      DS                            104                                           CRT026
      *
      **  COMIT TEXT
     I                                        1   50@NATN
     I                                        6   7 MDID
     I                                        8  15 PGMN
     I                                       16  18 WSIDX
     I                                       19  240MTIME
     I                                       25  34 USRIDX
     I                                       35  39 SBTRTY
     I                                       40  42 SBCCY
     I                                       43  56 SBAMT
     I                                       57  70 SEXRT
     I                                       71  75 SSTRTY
     I                                       76  78 SSCCY
     I                                       79  81 SDEPC
     I                                       82  84 SOTLI
     I                                       85  94 SOVUR                                     CRT026
     I                                       95 104 SOVPW                                     CRT026
      *                                                                   CRT002
     ITTIME       DS                             12                       CRT002
      *                                                                   CRT002
     I                                        1   2 WTHR                  CRT002
     I                                        3   4 WTMN                  CRT002
     I                                        5   6 WTSS                  CRT002
     I                                        1   60WTIME                 CRT002
      *                                                                   CRT002
     I                                        7   8 WDT1                  CRT002
     I                                        9  10 WDT2                  CRT002
     I                                       11  12 WDT3                  CRT002
     I                                        7  120WDATE                 CRT002
      *                                                                   CRT002
     I                                        1  120WTMDS                 CRT002
      *                                                                   CRT002
     I            DS                                                      CRT002
     I                                        1   7 WUMSID                CRT002
     I                                        1   7 @MSGID                CRT002
      *                                                                   CRT002
     I            DS                                                      CRT002
     I                                        1  10 WUMSGF                CRT002
     I                                        1  10 @MSGF                 CRT002
      *
     I            DS                             72
      ** Data structure to redefine currency array
     I                                        1  72 CCYR1
     I                                        1  72 @CY
      *
      *
     IRTSDTA     UDS                            256
      **  Job dataarea data structure
      *
     I                                        1   3 PTLID
     I                                        4   6 PTLBC
     I                                        7   7 PSPVI
     I                                        8  32 POVIN
     I                                    P  33  390PCHTL
     I                                    P  40  460PNCTL
     I                                       47  76 PTLNM
     I                                       77  800PTLMG
     I                                       81  840PTLSL
     I                                       85  890PTLTO
     I                                       90  92 PDEPC
     II#PARM      DS                           1024                                           CCG016
      ** Passed fields                                                                        CCG016
      **  Classification                                                                      CCG016
     I                                        1   3 I#BRCT                                    CCG016
     I                                        4   6 I#TLID                                    CCG016
     I                                        7   9 I#TBID                                    CCG016
     I                                       10  14 I#TBTN                                    CCG016
     I                                       15  17 I#FUNC                                    CCG016
     I                                       18  18 I#CLOS                                    CCG016
     I**********                             19  28 I#CHQN                           CCG016 MD042745
     I                                       19  30 I#CHQN                                  MD042745
      **  Accounts single, dr and cr                                                          CCG016
     I                                       41  46 I#CNUM                                    CCG016
     I                                       47  49 I#CCY                                     CCG016
     I                                       50  59 I#ACOD                                    CCG016
     I                                       60  61 I#ACSQ                                    CCG016
     I                                       62  64 I#BRCA                                    CCG016
     I                                       41  64 I#GLAR                                    CCG016
     I                                       65  74 I#ACNO                                    CCG016
     I                                       77  82 I#CNU1                                    CCG016
     I                                       83  85 I#CCY1                                    CCG016
     I                                       86  89 I#ACO1                                    CCG016
     I                                       90  91 I#ACS1                                    CCG016
     I                                       92  94 I#BRC1                                    CCG016
     I                                       77  94 I#GLA1                                    CCG016
     I                                       95 104 I#ACN1                                    CCG016
     I                                      107 112 I#CNU2                                    CCG016
     I                                      113 115 I#CCY2                                    CCG016
     I                                      116 119 I#ACO2                                    CCG016
     I                                      120 121 I#ACS2                                    CCG016
     I                                      122 124 I#BRC2                                    CCG016
     I                                      107 124 I#GLA2                                    CCG016
     I                                      125 134 I#ACN2                                    CCG016
      **  Transaction dets                                                                    CCG016
     I                                    P 137 1440I#AMNT                                    CCG016
     I                                      145 147 I#CCYT                                    CCG016
     I                                      148 198 I#NARR                                    CCG016
     I                                    P 199 2060I#CHQA                                    CCG016
     I                                    P 207 2138I#EXRT                                    CCG016
     I                                    P 217 2240I#BUYA                                    CCG016
     I                                      225 227 I#BUYC                                    CCG016
     I                                    P 228 2350I#SELA                                    CCG016
     I                                      236 238 I#SELC                                    CCG016
     I                                      239 288 I#NAR1                                    CCG016
     I                                      289 338 I#NAR2                                    CCG016
     I                                    P 347 3540I#INTA                                    CCG016
     I                                      355 357 I#INTC                                    CCG016
     I                                      358 407 I#INTN                                    CCG016
     I                                    P 417 4240I#TAXA                                    CCG016
     I                                      425 427 I#TAXC                                    CCG016
     I                                      428 477 I#TAXN                                    CCG016
     I                                    P 487 4940I#CHGA                                    CCG016
     I                                      495 497 I#CHGC                                    CCG016
     I                                      498 557 I#CHGN                                    CCG016
     I                                    P 567 5740I#TOTA                                    CCG016
     I                                      575 577 I#TOTC                                    CCG016
     I                                      578 627 I#TOTN                                    CCG016
     IO#PARM      DS                            256                                           CCG016
     I                                        1  10 O#ITEM                                    CCG016
     I                                       11  20 O#CUST                                    CCG016
     I                                       21  25 O#RSEQ                                    CCG016
     I                                       26  26 O#RLVL                                    CCG016
     I                                       27  29 O#RBCH                                    CCG016
     I                                       30  30 O#RARC                                    CCG016
      *                                                                                       CCG016
     ISDBANK    E DSSDBANKPD
     I** Bank Details
      *
     ISDCURR    E DSSDCURRPD
     I** Customer Details
      *
     ISDBRCH    E DSSDBRCHPD
     I** Branch Details
      *
     ISDDEPT    E DSSDDEPTPD
     I** Department Codes Details
      *
     ISDRETR    E DSSDRETRPD
     I** Retail Transaction Types Details
     I*
     ISDGELR    E DSSDGELRPD
     I** General Ledger Details
     I              BKPRCU                          PFCU
     I              BKPCDU                          PFCD
     I*
     ISDPRFM    E DSSDPRFMPD
     I** Profit Centre Default Matrix Retrieval Index
     I*
     ISDPRFC    E DSSDPRFCPD
     I** Profit Centre Details
     I*
     ISDTELD    E DSSDTELDPD
     I** Teller ID Details
     I*
     ISDFNCD    E DSSDFNCDPD
     I** Function Code  Details
     I*
     ISDTCHG    E DSSDTCHGPD
     I** Default Charges Transaction Type Details
     I*
     IDSFDY     E DSDSFDY
      *First DS for Access Programs, short data structure
      *
     IDSSDY     E DSDSSDY
      *Second DS for Access Programs, long data structure
      *
     ISCSARD    E DSSCSARDPD
     I** EXTERNAL DS FOR SAR DETAILS
     I/COPY WNCPYSRC,RE4120I001
      *                                                                                       CRT026
     IMUSER     E DSMUSERDD                                                                   CRT026
     I** External data structure for User Details                                             CRT026
     I** Renamed fields in PF/MUSERDD                                                         CRT026
     I              LCD                             LCDU                                      CRT026
      *
      /COPY ZSRSRC,RTXXXXI1
      ** Data structure to positions of validation indicators
      *
      * Data structure for AOSVALR0 string                                CRT012
     I            DS                                                      CRT012
     I                                        1 200 SVAL1                 CRT012
     I                                        1   1 SVAL11                CRT012
      *                                                                   CRT012
      * System Value                                                      CRT012
     I            DS                                                      CRT012
     I I            'CashierMultCharge'       1  20 SVALK1                CRT012
      *                                                                   CRT012
     I/COPY WNCPYSRC,REH00191
      /COPY ZSRSRC,ZTNLU1Z1
      **  Data structure to update last transaction number
      *
      /COPY ZSRSRC,ZFRPEDZ2
      ** Data structure for SR.ZFRPED
     I/COPY WNCPYSRC,RE4120I004
      *
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            MAIN   - Control Process                           *
      *                                                               *
      * CALLS      FIRST  - Initial Processing                        *
      *            LAST   - Final Processing                          *
      *            SCRINP - Detail screen input                       *
      *                                                               *
      * CALLED BY         -                                           *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
      *
     C                     MOVEACPY@      BIS@   80
      ** Initial processing
     C                     EXSR FIRST
      *
      ** Do while cmd/3 is not pressed
     C           *INKC     DOWEQ'0'
      *
      ** Perform detail screen input
     C                     EXSR SCRINP
      *
     C                     END
      *
      **  Final Processing
     C                     EXSR LAST
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            SCRINP - Detail screen input                       *
      *                                                               *
      * CALLS      DSPFMT - Display screen formats                    *
      *            RFRESH - Refresh screen                            *
      *            VALFMT - Validate input formats                    *
      *            LAST   - Final processing - terminate pgm.         *
      *            UPDRTN - Update control routine                    *
      *                                                               *
      * CALLED BY  MAIN   - Control Process                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           SCRINP    BEGSR                           ** SCRINP **
      *
      ** Do while input not valid
     C           *IN50     DOWEQ'1'
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVE '0'       *IN69                           CRT002
     C                     END                                            CRT002
      *
      ** Display appropriate screen format
     C                     EXSR DSPFMT
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN69     ANDEQ'1'                                       CRT002
     C                     MOVE '1'       *IN20                           CRT002
     C                     LEAVE                                          CRT002
     C                     ENDIF                                          CRT002
      *
      ** Process the input depending on the key pressed
      *
      ** If Help key is pressed, perform help processing
      *
      ** If cmd/3 is pressed - terminate the program
     C           *INKC     CASEQ'1'       LAST
      *
      ** If cmd/5 is pressed - refresh the screen & redisplay appr.scrn
     C           *INKE     CASEQ'1'       RFRESH
      *
      ** If enter key is pressed - validate the screen input
     C                     CAS            VALFMT
      *
     C                     END
      *                                                                   CRT002
      **  Display and validate window details                             CRT002
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JX'                                     CRT002
     C           *IN51     ANDEQ'0'                                       CRT002
     C           *IN50     ANDEQ'0'                                       CRT002
     C                     EXSR DSPWND                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN69     ANDEQ'1'                                       CRT002
     C                     MOVE '1'       *IN20                           CRT002
     C                     LEAVE                                          CRT002
     C                     ENDIF                                          CRT002
      *
     C                     END
      *
      ** If no terminal errors
      ** Perform transaction update
     C           *IN20     IFEQ '0'
     C                     EXSR UPDRTN
      *
      ** Seton indicator for transaction completed screen
     C                     SETON                     2224
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     EXSR MOVDTL                                    CRT002
      *                                                                   CRT002
     C/COPY WNCPYSRC,REH00280
     C                     MOVELREPOIO    P@QDS                           CRT002
     C                     EXSR SDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVELREPOIO    WCMSG                           CRT002
     C                     EXSR WRLOG                                     CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
     C                     MOVEL*BLANKS   REPOIO                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
      ** Perform initialisation
     C                     EXSR RFRESH
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPFMT - Display screen formats                    *
      *                                                               *
      * CALLS      SCC0250- Clear Message Queue                       *
      *                                                               *
      * CALLED BY  SCRINP - Detail screen input                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPFMT    BEGSR                           ** DSPFMT **
      *                                                                   CRT002
     C                     MOVEL*BLANKS   WRDAM  15                       CRT002
     C                     MOVEL*BLANKS   WRDCY   1                       CRT002
     C                     MOVEL*BLANKS   WPRAM  15                       CRT002
     C                     MOVEL*BLANKS   WPYRC   1                       CRT002
     C                     MOVEL*BLANKS   WTRA1  15                       CRT002
     C                     MOVEL*BLANKS   WTRA2  15                       CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
      *
      ** Display message subfile control record
     C                     WRITERE4120C0
      *
      ** Display appropriate screen format
      *
      ** If any terminal errors - display tran.terminated screen
     C           *IN20     IFEQ '1'
     C/COPY WNCPYSRC,RE4120C003
     C                     SELEC                                                            MD042577
     C           PFNCD     WHEQ '0JS'                                                       MD042577
     C                     EXFMTF20JS                                                       MD042577
     C           PFNCD     WHEQ '0JX'                                                       MD042577
     C                     EXFMTF20JX                                                       MD042577
     C                     OTHER                                                            MD042577
     C                     EXFMTRE4120F2
     C                     ENDSL                                                            MD042577
      *
     C                     ELSE
      *
      ** If tran completed successfully - disp.tran.completed scrn.
     C           *IN22     IFEQ '1'
     C/COPY WNCPYSRC,RE4120C009
     C                     SELEC                                                            MD042577
     C           PFNCD     WHEQ '0JS'                                                       MD042577
     C                     EXFMTF30JS                                                       MD042577
     C           PFNCD     WHEQ '0JX'                                                       MD042577
     C                     EXFMTF30JX                                                       MD042577
     C                     OTHER                                                            MD042577
     C                     EXFMTRE4120F3
     C                     ENDSL                                                            MD042577
      *
     C                     ELSE
      *
      ** Otherwise display initial input screen
     C                     SELEC                                                            MD042577
     C           PFNCD     WHEQ '0JS'                                                       MD042577
     C                     EXFMTF10JS                                                       MD042577
     C           PFNCD     WHEQ '0JX'                                                       MD042577
     C                     EXFMTF10JX                                                       MD042577
     C                     OTHER                                                            MD042577
     C                     EXFMTRE4120F1
     C                     ENDSL                                                            MD042577
      *
     C                     END
      *
     C/COPY WNCPYSRC,RE4120C004
     C                     END
      *                                                                   CRT002
     C           PMODE     WHEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   REPOII                          CRT002
     C                     EXSR RDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
      *                                                                   CRT002
     C                     MOVE P@QDR     REPOII                          CRT002
     C/COPY WNCPYSRC,REH00281
      *                                                                   CRT002
     C           RAMSTY    IFNE '*END'                                    CRT002
      *                                                                   CRT002
     C                     MOVELRAFWST    WFWST   1                       120880
     C                     MOVELRAMRDA    WRDAM                           CRT002
     C                     MOVELRAMTCY    WRDCY                           CRT002
     C                     MOVELRAMLCA    WPRAM                           CRT002
     C                     MOVELRAPYRC    WPYRC                           CRT002
     C                     MOVELRANRL1    SNARR                           CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
     C           PFNCD     WHEQ '0JI'                                     CRT002
     C                     MOVELRACCY1    SBCCY                           CRT002
     C                     MOVELRACCY2    SSCCY                           CRT002
     C                     MOVE RAMNA1    SBAMT                           CRT002
     C                     MOVE RAMNA2    SSAMT                           CRT002
     C                     MOVE RATRA1    WTRA1                           CRT002
     C                     MOVE RATRA2    WTRA2                           CRT002
     C           PFNCD     WHEQ '0JS'                                     CRT002
     C                     MOVELRACCY1    SBCCY                           CRT002
     C                     MOVE RATRA1    SBAMT                           CRT002
     C                     MOVELRACCY2    SSCCY                           CRT002
     C                     MOVE RAMNA2    SSAMT                           CRT002
     C                     MOVE RAMNA2    WTRA2                           CRT002
     C           PFNCD     WHEQ '0JX'                                     CRT002
     C                     MOVELRACCY1    SSCCY                           CRT002
     C                     MOVE RATRA1    SSAMT                           CRT002
     C                     MOVELRACCY2    SBCCY                           CRT002
     C                     MOVE RAMNA2    SBAMT                           CRT002
     C                     MOVE RAMNA2    WTRA2                           CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
     C                     CLEARWCMSG                                     CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVE 'N'       WSUCM                           CRT002
     C                     MOVE 'DR'      WSTAT                           CRT002
     C                     TIME           WTMDS  120                      CRT002
     C           WTHR      CAT  ':'       WA      3                       CRT002
     C           WTMN      CAT  ':'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WTSS      WSTTM                           CRT002
     C                     MOVE WSTTM     WRCTM   8                       CRT002
     C           WDT1      CAT  '/'       WA      3                       CRT002
     C           WDT2      CAT  '/'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WDT3      WRCDT   8                       CRT002
     C                     MOVELP@QDR     WCMSG                           CRT002
     C                     EXSR WRLOG                                     CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
      *                                                                   CRT002
     C                     MOVE '0'       *INKA                           CRT002
     C                     MOVE '0'       *INKB                           CRT002
     C                     MOVE '0'       *INKC                           CRT002
     C                     MOVE '0'       *INKE                           CRT002
     C                     MOVE '0'       *INKJ                           CRT002
     C                     MOVE '0'       *INKL                           CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
     C                     MOVE '1'       *INKC                           CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *
      ** Clear program message queue and terminal & warning msg. lines
     C                     CALL 'SCC0250'
     C                     MOVEL*BLANKS   SMSG1
     C                     MOVEL*BLANKS   SMSG2
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRESH - Refresh screen                            *
      *                                                               *
      * CALLS      IFLDS  - Initialize screen/work fields             *
      *            INT01  - Initialise error indicators               *
      *                                                               *
      * CALLED BY  SCRINP - Detail screen input                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRESH    BEGSR                           ** RFRESH **
      *
      ** Initialize all indicators
     C                     EXSR INT01
      *
      ** Initialize screen/work fields
     C                     EXSR IFLDS
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALFMT - Validate screen input                     *
      *                                                               *
      * CALLS      VALDET - Validate details                          *
      *            RTTWID - Teller workstation conditions check       *
      *            INT01  - Initialise error indicators               *
      *                                                               *
      * CALLED BY  SCRINP - Detail screen input                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALFMT    BEGSR                           ** VALFMT **
      *
      ** Intialise error indicators
     C                     EXSR INT01
      *
      ** Setof indicator for invalid input
     C                     SETOF                     50
      *
     C                     Z-ADD0         @TI     20
     C                     Z-ADD0         @WI     20
     C                     MOVE *BLANKS   @W
     C                     MOVE *BLANKS   @T
      *
      ** perform check for multiple sign on
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C***********          Z-ADD1         @I                       CRT002 130543
     C                     Z-ADD1         @J                              130543
     C                     MOVEL@TLID     @@PTL                           CRT002
     C                     MOVELRAUSID    @TLID                           CRT002
      *                                                                   CRT002
     C           @TLID     IFNE @@PTL                                     CRT002
     C***********@TLID     LOKUPWTL,@I                   60        CRT002 130543
     C           @TLID     LOKUPWTL,@J                   60               130543
     C           *IN60     IFEQ '1'                                       CRT002
     C***********@I        OCUR TELDS                  60          CRT002 130543
     C           @J        OCUR TELDS                  60                 130543
     C           *IN60     IFEQ '0'                                       CRT002
     C                     MOVELD@TLID    PTLID                           CRT002
     C                     MOVELD@TLBC    PTLBC                           CRT002
     C                     MOVELD@SPVI    PSPVI                           CRT002
     C                     MOVELD@OVRI    POVIN                           CRT002
     C**********           MOVELD@CHTL    PCHTL                                       CRT002 Bug3855
     C**********           MOVELD@NCTL    PNCTL                                       CRT002 Bug3855
     C                     Z-ADDD@CHTL    PCHTL                                              Bug3855
     C                     Z-ADDD@NCTL    PNCTL                                              Bug3855
     C                     MOVELD@DEPC    PDEPC                           CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
     C                     MOVE PDEPC     SDEPC                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     MOVELPTLID     @TLID                           CRT002
      *                                                                   CRT002
     C                     EXSR RTTWID
      *
      ** Validate details
     C                     EXSR VALDET
     C/COPY WNCPYSRC,RE4120C010
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            INT01  - Initialise error indicators               *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  FIRST  - Initial Processing                        *
      *            VALFMT - Validate screen input                     *
      *            RFRESH - Refresh screen                            *
      *                                                               *
      *****************************************************************
     C           INT01     BEGSR                           ** INT01  **
      *
      ** Setof screen conditioning & error indicators
     C                     SETOF                     111213
     C                     SETOF                     161415
     C                     SETOF                     1726
     C                     SETOF                     181930
     C                     SETOF                     313334
      *
     C*
     C/COPY WNCPYSRC,RE4120CCP1
     C*
      ** Setof indicator for override required
     C                     SETOF                     51
      *
      ** Seton indicator for invalid input
     C                     SETON                     50
      *
      ** If screen is to be refreshed - then setof 24 (tran.completed)
      ** 21 (Warning errors), 20 (terminal errors)
     C           *INKE     IFEQ '1'
     C                     SETOF                     202124
     C                     MOVE *OFF      *IN54                                               CRT026
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALDET - Validate Details                          *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            VALAMT - Validate amount                           *
      *            VALSAM - Validate sell amount                      *
      *            VALOVR - Validate override conditions              *
      *            VALXRT - Validate exchange rate                    *
      *            TRCHEK - Transaction conditions check              *
      *            TRNOVR - Transaction override process              *
      *            RTCASH - Excess cash check                         *
      *            RTCONV - Currency conversion                       *
      *            RTTCCY - Teller currency conditions check          *
      *                                                               *
      * CALLED BY  VALFMT - Validate screen input                     *
      *                                                               *
      *****************************************************************
     C           VALDET    BEGSR                           ** VALDET **
      *
      ** Setof indicators conditioning warn. & term. errors & succ.comp
     C                     SETOF                     202124
     C                     MOVE *OFF      *IN54                                               CRT026
     C                     SETOF                     272829               CRT002
     C                     SETOF                     40                   CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   WAMT   15                       CRT002
     C                     Z-ADD0         @DEC    10                      CRT002
     C                     Z-ADD0         @TRA1  150                      CRT002
     C                     Z-ADD0         @TRA2  150                      CRT002
     C                     Z-ADD0         @RDAM  150                      CRT002
     C                     Z-ADD0         @PYAM  150                      CRT002
     C                     Z-ADD0         W@TAMT 150                      CRT002
     C                     Z-ADD0         W@SCEQ 150                      CRT002
     C                     Z-ADD0         @DIFR  150                      CRT002
      *
      ** If Buy transaction type is blanks
      ** message -
     C           SBTRTY    IFEQ *BLANKS
     C                     SETON                     1150
     C                     MOVEL'USR0085' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
     C/COPY WNCPYSRC,RE4120C011
      *
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C           SBTRTY    PARM SBTRTY    @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record does not exist or is deleted -
     C           @RTCD     IFNE *BLANKS
     C                     SETON                     1150
     C                     MOVEL'USR0086' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
     C/COPY WNCPYSRC,RE4120C012
      *
      ** Transaction type must not be debit only
     C           A1DCIN    IFEQ 'D'
     C                     SETON                     1150
     C                     MOVEL'USR0087' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** Store dr/cr,cash,clearing & reversal indicators for later use
     C                     MOVEL' '       @BRVIN  1
     C                     MOVELA1DCIN    @BDCIN  1
     C                     MOVELA1CIND    @BCSIN  1
     C                     MOVELA1CLIN    @BCLIN  1
     C**********           MOVE A1ASGL    @BASGL  4                                           CGL029
     C                     MOVE A1ASGL    @BASGL 10                                           CGL029
      *                                                                   152325
      **  When function code = 0JI (FX transaction), cash indicator       152325
      **  should always be 'Y'.                                           152325
      *                                                                   152325
     C           PFNCD     IFEQ '0JI'                                     152325
     C           A1CIND    ANDEQ'N'                                       152325
     C                     SETON                     1150                 152325
     C                     MOVEL'USR2319' @MSGID                          152325
     C                     EXSR SNDMSG                                    152325
     C                     END                                            152325
      *
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO ERROR2                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** If Buy currency is blanks
      ** message -
     C           SBCCY     IFEQ *BLANKS
     C                     SETON                     1250
     C                     MOVEL'USR0076' @MSGID
     C                     EXSR SNDMSG
      *
      ** otherwise Check if it refers to live record in Lf/sdcurrl0
     C                     ELSE
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           SBCCY
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** If record not found or is not a live record
      ** Message - currency code not found
     C           @RTCD     IFNE *BLANK
     C                     SETON                     1250
     C                     MOVEL'USR0049' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Store the no.of dec.places & mult/div indicator
     C                     Z-ADDA6NBDP    @TDEC   10
     C                     MOVE A6MDIN    @TMD    1
     C                     Z-ADDA6SPRT    @BXRT  138                      093692
      *
     C           CEU024    IFEQ 'Y'                                       CEU024
     C                     Z-ADDA6EUER    WBRAT  138                      CEU024
     C                     MOVELA6EUMD    WBIND   1                       CEU024
     C           SBCCY     IFEQ BKEURO                                    CEU024
     C                     MOVEL'E'       WBCCY   1                       CEU024
     C                     Z-ADD1         WBRAT                           147915
     C                     ELSE                                           CEU024
     C           A6INCY    IFEQ 'Y'                                       CEU024
     C           BJRDNB    ANDGEA6TPSD                                    CEU024
     C********** BJRDNB    ANDLEA6TPED                             CEU024 190687
     C                     MOVELA6INCY    WBCCY                           CEU024
     C                     ELSE                                           CEU024
     C                     MOVEL*BLANKS   WBCCY                           CEU024
     C                     ENDIF                                          CEU024
     C                     ENDIF                                          CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO ERROR2                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** Access lf/sgcurrpd for smallest denomination
     C           *IN12     IFEQ '0'
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM SBCCY     SCCY    3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** If record not found or is not a live record - db error
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCURRPD'DBFILE           **************
     C                     Z-ADD23        DBASE            ** DB ERR 23 **
     C                     MOVELSBCCY     DBKEY            ***************
     C                     EXSR DBERR
     C                     ELSE
     C                     Z-ADDA6SMLD    @TSML   50
     C           @TSML     IFEQ *ZERO
     C                     Z-ADD1         @TSML
     C                     END
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
      *
      ** Buy and sell amounts can not both be entered
     C           SBAMT     IFNE *BLANKS
     C           SSAMT     ANDNE*BLANKS
     C                     SETON                     133350
     C                     MOVEL'USR0216' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
      ** Either buy or sell amount must be entered
     C           SBAMT     IFEQ *BLANKS
     C           SSAMT     ANDEQ*BLANKS
     C                     SETON                     133350
     C                     MOVEL'USR0217' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO ERROR2                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** Validate buyer amount - only if byr.curr code is valid
      ** and sell amount has not been entered
     C           *IN12     IFEQ '0'
     C           *IN13     ANDEQ'0'
     C           SSAMT     ANDEQ*BLANKS
     C           PMODE     ANDEQ'I'                                       CRT002
     C                     EXSR VALAMT
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN12     ANDEQ'0'                                       CRT002
     C           *IN13     ANDEQ'0'                                       CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C                     MOVE SBAMT     ZFIELD                          CRT002
     C                     Z-ADD@TDEC     ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    SBAMT                           CRT002
     C                     EXSR VALAMT                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO ERROR2                                    CRT002
     C                     ENDIF                                          CRT002
      ***********                                                         092429
      ***Validate*exchange*rate**                                         092429
     C***********          EXSR VALXRT                                    092429
      *
      ** If sell transaction type is blanks
      ** message -
     C           SSTRTY    IFEQ *BLANKS
     C                     SETON                     1550
     C                     MOVEL'USR0085' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
     C/COPY WNCPYSRC,RE4120C013
      *
      ** otherwise Check if it refers to live record in jf/sgretrj1
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C           SSTRTY    PARM SSTRTY    @RETR
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record does not exist or is deleted -
     C           @RTCD     IFNE *BLANKS
     C                     SETON                     1550
     C                     MOVEL'USR0086' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
     C/COPY WNCPYSRC,RE4120C014
      *
      ** Transaction type must not be credit only
     C           A1DCIN    IFEQ 'C'
     C                     SETON                     1550
     C                     MOVEL'USR0087' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** Store dr/cr,cash,clearing & reversal indicators for later use
     C                     MOVEL' '       @SRVIN  1
     C                     MOVELA1DCIN    @SDCIN  1
     C                     MOVELA1CIND    @SCSIN  1
     C                     MOVELA1CLIN    @SCLIN  1
     C**********           MOVE A1ASGL    @SASGL  4                                           CGL029
     C                     MOVE A1ASGL    @SASGL 10                                           CGL029
      *                                                                   152325
      **  When function code = 0JI (FX transaction), cash indicator       152325
      **  should always be 'Y'.                                           152325
      *                                                                   152325
     C           PFNCD     IFEQ '0JI'                                     152325
     C           A1CIND    ANDEQ'N'                                       152325
     C                     SETON                     1550                 152325
     C                     MOVEL'USR2319' @MSGID                          152325
     C                     EXSR SNDMSG                                    152325
     C                     END                                            152325
      *
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO ERROR2                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** If sell currency is blanks
      ** message -
     C           SSCCY     IFEQ *BLANKS
     C                     SETON                     1650
     C                     MOVEL'USR0076' @MSGID
     C                     EXSR SNDMSG
      *
      ** otherwise Check if sell ccy is same as buy ccy
     C                     ELSE
      *
      ** If sell currency is same as buy currency
      ** message - Buy and sell currencies should not be the same
     C           SSCCY     IFEQ SBCCY
     C                     SETON                     1650
     C                     MOVEL'USR0108' @MSGID
     C                     EXSR SNDMSG
      *
      ** otherwise Check if it refers to live record in lf/sdcurrl0
     C                     ELSE
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           SSCCY
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** If record not found or is not a live record
      ** Message - currency code not found
     C           @RTCD     IFNE *BLANK
     C                     SETON                     1650
     C                     MOVEL'USR0049' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Store no.of decimal places and mult./div ind.for sell currency
     C                     Z-ADDA6NBDP    @SDEC   10
     C                     MOVE A6MDIN    @SMD    1
     C                     Z-ADDA6SPRT    @SXRT  138                      093692
      *
     C           CEU024    IFEQ 'Y'                                       CEU024
     C                     Z-ADDA6EUER    WSRAT  138                      CEU024
     C                     MOVELA6EUMD    WSIND   1                       CEU024
     C           SSCCY     IFEQ BKEURO                                    CEU024
     C                     MOVEL'E'       WSLCY   1                       CEU024
     C                     Z-ADD1         WSRAT                           147915
     C                     ELSE                                           CEU024
     C           A6INCY    IFEQ 'Y'                                       CEU024
     C           BJRDNB    ANDGEA6TPSD                                    CEU024
     C********** BJRDNB    ANDLEA6TPED                             CEU024 190687
     C                     MOVELA6INCY    WSLCY                           CEU024
     C                     ELSE                                           CEU024
     C                     MOVEL*BLANKS   WSLCY                           CEU024
     C                     ENDIF                                          CEU024
     C                     ENDIF                                          CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     END
      *
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO ERROR2                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** Access lf/sgcurrpd for smallest denomination
     C           *IN16     IFEQ '0'
     C*
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM SSCCY     SCCY
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** If record not found or is not a live record - db error
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCURRPD'DBFILE           ***************
     C                     Z-ADD24        DBASE            ** DB ERR 24 **
     C                     MOVELSSCCY     DBKEY            ***************
     C                     EXSR DBERR
     C                     ELSE
     C                     Z-ADDA6SMLD    @SSML   50
      *                                                                                       CRT026
      ** To avoid error in validation of amount against smallest                              CRT026
      ** denomination                                                                         CRT026
      *                                                                                       CRT026
     C           @SSML     IFEQ *ZERO                                                         CRT026
     C                     Z-ADD1         @SSML                                               CRT026
     C                     ENDIF                                                              CRT026
     C*
     C/COPY WNCPYSRC,RE4120CCP6
     C*
     C                     END
      *
     C                     END
      *
      ** Validate sell amount - only if sell curr code is valid
      ** and buy amount has not been entered
     C           *IN16     IFEQ '0'
     C           *IN33     ANDEQ'0'
     C           SBAMT     ANDEQ*BLANKS
     C           PMODE     ANDEQ'I'                                       CRT002
     C                     EXSR VALSAM
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN16     ANDEQ'0'                                       CRT002
     C           *IN33     ANDEQ'0'                                       CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C                     MOVE SSAMT     ZFIELD                          CRT002
     C                     Z-ADD@SDEC     ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    SSAMT                           CRT002
     C                     EXSR VALSAM                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO ERROR2                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
      *                                                                   092429
      ** Validate exchange rate                                           092429
     C                     EXSR VALXRT                                    092429
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
      ** If department code is blanks
      ** message - department code is required
     C           SDEPC     IFEQ *BLANK
     C                     SETON                     1750
     C                     MOVEL'USR0055' @MSGID
     C                     EXSR SNDMSG
      *
      ** Get department code details
     C                     ELSE
      *
     C                     CALL 'AODEPTR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           SDEPC
     C           SDDEPT    PARM SDDEPT    DSFDY
      *
      ** If record not found
      ** message - department code not found
     C           @RTCD     IFNE *BLANKS
     C                     SETON                     1750
     C                     MOVE 'USR0054' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO ERROR2                                    CRT002
     C                     ENDIF                                          CRT002
     C*
     C*  Validate the input Profit Centre if entered
     C*
     C           PFCU      IFEQ 'Y'
     C*
     C           SPRFC     IFNE *BLANK
     C                     MOVE *BLANKS   @KEY4
     C                     CALL 'AOPRFCR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY    '@OPTN   7
     C                     PARM SPRFC     @KEY4   4
     C           SDPRFC    PARM SDPRFC    DSFDY
     C*
     C           @RTCD     IFNE *BLANK
     C                     MOVE 'USR1199' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     2650
     C                     ELSE
     C                     MOVE DSPCCD    SPRFC
     C                     MOVE SPRFC     PRFC
     C                     END
     C*
     C                     ELSE
     C*
     C                     MOVELPTLBC     @BRAN                           CRT002
     C           PFCD      IFEQ 'Y'
     C                     CALL 'AOPRFMR0'
     C                     PARM *BLANKS   @RTC1   1
     C                     PARM *BLANKS   @BOOK   2
     C                     PARM A1RTTY    @TRPT   5
     C                     PARM *BLANKS   @SUTP   2
     C***********          PARM PTLBC     @BRAN   3                       CRT002
     C                     PARM           @BRAN   3                       CRT002
     C                     PARM SDEPC     @DEPT   3
     C                     PARM USRPRF    @USER
     C                     PARM *BLANKS   @ACOF   2
     C                     PARM *BLANKS   @CNUM6  6
     C                     PARM *BLANKS   @PRFC   4
     C*
     C                     SELEC
     C           @RTC1     WHEQ '0'
     C                     MOVE @PRFC     SPRFC
     C                     MOVE SPRFC     PRFC
     C                     MOVE '0'       *IN26                           098166
     C           @RTC1     WHEQ '2'
     C           @RTC1     OREQ '1'                                       098166
     C                     MOVE @PRFC     SPRFC
     C                     MOVE 'USR1199' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     2650
     C                     ENDSL
     C*                                                                   098166
     C** Else, if default profit centre usage is off and profit centre    098166
     C** is blank, then error.                                            098166
     C*                                                                   098166
     C                     ELSE                                           098166
     C                     MOVE 'USR1199' @MSGID                          098166
     C                     EXSR SNDMSG                                    098166
     C                     MOVE '1'       *IN26                           098166
     C                     MOVE '1'       *IN50                           098166
     C*
     C                     END
     C*
     C                     END
     C*
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO ERROR2                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
      **  Validate Round Currency Flag.                                   CRT002
      *                                                                   CRT002
     C           WRDCY     IFNE *BLANK                                    CRT002
     C           WRDCY     ANDNE'1'                                       CRT002
     C           WRDCY     ANDNE'2'                                       CRT002
     C                     SETON                     2750                 CRT002
     C                     MOVEL'USR0152' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           WRDAM     IFNE *ZEROS                                    CRT002
     C           WRDAM     ANDNE*BLANKS                                   120885
     C           WRDCY     ANDNE'1'                                       CRT002
     C           WRDCY     ANDNE'2'                                       CRT002
     C                     SETON                     2750                 CRT002
     C                     MOVEL'USR0153' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   118131
     C           WRDAM     IFEQ *ZEROS                                    118131
     C           WRDAM     OREQ *BLANKS                                   118131
     C                     MOVEL*BLANK    WRDCY                           118131
     C                     ENDIF                                          118131
      *                                                                   CRT002
      **  Validate Transaction Amount 1.                                  CRT002
      *                                                                   CRT002
     C                     MOVE WTRA1     WAMT                            CRT002
     C                     Z-ADD@TDEC     @DEC                            CRT002
     C                     EXSR NUMCHK                                    CRT002
     C           *IN50     IFEQ '1'                                       CRT002
     C                     MOVEL'1'       *IN28                           CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD@AMT      @TRA1                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Validate Pay/Receive Flag.                                      CRT002
      *                                                                   CRT002
     C           WPYRC     IFNE *BLANK                                    CRT002
     C           WPYRC     ANDNE'P'                                       CRT002
     C           WPYRC     ANDNE'R'                                       CRT002
     C                     SETON                     2950                 CRT002
     C                     MOVEL'USR0154' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           WPRAM     IFNE *ZEROS                                    CRT002
     C           WPRAM     ANDNE*BLANKS                                   120885
     C           WPYRC     ANDNE'P'                                       CRT002
     C           WPYRC     ANDNE'R'                                       CRT002
     C                     SETON                     2950                 CRT002
     C                     MOVEL'USR0155' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   118131
     C           WPRAM     IFEQ *ZEROS                                    118131
     C           WPRAM     OREQ *BLANKS                                   118131
     C                     MOVEL*BLANK    WPYRC                           118131
     C                     ENDIF                                          118131
      *                                                                   CRT002
      **  Validate Transaction Amount 2.                                  CRT002
      *                                                                   CRT002
     C                     MOVE WTRA2     WAMT                            CRT002
     C                     Z-ADD@SDEC     @DEC                            CRT002
     C                     EXSR NUMCHK                                    CRT002
     C           *IN50     IFEQ '1'                                       CRT002
     C                     MOVEL'1'       *IN40                           CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD@AMT      @TRA2                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Validate Round Amount.                                          CRT002
      *                                                                   CRT002
     C                     MOVE WRDAM     WAMT                            CRT002
     C           WRDCY     IFEQ '1'                                       CRT002
     C                     Z-ADD@TDEC     @DEC                            CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD@SDEC     @DEC                            CRT002
     C                     ENDIF                                          CRT002
     C                     EXSR NUMCHK                                    CRT002
     C           *IN50     IFEQ '1'                                       CRT002
     C                     MOVEL'1'       *IN42                           CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD@AMT      @RDAM                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Validate Pay/Receive Amount.                                    CRT002
      *                                                                   CRT002
     C                     MOVE WPRAM     WAMT                            CRT002
     C                     Z-ADD@BDEC     @DEC                            CRT002
     C                     EXSR NUMCHK                                    CRT002
     C           *IN50     IFEQ '1'                                       CRT002
     C                     MOVEL'1'       *IN43                           CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD@AMT      @PYAM                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     Z-ADD@TRA1     W@TAMT 150                      CRT002
     C                     Z-ADD@TRA2     W@SCEQ 150                      CRT002
     C                     ENDIF                                          CRT002
      *
     C/COPY WNCPYSRC,REH00282
      *
      ** Validate Charges fields if entered
     C           @SAR      IFNE *BLANKS
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     EXSR ALNCHG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C           PMODE     OREQ 'P'                                       CRT002
     C           SCAMT     ANDNE*BLANKS                                   118789
     C           *IN31     ANDEQ'0'                                       CRT002
     C           *IN50     ANDEQ'0'                                       CRT002
     C                     EXSR CHARGE
     C                     END                                            CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           SCAMT     ANDNE*BLANKS                                   118789
     C           *IN31     ANDEQ'0'                                       CRT002
     C           *IN50     ANDEQ'0'                                       CRT002
     C           WCHCCY    ANDEQSBCCY                                     CRT002
     C**********           SUB  @CHAMT    @TAMT                     CRT002153383
      *                                                                   CRT002
     C           @CHAMT    IFGT @TAMT                                     CRT002
     C                     MOVE '1'       *IN31                           CRT002
     C                     MOVE '1'       *IN50                           CRT002
     C                     MOVE 'USR0207' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           SCAMT     ANDNE*BLANKS                                   118789
     C           *IN31     ANDEQ'0'                                       CRT002
     C           *IN50     ANDEQ'0'                                       CRT002
     C***********WCHCCY    ANDNESSCCY                              118789 145083
     C           WCHCCY    ANDEQSSCCY                                     145083
     C***********          SUB  @CHAMT    @TAMT                     CRT002153383
      *                                                                   CRT002
     C           @CHAMT    IFGT W@SCEQ                                    CRT002
     C                     MOVE '1'       *IN31                           CRT002
     C                     MOVE '1'       *IN50                           CRT002
     C                     MOVE 'USR0208' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     END
      *                                                                   CRT002
      **  In 'P' mode, get the exchange rate between the buy and sell amtsCRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'0'                                       CRT002
      *                                                                   CRT002
     C                     MOVEL@TDEC     W@TDP                           CRT002
     C                     MOVEL@SDEC     W@EDP                           CRT002
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C           WEXDF     ANDEQ'Y'                                       CEU024
     C                     MOVELWBIND     W@TMD                           CEU024
     C                     MOVELWSIND     W@EMD                           CEU024
     C                     ELSE                                           CEU024
     C                     MOVE @TMD      W@TMD                           CRT002
     C                     MOVE @SMD      W@EMD                           CRT002
     C                     ENDIF                                          CEU024
     C                     MOVELSBCCY     W@TCY                           CRT002
     C                     MOVELSSCCY     W@ECY                           CRT002
     C                     Z-ADD@BXRT     @TCSP  138                      CRT002
     C                     Z-ADD@SXRT     @EQSP  138                      CRT002
     C                     EXSR CMPXRT                                    CRT002
      *                                                                   CRT002
     C                     MOVELSBCCY     @TCCY                           CRT002
     C                     Z-ADD@TAMT     @TCAM                           CRT002
     C                     MOVEL@TDEC     @TCDP                           CRT002
     C                     MOVEL@TMD      @TCMD                           CRT002
     C                     MOVELSSCCY     @EQCY                           CRT002
     C                     MOVEL@SDEC     @EQDP                           CRT002
     C                     MOVEL@SMD      @EQMD                           CRT002
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C********** CRT104    IFEQ 'N'                                CEU024 151260
     C           WEXDF     IFEQ 'Y'                                       151260
     C                     MOVELWBIND     @TCMD                           CEU024
     C                     MOVELWSIND     @EQMD                           CEU024
     C                     ENDIF                                          CEU024
     C                     MOVELBKEURO    @EUCY   3                       CEU024
     C                     MOVE WEXDF     @INEU   1                       151260
     C                     EXSR RTCOEU                                    CEU024
     C                     ELSE                                           CEU024
     C                     EXSR RTCONV                                    CRT002
     C                     ENDIF                                          CEU024
     C                     Z-ADD@EQAM     W@TAM                           CRT002
      *                                                                   CRT002
     C                     MOVELSSCCY     @TCCY                           CRT002
     C                     Z-ADD@SCEQ     @TCAM                           CRT002
     C                     MOVEL@SDEC     @TCDP                           CRT002
     C                     MOVEL@SMD      @TCMD                           CRT002
     C                     MOVELSBCCY     @EQCY                           CRT002
     C                     MOVEL@TDEC     @EQDP                           CRT002
     C                     MOVEL@TMD      @EQMD                           CRT002
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C********** CRT104    IFEQ 'N'                                CEU024 151260
     C           WEXDF     IFEQ 'Y'                                       151260
     C                     MOVELWSIND     @TCMD                           CEU024
     C                     MOVELWBIND     @EQMD                           CEU024
     C                     ENDIF                                          CEU024
     C                     MOVELBKEURO    @EUCY                           CEU024
     C                     MOVE WEXDF     @INEU                           151260
     C                     EXSR RTCOEU                                    CEU024
     C                     ELSE                                           CEU024
     C                     EXSR RTCONV                                    CRT002
     C                     ENDIF                                          CEU024
     C                     Z-ADD@EQAM     W@EAM                           CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   RT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C           *IN50     IFEQ '0'                                       CRT002
      *                                                                   CRT002
      **  Get equivalent amount of one and check if they tally with       CRT002
      **  other amounts sent on the msg.                                  CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
     C           WRDCY     WHEQ '1'                                       CRT002
     C           PFNCD     ANDEQ'0JI'                                     CRT002
     C           WRDCY     OREQ '2'                                       CRT002
     C           PFNCD     ANDEQ'0JX'                                     CRT002
     C                     MOVELSSCCY     @TCCY                           CRT002
     C                     Z-ADD@SCEQ     @TCAM                           CRT002
     C                     MOVEL@SDEC     @TCDP                           CRT002
     C                     MOVEL@SMD      @TCMD                           CRT002
     C                     MOVELSBCCY     @EQCY                           CRT002
     C                     MOVEL@TDEC     @EQDP                           CRT002
     C                     MOVEL@TMD      @EQMD                           CRT002
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C********** CRT104    IFEQ 'N'                                CEU024 151260
     C           WEXDF     IFEQ 'Y'                                       151260
     C                     MOVELWSIND     @TCMD                           CEU024
     C                     MOVELWBIND     @EQMD                           CEU024
     C                     ENDIF                                          CEU024
     C                     MOVELBKEURO    @EUCY                           CEU024
     C                     MOVE WEXDF     @INEU                           151260
     C                     EXSR RTCOEU                                    CEU024
     C                     ELSE                                           CEU024
     C                     EXSR RTCONV                                    CRT002
     C                     ENDIF                                          CEU024
      *                                                                   CRT002
     C           @TRA1     IFNE @EQAM                                     CRT002
     C           PFNCD     ANDEQ'0JI'                                     CRT002
     C                     SETON                     2850                 CRT002
     C                     MOVEL'USR0156' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
     C           @EQAM     SUB  @TAMT     @DIFR                           CRT002
     C           @DIFR     IFLT 0                                         CRT002
     C                     Z-SUB@DIFR     @DIFR                           CRT002
     C                     ENDIF                                          CRT002
     C           @DIFR     IFNE @RDAM                                     CRT002
     C                     SETON                     2850                 CRT002
     C                     MOVEL'USR0157' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           WRDCY     WHEQ '2'                                       CRT002
     C           PFNCD     ANDEQ'0JI'                                     CRT002
     C           WRDCY     OREQ '1'                                       CRT002
     C           PFNCD     ANDEQ'0JX'                                     CRT002
     C                     MOVELSBCCY     @TCCY                           CRT002
     C                     Z-ADD@TAMT     @TCAM                           CRT002
     C                     MOVEL@TDEC     @TCDP                           CRT002
     C                     MOVEL@TMD      @TCMD                           CRT002
     C                     MOVELSSCCY     @EQCY                           CRT002
     C                     MOVEL@SDEC     @EQDP                           CRT002
     C                     MOVEL@SMD      @EQMD                           CRT002
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C********** CRT104    IFEQ 'N'                                CEU024 151260
     C           WEXDF     IFEQ 'Y'                                       151260
     C                     MOVELWBIND     @TCMD                           CEU024
     C                     MOVELWSIND     @EQMD                           CEU024
     C                     ENDIF                                          CEU024
     C                     MOVELBKEURO    @EUCY                           CEU024
     C                     MOVE WEXDF     @INEU                           151260
     C                     EXSR RTCOEU                                    CEU024
     C                     ELSE                                           CEU024
     C                     EXSR RTCONV                                    CRT002
     C                     ENDIF                                          CEU024
      *                                                                   CRT002
     C           @TRA2     IFNE @EQAM                                     CRT002
     C           PFNCD     ANDEQ'0JI'                                     CRT002
     C                     SETON                     4050                 CRT002
     C                     MOVEL'USR0158' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
     C           @EQAM     SUB  @SCEQ     @DIFR                           CRT002
     C           @DIFR     IFLT 0                                         CRT002
     C                     Z-SUB@DIFR     @DIFR                           CRT002
     C                     ENDIF                                          CRT002
     C           @DIFR     IFNE @RDAM                                     CRT002
     C                     SETON                     4050                 CRT002
     C                     MOVEL'USR0159' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C*
     C/COPY WNCPYSRC,RE4120CCP2
     C*
      *
      ** If no errors and sell amount entered calculate buy amount
      ** Decide which rate to be used for converting one amount to its    093692
      ** equivalent in the other CCY thru SR/GETXRT.                      093692
      *                                                                   093692
     C           *IN50     IFEQ '0'
     C           SSAMT     ANDNE*BLANKS
     C                     SETON                     34
     C                     EXSR GETXRT                                    093692
     C                     EXSR CALBUY
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
     C                     END
      *
      ** If there are no errors in validation
     C           *IN50     IFEQ '0'
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
      *
      ** Calculate sell amt.equivalent of buy amt.
      ** if buy amount entered
     C           *IN34     IFEQ '0'
      *
     C                     MOVE SBCCY     @TCCY
      *
      ** Calculate charge if in buy currency, and subtract from buy amt
     C           SCHIND    IFEQ 'B'
     C           SCPER     IFNE *BLANKS
     C           @TAMT     MULT @CHPER    @WRK   190
     C********** @WRK      DIV  10000     @CHAMT 150                      143087
     C           @WRK      DIV  10000     @CHAMT 150H                     143087
     C                     END
     C           @TAMT     SUB  @CHAMT    @TCAM
     C                     ELSE
     C                     Z-ADD@TAMT     @TCAM
     C                     END
      *
     C                     Z-ADD@TDEC     @TCDP
     C                     MOVE @TMD      @TCMD
     C                     MOVE SSCCY     @EQCY
     C                     Z-ADD@SDEC     @EQDP
     C                     MOVE @SMD      @EQMD
      *
      ** Decide which rate to be used for converting one amount to its    093692
      ** equivalent in the other CCY thru SR/GETXRT.                      093692
      *                                                                   093692
     C           CEU024    IFEQ 'Y'                                       CEU024
     C********** CRT104    IFEQ 'N'                                CEU024 151260
     C           WEXDF     IFEQ 'Y'                                       151260
     C                     MOVELWBIND     @TCMD                           CEU024
     C                     MOVELWSIND     @EQMD                           CEU024
     C                     ENDIF                                          CEU024
     C                     MOVELBKEURO    @EUCY                           CEU024
     C                     MOVE WEXDF     @INEU                           151260
     C                     EXSR GETXRT                                    CEU024
     C********** SBCCY     IFEQ BJCYCD                             146200 151340
     C********** SSCCY     ANDEQBKEURO                             146200 151340
     C********** CRT104    ANDEQ'N'                                146200 151340
     C********** WEXDF     ANDNE'Y'                                146200 151340
     C**********           Z-ADD@OXRT     @EXRT                    146200 151340
     C**********           ENDIF                                   146200 151340
     C                     EXSR RTCOEU                                    CEU024
     C                     ELSE                                           CEU024
     C                     EXSR GETXRT                                    093692
     C                     EXSR RTCONV
     C                     ENDIF                                          CEU024
      *
      ** Check charge less than sell amount if against sell ccy
     C           SCHIND    IFEQ 'S'
     C********** @CHAMT    ANDGT@EQAM                                     143087
     C           @CHAMT    ANDGE@EQAM                                     143087
     C                     SETON                     3150
     C                     MOVE 'USR0208' @MSGID
     C                     EXSR SNDMSG
     C                     GOTO ERROR
     C                     END
      *
      *
      ** If charge in sell currency subtract from sell equivalent amount
      ** -  save sell equivalent amount first
     C           SCHIND    IFEQ 'S'
     C                     MOVE @EQAM     @EQAMS 150
     C           SCPER     IFNE *BLANKS
     C           @EQAM     MULT @CHPER    @WRK
     C********** @WRK      DIV  10000     @CHAMT                          143087
     C           @WRK      DIV  10000     @CHAMT    H                     143087
     C                     END
     C                     SUB  @CHAMT    @EQAM
     C                     END
      *
     C                     Z-ADD@EQAM     @SCEQ  150
      *
     C                     END
      *
      ** Edit the sell amount field - insert dec.pt for screen display
     C                     Z-ADD@SDEC     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @SCEQ     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @AMTDS
     C                     MOVE *BLANKS   @SBAMT
     C                     MOVE ZOUT22    @AMTDS
     C                     MOVEL@SBAMT    @SCYEQ
      *
      ** Display sell amount if buy amount entered
     C           *IN34     IFEQ '0'
     C                     MOVE @SCYEQ    SSAMT
     C                     END
      *
      ** Edit the charge amount field - insert dec.pt for display
     C           SCHIND    IFNE ' '
      *
     C           SCHIND    IFEQ 'B'
     C                     Z-ADD@TDEC     ZDECS
     C                     ELSE
     C                     Z-ADD@SDEC     ZDECS
     C                     END
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @CHAMT    ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @CHGDS
     C                     MOVE *BLANKS   @SCAMT
     C                     MOVE ZOUT22    @CHGDS
      *
     C                     END
      *
      ** Perform rounding of buy and sell amounts if required
     C                     EXSR ROUND
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   143087
     C           *IN50     IFEQ '0'                                       143087
      *
      ** Teller currency conditions check for buy ccy.
     C                     MOVELSBCCY     @CCY
     C                     EXSR RTTCCY
      *
      ** Teller currency conditions check for sell ccy.
     C                     MOVELSSCCY     @CCY
     C                     EXSR RTTCCY
      *
      ** Move fields to key list.
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     MOVEL'1'       KRCTP
      *
      ** Access teller controls - TTRNTM2 - to get currencies array
     C           KLTRNT    CHAINTTRNTM2F             70
      *
      ** perform excess cash check for sell amt.equivalent
      ** only if cash indicator is 'Y'
     C           PMODE     IFEQ 'I'                                       139596
     C           @SCSIN    IFEQ 'Y'
     C                     Z-ADD@SCEQ     @TNAM  150
     C                     MOVELSSCCY     @CCY    3
     C                     EXSR RTCASH
     C                     END
     C                     ENDIF                                          139596
      *
      ** perform transaction check for terminal/warning errors
     C                     EXSR TRCHEK
      *
      ** If terminal error(s) exist
     C           @TI       IFGT 0
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     SETON                     20
     C                     END                                            CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVE '0'       *IN20                           CRT002
     C                     END                                            CRT002
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
     C                     ELSE
      *
      ** If warning error(s) exist and different from previous error(s)
     C           @WI       IFGT 0
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
      *
      ** Move overrride indicators from rtsdta to teller ovr.ind.array
     C                     MOVEAPOVIN     @R
      *
      ** Perform ovr.validation to check whether signon teller has
      ** authority to override - otherwise override prompt is required
     C                     EXSR VALOVR
      *
      ** If no successful override - override prompt is required
     C           *IN51     IFEQ '1'
      *
      ** If CRT026 is switch on use User Id instead of Teller ID                              CRT026
      *                                                                                       CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE *ON       *IN54                                               CRT026
     C                     ELSE                                                               CRT026
     C                     SETON                     21
     C                     ENDIF                                                              CRT026
      *
     C/COPY WNCPYSRC,REH00283
     C                     END
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVE '0'       *IN20                           CRT002
     C                     END                                            CRT002
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
      *
      ** Perform transaction override process
     C                     SETON                     51
     C                     EXSR TRNOVR
     C/COPY WNCPYSRC,REH00284
      *
     C                     END
      *                                                                   143087
     C                     ENDIF                                          143087
      *
     C           ERROR     TAG
      *
     C                     END
      *
     C           ERROR2    TAG                                            CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALAMT - Validate amount                           *
      *                                                               *
      * CALLS      ZALIGN - Validate amount fields                    *
      *            ZFRPED - Edit numeric field                        *
      *            SNDMSG - Send program message parameters           *
      *            EBYAMT - Edit buy amount                           *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALAMT    BEGSR                           ** VALAMT **
      *
      ** Check if amount field is blanks or zeros
     C           SBAMT     IFEQ *ZEROS
     C           SBAMT     OREQ *BLANKS
     C                     SETON                     1350
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Set up decimal values
     C                     Z-ADD@TDEC     ZADEC
     C           13        SUB  @TDEC     ZADIG
      *
      ** Align amount - and move it to numeric field
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SBAMT     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @TAMT  150
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     1350
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
      **  Validate amount against smallest denomination
     C           *IN13     IFEQ '0'
     C           @TAMT     DIV  @TSML     @@WORK 150
     C                     MVR            @XCESS  50
     C           @XCESS    IFNE *ZERO
     C                     SETON                     1350
     C                     MOVE 'USR0219' @MSGID
     C                     EXSR SNDMSG
     C                     END
     C                     END
      *
      ** If there are no errors - edit the amount field - insert dec.pt
     C           *IN13     IFEQ '0'
     C                     Z-ADD@TDEC     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @TAMT     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @AMTDS
     C                     MOVE *BLANKS   SBAMT
     C                     MOVE ZOUT22    @AMTDS
     C                     MOVEL@SBAMT    SBAMT
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALSAM - Validate sell amount                      *
      *                                                               *
      * CALLS      ZALIGN - Validate amount fields                    *
      *            ZFRPED - Edit numeric field                        *
      *            SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALSAM    BEGSR                           ** VALSAM **
      *
      ** Check if amount field is zero
     C           SSAMT     IFEQ *ZEROS
     C                     SETON                     3350
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Set up decimal values
     C                     Z-ADD@SDEC     ZADEC
     C           13        SUB  @SDEC     ZADIG
      *
      ** Align amount - and move it to numeric field
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SSAMT     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @SCEQ
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     3350
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
      **  Validate amount against smallest denomination
     C           *IN33     IFEQ '0'
     C           @SCEQ     DIV  @SSML     @@WORK
     C                     MVR            @XCESS
     C           @XCESS    IFNE *ZERO
     C                     SETON                     3350
     C                     MOVE 'USR0219' @MSGID
     C                     EXSR SNDMSG
     C                     END
     C                     END
      *
      ** If there are no errors - edit the amount field - insert dec.pt
     C           *IN33     IFEQ '0'
     C                     EXSR FMTSEL
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALXRT - Validate exchange rate                    *
      *                                                               *
      * CALLS      ZALIGN - Validate amount fields                    *
      *            ZFRPED - Edit numeric field                        *
      *            SNDMSG - Send program message parameters           *
      *            INSRAT - Insert default exchange rate              *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALXRT    BEGSR                           ** VALXRT **
      *
     C                     MOVE *BLANKS   @BDCD   1                       CEU024
     C                     MOVE *BLANKS   WEXDF   1                       CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C                     MOVE *BLANKS   WRTDF   1                       CEU024
      *                                                                   CEU024
      ** Both currencies are 'in' ccy or a euro and an 'in' ccy           CEU024
      *                                                                   CEU024
     C           WBCCY     IFEQ 'Y'                                       CEU024
     C           WSLCY     ANDEQ'Y'                                       CEU024
     C           SSCCY     ANDNESBCCY                                     CEU024
     C           WBCCY     OREQ 'E'                                       CEU024
     C           WSLCY     ANDEQ'Y'                                       CEU024
     C           SSCCY     ANDNESBCCY                                     CEU024
     C           WBCCY     OREQ 'Y'                                       CEU024
     C           WSLCY     ANDEQ'E'                                       CEU024
     C           SSCCY     ANDNESBCCY                                     CEU024
      *                                                                   CEU024
     C                     MOVE 'Y'       WRTDF                           CEU024
     C                     MOVE 'Y'       WEXDF                           CEU024
      *                                                                   CEU024
      ** Default exchange rate                                            CEU024
      *                                                                   CEU024
     C***********CRT104    IFEQ 'Y'                                CEU024 147915
     C***********          EXSR INSRAT                             CEU024 147915
     C***********          ELSE                                    CEU024 147915
     C***********          SELEC                                   146200 147915
     C***********SSCCY     WHEQ BKEURO                             146200 147915
     C***********          Z-ADDWBRAT     ZRATEX                   146200 147915
      ***********                                                  146200 147915
     C***********SBCCY     WHEQ BKEURO                             146200 147915
     C***********          Z-ADDWSRAT     ZRATEX                   146200 147915
      ***********                                                  146200 147915
     C***********          OTHER                                   146200 147915
      *                                                                   151340
     C                     SELEC                                          151340
      *                                                                   151340
     C           SBCCY     WHEQ BKEURO                                    151340
     C                     Z-ADDWSRAT     W#RT                            151340
     C                     Z-ADDWSRAT     @XRT1                           151340
      *                                                                   151340
     C           SSCCY     WHEQ BKEURO                                    151340
     C                     Z-ADDWBRAT     W#RT                            151340
     C                     Z-ADDWBRAT     @XRT1                           151340
      *                                                                   151340
     C                     OTHER                                          151340
      *                                                                   151340
      * Calculate buy to sell cross rate                                  151340
     C                     Z-ADDWBRAT     ZRATE1 138                      CEU024
     C                     MOVELWBIND     ZMDI1   1                       CEU024
     C                     Z-ADDWSRAT     ZRATE2 138                      CEU024
     C                     MOVELWSIND     ZMDI2   1                       CEU024
     C**********           EXSR ZXRATE                             CEU024 151340
     C                     EXSR RTZXRT                                    151340
     C***********SBCCY     IFNE BKEURO                             CEU024 146200
     C***********SSCCY     ANDNEBKEURO                             CEU024 146200
     C********** ZMDIX     IFEQ 'D'                                CEU024 151340
     C********** 1         DIV  ZRATEX    ZRATEX                   CEU024 151340
     C**********           ENDIF                                   CEU024 151340
     C***********          ENDIF                                   CEU024 146200
     C***********          ENDSL                                   146200 147915
      *                                                                   146200
     C           SSAMT     IFEQ *BLANKS                                   151340
     C                     Z-ADDZRATEX    W#RT                            CEU024
     C                     ELSE                                           151340
     C                     Z-ADDZRATEX    @XRT1                           151340
     C                     ENDIF                                          151340
     C***********          ENDIF                                   CEU024 147915
      *                                                                   151340
      * Calculate sell to buy cross rate                                  151340
     C                     Z-ADDWSRAT     ZRATE1                          151340
     C                     MOVELWSIND     ZMDI1                           151340
     C                     Z-ADDWBRAT     ZRATE2                          151340
     C                     MOVELWBIND     ZMDI2                           151340
     C                     EXSR RTZXRT                                    151340
     C           SSAMT     IFEQ *BLANKS                                   151340
     C                     Z-ADDZRATEX    @XRT1                           151340
     C                     ELSE                                           151340
     C                     Z-ADDZRATEX    W#RT                            151340
     C                     ENDIF                                          151340
      *                                                                   151340
     C                     ENDSL                                          151340
      *                                                                   151340
     C                     MOVE *BLANKS   WRTDF                           CEU024
      *                                                                   CEU024
     C           SEXRT     IFEQ *BLANKS                                   CEU024
     C                     MOVEL*BLANKS   ZFIELD                          CEU024
     C                     MOVE W#RT      ZFIELD                          CEU024
     C                     Z-ADD8         ZADEC                           CEU024
     C                     EXSR ZEDIT                                     CEU024
     C                     MOVE ZFIELD    SEXRT                           CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C           CRT104    IFEQ 'Y'
      *
      * If exchange rate is blank insert default rate
      * (SBCCY and SSCCY condition included, because blank currency field
      *    causes database error)
     C           SEXRT     IFEQ *BLANKS
      ** Not if Buy and sell currencies are the same as divide by zero
      ** error occurs in subroutine
     C           SSCCY     ANDNESBCCY
     C                     EXSR INSRAT
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Check if ex.rate field is blanks or zeros
     C           SEXRT     IFEQ *ZEROS
     C           SEXRT     OREQ *BLANKS
     C                     SETON                     1450
     C                     MOVE 'USR0089' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Set up decimal values
     C                     Z-ADD8         ZADEC
     C           13        SUB  ZADEC     ZADIG
      *
      ** Align amount - and move it to numeric field
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SEXRT     ZFIELD
     C                     EXSR ZALIGN
     C***********          MOVE ZFIELD    @EXRT  138                      093692
     C                     MOVE ZFIELD    @UEXRT 138                      093692
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     1450
     C                     MOVE 'USR0089' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** Exchange rate entered is not equal to the value computed         CEU024
      ** If cross rate can be buy to sell or sell to buy.                 151340
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C           @UEXRT    ANDNEW#RT                                      CEU024
     C           @UEXRT    ANDNE@XRT1                                     151340
     C           WEXDF     ANDEQ'Y'                                       CEU024
     C                     MOVE *BLANKS   ZFIELD                          CEU024
     C                     MOVE @UEXRT    ZFIELD                          CEU024
     C                     Z-ADD8         ZADEC                           CEU024
     C                     EXSR ZEDIT                                     CEU024
     C                     MOVE ZFIELD    SEXRT                           CEU024
     C                     SETON                     1450                 CEU024
     C                     MOVEL'USR0400' @MSGID                          CEU024
     C                     EXSR SNDMSG                                    CEU024
     C                     ENDIF                                          CEU024
     C                     END
      *
      ** If there are no errors - edit the amount field - insert dec.pt
     C           *IN14     IFEQ '0'
     C                     Z-ADD8         ZDECS
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C***********          MOVE @EXRT     ZFLD15                          093692
     C                     MOVE @UEXRT    ZFLD15                          093692
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @XRTDS
     C                     MOVE *BLANKS   SEXRT
     C                     MOVE ZOUT22    @XRTDS
     C                     MOVEL@XRT      SEXRT
      *
      ** Edit the exchange rate for printing
     C                     Z-ADD8         ZDECS
     C                     MOVE 'J'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C***********          MOVE @EXRT     ZFLD15                         093692
     C                     MOVE @UEXRT    ZFLD15                         093692
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @EXCRT
     C                     MOVE *BLANKS   OEXRT
     C                     MOVE ZOUT22    @EXCRT
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              093692
      *****************************************************************   093692
      *                                                               *   093692
      *            GETXRT - Decide which exchange rate to be used     *   093692
      *                                                               *   093692
      * CALLS      ZALIGN - Validate amount fields                    *   093692
      *            ZFRPED - Edit numeric field                        *   093692
      *            SNDMSG - Send program message parameters           *   093692
      *            INSRAT - Insert default exchange rate              *   093692
      *                                                               *   093692
      * CALLED BY  VALDET - Validate details                          *   093692
      *                                                               *   093692
      * FLDS USED         -                                           *   093692
      *                                                               *   093692
      *****************************************************************   093692
     C           GETXRT    BEGSR                           ** GETXRT **   093692
      *                                                                   CEU024
      ** If CEU024 is installed, Euro ccy is always the reference         CEU024
      ** Only if both ccys 'in' or 1 'in' & 1 Euro!                       151340
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C           WEXDF     ANDEQ'Y'                                       CEU024
     C********** CRT104    ANDEQ'N'                                CEU024 151340
      *                                                                   CEU024
     C                     SELEC                                          CEU024
     C           SBCCY     WHEQ BKEURO                                    CEU024
     C**********           Z-ADDWSRAT     @XRT1                    CEU024 151340
     C                     Z-ADDWSRAT     @EXRT                           151340
     C                     Z-ADDWSRAT     @OXRT                           151340
     C           SSCCY     WHEQ BKEURO                                    CEU024
     C**********           Z-ADDWBRAT     @XRT1                    CEU024 151340
     C                     Z-ADDWBRAT     @EXRT                           151340
     C                     Z-ADDWBRAT     @OXRT                           151340
     C**********           ENDSL                                   147915 151340
      *                                                                   CEU024
      ***If*neither*ccy*is base SR/RTCONV simply multiplies amount CEU024 151340
      ***rate,*so*need*to*convert both ccys to 'M' rate if necessa CEU024 151340
      ***and*if*sell*amount entered the rate used must be the rate CEU024 151340
      ***converting*sell*ccy to buy ccy.                           CEU024 151340
      *                                                                   CEU024
     C***********          OTHER                                   CEU024 147915
     C********** WBIND     IFEQ 'D'                                CEU024 151340
     C********** 1         DIV  WBRAT     @BXRT2 138H              CEU024 151340
     C**********           Z-ADD@BXRT2    @BXRT                    CEU024 151340
     C**********           ENDIF                                   CEU024 151340
     C********** WSIND     IFEQ 'D'                                CEU024 151340
     C********** 1         DIV  WSRAT     @SXRT2 138H              CEU024 151340
     C**********           Z-ADD@SXRT2    @SXRT                    CEU024 151340
     C**********           ENDIF                                   CEU024 151340
     C********** *IN34     IFEQ '0'                                CEU024 151340
     C********** @BXRT     DIV  @SXRT     @XRT1  138H              CEU024 151340
     C**********           ELSE                                    CEU024 151340
     C********** @SXRT     DIV  @BXRT     @XRT1                    CEU024 151340
     C**********           ENDIF                                   CEU024 151340
     C***********          ENDSL                                   CEU024 147915
      *                                                                   151340
      * Cross rate already calculated the right way round                 151340
     C                     OTHER                                          151340
     C                     Z-ADDW#RT      @EXRT                           151340
     C                     Z-ADD@XRT1     @OXRT                           151340
     C                     ENDSL                                          151340
      *                                                                   CEU024
      ** CEU024 is not installed, or involving an 'out' currency          CEU024
      *                                                                   CEU024
     C                     ELSE                                           CEU024
     C********** CEU024    IFEQ 'Y'                                CEU024 151340
     C********** CRT104    ANDEQ'Y'                                CEU024 151340
     C**********           Z-ADDW#RT      @XRT1                    CEU024 151340
     C**********           ELSE                                    CEU024 151340
      *                                                                   099360
      **  If 1 ccy is base use the spot rate for the non-base ccy.        099360
      **  (SR/RTCONV takes mult/div ind. into account if 1 ccy is base.)  099360
      *                                                                   099360
     C           SBCCY     IFEQ @BSCY                                     099360
     C                     Z-ADD@SXRT     @XRT1                           099360
     C                     ELSE                                           099360
     C           SSCCY     IFEQ @BSCY                                     099360
     C                     Z-ADD@BXRT     @XRT1                           099360
     C                     ELSE                                           099360
      *                                                                   099360
      **  If neither ccy is base SR/RTCONV simply multiplies amount by    099360
      **  rate, so need to convert both ccys to 'M' rate if necessary     099360
      **  and if sell amount entered the rate used must be the rate for   099360
      **  converting sell ccy to buy ccy.                                 099360
      *                                                                   093692
      ** Buy CCY. Convert to 'M' rate.                                    093692
      *                                                                   093692
     C           @TMD      IFEQ 'D'                                       093692
     C           1         DIV  @BXRT     @BXRT2 138H                     093692
     C                     Z-ADD@BXRT2    @BXRT                           093692
     C                     END                                            093692
      *                                                                   093692
      ** Sell CCY. Convert to 'M' rate.                                   093692
      *                                                                   093692
     C           @SMD      IFEQ 'D'                                       093692
     C           1         DIV  @SXRT     @SXRT2 138H                     093692
     C                     Z-ADD@SXRT2    @SXRT                           093692
     C                     END                                            093692
      *                                                                   093692
      ** Calculate exchange rates based on the two CCYs.                  093692
      *                                                                   093692
     C           *IN34     IFEQ '0'                                       093692
     C***********SBCCY     ANDNE@BSCY                              093692 099360
     C***********SSCCY     OREQ @BSCY                              093692 099360
     C           @BXRT     DIV  @SXRT     @XRT1  138H                     093692
     C                     ELSE                                           093692
     C           @SXRT     DIV  @BXRT     @XRT1                           093692
     C                     END                                            093692
      *                                                                   099360
     C                     END                                            099360
     C                     END                                            099360
      *                                                                   CEU024
     C**********           ENDIF                                   CEU024 151340
     C**********           ENDIF                                   CEU024 151340
      *                                                                   093692
      ** Get the reciprocal of the input rate, also the input rate itself 093692
      ** into a work field.                                               093692
      *                                                                   093692
     C           1         DIV  @UEXRT    @RXRT  138H                     093692
     C                     Z-ADD@UEXRT    @IXRT  138                      093692
      *                                                                   093692
      ** From @RXRT and @IXRT, use the rate which is closer to the rates  093692
      ** taken from PF/SDCURRPD.                                          093692
      *                                                                   093692
     C           @RXRT     SUB  @XRT1     @DIFFR 138                      093692
     C           @IXRT     SUB  @XRT1     @DIFFI 138                      093692
     C           @DIFFR    IFLT 0                                         093692
     C                     Z-SUB@DIFFR    @DIFFR                          093692
     C                     END                                            093692
     C           @DIFFI    IFLT 0                                         093692
     C                     Z-SUB@DIFFI    @DIFFI                          093692
     C                     END                                            093692
      *                                                                   093692
      ** Use the rate which produced the lesser difference.               093692
      *                                                                   093692
     C           @DIFFR    IFGT @DIFFI                                    093692
     C                     Z-ADD@IXRT     @EXRT                           093692
     C                     Z-ADD@RXRT     @OXRT  138       Save other rate099360
     C                     ELSE                                           093692
     C                     Z-ADD@RXRT     @EXRT                           093692
     C                     Z-ADD@IXRT     @OXRT            Save other rate099360
     C                     END                                            093692
      *                                                                   093692
     C********** @C104     IFNE 'Y'                                147915 151340
     C********** SBCCY     ANDEQBKEURO                             147915 151340
     C********** @SMD      ANDEQ'M'                                147915 151340
     C**********           Z-ADD@IXRT     @EXRT                    147915 151340
     C**********           Z-ADD@RXRT     @OXRT                    147915 151340
     C**********           ENDIF                                   147915 151340
      *                                                                   147915
     C                     ENDIF                                          151340
      *                                                                   151340
     C                     ENDSR                                          093692
      *****************************************************************   093692
      /EJECT
      *****************************************************************
      *                                                               *
      *            INSRAT - Insert dafault exchange rate              *
      *                                                               *
      * CALLS      ZEDIT  - Insert decimal field                      *
      * CALLED BY  VSEXRT - Validate exchange rate                    *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           INSRAT    BEGSR
     C                     OPEN REBDCCPD
      *
     C                     OPEN REBDCRPD
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JR'                                     CRT002
     C                     MOVEL'0JK'     WKEY                            CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JW'                                     CRT002
     C                     MOVEL'0JL'     WKEY                            CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JS'                                     CRT002
     C           PFNCD     OREQ '0JX'                                     CRT002
     C                     MOVEL'0JI'     WKEY                            CRT002
      *                                                                   CRT002
     C                     OTHER                                          CRT002
      *                                                                   CRT002
     C                     MOVELPFNCD     WKEY    3                       CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
     C                     DO
      *
      ** Find function code in Exchange Rate Control Table
     C***********PFNCD*****CHAINREBDCCD0             70                   118789
     C           WKEY      CHAINREBDCCD0             70                   118789
      *
      ** If record not found?
     C           *IN70     IFEQ *ON
      *                                                                   140255
     C                     GOTO INSEND                     Just return    140255
      *                                                    blank rate.    140255
     C************LOCK     IN   LDA                        ***************140255
     C***********          Z-ADD22        DBASE            ** DB ERR 22 **140255
     C***********          MOVEL'REBDCCPD'DBFILE           ***************140255
     C***********          MOVELPFNCD     DBKEY                           140255
     C***********          EXSR DBERR                                     140255
     C                     END
      *
      ** Check if trans. currency or account currency are not base one
     C           SBCCY     IFNE @BSCY
     C           SSCCY     ANDNE@BSCY
      *
      ** Find Transaction Currency in Currency Details Extension File
     C           SBCCY     CHAINREBDCRD0             70
      *
      ** If record not found - exit default rate processing
     C           *IN70     IFEQ *ON
     C                     LEAVE
     C                     ENDIF
      *
      ** Move exchange rate in accordance with function and currency code
     C                     Z-ADD0         W#RT   138
     C                     SELEC
     C           NAC       WHEQ 'DN'
     C           FEDNRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'DP'
     C           FEDPRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'DS'
     C           FEDSRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VN'
     C           FEVNRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VP'
     C           FEVPRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VS'
     C           FEVSRT    DIV  FEAMNT    W#RT      H
     C                     ENDSL
      *
      *
      ** Find Account Currency in Currency Details Extension File
     C           SSCCY     CHAINREBDCRD0             70
      *
      ** If record not found - exit default rate processing
     C           *IN70     IFEQ *ON
     C                     LEAVE
     C                     ENDIF
      *
      ** Move exchange rate in accordance with function and currency code
     C                     Z-ADD0         W#RT2  138
     C                     SELEC
     C           ACC       WHEQ 'DN'
     C           FEDNRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'DP'
     C           FEDPRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'DS'
     C           FEDSRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'VN'
     C           FEVNRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'VP'
     C           FEVPRT    DIV  FEAMNT    W#RT2     H
     C           ACC       WHEQ 'VS'
     C           FEVSRT    DIV  FEAMNT    W#RT2     H
     C                     ENDSL
      *                                                                   CEU024
     C********** CEU024    IFEQ 'Y'                                CEU024 151340
     C********** W#RT      DIV  W#RT2     W#RT      H              CEU024 151340
     C**********           ELSE                                    CEU024 151340
      *
      ** Calculate Exchange Rate through Basic Currency
     C           @TMD      IFEQ 'M'                                       099360
     C           @SMD      IFEQ 'M'                                       099360
     C           W#RT      DIV  W#RT2     W#RT      H
     C                     ELSE                                           099360
     C           W#RT      MULT W#RT2     W#RT      H                     099360
     C                     END                                            099360
     C                     ELSE                                           099360
     C           @SMD      IFEQ 'D'                                       099360
     C           W#RT2     DIV  W#RT      W#RT      H                     099360
     C                     ELSE                                           099360
     C           W#RT      MULT W#RT2     W#RT      H                     099360
     C           1         DIV  W#RT      W#RT      H                     099360
     C                     END                                            099360
     C                     END                                            099360
     C**********           ENDIF                                   CEU024 151340
      *
     C                     ELSE
      *
      ** If Transaction Currency is Basic one, look for Account Curr. Det.
     C           SBCCY     IFEQ @BSCY
     C           SSCCY     CHAINREBDCRD0             70
      *
      ** If record not found - exit default rate processing
     C           *IN70     IFEQ *ON
     C                     LEAVE
     C                     ENDIF
      *
     C                     Z-ADD0         W#RT   138
     C                     SELEC
     C           ACC       WHEQ 'DN'
     C           FEDNRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'DP'
     C           FEDPRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'DS'
     C           FEDSRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'VN'
     C           FEVNRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'VP'
     C           FEVPRT    DIV  FEAMNT    W#RT      H
     C           ACC       WHEQ 'VS'
     C           FEVSRT    DIV  FEAMNT    W#RT      H
     C                     ENDSL
      *
     C                     ELSE
      *
      ** Else look for Transaction Currency details
     C           SBCCY     CHAINREBDCRD0             70
      *
      ** If record not found - exit default rate processing
     C           *IN70     IFEQ *ON
     C                     LEAVE
     C                     ENDIF
      *
      ** Move exchange rate in accordance with function and currency code
     C                     Z-ADD0         W#RT   138
     C                     SELEC
     C           NAC       WHEQ 'DN'
     C           FEDNRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'DP'
     C           FEDPRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'DS'
     C           FEDSRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VN'
     C           FEVNRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VP'
     C           FEVPRT    DIV  FEAMNT    W#RT      H
     C           NAC       WHEQ 'VS'
     C           FEVSRT    DIV  FEAMNT    W#RT      H
     C                     ENDSL
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Insert decimal point
      *                                                                   CEU024
      ** Do not format exchange rate for display on screen when           CEU024
      ** CEU024 is switched on and the currencies involved are not        CEU024
      ** 'in' ccy or a Euro and an 'in' ccy                               CEU024
      *                                                                   CEU024
     C           CEU024    IFEQ 'N'                                       CEU024
     C           CEU024    OREQ 'Y'                                       CEU024
     C           WRTDF     ANDEQ*BLANKS                                   CEU024
     C                     MOVEL*BLANKS   ZFIELD
     C                     MOVE W#RT      ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    SEXRT
     C                     ENDIF                                          CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C                     MOVE 'Y'       @BDCD                           CEU024
     C                     ENDIF                                          CEU024
      *
     C                     ENDDO
     C           INSEND    TAG                                            140255
      *                                                                   140255
     C                     CLOSEREBDCRPD
     C                     CLOSEREBDCCPD
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            TRCHEK - Transaction conditions check              *
      *                                                               *
      * CALLS      RTTLMT - Teller limit check                        *
      *            RTXRAT - Validate exchange rate                    *
      *            RTASGL - No associated GL code check               *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           TRCHEK    BEGSR                           ** TRCHEK **
      *
      ** If teller limit check from fn.cd table is non-blank
     C***********@V,@TL    IFNE ' '                                       114621
     C           @V,@TL    IFNE 'X'                                       114621
     C                     MOVE SBCCY     @TCCY
     C                     Z-ADD@TAMT     @TAM1
     C                     Z-ADD0         @TAM2
     C                     MOVE @BCSIN    @TCI1
     C                     MOVE @SCSIN    @TCI2
     C                     Z-ADDPCHTL     @CHTL
     C                     Z-ADDPNCTL     @NCTL
     C                     EXSR RTTLMT
     C                     END
      *
      ** If exchange rate check from fn.cd table is non-blank
     C                     MOVE SBCCY     @CCY1                           151340
     C                     MOVE SSCCY     @CCY2                           151340
     C***********@V,@XR    IFNE ' '                                       114621
     C           @V,@XR    IFNE 'X'                                       114621
     C           WEXDF     ANDNE'Y'                                       151340
     C**********           MOVE SBCCY     @CCY1                           151340
     C**********           MOVE SSCCY     @CCY2                           151340
      *                                                                   099360
      **  If neither ccy is base and sell amount entered, use inverse     099360
      **  rate for exch. rate check as SR/RTXRAT assumes rate is for buy  099360
      **  ccy to sell ccy.                                                099360
      *                                                                   099360
     C                     Z-ADD@EXRT     @@EXRT 138                      099360
     C           SBCCY     IFNE @BSCY                                     099360
     C           SSCCY     ANDNE@BSCY                                     099360
     C           *IN34     ANDEQ'1'                                       099360
     C                     Z-ADD@OXRT     @EXRT                           099360
     C                     END                                            099360
     C                     EXSR RTXRAT
     C                     Z-ADD@@EXRT    @EXRT                           099360
     C                     END
      *
      ** If no associated gl code from fn.cd table is non-blank
     C***********@V,@GL    IFNE ' '                                       114621
     C           @V,@GL    IFNE 'X'                                       114621
     C                     MOVE SBTRTY    @TYP1
     C                     MOVE SSTRTY    @TYP2
     C                     MOVE @BASGL    @ASGL1
     C                     MOVE @SASGL    @ASGL2
     C                     EXSR RTASGL
      *
      ** If charge associated GL code can not be zero
     C           SCTRTY    IFNE *BLANKS                    B002
     C           @CASGL    ANDEQ0
      *
      ** If override allowed
     C           @V,@GL    IFEQ 'Y'                        B003
     C                     ADD  1         @WI
     C                     MOVEL'N.ASGL3' @W,@WI
     C                     MOVE 'Y'       @O,@GL
     C                     ELSE                            X003
      ** Override not allowed
     C                     ADD  1         @TI
     C                     MOVEL'N.ASGL3' @T,@TI
     C                     END                             E003
      *
     C                     END                             E002
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            CHARGE - Validate Charge Details                   *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            VALAMT - Validate amount                           *
      *            TRCHEK - Transaction conditions check              *
      *            TRNOVR - Transaction override process              *
      *            RTTCCY - Teller currency conditions check          *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      *****************************************************************
     C           CHARGE    BEGSR                           ** CHARGE **
      *
     C/COPY WNCPYSRC,REH00285
      *
      ** If trans. type entered either percent or amount must also be
      ** entered
     C           SCTRTY    IFNE *BLANK
      *
     C           SCPER     IFEQ *BLANK
     C           SCAMT     ANDEQ*BLANK
     C                     SETON                     193150
     C                     MOVE 'USR0210' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** Buy/sell indicator must be entered
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C           SCHIND    IFEQ *BLANK
     C                     SETON                     3050
     C                     MOVE 'USR0214' @MSGID
     C                     EXSR SNDMSG
     C                     END
     C                     ENDIF                                          CRT002
      *
      ** Can not enter both percent. and amount field
     C           SCPER     IFNE *BLANK
     C           SCAMT     ANDNE*BLANK
     C                     SETON                     193150
     C                     MOVE 'USR0206' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO CHARG9                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** If Charge transaction type is blank
      ** message -
     C           SCTRTY    IFEQ *BLANKS                    B002
     C                     SETON                     1850
     C                     MOVEL'USR0085' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE                            X002
     C/COPY WNCPYSRC,RE4120C015
     C*
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C           SCTRTY    PARM SCTRTY    @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record does not exist or is deleted -
     C           @RTCD     IFNE *BLANKS
     C                     SETON                     1850
     C                     MOVEL'USR0086' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE                            X003
     C/COPY WNCPYSRC,RE4120C016
      *
      ** Transaction type must be debit only
     C           A1DCIN    IFNE 'D'                        B004
     C                     SETON                     1850
     C                     MOVEL'USR0087' @MSGID
     C                     EXSR SNDMSG
     C                     END                             E004
      *
      ** Store dr/cr,cash,clearing & reversal indicators for later use
     C**********           MOVE A1ASGL    @CASGL  40                                          CGL029
     C                     MOVE A1ASGL    @CASGL 100                                          CGL029
      *
     C                     END                             E003
      *
     C                     END                             E002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO CHARG9                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** Charge currency indicator must be 'B' or 'S'
      **
     C           PMODE     IFEQ 'I'                                       CRT002
     C           SCHIND    IFNE 'B'                        B002
     C           SCHIND    ANDNE'S'
     C           SCHIND    ANDNE*BLANK
     C                     SETON                     3050
     C                     MOVEL'USR0201' @MSGID
     C                     EXSR SNDMSG
     C                     END                             E002
      *
      ***Charge*currency*must*be*base*currency                            143087
      **
     C********** SCHIND    IFEQ 'B'                        B002           143087
     C********** SBCCY     ANDNE@BSCY                                     143087
     C**********           SETON                     3050                 143087
     C**********           MOVEL'USR0202' @MSGID                          143087
     C**********           EXSR SNDMSG                                    143087
     C**********           END                             E002           143087
      *
     C********** SCHIND    IFEQ 'S'                        B002           143087
     C********** SSCCY     ANDNE@BSCY                                     143087
     C**********           SETON                     3050                 143087
     C**********           MOVEL'USR0202' @MSGID                          143087
     C**********           EXSR SNDMSG                                    143087
     C**********           END                             E002           143087
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
      ** Charge percentage
      **
      *
      ** Validate percent charge if entered
      *
     C           SCPER     IFNE *BLANKS                    B002
      *
      ** Set up decimal values
     C                     Z-ADD2         ZADEC
     C                     Z-ADD2         ZADIG
      *
      ** Align amount - and move it to numeric field
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SCPER     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @CHPER  50
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'                        B003
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     1950
     C                     MOVE 'USR0203' @MSGID
     C                     EXSR SNDMSG
     C                     END                             E003
      *
      ** If there are no errors - edit the field - insert dec.pt
     C           *IN19     IFEQ '0'                        B003
     C                     Z-ADD2         ZDECS
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @CHPER    ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @PERDS
     C                     MOVE *BLANKS   SCPER
     C                     MOVE ZOUT22    @PERDS
     C                     MOVEL@SCPER    SCPER
      *
     C                     END                             E003
      *
     C                     END                             E002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           *IN50     ANDEQ'1'                                       CRT002
     C                     GOTO CHARG9                                    CRT002
     C                     ENDIF                                          CRT002
      *
      ** Validate charge amount if entered
      *
     C           SCAMT     IFNE *BLANKS
      *
      ** Align amount - and move it to numeric field
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
      *                                                                   CRT002
     C           SCHIND    IFEQ 'B'
     C                     Z-ADD@TDEC     ZADEC
     C           13        SUB  @TDEC     ZADIG
     C                     ELSE
     C                     Z-ADD@SDEC     ZADEC
     C           13        SUB  @SDEC     ZADIG
     C                     END
      *
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SCAMT     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @CHAMT
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     3150
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
      *  If there are no errors check charge less than amount
      ** only if sell amount entered otherwise check done in CALBUY
      *
     C           PMODE     IFEQ 'I'                                       CRT002
     C           SCHIND    IFEQ 'B'
     C********** @CHAMT    ANDGT@TAMT                                     143087
     C           @CHAMT    ANDGE@TAMT                                     143087
     C           SBAMT     ANDNE*BLANKS
     C                     SETON                     3150
     C                     MOVE 'USR0207' @MSGID
     C                     EXSR SNDMSG
      *                                                                   143087
     C                     ELSE                                           143087
     C           SCHIND    IFEQ 'S'                                       143087
     C           @CHAMT    ANDGE@SCEQ                                     143087
     C           SSAMT     ANDNE*BLANKS                                   143087
     C                     SETON                     3150                 143087
     C                     MOVE 'USR0208' @MSGID                          143087
     C                     EXSR SNDMSG                                    143087
     C                     ENDIF                                          143087
      *                                                                   143087
     C                     END
     C                     END                                            CRT002
      *
     C                     END                             E001
      *
     C           CHARG9    TAG                                            CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            CALBUY - Calculate buy amount equivalent of        *
      *                     sell amount                               *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           CALBUY    BEGSR                           ** CALBUY **
      *
      ** Calculate charge if in sell currency, and add for conversion
     C           SCHIND    IFEQ 'S'
     C           SCPER     IFNE *BLANKS
     C           @SCEQ     MULT @CHPER    @WRK   190
     C********** @WRK      DIV  10000     @CHAMT 150                      143087
     C           @WRK      DIV  10000     @CHAMT 150H                     143087
     C                     END
     C           @SCEQ     ADD  @CHAMT    @TCAM
     C                     ELSE
     C                     Z-ADD@SCEQ     @TCAM
     C                     END
      *
      ** Save sell currency equivalent
     C                     MOVE @TCAM     @EQAMS
      *
      ** Convert to buy amount
     C                     MOVE SSCCY     @TCCY
     C                     Z-ADD@SDEC     @TCDP
     C                     MOVE @SMD      @TCMD
     C                     MOVE SBCCY     @EQCY
     C                     Z-ADD@TDEC     @EQDP
     C                     MOVE @TMD      @EQMD
      *
     C           CEU024    IFEQ 'Y'                                       CEU024
     C********** CRT104    IFEQ 'N'                                CEU024 151260
     C           WEXDF     IFEQ 'Y'                                       151260
     C                     MOVELWSIND     @TCMD                           CEU024
     C                     MOVELWBIND     @EQMD                           CEU024
     C**********           ELSE                                    CEU024 151340
     C**********           SELEC                                   CEU024 151340
     C********** SSCCY     WHEQ @BSCY                              CEU024 151340
     C**********           Z-ADD@EXRT     @EXRT                    CEU024 151340
     C**********           OTHER                                   CEU024 151340
     C********** 1         DIV  @EXRT     @EXRT                    CEU024 151340
     C**********           ENDSL                                   CEU024 151340
     C                     ENDIF                                          CEU024
     C                     MOVELBKEURO    @EUCY                           CEU024
     C                     MOVE WEXDF     @INEU                           151260
     C                     EXSR RTCOEU                                    CEU024
     C                     ELSE                                           CEU024
     C                     EXSR RTCONV
     C                     ENDIF                                          CEU024
      *
      ** Check charge less than buy amount if against buy ccy
     C           SCHIND    IFEQ 'B'
     C********** @CHAMT    ANDGT@EQAM                                     143087
     C           @CHAMT    ANDGE@EQAM                                     143087
     C                     SETON                     3150
     C                     MOVE 'USR0207' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** If no error
     C           *IN31     IFEQ '0'
     C                     Z-ADD@EQAM     @TAMT
      *
      ** If charge in buy currency add to buy amount
     C           SCHIND    IFEQ 'B'
     C           SCPER     IFNE *BLANKS
     C           @EQAM     MULT @CHPER    @WRK
     C********** @WRK      DIV  10000     @CHAMT                          143087
     C           @WRK      DIV  10000     @CHAMT    H                     143087
     C                     END
     C                     ADD  @CHAMT    @TAMT
     C                     END
      *
      ** Edit the buy amount field - insert dec.pt for screen display
     C                     EXSR FMTBUY
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            ROUND  - Round buy/sell amount to smallest         *
      *                     denomination in currency                  *
      *                   - any excess is added to charge amount      *
      *                     and buy/sell adjusted accordingly         *
      *                                                               *
      * CALLS      FMTBUY - Format buy amount for display             *
      *            FMTCHG - Format charge amount for display          *
      *            FMTSEL - Format sell amount for display            *
      *            FMTSEQ - Format sell currency equivalent           *
      *            RTCONV - Currency conversion                       *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ROUND     BEGSR                           ** ROUND  **
      *
      ** Save screen fields incase F12 taken
     C                     MOVE @SAR      @CHGSV 25
     C                     MOVE SBAMT     @BAMSV 14
     C                     MOVE SSAMT     @SAMSV 14
      *
      ** If Sell amount entered round buy amount
     C           *IN34     IFEQ '1'                        B001
     C           @TAMT     DIV  @TSML     @@WORK
     C                     MVR            @XCESS
     C           @TSML     SUB  @XCESS    @ROUND  50
      ** If Buy amount entered round sell amount
     C                     ELSE                            X001
     C           @SCEQ     DIV  @SSML     @@WORK
     C                     MVR            @XCESS
     C           @SSML     SUB  @XCESS    @ROUND
     C                     END                             E001
      *
      *
      ** If remainder exists rounding is to be performed
     C           @XCESS    IFNE *ZERO                      B001
      *
      *
      *
      ** If no charge entered set up charge fields & then process
      ** as if charge was entered
     C           SCHIND    IFEQ ' '                        B002
      *
      **  Charge indicator
     C           SBCCY     IFEQ @BSCY                      B003
     C           SBCCY     ORNE @BSCY                                     099360
     C           SSCCY     ANDNE@BSCY                                     099360
     C           *IN34     ANDEQ'1'                                       099360
     C                     MOVE 'B'       SCHIND
     C                     ELSE                            X003
     C                     MOVE 'S'       SCHIND
     C                     Z-ADD@EQAM     @EQAMS
     C                     END                             E003
      *
      **  Transaction type - error if no default
     C           FSFJIC    IFNE *BLANKS                    B003
     C                     MOVE FSFJIC    SCTRTY
     C/COPY WNCPYSRC,REH00286
     C                     MOVE @ASGSV    @CASGL
     C                     ELSE                            X003
     C                     SETON                     1850
     C                     MOVE 'USR0085' @MSGID
     C                     EXSR SNDMSG
     C                     END                             E003
      *
     C                     END                             E002
      *
      *
      ** Charge in Buy currency?
     C           SCHIND    IFEQ 'B'                        B002
      *
      ** If Sell amount entered round buy amount up
     C           *IN34     IFEQ '1'                        B003
     C                     ADD  @ROUND    @TAMT
     C                     ADD  @ROUND    @CHAMT
      *
     C                     ELSE                            X003
      ** Buy amount entered, round sell amount down
     C                     SUB  @XCESS    @SCEQ
      ** Convert to charge currency
     C                     MOVE SSCCY     @TCCY
     C                     Z-ADD@SCEQ     @TCAM
     C                     Z-ADD@SDEC     @TCDP
     C                     MOVE @SMD      @TCMD
     C                     MOVE SBCCY     @EQCY
     C                     Z-ADD@TDEC     @EQDP
     C                     MOVE @TMD      @EQMD
      *                                                                   143087
      * Use inverse rate if via Euro or neither ccy is base               143087
     C                     Z-ADD@EXRT     @@EXRT                          143087
     C           CEU024    IFEQ 'Y'                                       143087
     C           WEXDF     ANDEQ'Y'                                       143087
     C           SBCCY     ORNE @BSCY                                     143087
     C           SSCCY     ANDNE@BSCY                                     143087
     C                     Z-ADD@OXRT     @EXRT                           143087
     C                     ENDIF                                          143087
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C********** CRT104    IFEQ 'N'                                CEU024 151260
     C           WEXDF     IFEQ 'Y'                                       151260
      *                                                                   151340
      **Rate*must*be*other*way*round*if*via*Euro                   151340 143087
     C**********           Z-ADD@EXRT     @@EXRT                   151340 143087
     C**********           Z-ADD@OXRT     @EXRT                    151340 143087
     C                     MOVELWSIND     @TCMD                           CEU024
     C                     MOVELWBIND     @EQMD                           CEU024
     C                     ENDIF                                          CEU024
     C                     MOVELBKEURO    @EUCY                           CEU024
     C                     MOVE WEXDF     @INEU                           151260
     C                     EXSR RTCOEU                                    CEU024
     C********** WEXDF     IFEQ 'Y'                                151340 143087
     C**********           Z-ADD@@EXRT    @EXRT                    151340 143087
     C**********           ENDIF                                   151340 143087
      *                                                                   151340
     C                     ELSE                                           CEU024
     C                     EXSR RTCONV
     C                     ENDIF                                          CEU024
      *                                                                   143087
     C                     Z-ADD@@EXRT    @EXRT                           143087
     C           @TAMT     SUB  @EQAM     @CHAMT
     C                     END                             E003
      *
     C                     ELSE                            X002
      ** Charge in sell currency
      *
      ** If Sell amount entered round buy amount up
     C           *IN34     IFEQ '1'                        B003
     C                     ADD  @ROUND    @TAMT
      ** Convert to charge currency
     C                     MOVE SBCCY     @TCCY
     C                     Z-ADD@TAMT     @TCAM
     C                     Z-ADD@TDEC     @TCDP
     C                     MOVE @TMD      @TCMD
     C                     MOVE SSCCY     @EQCY
     C                     Z-ADD@SDEC     @EQDP
     C                     MOVE @SMD      @EQMD
      *                                                                   143087
      * Use inverse rate if via Euro or neither ccy is base               143087
     C                     Z-ADD@EXRT     @@EXRT                          143087
     C           CEU024    IFEQ 'Y'                                       143087
     C           WEXDF     ANDEQ'Y'                                       143087
     C           SBCCY     ORNE @BSCY                                     143087
     C           SSCCY     ANDNE@BSCY                                     143087
     C                     Z-ADD@OXRT     @EXRT                           143087
     C                     ENDIF                                          143087
      *                                                                   CEU024
     C           CEU024    IFEQ 'Y'                                       CEU024
     C********** CRT104    IFEQ 'N'                                CEU024 151260
     C           WEXDF     IFEQ 'Y'                                       151260
      *                                                                   151340
      **Rate*must*be*other*way*round*if*via*Euro                   151340 143087
     C**********           Z-ADD@EXRT     @@EXRT                   151340 143087
     C**********           Z-ADD@OXRT     @EXRT                    151340 143087
     C                     MOVELWBIND     @TCMD                           CEU024
     C                     MOVELWSIND     @EQMD                           CEU024
     C                     ENDIF                                          CEU024
     C                     MOVELBKEURO    @EUCY                           CEU024
     C                     MOVE WEXDF     @INEU                           151260
     C                     EXSR RTCOEU                                    CEU024
     C********** WEXDF     IFEQ 'Y'                                151340 143087
     C**********           Z-ADD@@EXRT    @EXRT                    151340 143087
     C**********           ENDIF                                   151340 143087
      *                                                                   151340
     C                     ELSE                                           CEU024
     C                     EXSR RTCONV
     C                     ENDIF                                          CEU024
      *                                                                   143087
     C                     Z-ADD@@EXRT    @EXRT                           143087
     C                     Z-ADD@EQAM     @EQAMS
     C           @EQAM     SUB  @SCEQ     @CHAMT
      *
     C                     ELSE                            X003
      ** Buy amount entered, round sell amount down
     C                     ADD  @XCESS    @CHAMT
     C                     SUB  @XCESS    @SCEQ
     C                     SUB  @XCESS    @EQAM
     C                     END                             E003
      *
      *
     C                     END                             E002
      *                                                                   143087
      * Check charge amount not greater than transaction amount           143087
     C           SCHIND    IFEQ 'B'                                       143087
     C           @CHAMT    IFGE @TAMT                                     143087
     C                     SETON                     3150                 143087
     C                     MOVE 'USR0207' @MSGID                          143087
     C                     EXSR SNDMSG                                    143087
     C                     ENDIF                                          143087
     C                     ELSE                                           143087
     C           @CHAMT    IFGE @SCEQ                                     143087
     C                     SETON                     3150                 143087
     C                     MOVE 'USR0208' @MSGID                          143087
     C                     EXSR SNDMSG                                    143087
     C                     ENDIF                                          143087
     C                     ENDIF                                          143087
      *
      ** Reset fields and format amounts for display
     C                     MOVE *BLANKS   SCPER
     C                     EXSR FMTCHG
     C                     EXSR FMTBUY
     C                     EXSR FMTSEL
     C                     EXSR FMTSEQ
      *
     C                     END                             E001
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            NUMCHK - Check if amount passed is numeric.        *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY  VALDET - Validate details                          *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           NUMCHK    BEGSR                           ** NUMCHK **   CRT002
      *                                                                   CRT002
     C                     Z-ADD0         @AMT                            CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C                     MOVE WAMT      ZFIELD                          CRT002
     C                     Z-ADD@DEC      ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    WAMT                            CRT002
      *                                                                   CRT002
     C           WAMT      IFEQ *BLANKS                                   CRT002
     C                     SETON                       50                 CRT002
     C                     MOVE 'USR0008' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      ** Set up decimal values                                            CRT002
      *                                                                   CRT002
     C                     Z-ADD@DEC      ZADEC                           CRT002
     C           13        SUB  @DEC      ZADIG                           CRT002
      *                                                                   CRT002
      ** Align amount - and move it to numeric field                      CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANK    ZFIELD                          CRT002
     C                     MOVE WAMT      ZFIELD                          CRT002
     C                     EXSR ZALIGN                                    CRT002
     C                     MOVE ZFIELD    @AMT   150                      CRT002
      *                                                                   CRT002
      ** If error found?  Set up error message                            CRT002
      *                                                                   CRT002
     C           *IN99     IFEQ '1'                                       CRT002
     C                     SETON                       50                 CRT002
     C                     MOVE 'USR0008' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************   CRT002
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALOVR - Validate override conditions              *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALOVR    BEGSR                           ** VALOVR **
      *
      ** Setof error indicator
     C                     SETOF                     51
      *
      ** Set array index to 1
     C                     Z-ADD1         @I      20
      *
     C           @I        DOUGT25
     C           *IN51     OREQ '1'
      *
     C           @O,@I     IFEQ 'Y'
     C           @R,@I     ANDEQ'N'
     C                     SETON                     51
      *
     C                     ELSE
      *
     C                     ADD  1         @I
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            TRNOVR - Transaction override process              *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            SCC0250- Clear Message Queue                       *
      *            VOVDET - Validate override details                 *
      *            LAST   - Final processing - terminate pgm.         *
      *            SETDSP - Set indicators for display                *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           TRNOVR    BEGSR                           ** TRNOVR **
      *
      ** Set indicator to condition display of warning messages if any
     C           @WI       IFGT 0
     C                     SETON                     23
     C                     ELSE
     C                     SETOF                     23
     C                     END
     C/COPY WNCPYSRC,REH00287
     C*
     C** Refresh screen fields
     C*
     C                     MOVE *BLANKS   SOTLI
     C                     MOVE *BLANKS   SOTPC
     C                     MOVE *BLANKS   SOVUR                                               CRT026
     C                     MOVE *BLANKS   SOVPW                                               CRT026
      *
      ** Do until successful override
     C           *IN51     DOUEQ'0'
      *
      ** Display message subfile control record
     C                     WRITERE4120C0
      *
      ** Sell ccy to be displayed next to sell ccy equivalent at top
      ** confirmation screen to keep client happy
     C                     MOVE SSCCY     @SSCCY
      *
      ** Display override screen format
     C                     SELEC                                                            MD042577
     C           PFNCD     WHEQ '0JS'                                                       MD042577
     C                     EXFMTF40JS                                                       MD042577
     C           PFNCD     WHEQ '0JX'                                                       MD042577
     C                     EXFMTF40JX                                                       MD042577
     C                     OTHER                                                            MD042577
     C                     EXFMTRE4120F4
     C                     ENDSL                                                            MD042577
      *
      ** Clear program message queue and terminal & warning msg. lines
     C                     CALL 'SCC0250'
      *
      ** Process the input depending on the key pressed
      *
      ** If Help key is pressed, perform help processing
      *
      ** If cmd/3 is pressed - terminate the program
     C           *INKC     CASEQ'1'       LAST
      *
      ** If cmd/1 is pressed - validate override details
     C           *INKA     CASEQ'1'       VOVDET
      *
      ** If cmd/12 or enter key is pressed - Set indicators for dsplay
     C                     CAS            SETDSP
      *
     C                     END
      *
     C                     END
      *
     C/COPY WNCPYSRC,REH00288
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VOVDET - Validate override details                 *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            VALOVR - Validate override conditions              *
      *            RTENCP - Encript passcode                          *
      *                                                               *
      * CALLED BY  TRNOVR - Transaction override process              *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VOVDET    BEGSR                           ** VOVDET **
      *
      ** Validation is to be done only if override prompt is displayed
      ** Otherwise - setof 51 to come out of loop
     C           *IN21     IFEQ '0'
     C           *IN54     ANDEQ'0'                                                           CRT026
     C                     SETOF                     51
      *
     C                     ELSE
      *
      ** Setof error indicators
     C                     SETOF                     111252
      *
      ** Override teller if blanks
      ** If CRT026 is switch ON User Id is required                                           CRT026
     C           SOTLI     IFEQ *BLANKS
     C           SOVUR     ANDEQ*BLANKS                                                       CRT026
     C                     SETON                     1152
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1500' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0032' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Access user id details to obtain the teller id attached                              CRT026
      ** to the user id                                                                       CRT026
      *                                                                                       CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'AOUSERR0'                                                    CRT026
     C                     PARM *BLANKS   @RTCD   7                                           CRT026
     C                     PARM '*KEY'    @OPTN   7                                           CRT026
     C                     PARM SOVUR     @USRP  10                                           CRT026
     C           MUSER     PARM MUSER     DSSDY                                               CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C           @RTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'MUSERDD' DBFILE           ***************                    CRT026
     C                     Z-ADD10        DBASE            ** DB ERR 10 **                    CRT026
     C                     MOVELSOVUR     DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C                     MOVE *ON       *IN52                                               CRT026
     C                     MOVEL'USR1501' @MSGID                                              CRT026
     C                     EXSR SNDMSG                                                        CRT026
      ** If user id is valid use the teller attached to this user                             CRT026
      ** to obtain the teller details                                                         CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE TLID      @TLID                                               CRT026
     C                     ENDIF                                                              CRT026
      ** If CRT026 enhancement is switch OFF use the teller id                                CRT026
      ** entered to obtain the teller details                                                 CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE SOTLI     @TLID                                               CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
      ** If no validation errors exist                                                        CRT026
      *                                                                                       CRT026
      ** Access teller id details                                                             CRT026
      *                                                                                       CRT026
     C           *IN52     IFEQ *OFF                                                          CRT026
     C                     CALL 'AOTELDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C**********           PARM           SOTLI                                               CRT026
     C                     PARM           @TLID   3                                           CRT026
     C           SDTELD    PARM SDTELD    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C                     SETON                     1152
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVEL'USR1509' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVEL'USR0030' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     END
     C                     ENDIF                                                              CRT026
      *
     C                     END
      *                                                                                       CRT026
      ** If no validation errors exist                                                        CRT026
      *                                                                                       CRT026
     C           *IN52     IFEQ *OFF                                                          CRT026
      *
      ** Check if passcode is blanks
      ** message - Teller passcode is required
      ** If CRT026 enhancement is ON check the password instead                               CRT026
      ** message - User password is required                                                  CRT026
     C           SOTPC     IFEQ *BLANKS
     C           SOVPW     ANDEQ*BLANKS                                                       CRT026
     C                     SETON                     1252
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVEL'USR1502' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVEL'USR0033' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *                                                                                       CRT026
      ** If CRT026 enhancement is ON check the password via REC4170                           CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'REC4170'                                                     CRT026
     C                     PARM           SOVUR                                               CRT026
     C                     PARM           SOVPW                                               CRT026
     C                     PARM *BLANKS   @RTCD   7                                           CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     SELEC                                                              CRT026
     C           @RTCD     WHEQ 'CPF2204'                                                     CRT026
     C                     MOVE 'USR1501' @MSGID                                              CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C           @RTCD     WHEQ 'CPF22E3'                                                     CRT026
     C                     MOVE 'USR1506' @MSGID                                              CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C           @RTCD     WHEQ 'CPF2203'                                                     CRT026
     C                     MOVE 'USR1507' @MSGID                                              CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C           @RTCD     WHEQ 'CPF2213'                                                     CRT026
     C                     MOVE 'USR1508' @MSGID                                              CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C           @RTCD     WHEQ 'CPF22E5'                                                     CRT026
     C                     MOVE 'USR1505' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E2'                                                     CRT026
     C                     MOVE 'USR1503' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E4'                                                     CRT026
     C                     MOVE 'USR1504' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E6'                                                     CRT026
     C                     MOVE 'USR1510' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E9'                                                     CRT026
     C                     MOVE 'USR1511' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF2225'                                                     CRT026
     C                     MOVE 'USR1512' @MSGID                                              CRT026
     C                     ENDSL                                                              CRT026
     C                     MOVE *ON       *IN12                                               CRT026
     C                     MOVE *ON       *IN52                                               CRT026
     C                     EXSR SNDMSG                                                        CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C                     ELSE                                                               CRT026
      *
      ** Check if passcode matches with that in file
      ** message - Teller passcode
      *
      ** Encript the passcode
     C                     MOVEASOTPC     BPWD
     C                     Z-ADD6         X       10
     C                     EXSR RTENCP
     C                     MOVEAEPWD      SOTPC
      *
     C           SOTPC     IFNE FRTLPC
     C                     SETON                     1252
     C                     MOVEL'USR0039' @MSGID
     C                     EXSR SNDMSG
     C                     END
     C                     ENDIF                                                              CRT026
      *
     C                     END
     C                     ENDIF                                                              CRT026
      *
      ** If no errors in validation
     C           *IN52     IFEQ '0'
      *
      ** move override indicators from telidpd to override ind.array
     C                     MOVEAFROVRI    @R
      *
      ** Perform override validation
     C                     EXSR VALOVR
      *
      ** If override unsuccessful -
      ** message - teller override failed
     C           *IN51     IFEQ '1'
     C                     MOVEL'USR0029' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************   CRT002
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *           DSPWND  - Display Window Details                    *   CRT002
      *                                                               *   CRT002
      * CALLS     WN0010  - Window Manager Program                    *   CRT002
      *                                                               *   CRT002
      * CALLED BY VOVDET  - Validate Override Details                 *   CRT002
      *           VALDET  - Validate Details                          *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           DSPWND    BEGSR                           ** DSPWND **   CRT002
      *                                                                   CRT002
      **  Set-up the data to be passed                                    CRT002
      *                                                                   CRT002
     C                     CLEARDATA                                      CRT002
     C                     MOVELPMODE     WMODE                           CRT002
     C                     MOVELSSCCY     WSCCY                           CRT002
     C                     MOVELSSAMT     WSAMT                           CRT002
     C                     MOVELPTLBC     WTLBC                           CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     CLEAR@RANR2                                    CRT002
     C                     CLEAR@RANR3                                    CRT002
     C                     MOVELRANRL2    @RANR2                          CRT002
     C                     MOVELRANRL3    @RANR3                          CRT002
     C                     MOVEL@SBNM     WBYNM                           CRT002
     C                     MOVEL@SCSN     WTCSN                           CRT002
     C                     MOVEL@SBIN     WBYID                           CRT002
     C                     MOVEL@SCIN     WISSU                           CRT002
     C                     MOVEL@SBIT     WIDTP                           CRT002
     C                     MOVEL*BLANKS   WTCNO                           CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     CALL 'WN0010'                                  CRT002
     C                     PARM @PGM      PGM    10                       CRT002
     C                     PARM *BLANK    FKEY    2                       CRT002
     C                     PARM 'I'       ACODE   1                       CRT002
     C                     PARM DATA      DATA                            CRT002
     C                     PARM *BLANKS   W0RTN   7                       CRT002
     C                     PARM *BLANKS   SPARE 256                       CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     CALL 'RE4120W0'                                CRT002
     C                     PARM 'I'       ACODE   1                       CRT002
     C                     PARM DATA      DATA                            CRT002
     C                     PARM *BLANKS   W0RTN   7                       CRT002
     C                     PARM *ZERO     WLEN    30                      CRT002
     C                     PARM *ZERO     WWID    30                      CRT002
     C                     PARM 1         WSROW   30                      CRT002
     C                     PARM 1         WSCOL   30                      CRT002
     C                     PARM WCHQNM    WCHQNM                          184553
     C                     PARM           WTITLE  7                       222373
     C                     PARM *BLANKS   SPARE 256                       CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
      **  Check window return code                                        CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           W0RTN     WHEQ 'Y2U9999'                                 CRT002
      *                                                                   CRT002
      **  F3 is requested, seton *INKC to go out and seton *IN20 to       CRT002
      **  prevent file update.                                            CRT002
     C                     MOVE '1'       *INKC                           CRT002
     C                     MOVE '1'       *IN20                           CRT002
      *                                                                   CRT002
     C           W0RTN     WHEQ 'USR0563'                                 CRT002
      *                                                                   CRT002
      **  WN Window error                                                 CRT002
      *                                                                   CRT002
     C                     MOVEL'USR0563' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     MOVE '1'       *INKL                           CRT002
     C                     EXSR SETDSP                                    CRT002
      *                                                                   CRT002
     C           W0RTN     WHEQ 'Y2U0004'                                 CRT002
     C           PMODE     ANDEQ'I'                                       CRT002
      *                                                                   CRT002
      **  WN Database error                                               CRT002
      *                                                                   CRT002
     C                     MOVEL'USR0567' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     MOVE '1'       *INKL                           CRT002
     C                     EXSR SETDSP                                    CRT002
      *                                                                   CRT002
     C           W0RTN     WHEQ 'USR0790'                                 CRT002
      *                                                                   CRT002
      **  F12 is requested                                                CRT002
      *                                                                   CRT002
     C                     MOVE '1'       *INKL                           CRT002
     C                     EXSR SETDSP                                    CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           WEMSG     ANDNE*BLANKS                                   CRT002
      *                                                                   CRT002
      **  If Database error                                               CRT002
      *                                                                   CRT002
     C           W0RTN     IFEQ 'Y2U0004'                                 CRT002
      *                                                                   CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     MOVELWEMSG     DBLOT                           CRT002
     C                     OUT  LDA                                       CRT002
     C                     EXSR *PSSR                                     CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
     C                     MOVE '1'       *IN69                           CRT002
     C                     MOVELWEMSG     WUMSID                          CRT002
     C                     END                                            CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            SETDSP - Set indicators for display                *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  TRNOVR - Transaction override process              *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           SETDSP    BEGSR                           ** SETDSP **
      *
      ** If cmd/12 is pressed - display prev.screen
     C           *INKL     IFEQ '1'
      *
      ** Setof indicator to come out override screen loop
     C                     SETOF                     51
      *
      ** Setof common screen error indicators
     C                     SETOF                     1112
      *
      ** Seton indicator to loop to display previous screen
     C                     SETON                     50
      *
      ** Reset screen fields and charge work field
     C                     MOVE @CHGSV    @SAR
     C                     MOVE @BAMSV    SBAMT
     C                     MOVE @SAMSV    SSAMT
     C                     Z-ADD0         @CHAMT
      *
      ** If buy amount entered reset sell amount else reset buy amount
     C           *IN34     IFEQ '0'
     C                     MOVE *BLANKS   SSAMT
     C                     ELSE
     C                     MOVE *BLANKS   SBAMT
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPDRTN - Control rtn. for updates                  *
      *                                                               *
      * CALLS      WRTLPD - Write Teller transactions details         *
      *            UPTRL  - Update Control Trailer Record             *
      *            ZTNLU1 - Get Next Available Tran.Number            *
      *            PCMTXT - Prepare comit text                        *
      *            RTTOTS - Teller total updates                      *
      *            SNDMSG - Send program message parameters           *
      *            DBERR  - Database Error Handling                   *
      *            FORMAT - Format amounts for printing               *
      *                                                               *
      * CALLED BY  SCRINP - Detail screen input                       *
      *                                                               *
      *****************************************************************
     C           UPDRTN    BEGSR                           ** UPDRTN **
     C/COPY WNCPYSRC,RE4120C017
      *
      ** Update next available transaction number
     C                     EXSR ZTNLU1
      *
     C/COPY WNCPYSRC,RE4120C007
      ** Prepare commmitment control text
     C                     EXSR PCMTXT
      *
      ** Move fields to key list.
     C                     MOVEL'T'       KTBRI
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     MOVELPTLID     KTBID
     C                     ELSE                                           CRT002
     C                     MOVEL@TLID     KTBID                           CRT002
     C                     ENDIF                                          CRT002
     C                     MOVEL'1'       KRCTP
      *
      ** Access teller controls - TTRNTM2 - to get transaction number
     C           KLTRNT    CHAINTTRNTM2F             70
     C/COPY WNCPYSRC,RE4120C018
      *
      ** Write Teller transaction details file
     C                     EXSR WRTLPD
      *
     C/COPY WNCPYSRC,RE4120C026
      *
      ** Write Teller charge details file
     C           SCHIND    IFNE ' '
     C           PMODE     ANDEQ'I'                                       CRT002
     C           PMODE     OREQ 'P'                                       CRT002
     C           @CHAMT    ANDNE*ZERO                                     123715
     C           PMODE     ANDNE'I'                                       123715
     C                     EXSR WRCHPD
     C                     END
      *
      ** Edit amounts for printing
     C                     EXSR FORMAT
      *
      ** Update trailer
     C                     EXSR UPTRL
      *
      ** Access teller controls - TTRNTM2 -
     C                     MOVEL'1'       KRCTP
     C           KLTRNT    CHAINTTRNTM2F             70
      *
      ** If record not found - database error
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD6         DBASE            ** DB ERR 06 **
     C                     MOVE 'TTRNTM2' DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
      *
     C                     ELSE
      *
      ** Increment next available transaction number
     C                     ADD  1         TTNATN
      *
      ** Use buyer ccy to look up currencies array
     C                     Z-ADD1         @I      20
     C           SBCCY     LOKUP@CY,@I                   82
      *
      ** If element not found
     C           *IN82     IFEQ '0'
      *
      ** Check if an empty element is present in array
     C           '   '     LOKUP@CY,@I                   82
      *
      ** If empty element is present
     C           *IN82     IFEQ '1'
     C                     MOVEASBCCY     @CY,@I
     C                     END
      *
     C                     END
      *
      ** Use seller ccy to look up currencies array                       152325
     C                     Z-ADD1         @I      20                      152325
     C           SSCCY     LOKUP@CY,@I                   82               152325
      *                                                                   152325
      ** If element not found                                             152325
     C           *IN82     IFEQ '0'                                       152325
      *                                                                   152325
      ** Check if an empty element is present in array                    152325
     C           '   '     LOKUP@CY,@I                   82               152325
      *                                                                   152325
      ** If empty element is present                                      152325
     C           *IN82     IFEQ '1'                                       152325
     C                     MOVEASSCCY     @CY,@I                          152325
     C                     END                                            152325
      *                                                                   152325
     C                     END                                            152325
      ** Update the record
     C                     UPDATTTRNTM2F
      *
     C                     END
      *
      ** Access teller controls - TTRNTM3 -
     C                     MOVEL'2'       KRCTP
     C           KLTRNT    CHAINTTRNTM3F             70
      *
      ** If record not found - database error
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD7         DBASE            ** DB ERR 07 **
     C                     MOVE 'TTRNTM3' DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
      *
     C                     ELSE
      *
      ** Obtain currency totals for buy-trans-type
     C                     MOVEL@BRVIN    @RVIN
     C                     MOVEL@BDCIN    @DCIN
     C                     MOVEL@BCSIN    @CSIN
     C                     MOVEL@BCLIN    @CLIN
     C                     MOVELSBCCY     @CCY
     C                     EXSR RTTOTS
      *
      ** Obtain currency totals for sell-trans-type
     C                     MOVEL@SRVIN    @RVIN
     C                     MOVEL@SDCIN    @DCIN
     C                     MOVEL@SCSIN    @CSIN
     C                     MOVEL@SCLIN    @CLIN
     C                     MOVELSSCCY     @CCY
     C                     Z-ADD@SCEQ     @TAMT
     C                     EXSR RTTOTS
      *
      ** Move teller transaction number to file & screen field
     C                     Z-ADDTBTN      TNLU
     C                     Z-ADDTBTN      TTLU                                                CRT006
     C                     Z-ADDTBTN      @TTRNO
      *
      ** Update the record
     C                     UPDATTTRNTM3F
      *
     C                     END
      *                                                                   CRT002
     C/COPY WNCPYSRC,RE4120C006
      *                                                                                       CCG016
     C                     MOVEL'N'       ##COPD                                              CCG016
     C           CCG016    IFEQ 'Y'                                                           CCG016
     C                     EXSR SNDUDC                                                        CCG016
     C                     END                                                                CCG016
     C           ##COPD    IFEQ 'N'                                                           CCG016
      *                                                                                       CCG016
     C           PMODE     IFEQ 'I'                                       CRT002
      *
      ** Print the transaction
     C                     OPEN RE4120P1
     C***                  WRITEDETAIL
      *
      *
     C*
     C/COPY WNCPYSRC,RE4120CCP3
     C*
     C                     WRITEHEADER
     C/COPY WNCPYSRC,RE4120C002
      *
      ** Charge entered as amount or %?
     C           SCPER     IFNE *BLANKS
     C                     SETON                     32
     C                     ELSE
     C                     SETOF                     32
     C                     END
      *
      ** No commission?
     C           SCHIND    IFEQ ' '                        B001
     C                     WRITENOCOM
     C                     ELSE                            X001
      ** Buy commission?
     C           SCHIND    IFEQ 'B'                        B002
     C                     WRITEBUYCOM
     C                     ELSE                            X002
      ** Sell commission
     C                     WRITESELCOM
     C                     END                             E002
      *
     C                     END                             E001
     C/COPY WNCPYSRC,RE4120C019
      *
     C                     CLOSERE4120P1
      *                                                                                       CCG016
     C                     ENDIF                                                              CCG016
      *                                                                                       CCG016
     C/COPY WNCPYSRC,RE4120C021
      *
      ** End of commitment cycle
     C           CMTTXT    COMIT
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                                       CCG016
     C           PMODE     IFEQ 'I'                                                           CCG016
     C           ##COPD    ANDEQ'Y'                                                           CCG016
     C           CMTTXT    COMIT                                                              CCG016
     C                     ENDIF                                                              CCG016
      *
     C                     ENDSR
      *****************************************************************
      *****************************************************************                       CCG016
      /EJECT                                                                                  CCG016
      *****************************************************************                       CCG016
      *                                                               *                       CCG016
      *            SNDUDC - Send advice to UDC                        *                       CCG016
      *                                                               *                       CCG016
      * CALLS      external pgm                                       *                       CCG016
      *                                                               *                       CCG016
      * CALLED BY  same as PRTTRN                                     *                       CCG016
      *                                                               *                       CCG016
      * FLDS USED         -                                           *                       CCG016
      *                                                               *                       CCG016
      *****************************************************************                       CCG016
     C           SNDUDC    BEGSR                                                              CCG016
      *                                                                                       CCG016
     C                     MOVELITLB      I#BRCT    P                                         CCG016
     C                     MOVELPTLID     I#TLID    P                                         CCG016
     C                     MOVELTBID      I#TBID    P                                         CCG016
     C                     MOVELTBTN      I#TBTN    P                                         CCG016
     C                     MOVELPFNCD     I#FUNC    P                                         CCG016
     C                     MOVEL'N'       I#CLOS    P                                         CCG016
     C                     MOVEL*BLANKS   I#CHQN    P                                         CCG016
     C                     MOVEL*ZEROS    I#CNUM                                              CCG016
     C                     MOVEL*BLANKS   I#CCY                                               CCG016
     C                     MOVEL*ZEROS    I#ACOD                                              CCG016
     C                     MOVEL*ZEROS    I#ACSQ                                              CCG016
     C                     MOVEL*ZEROS    I#BRCA                                              CCG016
     C                     MOVEL*ZEROS    I#ACNO                                              CCG016
     C                     MOVEL*ZEROS    I#CNU1                                              CCG016
     C                     MOVEL*BLANKS   I#CCY1                                              CCG016
     C                     MOVEL*ZEROS    I#ACO1                                              CCG016
     C                     MOVEL*ZEROS    I#ACS1                                              CCG016
     C                     MOVEL*BLANKS   I#BRC1                                              CCG016
     C                     MOVEL*ZEROS    I#ACN1                                              CCG016
     C                     MOVEL*ZEROS    I#CNU2                                              CCG016
     C                     MOVEL*BLANKS   I#CCY2                                              CCG016
     C                     MOVEL*ZEROS    I#ACO2                                              CCG016
     C                     MOVEL*ZEROS    I#ACS2                                              CCG016
     C                     MOVEL*BLANKS   I#BRC2                                              CCG016
     C                     MOVEL*ZEROS    I#ACN2                                              CCG016
     C                     Z-ADD0         I#AMNT                                              CCG016
     C                     MOVEL*BLANKS   I#CCYT                                              CCG016
     C                     MOVELSNARR     I#NARR    P                                         CCG016
     C                     Z-ADD0         I#CHQA                                              CCG016
     C                     Z-ADD@UEXRT    I#EXRT                                              CCG016
     C                     Z-ADD@BUYA     I#BUYA                                              CCG016
     C                     MOVELSBCCY     I#BUYC                                              CCG016
     C           SCHIND    IFEQ ' '                                                           AWFIX9
     C           SCHIND    OREQ 'S'                                                           AWFIX9
     C           SCHIND    OREQ 'B'                                                           AWFIX9
     C           @EQAMS    ANDEQ0                                                             AWFIX9
     C                     Z-ADD@SCEQ     I#SELA                                              CCG016
     C                     ELSE                                                               AWFIX9
     C                     Z-ADD@EQAMS    I#SELA                                              AWFIX9
     C                     END                                                                AWFIX9
     C                     MOVELSSCCY     I#SELC                                              CCG016
     C                     MOVEL*BLANKS   I#NAR1                                              CCG016
     C                     MOVEL*BLANKS   I#NAR2                                              CCG016
     C                     Z-ADD0         I#INTA                                              CCG016
     C                     MOVEL*BLANKS   I#INTC                                              CCG016
     C                     MOVEL*BLANKS   I#INTN                                              CCG016
     C                     Z-ADD0         I#TAXA                                              CCG016
     C                     MOVEL*BLANKS   I#TAXC                                              CCG016
     C                     MOVEL*BLANKS   I#TAXN                                              CCG016
     C                     Z-ADD0         I#CHGA                                              CCG016
     C                     MOVEL*BLANKS   I#CHGC    P                                         CCG016
     C           SCHIND    IFEQ 'B'                                                           CCG016
     C                     Z-ADD@CHAMT    I#CHGA                                              CCG016
     C                     MOVELI#BUYC    I#CHGC    P                                         CCG016
     C           I#BUYA    SUB  I#CHGA    I#AMNT                                              157826
     C                     MOVELI#BUYC    I#CCYT    P                                         157826
     C                     END                                                                CCG016
     C           SCHIND    IFEQ 'S'                                                           CCG016
     C                     Z-ADD@CHAMT    I#CHGA                                              CCG016
     C                     MOVELI#SELC    I#CHGC    P                                         CCG016
     C           I#SELA    SUB  I#CHGA    I#AMNT                                              157821
     C                     MOVELI#SELC    I#CCYT    P                                         157821
     C                     END                                                                CCG016
     C                     MOVELSCHIND    I#CHGN    P                                         CCG016
     C                     Z-ADD0         I#TOTA                                              CCG016
     C                     MOVEL*BLANKS   I#TOTC                                              CCG016
     C                     MOVEL*BLANKS   I#TOTN                                              CCG016
     C           SCHIND    IFEQ 'S'                                                           AWFIX9
     C                     Z-ADD@EQAMS    I#TOTA                                              AWFIX9
     C                     SUB  @CHAMT    I#TOTA                                              AWFIX9
     C                     MOVELSSCCY     I#TOTC                                              AWFIX9
     C                     ENDIF                                                              AWFIX9
      *                                                                                       CCG016
     C                     CALL 'CGC3605'                                                     CCG016
     C                     PARM '*PREPARE'ACTION  8                                           CCG016
      *                                                                                       CCG016
     C                     CALL 'CG0501'                                                      CCG016
     C                     PARM           W0RTN   7                                           CCG016
     C                     PARM 'YES'     W0CMT   3                                           CCG016
     C                     PARM *BLANKS   ##COPD  1                                           CCG016
     C                     PARM *BLANKS   ##AUTO  1                                           CCG016
     C                     PARM           I#PARM                                              CCG016
     C                     PARM           O#PARM                                              CCG016
      *                                                                                       CCG016
     C                     CALL 'CGC3604'                                                     CCG016
      *                                                                                       CCG016
     C           ##COPD    IFNE 'N'                                                           CCG016
     C                     CALL 'CGC0524'                                                     CCG016
     C                     PARM *BLANKS   W7A1    7                                           CCG016
     C                     PARM O#PARM    W50A1  50                                           CCG016
     C                     PARM *BLANKS   W10A1  10                                           CCG016
     C                     END                                                                CCG016
      *                                                                                       CCG016
     C                     Z-ADD*ZEROS    @EQAMS                                              253655
      *                                                                                       253655
     C                     ENDSR                                                              CCG016
      *****************************************************************                       CCG016
     C/COPY WNCPYSRC,RE4120C022
      /EJECT
      ** SR.RTTOTS Subroutine
      /COPY ZSRSRC,RTTOTSC1
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRTLPD - Write Teller transactions details         *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           WRTLPD    BEGSR                           ** WRTLPD **
      *                                                                   CRT002
      **  If not the first time, delete previous overrides                CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C           @CMD      IFNE *BLANKS                                   CRT002
     C                     MOVEL*BLANKS   @CMD                            CRT002
     C                     MOVEL@TXT,3    @CMD                            CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMD                            CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Perform override to PF/TTRANPD & open file                      CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   @CMD                            CRT002
     C                     MOVEL@TXT,1    @CMD                            CRT002
     C                     MOVEL'T'       @BRI                            CRT002
     C                     MOVEL@TLID     @BID                            CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMD                            CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     MOVEL'QCMDEXC' P@QRS                           CRT002
     C                     MOVEL@CMDT     P@QKY                           CRT002
     C                     EXSR DQERR                                     CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     OPEN TTRANPD                70                 CRT002
      *                                                                                       CRT006
      ** Acknowledged Flag will be processed from the transaction                             CRT006
      ** application data queue message if running in batch mode.                             CRT006
      ** Interactively, Acknowledged Flag will be set to 'Y'.                                 CRT006
     C           PMODE     IFEQ 'P'                                                           CRT006
     C                     MOVE RAACKF    ACKF                                                CRT006
     C                     ELSE                                                               CRT006
     C                     MOVE 'Y'       ACKF                                                CRT006
     C                     ENDIF                                                              CRT006
      *
     C/COPY WNCPYSRC,RE4120C001
     C                     MOVEL'D'       RECI
     C                     MOVEL'T'       TBRI
     C                     MOVELPTLID     TBID
     C                     MOVELPTLBC     ITLB                            CRT002
     C                     Z-ADDTTNATN    TBTN
     C                     MOVELPFNCD     FNCD
     C                     MOVELSBCCY     CCY1
     C                     Z-ADD@TAMT     AMT1
     C                     MOVELSSCCY     CCY2
     C                     Z-ADD@SCEQ     AMT2
     C                     Z-ADD@EXRT     EXCR
     C                     MOVELSBTRTY    TTP1
     C                     MOVELSSTRTY    TTP2
     C                     MOVELSDEPC     DEPC
     C                     MOVELSPRFC     PRFC
     C***********          MOVELPTLBC     ITLB                            CRT002
     C                     Z-ADD@RDAM     RDAM                            CRT002
     C                     MOVELWRDCY     RDCY                            CRT002
     C                     Z-ADD@PYAM     PRAM                            CRT002
     C                     MOVELWPYRC     PYRC                            CRT002
     C                     MOVEL@JOB      TWID
     C                     TIME           TIME
      *                                                                                       CRT026
      ** If CRT026 is switch on use the teller id attached to the                             CRT026
      ** user profile                                                                         CRT026
      *                                                                                       CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVELTLID      OVTI                                                CRT026
     C                     ELSE                                                               CRT026
     C                     MOVELSOTLI     OVTI
     C                     ENDIF                                                              CRT026
     C                     MOVEA@W,1      MSG1
     C                     MOVEA@W,10     MSG2
     C                     Z-ADDBJRDNB    VLDT
      *                                                                                       CRT012
      * Move Transaction Type passed in from Cashier to new field on                          CRT012
      * TTRANPD                                                                               CRT012
     C           CRT012    IFEQ 'Y'                                                           CRT012
     C                     MOVELWCSHTT    CSHTT                                               CRT012
     C                     ENDIF                                                              CRT012
     C                     WRITETTRANPDF
     C/COPY WNCPYSRC,RE4120C005
      *
     C                     CLOSETTRANPD                70                 CRT002
      *                                                                   CRT002
     C                     ENDSR
     C/COPY WNCPYSRC,REH00192
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRCHPD - Write Teller charges detail               *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           WRCHPD    BEGSR                           ** WRCHPD **
      *
     C                     MOVEL'D'       RECI
     C                     MOVEL'T'       TBRI
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     MOVELPTLID     TBID
     C                     ELSE                                           CRT002
     C                     MOVEL@TLID     TBID                            CRT002
     C                     ENDIF                                          CRT002
     C                     Z-ADDTTNATN    TBTN
      *                                                                   CRT012
      * If CRT012 is On then                                              CRT012
      * ouput each individual charge and charge code.                     CRT012
     C           CRT012    IFEQ 'Y'                                       CRT012
     C           WCHC1     ANDNE*BLANKS                                   CRT012
     C                     EXSR SRCHRG                                    CRT012
     C                     ELSE                                           CRT012
     C                     Z-ADD@CHAMT    AMT3
     C                     MOVELSCTRTY    TTP3
      *
     C                     SELEC                                          CRT002
      *                                                                   CRT002
     C           PMODE     WHEQ 'I'                                       CRT002
     C           SCHIND    IFEQ 'B'
     C                     MOVELSBCCY     CCY3
     C                     ELSE
     C                     MOVELSSCCY     CCY3
     C                     END
      *                                                                   CRT002
     C           PMODE     WHEQ 'P'                                       CRT002
     C                     MOVELWCHCCY    CCY3                            CRT002
     C                     ENDSL                                          CRT002
      *
     C                     WRITETTCHGPDF
     C                     ENDIF                                          CRT012
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPTRL  - Update Control Trailer Record             *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           UPTRL     BEGSR                           ** UPTRL  **
      *                                                                   CRT002
      **  If not the first time, delete previous overrides                CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C           @CMDT     IFNE *BLANKS                                   CRT002
     C                     MOVEL*BLANKS   @CMDT                           CRT002
     C                     MOVEL@TXT,4    @CMDT                           CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMDT                           CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Perform override to PF/TTRANPT & open file                      CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   @CMDT                           CRT002
     C                     MOVEL@TXT,2    @CMDT                           CRT002
     C                     MOVEL'T'       @BRIT                           CRT002
     C                     MOVEL@TLID     @BIDT                           CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMDT                           CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     MOVEL'QCMDEXC' P@QRS                           CRT002
     C                     MOVEL@CMDT     P@QKY                           CRT002
     C                     EXSR DQERR                                     CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     OPEN TTRANPT                70                 CRT002
      *
     C           1         CHAINTTRANPTF             70
      *
      ** If no record is present -
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        *************
     C                     Z-ADD5         DBASE            ** DB ERR 05*
     C                     MOVEL'TTRANPT' DBFILE           *************
     C                     MOVEL'1       'DBKEY
     C                     EXSR DBERR
      *
     C                     ELSE
      *
     C                     ADD  1         NORE
     C                     UPDATTTRANPTF
      *
     C                     CLOSETTRANPT                70                 CRT002
      *                                                                   CRT002
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FMTCHG - Format charge for display                 *
      *                                                               *
      * CALLED BY  ROUND  - Round amount to smallest denomination     *
      *                                                               *
      * CALLS      ZFRPED - Edit numeric field                        *
      *                                                               *
      *****************************************************************
     C           FMTCHG    BEGSR                           ** FMTCHG **
      *
     C           SCHIND    IFEQ 'B'
     C                     Z-ADD@TDEC     ZDECS
     C                     ELSE
     C                     Z-ADD@SDEC     ZDECS
     C                     END
      *
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @CHAMT    ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @CHGDS
     C                     MOVE ZOUT22    @CHGDS
     C                     MOVE @SCAMT    SCAMT
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FMTBUY - Format buy amount for display             *
      *                                                               *
      * CALLED BY  ROUND  - Round amount to smallest denomination     *
      *                                                               *
      * CALLS      ZFRPED - Edit numeric field                        *
      *                                                               *
      *****************************************************************
     C           FMTBUY    BEGSR                           ** FMTBUY **
      *
     C                     Z-ADD@TDEC     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @TAMT     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @AMTDS
     C                     MOVE *BLANKS   SBAMT
     C                     MOVE ZOUT22    @AMTDS
     C                     MOVE @SBAMT    SBAMT
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FMTSEL - Format sell amount for display            *
      *                                                               *
      * CALLED BY  ROUND  - Round amount to smallest denomination     *
      *                                                               *
      * CALLS      ZFRPED - Edit numeric field                        *
      *                                                               *
      *****************************************************************
     C           FMTSEL    BEGSR                           ** FMTSEL **
      *
     C                     Z-ADD@SDEC     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @SCEQ     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @SAMDS
     C                     MOVE *BLANKS   SSAMT
     C                     MOVE ZOUT22    @SAMDS
     C                     MOVEL@SSAMT    SSAMT
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FMTSEQ - Format sell currency equivalent           *
      *                                                               *
      * CALLED BY  ROUND  - Round amount to smallest denomination     *
      *                                                               *
      * CALLS      ZFRPED - Edit numeric field                        *
      *                                                               *
      *****************************************************************
     C           FMTSEQ    BEGSR                           ** FMTSEQ **
      *
     C                     Z-ADD@SDEC     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @SCEQ     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @AMTDS
     C                     MOVE *BLANKS   @SBAMT
     C                     MOVE ZOUT22    @AMTDS
     C                     MOVEL@SBAMT    @SCYEQ
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FORMAT - Format amounts for printing               *
      *                                                               *
      * CALLED BY  UPDRTN - Control routine for updates               *
      *                                                               *
      * CALLS      ZFRPED - Edit numeric field                        *
      *                                                               *
      *****************************************************************
     C           FORMAT    BEGSR                           ** FORMAT **
      *
      ** Edit the buy amount field - for printing
     C/COPY WNCPYSRC,RE4120C023
     C                     Z-ADD@TAMT     @BUYA  150                                          CCG016
     C                     Z-ADD@TDEC     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @TAMT     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @PAMT1
     C                     MOVE *BLANKS   OBAMT
     C                     MOVE ZOUT22    @PAMT1
      *
      ** Edit the charge amount field - for printing
     C           @CHAMT    IFNE *ZERO
     C           SCHIND    IFEQ 'B'
     C                     Z-ADD@TDEC     ZDECS
     C                     ELSE
     C                     Z-ADD@SDEC     ZDECS
     C                     END
      *
     C                     MOVE 'J'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @CHAMT    ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @PAMT3
     C                     MOVE ZOUT22    @PAMT3
     C                     END
      *
      ** Edit the sell amount field - for printing
     C                     Z-ADD@SDEC     ZDECS
     C                     MOVE 'J'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @SCEQ     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @PAMT2
     C                     MOVE *BLANKS   OSAMT
     C                     MOVE ZOUT22    @PAMT2
      *
      ** Edit the exchange amount (if buy commission)
      ** else the equivalent amount (if sell) for printing
     C                     MOVE *BLANKS   ZFLD15
     C           SCHIND    IFEQ 'B'
     C                     Z-ADD@TDEC     ZDECS
     C           @TAMT     SUB  @CHAMT    @TCAM
     C                     MOVE @TCAM     ZFLD15
     C                     ELSE
     C                     Z-ADD@SDEC     ZDECS
     C                     MOVE @EQAMS    ZFLD15
     C                     END
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @EXAMT
     C                     MOVE *BLANKS   OEXAMT
     C                     MOVE ZOUT22    @EXAMT
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            PCMTXT - Prepare comit text                        *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           PCMTXT    BEGSR                           ** PCMTXT **
      *
      ** Prepare the comit text CMTTXT
     C                     MOVE 'RE'      MDID
     C                     MOVEL@PGM      PGMN
     C                     MOVE SWID      WSIDX
     C                     TIME           MTIME
     C                     MOVE @USER     USRIDX
      *
     C                     ENDSR
      *****************************************************************   CRT002
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      *            ALNCHG - Format Charge Amount.                     *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY         -                                           *   CRT002
      *                                                               *   CRT002
      * FLDS USED         -                                           *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           ALNCHG    BEGSR                           ** ALNCHG **   CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   SCAMT                           CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C                     Z-ADD0         ZADIG                           CRT002
     C                     Z-ADD0         ZADEC                           CRT002
      *                                                                   CRT002
      * If in batch mode then simply move amount into WCHAMT field        CRT012
      * to @CHAMT field as no need to use ZALIGN.                         CRT012
     C           PMODE     IFEQ 'P'                                       CRT012
     C                     MOVE WCHAMT    @CHAMT                          CRT012
     C                     MOVELWCHAMT    SCAMT                           CRT012
     C                     ELSE                                           CRT012
     C                     MOVELWCHAMT    ZFIELD                          CRT002
      *                                                                   CRT002
     C           WCHCCY    IFEQ SSCCY                                     CRT002
     C                     Z-ADD@SDEC     ZADEC                           CRT002
     C                     ELSE                                           CRT002
     C           WCHCCY    IFEQ SBCCY                                     CRT002
     C                     Z-ADD@TDEC     ZADEC                           CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C           15        SUB  ZADEC     ZADIG                           CRT002
      *                                                                   CRT002
     C                     EXSR ZALIGN                                    CRT002
      *                                                                   CRT002
     C           *IN99     IFEQ '0'                                       CRT002
     C           ZFIELD    ANDNE*ZERO                                     CRT002
     C*********************MOVE WCHAMT    SCAMT                     CRT002118133
     C                     MOVELWCHAMT    SCAMT                           118133
     C                     MOVE ZFIELD    @CHAMT                          CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
     C           *IN99     IFEQ '1'                                       CRT002
     C                     SETON                     3150                 CRT002
     C                     MOVE 'USR0008' WUMSID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT012
      ************************************************************ CRT002 171139
      ****Blank*out*default*transaction*type*when*charge*amount*is CRT002 171139
      ************************************************************ CRT002 171139
     C********** SCAMT     IFEQ *BLANKS                            CRT002 171139
     C**********           MOVEL*BLANKS   SCTRTY                   CRT002 171139
     C**********           END                                     CRT002 171139
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            LAST   - Final Processing                          *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  Main   - Control Process                           *
      *            SCRINP - Detail screen input                       *
      *            TRNOVR - Transaction override process              *
      *                                                               *
      *****************************************************************
     C           LAST      BEGSR                           ** LAST   **
      *
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            *PSSR  - Program error                             *
      *                                                               *
      * CALLS      DBERRCTL                                           *
      *                                                               *
      * CALLED BY  DBERR  - Database Error Handling                   *
      *                                                               *
      *****************************************************************
     C           *PSSR     BEGSR                           ** *PSSR  **
     C*
     C** Check to see that *PSSR has not been called yet
     C*
     C           WRUN      IFEQ *BLANK
     C                     MOVE 'Y'       WRUN    1
     C                     SETON                     U7U8LR
     C                     DUMP
     C*
     C** Call standard database error program
     C*
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     CALL 'DBERRCTL'
     C                     END                                            CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           @FIRST    ANDEQ'0'                                       CRT002
      *                                                                   CRT002
     C                     ROLBK                                          CRT002
      *                                                                   CRT002
     C                     MOVELRAMSTY    RBMSTY                          CRT002
     C                     MOVELDBLOT     RBHSMS                          CRT002
     C                     MOVEL'DBER'    RBHMSI                          CRT002
     C                     MOVEL'1'       RBAEFL                          CRT002
     C                     MOVEL'E'       RBHMSS                          CRT002
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
      *                                                                   CRT002
     C                     MOVEL'USR0010' @MSGID                          CRT002
     C                     MOVELDBLOT     @MSGDT                          CRT002
     C                     EXSR RTVMSG                                    CRT002
     C                     MOVEL@MSGTX    RBHSMS                          CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVE 'N'       WSUCM                           CRT002
     C                     MOVE 'DS'      WSTAT                           CRT002
     C                     TIME           WTMDS                           CRT002
     C           WTHR      CAT  ':'       WA                              CRT002
     C           WTMN      CAT  ':'       WB                              CRT002
     C           WA        CAT  WB        WC                              CRT002
     C           WC        CAT  WTSS      WSTTM                           CRT002
      *                                                                   CRT002
     C/COPY WNCPYSRC,REH00289
     C                     MOVELREPOIO    P@QDS                           CRT002
      *                                                                   CRT002
     C                     CLEARWCMSG                                     CRT002
     C                     MOVELREPOIO    WCMSG                           CRT002
      *                                                                   CRT002
     C                     EXSR SDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
     C                     EXSR WRLOG                                     CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
     C                     MOVEL*BLANKS   REPOIO                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
     C*
     C                     END
     C*
     C** If *PSSR already run, then just end the program here
     C*
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FIRST  - Initial Processing                        *
      *                                                               *
      * CALLS      ZA0150 - Get Midas Rundate & Setup Indicator       *
      *            IFLDS  - Initialize screen/work fields             *
      *            INT01  - Initialise error indicators               *
      *            DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLED BY  Main   - Control Process                           *
      *                                                               *
      *****************************************************************
     C           FIRST     BEGSR                           ** FIRST  **
      *
      ** Input parameter(s) :
     C           *ENTRY    PLIST                           Entry parameter list
     C                     PARM           PFNCD   3        Function code
     C                     PARM           PMODE   1        Processing ModeCRT002
     C*
     C/COPY WNCPYSRC,RE4120CCP4
     C*
      *
      ** Retrieve RTS job dataarea
     C           *NAMVAR   DEFN           RTSDTA
     C                     IN   RTSDTA
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     MOVELPTLID     @TLID
     C                     ENDIF                                          CRT002
      *
      ** Prepare LDA
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVEL*BLANK    DBLOT
     C                     OUT  LDA
     C*
     C** IN the data are ZMUSER
     C*
     C           *NAMVAR   DEFN           ZMUSER
     C                     IN   ZMUSER
      *                                                                   CRT002
      **  If function code '0JS', display 'Buying Travellers Cheques'     CRT002
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JS'                                     CRT002
     C                     MOVE '1'       *IN35                           CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  If function code '0JX', display 'Selling Travellers Cheques'    CRT002
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JX'                                     CRT002
     C                     MOVE '1'       *IN36                           CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  If PMODE = 'I', open display file RE4120DF                      CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     OPEN RE4120DF                                  CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Initialise MSG text and MSG return code                         CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   @MSGTX                          CRT002
      *                                                                   CRT002
      **  Initialise MSDID and MSG file fields                            CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   WUMSID                          CRT002
     C                     MOVEL'RTSMSGF' WUMSGF                          CRT002
      *                                                                   CRT002
     C                     MOVE '1'       @FIRST  1                       CRT002
     C*
     C** Check Profit Centres Used Indicator.
     C*
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*FIRST ' @OPTN
     C********** SDGELR    PARM SDGELR    DSFDY                                               CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C*
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDGELRPD'DBFILE           ***************
     C                     MOVEL@OPTN     DBKEY            ** DB ERR 08 **
     C                     Z-ADD8         DBASE            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C** Check if 'PROFIT CENTRE USED'
     C           PFCU      IFEQ 'Y'
     C                     SETON                     25
     C                     END
     C*
      ** initialize parameters for SCC0240- build program message queue
     C                     MOVE *BLANKS   @MSGID  7
     C                     MOVEL'RTSMSGF' @MSGF  10
      *
      ** Initialize screen message queue
     C                     MOVEL'*'       SPGMQ
      *
      ** Seton  message subfile end indicator
     C                     MOVE '1'       *IN10
      *
     C                     MOVEL@JOB      SWID   10
     C                     MOVEL@PGM      SPGMN  10
     C                     MOVEL@USER     SUSER
     C                     MOVE *BLANKS   SMRDT   7
      *
      ** Call subroutine to access sdbankl1 for Midas Run Date.
     C                     EXSR ZA0150
      *
      ** Call subroutine to access sdbrcdl1 for Branch Name
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     EXSR ZABRCA
     C                     END                                            CRT002
      *
      ** Move midas run date to screen field
     C                     MOVELBJMRDT    SMRDT
      *
      ** Store base currency code & local currency code
     C                     MOVE BJCYCD    @BSCY   3
     C                     MOVE BJLCCY    @LCCY   3
      *
      ** Access lf/sdcurrl0 for local currency details
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM BJLCCY    @CURR   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** If record not found or is not a live record - db error
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVE @CURR     DBKEY            ** DB ERR 02 **
     C                     Z-ADD2         DBASE            ***************
     C                     EXSR DBERR
     C                     END
      *
      ** Store details
     C                     Z-ADDA6NBDP    @LDEC   10
     C                     Z-ADDA6SMLD    @LSML   50                      CRT002
      *
      ** Access lf/sdcurrl0 for base  currency details
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM BJCYCD    @CURR
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** If record not found or is not a live record - db error
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVE @CURR     DBKEY            ** DB ERR 03 *
     C                     Z-ADD3         DBASE            ***************
     C                     EXSR DBERR
     C                     END
      *
      ** Store details
     C                     Z-ADDA6NBDP    @BDEC   10
     C                     Z-ADDA6SMLD    @BSML   50                      CRT002
     C                     MOVELA6MDIN    @BMD    1                       CRT002
      *
     C                     CALL 'AOFNCDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM PFNCD     @FNCD   3
     C           SDFNCD    PARM SDFNCD    DSFDY
      *
      ** If record does not exist or is deleted - database errors
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVE 'SDFNCDPD'DBFILE           ***************
     C                     Z-ADD4         DBASE            ** DB ERR 04 **
     C                     MOVELPFNCD     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
      ** Store validation indicators in an array
     C                     MOVEAFQVWIN    @V
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JS'                                     CRT002
      *                                                                   CRT002
     C           FQCRC1    IFNE *BLANKS                                   CRT002
     C                     CALL 'AORETRR0'                                CRT002
     C                     PARM '*BLANKS' @RTCD                           CRT002
     C                     PARM '*KEY   ' @OPTN                           CRT002
     C           SBTRTY    PARM FQCRC1    @RETR                           CRT002
     C           SDRETR    PARM SDRETR    DSFDY                           CRT002
      *                                                                   CRT002
      **  Dbase error if record not found                                 CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     Z-ADD25        DBASE                           CRT002
     C                     MOVELFQCRC1    DBKEY                           CRT002
     C                     MOVE 'SDRETRPD'DBFILE                          CRT002
     C                     EXSR DBERR                                     CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Transaction type must not be debit only                         CRT002
      *                                                                   CRT002
     C           A1DCIN    IFEQ 'D'                                       CRT002
     C                     SETON                     1150                 CRT002
     C                     MOVEL'USR0087' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     END                                            CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD26        DBASE                           CRT002
     C                     MOVELFQCRC1    DBKEY                           CRT002
     C                     MOVE 'SDFNCDPD'DBFILE                          CRT002
     C                     EXSR DBERR                                     CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C           PFNCD     IFEQ '0JX'                                     CRT002
      *                                                                   CRT002
     C           FQDRC1    IFNE *BLANKS                                   CRT002
     C                     CALL 'AORETRR0'                                CRT002
     C                     PARM '*BLANKS' @RTCD                           CRT002
     C                     PARM '*KEY   ' @OPTN                           CRT002
     C           SSTRTY    PARM FQDRC1    @RETR                           CRT002
     C           SDRETR    PARM SDRETR    DSFDY                           CRT002
      *                                                                   CRT002
      **  Dbase error if record not found                                 CRT002
      *                                                                   CRT002
     C           @RTCD     IFNE *BLANKS                                   CRT002
     C           *LOCK     IN   LDA                                       CRT002
     C                     Z-ADD27        DBASE                           CRT002
     C                     MOVELFQDRC1    DBKEY                           CRT002
     C                     MOVE 'SDRETRPD'DBFILE                          CRT002
     C                     EXSR DBERR                                     CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      **  Transaction type must not be credit only                        CRT002
     C           A1DCIN    IFEQ 'C'                                       CRT002
     C                     SETON                     1550                 CRT002
     C                     MOVEL'USR0087' @MSGID                          CRT002
     C                     EXSR SNDMSG                                    CRT002
     C                     END                                            CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
     C                     Z-ADD28        DBASE                           CRT002
     C                     MOVELFQDRC1    DBKEY                           CRT002
     C                     MOVE 'SDFNCDPD'DBFILE                          CRT002
     C                     EXSR DBERR                                     CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *
      ** Get default charge transaction type for function
      *
      ** Set up key list
     C                     CALL 'AOTCHGR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDTCHG    PARM SDTCHG    DSFDY
     C*
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD21        DBASE            ** DB ERR 21 **
     C                     MOVE 'SDRTSDPD'DBFILE           ***************
     C                     MOVEL'*FIRST'  DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** If default charge transaction type non blank obtain details
      ** and save
     C           FSFJIC    IFNE *BLANKS
     C*
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C           SCTRTY    PARM FSFJIC    @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
     C*
      ** Dbase error if record not found or transaction type not debit
     C           @RTCD     IFNE *BLANKS
     C           A1DCIN    ORNE 'D'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD22        DBASE            ** DB ERR 22 **
     C                     MOVELFSFJIC    DBKEY            ***************
     C                     MOVE 'SDRETRPD'DBFILE
     C                     EXSR DBERR
     C                     END
      *
      ** Save associated GL code
     C**********           MOVE A1ASGL    @ASGSV  40                                          CGL029
     C                     MOVE A1ASGL    @ASGSV 100                                          CGL029
     C                     END
      *
     C/COPY WNCPYSRC,REH00180
     C*
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*VERIFY' @OPTN   7
     C                     PARM 'CRT104'  @SARD   6
     C           SCSARD    PARM SCSARD    DSFDY
     C*
     C           @RTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CRT104  1
     C                     ELSE
     C                     MOVE 'N'       CRT104
     C                     END
     C/COPY WNCPYSRC,RE4120C025
      *                                                                   CEU024
      ** Access Switchable Feature Details                                CEU024
      *                                                                   CEU024
     C                     CALL 'AOSARDR0'                                CEU024
     C                     PARM *BLANKS   @RTCD                           CEU024
     C                     PARM '*VERIFY' @OPTN                           CEU024
     C                     PARM 'CEU024'  @SARD                           CEU024
     C           SCSARD    PARM SCSARD    DSFDY                           CEU024
     C*                                                                   CEU024
     C           @RTCD     IFEQ *BLANKS                                   CEU024
     C                     MOVE 'Y'       CEU024  1                       CEU024
     C                     MOVE CRT104    @C104   1                       CEU024
     C                     ELSE                                           CEU024
     C                     MOVE 'N'       CEU024                          CEU024
      *                                                                   CEU024
      ** Handle Database Error                                            CEU024
      *                                                                   CEU024
     C           @RTCD     IFNE '*NRF    '                                CEU024
     C           *LOCK     IN   LDA                                       CEU024
     C                     MOVEL'SCSARDPD'DBFILE           ************** CEU024
     C                     MOVEL'CEU024'  DBKEY            * DB ERR  29 * CEU024
     C                     Z-ADD29        DBASE            ************** CEU024
     C                     EXSR DBERR                                     CEU024
     C                     ENDIF                                          CEU024
      *                                                                   CEU024
     C                     ENDIF                                          CEU024
     C/COPY WNCPYSRC,RE4120C008
      ** Initialise all screen/work fields and indicators
     C                     EXSR INT01
     C                     EXSR IFLDS
      *                                                                   CRT002
      **  Load tellers to array.                                          CRT002
      *                                                                   CRT002
     C                     EXSR LODTLR                                    CRT002
     C/COPY WNCPYSRC,RE4120C024
      *
     C                     MOVE '0'       @FIRST                          CRT002
      *                                                                   CRT002
     C                     SELEC                                          CRT002
      *                                                                   CRT002
      **  Foreign Exchange Transactions                                   CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JI'                                     CRT002
     C                     MOVEL'RE4120'  P@QRC                           CRT002
     C                     MOVE '0JI '    P@QRC                           CRT002
     C                     MOVE '1'       *IN37                           CRT002
      *                                                                   CRT002
      **  Buy Travellers Cheques in Non-Cash Currency                     CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JS'                                     CRT002
     C                     MOVEL'RE4120'  P@QRC                           CRT002
     C                     MOVE '0JS '    P@QRC                           CRT002
     C                     MOVE '1'       *IN38                           CRT002
      *                                                                   CRT002
      **  Sell Travellers Cheques in Non-Cash Currency                    CRT002
      *                                                                   CRT002
     C           PFNCD     WHEQ '0JX'                                     CRT002
     C                     MOVEL'RE4120'  P@QRC                           CRT002
     C                     MOVE '0JX '    P@QRC                           CRT002
     C                     MOVE '1'       *IN39                           CRT002
      *                                                                   CRT002
     C                     ENDSL                                          CRT002
      *                                                                   CRT002
     C/COPY ZSRSRC,RBOITMC1                                               CRT002
      *                                                                   CRT002
      * Check if CRT012 is switched on                                    CRT012
     C                     CALL 'AOSARDR0'                                CRT012
     C                     PARM           PRTCD   7                       CRT012
     C                     PARM '*VERIFY' POPTN   7                       CRT012
     C                     PARM 'CRT012'  PSARD   6                       CRT012
      *                                                                   CRT012
     C           PRTCD     IFEQ *BLANKS                                   CRT012
      *                                                                   CRT012
      * Check if Cashier Multiple Charges is On                           CRT012
     C                     MOVE *BLANKS   SVALK2                          CRT012
     C                     MOVE *BLANKS   SVALK3                          CRT012
     C                     MOVE *BLANKS   SVALK4                          CRT012
     C                     MOVE *BLANKS   SVALK5                          CRT012
     C                     MOVE *BLANKS   SVALK6                          CRT012
     C                     MOVE *BLANKS   SVALK7                          CRT012
     C                     MOVE *BLANKS   SVALK8                          CRT012
     C                     MOVE *BLANKS   SVALK7                          CRT012
     C                     MOVE *BLANKS   SVALK8                          CRT012
      *                                                                   CRT012
     C                     CALL 'AOSVALR0'                                CRT012
     C                     PARM *BLANKS   RTNCDE  7                       CRT012
     C                     PARM           SVALK1 20                       CRT012
     C                     PARM           SVAL1 200                       CRT012
     C                     PARM           SVALK2 20                       CRT012
     C                     PARM           SVAL2 200                       CRT012
     C                     PARM           SVALK3 20                       CRT012
     C                     PARM           SVAL3 200                       CRT012
     C                     PARM           SVALK4 20                       CRT012
     C                     PARM           SVAL4 200                       CRT012
     C                     PARM           SVALK5 20                       CRT012
     C                     PARM           SVAL5 200                       CRT012
     C                     PARM           SVALK6 20                       CRT012
     C                     PARM           SVAL6 200                       CRT012
     C                     PARM           SVALK7 20                       CRT012
     C                     PARM           SVAL7 200                       CRT012
     C                     PARM           SVALK8 20                       CRT012
     C                     PARM           SVAL8 200                       CRT012
     C                     PARM           SVALK9 20                       CRT012
     C                     PARM           SVAL9 200                       CRT012
     C                     PARM           SVALK0 20                       CRT012
     C                     PARM           SVAL10200                       CRT012
      *                                                                   CRT012
     C           RTNCDE    IFNE *BLANKS                                   CRT012
     C           SVAL10    IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK0    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL9     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK9    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL8     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK8    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL7     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK7    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL6     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK6    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL5     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK5    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL4     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK4    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL3     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK3    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL2     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK2    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL1     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK1    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           *LOCK     IN   LDA                                       CRT012
     C                     MOVEL'SDSVALPD'DBFILE           *************  CRT012
     C                     Z-ADD37        DBASE            * DB ERR 37 *  CRT012
     C                     EXSR DBERR                      *************  CRT012
     C                     ENDIF                                          CRT012
     C           SVAL11    IFEQ 'Y'                                       CRT012
     C                     MOVE 'Y'       CRT012  1                       CRT012
     C                     ELSE                                           CRT012
     C                     MOVE 'N'       CRT012                          CRT012
     C                     ENDIF                                          CRT012
     C*                                                                   CRT012
     C                     ELSE                                           CRT012
     C                     MOVE 'N'       CRT012                          CRT012
     C                     ENDIF                                          CRT012
      *                                                                   CRT012
      ** Check if CRT026 is switched on                                                       CRT026
      *                                                                                       CRT026
     C                     CALL 'AOSARDR0'                                                    CRT026
     C                     PARM *BLANKS   @RTCD   7                                           CRT026
     C                     PARM '*VERIFY' @OPTN   7                                           CRT026
     C                     PARM 'CRT026'  @SARD   6                                           CRT026
     C           SCSARD    PARM SCSARD    DSFDY                                               CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C           @RTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'SCSARDPD'DBFILE           ***************                    CRT026
     C                     Z-ADD9         DBASE            ** DB ERR 09 **                    CRT026
     C                     MOVEL'CRT026'  DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           @RTCD     IFEQ *BLANKS                                                       CRT026
     C                     MOVE 'Y'       CRT026  1                                           CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'N'       CRT026                                              CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C                     MOVEL*BLANKS   CCG016  1                                           CCG016
     C                     CALL 'AOSARDR0'                                                    CCG016
     C                     PARM *BLANKS   PRTCD   7                                           CCG016
     C                     PARM '*VERIFY' POPTN   7                                           CCG016
     C                     PARM 'CCG016'  PSAR    6                                           CCG016
     C           PRTCD     IFEQ *BLANKS                                                       CCG016
     C                     MOVEL'Y'       CCG016                                              CCG016
     C                     END                                                                CCG016
      *                                                                                       CCG016
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            IFLDS  - Initialize screen/work fields             *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  RFRESH - Refresh screen                            *
      *            FIRST  - Initial Processing                        *
      *****************************************************************
     C           IFLDS     BEGSR                           ** IFLDS  **
      *
     C           PFNCD     IFEQ '0JI'                                     CRT002
     C                     MOVE FSFJIB    SBTRTY
     C                     MOVE FSFJIS    SSTRTY
     C                     END                                            CRT002
     C           PFNCD     IFEQ '0JS'                                     CRT002
     C                     MOVE FQCRC1    SBTRTY                          CRT002
     C                     MOVE FSFJIS    SSTRTY                          CRT002
     C                     END                                            CRT002
     C           PFNCD     IFEQ '0JX'                                     CRT002
     C                     MOVE FSFJIB    SBTRTY                          CRT002
     C                     MOVE FQDRC1    SSTRTY                          CRT002
     C                     END                                            CRT002
     C                     MOVE *BLANKS   SBCCY
     C                     MOVE *BLANKS   SSCCY
     C                     MOVE *BLANKS   SBAMT
     C                     MOVE *BLANKS   @SCYEQ
     C                     MOVE *BLANKS   SEXRT
     C                     MOVE *BLANKS   SDEPC
     C                     MOVE *BLANKS   SOTLI
     C                     MOVE *BLANKS   SOTPC
     C                     MOVE *BLANKS   SOVUR                                               CRT026
     C                     MOVE *BLANKS   SOVPW                                               CRT026
     C                     MOVE *BLANKS   @W
     C                     MOVE *BLANKS   @T
     C                     Z-ADD1         @COUNT  10
     C                     MOVE FSFJIC    SCTRTY
     C                     MOVE *BLANKS   SCHIND
     C                     MOVE *BLANKS   SCPER
     C                     MOVE *BLANKS   SCAMT
     C                     MOVE *BLANKS   SNARR
     C                     MOVE *BLANKS   SPRFC
     C                     MOVE *BLANKS   SSAMT
     C/COPY WNCPYSRC,RE4120C020
      *
      ** Initialise work fields
     C                     MOVE *BLANKS   @SBAMT
     C                     MOVE *BLANKS   @XRT
     C                     MOVE *BLANKS   OBAMT
     C                     MOVE *BLANKS   OSAMT
     C                     MOVE *BLANKS   @TMD
     C                     MOVE *BLANKS   @SMD
     C                     MOVE *BLANKS   @BRVIN
     C                     MOVE *BLANKS   @BDCIN
     C                     MOVE *BLANKS   @BCSIN
     C                     MOVE *BLANKS   @BCLIN
     C                     MOVE *BLANKS   @BASGL
     C                     MOVE *BLANKS   @SRVIN
     C                     MOVE *BLANKS   @SDCIN
     C                     MOVE *BLANKS   @SCSIN
     C                     MOVE *BLANKS   @SCLIN
     C                     MOVE *BLANKS   @SASGL
     C                     Z-ADD0         @TDEC
     C                     Z-ADD0         @SDEC
     C                     Z-ADD0         @SCEQ
     C                     Z-ADD0         @EXRT
     C                     MOVE *BLANKS   @SCAMT
     C                     MOVE *BLANKS   OEXRT
     C                     Z-ADD0         @CHAMT
     C*
     C** Load the teller's default department code
     C*
     C                     MOVE PDEPC     SDEPC
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            ZA0150 - Get Midas Rundate & Setup Indicator       *
      *                                                               *
      *        - This subroutine chains to file LF/SDBANKL1           *
      *            to get Midas Rundate & setup-complete-flag         *
      *                                                               *
      *            Indicator 70 is set on if the chain fails          *
      *                                                               *
      *            if indicator 70 is on, details of the              *
      *            attempted access is placed in the LDA              *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLED BY  FIRST  - Initial Processing                        *
      *                                                               *
      *****************************************************************
     C           ZA0150    BEGSR                           ** ZA0150 **
      *
     C                     MOVE *BLANKS   @SDKEY 10
     C*
     C** Use access program AOBANKR0 to retrieve header details
     C*
     C                     CALL 'AOBANKR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      ** If record does not exist
     C*
     C** If error in access program, exit via DBERR subroutine
     C*
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE           ***************
     C                     MOVE @OPTN     DBKEY            ** DB ERR 01 *
     C                     Z-ADD1         DBASE            ***************
     C                     EXSR DBERR
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * SNDMSG  - Sends parameters of SNDPGMMSG command to be executed*
      *                                                               *
      * CALLS      SCC0240- Send Message to program queue             *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED  @MSGID - Message id                                *
      *            @MSGF  - Message file                              *
      *            @MSDTA - Message data                              *
      *            @MSPRL - Program relationship                      *
      *            @MSPGM - Program name                              *
      *            @MSTYP - Message type                              *
      *                                                               *
      *****************************************************************
     C           SNDMSG    BEGSR                           ** SNDMSG **
      *
     C                     SETON                     69
      *
     C                     CALL 'SCC0240'
     C                     PARM           @MSGID
     C                     PARM           @MSGF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLS      *PSSR  - Program  error                            *
      *                                                               *
      * CALLED BY  ZA0150 - Get Midas Rundate & Setup Indicator       *
      *            FIRST  - Initial processing                        *
      *            UPTRL  - Update Control Trailer Record             *
      *            UPDRTN - Control rtn. for updates                  *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DBERR     BEGSR                           ** DBERR  **
      *
     C                     MOVEL@PGM      DBPGM
     C                     OUT  LDA
      *
     C                     EXSR *PSSR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * ZABRCA  -  Get Teller Branch Name                             *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLED BY  FIRST  -  Initial Processing                       *
      *                                                               *
      *****************************************************************
     C           ZABRCA    BEGSR                           ** ZABRCA **
     C*
     C** Use access program AOBRCHR0 to retrieve header details
     C*
     C                     MOVELPTLBC     @BRCH                           CRT002
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C***********          PARM PTLBC     @BRCH   3                       CRT002
     C                     PARM           @BRCH   3                       CRT002
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
      ** If record does not exist
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBRCHPD'DBFILE           ***************
     C                     MOVE @BRCH     DBKEY            ** DB ERR 07 **
     C                     Z-ADD20        DBASE            ***************
     C                     EXSR DBERR
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              CRT002
      *****************************************************************   CRT002
      *                                                               *   CRT002
      * MOVDTL  -  Move Details to Send to Outgoing DataQ             *   CRT002
      *                                                               *   CRT002
      * CALLS             -                                           *   CRT002
      *                                                               *   CRT002
      * CALLED BY  SCRINP -  Detail screen input (in P mode)          *   CRT002
      *                                                               *   CRT002
      *****************************************************************   CRT002
     C           MOVDTL    BEGSR                           ** MOVDTL **   CRT002
      *                                                                   CRT002
      **  Message Type and Host Message Id.                               CRT002
      *                                                                   CRT002
     C                     MOVELRAMSTY    RBMSTY                          CRT002
     C                     MOVEL*BLANKS   RBHMSI                          CRT002
      *                                                                   CRT002
      **  Terminal or Warning Errors Exist.                               CRT002
      *                                                                   CRT002
     C           @TI       IFGT 0                                         CRT002
     C           @WI       ORGT 0                                         CRT002
      *                                                                   CRT002
      **  Convert warning messages to Cashier Format                      CRT002
      *                                                                   CRT002
     C                     MOVEA*BLANKS   WMS1                            CRT002
     C                     MOVEA*BLANKS   WMS2                            CRT002
     C                     MOVEASMSG1     WMS1                            CRT002
     C                     Z-ADD1         X                               CRT002
      *                                                                   CRT002
     C           WMS1,X    DOWNE*BLANKS                                   CRT002
     C           X         ANDLE7                                         CRT002
      *                                                                   CRT002
     C           WMS1,X    LOKUPTABC1     TABC2          25               CRT002
     C           *IN25     IFEQ '1'                                       CRT002
     C                     MOVELTABC2     WMS2,X                          CRT002
     C                     ELSE                                           CRT002
     C                     MOVEL'CDNF'    WMS2,X                          CRT002
     C                     END                                            CRT002
     C                     ADD  1         X                               CRT002
      *                                                                   CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     SUB  1         X                               CRT002
     C                     MOVE X         WWNUM                           CRT002
     C                     MOVELWHSMS     RBHSMS                          CRT002
      *                                                                   CRT002
     C                     MOVEL'W'       RBHMSS                          CRT002
     C                     MOVEL'1'       RBAEFL                          CRT002
     C                     MOVEL'N'       WSUCM                           CRT002
      *                                                                   120880
     C           WFWST     IFEQ 'Y'                                       120880
     C                     MOVEL'S'       RBFPSF                          120880
     C                     ENDIF                                          120880
      *                                                                   CRT002
     C/COPY WNCPYSRC,REH00290
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Errors exist before detail screen appears.                      CRT002
      *                                                                   CRT002
     C           *IN69     IFEQ '1'                                       CRT002
     C/COPY WNCPYSRC,REH00291
     C                     MOVEL'E'       RBHMSS                          CRT002
     C                     MOVEL'1'       RBAEFL                          CRT002
      *                                                                   120880
     C           WFWST     IFEQ 'Y'                                       120880
     C                     MOVEL'E'       RBFPSF                          120880
     C                     ENDIF                                          120880
      *                                                                   120880
     C                     MOVE WUMSID    RBHMSI                          CRT002
     C                     MOVEL*BLANKS   WUMSGD 78                       CRT002
     C                     MOVEL'N'       WSUCM                           CRT002
      *                                                                   CRT002
     C                     EXSR RTVMSG                                    CRT002
     C                     MOVEL@MSGTX    RBHSMS                          CRT002
      *                                                                   CRT002
     C/COPY WNCPYSRC,REH00292
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Valid record received.                                          CRT002
      *                                                                   CRT002
     C           @TI       IFEQ 0                                         CRT002
     C           @WI       ANDEQ0                                         CRT002
     C           *IN69     ANDEQ'0'                                       CRT002
      *                                                                   CRT002
      **  Completed Severity.  Transaction Reference should be comprised  CRT002
      **  of the Teller Id and Transaction Number.                        CRT002
      *                                                                   CRT002
     C                     MOVEL'C'       RBHMSS                          CRT002
      *                                                                   120880
     C           WFWST     IFEQ 'Y'                                       120880
     C                     MOVEL'Y'       RBFPSF                          120880
     C                     MOVEL*BLANK    RBHMSS                          120880
     C                     ENDIF                                          120880
      *                                                                   120880
     C                     ENDIF                                                              194978
      *                                                                                       194978
     C           @TI       IFEQ 0                                                             194978
     C           *IN69     ANDEQ'0'                                                           194978
     C                     MOVELPTLID     @WRK8   8                       CRT002
     C                     MOVE TBTN      @WRK8                           CRT002
     C                     MOVEL@WRK8     RBTRN1                          CRT002
     C                     MOVEL'Y'       WSUCM                           CRT002
     C                     TIME           WTMDS  120                      CRT002
     C           WTHR      CAT  ':'       WA      3                       CRT002
     C           WTMN      CAT  ':'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WTSS      WCMTM                           CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     MOVEL'DS'      WSTAT                           CRT002
     C                     TIME           WTMDS  120                      CRT002
     C           WTHR      CAT  ':'       WA      3                       CRT002
     C           WTMN      CAT  ':'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WTSS      WSTTM                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
      *                                                                   CRT002
     C                     ENDSR                                          CRT002
      *EJECT******************                                     CEU024 151340
      *C*PY*ZSRSRC,ZXRATEZ1***                                     CEU024 151340
      *                                                                   151340
      /EJECT                                                              151340
      /COPY ZSRSRC,RTZXRTC1                                               151340
      *                                                                   151340
      /EJECT                                                              CEU024
      /COPY ZSRSRC,RTCOEUC1                                               CEU024
      *****************************************************************   CRT002
     C*
     C/COPY WNCPYSRC,RE4120CCP5
     C*
      /EJECT
      ** SR.ZALIGN subroutine
      /COPY ZSRSRC,ZALIGNZ2
      *
      *****************************************************************
      /EJECT
      ** SR.ZEDIT subroutine
      /COPY ZSRSRC,ZEDITZ2
      *
      *****************************************************************
      /EJECT
      ** SR.ZTNLU1 subroutine
      /COPY ZSRSRC,ZTNLU1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZFRPED Subroutine
      /COPY ZSRSRC,ZFRPEDZ3
      *
      *****************************************************************
      /EJECT
      ** SR.RTTCCY Subroutine
      /COPY ZSRSRC,RTTCCYC1
      *
      *****************************************************************
      /EJECT
      ** SR.RTCASH Subroutine
      /COPY ZSRSRC,RTCASHC1
      *****************************************************************
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBSDQMS                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBRDQMS                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBDQERR                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBRMSGC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBWLOGC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBCXRTC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBLDTLC1                                               CRT002
      *                                                                   CRT002
      /EJECT
      /COPY ZSRSRC,RTTWIDC1
      ** Array for SR.RTTWID
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTCCYSC1
      ** Array for SR.RTCCYS
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTTLMTC1
      ** Array for SR.RTTLMT
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTXRATC1
      ** Array for SR.RTXRAT
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTASGLC1
      ** Array for SR.RTASGL
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTCONVC1
      ** Array for SR.RTCONV
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTLCNVC1
      ** Array for SR.RTLCNV
      *
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTENCPC1
      ** Passcode encription
      /EJECT                                                              CRT012
      /COPY ZSRSRC,RBCCHGC1                                               CRT012
      ** Charges split                                                    CRT012
      *                                                                   CRT012
      *
      *****************************************************************
      /EJECT
      *
      ** Teller controls
     OTTRNTM2FE                @RELTT
      *
      ** Teller totals
     OTTRNTM3FE                @RELT3
      *****************************************************************
     O*                                                                   S01408
     O/COPY WNCPYSRC,RE4120OOP1                                           S01408
**  CPY@  OBJECT COPYRIGHT
(c) Misys International Banking Systems Ltd. 2001
** - @P   - Array to hold the positions of the validation indicators
01020304050607080910111213141516171819202122232425
**  alphanumeric table
ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789
**  encription code table
SDKJFIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJ
FIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJFIEN
** @TXT - Large text strings                                              CRT002
OVRDBF     FILE(TTRANPD) MBR(XXXX) SECURE(*YES) SHARE(*YES) SEQONLY(*NO)
OVRDBF     FILE(TTRANPT) MBR(XXXX) SECURE(*YES) SHARE(*YES) SEQONLY(*NO)
DLTOVR     FILE(TTRANPD)
DLTOVR     FILE(TTRANPT)
**  WTEXT WARNING TEXT MESSAGE                                            CRT002
KSM2329  Multiple referrals exist ( ) -                                   CRT002
**  TABC1/TABC2 - WARNING MESSAGE CONVERTION TABLE                        CRT002
HOLDS   HLDS                                                              CRT002
EXCESS  EXCS                                                              CRT002
FLOAT   FLOT                                                              CRT002
CLS.O/D CSOD                                                              CRT002
SVG.O/D SVOD                                                              CRT002
MAX.CCY MXCY                                                              CRT002
CHQBKER CQBK                                                              CRT002
N.S.F.  NSF                                                               CRT002
EX.O/D  EXOD                                                              CRT002
BLW.MIN BLMN                                                              CRT002
AC.CLG  ACCL                                                              CRT002
N.ASGL1 NAG1                                                              CRT002
N.ASGL2 NAG2                                                              CRT002
N.ASGL3 NAG3                                                              179321
BADDPT  BDDT                                                              CRT002
BLOCKCR BLCR                                                              CRT002
BLOCKDR BLDR                                                              CRT002
BNKRPT  BKRP                                                              CRT002
BR.DIF  BRDF                                                              CRT002
BR.DIF1 BRD1                                                              190137
BR.DIF2 BRD2                                                              190137
BFBVIC  BVCQ                                                              CRT002
CHQPRES CQPR                                                              CRT002
CHQRNG  CQRN                                                              CRT002
INACTV  INAC                                                              CRT002
INACTV1 INA1                                                              179321
INACTV2 INA2                                                              179321
REFERCR RFCR                                                              CRT002
REFERDR RFDR                                                              CRT002
STOPCHQ STCQ                                                              CRT002
TLIMIT  TLLM                                                              CRT002
N.WKDAY NWKD                                                              CRT002
XRTWARN XRTW                                                              CRT002
TLIMIT1 TLLM                                                              142092
TLIMIT2 TLLM                                                              142092
CLOSED  CLOS                                                              142092
BLOCKED BLOK                                                              142092
NOTZERO NZRO                                                              142092
BR.OFF  BOFF                                                              CRT007
BR.OFF1 BOF1                                                              CRT007
BR.OFF2 BOF2                                                              CRT007
