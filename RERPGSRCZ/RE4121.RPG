     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE Charges and Credits')                         *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Retail Module                                        *
     F*                                                               *
     F*  RE4121 - Charges and Credits                                 *
     F*                                                               *
     F*  Function:  This program accepts and validates the input of   *
     F*   (I/C)     either charges or credits to retail accounts and  *
     F*             performs file updates to the teller system master *
     F*             files.  A transaction confirmation slip is        *
     F*             generated during this transaction, as receipt for *
     F*             the customer.                                     *
     F*                                                               *
     F*  Called By: REC4121 - RTS Charges and Credits                 *
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
     F*                                                               *
      *  Last Amend No. MD042745           Date 20Nov16               *
      *  Prev Amend No. CCG016             Date 13Sep16               *
      *                 CGL165             Date 17Feb15               *
      *                 AR1087355          Date 30Sep13               *
      *                 MD020701           Date 30Sep13               *
      *                 MD020635           Date 30Sep13               *
      *                 AR1083178          Date 30Sep13               *
      *                 CRE081             Date 30Sep13               *
      *                 252150             Date 03Sep12               *
      *                 263834             Date 17Mar10               *
      *                 CRE073             Date 06Dec10               *
      *                 CRE075             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016             Date 19May08               *
      *                 CER047             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 BUG27532           Date 26Apr10               *
      *                 BUG27045A          Date 13Apr10               *
      *                 BUG27045           Date 18Feb10               *
      *                 CAP205             Date 23Feb10               *
      *                 CAP204             Date 09Feb10               *
      *                 CRE401             Date 26Nov09               *
      *                 CDL081             Date 14Dec09               *
      *                 260297             Date 19May09               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 BUG15976A          Date 25Apr08               *
      *                 253689 (BUG17640)  Date 09Apr08               *
      *                 BUG15976           Date 04Apr08               *
      *                 250891             Date 16Oct07               *
      *                 249968             Date 12Sep07               *
      *                 249179             Date 19Jul07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 25Sep06               *
      *                 CDL013             Date 09Jun06               *
      *                 165543             Date 06Jun06               *
      *                 CSD031             Date 10Apr06               *
      *                 BUG8798 (Reopen)   Date 27Oct05               *
      *                 BUG8798            Date 10Oct05               *
      *                 BUG8514            Date 29Sep05               *
      *                 CRT026             Date 23May06               *
      *                 CSD027             Date 09Dec05               *
      *                 BUG8067            Date 05Sep05               *
      *                 BUG6342            Date 15Apr05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CAAA03             Date 03May04               *
      *                 CRE019             Date 15Mar04               *
      *                 CGL029             Date 01Sep03               *
      *                 CRT012             Date 20May03               *
      * Midas Release 4.01 -------------------------------------------*
     F*  Last Amend No. CRT007             Date 14Jan02               *
      *                 CRT005             Date 27Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 194978             Date 28Jun01               *
      *                 CRT006             Date 17Apr01               *
      *                 CDE002             Date 21Dec99               *
      *                 101578             Date 17Apr01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CSD006             Date 17May01               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 145752             Date 15Aug00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 176443             Date 18Apr00               *
      *                 176510             Date 11Apr00               *
      * Midas DBA 3.02 -----------------------------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 153001             Date 27Apr99               *
      *                 CSD005             Date 02MAR99               *
      *                 CTI002             DATE 09Sep98               *
     F*                 140802             Date 17Aug98               *
     F*                 106661             Date 19Sep97               *
     F*                 110130             Date 09Apr97               *
     F*                 114621             Date 21Feb97               *
     F*                 CRT002             Date  1Dec95               *
     F*                 CCB002             DATE 29JUL96               *
     F*                 S01408             DATE 25APR96               *
     F*                 S01408             DATE 26FEB96               *
     F*                 093546             DATE 12SEP95               *
     F*                 093545             DATE  8SEP95               *
     F*                 S01408             DATE 06SEP95               *
     F*                 091241             DATE 17JUL95               *
     F*                 CRT001  *CREATE    DATE 28FEB95               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD042745 - Travellers Cheque Number is 12 char long.         *
      *  CCG016 - Correspondence Manager for Retail Teller System.    *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  AR1087355C - Do not issue 'EX.O/D' error if withdrawal amnt  *
      *               is withn the range of Available Balance and     *
      *               Closing Balance.                                *
      *  MD020701  - Issue 'N.S.F.' error message instead of          *
      *              'EX.O/D' when account does not have overdraft.   *
      *  MD020635  - Warning errors for NSF, BLMN and EXOD were not   *
      *              initialised causing other warning messages to    *
      *              appear as failing override validation.           *
      *              Initialise override array @O to blanks.          *
      *  AR1083178 - Cannot withdraw from savings accounts, @CLBL is  *
      *              not set-up if CRE081 is ON.                      *
      *  CRE081 - Account Balance Check in RPG                        *
      *         - Consider the following programs in CRE081 changes:  *
      *           RE4116 RE4117 RE4118 RE4119 RE4121 RE4124           *
      *  252150 - COB component MEC103/GLC48 fails due to FOOB.       *
      *           Amend the program to match MOD/GLAMADUPD process    *
      *           when closing an account that is inserted the same   *
      *           day. Recompiled over changes ZSRSRC.RTACLSC1        *
      *           Applied for AR980794 (Child: AR980795)              *
      *  263834 - Account with Swift reference is deleted causing     *
      *           MEC105 fallover. Amended program in a way that      *
      *           that deletion is not allowed when record exists in  *
      *           file SWACSSB. Applied fix 263818.                   *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016 - German Interest Calculation: Upgarde of FGE059      *
      *           to Midas Plus (Recompile)                           *
      *  CER047 - German Features LF037-00 Reporting §24c KWG         *
      *           (Recompile)                                         *
      *  BUG27532 - Several fields are blank in the confirmation page *
      *             (Recompile)                                       *
      *  BUG27045A - Override the fix of Bug 27045 (Recompile)        *
      *  BUG27045 - Amend via SOAP removes Document Linkage           *
      *             (Recompile)                                       *
      *  CAP205 - Teller Related APIs - Account Balance Check         *
      *  CAP204 - Teller Related APIs - Account Transfer (Recompile)  *
      *  CRE401 - 4-Eyes Checking Gaps - Sweeps (Recompile)           *
      *  CDL081 - Tiered withholding tax rounding upgrade             *
      *  260297 - Incorrect interest calculation w/ calc basis 6.     *
      *           Recompiled over changes in RTINDEF1 and RTINDEF2.   *
      *           Applied fix 220323.                                 *
      *  BUG15976A - Recompile due to changes in RE4121DF             *
      *  253689 - Check for outstanding sweep accounts by using       *
      *           full account number and retail account number       *
      *           as search keys (BUG17640)                           *
      *  BUG15976 - Screen looks as if text is overwritten            *
      *  250891 - Initialise field @SKIP.                             *
      *  249968 - Add Validations if there are Outstanding            *
      *           Held Items, Stopped Checks, Standing Orders         *
      *           and SWEEP before an account is close.               *
      *  249179 - Extend account code variable.  Recompile due to     *
      *           changes in /copy RTASGLC1.                          *
      *  242286 - Recompile over changes in /COPY RTINTRE.            *
      *  CDL013 - Tiered Withholding Tax                              *
      *  165543 - Wrong CCY for Account Closure.                      *
      *           Recompile for changes in ZSRSRC/RTCLOSC1.           *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  BUG8798 - (Reopen) There is no display of DR/CR indicator    *
      *  BUG8798 - Wrong heading show on advice (Recompile)           *
      *  BUG8514 - Issue regarding teller overrides(Recompile)        *
      *  CRT026  - Retail Teller Password Change                      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  BUG8067 - Add Transaction Time (Recompile)                   *
      *  BUG6342 - Interest calculation has 0.01 discrepancy.         *
      *            Recompiled over changes in RTINDEF1/2 and RTINTRE. *
      *            Applied fix 220323.                                *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CAAA03 - Webfacing changes(re-compile)                       *
      *  CRE019 - Cheque Processing and Maintenance (Recompile)       *
      *  CGL029 - Increase Account Code to 10 digits (Recompile)      *
     F*  CRT012 - Midas/Cashier Interface - Multiple Charges          *
     F*           Recompile                                           *
     F*  CRT007 - Cashier Branch Offline Checking                     *
     F*  CRT005 - Recompiled due to changes in RTTWIDC1               *
      *  194978 - Recompiled due to changes in RTTWIDC1 and RTODCKC1. *
      *  CRT006 - Cashier Reserve Transactions.                       *
      *  CDE002 - Revenue Analysis - Recompiled due to changes in     *
      *           PF/REFXAJL0.                                        *
     F*  101578 - Recompile due to changes in RTCCYXC1                *
     F*  CSD006 - Use DSSDY for call to AOCURRR0.                     *
     F*  145752 - Recompile due to changes in COPY source RTBALCC1.   *
     F*  176443 - Avoid MCH3601 to be sent.                           *
     F*           Pass correct parameter to AOCUSTR0.                 *
      *  176510 - Account Officer added to AOPRFMR0 call and the      *
      *           Profit Centre validated only when a valid           *
      *           Transaction Type is entered.                        *
      *  153001 - A/c failed to close because minimum charge posted   *
      *           so balance was not zero. File RECRG no longer used  *
      *           as actual charges shown, ie. no minimum or maximum. *
      *           Includes changes to /COPYs RTCHRGC1, RTCLSCC1 &     *
      *           RTCOMMC1.                                           *
      *  CSD005 - Standing Data Account Narrative.  Add new field     *
      *           to SDACODPD.  Recompilation of programs.            *
      *  CTI002 - Recompiled : File SDACODPD changed                  *
     F*  140802 - /COPY RTCCYSC1 changes.  Change currency validation *
     F*           to check for @RTCD instead of *IN80 (not used)      *
     F*  106661 - Include Closing Account projected movements         *
     F*           in RSACMTPD to allow passbook printing.             *
     F*           Note that this may cause a problem if Closed        *
     F*           Accounts (RECI = C) are allowed to have passbooks   *
     F*           printed in that these entries may be printed twice. *
     F*           This is not the case at the moment.(Upgrade 073990).*
     F*  110130 - Transaction is not accepted for saving accounts     *
     F*  114621 - Replace blank with 'X' to mean not to validate      *
     F*           condition.                                          *
     F*  CRT002 - Retail Branch Access.                               *
     F*           Introduce /COPY RTCCYSF1 needed when using /COPY    *
     F*           RTCCYSC1.                                           *
     F*  CCB002 - COB Performance Enhancements                        *
     F*           Access now via access object                        *
     F*           Change MEMOS processing to use access objects.      *
     F*  S01408 - Addition of hook RE4121CP15 - EEE002                *
     F*           Addition of hook RE4121CP14 - EEE002                *
     F*           Addition of hook RE4121CP13 - EEE002                *
     F*           Addition of hook RE4121CP12 - EEE002                *
     F*           Addition of hook RE4121CP11                         *
     F*  S01408 - Addition of hook RE4121FFP1.- EEE002 EAU016         *
     F*           Addition of hook RE4121EEP1.- EAU016                *
     F*           Addition of hook RE4121CCP8.- EAU016                *
     F*           Addition of hook RE4121CCP9.- EAU016                *
     F*           Addition of hook RE4121CP10.- EAU016                *
     F*           Addition of hook RE4121OOP1.- EAU016                *
     F*  093546 - Recompile due to changes in DSPF/RE4121DF -- text   *
     F*           amendment and alignment of fields.                  *
     F*  093545 - Recompile due to changes in PRTF/RE4121P1 --        *
     F*           standardize pagesize.                               *
     F*  S01408 - Addition of hook RE4121IIP1.- EEE002                *
     F*           Addition of hook RE4121IIP2.                        *
     F*           Addition of hook RE4121CCP1.                        *
     F*           Addition of hook RE4121CCP2.                        *
     F*           Addition of hook RE4121CCP3.                        *
     F*           Addition of hook RE4121CCP4.- EEE002                *
     F*           Addition of hook RE4121CCP5.- EAU016                *
     F*           Addition of hook RE4121CCP6.                        *
     F*           Addition of hook RE4121CCP7.                        *
     F*  091241 - ATM Interface.  Recompiled.                         *
     F*  CRT001 - Retail Teller System.                               *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F*
     FRE4121P1O   E                    PRINTER      KINFDS SPOOL      UC
     F**  Validation Prints
     F*
     FRSACMTPDO   E                    DISK         KINFSR *PSSR
     F**  Shadow posting file
     F                                              KCOMIT
     F*
     FACCNT   UF  E           K        DISK         KINFSR *PSSR      UC
     F**  Account master
     F                                              KCOMIT
     F*
     FTTRANPD O   E                    DISK         KINFSR *PSSR
     F**  Teller Transactions Details
     F                                              KCOMIT
     F*
     FTTRANPT UF  E                    DISK         KINFSR *PSSR
     F**  Teller Transactions Trailer
     F                                              KCOMIT
      *                                                                                       249968
     FHELDITL0IF  E           K        DISK                                                   249968
      ** Held Items                                                                           249968
     FSTOPCL3 IF  E           K        DISK                                                   249968
     F            STOPCSDF                          KRENAMESTOPCSL3                           249968
      ** Stopped cheques detail                                                               249968
      *                                                                                       249968
     FSTANDL4 IF  E           K        DISK                                                   249968
      ** Standing Orders                                                                      249968
      *                                                                                       249968
     FSTANDL5 IF  E           K        DISK                                                   249968
     F            STANDSBF                          KRENAMESTANDSBG                           249968
      ** Standing Orders                                                                      249968
      *                                                                                       249968
     FRESWEPL5IF  E           K        DISK                                                   249968
     F            RESWEPD0                          KRENAMERESWEP5F                           253689
     FRESWEPL7IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP7F                           253689
     FRESWEPL8IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP8F                           253689
     FRESWEPL6IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP6F                           253689
      ** SWEEP                                                                                249968
      *                                                                                       249968
     F*
     F**RECRG***IF  E           K        DISK                         UC  153001
     F****Retail*charges*file                                             153001
     F*
     FREIAC   IF  E           K        DISK                           UC
     F**  Retail interest and charges
     F*
     FREACR   IF  E           K        DISK                           UC
     F**  Retail interest accrual ITD
     F*
     FACNUM   IF  E           K        DISK
     F**  Account Numbers Cross Reference File
     F            ACCNTABF                          KRENAMEACNUMABF
     F*
     FTTRNT   UF  E           K        DISK         KINFSR *PSSR
     F**  Teller Controls/Totals
     F                                              KCOMIT
     F*
     F*********MEMOS   UF  E                    DISK         KINFSR *PSSR CCB002
     F***********  Retail Shadow Balances                                 CCB002
     F***********                                              KCOMIT     CCB002
     F*
     FREFXAJL0IF  E           K        DISK
     F**  RE-Fixed accounts join logical file
     FSDSTAXPDIF  E                    DISK                           UC
     F**  SD Tax File
      *                                                                                       CDL013
     FACCNTBY0IF  E           K        DISK                           UC                      CDL013
     FSDSTAAL1IF  E           K        DISK                           UC                      CDL013
      *                                                                                       CDL013
     F*
     FSWACB   IF  E           K        DISK         KINFSR *PSSR                              263834
     F            SWACSSAF                          KIGNORE                                   263834
     F            SWACSSCF                          KIGNORE                                   263834
      *                                                                                       263834
     FRE4121DFCF  E                    WORKSTN
     F** Display file - Retail account transfer
     F*
     F/COPY ZSRSRC,RTCOMMF1
     F*
     F/COPY ZSRSRC,RTINDEF3
     F*
     F/COPY ZSRSRC,RTCCYSF1                                               CRT002
     F*                                                                   S01408
     F/COPY WNCPYSRC,RE4121FFP1                                           S01408
     F*                                                                   S01408
     F/EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*    10         Message Subfile End Indicator (SFLEND)          *
     F*    15         Error in profit centre                          *
     F*    16         Profit Centre used                              *
     F*                                                               *
     F*    20         Display transaction terminated message          *
     F*    21         Display "OVERRIDE REQUIRED" message             *
     F*    22         Display terminal or warning message codes       *
     F*    26         Display override prompt                         *
     F*    27         Display underline attributes                    *
     F*    28         Display account balances                        *
     F*    29         Display account closing balances                *
     F*                                                               *
     F*    30         Error in retail a/c number                      *
     F*    31         Error in currency code                          *
     F*    32         Error in transaction type 1                     *
     F*    33         Error in amount 1                               *
     F*    34         Error in transaction type 2                     *
     F*    35         Error in amount 2                               *
     F*    36         Error in value date                             *
     F*    37         Error in department code                        *
     F*    38         Error in override teller identifier             *
     F*    39         Error in override passcode                      *
     F*                                                               *
     F*    40         Account closure selected                        *
     F*    41         Account closure successful                      *
     F*    42         Account closure unsuccessful                    *
     F*    45         Display "TRANSACTION COMPLETED" message         *
     F*                                                               *
     F*    50         2nd Transaction Entered                         *
     F*    54         Display override user id / password             *                       CRT026
     F*                                                               *
      *    65         NR indicator for SWACB                          *                       263834
     F*    67         Update indicator                                *
     F*    68         Unsuccessful override                           *
     F*    69         Validation error                                *
     F*                                                               *
     F*    70         Record not found                                *
     F*    76         Display Withholding Tax                         *
     F*                                                               *
     F*   80-89       Standard RTS subroutines                        *
     F*                                                               *
     F*   90-99       Standard MIDAS subroutines                      *
     F*                                                               *
     F*    KA         Work with transactions                          *
     F*    KB         Display account balances                        *
     F*    KC         Exit program                                    *
     F*    KE         Refresh screen                                  *
     F*    KJ         A/C closure enquiry                             *
     F*    KL         Previous                                        *
     F*                                                               *
     F*    U6         System error                                    *
     F*   U7-U8       Database error occurs                           *
     F*                                                               *
     F*****************************************************************
     F/EJECT
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  Control Subroutines                                          *
     F*                                                               *
     F*  ACLOSE - A/C closure enquiry                                 *
     F*  ACCDET - Accept details                                      *
     F*  CHKACC - Check account status                                *
     F*  DBERR  - Database error handling                             *
     F*  FIRST  - Initial Processing                                  *
     F*  LAST   - Final Processing                                    *
     F*  MAIN   - Main Processing                                     *
     F*  SNDMSG - Send program message parameters                     *
     F*  WRKACC - Work with account                                   *
     F*  WRKDET - Work with details                                   *
     F*  WRKOVR - Work with override                                  *
     F*  WRKTRN - Work with transaction                               *
     F*  *PSSR  - Program error                                       *
     F*                                                               *
     F*  Screen Handling                                              *
     F*                                                               *
     F*  DSPBAL - Display account balances                            *
     F*  DSPDET - Display combined cash & cheque details              *
     F*  DSPINL - Display initial screen                              *
     F*  DSPOVR - Display overrride screen                            *
     F*  EXTDET - Exit details screen                                 *
     F*  EXTOVR - Exit override screen                                *
     F*                                                               *
     F*  Screen Initialisation / Resets                               *
     F*                                                               *
     F*  RFRDET - Refresh details screen                              *
     F*  RFRERR - Refresh warning/terminal error screen               *
     F*  RFRINL - Refresh initial screen                              *
     F*  RFROVR - Refresh override screen                             *
     F*                                                               *
     F*  Validation Subroutines                                       *
     F*                                                               *
     F*  VACCLO - Validate account closure                            *
     F*  VALINL - Validate initial screen                             *
     F*  VALTRN - Validate transaction                                *
     F*  VALDET - Validate details                                    *
     F*  VALOVR - Validate override                                   *
     F*  VOCOND - Validate override conditions                        *
     F*  VSACNO - Validate account number                             *
     F*  VSCCY  - Validate currency code                              *
     F*  VSTYP1 - Validate transaction type   1                       *
     F*  VSTAM1 - Validate transaction amount 1                       *
     F*  VSTYP2 - Validate transaction type   2                       *
     F*  VSTAM2 - Validate transaction amount 2                       *
     F*  VSVLDT - Validate value date                                 *
     F*  VSDEPC - Validate department code                            *
     F*  VSPRFC - Validate profit centre                              *
     F*  VTCOND - Validate teller transaction conditions              *
     F*                                                               *
     F*  Updates Subroutines                                          *
     F*                                                               *
     F*  UACNUM - Update accounts                                     *
     F*  UMEMOD - Update debit memos                                  *
     F*  UPDATE - Update control                                      *
     F*  UTNTM2 - Update teller controls                              *
     F*  UTNTM3 - Update teller totals                                *
     F*  UTRANT - Update teller transaction trailer                   *
     F*  WRSACM - Write shadow postings                               *
     F*  WRSAC2 - Write shadow postings for Closure capitalisation.   *   106661
     F*  WTRAND - Write teller transacton details                     *
     F*                                                               *
     F*  Printing Subroutines                                         *
     F*                                                               *
     F*  PRTTRN - Print transaction                                   *
     F*                                                               *
     F*  Standard RTS Subroutines                                     *
     F*                                                               *
     F*  RTABAL - Account available balance check                     *
     F*  RTACLG - Account closing check                               *
     F*  RTACLS - Account closure updates                             *
     F*  RTBALC - Calculate available balances                        *
     F*  RTBDPT - Bad Debt check                                      *
     F*  RTBKCR - Block credit check                                  *
     F*  RTBKDR - Block debit check                                   *
     F*  RTBKPT - Bankrupt/Liquidation check                          *
     F*  RTRFCR - Refer credit check                                  *
     F*  RTRFDR - Refer debit check                                   *
     F*  RTBRCH - Branch different check                              *
     F*  RTBVIC - Backvalue check                                     *
     F*  RTCCYS - Currency setup                                      *
     F*  RTCCYX - Convert an amount from one ccy to another: xchge rte*
     F*  RTCHRG - Calculate charges                                   *
     F*  RTCLSC - Calculate close details                             *
     F*  RTCLSE - Close account condition check                       *
     F*  RTIACT - Inactive account check                              *
     F*  RTINTR - Calculate interest                                  *
     F*  RTLCNV - Local currency conversion                           *
     F*  RTTCCY - Teller currency conditions check                    *
     F*  RTTLMT - Teller limit check                                  *
     F*  RTTOTS - Teller total updates                                *
     F*  RTTWID - Teller workstation conditions check                 *
     F*  RTWDAY - Non-working day check                               *
     F*  RTENCP - Encript passcode                                    *
     F*  RTCOMM - Calculate commission for account close              *
     F*  RTASGL - No associated GL code check                         *
     F*  RTODCK - Exceed overdraft check                              *
     F*  INTCAL - Interest calculation                                *
     F*  ZICD   - Find number of days to calculate interest           *
     F*  ZIC00  - Calculate interest for type 00                      *
     F*  ZIC01  - Calculate interest for type 01                      *
     F*  ZIC02  - Calculate interest for type 02                      *
     F*  DRINIT - Debit rates loading                                 *
     F*  CRINIT - Credit rates loading                                *
     F*  DATEIN - Date initialisation processing                      *
     F*                                                               *
     F*  Standard MIDAS Subroutines                                   *
     F*                                                               *
     F*  ZACCH  - Access a holiday record for a particular            *
     F*           location                                            *
     F*  ZALIGN - Validate amount fields                              *
     F*  ZCHKH  - Determine whether a given date is a                 *
     F*           holiday for a particular currency                   *
     F*  ZDATE1 - Validate dates submitted and convert to a           *
     F*           number of days                                      *
     F*  ZDATE2 - Convert date to dayno. to date formats              *
     F*  ZFRPED - Format and edit amount field                        *
     F*  ZFWDT  - Calculate the number of working day                 *
     F*           forward from a given start date for any             *
     F*           particular currency                                 *
     F*  ZTNLU1 - Access dataarea for next transaction no.            *
     F*                                                               *
     F*  External Subroutines                                         *
     F*                                                               *
     F*  SCC0250 - Clear message queue                                *
     F*  SCC0240 - Send program message queue                         *
     F*                                                               *
     F*  DBERRCTL Program error                                       *
     F*                                                               *
     F*  Access Object Programs                                       *
     F*                                                               *
     F*  AOBANKR0 - Access bank ICD details                           *
     F*  AORETRR0 - Access retail transaction details                 *
     F*  AODEPTR0 - Access department code details                    *
     F*  AORETLR0 - Access retail ICD details                         *
     F*  AOGELRR0 - Access general ledger details                     *
     F*  AOCUSTR0 - Access customer details                           *
     F*  AOACODR0 - Access account code details                       *
     F*  AOCURRR0 - Access currency details                           *
     F*  AOTELDR0 - Access teller details                             *
     F*  AOFNCDR0 - Access function code details                      *
     F*  AOPRFCR0 - Access profit centre details                      *
     F*  AOPRFMR0 - Profit centre default retrieval                   *
     F*                                                               *
     F*****************************************************************
     E/EJECT
     E*****************************************************************
     E*
     E**  Compile time arrays
     E*
     E/COPY WNCPYSRC,RE4121EEP1                                           S01408
     E*
     E                    CPY@    1   1 80
     E**  Copyright statement
     E*
     E                    POWER   1   7  7 3
     E**  Power array
     E*
     E/COPY ZSRSRC,ZDATE2Z1
     E**  Array for SR.ZDATE1, SR.ZDATE2
     E*
     E/COPY ZSRSRC,RTENCPE1
     E**  Array for SR.RTENCP
     E*
     E/COPY ZSRSRC,RTXXXXE1
     E**  Array for SR.RTBKDR, SR.RTBKCR, SR.RTRFDR, SR.RTRFCR, SR.RTIACT
     E*
     E*
     E*
     E**  Execution time arrays
     E*
     E*
     E                    @CY        24  3
     E**  Teller currencies array
     E*
     E/COPY ZSRSRC,ZALIGNZ1
     E**  Array for both SR.ZALIGN, SR.ZEDIT
     E*
     E/COPY ZSRSRC,ZFRPEDZ1
     E**  Array for SR.ZFRPED
     E*
     E/COPY ZSRSRC,ZHOLE
     E**  Array for SR.ZACCH, SR.ZCHKH
     E*
     E/COPY ZSRSRC,RTCCYSE1
     E**  Array for SR.RTCCYS
     E*
     E/COPY ZSRSRC,RTCOMME1
     E**  Array for SR.RTCOMM
     E*
     E/COPY ZSRSRC,RTINDEF1
     E**  RTS arrays definition
     E/COPY WNCPYSRC,RE4121E001
     E*
     E*****************************************************************
     I/EJECT
     I*****************************************************************
     I*
     ITTRANPTF
     I**  Renamed fields in PF/TTRANPT
     I              NORE                            TTNORE
     I*
     I*
     ISTANDSBF                                                                                249968
      ** Renamed fields in LF/STANDL4                                                         249968
     I              TRAT                            BRAT                                      249968
     ISTANDSBG                                                                                249968
      ** Renamed fields in LF/STANDL5                                                         249968
     I              TRAT                            CRAT                                      249968
     ITTRNTM2F
     I**  Renamed fields in PF/TTRNTM2
     I              RECI                            T2RECI
     I              NATN                            T2NATN
     I              RUND                            T2RUND
     I*
      ** Rename fields to prevent overwrite                                                   263834
      *                                                                                       263834
     ISWACSSBF                                                                                263834
     I              RECI                            RECISW                                    263834
     I              CNUMA                           CNUMSW                                    263834
     I              CCY                             CCYSW                                     263834
     I              ACODQQ                          ACDQSW                                    263834
     I              ACSQ                            ACSQSW                                    263834
     I              CFSB                            CFSBSW                                    263834
     I              LSTD                            LSTDSW                                    263834
     I              NSTD                            NSTDSW                                    263834
     I              ACNO                            ACNOSW                                    263834
     I              STFQ                            STFQSW                                    263834
     I              STDY                            STDYSW                                    263834
     I              LSNO                            LSNOSW                                    263834
     I              UPRI                            UPRISW                                    263834
     I              DDIS                            DDISSW                                    263834
     I              BRCA                            BRCASW                                    263834
     I              IND                             INDSW                                     263834
     I              ZZ006                           ZZ06SW                                    263834
     I              LCD                             LCDSW                                     263834
     I              CHTP                            CHTPSW                                    263834
     I              TNLU                            TNLUSW                                    263834
     I              MT94                            MT94SW                                    263834
     I              ACOD                            ACODSW                                    263834
      *                                                                                       263834
     IACNUMABF
     I**  Renamed fields in LF/ACNUM
     I              CCY                             ACCY
     I/COPY WNCPYSRC,RE4121I001
     I*
     I*
     I/COPY ZSRSRC,RTINDEF4
     I**  Renamed fields in LF/REHRCJ and LF/REHRDJ files
     I*
     I*
     I            DS
     I**  12 Character key
     I                                        1  12 @KEY
     I                                        2   30@CHGT
     I                                        4   80@CHST
     I                                        9  11 @CHCY
     I                                       12  12 @DDDD
     I*
     I*
     I            DS                             72
     I**  Data structure to initialise arrays
     I                                        1  72 CCYR1
     I                                        1  72 @CY
      *                                                                   CCB002
     IUMEMER      DS                                                      CCB002
      ** Data structure for database error on call to AOMEMSR0.           CCB002
     I**********                              1   60U0CNUM                             CCB002 CSD027
     I                                        1   6 U0CNUM                                    CSD027
     I                                        7   9 U0CUCD                CCB002
     I**********                             10  130U0ACCD                             CCB002 CGL029
     I**********                             14  150U0ACSQ                             CCB002 CGL029
     I**********                             16  18 U0BRCA                             CCB002 CGL029
     I                                       10  190U0ACCD                                    CGL029
     I                                       20  210U0ACSQ                                    CGL029
     I                                       22  24 U0BRCA                                    CGL029
     I*
     I*
     I            DS
     I**  Data structure to hold key fields of LF/TTRNT
     I                                        1   5 @TTRNT
     I                                        1   1 KTBRI
     I                                        2   4 KTBID
     I                                        5   5 KRCTP
     I*
     I*
     I@VDS        DS
     I**  Data structure to initialise validation indicators
     I                                        1  25 VWIN
     I                                        1  25 @V
     I*
     I*
     ISPOOL       DS
     I**  File information data structure
     I                                       83  92 SFILE
     I                                    B 123 1240SFNUM
     I*
     I*
     IRUNDT       DS
     I**  Data area RUNDAT
     I                                        1   7 RUNA
     I                                    P   8  100RUND
     I                                       11  11 SSF
     I                                       12  12 DATF
     I                                       13  13 MBIN
     I*
     I*
     IZMUSER      DS                             17
     I**  Data area of menu user
     I                                        1  10 USRPRF
     I*
     I*
     ICMTTXT      DS                            256
     I**  Commitment Control Commit Text
     I                                        1   50NATN
     I                                        6   7 MDID
     I                                        8  15 PGMN
     I                                       16  18 WSIDX
     I                                       19  240MTIME
     I                                       25  25 ACTCDX
     I                                       26  35 USRIDX
     I*
     I**  Data structure for initial screen
     I                                       51 100 @INLDS
     I                                       51  60 SACNO1
     I                                       61  63 SCCY1
     I*
     I**  Data structure for details screen
     I                                      101 200 @DETDS
     I                                      101 105 STYP1
     I                                      106 119 STAM1
     I                                      120 124 STYP2
     I                                      125 138 STAM2
     I                                      139 144 SVLDT
     I                                      145 147 SDEPC
     I                                      148 151 SPRFC
     I*
     I** Data structure for override screen
     I                                      201 256 @OVRDS
     I                                      201 203 SOVTI
     I                                      204 209 SOVPC
     I                                      210 219 SOVUR                                     CRT026
     I                                      220 229 SOVPW                                     CRT026
     I*
     I*
     I/COPY ZSRSRC,RTXXXXI1
     I**  Data structure to positions of validation indicators
     I*
     I/COPY ZSRSRC,RTXXXXI2
     I**  Data structure for 15 character account number
     I*
     I/COPY ZSRSRC,ZHOLI
     I**  Data structure for SR.ZACCH, SR.ZCHKH, SR.ZFWDT
     I*
     I/COPY ZSRSRC,RTTOTSI1
     I**  Data structures definitions for SR.RTTOTS
     I*
     I/COPY ZSRSRC,ZFRPEDZ2
     I**  Data structure for SR.ZFRPED
     I*
     I*                                                                   S01408
     I/COPY WNCPYSRC,RE4121IIP1                                           S01408
     I*                                                                   S01408
     I/COPY ZSRSRC,RTCOMMI1
     I**  Data structure for SR.RTCOMM
     I*
     I/COPY ZSRSRC,RTINDEF5
     I**  RTS data structure definitions
     I*
     I/COPY ZSRSRC,ZTNLU1Z1
     I**  Array for SR.ZTNLU1
     I*
     I/COPY ZSRSRC,ZHOLDS
     I**  Data structure for SR.ZACCH
     I*
     I*
     IRTSDTA     UDS                            256
     I**  RTS job data area data structure
     I                                        1   3 PTLID
     I                                        4   6 PTLBC
     I                                        7   7 PSPVI
     I                                        8  32 POVIN
     I                                    P  33  390PCHTL
     I                                    P  40  460PNCTL
     I                                       47  76 PTLNM
     I                                       77  800PTLMG
     I                                       81  840PTLSL
     I                                       85  890PTLTO
     I                                       90  92 PDEPC
     I*
     I*
     ILDA         DS                            256
     I**  Local data area for data base errors.
     I                                        1   3 ERTLID
     I                                       11  20 ERTWID
     I                                       21  30 ERWSID
     I                                      134 183 DBLOT
     I**  Field combining the following fields
     I                                      134 141 DBFILE
     I**  Name of database file in error
     I                                      142 170 DBKEY
     I**  Key value causing database error
     I                                      172 180 DBPGM
     I**  Name of program causing database error
     I                                      181 1830DBASE
     I**  Number of database error
     I*
     I*
     IPSDS       SDS
     I**  Program Status Data Structure
     I*
     I                                        1  10 @PGM
     I**  Field containing program ID
     I*
     I                                      244 253 @JOB
     I**  Field containing workstation ID
     I*
     I                                      254 263 @USER
     I**  Field containing user ID
     I*
     I*
     II#PARM      DS                           1024                                           CCG016
      ** Passed fields                                                                        CCG016
      **  Classification                                                                      CCG016
     I                                        1   3 I#BRCT                                    CCG016
     I                                        4   6 I#TLID                                    CCG016
     I                                        7   9 I#TBID                                    CCG016
     I                                       10  14 I#TBTN                                    CCG016
     I                                       15  17 I#FUNC                                    CCG016
     I                                       18  18 I#CLOS                                    CCG016
     I**********                             19  28 I#CHQN                           CCG016 MD042745
     I                                       19  30 I#CHQN                                  MD042745
      **  Accounts single, dr and cr                                                          CCG016
     I                                       41  46 I#CNUM                                    CCG016
     I                                       47  49 I#CCY                                     CCG016
     I                                       50  59 I#ACOD                                    CCG016
     I                                       60  61 I#ACSQ                                    CCG016
     I                                       62  64 I#BRCA                                    CCG016
     I                                       41  64 I#GLAR                                    CCG016
     I                                       65  74 I#ACNO                                    CCG016
     I                                       77  82 I#CNU1                                    CCG016
     I                                       83  85 I#CCY1                                    CCG016
     I                                       86  89 I#ACO1                                    CCG016
     I                                       90  91 I#ACS1                                    CCG016
     I                                       92  94 I#BRC1                                    CCG016
     I                                       77  94 I#GLA1                                    CCG016
     I                                       95 104 I#ACN1                                    CCG016
     I                                      107 112 I#CNU2                                    CCG016
     I                                      113 115 I#CCY2                                    CCG016
     I                                      116 119 I#ACO2                                    CCG016
     I                                      120 121 I#ACS2                                    CCG016
     I                                      122 124 I#BRC2                                    CCG016
     I                                      107 124 I#GLA2                                    CCG016
     I                                      125 134 I#ACN2                                    CCG016
      **  Transaction dets                                                                    CCG016
     I                                    P 137 1440I#AMNT                                    CCG016
     I                                      145 147 I#CCYT                                    CCG016
     I                                      148 198 I#NARR                                    CCG016
     I                                    P 199 2060I#CHQA                                    CCG016
     I                                    P 207 2138I#EXRT                                    CCG016
     I                                    P 217 2240I#BUYA                                    CCG016
     I                                      225 227 I#BUYC                                    CCG016
     I                                    P 228 2350I#SELA                                    CCG016
     I                                      236 238 I#SELC                                    CCG016
     I                                      239 288 I#NAR1                                    CCG016
     I                                      289 338 I#NAR2                                    CCG016
     I                                    P 347 3540I#INTA                                    CCG016
     I                                      355 357 I#INTC                                    CCG016
     I                                      358 407 I#INTN                                    CCG016
     I                                    P 417 4240I#TAXA                                    CCG016
     I                                      425 427 I#TAXC                                    CCG016
     I                                      428 477 I#TAXN                                    CCG016
     I                                    P 487 4940I#CHGA                                    CCG016
     I                                      495 497 I#CHGC                                    CCG016
     I                                      498 557 I#CHGN                                    CCG016
     I                                    P 567 5740I#TOTA                                    CCG016
     I                                      575 577 I#TOTC                                    CCG016
     I                                      578 627 I#TOTN                                    CCG016
     IO#PARM      DS                            256                                           CCG016
     I                                        1  10 O#ITEM                                    CCG016
     I                                       11  20 O#CUST                                    CCG016
     I                                       21  25 O#RSEQ                                    CCG016
     I                                       26  26 O#RLVL                                    CCG016
     I                                       27  29 O#RBCH                                    CCG016
     I                                       30  30 O#RARC                                    CCG016
      *                                                                                       CCG016
     ISDBANK    E DSSDBANKPD
     I**  Midas Bank details
     I*
     ISDBRCH    E DSSDBRCHPD
     I**  Midas Branch Code details
     I*
     ISDCURR    E DSSDCURRPD
     I**  Midas Currency details
     I*
     ISDDEPT    E DSSDDEPTPD
     I**  Midas Department details
     I*
     ISDFNCD    E DSSDFNCDPD
     I**  Midas Function Code details
     I*
     ISDRETL    E DSSDRETLPD
     I**  Midas Retail ICD details
     I*
     ISDRETR    E DSSDRETRPD
     I**  Midas Retail Transaction details
     I*
     ISDTELD    E DSSDTELDPD
     I**  Midas Teller ID details
     I*
     ISDCUST    E DSSDCUSTPD
     I**  Midas Customer details
     I*
     I              QQDFAC                          QQDFC1                                    CGL029
     ISCSARD    E DSSCSARDPD                                              CRT002
     I** Switchable SARs                                                  CRT002
     I*                                                                   CRT002
     ISDACOD    E DSSDACODPD
     I**  Midas Account Codes details
     I*
     I              QQACCD                          QQACD1                                    CGL029
     ISDPRFM    E DSSDPRFMPD
     I** Profit Centre Default Matrix Retrieval Index
     I*
     ISDPRFC    E DSSDPRFCPD
     I** Profit Centre Details
     I*
     ISDGELR    E DSSDGELRPD
     I** General Ledger Details
     I*
     I              QQACCD                          QQACD2                                    CGL029
     IDSMEMS    E DSMEMOS                                                 CCB002
     I** External data structure for MEMOS Details                        CCB002
     I** Renamed fields in PF/MEMOS                                       CCB002
     I              CNUM                            MECNUM                CCB002
     I              ACOD                            MEACOD                CCB002
     I              ACSQ                            MEACSQ                CCB002
     IDSFDY     E DSDSFDY
     I**  First DS for Access Programs, short data structure
     I*                                                                   S01408
     I/COPY WNCPYSRC,RE4121IIP2                                           S01408
     I*                                                                   S01408
     IMUSER     E DSMUSERDD                                                                   CRT026
     I** External data structure for User Details                                             CRT026
     I** Renamed fields in PF/MUSERDD                                                         CRT026
     I              RECI                            RECIU                                     CRT026
     I              LCD                             LCDU                                      CRT026
      *                                                                                       CRE081
     IZONEDP      DS                                                                          CRE081
     I                                        1  100PRTAC                                     CRE081
     I                                       11  200PACOD                                     CRE081
     I                                       21  220PASEQ                                     CRE081
     I                                       23  270PVLDAT                                    CRE081
     I                                       28  420PAMT                                      CRE081
     I                                       43  570PACBAL                                    CRE081
     I                                       58  720PAVBAL                                    CRE081
     I                                       73  770PFLDAT                                    CRE081
     I                                       78  920PFLBAL                                    CRE081
      *                                                                                       CDL081
      ** Named constants                                                                      CDL081
      *                                                                                       CDL081
     I              'BasCcyTaxRoundDown'  C         C#BASE                                    CDL081
     I              'NBasCcyTaxRoundDown' C         C#NBAS                                    CDL081
     I              'RIBALENQY'           C         RIBALQ                                AR1087355C
     I*
     I*****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*            MAIN   - Main Control Processing                   *
     C*                                                               *
     C* CALLS      ACLOSE - A/C closure enquiry                       *
     C*            DSPINL - Display initial screen                    *
     C*            FIRST  - Initial Processing                        *
     C*            LAST   - Final Processing                          *
     C*            RFRINL - Refresh initial screen                    *
     C*            WRKACC - Work with account                         *
     C*                                                               *
     C* CALLED BY         -                                           *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C*
     C                     MOVEACPY@      BIS@   80
     C*
     C**  Initial Processing
     C*
     C                     EXSR FIRST
      *                                                                                       250891
      ** Initialise Skip Update Flag to 'N'                                                   250891
     C                     MOVEL'N'       @SKIP   1                                           250891
      *                                                                                       250891
     C*
     C**  Main Processing
     C*
     C**  Refresh initial screen
     C*
     C                     EXSR RFRINL
     C*
     C**  Display initial screen
     C*
     C                     EXSR DSPINL
     C*
     C**  Do while Cmd/3 is not pressed
     C*
     C           *INKC     DOWEQ'0'
      *                                                                   106661
      ** Save the Closure intention for the Close Balance check.          106661
     C           *INKJ     IFEQ '1'                                       106661
     C                     MOVE 'Y'       CLREQ   1                       106661
     C                     ELSE                                           106661
     C                     MOVE 'N'       CLREQ                           106661
     C                     END                                            106661
     C*
     C**  If Cmd/5 is pressed, refresh initial screen
     C*
     C           *INKE     CASEQ'1'       RFRINL
     C*
     C** If Cmd/10 is pressed, perform account closure enquiry
     C*
     C           *INKJ     CASEQ'1'       ACLOSE
     C*
     C**  If Enter key is pressed, work with account
     C*
     C                     CAS            WRKACC
     C*
     C                     END
     C*
     C**  Redisplay initial screen
     C*
     C                     EXSR DSPINL
     C*
     C                     END
     C*
     C**  When Cmd/3 is pressed, perform last processing
     C*
     C                     EXSR LAST
     C*
     C*****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPINL - Display Initial Screen                    *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *            RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPINL    BEGSR                           ** DSPINL **
      *
      ** Display program message subfile for any messages
     C                     WRITERE4121C0
      *
      ** Display warning/terminal error(s) screen
     C**********           WRITERE4121F1                                                    BUG15976
      *
      ** Display and accept initial screen
     C                     EXFMTRE4121F0
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
      ** Clear warning/terminal error screen
     C                     EXSR RFRERR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  DSPINL - Display initial screen                    *
      *            RFRINL - Refresh initial screen                    *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRERR    BEGSR                           ** RFRERR **
      *
     C                     SETOF                     202122
     C                     SETOF                     29
     C                     MOVE *BLANKS   SACNO2
     C                     MOVE *BLANKS   SANAM
     C                     MOVE *BLANKS   SCCY2
     C                     MOVEA*BLANKS   @W
     C                     MOVEA*BLANKS   @T
     C                     MOVEL*BLANKS   SMSG1
     C                     MOVEL*BLANKS   SMSG2
     C                     MOVEL*BLANKS   @MSG1
     C                     MOVEL*BLANKS   @MSG2
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKACC - Work with account                         *
      *                                                               *
      * CALLS      CHKACC - Check account status                      *
      *            RFRINL - Refresh initial screen                    *
      *            RTTWID - Teller workstation conditions check       *
      *            VALINL - Validate initial screen                   *
      *            WRKDET - Work with details                         *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *            ACLOSE - A/C closure enquiry                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKACC    BEGSR                           ** WRKACC **
      *
     C                     SETOF                     4569
      *
      ** If account closure not requested?  validate initial screen
     C           *IN40     IFEQ '0'
     C                     EXSR VALINL
     C                     END
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** Check for multiple sign on
     C                     MOVELPTLID     @TLID
     C                     EXSR RTTWID
      *
      ** If record not found?
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD1         DBASE            ** DB ERR 01 **
     C                     MOVE 'TTRNT'   DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C                     Z-ADDT2NATN    @NATN   50
      *
      ** Check for account terminal conditions
     C                     EXSR CHKACC
      *
      ** If no terminal error(s) exist?
     C           @TI       IFEQ 0
      *
      ** Process transaction details
     C                     EXSR WRKDET
      *
      ** Refresh initial screen
     C                     EXSR RFRINL
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALINL - Validate initial screen                   *
      *                                                               *
      * CALLS      VSACNO - Validate account number                   *
      *            VSCCY  - Validate currency code                    *
      *                                                               *
      * CALLED BY  WRKACC - Work with account                         *
      *            ACLOSE - A/C closure enquiry                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALINL    BEGSR                           ** VALINL **
      *
      ** Set off Validation error fields and indicators
     C                     SETOF                     202122
     C                     Z-ADD0         @TI     20
     C                     Z-ADD0         @WI     20
     C                     MOVE *BLANKS   @W
     C                     MOVE *BLANKS   @T
      *
      ** Validate Account Number
     C           *IN69     CASEQ'0'       VSACNO
     C                     END
      *
      ** Validate Currency Code
     C           *IN69     CASEQ'0'       VSCCY
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSACNO - Validate account number                   *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALINL - Validate initial screen                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSACNO    BEGSR                           ** VSACNO **
      *
      ** Set off error indicator(s)
     C                     SETOF                     30
     C                     SETOF                     70
      *
     C                     MOVE *BLANKS   SACN20 10
     C/COPY WNCPYSRC,RE4121C021
      *
      * Move fields to key list.
     C                     MOVELSACNO1    KACNO
     C                     MOVELKACNO     SACN20
      *
     C           SACNO1    IFNE SACN20
     C           KACNO     ORLT 0
     C                     SETON                     70
     C                     END
      *
      ** Get Account Details
     C           *IN70     IFEQ '0'
     C           KLACNO    CHAINACNUM                70
     C                     END
      *
      ** If debit account number not found?
     C           *IN70     IFEQ '1'
     C                     SETON                     30
     C                     MOVE 'USR0050' @MSGID
     C                     EXSR SNDMSG
     C                     ELSE
     C*
     C**  If account is a 'live' record?
     C*
     C           RECI      IFEQ 'D'
     C*
     C**  set up account details
     C*
     C**********           Z-ADDCNUM      @CNUM                                               CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     Z-ADDACOD      @ACOD
     C                     Z-ADDACSQ      @ACSQ
     C                     Z-ADDRRNM      @RRNM
     C                     MOVE BRCA      @BRCA
     C*
     C**  Account referred must not be closed
     C*
     C                     ELSE
     C                     SETON                     30
     C                     MOVE 'USR0051' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                               *
     C                     END
     C*
     C**  Save customer number for chain to customer file
     C*
     C           *IN30     IFEQ '0'
     C                     MOVE CNUM      @@CNUM  6
     C*
     C**  Get customer name for advice
     C*
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY  '  @OPTN   7
     C                     PARM @@CNUM    @CUST  10
     C                     PARM *BLANKS   @KSTS   7
     C***********SDCUST    PARM SDCUST    DSFDY                           176443
     C           SDCUST    PARM SDCUST    DSSDY                           176443
     C*
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD20        DBASE            ***************
     C                     MOVEL'SDCUSTPD'DBFILE           *DB ERROR 020 *
     C                     MOVEL@CUST     DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR DBERR
     C                     END
     C*
     C                     MOVELBBCRNM    OCUST
     C                     MOVELBBACOC    ACOF    2                       176510
     C/COPY WNCPYSRC,RE4121C001
     C                     END
      *                                                                                       263834
      ** For delete, Account should not have an attached SWACSSB record                       263834
      *                                                                                       263834
     C           *IN40     IFEQ '1'                                                           263834
     C                     MOVELCNUM      WWCNBR                                              263834
     C                     Z-ADDACOD      WWACOD                                              263834
     C                     Z-ADDACSQ      WWACSQ                                              263834
     C                     MOVELBRCA      WWBRCA                                              263834
     C                     MOVELACCY      WWCCY                                               263834
      *                                                                                       263834
     C           SWAKEY    CHAINSWACSSBF             65                                       263834
     C           *IN65     IFEQ '0'                                                           263834
     C           RECISW    ANDNE'*'                                                           263834
     C                     MOVE '1'       *IN30                                               263834
     C                     MOVE '1'       *IN69                                               263834
     C                     MOVE '5045554' ZAMSID                                              263834
     C                     CALL 'Y2SNMGC'                                                     263834
     C                     PARM           ZAPGM                                               263834
     C                     PARM           ZAPGRL                                              263834
     C                     PARM           ZAMSID                                              263834
     C                     PARM           ZAMSGF                                              263834
     C                     PARM *BLANK    ZAMSDA                                              263834
     C                     PARM           ZAMSTP                                              263834
      *                                                                                       263834
      ** Clear all fields for default mechanism next time.                                    263834
      *                                                                                       263834
     C                     MOVEL*BLANK    ZAPGM                                               263834
     C                     MOVEL*BLANK    ZAPGRL                                              263834
     C                     MOVEL*BLANK    ZAMSDA                                              263834
     C                     MOVEL*BLANK    ZAMSTP                                              263834
     C                     ENDIF                                                              263834
     C                     ENDIF                                                              263834
     C*
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CCP8                                           S01408
     C*                                                                   S01408
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSCCY  - Validate currency code                    *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            RTCCYS - Currency setup                            *
      *            DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  VALINL - Validate initial screen                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSCCY     BEGSR                           ** VSCCY  **
      *
      ** Set off error indicator(s)
     C                     SETOF                     31
      *
      ** If currency field is entered?
     C           SCCY1     IFNE ' '
      *
     C           SCCY1     IFEQ '?'
      *
      ** Get currency details
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C           SCCY1     PARM SCCY1     @CCY
     C***********SDCURR    PARM SDCURR    DSFDY                           CSD006
     C           SDCURR    PARM SDCURR    DSSDY                           CSD006
      *
      ** If record found
     C           @RTCD     IFNE *BLANK
     C                     SETON                     3169
     C                     MOVEL'USR0049' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
      ** Currency must be the same as the currency code
      ** of the account referred to?
     C           SCCY1     IFNE ACCY
     C                     SETON                     31
     C                     MOVE 'USR0052' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** Else assume account currency code
     C                     ELSE
     C                     MOVE ACCY      SCCY1
     C                     END
      *
      ** If no validation errors?  get currency details
     C           *IN69     IFEQ '0'
     C                     MOVE SCCY1     @CCY
     C                     EXSR RTCCYS
      *
     C           @RTCD     IFEQ *BLANKS
     C                     Z-ADDTDP,@I    @TCDP
     C                     ELSE
      *
     C           *LOCK     IN   LDA
     C                     MOVE 'SDCURRPD'DBFILE           **************
     C                     MOVEL@CCY      DBKEY            ** DB ERR 02 **
     C                     Z-ADD2         DBASE            ***************
     C                     EXSR DBERR
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            CHKACC - Check account status                      *
      *                                                               *
      * CALLS      RTIACT - Inactive account check                    *
      *            RTBKPT - Bankrupt/Liquidation check                *
      *            RTBDPT - Bad Debt check                            *
      *            RTBRCH - Branch different check                    *
      *            RTACLG - Account closing check                     *
      *                                                               *
      * CALLED BY  WRKACC - Work with account                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           CHKACC    BEGSR                           ** CHKACC **
      *
     C                     MOVE RETB      @RETB
     C                     MOVE SCCY1     SCCY2
     C                     MOVE ANAM      SANAM
     C                     MOVE SACNO1    SACNO2
     C                     MOVE '  '      @ACIN   2
      *
      ** Inactive account check
      *                                                                   114621
     C***********@V,@IA    IFNE ' '                                       114621
     C           @V,@IA    IFNE 'X'                                       114621
     C                     EXSR RTIACT
     C                     END
      *
      ** Bankrupt/Liquidation check
      *                                                                   114621
     C***********@V,@BL    IFNE ' '                                       114621
     C           @V,@BL    IFNE 'X'                                       114621
     C                     EXSR RTBKPT
     C                     END
      *
      ** Bad Debt check
      *                                                                   114621
     C***********@V,@DB    IFNE ' '                                       114621
     C           @V,@DB    IFNE 'X'                                       114621
     C                     EXSR RTBDPT
     C                     END
      *
      ** Branch different check
      *                                                                   114621
     C***********@V,@DF    IFNE ' '                                       114621
     C           @V,@DF    IFNE 'X'                                       114621
     C                     MOVELBRCA      @BRCA
     C                     MOVELPTLBC     @TLBC
     C                     EXSR RTBRCH
     C                     END
      *
      ** Account closing check
      *                                                                   114621
     C***********@V,@AC    IFNE ' '                                       114621
     C           @V,@AC    IFNE ' '                                       114621
     C                     MOVELACST      @ACST
     C                     EXSR RTACLG
     C                     END
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
     C                     SETON                     2022
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
     C                     ELSE
      *
      ** If warning error(s) exist?
     C           @WI       IFGT 0
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
     C                     SETON                     22
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTBKDRC1
      ** Block debit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTRFDRC1
      ** Refer debit check subroutine
      *
      /COPY ZSRSRC,RTIACTC1
      ** Inactive account check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTBKPTC1
      ** Bankrupt/Liquidation check
      *
      /EJECT
      /COPY ZSRSRC,RTBDPTC1
      ** Bad Debt check
      *
      /EJECT
      /COPY ZSRSRC,RTBRCHC1
      ** Branch different check
      *
      /EJECT
      /COPY ZSRSRC,RTACLGC1
      ** Account closing check
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKDET - Work with details                         *
      *                                                               *
      * CALLS      ACCDET - Accept details                            *
      *            DSPDET - Display combined cash & cheque details    *
      *            EXTDET - Exit details    screen                    *
      *            LAST   - Final Processing                          *
      *            RFRDET - Refresh detail screen                     *
      *                                                               *
      * CALLED BY  WRKACC -  Work with account                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKDET    BEGSR                           ** WRKDET **
      *
      ** Initialise work fields
     C           @WI       ADD  1         @WX     20
      ** Initialise account closure indicators
     C                     SETOF                     4142
      *
     C                     EXSR RFRDET
      *
     C                     EXSR DSPDET
      *
     C           *INKL     DOWEQ'0'
      *
      ** If Cmd/3 is pressed, exit this program
     C           *INKC     CASEQ'1'       LAST
      *
      ** If Cmd/5 is pressed, refresh details screen
     C           *INKE     CASEQ'1'       RFRDET
      *
      ** If Cmd/12 is pressed, return to previous routine
     C           *INKL     CASEQ'1'       EXTDET
      *
      ** If Enter key is pressed, process screen input
     C                     CAS            ACCDET
      *
     C                     END
      *
      ** Redisplay appropriate screen ( details    )
     C                     EXSR DSPDET
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPDET - Display combined cash & cheque details    *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPDET    BEGSR                           ** DSPDET **
      *
      ** If previous key has not been pressed or set on?
     C           *INKL     IFEQ '0'
      *
      ** Display program message subfile for any messages
     C                     WRITERE4121C0
      *
      ** Display warning/terminal error(s) screen
     C**********           WRITERE4121F1                                                    BUG15976
     C/COPY WNCPYSRC,RE4121C011
      *
      ** Display and accept combined cash & cheque input screen
     C                     EXFMTRE4121F2
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            ACCDET - Accept details                            *
      *                                                               *
      * CALLS      PRTTRN - Print transaction                         *
      *            UPDATE - Update control                            *
      *            VALDET - Validate details                          *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ACCDET    BEGSR                           ** ACCDET **
      *
     C                     SETOF                     21
      *
     C                     EXSR VALDET
      *
      ** If proceed to update?
     C           *IN67     IFEQ '1'
     C*                                                                   S01408
      ** Proceed to update? (i.e. no Outstanding Held Items, Stopped                          249968
      **                          Cheques, Standing Orders, SWEEPS  )                         249968
     C           @SKIP     IFEQ 'N'                                                           249968
     C/COPY WNCPYSRC,RE4121CCP1                                           S01408
     C*                                                                   S01408
      *
     C                     EXSR UPDATE
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CCP2                                           S01408
     C*                                                                   S01408
     C                     MOVEL'N'       ##COPD                                              CCG016
     C           CCG016    IFEQ 'Y'                                                           CCG016
     C                     EXSR SNDUDC                                                        CCG016
     C                     END                                                                CCG016
     C           ##COPD    IFEQ 'N'                                                           CCG016
      *
     C                     EXSR PRTTRN
     C                     ENDIF                                                              CCG016
     C/COPY WNCPYSRC,RE4121C013
      *
      ** End of commitment cycle
     C           CMTTXT    COMIT
      *
      ** Display transaction completed
     C                     SETON                     45
     C                     ENDIF                                                              249968
      *
      ** If account closure is not requested?
     C           @CLOS     IFEQ ' '
     C                     SETOF                     4142
     C                     END
      *
      ** If account closure is successful?
     C           @CLOS     IFEQ 'Y'
     C                     SETON                     41
     C                     END
      *
      ** If account closure is unsuccessful?
     C           @CLOS     IFEQ 'N'
     C                     SETON                     42
     C                     END
      *
      ** Exit out of details screen and back to initial screen
     C                     MOVE '1'       *INKL
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CCP3                                           S01408
     C*                                                                   S01408
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALDET - Validate details                          *
      *                                                               *
      * CALLS      RTODCK - Exceed OD check                           *
      *            RTTCCY - Teller currency conditions check          *
      *            VALTRN - Validate transaction                      *
      *            VACCLO - Validate account closure                  *
      *            VOCOND - Validate override conditions              *
      *            VTCOND - Validate teller transaction conditions    *
      *            WRKOVR - Work with override                        *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALDET    BEGSR                           ** VALDET **
      *
     C                     SETOF                     6769
     C                     SETOF                     50
     C                     MOVEA*BLANKS   @W,@WX
     C                     MOVEL*BLANKS   @OVTI
      *
      ** Validate transaction
     C                     EXSR VALTRN
      *
      ** If error(s) exist?
     C           *IN69     IFEQ '0'
     C*
     C**  If transaction type 2 entered set on indicator
     C*
     C           STYP2     IFNE ' '
     C                     SETON                     50
     C                     END
      *
      ** Perform teller currency conditions check
     C                     MOVELSCCY1     @CCY
     C                     EXSR RTTCCY
      *
      ** If an empty element is found? insert currency into array
     C           *IN82     IFEQ '1'
     C           @CY,@I    ANDEQ'   '
     C                     MOVE SCCY1     @CY,@I
     C                     END
      *
     C           *IN89     IFEQ '1'
     C                     SETON                     2269
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
     C                     END
      *
      ** Validate teller transaction conditions
     C                     EXSR VTCOND
      *
      ** If a/c closure requested?  perform account closure check
     C           *IN40     IFEQ '1'
     C                     EXSR VACCLO
     C                     END
      *
      ** If a/c closure not requested  OR  unsuccessful a/c closure
      ** perform exceed overdraft check?
     C           *IN40     IFEQ '0'
     C           @CLOS     OREQ 'N'
      *
      ** If charges input ( transaction type 1 =  D E B I T )           'C')
     C           @DCIN1    IFEQ 'D'
      ** Call Access Object AOMEMSR0                                      110130
     C                     CALL 'AOMEMSR0'                                110130
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  110130
     C                     PARM '*KEY   ' W0OPTN           O:Option       110130
     C                     PARM 0         W0RETL 100       O:Retail A/C No110130
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              110130 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM SCCY1     W0CUCD  3        O:Currency     110130
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              110130 CGL029
     C                     PARM @ACOD     W0ACCD 100       O:Account Code                     CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. 110130
     C                     PARM @BRCA     W0BRCA  3        O:Branch       110130
     C           DSMEMS    PARM DSMEMS    DSFDY                           110130
      *                                                                   110130
      ** If record not found?                                             110130
     C           W0RTCD    IFNE *BLANKS                                   110130
     C           *LOCK     IN   LDA                        ***************110130
     C                     Z-ADD19        DBASE            ** DB ERR 19 **110130
     C                     MOVE 'AOMEMSR0'DBFILE           ***************110130
     C**********           Z-ADDW0CNUM    U0CNUM                                       110130 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          110130
     C                     Z-ADDW0ACCD    U0ACCD                          110130
     C                     Z-ADDW0ACSQ    U0ACSQ                          110130
     C                     MOVE W0BRCA    U0BRCA                          110130
     C                     MOVELUMEMER    DBKEY                           110130
     C                     EXSR DBERR                                     110130
     C                     END                                            110130
      *                                                                   110130
     C                     Z-ADDLDBLN     @LDBL                           110130
     C                     Z-ADDCLBLN     @CLBL
     C                     MOVELACST      @ACST
     C                     MOVELSTYP      @STYP
     C                     EXSR RTODCK
     C                     END
     C                     END
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
      *
     C                     SETON                     202269
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
      ** exit out of details screen
     C                     MOVE '1'       *INKL
      *
     C                     ELSE
      *
      ** If warning error(s) exist?
     C           @WI       IFGT 0
      *
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
     C                     SETON                     22
      *
      ** Move teller override indicators from DTAARA/RTSDTA
      ** to teller override array
     C                     MOVEAPOVIN     @R
      *
      ** Perform override validate process
     C                     EXSR VOCOND
      *
      ** Do not display override teller prompt if sign-on teller has
      ** authority to override?
     C           *IN68     IFEQ '0'
     C                     SETOF                     26
     C                     MOVE *OFF      *IN54                                               CRT026
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE *ON       *IN54                                               CRT026
     C                     ELSE                                                               CRT026
     C                     SETON                     26
     C                     ENDIF                                                              CRT026
     C                     END
      *
     C                     EXSR WRKOVR
      *
     C                     ELSE
      *
     C                     SETON                     67
      *
     C                     END
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTTCCYC1
      ** Teller currency conditions
      *
      /EJECT
      /COPY ZSRSRC,RTODCKC1
      ** Overdraft check
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALTRN - Validate transaction                      *
      *                                                               *
      * CALLS      VSTYP1 - Validate transaction type 1               *
      *            VSTAM1 - Validate amount 1                         *
      *            VSTYP2 - Validate transaction type 2               *
      *            VSTAM2 - Validate amount 2                         *
      *            VSVLDT - Validate value date                       *
      *            VSDEPC - Validate department code                  *
      *            VSPRFC - Validate profit centre                    *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALTRN    BEGSR                           ** VALTRN **
     C*
     C**  Validate transaction type 1
     C*
     C                     EXSR VSTYP1
     C*
     C**  Validate transaction amount 1
     C*
     C                     EXSR VSTAM1
     C*
     C**  Validate transaction type 2
     C*
     C                     EXSR VSTYP2
     C*
     C**  Validate transaction amount 2
     C*
     C                     EXSR VSTAM2
     C*
     C**  Validate value date
     C*
     C                     EXSR VSVLDT
     C*
     C**  Validate department code
     C*
     C                     EXSR VSDEPC
     C*
     C**  Validate Profit Centre
     C*   If Used and Transaction Type is Valid                           176510
     C*                                                                   176510
     C           BKPRCU    IFEQ 'Y'
     C           *IN32     ANDEQ'0'                                       176510
     C                     EXSR VSPRFC
     C                     END
     C/COPY WNCPYSRC,RE4121C008
     C*
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSTYP1 - Validate transaction type 1               *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSTYP1    BEGSR                           ** VSTYP1 **
      *
     C                     SETOF                     32
      *
      ** If transaction type entered?
     C           STYP1     IFNE *BLANKS
     C/COPY WNCPYSRC,RE4121C009
     C*
     C**  Transaction type 1
     C*
     C                     CALL 'AORETRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C           STYP1     PARM           STYP1
     C           SDRETR    PARM SDRETR    DSSDY
     C*
     C*
     C**  If record found?
     C*
     C           @RTCD     IFEQ *BLANKS
      *
      ** If DR/CR indicator valid?
     C           A1DCIN    IFEQ 'D'
     C           A1DCIN    OREQ 'C'
      *
     C                     MOVELSTYP1     @TYP1
     C                     MOVEL' '       @RVIN1  1
     C                     MOVELA1DCIN    @DCIN1  1
     C                     MOVELA1CIND    @CSIN1  1
     C                     MOVELA1CLIN    @CLIN1  1
     C                     MOVELA1RTNM    @NRTD1 30
     C                     MOVE A1ASGL    @ASGL1
     C                     MOVELA1PASB    @PASS1  2
      *
     C                     ELSE
     C                     SETON                     32
     C                     MOVE 'USR0087' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ELSE
     C                     SETON                     32
     C                     MOVE 'USR0086' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ELSE
     C                     SETON                     32
     C                     MOVE 'USR0085' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSTAM1 - Validate transaction amount 1             *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            ZALIGN - Validate amount fields                    *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSTAM1    BEGSR                           ** VSTAM1 **
      *
     C                     SETOF                     33
      *
      ** If amount field is entered?
     C           STAM1     IFNE ' '
      *
      ** Set up decimal values
     C                     Z-ADD@TCDP     ZADEC
     C           13        SUB  @TCDP     ZADIG
      *
      ** Align amount
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE STAM1     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @TAM1  150                      E14168
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     33
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** Amount must not be blank or zero
     C                     ELSE
     C                     SETON                     33
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSTYP2 - Validate transaction type 2               *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSTYP2    BEGSR                           ** VSTYP2 **
      *
     C                     SETOF                     34
      *
      ** If transaction type entered?
     C           STYP2     IFNE *BLANKS
     C/COPY WNCPYSRC,RE4121C010
      *
      ** Trans. type 2 must not be the same as trans. type 1
     C           STYP2     IFNE STYP1
     C*
     C**  Transaction type 2
     C*
     C                     CALL 'AORETRR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C           STYP2     PARM           STYP2
     C           SDRETR    PARM SDRETR    DSSDY
      *
     C*
     C**  If record found?
     C*
     C           @RTCD     IFEQ *BLANKS
      *
      ** If DR/CR indicator valid?
     C           A1DCIN    IFEQ 'D'
     C           A1DCIN    OREQ 'C'
      *
      ** Trans. type 2 DR/CR ind. must be the same as trans. type 1
     C           A1DCIN    IFEQ @DCIN1
      *
     C                     MOVELSTYP2     @TYP2
     C                     MOVEL' '       @RVIN2  1
     C                     MOVELA1DCIN    @DCIN2  1
     C                     MOVELA1CIND    @CSIN2  1
     C                     MOVELA1CLIN    @CLIN2  1
     C                     MOVELA1RTNM    @NRTD2 30
     C                     MOVE A1ASGL    @ASGL2
     C                     MOVELA1PASB    @PASS2  2
      *
     C                     ELSE
     C                     SETON                     34
     C                     MOVE 'USR0103' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ELSE
     C                     SETON                     34
     C                     MOVE 'USR0087' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ELSE
     C                     SETON                     34
     C                     MOVE 'USR0086' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ELSE
     C                     SETON                     34
     C                     MOVE 'USR0102' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSTAM2 - Validate transaction amount 2             *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            ZALIGN - Validate amount fields                    *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSTAM2    BEGSR                           ** VSTAM2 **
      *
     C                     SETOF                     35
     C                     Z-ADD0         @TAM2
      *
      ** If amount field is entered?
     C           STAM2     IFNE ' '
      *
      ** If transaction type 2 is entered?
     C           STYP2     IFNE ' '
      *
      ** Set up decimal values
     C                     Z-ADD@TCDP     ZADEC
     C           13        SUB  @TCDP     ZADIG
      *
      ** Align amount
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE STAM2     ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @TAM2  150
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     35
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
     C                     END
     C*
     C**  Amount must be blank or zero if trans. type 2 is not entered
     C*
     C                     ELSE
     C                     SETON                     35
     C                     MOVE 'USR0105' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     ELSE
     C*
     C**  Amount must not be blank or zero if transaction type 2 is
     C**  entered
     C*
     C           STYP2     IFNE ' '
     C                     SETON                     35
     C                     MOVE 'USR0104' @MSGID
     C                     EXSR SNDMSG
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSVLDT - Validate value date                       *
      *                     Assign defaults if not entered            *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            ZDATE1 - Validate dates submitted and convert to a *
      *                     number of days                            *
      *            ZDATE2 - Convert date to dayno. to date formats    *
      *            ZFWDT  - Calculate the number of working days      *
      *                     forward from a given start date for any   *
      *                     particular currency                       *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSVLDT    BEGSR                           ** VSVLDT **
      *
     C                     SETOF                     3699
      *
      ** If value date is blanks?  use run day number as value date
     C           SVLDT     IFEQ *BLANKS
     C                     Z-ADDBJRDNB    @VLDT
     C                     Z-ADD@VLDT     ZDAYNO
     C                     EXSR ZDATE2
      *
      ** Else validate input screen value date
     C                     ELSE
     C                     MOVE SVLDT     ZDATE
     C                     EXSR ZDATE1
      *
      ** If date is valid?
     C           *IN99     IFEQ '0'
     C                     Z-ADDZDAYNO    @VLDT   50
     C                     END
     C                     END
      *
      ** If Invalid date?
     C           *IN99     IFEQ '1'
     C                     MOVE 'USR0009' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     36
      *
      ** Else is value date prior to date account opened?
     C                     ELSE
      *
     C           @VLDT     IFLT DACO
     C                     MOVE 'USR0056' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     36
     C                     END
      *
      ** Value date must not be later than no. of days forward
     C                     Z-ADDBMNDFV    ZNRDYS
     C                     MOVE SCCY1     ZCCY
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     EXSR ZFWDT
     C           @VLDT     IFGT ZDYNBR
     C                     MOVE 'USR0057' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     36
     C                     END
     C*
     C**  If A/C closure requested?  value date must be equal to run-date
     C*
     C           *IN40     IFEQ '1'
     C           @VLDT     ANDNEBJRDNB
     C                     MOVE 'USR0058' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     36
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSDEPC - Validate department code                  *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALTRN - Validate transaction                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSDEPC    BEGSR                           ** VSDEPC **
      *
     C                     SETOF                     37
      *
      ** If department code is not blank?
     C           SDEPC     IFNE *BLANK
      *
      ** Get department code details
     C                     CALL 'AODEPTR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           SDEPC
     C           SDDEPT    PARM SDDEPT    DSFDY
      *
      ** If record not found?
     C           @RTCD     IFNE *BLANKS
     C                     MOVE 'USR0054' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     37
     C                     END
      *
      ** Bank code is required
     C                     ELSE
     C                     MOVE 'USR0055' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     37
     C                     END
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
     C*****************************************************************
     C*                                                               *
     C*            VSPRFC - Validate profit centre                    *
     C*                                                               *
     C* CALLS      SNDMSG - Send program message parameters           *
     C*                                                               *
     C* CALLED BY  VALTRN - Validate transaction                      *
     C*                                                               *
     C* FLDS USED         -                                           *
     C*                                                               *
     C*****************************************************************
     C           VSPRFC    BEGSR                           ** VSPRFC **
     C*
     C                     SETOF                     15
     C*
     C**  Validate the input Profit Centre if entered
     C*
     C           SPRFC     IFNE *BLANK                     B1
     C                     CALL 'AOPRFCR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY    '@OPTN   7
     C           SPRFC     PARM SPRFC     @PRFC   4
     C           SDPRFC    PARM SDPRFC    DSFDY
     C*
     C           @RTCD     IFNE *BLANKS                    B2
     C                     MOVE 'USR1199' @MSGID
     C                     MOVE '1'       *IN15
     C                     EXSR SNDMSG
     C                     END                             E2
     C*
     C                     ELSE                            X1
     C*
     C**  Get the default profit centre
     C*
     C           BKPCDU    IFEQ 'Y'                        B2
     C                     CALL 'AOPRFMR0'
     C                     PARM *BLANKS   @RTC1   1
     C                     PARM *BLANKS   @BOOK   2
     C                     PARM STYP1     @TRPT   5
     C                     PARM *BLANKS   @SUTP   2
     C                     PARM PTLBC     @BRAN   3
     C                     PARM SDEPC     @DEPT   3
     C                     PARM USRPRF    @USRID 10
     C*********************PARM *BLANKS   @ACOF   2                       176510
     C                     PARM ACOF      @ACOF   2                       176510
     C                     PARM @@CNUM    @CUSTN  6
     C                     PARM *BLANKS   @PRFC   4
     C*
     C                     MOVE @PRFC     SPRFC
     C*
     C           @RTC1     IFNE *ZERO                      B3
     C                     MOVE 'USR1199' @MSGID
     C                     MOVE '1'       *IN15
     C                     EXSR SNDMSG
     C                     END                             E3
     C*
     C**  If a default profit centre is not used
     C*
     C                     ELSE                            X2
     C*
     C                     MOVE 'USR1199' @MSGID
     C                     MOVE '1'       *IN15
     C                     EXSR SNDMSG
     C*
     C                     END                             E2
     C*
     C                     END                             E1
     C*
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VTCOND - Validate teller transaction conditions    *
      *                                                               *
      * CALLS      RTABAL - Account available balance check           *
      *            RTBKCR - Block credit check                        *
      *            RTBKDR - Block debit check                         *
      *            RTBVIC - Backvalue check                           *
      *            RTRFCR - Refer credit check                        *
      *            RTRFDR - Refer debit check                         *
      *            RTTLMT - Teller limit check                        *
      *            RTWDAY - Non-working day check                     *
      *            RTBVIC - Backvalue check                           *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VTCOND    BEGSR                           ** VTCOND **
      *
      ** Setup full transaction amount
     C           @TAM1     ADD  @TAM2     @TNAM
      *
      ** If charges input ( transaction type 1 =  D E B I T )?          'C')
     C           @DCIN1    IFEQ 'D'
      *
      ** Block debit check?
      *                                                                   114621
     C***********@V,@BD    IFNE ' '                                       114621
     C           @V,@BD    IFNE 'X'                                       114621
     C                     EXSR RTBKDR
     C                     END
      *
      ** Refer debit check?
      *                                                                   114621
     C***********@V,@RD    IFNE ' '                                       114621
     C           @V,@RD    IFNE 'X'                                       114621
     C                     EXSR RTRFDR
     C                     END
      *
      **  If CRE081 is OFF                                                                    CRE081
      *                                                                                       CRE081
     C           CRE081    IFEQ 'N'                                                           CRE081
      *                                                                                       CRE081
     C***********          Z-ADDRRNM      @RRNM                           CCB002
     C                     MOVE SACNO1    @ACNOM                          CCB002
     C                     Z-ADDODLN      @ODLN
     C                     Z-ADDODED      @ODED
     C                     Z-ADDHELD      @HELD
     C                     Z-ADDMINB      @MINB
     C                     Z-ADD@TCDP     @CYDP
      *
      ** Insufficient funds check?
      ** Exceed OD limit check?
      ** Minimum balance check?
      *                                                                   114621
     C***********@V,@IF    IFNE ' '                                       114621
     C***********@V,@OD    ORNE ' '                                       114621
     C***********@V,@MB    ORNE ' '                                       114621
     C           @V,@IF    IFNE 'X'                                       114621
     C           @V,@OD    ORNE 'X'                                       114621
     C           @V,@MB    ORNE 'X'                                       114621
     C/COPY WNCPYSRC,RE4121C004
     C                     EXSR RTABAL
     C/COPY WNCPYSRC,RE4121C005
     C                     END
      *
      **  If CRE081 is ON, perform Account Balance Check                                      CRE081
      *                                                                                       CRE081
     C                     ELSE                                                               CRE081
      *                                                                                       CRE081
     C           @V,@IF    IFNE 'X'                                                           CRE081
     C           @V,@OD    ORNE 'X'                                                           CRE081
     C           @V,@MB    ORNE 'X'                                                           CRE081
     C                     EXSR VALABC                                                        CRE081
     C                     Z-ADDPAVBAL    CLBLN                                            AR1083178
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     END
      *
      ** If charges input ( transaction type 1 =  C R E D I T )?        'C')
     C           @DCIN1    IFEQ 'C'
      *
      ** Block credit check?
      *                                                                   114621
     C***********@V,@BC    IFNE ' '                                       114621
     C           @V,@BC    IFNE 'X'                                       114621
     C                     EXSR RTBKCR
     C                     END
      *
      ** Refer credit check?
      *                                                                   114621
     C***********@V,@RC    IFNE ' '                                       114621
     C           @V,@RC    IFNE 'X'                                       114621
     C                     EXSR RTRFCR
     C                     END
      *
     C                     END
      *
      ** Teller limit check?
      *                                                                   114621
     C***********@V,@TL    IFNE ' '                                       114621
     C           @V,@TL    IFNE 'X'                                       114621
     C                     MOVELSCCY1     @TCCY
     C                     MOVELBJLCCY    @LCCY
     C                     Z-ADD@TAM1     @TAM1
     C                     Z-ADD@TAM2     @TAM2
     C                     MOVEL@CSIN1    @TCI1
     C                     MOVEL@CSIN2    @TCI2
     C                     Z-ADDPCHTL     @CHTL
     C                     Z-ADDPNCTL     @NCTL
     C                     EXSR RTTLMT
     C                     END
      *
      ** Non-working day check?
      *                                                                   114621
     C***********@V,@NW    IFNE ' '                                       114621
     C           @V,@NW    IFNE 'X'                                       114621
     C                     Z-ADD@VLDT     ZDAYNO
     C                     MOVELSCCY1     ZCCY
     C                     EXSR RTWDAY
     C                     END
      *
      ** Backvaluation/ic check?
      *                                                                   114621
     C***********@V,@BV    IFNE ' '                                       114621
     C           @V,@BV    IFNE 'X'                                       114621
     C                     Z-ADDLDID      @LDID
     C                     MOVE DRIF      @DRIF
     C                     Z-ADDLCID      @LCID
     C                     MOVE CRIF      @CRIF
     C                     MOVE '  '      @ACIN
     C                     EXSR RTBVIC
     C                     END
      *
      ** No associated GL code check?
      *                                                                   114621
     C***********@V,@GL    IFNE ' '                                       114621
     C           @V,@GL    IFNE 'X'                                       114621
     C                     EXSR RTASGL
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTABALC1
      ** Account available balance check for debit transaction
      *
      /EJECT
      /COPY ZSRSRC,RTBALCC1
      ** calculate available balance
      *
      /EJECT
      /COPY ZSRSRC,RTBKCRC1
      ** Block credit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTRFCRC1
      ** Refer credit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTTLMTC1
      ** Teller limit check
      *
      /EJECT
      /COPY ZSRSRC,RTWDAYC1
      ** Non-working day check
      *
      /EJECT
      /COPY ZSRSRC,RTBVICC1
      ** Backvaluation i/c check
      *
      /EJECT
      /COPY ZSRSRC,RTASGLC1
      ** No associated GL code check
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            VACCLO - Validate account closure                  *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VACCLO    BEGSR                           ** VACCLO **
      ***********                                                         CCB002
      ***Access*shadow balances                                           CCB002
     C***********@RRNM     CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
      ** Call Access Object AOMEMSR0                                      CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' W0OPTN           O:Option       CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM SCCY1     W0CUCD  3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACCD                                              CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
      ** If record not found?
     C************IN70     IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE *BLANKS                                   CCB002
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD3         DBASE            ** DB ERR 03 **
     C***********          MOVE 'MEMOS  ' DBFILE           ***************CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C***********          MOVEL@RRNM     DBKEY                           CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      ***********                                                         CCB002
      ***Release*record                                                   CCB002
     C***********          EXCPT@RLMEM                                    CCB002
      *
     C           @INTR     ADD  CLBLN     @WKBL  150
     C                     ADD  @WTAX     @WKBL
     C                     ADD  @CHRG     @WKBL
      *
      ** If debit then add to work balance. Else (credit), subtract.
     C           @DCIN1    IFEQ 'D'
     C                     ADD  @TAM1     @WKBL
     C                     ADD  @TAM2     @WKBL
     C                     ELSE
     C                     SUB  @TAM1     @WKBL
     C                     SUB  @TAM2     @WKBL
     C                     END
      *
      ** If record not found?
     C           @WKBL     IFEQ 0
     C                     MOVE 'Y'       @CLOS
     C                     ELSE
     C                     MOVE 'N'       @CLOS
     C                     END
      *                                                                                       249968
      ** Initialise Skip Update Flag to 'N'                                                   249968
     C                     MOVEL'N'       @SKIP   1                                           249968
      *
      ** If Held Amount Item is Found                                                         249968
     C           KACO      CHAINHELDIHBF             62                                       249968
     C           *IN62     IFEQ '0'                                                           249968
     C                     MOVEL'USR2412' @MSGID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVEL'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              248968
      *                                                                                       249968
      ** If Stopped Cheque is Found                                                           249968
     C           KACO      CHAINSTOPCSL3             61                                       249968
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2413' @MSGID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVEL'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
      ** If Standing Orders is Found using Debit Retail Account                               249968
     C           KACO      CHAINSTANDSBF             61                                       249968
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2414' @MSGID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVE 'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
      ** If Standing Orders is Found using Credit Retail Account                              249968
     C           KACO      CHAINSTANDSBG             61                                       249968
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2414' @MSGID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVE 'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
      *                                                                                       249968
      ** If SWEEP is Found                                                                    249968
      ** Check for Credit Sweep Account                                                       253689
      *                                                                                       253689
     C********** KSWEEP    CHAINRESWEPD0             61                                249968 253689
     C           KSWEEP    CHAINRESWEP5F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP2     CHAINRESWEP6F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP1     CHAINRESWEP7F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP2     CHAINRESWEP8F             61                                       253689
     C                     ENDIF                                                              253689
     C                     ENDIF                                                              253689
     C                     ENDIF                                                              253689
      *                                                                                       253689
     C           *IN61     IFEQ '0'                                                           249968
     C                     MOVEL'USR2415' @MSGID                                              249968
     C                     EXSR SNDMSG                                                        249968
     C                     MOVE 'Y'       @SKIP                                               249968
     C                     MOVEL'N'       @CLOS                                               249968
     C                     ENDIF                                                              249968
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKOVR - Work with override                        *
      *                                                               *
      * CALLS      DSPBAL - Display account balances                  *
      *            DSPOVR - Display overrride screen                  *
      *            EXTOVR - Exit override screen                      *
      *            LAST   - Final Processing                          *
      *            RFROVR - Refresh override screen                   *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKOVR    BEGSR                           ** WRKOVR **
      *
      ** Set off underline attributes
     C                     SETOF                     27
      *
      ** Refresh override screen
     C                     EXSR RFROVR
      *
      ** If Display 'OVERRIDE REQUIRED' message required?
     C           @WI       IFGT 0
     C                     SETON                     21
     C                     END
      *
      ** Display override screen
     C                     EXSR DSPOVR
      *
     C           *INKL     DOWEQ'0'
      *
      ** If Cmd/1 is pressed, work with transaction
     C           *INKA     CASEQ'1'       WRKTRN
      *
      ** If Cmd/2 is pressed, display account balances
     C           *INKB     CASEQ'1'       DSPBAL
      *
      ** If Cmd/3 is pressed, exit this program
     C           *INKC     CASEQ'1'       LAST
      *
     C                     END
      *
      ** Redisplay appropriate screen ( override )
     C                     EXSR DSPOVR
      *
     C                     END
      *
      ** Return to previous screen
     C                     EXSR EXTOVR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPOVR - Display overrride screen                  *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPOVR    BEGSR                           ** DSPOVR **
      *
      ** If previous key has not been pressed or set on?
     C           *INKL     IFEQ '0'
      *
      ** Display program message subfile for any messages
     C                     WRITERE4121C0
      *
      ** Display warning/terminal error screen
     C**********           WRITERE4121F1                                                    BUG15976
     C/COPY WNCPYSRC,RE4121C012
      *
      ** Display withdrwal screen
     C**********           WRITERE4121F2                                                    BUG15976
      *
      ** Display and accept override screen
     C                     EXFMTRE4121F3
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
      ** Set off account balances display
     C                     SETOF                     28
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFROVR - Refresh override screen                   *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *            EXTOVR - Exit override screen                      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFROVR    BEGSR                           ** RFROVR **
      *
     C                     SETOF                     21
     C                     MOVE *BLANKS   @OVRDS
     C                     MOVE *OFF      *IN38                                               CRT026
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            EXTOVR - Exit override screen                      *
      *                                                               *
      * CALLS      RFROVR - Refresh override screen                   *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           EXTOVR    BEGSR                           ** EXTOVR **
      *
      ** Refresh override screen
     C                     EXSR RFROVR
      *
      ** If no terminal error(s) exist?
     C           @TI       IFEQ 0
      *
     C           @WX       SUB  1         @WI
     C                     MOVEA*BLANKS   @W,@WX
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
      *
     C           @WI       IFGT 0
     C                     SETON                     22
     C                     ELSE
     C                     SETOF                     22
     C                     END
      *
      ** Set previous screen indicator off to return to details    screen
     C                     SETOF                     KL
      *
     C                     END
      *
      ** Set on underline attributes
     C                     SETON                     27
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPBAL - Display account balances                  *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTBALC - Calculate available balances              *
      *            ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPBAL    BEGSR                           ** DSPBAL **
      *
     C                     SETON                     28
      *
      **  If CRE081 is OFF or Available Balance is zero                                       CRE081
      *                                                                                       CRE081
     C           CRE081    IFEQ 'N'                                                           CRE081
     C           PAVBAL    OREQ 0                                                             CRE081
      *                                                                                       CRE081
      ** Calculate available balances
     C***********          Z-ADDRRNM      @RRNM                           CCB002
     C                     MOVE @ACNO     @ACNOM                          CCB002
     C                     Z-ADDODLN      @ODLN
     C                     Z-ADDODED      @ODED
     C                     Z-ADDHELD      @HELD
     C                     Z-ADD@TCDP     @CYDP
     C/COPY WNCPYSRC,RE4121C006
     C                     EXSR RTBALC
     C/COPY WNCPYSRC,RE4121C007
      *
      ** If MEMOS record not found?
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD4         DBASE            ** DB ERR 04 **
     C                     MOVE 'MEMOS '  DBFILE           ***************
     C***********          MOVEL@RRNM     DBKEY                           CCB002
     C                     MOVEL@ACNOM    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      *
      **  Set-up Available Balance                                                            CRE081
      *                                                                                       CRE081
     C                     ELSE                                                               CRE081
     C                     Z-ADDPAVBAL    @AVBL                                               CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C/COPY WNCPYSRC,RE4121C002
     C                     Z-ADD@TCDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADDLDBLN     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SLDBL
      *
     C/COPY WNCPYSRC,RE4121C003
     C                     Z-ADD@TCDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@AVBL     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SAVBL
     C/COPY WNCPYSRC,RE4121C016
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * CALLS      RTODCK - Exceed OD check                           *
      *            SNDMSG - Send program message parameters           *
      *            VACCLO - Validate account closure                  *
      *            VALOVR - Validate override                         *
      *            VOCOND - Validate override conditions              *
      *                                                               *
      * CALLED BY  WRKOVR - Work with override                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKTRN    BEGSR                           ** WRKTRN **
      *
      ** If override teller id is prompted?
     C           *IN26     IFEQ '1'
     C           *IN54     OREQ *ON                                                           CRT026
      *
     C                     EXSR VALOVR
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
     C*
     C**  Move teller override indicators from PF/SDTELDPD
     C**  to teller override array
     C*
     C                     MOVEAFROVRI    @R
      *
      ** Perform override validate process
     C                     EXSR VOCOND
      *
      ** If successful override?  Set on Previous screen indicator
      ** to return to update handling
     C           *IN68     IFEQ '0'
      *
      ** If a/c closure requested?  perform account closure check
     C           *IN40     IFEQ '1'
     C                     EXSR VACCLO
     C                     END
      *
      ** If a/c closure not requested  OR  unsuccessful a/c closure
      ** perform exceed overdraft check?
     C           *IN40     IFEQ '0'
     C           @CLOS     OREQ 'N'
      *
      ** If charges input ( transaction type 1 =  D E B I T )           'C')
     C           @DCIN1    IFEQ 'D'
     C                     Z-ADDCLBLN     @CLBL
     C                     MOVELACST      @ACST
     C                     MOVELSTYP      @STYP
     C                     EXSR RTODCK
     C                     END
     C                     END
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
      *
     C                     SETON                     202269
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
      ** exit out of details screen
     C                     MOVE '1'       *INKL
      *
     C                     ELSE
     C                     SETOF                     69
     C                     SETON                     67
     C                     MOVE '1'       *INKL
     C                     END
      *
      ** Else teller override failed
     C                     ELSE
     C                     MOVE 'USR0029' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     69
     C                     END
      *
     C                     END
      *
      ** Else no override prompted, set on indicator to update files
     C                     ELSE
     C                     SETON                     67
      *
      ** and exit out of override screen
     C                     MOVE '1'       *INKL
      *
     C                     END
      *
      ** Save screen error messages (later to be used for output)
     C                     MOVE *BLANK    @MSG1  72
     C                     MOVE *BLANK    @MSG2  72
     C                     MOVELSMSG1     @MSG1  72
     C                     MOVELSMSG2     @MSG2  72
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALOVR - Validate override                         *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            RTENCP - Encript passcode                          *
      *                                                               *
      * CALLED BY  DSPBAL - Display account balances                  *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALOVR    BEGSR                           ** VALOVR **
      *
      ** Set off validation error indicator
      ** and save field for override teller identifier
     C                     SETOF                     69
     C                     MOVE *BLANKS   @OVTI   3
      *
      ** If override teller identifier is not blank?
      ** If CRT026 is switch ON check user id if not blank                                    CRT026
      *                                                                                       CRT026
     C           SOVTI     IFNE *BLANK
     C           SOVUR     ORNE *BLANK                                                        CRT026
      *                                                                                       CRT026
      ** Access user id details to obtain the teller id attached                              CRT026
      ** to the user id                                                                       CRT026
      *                                                                                       CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'AOUSERR0'                                                    CRT026
     C                     PARM *BLANKS   @RTCD                                               CRT026
     C                     PARM '*KEY'    @OPTN                                               CRT026
     C                     PARM SOVUR     @USRP  10                                           CRT026
     C           MUSER     PARM MUSER     DSSDY                                               CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C           @RTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'MUSERDD' DBFILE           ***************                    CRT026
     C                     Z-ADD39        DBASE            ** DB ERR 39 **                    CRT026
     C                     MOVELSOVUR     DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C                     MOVEL'USR1501' @MSGID                                              CRT026
     C                     EXSR SNDMSG                                                        CRT026
      ** If user id is valid use the teller attached to this user                             CRT026
      ** to obtain the teller details                                                         CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE TLID      @TELD                                               CRT026
     C                     ENDIF                                                              CRT026
      ** If CRT026 enhancement is switch OFF use the teller id                                CRT026
      ** entered to obtain the teller details                                                 CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE SOVTI     @TELD                                               CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
      ** If no validation errors exist                                                        CRT026
     C*
     C**  Access teller id details
     C*
     C           *IN69     IFEQ *OFF                                                          CRT026
     C                     CALL 'AOTELDR0'
     C**********           PARM '*DBERR ' @RTCD   7                                           CRT026
     C                     PARM '*BLANKS' @RTCD   7                                           CRT026
     C                     PARM '*KEY   ' @OPTN   7
     C**********           PARM SOVTI     @TELD   3                                           CRT026
     C                     PARM           @TELD   3                                           CRT026
     C           SDTELD    PARM SDTELD    DSFDY
     C*
     C           @RTCD     IFEQ *BLANKS
     C**********           MOVE SOVTI     @OVTI                                               CRT026
     C                     MOVE @TELD     @OVTI                                               CRT026
      *
      ** Teller Identifier not found
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVEL'USR1509' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0030' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     38
     C                     END
     C                     ENDIF                                                              CRT026
      *
      ** Teller identifier is required
      ** If CRT026 is switch ON User identifier is required                                   CRT026
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1500' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0032' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     38
     C                     END
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** If teller passcode is not blank?
      ** If CRT026 is switch ON check user password if not blank                              CRT026
      *                                                                                       CRT026
     C           SOVPC     IFNE *BLANK
     C           SOVPW     ORNE *BLANK                                                        CRT026
      ** If CRT026 is switch ON check the password via REC4170                                CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'REC4170'                                                     CRT026
     C                     PARM           SOVUR                                               CRT026
     C                     PARM           SOVPW                                               CRT026
     C                     PARM *BLANKS   @RTCD   7                                           CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     SELEC                                                              CRT026
     C           @RTCD     WHEQ 'CPF2204'                                                     CRT026
     C                     MOVE 'USR1501' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF22E3'                                                     CRT026
     C                     MOVE 'USR1506' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF2203'                                                     CRT026
     C                     MOVE 'USR1507' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF2213'                                                     CRT026
     C                     MOVE 'USR1508' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF22E5'                                                     CRT026
     C                     MOVE 'USR1505' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E2'                                                     CRT026
     C                     MOVE 'USR1503' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E4'                                                     CRT026
     C                     MOVE 'USR1504' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E6'                                                     CRT026
     C                     MOVE 'USR1510' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E9'                                                     CRT026
     C                     MOVE 'USR1511' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF2225'                                                     CRT026
     C                     MOVE 'USR1512' @MSGID                                              CRT026
     C                     ENDSL                                                              CRT026
     C                     MOVE *ON       *IN39                                               CRT026
     C                     EXSR SNDMSG                                                        CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C                     ELSE                                                               CRT026
      *
      ** If teller passcode does not match?
      *
      ** Encript the passcode
     C                     MOVEASOVPC     BPWD
     C                     Z-ADD6         X       10
     C                     EXSR RTENCP
     C                     MOVEAEPWD      SOVPC
      *
     C           SOVPC     IFNE FRTLPC
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE 'USR0039' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     39
     C                     END
     C                     ENDIF                                                              CRT026
      *
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1502' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE 'USR0033' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     39
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VOCOND - Validate override conditions              *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VOCOND    BEGSR                           ** VOCOND **
      *
     C                     SETOF                     68
     C                     Z-ADD1         @I
      *
      ** Do until end of array reached or unsuccessful override found
     C           @I        DOUGT25
      *
      ** If element of override conditions is yes
      ** and teller override indicators array element is no?
     C           @O,@I     IFEQ 'Y'
     C           @R,@I     ANDEQ'N'
      *
      ** Return as unsuccessful override
     C                     SETON                     68
     C                     Z-ADD25        @I
     C                     END
      *
      ** Check next element
     C                     ADD  1         @I
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      *
      /EJECT
      /COPY ZSRSRC,RTLCNVC1
      ** local currency conversion
      *
      /EJECT
      /COPY ZSRSRC,RTCCYSC1
      ** currency setup
      *
      /EJECT
      /COPY ZSRSRC,RTACLSC1
      ** Account closure
      *
      /EJECT
      /COPY ZSRSRC,RTTWIDC1
      ** teller workstation-id conditions check
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRDET - Refresh detail screen                     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *            EXTDET - Exit details screen                       *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRDET    BEGSR                           ** RFRDET **
     C*
     C                     SETON                     27
     C                     SETOF                     323334
     C                     SETOF                     353637
     C                     SETOF                     152169
     C*
     C**  If no warning errors exist?
     C*
     C           @WI       IFEQ 0
     C                     SETOF                     22
     C                     END
     C*
     C                     MOVE *BLANKS   @DETDS
     C                     MOVE PDEPC     SDEPC
     C*
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            EXTDET - Exit details    screen                    *
      *                                                               *
      * CALLS      RFRDET - Refresh details    screen                 *
      *                                                               *
      * CALLED BY  WRKDET - Work with details                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           EXTDET    BEGSR                           ** EXTDET **
      *
      ** Clear details    screen
     C                     EXSR RFRDET
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *           SNDMSG  - Send program message parameters           *
      *                                                               *
      * CALLS     SCC0240 - Send message to program queue             *
      *                                                               *
      * CALLED BY  DSPBAL - Display account balances                  *
      *            VALOVR - Validate override                         *
      *            VSACNO - Validate account number                   *
      *            VSCCY  - Validate currency code                    *
      *            VSTYP1 - Validate transaction type 1               *
      *            VSTAM1 - Validate amount 1                         *
      *            VSTYP2 - Validate transaction type 2               *
      *            VSTAM2 - Validate amount 2                         *
      *            VSVLDT - Validate value date                       *
      *            VSDEPC - Validate department code                  *
      *            WRKTRN - Work with transaction                     *
      *                                                               *
      * FLDS USED  @MSGID - Message id                                *
      *            @MSGF  - Message file                              *
      *            @MSDTA - Message data                              *
      *            @MSPRL - Program relationship                      *
      *            @MSPGM - Program name                              *
      *            @MSTYP - Message type                              *
      *                                                               *
      *****************************************************************
     C           SNDMSG    BEGSR                           ** SNDMSG **
     C*
     C                     SETON                     69
     C*
     C                     CALL 'SCC0240'
     C                     PARM           @MSGID
     C                     PARM           @MSGF
     C*
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRINL - Refresh initial screen                    *
      *                                                               *
      * CALLS      RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRINL    BEGSR                           ** RFRINL **
      *
     C                     SETOF                     303132
     C                     SETOF                     353740
     C                     SETOF                     8182
     C                     MOVE ' '       @CLOS
     C                     MOVE *BLANKS   @INLDS
     C                     MOVE ' '       @CLOS
      *
      ** If Cmd/5 is pressed?
     C           *INKE     IFEQ '1'
     C           @TI       OREQ 0
     C                     EXSR RFRERR
     C      KE             SETOF                     454142
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPDATE - Update control                            *
      *                                                               *
      * CALLS      UACNUM - Update accounts                           *
      *            UMEMOS - Update memos                              *
      *            UPDATE - Update control                            *
      *            UTNTM2 - Update teller controls                    *
      *            UTNTM3 - Update teller totals                      *
      *            UTRANT - Update teller transaction trailer         *
      *            WRSACM - Write shadow postings                     *
      *            WRSAC2 - Write shadow postings for Closure         *   106661
      *            WTRAND - Write teller transacton details           *
      *            ZTNLU1 - Access dataarea for next transaction no.  *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UPDATE    BEGSR                           ** UPDATE **
      *
      ** Access and update next available transaction number
     C                     EXSR ZTNLU1
      *
     C                     TIME           STIME   60
     C                     Z-ADD@NATN     STTLU
      *
      ** Update all files
     C                     EXSR WTRAND
      *
     C                     EXSR UTRANT
      *
     C                     EXSR UTNTM2
      *
     C                     EXSR UTNTM3
      *
     C                     EXSR UMEMOS
      *
     C                     EXSR UACNUM
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WTRAND - Write teller transacton details           *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WTRAND    BEGSR                           ** WTRAND **
      *
      ** Format record details
     C                     MOVEL'D'       RECI
     C                     MOVEL'T'       TBRI
     C                     MOVELPTLID     TBID
     C                     MOVEL@NATN     TBTN
     C                     MOVE SACNO1    ACNO
     C                     MOVELPFNCD     FNCD
     C                     MOVELSCCY1     CCY1
     C                     Z-ADD@TAM1     AMT1
     C                     Z-ADD@TAM2     AMT2
     C                     MOVELSTYP1     TTP1
     C                     MOVELSTYP2     TTP2
     C                     MOVE SVLDT     IVLD
     C                     MOVELPTLBC     ITLB
     C                     MOVELSDEPC     DEPC
     C                     MOVELSPRFC     PRFC
     C                     MOVEL@JOB      TWID
     C                     MOVELSTIME     TIME
     C                     MOVEL@OVTI     OVTI
     C                     MOVEL@CLOS     CLOS
     C                     Z-ADD@RRNM     MRR1
     C                     MOVEL@MSG1     MSG1
     C                     MOVEL@MSG2     MSG2
     C                     Z-ADD@VLDT     VLDT
     C                     MOVE 'Y'       ACKF                                                CRT006
      *
     C                     WRITETTRANPDF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTRANT - Update teller transaction trailer         *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTRANT    BEGSR                           ** UTRANT **
      *
      ** Access teller transaction trailer
     C           1         CHAINTTRANPTF             70
      *
      ** If record not found?
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD5         DBASE            ** DB ERR 05 **
     C                     MOVE 'TTRANPT' DBFILE           ***************
     C                     MOVEL'1'       DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Increment no. of records
     C                     ADD  1         TTNORE
      *
      ** Update teller transaction trailer
     C                     UPDATTTRANPTF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTNTM2 - Update teller controls                    *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTTCCY - Teller currency conditions check          *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTNTM2    BEGSR                           ** UTNTM2 **
      *
      * Move fields to key list.
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     MOVEL'1'       KRCTP
      *
      ** Get Teller Control Details
     C           KLTRNT    CHAINTTRNT                70
      *
      ** If record not found?
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD6         DBASE            ** DB ERR 06 **
     C                     MOVE 'TTRNT'   DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Format record details
     C                     ADD  1         T2NATN
      *
      ** If currency of account is not present on currencies array?
      ** in PF/TTRNTM2, update array with account currency
     C                     MOVELSCCY1     @CCY
     C                     EXSR RTTCCY
     C           @CY,@I    IFEQ '   '
     C                     MOVELSCCY1     @CY,@I
     C                     END
      *
      ** Update teller controls
     C                     UPDATTTRNTM2F
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTNTM3 - Update teller totals                      *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTTOTS - Teller total updates                      *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTNTM3    BEGSR                           ** UTNTM3 **
      *
      * Move fields to key list.
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     MOVEL'2'       KRCTP
      *
      ** Get Teller Control Details
     C           KLTRNT    CHAINTTRNT                70
      *
      ** If record not found?
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD7         DBASE            ** DB ERR 07 **
     C                     MOVE 'TTRNT'   DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Obtain currency totals using transaction type 1 details
     C                     MOVELSCCY1     @CCY
     C                     Z-ADD@TAM1     @TAMT
     C                     MOVEL@RVIN1    @RVIN
     C                     MOVEL@DCIN1    @DCIN
     C                     MOVEL@CSIN1    @CSIN
     C                     MOVEL@CLIN1    @CLIN
     C                     EXSR RTTOTS
      *
      ** If transaction type 2 is entered?
     C           STYP2     IFNE *BLANKS
      *
      ** Obtain currency totals using transaction type 2 details
     C                     MOVELSCCY1     @CCY
     C                     Z-ADD@TAM2     @TAMT
     C                     MOVEL@RVIN2    @RVIN
     C                     MOVEL@DCIN2    @DCIN
     C                     MOVEL@CSIN2    @CSIN
     C                     MOVEL@CLIN2    @CLIN
     C                     EXSR RTTOTS
     C                     END
      *
      ** Update teller tansaction no. of last update
     C                     Z-ADD@NATN     TTLU
      *
      ** Update teller totals
     C                     UPDATTTRNTM3F
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UMEMOS - Update memos                              *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UMEMOS    BEGSR                           ** UMEMOS **
      ***********                                                         CCB002
      ***Retrieve PF/MEMOS details                                        CCB002
     C***********@RRNM     CHAINMEMOS                70                   CCB002
      *
      ***If*record not found?                                             CCB002
     C************IN70     IFEQ '1'                                       CCB002
     C************LOCK     IN   LDA                        ***************CCB002
     C***********          Z-ADD8         DBASE            ** DB ERR 08 **CCB002
     C***********          MOVE 'MEMOS  ' DBFILE           ***************CCB002
     C***********          MOVEL@RRNM     DBKEY                           CCB002
     C***********          EXSR DBERR                                     CCB002
     C***********          END                                            CCB002
      *
     C           @TAM1     ADD  @TAM2     @TNAM
      *                                                                   106661
      ** include net interest amount if closing.                          106661
     C           CLREQ     IFEQ 'Y'                                       106661
     C           @CLOS     ANDEQ'Y'                                       106661
      ** Write interest and charge records to RSACMTPD if required        106661
     C                     EXSR WRSAC2                                    106661
     C                     Z-ADD@INTRS    SUMT   150                      106661
     C                     ADD  @CHRG     SUMT                            106661
      *                                                                   106661
     C** Chain access object AOMEMSU0                                     106661
     C                     CALL 'AOMEMSU0'                                106661
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  106661
     C                     PARM 0         W0RETL 100       O:Retail A/C No106661
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              106661 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM @CCY      W0CCY   3        O:Currency     106661
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              106661 CGL029
     C                     PARM @ACOD     W0ACCD           O:Account Code                     CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. 106661
     C                     PARM @BRCA     W0BRCA  3        O:Branch       106661
     C                     PARM BJRDNB    W0PSTD  50       O:Posting date 106661
     C                     PARM BJRDNB    W0VDAT  50       O:Value date   106661
     C                     PARM SUMT      W0AMT  150       O:Movement amt 106661
     C                     PARM 'N'       W0FTOV  1        O:FT override  106661
      *                                                                   106661
      ** If record not found?                                             106661
     C           W0RTCD    IFNE *BLANKS                                   106661
     C           *LOCK     IN   LDA                                       106661
     C                     Z-ADD19        DBASE            ***************106661
     C                     MOVE 'AOMEMSU0'DBFILE           ** DBERR 019 **106661
     C**********           Z-ADDW0CNUM    U0CNUM           ***************             106661 CSD027
     C                     MOVE W0CNUM    U0CNUM           ***************                    CSD027
     C                     MOVE W0CUCD    U0CUCD                          106661
     C                     Z-ADDW0ACCD    U0ACCD                          106661
     C                     Z-ADDW0ACSQ    U0ACSQ                          106661
     C                     MOVE W0BRCA    U0BRCA                          106661
     C                     MOVELUMEMER    DBKEY                           106661
     C                     EXSR DBERR                                     106661
     C                     END                                            106661
     C/COPY WNCPYSRC,RE4121C018
     C                     END                                            106661
      *
      ***If*charges input ( transaction type 1 =  D E B I T )?          'CCCB002
     C***********@DCIN1    IFEQ 'D'                                       CCB002
      ***********                                                         CCB002
      ***If*value date less than or equal to run date?                  'CCCB002
     C***********@VLDT     IFLE @RUND                                     CCB002
      ***********                                                         CCB002
      ***add*transaction amount to cleared balance                        CCB002
     C***********          ADD  @TNAM     CLBLN                           CCB002
      ***********                                                         CCB002
     C***********          END                                            CCB002
      ***********                                                         CCB002
      ***add*transaction amount to ledger balance                         CCB002
     C***********          ADD  @TNAM     LDBLN                           CCB002
      ***********                                                         CCB002
     C***********          END                                            CCB002
      ***********                                                         CCB002
      ***If*charges input ( transaction type 1 =  C R E D I T )?        'CCCB002
     C***********@DCIN1    IFEQ 'C'                                       CCB002
      ***********                                                         CCB002
      ***If*value date less than or equal to run date?                  'CCCB002
     C***********@VLDT     IFLE @RUND                                     CCB002
      ***********                                                         CCB002
      ***Subtract transaction amount to cleared balance                   CCB002
     C***********          SUB  @TNAM     CLBLN                           CCB002
      ***********                                                         CCB002
     C***********          END                                            CCB002
      ***********                                                         CCB002
      ***Subtract transaction amount to ledger balance                    CCB002
     C***********          SUB  @TNAM     LDBLN                           CCB002
      ***********                                                         CCB002
     C***********          END                                            CCB002
      ***********                                                         CCB002
      ***Update*PF/MEMOS record                                           CCB002
     C***********          UPDATMEMOSMDF                                  CCB002
      *                                                                   CCB002
      ** Set up posting amount.                                           CCB002
     C           @DCIN1    IFEQ 'C'                                       CCB002
     C                     Z-SUB@TNAM     W0AMT                           CCB002
     C                     ELSE                                           CCB002
     C                     Z-ADD@TNAM     W0AMT                           CCB002
     C                     ENDIF                                          CCB002
      *                                                                   CCB002
      ** Call Access Object AOMEMSU0                                      CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM ACCY      W0CUCD  3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACCD           O:Account Code                     CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C                     PARM RUND      W0PSTD  50       O:Posting date CCB002
     C                     PARM @VLDT     W0VDAT  50       O:Value date   CCB002
     C                     PARM           W0AMT  150       O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV  1        O:FT override  CCB002
      *                                                                   CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C           *LOCK     IN   LDA                        ***************CCB002
     C                     Z-ADD8         DBASE            ** DB ERR 08 **CCB002
     C                     MOVE 'AOMEMSU0'DBFILE           ***************CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR                                     CCB002
     C                     END                                            CCB002
     C/COPY WNCPYSRC,RE4121C019
      *
      ** Write shadow postings
     C           @DCIN1    IFEQ 'D'
     C                     Z-ADD0         DORC
     C                     ELSE
     C                     Z-ADD1         DORC
     C                     END
     C                     Z-ADD@TAM1     MVAM
     C                     MOVEL@NRTD1    NRTD
     C                     MOVEL@PASS1    PASS
     C                     EXSR WRSACM
      *
      ** If amount 2 is not zero?                                       'C')
     C           @TAM2     IFNE 0
     C           @DCIN2    IFEQ 'D'
     C                     Z-ADD0         DORC
     C                     ELSE
     C                     Z-ADD1         DORC
     C                     END
     C                     Z-ADD@TAM2     MVAM
     C                     MOVEL@NRTD2    NRTD
     C                     MOVEL@PASS2    PASS
     C                     EXSR WRSACM
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRSACM - Write shadow postings                     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRSACM    BEGSR                           ** WRSACM **
      *
     C**********           Z-ADD@CNUM     CUSN                                                CSD027
     C                     MOVE @CNUM     CUSN                                                CSD027
     C                     MOVEL@CCY      CCYD
     C                     Z-ADD@ACOD     ACDE
     C                     Z-ADD@ACSQ     ASNC
     C                     MOVE @BRCA     BRCA
     C                     Z-ADDBJRDNB    PTDT
     C                     Z-ADD@VLDT     VUDT
     C                     MOVEL'TT'      TRYP
     C                     MOVE @NATN     TNMR
     C                     MOVEL*BLANKS   CQNR
     C                     MOVELPTLID     TBID
     C                     MOVEL'N'       APBI
      *                                                                                       CAP205
      ** Set up Module and Movement Type fields                                               CAP205
      *                                                                                       CAP205
     C           CAP205    IFEQ 'Y'                                                           CAP205
     C                     MOVE 'RE'      CMOD                                                CAP205
     C                     MOVE 'S'       MTYP                                                CAP205
     C                     ENDIF                                                              CAP205
      *
     C                     WRITERSACMTPO
     C/COPY WNCPYSRC,RE4121C020
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UACNUM - Update accounts                           *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTACLS - Account closure updates                   *
      *                                                               *
      * CALLED BY  UPDATE - Update control                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UACNUM    BEGSR                           ** UACNUM **
      *
      ** If account closure is successful?
     C           @CLOS     IFEQ 'Y'
     C                     MOVEL' '       @RVIN
     C                     EXSR RTACLS
      *
      ** If LF/ACCNT record not found?
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD9         DBASE            ** DB ERR 09 **
     C                     MOVE 'ACCNT '  DBFILE           ***************
     C                     MOVEL@ACCN     DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            PRTTRN - Print transaction                         *
      *                                                               *
      * CALLS      ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  ACCDET - Accept details                            *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           PRTTRN    BEGSR                           ** PRTTRN **
      *
     C                     OPEN RE4121P1
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CCP9                                           S01408
     C*                                                                   S01408
     C*
     C** Ensure Report Spool File Recorded by RCF
     C*
     C                     Z-ADDSFNUM     ZSNUM   60
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM           SENTY   3
     C                     PARM           SFILE
     C                     PARM           ZSNUM
     C                     PARM *BLANKS   ZSERR   1
     C*
     C** Error During ZSFILE Processing, Return to Calling Program
     C*
     C           ZSERR     IFEQ 'Y'
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C                     END
      *
      ** Format transaction amount 1
     C                     Z-ADD@TCDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@TAM1     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    OTAM1
      *
      ** Format transaction amount 2
     C                     Z-ADD@TCDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@TAM2     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    OTAM2
      *                                                                                      BUG8798
      ** Format transaction TOTAL amount                                                     BUG8798
     C                     Z-ADD@TCDP     ZDECS                                              BUG8798
     C                     MOVE 'A'       ZECODE                                             BUG8798
     C                     Z-ADD@TAM1     ZFLD15                                             BUG8798
     C                     ADD  @TAM2     ZFLD15                                             BUG8798
     C                     EXSR ZFRPED                                                       BUG8798
     C                     MOVE ZOUT22    OTAMT                                              BUG8798
      *                                                                                      BUG8798
     C           @DCIN1    IFEQ 'C'                                                          BUG8798
     C                     SETOF                     46                                      BUG8798
     C                     ELSE                                                              BUG8798
     C                     SETON                     46                                      BUG8798
     C                     ENDIF                                                             BUG8798
      *                                                                                      BUG8798
     C                     MOVE SCCY1     SCCYT                                              BUG8798
      *
     C                     WRITEDETAIL
      *
     C                     CLOSERE4121P1
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                                                  CCG016
      *****************************************************************                       CCG016
      *                                                               *                       CCG016
      *            SNDUDC - Send advice to UDC                        *                       CCG016
      *                                                               *                       CCG016
      * CALLS      external pgm                                       *                       CCG016
      *                                                               *                       CCG016
      * CALLED BY  same as PRTTRN                                     *                       CCG016
      *                                                               *                       CCG016
      * FLDS USED         -                                           *                       CCG016
      *                                                               *                       CCG016
      *****************************************************************                       CCG016
     C           SNDUDC    BEGSR                                                              CCG016
      *                                                                                       CCG016
     C                     MOVELITLB      I#BRCT    P                                         CCG016
     C                     MOVELPTLID     I#TLID    P                                         CCG016
     C                     MOVELTBID      I#TBID    P                                         CCG016
     C                     MOVELSTTLU     I#TBTN    P                                         CCG016
     C                     MOVELPFNCD     I#FUNC    P                                         CCG016
     C           *IN40     IFEQ '0'                                                           CCG016
     C                     MOVEL'N'       I#CLOS    P                                         CCG016
     C                     ELSE                                                               CCG016
     C                     MOVEL'Y'       I#CLOS    P                                         CCG016
     C                     END                                                                CCG016
     C                     MOVEL*ZEROS    I#CHQN                                              CCG016
     C                     MOVEL*ZEROS    I#CNUM                                              CCG016
     C                     MOVEL*BLANKS   I#CCY                                               CCG016
     C                     MOVEL*ZEROS    I#ACOD                                              CCG016
     C                     MOVEL*ZEROS    I#ACSQ                                              CCG016
     C                     MOVEL*ZEROS    I#BRCA                                              CCG016
     C                     MOVELACNO      I#ACNO    P                                         CCG016
     C                     MOVEL*ZEROS    I#CNU1                                              CCG016
     C                     MOVEL*BLANKS   I#CCY1                                              CCG016
     C                     MOVEL*ZEROS    I#ACO1                                              CCG016
     C                     MOVEL*ZEROS    I#ACS1                                              CCG016
     C                     MOVEL*BLANKS   I#BRC1                                              CCG016
     C                     MOVEL*ZEROS    I#ACN1                                              CCG016
     C                     MOVEL*ZEROS    I#CNU2                                              CCG016
     C                     MOVEL*BLANKS   I#CCY2                                              CCG016
     C                     MOVEL*ZEROS    I#ACO2                                              CCG016
     C                     MOVEL*ZEROS    I#ACS2                                              CCG016
     C                     MOVEL*BLANKS   I#BRC2                                              CCG016
     C*                                                                                       CCG016
     C                     MOVEL*ZEROS    I#ACN2                                              CCG016
     C                     Z-ADD@TAM1     I#AMNT                                              CCG016
     C                     MOVELSCCY1     I#CCYT    P                                         CCG016
     C                     MOVEL@NRTD1    I#NARR    P                                         CCG016
     C                     Z-ADD0         I#CHQA                                              CCG016
     C                     Z-ADD0         I#EXRT                                              CCG016
     C                     Z-ADD0         I#BUYA                                              CCG016
     C                     MOVEL*BLANKS   I#BUYC                                              CCG016
     C                     Z-ADD0         I#SELA                                              CCG016
     C                     MOVEL*BLANKS   I#SELC                                              CCG016
     C                     MOVEL*BLANKS   I#NAR1                                              CCG016
     C                     MOVEL*BLANKS   I#NAR2                                              CCG016
     C                     Z-ADD0         I#INTA                                              CCG016
     C                     MOVEL*BLANKS   I#INTC                                              CCG016
     C                     MOVEL*BLANKS   I#INTN                                              CCG016
     C                     Z-ADD0         I#TAXA                                              CCG016
     C                     MOVEL*BLANKS   I#TAXC                                              CCG016
     C*                                                                                       CCG016
     C                     MOVEL*BLANKS   I#TAXN                                              CCG016
     C                     Z-ADD0         I#CHGA                                              CCG016
     C                     MOVEL*BLANKS   I#CHGC                                              CCG016
     C                     MOVEL*BLANKS   I#CHGN                                              CCG016
     C                     Z-ADD@TAM2     I#TOTA                                              CCG016
     C                     MOVELSCCY2     I#TOTC    P                                         CCG016
     C                     MOVEL@NRTD2    I#TOTN    P                                         CCG016
      *                                                                                       CCG016
     C                     CALL 'CGC3605'                                                     CCG016
     C                     PARM '*PREPARE'ACTION  8                                           CCG016
      *                                                                                       CCG016
     C                     CALL 'CG0501'                                                      CCG016
     C                     PARM           W0RTN   7                                           CCG016
     C                     PARM 'YES'     W0CMT   3                                           CCG016
     C                     PARM *BLANKS   ##COPD  1                                           CCG016
     C                     PARM *BLANKS   ##AUTO  1                                           CCG016
     C                     PARM           I#PARM                                              CCG016
     C                     PARM           O#PARM                                              CCG016
      *                                                                                       CCG016
     C                     CALL 'CGC3604'                                                     CCG016
      *                                                                                       CCG016
     C           ##COPD    IFNE 'N'                                                           CCG016
     C                     CALL 'CGC0524'                                                     CCG016
     C                     PARM *BLANKS   W7A1    7                                           CCG016
     C                     PARM O#PARM    W50A1  50                                           CCG016
     C                     PARM *BLANKS   W10A1  10                                           CCG016
     C                     END                                                                CCG016
      *                                                                                       CCG016
     C                     ENDSR                                                              CCG016
      *****************************************************************                       CCG016
     C/COPY WNCPYSRC,RE4121C014
      /EJECT
      /COPY ZSRSRC,RTCLSCC1
      ** Calculate close details
      *
      /EJECT
      /COPY ZSRSRC,RTCHRGC1
      ** Calculate service charges
      *
      /EJECT
      /COPY ZSRSRC,RTINTRC1
      ** Calculate net interest
      *
      /EJECT
      /COPY ZSRSRC,RTCLSEC1
      ** Close account conditions check
      *
      /EJECT
      /COPY ZSRSRC,RTTOTSC1
      ** Calculate teller totals updates
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            ACLOSE - A/C Closure Enquiry                       *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTCLSC - Calculate close details                   *
      *            RTCLSE - Close account condition check             *
      *            VALINL - Validate initial screen                   *
      *            WRKACC - Work with account                         *
      *            ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ACLOSE    BEGSR                           ** ACLOSE **
      *
     C                     SETOF                     4569
     C                     SETON                     40
     C**********           OPEN RECRG                                     153001
     C                     OPEN REIAC
     C                     OPEN REACR
      *
      ** Validate initial screen
     C                     EXSR VALINL
      *
      ** If no validation error(s)?
     C           *IN69     IFEQ '0'
      *
      ** Set up variables
     C                     MOVE ' '       @CLOS   1
     C                     MOVE RETB      @RETB
     C                     MOVELSCCY1     @CCY
     C                     Z-ADDHELD      @HELD
      ***********                                                         CCB002
      ***Retrieve PF/MEMOS details                                        CCB002
     C***********@RRNM     CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
      ** Call Access Object AOMEMSR0                                      CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' W0OPTN           O:Option       CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM ACCY      W0CUCD  3        O:Currency     CCB002
     C*********            PARM @ACOD     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACCD           O:Account Code                     CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
      ** If record not found?
     C************IN70     IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD10        DBASE            ** DB ERR 10 **
     C***********          MOVE 'MEMOS  ' DBFILE           ***************CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C***********          MOVEL@RRNM     DBKEY                           CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      ***********                                                         CCB002
      ** Release*record                                                   CCB002
     C***********          EXCPT@RLMEM                                    CCB002
      *
      ** Perform close account condition check
     C                     MOVE SCCY1     SCCY2
     C                     MOVE ANAM      SANAM
     C                     MOVE SACNO1    SACNO2
     C                     MOVE '1 '      @ACIN   2
     C                     Z-ADDCLBLN     @CLBL
      *                                                                   CCB002
      ** Set up fields                                                    CCB002
     C                     Z-ADD*ZEROS    @ACNOM                          CCB002
     C**********           Z-ADD@CNUM     @CNUMM                                       CCB002 CSD027
     C                     MOVE @CNUM     @CNUMM                                              CSD027
     C                     MOVE @CCY      @CCYM                           CCB002
     C                     Z-ADD@ACOD     @ACCDM                          CCB002
     C                     Z-ADD@ACSQ     @ACSQM                          CCB002
     C                     MOVE @BRCA     @BRCAM                          CCB002
      *
      ** Calculate close account condition check
     C                     EXSR RTCLSE
      *
      ** If no terminal error(s) exist?
     C           @TI       IFEQ 0
      *
      ** Calculate close details
     C                     MOVELSCCY1     @CCY
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CP12                                           S01408
     C*                                                                   S01408
      *                                                                                       CDL013
     C           CDL013    IFEQ 'Y'                                                           CDL013
     C                     EXSR #ERTCL                                                        CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C                     EXSR RTCLSC
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      *
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CP13                                           S01408
     C*                                                                   S01408
      ** If record not found?
     C           *IN80     IFEQ '1'
      *                                                    ***************
     C                     Z-ADD11        DBASE            ** DB ERR 11 **
     C                     EXSR DBERR                      ***************
     C                     END
      *
      ** If no terminal error(s) exist?
     C           @TI       IFEQ 0
      *
      ** Remove any warning messages since same routines will validate again
     C                     Z-ADD0         @WI
     C                     MOVEA*BLANKS   @W
      *
      ** Prepare output fields for account closing balances
      ** and set on display indicator
     C                     Z-ADD@TCDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@INTR     ZFLD15
     C                     Z-ADD@INTR     @INTRS 150                      106661
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SINTR
     C*
     C**  Show W/TAX if the customer is liable to tax and WT is not 0
     C*
     C           BBTAIN    IFEQ 'Y'
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CP15                                           S01408
     C*                                                                   S01408
      *                                                                                       CDL013
     C** Show W/TAX if Tax indicator is valid and tax is not zero.                            CDL013
     C           CDL013    OREQ 'Y'                                                           CDL013
     C           BBTAIN    ANDNE'0'                                                           CDL013
     C           @WTAX     ANDNE0
     C                     Z-ADD@TCDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@WTAX     ZFLD15
     C                     ADD  @WTAX     @INTRS                          106661
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SWTAX
     C*
     C                     MOVE '1'       *IN76
     C*
     C                     ELSE
     C*
     C                     MOVE '0'       *IN76
     C*
     C                     END
      *
     C                     Z-ADD@TCDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@CHRG     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SCHRG
      *
     C                     Z-ADD@TCDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@CLOB     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SCLOB
      *
     C                     SETON                     29
     C/COPY WNCPYSRC,RE4121C017
      *
      ** Perform work with account
     C                     EXSR WRKACC
      *
     C                     END
      *
     C                     END
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
     C                     SETON                     2022
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
     C                     END
      *
     C                     END
      *
     C                     SETOF                     40
      *
     C**********           CLOSERECRG                                     153001
     C                     CLOSEREIAC
     C                     CLOSEREACR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      ** SR.ZACCH  subroutine
      /COPY ZSRSRC,ZACCH
      *
      *****************************************************************
      /EJECT
      ** SR.ZALIGN subroutine
      /COPY ZSRSRC,ZALIGNZ2
      *
      *****************************************************************
      /EJECT
      ** SR.ZCHKH  subroutine
      /COPY ZSRSRC,ZCHKH
      *
      *****************************************************************
      /EJECT
      ** SR.ZDATE1 subroutine
      /COPY ZSRSRC,ZDATE1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZDATE2 subroutine
      /COPY ZSRSRC,ZDATE2Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZFWDT  Subroutine
      /COPY ZSRSRC,ZFWDT
      *
      *****************************************************************
      /EJECT
      ** SR.ZTNLU1 Subroutine
      /COPY ZSRSRC,ZTNLU1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZFRPED Subroutine
      /COPY ZSRSRC,ZFRPEDZ3
      *
      *****************************************************************                       CRE081
      /EJECT                                                                                  CRE081
      *****************************************************************                       CRE081
      *                                                               *                       CRE081
      *  VALABC - Validate Account Balance Check in RPG               *                       CRE081
      *                                                               *                       CRE081
      *       NOTE: Any changes done to this subroutine must          *                       CRE081
      *             be done also to the following programs:           *                       CRE081
      *             RE4116, RE4117, RE4118, RE4119, and RE4121        *                       CRE081
      *                                                               *                       CRE081
      *****************************************************************                       CRE081
      *                                                                                       CRE081
     C           VALABC    BEGSR                                                              CRE081
      *                                                                                       CRE081
      ** Initialise override array elements as per SR RTABAL                                MD020635
      *                                                                                     MD020635
     C           PFNCD     IFNE '***'                                                       MD020635
     C                     MOVE ' '       @O,@IF                                            MD020635
     C                     MOVE ' '       @O,@OD                                            MD020635
     C                     MOVE ' '       @O,@MB                                            MD020635
     C                     ENDIF                                                            MD020635
      *                                                                                     MD020635
     C                     MOVE SACNO1    PRTAC                                               CRE081
     C                     CALL 'RE001590'                                                    CRE081
     C                     PARM           PRTAC                                               CRE081
     C                     PARM *BLANKS   PCUSN   6                                           CRE081
     C                     PARM *BLANKS   PCURR   3                                           CRE081
     C                     PARM 0         PACOD                                               CRE081
     C                     PARM 0         PASEQ                                               CRE081
     C                     PARM *BLANKS   PBRCH   3                                           CRE081
     C                     PARM 'RETELD'  PTRTYP 10                                           CRE081
     C                     PARM @VLDT     PVLDAT                                              CRE081
     C                     PARM @TNAM     PAMT                                                CRE081
     C                     PARM *BLANKS   PERR01  7                                           CRE081
     C                     PARM *BLANKS   PERR02  7                                           CRE081
     C                     PARM 0         PACBAL                                              CRE081
     C                     PARM 0         PAVBAL                                              CRE081
     C                     PARM 0         PFLDAT                                              CRE081
     C                     PARM 0         PFLBAL                                              CRE081
      *                                                                                       CRE081
     C           PERR01    IFEQ 'ABC0001'                                                     CRE081
      *                                                                                       CRE081
     C           @V,@MB    IFEQ 'Y'                                                           CRE081
     C                     ADD  1         @WI                                                 CRE081
     C                     MOVEL'BLW.MIN' @W,@WI                                              CRE081
     C                     MOVEL'Y'       @O,@MB                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C           @V,@MB    IFEQ 'N'                                                           CRE081
     C                     ADD  1         @TI                                                 CRE081
     C                     MOVEL'BLW.MIN' @T,@TI                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C           PERR02    IFNE *BLANKS                                                       CRE081
      *                                                                                   AR1087355C
      ** Call RIBALENQY to get Closing Balance                                            AR1087355C
      *                                                                                   AR1087355C
     C                     CALL RIBALQ                                                    AR1087355C
     C                     PARM '00N'     @@FNCD  3                                       AR1087355C
     C                     PARM SACNO1    @@ACNO 10                                       AR1087355C
     C                     PARM *BLANKS   @ACCY   3                                       AR1087355C
     C                     PARM *BLANKS   @ACBL  22                                       AR1087355C
      *                                                                                   AR1087355C
     C                     MOVE *BLANKS   ZWLFLD                                          AR1087355C
     C                     MOVEL@ACBL     ZWLFLD                                          AR1087355C
      *                                                                                   AR1087355C
      ** Get currency details                                                             AR1087355C
      *                                                                                   AR1087355C
     C                     CALL 'AOCURRR0'                                                AR1087355C
     C                     PARM '*BLANK ' @RTCD   7                                       AR1087355C
     C                     PARM '*KEY   ' @OPTN   7                                       AR1087355C
     C           @ACCY     PARM @ACCY     @CCY                                            AR1087355C
     C           SDCURR    PARM SDCURR    DSSDY                                           AR1087355C
      *                                                                                   AR1087355C
      ** If record found                                                                  AR1087355C
      *                                                                                   AR1087355C
     C           @RTCD     IFNE *BLANK                                                    AR1087355C
     C           *LOCK     IN   LDA                        ***************                AR1087355C
     C                     Z-ADD900       DBASE            ** DB ERR 900**                AR1087355C
     C                     MOVE 'SDCURR'  DBFILE           ***************                AR1087355C
     C                     MOVEL@CCY      DBKEY                                           AR1087355C
     C                     EXSR DBERR                                                     AR1087355C
     C                     ENDIF                                                          AR1087355C
      *                                                                                   AR1087355C
     C                     Z-ADDA6NBDP    ZADEC                                           AR1087355C
     C           15        SUB  A6NBDP    ZADIG                                           AR1087355C
      *                                                                                   AR1087355C
     C                     CALL 'ZALIGNB'                                                 AR1087355C
     C                     PARM *BLANKS   ZRTN    7                                       AR1087355C
     C                     PARM           ZWLFLD 20                                       AR1087355C
     C                     PARM *BLANKS   ZFIELD 16                                       AR1087355C
     C                     PARM           ZADEC   10                                      AR1087355C
     C                     PARM           ZADIG   20                                      AR1087355C
     C                     PARM *BLANKS   ZAFLD  16                                       AR1087355C
      *                                                                                   AR1087355C
     C                     Z-ADD0         @@CLOB 150                                      AR1087355C
     C                     MOVE ZAFLD     @@CLOB                                          AR1087355C
      *                                                                                   AR1087355C
     C           @TNAM     IFGT PAVBAL                                                    AR1087355C
     C           @TNAM     ANDLE@@CLOB                                                    AR1087355C
     C                     ELSE                                                           AR1087355C
      *                                                                                     MD020701
     C           @ODLN     IFEQ 0                                                           MD020701
     C           @ODED     ORLT @RUND                                                       MD020701
     C           @V,@IF    IFEQ 'Y'                                                         MD020701
     C                     ADD  1         @WI                                               MD020701
     C                     MOVEL'N.S.F.'  @W,@WI                                            MD020701
     C                     MOVE 'Y'       @O,@IF                                            MD020701
     C                     ENDIF                                                            MD020701
     C           @V,@IF    IFEQ 'N'                                                         MD020701
     C                     ADD  1         @TI                                               MD020701
     C                     MOVEL'N.S.F.'  @T,@TI                                            MD020701
     C                     ENDIF                                                            MD020701
     C                     ELSE                                                             MD020701
      *                                                                                     MD020701
     C           @V,@OD    IFEQ 'Y'                                                           CRE081
     C                     ADD  1         @WI                                                 CRE081
     C                     MOVEL'EX.O/D'  @W,@WI                                              CRE081
     C                     MOVEL'Y'       @O,@OD                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C           @V,@OD    IFEQ 'N'                                                           CRE081
     C                     ADD  1         @TI                                                 CRE081
     C                     MOVEL'EX.O/D'  @T,@TI                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDIF                                                            MD020701
      *                                                                                     MD020701
     C                     ENDIF                                                          AR1087355C
      *                                                                                   AR1087355C
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDSR                                                              CRE081
      *                                                                                       CRE081
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FIRST  - Initial Processing                        *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           FIRST     BEGSR                           ** FIRST  **
      *
      ** Input parameter(s) :
     C           *ENTRY    PLIST                           Entry parameter list
     C                     PARM           PFNCD   3        Function code
      *
      ** Define keylist(s)
      *
      ** Currency details
     C           KLBANK    KLIST
     C                     KFLD           BJBANK
      *
      ** Retail details
     C           KLRETD    KLIST
     C                     KFLD           BMRETL
      *
      *
      ** Account numbers cross reference
     C           KLACNO    KLIST
     C                     KFLD           KACNO  100
      *
      ** Account master
     C           KLACNT    KLIST
     C                     KFLD           @CNUM
     C                     KFLD           @CCY
     C                     KFLD           @ACOD
     C                     KFLD           @ACSQ
     C                     KFLD           @BRCA
     C*
     C**  Retail commission
     C*
     C           KLCOMM    KLIST
     C                     KFLD           @BRCA
     C                     KFLD           @CNUM
     C                     KFLD           @CCY
     C                     KFLD           @ACOD
     C                     KFLD           @ACSQ
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CP11                                           S01408
     C*                                                                   S01408
     C*
     C/COPY ZSRSRC,RTINDEF2
     C**  RTS key field and field definitions
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CP10                                           S01408
     C*                                                                   S01408
     C*
     C           KSWEEP    KLIST                                                              249968
     C                     KFLD           @CNUM                                               249968
     C                     KFLD           CCY                                                 249968
     C                     KFLD           @ACOD                                               249968
     C                     KFLD           @ACSQ                                               249968
     C                     KFLD           @BRCA                                               249968
      *                                                                                       253689
     C           KSWP1     KLIST                                                              253689
     C                     KFLD           @BRCA                                               253689
     C                     KFLD           @CNUM                                               253689
     C                     KFLD           CCY                                                 253689
     C                     KFLD           @ACOD                                               253689
     C                     KFLD           @ACSQ                                               253689
      *                                                                                       253689
      ** Klist for chaining retail account number                                             253689
      *                                                                                       253689
     C           KSWP2     KLIST                                                              253689
     C                     KFLD           @ACNO                                               253689
      *
     C           KACO      KLIST                                                              249968
     C                     KFLD           @ACNO                                               249968
     C                     KFLD           @ACSQ                                               249968
      *                                                                                       263834
     C           SWAKEY    KLIST                                                              263834
     C                     KFLD           WWBRCA  3                                           263834
     C                     KFLD           WWCNBR  6                                           263834
     C                     KFLD           WWCCY   3                                           263834
     C                     KFLD           WWACOD 100                                          263834
     C                     KFLD           WWACSQ  20                                          263834
      *                                                                                       263834
      ** Retrieve RTS job dataarea
     C           *NAMVAR   DEFN           RTSDTA
     C                     IN   RTSDTA
      *
      ** Reset LDA
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBLOT
     C                     OUT  LDA
     C*
     C**  Access General Ledger details
     C*
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C********** SDGELR    PARM SDGELR    DSFDY                                               CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C*
     C**  Check if 'PROFIT CENTRE USED'
     C*
     C           BKPRCU    IFEQ 'Y'
     C                     SETON                     16
     C                     END
     C*
     C**  Access bank details
     C*
     C                     CALL 'AOBANKR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
     C*
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE           ***************
     C                     MOVEL@OPTN     DBKEY            ** DB ERR 12 **
     C                     Z-ADD12        DBASE            **************
     C                     EXSR DBERR
     C                     END
      *
      ** Set up local currency
     C                     MOVE BJLCCY    @CCY
     C                     EXSR RTCCYS
      *
      ** If record not found?
     C*
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVELBJLCCY    DBKEY            ** DB ERR 13 **
     C                     Z-ADD13        DBASE            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**  Set up base currency
     C*
     C           BJLCCY    IFNE BJCYCD
     C                     MOVE BJCYCD    @CCY
     C                     EXSR RTCCYS
     C*
     C** If record not found?
     C*
     C************IN80     IFEQ '1'                                       140802
     C           @RTCD     IFNE *BLANK                                    140802
     C           *LOCK     IN   LDA                        ***************
     C                     MOVE '17'      DBASE            ** DB ERR 17 **
     C                     MOVE 'SDCURRPD'DBFILE           ***************
     C                     MOVEL@CCY      DBKEY
     C                     EXSR DBERR
     C                     END
     C                     END
     C*
      *
      ** Set up date format indicator
     C           BJDFIN    IFEQ 'D'
     C                     SETOF                     98
     C                     ELSE
     C                     SETON                     98
     C                     END
     C*
     C**  Access Tax ICD for rate. Default is ZERO.
     C*
     C                     Z-ADD0         TXWTRR
     C                     OPEN SDSTAXPD
     C           1         CHAINSDSTAXPD             70
     C                     CLOSESDSTAXPD
     C*
     C** Error in SDSTAXPD
     C*
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     MOVE '18'      DBASE            ** DB ERR 18 **
     C                     MOVE 'SDSTAXPD'DBFILE           ***************
     C                     MOVEL'1'       DBKEY
     C                     EXSR DBERR
     C                     END
     C*
     C*
     C**  Get Retail Details
     C*
     C                     CALL 'AORETLR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDRETL    PARM SDRETL    DSFDY
     C*
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDRETLPD'DBFILE           ***************
     C                     MOVEL@OPTN     DBKEY            ** DB ERR 14 **
     C                     Z-ADD14        DBASE            ***************
     C                     EXSR DBERR
     C                     END
     C*
     C**  Access function code details
     C*
     C                     CALL 'AOFNCDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM PFNCD     @FNCD   3
     C           SDFNCD    PARM SDFNCD    DSFDY
     C*
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD15        DBASE            ** DB ERR 15 **
     C                     MOVEL'SDFNCDPD'DBFILE           ***************
     C                     MOVELPFNCD     DBKEY
     C                     EXSR DBERR
     C                     END
      *                                                                   CRT007
      ** Determine if SAR CRT003 Cashier Interface is installed           CRT007
      *                                                                   CRT007
     C                     CALL 'AOSARDR0'                                CRT007
     C                     PARM *BLANKS   PRTCD   7                       CRT007
     C                     PARM '*VERIFY 'POPTN   7                       CRT007
     C                     PARM 'CRT003'  PSARD   6                       CRT007
     C           SCSARD    PARM SCSARD    DSFDY                           CRT007
      *                                                                   CRT007
     C           PRTCD     IFNE *BLANKS                                   CRT007
     C           PRTCD     ANDNE'*NRF   '                                 CRT007
     C           *LOCK     IN   LDA                                       CRT007
     C                     MOVEL'SCSARDPD'DBFILE                          CRT007
     C                     Z-ADD8         DBASE                           CRT007
     C                     MOVEL'CRT003'  DBKEY                           CRT007
     C                     EXSR DBERR                                     CRT007
     C                     ENDIF                                          CRT007
      *                                                                   CRT007
     C           PRTCD     IFEQ *BLANKS                                   CRT007
     C                     MOVE 'Y'       CRT003                          CRT007
     C                     ELSE                                           CRT007
     C                     MOVE 'N'       CRT003                          CRT007
     C                     ENDIF                                          CRT007
      *                                                                                       CRT026
      ** Check if CRT026 is switched on                                                       CRT026
      *                                                                                       CRT026
     C                     CALL 'AOSARDR0'                                                    CRT026
     C                     PARM *BLANKS   PRTCD                                               CRT026
     C                     PARM '*VERIFY' POPTN                                               CRT026
     C                     PARM 'CRT026'  PSARD                                               CRT026
     C           SCSARD    PARM SCSARD    DSFDY                                               CRT026
      *                                                                                       CRT026
     C           PRTCD     IFNE *BLANKS                                                       CRT026
     C           PRTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'SCSARDPD'DBFILE           ***************                    CRT026
     C                     Z-ADD16        DBASE            ** DB ERR 16 **                    CRT026
     C                     MOVEL'CRT026'  DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           PRTCD     IFEQ *BLANKS                                                       CRT026
     C                     MOVE 'Y'       CRT026  1                                           CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'N'       CRT026                                              CRT026
     C                     ENDIF                                                              CRT026
      *                                                                   CCB002
      ** Store validation indicators in an array                          CCB002
      *                                                                   CCB002
     C                     MOVEAFQVWIN    @V                              CCB002
     C*                                                                   S01408
      *                                                                                       CDL013
      *** Check if CAR CDL013 is installed                                                    CDL013
     C                     CALL 'AOSARDR0'                                                    CDL013
     C                     PARM '*BLANKS' @RTCD                                               CDL013
     C                     PARM '*VERIFY' @OPTN                                               CDL013
     C                     PARM 'CDL013'  @SARD   6                                           CDL013
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL013
      *                                                                                       CDL013
      *** CAR CDL013 is NOT installed                                                         CDL013
     C           @RTCD     IFNE *BLANKS                                                       CDL013
     C                     MOVE 'N'       CDL013  1                                           CDL013
      *                                                                                       CDL013
      *** CAR CDL013 is installed                                                             CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C                     MOVE 'Y'       CDL013  1                                           CDL013
     C                     MOVEL'RETAIL'  ULSTAX 10 P                                         CDL013
      *                                                                                       CDL013
      *** Access WHT ICD record to determine WHT rate.                                        CDL013
     C                     OPEN SDSTAAL1                                                      CDL013
     C           ULSTAX    CHAINSDSTAAL1             70                                       CDL013
      *                                                                                       CDL013
     C           *IN70     IFEQ *ON                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'SDSTAAL1'DBFILE           ************                       CDL013
     C                     MOVEL'RETAIL'  DBKEY            * DBERR 50 *                       CDL013
     C                     Z-ADD50        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      *** Open Account Details Extension file                                                 CDL013
     C                     OPEN ACCNTBY0                                                      CDL013
      *                                                                                       CDL013
      *** Retrieve Base CCy details                                                           CDL013
     C                     MOVE BJCYCD    @CCY                                                CDL013
     C                     EXSR RTCCYS                                                        CDL013
     C                     MOVE @CCY      ZCCYT                                               CDL013
     C                     Z-ADDTRT,@I    ZRATET                                              CDL013
     C                     MOVE TDP,@I    ZCDPT                                               CDL013
     C                     MOVE TMD,@I    ZMDINT                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CAP205
      ** Access SAR details file to see if CAP205 is installed.                               CAP205
      *                                                                                       CAP205
     C                     CALL 'AOSARDR0'                                                    CAP205
     C                     PARM *BLANKS   PRTCD                                               CAP205
     C                     PARM '*VERIFY' POPTN                                               CAP205
     C                     PARM 'CAP205'  PSARD                                               CAP205
     C           SCSARD    PARM SCSARD    DSFDY                                               CAP205
      *                                                                                       CAP205
     C                     MOVE 'N'       CAP205  1                                           CAP205
     C           PRTCD     IFEQ *BLANKS                                                       CAP205
     C                     MOVE 'Y'       CAP205                                              CAP205
     C                     ELSE                                                               CAP205
     C           PRTCD     IFNE '*NRF    '                                                    CAP205
     C           *LOCK     IN   LDA                                                           CAP205
     C                     MOVEL'SCSARDPD'DBFILE                                              CAP205
     C                     MOVEL'CAP205'  DBKEY                                               CAP205
     C                     Z-ADD58        DBASE                                               CAP205
     C                     EXSR DBERR                                                         CAP205
     C                     ENDIF                                                              CAP205
     C                     ENDIF                                                              CAP205
      *                                                                                       CDL081
      ** Check if CDL081 is installed                                                         CDL081
      *                                                                                       CDL081
     C                     MOVE 'N'       CDL081  1                                           CDL081
     C                     CALL 'AOSARDR0'                                                    CDL081
     C                     PARM *BLANKS   PRTCD                                               CDL081
     C                     PARM '*VERIFY' POPTN                                               CDL081
     C                     PARM 'CDL081'  PSARD                                               CDL081
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL081
      *                                                                                       CDL081
     C           PRTCD     IFNE *BLANKS                                                       CDL081
     C           PRTCD     ANDNE'*NRF   '                                                     CDL081
     C           *LOCK     IN   LDA                                                           CDL081
     C                     Z-ADD056       DBASE                                               CDL081
     C                     MOVE 'SCSARDPD'DBFILE                                              CDL081
     C                     MOVEL'CDL081'  DBKEY                                               CDL081
     C                     EXSR DBERR                                                         CDL081
     C                     END                                                                CDL081
      *                                                                                       CDL081
     C           PRTCD     IFEQ *BLANKS                                                       CDL081
     C                     MOVE 'Y'       CDL081                                              CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL081
      ** Access withholding tax round down system values if CDL081 is on                      CDL081
      *                                                                                       CDL081
     C           CDL081    IFEQ 'Y'                                                           CDL081
     C                     CALL 'AOSVALR0'                                                    CDL081
     C                     PARM *BLANKS   PRTCD                                               CDL081
     C                     PARM C#BASE    SVALK1 20                                           CDL081
     C                     PARM           SVAL1 200                                           CDL081
     C                     PARM C#NBAS    SVALK2 20                                           CDL081
     C                     PARM           SVAL2 200                                           CDL081
     C                     PARM *BLANK    SVALK3 20                                           CDL081
     C                     PARM           SVAL3 200                                           CDL081
     C                     PARM *BLANK    SVALK4 20                                           CDL081
     C                     PARM           SVAL4 200                                           CDL081
     C                     PARM *BLANK    SVALK5 20                                           CDL081
     C                     PARM           SVAL5 200                                           CDL081
     C                     PARM *BLANK    SVALK6 20                                           CDL081
     C                     PARM           SVAL6 200                                           CDL081
     C                     PARM *BLANK    SVALK7 20                                           CDL081
     C                     PARM           SVAL7 200                                           CDL081
     C                     PARM *BLANK    SVALK8 20                                           CDL081
     C                     PARM           SVAL8 200                                           CDL081
     C                     PARM *BLANK    SVALK9 20                                           CDL081
     C                     PARM           SVAL9 200                                           CDL081
     C                     PARM *BLANK    SVALK0 20                                           CDL081
     C                     PARM           SVAL10200                                           CDL081
      *                                                                                       CDL081
     C           PRTCD     IFNE *BLANKS                                                       CDL081
     C           *LOCK     IN   LDA                                                           CDL081
     C                     Z-ADD057       DBASE                                               CDL081
     C                     MOVE 'SDSVALPD'DBFILE                                              CDL081
     C           SVAL1     IFEQ '*NRF'                                                        CDL081
     C                     MOVELSVALK1    DBKEY                                               CDL081
     C                     ENDIF                                                              CDL081
     C           SVAL2     IFEQ '*NRF'                                                        CDL081
     C                     MOVELSVALK2    DBKEY                                               CDL081
     C                     ENDIF                                                              CDL081
     C                     EXSR DBERR                                                         CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL081
      ** Setup tax amount rounding down indicators                                            CDL081
      *                                                                                       CDL081
     C                     MOVELSVAL1     W#BSRD  1                                           CDL081
     C                     MOVELSVAL2     W#NBRD  1                                           CDL081
     C                     ENDIF                                                              CDL081
     C/COPY WNCPYSRC,RE4121CCP4                                           S01408
     C*                                                                   S01408
     C*
     C**  Define Error Message Fields
     C*
     C                     MOVE *BLANKS   @MSGID  7
     C                     MOVEL'RTSMSGF' @MSGF  10
      *                                                                                       263834
      ** Initialise fields to be used for message text retrieval                              263834
      *                                                                                       263834
     C                     MOVEL*BLANK    ZAPGM  10                                           263834
     C                     MOVEL'RTSMSGF' ZAMSGF 10                                           263834
     C                     MOVEL*BLANK    ZAPGRL  5                                           263834
     C                     MOVEL*BLANK    ZAMSID  7                                           263834
     C                     MOVEL*BLANK    ZAMSDA132                                           263834
     C                     MOVEL*BLANK    ZAMSTP  7                                           263834
     C*
     C**  Initialise Screen fields
     C*
     C                     SETON                     10
     C                     MOVEL@PGM      SPGMQ
     C                     MOVEL@JOB      SWID
     C                     MOVEL@USER     SUSER
     C                     MOVELBJMRDT    SMRDT
     C*
     C**  Initialise work fields and indicators
     C*
     C                     Z-ADD0         @TAMT  150
     C                     Z-ADD1         @WX     20
     C                     Z-ADDPCHTL     @CHTL
     C                     Z-ADDPNCTL     @NCTL
     C                     Z-ADD1         @COUNT  10
     C                     Z-ADDBJRDNB    @RUND
     C                     Z-ADDBJRDNB    RUND    50
     C/COPY WNCPYSRC,RE4121C015
     C*                                                                                       CRE081
      ** Perform Account Balance Check in RPG if feature CRE081 is ON                         CRE081
      *                                                                                       CRE081
     C                     CALL 'AOSARDR0'                                                    CRE081
     C                     PARM *BLANKS   PRTCD                                               CRE081
     C                     PARM '*KEY   ' POPTN                                               CRE081
     C                     PARM 'CRE081'  PSARD                                               CRE081
     C           SCSARD    PARM SCSARD    DSFDY                                               CRE081
      *                                                                                       CRE081
     C                     MOVE 'N'       CRE081  1                                           CRE081
     C           PRTCD     IFEQ *BLANKS                                                       CRE081
     C                     MOVE 'Y'       CRE081                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CCG016
     C                     MOVEL*BLANKS   CCG016  1                                           CCG016
     C                     CALL 'AOSARDR0'                                                    CCG016
     C                     PARM *BLANKS   PRTCD   7                                           CCG016
     C                     PARM '*VERIFY' POPTN   7                                           CCG016
     C                     PARM 'CCG016'  PSAR    6                                           CCG016
     C           PRTCD     IFEQ *BLANKS                                                       CCG016
     C                     MOVEL'Y'       CCG016                                              CCG016
     C                     END                                                                CCG016
     C*
     C                     ENDSR
      *****************************************************************
      *---------------------------------------------------------------*                       CDL013
     C           #ERTCL    BEGSR                                                              CDL013
      *                                                                                       CDL013
      ** Define parameters                                                                    CDL013
      *                                                                                       CDL013
     C                     Z-ADD@ACNO     @ACNO  100                                          CDL013
     C                     Z-ADD@CLBL     @CLBL  150                                          CDL013
     C                     Z-ADD@CHRG     @CHRG  150                                          CDL013
     C                     Z-ADD@INTR     @INTR  150                                          CDL013
     C                     Z-ADD@CLOB     @CLOB  150                                          CDL013
      *                                                                                       CDL013
     C                     Z-ADD@INTT     @INTT  150                                          CDL013
     C                     Z-ADD@WTAX     @WTAX  150                                          CDL013
     C                     Z-ADD@ACOD     @ACOD  100                                          CDL013
     C                     Z-ADDRHISD     RHISD   50                                          CDL013
     C                     Z-ADDRHISB     RHISB  150                                          CDL013
      *                                                                                       CDL013
      * Retrieve retail interest and charges                                                  CDL013
      *                                                                                       CDL013
     C           KLACNT    CHAINREIAC                80                                       CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '1'                                                           CDL013
      *                                                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL@ACCN     DBKEY                                               CDL013
     C                     MOVEL'REIAC'   DBFILE                                              CDL013
      *                                                                                       CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      * Retrieve retail interest accrual ITD                                                  CDL013
      *                                                                                       CDL013
     C           KLACNT    CHAINREACR                80                                       CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '1'                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL@ACNO     DBKEY                                               CDL013
     C                     MOVEL'REACR'   DBFILE                                              CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** If no database errors                                                                CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '0'                                                           CDL013
      *                                                                                       CDL013
      ** Calculate charges                                                                    CDL013
      *                                                                                       CDL013
     C                     Z-ADDCHGT      @CHGT                                               CDL013
     C                     Z-ADDCHST      @CHST                                               CDL013
     C                     MOVEL@CCY      @CHCY                                               CDL013
     C                     MOVELCHAC      @CHAC                                               CDL013
     C                     Z-ADDRCA       @RCA                                                CDL013
     C                     Z-ADDNRCA      @NRCA                                               CDL013
     C                     Z-ADDLCD       RHISD                                               CDL013
     C                     Z-ADDHISB      RHISB                                               CDL013
      *                                                                                       CDL013
      *                                                                                       CDL013
      ** Get fixed account charge                                                             CDL013
      *                                                                                       CDL013
     C                     MOVE @BRCA     @BRCDX  3                                           CDL013
     C           KFXA      CHAINREFXAJL0             88                                       CDL013
     C                     Z-ADDRYACCH    @FXACM                                              CDL013
      *                                                                                       CDL013
     C                     EXSR RTCHRG                                                        CDL013
      *                                                                                       CDL013
      *  Calculate commissions - added to @CHRG                                               CDL013
      *                                                                                       CDL013
     C                     EXSR RTCOMM                                                        CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '0'                                                           CDL013
      *                                                                                       CDL013
      ** Calculate interest                                                                   CDL013
      *                                                                                       CDL013
     C                     MOVELDACP      @DACP  21                                           CDL013
     C                     MOVELCACP      @CACP  21                                           CDL013
     C                     Z-ADDMADI      @MADI  130                                          CDL013
     C                     Z-ADDMACI      @MACI  130                                          CDL013
     C                     Z-ADDGADI      @GADI  130                                          CDL013
     C                     Z-ADDGACI      @GACI  130                                          CDL013
     C                     Z-ADDDAIC1     @DAIC1 130                                          CDL013
     C                     Z-ADDCAIC1     @CAIC1 130                                          CDL013
      *                                                                                       CDL013
     C                     EXSR RTINTR                                                        CDL013
      *                                                                                       CDL013
      ** Add net-interest & service charge to close balance                                   CDL013
      *                                                                                       CDL013
     C           @INTR     ADD  @CHRG     @CLOB                                               CDL013
      *                                                                                       CDL013
      ** If the customer is liable calculate tax                                              CDL013
      *                                                                                       CDL013
     C           BBCSTY    IFNE 'N'                                                           CDL013
      *                                                                                       CDL013
      ** Include withholding tax in closing balance                                           CDL013
      *                                                                                       CDL013
      ** If SDSTAXPD/TXWNDI is 'Y', compute tax from net interest (sum                        CDL013
      ** of DR and CR interests).  Else, compute tax from gross                               CDL013
      ** interest (CR interest only).                                                         CDL013
      *                                                                                       CDL013
     C           TXWNDI    IFEQ 'Y'                                                           CDL013
     C                     Z-ADD@INTR     @INTT                                               CDL013
     C                     ELSE                                                               CDL013
     C                     Z-SUB@CRINT    @INTT                                               CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** If the resulting interest is zero or debit, no need to compute                       CDL013
      ** for the w/holding tax.  It is automatically equal to zero.                           CDL013
      *                                                                                       CDL013
     C           @INTT     IFGE *ZERO                                                         CDL013
     C                     Z-ADD*ZERO     @WTAX                                               CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      * Retrieve Taxable indicator for this Account.                                          CDL013
      *                                                                                       CDL013
     C           ACNTXF    KLIST                                                              CDL013
     C                     KFLD           @CNUM                                               CDL013
     C                     KFLD           @CCY                                                CDL013
     C                     KFLD           @ACOD                                               CDL013
     C                     KFLD           @ACSQ                                               CDL013
     C                     KFLD           @BRCDX                                              CDL013
      *                                                                                       CDL013
     C           ACNTXF    CHAINACCNTBY0             70                                       CDL013
     C           *IN70     IFEQ *ON                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'ACCNTBY0'DBFILE           ************                       CDL013
     C                     MOVEL@CNUM     DBKEY            * DBERR 22 *                       CDL013
     C                     Z-ADD22        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      *** If Tax indicator is ZERO set WHT rate to ZERO,                                      CDL013
      *** otherwise set WHT rate.                                                             CDL013
     C                     SELEC                                                              CDL013
     C           ATITAX    WHEQ '0'                                                           CDL013
     C                     Z-ADD0         ULWHTR  52                                          CDL013
     C           ATITAX    WHEQ '1'                                                           CDL013
     C                     Z-ADDETXR1     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '2'                                                           CDL013
     C                     Z-ADDETXR2     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '3'                                                           CDL013
     C                     Z-ADDETXR3     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '4'                                                           CDL013
     C                     Z-ADDETXR4     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '5'                                                           CDL013
     C                     Z-ADDETXR5     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '6'                                                           CDL013
     C                     Z-ADDETXR6     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '7'                                                           CDL013
     C                     Z-ADDETXR7     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '8'                                                           CDL013
     C                     Z-ADDETXR8     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '9'                                                           CDL013
     C                     Z-ADDETXR9     ULWHTR                                              CDL013
     C                     ENDSL                                                              CDL013
      *                                                                                       CDL013
      *** If WHT rate is ZERO set tax amount to ZERO.                                         CDL013
     C           ULWHTR    IFEQ *ZERO                                                         CDL013
     C                     Z-ADD0         @WTAX                                               CDL013
      *                                                                                       CDL013
      *** otherwise calculate tax amount.                                                     CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      *** If Account currency is in Base Currency.                                            CDL013
      *** and CDL081 is off                                                                   CDL081
      *                                                                                       CDL081
     C           @CCY      IFEQ BJCYCD                                                        CDL013
     C           CDL081    ANDEQ'N'                                                           CDL081
      *                                                                                       CDL013
      *** Set work adjustment field according to number of decimal                            CDL013
      *** places in currency before calculating the tax amount.                               CDL013
     C                     SELEC                                                              CDL013
     C           ZCDPT     WHEQ 0                                                             CDL013
     C                     Z-ADD1         ULWKAD  40                                          CDL013
     C           ZCDPT     WHEQ 1                                                             CDL013
     C                     Z-ADD10        ULWKAD                                              CDL013
     C           ZCDPT     WHEQ 2                                                             CDL013
     C                     Z-ADD100       ULWKAD                                              CDL013
     C           ZCDPT     WHEQ 3                                                             CDL013
     C                     Z-ADD1000      ULWKAD                                              CDL013
     C                     ENDSL                                                              CDL013
      *                                                                                       CDL013
      *** Account currency is in Base Currency round down gross                               CDL013
      *** Interest Amount.                                                                    CDL013
     C           @INTT     DIV  ULWKAD    ULTINT 150                                          CDL013
     C                     MULT ULWKAD    ULTINT                                              CDL013
      *                                                                                       CDL013
      *** calculate Tax Amount.                                                               CDL013
     C           ULTINT    MULT ULWHTR    @WTAX                                               CDL013
     C                     DIV  100       @WTAX                                               CDL013
      *                                                                                       CDL013
      *** round down Tax Amount.                                                              CDL013
     C           @WTAX     DIV  ULWKAD    @WTAX  150                                          CDL013
     C                     MULT ULWKAD    @WTAX                                               CDL013
      *                                                                                       CDL013
      *** otherwise (Account Ccy NOT = Base Ccy) calculate                                    CDL013
      *** Tax amount without rounding down.                                                   CDL013
     C                     ELSE                                                               CDL013
     C           @INTT     MULT ULWHTR    @WTAX                                               CDL013
      *                                                                                       CDL081
      ** Check if tax amount is to be rounded down                                            CDL081
      *                                                                                       CDL081
     C           @CCY      IFEQ BJCYCD                                                        CDL081
     C           CDL081    ANDEQ'Y'                                                           CDL081
     C           W#BSRD    ANDEQ'Y'                                                           CDL081
     C           @CCY      ORNE BJCYCD                                                        CDL081
     C           CDL081    ANDEQ'Y'                                                           CDL081
     C           W#NBRD    ANDEQ'Y'                                                           CDL081
     C                     DIV  100       @WTAX                                               CDL081
     C                     ELSE                                                               CDL081
     C                     DIV  100       @WTAX     H                                         CDL013
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL013
      ** Calculate the interest amount in base currency (ULTINT)                              CDL013
      *                                                                                       CDL013
      ** Retrieve Account Ccy details                                                         CDL013
     C                     EXSR RTCCYS                                                        CDL013
     C                     MOVE @CCY      ZCCYF                                               CDL013
     C                     Z-ADDTRT,@I    ZRATEF                                              CDL013
     C                     MOVE TDP,@I    ZCDPF                                               CDL013
     C                     MOVE TMD,@I    ZMDINF                                              CDL013
      *                                                                                       CDL013
      ** Set amount in the Account Ccy                                                        CDL013
     C                     Z-ADD@INTT     ZAMTF                                               CDL013
      *                                                                                       CDL013
      ** Convert the amount to the Base Ccy                                                   CDL013
     C                     EXSR RTCCYX                                                        CDL013
      *                                                                                       CDL013
      ** Set amount in the Base Ccy                                                           CDL013
     C                     Z-ADDZAMTT     ULTINT                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Access account code details                                                          CDL013
      *                                                                                       CDL013
     C                     MOVE @ACOD     @ACODA 10                                           CDL013
      *                                                                                       CDL013
     C                     CALL 'AOACODR0'                                                    CDL013
     C                     PARM *BLANKS   @RTCD                                               CDL013
     C                     PARM '*KEY   ' @OPTN                                               CDL013
     C                     PARM           @ACODA                                              CDL013
     C           SDACOD    PARM SDACOD    DSFDY                                               CDL013
      *                                                                                       CDL013
      ** Error in SDACODPA                                                                    CDL013
      *                                                                                       CDL013
     C           @RTCD     IFNE *BLANKS                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'SDACODPD'DBFILE           ************                       CDL013
     C                     MOVEL@ACODA    DBKEY            * DBERR 21 *                       CDL013
     C                     Z-ADD21        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Check if the interest amount in base ccy is below minimum                            CDL013
     C                     Z-SUBULTINT    ULTINT                                              CDL013
     C           ULTINT    IFLT A5MISU                                                        CDL013
     C                     Z-ADD*ZERO     @WTAX                                               CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Subtract Withholding Tax from Close Balance                                          CDL013
      *                                                                                       CDL013
     C                     Z-SUB@WTAX     @WTAX                                               CDL013
     C                     ADD  @WTAX     @CLOB                                               CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Add cleared balance to close balance                                                 CDL013
      *                                                                                       CDL013
     C                     ADD  @CLBL     @CLOB                                               CDL013
      *                                                                                       CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVE 'RECRG'   DBFILE                                              CDL013
     C                     MOVEL@KEY      DBKEY                                               CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDSR                                                              CDL013
      *****************************************************************                       CDL013
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CCP5                                           S01408
     C*                                                                   S01408
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CCP7                                           S01408
     C*                                                                   S01408
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CCP6                                           S01408
     C*                                                                   S01408
      /EJECT
      *****************************************************************
      *                                                               *
      *            DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLS      *PSSR  - Program  error                            *
      *                                                               *
      * CALLED BY  FIRST  - Initial Processing                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DBERR     BEGSR                           ** DBERR  **
      *
     C                     MOVEL@PGM      DBPGM
     C                     OUT  LDA
      *
     C                     EXSR *PSSR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            LAST   - Final Processing                          *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           LAST      BEGSR                           ** LAST   **
      *
     C                     CLOSE*ALL                   69
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
     C*****************************************************************
     C/EJECT
     C/COPY ZSRSRC,RTCOMMC1
     C**  RTS Calculate Commission for account close
      *                                                                   106661
     C/EJECT                                                              106661
      /COPY ZSRSRC,RTCLOSC1                                               106661
     C*
     C/EJECT
     C/COPY ZSRSRC,RTINTRE
     C**  Interest Calculation between two dates
     C*
     C/EJECT
     C/COPY ZSRSRC,RTCCYXC1
     C**  Convert an amount from one ccy to another using spot rate
     C*
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR             - Program error                             *
      *                                                               *
      * CALLS      DBERRCTL                                           *
      *                                                               *
      * CALLED BY  DBERR  - Database Error Handling                   *
      *                                                               *
      *****************************************************************
     C           *PSSR     BEGSR                           ** *PSSR  **
     C*
     C** Check to see that *PSSR has not been called yet
     C*
     C           WRUN      IFEQ *BLANK
     C                     MOVE 'Y'       WRUN    1
     C                     SETON                     U7U8LR
     C                     DUMP
     C*
     C** Call standard database error program
     C*
     C                     CALL 'DBERRCTL'
     C*
     C                     END
     C*
     C** If *PSSR already run, then just end the program here
     C*
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTENCPC1
      ** Passcode encription
      *
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4121CP14                                           S01408
     C*                                                                   S01408
      *****************************************************************
     O/EJECT
     O*****************************************************************
     O*
     O**  Account Details
     O*
     OACCNTABFE                @RLACC
     O*
     O**  Account Trailer
     O*
     OACCNTACFE                @UPACC
     O*
     O                         NORE
     O                         NINU
     O                         NOAM
     O                         NOCL
     O                         NOAU
     O                         LCD
     O                         TNLU
     O***********                                                         CCB002
     O****Retail*Shadow Balances                                          CCB002
     O***********                                                         CCB002
     O***********MEMOSMDFE                @RLMEM                          CCB002
     O*
     O**  Transaction details file
     O*
     OTTRNTM2FE                @RELTT
      *
      *****************************************************************
     O*                                                                   S01408
     O/COPY WNCPYSRC,RE4121OOP1                                           S01408
     O*                                                                   S01408
**  CPY@ - Copyright statemetnt
(c) Misys International Banking Systems Ltd. 2001
**  POWER - array of powers for currency conversion
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  ZYDY - Years in days cumulative, four year span
0366073110961461
**  ZMDY - Months in days cumulative through year
000031059090120151181212243273304334365
**  ZMNM - Months short names
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  ALPNM - alphanumeric table
ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789
**  ECDT - encription code table
SDKJFIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJ
FIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJFIEN
**  @P - Array to hold the positions of the validation indicators
01020304050607080910111213141516171819202122232425
