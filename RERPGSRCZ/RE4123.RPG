     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE Account closure')                             *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Retail Module                                        *
     F*                                                               *
     F*  RE4123 - Account Closure                                     *
     F*                                                               *
     F*  Function:  This program enquires through an account and      *
     F*  (I/C)      displays amongst other details, the balance of    *
     F*             the account, together with any outstanding        *
     F*             account interest and charges.  If a transaction   *
     F*             is subsequently passed across the account which   *
     F*             brings the available customer balance to zero,    *
     F*             the account will be flagged for closure during    *
     F*             the close of business.                            *
     F*                                                               *
     F*  Called By: Retail Teller System Menu                         *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. CSD103             Date 10Aug20               *
      *  Prev Amend No. MD054057           Date 05Nov19               *
      *                 CER050             Date 16Jun19               *
      *                 MD050139           Date 23Mar18               *
      *                 MD046248           Date 27Oct17               *
      *                 MD034451C          Date 02Mar16               *
      *                 CGL184             Date 07Dec16               *
      *                 218877             Date 26Aug15               *
      *                 CGL165             Date 17Feb15               *
      *                 252150             Date 03Sep12               *
      *                 263834             Date 17Mar10               *
      *                 CRE073             Date 06Dec10               *
      *                 CRE075             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER016             Date 19May08               *
      *                 CER047             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 BUG27532           Date 26Apr10               *
      *                 BUG27045A          Date 13Apr10               *
      *                 BUG27045           Date 18Feb10               *
      *                 CRE401             Date 26Nov09               *
      *                 CDL081             Date 14Dec09               *
      *                 CAP187             Date 21Aug09               *
      *                 260297             Date 19May09               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 253689 (BUG17640)  Date 09Apr08               *
      *                 250891             Date 16Oct07               *
      *                 249968             Date 12Sep07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 242286             Date 25Sep06               *
      *                 CDL013             Date 09Jun06               *
      *                 233332             Date 06Jun06               *
      *                 CSD031             Date 10Apr06               *
      *                 BUG8514            Date 14Jun06               *
      *                 CRT026             Date 23May06               *
      *                 BUG6342            Date 15Apr05               *
      *                 CSD027             Date 09Dec05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CAAA03             Date 22Apr04               *
      *                 CRE019             Date 15Mar04               *
      *                 CGL029             Date 01Sep03               *
      *                 CRT012             Date 26Nov02               *
      * Midas Release 4.01 -------------------------------------------*
     F*                 CRT007             Date 14Jan02               *
      *                 CRT005             Date 27Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CRT006             Date 06Aug01               *
      *                 194978             Date 28Jun01               *
      *                 CDE002             Date 21Dec99               *
      *                 101578             Date 17Apr01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CSD006             Date 17May01               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 153001             Date 27Apr99               *
      *                 CSD005             Date 02MAR99               *
      *                 CTI002             DATE 09Sep98               *
      *                 140802             Date 17Aug98               *
      *                 104270             Date 19Sep97               *
     F*                 114621             Date 21Feb97               *
     F*                 CRT002             Date  1Dec95               *
     F*                 CCB002             DATE 29JUL96               *
     F*                 EEE002             DATE 07FEB97               *
     F*                 S01408             DATE 10APR96               *
     F*                 091241             DATE 17JUL95               *
     F*                 CRT001  *CREATE    DATE 28FEB95               *
     F*                                                               *
     F*---------------------------------------------------------------*
      *                                                               *
      *  CSD103 - LIBOR Deregulation - Common Layer/Standing Data     *
      *  MD054057 - Failure to close an account.  Check correct       *
      *             network files during account closure.             *
      *  CER050 - Annualised Percentage Rate (Recompile)              *
      *  MD050139- AOSARDR0 called every time causing performance     *
      *            issue. Recompile due to changes in /COPY           *
      *            ZFREQ/ZFRQ*.                                       *
      *  MD046248 - Finastra Rebranding                               *
      *  MD034451C - API: Repeated Held Item reversals are allowed.   *
      *              Recompiled due to changed PF/HELDIHB.            *
      *  CGL184 - New Frequencies for Account Statements (Recompile)  *
      *  218877 - Recompiled due to changes in RTCCYSC1               *
      *         - Applied for MD-28376                                *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  252150 - COB component MEC103/GLC48 fails due to FOOB.       *
      *           Amend the program to match MOD/GLAMADUPD process    *
      *           when closing an account that is inserted the same   *
      *           day. Recompiled over changes ZSRSRC.RTACLSC1        *
      *           Applied for AR980794 (Child: AR980795)              *
      *  263834 - Account with Swift reference is deleted causing     *
      *           MEC105 fallover. Amended program in a way that      *
      *           that deletion is not allowed when record exists in  *
      *           file SWACSSB. Applied fix 263818.                   *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER016 - German Interest Calculation: Upgarde of FGE059      *
      *           to Midas Plus (Recompile)                           *
      *  CER047 - German Features LF037-00 Reporting §24c KWG         *
      *           (Recompile)                                         *
      *  BUG27532 - Several fields are blank in the confirmation page *
      *             (Recompile)                                       *
      *  BUG27045A - Override the fix of Bug 27045 (Recompile)        *
      *  BUG27045 - Amend via SOAP removes Document Linkage           *
      *             (Recompile)                                       *
      *  CRE401 - 4-Eyes Checking Gaps - Sweeps (Recompile)           *
      *  CDL081 - Tiered withholding tax rounding upgrade             *
      *  CAP187 - Document Linkage (Recompile)                        *
      *  260297 - Incorrect interest calculation w/ calc basis 6.     *
      *           Recompiled over changes in RTINDEF1 and RTINDEF2.   *
      *           Applied fix 220323.                                 *
      *  253689 - Amend validations of account closure such that      *
      *           the program checks for any outstanding items        *
      *           before closing account (BUG17640)
      *  250891 - Initialise field @SKIP.                             *
      *  249968 - Add Validations if there are Outstanding            *
      *           Held Items, Stopped Checks, Standing Orders         *
      *           and SWEEP before an account is close.               *
      *  242286 - Recompile over changes in /COPY RTINTRE.            *
      *  CDL013 - Tiered Withholding Tax                              *
      *  233332 - Included validation if retail number entered is an  *
      *           alternative a/c when closing an account.            *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  BUG8514 - Issue regarding teller overrides(Recompile)        *
      *  CRT026 - Retail Teller Password Change                       *
      *  BUG6342 - Interest calculation has 0.01 discrepancy.         *
      *            Recompiled over changes in RTINDEF1/2 and RTINTRE. *
      *            Applied fix 220323.                                *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CAAA03 - Webfacing Changes                                   *
      *  CRE019 - Cheque Processing and Maintenance (Recompile)       *
      *  CGL029 - Increase Account Code to 10 digits (Recompile)      *
      *  CRT012 - Recompile over changed TTRANPD                      *
      *  CRT007 - Branch Offline Checking                             *
     F*  CRT005 - Recompiled due to change in RTTWIDC1                *
      *  CRT006 - Cashier Reserve Transactions. Recompile.            *
      *  194978 - Recompiled due to changes in RTTWIDC1.              *
      *  CDE002 - Revenue Analysis - Recompiled due to changes in     *
      *           PF/REFXAJL0.                                        *
     F*  101578 - Recompiled due to change in RTCCYXC1                *
     F*  CSD006 - Use DSSDY for call to AOCURRR0.                     *
      *  153001 - A/c failed to close because minimum charge posted   *
      *           so balance was not zero. File RECRG no longer used  *
      *           as actual charges shown, ie. no minimum or maximum. *
      *           Includes changes to /COPYs RTCHRGC1, RTCLSCC1 &     *
      *           RTCOMMC1.                                           *
      *  CSD005 - Standing Data Account Narrative.  Add new field     *
      *           to SDACODPD.  Recompilation of programs.            *
      *  CTI002 - Recompiled : File SDACODPD changed                  *
     F*  140802 - Recompiled due to change in /COPY RTCCYSC1          *
     F*  104270 - Recompile due to changes to /COPYs RT*.             *
     F*  114621 - Replace blank with 'X' to mean not to validate      *
     F*           condition.                                          *
     F*  CRT002 - Retail Branch Access.                               *
     F*           Introduce /COPY RTCCYSF1 needed when using /COPY    *
     F*           RTCCYSC1.                                           *
     F*  CCB002 - COB Performance Enhancements                        *
     F*           Access now via access object                        *
     F*           Change MEMOS processing to use access objects.      *
     F*  EEE002 - Hook RE4123IIP1 reinserted.                         *
     F*  S01408 - Core hook RE4123CCP6 added- EEE002                  *
     F*           Core hook RE4123CCP5 added- EEE002                  *
     F*           Core hook RE4123CCP4 added- EEE002                  *
     F*           Core hook RE4123CCP3 added- EEE002                  *
     F*           Core hook RE4123CCP2 added- EEE002                  *
     F*           Core hook RE4123CCP1 added                          *
     F*           Core hook RE4123FFP1 added- EEE002                  *
     F*  091241 - ATM Interface.  Recompiled.                         *
     F*  CRT001 - Retail Teller System                                *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     F*
     F/COPY ZSRSRC,RTINDEF3
     FREFXAJL0IF  E           K        DISK
     F** Fixed accounts file
     F*
     FACNUM   IF  E           K        DISK
     F** Account Numbers Cross Reference File
     F            ACCNTABF                          KRENAMEACNUMABF
     F*
     FACCNT   UF  E           K        DISK         KINFSR *PSSR      UC
     F                                              KCOMIT
     F** Account master
      *                                                                                       249968
     FHELDITL0IF  E           K        DISK                                                   249968
      ** Held Items                                                                           249968
     FSTOPCL3 IF  E           K        DISK                                                   249968
     F            STOPCSDF                          KRENAMESTOPCSL3                           249968
      ** Stopped cheques detail                                                               249968
      *                                                                                       249968
     FSTANDL4 IF  E           K        DISK                                                   249968
      ** Standing Orders                                                                      249968
      *                                                                                       249968
     FSTANDL5 IF  E           K        DISK                                                   249968
     F            STANDSBF                          KRENAMESTANDSBG                           249968
      ** Standing Orders                                                                      249968
      *                                                                                       249968
     FRESWEPL5IF  E           K        DISK                                                   249968
     F            RESWEPD0                          KRENAMERESWEP5F                           253689
     FRESWEPL7IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP7F                           253689
     FRESWEPL8IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP8F                           253689
     FRESWEPL6IF  E           K        DISK                                                   253689
     F            RESWEPD0                          KRENAMERESWEP6F                           253689
      ** SWEEP                                                                                249968
      *                                                                                       249968
     F*
     FREACR   IF  E           K        DISK                           UC
     F** Retail interest accrual ITD
     F*
     FREIAC   IF  E           K        DISK                           UC
     F** Retail interest and charges
      *                                                                                       CDL013
     FACCNTBY0IF  E           K        DISK                           UC                      CDL013
     FSDSTAAL1IF  E           K        DISK                           UC                      CDL013
      *                                                                                       CDL013
     F*
     F**RECRG***IF  E           K        DISK                         UC  153001
     F***Retail*charges*file                                              153001
     F*
     F******MEMOS   IF  E                    DISK         KINFSR *PSSR    CCB002
     F******** Shadow balance file                                        CCB002
     F********                                                            CCB002
     FTTRNT   UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
     F** Teller Controls/Totals
     F*
     FTTRANPD O   E                    DISK         KINFSR *PSSR
     F                                              KCOMIT
     F** Teller Transactions Details
     F*
     FTTRANPT UF  E                    DISK         KINFSR *PSSR
     F                                              KCOMIT
     F** Teller Transactions Trailer
     F*
     FRE4123DFCF  E                    WORKSTN
     F** Display file - Account Closure
     F*
     FSDSTAXPDIF  E                    DISK                           UC
     F** SD Tax File
     F*
     FSWACB   IF  E           K        DISK         KINFSR *PSSR                              263834
     F            SWACSSAF                          KIGNORE                                   263834
     F            SWACSSCF                          KIGNORE                                   263834
     FGLNWACL5IF  E           K        DISK         KINFSR *PSSR                            MD054057
      **  Midas GL GLNWACPD - By Brch/Custno/ccy/acod/accseq       PREFIX 'G'               MD054057
     FGLNW94L7IF  E           K        DISK         KINFSR *PSSR                            MD054057
      ** Midas GL GLNW94PD - By Brch/Custno/ccy/acod/accseq        PREFIX 'H'               MD054057
      *                                                                                       263834
     F/COPY ZSRSRC,RTCOMMF1
     F*
     F/COPY ZSRSRC,RTCCYSF1                                               CRT002
     F*                                                                   CRT002
     F/COPY WNCPYSRC,RE4123FFP1                                           S01408
     F*                                                                   S01408
     F*****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F****01**-*Help***************************************************
     F*   10  - Message Subfile End Indicator (SFLEND)                *
     F*                                                               *
     F*   20  - Display transaction terminated message                *
     F*   21  - Display "OVERRIDE REQUIRED" message                   *
     F*   22  - Display terminal or warning message codes             *
     F*                                                               *
     F*   25  - Work indicator                                        *
     F*                                                               *
     F*   26  - Display override prompt                               *
     F*   27  - Display underline attributes                          *
     F*   29  - Display account closing balances                      *
     F*                                                               *
     F*   30  - Error in Retail A/C number                            *
     F*   31  - Error in Currency code                                *
     F*                                                               *
     F*   32  - Fresh screen                                          *
     F*   33  - Valid key for Override screen                         *
     F*                                                               *
     F*   38  - Error in Override teller identifier                   *
     F*   39  - Error in Override passcode                            *
     F*                                                               *
     F*   40  - Account closure selected                              *
     F*   41  - Account closure successful                            *
     F*   42  - Account Closure unsuccessful                          *
     F*                                                               *
     F*   43  - Display "TRANSACTION COMPLETED" message               *
     F*   54  - Display override user id / password                   *                       CRT026
      *   65  - NR indicator for SWACB                                *                       263834
     F*                                                               *
     F*   67  - Update indicator                                      *
     F*   68  - Unsuccessful override                                 *
     F*   69  - Validation error                                      *
     F*                                                               *
     F*   70  - Record not found                                      *
     F*   71  - Chain fail indicator                                  *
     F*                                                               *
     F*   76  - Display Withholding Tax                               *
     F*                                                               *
     F* 80-89 - Standard RTS subroutines                              *
     F*                                                               *
     F* 90-99 - Standard MIDAS subroutines                            *
     F*                                                               *
     F*   LR  - Last record indicator                                 *
     F*                                                               *
     F*   KA  - Validate override details                             *
     F*   KC  - Exit program                                          *
     F*   KE  - Refresh screen                                        *
     F*   KJ  - A/C closure enquiry                                   *
     F*   KL  - Previous                                              *
     F*                                                               *
     F*   U6  - System error                                          *
     F* U7+U8 - Database error occurs                                 *
     F*                                                               *
     F*****************************************************************
      /EJECT
      *****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  Control Subroutines                                          *
     F*                                                               *
     F*  ACLOSE - A/C closure enquiry                                 *
     F*  ACCDET - Accept details                                      *
     F*  DBERR  - Database error handling                             *
     F*  FIRST  - Initial Processing                                  *
     F*  LAST   - Final Processing                                    *
     F*  MAIN   - Main Processing                                     *
     F*  SNDMSG - Send program message parameters                     *
     F*  WRKACC - Work with account                                   *
     F*  WRKTRN - Work with retail account transaction                *
     F*  CHKAGN - Check again before update                           *
     F*  *PSSR  - Program error                                       *
     F*                                                               *
     F*  Screen Handling                                              *
     F*                                                               *
     F*  DSPINL - Display initial screen                              *
     F*  EXTDET - Exit details    screen                              *
     F*                                                               *
     F*  Screen Initialisation / Resets                               *
     F*                                                               *
     F*  RFRDET - Refresh details    screen                           *
     F*  RFRERR - Refresh warning/terminal error screen               *
     F*  RFRINL - Refresh initial screen                              *
     F*  RFROVR - Refresh override screen                             *
     F*                                                               *
     F*  Validation Subroutines                                       *
     F*                                                               *
     F*  VALINL - Validate initial screen                             *
     F*  VALDET - Validate details                                    *
     F*  VALOVR - Validate override                                   *
     F*  VOCOND - Validate override conditions                        *
     F*  VRTCCY - Validate teller transaction currency                *
     F*  VSACNO - Validate account number                             *
     F*  VSCCY  - Validate currency code                              *
     F*                                                               *
     F*  Updates Subroutines                                          *
     F*                                                               *
     F*  UACNUM - Update accounts                                     *
     F*  UPDATE - Update control                                      *
     F*  UTNTM2 - Update teller controls                              *
     F*  UTRAND - Update teller transacton details                    *
     F*  UTRANT - Update teller transaction trailer                   *
     F*                                                               *
     F*  Standard RTS Subroutines                                     *
     F*                                                               *
     F***DBSR***-*RTS*database*error*subroutine************************   DBSR
     F*  RTACLG - Account closing check                               *
     F*  RTACLS - Account closure updates                             *
     F*  RTBDPT - Bad Debt check                                      *
     F*  RTBKCR - Block credit check                                  *
     F*  RTBKDR - Block debit check                                   *
     F*  RTBKPT - Bankrupt/Liquidation check                          *
     F*  RTRFCR - Refer credit check                                  *
     F*  RTRFDR - Refer debit check                                   *
     F*  RTBRCH - Branch different check                              *
     F*  RTCCYS - Currency setup                                      *
     F*  RTCCYX - Convert an amount in one ccy to another ccy         *
     F*           using exchange rate                                 *
     F*  RTCHRG - Calculate charges                                   *
     F*  RTCLSC - Calculate close details                             *
     F*  RTCLSE - Close account condition check                       *
     F*  RTCOMM - Calculate commission for account closure            *
     F*  RTIACT - Inactive account check                              *
     F*  RTINTR - Calculate interest                                  *
     F*  RTTCCY - Teller currency conditions check                    *
     F*  RTTWID - Teller workstation conditions check                 *
     F*  RTENCP - Encript passcode                                    *
     F*                                                               *
     F*  Standard MIDAS Subroutines                                   *
     F*                                                               *
     F*  CRINIT - Credit rates loading                                *
     F*  DATEIN - Date init processing                                *
     F*  DRINIT - Debit rates loading                                 *
     F*  INTCAL - Interest calculation between two dates              *
     F*  ZALIGN - Validate amount fields                              *
     F*  ZDATE1 - Validate dates submitted and convert to a           *
     F*           number of days                                      *
     F*  ZDATE2 - Convert date to dayno. to date formats              *
     F*  ZFRPED - Format and edit amount field                        *
     F*  ZICD   - Find number of days to calculate interest           *
     F*           according to calculation basis                      *
     F*  ZIC00  - Calculate interest (type=00)                        *
     F*  ZIC01  - Calculate interest (type=01)                        *
     F*  ZIC02  - Calculate interest (type=02)                        *
     F*  ZTNLU1 - Access dataarea for next transaction no.            *
     F*                                                               *
     F*  External Subroutines                                         *
     F*                                                               *
     F*  SCC0250 - Clear Message Queue                                *
     F*  SCC0240 - Send Message                                       *
     F*                                                               *
     F*  DBERRCTL Program error                                       *
     F*                                                               *
     F*****************************************************************
      /EJECT
      *****************************************************************
      *
     E                    CPY@    1   1 80               COPYRIGHT STATEMENT
     E*
      /COPY ZSRSRC,ZDATE2Z1
      ** Array for SR.ZDATE1, SR.ZDATE2
      *
      /COPY ZSRSRC,ZALIGNZ1
      ** Array for both SR.ZALIGN, SR.ZEDIT
      *
      /COPY ZSRSRC,RTXXXXE1
      ** Array for SR.RTBKDR, SR.RTBKCR, SR.RTRFDR, SR.RTRFCR, SR.RTIACT
      *
      /COPY ZSRSRC,ZFRPEDZ1
      ** Array for SR.ZFRPED
      *
     E                    @CY        24  3
      ** Teller currencies array
      *
      /COPY ZSRSRC,RTINDEF1
      *
      /COPY ZSRSRC,RTCOMME1
      *
      /COPY ZSRSRC,RTCCYSE1
      ** Array for SR.RTCCYS
      *
      /COPY ZSRSRC,RTENCPE1
      ** Array for SR.RTENCP
      *
     E                    POWER   1   7  7 3             POWER ARRAY
     E/COPY WNCPYSRC,RE4123E001
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      /COPY ZSRSRC,RTINDEF4
      *
     ITTRANPTF
      ** Renamed fields in PF/TTRANPT
     I              NORE                            TTNORE
      *
     ITTRNTM2F
      ** Renamed fields in PF/TTRNTM2
     I              RECI                            T2RECI
     I              NATN                            T2NATN
     I              RUND                            T2RUND
      *
      ** Rename fields to prevent overwrite                                                   263834
      *                                                                                       263834
     ISWACSSBF                                                                                263834
     I              RECI                            RECISW                                    263834
     I              CNUMA                           CNUMSW                                    263834
     I              CCY                             CCYSW                                     263834
     I              ACODQQ                          ACDQSW                                    263834
     I              ACSQ                            ACSQSW                                    263834
     I              CFSB                            CFSBSW                                    263834
     I              LSTD                            LSTDSW                                    263834
     I              NSTD                            NSTDSW                                    263834
     I              ACNO                            ACNOSW                                    263834
     I              STFQ                            STFQSW                                    263834
     I              STDY                            STDYSW                                    263834
     I              LSNO                            LSNOSW                                    263834
     I              UPRI                            UPRISW                                    263834
     I              DDIS                            DDISSW                                    263834
     I              BRCA                            BRCASW                                    263834
     I              IND                             INDSW                                     263834
     I              ZZ006                           ZZ06SW                                    263834
     I              LCD                             LCDSW                                     263834
     I              CHTP                            CHTPSW                                    263834
     I              TNLU                            TNLUSW                                    263834
     I              MT94                            MT94SW                                    263834
     I              ACOD                            ACODSW                                    263834
     IGLNWACD0                                                                              MD054057
     I              NARECI                          GRECI                                   MD054057
     I              NANWRK                          GNWRK                                   MD054057
     I              NABRCH                          GBRCA                                   MD054057
     I              NACNUM                          GCNUM                                   MD054057
     I              NACCY                           GCCY                                    MD054057
     I              QQACOD                          GQACOD                                  MD054057
     I              NAACSQ                          GACSQ                                   MD054057
     I              NANATY                          GNATY                                   MD054057
     I              NAG950                          GG950                                   MD054057
     I              NA5SFQ                          G5SFQ                                   MD054057
     I              NA5SDY                          G5SDY                                   MD054057
     I              NA5NSD                          G5NSD                                   MD054057
     I              NA5DSI                          G5DSI                                   MD054057
     I              NA5LCB                          G5LCB                                   MD054057
     I              NA5LSD                          G5LSD                                   MD054057
     I              NA5LST                          G5LST                                   MD054057
     I              NA5LSN                          G5LSN                                   MD054057
     I              NALCDT                          GLCDT                                   MD054057
     I              NACHTP                          GCHTP                                   MD054057
     I              NAUSER                          GUSER                                   MD054047
     I              NAACOD                          GACOD                                   MD054057
      *                                                                                     MD054057
     IGLNW94D0                                                                              MD054057
     I              N4RECI                          HRECI                                   MD054057
     I              N4NWRK                          HNWRK                                   MD054057
     I              N4BRCA                          HBRCA                                   MD054057
     I              N4CNUM                          HCNUM                                   MD054057
     I              N4CCY                           H4CCY                                   MD054057
     I              QQACCD                          HQACCD                                  MD054057
     I              N4ACSQ                          HACSQ                                   MD054057
     I              N4NATY                          HNATY                                   MD054057
     I              N4DSTN                          HDSTN                                   MD054057
     I              N4DSTD                          HDSTD                                   MD054057
     I              N4LCDT                          HLCDT                                   MD054057
     I              N4CHTP                          HCHTP                                   MD054057
     I              N4USER                          HUSER                                   MD054057
     I              N4ACCD                          HACCD                                   MD054057
      *                                                                                       263834
     IACNUMABF
      ** Renamed fields in LF/ACNUM
     I              CCY                             ACCY
     ISTANDSBF                                                                                249968
      ** Renamed fields in LF/STANDL4                                                         249968
     I              TRAT                            BRAT                                      249968
     ISTANDSBG                                                                                249968
      ** Renamed fields in LF/STANDL5                                                         249968
     I              TRAT                            CRAT                                      249968
      *
      /COPY ZSRSRC,RTXXXXI1
      ** Data structure to positions of validation indicators
      *
      /COPY ZSRSRC,RTXXXXI2
      ** Data structure for 15 character account number
      *
      /COPY ZSRSRC,RTINDEF5
      *
     I*                                                                   EEE002
     I/COPY WNCPYSRC,RE4121IIP1                                           EEE002
     I*                                                                   EEE002
      /COPY ZSRSRC,RTCOMMI1
      *
      *                                                                   CCB002
     IUMEMER      DS                                                      CCB002
      ** Data structure for database error on call to AOMEMSR0.           CCB002
     I**********                              1   60U0CNUM                             CCB002 CSD027
     I                                        1   6 U0CNUM                                    CSD027
     I                                        7   9 U0CUCD                CCB002
     I**********                             10  130U0ACCD                             CCB002 CGL029
     I**********                             14  150U0ACSQ                             CCB002 CGL029
     I**********                             16  18 U0BRCA                             CCB002 CGL029
     I                                       10  190U0ACCD                                    CGL029
     I                                       20  210U0ACSQ                                    CGL029
     I                                       22  24 U0BRCA                                    CGL029
     I            DS
      ** 12 Character key
     I                                        1  12 @KEY
     I                                        2   30@CHGT
     I                                        4   80@CHST
     I                                        9  11 @CHCY
     I                                       12  12 @DDDD
      *
     I@VDS        DS
      *
     I            DS                             72
      ** Data structure to initialise arrays
     I                                        1  72 CCYR1
     I                                        1  72 @CY
      *
     I            DS
      ** Data structure to hold key fields of LF/TTRNT
     I                                        1   5 @TTRNT
     I                                        1   1 KTBRI
     I                                        2   4 KTBID
     I                                        5   5 KRCTP
      *
     ICMTTXT      DS                            200
      ** Commitment Control Commit Text
     I                                        1   50NATN
     I                                        6   7 MDID
     I                                        8  15 PGMN
     I                                       16  18 WSIDX
     I                                       19  240MTIME
     I                                       25  25 ACTCDX
     I                                       26  35 USRIDX
      ** Data structure for initial screen
     I                                       51  63 SINLDS
     I                                       51  60 SACNO
     I                                       61  63 SCCY
      *
      ** Data structure for override screen
     I                                      101 200 @OVRDS
     I                                      101 103 SOVTI
     I                                      104 109 SOVPC
     I                                      110 119 SOVUR                                     CRT026
     I                                      120 129 SOVPW                                     CRT026
      *
      /COPY ZSRSRC,ZTNLU1Z1
      ** Array for SR.ZTNLU1
      *
      /COPY ZSRSRC,ZFRPEDZ2
      ** Data structure for SR.ZFRPED
      *
      /COPY ZSRSRC,ZDATE3Z3
      ** Array for SR.ZDATE3
      *
     IPSDS       SDS
      ** Program Status Data Structure
      *
      ** Field containing program ID
     I                                        1  10 @PGM
      *
      ** Field containing workstation ID
     I                                      244 253 @JOB
      *
      ** Field containing user ID
     I                                      254 263 SUSER
      *
     IRTSDTA     UDS                            256
      ** RTS job data area data structure
     I                                        1   3 PTLID
     I                                        4   6 PTLBC
     I                                        7   7 PSPVI
     I                                        8  32 POVIN
     I                                    P  33  390PCHTL
     I                                    P  40  460PNCTL
      *
      *
     ILDA         DS                            256
     I**  Local data area for data base errors.
     I                                        1   3 ERTLID
     I                                       11  20 ERTWID
     I                                       21  30 ERWSID
     I**  Field combining the following fields
     I                                      134 183 DBLOT
     I**  Name of database file in error
     I                                      134 141 DBFILE
     I***********                           134 141 LFILE                 DBSR
     I**  Key value causing database error
     I                                      142 170 DBKEY
     I***********                           142 170 LKEY                  DBSR
     I**  Name of program causing database error
     I                                      171 180 DBPGM
     I**  Number of database error
     I                                      181 1830DBASE
     I***********                           181 1830LDBNO                 DBSR
     I*
     ISDBANK    E DSSDBANKPD
     I** External data structure for Bank Details
     I*
     ISDCURR    E DSSDCURRPD
     I** External data structure for Currency Codes
     I*
     ISDTELD    E DSSDTELDPD
     I** External data structure for Teller Identification Details
     I*
     ISDFNCD    E DSSDFNCDPD
     I** External data structure for Function Codes Details
     I*
     ISCSARD    E DSSCSARDPD                                              CRT002
     I** Switchable SARs                                                  CRT002
     I*                                                                   CRT002
     ISDACOD    E DSSDACODPD
     I** External data structure for Account Code Details
     I*
     ISDBRCH    E DSSDBRCHPD                                              CRT007
     I** External data structure for Branch Code Details                  CRT007
     I*                                                                   CRT007
     ISDCUST    E DSSDCUSTPD
     I** External data structure for Customer Details
     I*
     I              QQDFAC                          QQDFC1                                    CGL029
     IDSSDY     E DSDSSDY
     I** Second DS for access programs, Long data structure
     I*
     IDSMEMS    E DSMEMOS                                                 CCB002
     I** External data structure for MEMOS Details                        CCB002
     I** Renamed fields in PF/MEMOS                                       CCB002
     I              CNUM                            MECNUM                CCB002
     I              ACOD                            MEACOD                CCB002
     I              ACSQ                            MEACSQ                CCB002
     IDSFDY     E DSDSFDY
     I** First DS for access programs, Short data structure
      *
     IMUSER     E DSMUSERDD                                                                   CRT026
     I** External data structure for User Details                                             CRT026
     I** Renamed fields in PF/MUSERDD                                                         CRT026
     I              RECI                            RECIU                                     CRT026
     I              LCD                             LCDU                                      CRT026
      *                                                                                       CRT026
      ** Named constants                                                                      CDL081
      *                                                                                       CDL081
     I              'BasCcyTaxRoundDown'  C         C#BASE                                    CDL081
     I              'NBasCcyTaxRoundDown' C         C#NBAS                                    CDL081
     I/COPY WNCPYSRC,RE4123I001
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            MAIN   - Main Control Processing                   *
      *                                                               *
      * CALLS      ACCDET - Accept details                            *
      *            DSPINL - Display initial screen                    *
      *            FIRST  - Initial Processing                        *
      *            LAST   - Final Processing                          *
      *            RFRINL - Refresh initial screen                    *
      *            CHKAGN - Check again before update                 *
      *            WRKACC - Work with account                         *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C*
     C** Copyright statement
     C*
     C                     MOVEACPY@      BIS@   80
     C*
      /COPY ZSRSRC,RTINDEF2
     C*
      *
      ** Initial Processing
     C                     EXSR FIRST
      *                                                                                       250891
      ** Initialise Skip Update Flag to 'N'                                                   250891
     C                     MOVEL'N'       @SKIP   1                                           250891
      *                                                                                       250891
      *
      ** Main Processing
      *
      ** Refresh initial screen
     C                     EXSR RFRINL
      *
      ** Display initial screen
     C                     SETON                     32
     C                     EXSR DSPINL
      *
      ** Do while Cmd/3 is not pressed
     C           *INKC     DOWEQ'0'
      *
      ** If Cmd/1  is pressed, validate override conditions
     C           *INKA     CASEQ'1'       CHKAGN
      *
      ** If Cmd/5 is pressed, refresh initial screen
     C           *INKE     CASEQ'1'       RFRINL
      *
      ** If Cmd/12 is pressed, refresh initial screen
     C           *INKL     CASEQ'1'       RFRINL
      *
      ** If Cmd/10 is pressed, perform account closure enquiry
     C           *INKJ     CASEQ'1'       ACCDET
      *
      ** If Enter key is pressed, work with account
     C                     CAS            WRKACC
      *
     C                     END
      *
      ** Redisplay initial screen
     C                     EXSR DSPINL
      *
     C                     END
      *
      ** When Cmd/3 is pressed, perform last processing
     C                     EXSR LAST
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPINL - Display Initial Screen                    *
      *                                                               *
      * CALLS     SCC0250 - Clears message queue                      *
      *            RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPINL    BEGSR                           ** DSPINL **
      *
      ** initialise variables
     C           *IN25     IFEQ '0'
     C                     MOVEL*BLANKS   SOVTI
     C                     MOVEL*BLANKS   SOVPC
     C                     MOVEL*BLANKS   SOVUR                                               CRT026
     C                     MOVEL*BLANKS   SOVPW                                               CRT026
     C                     END
      *
      ** initialise variables
      *
     C           *IN20     IFEQ '1'
     C           *IN40     OREQ '1'
     C                     MOVEL*BLANKS   SACNO
     C                     MOVEL*BLANKS   SCCY
     C                     END
      *
      ** Display program message subfile for any messages
     C                     WRITERE4123C0
      *
      ** Display terminal error(s) and accept next account
     C   20                EXFMTRE4123F1
      *
      ** Display account closed and accept next account
     C   40                EXFMTRE4123F2
      *
      ** only cmd/3 cmd/5 cmd/10 allowed for screen RE4123F3
     C           *IN25     IFEQ '1'
     C                     SETOF                     33
     C           *IN33     DOUEQ'1'
      *
     C/COPY WNCPYSRC,RE4123C002
      ** Display and accept screen for account closure request
     C                     EXFMTRE4123F3
      *
     C           *INKC     IFEQ '1'
     C           *INKE     OREQ '1'
     C           *INKJ     OREQ '1'
     C                     SETON                     33
     C                     SETOF                     25
     C                     END
      *
     C                     END
      *
     C                     END
      *
      ** Display and accept initial screen
     C   32                EXFMTRE4123F0
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRERR    BEGSR                           ** RFRERR **
      *
     C                     SETOF                     202122
     C                     SETOF                     29
     C*                    MOVE *ZEROS    SACNO
     C                     MOVE *BLANKS   SANAM
     C*                    MOVE *BLANKS   SCCY
     C                     MOVEA*BLANKS   @W
     C                     MOVEA*BLANKS   @T
     C                     MOVEL*BLANKS   SMSG1
     C                     MOVEL*BLANKS   SMSG2
     C                     MOVEL*BLANKS   @MSG1                           SE3094
     C                     MOVEL*BLANKS   @MSG2                           SE3094
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKACC - Work with account                         *
      *                                                               *
      * CALLS      CHKACC - Check account status                      *
      *            RFRINL - Refresh initial screen                    *
      *            RTTWID - Teller workstation conditions check       *
      *            VALINL - Validate initial screen                   *
      *            WRKDET - Work with details                         *
      *            DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKACC    BEGSR                           ** WRKACC **
      *
     C                     SETOF                     436921
     C                     MOVE '0'       *IN41
     C                     MOVE '0'       *IN42
      *
      ** If account closure not requested, validate initial screen        SE2977
     C                     EXSR VALINL
      *
      ** If no validation error(s) exist
     C           *IN69     IFEQ '0'
      *
      ** Check for multiple sign on
     C                     MOVELPTLID     @TLID
     C                     EXSR RTTWID
      *
      ** Record not found.
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD1         DBASE            ** DB ERR 01 **
     C                     MOVE 'TTRNT'   DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C                     Z-ADDT2NATN    @NATN   50
      *
      ** If no warning or terminal errors
     C           *IN20     IFEQ '0'
     C           *IN21     ANDEQ'0'
      *
      ** Process Account close conditions check
     C                     EXSR ACLOSE
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALINL - Validate initial screen                   *
      *                                                               *
      * CALLS      VSACNO - Validate account number                   *
      *            VSCCY  - Validate currency code                    *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALINL    BEGSR                           ** VALINL **
      *
      ** Set off Validation error fields and indicators
     C                     SETOF                     2122
     C                     Z-ADD0         @TI     20
     C                     Z-ADD0         @WI     20
      *
      ** Validate Account Number
     C           *IN69     CASEQ'0'       VSACNO
     C                     END
      *
      ** Validate Currency Code
     C           *IN69     CASEQ'0'       VSCCY
     C                     END
      *
     C           *IN69     IFEQ '0'
     C                     SETOF                     322040
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSACNO - Validate account number                   *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  WRKACC - Work with account                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSACNO    BEGSR                           ** VSACNO **
      *
      ** Set off error indicator(s)
     C                     SETOF                     30
     C                     SETOF                     70
      *
     C                     MOVE *BLANKS   SACN20 10
     C/COPY WNCPYSRC,RE4123C004
      *
      *
      * Move fields to key list.
     C                     MOVELSACNO     KACNO
     C                     MOVELKACNO     SACN20
      *
     C           SACNO     IFNE SACN20
     C           KACNO     ORLT 0
     C                     SETON                     70
     C                     END
      *
      ** Get Account Details
     C           *IN70     IFEQ '0'
     C           KLACNO    CHAINACNUM                70
     C                     END
      *
      ** Account number must refer to a live record
     C           *IN70     IFEQ '1'
     C                     SETON                     30
     C                     MOVE 'USR0050' @MSGID
     C                     EXSR SNDMSG
     C                     ELSE
      *
      ** If account is a 'live' record
     C           RECI      IFEQ 'D'
      *
      ** set up account details
     C**********           Z-ADDCNUM      @CNUM                                               CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     Z-ADDACOD      @ACOD
     C                     Z-ADDACSQ      @ACSQ
     C                     MOVELBRCA      @BRCA
     C***********          Z-ADDRRNM      @RRNM                           CCB002
      *
     C                     ELSE
      *
      ** Account referred must not be closed
     C                     SETON                     30
     C                     MOVE 'USR0051' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** Save customer number for chain to Customer file
     C                     MOVE CNUM      @@CNUM  6
      *
      ** Retrieve Customer details
     C           *IN30     IFEQ '0'
     C*
     C                     MOVEL@@CNUM    @KEY1
     C                     CALL 'AOCUSTR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @KEY1  10
     C                     PARM *BLANKS   @KYST   7
     C           SDCUST    PARM SDCUST    DSSDY
     C*
     C** If record not found?
     C*
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD22        DBASE            ** DB ERR 22 **
     C                     MOVE 'SDCUSTPD'DBFILE           ***************
     C                     MOVEL@KEY1     DBKEY
     C                     EXSR DBERR
     C                     END
     C                     END
      *                                                               *
     C                     END
      *                                                                                       263834
      ** Account should not have an attached SWACSSB record.                                  263834
      *                                                                                       263834
     C                     MOVELCNUM      WWCNBR                                              263834
     C                     Z-ADDACOD      WWACOD                                              263834
     C                     Z-ADDACSQ      WWACSQ                                              263834
     C                     MOVELBRCA      WWBRCA                                              263834
     C                     MOVELACCY      WWCCY                                               263834
      *                                                                                       263834
      ** If CGL013 is on, account should not have an attached GLNW record.                  MD054057
      *                                                                                     MD054057
     C           CGL013    IFEQ 'Y'                                                         MD054057
     C           SWAKEY    CHAINGLNWACL5             80                                     MD054057
     C           *IN80     IFEQ '0'                                                         MD054057
     C           GRECI     ANDNE'*'                                                         MD054057
     C                     MOVE '1'       *IN30                                             MD054057
     C                     MOVE '1'       *IN69                                             MD054057
     C                     MOVE 'USR1147' ZAMSID                                            MD054057
     C                     CALL 'Y2SNMGC'                                                   MD054057
     C                     PARM           ZAPGM                                             MD054057
     C                     PARM           ZAPGRL                                            MD054057
     C                     PARM           ZAMSID                                            MD054057
     C                     PARM           ZAMSGF                                            MD054057
     C                     PARM *BLANK    ZAMSDA                                            MD054057
     C                     PARM           ZAMSTP                                            MD054057
     C                     ELSE                                                             MD054057
     C           SWAKEY    CHAINGLNW94L7             80                                     MD054057
     C           *IN80     IFEQ '0'                                                         MD054057
     C           HRECI     ANDNE'*'                                                         MD054057
     C                     MOVE '1'       *IN30                                             MD054057
     C                     MOVE '1'       *IN69                                             MD054057
     C                     MOVE 'USR1147' ZAMSID                                            MD054057
     C                     CALL 'Y2SNMGC'                                                   MD054057
     C                     PARM           ZAPGM                                             MD054057
     C                     PARM           ZAPGRL                                            MD054057
     C                     PARM           ZAMSID                                            MD054057
     C                     PARM           ZAMSGF                                            MD054057
     C                     PARM *BLANK    ZAMSDA                                            MD054057
     C                     PARM           ZAMSTP                                            MD054057
     C                     ENDIF                                                            MD054057
     C                     ENDIF                                                            MD054057
     C                     ELSE                                                             MD054057
     C           SWAKEY    CHAINSWACSSBF             65                                       263834
     C           *IN65     IFEQ '0'                                                           263834
     C           RECISW    ANDNE'*'                                                           263834
     C                     MOVE '1'       *IN30                                               263834
     C                     MOVE '1'       *IN69                                               263834
     C**********           MOVE '5045554' ZAMSID                                     263834 MD054057
     C                     MOVE 'USR1147' ZAMSID                                            MD054057
     C                     CALL 'Y2SNMGC'                                                     263834
     C                     PARM           ZAPGM                                               263834
     C                     PARM           ZAPGRL                                              263834
     C                     PARM           ZAMSID                                              263834
     C                     PARM           ZAMSGF                                              263834
     C                     PARM *BLANK    ZAMSDA                                              263834
     C                     PARM           ZAMSTP                                              263834
      *                                                                                       263834
      ** Clear all fields for default mechanism next time.                                    263834
      *                                                                                       263834
     C                     MOVEL*BLANK    ZAPGM                                               263834
     C                     MOVEL*BLANK    ZAPGRL                                              263834
     C                     MOVEL*BLANK    ZAMSDA                                              263834
     C                     MOVEL*BLANK    ZAMSTP                                              263834
     C                     ENDIF                                                              263834
     C                     ENDIF                                                            MD054057
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VSCCY  - Validate currency code                    *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALF0  - Validate Initial Screen                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VSCCY     BEGSR                           ** VSCCY  **
      *
      ** Set off error indicator(s)
     C                     SETOF                     31
      *
      ** If currency field is entered
     C           SCCY      IFNE ' '
      *
     C           SCCY      IFEQ '?'
      *
      ** Get currency details
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C           SCCY      PARM SCCY      @CCY
     C***********SDCURR    PARM SDCURR    DSFDY                           CSD006
     C           SDCURR    PARM SDCURR    DSSDY                           CSD006
      *
      ** If record found
     C           @RTCD     IFNE *BLANK
     C                     SETON                     3169
     C                     MOVEL'USR0049' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
      ** Currency must be the same as the currency code
      ** of the account referred to
     C           SCCY      IFNE ACCY
     C                     SETON                     31
     C                     MOVE 'USR0052' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** Else assume account currency code
     C                     ELSE
     C                     MOVE ACCY      SCCY
     C                     END
      *
      ** If no validation errors, get currency details
     C           *IN69     IFEQ '0'
     C                     MOVE SCCY      @CCY
     C                     EXSR RTCCYS
      *
     C           @RTCD     IFEQ *BLANKS
     C                     Z-ADDTDP,@I    @CYDP   50
     C                     ELSE
     C                     SETON                     31
     C                     MOVE 'USR0049' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            ACCDET - Accept details                            *
      *                                                               *
      * CALLS      VALDET - Validate details                          *
      *            UPDATE - Update control                            *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ACCDET    BEGSR                           ** ACCDET **
      *
     C                     SETOF                     21
      *
      ** If warning exist go for validating sign on teller
     C           @WI       IFGT 0
      *
     C                     EXSR VALDET
      *
     C                     ELSE
      *
      ** Seton update indicator
     C                     SETON                     67
      *
      ** End shifted from below - To give effect to any user overrides
     C                     END
      *
      ** Proceed to update?
     C           *IN67     IFEQ '1'
      ** Proceed to update? (i.e. no Outstanding Held Items, Stopped                          249968
      **                          Cheques, Standing Orders, SWEEPS  )                         249968
     C           @SKIP     IFEQ 'N'                                                           249968
      *
     C                     EXSR UPDATE
      *
      ** End of commitment cycle
     C           CMTTXT    COMIT
      *
      ** Display transaction completed
     C                     SETON                     43
     C                     ENDIF                                                              249968
      *
      ** If account closure is successful
     C           @CLOS     IFEQ 'Y'
     C                     SETON                     41
     C                     END
      *
      ** If account closure is unsuccessful
     C           @CLOS     IFEQ 'N'
     C                     SETON                     42
     C                     END
      *
      ** Exit out of details screen and back to initial screen
     C                     MOVE '1'       *INKL
      *
     C                     END
      *
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALDET - Validate details                          *
      *                                                               *
      * CALLS             -                                           *
      *            VOCOND - Validate override conditions              *
      *            VRTCCY - Validate teller transaction currency      *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALDET    BEGSR                           ** VALDET **
      *
     C                     SETOF                     6769
     C                     Z-ADD0         @TI
     C                     MOVEL*BLANKS   @T
     C                     MOVEA*BLANKS   @W,@WX
     C                     MOVEL*BLANKS   @OVTI                           SE3094
      *
      ** Move teller override indicators from DTAARA/RTSDTA
      ** to teller override array
     C                     MOVEAPOVIN     @R
      *
      ** Perform override validate process
     C                     EXSR VOCOND
      **********                                                                       249968 253689
      ***Initialise Skip Update Flag to 'N'                                            249968 253689
     C**********           MOVEL'N'       @SKIP   1                                    249968 253689
      **********                                                                       249968 253689
      ***If*Held Amount Item is Found                                                  249968 253689
     C********** KACO      CHAINHELDIHBF             61                                249968 253689
     C********** *IN61     IFEQ '0'                                                    249968 253689
     C**********           MOVEL'USR2412' @MSGID                                       249968 253689
     C**********           EXSR SNDMSG                                                 249968 253689
     C**********           MOVEL'Y'       @SKIP                                        249968 253689
     C**********           MOVEL'N'       @CLOS                                        249968 253689
     C**********           ENDIF                                                       249968 253689
      **********                                                                       249968 253689
      ***If*Stopped Cheque is Found                                                    249968 253689
     C********** KACO      CHAINSTOPCSL3             61                                249968 253689
     C********** *IN61     IFEQ '0'                                                    249968 253689
     C**********           MOVEL'USR2413' @MSGID                                       249968 253689
     C**********           EXSR SNDMSG                                                 249968 253689
     C**********           MOVEL'Y'       @SKIP                                        249968 253689
     C**********           MOVEL'N'       @CLOS                                        249968 253689
     C**********           ENDIF                                                       249968 253689
      **********                                                                       249968 253689
      ***If*Standing Orders is Found using Debit Retail Account                        249968 253689
     C********** KACO      CHAINSTANDSBF             61                                249968 253689
     C********** *IN61     IFEQ '0'                                                    249968 253689
     C**********           MOVEL'USR2414' @MSGID                                       249968 253689
     C**********           EXSR SNDMSG                                                 249968 253689
     C**********           MOVE 'Y'       @SKIP                                        249968 253689
     C**********           MOVEL'N'       @CLOS                                        249968 253689
     C**********           ENDIF                                                       249968 253689
      **********                                                                       249968 253689
      ***If*Standing Orders is Found using Credit Retail Account                       249968 253689
     C********** KACO      CHAINSTANDSBG             61                                249968 253689
     C********** *IN61     IFEQ '0'                                                    249968 253689
     C**********           MOVEL'USR2414' @MSGID                                       249968 253689
     C**********           EXSR SNDMSG                                                 249968 253689
     C**********           MOVE 'Y'       @SKIP                                        249968 253689
     C**********           MOVEL'N'       @CLOS                                        249968 253689
     C**********           ENDIF                                                       249968 253689
      ***If*SWEEP is Found                                                             249968 253689
     C********** KSWEEP    CHAINRESWEPD0             61                                249968 253689
     C********** *IN61     IFEQ '0'                                                    249968 253689
     C**********           MOVEL'USR2415' @MSGID                                       249968 253689
     C**********           EXSR SNDMSG                                                 249968 253689
     C**********           MOVE 'Y'       @SKIP                                        249968 253689
     C**********           MOVEL'N'       @CLOS                                        249968 253689
     C**********           ENDIF                                                       249968 253689
      *
      ** Do not display override teller prompt if sign-on teller has
      ** authority to override
     C           *IN68     IFEQ '0'
     C                     SETOF                     26
     C                     MOVE *OFF      *IN54                                               CRT026
      *
      ** Display closure successful if sign-on teller has authority
      ** and seton update indicator
     C                     SETON                     4067
      *
     C                     ELSE
      *
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE *ON       *IN54                                               CRT026
     C                     ELSE                                                               CRT026
     C                     SETON                     26
     C                     ENDIF                                                              CRT026
     C                     SETOF                     4067
      *
     C                     END
      *
     C                     EXSR WRKTRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRKTRN - Work with retail a/c transaction          *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            VALOVR - Validate override                         *
      *            VOCOND - Validate override conditions              *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           WRKTRN    BEGSR                           ** WRKTRN **
      *
     C                     SETOF                     33
     C                     SETOF                     38
      *
     C           *IN33     DOUEQ'1'
      *
      ** Display program message subfile for any messages
     C                     WRITERE4123C0
      *
     C/COPY WNCPYSRC,RE4123C003
      ** Display and accept override screen
     C                     EXFMTRE4123F5
      *
      ** Clear program message queue
     C                     CALL 'SCC0250'
      *
      ** If override teller id is prompted?
      ** Or if CRT026 is switch ON and if override user id is                                 CRT026
      ** prompted                                                                             CRT026
      *                                                                                       CRT026
     C           *INKA     IFEQ '1'
      *
     C           *IN26     IFEQ '1'
     C           *IN54     OREQ *ON                                                           CRT026
      *
     C                     EXSR VALOVR
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** Move teller override indicators from PF/TELIDPD
      ** to teller override array
     C                     MOVEAFROVRI    @R
      *
      ** Perform override validate process
     C                     EXSR VOCOND
      *
      ** If successful override?  Set on Previous screen indicator
      ** to return to update handling
     C           *IN68     IFEQ '0'
     C                     SETOF                     6926
     C                     SETON                     67
     C                     MOVE *OFF      *IN54                                               CRT026
      *
      ** To activate the refresh process
     C*                    MOVE '1'       *INKL
     C                     ELSE
     C                     MOVE 'USR0029' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     69
     C                     END
      *
     C                     END
      *
      ** If override not required setup update indicator
     C                     ELSE
     C                     SETON                     67
      *
     C                     END
      *
     C                     END
      *
     C           *INKA     IFEQ '1'
     C           *IN69     ANDEQ'0'
     C                     SETON                     33
     C                     END
      *
     C           *INKC     IFEQ '1'
     C           *INKL     OREQ '1'
     C                     SETON                     33
     C                     SETOF                     4067
     C                     END
      *
     C                     END
      *
      ** Save screen error messages (later to be used for output)
     C                     MOVE *BLANK    @MSG1  72
     C                     MOVE *BLANK    @MSG2  72
     C                     MOVELSMSG1     @MSG1
     C                     MOVELSMSG2     @MSG2
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALOVR - Validate override                         *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            RTENCP - Encript passcode                          *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALOVR    BEGSR                           ** VALOVR **
      *
      ** Set off validation error indicator
     C                     SETOF                     69
     C                     MOVE *BLANK    @OVTI   3
      *
      ** If override teller identifier is not blank
      ** If CRT026 is switch ON check user id if not blank                                    CRT026
      *                                                                                       CRT026
     C           SOVTI     IFNE *BLANK
     C           SOVUR     ORNE *BLANK                                                        CRT026
      *                                                                                       CRT026
      ** Access user id details to obtain the teller id attached                              CRT026
      ** to the user id                                                                       CRT026
      *                                                                                       CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'AOUSERR0'                                                    CRT026
     C                     PARM *BLANKS   @RTCD                                               CRT026
     C                     PARM '*KEY'    @OPTN                                               CRT026
     C                     PARM SOVUR     @USRP  10                                           CRT026
     C           MUSER     PARM MUSER     DSSDY                                               CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C           @RTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'MUSERDD' DBFILE           ***************                    CRT026
     C                     Z-ADD39        DBASE            ** DB ERR 39 **                    CRT026
     C                     MOVELSOVUR     DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C                     MOVEL'USR1501' @MSGID                                              CRT026
     C                     EXSR SNDMSG                                                        CRT026
      ** If user id is valid use the teller attached to this user                             CRT026
      ** to obtain the teller details                                                         CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE TLID      @TELI                                               CRT026
     C                     ENDIF                                                              CRT026
      ** If CRT026 enhancement is switch OFF use the teller id                                CRT026
      ** entered to obtain the teller details                                                 CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE SOVTI     @TELI                                               CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
      ** If no validation errors exist                                                        CRT026
      *
      ** Get teller identifier details
     C*
     C           *IN69     IFEQ *OFF                                                          CRT026
     C                     CALL 'AOTELDR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C**********           PARM SOVTI     @TELI   3                                           CRT026
     C                     PARM           @TELI   3                                           CRT026
     C           SDTELD    PARM SDTELD    DSFDY
      *
      ** Teller Identifier not found
     C           @RTCD     IFNE *BLANKS
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVEL'USR1509' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0030' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     3869
     C                     END
     C                     ENDIF                                                              CRT026
      *
      ** Teller identifier is required
      ** If CRT026 is switch ON User identifier is required                                   CRT026
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1500' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0032' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     3869
     C                     END
      *
      ** If no validation error(s) exist?
     C           *IN69     IFEQ '0'
      *
      ** If teller passcode is not blank?
      ** If CRT026 is switch ON check user password if not blank                              CRT026
      *                                                                                       CRT026
     C           SOVPC     IFNE *BLANK
     C           SOVPW     ORNE *BLANK                                                        CRT026
      ** If CRT026 is switch ON check the password via REC4170                                CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'REC4170'                                                     CRT026
     C                     PARM           SOVUR                                               CRT026
     C                     PARM           SOVPW                                               CRT026
     C                     PARM *BLANKS   @RTCD   7                                           CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     SELEC                                                              CRT026
     C           @RTCD     WHEQ 'CPF2204'                                                     CRT026
     C                     MOVE 'USR1501' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF22E3'                                                     CRT026
     C                     MOVE 'USR1506' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF2203'                                                     CRT026
     C                     MOVE 'USR1507' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF2213'                                                     CRT026
     C                     MOVE 'USR1508' @MSGID                                              CRT026
     C                     MOVE *ON       *IN38                                               CRT026
     C           @RTCD     WHEQ 'CPF22E5'                                                     CRT026
     C                     MOVE 'USR1505' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E2'                                                     CRT026
     C                     MOVE 'USR1503' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E4'                                                     CRT026
     C                     MOVE 'USR1504' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E6'                                                     CRT026
     C                     MOVE 'USR1510' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E9'                                                     CRT026
     C                     MOVE 'USR1511' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF2225'                                                     CRT026
     C                     MOVE 'USR1512' @MSGID                                              CRT026
     C                     ENDSL                                                              CRT026
     C                     MOVE *ON       *IN39                                               CRT026
     C                     EXSR SNDMSG                                                        CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C                     ELSE                                                               CRT026
      *
      ** Encript the passcode
     C                     MOVEASOVPC     BPWD
     C                     Z-ADD6         X       10
     C                     EXSR RTENCP
     C                     MOVEAEPWD      SOVPC
      *
      ** If teller passcode does not match
     C           SOVPC     IFNE FRTLPC
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE 'USR0039' @MSGID
     C                     EXSR SNDMSG
     C                     SETON                     3969
     C                     END
     C                     ENDIF                                                              CRT026
      *
     C                     ELSE
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1502' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE 'USR0033' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     SETON                     3969
     C                     END
      *
     C                     END
      *
      ** Store override teller-id
     C**********           MOVELSOVTI     @OVTI                                               CRT026
     C                     MOVEL@TELI     @OVTI                                               CRT026
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFROVR - Refresh override screen                   *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFROVR    BEGSR                           ** RFROVR **
      *
     C                     SETOF                     21
     C                     MOVE *BLANKS   SOVTI
     C                     MOVE *BLANKS   SOVPC
     C                     MOVE *BLANKS   SOVUR                                               CRT026
     C                     MOVE *BLANKS   SOVPW                                               CRT026
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VRTCCY - Validate teller transaction currency      *
      *                                                               *
      * CALLS      RTTCCY - Teller currency conditions check          *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VRTCCY    BEGSR                           ** VRTCCY **
      *
     C                     EXSR RTTCCY
      *
     C           *IN89     IFEQ '1'
     C                     SETON                     2269
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VOCOND - Validate override conditions              *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VOCOND    BEGSR                           ** VOCOND **
      *
     C                     SETOF                     68
     C                     Z-ADD1         @I
      *
      ** Do until end of array reached or unsuccessful override found
     C           @I        DOUGT25
      *
      ** If element of override conditions is yes
      ** and teller override indicators array element is no
     C           @O,@I     IFEQ 'Y'
     C           @R,@I     ANDEQ'N'
      *
      ** Return as unsuccessful override
     C                     SETON                     68
     C                     Z-ADD25        @I
     C                     END
      *
      ** Check next element
     C                     ADD  1         @I
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /COPY ZSRSRC,RTINTRE
      ** CALCULATION OF INTEREST
      *
      /EJECT
      /COPY ZSRSRC,RTTCCYC1
      ** Teller currency conditions
      *
      /EJECT
      /COPY ZSRSRC,RTCCYSC1
      ** currency setup
      *
      /EJECT
      /COPY ZSRSRC,RTACLSC1
      ** Account closure
      *
      /EJECT
      /COPY ZSRSRC,RTTWIDC1
      ** teller workstation-id conditions check
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRDET - Refresh details    screen                 *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRDET    BEGSR                           ** RFRDET **
      *
     C                     SETON                     2732
     C                     SETOF                     33
     C                     SETOF                     2169
      *
     C           @WI       IFEQ 0
     C                     SETOF                     22
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            EXTDET - Exit details    screen                    *
      *                                                               *
      * CALLS      RFRDET - Refresh details    screen                 *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           EXTDET    BEGSR                           ** EXTDET **
      *
      ** Clear details    screen
     C                     EXSR RFRDET
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *           SNDMSG  - Send program message parameters           *
      *                                                               *
      * CALLS     SCC0240 - Send message to program queue             *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED  @MSGID - Message id                                *
      *            @MSGF  - Message file                              *
      *                                                               *
      *****************************************************************
     C           SNDMSG    BEGSR                           ** SNDMSG **
      *
     C                     SETON                     69
      *
     C                     CALL 'SCC0240'
     C                     PARM           @MSGID
     C                     PARM           @MSGF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRINL - Refresh initial screen                    *
      *                                                               *
      * CALLS      RFRERR - Refresh warning/terminal error screen     *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRINL    BEGSR                           ** RFRINL **
      *
     C                     SETOF                     263031
     C                     SETOF                     33
     C                     SETOF                     204022
     C                     SETOF                     8182
     C                     SETON                     32
     C                     MOVE *OFF      *IN54                                               CRT026
     C                     MOVE *BLANKS   SACNO
     C                     MOVE *BLANKS   SCCY
     C                     MOVE *BLANKS   SACNO1
     C                     MOVE *BLANKS   SCCY1
     C                     MOVE *BLANKS   SANAM
      *
     C                     EXSR RFRERR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPDATE - Update control                            *
      *                                                               *
      * CALLS      UACNUM - Update accounts                           *
      *            UPDATE - Update control                            *
      *            UTNTM2 - Update teller controls                    *
      *            UTRAND - Update teller transacton details          *
      *            UTRANT - Update teller transaction trailer         *
      *            ZTNLU1 - Access dataarea for next transaction no.  *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UPDATE    BEGSR                           ** UPDATE **
      *
     C                     SETOF                     25
      *
      ** Access and update next available transaction number
     C                     EXSR ZTNLU1
      *
     C                     TIME           STIME   60
     C                     Z-ADD@NATN     STTLU
      *
      ** Update all files
     C           *IN69     CASEQ'0'       UTRAND
     C                     END
      *
     C           *IN69     CASEQ'0'       UTRANT
     C                     END
      *
     C           *IN69     CASEQ'0'       UTNTM2
     C                     END
      *
     C           *IN69     CASEQ'0'       UACNUM
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTRAND - Update teller transacton details          *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTRAND    BEGSR                           ** UTRAND **
      *
      ** Format record details
     C                     MOVEL'D'       RECI
     C                     MOVEL'T'       TBRI
     C                     MOVELPTLID     TBID
     C                     MOVEL@NATN     TBTN
     C                     MOVELPFNCD     FNCD
     C                     MOVEL@CCY      CCY1                            SE2977
     C                     MOVEL@JOB      TWID
     C                     MOVELSTIME     TIME
     C                     MOVEL@OVTI     OVTI
     C                     MOVEL@CLOS     CLOS
     C***********          Z-ADD@RRNM     MRR1                            CCB002
     C                     Z-ADDBJRDNB    VLDT
     C                     MOVEL@MSG1     MSG1
     C                     MOVEL@MSG2     MSG2
     C                     MOVELPTLBC     ITLB
      *
     C                     WRITETTRANPDF               69
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTRANT - Update teller transaction trailer         *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTRANT    BEGSR                           ** UTRANT **
      *
      ** Retrieve teller transaction trailer
     C           1         CHAINTTRANPTF             71
      *
      ** If record not found?
     C           *IN71     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD2         DBASE            ** DB ERR 02 **
     C                     MOVE 'TTRANPT' DBFILE           ***************
     C                     MOVEL'1'       DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Increment no. of records
     C                     ADD  1         TTNORE
      *
      ** Update teller transaction trailer
     C                     UPDATTTRANPTF               69
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTNTM2 - Update teller controls                    *
      *                                                               *
      * CALLS      RTTCCY - Teller currency conditions check          *
      *            DBERR  - Database error handling                   *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UTNTM2    BEGSR                           ** UTNTM2 **
      *
      * Move fields to key list.
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     MOVEL'1'       KRCTP
      *
      ** Get Teller Control Details
     C           KLTRNT    CHAINTTRNT                70
      *
      ** Record not found.
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD3         DBASE            ** DB ERR 03 **
     C                     MOVE 'TTRNT'   DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Format record details
     C                     ADD  1         T2NATN
      *
      ** If currency of account is not present on currencies array
      ** in PF/TTRNTM2, update array with account currency
     C                     EXSR RTTCCY
     C           @CY,@I    IFEQ '   '
     C                     MOVEL@CCY      @CY,@I                          SE2977
     C                     END
      *
      ** Update teller controls
     C                     UPDATTTRNTM2F
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UACNUM - Update accounts                           *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTACLS - Account closure updates                   *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           UACNUM    BEGSR                           ** UACNUM **
     C                     SETOF                     40
      *
      ** If account closure is successful
     C           @CLOS     IFEQ 'Y'
      *
      ** Seton screen indicator for account closed successfully
     C                     SETON                     40
     C                     MOVEL' '       @RVIN
     C                     EXSR RTACLS
      *
      ** If LF/ACCNT record not found.
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD4         DBASE            ** DB ERR 04 **
     C                     MOVE 'ACCNT '  DBFILE           ***************
     C                     MOVEL@ACCN     DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTBKDRC1
      ** Block debit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTBKCRC1
      ** Block credit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTRFDRC1
      ** Refer debit check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTRFCRC1
      ** Refer credit check subroutine
      *
      /COPY ZSRSRC,RTIACTC1
      ** Inactive account check subroutine
      *
      /EJECT
      /COPY ZSRSRC,RTBKPTC1
      ** Bankrupt/Liquidation check
      *
      /EJECT
      /COPY ZSRSRC,RTBDPTC1
      ** Bad Debt check
      *
      /EJECT
      /COPY ZSRSRC,RTBRCHC1
      ** Branch different check
      *
      /EJECT
      /COPY ZSRSRC,RTACLGC1
      ** Account closing check
      *
      /EJECT
      /COPY ZSRSRC,RTCLSCC1
      ** Calculate close details
      *
      /EJECT
      /COPY ZSRSRC,RTCHRGC1
      ** Calculate service charges
      *
      /EJECT
      /COPY ZSRSRC,RTINTRC1
      ** Calculate net interest
      *
      /EJECT
      *COPY ZSRSRC,RTCLSEC1
      ** Close account conditions check
      *
      *****************************************************************
      *                                                               *
      *            RTCLSE - Close account condition check             *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTIACT - Inactive account check                    *
      *            RTBKPT - Bankrupt/Liquidation check                *
      *            RTBDPT - Bad Debt check                            *
      *            RTBKCR - Block credit check                        *
      *            RTBKDR - Block debit check                         *
      *            RTBRCH - Branch different check                    *
      *            RTRFCR - Refer credit check                        *
      *            RTRFDR - Refer debit check                         *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED  Input                                              *
      *            @V     - Validation indicators array               *
      *            @BD    - Block credit     array position           *
      *            @BC    - Block debit      array position           *
      *            @RC    - Refer credit     array position           *
      *            @RD    - Refer debit      array position           *
      *            @DB    - Bad debt         array position           *
      *            @DF    - Branch different array position           *
      *            @IA    - Inactive account array position           *
      *            @BL    - Bankrupt/Liquidation array position       *
      *            @BRCD  - Branch code                               *
      *            @HELD  - Held amount                               *
      *            @RRNM  - Relative record number                    *
      *            PTLBC  - Teller branch code                        *
      *                                                               *
      * FLDS USED  Output                                             *
      *            @TI    - Terminal error index                      *
      *            @T     - Terminal message codes array              *
      *            *IN80  - Database error on PF/MEMOS                *
      *                                                               *
      *****************************************************************
     C           RTCLSE    BEGSR                           ** RTCLSE **
      *                                                                                       233332
      ** Alternative a/c check                                                                233332
     C           KLACNT    CHAINREIAC                80                                       233332
     C           *IN80     IFEQ '1'                                                           233332
     C           *LOCK     IN   LDA                                                           233332
     C                     MOVEL@ACCN     DBKEY                                               233332
     C                     MOVEL'REIAC'   DBFILE                                              233332
     C                     ELSE                                                               233332
     C           NOALT     IFGT 0                                                             233332
     C                     ADD  1         @TI                                                 233332
     C                     MOVEL'ALT A/C' @T,@TI                                              233332
     C                     END                                                                233332
     C                     END                                                                233332
      *
      ** Block debit check
      *                                                                   114621
     C***********@V,@BD    IFNE ' '                                       114621
     C           @V,@BD    IFNE 'X'                                       114621
     C                     EXSR RTBKDR
     C                     END
      *
      ** Block credit check
      *                                                                   114621
     C***********@V,@BC    IFNE ' '                                       114621
     C           @V,@BC    IFNE 'X'                                       114621
     C                     EXSR RTBKCR
     C                     END
      *
      ** Refer debit check
      *                                                                   114621
     C***********@V,@RD    IFNE ' '                                       114621
     C           @V,@RD    IFNE 'X'                                       114621
     C                     EXSR RTRFDR
     C                     END
      *
      ** Refer credit check
      *                                                                   114621
     C***********@V,@RC    IFNE ' '                                       114621
     C           @V,@RC    IFNE 'X'                                       114621
     C                     EXSR RTRFCR
     C                     END
      *
      ** Inactive account check
      *                                                                   114621
     C***********@V,@IA    IFNE ' '                                       114621
     C           @V,@IA    IFNE 'X'                                       114621
     C                     EXSR RTIACT
     C                     END
      *
      ** Bankrupt/Liquidation check
      *                                                                   114621
     C***********@V,@BL    IFNE ' '                                       114621
     C           @V,@BL    IFNE 'X'                                       114621
     C                     EXSR RTBKPT
     C                     END
      *
      ** Bad Debt check
      *                                                                   114621
     C***********@V,@DB    IFNE ' '                                       114621
     C           @V,@DB    IFNE 'X'                                       114621
     C                     EXSR RTBDPT
     C                     END
      *
      ** Branch different check
      *                                                                   114621
     C***********@V,@DF    IFNE ' '                                       114621
     C           @V,@DF    IFNE 'X'                                       114621
     C                     MOVELBRCA      @BRCA
     C                     MOVELPTLBC     @TLBC
     C                     EXSR RTBRCH
     C                     END
      *                                                                   114621
      ** Account closing check?
      *                                                                   114621
     C***********@V,@AC    IFNE ' '                                       114621
     C           @V,@AC    IFNE 'X'                                       114621
     C                     MOVELACST      @ACST
     C                     EXSR RTACLG
     C                     END
      *
      ** If held amount is not zero
     C           @HELD     IFNE 0
     C                     ADD  1         @TI
     C                     MOVEL'HOLDS'   @T,@TI
     C                     END
      *                                                                                       253689
      ** Initialise Skip Update Flag to 'N'                                                   253689
      *                                                                                       253689
     C                     MOVEL'N'       @SKIP   1                                           253689
     C                     MOVE ACNO      @ACNO                                               253689
      *                                                                                       253689
      ** If Held Amount Item is Found                                                         253689
      *                                                                                       253689
     C           KACO      CHAINHELDIHBF             61                                       253689
     C           *IN61     IFEQ '0'                                                           253689
     C           RECI      ANDNE'*'                                                           253689
     C                     MOVEL'USR2412' @MSGID                                              253689
     C                     EXSR SNDMSG                                                        253689
     C                     MOVEL'Y'       @SKIP                                               253689
     C                     MOVEL'N'       @CLOS                                               253689
     C                     ENDIF                                                              253689
      *                                                                                       253689
      ** If Stopped Cheque is Found                                                           253689
      *                                                                                       253689
     C           KACO      CHAINSTOPCSL3             61                                       253689
     C           *IN61     IFEQ '0'                                                           253689
     C           RECI      ANDNE'*'                                                           253689
     C                     ADD  1         @TI                                                 253689
     C                     MOVEL'USR2413' @MSGID                                              253689
     C                     EXSR SNDMSG                                                        253689
     C                     MOVEL'Y'       @SKIP                                               253689
     C                     MOVEL'N'       @CLOS                                               253689
     C                     ENDIF                                                              253689
      *                                                                                       253689
      ** If Standing Orders is Found using Debit Retail Account                               253689
     C           KACO      CHAINSTANDSBF             61                                       253689
     C           *IN61     IFEQ '0'                                                           253689
     C           RECI      ANDNE'*'                                                           253689
     C                     ADD  1         @TI                                                 253689
     C                     MOVEL'USR2414' @MSGID                                              253689
     C                     EXSR SNDMSG                                                        253689
     C                     MOVE 'Y'       @SKIP                                               253689
     C                     MOVEL'N'       @CLOS                                               253689
     C                     ENDIF                                                              253689
      *                                                                                       253689
      ** If Standing Orders is Found using Credit Retail Account                              253689
      *                                                                                       253689
     C           KACO      CHAINSTANDSBG             61                                       253689
     C           *IN61     IFEQ '0'                                                           253689
     C           RECI      ANDNE'*'                                                           253689
     C                     ADD  1         @TI                                                 253689
     C                     MOVEL'USR2414' @MSGID                                              253689
     C                     EXSR SNDMSG                                                        253689
     C                     MOVE 'Y'       @SKIP                                               253689
     C                     MOVEL'N'       @CLOS                                               253689
     C                     ENDIF                                                              253689
      *                                                                                       253689
      ** Check for credit sweep account                                                       253689
      *                                                                                       253689
     C           KSWEEP    CHAINRESWEP5F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP2     CHAINRESWEP6F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP1     CHAINRESWEP7F             61                                       253689
     C           *IN61     IFEQ '1'                                                           253689
     C           KSWP2     CHAINRESWEP8F             61                                       253689
     C                     ENDIF                                                              253689
     C                     ENDIF                                                              253689
     C                     ENDIF                                                              253689
      *                                                                                       253689
     C           *IN61     IFEQ '0'                                                           253689
     C                     ADD  1         @TI                                                 253689
     C                     MOVEL'USR2415' @MSGID                                              253689
     C                     EXSR SNDMSG                                                        253689
     C                     MOVE 'Y'       @SKIP                                               253689
     C                     MOVEL'N'       @CLOS                                               253689
     C                     ENDIF                                                              253689
      *                                                                                       253689
      ***********                                                         CCB002
      ***Retrieve PF/MEMOS details                                        CCB002
     C***********@RRNM     CHAINMEMOS                80                   CCB002
      *                                                                   CCB002
      ** Call Access Object AOMEMSR0                                      CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' W0OPTN  7        O:Option       CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM @CCY      W0CUCD  3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACCD 100                                          CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
      ** If record found
     C************IN80     IFEQ '0'                                       CCB002
     C           W0RTCD    IFEQ *BLANKS                                   CCB002
      *
      ** Release the record
      *****                EXCPT@RLMEM
      *
      ** If cleared balance is not the same as the ledger balance
     C           CLBLN     IFNE LDBLN
     C                     ADD  1         @TI
     C                     MOVEL'FLOAT'   @T,@TI
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * ACLOSE            - A/C Closure Enquiry                       *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTCLSC - Calculate close details                   *
      *            RTCLSE - Close account condition check             *
      *            VALINL - Validate initial screen                   *
      *            WRKACC - Work with account                         *
      *            ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ACLOSE    BEGSR                           ** ACLOSE **
      *
     C                     SETOF                     4369
     C                     SETON                     40
     C**********           OPEN RECRG                                     153001
     C                     OPEN REIAC
     C                     OPEN REACR
     C                     Z-ADD0         @TI
     C                     Z-ADD0         @WI
     C                     MOVEL*BLANKS   @T
     C                     MOVEL*BLANKS   @W
     C                     MOVEL*BLANKS   SMSG1
     C                     MOVEL*BLANKS   SMSG2
      *
      ** No validation error(s)
     C           *IN69     IFEQ '0'
      *
      ** Set up variables
     C                     MOVE ' '       @CLOS   1
     C                     MOVE RETB      @RETB
     C***********          Z-ADDRRNM      @RRNM   50                      CCB002
     C**********           Z-ADDCNUM      @CNUM                                               CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     MOVELSCCY      @CCY
     C                     Z-ADDACOD      @ACOD
     C                     Z-ADDACSQ      @ACSQ
     C                     MOVELBRCA      @BRCA
     C                     Z-ADDHELD      @HELD
      ***********                                                         CCB002
      ***Retrieve PF/MEMOS details                                        CCB002
     C***********@RRNM     CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
      ** Call Access Object AOMEMSR0                                      CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' W0OPTN           O:Option       CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM ACCY      W0CUCD  3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACCD                                              CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
      ** If record not found?
     C************IN70     IFEQ '1'                                       CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD5         DBASE            ** DB ERR 05 **
     C***********          MOVE 'MEMOS  ' DBFILE           ***************CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C***********          MOVEL@RRNM     DBKEY                           CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
     C                     END
      *
      ** Perform close account condition check
     C                     MOVE SCCY      SCCY1
     C                     MOVE SACNO     SACNO1
     C                     MOVE ANAM      SANAM
     C                     MOVE '  '      @ACIN   2
     C                     Z-ADDCLBLN     @CLBL
      *
      ** Calculate close account condition check
     C                     EXSR RTCLSE
      *
      ** If no terminal error(s)
     C           @TI       IFEQ 0
     C                     MOVELACCY      @CCY
      *
      ** Calculate close details
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4123CCP2                                           S01408
     C*                                                                   S01408
      *                                                                                       CDL013
     C           CDL013    IFEQ 'Y'                                                           CDL013
     C                     EXSR #ERTCL                                                        CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C                     EXSR RTCLSC
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4123CCP3                                           S01408
     C*                                                                   S01408
      *
      ** If record not found?
     C           *IN80     IFEQ '1'
      *                                                    ***************
     C                     Z-ADD6         DBASE            ** DB ERR 06 **
     C                     EXSR DBERR                      ***************
     C                     END
      *
      ** If Closing balance for the account = zero
     C           @CLOB     IFNE 0
     C                     ADD  1         @TI
     C                     MOVEL'NOTZERO' @T,@TI
     C                     SETOF                     25
     C                     ELSE
     C                     MOVELSACNO     SACNO1
     C                     MOVELSCCY      SCCY1
     C                     SETON                     25
     C                     END
      *
      ** If no terminal error(s)
     C           @TI       IFEQ 0
      *
      ** Set closure successful indicator to 'Y'
     C                     MOVEL'Y'       @CLOS
      *
      ** Prepare output fields for account closing balances
      ** and set on display indicator
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     MOVE @INTR     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SINTR
     C*
     C           BBTAIN    IFEQ 'Y'
      *                                                                                       CDL013
     C** Show W/TAX if Tax indicator is valid and tax is not zero.                            CDL013
     C           CDL013    OREQ 'Y'                                                           CDL013
     C           BBTAIN    ANDNE'0'                                                           CDL013
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4123CCP5                                           S01408
     C*                                                                   S01408
     C           @WTAX     ANDNE0
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     Z-ADD@WTAX     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SWTAX
     C*
     C                     MOVE '1'       *IN76
     C*
     C                     ELSE
     C*
     C                     MOVE '0'       *IN76
     C*
     C                     END
      *
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     MOVE @CHRG     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SCHRG
      *
     C                     Z-ADD@CYDP     ZDECS
     C                     MOVE 'A'       ZECODE
     C                     MOVE @CLOB     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE ZOUT22    SCLOB
      *
     C                     SETON                     29
     C/COPY WNCPYSRC,RE4123C001
      *
     C                     END
      *
     C                     END
      *
     C                     MOVELSACNO     SACNO1
     C                     MOVELSCCY      SCCY1
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
     C                     SETON                     2022
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
     C                     ELSE
      *
      ** If closing = 0 seton account closure flag
     C           @CLOB     IFEQ 0
     C                     SETON                     25
     C                     END
      *
      ** If warning error(s) exist?
     C           @WI       IFGT 0
      *
     C                     SETON                     21
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
      *
     C                     END
      *
     C                     END
      *
     C                     END
      *
     C                     SETOF                     40
      *
     C**********           CLOSERECRG                                     153001
     C                     CLOSEREIAC
     C                     CLOSEREACR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CHKAGN            - Checking again before update              *
      *                                                               *
      * CALLS      DBERR  - Database error handling                   *
      *            RTCLSC - Calculate close details                   *
      *            ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           CHKAGN    BEGSR                           ** CHKAGN **
      *
     C                     SETOF                     4369
     C                     SETON                     40
     C                     Z-ADD0         @TI
     C                     MOVEA*BLANKS   @T
     C**********           OPEN RECRG                                     153001
     C                     OPEN REIAC
     C                     OPEN REACR
      *
      ** Set up variables
     C                     MOVE ' '       @CLOS   1
     C                     MOVE RETB      @RETB
     C***********          Z-ADDRRNM      @RRNM   50                      CCB002
     C**********           Z-ADDCNUM      @CNUM                                               CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     Z-ADDACOD      @ACOD
     C                     Z-ADDACSQ      @ACSQ
     C                     MOVELBRCA      @BRCA
      *
      ** Perform close account condition check
     C                     MOVE SCCY      SCCY1
     C                     MOVE SACNO     SACNO1
     C                     MOVE ACNO      @ACNO
     C                     MOVE ANAM      SANAM
     C                     MOVE '  '      @ACIN   2
     C                     Z-ADDCLBLN     @CLBL
      *
      ** Calculate close account condition check
      ***Retrieve PF/MEMOS details                                        CCB002
     C***********@RRNM     CHAINMEMOS                80                   CCB002
      *                                                                   CCB002
      ** Call Access Object AOMEMSR0                                      CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' W0OPTN           O:Option       CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM @CNUM     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM @CNUM     W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM @CCY      W0CUCD  3        O:Currency     CCB002
     C**********           PARM @ACOD     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM @ACOD     W0ACCD                                              CGL029
     C                     PARM @ACSQ     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM @BRCA     W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
      ** If record found
     C************IN80     IFEQ '0'                                       CCB002
     C           W0RTCD    IFEQ *BLANKS                                   CCB002
      *
      ** If cleared balance is not the same as the ledger balance
     C           CLBLN     IFNE LDBLN
     C                     ADD  1         @TI
     C                     MOVEL'FLOAT'   @T,@TI
     C                     END
      *
     C                     ELSE
      *
      ** If record not found?
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD7         DBASE            ** DB ERR 07 **
     C***********          MOVE 'MEMOS  ' DBFILE           ***************CCB002
     C                     MOVE 'AOMEMSR0'DBFILE                          CCB002
     C***********          MOVEL@RRNM     DBKEY                           CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    DBKEY                           CCB002
     C                     EXSR DBERR
      *
     C                     END
      *
      ** If no terminal error(s)
     C           @TI       IFEQ 0
      *
      ** Calculate close details
     C                     MOVE ACNO      @ACNO
     C                     MOVELACCY      @CCY
     C                     EXSR RTCLSC
      *
      ** If record not found?
     C           *IN80     IFEQ '1'
      *                                                    ***************
     C                     Z-ADD8         DBASE            ** DB ERR 08 **
     C                     EXSR DBERR                      ***************
     C                     END
      *
      ** If Closing balance for the account = zero
     C           @CLOB     IFGT 0
     C                     ADD  1         @TI
     C                     MOVEL'NOTZERO' @T,@TI
     C                     END
      *
     C                     END
      *
      ** If terminal error(s) exist?
     C           @TI       IFGT 0
     C                     SETOF                     2526
     C                     SETON                     2022
     C                     MOVE *OFF      *IN54                                               CRT026
     C                     MOVELSACNO     SACNO1
     C                     MOVELSCCY      SCCY1
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
     C                     SETOF                     40
      *
     C                     ELSE
      *
      ** If no terminal errors on check again - go for update
     C                     MOVEL'Y'       @CLOS
     C                     EXSR UPDATE
      *
      ** End of commitment cycle
     C           CMTTXT    COMIT
      *
      ** Display transaction completed
     C                     SETON                     43
      *
      ** If account closure is successful
     C           @CLOS     IFEQ 'Y'
     C                     SETON                     41
     C                     END
      *
      ** If account closure is unsuccessful
     C           @CLOS     IFEQ 'N'
     C                     SETON                     42
     C                     END
      *
      ** Exit out of details screen and back to initial screen
     C                     MOVE '1'       *INKL
      *
     C                     END
      *
     C**********           CLOSERECRG                                     153001
     C                     CLOSEREIAC
     C                     CLOSEREACR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      ** SR.ZALIGN subroutine
      /COPY ZSRSRC,ZALIGNZ2
      *
      *****************************************************************
      /EJECT
      ** SR.ZDATE1 subroutine
      /COPY ZSRSRC,ZDATE1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZDATE2 subroutine
      /COPY ZSRSRC,ZDATE2Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZTNLU1 Subroutine
      /COPY ZSRSRC,ZTNLU1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZFRPED Subroutine
      /COPY ZSRSRC,ZFRPEDZ3
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FIRST  - Initial Processing                        *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           FIRST     BEGSR                           ** FIRST  **
      *
      ** Input parameter(s) :
     C           *ENTRY    PLIST                           Entry parameter list
     C                     PARM           PFNCD   3        Function code
      *
      ** Define Keylist(s)
      *
      ** Account Numbers Cross Reference
     C           KLACNO    KLIST
     C                     KFLD           KACNO  100
      ** Account master
     C           KLACNT    KLIST
     C                     KFLD           @CNUM
     C                     KFLD           @CCY
     C                     KFLD           @ACOD
     C                     KFLD           @ACSQ
     C                     KFLD           @BRCA
     C*
     C** Retail commission
     C*
     C           KLCOMM    KLIST
     C                     KFLD           @BRCA
     C                     KFLD           @CNUM
     C                     KFLD           @CCY
     C                     KFLD           @ACOD
     C                     KFLD           @ACSQ
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4123CCP1                                           S01408
     C*                                                                   S01408
     C           KSWEEP    KLIST                                                              249968
     C                     KFLD           @CNUM                                               249968
     C                     KFLD           CCY                                                 249968
     C                     KFLD           @ACOD                                               249968
     C                     KFLD           @ACSQ                                               249968
     C                     KFLD           @BRCA                                               249968
      *                                                                                       253689
     C           KSWP1     KLIST                                                              253689
     C                     KFLD           @BRCA                                               253689
     C                     KFLD           @CNUM                                               253689
     C                     KFLD           CCY                                                 253689
     C                     KFLD           @ACOD                                               253689
     C                     KFLD           @ACSQ                                               253689
      *                                                                                       253689
      ** Klist for chaining retail account number                                             253689
      *                                                                                       253689
     C           KSWP2     KLIST                                                              253689
     C                     KFLD           @ACNO                                               253689
      *                                                                                       249968
     C           KACO      KLIST                                                              249968
     C                     KFLD           @ACNO                                               249968
     C                     KFLD           @ACSQ                                               249968
      *                                                                                       263834
     C           SWAKEY    KLIST                                                              263834
     C                     KFLD           WWBRCA  3                                           263834
     C                     KFLD           WWCNBR  6                                           263834
     C                     KFLD           WWCCY   3                                           263834
     C                     KFLD           WWACOD 100                                          263834
     C                     KFLD           WWACSQ  20                                          263834
      *
      ** Retrieve RTS job dataarea
     C           *NAMVAR   DEFN           RTSDTA
     C                     IN   RTSDTA
      *
      **   Reset LDA
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANKS   DBLOT
     C                     OUT  LDA
      *                                                                                       263834
      ** Initialise fields to be used for message text retrieval                              263834
      *                                                                                       263834
     C                     MOVEL*BLANK    ZAPGM  10                                           263834
     C                     MOVEL'RTSMSGF' ZAMSGF 10                                           263834
     C                     MOVEL*BLANK    ZAPGRL  5                                           263834
     C                     MOVEL*BLANK    ZAMSID  7                                           263834
     C                     MOVEL*BLANK    ZAMSDA132                                           263834
     C                     MOVEL*BLANK    ZAMSTP  7                                           263834
      *
      ** Get Base Currency - Bank Details
     C*
     C                     CALL 'AOBANKR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      ** Record not found.
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD9         DBASE            ** DB ERR 09 **
     C                     MOVE 'SDBANKPD'DBFILE           ***************
     C                     MOVEL@OPTN     DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Set up local currency
     C                     MOVE BJLCCY    @CCY
     C                     Z-ADDBJRDNB    RUND    50
     C                     EXSR RTCCYS
      *
      ** If record not found.
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD10        DBASE            ** DB ERR 10 **
     C                     MOVE 'SDCURRL0'DBFILE           ***************
     C                     MOVELBJLCCY    DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Set up base currency
     C           BJLCCY    IFNE BJCYCD
     C                     MOVE BJCYCD    @CCY
     C                     EXSR RTCCYS
      *
      ** If record not found?
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD17        DBASE            ** DB ERR 17 **
     C                     MOVE 'SDCURRL0'DBFILE           ***************
     C                     MOVEL@CCY      DBKEY
     C                     EXSR DBERR
     C                     END
     C                     END
     C*
      ** Set up date format indicator
     C           BJDFIN    IFEQ 'D'
     C                     SETOF                     98
     C                     ELSE
     C                     SETON                     98
     C                     END
     C*
     C** Access Tax ICD for rate. Default is ZERO.
     C*
     C                     Z-ADD0         TXWTRR
     C                     OPEN SDSTAXPD
     C           1         CHAINSDSTAXPD             70
     C                     CLOSESDSTAXPD
     C*
     C** Error in SDSTAXPD
     C*
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD18        DBASE            ** DB ERR 18 **
     C                     MOVE 'SDSTAXPD'DBFILE           ***************
     C                     MOVEL'1'       DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Get Function Code Details
     C*
     C                     CALL 'AOFNCDR0'
     C                     PARM '*BLANKS' @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM PFNCD     @FNCD   3
     C           SDFNCD    PARM SDFNCD    DSFDY
      *
      ** Record not found.
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD11        DBASE            ** DB ERR 11 **
     C                     MOVE 'SDFNCDPD'DBFILE           ***************
     C                     MOVELPFNCD     DBKEY
     C                     EXSR DBERR
     C                     END
      *                                                                                     MD054057
      ** Check if CGL013 is switched on                                                     MD054057
     C*                                                                                     MD054057
     C                     CALL 'AOSARDR0'                                                  MD054057
     C                     PARM '*BLANKS' @RTCD                                             MD054057
     C                     PARM '*VERIFY' @OPTN                                             MD054057
     C                     PARM 'CGL013'  @SARD                                             MD054057
     C           SCSARD    PARM SCSARD    DSFDY                                             MD054057
      *                                                                                     MD054057
     C           @RTCD     IFEQ *BLANKS                                                     MD054057
     C                     MOVE 'Y'       CGL013  1                                         MD054057
     C                     ELSE                                                             MD054057
     C                     MOVE 'N'       CGL013                                            MD054057
     C                     END                                                              MD054057
      *                                                                   CRT007
      ** Determine if SAR CRT003 Cashier Interface is installed           CRT007
      *                                                                   CRT007
     C                     CALL 'AOSARDR0'                                CRT007
     C                     PARM *BLANKS   PRTCD   7                       CRT007
     C                     PARM '*VERIFY 'POPTN   7                       CRT007
     C                     PARM 'CRT003'  PSARD   6                       CRT007
     C           SCSARD    PARM SCSARD    DSFDY                           CRT007
      *                                                                   CRT007
     C           PRTCD     IFNE *BLANKS                                   CRT007
     C           PRTCD     ANDNE'*NRF   '                                 CRT007
     C           *LOCK     IN   LDA                                       CRT007
     C                     MOVEL'SCSARDPD'DBFILE                          CRT007
     C                     Z-ADD8         DBASE                           CRT007
     C                     MOVEL'CRT003'  DBKEY                           CRT007
     C                     EXSR DBERR                                     CRT007
     C                     ENDIF                                          CRT007
      *                                                                   CRT007
     C           PRTCD     IFEQ *BLANKS                                   CRT007
     C                     MOVE 'Y'       CRT003                          CRT007
     C                     ELSE                                           CRT007
     C                     MOVE 'N'       CRT003                          CRT007
     C                     ENDIF                                          CRT007
      *                                                                                       CRT026
      ** Check if CRT026 is switched on                                                       CRT026
      *                                                                                       CRT026
     C                     CALL 'AOSARDR0'                                                    CRT026
     C                     PARM *BLANKS   PRTCD                                               CRT026
     C                     PARM '*VERIFY' POPTN                                               CRT026
     C                     PARM 'CRT026'  PSARD                                               CRT026
     C           SCSARD    PARM SCSARD    DSFDY                                               CRT026
      *                                                                                       CRT026
     C           PRTCD     IFNE *BLANKS                                                       CRT026
     C           PRTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'SCSARDPD'DBFILE           ***************                    CRT026
     C                     Z-ADD12        DBASE            ** DB ERR 12 **                    CRT026
     C                     MOVEL'CRT026'  DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           PRTCD     IFEQ *BLANKS                                                       CRT026
     C                     MOVE 'Y'       CRT026  1                                           CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'N'       CRT026                                              CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CDL013
      *** Check if CAR CDL013 is installed                                                    CDL013
     C                     CALL 'AOSARDR0'                                                    CDL013
     C                     PARM '*BLANKS' @RTCD                                               CDL013
     C                     PARM '*VERIFY' @OPTN                                               CDL013
     C                     PARM 'CDL013'  @SARD   6                                           CDL013
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL013
      *                                                                                       CDL013
      *** CAR CDL013 is NOT installed                                                         CDL013
     C           @RTCD     IFNE *BLANKS                                                       CDL013
     C                     MOVE 'N'       CDL013  1                                           CDL013
      *                                                                                       CDL013
      *** CAR CDL013 is installed                                                             CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C                     MOVE 'Y'       CDL013  1                                           CDL013
     C                     MOVEL'RETAIL'  ULSTAX 10 P                                         CDL013
      *                                                                                       CDL013
      *** Access WHT ICD record to determine WHT rate.                                        CDL013
     C                     OPEN SDSTAAL1                                                      CDL013
     C           ULSTAX    CHAINSDSTAAL1             70                                       CDL013
      *                                                                                       CDL013
     C           *IN70     IFEQ *ON                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'SDSTAAL1'DBFILE           ************                       CDL013
     C                     MOVEL'RETAIL'  DBKEY            * DBERR 50 *                       CDL013
     C                     Z-ADD50        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      *** Open Account Details Extension file                                                 CDL013
     C                     OPEN ACCNTBY0                                                      CDL013
      *                                                                                       CDL013
      *** Retrieve Base CCy details                                                           CDL013
     C                     MOVE BJCYCD    @CCY                                                CDL013
     C                     EXSR RTCCYS                                                        CDL013
     C                     MOVE @CCY      ZCCYT                                               CDL013
     C                     Z-ADDTRT,@I    ZRATET                                              CDL013
     C                     MOVE TDP,@I    ZCDPT                                               CDL013
     C                     MOVE TMD,@I    ZMDINT                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL081
      ** Check if CDL081 is installed                                                         CDL081
      *                                                                                       CDL081
     C                     MOVE 'N'       CDL081  1                                           CDL081
     C                     CALL 'AOSARDR0'                                                    CDL081
     C                     PARM *BLANKS   PRTCD                                               CDL081
     C                     PARM '*VERIFY' POPTN                                               CDL081
     C                     PARM 'CDL081'  PSARD                                               CDL081
     C           SCSARD    PARM SCSARD    DSFDY                                               CDL081
      *                                                                                       CDL081
     C           PRTCD     IFNE *BLANKS                                                       CDL081
     C           PRTCD     ANDNE'*NRF   '                                                     CDL081
     C           *LOCK     IN   LDA                                                           CDL081
     C                     Z-ADD056       DBASE                                               CDL081
     C                     MOVE 'SCSARDPD'DBFILE                                              CDL081
     C                     MOVEL'CDL081'  DBKEY                                               CDL081
     C                     EXSR DBERR                                                         CDL081
     C                     END                                                                CDL081
      *                                                                                       CDL081
     C           PRTCD     IFEQ *BLANKS                                                       CDL081
     C                     MOVE 'Y'       CDL081                                              CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL081
      ** Access withholding tax round down system values if CDL081 is on                      CDL081
      *                                                                                       CDL081
     C           CDL081    IFEQ 'Y'                                                           CDL081
     C                     CALL 'AOSVALR0'                                                    CDL081
     C                     PARM *BLANKS   PRTCD                                               CDL081
     C                     PARM C#BASE    SVALK1 20                                           CDL081
     C                     PARM           SVAL1 200                                           CDL081
     C                     PARM C#NBAS    SVALK2 20                                           CDL081
     C                     PARM           SVAL2 200                                           CDL081
     C                     PARM *BLANK    SVALK3 20                                           CDL081
     C                     PARM           SVAL3 200                                           CDL081
     C                     PARM *BLANK    SVALK4 20                                           CDL081
     C                     PARM           SVAL4 200                                           CDL081
     C                     PARM *BLANK    SVALK5 20                                           CDL081
     C                     PARM           SVAL5 200                                           CDL081
     C                     PARM *BLANK    SVALK6 20                                           CDL081
     C                     PARM           SVAL6 200                                           CDL081
     C                     PARM *BLANK    SVALK7 20                                           CDL081
     C                     PARM           SVAL7 200                                           CDL081
     C                     PARM *BLANK    SVALK8 20                                           CDL081
     C                     PARM           SVAL8 200                                           CDL081
     C                     PARM *BLANK    SVALK9 20                                           CDL081
     C                     PARM           SVAL9 200                                           CDL081
     C                     PARM *BLANK    SVALK0 20                                           CDL081
     C                     PARM           SVAL10200                                           CDL081
      *                                                                                       CDL081
     C           PRTCD     IFNE *BLANKS                                                       CDL081
     C           *LOCK     IN   LDA                                                           CDL081
     C                     Z-ADD057       DBASE                                               CDL081
     C                     MOVE 'SDSVALPD'DBFILE                                              CDL081
     C           SVAL1     IFEQ '*NRF'                                                        CDL081
     C                     MOVELSVALK1    DBKEY                                               CDL081
     C                     ENDIF                                                              CDL081
     C           SVAL2     IFEQ '*NRF'                                                        CDL081
     C                     MOVELSVALK2    DBKEY                                               CDL081
     C                     ENDIF                                                              CDL081
     C                     EXSR DBERR                                                         CDL081
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL081
      ** Setup tax amount rounding down indicators                                            CDL081
      *                                                                                       CDL081
     C                     MOVELSVAL1     W#BSRD  1                                           CDL081
     C                     MOVELSVAL2     W#NBRD  1                                           CDL081
     C                     ENDIF                                                              CDL081
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4123CCP6                                           S01408
     C*                                                                   S01408
     C*
     C** Store validation indicators
     C*
     C                     MOVEAFQVWIN    @V
      *
      ** Define Error Message Fields
     C                     MOVE *BLANKS   @MSGID  7
     C                     MOVEL'RTSMSGF' @MSGF  10
      *
      ** Initialise Screen fields
     C                     SETON                     1032
     C                     MOVEL@PGM      SPGMQ
     C                     MOVEL@JOB      SWSID
     C                     MOVELBJMRDT    SRUNA
      *
      ** Initialise work fields and indicators
     C                     Z-ADD0         @TAMT  150
     C                     Z-ADD0         @HELD  150
     C                     Z-ADD1         @WX     20
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DBERR  - Database Error Handling                   *
      *                                                               *
      * CALLS      *PSSR  - Program  error                            *
      *                                                               *
      * CALLED BY  WRKACC - Work with account                         *
      *            UTRANT - Update teller transaction trailer         *
      *            UTNTM2 - Update teller controls                    *
      *            UACNUM - Update accounts                           *
      *            ACLOSE - A/C closure enquiry                       *
      *            CHKAGN - Check again before update                 *
      *            FIRST  - Initial Processing                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DBERR     BEGSR                           ** DBERR  **
      *
     C                     MOVEL@PGM      DBPGM
     C                     OUT  LDA
      *
     C                     EXSR *PSSR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            LAST   - Final Processing                          *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           LAST      BEGSR                           ** LAST   **
      *
     C                     CLOSE*ALL                   69
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR             - Program error                             *
      *                                                               *
      * CALLS      DBERRCTL                                           *
      *                                                               *
      * CALLED BY  DBERR  - Database Error Handling                   *
      *                                                               *
      *****************************************************************
     C           *PSSR     BEGSR                           ** *PSSR  **
     C*
     C** Check to see that *PSSR has not been called yet
     C*
     C           WRUN      IFEQ *BLANK
     C                     MOVE 'Y'       WRUN    1
     C                     SETON                     U7U8LR
     C                     DUMP
     C*
     C** Call standard database error program
     C*
     C                     CALL 'DBERRCTL'
     C*
     C                     END
     C*
     C** If *PSSR already run, then just end the program here
     C*
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      *---------------------------------------------------------------*                       CDL013
     C           #ERTCL    BEGSR                                                              CDL013
      *                                                                                       CDL013
      ** Define parameters                                                                    CDL013
      *                                                                                       CDL013
     C                     Z-ADD@ACNO     @ACNO  100                                          CDL013
     C                     Z-ADD@CLBL     @CLBL  150                                          CDL013
     C                     Z-ADD@CHRG     @CHRG  150                                          CDL013
     C                     Z-ADD@INTR     @INTR  150                                          CDL013
     C                     Z-ADD@CLOB     @CLOB  150                                          CDL013
      *                                                                                       CDL013
     C                     Z-ADD@INTT     @INTT  150                                          CDL013
     C                     Z-ADD@WTAX     @WTAX  150                                          CDL013
     C                     Z-ADD@ACOD     @ACOD  100                                          CDL013
     C                     Z-ADDRHISD     RHISD   50                                          CDL013
     C                     Z-ADDRHISB     RHISB  150                                          CDL013
      *                                                                                       CDL013
      * Retrieve retail interest and charges                                                  CDL013
      *                                                                                       CDL013
     C           KLACNT    CHAINREIAC                80                                       CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '1'                                                           CDL013
      *                                                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL@ACCN     DBKEY                                               CDL013
     C                     MOVEL'REIAC'   DBFILE                                              CDL013
      *                                                                                       CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      * Retrieve retail interest accrual ITD                                                  CDL013
      *                                                                                       CDL013
     C           KLACNT    CHAINREACR                80                                       CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '1'                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL@ACNO     DBKEY                                               CDL013
     C                     MOVEL'REACR'   DBFILE                                              CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** If no database errors                                                                CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '0'                                                           CDL013
      *                                                                                       CDL013
      ** Calculate charges                                                                    CDL013
      *                                                                                       CDL013
     C                     Z-ADDCHGT      @CHGT                                               CDL013
     C                     Z-ADDCHST      @CHST                                               CDL013
     C                     MOVEL@CCY      @CHCY                                               CDL013
     C                     MOVELCHAC      @CHAC                                               CDL013
     C                     Z-ADDRCA       @RCA                                                CDL013
     C                     Z-ADDNRCA      @NRCA                                               CDL013
     C                     Z-ADDLCD       RHISD                                               CDL013
     C                     Z-ADDHISB      RHISB                                               CDL013
      *                                                                                       CDL013
      *                                                                                       CDL013
      ** Get fixed account charge                                                             CDL013
      *                                                                                       CDL013
     C                     MOVE @BRCA     @BRCDX  3                                           CDL013
     C           KFXA      CHAINREFXAJL0             88                                       CDL013
     C                     Z-ADDRYACCH    @FXACM                                              CDL013
      *                                                                                       CDL013
     C                     EXSR RTCHRG                                                        CDL013
      *                                                                                       CDL013
      *  Calculate commissions - added to @CHRG                                               CDL013
      *                                                                                       CDL013
     C                     EXSR RTCOMM                                                        CDL013
      *                                                                                       CDL013
      ** If record not found?                                                                 CDL013
      *                                                                                       CDL013
     C           *IN80     IFEQ '0'                                                           CDL013
      *                                                                                       CDL013
      ** Calculate interest                                                                   CDL013
      *                                                                                       CDL013
     C                     MOVELDACP      @DACP  21                                           CDL013
     C                     MOVELCACP      @CACP  21                                           CDL013
     C                     Z-ADDMADI      @MADI  130                                          CDL013
     C                     Z-ADDMACI      @MACI  130                                          CDL013
     C                     Z-ADDGADI      @GADI  130                                          CDL013
     C                     Z-ADDGACI      @GACI  130                                          CDL013
     C                     Z-ADDDAIC1     @DAIC1 130                                          CDL013
     C                     Z-ADDCAIC1     @CAIC1 130                                          CDL013
      *                                                                                       CDL013
     C                     EXSR RTINTR                                                        CDL013
      *                                                                                       CDL013
      ** Add net-interest & service charge to close balance                                   CDL013
      *                                                                                       CDL013
     C           @INTR     ADD  @CHRG     @CLOB                                               CDL013
      *                                                                                       CDL013
      ** If the customer is liable calculate tax                                              CDL013
      *                                                                                       CDL013
     C           BBCSTY    IFNE 'N'                                                           CDL013
      *                                                                                       CDL013
      ** Include withholding tax in closing balance                                           CDL013
      *                                                                                       CDL013
      ** If SDSTAXPD/TXWNDI is 'Y', compute tax from net interest (sum                        CDL013
      ** of DR and CR interests).  Else, compute tax from gross                               CDL013
      ** interest (CR interest only).                                                         CDL013
      *                                                                                       CDL013
     C           TXWNDI    IFEQ 'Y'                                                           CDL013
     C                     Z-ADD@INTR     @INTT                                               CDL013
     C                     ELSE                                                               CDL013
     C                     Z-SUB@CRINT    @INTT                                               CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** If the resulting interest is zero or debit, no need to compute                       CDL013
      ** for the w/holding tax.  It is automatically equal to zero.                           CDL013
      *                                                                                       CDL013
     C           @INTT     IFGE *ZERO                                                         CDL013
     C                     Z-ADD*ZERO     @WTAX                                               CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      * Retrieve Taxable indicator for this Account.                                          CDL013
      *                                                                                       CDL013
     C           ACNTXF    KLIST                                                              CDL013
     C                     KFLD           @CNUM                                               CDL013
     C                     KFLD           @CCY                                                CDL013
     C                     KFLD           @ACOD                                               CDL013
     C                     KFLD           @ACSQ                                               CDL013
     C                     KFLD           @BRCDX                                              CDL013
      *                                                                                       CDL013
     C           ACNTXF    CHAINACCNTBY0             70                                       CDL013
     C           *IN70     IFEQ *ON                                                           CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'ACCNTBY0'DBFILE           ************                       CDL013
     C                     MOVEL@CNUM     DBKEY            * DBERR 23 *                       CDL013
     C                     Z-ADD23        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      *** If Tax indicator is ZERO set WHT rate to ZERO,                                      CDL013
      *** otherwise set WHT rate.                                                             CDL013
     C                     SELEC                                                              CDL013
     C           ATITAX    WHEQ '0'                                                           CDL013
     C                     Z-ADD0         ULWHTR  52                                          CDL013
     C           ATITAX    WHEQ '1'                                                           CDL013
     C                     Z-ADDETXR1     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '2'                                                           CDL013
     C                     Z-ADDETXR2     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '3'                                                           CDL013
     C                     Z-ADDETXR3     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '4'                                                           CDL013
     C                     Z-ADDETXR4     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '5'                                                           CDL013
     C                     Z-ADDETXR5     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '6'                                                           CDL013
     C                     Z-ADDETXR6     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '7'                                                           CDL013
     C                     Z-ADDETXR7     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '8'                                                           CDL013
     C                     Z-ADDETXR8     ULWHTR                                              CDL013
     C           ATITAX    WHEQ '9'                                                           CDL013
     C                     Z-ADDETXR9     ULWHTR                                              CDL013
     C                     ENDSL                                                              CDL013
      *                                                                                       CDL013
      *** If WHT rate is ZERO set tax amount to ZERO.                                         CDL013
     C           ULWHTR    IFEQ *ZERO                                                         CDL013
     C                     Z-ADD0         @WTAX                                               CDL013
      *                                                                                       CDL013
      *** otherwise calculate tax amount.                                                     CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
      *** If Account currency is in Base Currency.                                            CDL013
      *** and CDL081 is off                                                                   CDL081
      *                                                                                       CDL081
     C           @CCY      IFEQ BJCYCD                                                        CDL013
     C           CDL081    ANDEQ'N'                                                           CDL081
      *                                                                                       CDL013
      *** Set work adjustment field according to number of decimal                            CDL013
      *** places in currency before calculating the tax amount.                               CDL013
     C                     SELEC                                                              CDL013
     C           ZCDPT     WHEQ 0                                                             CDL013
     C                     Z-ADD1         ULWKAD  40                                          CDL013
     C           ZCDPT     WHEQ 1                                                             CDL013
     C                     Z-ADD10        ULWKAD                                              CDL013
     C           ZCDPT     WHEQ 2                                                             CDL013
     C                     Z-ADD100       ULWKAD                                              CDL013
     C           ZCDPT     WHEQ 3                                                             CDL013
     C                     Z-ADD1000      ULWKAD                                              CDL013
     C                     ENDSL                                                              CDL013
      *                                                                                       CDL013
      *** Account currency is in Base Currency round down gross                               CDL013
      *** Interest Amount.                                                                    CDL013
     C           @INTT     DIV  ULWKAD    ULTINT 150                                          CDL013
     C                     MULT ULWKAD    ULTINT                                              CDL013
      *                                                                                       CDL013
      *** calculate Tax Amount.                                                               CDL013
     C           ULTINT    MULT ULWHTR    @WTAX                                               CDL013
     C                     DIV  100       @WTAX                                               CDL013
      *                                                                                       CDL013
      *** round down Tax Amount.                                                              CDL013
     C           @WTAX     DIV  ULWKAD    @WTAX  150                                          CDL013
     C                     MULT ULWKAD    @WTAX                                               CDL013
      *                                                                                       CDL013
      *** otherwise (Account Ccy NOT = Base Ccy) calculate                                    CDL013
      *** Tax amount without rounding down.                                                   CDL013
     C                     ELSE                                                               CDL013
     C           @INTT     MULT ULWHTR    @WTAX                                               CDL013
      *                                                                                       CDL081
      ** Check if tax amount is to be rounded down                                            CDL081
      *                                                                                       CDL081
     C           @CCY      IFEQ BJCYCD                                                        CDL081
     C           CDL081    ANDEQ'Y'                                                           CDL081
     C           W#BSRD    ANDEQ'Y'                                                           CDL081
     C           @CCY      ORNE BJCYCD                                                        CDL081
     C           CDL081    ANDEQ'Y'                                                           CDL081
     C           W#NBRD    ANDEQ'Y'                                                           CDL081
     C                     DIV  100       @WTAX                                               CDL081
     C                     ELSE                                                               CDL081
     C                     DIV  100       @WTAX     H                                         CDL013
     C                     ENDIF                                                              CDL081
      *                                                                                       CDL013
      ** Calculate the interest amount in base currency (ULTINT)                              CDL013
      *                                                                                       CDL013
      ** Retrieve Account Ccy details                                                         CDL013
     C                     EXSR RTCCYS                                                        CDL013
     C                     MOVE @CCY      ZCCYF                                               CDL013
     C                     Z-ADDTRT,@I    ZRATEF                                              CDL013
     C                     MOVE TDP,@I    ZCDPF                                               CDL013
     C                     MOVE TMD,@I    ZMDINF                                              CDL013
      *                                                                                       CDL013
      ** Set amount in the Account Ccy                                                        CDL013
     C                     Z-ADD@INTT     ZAMTF                                               CDL013
      *                                                                                       CDL013
      ** Convert the amount to the Base Ccy                                                   CDL013
     C                     EXSR RTCCYX                                                        CDL013
      *                                                                                       CDL013
      ** Set amount in the Base Ccy                                                           CDL013
     C                     Z-ADDZAMTT     ULTINT                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Access account code details                                                          CDL013
      *                                                                                       CDL013
     C                     MOVE @ACOD     @ACODA 10                                           CDL013
      *                                                                                       CDL013
     C                     CALL 'AOACODR0'                                                    CDL013
     C                     PARM *BLANKS   @RTCD                                               CDL013
     C                     PARM '*KEY   ' @OPTN                                               CDL013
     C                     PARM           @ACODA                                              CDL013
     C           SDACOD    PARM SDACOD    DSFDY                                               CDL013
      *                                                                                       CDL013
      ** Error in SDACODPA                                                                    CDL013
      *                                                                                       CDL013
     C           @RTCD     IFNE *BLANKS                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVEL'SDACODPD'DBFILE           ************                       CDL013
     C                     MOVEL@ACODA    DBKEY            * DBERR 21 *                       CDL013
     C                     Z-ADD21        DBASE            ************                       CDL013
     C                     EXSR DBERR                                                         CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Check if the interest amount in base ccy is below minimum                            CDL013
     C                     Z-SUBULTINT    ULTINT                                              CDL013
     C           ULTINT    IFLT A5MISU                                                        CDL013
     C                     Z-ADD*ZERO     @WTAX                                               CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Subtract Withholding Tax from Close Balance                                          CDL013
      *                                                                                       CDL013
     C                     Z-SUB@WTAX     @WTAX                                               CDL013
     C                     ADD  @WTAX     @CLOB                                               CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
      ** Add cleared balance to close balance                                                 CDL013
      *                                                                                       CDL013
     C                     ADD  @CLBL     @CLOB                                               CDL013
      *                                                                                       CDL013
     C                     ELSE                                                               CDL013
      *                                                                                       CDL013
     C           *LOCK     IN   LDA                                                           CDL013
     C                     MOVE 'RECRG'   DBFILE                                              CDL013
     C                     MOVEL@KEY      DBKEY                                               CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDIF                                                              CDL013
      *                                                                                       CDL013
     C                     ENDSR                                                              CDL013
      *****************************************************************                       CDL013
      *****************************************************************                       CDL013
      /EJECT
      /COPY ZSRSRC,RTENCPC1
      ** Passcode encription
      *
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTCCYXC1
      *
      /EJECT
      /COPY ZSRSRC,RTCOMMC1
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4123CCP4                                           S01408
     C*                                                                   S01408
      *
      ** Account Details
     OACCNTABFE                @RLACC
      *
      ** Account Trailer
     OACCNTACFE                @UPACC
      *
     O                         NORE
     O                         NINU
     O                         NOAM
     O                         NOCL
     O                         NOAU
     O                         LCD
     O                         TNLU
      *
      ** Transaction details file
     OTTRNTM2FE                @RELTT
      *
      ** Retail Shadow Balances
     O*MEMOSMDFE                @RLMEM
      *
      *****************************************************************
**  CPY@  OBJECT COPYRIGHT
(c) Finastra International Limited 2001
**   ZYDY - Years in days cumulative, four year span
0366073110961461
**   ZMDY - Months in days cumulative through year
000031059090120151181212243273304334365
**   ZMNM - Months short names
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** - @P   - Array to hold the positions of the validation indicators
01020304050607080910111213141516171819202122232425
**  alphanumeric table
ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789
**  encription code table
SDKJFIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJ
FIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJFIEN
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
