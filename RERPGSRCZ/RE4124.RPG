     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE Transactions Reversals')                      *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Retail Teller System                                 *
     F*                                                               *
     F*  RE4124 - Transaction Reversals                               *
     F*                                                               *
     F*  Function:  This program accepts and validates reversals      *
     F*    (I/C)    of teller transactions and reverses all file      *
     F*             updates to the teller system master files         *
     F*             created by the reversed transaction.              *
     F*                                                               *
     F*  Called By: Retail Teller System Menu                         *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CGL154             Date 13Oct14               *
      *                 MD020701           Date 30Sep13               *
      *                 MD020635           Date 30Sep13               *
      *                 AR1083178          Date 30Sep13               *
      *                 CRE081             Date 30Sep13               *
      *                 252150             Date 03Sep12               *
      *                 CRE041             Date 28Sep12               *
      *                 CRE073             Date 06Dec10               *
      *                 CRE075             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 CER047             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 CAP205             Date 16Mar10               *
      *                 CAP204             Date 09Feb10               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 243813             Date 22Nov06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 241729             Date 23Aug06               *
      *                 CDL049             Date 11May06               *
      *                 CSD031             Date 10Apr06               *
      *                 BUG8685            Date 22Jun06               *
      *                 BUG8514            Date 14Jun06               *
      *                 CRT026             Date 23May06               *
      *                 CSD027             Date 09Dec05               *
      *                 BUG8195            Date 18Aug05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG4470            Date 01Dec04               *
      *                 BUG3915            Date 04Aug03               *
      *                 Bug3855            Date 03Aug04               *
      *                 BUG2849            Date 06Jun04               *
      *                 BUG2488            Date 31May04               *
      *                 CLE025             Date 20Oct03               *
      *                 BUG2304            Date 30Apr04               *
      *                 CAAA03             Date 23Apr04               *
      *                 CRE019             Date 15Mar04               *
      *                 CGL029             Date 01Sep03               *
      *                 CRT012             Date 26Nov02               *
      *                 CRT008             Date 18Oct02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 201732             Date 24Jan02               *
     F*                 CRT007             Date 14Jan02               *
     F*                 CRT005             Date 27Nov01               *
     F*                 198870             Date 28Sep01               *
     F*                 197289             Date 31Aug01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 194978             Date 28Jun01               *
      *                 CRT006             Date 17Apr01               *
      *                 190137             Date 18Apr01               *
      * Midas DBA 3.05 -----------------------------------------------*
      * Midas DBA 3.04 -----------------------------------------------*
      *                 166612             Date 18Oct00               *
     F*                 145752             Date 15Aug00               *
      * Midas DBA 3.03 -----------------------------------------------*
     F*                 179321             Date 26May00               *
      * Midas DBA 3.02 -----------------------------------------------*
     F*                 155095 (151611)    Date 20Oct99               *
      * Midas DBA 3.01 -----------------------------------------------*
     F*                 142092             Date 12NOV98               *
     F*                 139596             Date 23JUL98               *
     F*                 164264             Date 05Jul99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 130543             Date 13FEB98               *
     F*                 106661             DATE 19SEP97               *
     F*                 120880             Date 06AUG97               *
     F*                 120472             Date 04Aug97               *
     F*                 120471             Date 04Aug97               *
     F*                 114621             Date 21Feb97               *
     F*                 CRT002             Date  1DEC95               *
     F*                 CCB002             DATE 19AUG96               *
     F*                 S01408             Date 17APR96               *
     F*                 093546             DATE 12SEP95               *
     F*                 091241             DATE 21JUL95               *
     F*                 CRT001  *CREATE    DATE 28FEB95               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CGL154 - FATCA Reporting (Recompile)                         *
      *  MD020701  - Issue 'N.S.F.' error message instead of          *
      *              'EX.O/D' when account does not have overdraft.   *
      *  MD020635  - Warning errors for NSF, BLMN and EXOD were not   *
      *              initialised causing other warning messages to    *
      *              appear as failing override validation.           *
      *              Initialise override array @O to blanks.          *
      *  AR1083178 - Cannot withdraw from savings accounts, @CLBL is  *
      *              not set-up if CRE081 is ON.                      *
      *  CRE081 - Account Balance Check in RPG                        *
      *         - Consider the following programs in CRE081 changes:  *
      *           RE4116 RE4117 RE4118 RE4119 RE4121 RE4124           *
      *  252150 - COB component MEC103/GLC48 fails due to FOOB.       *
      *           Amend the program to match MOD/GLAMADUPD process    *
      *           when closing an account that is inserted the same   *
      *           day. Recompiled over changes ZSRSRC.RTACLSC1        *
      *           Applied for AR980794 (Child: AR980795)              *
      *  CRE041 - Enhancements to Customer Exchanges (Recompile)      *
      *  CRE073 - Interest Rate Rounding (Recompile)                  *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER047 - German Features LF037-00 Reporting §24c KWG         *
      *           (Recompile)                                         *
      *  CAP205 - Teller Related APIs - Account Balance Check         *
      *  CAP204 - Teller Related APIs - Account Transfer (Recompile)  *
      *  243813 - Incorrect member identifier used in accessing file  *
      *           TTRANPT.                                            *
      *  241729 - Rename the field ACNO in CHQBKPT to make sure       *
      *           account number is not overwritten with wrong value. *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  BUG8685 - Transaction reversal not allowed for Clearing/Pay- *
      *            roll Common Detail Input ; execute SR/SETBAT even  *
      *            during interactive mode to avoid problem with CCY  *
      *            due to override not done over TTRANL1.             *
      *  BUG8514 - Issue regarding teller overrides(Recompile)        *
      *  CRT026 - Retail Teller Password Change                       *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  BUG8195 - Prevent overriding of non-live teller IDs in       *
      *            TTRANL7.                                           *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG4470 - BOI cashier error 26. Recompiled due to changes in *
      *            /COPY RBMODTC1.                                    *
      *  BUG3915 - 664 Cash Withdrawal Reversal ends in DATABASE      *
      *            ERROR at 14                                        *
      *  Bug3855 - Incorrect field definitions by CRT002              *
      *  BUG2849 - CRE019 amendments for Cashier Interface (Recompile)*
      *  BUG2488- Logical file REDDSSRCDV/TTRANL6 is based over  a    *
      *           phsical which is set to members = *nomax.  Amend    *
      *           TTRANL6 and create a  new logical file TTRANL7.     *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  BUG2304 - Various file layout changes. Recompile.            *
      *  CAAA03 - Webfacing Changes (recompile)                       *
      *  CRE019 - Cheque Processing and Maintenance                   *
      *  CGL029 - Increase Account Code to 10 digits                  *
     F*  CRT012 - Midas/Cashier Interface - Multiple Charges         *
     F*  CRT008 - Forward Report Enhancements.  Move send dataqueue   *
     F*           message processing to after files have been updated *
     F*  201732 - Recompiled due to changes in RBMODTC1               *
     F*  CRT007 - Cashier Branch Offline Checking                     *
     F*  CRT005 - Recompiled due to changes in RTTWIDC1               *
     F*  198870 - Terminal errors missed in cashier, pad available    *
     F*           balance and uncleared funds with leading zeros,     *
     F*           reverse available balance convention for display    *
     F*           in cashier.  Display correct available balance.     *
     F*           Recompilation of RBMODTC1 to correct rev of a/c     *
     F*           transfers, correct x-ccy revs, don't pass host ref  *
     F*           back to cashier when forwarding has a terminal error*
     F*           Applies 166478,194391,198447, 197835, 198448        *
     F*  197289 - Reversal of reversal needs to be correct DR/CR.     *
     F*           Make sure the overrides to teller files TTRANL1     *
     F*           and TTRANPT are correct for the first transaction.  *
     F*           Allow the reversal of a reversal in cashier to      *
      *           ensure that unacknowledged reversals can be reversed*
      *  194978 - Error in reversing Exchange Cash transaction '0JI'  *
      *           (Cashier).                                          *
      *  CRT006 - Cashier Reserve Transactions.                       *
     F*  190137 - Addition of further warning messages.               *
     F*  166612 - Recomile due to change in COPY source RBMODTC1.     *
     F*  145752 - Recompile due to change in COPY source RTBALCC1.    *
     F*  179321 - Addition of extra warning messages, includes        *
     F*           fix number 166475.                                  *
     F*  155095 - Correct access for available balance (151611)       *
     F*  142092 - Cannot get full description of errors appearing on  *
     F*           teller screen in Cashier.                           *
     F*  139596 - Only check cashbox excess when PMODE = I (intractiv)*
     F*  164264 - Reversal of FX transaction was not supplying        *
     F*           SCCY field when using Cashier.                      *
     F*  130543 - Changed the array index for teller processing from  *
     F*           @I (2,0) to @J (3,0).  /COPY RBLDTLC1 and RBLDTLE1  *
     F*           were likewise amended.                              *
     F*  106661 - Re-compile only, over changed RTABALC1.             *
     F*  120880 - Store and Forward Function.                         *
     F*  120472 - Transaction Reversal locks records of its update    *
     F*           files.  Commit updates after each cycle.            *
     F*  120471 - Correct reversal with charges in P mode.            *
     F*  114621 - Replace blank with 'X' to mean not to validate      *
     F*           condition.                                          *
     F*  CRT002 - Retail Branch Access.                               *
     F*  CCB002 - COB Performance Enhancements                        *
     F*           Access now via access object                        *
     F*           MEMOS is now accessed via GL/RE key rather than old *
     F*           relative record number.                             *
     F*  S01408 - Addition of core hook RE4124CCP1                    *
     F*  093546 - Recompile due to changes in DSPF/RE4124DF -- text   *
     F*           amendment and alignment of fields.                  *
     F*  091241 - ATM Interface.   Recompile                          *
     F*  CRT001 - Retail Teller System                                *
     F*                                                               *
     F*****************************************************************
      /EJECT
      *****************************************************************
     FACNUM   IF  E           K        DISK
      ** Account Numbers Cross Reference File
     F            ACCNTABF                          KRENAMEACNUMABF
      *
     FACCNT   UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
      ** Account master
      *
     F****MEMOS***UF**E****                DISK         KINFSR *PSSR      CCB002
     F*********************                         KCOMIT                CCB002
      ** Retail Shadow Balances
      *
     FRSACMTPDO   E                    DISK         KINFSR *PSSR
     F                                              KCOMIT
      ** Shadow posting file
      *
     FTTRNT   UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
      ** Teller Trans. Control file
      *
     FTTRANL1 UF  E           K        DISK         KINFSR *PSSR      UC
     F                                              KCOMIT
      ** Teller Trans. logical file
      *
     FTTRANL6 IF  E           K        DISK                                                   CRE019
      ** Teller Trans. logical file of all presented cheques                                  CRE019
      *                                                                                       CRE019
     FTTRANL7 IF  E           K        DISK                           UC                     BUG2488
      ** Teller Trans. logical file of all presented cheques                                 BUG2488
      *                                                                                      BUG2488
     FTTRANPD O   E                    DISK         KINFSR *PSSR      UC
     F            TTRANPDF                          KRENAMET2RANPDF
     F                                              KCOMIT
      ** Teller Trans. Details file
      *
     F***TTRANPT*UF  E                    DISK         KINFSR *PSSR       CRT002
     FTTRANPT UF  E                    DISK         KINFSR *PSSR      UC  CRT002
     F            TTRANPTF                          KRENAMET2RANPTF
     F                                              KCOMIT
      ** Teller Trans. Trailer file
      *
     FCHQBKPD UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
      ** Cheque book file
      *
     FCHQBKPT UF  E           K        DISK         KINFSR *PSSR                              CRE019
     F                                              KCOMIT                                    CRE019
      ** Cheque book trailer file                                                             CRE019
      *                                                                                       CRE019
     FCHQDPPD UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
      ** Cheque deposited file
      *
     F***RE4124DFCF  E                    WORKSTN      KINFSR *PSSR       CRT002
     FRE4124DFCF  E                    WORKSTN                        UC  CRT002
      ** Display file - Transaction reversals
      *
     FTTCHGL0 IF  E           K        DISK
      ** Teller charges detail
      *
     FREIAC   IF  E           K        DISK                           UC  CRT002
      **  Retail interest and charges                                     CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBWLOGF1                                               CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBLDTLF1                                               CRT002
      *                                                                   CRT002
     F/COPY WNCPYSRC,RE4124F001
      *****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*     F U N C T I O N   O F   I N D I C A T O R S               *
     F*                                                               *
     F*      KA          Accept screen                                *
     F*      KB          Display balances                             *
     F*      KC          Exit Program                                 *
     F*      KE          Refresh Screen                               *
     F*      KL          Previous screen                              *
     F*                                                               *
     F*      01          Help                                         *
     F*                                                               *
     F*      09          Non a/c ccy transaction indicator            *
     F*      10          Message Subfile End Indicator (SFLEND)       *
     F*                                                               *
     F*      11          Error in SBATNO- Batch no.                   *
     F*                           SOTLI - Override teller-id          *
     F*      12          Error in STTNO - TRansaction no.             *
     F*                           SOTPC - Override teller passcode    *
     F*      13          Error in SRACNO- Retail a/c no.              *
     F*      14          Error in SCCY  - Currency code               *
     F*      15          Error in SAMT  - Amount                      *
     F*      16          Error in STTNO - Transaction No. not blank   *
     F*                                                               *
     F*      20          Terminal errors found                        *
     F*      21          Override prompt required                     *
     F*      22          Transaction completed successfully           *
     F*      23          Display balance when cmd/2 taken             *
     F*      24          Warning errors  found                        *
     F*      30          Use correct date on projected account mvmts  *   197289
     F*                                                               *
     F*      50          Invalid input indicator                      *
     F*      51          Error in override validation                 *
     F*      52          Error in override details validation         *
     F*      54          Display override user id / password          *                       CRT026
      *      60          LOKUP 'equal to' on commas in available bal  *   198870
     F*      67          Error ind.for accessing pf/chqbkpd           *
     F*      69          General error indicator                      *
     F*                                                               *
     F*      70          General Indicator Used For CHAIN             *
     F*                                                               *
     F*         U7+U8    Set on if database error occurs              *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  ACCHEK - Account conditions check                            *
      *  CQTDUP - Check for duplicate cheque transactions             *                       CRE019
     F*  DBERR  - Database Error Handling : Terminate pgm.            *
     F*  DSPBAL - Display account balances                            *
     F*  DSPFMT - Display screen formats                              *
     F*  FIRST  - Initial Processing                                  *
     F*  GETRDT - Get transaction details                             *
     F*  IFLDS  - Initialize screen/work fields                       *
     F*  INT01  - Initialise error indicators                         *
     F*  LAST   - Final processing - terminate pgm.                   *
     F*  MAIN   - Control Process                                     *
     F*  MAINP  - Main input process                                  *
     F*  PCMTXT - Prepare comit text                                  *
     F*  RFRESH - Refresh screen                                      *
     F*  SETDSP - Set indicators for display                          *
     F*  SETBAT - Set up batch member override                        *
     F*  SNDDTQ - Send Dataqueue Message                              *   CRT008
     F*  SNDMSG - Send program message parameters                     *
     F*  TRNACC - Transaction accept process                          *
     F*  UBTRRV - Update for batch  transaction reversal              *
     F*  UMEMOS - Update memos file record                            *
     F*  UPDMEM - Update memos file                                   *
      *  UPMEM2 - Reverse postings in MEMOS and RSACMTPD for CRE019   *                       CRE019
     F*  UPDCHD - Update pf/chqdppd                                   *
     F*  UPDCHK - Update pf/chqbkpd                                   *
     F*  UPDRTN - Control rtn. for updates                            *
     F*  UPTRL  - Update Control Trailer Record                       *
      *  UPTRL2 - Update Control Trailer Record  - CHQBKPT            *                       CRE019
     F*  UTTRRV - Update for teller transaction reversal              *
     F*  VALAMT - Validate amount                                     *
     F*  VALDET - Validate Details                                    *
     F*  VALFMT - Validate input formats                              *
     F*  VALOVR - Validate override conditions                        *
     F*  VALSPV - Validate supervisor indicator                       *
     F*  VOVDET - Validate override details                           *
     F*  WRTRPD - Write Teller transactions details                   *
     F*  WRRSAC - Write shadow posting file record                    *
     F*  *PSSR  - Program error                                       *
     F*                                                               *
     F*  Standard RTS Subroutines                                     *
     F*                                                               *
     F*  MOVDET - Move details to send to outgoing data queue         *   CRT002
     F*  RDQMS  - Read dataqueue message                              *   CRT002
     F*  RTABAL - Account available balance check                     *
     F*  RTACLG - Account closing Check                               *
     F*  RTACLS - Account closure updates                             *
     F*  RTBALC - Calculate available balances                        *
     F*  RTBDPT - Bad Debit Check                                     *
     F*  RTBKDR - Block Debit Check                                   *
     F*  RTBKCR - Block credit check                                  *
     F*  RTBKPT - Bankrupt/Liquidation check                          *
     F*  RTCASH - Excess cash check                                   *
     F*  RTODCK - Exceed overdraft check                              *
     F*  RTRFDR - Refer Debit Check                                   *
     F*  RTRFCR - Refer Credit Check                                  *
     F*  RTIACT - Inactive Account Check                              *
     F*  RTTCCY - Teller currency conditions check                    *
     F*  RTTOTS - Teller total updates                                *
     F*  RTTWID - Teller workstation conditions check                 *
     F*  RTENCP - Encript passcode                                    *
     F*  RTVMSG - Retrieve message from Message file                  *   CRT002
     F*  SDQMS  - Send dataqueue message                              *   CRT002
     F*                                                               *
     F*  Standard MIDAS Subroutines                                   *
     F*                                                               *
      *  PAD    - Pad field with leading zeros                        *   198870
     F*  ZALIGN - Validate amount fields                              *
     F*  ZFRPED - Format and edit amount field                        *
     F*  ZTNLU1 - Access dataarea for next transaction no.            *
     F*                                                               *
     F*                                                               *
     F*  External Routines                                            *
     F*                                                               *
     F*  SCC0250- Clear Message Queue                                 *
     F*  SCC0240- Send Message to program queue                       *
     F*                                                               *
     F*  DBERRCTL Program error                                       *
     F*                                                               *
     F*****************************************************************
      /EJECT
      *****************************************************************
      *
     E                    CPY@    1   1 80
      /COPY ZSRSRC,RTXXXXE1
      ** Array for SR.RTBKDR, SR.RTBKCR, SR.RTRFDR, SR.RTRFCR, SR.RTIACT
      *
      /COPY ZSRSRC,ZALIGNZ1
      ** Array for both SR.ZALIGN AND SR.ZEDIT
      *
      /COPY ZSRSRC,ZFRPEDZ1
      ** Array for SR.ZFRPED
      *
     E                    @CY        24  3
      ** Teller currencies array
      *
     E                    @CA        20  1
      ** Cheque presented status array
      *
      /COPY ZSRSRC,RTENCPE1
      ** Array for SR.RTENCP
      *
     E********************@TXT    1   3 80               Text strings     CRT002
     E**********          @TXT    1   5 80               Text strings                 CRT002 BUG2488
     E                    @TXT    1   7 80                                                   BUG2488
      ** Array for padding with zeros                                     198870
     E                    RTE        16  1  A            Padding          198870
      *                                                                   CRT002
      /COPY ZSRSRC,RBMODTE1                                               CRT002
      **  Array for SR.MOVDET                                             CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,RBLDTLE1                                               CRT002
      **  Array for SR.LODTLR                                             CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,ZDATE9Z1                                               CRT002
      ** Array for ZDATE9                                                 CRT002
      *                                                                   CRT002
     E                    POWER   1   7  7 3                                                  CRE019
      ** Power compile time array                                                             CRE019
      *                                                                                       CRE019
      /EJECT
      *****************************************************************
      *
     ITTRANPDF
      ** Renamed fields in LF/TTRANL1
     I              ACNO                            TRACNO
     I              CCY1                            TRCCY1
     I              CCY2                            TRCCY2
     I              AMT2                            TRAMT2
     I              TTP1                            TRTTP1
     I              TTP2                            TRTTP2
     I              DEPC                            TRDEPC
     I              RBCD                            TRRBCD
     I              CQNF                            TRCQNF
     I              IVLD                            TRIVLD
     I              EXCR                            TREXCR
     I              TTAC                            TRTTAC
     I              TTNR                            TRTTNR
     I              CUS1                            TRCUS1
     I              CUS2                            TRCUS2
     I              ACD1                            TRACD1
     I              ACD2                            TRACD2
     I              ACSQ1                           TRASQ1
     I              ACSQ2                           TRASQ2
     I              CVAM                            TRCVAM
     I              CVAM2                           TRCVM2
     I              RTLI                            TRRTLI
     I              ITLB                            TRITLB
     I              PBID                            TRPBID
     I              CLOS                            TRCLOS
     I              MRR2                            TRMRR2
     I              VLDT                            TRVLDT
     I              TBIDI                           TRIDI
     I              HCAC                            TRHCAC                                    CRE019
      *                                                                                       CRE019
     ITTRAND0                                                                                 CRE019
      ** Renamed fields in LF/TTRANL6                                                         CRE019
     I              ACNO                            TTACNO                                    CRE019
     I              CQNF                            TTCQNF                                    CRE019
     I              HCAC                            THACNO                                    CRE019
     I              TBID                            TTTBID                                    CRE019
     I              TBTN                            TTTBTN                                    CRE019
      *                                                                                       CRE019
     I@BTREMG                                                                                 CRE019
      ** Renamed fields in LF/TTRANL6                                                         CRE019
     I              BTIBCA                          TBBRCA                                    CRE019
     I              BTCUST                          TBCNUM                                    CRE019
     I              BTCYCD                          TBCCY                                     CRE019
     I              BTACCD                          TBACOD                                    CRE019
     I              BTACSN                          TBACSQ                                    CRE019
     I              BTRACN                          TBACNO                                    CRE019
      *                                                                                       CRE019
     ICUSEXCEF                                                                                CRE019
      ** Renamed fields in LF/TTRANL6                                                         CRE019
     I              DRBR                            TCBRCA                                    CRE019
     I              DCUS                            TCCNUM                                    CRE019
     I              DRCY                            TCCCY                                     CRE019
     I              DCOD                            TCACOD                                    CRE019
     I              DACS                            TCACSQ                                    CRE019
     I              DRAN                            TCACNO                                    CRE019
      *                                                                                       CRE019
      *
     ITTRNTM2F
      ** Renamed fields in PF/TTRNTM2
     I              NATN                            TTNATN
      *
     IT2RANPTF
      ** Renamed fields in PF/TTRANPT
     I              TBTN                            TRTBTN
      *
      *
     ICHQBKPDF
      ** Renamed fields in PF/CHQBKPD
     I              ACNO                            CQACNO
     I              CHAC                            CQCHAC                                    CRE019
     ICHQBKPTF                                                                                CRE019
      ** Renamed fields in PF/CHQBKPT                                                         CRE019
     I              NORE                            NORET                                     CRE019
     I              ACNO                            ACNOT                                     241729
      *                                                                                       CRE019
     I/COPY WNCPYSRC,RE4124I003
      *
      /COPY ZSRSRC,RTTOTSI1
      ** Multiple occurrence data structures for SR.RTTOTS
      *
     I            DS                              5
      ** Data structure to hold key fields of LF/TTRNT
     I                                        1   5 @TTRNT
     I                                        1   1 KTBRI
     I                                        2   4 KTBID
     I                                        5   5 KRCTP
      *
     I            DS                             10
      ** Data structure to hold key fields of LF/TTRANL1 - TTRANPDF
     I                                        1  10 @TTRAN
     I                                        1   1 K2BRI
     I                                        2   4 K2ITB
     I                                        5   7 K2BID
     I                                    P   8  100K2TRN
      *
      ** DS to hold full account of house cheque being reversed                               CRE019
     I            DS                                                                          CRE019
     I                                        1  24 WHACCN                                    CRE019
     I**********                              1   60WHCNUM                             CRE019 CSD027
     I                                        1   6 WHCNUM                                    CSD027
     I                                        7   9 WHCCY                                     CRE019
     I                                       10  190WHACOD                                    CRE019
     I                                       20  210WHACSQ                                    CRE019
     I                                       22  24 WHBRCA                                    CRE019
      *                                                                                       CRE019
      ** DS to hold full account of house cheque from TTRANL6 - CUSEXCEF                      CRE019
     I            DS                                                                          CRE019
     I                                        1  24 TCACCN                                    CRE019
     I**********                              1   60TCCNUM                             CRE019 CSD027
     I                                        1   6 TCCNUM                                    CSD027
     I                                        7   9 TCCCY                                     CRE019
     I                                       10  190TCACOD                                    CRE019
     I                                       20  210TCACSQ                                    CRE019
     I                                       22  24 TCBRCA                                    CRE019
      *                                                                                       CRE019
      ** DS to hold full account of house cheque from TTRANL6 - @BTREMG                       CRE019
     I            DS                                                                          CRE019
     I                                        1  24 TBACCN                                    CRE019
     I                                        1   6 TBCNUM                                    CRE019
     I                                        7   9 TBCCY                                     CRE019
     I                                       10  19 TBACOD                                    CRE019
     I                                       20  21 TBACSQ                                    CRE019
     I                                       22  24 TBBRCA                                    CRE019
      *                                                                                       CRE019
     I            DS                              7
      ** Data structure to hold key fields of LF/TTRANL1 - TTRANPTF
     I                                        1   7 @TTRA2
     I                                        1   1 K3BRI
     I                                        2   4 K3BID
     I                                    P   5   70K3TRN
      *
      *
     I            DS                             18
      ** Data structure to hold key fields of PF/CHQBKPD
     I                                        1  18 @CQBKY
     I                                        1  100KACNO
     I                                       11  180KSCQN
      *
      *
     I            DS                             11
      ** Data structure to hold key fields of PF/CHQDPPD
     I                                        1  11 @CQDKY
     I                                        1   3 KTLID
     I                                    P   4   60KTBTN
     I                                        7  110KSEQN
      *
      *
     I@AMTDS      DS                             16
      ** Data structure to hold amount returned by zfrped
     I                                        1  14 @SAMT
      *
      *
     I@SCEAM      DS                             19
      ** Data structure to hold sell ccy equivalent  returned by zfrped
     I                                        1  17 @SCYEQ
      *
      *
     I            DS
      ** Data structure to hold string constants for QCMDEXC
     I                                        1  80 @CMD
     I                                       30  30 @BRI
     I                                       31  33 @BID
      *                                                                   CRT002
     I            DS                                                                          194978
      **  Data structure to hold string constants for QCMDEXC             CRT002
      *                                                                   CRT002
     I                                        1  80 @CMDT                 CRT002
     I                                       30  30 @BRIT                 CRT002
     I                                       31  33 @BIDT                 CRT002
      *
     I            DS                                                                         BUG2488
      **  Data structure to hold string constants for QCMDEXC                                BUG2488
      *                                                                                      BUG2488
     I                                        1  80 @CMD7                                    BUG2488
     I                                       30  30 @BRI7                                    BUG2488
     I                                       31  33 @BID7                                    BUG2488
      *                                                                                      BUG2488
     I@TRNO       DS                                                      CRT002
      **  Data structure to hold the transaction number in PC mode        CRT002
      *                                                                   CRT002
     I                                        1   3 WTLID                 CRT002
     I                                        4   8 WTRNO                 CRT002
     I                                        9  14 WBLNK                 CRT002
      *                                                                   CRT002
     ITTIME       DS                             12                       CRT002
      *                                                                   CRT002
     I                                        1   2 WTHR                  CRT002
     I                                        3   4 WTMN                  CRT002
     I                                        5   6 WTSS                  CRT002
     I                                        1   60WTIME                 CRT002
      *                                                                   CRT002
     I                                        7   8 WDT1                  CRT002
     I                                        9  10 WDT2                  CRT002
     I                                       11  12 WDT3                  CRT002
     I                                        7  120WDATE                 CRT002
      *                                                                   CRT002
     I                                        1  120WTMDS                 CRT002
      *
     IPSDS       SDS
      **  Program Status Data Structure
      *
     I                                        1  10 @PGM
      **  Field containing Program name
     I                                      244 253 @JOB
      **  Field containing Workstation ID
     I                                      254 263 @USER
      **  Field Containing User ID
      *
      *
     I***LDA        UDS                            256
     ILDA         DS                            256
      **  Local data area for data base errors.
     I                                        1   3 ERTLID
     I                                       11  20 ERTWID
     I                                       21  30 ERWSID
      *
      **  Field combining the following fields
     I                                      134 183 DBLOT
      **  Name of database file in error
     I                                      134 141 DBFILE
      **  Key value causing database error
     I                                      142 170 DBKEY
      **  Name of program causing database error
     I                                      171 180 DBPGM
      **  Number of database error
     I                                      181 1830DBASE
     I*
     ICITFTS    E DSCITFTS                        2                       CRT002
      ** Data area for Trickle Feed Time Stamp                            CRT002
      *                                                                   CRT002
     I                                        1   2 WNNSS                 CRT002
      *                                                                   CRT002
     I/COPY WNCPYSRC,REH00352
     I/COPY ZSRSRC,RBOITMI1                                               CRT002
     I/COPY WNCPYSRC,REH00353
      *                                                                   CRT002
     I/COPY ZSRSRC,RBWLOGI1                                               CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBMODTI1                                               CRT002
      *                                                                   CRT002
     I/COPY ZSRSRC,RBLDTLI1                                               CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,ZDATE9Z2                                               CRT002
      ** Data structure for ZDATE9                                        CRT002
      *                                                                   CRT002
     ISDBRCH    E DSSDBRCHPD                                              197289
      **  Branch Codes                                                    197289
      *                                                                   197289
     ISDBANK    E DSSDBANKPD
      ** Bank Details              Retrieval index
      *
     ISDCURR    E DSSDCURRPD
      ** Currency Code             Retrieval index
     I*
     ISDRETR    E DSSDRETRPD
     I** Retail Transaction Types Details
     I*
     ISDTELD    E DSSDTELDPD
     I** Teller ID Details
     I*
     ISDFNCD    E DSSDFNCDPD
     I** Function Code  Details
     I*                                                                   CCB002
     IDSMEMS    E DSMEMOS                                                 CCB002
     I** External data structure for MEMOS Details                        CCB002
     I** Renamed fields in PF/MEMOS                                       CCB002
     I              CNUM                            MECNUM                CCB002
     I              CCY                             MECCY                 CCB002
     I              ACOD                            MEACOD                CCB002
     I              ACSQ                            MEACSQ                CCB002
     I              BRCA                            MEBRCA                                    194978
     I*
     ISDCUST    E DSSDCUSTPD                                              CRT002
      **  Customer Details                                                CRT002
     I              QQDFAC                          QQDFC1                                    CGL029
      *                                                                   CRT002
     I/COPY WNCPYSRC,RE4124I002
     IDSFDY     E DSDSFDY
     I*
     I** First DS for access programs, Short data structure
     I*
     IDSSDY     E DSDSSDY
     I*
     I** Second DS for access programs, Long data structure
      *                                                                                       CRE019
     ISCSARD    E DSSCSARDPD                                                                  CRE019
      ** Switchable SARs                                                                      CRE019
      *
     IMUSER     E DSMUSERDD                                                                   CRT026
     I** External data structure for User Details                                             CRT026
     I** Renamed fields in PF/MUSERDD                                                         CRT026
     I              RECI                            RECIU                                     CRT026
     I              LCD                             LCDU                                      CRT026
      *                                                                                       CRT026
      /COPY ZSRSRC,RTXXXXI1
      ** Data structure to positions of validation indicators
      *
      /COPY ZSRSRC,RTXXXXI2
      ** Data structure to redefine 15 character a/c number
      * Data structure for AOSVALR0 string                                CRT012
     I            DS                                                      CRT012
     I                                        1 200 SVAL1                 CRT012
     I                                        1   1 SVAL11                CRT012
      *                                                                   CRT012
      * System Value                                                      CRT012
     I            DS                                                      CRT012
     I I            'CashierMultCharge'       1  20 SVALK1                CRT012
      *                                                                   CRT012
      *
      /COPY ZSRSRC,ZTNLU1Z1
      **  Data structure to update last transaction number
      *
      /COPY ZSRSRC,ZFRPEDZ2
      ** Data structure for SR.ZFRPED
      *
     I***CMTTXT*      DS                             72                                       CRT026
     ICMTTXT      DS                             92                                           CRT026
      *
      **  COMIT TEXT
     I                                        1   50@NATN
     I                                        6   7 MDID
     I                                        8  15 PGMN
     I                                       16  18 WSIDX
     I                                       19  240MTIME
     I                                       25  34 USRIDX
     I                                       35  37 SBATNO
     I                                       38  42 STTNO
     I                                       43  52 SRACNO
     I                                       53  55 SCCY
     I                                       56  69 SAMT
     I                                       70  72 SOTLI
     I                                       73  82 SOVUR                                     CRT026
     I                                       83  92 SOVPW                                     CRT026
      *
     I            DS                             72
      ** Data structure to redefine currency array
     I                                        1  72 CCYR1
     I                                        1  72 @CY
      *
      *
     IRTSDTA     UDS                            256
      **  Job dataarea data structure
      *
     I                                        1   3 PTLID
     I                                        4   6 PTLBC
     I                                        7   7 PSPVI
     I                                        8  32 POVIN
     I                                    P  33  390PCHTL
     I                                    P  40  460PNCTL
     I                                       47  76 PTLNM
     I                                       77  800PTLMG
     I                                       81  840PTLSL
     I                                       85  890PTLTO
     I                                       90  920PDEPC
     I/COPY WNCPYSRC,RE4124I001
      *                                                                                       CRE081
     IZONEDP      DS                                                                          CRE081
     I                                        1  100PRTAC                                     CRE081
     I                                       11  200PACOD                                     CRE081
     I                                       21  220PASEQ                                     CRE081
     I                                       23  270PVLDAT                                    CRE081
     I                                       28  420PAMT                                      CRE081
     I                                       43  570PACBAL                                    CRE081
     I                                       58  720PAVBAL                                    CRE081
     I                                       73  770PFLDAT                                    CRE081
     I                                       78  920PFLBAL                                    CRE081
      *
      *****************************************************************
      *                                                               *
      *            MAIN   - Control Process                           *
      *                                                               *
      * CALLS      FIRST  - Initial Processing                        *
      *            LAST   - Final Processing                          *
      *            MAINP  - Main input process                        *
      *            RFRESH - Refresh screen                            *
      *                                                               *
      * CALLED BY         -                                           *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
      *
     C                     MOVEACPY@      BIS@   80
     C/COPY WNCPYSRC,RE4124C021
      ** Initial processing
     C                     EXSR FIRST
      *
      ** Do while cmd/3 is not pressed
     C           *INKC     DOWEQ'0'
      *
      ** Perform screen initialisation
     C                     EXSR RFRESH
      *
      ** Perform main input process
     C                     EXSR MAINP
      *
     C                     END
      *
      **  Final Processing
     C                     EXSR LAST
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            MAINP  - Main input process                        *
      *                                                               *
      * CALLS      DSPFMT - Display screen formats                    *
      *            RFRESH - Refresh screen                            *
      *            VALFMT - Validate input formats                    *
      *            LAST   - Final processing - terminate pgm.         *
      *            UPDRTN - Update control routine                    *
      *            PCMTXT - Prepare comit text.                       *   CRT002
      *            DTQMSG - Send Dataqueue message                    *   CRT008
      *                                                               *
      * CALLED BY  MAIN   - Control Process                           *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           MAINP     BEGSR                           ** MAINP  **
      *
      ** Do while input not valid
     C           *IN50     DOWEQ'1'
      *
      ** Display appropriate screen
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     EXSR DSPFMT
      *                                                                   CRT002
      **  Retrieve values from DTAQ.                                      CRT002
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   REPOII                          CRT002
     C                     EXSR RDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
      *                                                                   CRT002
     C                     MOVELP@QDR     REPOII                          CRT002
     C/COPY WNCPYSRC,REH00316
      *                                                                                       194978
     C           RAMSTY    IFNE '*END'                                                        194978
      *                                                                                       194978
      ** Move RATRN1 into transaction number field                                            194978
      *                                                                                       194978
     C                     MOVELRATRN1    @TRNO                                               194978
     C/COPY WNCPYSRC,REH00317
     C                     MOVELWTRNO     STTNO                                               194978
      *                                                                                       194978
      ** Set up KLTRAN Key on TTRANL1 and open TTRANL1                                        194978
      *                                                                                       194978
     C                     MOVE STTNO     K2TRN                                               194978
     C                     MOVELRAUSID    K2BID                                               194978
     C                     MOVEL'T'       K2BRI                                               194978
     C                     MOVELRABRNM    K2ITB                                               194978
     C                     EXSR SETBAT                                                        194978
      *                                                                                       194978
      ** Chain on TTRANL1 and exit if transaction number doesn't exist                        194978
      *                                                                                       194978
     C           KLTRAN    CHAINTTRANPDF             70                                       194978
     C           *IN70     IFEQ *ON                                                           194978
     C                     MOVEL'USR0048' @MSGID                                              194978
     C                     EXSR SNDMSG                                                        194978
     C                     ELSE                                                               194978
      *                                                                                       194978
      *                                                                   CRT002
     C********** RAMSTY    IFNE '*END'                                                 CRT002 194978
      *                                                                   CRT002
     C                     MOVE RAFWST    WFWST   1                       120880
      *                                                                   120880
     C           RACCY2    IFNE *BLANKS                                   120471
     C           RACCY1    ANDNERACCY2                                    120471
     C                     MOVEL'1'       *IN17                           120471
     C                     ELSE                                           120471
     C                     MOVEL'0'       *IN17                           120471
     C                     ENDIF                                          120471
      *                                                                   120471
     C           FNCD      IFEQ '00R'                                     120471
     C           FNCD      OREQ '0JR'                                     120471
     C           FNCD      OREQ '00W'                                     120471
     C           FNCD      OREQ '0JW'                                     120471
     C                     MOVELWMAC2     SRACNO                          120471
     C                     ELSE                                           120471
     C                     MOVELWMAC1     SRACNO                          CRT002
     C                     ENDIF                                          120471
      *                                                                   120471
     C           *IN17     IFEQ '1'                                       120471
      *                                                                   120471
     C           FNCD      IFEQ '0JI'                                     164264
     C                     MOVELRACCY1    SCCY                            164264
     C                     MOVE RATRA1    SAMT                            164264
      *                                                                   164264
     C                     ELSE                                           164264
      *                                                                   120471
     C           FNCD      IFEQ '0JR'                                     120471
     C           FNCD      OREQ '0JW'                                     120471
     C                     MOVELRACCY1    SCCY                            120471
     C                     MOVE RATRA1    SAMT                            120471
     C                     ELSE                                           120471
     C                     MOVELRACCY2    SCCY                            120471
     C**********           MOVE RAMNA2    SAMT                                         120471 194978
     C                     MOVE RATRA2    SAMT                                                194978
     C                     ENDIF                                          120471
      *                                                                   120471
     C                     ENDIF                                          164264
      *                                                                   164264
     C                     ELSE                                           120471
      *                                                                   120471
     C                     MOVELRACCY1    SCCY                            CRT002
      *                                                                   120471
     C           FNCD      IFEQ '00R'                                     120471
     C           FNCD      OREQ '00W'                                     120471
     C                     MOVE RATRA2    SAMT                            120471
     C                     ELSE                                           120471
     C                     MOVE RATRA1    SAMT                            CRT002
     C                     ENDIF                                          120471
      *                                                                   120471
     C                     ENDIF                                          120471
      *                                                                   120471
     C**********           MOVELRATRN1    @TRNO                                        CRT002 194978
     C**********           MOVELWTRNO     STTNO                                        CRT002 194978
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
     C                     CLEARWCMSG                                     CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVE 'N'       WSUCM                           CRT002
     C                     MOVE 'DR'      WSTAT                           CRT002
     C                     TIME           WTMDS  120                      CRT002
     C           WTHR      CAT  ':'       WA      3                       CRT002
     C           WTMN      CAT  ':'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WTSS      WSTTM                           CRT002
     C                     MOVE WSTTM     WRCTM   8                       CRT002
     C           WDT1      CAT  '/'       WA      3                       CRT002
     C           WDT2      CAT  '/'       WB      3                       CRT002
     C           WA        CAT  WB        WC      6                       CRT002
     C           WC        CAT  WDT3      WRCDT   8                       CRT002
     C                     MOVELP@QDR     WCMSG                           CRT002
     C                     EXSR WRLOG                                     CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
      *                                                                   CRT002
     C                     MOVE '0'       *INKA                           CRT002
     C                     MOVE '0'       *INKB                           CRT002
     C                     MOVE '0'       *INKC                           CRT002
     C                     MOVE '0'       *INKE                           CRT002
     C                     MOVE '0'       *INKL                           CRT002
      *                                                                                       194978
     C                     ENDIF                                                              194978
      *                                                                   CRT002
     C                     ELSE                                           CRT002
      *                                                                   CRT002
      *                                                                   CRT002
     C                     MOVE '1'       *INKC                           CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
      ** Process the input depending on the key pressed
      *
      ***If*Help*key*is*pressed,*perform*help*processing
      *
      ** If cmd/3 is pressed - terminate the program
     C           *INKC     CASEQ'1'       LAST
      *
      ** If cmd/5 is pressed - refresh the screen & redisplay appr.scrn
     C           *INKE     CASEQ'1'       RFRESH
      *
      ** If enter key is pressed - validate the screen input
     C                     CAS            VALFMT
      *
     C                     END
      *
     C                     END
      *
      ** If no terminal errors
      ** Perform transaction update
     C           *IN20     IFEQ '0'
     C                     EXSR UPDRTN
      *
      ** Seton indicator for transaction completed screen
     C                     SETON                     22
      *
     C                     END
      *
      ** Call subroutine to send dtq message back                         CRT008
      *                                                                   CRT008
     C           PMODE     IFEQ 'P'                                       CRT008
     C                     EXSR DTQMSG                                    CRT008
     C                     ENDIF                                          CRT008
      *                                                                   CRT008
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPFMT - Display screen formats                    *
      *                                                               *
      * CALLS      SCC0250- Clear Message Queue                       *
      *                                                               *
      * CALLED BY  MAINP  - Main input process                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPFMT    BEGSR                           ** DSPFMT **
      *
      ** Display message subfile control record
     C                     WRITERE4124C0
      *
      ** Display appropriate screen format
      *
      ** If any terminal errors - display tran.terminated screen
     C           *IN20     IFEQ '1'
     C                     EXFMTRE4124F1
      *
     C                     ELSE
      *
      ** If tran completed successfully - disp.tran.completed scrn.
     C           *IN22     IFEQ '1'
     C                     EXFMTRE4124F2
      *
     C                     ELSE
      *
      ** Otherwise display initial input screen
     C                     EXFMTRE4124F0
      *
     C                     END
      *
     C                     END
      *
      ** Clear program message queue and terminal & warning msg. lines
     C                     CALL 'SCC0250'
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RFRESH - Refresh screen                            *
      *                                                               *
      * CALLS      IFLDS  - Initialize screen/work fields             *
      *            INT01  - Initialise error indicators               *
      *            PCMTXT - Prepare comit text.                       *   CRT002
      *                                                               *
      * CALLED BY  MAINP  - Main input process                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RFRESH    BEGSR                           ** RFRESH **
      *
      ** Initialize all indicators
     C                     EXSR INT01
      *                                                                   CRT002
      **  Initialise WSUS (Posting-Was-Done-Against-Suspense indicator)   CRT002
      *                                                                   CRT002
     C                     MOVE 'N'       WSUS    1                       CRT002
      *
      ** Initialize screen/work fields
     C                     EXSR IFLDS
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALFMT - Validate screen input                     *
      *                                                               *
      * CALLS      VALDET - Validate details                          *
      *            RTTWID - Teller workstation conditions check       *
      *            INT01  - Initialise error indicators               *
      *            PAD    - Pad Balance with leading zeros.           *   198870
      *                                                               *
      * CALLED BY  MAINP  - Main input process                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALFMT    BEGSR                           ** VALFMT **
      *
      ** Initialise error indicators
     C                     EXSR INT01
      *
      ** Setof indicator for invalid input
     C                     SETOF                     50
      *
     C                     Z-ADD0         @TI     20
     C                     Z-ADD0         @WI     20
     C                     MOVE *BLANKS   @W
     C                     MOVE *BLANKS   @T
      *
      ** perform check for multiple sign on
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C***********          Z-ADD1         @I                       CRT002 130543
     C                     Z-ADD1         @J                              130543
     C                     MOVEL@TLID     @@PTL                           CRT002
     C                     MOVELRAUSID    @TLID                           CRT002
     C           @TLID     IFNE @@PTL                                     CRT002
     C***********@TLID     LOKUPWTL,@I                   60        CRT002 130543
     C           @TLID     LOKUPWTL,@J                   60               130543
     C           *IN60     IFEQ '1'                                       CRT002
     C***********@I        OCUR TELDS                  60          CRT002 130543
     C           @J        OCUR TELDS                  60                 130543
     C           *IN60     IFEQ '0'                                       CRT002
     C                     MOVELD@TLID    PTLID                           CRT002
     C                     MOVELD@TLBC    PTLBC                           CRT002
     C                     MOVELD@SPVI    PSPVI                           CRT002
     C                     MOVELD@OVRI    POVIN                           CRT002
     C**********           MOVELD@CHTL    PCHTL                                       CRT002 Bug3855
     C**********           MOVELD@NCTL    PNCTL                                       CRT002 Bug3855
     C                     Z-ADDD@CHTL    PCHTL                                              Bug3855
     C                     Z-ADDD@NCTL    PNCTL                                              Bug3855
     C                     MOVELD@DEPC    PDEPC                           CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     MOVELPTLID     @TLID                           CRT002
      *                                                                   CRT002
     C                     EXSR RTTWID
      *
      ** Validate details
     C                     EXSR VALDET
      *                                                                   CRT002
     C/COPY WNCPYSRC,RE4124C015
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
     C                     CLEARWCMSG                                     CRT002
     C                     MOVEL@MSGID    WUMSID                          CRT002
     C                     MOVELCNUM      @@CNUM  6                       CRT002
     C                     MOVEL@CCY      ACCY    3                       CRT002
     C                     Z-ADDTTNATN    @NATN                                               194978
     C                     MOVELRATRN1    RBTRN2                                              194978
     C                     EXSR MOVDET                                    CRT002
      *                                                                   CRT002
     C                     MOVELACCY      @CCY                            CRT002
     C                     Z-ADDRRNM      @RRNM                           CRT002
     C                     Z-ADDODLN      @ODLN                           CRT002
     C                     Z-ADDODED      @ODED                           CRT002
     C                     Z-ADDHELD      @HELD                           CRT002
     C                     EXSR RTBALC                                    CRT002
      *                                                                   CRT002
      ** If function code from lf/ttranl1 is one of the following         198870
     C           FNCD      IFEQ '00N'                                     198870
     C           FNCD      OREQ '0JN'                                     198870
     C           FNCD      OREQ '00K'                                     198870
     C           FNCD      OREQ '00R'                                     198870
     C           FNCD      OREQ '0JK'                                     198870
     C           FNCD      OREQ '00Q'                                     198870
     C           FNCD      OREQ '0JQ'                                     198870
     C           FNCD      OREQ '0JR'                                     198870
     C           FNCD      OREQ '00H'                                     198870
     C           FNCD      OREQ '0JH'                                     198870
     C           FNCD      OREQ '00P'                                     198870
     C           FNCD      OREQ '0JP'                                     198870
      *                                                                   198870
      ** ADD RATRA1 to get new available balance                          198870
     C                     ADD  RATRA1    @AVBL                           198870
      *                                                                   198870
     C                     ELSE                                           198870
      *                                                                   198870
     C           FNCD      IFEQ '00O'                                     198870
     C           FNCD      OREQ '0JO'                                     198870
     C           FNCD      OREQ '00L'                                     198870
     C           FNCD      OREQ '00W'                                     198870
     C           FNCD      OREQ '0JL'                                     198870
     C           FNCD      OREQ '0JW'                                     198870
      *                                                                   198870
      ** SUB RATRA1 to get new available balance                          198870
     C                     SUB  RATRA1    @AVBL                           198870
      *                                                                   198870
     C                     ELSE                                           198870
      *                                                                   198870
      ** If function code is '00I' or '***'                               198870
     C           FNCD      IFEQ '00I'                                     198870
     C           FNCD      OREQ '***'                                     198870
      *                                                                   198870
      ** Access PF/SDRETRPD for transaction type from TTRANL1             198870
     C                     MOVE TRTTP1    @RETR                           198870
     C                     CALL 'AORETRR0'                                198870
     C                     PARM '*BLANKS' @RTCD   7                       198870
     C                     PARM '*KEY   ' @OPTN   7                       198870
     C                     PARM           @RETR   5                       198870
     C           SDRETR    PARM SDRETR    DSFDY                           198870
      *                                                                   198870
      ** If record does not exists -                                      198870
     C           @RTCD     IFNE *BLANK                                    198870
     C           *LOCK     IN   LDA                        ***************198870
     C                     Z-ADD3         DBASE            ** DB ERR 03 * 198870
     C                     MOVE 'SDRETRPD'DBFILE           ***************198870
     C                     MOVELTRTTP1    DBKEY                           198870
     C                     EXSR DBERR                                     198870
     C                     ELSE                                           198870
      *                                                                   198870
      ** If Transaction type is CR then ADD RATRA1 to Available balance   198870
     C           A1DCIN    IFEQ 'C'                                       198870
     C                     ADD  RATRA1    @AVBL                           198870
     C                     ELSE                                           198870
      *                                                                   198870
      ** If Transaction type is DR then SUB RATRA1 to Available balance   198870
     C           A1DCIN    IFEQ 'D'                                       198870
     C                     SUB  RATRA1    @AVBL                           198870
     C                     ENDIF                                          198870
     C                     ENDIF                                          198870
      *                                                                   198870
     C                     ENDIF                                          198870
     C                     ENDIF                                          198870
      *                                                                   198870
     C                     ENDIF                                          198870
     C                     ENDIF                                          198870
      *                                                                   198870
      **  Account Balance Sign (after).                                   CRT002
      *                                                                   CRT002
     C           *IN80     IFEQ '0'                                       CRT002
      *                                                                   CRT002
     C**********           MOVEL'+'       RBABDS                   CRT002 198870
      *                                                                   CRT002
     C           @AVBL     IFLT 0                                         CRT002
     C                     Z-SUB@AVBL     @AVBL                           CRT002
     C***********          MOVEL'-'       RBABDS                   CRT002 198870
     C                     MOVEL'+'       RBABDS                          198870
     C                     ELSE                                           198870
     C           @AVBL     IFGT 0                                         198870
     C                     MOVEL'-'       RBABDS                          198870
     C                     ELSE                                           198870
     C                     MOVE ' '       RBABDS                          198870
     C                     ENDIF                                          198870
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Account Balance (after).                                        CRT002
      *                                                                   CRT002
     C                     MOVE @AVBL     ZFIELD                          CRT002
     C                     Z-ADDA6NBDP    ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    RBDAAB                          CRT002
     C                     MOVE *BLANKS   WFIELD 16                       198870
     C                     MOVE RBDAAB    WFIELD                          198870
     C                     EXSR PAD                                       198870
     C                     MOVEARTE       RBDAAB                          198870
     C                     MOVEA*BLANKS   RTE                             198870
      *                                                                   CRT002
     C/COPY WNCPYSRC,REH00318
     C           *IN50     IFEQ *ON                                       CRT008
     C                     MOVELREPOIO    P@QDS                           CRT002
     C                     EXSR SDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVELREPOIO    WCMSG                           CRT002
     C                     EXSR WRLOG                                     CRT002
      *                                                                   CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
     C                     MOVEL*BLANKS   REPOIO                          CRT002
      *                                                                   CRT008
     C                     ENDIF                                          CRT008
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            INT01  - Initialise error indicators               *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  FIRST  - Initial Processing                        *
      *            VALFMT - Validate screen input                     *
      *            RFRESH - Refresh screen                            *
      *                                                               *
      *****************************************************************
     C           INT01     BEGSR                           ** INT01  **
      *
      ** Setof screen conditioning & error indicators
     C                     SETOF                     111213
     C                     SETOF                     1415
     C                     SETOF                     23
     C                     SETOF                     69                   CRT002
      *
      ** Setof non-a/c ccy transaction indicator
     C                     SETOF                     09
      *
      ** Setof indicator for override required
     C                     SETOF                     51
      *
      ** Seton indicator for invalid input
     C                     SETON                     50
      ** Setof Acknowledgement Indicator                                  197289
     C                     SETOF                     30                   197289
      *
      ** If screen is to be refreshed - then setof 22 (tran.completed)
      ** 21 (Override reqd.), 20 (terminal errors), 23 (display bal.)
      ** 24 (Warning errors)
     C           *INKE     IFEQ '1'
     C                     SETOF                     202122
     C                     SETOF                     2324
     C                     MOVE *OFF      *IN54                                               CRT026
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALDET - Validate Details                          *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            VALAMT - Validate amount                           *
      *            VALOVR - Validate override conditions              *
      *            TRNACC - Transaction accept process                *
      *            RTCASH - Excess cash check                         *
      *            RTTCCY - Teller currency conditions check          *
      *                                                               *
      * CALLED BY  VALFMT - Validate screen input                     *
      *                                                               *
      *****************************************************************
     C           VALDET    BEGSR                           ** VALDET **
      *
      ** Setof indicators conditioning warn/term err,comp. & ovr.reqd
     C                     SETOF                     202122
     C                     SETOF                     24
     C                     MOVE *OFF      *IN54                                               CRT026
      *---------------------------------------------------------------*
      * Field - Batch number                                          *
      *---------------------------------------------------------------*
      *
      ** If Batch no. is not blanks- check whether exists in pf/ttrntm2
      ** message -
     C           SBATNO    IFNE *BLANKS
      *
      ** Setup key to access file ttrntm2
     C                     MOVEL'B'       KTBRI
     C                     MOVELSBATNO    KTBID
     C                     MOVEL'1'       KRCTP
      *
      ** Access lf/ttrntm2
     C           KLTRNT    CHAINTTRNTM2F             70
      *
      ** If record does not exist or is not a live record
     C           *IN70     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     SETON                     1150
     C                     MOVEL'USR0045' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** If batch input teller branch is different from that of current
      ** teller's branch code
     C           PMODE     IFEQ 'I'                                       CRT002
     C           TLBC      IFNE PTLBC
     C                     SETON                     1150
     C                     MOVEL'USR0078' @MSGID
     C                     EXSR SNDMSG
     C                     END
     C                     ENDIF                                          CRT002
      *
      ** Check if batch number is active
     C           ACTV      IFEQ 'Y'
     C                     SETON                     1150
     C                     MOVEL'USR0094' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
      ** If Batch no. is blanks - access ttrntm2 for teller record
     C                     ELSE
      *
      ** Setup key to access file ttrntm2
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     MOVEL'1'       KRCTP
      *
      ** Access lf/ttrntm2
     C           KLTRNT    CHAINTTRNTM2F             70
      *
     C                     END
      *                                                                   CRT002
     C           *IN50     IFEQ '1'                                       CRT002
     C                     GOTO VALDE9                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      *---------------------------------------------------------------*
      * Field - Transaction number                                    *
      *---------------------------------------------------------------*
      *
      ** Test if tran.no. is numeric - 16 is seton if numeric
     C                     SETOF                     16
     C                     TESTN          STTNO      16
      *
      ** If tran.no. is not numeric or is zeros
      ** message -                                                     zeros
     C           *IN16     IFEQ '0'
     C           STTNO     OREQ *ZEROS
     C                     SETON                     1250
     C                     MOVEL'USR0109' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     MOVE STTNO     @TTNO   50
      *
      ** If trans.no is valid - check whether it exists in tran.file
     C           *IN12     IFEQ '0'
      *
      ** If batch number entered & tran.no is > batch last item used
     C           SBATNO    IFNE *BLANKS
     C           @TTNO     ANDGTBITU
     C                     SETON                     1250
     C                     MOVEL'USR0047' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
      ** If batch number is blanks & tran.no is > next avl.tran.no
     C           SBATNO    IFEQ *BLANKS
     C           @TTNO     ANDGTTTNATN
     C                     SETON                     1250
     C                     MOVEL'USR0047' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
     C           *IN50     IFEQ '1'                                       CRT002
     C                     GOTO VALDE9                                    CRT002
     C                     END                                            CRT002
      *
      ** If batch number ignore further validation
     C           *IN11     IFNE '1'
      *
      *
      ** Setup key to access lf/ttranl1
      ** For trans.use teller branch, for batch - branch from ttrntm2
     C           SBATNO    IFEQ *BLANKS
     C                     MOVEL'T'       K2BRI
     C                     MOVELPTLID     K2BID
     C                     MOVE PTLBC     K2ITB
      *
     C                     ELSE
      *
     C                     MOVEL'B'       K2BRI
     C                     MOVELSBATNO    K2BID
     C                     MOVE TLBC      K2ITB
      *
     C                     END
      *
     C                     Z-ADD@TTNO     K2TRN
      *
     C********** PMODE     IFEQ 'P'                                                   194978 BUG8685
     C                     EXSR SETBAT
     C**********           ENDIF                                                      194978 BUG8685
      *
      ** Access lf/ttranl1 for tran.no.record
     C           KLTRAN    CHAINTTRANPDF             70
      *
      ** If record exists -
     C           *IN70     IFEQ '0'
      *
      ** If fn. code is any of the following(not a/c related or fx)
     C           FNCD      IFEQ 'MJM'
     C           FNCD      OREQ '0JA'
     C           FNCD      OREQ '0JT'
     C           FNCD      OREQ '0JV'
     C           FNCD      OREQ '00S'                                     CRT002
     C           FNCD      OREQ '00X'                                     CRT002
     C           FNCD      OREQ '00E'
     C           FNCD      OREQ '00F'
     C           FNCD      OREQ '0JE'
     C           FNCD      OREQ '0JF'
     C                     SETON                     1250
     C                     MOVEL'USR0110' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   197289
      ** Use access program AOBRCHR1 to retrieve branch details           197289
      *                                                                   197289
     C                     MOVELK2ITB     @BRCH                           197289
     C                     CALL 'AOBRCHR1'                                197289
     C                     PARM '*BLANKS' @RTCD   7                       197289
     C                     PARM '*KEY   ' @OPTN   7                       197289
     C                     PARM           @BRCH   3                       197289
     C           SDBRCH    PARM SDBRCH    DSFDY                           197289
      *                                                                   197289
      ** If record does not exist                                         197289
     C           @RTCD     IFNE *BLANKS                                   197289
     C           *LOCK     IN   LDA                                       197289
     C                     MOVEL'SDBRCHPD'DBFILE           ***************197289
     C                     MOVE @BRCH     DBKEY            ** DB ERR 22 **197289
     C                     Z-ADD22        DBASE            ***************197289
     C                     EXSR DBERR                                     197289
     C                     END                                            197289
      *                                                                   197289
      * Cashier Mode, TCP/IP Branch and the record currently stored is    197289
      * a reversal record.                                                197289
      *                                                                   197289
     C           PMODE     IFEQ 'P'                                       197289
     C           A8TCPP    ANDNE*ZEROS                                    197289
     C           CRTN      ANDNE*ZEROS                                    197289
     C           CRTN      ANDLTK2TRN                                     197289
     C                     MOVE TBTN      TBTNX   50                      197289
     C                     MOVE CRTN      K2TRN                           197289
      *                                                                   197289
      * Chain on the transaction linked to the reversal record            197289
      * and clear out the reference field                                 197289
      *                                                                   197289
     C           KLTRAN    CHAINTTRANPDF             70                   197289
     C                     MOVE *BLANKS   CRTN                            197289
     C                     MOVE *BLANKS   RVCY                            197289
     C                     MOVE FNCD      FNCDX   3                       197289
     C                     UPDATTTRANPDF                                  197289
     C                     MOVE TBTNX     K2TRN                           197289
      *                                                                   197289
      * Clear the reference field on the actual reversal and              197289
      * set the acknowledged flag to 'Y'                                  197289
      *                                                                   197289
     C           KLTRAN    CHAINTTRANPDF             70                   197289
     C                     MOVE *BLANKS   CRTN                            197289
     C                     MOVE *BLANKS   RVCY                            197289
     C           ACKF      IFEQ ' '                                       197289
     C                     MOVE 'Y'       ACKF                            197289
     C                     ENDIF                                          197289
     C                     UPDATTTRANPDF                                  197289
     C                     SETON                     30                   197289
     C                     ENDIF                                          197289
      *                                                                   197289
      * If record is a reversal that has already been reversed then       197289
      * reverse the original transaction                                  197289
      *                                                                   197289
     C           CRTN      IFNE *ZEROS                                    197289
     C           PMODE     ANDEQ'P'                                       197289
     C           A8TCPP    ANDNE*ZEROS                                    197289
     C           FNCD      ANDEQ'0JD'                                     197289
     C           CRTN      ANDGTK2TRN                                     197289
     C                     MOVELRATRN2    @TRNO                           197289
     C                     MOVE WTRNO     K2TRN                           197289
     C           KLTRAN    CHAINTTRANPDF             70                   197289
     C                     MOVE WTRNO     @TTNO                           197289
     C                     ENDIF                                          197289
      *                                                                   197289
      *
      ** Check if transaction is already reversed
     C           CRTN      IFNE *ZEROS
     C                     SETON                     1250
     C                     MOVEL'USR0111' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           *IN50     IFEQ '1'                                       CRT002
     C                     GOTO VALDE9                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      *---------------------------------------------------------------*
      * Field - Account number                                        *
      *---------------------------------------------------------------*
      *
     C                     SETOF                     70
     C/COPY WNCPYSRC,RE4124C023
     C                     MOVELSRACNO    @ACNO  100
      *
      ** If transaction is retail a/c related (retail a/c from ttranl1
      **                                       is non zeros)
     C           TRACNO    IFNE *ZEROS
      *
     C           SRACNO    IFEQ *BLANKS
     C                     SETON                     1350
     C                     MOVEL'USR0114' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Validate retail acct no.
     C                     MOVE *BLANKS   SACN20 10
     C                     MOVEL@ACNO     SACN20
      *
     C           SRACNO    IFNE SACN20
     C           @ACNO     ORLT 0
     C                     SETON                     70
     C                     END
      *
     C           @ACNO     IFNE TRACNO
     C           *IN70     OREQ '1'
     C                     SETON                     1350
     C                     MOVEL'USR0114' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           *IN50     IFEQ '1'                                       CRT002
     C                     GOTO VALDE9                                    CRT002
     C                     END                                            CRT002
      *
      ** If Account number is not blanks
     C           SRACNO    IFNE *BLANKS
      *
      ** Access lf/acnum
     C           *IN70     IFEQ '0'
     C           @ACNO     CHAINACNUMABF             70
     C                     END
      *
      ** If record not found
     C           *IN70     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     SETON                     1350
     C                     MOVEL'USR0050' @MSGID
     C                     EXSR SNDMSG
      *
      ** otherwise
     C                     ELSE
      *
      ** Store a/c ccy and name & rel.rec.no of pf/memos
     C                     MOVELCCY       @ACCY   3
     C                     MOVELANAM      @ACNM  20
     C*********************Z-ADDRRNM      @ORNM   50                      CCB002
      *
      ** Check account status
     C           ACST      IFEQ 'C'
     C                     SETON                     1350
     C                     MOVEL'USR0051' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
      *                                                                   CRT002
      **  Transfer fields to work fields for possible chain to LF/REIAC.  CRT002
      *                                                                   CRT002
     C**********           Z-ADDCNUM      @CNUM                                        CRT002 CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     Z-ADDACOD      @ACOD                           CRT002
     C                     Z-ADDACSQ      @ACSQ                           CRT002
     C                     MOVELBRCA      @BRCA                           CRT002
      *                                                                   CRT002
      **  Retrieve Available Balance before transaction is carried out.   CRT002
      *                                                                   CRT002
     C                     MOVELCCY       @CCY                            CRT002
     C                     Z-ADDRRNM      @RRNM                           CRT002
     C                     Z-ADDODLN      @ODLN                           CRT002
     C                     Z-ADDODED      @ODED                           CRT002
     C                     Z-ADDHELD      @HELD                           CRT002
     C                     MOVELSRACNO    @ACNOM                          198870
     C                     EXSR RTBALC                                    CRT002
      *                                                                   CRT002
     C           *IN80     IFEQ '0'                                       CRT002
      *                                                                   CRT002
     C***********          MOVEL'+'       RBAVBS                   CRT002 198870
      *                                                                   CRT002
     C           @AVBL     IFLT 0                                         CRT002
     C                     Z-SUB@AVBL     @AVBL                           CRT002
     C***********          MOVEL'-'       RBAVBS                   CRT002 198870
     C                     MOVEL'+'       RBAVBS                          198870
     C                     ELSE                                           198870
     C           @AVBL     IFGT 0                                         198870
     C                     MOVEL'-'       RBAVBS                          198870
     C                     ELSE                                           198870
     C                     MOVE ' '       RBAVBS                          198870
     C                     ENDIF                                          198870
     C                     END                                            CRT002
      *                                                                   CRT002
     C                     MOVEL@AVBL     RBAVBL                          CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
      *
     C                     END
      *
     C                     END
      *                                                                   CRT002
     C           *IN50     IFEQ '1'                                       CRT002
     C                     GOTO VALDE9                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      *---------------------------------------------------------------*
      * Field - Currency                                              *
      *---------------------------------------------------------------*
      *
      ** Currency must be same as trans.ccy code
      ** message -
     C           SCCY      IFNE TRCCY1
     C                     SETON                     1450
     C                     MOVEL'USR0112' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *                                                                   CRT002
     C           *IN50     IFEQ '1'                                       CRT002
     C                     GOTO VALDE9                                    CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      *---------------------------------------------------------------*
      * Get transaction details before validating amount              *
      *---------------------------------------------------------------*
      *
      ** Get transaction details
     C                     EXSR GETRDT
      *
      ** Validate amount
     C                     EXSR VALAMT
      *
      *
     C                     END
      *
      *
      ** If there are no errors in validation
     C           *IN50     IFEQ '0'
      *
      ** Store function code & name required for dsp. on override scrn.
     C                     MOVELFNCD      @FNCD   3
      *
      ** Access function code record from PF/SDFNCDPD
     C                     CALL 'AOFNCDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           @FNCD
     C           SDFNCD    PARM SDFNCD    DSFDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDFNCDPD'DBFILE           ***************
     C                     Z-ADD15        DBASE            ** DB ERR 15 **
     C                     MOVELFNCD      DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
     C                     MOVE *BLANKS   @FNNM  30
     C                     MOVELFQRNNR    @FNNM
      *
      ** Perform teller ccy conds.check for the input ccy
      *                                                                   120471
     C           FNCD      IFNE '0JR'                                     120471
     C           FNCD      ANDNE'0JW'                                     120471
     C                     MOVELSCCY      @CCY
     C                     ENDIF                                          120471
     C                     EXSR RTTCCY
      *
      ** If reversed transaction is foreign exchange
     C           FNCD      IFEQ '0JI'
     C           FNCD      OREQ '0JS'                                     CRT002
     C           FNCD      OREQ '0JX'                                     CRT002
      *
      ** And if PMODE is I (interactive).                                 139596
     C********** PMODE     ANDEQ'I'                                                    139596 194978
     C           PMODE     IFEQ 'I'                                                           194978
      *                                                                   139596
      ** Perform excess cash check
     C                     Z-ADDAMT1      @TNAM  130
     C                     MOVELTRCCY1    @CCY    3
     C                     EXSR RTCASH
     C                     ENDIF                                                              194978
      *
     C                     ELSE
      *
      ** Perform account conds. check
      *                                                                   120471
     C           FNCD      IFNE '0JR'                                     120471
     C           FNCD      ANDNE'0JW'                                     120471
     C                     MOVELRACCY1    @CCY                            120471
     C                     ENDIF                                          120471
     C                     EXSR ACCHEK
      *
     C                     END
      *
      ** If terminal error(s) exist
     C           @TI       IFGT 0
     C********** PMODE     IFEQ 'I'                                                    CRT002 194978
     C                     SETON                     20
     C**********           ENDIF                                                       CRT002 194978
     C                     MOVEA@T,1      SMSG1
     C                     MOVEA@T,10     SMSG2
      *
     C                     ELSE
      *
      ** If warning error(s) exist and different from previous error(s)
     C           @WI       IFGT 0
      *
      ** Seton indicator to for warning errors
     C                     SETON                     24
     C/COPY WNCPYSRC,REH00319
      *
     C                     MOVEA@W,1      SMSG1
     C                     MOVEA@W,10     SMSG2
      *
      ** Move overrride indicators from rtsdta to teller ovr.ind.array
     C                     MOVEAPOVIN     @R
      *
      ** Perform ovr.validation to check whether signon teller has
      ** authority to override - otherwise override prompt is required
     C                     EXSR VALOVR
      *
      ** If no successful override - override prompt is required
     C           *IN51     IFEQ '1'
      *
      ** If CRT026 is switch ON use user id instead of teller id                              CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE *ON       *IN54                                               CRT026
     C                     ELSE                                                               CRT026
     C                     SETON                     21
     C                     ENDIF                                                              CRT026
      *
     C/COPY WNCPYSRC,REH00320
     C                     END
      *
     C                     END
      *
     C/COPY WNCPYSRC,RE4124C003
      ** Perform transaction accept process (with or w/o override)
      *
      ** Align the resp.amts to be displayed on the override screen
     C                     MOVE *BLANKS   ZFLD15
      *
     C           FNCD      IFEQ '0JI'
     C           FNCD      OREQ '0JS'                                     CRT002
     C           FNCD      OREQ '0JX'                                     CRT002
     C                     MOVELTRCCY2    @TMPCY  3
     C                     MOVE TRAMT2    ZFLD15
     C                     ELSE
     C                     MOVEL@ACCY     @TMPCY
     C                     MOVE @TAAMT    ZFLD15
     C                     END
      *
     C*
     C                     CALL 'AOCURRR0'
     C                     PARM '*DBERR'  @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM @TMPCY    @CURR   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'A'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @SCEAM
     C                     MOVE ZOUT22    @SCEAM
      *
      ** Move the input screen fields to be displayed as output
     C                     MOVELSRACNO    @IACNO
     C                     MOVELSCCY      @ICCY
     C                     MOVELTRCCY2    @SECCY
      *
     C                     MOVE @IACNO    @ACNO2 100                      CCB002
      *                                                                   CCB002
      ** If function code is not fx (oji) - align aval.bal & led.bal
     C           FNCD      IFNE '0JI'
     C           FNCD      ORNE '0JS'                                     CRT002
     C           FNCD      ORNE '0JX'                                     CRT002
      *                                                                   CCB002
      ** Chain access object AOMEMSR0                                     CCB002
     C                     CALL 'AOMEMSR0'                                CCB002
     C                     PARM *BLANK    W0RTCD  7        I:Return code  CCB002
     C                     PARM '*KEY   ' W0OPTN  7        O:Option       CCB002
     C                     PARM @ACNO2    W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM *ZERO     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM *BLANKS   W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM *BLANK    W0CCY   3        O:Currency     CCB002
     C                     PARM *ZERO     W0ACDD  40       O:Account Code CCB002
     C                     PARM *ZERO     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM *BLANK    W0BRCA  3        O:Branch       CCB002
     C           DSMEMS    PARM DSMEMS    DSFDY                           CCB002
      *
     C                     MOVE CLBLN     ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'A'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @AVLBL
     C                     MOVE ZOUT22    @AVLBL
      *
      ** Access pf/memos for resp. a/c no. to get ledger balance
     C                     MOVEL@IACNO    @ACNO
     C***********@ORNM*****CHAINMEMOS                70                   CCB002
      *
     C                     MOVE LDBLN     ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'A'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @LEDBL
     C                     MOVE ZOUT22    @LEDBL
      *
      ** Seton screen indicator for non-a/c ccy trans
     C           FNCD      IFEQ '0JN'
     C           FNCD      OREQ '0JK'
     C           FNCD      OREQ '0JQ'
     C           FNCD      OREQ '0JR'                                     CRT002
     C           FNCD      OREQ '0JH'
     C           FNCD      OREQ '0JP'
     C           FNCD      OREQ '0JO'
     C           FNCD      OREQ '0JL'
     C           FNCD      OREQ '0JW'                                     CRT002
      *
     C                     SETON                     09
      *
     C                     END
      *
     C                     END
     C/COPY WNCPYSRC,RE4124C012
      *
      ** Perform transaction accept process (with or w/o override)
     C                     SETON                     51
     C                     EXSR TRNACC
      *
     C                     END
      *
     C                     END
      *
     C           VALDE9    TAG                                            CRT002
      *                                                                   CRT002
     C                     UNLCKTTRNT                                     CRT002
      *                                                                   CRT002
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *           SETBAT  - Set up batch member override              *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY                                                     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           SETBAT    BEGSR                           ** SETBAT **
      *
      ** If not the first time, delete previous overrides & close file
     C           @CMD      IFNE *BLANKS
     C                     MOVEL*BLANKS   @CMD
     C                     MOVEL@TXT,1    @CMD
     C                     CALL 'QCMDEXC'              70
     C                     PARM           @CMD
     C                     PARM 80        @LEN   155
      *
     C**********           CLOSETTRANL1                70                 197289
      *
     C                     END
     C                     CLOSETTRANL1                70                 197289
      *
      ** Perform new override to LF/TTRANL1 & open file
     C                     MOVEL*BLANKS   @CMD
     C                     MOVEL@TXT,2    @CMD
     C                     MOVELK2BRI     @BRI
     C                     MOVELK2BID     @BID
     C                     CALL 'QCMDEXC'              70
     C                     PARM           @CMD
     C                     PARM 80        @LEN
      *                                                                   CRT002
     C                     MOVEL'QCMDEXC' P@QRS                           CRT002
     C                     MOVEL@CMDT     P@QKY                           CRT002
     C                     EXSR DQERR                                     CRT002
      *
     C                     OPEN TTRANL1                70
      *                                                                   CRT002
      **  If not the first time, delete previous overrides                CRT002
      *                                                                   CRT002
     C           @CMDT     IFNE *BLANKS                                   CRT002
     C                     MOVEL*BLANKS   @CMDT                           CRT002
     C                     MOVEL@TXT,4    @CMDT                           CRT002
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMDT                           CRT002
     C                     PARM 80        @LEN   155                      CRT002
     C                     CLOSETTRANPT                70                 CRT002
     C                     ENDIF                                          CRT002
      *                                                                   CRT002
      **  Perform override to PF/TTRANPT & open file                      CRT002
      *                                                                   CRT002
     C                     MOVEL*BLANKS   @CMDT                           CRT002
     C                     MOVEL@TXT,5    @CMDT                           CRT002
     C**********           MOVEL'T'       @BRIT                                        CRT002 243813
     C                     MOVELK2BRI     @BRIT                                               243813
     C************         MOVEL@TLID     @BIDT                    CRT002 197289
     C                     MOVELK2BID     @BIDT                    CRT002 197289
     C                     CALL 'QCMDEXC'              70                 CRT002
     C                     PARM           @CMDT                           CRT002
     C                     PARM 80        @LEN   155                      CRT002
      *                                                                   CRT002
     C                     MOVEL'QCMDEXC' P@QRS                           CRT002
     C                     MOVEL@CMDT     P@QKY                           CRT002
     C                     EXSR DQERR                                     CRT002
      *                                                                   CRT002
     C                     OPEN TTRANPT                70                 CRT002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALAMT - Validate amount                           *
      *                                                               *
      * CALLS      ZALIGN - Validate amount fields                    *
      *            ZFRPED - Edit numeric field                        *
      *            SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALAMT    BEGSR                           ** VALAMT **
      *
      ** Get the no.of decimal places of input currency
     C*
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANK'  @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           SCCY
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ** If record not found - set no.of decimal places to zeros
     C           @RTCD     IFNE *BLANK
     C                     Z-ADD0         A6NBDP
     C                     END
      *
      ** Store no.of decimal places and mult./div ind.for inp. currency
     C                     Z-ADDA6NBDP    @IDEC   10
     C                     MOVE A6MDIN    @IMD    1
      *                                                                                       CRE019
      ** If CRE019 is on, store currency spot rate                                            CRE019
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C                     Z-ADDA6SPRT    WISPRT 138                                          CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       194978
      ** Correct amount if cross-currency reversal                                            194978
     C           PMODE     IFEQ 'P'                                                           194978
     C           FNCD      IFEQ '0JN'                                                         194978
     C           FNCD      OREQ '0JO'                                                         194978
     C           FNCD      OREQ '0JQ'                                     198870
     C           FNCD      OREQ '0JP'                                     198870
     C           FNCD      OREQ '0JL'                                     198870
     C           FNCD      OREQ '0JK'                                     198870
     C           FNCD      OREQ '0JI'                                     198870
     C           FNCD      OREQ '0JH'                                     198870
     C                     MOVEL*BLANKS   SAMT                                                194978
     C                     MOVE AMT1      SAMT                                                194978
     C                     ENDIF                                                              194978
     C                     ENDIF                                                              194978
      *
      ** Check if amount field is blanks or zeros
     C           SAMT      IFEQ *ZEROS
     C           SAMT      OREQ *BLANKS
     C                     SETON                     1550
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C                     MOVEL*BLANKS   ZFIELD                          CRT002
     C                     MOVE SAMT      ZFIELD                          CRT002
     C                     Z-ADD@IDEC     ZADEC                           CRT002
     C                     EXSR ZEDIT                                     CRT002
     C                     MOVE ZFIELD    SAMT                            CRT002
     C                     ENDIF                                          CRT002
      *
      ** Set up decimal values
     C                     Z-ADD@IDEC     ZADEC
     C           13        SUB  @IDEC     ZADIG
      *
      ** Align amount - and move it to numeric field
     C                     MOVEL*BLANK    ZFIELD
     C                     MOVE SAMT      ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @TAMT  150
      *
      ** If error found?  Set up error message
     C           *IN99     IFEQ '1'
     C           ZFIELD    OREQ *ZERO
     C                     SETON                     1550
     C                     MOVE 'USR0008' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *                                                                   120471
     C           PMODE     IFEQ 'P'                                       120471
      *                                                                   120471
      * If CRT012 is On then                                              CRT012
      * need to accumulate the individual charge amounts                  CRT012
      * of the transaction.                                               CRT012
     C           CRT012    IFEQ 'Y'                                       CRT012
     C                     Z-ADD0         TOTCHG 130                      CRT012
     C           KCHARG    SETLLTTCHGL0                                   CRT012
     C           KCHARG    READETTCHGL0                  70               CRT012
     C           *IN70     DOWEQ*OFF                                      CRT012
     C                     ADD  AMT3      TOTCHG                          CRT012
     C           KCHARG    READETTCHGL0                  70               CRT012
     C                     ENDDO                                          CRT012
     C                     Z-ADD0         AMT3                            CRT012
     C                     Z-ADDTOTCHG    AMT3                            CRT012
     C                     ELSE                                           CRT012
     C                     Z-ADD0         AMT3                            120471
     C           KCHARG    CHAINTTCHGL0              70                   120471
     C                     ENDIF                                          CRT012
      *                                                                   120471
     C           AMT3      IFNE *ZERO                                     120471
     C           CCY3      ANDEQRACCY1                                    120471
     C           *IN17     ANDEQ'0'                                       120471
      *                                                                   120471
     C           FNCD      IFEQ '00L'                                     120471
     C           FNCD      OREQ '00W'                                     120471
     C           FNCD      OREQ '0JL'                                     120471
     C           FNCD      OREQ '0JW'                                     120471
     C           FNCD      OREQ '0JO'                                     120471
     C           FNCD      OREQ '00O'                                     120471
     C                     SUB  AMT3      @TAMT                           120471
      *                                                                   120471
     C                     ELSE                                           120471
     C                     ADD  AMT3      @TAMT                           120471
     C                     END                                            120471
      *                                                                   120471
     C                     END                                            120471
      *                                                                   120471
     C                     END                                            120471
      *
      ** Check if amount is equal to total transaction amount
     C           @TAMT     IFNE @TTAMT
     C                     SETON                     1550
     C                     MOVE 'USR0113' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
     C                     END
      *
      ** If there are no errors - edit the amount field - insert dec.pt
     C           *IN15     IFEQ '0'
      *
     C                     Z-ADD@IDEC     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE @TAMT     ZFLD15
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @AMTDS
     C                     MOVE *BLANKS   SAMT
     C                     MOVE ZOUT22    @AMTDS
     C                     MOVEL@SAMT     SAMT
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            GETRDT - Get transaction details                   *
      *                                                               *
      * CALLS      ZALIGN - Validate amount fields                    *
      *            ZFRPED - Edit numeric field                        *
      *            SNDMSG - Send program message parameters           *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           GETRDT    BEGSR                           ** GETRDT **
      *
      ** Initialise work variables
     C                     Z-ADD0         @RVTTY
     C                     Z-ADD0         @RTRVT
      *
      ** If function code from lf/ttranl1 is one of the following
     C           FNCD      IFEQ '00N'
     C           FNCD      OREQ '0JN'
     C           FNCD      OREQ '00K'
     C           FNCD      OREQ '00R'                                     CRT002
     C           FNCD      OREQ '0JK'
     C           FNCD      OREQ '00Q'
     C           FNCD      OREQ '0JQ'
     C           FNCD      OREQ '0JR'                                     CRT002
     C           FNCD      OREQ '00H'
     C           FNCD      OREQ '0JH'
     C           FNCD      OREQ '00P'
     C           FNCD      OREQ '0JP'
      *
      ** Set reversal trans.type to credit
     C                     Z-ADD1         @RVTTY  10
      *
     C                     ELSE
      *
     C           FNCD      IFEQ '00O'
     C           FNCD      OREQ '0JO'
     C           FNCD      OREQ '00L'
     C           FNCD      OREQ '00W'                                     CRT002
     C           FNCD      OREQ '0JL'
     C           FNCD      OREQ '0JW'                                     CRT002
      *
      ** Set reversal trans.type to debit
     C                     Z-ADD0         @RVTTY
      *                                                                   197289
     C                     ELSE                                           197289
     C           FNCD      IFEQ '0JD'                                     197289
      *                                                                   197289
      ** Previous function code is..                                      197289
      *                                                                   197289
     C           FNCDX     IFEQ '00N'                                     197289
     C           FNCDX     OREQ '0JN'                                     197289
     C           FNCDX     OREQ '00K'                                     197289
     C           FNCDX     OREQ '00R'                                     197289
     C           FNCDX     OREQ '0JK'                                     197289
     C           FNCDX     OREQ '00Q'                                     197289
     C           FNCDX     OREQ '0JQ'                                     197289
     C           FNCDX     OREQ '0JR'                                     197289
     C           FNCDX     OREQ '00H'                                     197289
     C           FNCDX     OREQ '0JH'                                     197289
     C           FNCDX     OREQ '00P'                                     197289
     C           FNCDX     OREQ '0JP'                                     197289
      *                                                                   197289
      ** Set reversal trans.type to debit                                 197289
      *                                                                   197289
     C                     Z-ADD0         @RVTTY                          197289
     C                     ELSE                                           197289
      *                                                                   197289
     C           FNCDX     IFEQ '00O'                                     197289
     C           FNCDX     OREQ '0JO'                                     197289
     C           FNCDX     OREQ '00L'                                     197289
     C           FNCDX     OREQ '00W'                                     197289
     C           FNCDX     OREQ '0JL'                                     197289
     C           FNCDX     OREQ '0JW'                                     197289
      *
      ** Set reversal trans.type to credit                                197289
      *
     C                     Z-ADD1         @RVTTY  10                      197289
     C                     END                                            197289
     C                     END                                            197289
      *
      *
     C                     END                                            197289
      *
     C                     END
      *
     C                     END
      *
      ** If function code is '00I' or '***'
     C           FNCD      IFEQ '00I'
     C           FNCD      OREQ '***'
      ** Access PF/SDRETRPD for transaction type from TTRANL1
     C                     MOVE TRTTP1    @RETR
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record does not exists -
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD3         DBASE            ** DB ERR 03 *
     C                     MOVE 'SDRETRPD'DBFILE           ***************
     C                     MOVELTRTTP1    DBKEY
     C                     EXSR DBERR
      *
     C                     ELSE
      *
      ** If debit/credit indicator is 'D'
     C           A1DCIN    IFEQ 'D'
      *
      ** Set reversal trans.type to debit
     C                     Z-ADD0         @RVTTY
      *
     C                     ELSE
      *
      ** If debit/credit indicator is 'C'
     C           A1DCIN    IFEQ 'C'
      *
      ** Set reversal trans.type to credit
     C                     Z-ADD1         @RVTTY
      *
     C                     END
      *
     C                     END
      *
     C                     END
      *
     C                     END
      *
      ** If function code from lf/ttranl1 is one of the following
     C           FNCD      IFEQ '00N'
     C           FNCD      OREQ '00K'
     C           FNCD      OREQ '00Q'
     C           FNCD      OREQ '00R'                                     CRT002
     C           FNCD      OREQ '00O'
     C           FNCD      OREQ '00L'
     C           FNCD      OREQ '00W'                                     CRT002
     C           FNCD      OREQ '00A'
     C           FNCD      OREQ '***'
      *
      ** Set amts.in a/c ccy & tran.ccy as amt.1 from ttranl1
     C                     Z-ADDAMT1      @TAAMT 150
     C                     Z-ADDAMT1      @TTAMT 150
      *
     C                     ELSE
      *
     C           FNCD      IFEQ '00H'
     C           FNCD      OREQ '00P'
     C           FNCD      OREQ '00I'
      *
      ** Set both the amounts as sum of amt1 & amt2 from ttranl1
     C           AMT1      ADD  TRAMT2    @TAAMT
     C           AMT1      ADD  TRAMT2    @TTAMT
      *
     C                     END
      *
     C                     END
      *
      ** If function code from lf/ttranl1 is one of the following
     C           FNCD      IFEQ '0JN'
     C           FNCD      OREQ '0JK'
     C           FNCD      OREQ '0JQ'
     C           FNCD      OREQ '0JR'                                     CRT002
     C           FNCD      OREQ '0JO'
     C           FNCD      OREQ '0JL'
     C           FNCD      OREQ '0JW'                                     CRT002
      *
      ** Set amt. in a/c ccy as converted  amt.1 from ttranl1
     C                     Z-ADDTRCVAM    @TAAMT
      *
      ** Set amt. in tran. ccy as amt.1 from ttranl1
     C                     Z-ADDAMT1      @TTAMT
      *
     C                     END
      *
      ** If function code from lf/ttranl1 is one of the following
     C           FNCD      IFEQ '0JH'
     C           FNCD      OREQ '0JP'
      *
      ** Set amt. in a/c ccy as sum of converted  amt.1&2 from ttranl1
     C           TRCVAM    ADD  TRCVM2    @TAAMT
      *
      ** Set amt. in tran. ccy as sum of amt.1&2 from ttranl1
     C           AMT1      ADD  TRAMT2    @TTAMT
      *
     C                     END
      *
      ** If function code from lf/ttranl1 is '0ji'
      **                                     '0js', '0jx'                 CRT002
      *                                                                   CRT002
     C           FNCD      IFEQ '0JI'
     C           FNCD      OREQ '0JS'                                     CRT002
     C           FNCD      OREQ '0JX'                                     CRT002
      *
      ** Set amt. in tran. ccy as amt.1 from ttranl1
     C                     Z-ADDAMT1      @TTAMT
      *
     C                     END
      *
      ** Store ttran. amt1 & 2 and ccy1 &2
     C                     Z-ADDAMT1      @AMT1  150
     C                     Z-ADDTRAMT2    @AMT2  150
     C                     MOVELTRCCY1    @CCY1   3
     C                     MOVELTRCCY2    @CCY2   3
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            ACCHEK - Account conditions check                  *
      *                                                               *
      * CALLS      RTXRAT - Validate exchange rate                    *
      *            RTASGL - No associated GL code check               *
      *                                                               *
      * CALLED BY  MAINP  - Main input process                        *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           ACCHEK    BEGSR                           ** ACCHEK **
      *
      ** If fn.cd is '00A' - retail transfer
     C           FNCD      IFEQ '00A'
      *
      ** Access lf/acnum for account no.2 (credit a/c no. from ttranl1)
     C                     MOVE TRTTAC    @ACNO
     C           @ACNO     CHAINACNUMABF             70
     C***********          Z-ADDCNUM      @@CNUM  60                      CRT002
     C**********           Z-ADDCNUM      @@CUSN  60                                   CRT002 CSD027
     C                     MOVE CNUM      @@CUSN  6                                           CSD027
     C                     MOVELCCY       @@CCY   3
     C**********           Z-ADDACOD      @@ACOD  40                                          CGL029
     C                     Z-ADDACOD      @@ACOD 100                                          CGL029
     C                     Z-ADDACSQ      @@ACSQ  20
     C                     MOVELBRCA      @@BRCA  3
      *
     C                     END
      *
      ** Move retail indicator & a/c status from lf/acnum to work field
      ** Also store rel.rec.no of pf/memos for crdeit a/c
     C                     MOVELRETB      @RETB
     C                     MOVELACST      @ACST
     C*********************Z-ADDRRNM      @RRNM2  50                      CCB002
      *
      ** If Rev.trans.type is credit or fn.cd. from ttranl1 is '00A'
     C           @RVTTY    IFEQ 1
     C           FNCD      OREQ '00A'
      *
      ** If block debit check from fn.cd table is non-blank
     C***********@V,@BD    IFNE ' '                                       114621
     C           @V,@BD    IFNE 'X'                                       114621
     C                     EXSR RTBKDR
     C                     END
      *
      ** If ref. debit check from fn.cd table is non-blank
     C***********@V,@RD    IFNE ' '                                       114621
     C           @V,@RD    IFNE 'X'                                       114621
     C                     EXSR RTRFDR
     C                     END
      *
      **  If CRE081 is OFF                                                                    CRE081
      *                                                                                       CRE081
     C           CRE081    IFEQ 'N'                                                           CRE081
      *                                                                                       CRE081
      ** If insuf.fund, exceed od limit or min.bal check is non blank
     C***********@V,@IF    IFNE ' '                                       114621
     C***********@V,@OD    ORNE ' '                                       114621
     C***********@V,@MB    ORNE ' '                                       114621
     C           @V,@IF    IFNE 'X'                                       114621
     C           @V,@OD    ORNE 'X'                                       114621
     C           @V,@MB    ORNE 'X'                                       114621
     C                     Z-ADD@TAAMT    @TNAM
     C*********************Z-ADDRRNM      @RRNM                           CCB002
     C                     Z-ADDODLN      @ODLN
     C                     Z-ADDODED      @ODED
     C                     Z-ADDMINB      @MINB
      *
      ** Access lf/sdcurrl0 for no.of dec.places of a/c ccy
     C*
     C                     CALL 'AOCURRR0'
     C                     PARM '*BLANK'  @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM CCY       @CURR   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
     C           @RTCD     IFEQ *BLANK
     C                     Z-ADDA6NBDP    @CYDP
     C                     ELSE
     C                     Z-ADD0         @CYDP
     C                     END
      *
     C/COPY WNCPYSRC,RE4124C009
     C                     Z-ADD@ACNO     @ACNOM 100                      155095
     C/COPY WNCPYSRC,REH00156
     C/COPY WNCPYSRC,REH00039
     C                     EXSR RTABAL
     C/COPY WNCPYSRC,RE4124C010
      *
     C                     END
      *
      **  If CRE081 is ON, perform Account Balance Check                                      CRE081
      *                                                                                       CRE081
     C                     ELSE                                                               CRE081
      *                                                                                       CRE081
     C           @V,@IF    IFNE 'X'                                                           CRE081
     C           @V,@OD    ORNE 'X'                                                           CRE081
     C           @V,@MB    ORNE 'X'                                                           CRE081
     C                     EXSR VALABC                                                        CRE081
     C                     Z-ADDPAVBAL    CLBLN                                            AR1083178
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
      ** Perform account od check
     C                     Z-ADD@TAMT     @TNAM
     C                     Z-ADDCLBLN     @CLBL
     C                     MOVELACST      @ACST
     C                     MOVELSTYP      @STYP
     C                     Z-ADDLDBLN     @LDBL  150
      ** For current accounts only check for exceeded overdraft
     C           STYP      IFEQ 'C'
     C                     EXSR RTODCK
     C                     END
      *
     C                     END
      *
      ** If fn.cd is '00A'- retail transfer- get original rec.of acnum
     C           FNCD      IFEQ '00A'
      *
      ** Access lf/acnum for retail a/c no.
     C                     MOVE TRACNO    @ACNO
     C           @ACNO     CHAINACNUMABF             70
      *
     C                     END
      *
      ** Move retail indicator & a/c status from lf/acnum to work field
     C                     MOVELRETB      @RETB
     C                     MOVELACST      @ACST
      *
      ** If Rev.trans.type is debit  or fn.cd. from ttranl1 is '00A'
     C           @RVTTY    IFEQ 0
     C           FNCD      OREQ '00A'
      *
      ** If block credit check from fn.cd table is non-blank
     C***********@V,@BC    IFNE ' '                                       114621
     C           @V,@BC    IFNE 'X'                                       114621
     C                     EXSR RTBKCR
     C                     END
      *
      ** If ref.credit check from fn.cd table is non-blank
     C***********@V,@RC    IFNE ' '                                       114621
     C           @V,@RC    IFNE 'X'                                       114621
     C                     EXSR RTRFCR
     C                     END
      *
     C                     END
      *
      ** If inactive a/c check is non-blank
     C***********@V,@IA    IFNE ' '                                       114621
     C           @V,@IA    IFNE 'X'                                       114621
     C                     MOVEL'1 '      @ACIN   2
     C                     EXSR RTIACT
     C                     END
      *
      ** If bankrupt/liquidation check is non-blank
     C***********@V,@BL    IFNE ' '                                       114621
     C           @V,@BL    IFNE 'X'                                       114621
     C                     EXSR RTBKPT
     C                     END
      *
      ** If bad debt check is non-blank
     C***********@V,@DB    IFNE ' '                                       114621
     C           @V,@DB    IFNE 'X'                                       114621
     C                     EXSR RTBDPT
     C                     END
      *
      ** If a/c closing check is non-blank
     C***********@V,@AC    IFNE ' '                                       114621
     C           @V,@AC    IFNE 'X'                                       114621
     C                     EXSR RTACLG
     C                     END
      *
      ** If fn.cd is '00A' - retail transfer
     C           FNCD      IFEQ '00A'
      *
      ** Access lf/acnum for account no.2 (credit a/c no. from ttranl1)
     C                     MOVE TRTTAC    @ACNO
     C           @ACNO     CHAINACNUMABF             70
      *
      ** Move retail indicator & a/c status from lf/acnum to work field
     C                     MOVELRETB      @RETB
     C                     MOVELACST      @ACST
      *
      ** If inactive a/c check is non-blank
     C***********@V,@IA    IFNE ' '                                       114621
     C           @V,@IA    IFNE 'X'                                       114621
     C                     MOVEL'2 '      @ACIN
     C                     EXSR RTIACT
     C                     END
      *
      ** If bankrupt/liquidation check is non-blank
     C***********@V,@BL    IFNE ' '                                       114621
     C           @V,@BL    IFNE 'X'                                       114621
     C                     EXSR RTBKPT
     C                     END
      *
      ** If bad debt check is non-blank
     C***********@V,@DB    IFNE ' '                                       114621
     C           @V,@DB    IFNE 'X'                                       114621
     C                     EXSR RTBDPT
     C                     END
      *
      ** If a/c closing check is non-blank
     C***********@V,@AC    IFNE ' '                                       114621
     C           @V,@AC    IFNE 'X'                                       114621
     C                     EXSR RTACLG
     C                     END
      *
      ** Read back original(retail a/c) record from lf/acnum
     C                     MOVE TRACNO    @ACNO
     C           @ACNO     CHAINACNUMABF             70
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALOVR - Validate override conditions              *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALOVR    BEGSR                           ** VALOVR **
      *
      ** Setof error indicator
     C                     SETOF                     51
      *
      ** Set array index to 1
     C                     Z-ADD1         @I      20
      *
     C           @I        DOUGT25
     C           *IN51     OREQ '1'
      *
     C           @O,@I     IFEQ 'Y'
     C           @R,@I     ANDEQ'N'
     C                     SETON                     51
      *
     C                     ELSE
      *
     C                     ADD  1         @I
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            TRNACC - Transaction accept process                *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            SCC0250- Clear Message Queue                       *
      *            VOVDET - Validate override details                 *
      *            LAST   - Final processing - terminate pgm.         *
      *            SETDSP - Set indicators for display                *
      *                                                               *
      * CALLED BY  VALDET - Validate details                          *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           TRNACC    BEGSR                           ** TRNACC **
      *
      ** Do until successful override
     C           *IN51     DOUEQ'0'
      *
      ** Display message subfile control record
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
      *                                                                   CRT002
     C                     WRITERE4124C0
      *
      ** Display transaction acceptance screen depending on fn.cd
     C           FNCD      IFEQ '0JI'
     C           FNCD      OREQ '0JS'                                     CRT002
     C           FNCD      OREQ '0JX'                                     CRT002
     C                     EXFMTRE4124F4
     C                     ELSE
     C                     EXFMTRE4124F3
     C                     END
      *
      ** Clear program message queue and terminal & warning msg. lines
     C                     CALL 'SCC0250'
      *                                                                   CRT002
     C                     ELSE                                           CRT002
     C/COPY WNCPYSRC,REH00321
     C                     MOVE '1'       *INKA                           CRT002
     C/COPY WNCPYSRC,REH00322
     C                     MOVE '0'       *IN21                           CRT002
     C                     MOVE *OFF      *IN54                                               CRT026
     C/COPY WNCPYSRC,REH00323
     C                     ENDIF                                          CRT002
      *
      ** Process the input depending on the key pressed
      *
      ***If*Help*key*is*pressed,*perform*help*processing
      *
      ** If cmd/3 is pressed - terminate the program
     C           *INKC     CASEQ'1'       LAST
      *
      ** If cmd/2 is pressed - display account balances
     C           *INKB     CASEQ'1'       DSPBAL
      *
      ** If cmd/1 is pressed - validate override details
     C           *INKA     CASEQ'1'       VOVDET
      *
      ** If cmd/12 or enter key is pressed - Set indicators for dsplay
     C                     CAS            SETDSP
      *
     C                     END
      *
     C                     END
      *
      ** Save screen error messages (later to be used for output)
     C                     MOVE *BLANK    @MSG1  72
     C                     MOVE *BLANK    @MSG2  72
     C                     MOVELSMSG1     @MSG1  72
     C                     MOVELSMSG2     @MSG2  72
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VOVDET - Validate override details                 *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            VALOVR - Validate override conditions              *
      *            RTENCP - Encript passcode                          *
      *                                                               *
      * CALLED BY  TRNACC - Transaction accept process                *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VOVDET    BEGSR                           ** VOVDET **
      *
      ** Validation is to be done only if override prompt is displayed
      ** Otherwise - setof 51 to come out of loop
     C           *IN21     IFEQ '0'
     C           *IN54     ANDEQ'0'                                                           CRT026
     C                     SETOF                     51
      *
     C                     ELSE
      *
      ** Setof error indicators
     C                     SETOF                     111252
      *
      ** Override teller if blanks
      ** If CRT026 is switch ON User Id is required                                           CRT026
      *                                                                                       CRT026
     C           SOTLI     IFEQ *BLANKS
     C           SOVUR     ANDEQ*BLANKS                                                       CRT026
     C/COPY WNCPYSRC,REH00324
     C                     SETON                     1152
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVE 'USR1500' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'USR0032' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *                                                                                       CRT026
      ** Access user id details to obtain the teller id attached                              CRT026
      ** to the user id                                                                       CRT026
      *                                                                                       CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'AOUSERR0'                                                    CRT026
     C                     PARM *BLANKS   @RTCD   7                                           CRT026
     C                     PARM '*KEY'    @OPTN   7                                           CRT026
     C                     PARM SOVUR     @USRP  10                                           CRT026
     C           MUSER     PARM MUSER     DSSDY                                               CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C           @RTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'MUSERDD' DBFILE           ***************                    CRT026
     C                     Z-ADD24        DBASE            ** DB ERR 24 **                    CRT026
     C                     MOVELSOVUR     DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C                     MOVE *ON       *IN52                                               CRT026
     C                     MOVEL'USR1501' @MSGID                                              CRT026
     C                     EXSR SNDMSG                                                        CRT026
      ** If user id is valid use the teller attached to this user                             CRT026
      ** to obtain the teller details                                                         CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE TLID      @TELD                                               CRT026
     C                     ENDIF                                                              CRT026
      ** If CRT026 enhancement is switch OFF use the teller id                                CRT026
      ** entered to obtain the teller details                                                 CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE SOTLI     @TELD                                               CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
      ** If no validation errors exist                                                        CRT026
      *
      ** Check if record exists in file PF/SDTELDPD
     C           *IN52     IFEQ *OFF                                                          CRT026
     C                     CALL 'AOTELDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C**********           PARM           SOTLI                                               CRT026
     C                     PARM           @TELD   3                                           CRT026
     C           SDTELD    PARM SDTELD    DSFDY
      *
      ** If record not found
      ** message - Teller identifier not found
     C           @RTCD     IFNE *BLANK
     C                     SETON                     1152
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVEL'USR1509' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVEL'USR0030' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
     C                     END
     C                     ENDIF                                                              CRT026
      *
     C                     END
     C/COPY WNCPYSRC,REH00325
      *                                                                                       CRT026
      ** If no validation errors exist                                                        CRT026
      *                                                                                       CRT026
     C           *IN52     IFEQ *OFF                                                          CRT026
      *
      ** Check if passcode is blanks
      ** message - Teller passcode is required
      ** If CRT026 enhancement is ON check the password instead                               CRT026
      ** message - User password is required                                                  CRT026
     C           SOTPC     IFEQ *BLANKS
     C           SOVPW     ANDEQ*BLANKS                                                       CRT026
     C                     SETON                     1252
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     MOVEL'USR1502' @MSGID                                              CRT026
     C                     ELSE                                                               CRT026
     C                     MOVEL'USR0033' @MSGID
     C                     ENDIF                                                              CRT026
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *                                                                                       CRT026
      ** If CRT026 enhancement is ON check the password via REC4170                           CRT026
     C           CRT026    IFEQ 'Y'                                                           CRT026
     C                     CALL 'REC4170'                                                     CRT026
     C                     PARM           SOVUR                                               CRT026
     C                     PARM           SOVPW                                               CRT026
     C                     PARM *BLANKS   @RTCD   7                                           CRT026
      *                                                                                       CRT026
     C           @RTCD     IFNE *BLANKS                                                       CRT026
     C                     SELEC                                                              CRT026
     C           @RTCD     WHEQ 'CPF2204'                                                     CRT026
     C                     MOVE 'USR1501' @MSGID                                              CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C           @RTCD     WHEQ 'CPF22E3'                                                     CRT026
     C                     MOVE 'USR1506' @MSGID                                              CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C           @RTCD     WHEQ 'CPF2203'                                                     CRT026
     C                     MOVE 'USR1507' @MSGID                                              CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C           @RTCD     WHEQ 'CPF2213'                                                     CRT026
     C                     MOVE 'USR1508' @MSGID                                              CRT026
     C                     MOVE *ON       *IN11                                               CRT026
     C           @RTCD     WHEQ 'CPF22E5'                                                     CRT026
     C                     MOVE 'USR1505' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E2'                                                     CRT026
     C                     MOVE 'USR1503' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E4'                                                     CRT026
     C                     MOVE 'USR1504' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E6'                                                     CRT026
     C                     MOVE 'USR1510' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF22E9'                                                     CRT026
     C                     MOVE 'USR1511' @MSGID                                              CRT026
     C           @RTCD     WHEQ 'CPF2225'                                                     CRT026
     C                     MOVE 'USR1512' @MSGID                                              CRT026
     C                     ENDSL                                                              CRT026
     C                     MOVE *ON       *IN12                                               CRT026
     C                     MOVE *ON       *IN52                                               CRT026
     C                     EXSR SNDMSG                                                        CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C                     ELSE                                                               CRT026
      *
      ** Check if passcode matches with that in file
      ** message - Teller passcode
      *
      ** Encript the passcode
     C                     MOVEASOTPC     BPWD
     C                     Z-ADD6         X       10
     C                     EXSR RTENCP
     C                     MOVEAEPWD      SOTPC
      *
     C           SOTPC     IFNE FRTLPC
     C                     SETON                     1252
     C                     MOVEL'USR0039' @MSGID
     C                     EXSR SNDMSG
     C                     END
     C                     ENDIF                                                              CRT026
      *
     C                     END
     C                     ENDIF                                                              CRT026
     C/COPY WNCPYSRC,REH00326
      *
      ** If no errors in validation
     C           *IN52     IFEQ '0'
      *
      ** move override indicators from SDTELDPD to override ind.array
     C                     MOVEAFROVRI    @R
      *
      ** Perform override validation
     C                     EXSR VALOVR
      *
      ** If override unsuccessful -
      ** message - teller override failed
     C           *IN51     IFEQ '1'
     C                     MOVEL'USR0029' @MSGID
     C                     EXSR SNDMSG
     C/COPY WNCPYSRC,REH00327
     C                     END
      *
     C                     END
      *
     C/COPY WNCPYSRC,REH00328
     C                     END
      *
      ** Store override teller-id for updating on file
     C                     MOVE *BLANK    @OVTI   3
     C**********           MOVELSOTLI     @OVTI                                               CRT026
     C                     MOVEL@TELD     @OVTI                                               CRT026
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            SETDSP - Set indicators for display                *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  TRNACC - Transaction accept process                *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           SETDSP    BEGSR                           ** SETDSP **
      *
      ** If cmd/12 is pressed - display prev.screen
     C           *INKL     IFEQ '1'
      *
      ** Setof indicator to come out override screen loop
     C                     SETOF                     51
      *
      ** Setof common screen error indicators
     C                     SETOF                     1112
      *
      ** Seton indicator to loop to display previous screen
     C                     SETON                     50
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DSPBAL - Display account balances                  *
      *                                                               *
      * CALLS      RTBALC - Calculate available balances              *
      *            ZFRPED - Format and edit amount field              *
      *                                                               *
      * CALLED BY  TRNACC - Transaction accept process                *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DSPBAL    BEGSR                           ** DSPBAL **
      *
      **  If CRE081 is OFF or Available Balance is zero                                       CRE081
      *                                                                                       CRE081
     C           CRE081    IFEQ 'N'                                                           CRE081
     C           PAVBAL    OREQ 0                                                             CRE081
      *                                                                                       CRE081
      ** If no warning conditions exist
      *
      ** Perform calc. avaialable balance process
     C*********************Z-ADDRRNM      @RRNM                           CCB002
     C                     Z-ADDODLN      @ODLN
     C                     Z-ADDODED      @ODED
     C                     Z-ADDHELD      @HELD
     C                     Z-ADD@IDEC     @CYDP
     C                     MOVE @IACNO    @ACNOM 100                      CCB002
     C/COPY WNCPYSRC,RE4124C011
     C                     EXSR RTBALC
      *
     C/COPY WNCPYSRC,RE4124C004
      *                                                                                       CRE081
      **  Set-up Available Balance                                                            CRE081
      *                                                                                       CRE081
     C                     ELSE                                                               CRE081
     C                     Z-ADDPAVBAL    @AVBL                                               CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
      ** Convert ledger balance
     C                     MOVE LDBLN     ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'A'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @LEDBL
     C                     MOVE ZOUT22    @LEDBL
      *
     C/COPY WNCPYSRC,RE4124C005
      ** Convert available balance
     C                     MOVE @AVBL     ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'A'       ZECODE
     C                     EXSR ZFRPED
     C                     MOVE *BLANKS   @AVLBL
     C                     MOVE ZOUT22    @AVLBL
      *
     C                     SETON                     23
     C/COPY WNCPYSRC,RE4124C022
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            VALSPV - Validate supervisor indicator             *
      *                                                               *
      * CALLS      SNDMSG - Send program message parameters           *
      *            VALOVR - Validate override conditions              *
      *                                                               *
      * CALLED BY  DSPBAL - Display account balances                  *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           VALSPV    BEGSR                           ** VALSPV **
      *
      ** Setof error indicators
     C                     SETOF                     111252
      *
      ** If override teller-id is entered
     C           SOTLI     IFNE *BLANKS
      *
      ** Check if record exists in file PF/SDTELDPD
     C                     CALL 'AOTELDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM           SOTLI
     C           SDTELD    PARM SDTELD    DSFDY
      *
      ** If record not found
      ** message - Teller identifier not found
     C           @RTCD     IFNE *BLANK
     C                     SETON                     1152
     C                     MOVEL'USR0030' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
      ** If sign on teller is not spv. & no override entered
      ** OR override teller entered and is not a spv.
     C           SOTLI     IFEQ *BLANKS
     C           PSPVI     ANDNE'Y'
     C           SOTLI     ORNE *BLANKS
     C           FRSPVI    ANDNE'Y'
     C                     SETON                     1152
     C                     MOVE 'USR0036' @MSGID
     C                     EXSR SNDMSG
      *
     C                     END
      *
      ** If override teller is entered - check if passcode is blanks
      ** message - Teller passcode is required
     C           SOTLI     IFNE *BLANKS
     C           SOTPC     IFEQ *BLANKS
     C                     SETON                     1252
     C                     MOVEL'USR0033' @MSGID
     C                     EXSR SNDMSG
      *
     C                     ELSE
      *
      ** Check if passcode matches with that in file
      ** message - Teller passcode
      *
      ** Encript the passcode
     C                     MOVEASOTPC     BPWD
     C                     Z-ADD6         X
     C                     EXSR RTENCP
     C                     MOVEAEPWD      SOTPC
      *
     C           SOTPC     IFNE FRTLPC
     C                     SETON                     1252
     C                     MOVEL'USR0039' @MSGID
     C                     EXSR SNDMSG
     C                     END
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPDRTN - Control rtn. for updates                  *
      *                                                               *
      * CALLS      WRTLPD - Write Teller transactions details         *
      *            UPTRL  - Update Control Trailer Record             *
      *            ZTNLU1 - Get Next Available Tran.Number            *
      *            PCMTXT - Prepare comit text                        *
      *            RTTOTS - Teller total updates                      *
      *            SNDMSG - Send program message parameters           *
      *            DBERR  - Database Error Handling : Terminate pgm.  *
      *                                                               *
      * CALLED BY  MAINP  - Main input process                        *
      *                                                               *
      *****************************************************************
     C           UPDRTN    BEGSR                           ** UPDRTN **
      *
      ** Update next available transaction number
     C                     EXSR ZTNLU1
      *
      ** Prepare commmitment control text
     C                     EXSR PCMTXT
      *
      ** Access ttrntm2 - for next ava.tran.no reqd for ttranpd
      *
      ** Move fields to key list depending on batch or teller
     C           SBATNO    IFEQ *BLANKS
     C                     MOVEL'T'       KTBRI
     C                     MOVELPTLID     KTBID
     C                     ELSE
     C                     MOVEL'B'       KTBRI
     C                     MOVELSBATNO    KTBID
     C                     END
     C                     MOVEL'1'       KRCTP
      *
      ** Access teller controls - TTRNTM2 -
     C           KLTRNT    CHAINTTRNTM2F             70
      *
      ** If record not found - database error
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD5         DBASE            ** DB ERR 05**
     C                     MOVE 'TTRNTM2' DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** If batch no. not entered
     C           SBATNO    IFEQ *BLANKS
      *
      ** Perform update teller trans.reversal
     C                     EXSR UTTRRV
      *
     C                     ELSE
      *
      ** Perform update batch trans.reversal
     C                     EXSR UBTRRV
      *
     C                     END
     C/COPY WNCPYSRC,RE4124C002
      *
      ** Reset function code after trailer PF/TTRANPT has been chained
     C                     MOVEL@FNCD     FNCD
      *
      ** Update ttrntm2 -
     C/COPY WNCPYSRC,RE4124C001
      *
      ** Access teller controls - TTRNTM2 -
     C           KLTRNT    CHAINTTRNTM2F             70
      *
      ** If teller trans.
     C           SBATNO    IFEQ *BLANKS
      *
      ** Increment next available transaction number
     C                     ADD  1         TTNATN
      *
     C                     ELSE
      *
      ** Increment next available transaction number
     C                     ADD  1         TTNATN
      *
      ** Increment batch last item used
     C                     ADD  1         BITU
      *
     C                     END
      *
      ** Update the record
     C                     UPDATTTRNTM2F
      *
      ** Access teller controls - TTRNTM3 -
     C                     MOVEL'2'       KRCTP
     C           KLTRNT    CHAINTTRNTM3F             70
      *
      ** If record not found - database error
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD6         DBASE            ** DB ERROR 6 *
     C                     MOVE 'TTRNTM3' DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
      *
     C                     ELSE
      *
      ** Access function code record from PF/SDFNCDPD
     C                     CALL 'AOFNCDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM FNCD      @FNCD
     C           SDFNCD    PARM SDFNCD    DSFDY
      *
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDFNCDPD'DBFILE           ***************
     C                     Z-ADD16        DBASE            ** DB ERR 16 **
     C                     MOVELFNCD      DBKEY            **************
     C                     EXSR DBERR
     C                     END
      *
      ** Initialise work transaction types
     C                     MOVE *BLANKS   @TTP1   5
     C                     MOVE *BLANKS   @TTP2   5
      *
      ** If function code is any of the following
     C           @FNCD     IFEQ '00N'
     C           @FNCD     OREQ '00K'
     C           @FNCD     OREQ '00Q'
     C           @FNCD     OREQ '00R'                                     CRT002
     C           @FNCD     OREQ '00H'
     C           @FNCD     OREQ '00P'
     C           @FNCD     OREQ '0JN'
     C           @FNCD     OREQ '0JK'
     C           @FNCD     OREQ '0JQ'
     C           @FNCD     OREQ '0JR'                                     CRT002
     C           @FNCD     OREQ '0JH'
     C           @FNCD     OREQ '0JP'
      *
      ** use credit transaction 1 from PF/SDFNCDPD
     C                     MOVELFQCRC1    @TTP1
      *
     C                     ELSE
      *
      ** If function code is any of the following
     C           @FNCD     IFEQ '00O'
     C           @FNCD     OREQ '00L'
     C           @FNCD     OREQ '00W'                                     CRT002
     C           @FNCD     OREQ '0JO'
     C           @FNCD     OREQ '0JL'
     C           @FNCD     OREQ '0JW'                                     CRT002
     C           @FNCD     OREQ '00A'
      *
      ** use debit transaction 1 from PF/SDFNCDPD
     C                     MOVELFQDRC1    @TTP1
      *
     C                     ELSE
      *
      ** If function code is any of the following
     C           @FNCD     IFEQ '00I'
     C           @FNCD     OREQ '0JI'
     C           @FNCD     OREQ '0JS'                                     CRT002
     C           @FNCD     OREQ '0JX'                                     CRT002
     C           @FNCD     OREQ '***'
      *
      ** use transaction type 1 from ttranl1
     C                     MOVELTRTTP1    @TTP1
      *
     C                     END
      *
     C                     END
      *
     C                     END
      *
      ** If function code is any of the following
     C           @FNCD     IFEQ '00H'
     C           @FNCD     OREQ '00P'
     C           @FNCD     OREQ '0JH'
     C           @FNCD     OREQ '0JP'
      *
      ** use credit transaction 2 from PF/SDFNCDPD
     C                     MOVELFQCRC2    @TTP2
      *
     C                     ELSE
      *
      ** If function code is any of the following
     C           @FNCD     IFEQ '00A'
      *
      ** use credit transaction 1 from PF/SDFNCDPD
     C                     MOVELFQCRC1    @TTP2
      *
     C                     ELSE
      *
      ** If function code is any of the following
     C           @FNCD     IFEQ '00I'
     C           @FNCD     OREQ '0JI'
     C           @FNCD     OREQ '0JS'                                     CRT002
     C           @FNCD     OREQ '0JX'                                     CRT002
      *
      ** use transaction type 2 from ttranl1
     C           TRTTP2    IFNE *ZERO
     C                     MOVELTRTTP2    @TTP2
     C                     END
      *
     C                     END
      *
     C                     END
      *
     C                     END
      *
      ** If transaction type 1 is not blank - access PF/SDRETRPD
     C           @TTP1     IFNE *BLANK
      *
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM @TTP1     @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record does not exist
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD7         DBASE            ** DB ERR 07 *
     C                     MOVE 'SDRETRPD'DBFILE           ***************
     C                     MOVEL@TTP1     DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Obtain currency totals for trans-type 1
     C                     MOVELA1DCIN    @DCIN
     C                     MOVELA1CIND    @CSIN
     C                     MOVELA1CLIN    @CLIN1  1
     C                     MOVEL@CLIN1    @CLIN
     C                     MOVELA1PASB    @PBTP1  2
      *
      ** Setup ccy and amount to be updated
     C                     MOVEL@CCY1     @CCY
     C                     Z-ADD@AMT1     @TAMT
      *
     C                     EXSR RTTOTS
      *
     C                     END
      *
      ** If transaction type 2 is not blank - access PF/SDRETRPD
     C           @TTP2     IFNE *BLANK
      *
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM @TTP2     @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record does not exist
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD8         DBASE            ** DB ERR 08 *
     C                     MOVE 'SDRETRPD'DBFILE           ***************
     C                     MOVEL@TTP2     DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Obtain currency totals for trans-type 2
     C                     MOVELA1DCIN    @DCIN
     C                     MOVELA1CIND    @CSIN
     C                     MOVELA1CLIN    @CLIN2  1
     C                     MOVEL@CLIN2    @CLIN
     C                     MOVELA1PASB    @PBTP2  2
      *
      ** Setup ccy and amount to be updated
     C           @FNCD     IFEQ '00A'
     C                     MOVEL@CCY1     @CCY
     C                     Z-ADD@AMT1     @TAMT
     C                     ELSE
     C           @FNCD     IFEQ '0JI'
     C           @FNCD     OREQ '0JS'                                     CRT002
     C           @FNCD     OREQ '0JX'                                     CRT002
     C                     MOVEL@CCY2     @CCY
     C                     Z-ADD@AMT2     @TAMT
     C                     ELSE
     C           @FNCD     IFEQ '00I'
     C           @CCY2     ANDEQ'   '
     C                     MOVEL@CCY1     @CCY
     C                     Z-ADD1         @COUNT
     C                     ELSE
     C                     END
     C                     Z-ADD@AMT2     @TAMT
     C           @FNCD     IFEQ '0JI'
     C           @FNCD     OREQ '0JS'                                     CRT002
     C           @FNCD     OREQ '0JX'                                     CRT002
     C                     MOVEL@CCY2     @CCY
     C                     END
     C                     END
     C                     END
      *
     C                     Z-ADD1         @COUNT
      *
     C                     EXSR RTTOTS
      *
     C                     END
      *
      ** Move teller transaction number to file & screen field
     C                     Z-ADD@TTRNO    TBTN
     C                     Z-ADDTBTN      TNLU
     C                     Z-ADDTBTN      TTLU                                                CRT006
      *
      ** Update the record
     C                     UPDATTTRNTM3F
      *
     C                     END
      *
      ** If retail a/c no. from lf/ttranl1 is non-zero
     C           TRACNO    IFNE *ZEROS
      *
      ** Update pf/memos
     C                     EXSR UPDMEM
      *
     C                     END
      *                                                                                       CRE019
      ** If CRE019 is on and house cheque account is entered, update memos                    CRE019
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C           TRHCAC    ANDNE*BLANKS                                                       CRE019
     C                     EXSR UPMEM2                                                        CRE019
     C                     ENDIF                                                              CRE019
      *
      ** If account closure successful
     C           TRCLOS    IFEQ 'Y'
      *
      ** Reverse previous update on lf/accnt
      *
      ** Move fields to key from lf/acnum
     C**********           Z-ADDCNUM      @CNUM                                               CSD027
     C                     MOVE CNUM      @CNUM                                               CSD027
     C                     MOVELCCY       @CCY
     C                     Z-ADDACOD      @ACOD
     C                     Z-ADDACSQ      @ACSQ
     C                     MOVELBRCA      @BRCA
     C                     EXSR RTACLS
      *
     C                     END
      *
      ** If update cheque presented indicator is 'Y'
     C           UCQB      IFEQ 'Y'
     C           CQNF      ORNE *BLANKS                                                      BUG2488
     C           CRE019    OREQ 'Y'                                                          BUG2488
     C           UCQB      ANDEQ'Y'                                                          BUG3915
      *
      ** Reverse update on pf/chqbkpd
     C                     EXSR UPDCHK
      *
     C                     END
      *
      ** If function code of rev.trans.is one of the foll.(cheq.dep.)
     C           FNCD      IFEQ '00K'
     C           FNCD      OREQ '00R'                                     CRT002
     C           FNCD      OREQ '0JK'
     C           FNCD      OREQ '0JR'                                     CRT002
     C           FNCD      OREQ '00H'
     C           FNCD      OREQ '0JH'
     C           FNCD      OREQ '00P'
     C           FNCD      OREQ '0JP'
     C           FNCD      OREQ '00Q'
     C           FNCD      OREQ '0JQ'
      *
      ** Reverse update on pf/chqdppd
     C                     EXSR UPDCHD
      *
     C                     END
      *
      ** End of commitment cycle
      *                                                                   CRT002
     C***********PMODE     IFEQ 'I'                                 CRT002120472
     C           CMTTXT    COMIT
     C***********          ENDIF                                    CRT002120472
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      ** SR.RTTOTS Subroutine
      /COPY ZSRSRC,RTTOTSC1
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UTTRRV - Update for teller transaction reversal    *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           UTTRRV    BEGSR                           ** UTTRRV **
      *
      ** Setup key to access lf/ttranl1
      ** For trans.use teller branch
     C                     MOVEL'T'       K2BRI
     C                     MOVELPTLID     K2BID
     C                     Z-ADD@TTNO     K2TRN
     C                     MOVE PTLBC     K2ITB
      *
      ** Access lf/ttranl1 for tran.no.record
     C           KLTRAN    CHAINTTRANPDF             70
      *
      ** If record does not exists -
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        *************
     C                     Z-ADD9         DBASE            ** DB ERR 09*
     C                     MOVEL'TTRANL1' DBFILE           *************
     C                     MOVEL@TTRAN    DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C*                    Z-ADDNATN      CRTN
      *
      ** If teller transaction reversal
     C           SBATNO    IFEQ *BLANKS
     C                     Z-ADDTTNATN    CRTN
      *
     C                     ELSE
      *
     C           BITU      ADD  1         CRTN
      *
     C                     END
      *
     C                     MOVELPTLBC     TRITLB
      *
      ** Update lf/ttranl1
     C                     UPDATTTRANPDF
      *
     C/COPY WNCPYSRC,RE4124C013
      ** Write record on pf/ttranpd
     C                     EXSR WRTRPD
      *
     C/COPY WNCPYSRC,RE4124C014
      ** Update trailer record pf/ttranpt
     C                     EXSR UPTRL
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UBTRRV - Update for batch  transaction reversal    *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           UBTRRV    BEGSR                           ** UBTRRV **
      *
      ** reaccess batch control record from ttrntm2 -
      *
      ** Move fields to key list
     C                     MOVEL'B'       KTBRI
     C                     MOVELSBATNO    KTBID
     C                     MOVEL'1'       KRCTP
      *
      ** Access teller controls - TTRNTM2 -
     C           KLTRNT    CHAINTTRNTM2F             70
      *
      ** If record not found - database error
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD10        DBASE            ** DB ERR 10 **
     C                     MOVE 'TTRNTM2' DBFILE           ***************
     C                     MOVEL@TTRNT    DBKEY
     C                     EXSR DBERR
     C                     END
      *
      ** Setup key to access lf/ttranl1 - ttranpdf
      ** For batch - branch from ttrntm2
     C                     MOVEL'B'       K2BRI
     C                     MOVELSBATNO    K2BID
     C                     Z-ADD@TTNO     K2TRN
     C                     MOVE TLBC      K2ITB
      *
      ** Access lf/ttranl1 for tran.no.record
     C           KLTRAN    CHAINTTRANPDF             70
      *
      ** If record does not exists -
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        *************
     C                     Z-ADD11        DBASE            ** DB ERR 11*
     C                     MOVEL'TTRANL1' DBFILE           *************
     C                     MOVEL@TTRAN    DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C           BITU      ADD  1         CRTN
      *
     C                     MOVELPTLBC     TRITLB
      *
      ** Update lf/ttranl1
     C                     UPDATTTRANPDF
     C/COPY WNCPYSRC,REH00255
      *
      ** Write record on pf/ttranpd
     C                     EXSR WRTRPD
      *
      ** Update trailer record from lf/ttranl1
      *
      ** Setup key to access lf/ttranl1 - ttranptf
     C                     MOVEL'B'       K3BRI
     C                     MOVELSBATNO    K3BID
     C                     Z-ADD99999     K3TRN
      *
      ** Access lf/ttranl1 for batch trailer record
     C           KLTRA2    CHAINTTRANPTF             70
      *
      ** If record does not exists -
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        *************
     C                     Z-ADD12        DBASE            ** DB ERR 12*
     C                     MOVEL'TTRANL1' DBFILE           *************
     C                     MOVEL@TTRA2    DBKEY
     C                     EXSR DBERR
     C                     END
      *
     C                     ADD  1         NORE
      *
      ** Update lf/ttranl1
     C                     UPDATTTRANPTF
     C/COPY WNCPYSRC,REH00193
      *
     C                     ENDSR
     C/COPY WNCPYSRC,REH00194
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPDMEM - Update memos file                         *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           UPDMEM    BEGSR                           ** UPDMEM **
      *
     C***********KCHARG    KLIST                                          120471
     C***********          KFLD           TBID                            120471
     C***********          KFLD           @TTNO                           120471
      ***********                                                         120471
      *
      *  Rewriting of charges processing.
      *  Chain to the file.  If a charge amount is present,  add if
      *  function is withdrawal, otherwise subtract.
      *
     C           PMODE     IFEQ 'I'                                       120471
     C                     Z-ADD0         AMT3
     C           KCHARG    CHAINTTCHGL0              70
     C                     ENDIF                                          120471
      *                                                                   120471
     C           AMT3      IFNE *ZERO
     C           PMODE     ANDEQ'I'                                       120471
     C           AMT3      ORNE *ZERO                                     120471
     C           CCY3      ANDEQRACCY1                                    120471
     C           *IN17     ANDEQ'0'                                       120471
     C           PMODE     ANDEQ'P'                                       120471
     C           AMT3      ORNE *ZERO                                     120471
     C           CCY3      ANDEQRACCY1                                    120471
     C           FNCD      ANDEQ'0JW'                                     120471
     C           PMODE     ANDEQ'P'                                       120471
     C           AMT3      ORNE *ZERO                                     120471
     C           CCY3      ANDEQRACCY1                                    120471
     C           FNCD      ANDEQ'0JL'                                     120471
     C           PMODE     ANDEQ'P'                                       120471
     C/COPY WNCPYSRC,REH00329
      *                                                                   120471
     C           FNCD      IFEQ '00L'
     C           FNCD      OREQ '00W'                                     CRT002
     C           FNCD      OREQ '0JL'
     C           FNCD      OREQ '0JW'                                     CRT002
     C           FNCD      OREQ '0JO'
     C           FNCD      OREQ '00O'
     C                     ADD  AMT3      @TAAMT
     C                     ELSE
     C                     SUB  AMT3      @TAAMT
     C                     END
     C                     END
      *
      ** Update memos record for retail a/c no.from ttranl1 (debit a/c)
     C                     MOVE TRACNO    @ACNO
     C*********************Z-ADD@ORNM     @RNM    50                      CCB002
      *
      ** Set indicator to rev.type credit for fn.cd '00a'
     C           FNCD      IFEQ '00A'
     C                     Z-ADD0         @RTRVT  10
     C                     END
      *
     C                     EXSR UMEMOS
      *
      ** If rev.tran. is retail transfer (fn.cd = '00A')
     C           FNCD      IFEQ '00A'
      *
      ** Update memos record for credit a/c no. from ttranl1
     C***********          Z-ADD@@CNUM    CNUM                            CRT002
     C**********           Z-ADD@@CUSN    CNUM                                         CRT002 CSD027
     C                     MOVE @@CUSN    CNUM                                                CSD027
     C                     MOVEL@@CCY     CCY
     C                     Z-ADD@@ACOD    ACOD
     C                     Z-ADD@@ACSQ    ACSQ
     C                     MOVEL@@BRCA    BRCA
     C                     MOVE TRTTAC    @ACNO
     C*********************Z-ADD@RRNM2    @RNM                            CCB002
      *
      ** Set indicator to rev.type debit for fn.cd '00a'
     C                     Z-ADD1         @RTRVT
     C                     EXSR UMEMOS
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************                       CRE019
      /EJECT                                                                                  CRE019
      *****************************************************************                       CRE019
      *  UPMEM2 - Reverse postings in MEMOS and RSACMTPD for CRE019   *                       CRE019
      *****************************************************************                       CRE019
     C           UPMEM2    BEGSR                                                              CRE019
      *                                                                                       CRE019
     C                     MOVELTRHCAC    KACNO  100                                          CRE019
     C           KACNO     CHAINACNUMABF             70                                       CRE019
      *                                                                                       CRE019
      ** If no record is found                                                                CRE019
      *                                                                                       CRE019
     C           *IN70     IFEQ *ON                                                           CRE019
     C           *LOCK     IN   LDA                                                           CRE019
     C                     Z-ADD33        DBASE                                               CRE019
     C                     MOVE 'ACNUM   'DBFILE                                              CRE019
     C                     MOVELKACNO     DBKEY                                               CRE019
     C                     EXSR DBERR                                                         CRE019
      *                                                                                       CRE019
      ** else reverse postings to house cheque account                                        CRE019
      *                                                                                       CRE019
     C                     ELSE                                                               CRE019
     C           FNCD      IFEQ '00Q'                                                         CRE019
     C           FNCD      OREQ '0JQ'                                                         CRE019
     C                     Z-ADDAMT1      WHCAM  150                                          CRE019
     C                     MOVELTRCCY1    WTCCY   3                                           CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C           FNCD      IFEQ '00P'                                                         CRE019
     C           FNCD      OREQ '0JP'                                                         CRE019
     C                     Z-ADDTRAMT2    WHCAM                                               CRE019
     C                     MOVELTRCCY2    WTCCY                                               CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
      ** Convert cheque amount using spot rate                                                CRE019
      *                                                                                       CRE019
     C           WTCCY     IFNE CCY                                                           CRE019
      *                                                                                       CRE019
      ** Retrieve transaction/account currency details                                        CRE019
      *                                                                                       CRE019
     C                     CALL 'AOCURRR0'                                                    CRE019
     C                     PARM '*BLANK'  @RTCD                                               CRE019
     C                     PARM '*KEY   ' @OPTN                                               CRE019
     C                     PARM CCY       @CURR                                               CRE019
     C           SDCURR    PARM SDCURR    DSSDY                                               CRE019
      *                                                                                       CRE019
     C                     Z-ADDWISPRT    ZRATE1 138                                          CRE019
     C                     MOVEL@IMD      ZMDI1   1                                           CRE019
     C                     Z-ADD@IDEC     ZCDPI                                               CRE019
     C                     Z-ADDA6SPRT    ZRATE2 138                                          CRE019
     C                     MOVELA6MDIN    ZMDI2   1                                           CRE019
     C                     Z-ADDA6NBDP    ZCDPO   10                                          CRE019
      *                                                                                       CRE019
      ** Determine cross exchange rate between the currencies                                 CRE019
      *                                                                                       CRE019
     C                     EXSR ZXRATE                                                        CRE019
      *                                                                                       CRE019
      ** Convert amount to house cheque account currency equivalent                           CRE019
      *                                                                                       CRE019
     C                     MOVELZMDIX     ZMD                                                 CRE019
     C                     Z-ADDZRATEX    ZEXCH                                               CRE019
     C                     MOVE WHCAM     ZAMTCI                                              CRE019
     C                     MOVELWTCCY     ZCCYI                                               CRE019
     C                     MOVELCCY       ZCCYO                                               CRE019
     C                     EXSR ZCONV                                                         CRE019
     C                     Z-ADDZAMTCO    WHCAM                                               CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
      ** set posting amount to cash and value date to rundate                                 CRE019
     C                     Z-ADDKACNO     W0RETL                                              CRE019
     C                     Z-ADDBJRDNB    @VDAO                                               CRE019
     C           *ZERO     SUB  WHCAM     @PAAO                                               CRE019
      *                                                                                       CRE019
     C                     CALL 'AOMEMSU0'                                                    CRE019
     C                     PARM *BLANKS   W0RTCD  7                                           CRE019
     C                     PARM           W0RETL 100                                          CRE019
     C**********           PARM *ZERO     W0CNUM  60                                   CRE019 CSD027
     C                     PARM *BLANKS   W0CNUM  6                                           CSD027
     C                     PARM *BLANK    W0CUCD  3                                           CRE019
     C                     PARM *ZERO     W0ACCD 100                                          CRE019
     C                     PARM *ZERO     W0ACSQ  20                                          CRE019
     C                     PARM *BLANK    W0BRCA  3                                           CRE019
     C                     PARM BJRDNB    W0PSTD  50                                          CRE019
     C                     PARM @VDAO     W0VDAT  50                                          CRE019
     C                     PARM @PAAO     W0AMT  150                                          CRE019
     C                     PARM 'N'       W0FTOV  1                                           CRE019
      *                                                                                       CRE019
      ** Database error processing                                                            CRE019
      *                                                                                       CRE019
     C           W0RTCD    IFNE *BLANKS                                                       CRE019
     C           *LOCK     IN   LDA                                                           CRE019
     C                     Z-ADD34        DBASE                                               CRE019
     C                     MOVE 'AOMEMSU0'DBFILE                                              CRE019
     C                     MOVELW0RETL    DBKEY                                               CRE019
     C                     EXSR DBERR                                                         CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
      ** Insert a credit posting to PF/RSACMTPF to reverse the                                CRE019
      ** previous debit posting made for the house cheque account.                            CRE019
      *                                                                                       CRE019
     C                     Z-ADD1         DORC                                                CRE019
     C**********           Z-ADDCNUM      CUSN                                         CRE019 CSD027
     C                     MOVE CNUM      CUSN                                                CSD027
     C                     MOVELCCY       CCYD                                                CRE019
     C                     Z-ADDACOD      ACDE                                                CRE019
     C                     Z-ADDACSQ      ASNC                                                CRE019
     C                     MOVELBRCA      BRCA                                                CRE019
     C                     Z-ADDWHCAM     MVAM                                                CRE019
      *                                                                                       CRE019
     C                     WRITERSACMTPO                                                      CRE019
      *                                                                                       CRE019
      ** Save full house cheque account detail for check of duplicate                         CRE019
      ** cheque numbers in SR/UPDCHK                                                          CRE019
      *                                                                                       CRE019
     C**********           Z-ADDCNUM      WHCNUM                                       CRE019 CSD027
     C                     MOVE CNUM      WHCNUM                                              CSD027
     C                     MOVELCCY       WHCCY                                               CRE019
     C                     Z-ADDACOD      WHACOD                                              CRE019
     C                     Z-ADDACSQ      WHACSQ                                              CRE019
     C                     MOVELBRCA      WHBRCA                                              CRE019
     C                     ENDIF                                                              CRE019
     C                     ENDSR                                                              CRE019
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UMEMOS - Update memos file record                  *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDMEM - Update memos file                         *
      *                                                               *
      *****************************************************************
     C           UMEMOS    BEGSR                           ** UMEMOS **
      *
      ***Access account shadow balance off pf/memos for resp. a/c no.     CCB002
     C***********@RNM******CHAINMEMOS                70                   CCB002
      *                                                                   CCB002
      **If the transaction is credit...                                   CCB002
     C           @RVTTY    IFEQ 1                                         CCB002
     C           @RTRVT    OREQ 1                                         CCB002
      *                                                                   CCB002
      **If the transaction value date > rundate...                        CCB002
     C           TRVLDT    IFGT @RUND                                     CCB002
      *                                                                   CCB002
      ** For future valued transactions with duo amounts, include cash    CCB002
      ** amount only.  Value date check based on cheque amount.           CCB002
     C           FNCD      IFEQ '00H'                                     CCB002
     C           FNCD      OREQ '00P'                                     CCB002
     C           FNCD      OREQ '0JH'                                     CCB002
     C           FNCD      OREQ '0JP'                                     CCB002
      *                                                                   CCB002
      ** set posting amount to cash and value date to rundate             CCB002
     C                     Z-ADD@AMT1     @PAAO  150                      CCB002
     C                     Z-ADDBJRDNB    @VDAO   50                      CCB002
      *                                                                   CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM @ACNO     W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM *ZERO     W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM *BLANKS   W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM *BLANK    W0CUCD  3        O:Currency     CCB002
     C**********           PARM *ZERO     W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM *ZERO     W0ACCD 100                                          CGL029
     C                     PARM *ZERO     W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM *BLANK    W0BRCA  3        O:Branch       CCB002
     C                     PARM BJRDNB    W0PSTD  50       O:Posting date CCB002
     C                     PARM @VDAO     W0VDAT  50       O:Value date   CCB002
     C                     PARM @PAAO     W0AMT  150       O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV  1        O:FT override  CCB002
      *                                                                   CCB002
      ** If not accessed properly...                                      CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C           *LOCK     IN   LDA                        ***************CCB002
     C                     Z-ADD17        DBASE            ** DB ERR 17 **CCB002
     C                     MOVE 'AOMEMSU0'DBFILE           ***************CCB002
     C                     MOVELW0RETL    DBKEY                           CCB002
     C                     EXSR DBERR                                     CCB002
     C                     ENDIF                                          CCB002
     C/COPY WNCPYSRC,RE4124C016
      *                                                                   CCB002
      ** Set posting amount to cheque amount and update MEMOS             CCB002
      ** if the cheque/posting amount is non-zero                         CCB002
     C           @TAAMT    SUB  @AMT1     @PAAO                           CCB002
     C           @PAAO     IFNE 0                                         CCB002
      *                                                                   CCB002
      ** Set value date to transaction value date                         CCB002
     C                     Z-ADDTRVLDT    @VDAO                           CCB002
      *                                                                   CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD           I:Return code  CCB002
     C                     PARM @ACNO     W0RETL           O:Retail A/C NoCCB002
     C**********           PARM *ZERO     W0CNUM           O:Customer No.              CCB002 CSD027
     C                     PARM *BLANKS   W0CNUM           O:Customer No.                     CSD027
     C                     PARM *BLANK    W0CUCD           O:Currency     CCB002
     C                     PARM *ZERO     W0ACCD           O:Account Code CCB002
     C                     PARM *ZERO     W0ACSQ           O:Account Seq. CCB002
     C                     PARM *BLANK    W0BRCA           O:Branch       CCB002
     C                     PARM BJRDNB    W0PSTD           O:Posting date CCB002
     C                     PARM @VDAO     W0VDAT           O:Value date   CCB002
     C                     PARM @PAAO     W0AMT            O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV           O:FT override  CCB002
      *                                                                   CCB002
      ** If not accessed properly...                                      CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C           *LOCK     IN   LDA                        ***************CCB002
     C                     Z-ADD18        DBASE            ** DB ERR 18 **CCB002
     C                     MOVE 'AOMEMSU0'DBFILE           ***************CCB002
     C                     MOVELW0RETL    DBKEY                           CCB002
     C                     EXSR DBERR                                     CCB002
     C                     ENDIF                                          CCB002
     C/COPY WNCPYSRC,RE4124C017
     C                     ENDIF                                          CCB002
      *                                                                   CCB002
      ** Non-clearing cheques...                                          CCB002
     C                     ELSE                                           CCB002
     C                     Z-ADD@TAAMT    @PAAO                           CCB002
     C                     Z-ADDTRVLDT    @VDAO                           CCB002
      *                                                                   CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD           I:Return code  CCB002
     C                     PARM @ACNO     W0RETL           O:Retail A/C NoCCB002
     C**********           PARM *ZERO     W0CNUM           O:Customer No.              CCB002 CSD027
     C                     PARM *BLANKS   W0CNUM           O:Customer No.                     CSD027
     C                     PARM *BLANK    W0CUCD           O:Currency     CCB002
     C                     PARM *ZERO     W0ACCD           O:Account Code CCB002
     C                     PARM *ZERO     W0ACSQ           O:Account Seq. CCB002
     C                     PARM *BLANK    W0BRCA           O:Branch       CCB002
     C                     PARM BJRDNB    W0PSTD           O:Posting date CCB002
     C                     PARM @VDAO     W0VDAT           O:Value date   CCB002
     C                     PARM @PAAO     W0AMT            O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV           O:FT override  CCB002
      *                                                                   CCB002
      ** If not accessed properly...                                      CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C           *LOCK     IN   LDA                        ***************CCB002
     C                     Z-ADD19        DBASE            ** DB ERR 19 **CCB002
     C                     MOVE 'AOMEMSU0'DBFILE           ***************CCB002
     C                     MOVELW0RETL    DBKEY                           CCB002
     C                     EXSR DBERR                                     CCB002
     C                     ENDIF                                          CCB002
     C/COPY WNCPYSRC,RE4124C018
     C                     ENDIF                                          CCB002
      *                                                                   CCB002
      ** When value date <= rundate...                                    CCB002
     C                     ELSE                                           CCB002
     C           BJRDNB    ADD  1         @VDAO                           CCB002
      *                                                                   CCB002
      ** If transaction is for non-clearing cheques...                    CCB002
     C********** PFNCD     IFNE '00H'                                                  CCB002 194978
     C********** PFNCD     ANDNE'00K'                                                  CCB002 194978
     C********** PFNCD     ANDNE'0JH'                                                  CCB002 194978
     C********** PFNCD     ANDNE'0JK'                                                  CCB002 194978
     C           @FNCD     IFNE '00H'                                                         194978
     C           @FNCD     ANDNE'00K'                                                         194978
     C           @FNCD     ANDNE'0JH'                                                         194978
     C           @FNCD     ANDNE'0JK'                                                         194978
      *                                                                   CCB002
     C                     Z-ADDTRVLDT    @VDAO                           CCB002
      *                                                                   CCB002
      ** Clearing cheques and not local currency...                       CCB002
     C                     ELSE                                           CCB002
     C           SCCY      IFNE BJLCCY                                    CCB002
     C                     Z-ADDTRVLDT    @VDAO                           CCB002
     C                     ENDIF                                          CCB002
     C                     ENDIF                                          CCB002
      *                                                                   CCB002
     C                     Z-ADD@TAAMT    @PAAO                           CCB002
      *                                                                   CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD           I:Return code  CCB002
     C                     PARM @ACNO     W0RETL           O:Retail A/C NoCCB002
     C**********           PARM *ZERO     W0CNUM           O:Customer No.              CCB002 CSD027
     C                     PARM *BLANKS   W0CNUM           O:Customer No.                     CSD027
     C                     PARM *BLANK    W0CUCD           O:Currency     CCB002
     C                     PARM *ZERO     W0ACCD           O:Account Code CCB002
     C                     PARM *ZERO     W0ACSQ           O:Account Seq. CCB002
     C                     PARM *BLANK    W0BRCA           O:Branch       CCB002
     C                     PARM BJRDNB    W0PSTD           O:Posting date CCB002
     C                     PARM @VDAO     W0VDAT           O:Value date   CCB002
     C                     PARM @PAAO     W0AMT            O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV           O:FT override  CCB002
      *                                                                   CCB002
      ** If not accessed properly...                                      CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C           *LOCK     IN   LDA                        ***************CCB002
     C                     Z-ADD20        DBASE            ** DB ERR 20 **CCB002
     C                     MOVE 'AOMEMSU0'DBFILE           ***************CCB002
     C                     MOVELW0RETL    DBKEY                           CCB002
     C                     EXSR DBERR                                     CCB002
     C                     ENDIF                                          CCB002
     C/COPY WNCPYSRC,RE4124C019
     C                     ENDIF                                          CCB002
      *                                                                   CCB002
      ** Debit transactions...                                            CCB002
     C                     ELSE                                           CCB002
     C           @TAAMT    MULT -1        @PAAO                           CCB002
     C                     Z-ADDTRVLDT    @VDAO                           CCB002
      *                                                                   CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD           I:Return code  CCB002
     C                     PARM @ACNO     W0RETL           O:Retail A/C NoCCB002
     C**********           PARM *ZERO     W0CNUM           O:Customer No.              CCB002 CSD027
     C                     PARM *BLANKS   W0CNUM           O:Customer No.                     CSD027
     C                     PARM *BLANK    W0CUCD           O:Currency     CCB002
     C                     PARM *ZERO     W0ACCD           O:Account Code CCB002
     C                     PARM *ZERO     W0ACSQ           O:Account Seq. CCB002
     C                     PARM *BLANK    W0BRCA           O:Branch       CCB002
     C                     PARM BJRDNB    W0PSTD           O:Posting date CCB002
     C                     PARM @VDAO     W0VDAT           O:Value date   CCB002
     C                     PARM @PAAO     W0AMT            O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV           O:FT override  CCB002
      *                                                                   CCB002
      ** If not accessed properly...                                      CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C           *LOCK     IN   LDA                        ***************CCB002
     C                     Z-ADD21        DBASE            ** DB ERR 21 **CCB002
     C                     MOVE 'AOMEMSU0'DBFILE           ***************CCB002
     C                     MOVELW0RETL    DBKEY                           CCB002
     C                     EXSR DBERR                                     CCB002
     C                     ENDIF                                          CCB002
     C/COPY WNCPYSRC,RE4124C020
     C                     ENDIF                                          CCB002
      **********************                                              CCB002
      ***If record not found - database error                             CCB002
     C************IN70*****IFEQ '1'                                       CCB002
     C************LOCK*****IN   LDA                        *************  CCB002
     C*********************Z-ADD13        DBASE            ** DB ERR 13*  CCB002
     C*********************MOVE 'MEMOS  ' DBFILE           *************  CCB002
     C*********************MOVELW0RETL    DBKEY                           CCB002
     C*********************EXSR DBERR                                     CCB002
     C*********************END                                            CCB002
      *********************                                               CCB002
      ***If rev.tran type is credit (or rev.tr.typ is credit for '00a')   CCB002
     C***********@RVTTY****IFEQ 1                                         CCB002
     C***********@RTRVT****OREQ 1                                         CCB002
      **********************                                              CCB002
      ***If Value date(from ttranl1) <= midas run date                    CCB002
     C***********TRVLDT****IFLE @RUND                                     CCB002
      **********************                                              CCB002
      ***For non clearing cheques, update cleared balance                 CCB002
     C***********PFNCD*****IFNE '00H'                                     CCB002
     C***********PFNCD*****ANDNE'00K'                                     CCB002
     C***********PFNCD*****ANDNE'0JH'                                     CCB002
     C***********PFNCD*****ANDNE'0JK'                                     CCB002
      *********************                                               CCB002
      *********************                                               CCB002
      ***Add total amt in a/c ccy to cleared balance                      CCB002
     C*********************ADD  @TAAMT    CLBLN                           CCB002
      *********************                                               CCB002
     C*********************ELSE                                           CCB002
      *********************                                               CCB002
      ***For clearing cheques, do not update if currency is in local ccy  CCB002
     C***********SCCY******IFNE BJLCCY                                    CCB002
     C*********************ADD  @TAAMT    CLBLN                           CCB002
     C*********************END                                            CCB002
      *********************                                               CCB002
     C*********************END                                            CCB002
      *********************                                               CCB002
      ***For future valued transactions with duo amounts, include cash    CCB002
      ***amount only.  Value date check based on cheque amount.           CCB002
     C*********************ELSE                                           CCB002
      *********************                                               CCB002
     C***********FNCD******IFEQ '00H'                                     CCB002
     C***********FNCD******OREQ '00P'                                     CCB002
     C***********FNCD******OREQ '0JH'                                     CCB002
     C***********FNCD******OREQ '0JP'                                     CCB002
     C*********************ADD  @AMT1     CLBLN                           CCB002
     C*********************END                                            CCB002
      *********************                                               CCB002
     C*********************END                                            CCB002
      *********************                                               CCB002
      ***Add total amt in a/c ccy to ledger  balance                      CCB002
     C*********************ADD  @TAAMT    LDBLN                           CCB002
      *********************                                               CCB002
      ***If rev.tran. type is debit                                       CCB002
     C*********************ELSE                                           CCB002
      *********************                                               CCB002
      ***If Value date(from ttranl1) <= midas run date                    CCB002
     C***********TRVLD*****IFLE @RUND                                     CCB002
      *********************                                               CCB002
      ***Sub total amt in a/c ccy from cleared balance                    CCB002
     C*********************SUB  @TAAMT    CLBLN                           CCB002
      *********************                                               CCB002
     C*********************END                                            CCB002
      *********************                                               CCB002
      ***Sub total amt in a/c ccy from ledger  balance                    CCB002
     C*********************SUB  @TAAMT    LDBLN                           CCB002
      *********************                                               CCB002
     C*********************END                                            CCB002
      *********************                                               CCB002
      ***Update memos record                                              CCB002
     C*********************UPDATMEMOSMDF                                  CCB002
      *********************                                               CCB002
      ** Write record on pf/rsacmtpd                                      CCB002
     C                     EXSR WRRSAC                                    CCB002
      *                                                                   CCB002
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPDCHK - Update pf/chqbkpd                         *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           UPDCHK    BEGSR                           ** UPDCHK **
      *
     C                     SETOF                     67
      *
      ** Define key list
      ** Cheque book details
     C           KLCQBK    KLIST
     C                     KFLD           KACNO  100
     C                     KFLD           KSCQN   80
      *
      ** Set up key - move a/c no. & chq.no. from lf/ttranl1
     C                     MOVE TRACNO    @ACNO
     C                     MOVE TRCQNF    @CQNF   80
      *
      ** Set up key to house cheque account if CRE019 is on                                   CRE019
      *                                                                                       CRE019
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C           TRHCAC    ANDNE*BLANKS                                                       CRE019
     C                     MOVELTRHCAC    @ACNO                                               CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C                     Z-ADD@ACNO     KACNO
     C                     Z-ADD@CQNF     KSCQN
      *
      ** Set limit greater than account no. & cheque no.
     C           KLCQBK    SETGTCHQBKPD
     C                     READPCHQBKPD                  70
      *
      ** If record found?  release record
     C           *IN70     IFEQ '0'
      *
      ** If retail account number equal to account number?
      ** Add (no. of cheques -1) to start cheque no. to give the
      ** end cheque number
     C           CQACNO    IFEQ @ACNO
     C           NOCQ      SUB  1         @ECQN   80
     C                     ADD  SCQN      @ECQN
      *
      ** If cheque number less than  start cheque number
      ** or cheque number greater than end cheque number
     C           @CQNF     IFLT SCQN
     C           @CQNF     ORGT @ECQN
     C                     SETON                     67
     C                     END
      *
     C                     ELSE
      *
     C                     SETON                     67
      *
     C                     END
     C*
      *
     C                     ELSE
      *
     C                     SETON                     67
      *
     C                     END
      *
      ** If record not found, or retail account numbers not equal
      ** or cheque out of range - db error
     C           *IN67     IFEQ '1'
     C           *LOCK     IN   LDA                        *************
     C                     Z-ADD14        DBASE            ** DB ERR 14*
     C                     MOVE 'CHQBKPD' DBFILE           *************
     C                     MOVEL@CQBKY    DBKEY
     C                     EXSR DBERR
     C                     END
      *                                                                                       CRE019
      ** If CRE019 is on, check if cheque have been presented in                              CRE019
      ** in other transactions.                                                               CRE019
      *                                                                                       CRE019
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C                     EXSR CQTDUP                                                        CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
      ** Remove cheque from presented list when CRE019 is off,                                CRE019
      ** or when on and cheque was presented only once and is                                 CRE019
      ** not out of range.                                                                    CRE019
     C           CRE019    IFEQ 'N'                                                           CRE019
     C           CRE019    OREQ 'Y'                                                           CRE019
     C           WCDUP     ANDEQ'N'                                                           CRE019
     C           OUTR      ANDNE'Y'                                                           CRE019
      *
      ** Move cheque presented array from file to array
     C                     MOVEACQPS      @CA
      *
      ** Calculate cheque presented status array index
     C           @CQNF     SUB  SCQN      @OFSET  80
     C           @OFSET    DIV  8         @I
     C                     MVR            @BITN   10
     C                     ADD  1         @I
      *
      ** Test corresponding bit-position of element for cheque presented
     C           @BITN     IFEQ 0
     C                     BITOF'0'       @CA,@I
     C                     END
     C           @BITN     IFEQ 1
     C                     BITOF'1'       @CA,@I
     C                     END
     C           @BITN     IFEQ 2
     C                     BITOF'2'       @CA,@I
     C                     END
     C           @BITN     IFEQ 3
     C                     BITOF'3'       @CA,@I
     C                     END
     C           @BITN     IFEQ 4
     C                     BITOF'4'       @CA,@I
     C                     END
     C           @BITN     IFEQ 5
     C                     BITOF'5'       @CA,@I
     C                     END
     C           @BITN     IFEQ 6
     C                     BITOF'6'       @CA,@I
     C                     END
     C           @BITN     IFEQ 7
     C                     BITOF'7'       @CA,@I
     C                     END
      *
      ** Move array to file
     C                     MOVEA@CA       CQPS
      *
      ** Update the record
     C                     UPDATCHQBKPDF
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
      ** If CRE019 is on and reversing house cheque that is out of                            CRE019
      ** range and cheque is not presented in other transactions,                             CRE019
      ** physically delete cheque book record and update trailer.                             CRE019
     C           CRE019    IFEQ 'Y'                                                           CRE019
     C           OUTR      ANDEQ'Y'                                                           CRE019
     C           WCDUP     ANDEQ'N'                                                           CRE019
     C                     DELETCHQBKPDF                                                      CRE019
     C                     EXSR UPTRL2                                                        CRE019
     C                     ENDIF                                                              CRE019
      *
     C                     ENDSR
      *****************************************************************                       CRE019
      /EJECT                                                                                  CRE019
      *****************************************************************                       CRE019
      *  CQTDUP - Check for duplicate cheque transactions             *                       CRE019
      *****************************************************************                       CRE019
     C           CQTDUP    BEGSR                                                              CRE019
      *                                                                                       CRE019
     C           TRCQNF    SETLLTTRANL6                                                       CRE019
     C           TRCQNF    READETTRANL6                  70                                   CRE019
      *                                                                                       CRE019
     C                     MOVE 'N'       WCDUP   1                                           CRE019
     C           *IN70     IFEQ *OFF                                                         BUG2488
     C                     MOVE 'Y'       WCDUP                                              BUG2488
     C                     ELSE                                                              BUG2488
      *                                                                                      BUG2488
     C           *LOVAL    SETLLSDTELDL1                                                     BUG2488
     C                     READ SDTELDL1                 71                                  BUG2488
     C           WCDUP     DOWEQ'N'                                                          BUG2488
     C           *IN71     ANDEQ*OFF                                                         BUG2488
      *                                                                                      BUG8195
     C           FRTYLC    IFNE 'D'                                                          BUG8195
      *                                                                                      BUG2488
      ** If not the first time, delete previous overrides                                    BUG2488
      *                                                                                      BUG2488
     C           @CMD7     IFNE *BLANKS                                                      BUG2488
     C                     MOVEL*BLANKS   @CMD7                                              BUG2488
     C                     MOVEL@TXT,6    @CMD7                                              BUG2488
     C                     CALL 'QCMDEXC'                                                    BUG2488
     C                     PARM           @CMD7                                              BUG2488
     C                     PARM 80        @LEN                                               BUG2488
     C                     CLOSETTRANL7                                                      BUG2488
     C                     ENDIF                                                             BUG2488
      *                                                                                      BUG2488
      ** Perform override to LF/TTRANL7                                                      BUG2488
      *                                                                                      BUG2488
     C                     MOVEL*BLANKS   @CMD7                                              BUG2488
     C                     MOVEL@TXT,7    @CMD7                                              BUG2488
     C                     MOVEL'T'       @BRI7                                              BUG2488
     C                     MOVELFRTLID    @BID7                                              BUG2488
     C                     CALL 'QCMDEXC'                                                    BUG2488
     C                     PARM           @CMD7                                              BUG2488
     C                     PARM 80        @LEN                                               BUG2488
     C                     OPEN TTRANL7                                                      BUG2488
      *                                                                                      BUG2488
     C           *LOVAL    SETLLTTRANL7                                                      BUG2488
     C           TRCQNF    CHAINTTRANL7              70                                      BUG2488
     C           *IN70     IFEQ *OFF                                                         BUG2488
     C                     MOVE 'Y'       WCDUP                                              BUG2488
     C                     ENDIF                                                             BUG2488
      *                                                                                      BUG8195
     C                     ENDIF                                                             BUG8195
      *                                                                                      BUG2488
     C                     READ SDTELDL1                 71                                  BUG2488
      *                                                                                      BUG2488
     C                     ENDDO                                                             BUG2488
     C                     ENDIF                                                             BUG2488
      *                                                                                      BUG2488
      ***Find*corresponding*record*of*cheque*transaction*and***********               CRE019 BUG2488
      ***check*if*there*is*a*duplicate*transaction.********************               CRE019 BUG2488
     C********** *IN70     DOWEQ*OFF                                                  CRE019 BUG2488
     C********** WCDUP     ANDEQ'N'                                                   CRE019 BUG2488
      *****************************************************************               CRE019 BUG2488
      ***Determine*valid*retail*account*number*or*full*account*********               CRE019 BUG2488
      ***name*among*the*three*included*members.************************               CRE019 BUG2488
     C********** THACNO    IFEQ *BLANK                                                CRE019 BUG2488
     C**********           SELEC                                                      CRE019 BUG2488
     C********** TTACNO    WHNE *ZERO                                                 CRE019 BUG2488
     C**********           MOVE TTACNO    THACNO                                      CRE019 BUG2488
     C********** TBACNO    WHNE *ZERO                                                 CRE019 BUG2488
     C**********           MOVE TBACNO    THACNO                                      CRE019 BUG2488
     C********** TCACNO    WHNE *ZERO                                                 CRE019 BUG2488
     C**********           MOVE TCACNO    THACNO                                      CRE019 BUG2488
     C********** TBACCN    WHNE *BLANK                                                CRE019 BUG2488
     C**********           MOVE TBACCN    TCACCN                                      CRE019 BUG2488
     C**********           ENDSL                                                      CRE019 BUG2488
     C**********           ENDIF                                                      CRE019 BUG2488
      *****************************************************************               CRE019 BUG2488
     C********** THACNO    IFNE *BLANKS                                               CRE019 BUG2488
     C********** THACNO    ANDEQTRHCAC                                                CRE019 BUG2488
     C********** THACNO    OREQ *BLANKS                                               CRE019 BUG2488
     C********** TCACCN    ANDEQWHACCN                                                CRE019 BUG2488
     C********** TTTBID    IFNE TBID                                                  CRE019 BUG2488
     C********** TTTBTN    ORNE TBTN                                                  CRE019 BUG2488
     C**********           MOVE 'Y'       WCDUP                                       CRE019 BUG2488
     C**********           ENDIF                                                      CRE019 BUG2488
     C**********           ENDIF                                                      CRE019 BUG2488
      *****************************************************************               CRE019 BUG2488
      ***Clear*TTRANL6*fields*before*next*read*************************               CRE019 BUG2488
     C**********           MOVE *BLANKS   THACNO                                      CRE019 BUG2488
     C**********           MOVE *BLANKS   TTTBID                                      CRE019 BUG2488
     C**********           Z-ADD*ZERO     TTTBTN                                      CRE019 BUG2488
     C**********           Z-ADD*ZERO     TBACNO                                      CRE019 BUG2488
     C**********           MOVE *BLANKS   TBACCN                                      CRE019 BUG2488
     C**********           Z-ADD*ZERO     TCACNO                                      CRE019 BUG2488
     C**********           MOVE *BLANKS   TCACCN                                      CRE019 BUG2488
      *****************************************************************               CRE019 BUG2488
     C********** TRCQNF    READETTRANL6                  70                           CRE019 BUG2488
     C**********           ENDDO                                                      CRE019 BUG2488
      *                                                                                      BUG2488
     C                     ENDSR                                                              CRE019
      *****************************************************************                       CRE019
      /EJECT                                                                                  CRE019
      *****************************************************************                       CRE019
      *  UPTRL2 - Update Control Trailer Record  - CHQBKPT            *                       CRE019
      *****************************************************************                       CRE019
     C           UPTRL2    BEGSR                                                              CRE019
      *                                                                                       CRE019
     C                     Z-ADD9999999999KACNO                                               CRE019
     C                     Z-ADD99999999  KSCQN                                               CRE019
     C           KLCQBK    CHAINCHQBKPTF             70                                       CRE019
      *                                                                                       CRE019
      **  If no record found                                                                  CRE019
      *                                                                                       CRE019
     C           *IN70     IFEQ *ON                                                           CRE019
     C           *LOCK     IN   LDA                                                           CRE019
     C                     Z-ADD32        DBASE                                               CRE019
     C                     MOVEL'CHQBKPTF'DBFILE                                              CRE019
     C                     MOVELKACNO     DBKEY                                               CRE019
     C                     MOVE KSCQN     DBKEY                                               CRE019
     C                     EXSR DBERR                                                         CRE019
     C                     ELSE                                                               CRE019
     C                     SUB  1         NORET                                               CRE019
     C                     UPDATCHQBKPTF                                                      CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C                     ENDSR                                                              CRE019
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPDCHD - Update pf/chqdppd                         *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           UPDCHD    BEGSR                           ** UPDCHD **
      *
      ** Define key list
      ** Cheque deposited details
     C           KLCQDP    KLIST
     C                     KFLD           KTLID
     C                     KFLD           KTBTN
     C                     KFLD           KSEQN
      *
      ** If function code is one of the following
     C           FNCD      IFEQ '00H'
     C           FNCD      OREQ '0JH'
     C           FNCD      OREQ '00P'
     C           FNCD      OREQ '0JP'
      *
      ** And clearing ind. of trans.type 2 is 'y'
     C           @CLIN2    ANDEQ'Y'
      *
      ** Move fields to key list
     C                     MOVELTBID      KTLID
     C                     Z-ADD@TTNO     KTBTN
      *
      ** If cheque number is blanks
     C           TRCQNF    IFEQ *BLANK
      *
     C                     Z-ADD00000     KSEQN
      *
     C                     ELSE
      *
     C                     Z-ADD999       KSEQN
      *
     C                     END
      *
     C                     END
      *
      ** If function code is one of the following
     C           FNCD      IFEQ '00K'
     C           FNCD      OREQ '00R'                                     CRT002
     C           FNCD      OREQ '0JK'
     C           FNCD      OREQ '0JR'                                     CRT002
     C           FNCD      OREQ '00Q'
     C           FNCD      OREQ '0JQ'
      *
      ** And clearing ind. of trans.type 1 is 'y'
     C           @CLIN1    ANDEQ'Y'
      *
      ** Move fields to key list
     C                     MOVELTBID      KTLID
     C                     Z-ADD@TTNO     KTBTN
      *
      ** If cheque number is blanks
     C           TRCQNF    IFEQ *BLANK
      *
     C                     Z-ADD00000     KSEQN
      *
     C                     ELSE
      *
     C                     Z-ADD99999     KSEQN
      *
     C                     END
      *
     C                     END
      *
      ** If function code is one of the following
     C           FNCD      IFEQ '00H'
     C           FNCD      OREQ '0JH'
     C           FNCD      OREQ '00P'
     C           FNCD      OREQ '0JP'
     C           FNCD      OREQ '00K'
     C           FNCD      OREQ '00R'                                     CRT002
     C           FNCD      OREQ '0JK'
     C           FNCD      OREQ '0JR'                                     CRT002
     C           FNCD      OREQ '00Q'
     C           FNCD      OREQ '0JQ'
      *
      ** Access record off pf/chqdppd
     C           KLCQDP    CHAINCHQDPPD              70
      *
      ** If record found - update the record
     C           *IN70     IFEQ '0'
      *
     C                     MOVEL'*'       RECI
     C                     MOVEL'R'       UPDI
     C                     UPDATCHQDPPDF
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRTRPD - Write Teller transactions details         *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           WRTRPD    BEGSR                           ** WRTRPD **
      *
      ** If teller transaction reversal
     C           SBATNO    IFEQ *BLANKS
     C                     MOVEL'T'       TBRI
     C                     MOVELPTLID     TBID
     C                     Z-ADDTTNATN    TBTN
     C                     Z-ADDTBTN      @TTRNO
     C                     MOVEL'T'       CQRI
      *
     C                     ELSE
      *
      ** If batch transaction reversal
     C                     MOVEL'B'       TBRI
     C                     MOVELSBATNO    TBID
     C           BITU      ADD  1         TBTN
     C                     Z-ADDTBTN      @TTRNO
     C                     MOVEL'B'       CQRI
      *
     C                     END
      *
      ** Perform override to PF/TTRANPD & open file
     C                     MOVEL*BLANKS   @CMD
     C                     MOVEL@TXT,3    @CMD
     C                     MOVELTBRI      @BRI
     C                     MOVELTBID      @BID
     C                     CALL 'QCMDEXC'              70
     C                     PARM           @CMD
     C                     PARM 80        @LEN
      *                                                                   CRT002
     C                     MOVEL'QCMDEXC' P@QRS                           CRT002
     C                     MOVEL@CMDT     P@QKY                           CRT002
     C                     EXSR DQERR                                     CRT002
      *
     C                     OPEN TTRANPD                70
      *                                                                                       CRT006
      ** Acknowledged Flag will be processed from the transaction                             CRT006
      ** application data queue message if running in batch mode.                             CRT006
      ** Interactively, Acknowledged Flag will be set to 'Y'.                                 CRT006
     C           PMODE     IFEQ 'P'                                                           CRT006
     C                     MOVE RAACKF    ACKF                                                CRT006
     C                     ELSE                                                               CRT006
     C                     MOVE 'Y'       ACKF                                                CRT006
     C                     ENDIF                                                              CRT006
      *
     C                     MOVEL'D'       RECI
     C                     MOVE TRACNO    ACNO
     C                     MOVELPFNCD     FNCD
     C                     MOVELSCCY      CCY1
     C                     Z-ADD@TAMT     AMT1
     C                     MOVELTRDEPC    DEPC
     C                     MOVELPTLBC     ITLB
     C                     MOVEL@JOB      TWID
     C                     TIME           TIME
     C                     Z-ADDRRNM      MRR1
     C                     MOVEL@OVTI     OVTI
     C                     MOVEL@MSG1     MSG1
     C                     MOVELTRCCY1    RVCY
     C                     Z-ADD@TTNO     CRTN
     C                     WRITET2RANPDF
      *
     C                     CLOSETTRANPD                70
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            WRRSAC - Write shadow posting file record          *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  UMEMOS - Update memos file record                  *
      *                                                               *
      *****************************************************************
     C           WRRSAC    BEGSR                           ** WRRSAC **
      *
     C**********           Z-ADDCNUM      CUSN                                                CSD027
     C                     MOVE CNUM      CUSN                                                CSD027
     C                     MOVELCCY       CCYD
     C                     Z-ADDACOD      ACDE
     C                     Z-ADDACSQ      ASNC
     C                     Z-ADD@RUND     PTDT
      *                                                                   197289
      * Ensure correct date is set up for projected a/c movements         197289
      *                                                                   197289
     C           *IN30     IFEQ '1'                                       197289
     C                     Z-ADD@RUND     VUDT                            197289
     C                     ELSE                                           197289
     C                     Z-ADDTRVLDT    VUDT
     C                     ENDIF                                          197289
      *                                                                   197289
     C                     MOVEL'TT'      TRYP
      *
     C                     MOVEL@FNNR     NRTD
     C                     MOVE TBTN      TNMR
     C                     MOVE TRCQNF    CQNR
     C                     Z-ADD@TAAMT    MVAM
      *
      ** If rev.tr.type is credit(or rev.tr.type is credit for '00a')
     C           @RVTTY    IFEQ 1
     C           @RTRVT    OREQ 1
     C                     Z-ADD0         DORC
     C                     ELSE
     C                     Z-ADD1         DORC
     C                     END
      *
     C                     MOVELPTLID     TBID
     C                     MOVEL'N'       APBI
      *
      ** If function code is not retail transfer (00a)
     C           FNCD      IFNE '00A'
      *
     C                     MOVEL@PBTP1    PASS
      *
     C                     ELSE
      *
      ** If rev.type is credit for 00A
     C           @RTRVT    IFEQ 1
      *
     C                     MOVEL@PBTP1    PASS
      *
     C                     ELSE
      *
     C                     MOVEL@PBTP2    PASS
      *
     C                     END
      *
     C                     END
      *
      ** Move the passbook transaction type for reversal
     C                     MOVEL@RVPBT    PASS
      *
     C*                                                                   S01408
     C/COPY WNCPYSRC,RE4124CCP1                                           S01408
     C*                                                                   S01408
     C           CAP205    IFEQ 'Y'                                                           CAP205
     C                     MOVEL'RE'      CMOD                                                CAP205
     C                     MOVEL'S'       MTYP                                                CAP205
     C                     ENDIF                                                              CAP205
      *                                                                                       CAP205
     C                     WRITERSACMTPO
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            UPTRL  - Update Control Trailer Record             *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling : Terminate pgm.  *
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           UPTRL     BEGSR                           ** UPTRL  **
      *
     C           1         CHAINT2RANPTF             70
      *
      ** If no record is present -
     C           *IN70     IFEQ '1'
     C           *LOCK     IN   LDA                        *************
     C                     Z-ADD4         DBASE            ** DB ERR 04*
     C                     MOVEL'TTRANPT' DBFILE           *************
     C                     MOVEL'1       'DBKEY
     C                     EXSR DBERR
      *
     C                     ELSE
      *
     C                     ADD  1         NORE
     C                     UPDATT2RANPTF
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            PCMTXT - Prepare comit text                        *
      *                                                               *
      * CALLS      MAINP  - Main input process                        *   CRT002
      *            VALFMT - Validate screen input                     *   CRT002
      *                                                               *
      * CALLED BY  UPDRTN - Control rtn. for updates                  *
      *                                                               *
      *****************************************************************
     C           PCMTXT    BEGSR                           ** PCMTXT **
      *
      ** Prepare the comit text CMTTXT
     C                     MOVE 'RE'      MDID
     C                     MOVEL@PGM      PGMN
     C                     MOVE SWID      WSIDX
     C                     TIME           MTIME
     C                     MOVE @USER     USRIDX
      *
     C                     ENDSR
      *****************************************************************                       CRE081
      /EJECT                                                                                  CRE081
      *****************************************************************                       CRE081
      *                                                               *                       CRE081
      *  VALABC - Validate Account Balance Check in RPG               *                       CRE081
      *                                                               *                       CRE081
      *****************************************************************                       CRE081
      *                                                                                       CRE081
     C           VALABC    BEGSR                                                              CRE081
      *                                                                                       CRE081
      ** Initialise override array elements as per SR RTABAL                                MD020635
      *                                                                                     MD020635
     C           PFNCD     IFNE '***'                                                       MD020635
     C                     MOVE ' '       @O,@IF                                            MD020635
     C                     MOVE ' '       @O,@OD                                            MD020635
     C                     MOVE ' '       @O,@MB                                            MD020635
     C                     ENDIF                                                            MD020635
      *                                                                                     MD020635
     C                     CALL 'RE001590'                                                    CRE081
     C                     PARM @ACNO     PRTAC                                               CRE081
     C                     PARM *BLANKS   PCUSN   6                                           CRE081
     C                     PARM *BLANKS   PCURR   3                                           CRE081
     C                     PARM 0         PACOD                                               CRE081
     C                     PARM 0         PASEQ                                               CRE081
     C                     PARM *BLANKS   PBRCH   3                                           CRE081
     C                     PARM 'RETELD'  PTRTYP 10                                           CRE081
     C                     PARM @VDAO     PVLDAT                                              CRE081
     C                     PARM @TAAMT    PAMT                                                CRE081
     C                     PARM *BLANKS   PERR01  7                                           CRE081
     C                     PARM *BLANKS   PERR02  7                                           CRE081
     C                     PARM 0         PACBAL                                              CRE081
     C                     PARM 0         PAVBAL                                              CRE081
     C                     PARM 0         PFLDAT                                              CRE081
     C                     PARM 0         PFLBAL                                              CRE081
      *                                                                                       CRE081
     C           PERR01    IFEQ 'ABC0001'                                                     CRE081
      *                                                                                       CRE081
     C           @V,@MB    IFEQ 'Y'                                                           CRE081
     C                     ADD  1         @WI                                                 CRE081
     C                     MOVEL'BLW.MIN' @W,@WI                                              CRE081
     C                     MOVEL'Y'       @O,@MB                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C           @V,@MB    IFEQ 'N'                                                           CRE081
     C                     ADD  1         @TI                                                 CRE081
     C                     MOVEL'BLW.MIN' @T,@TI                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C           PERR02    IFNE *BLANKS                                                       CRE081
      *                                                                                       CRE081
     C           @ODLN     IFEQ 0                                                           MD020701
     C           @ODED     ORLT @RUND                                                       MD020701
     C           @V,@IF    IFEQ 'Y'                                                         MD020701
     C                     ADD  1         @WI                                               MD020701
     C                     MOVEL'N.S.F.'  @W,@WI                                            MD020701
     C                     MOVE 'Y'       @O,@IF                                            MD020701
     C                     ENDIF                                                            MD020701
     C           @V,@IF    IFEQ 'N'                                                         MD020701
     C                     ADD  1         @TI                                               MD020701
     C                     MOVEL'N.S.F.'  @T,@TI                                            MD020701
     C                     ENDIF                                                            MD020701
     C                     ELSE                                                             MD020701
      *                                                                                     MD020701
     C           @V,@OD    IFEQ 'Y'                                                           CRE081
     C                     ADD  1         @WI                                                 CRE081
     C                     MOVEL'EX.O/D'  @W,@WI                                              CRE081
     C                     MOVEL'Y'       @O,@OD                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C           @V,@OD    IFEQ 'N'                                                           CRE081
     C                     ADD  1         @TI                                                 CRE081
     C                     MOVEL'EX.O/D'  @T,@TI                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDIF                                                            MD020701
      *                                                                                     MD020701
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDSR                                                              CRE081
      *                                                                                       CRE081
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            LAST   - Final Processing                          *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  Main   - Control Process                           *
      *            MAINP  - Main input process                        *
      *            TRNACC - Transaction accept process                *
      *                                                               *
      *****************************************************************
     C           LAST      BEGSR                           ** LAST   **
      *
      ** Close files TTRANL1 and TTRANPT                                                      194978
      *                                                                                       194978
     C                     CLOSETTRANL1                70                                     194978
     C                     CLOSETTRANPT                70                                     194978
      *                                                                                       194978
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            *PSSR  - Program error                             *
      *                                                               *
      * CALLS      DBERRCTL                                           *
      *            PCMTXT - Prepare comit text.                       *   CRT002
      *                                                               *
      * CALLED BY                                                     *
      *                                                               *
      *****************************************************************
     C           *PSSR     BEGSR                           ** *PSSR  **
     C*
     C** Check to see that *PSSR has not been called yet
     C*
     C           WRUN      IFEQ *BLANK
     C                     MOVE 'Y'       WRUN    1
     C                     SETON                     U7U8LR
      *
      ** Transaction failed.  Re-input necessary.
     C                     DUMP
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     CLOSE*ALL
     C                     ROLBK
     C*
     C** Call standard database error program
     C*
     C                     CALL 'DBERRCTL'
     C                     END                                            CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'P'                                       CRT002
     C           @FIRST    ANDEQ'0'                                       CRT002
      *                                                                   CRT002
     C                     ROLBK                                          CRT002
      *                                                                   CRT002
     C                     MOVELRAMSTY    RBMSTY                          CRT002
     C                     MOVELDBLOT     RBHSMS                          CRT002
     C                     MOVEL*BLANKS   RBHMSI                          CRT002
     C                     MOVEL'1'       RBAEFL                          CRT002
     C                     MOVEL'E'       RBHMSS                          CRT002
      *                                                                   CRT002
     C                     CLEARLOGDS                                     CRT002
      *                                                                   CRT002
     C                     MOVEL'USR0010' @MSGID                          CRT002
     C                     MOVELDBLOT     @MSGDT                          CRT002
     C                     EXSR RTVMSG                                    CRT002
     C                     MOVEL@MSGTX    RBHSMS                          CRT002
      *                                                                   CRT002
     C                     MOVE RACMSQ    WCMSQ                           CRT002
     C                     MOVELRABRNM    WBRCA                           CRT002
     C                     MOVELRAUSID    WUSID                           CRT002
     C                     MOVE 'N'       WSUCM                           CRT002
     C                     MOVE 'DS'      WSTAT                           CRT002
     C                     TIME           WTMDS                           CRT002
     C           WTHR      CAT  ':'       WA                              CRT002
     C           WTMN      CAT  ':'       WB                              CRT002
     C           WA        CAT  WB        WC                              CRT002
     C           WC        CAT  WTSS      WSTTM                           CRT002
      *                                                                   CRT002
     C/COPY WNCPYSRC,REH00330
     C                     MOVELREPOIO    P@QDS                           CRT002
      *                                                                   CRT002
     C                     CLEARWCMSG                                     CRT002
     C                     MOVELREPOIO    WCMSG                           CRT002
      *                                                                   CRT002
     C                     EXSR SDQMS                                     CRT002
     C                     EXSR DQERR                                     CRT002
     C                     EXSR WRLOG                                     CRT002
     C                     EXSR PCMTXT                                    CRT002
     C           CMTTXT    COMIT                                          CRT002
     C                     MOVEL*BLANKS   REPOIO                          CRT002
     C                     CLOSE*ALL                                      CRT002
      *                                                                   CRT002
     C                     ENDIF                                          CRT002
     C*
     C                     END
     C                     SETON                     LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            FIRST  - Initial Processing                        *
      *                                                               *
      * CALLS      IFLDS  - Initialize screen/work fields             *
      *            INT01  - Initialise error indicators               *
      *            DBERR  - Database Error Handling : Terminate pgm.  *
      *                                                               *
      * CALLED BY  Main   - Control Process                           *
      *                                                               *
      *****************************************************************
     C           FIRST     BEGSR                           ** FIRST  **
      *                                                                                       194978
      ** Open files TTRANL1 and TTRANPT                                                       194978
     C                     OPEN TTRANL1                70                                     194978
     C                     OPEN TTRANPT                70                                     194978
      *
      ** Input parameter(s) :
     C           *ENTRY    PLIST                           Entry parameter list
     C                     PARM           PFNCD   3        Function code
     C                     PARM           PTTYP   5        Trans. Type
     C                     PARM           PMODE   1        Processing ModeCRT002
      *
      ** Define Keylist for ttranl1- ttranpdf
     C           KLTRAN    KLIST
     C                     KFLD           K2BRI
     C                     KFLD           K2ITB
     C                     KFLD           K2BID
     C                     KFLD           K2TRN
      *
      ** Define Keylist for ttranl1- ttranptf
     C           KLTRA2    KLIST
     C                     KFLD           K3BRI
     C                     KFLD           K3BID
     C                     KFLD           K3TRN
      *
      ** Account master
     C           KLACNT    KLIST
     C                     KFLD           @CNUM
     C                     KFLD           @CCY
     C                     KFLD           @ACOD
     C                     KFLD           @ACSQ
     C                     KFLD           @BRCA
      *                                                                   120471
     C           KCHARG    KLIST                                          120471
     C                     KFLD           TBID                            120471
     C                     KFLD           @TTNO                           120471
      *
      ** Retrieve RTS job dataarea
     C           *NAMVAR   DEFN           RTSDTA
     C                     IN   RTSDTA
      *                                                                   CRT002
     C           *NAMVAR   DEFN           CITFTS                          CRT002
     C                     IN   CITFTS                                    CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     MOVELPTLID     @TLID
     C                     ENDIF                                          CRT002
      *
      ** Prepare LDA
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVEL*BLANK    DBLOT
     C                     OUT  LDA
      *                                                                   CRT002
      **  If PMODE = 'I', open display file RE4124DF                      CRT002
      *                                                                   CRT002
     C           PMODE     IFEQ 'I'                                       CRT002
     C                     OPEN RE4124DF                                  CRT002
     C                     END                                            CRT002
      *                                                                   CRT002
      **  Initialise MSG text and MSG return code                         CRT002
      *                                                                   CRT002
     C                     MOVE *BLANKS   WUMSGT 78                       CRT002
     C                     MOVE *BLANKS   WURTCD  1                       CRT002
      *
      ** initialize parameters for SCC0240- build program message queue
     C                     MOVE *BLANKS   @MSGID  7
     C                     MOVEL'RTSMSGF' @MSGF  10
     C                     MOVE *BLANKS   WUMSID  7                       CRT002
     C                     MOVEL'RTSMSGF' WUMSGF 10                       CRT002
      *                                                                   CRT002
     C                     MOVE '1'       @FIRST  1                       CRT002
      *
      ** Initialize screen message queue
     C                     MOVEL'*'       SPGMQ
      *
      ** Seton  message subfile end indicator
     C                     MOVE '1'       *IN10
      *
      ** Set up workstation-id, program ... for screen display
     C                     MOVEL@JOB      SWID   10
     C                     MOVEL@PGM      SPGMN  10
     C                     MOVEL@USER     SUSER  10
      *
      ** Access PF/SDBANKPD for Midas Run Date.
     C                     CALL 'AOBANKR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      ** If record does not exist
     C           @RTCD     IFNE *BLANK
      *
     C           *LOCK     IN   LDA
     C                     MOVE 'SDBANKPD'DBFILE           ***************
     C                     Z-ADD1         DBASE            ** DB ERR 01 **
     C                     MOVEL@OPTN     DBKEY            ***************
     C                     EXSR DBERR
      *
     C                     END
      *
      ** Move midas run date to screen field & store runday number
     C                     MOVELBJMRDT    SRUNA
     C                     Z-ADDBJRDNB    @RUND   50
      *
      ** Access PF/SDFNCDPD for function code record
     C                     CALL 'AOFNCDR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM PFNCD     @FNCD
     C           SDFNCD    PARM SDFNCD    DSFDY
      *
      ** If record does not exist - database errors
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA
     C                     MOVEL'SDFNCDPD'DBFILE           **************
     C                     Z-ADD2         DBASE            ** DB ERR 02 **
     C                     MOVELPFNCD     DBKEY            ***************
     C                     EXSR DBERR
     C                     END
      *
      ** Access PF/SDRETRPD for tran.type from entry parameter
     C                     CALL 'AORETRR0'
     C                     PARM '*BLANKS' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM PTTYP     @RETR   5
     C           SDRETR    PARM SDRETR    DSFDY
      *
      ** If record does not exist - database error
     C           @RTCD     IFNE *BLANK
     C           *LOCK     IN   LDA                        ***************
     C                     Z-ADD3         DBASE            ** DB ERR 03***
     C                     MOVE 'SDRETRPD'DBFILE           **************
     C                     MOVELPTTYP     DBKEY
     C                     EXSR DBERR
      *
     C                     END
      *
      ** Store the passbook transaction type (pass)
     C                     MOVELA1PASB    @RVPBT  2
      *
      ** Store validation indicators in an array and function desc.
     C                     MOVEAFQVWIN    @V
     C                     MOVELFQRNNR    @FNNR  30
      *
      ** Set reversal indicator to 'y'
     C                     MOVEL'Y'       @RVIN   1
      *
      ** Initialise QCMDEXC text
     C                     MOVEL*BLANKS   @CMD
     C                     MOVEL*BLANKS   @CMDT                           CRT002
     C                     MOVEL*BLANKS   @CMD7                                              BUG2488
      *                                                                   CRT002
      **  Load tellers to array.                                          CRT002
      *                                                                   CRT002
     C                     EXSR LODTLR                                    CRT002
     C/COPY WNCPYSRC,REH00331
      *
     C                     MOVE '0'       @FIRST                          CRT002
      *                                                                   CRT002
     C                     MOVEL'RE4124'  P@QRC                           CRT002
     C                     MOVE '0JD '    P@QRC                           CRT002
      *                                                                   CRT002
     C/COPY ZSRSRC,RBOITMC1                                               CRT002
      *                                                                   CRT002
      ** Determine if CRE019 is installed                                                     CRE019
      *                                                                                       CRE019
     C                     CALL 'AOSARDR0'                                                    CRE019
     C                     PARM *BLANKS   PRTCD   7                                           CRE019
     C                     PARM '*VERIFY 'POPTN   7                                           CRE019
     C                     PARM 'CRE019'  PSARD   6                                           CRE019
     C           SCSARD    PARM SCSARD    DSFDY                                               CRE019
      *                                                                                       CRE019
     C           PRTCD     IFNE *BLANKS                                                       CRE019
     C           PRTCD     ANDNE'*NRF   '                                                     CRE019
     C           *LOCK     IN   LDA                                                           CRE019
     C                     MOVEL'SCSARDPD'DBFILE                                              CRE019
     C                     Z-ADD35        DBASE                                               CRE019
     C                     MOVEL'CRE019'  DBKEY                                               CRE019
     C                     EXSR DBERR                                                         CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
     C           PRTCD     IFEQ *BLANKS                                                       CRE019
     C                     MOVE 'Y'       CRE019  1                                           CRE019
     C                     ELSE                                                               CRE019
     C                     MOVE 'N'       CRE019                                              CRE019
     C                     ENDIF                                                              CRE019
      *                                                                                       CRE019
      * Check if CRT012 is switched on                                    CRT012
     C                     CALL 'AOSARDR0'                                CRT012
     C                     PARM           PRTCD   7                       CRT012
     C                     PARM '*VERIFY' POPTN   7                       CRT012
     C                     PARM 'CRT012'  PSARD   6                       CRT012
      *                                                                   CRT012
     C           PRTCD     IFEQ *BLANKS                                   CRT012
      *                                                                   CRT012
      * Check if Cashier Multiple Charges is On                           CRT012
     C                     MOVE *BLANKS   SVALK2                          CRT012
     C                     MOVE *BLANKS   SVALK3                          CRT012
     C                     MOVE *BLANKS   SVALK4                          CRT012
     C                     MOVE *BLANKS   SVALK5                          CRT012
     C                     MOVE *BLANKS   SVALK6                          CRT012
     C                     MOVE *BLANKS   SVALK7                          CRT012
     C                     MOVE *BLANKS   SVALK8                          CRT012
     C                     MOVE *BLANKS   SVALK7                          CRT012
     C                     MOVE *BLANKS   SVALK8                          CRT012
      *                                                                   CRT012
     C                     CALL 'AOSVALR0'                                CRT012
     C                     PARM *BLANKS   RTNCDE  7                       CRT012
     C                     PARM           SVALK1 20                       CRT012
     C                     PARM           SVAL1 200                       CRT012
     C                     PARM           SVALK2 20                       CRT012
     C                     PARM           SVAL2 200                       CRT012
     C                     PARM           SVALK3 20                       CRT012
     C                     PARM           SVAL3 200                       CRT012
     C                     PARM           SVALK4 20                       CRT012
     C                     PARM           SVAL4 200                       CRT012
     C                     PARM           SVALK5 20                       CRT012
     C                     PARM           SVAL5 200                       CRT012
     C                     PARM           SVALK6 20                       CRT012
     C                     PARM           SVAL6 200                       CRT012
     C                     PARM           SVALK7 20                       CRT012
     C                     PARM           SVAL7 200                       CRT012
     C                     PARM           SVALK8 20                       CRT012
     C                     PARM           SVAL8 200                       CRT012
     C                     PARM           SVALK9 20                       CRT012
     C                     PARM           SVAL9 200                       CRT012
     C                     PARM           SVALK0 20                       CRT012
     C                     PARM           SVAL10200                       CRT012
      *                                                                   CRT012
     C           RTNCDE    IFNE *BLANKS                                   CRT012
     C           SVAL10    IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK0    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL9     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK9    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL8     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK8    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL7     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK7    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL6     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK6    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL5     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK5    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL4     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK4    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL3     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK3    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL2     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK2    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           SVAL1     IFEQ '*NRF'                                    CRT012
     C                     MOVE SVALK1    DBKEY                           CRT012
     C                     ENDIF                                          CRT012
     C           *LOCK     IN   LDA                                       CRT012
     C                     MOVEL'SDSVALPD'DBFILE           *************  CRT012
     C                     Z-ADD37        DBASE            * DB ERR 37 *  CRT012
     C                     EXSR DBERR                      *************  CRT012
     C                     ENDIF                                          CRT012
     C           SVAL11    IFEQ 'Y'                                       CRT012
     C                     MOVE 'Y'       CRT012  1                       CRT012
     C                     ELSE                                           CRT012
     C                     MOVE 'N'       CRT012                          CRT012
     C                     ENDIF                                          CRT012
     C*                                                                   CRT012
     C                     ELSE                                           CRT012
     C                     MOVE 'N'       CRT012                          CRT012
     C                     ENDIF                                          CRT012
      *                                                                   CRT012
      ** Check if CRT026 is switched on                                                       CRT026
      *                                                                                       CRT026
     C                     CALL 'AOSARDR0'                                                    CRT026
     C                     PARM *BLANKS   PRTCD                                               CRT026
     C                     PARM '*VERIFY' POPTN                                               CRT026
     C                     PARM 'CRT026'  PSARD                                               CRT026
     C           SCSARD    PARM SCSARD    DSFDY                                               CRT026
      *                                                                                       CRT026
     C           PRTCD     IFNE *BLANKS                                                       CRT026
     C           PRTCD     ANDNE'*NRF   '                                                     CRT026
     C           *LOCK     IN   LDA                                                           CRT026
     C                     MOVEL'SCSARDPD'DBFILE           ***************                    CRT026
     C                     Z-ADD23        DBASE            ** DB ERR 23 **                    CRT026
     C                     MOVEL'CRT026'  DBKEY            ***************                    CRT026
     C                     EXSR DBERR                                                         CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
     C           PRTCD     IFEQ *BLANKS                                                       CRT026
     C                     MOVE 'Y'       CRT026  1                                           CRT026
     C                     ELSE                                                               CRT026
     C                     MOVE 'N'       CRT026                                              CRT026
     C                     ENDIF                                                              CRT026
      *                                                                                       CRT026
      ** Determine if CAP205 is installed                                                     CAP205
      *                                                                                       CAP205
     C                     CALL 'AOSARDR0'                                                    CAP205
     C                     PARM *BLANKS   PRTCD                                               CAP205
     C                     PARM '*VERIFY 'POPTN                                               CAP205
     C                     PARM 'CAP205'  PSARD                                               CAP205
     C           SCSARD    PARM SCSARD    DSFDY                                               CAP205
      *                                                                                       CAP205
     C           PRTCD     IFNE *BLANKS                                                       CAP205
     C           PRTCD     ANDNE'*NRF   '                                                     CAP205
     C           *LOCK     IN   LDA                                                           CAP205
     C                     MOVEL'SCSARDPD'DBFILE                                              CAP205
     C                     Z-ADD36        DBASE                                               CAP205
     C                     MOVEL'CAP205'  DBKEY                                               CAP205
     C                     EXSR DBERR                                                         CAP205
     C                     ENDIF                                                              CAP205
      *                                                                                       CAP205
     C           PRTCD     IFEQ *BLANKS                                                       CAP205
     C                     MOVE 'Y'       CAP205  1                                           CAP205
     C                     ELSE                                                               CAP205
     C                     MOVE 'N'       CAP205                                              CAP205
     C                     ENDIF                                                              CAP205
      *                                                                                       CAP205
     C/COPY WNCPYSRC,RE4124C006
      *                                                                                       CRE081
      ** Perform Account Balance Check in RPG if feature CRE081 is ON                         CRE081
      *                                                                                       CRE081
     C                     CALL 'AOSARDR0'                                                    CRE081
     C                     PARM *BLANKS   PRTCD                                               CRE081
     C                     PARM '*KEY   ' POPTN                                               CRE081
     C                     PARM 'CRE081'  PSARD                                               CRE081
     C           SCSARD    PARM SCSARD    DSFDY                                               CRE081
      *                                                                                       CRE081
     C                     MOVE 'N'       CRE081  1                                           CRE081
     C           PRTCD     IFEQ *BLANKS                                                       CRE081
     C                     MOVE 'Y'       CRE081                                              CRE081
     C                     ENDIF                                                              CRE081
      *                                                                                       CRE081
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            IFLDS  - Initialize screen/work fields             *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  RFRESH - Refresh screen                            *
      *            FIRST  - Initial Processing                        *
      *****************************************************************
     C           IFLDS     BEGSR                           ** IFLDS  **
      *
     C                     MOVE *BLANKS   SBATNO
     C                     MOVE *BLANKS   STTNO
     C                     MOVE *BLANKS   SRACNO
     C                     MOVE *BLANKS   SCCY
     C                     MOVE *BLANKS   SAMT
     C                     MOVE *BLANKS   SOTLI
     C                     MOVE *BLANKS   SOTPC
     C                     MOVE *BLANKS   SOVUR                                               CRT026
     C                     MOVE *BLANKS   SOVPW                                               CRT026
      *
      ** Initialise work fields
     C                     MOVE *BLANKS   @SECCY
     C                     MOVE *BLANKS   @SCYEQ
     C                     MOVE *BLANKS   @ACNO
     C                     MOVE *BLANKS   @ACNM
     C                     MOVE *BLANKS   @CCY
     C                     MOVE *BLANKS   @FNCD
     C                     MOVE *BLANKS   @FNNM
     C                     MOVE *BLANKS   @LEDBL 22
     C                     MOVE *BLANKS   @AVLBL 22
     C                     MOVE *BLANKS   @W
     C                     MOVE *BLANKS   @T
     C                     Z-ADD1         @COUNT  10
      *
     C                     ENDSR
      *****************************************************************
     C/COPY WNCPYSRC,RE4124C007
      /EJECT
     C/COPY WNCPYSRC,RE4124C008
      *****************************************************************
      *                                                               *
      * SNDMSG  - Sends parameters of SNDPGMMSG command to be executed*
      *                                                               *
      * CALLS      SCC0240 - Send Message to program queue            *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      * FLDS USED  @MSGID - Message id                                *
      *            @MSGF  - Message file                              *
      *                                                               *
      *****************************************************************
     C           SNDMSG    BEGSR                           ** SNDMSG **
      *
     C                     SETON                     69
      *
     C                     CALL 'SCC0240'
     C                     PARM           @MSGID
     C                     PARM           @MSGF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DBERR  - Database Error Handling : Terminate pgm.  *
      *                                                               *
      * CALLED BY  ZA0150 - Get Midas Rundate & Setup Indicator(01)   *
      *            FIRST  - Initial processing              (02 03 04)*
      *            UPTRL  - Update Control Trailer Record      (05)   *
      *            UPDRTN - Control rtn. for updates           (06 07)*
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           DBERR     BEGSR                           ** DBERR  **
      *
     C                     MOVEL@PGM      DBPGM
     C                     OUT  LDA
      *
     C                     EXSR *PSSR
      *
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              198870
      *****************************************************************   198870
      *                                                               *   198870
      *            PAD    - Pad field with leading zeros.             *   198870
      *                                                               *   198870
      * CALLS             -                                           *   198870
      *                                                               *   198870
      * CALLED BY  VALFMT - Validate Input routine.                   *   198870
      *                                                               *   198870
      * FLDS USED         -                                           *   198870
      *                                                               *   198870
      *****************************************************************   198870
     C           PAD       BEGSR                                          198870*** PAD    ***
      *                                                                   198870
      **  Pad field with zeros to coincide with Cashier format.           198870
      *                                                                   198870
     C                     Z-ADD1         L       20                      198870
     C                     Z-ADD0         WEND    20                      198870
     C           ' '       CHECKWFIELD    WEND                            198870
     C                     MOVEA*BLANKS   RTE,1                           198870
     C                     MOVEAWFIELD    RTE,1                           198870
      *                                                                   198870
     C           L         DOWLTWEND                                      198870
     C                     MOVEL'0'       RTE,L                           198870
     C                     ADD  1         L                               198870
     C                     ENDDO                                          198870
      *                                                                   198870
      **  Replace any commas caused by County-specific character sets     198870
      **  by decimal points to ensure Cashier compatibility.              198870
      *                                                                   198870
     C                     Z-ADD1         X                               198870
     C                     MOVE '0'       *IN68                           198870
      *                                                                   198870
     C           ','       LOKUPRTE,X                  60                 198870
     C           *IN60     IFEQ *ON                                       198870
     C                     MOVEL'.'       RTE,X                           198870
     C                     ENDIF                                          198870
      *                                                                   198870
     C                     ENDSR                                          198870
      *                                                                   198870
      *****************************************************************   198870
      /EJECT                                                              CRT008
      *****************************************************************   CRT008
      *                                                               *   CRT008
      *            DTQMSG - Send message to DTQ                       *   CRT008
      *                                                               *   CRT008
      * CALLS      SDQMS - Send dataqueue message                     *   CRT008
      *            DQERR - Dataqueue message error                    *   CRT008
      *                                                               *   CRT008
      * CALLED BY  MAINP - Main Input Process                         *   CRT008
      *                                                               *   CRT008
      *****************************************************************   CRT008
     C           DTQMSG    BEGSR                                          CRT008*** DTQMSG ***
      *                                                                   CRT008
     C                     MOVELREPOIO    P@QDS                           CRT008
     C                     EXSR SDQMS                                     CRT008
     C                     EXSR DQERR                                     CRT008
      *                                                                   CRT008
     C                     MOVE RACMSQ    WCMSQ                           CRT008
     C                     MOVELRABRNM    WBRCA                           CRT008
     C                     MOVELRAUSID    WUSID                           CRT008
     C                     MOVELREPOIO    WCMSG                           CRT008
     C                     EXSR WRLOG                                     CRT008
      *                                                                   CRT008
     C                     EXSR PCMTXT                                    CRT008
     C           CMTTXT    COMIT                                          CRT008
     C                     MOVEL*BLANKS   REPOIO                          CRT008
      *                                                                   CRT008
      *                                                                   CRT008
     C                     ENDSR                                          CRT008
      *****************************************************************   CRT008
      /EJECT
      ** SR.ZALIGN subroutine
      /COPY ZSRSRC,ZALIGNZ2
      *
      *****************************************************************
      /EJECT
      ** SR.ZTNLU1 subroutine
      /COPY ZSRSRC,ZTNLU1Z2
      *
      *****************************************************************
      /EJECT
      ** SR.ZFRPED Subroutine
      /COPY ZSRSRC,ZFRPEDZ3
      *
      *****************************************************************
      /EJECT
      ** SR.RTTCCY Subroutine
      /COPY ZSRSRC,RTTCCYC1
      *
      *****************************************************************
      /EJECT
      ** SR.RTCASH Subroutine
      /COPY ZSRSRC,RTCASHC1
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTTWIDC1
      ** Array for SR.RTTWID
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTBKDRC1
      ** SR.RTBKDR Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTBKCRC1
      ** SR.RTBKCR Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTRFDRC1
      ** SR.RTRFDR Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTRFCRC1
      ** SR.RTRFCR Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTIACTC1
      ** SR.RTIACT Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTBKPTC1
      ** SR.RTBKPT Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTBDPTC1
      ** SR.RTBDPT Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTABALC1
      ** SR.RTABAL Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTACLGC1
      ** SR.RTACLG Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTBALCC1
      ** SR.RTBALC Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTACLSC1
      ** SR.RTACLS Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTODCKC1
      ** SR.RTODCK Subroutine
      *****************************************************************
      /EJECT
      /COPY ZSRSRC,RTENCPC1
      ** Passcode encription
      *
      *****************************************************************
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBSDQMS                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBRDQMS                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBDQERR                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
     C/COPY WNCPYSRC,REH00354
      /COPY ZSRSRC,RBMODTC1                                               CRT002
     C/COPY WNCPYSRC,REH00355
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBRMSGC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBWLOGC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,ZEDITZ2                                                CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,RBLDTLC1                                               CRT002
      *                                                                   CRT002
      /EJECT                                                              CRT002
      /COPY ZSRSRC,ZDATE9Z3                                               CRT002
      *                                                                   CRT002
      /COPY ZSRSRC,ZCONVZ1                                                                    CRE019
      ** Convert amount from one currency to another                                          CRE019
      *                                                                                       CRE019
      /EJECT                                                                                  CRE019
      /COPY ZSRSRC,ZXRATEZ1                                                                   CRE019
      ** Obtain x-ccy exchange rate and mult/div indicator                                    CRE019
      *                                                                                       CRE019
      /EJECT
      *****************************************************************
      *
      ** Account Details
     OACCNTABFE                @RLACC
      *
      ** Account Trailer
     OACCNTACFE                @UPACC
      *
     O                         NORE
     O                         NINU
     O                         NOAM
     O                         NOCL
     O                         NOAU
     O                         LCD
     O                         TNLU
      *
      ** Retail Shadow Balances
     O****MEMOSMDFE*********       @RLMEM                                 CCB002
      **********************                                              CCB002
      *
      ** Cheque book file
     O*CHQBKPDFE                @RLCQB
      *
      ** Teller controls
     OTTRNTM2FE                @RELTT
      *
      ** Teller totals
     OTTRNTM3FE                @RELT3
      *
      *****************************************************************
** COPYRIGHT OBJECT **
(c) Finastra International Limited 2001
** - @P   - Array to hold the positions of the validation indicators
01020304050607080910111213141516171819202122232425
**  alphanumeric table
ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789
**  encription code table
SDKJFIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJ
FIENVQPWOCMUXZ293847501LRBAGYHT6ZSDKJFIEN
** @TXT - Large text strings
DLTOVR     FILE(TTRANL1)
OVRDBF     FILE(TTRANL1) MBR(XXXX) SECURE(*YES) SHARE(*YES) SEQONLY(*NO)
OVRDBF     FILE(TTRANPD) MBR(XXXX) SECURE(*YES) SHARE(*YES) SEQONLY(*NO)
DLTOVR     FILE(TTRANPT)
OVRDBF     FILE(TTRANPT) MBR(XXXX) SECURE(*YES) SHARE(*YES) SEQONLY(*NO)
DLTOVR     FILE(TTRANL7)
OVRDBF     FILE(TTRANL7) MBR(XXXX) SECURE(*YES) SHARE(*NO)  SEQONLY(*NO)
**  WTEXT WARNING TEXT MESSAGE                                            CRT002
KSM2329  Multiple referrals exist ( ) -                                   CRT002
**  TABC1/TABC2 - WARNING MESSAGE CONVERTION TABLE                        CRT002
HOLDS   HLDS                                                              CRT002
EXCESS  EXCS                                                              CRT002
FLOAT   FLOT                                                              CRT002
CLS.O/D CSOD                                                              CRT002
SVG.O/D SVOD                                                              CRT002
MAX.CCY MXCY                                                              CRT002
CHQBKER CQBK                                                              CRT002
N.S.F.  NSF                                                               CRT002
EX.O/D  EXOD                                                              CRT002
BLW.MIN BLMN                                                              CRT002
AC.CLG  ACCL                                                              CRT002
N.ASGL1 NAG1                                                              CRT002
N.ASGL2 NAG2                                                              CRT002
N.ASGL3 NAG3                                                              179321
BADDPT  BDDT                                                              CRT002
BLOCKCR BLCR                                                              CRT002
BLOCKDR BLDR                                                              CRT002
BNKRPT  BKRP                                                              CRT002
BR.DIF  BRDF                                                              CRT002
BR.DIF1 BRD1                                                              190137
BR.DIF2 BRD2                                                              190137
BFBVIC  BVCQ                                                              CRT002
CHQPRES CQPR                                                              CRT002
CHQRNG  CQRN                                                              CRT002
INACTV  INAC                                                              CRT002
INACTV1 INA1                                                              179321
INACTV2 INA2                                                              179321
REFERCR RFCR                                                              CRT002
REFERDR RFDR                                                              CRT002
STOPCHQ STCQ                                                              CRT002
TLIMIT  TLLM                                                              CRT002
N.WKDAY NWKD                                                              CRT002
XRTWARN XRTW                                                              CRT002
TLIMIT1 TLLM                                                              142092
TLIMIT2 TLLM                                                              142092
CLOSED  CLOS                                                              142092
BLOCKED BLOK                                                              142092
NOTZERO NZRO                                                              142092
BR.OFF  BOFF                                                              CRT007
BR.OFF1 BOF1                                                              CRT007
BR.OFF2 BOF2                                                              CRT007
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION                                           CRE019
0000001                                                                                       CRE019
0000010                                                                                       CRE019
0000100                                                                                       CRE019
0001000                                                                                       CRE019
0010000                                                                                       CRE019
0100000                                                                                       CRE019
1000000                                                                                       CRE019
