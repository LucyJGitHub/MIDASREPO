     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE CI communications program')                   *
      *****************************************************************
      *                                                               *
      *  Midas - Retail Module                                        *
      *                                                               *
      *  RE4401 - CI Communications Program                           *
      *                                                               *
      *  Function:  This program will be evoked automatically during  *
      *  (I/C)      Input Cycle by each Cashier job starting at the   *
      *             AS/400.  It will provide the communications link  *
      *             between the Midas system on the AS/400 and        *
      *             remote branch comms controller session (i.e. the  *
      *             teller) by opening a conversation with the reques-*
      *             ter.  This function will receive incoming request *
      *             messages from the remote branch comms controller. *
      *             It will then update the status of the record in   *
      *             the interface's Log File (PF/REPLOGPD) and then   *
      *             ascertain, from the BAI Transaction Types File    *
      *             (PF/SDBAITPD), to which data queue it should send *
      *             the msg for processing by the banking function    *
      *             pgms and send the outgoing comms responses.       *
      *                                                               *
      *  Called By: REC4401 - CI Communications Program Control       *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *                                                               *
      *  Last Amend No. CER059             Date 19Jul10               *
      *  Prev Amend No. CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 222373             Date 23Oct03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CRT005             Date 09Aug01               *
      *                 199373             Date 25Oct01               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 176563             Date 06Feb01               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CRT004             DATE 04MAY00               *
      *                 CDL008             Date 02May00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 175838             Date 02Mar00               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 164948             Date 27Jul99               *
      *                 164946             Date 27Jul99               *
      *                 164271             Date 08Jul99               *
      *                 163862             Date 07Jul99               *
      *                 164273             Date 29Jun99               *
      *                 164275             Date 29Jun99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 141921             Date 03Sep98               *
      *                 CEU025             Date 31Aug98               *
      *                 118528             Date 28May97               *
      *                 122060             Date  3Jul97               *
      *                 124248             Date  7Nov97               *
      *                 120880             Date  6Jun97               *
      *                 120072             Date 05Aug97               *
      *                 119318             Date 05Aug97               *
      *                 117112             Date 22Apr97               *
      *                 CRT003  *CREATE    Date 22JUL96               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  222373 - Parameter Mismatch                                  *
      *  CRT005 - Cashier Enhancement for Cash In Cash Out            *
      *  199373 - Remove check on end of EMU transition.              *
      *  176563 - Modify download to allow Account selection in       *
      *           Cashier. Workaround as Cashier fix not yet provided.*
      *  CRT004 - Cashier Midas TCP/IP interface.                     *
      *             Recompiled over SDBRCHPD Changes                  *
      *  CDL008 - Continuous Linked Settlement (recompile SDBRCHPD)   *
      *  175838 - Correction to call AOGELRR0 and flag only In        *
      *           Currencies within the Transition period.            *
      *  164948 - Fixed rates download downloading Bureau de Change   *
      *           rates (CEU025 on) or spot rates (CEU025 off)        *
      *           instead of fixed rates.                             *
      *  164946 - Fixed rates download (FRAT) looking in wrong place  *
      *           on incoming message for last currency read. Also    *
      *           data was being grouped in blocks of 21 not 20.      *
      *  164271 - Ensure the Teller is unlocked upon exit.            *
      *  163862 - Change subroutine P18 - Fixed Rate Download to check*
      *           the multiply/divide indicator if the bureau de      *
      *           change rates are used.                              *
      *  164273 - Change 'Cashier 8' reference to 'Cashier'           *
      *  164275 - Do not perform implicit KSON for Cashier Version 9. *
      *  141921 - Only use currency file rates for retail rates down- *
      *           load when CRT104 is not switched on. If CRT104 is   *
      *           switched on, use the Bureau de Change rates instead.*
      *  CEU025 - EMU: Midas-Cashier Interface                        *
      *  118528 - Off-line balance hold feature.                      *
      *  122060 - Drafts Issuance.                                    *
      *  124248 - Access Currency File to retrieve No. of Decimal     *
      *           Places for downloading to Cashier                   *
      *  120880 - Store and Forward Function.                         *
      *  120072 - Extend file layouts for Cashier B version.          *
      *  119318 - Send amounts always with a full stop no matter what *
      *           the country specific decimal separator may be.      *
      *  117112 - Cashier Interface.  Several problems corrected.     *
      *  CRT003 - Branch Automation Interface.                        *
      *                                                               *
      *****************************************************************
      /EJECT
     FREPLOGL9IF  E           K        DISK
     F            REPLOGD0                          KRENAMEREPLOGD9
      **  CI Communications Log keyed by Brch, Teller Id, Comms Seq No.
      *
     FREPLOGL0UF  E           K        DISK                      A
      **  CI Communications Log keyed by CI Comms Seq No.
      *
     FTTRNM2L1UF  E           K        DISK
      **  Teller Controls File
      *
     F*REPDRIPDO***E                    DISK                              122060
     FREPDRIPDO   E                    DISK                           UC  122060
      **  CI Draft Issuance Incoming Message
      *
     FACCNTL0 IF  E           K        DISK         KINFSR *PSSR          122060
      **  Account Details Full Account Number                             122060
      *                                                                   122060
     FREPDRIL1UF  E           K        DISK         KINFSR *PSSR      UC  122060
     F            REPDRID0                          KRENAMEREPDRILF       122060
      **  Draft Issuance Incoming Message key Draft No                    122060
      *                                                                   122060
     FSDCURRL0IF  E           K        DISK         KINFSR *PSSR
      **  SD Currency Codes
      *
     FSDNOSTL0IF  E           K        DISK         KINFSR *PSSR
      **  SD Nostro Details
      *
     FSDBRCHL0UF  E           K        DISK         KINFSR *PSSR
      **  SD Branch Details
      *
     FTTRNM2L2IF  E           K        DISK         KINFSR *PSSR
     F            TTRNTM2F                          KRENAMETTRNM2F2
      **  RTS Tellers
      *
     FACNUM   IF  E           K        DISK         KINFSR *PSSR          118528
     F            ACCNTABF                          KRENAMEACNUMF         118528
      **  RE Account Numbers                                              118528
      *                                                                   118528
     FREBDCRPDIF  E           K        DISK         KINFSR *PSSR
      **  RE Bureau de Change Rates Control
      *
     FRE4401CMCF  E                    WORKSTN
     F                                              KNUM        1
     F                                              KINFSR *PSSR
     F                                              KINFDS FEEDBK
     F                                              KID    PGMDEV
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *                  FUNCTION OF INDICATORS                       *
      *                  ----------------------                       *
      *                                                               *
      *       20         End Of File for ICFF/RE4401CM.               *
      *       21         'READ' error on device ICFF/RE4401CM.        *
      *       22         'WRITE' error on device ICFF/RE4401CM.       *
      *       23         'ACQUIRE' error on device ICFF/RE4401CM.     *
      *       25         'RCVFAIL' on ICFF/RE4401CM.                  *
      *       26         'RCVCONFIRM' on ICFF/RE4401CM.               *
      *       27         'DETACH' on ICFF/RE4401CM.                   *
      *                                                               *
      *       30         'CHAIN' fail for LF/TTRNM2L1.                *
      *       31         'CHAIN' fail for LF/ACNUM.                   *   118528
      *       32         SCAN successful.                             *   118528
      *       35         'CHAIN' fail for LF/REPLOGL0.                *
      *                                                               *
      *       60         LOKUP 'equal to' on Device Array (CDV)       *
      *       62         LOKUP 'equal to' on Teller Array (TLR)       *
      *       64         LOKUP 'equal to' on Transaction Type (TXP)   *
      *       67         LOKUP 'equal to' on Msgs Require Ack(MTYP)   *
      *       67         LOKUP 'equal to' on commas in rates          *   119318
      *                                                               *
      *                                                               *
      *       80-89      Standard RTS subroutines                     *
      *                                                               *
      *       90-99      Standard MIDAS subroutines                   *
      *                                                               *
      *       U7+U8      Database error occurs                        *
      *                                                               *
      *****************************************************************
      *                                                               *
      *  S U B R O U T I N E   I N D E X                              *
      *                                                               *
      *  CLOPOS - Postings Received At Branch Closure                 *   118528
      *  COMMSG - Comms Message Processing.                           *
      *  DBERR  - Database Error Handling.                            *
      *  DIMSG  - Draft Issuance Message Processing.                  *
      *  INIT   - Initialisation.                                     *
      *  MESG   - Message Processing.                                 *
      *  MSGVAL - Further Message Validation.                         *
      *  PAD    - Pad field with leading zeros.                       *   118528
      *  P06    - Retrieve System Control Data Routine.               *   118528
      *  P07    - Retrieve System Parameter Codes Routine.            *   118528
      *  P08    - Retrieve Exchange Rates Information.                *   118528
      *  P09    - Retrieve Nostro Account Details Routine.            *   118528
      *  P10    - Retrieve Branch Details Routine.                    *   118528
      *  P11    - Branch Open Routine.                                *   118528
      *  P12    - Branch Close Routine.                               *   118528
      *  P13    - Sign-Off Routine.                                   *   118528
      *  P14    - Sign-On Routine.                                    *   118528
      *  P15    - Retail Rates Routine.                               *   118528
      *  P16    - Alternative Currency Descriptions Routine.          *   118528
      *  P17    - Reversal of Account Balance Hold.                   *   118528
      *  RCVDTQ - Receive Dataqueue Processing.                       *
      *  ROLLBK - Rollback Processing.                                *
      *  RTVMSG - Retrieve Program Message Details.                   *
      *  RVFBDT - Calculate Working Days Backward.                    *   118528
      *  UPDLOG - Update Communications Log.                          *
      *  WRTLOG - Write to Communications Log.                        *
      *  WRTDRI - Write to PF/REPDRIPD.                               *
      *  *PSSR  - Program Error.                                      *
      *                                                               *
      *  Standard MIDAS Subroutines                                   *
      *                                                               *
      *  ZFWDT  -  Calculate Working Days Forward.                    *
      *                                                               *
      *****************************************************************
      /EJECT
      *
     E                    CPY@    1   1 80
      **  Array containing Copyright statement.
      *
     E                    DLY     1   1 13
      *
     E********************MTYP    1  23  4   CONF    1                    CEU025
     E**********          MTYP    1  24  4   CONF    1                                 CEU025 CRT005
     E                    MTYP    1  28  4   CONF    1                                        CRT005
      **  Lookup Table to hold message type and required ACK or NAK.
      *
     E/COPY ZSRSRC,ZDATE9Z1
      *
     E                    CDV       999 10  A
      **  Authorised Devices array.
      *
     E                    TLR       999  3  ATST     3
      **  Authorised Tellers array.
      *
     E                    TBR       999  3  A
      **  Teller's Branch Code array.
      *
     E                    TXP       999 10  ADTL    36
      **  Cashier Interface Transaction Types Array.
      *
      /COPY ZSRSRC,ZDATE2Z1
      *
      /COPY ZSRSRC,ZEDITZ1
      *
      /COPY ZSRSRC,ZHOLE
      *
     E                    NAR     1   2 35
      **  Array containing Retail Rates Description
      *
     E                    RATE       16  1
      **  Array containing field to be padded with leading zeros
      *
     E                    BDY       199  6
      **  Array containing Business Days
      *
     E********************ACY        10189                                CEU025
     E                    AC1        10244                                CEU025
     E                    AC2        10 57                                CEU025
      **  Array containing Outgoing Currency Blocks
      *
     E                    ASP        60  5
      **  Array containing SP Codes
      *
     E                    AOS        60 23
      **  Array containing Outgoing SP Codes
      *
     E                    AN1         4235
      **  Array containing Outgoing Nostro Block 1
      *
     E                    AN2         4197
      **  Array containing Outgoing Nostro Block 2
      *
     E                    ABR        50 39
      **  Array containing Outgoing Branch Block
      *
     E                    AR1        10231
      **  Array containing Outgoing Retail Rates Block 1
      *
     E********************AR2        10 35                                CEU025
     E                    AR2        10 92                                CEU025
      **  Array containing Outgoing Retail Rates Block 2
      *
     E                    ACD        16 76
      **  Array containing Outgoing Alternate Currency Descriptions
      *
     E***********         AFR        21 21                                CEU025              164946
     E                    AFR        20 21                                                    164946
      **  Array containing Fixed Rate Download                            CEU025
      *                                                                   CEU025
      /EJECT
      *
     I/COPY ZSRSRC,ZDATE9Z2
      *
     I            DS
     I*I************'CASHIER 8 '              1  10 W#ICDP                                    164273
     I I            'CASHIER   '              1  10 W#ICDP                                    164273
      *
     I            DS
      **  Data structure to hold string constants for QCMDEXC
      *
     I                                        1  80 @CMD
      *
     IFEEDBK      DS
      **  File Informational Data Structure for error handling (RE4401CM).
      *
     I                                     *STATUS  STATUS
     I                                       38  45 FMTNM
     I                                      261 268 ICFREC
     I                                      273 282 CMID
     I                                    B 372 3750ACTLEN
     I                                      401 404 MAJMIN
     I                                      401 402 MAJCOD
     I                                      403 404 MINCOD
      *
     IPSDS       SDS
      **  Program status data structure.
      *
     I                                     *PROGRAM ZAPGM
     I                                      244 246 WSID
     I                                      245 246 WSID2
     I                                      244 253 WSJOB
     I                                      254 263 USRID
     I                                      264 2690JNUMBR
     I                                      264 269 JOBNUM
      *
     IMSGS        DS
      **  Data structure for message data sent to RBA Dataqueue.
      *
     I                                        1 256 MSGS01
     I                                      257 512 MSGS02
     I                                      513 768 MSGS03
     I                                      7691003 MSGS04
     I                                       15  24 W#JBDQ
     I                                       25  30 W#SEQN
     I                                      113 113 W#FWST                120880
     I                                      358 371 R#TRN1
     I                                      461 474 R#TRN2
     I                                      515 528 R#TRN3
     I                                      529 542 R#TRN4
      *
     IMSGR        DS
      **  Data structure for message data returned on Dataqueue from RBA.
      *
     I                                        1 256 MSGR01
     I                                      257 512 MSGR02
     I                                      513 768 MSGR03
     I                                      7691024 MSGR04
     I                                     10251280 MSGR05
     I                                     12811536 MSGR06
     I                                     15371792 MSGR07
     I                                     17932048 MSGR08
     I                                     20492304 MSGR09
     I                                     23052560 MSGR10
     I                                        1   4 M#MSTY                122060
     I                                       29  29 M#HMSS
     I                                      358 371 M#TRN1
     I                                      461 474 M#TRN2
     I                                      515 528 M#TRN3
     I                                      529 542 M#TRN4
      *
     IFIELDI      DS                           1024
      **  Data structure for message data read from ICF File.
      *
     I                                        1 256 FLDI1
     I                                      257 512 FLDI2
     I                                      513 768 FLDI3
     I                                      7691024 FLDI4
     I                                        1   4 I#MSTY
     I                                        5   8 I#BRNO
     I                                        5   7 W#BRCA
     I                                        9  24 I#USER
     I                                        9  11 W#TELD
     I                                       25 113 I#FLR
     I                                      114 1260I#EQAC
     I                                      127 1290I#TCOD
     I                                      130 132 I#CUR1
     I                                      133 135 I#CUR2
     I                                      136 149 I#FILR
     I                                      140 1500I#TAMT
     I                                      151 156 I#VDAT
     I                                      157 174 I#REFL
     I                                      175 209 I#NLN1
     I                                      210 244 I#NLN2
     I                                      245 279 I#NLN3
     I                                      280 314 I#NLN4
     I                                      315 316 I#SP
     I                                      317 319 I#SPCD
     I                                      315 319 W#TXP
     I                                      478 479 I#SP2
     I                                      480 482 I#SPC2
     I                                      478 482 W#TX2
     I                                      901 913 I#ACNO
      *                                                                   122060
      ** Message Format for Drafts Issuance (also from FIELDI).           122060
      *                                                                   122060
     I                                      114 116 D#ACDE                122060
     I                                      130 135 D#NOST                122060
     I                                      136 138 D#DCCY                122060
     I                                      139 141 D#FCCY                122060
     I                                      142 144 D#TRC1                122060
     I                                      145 147 D#TRC2                122060
     I                                      148 150 D#TXP                 122060
     I                                      151 153 D#TXP2                122060
     I                                      158 1680D#DRAM                122060
     I                                      169 181 D#FDAC                122060
     I                                      186 1960D#FDAM                122060
     I                                      197 212 D#DRNO                122060
     I                                      213 228 D#ODRN                122060
     I                                      233 2430D#DPOS                122060
     I                                      248 2580D#CPOS                122060
     I                                      259 293 D#BENF                122060
     I                                      294 299 D#VDAT                122060
     I                                      300 305 D#TDAT                122060
     I                                      306 319 D#TRF1                122060
     I                                      320 333 D#TRF2                122060
     I                                      334 347 D#TRF3                122060
     I                                      348 361 D#TRF4                122060
     I                                      538 550 D#SPAC                122060
     I                                      551 552 D#SPTC                122060
     I                                      553 553 D#AFAF                122060
     I                                      554 573 D#AFBR                122060
     I                                      557 573 D#AFAN                122060
     I                                      574 574 D#ANAF                122060
     I                                      575 594 D#ANAN                122060
     I                                      578 587 D#NOSA                122060
     I                                      596 598 D#CHCY                122060
     I                                      599 629 D#CHRG                122060
      *
     IFIELDO      DS
      **  Data structure for message data written to ICF File.
      *
     I                                        1 256 FLDO1
     I                                      257 512 FLDO2
     I                                      513 768 FLDO3
     I                                      7691024 FLDO4
     I                                     10251280 FLDO5
     I                                     12811536 FLDO6
     I                                     15371792 FLDO7
     I                                     17932048 FLDO8
     I                                     20492304 FLDO9
     I                                     23052560 FLDO10
      *
     IOSTATD      DS                            111
      **  Data structure for common outgoing message status.
      *
     I                                        1   4 O#MSTY
     I                                        5   7 O#BRCA
     I                                        9  11 O#TELD
     I                                       25  28 O#WKID
     I                                       29  29 O#HMSS
     I                                       30  33 O#HMSI
     I                                       34 111 O#HMSG
      *
     IICPRRD      DS
      **  Incoming CPRR Message
      *
     I                                        1 116 ICPRR
     I**********                             74  76 IRRTYP                CEU025              164946
     I                                      114 116 IRRRTY
      *
     IOCPRRD      DS
      **  Outgoing CPRR Message
      *
     I                                        1 111 OCPRR
     I                                      114 344 ORD01A
     I**************************************345 379 ORD01B                CEU025
     I**************************************380 610 ORD02A                CEU025
     I**************************************611 645 ORD02B                CEU025
     I**************************************646 876 ORD03A                CEU025
     I**************************************877 911 ORD03B                CEU025
     I**************************************9121142 ORD04A                CEU025
     I*************************************11431177 ORD04B                CEU025
     I*************************************11781408 ORD05A                CEU025
     I*************************************14091443 ORD05B                CEU025
     I*************************************14441674 ORD06A                CEU025
     I*************************************16751709 ORD06B                CEU025
     I*************************************17101940 ORD07A                CEU025
     I*************************************19411975 ORD07B                CEU025
     I*************************************19762206 ORD08A                CEU025
     I*************************************22072241 ORD08B                CEU025
     I*************************************22422472 ORD09A                CEU025
     I*************************************24732507 ORD09B                CEU025
     I*************************************25082738 ORD10A                CEU025
     I*************************************27392773 ORD10B                CEU025
     I                                      345 436 ORD01B                CEU025
     I                                      437 667 ORD02A                CEU025
     I                                      668 759 ORD02B                CEU025
     I                                      760 990 ORD03A                CEU025
     I                                      9911082 ORD03B                CEU025
     I                                     10831313 ORD04A                CEU025
     I                                     13141405 ORD04B                CEU025
     I                                     14061636 ORD05A                CEU025
     I                                     16371728 ORD05B                CEU025
     I                                     17291959 ORD06A                CEU025
     I                                     19602051 ORD06B                CEU025
     I                                     20522282 ORD07A                CEU025
     I                                     22832374 ORD07B                CEU025
     I                                     23752605 ORD08A                CEU025
     I                                     26062697 ORD08B                CEU025
     I                                     26982928 ORD09A                CEU025
     I                                     29293020 ORD09B                CEU025
     I                                     30213251 ORD10A                CEU025
     I                                     32523343 ORD10B                CEU025
      *
     IOCPRRB      DS
      **  Outgoing RR Data Block.
      *
     I                                        1 231 ORORS1
     I**************************************232 266 ORORS2                CEU025
     I                                      232 323 ORORS2                CEU025
     I                                        1   3 ORRRTY
     I                                        4  38 ORRRDS
     I                                       39  41 ORCCY
     I                                       42  44 ORCCYN
     I                                       45  79 ORCCYD
     I                                       80  80 OREDCD
     I                                       81  81 ORRCFL
     I                                       82  94 ORBYRT
     I                                       95 107 ORBPRT
     I                                      108 123 ORBPAM
     I                                      124 129 ORBYCM
     I                                      130 137 ORBMDN
     I                                      138 150 ORSLRT
     I                                      151 163 ORSPRT
     I                                      164 179 ORSPAM
     I                                      180 185 ORSLCM
     I                                      186 193 ORSMDN
     I                                      194 228 ORARRD
     I                                      229 231 ORACCY
     I                                      232 266 ORACYD
     I                                      267 280 OREXBR                CEU025
     I                                      281 294 OREBPR                CEU025
     I                                      295 308 OREXSR                CEU025
     I                                      309 322 ORESPR                CEU025
     I                                      323 323 ORMBFL                CEU025
      *
     IICDESD      DS
      **  Incoming CDES Message
      *
     I                                        1 116 ICDES
     I                                      114 116 IDCCY
      *
     IOCDESD      DS
      **  Outgoing CDES message.
      *
     I                                        1 111 OCDES
     I                                      114 189 ODD01
     I                                      190 265 ODD02
     I                                      266 341 ODD03
     I                                      342 417 ODD04
     I                                      418 493 ODD05
     I                                      494 569 ODD06
     I                                      570 645 ODD07
     I                                      646 721 ODD08
     I                                      722 797 ODD09
     I                                      798 873 ODD10
     I                                      874 949 ODD11
     I                                      9501025 ODD12
     I                                     10261101 ODD13
     I                                     11021177 ODD14
     I                                     11781253 ODD15
     I                                     12541329 ODD16
      *
     IOCDESB      DS
      **  Outgoing CDES Data Block.
      *
     I                                        1   3 ODCCY
     I                                        4  38 ODMJCD
     I                                       40  40 ODFRFL
     I                                       41  41 ODNMWD
     I                                       42  76 ODMNCD
      *
     IRICMSG      DS
      **  Incoming Message (for output to LF/REPLOGL0).
      *
     I                                        1 256 LOG01
     I                                      257 512 LOG02
     I                                      513 768 LOG03
     I                                      769 900 LOG04
     I                                        1   4 R#MSTY
     I                                       25  28 R#WKID
     I                                       29  29 R#HMSS
     I                                       30  33 R#HMSI
     I                                       34 111 R#HMSG
      *
     IDTLDS       DS
      **  Break down of Transaction Type Details Array (DTL).
      *
     I                                        1   3 W#TTFC
     I                                        4  13 W#DQNM
     I                                       14  180W#DQLN
     I                                       19  21 W#RVFN
     I                                       22  31 W#RVDQ
     I                                       32  360W#RVDL
      *
     IRUNDT       DS
      **  Rundat data area.
      *
     I                                        1   7 RUNA
     I                                    P   8  100RUND
     I                                       11  11 SSF
     I                                       12  12 DATF
     I                                       13  13 MBIN
      *
     IFTIME       DS                              8
      **  Setup Time.
      *
     I                                        1   2 WFHR
     I I            ':'                       3   3 WFILR1
     I                                        4   5 WFMN
     I I            ':'                       6   6 WFILR2
     I                                        7   8 WFSS
      *
     ITTIME       DS                              6
      *
     I                                        1   2 WTHR
     I                                        3   4 WTMN
     I                                        5   6 WTSS
      *
     IFDATE       DS                              8
      **  Setup Date.
      *
     I                                        1   2 WFDD
     I I            '/'                       3   3 WFILR3
     I                                        4   5 WFMM
     I I            '/'                       6   6 WFILR4
     I                                        7   8 WFYY
      *
     ITDATE       DS                              6
      *
     I                                        1   2 WTDD
     I                                        3   4 WTMM
     I                                        5   6 WTYY
      *
     ICISTAT      DS                              6
      **  CI Status Dataarea.
      *
     I                                        1   60WCSEQN
      *
     ICITFTS    E DSCITFTS                        2                       118528
      ** Data area for Unique Time Stamp                                  118528
      *                                                                   118528
     I                                        1   2 WNNSS                 118528
      *                                                                   118528
     ILDA         DS                            256
      **  Local Data Area to identify database errors.
      *
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I                                      134 183 DBLOT
      *
     I            DS
      **  Data structure to hold key fields of LF/TTRNT for DBKEY in LDA.
      *
     I                                        1   5 @TTRNT
     I                                        1   1 KTBRI
     I                                        2   4 KTBID
     I                                        5   5 KRCTP
      *
     IICDATD      DS
      **  Incoming CDAT Message
      *
     I                                        1 119 ICDAT
     I                                      114 116 ICFBDT
     I                                      117 119 ICLBDT
      *
     IOCDATD      DS
      **  Outgoing CDAT Message
      *
     I                                        1 111 OCDAT
     I                                      114 116 OCFBDT
     I                                      117 119 OCLBDT
     I                                      120 122 OCLCCY
     I                                      123 1240OCPBLN
     I                                      125 1260OCXRTL
     I                                      127 127 OCINSC
     I                                      128 128 OCDCSC
     I                                      133 135 OCDTFM
     I                                      136 387 OCBSD1
     I                                      388 639 OCBSD2
     I                                      640 891 OCBSD3
     I                                      8921143 OCBSD4
     I                                     11421329 OCBSD5
     I                                     13301330 OCCQRF
     I                                     13581358 OCTMPF                176563
     I                                     14201420 OCLCLY
     I                                     14211421 OCLCLN
     I                                     14231457 OCBRNM
     I                                     14581492 OCBRA1
     I                                     14931527 OCBRA2
     I                                     15281562 OCBRA3
     I                                     15631597 OCBRA4
     I                                     15981632 OCBRA5
     I                                     16331633 OCLDBF
     I                                     18441844 OCEACV
     I                                     18451847 OCBCCY
     I                                     18481848 OCHSID
     I                                     18491852 OCBRID
     I                                     18531856 OCRTOF                120072
     I                                     18571860 OCCYOF                120072
     I                                     18611861 OCLCEC                120072
     I                                     18621862 OCERSZ                CEU025
     I                                     18631863 OCAACN                CEU025
      *
     IISPDTD      DS
      **  Incoming SPDT Message
      *
     I                                        1 256 ISPDT1
     I                                      257 419 ISPDT2
     I                                      114 116 IPFBDT
     I                                      117 119 IPLBDT
     I                                      120 374 IPSPP1
     I                                      375 419 IPSPP2
      *
     IOSPDTD      DS
      **  Outgoing SPDT Message
      *
     I                                        1 111 OSPDT1
     I                                      114 366 OSPDT2
     I                                      367 619 OSPDT3
     I                                      620 872 OSPDT4
     I                                      8731125 OSPDT5
     I                                     11261378 OSPDT6
     I                                     13791493 OSPDT7
     I                                      114 136 OPDB01
     I                                      137 159 OPDB02
     I                                      160 182 OPDB03
     I                                      183 205 OPDB04
     I                                      206 228 OPDB05
     I                                      229 251 OPDB06
     I                                      252 274 OPDB07
     I                                      275 297 OPDB08
     I                                      298 320 OPDB09
     I                                      321 343 OPDB10
     I                                      344 366 OPDB11
     I                                      367 389 OPDB12
     I                                      390 412 OPDB13
     I                                      413 435 OPDB14
     I                                      436 458 OPDB15
     I                                      459 481 OPDB16
     I                                      482 504 OPDB17
     I                                      505 527 OPDB18
     I                                      528 550 OPDB19
     I                                      551 573 OPDB20
     I                                      574 596 OPDB21
     I                                      597 619 OPDB22
     I                                      620 642 OPDB23
     I                                      643 665 OPDB24
     I                                      666 688 OPDB25
     I                                      689 711 OPDB26
     I                                      712 734 OPDB27
     I                                      735 757 OPDB28
     I                                      758 780 OPDB29
     I                                      781 803 OPDB30
     I                                      804 826 OPDB31
     I                                      827 849 OPDB32
     I                                      850 872 OPDB33
     I                                      873 895 OPDB34
     I                                      896 918 OPDB35
     I                                      919 941 OPDB36
     I                                      942 964 OPDB37
     I                                      965 987 OPDB38
     I                                      9881010 OPDB39
     I                                     10111033 OPDB40
     I                                     10341056 OPDB41
     I                                     10571079 OPDB42
     I                                     10801102 OPDB43
     I                                     11031125 OPDB44
     I                                     11261148 OPDB45
     I                                     11491171 OPDB46
     I                                     11721194 OPDB47
     I                                     11951217 OPDB48
     I                                     12181240 OPDB49
     I                                     12411263 OPDB50
     I                                     12641286 OPDB51
     I                                     12871309 OPDB52
     I                                     13101332 OPDB53
     I                                     13331355 OPDB54
     I                                     13561378 OPDB55
     I                                     13791401 OPDB56
     I                                     14021424 OPDB57
     I                                     14241447 OPDB58
     I                                     14481470 OPDB59
     I                                     14711493 OPDB60
      *
     IOSPDTB      DS
      **  Outgoing SP Data Block
      *
     I                                        1   5 OPSPPM
     I                                        6   8 OPDRTC
     I                                        9  11 OPOFDL
     I                                       12  14 OPOFDF
     I                                       15  17 OPCRTC
     I                                       18  20 OPOFCL
     I                                       21  23 OPOFCF
      *
     IIBSERD      DS
      **  Incoming BSER Message
      *
     I                                        1 116 IBSER
     I                                      114 116 IXCCY
      *
     IOBSERD      DS
      **  Outgoing BSER Message
      *
     I                                        1 111 OBSER
     I**************************************114 329 OXCB01                CEU025
     I**************************************330 545 OXCB02                CEU025
     I**************************************546 761 OXCB03                CEU025
     I**************************************762 977 OXCB04                CEU025
     I**************************************9781193 OXCB05                CEU025
     I*************************************11941409 OXCB06                CEU025
     I*************************************14101625 OXCB07                CEU025
     I*************************************16261841 OXCB08                CEU025
     I*************************************18422057 OXCB09                CEU025
     I*************************************20582273 OXCB10                CEU025
     I                                      114 357 OXC01A                CEU025
     I                                      358 414 OXC01B                CEU025
     I                                      415 658 OXC02A                CEU025
     I                                      659 715 OXC02B                CEU025
     I                                      716 959 OXC03A                CEU025
     I                                      9601016 OXC03B                CEU025
     I                                     10171260 OXC04A                CEU025
     I                                     12611317 OXC04B                CEU025
     I                                     13181561 OXC05A                CEU025
     I                                     15621618 OXC05B                CEU025
     I                                     16191862 OXC06A                CEU025
     I                                     18631919 OXC06B                CEU025
     I                                     19202163 OXC07A                CEU025
     I                                     21642220 OXC07B                CEU025
     I                                     22212464 OXC08A                CEU025
     I                                     24652521 OXC08B                CEU025
     I                                     25222765 OXC09A                CEU025
     I                                     27662822 OXC09B                CEU025
     I                                     28233066 OXC10A                CEU025
     I                                     30673123 OXC10B                CEU025
      *
     IOBSCYB      DS
      **  Outgoing CCY block
      *
     I                                        1 244 OXOXS1                CEU025
     I                                      245 301 OXOXS2                CEU025
     I                                        1   3 OXCCY
     I                                        4  38 OXCCYD
     I                                       39  39 OXCCYE
     I                                       40  52 OXXRBC
     I                                       53  60 OXMNBC
     I                                       61  66 OXCMBC
     I                                       67  79 OXXRBT
     I                                       80  87 OXMNBT
     I                                       88  93 OXCMBT
     I                                       94 106 OXXRSC
     I                                      107 114 OXMNSC
     I                                      115 120 OXCMSC
     I                                      121 133 OXXRST
     I                                      134 141 OXMNST
     I                                      142 147 OXCMST
     I                                      148 148 OXRCRT
     I                                      149 151 OXCCYN
     I                                      152 154 OXARCY
     I                                      155 189 OXARCD
     I                                      190 202 OXSPRT
     I                                      203 203 OXSRRC
     I                                      204 216 OXUSRT
     I                                      217 230 OXEXBC                CEU025
     I                                      231 244 OXEXBT                CEU025
     I                                      245 258 OXEXSC                CEU025
     I                                      259 272 OXEXST                CEU025
     I                                      273 286 OXEXSR                CEU025
     I                                      287 300 OXEXUR                CEU025
     I                                      301 301 OXMBFL                CEU025
      *
     IINOSTD      DS
      **  Incoming NOST Message
      *
     I                                        1 122 INOST
     I                                      114 116 INCCY
     I                                      117 122 INNSNM
      *
     IONOSTD      DS
      **  Outgoing NOST Message
      *
     I                                        1 111 ONOST
     I                                      114 348 ONNB1A
     I                                      349 545 ONNB1B
     I                                      546 780 ONNB2A
     I                                      781 977 ONNB2B
     I                                      9781212 ONNB3A
     I                                     12131409 ONNB3B
     I                                     14101644 ONNB4A
     I                                     16451841 ONNB4B
      *
     IONONSB      DS
      **  Outgoing Nostro Block
      *
     I                                        1 235 ONONS1
     I                                      236 432 ONONS2
     I                                        1   3 ONCCY
     I                                        4   9 ONNSNM
     I                                       10  44 ONNSDC
     I                                       45  48 ONACBR
     I                                       49  54 ONACCN
     I                                       55  57 ONACSF
     I                                       58  92 ONRED1
     I                                       93 127 ONRED2
     I                                      128 162 ONRED3
     I                                      163 197 ONRED4
     I                                      201 235 ONNSA1
     I                                      236 270 ONNSA2
     I                                      271 305 ONNSA3
     I                                      306 340 ONNSA4
     I                                      341 375 ONNSA5
     I                                      376 410 ONARAB
     I                                      411 412 ONTRFM
     I                                      413 432 ONEXAC
      *
     IIMIDBD      DS
      **  Incoming MIDB Message
      *
     I                                        1 116 IMIDB
     I                                      114 116 IBBRCH
      *
     IOMIDBD      DS
      **  Outgoing MIDB Message
      *
     I                                        1 111 OMIDB1
     I                                      114 347 OMIDB2
     I                                      348 581 OMIDB3
     I                                      582 815 OMIDB4
     I                                      8161049 OMIDB5
     I                                     10501283 OMIDB6
     I                                     12841517 OMIDB7
     I                                     15181751 OMIDB8
     I                                     17521985 OMIDB9
     I                                     19862063 OMID10
     I                                      114 152 OBBB01
     I                                      153 191 OBBB02
     I                                      192 230 OBBB03
     I                                      231 269 OBBB04
     I                                      270 292 OBBB05
     I                                      293 308 OBBB06
     I                                      309 347 OBBB07
     I                                      348 386 OBBB08
     I                                      387 425 OBBB09
     I                                      426 464 OBBB10
     I                                      465 503 OBBB11
     I                                      504 542 OBBB12
     I                                      542 581 OBBB13
     I                                      582 620 OBBB14
     I                                      621 659 OBBB15
     I                                      660 698 OBBB16
     I                                      699 737 OBBB17
     I                                      738 776 OBBB18
     I                                      777 815 OBBB19
     I                                      816 854 OBBB20
     I                                      855 893 OBBB21
     I                                      894 932 OBBB22
     I                                      933 971 OBBB23
     I                                      9721010 OBBB24
     I                                     10491088 OBBB25
     I                                     10891127 OBBB26
     I                                     11281166 OBBB27
     I                                     11671205 OBBB28
     I                                     12061244 OBBB29
     I                                     12451283 OBBB30
     I                                     12841322 OBBB31
     I                                     13231361 OBBB32
     I                                     13621400 OBBB33
     I                                     14011439 OBBB34
     I                                     14401478 OBBB35
     I                                     14791517 OBBB36
     I                                     15181556 OBBB37
     I                                     15571595 OBBB38
     I                                     15961634 OBBB39
     I                                     16351673 OBBB40
     I                                     16741712 OBBB41
     I                                     17131751 OBBB42
     I                                     17521790 OBBB43
     I                                     17911829 OBBB44
     I                                     18301868 OBBB45
     I                                     18691907 OBBB46
     I                                     19081946 OBBB47
     I                                     19471985 OBBB48
     I                                     19862024 OBBB49
     I                                     20252063 OBBB50
      *
     IOBBRBK      DS
      **  Outgoing Branch Block
      *
     I                                        1   3 OBBRCH
     I                                        4  33 OBBRNM
     I                                       34  39 OBINCN
      *
     IIBROPD      DS
      **  Incoming BROP Message
      *
     I                                        1 116 IBROP
      *
     IOBROPD      DS
      **  Outgoing BROP Message
      *
     I                                        1 113 OBROP
      *
     IIBRCLD      DS
      **  Incoming BRCL Message
      *
     I                                        1 116 IBRCL
      *
     IOBRCLD      DS
      **  Outgoing BRCL Message
      *
     I                                        1 113 OBRCL
      *
     IIKSOFD      DS
      **  Incoming KSOF Message
      *
     I                                        1 114 IKSOF
      *
     IOKSOFD      DS
      **  Outgoing KSOF Message
      *
     I                                        1 113 OKSOF
      *
     IIKSOND      DS
      **  Incoming KSON Message
      *
     I                                        1 117 IKSON
      *
     IOKSOND      DS
      **  Outgoing KSON Message
      *
     I                                        1 113 OKSON
      *
     IIRACBD      DS                                                      118528
      **  Incoming RACB Message                                           118528
      *                                                                   118528
     I                                        1 155 IRACB                 118528
     I                                      113 113 IRFWST                118528
     I                                      114 117 IRBRCH                118528
     I                                      118 123 IRCUSN                118528
     I                                      124 126 IRASFX                118528
     I                                      127 146 IRAACN                118528
     I                                      147 147 IRAANF                118528
      *                                                                   118528
     IORACBD      DS                                                      118528
      **  Outgoing RACB Message                                           118528
      *                                                                   118528
     I                                        1 162 ORACB                 118528
     I                                      114 114 ORAVBS                118528
     I                                      115 130 ORAVBL                118528
     I                                      131 146 ORFTBC                118528
     I                                      147 161 ORTMST                118528
     I                                      162 162 ORFBCF                118528
      *                                                                   118528
     IIFRATD      DS                                                      CEU025
      **  Incoming Fixed Rate Download                                    CEU025
      *                                                                   CEU025
     I                                        1 116 IFRAT                 CEU025
     I                                      114 116 IFEUCY                CEU025
      *                                                                   CEU025
     IOFRATD      DS                                                      CEU025
      **  Outgoing Fixed Rate Download                                    CEU025
      *                                                                   CEU025
     I                                        1 111 OFRAT                 CEU025
     I                                      114 134 OFDB01                CEU025
     I                                      135 155 OFDB02                CEU025
     I                                      156 176 OFDB03                CEU025
     I                                      177 197 OFDB04                CEU025
     I                                      198 218 OFDB05                CEU025
     I                                      219 239 OFDB06                CEU025
     I                                      240 260 OFDB07                CEU025
     I                                      261 281 OFDB08                CEU025
     I                                      282 302 OFDB09                CEU025
     I                                      303 323 OFDB10                CEU025
     I                                      324 344 OFDB11                CEU025
     I                                      345 365 OFDB12                CEU025
     I                                      366 386 OFDB13                CEU025
     I                                      387 407 OFDB14                CEU025
     I                                      408 428 OFDB15                CEU025
     I                                      429 449 OFDB16                CEU025
     I                                      450 470 OFDB17                CEU025
     I                                      471 491 OFDB18                CEU025
     I                                      492 512 OFDB19                CEU025
     I                                      513 533 OFDB20                CEU025
     I**********                            534 554 OFDB21                CEU025              164946
      *                                                                   CEU025
     IOFRATB      DS                                                      CEU025
     I                                        1   3 OFFRCY                CEU025
     I                                        4   6 OFGRCY                CEU025
     I                                        7   7 OFRCFL                CEU025
     I                                        8  21 OFFRRT                CEU025
      *                                                                   CEU025
      /COPY ZSRSRC,ZHOLI
      *
     IOMSDT       DS                           2273
      *
     ISCSARD    E DSSCSARDPD
      **  Switchable Features
      *
     ISDBANK    E DSSDBANKPD
      **  Bank Details
      *
     ISDBAII    E DSSDBAIIPD
      **  Cashier Interface ICD Details
      *
     ISDTELD    E DSSDTELDPD
      **  Teller id
      *
     ISDBAIT    E DSSDBAITPD
      **  Transaction types
      *
     ISDBAID    E DSSDBAIDPD
      **  Authorised devices
      *
     ISDBRCH    E DSSDBRCHPD
      **  Branch codes
      *
     ISDCURR    E DSSDCURRPD
      **  Currency Details
      *
     ISDCUST    E DSSDCUSTPD
      **  Customer Details
     I              QQDFAC                          QQDFAX                                    CGL029
      *
     ISDDEAL    E DSSDDEALPD
      **  Dealing ICD
      *
     ISDGELR    E DSSDGELRPD                                              CEU025
      **  Teller id                                                       CEU025
     I              QQACCD                          QQACCX                                    CGL029
      *                                                                   CEU025
     ISDMMOD    E DSSDMMODPD
      **  Midas Modules
      *
     IDSMEMS    E DSMEMOS                                                 118528
      **  Shadow Balances                                                 118528
      *                                                                   118528
     IDSFDY     E DSDSFDY
      **  First DS for access programs, short data structure
      *
     IDSSDY     E DSDSSDY
      **  Second DS for access programs, long data structure
      *
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            MAIN   - Main Control Processing.                  *
      *                                                               *
      * CALLS      COMMSG - Comms Message Processing.                 *
      *            INIT   - Initial Processing.                       *
      *            RCVDTQ - Receive Dataqueue Processing.             *
      *                                                               *
      *****************************************************************
      *
     C                     EXSR INIT
      *
     C           WACTIV    DOWEQ'Y'
      *
      **  Read ICF File if Read Required Flag is set to yes.
      *
     C                     EXSR COMMSG
      *
      **  Receive Data Queue if RCVDTAQ Required Flag is set to yes.
      *
     C           WRCVDQ    IFEQ 'Y'
     C                     EXSR RCVDTQ
     C                     ENDIF
      *
     C                     ENDDO
      *                                                                                       164271
      **  Ensure the Teller is unlocked from TTRNTM2 when exiting.                            164271
      *                                                                                       164271
      **  Restore Branch Code and Teller details.                                             164271
      *                                                                                       164271
     C                     MOVEL@WBRCA    W#BRCA                                              164271
     C                     MOVEL@WTELD    W#TELD                                              164271
      *                                                                                       164271
      **  Sign off teller from Teller Totals and Controls File.                               164271
      *                                                                                       164271
     C                     MOVELW#TELD    KTBID                                               164271
     C           KTTRNT    CHAINTTRNM2L1             30                                       164271
      *                                                                                       164271
     C           *IN30     IFEQ *ON                                                           164271
     C           RECI      ORNE 'D'                                                           164271
      *                                                                                       164271
     C                     MOVEL*BLANKS   @WRK4                                               164271
     C                     MOVEL*BLANKS   @WRK5                                               164271
     C           KTBRI     CAT  KTBID     @WRK4                                               164271
     C           @WRK4     CAT  KRCTP     @WRK5                                               164271
      *                                                                                       164271
     C           *LOCK     IN   LDA                                                           164271
     C                     MOVEL'TTRNM2L1'DBFILE                                              164271
     C                     MOVEL@WRK5     DBKEY                                               164271
     C                     Z-ADD29        DBASE                                               164271
     C                     EXSR DBERR                                                         164271
      *                                                                                       164271
     C                     ELSE                                                               164271
      *                                                                                       164271
     C                     MOVE *BLANKS   TWID                                                164271
     C                     UPDATTTRNTM2F                                                      164271
     C                     ENDIF                                                              164271
      *
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C/EJECT
      *****************************************************************
      *                                                               *
      *            COMMSG - Comms Message Processing.                 *
      *                                                               *
      * CALLS      *PSSR  - Progarm Error.                            *
      *            RTVMSG - Retrieve Program Message Details.         *
      *            WRTLOG - Write to Communications Log.              *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing.                  *
      *                                                               *
      *****************************************************************
     C           COMMSG    BEGSR
      *
      **  Initialise the following workfields.
      *
      **         MSGS             input message data
      **         WTRID            RBA trat id
      **         WIDID            input device id
      *
      **  Reset the receive Data Queue Required Flag.
      *
     C                     MOVEL'N'       WRCVDQ  1
      *
     C                     MOVE *BLANKS   MSGS
     C                     MOVE *BLANKS   WTRID  10
     C                     MOVE *BLANKS   WIDID  10
     C                     MOVE *BLANKS   WMDTA1
     C                     MOVE *BLANKS   WMDTA2
      *
      **  Reset received comms file message field (incoming data).
      *
     C                     MOVE *BLANKS   FIELDI
     C                     MOVE 'N'       WERROR  1
      *
      **  Read ICF file for incoming message data.
      *
     C                     READ DATAIN                 2120
      *
      ** Save Branch Code and Teller details.
      *
     C           W#BRCA    IFNE *BLANKS
     C                     MOVELW#BRCA    @WBRCA  3
     C                     END
     C           W#TELD    IFNE *BLANKS
     C                     MOVELW#TELD    @WTELD  3
     C                     END
      *
     C           *IN27     IFEQ '1'
      *
      **  Restore Branch Code and Teller details.
      *
     C                     MOVEL@WBRCA    W#BRCA
     C                     MOVEL@WTELD    W#TELD
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0060' @MSGID
     C                     MOVELW#TELD    WMDTA1 10
     C                     MOVEL*BLANKS   WMDTA2 10
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'C'       O#HMSS
     C                     MOVE *BLANKS   O#HMSI
      *
     C                     MOVE 'Y'       WCSTAT  1
     C                     MOVE 'CR'      WMSTAT  2
     C                     EXSR WRTLOG
      *
      **  Sign off teller from Teller Totals and Controls File.
      *
     C                     MOVELW#TELD    KTBID
     C           KTTRNT    CHAINTTRNM2L1             30
      *
     C           *IN30     IFEQ *ON
     C           RECI      ORNE 'D'
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0055' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVEL*BLANKS   @WRK4   4
     C                     MOVEL*BLANKS   @WRK5   5
     C           KTBRI     CAT  KTBID     @WRK4
     C           @WRK4     CAT  KRCTP     @WRK5
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'TTRNM2L1'DBFILE
     C                     MOVEL@WRK5     DBKEY
     C                     Z-ADD20        DBASE
     C                     EXSR DBERR
      *
     C                     ELSE
      *
     C                     MOVE *BLANKS   TWID
     C                     UPDATTTRNTM2F
      *
     C                     ENDIF
      *
      *
      **  End the program.
      *
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDIF
      *
     C                     MOVE 'N'       WRLBCK  1
      *
      **  *IN20 indicates no data read from invited devices. (End Of File).
      *
     C           *IN20     IFEQ '1'
      *
     C                     Z-ADD13        LEN    155
     C                     CALL 'QCMDEXC'
     C                     PARM           DLY    13
     C                     PARM           LEN
      *
     C                     ELSE
      *
      **  For Major Code '03' - Input operation completed successfully, but
      **  no data received, go to output section of logic.
      *
     C           MAJMIN    IFEQ '0300'
     C                     WRITEINVITE                 22
     C                     END
     C           MAJMIN    CABEQ'0300'    END#03
     C           MAJMIN    CABEQ'0301'    END#03
      *
      **  If End Of File Read on input. Delay for 1 second then go to
      **  the output section of logic.
      *
     C           STATUS    IFEQ 00011
     C                     Z-ADD13        LEN    155
     C                     CALL 'QCMDEXC'
     C                     PARM           DLY    13
     C                     PARM           LEN
     C                     END
      *
     C           STATUS    CABEQ00011     END#03
      *
      **  If wait time has not been exceeded AND the PC application has not
      **  requested a 'DETACH'.
      *
     C***********STATUS    IFNE 01331                                     117112
     C           STATUS    IFEQ 01331                                     117112
     C           *IN27     ANDEQ'0'
      *
     C                     MOVEL'Y'       WERROR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0053' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM MAJMIN    MMCODE
     C                     PARM *BLANKS   P#BRCA
     C                     PARM           @MSGID
     C                     PARM *BLANKS   @MSGDT
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITESTATO
      *
      **  Sign off teller from Teller Totals and Controls File.
      *
     C                     MOVELW#TELD    KTBID
     C           KTTRNT    CHAINTTRNM2L1             30
      *
     C           *IN30     IFEQ *ON
     C           RECI      ORNE 'D'
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0055' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVEL*BLANKS   @WRK4   4
     C                     MOVEL*BLANKS   @WRK5   5
     C           KTBRI     CAT  KTBID     @WRK4
     C           @WRK4     CAT  KRCTP     @WRK5
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'TTRNM2L1'DBFILE
     C                     MOVEL@WRK5     DBKEY
     C                     Z-ADD22        DBASE
     C                     EXSR DBERR
      *
     C                     ELSE
      *
     C                     MOVE *BLANKS   TWID
     C                     UPDATTTRNTM2F
      *
     C                     ENDIF
      *
      **  End the program.
      *
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ELSE
      *
     C           WERROR    IFEQ 'N'
      *
      **  If the data format from the ICFF/RE4401CM has not been read or
      **  the mesage itself is blank.
      *
     C           ICFREC    IFNE 'DATAIN'
     C           FIELDI    OREQ *BLANKS
      *
     C                     MOVEL'Y'       WERROR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0054' @MSGID
     C                     MOVELICFREC    WMDTA1
     C                     MOVEL'RE4401CM'WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM *BLANKS   P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITESTATO
      *
     C                     ELSE
      *
      ****Check*Interface*ICD*to*see*if*product*is*'CASHIER*8'.******     164273
      **  Check Interface ICD to see if product is 'CASHIER  '.           164273
      *
     C           FUPROD    IFNE W#ICDP
      *
      **  If message from invalid device.
      *
     C                     Z-ADDWCPOS     C
     C           WIDID     LOKUPCDV,C                    60
      *
     C           *IN60     IFEQ '0'
      *
     C                     MOVEL'Y'       WERROR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0001' @MSGID
     C                     MOVELWIDID     WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ENDIF
      *
     C                     ELSE
      *
      ****ie*the*product*is*'CASHIER 8'.                                  164273
      **  ie the product is 'CASHIER  '.                                  164273
      *
     C                     Z-ADD1         E       30
     C           I#MSTY    LOKUPMTYP,E                   67
      *
     C           *IN67     IFEQ '0'
      *
     C                     MOVEL'Y'       WERROR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0066' @MSGID
     C                     MOVELI#MSTY    WMDTA1
     C                     MOVELFUPROD    WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
      ** If a valid message type set the confirmation required flag.
      *
     C                     MOVELCONF,E    CONFRQ  1
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C           WERROR    IFEQ 'N'
      *
      **  If message from invalid teller.
      *
     C                     Z-ADDWAPOS     A
     C           W#TELD    LOKUPTLR,A                    62
      *
     C           *IN62     IFEQ '0'
      *
     C                     MOVEL'Y'       WERROR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0002' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
      **  Teller Valid.
      *
     C                     ELSE
      *
      **  Ensure that the Branch matches the Teller's branch Code (SDTELDPD).
      *
     C           W#BRCA    IFNE TBR,A
      *
     C                     MOVEL'Y'       WERROR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0012' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVELW#BRCA    WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      **  If device and teller are valid, perform further message validation.
      *
     C           WERROR    IFEQ 'N'
      *
      **  Process incoming message depending on message type.
      *
     C                     SELEC
      *
      **  System Control Data.
      *
     C           I#MSTY    WHEQ 'CDAT'
     C                     EXSR P06
      *
      **  System Parameter Code.
      *
     C           I#MSTY    WHEQ 'SPDT'
     C                     EXSR P07
      *
      **  Exchange Rates Information.
      *
     C           I#MSTY    WHEQ 'BSER'
     C                     EXSR P08
      *
      **  Nostro Account Details.
      *
     C           I#MSTY    WHEQ 'NOST'
     C                     EXSR P09
      *
      **  Branch Details.
      *
     C           I#MSTY    WHEQ 'MIDB'
     C                     EXSR P10
      *
      **  Branch Opening.
      *
     C           I#MSTY    WHEQ 'BROP'
     C                     EXSR P11
      *
      **  Branch Closure.
      *
     C           I#MSTY    WHEQ 'BRCL'
     C                     EXSR P12
      *
      **  Sign Off.
      *
     C           I#MSTY    WHEQ 'KSOF'
     C                     EXSR P13
      *
      **  Sign On.
      *
     C           I#MSTY    WHEQ 'KSON'
     C                     EXSR P14
      *
      **  Retail Rates.
      *
     C           I#MSTY    WHEQ 'CPRR'
     C                     EXSR P15
      *
      **  Alternative Currency Descriptions.
      *
     C           I#MSTY    WHEQ 'CDES'
     C                     EXSR P16
      *                                                                   118528
      **  Reversal of Account Balances Hold                               118528
      *                                                                   118528
     C           I#MSTY    WHEQ 'RACB'                                    118528
     C                     EXSR P17                                       118528
      *                                                                   CEU025
      ** Fixed Rate Download                                              CEU025
      *                                                                   CEU025
     C           I#MSTY    WHEQ 'FRAT'                                    CEU025
     C                     EXSR P18                                       CEU025
      *                                                                                       CRT005
      ** Ignore Cashier Transactions for Teller Treasury In, Teller                           CRT005
      ** Treasury Out, Teller Cross In, and Teller Cross Out when CRT005                      CRT005
      ** is not installed                                                                     CRT005
      *                                                                                       CRT005
     C           I#MSTY    WHEQ 'CSOV'                                                        CRT005
     C           CRT005    ANDEQ'N'                                                           CRT005
     C                     EXSR CLOPOS                                                        CRT005
      *                                                                                       CRT005
     C           I#MSTY    WHEQ 'CSIV'                                                        CRT005
     C           CRT005    ANDEQ'N'                                                           CRT005
     C                     EXSR CLOPOS                                                        CRT005
      *                                                                                       CRT005
     C           I#MSTY    WHEQ 'TLIN'                                                        CRT005
     C           CRT005    ANDEQ'N'                                                           CRT005
     C                     EXSR CLOPOS                                                        CRT005
      *                                                                                       CRT005
     C           I#MSTY    WHEQ 'TLOU'                                                        CRT005
     C           CRT005    ANDEQ'N'                                                           CRT005
     C                     EXSR CLOPOS                                                        CRT005
      *
      **  Branch Closure Postings.
      *
     C           W#TXP     WHEQ 'SP101'
     C                     EXSR CLOPOS
      *
     C           W#TXP     WHEQ 'SP250'
     C                     EXSR CLOPOS
      *
     C           W#TXP     WHEQ 'SP251'
     C           CRT005    ANDEQ'N'                                                           CRT005
     C                     EXSR CLOPOS
      *
     C           W#TXP     WHEQ 'SP252'
     C                     EXSR CLOPOS
      *
     C                     OTHER
     C                     EXSR MSGVAL
      *
     C                     ENDSL
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C           END#03    ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            MSGVAL - Further Message Validation.               *
      *                                                               *
      * CALLS      DIMSG  - Draft Issuance Message Processing.        *
      *            MESG   - Message Processing.                       *
      *            RTVMSG - Retrieve Program Message Details.         *
      *            WRTLOG - Write to Communications Log.              *
      *            *PSSR  - Program Error.                            *
      *                                                               *
      * CALLED BY  COMMSG - Comms message Processing.                 *
      *                                                               *
      *****************************************************************
     C           MSGVAL    BEGSR
      *
     C                     MOVELFLDI1     MSGS01
     C                     MOVELFLDI2     MSGS02
     C                     MOVELFLDI3     MSGS03
     C                     MOVELFLDI4     MSGS04
      *
     C                     MOVELWJOBID    W#JBDQ
     C                     MOVEL'N'       W#FWST                          120880
      *
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM W#BRCA    @BRCA
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
      **  Branch not found.
      *
     C           @RTCD     IFNE *BLANKS
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0003' @MSGID
     C                     MOVELW#BRCA    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO
      *
     C                     ELSE
      *
      **  Branch is found but not open.
      *
     C           A8BRST    IFNE 'O'
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0004' @MSGID
     C                     MOVELW#BRCA    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO
      *
     C                     ELSE
      *
      **  Transaction processed requires an internal system parameter.
      *
     C                     SELEC
      *
     C           I#MSTY    WHEQ 'CQRH'
     C                     MOVEL'SP910'   W#TXP
      *
     C           I#MSTY    WHEQ 'CQDS'
     C                     MOVEL'SP911'   W#TXP
      *
     C           I#MSTY    WHEQ 'CSCD'
     C                     MOVEL'SP920'   W#TXP
      *
     C           I#MSTY    WHEQ 'CSAD'
     C                     MOVEL'SP921'   W#TXP
      *
     C           I#MSTY    WHEQ 'CSDM'
     C                     MOVEL'SP922'   W#TXP
      *
     C           I#MSTY    WHEQ 'CSCW'
     C                     MOVEL'SP923'   W#TXP
      *
     C           I#MSTY    WHEQ 'CSAW'
     C                     MOVEL'SP924'   W#TXP
      *
     C           I#MSTY    WHEQ 'CSDE'
     C                     MOVEL'SP925'   W#TXP
      *
     C           I#MSTY    WHEQ 'CSRV'
     C                     MOVEL'SP926'   W#TXP
      *
     C           I#MSTY    WHEQ 'PBCV'
     C                     MOVEL'SP930'   W#TXP
      *
     C           I#MSTY    WHEQ 'PBLN'
     C                     MOVEL'SP931'   W#TXP
      *
     C           I#MSTY    WHEQ 'RACB'
     C                     MOVEL'SP958'   W#TXP
      *
     C           I#MSTY    WHEQ 'CBRQ'
     C                     MOVEL'SP960'   W#TXP
      *
     C           I#MSTY    WHEQ 'EQUI'
     C                     MOVEL'SP961'   W#TXP
      *
     C                     ENDSL
      *
      **  If teller status flag array element is off.
      *
     C           TST,A     IFEQ 'OFF'
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0007' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITESTATO
      *
      **  If teller status flag array element is on.
      *
     C                     ELSE
      *
      **  If the message received has an invalid transaction type.
      *
     C                     MOVELW#TXP     W#TX10 10
      *
      **  For DIRQ msg, use SP code 1 unless this is blank else use SP code 2.
      *
     C                     MOVEL*BLANKS   W#WRK5  5                       122060
      *                                                                   122060
     C           I#MSTY    IFEQ 'DIRQ'
     C***********I#SPCD    ANDEQ*BLANK
     C***********          MOVELW#TX2     W#TX10
     C                     MOVEL'SP'      W#WRK5                          122060
     C                     MOVE D#TXP     W#WRK5                          122060
     C                     MOVELW#WRK5    W#TX10                          122060
     C                     ENDIF
      *
     C                     Z-ADDWBPOS     B
      *                                                                                       CRT005
      ** Set On *IN64 if Message Type is 'CSOV', 'CSIV', 'TLIN', or                           CRT005
      ** 'TLOU'; otherwise, look up on table TXP                                              CRT005
      *                                                                                       CRT005
     C           I#MSTY    IFEQ 'CSOV'                                                        CRT005
     C           I#MSTY    OREQ 'CSIV'                                                        CRT005
     C           I#MSTY    OREQ 'TLIN'                                                        CRT005
     C           I#MSTY    OREQ 'TLOU'                                                        CRT005
     C                     MOVE *ON       *IN64                                               CRT005
     C                     ELSE                                                               CRT005
     C           W#TX10    LOKUPTXP,B                    64
     C                     ENDIF                                                              CRT005
      *                                                                                       CRT005
      ** Populate data structure DTLDS when CRT005 is installed                               CRT005
      *                                                                                       CRT005
     C           *IN64     IFEQ *ON                                                           CRT005
     C           I#MSTY    IFEQ 'CSOV'                                                        CRT005
     C           I#MSTY    OREQ 'CSIV'                                                        CRT005
     C           I#MSTY    OREQ 'TLIN'                                                        CRT005
     C           I#MSTY    OREQ 'TLOU'                                                        CRT005
     C           W#TX10    OREQ 'SP251'                                                       CRT005
      *                                                                                       CRT005
     C                     CLEARDTLDS                                                         CRT005
     C                     MOVEL'RE4122'  W#DQNM                                              CRT005
     C                     MOVEL'RE4122'  W#RVDQ                                              CRT005
     C                     Z-ADD1004      W#DQLN                                              CRT005
     C                     Z-ADD1004      W#RVDL                                              CRT005
      *                                                                                       CRT005
     C                     SELEC                                                              CRT005
      *                                                                                       CRT005
     C           I#MSTY    WHEQ 'CSIV'                                                        CRT005
     C           W#TX10    OREQ 'SP251'                                                       CRT005
     C           I#TCOD    ANDGE500                                                           CRT005
     C           I#TCOD    ANDLE999                                                           CRT005
     C                     MOVE '0JE '    W#DQNM                                              CRT005
     C                     MOVE '0JF '    W#RVDQ                                              CRT005
      *                                                                                       CRT005
     C           I#MSTY    WHEQ 'CSOV'                                                        CRT005
     C           W#TX10    OREQ 'SP251'                                                       CRT005
     C           I#TCOD    ANDGE0                                                             CRT005
     C           I#TCOD    ANDLE499                                                           CRT005
     C                     MOVE '0JF '    W#DQNM                                              CRT005
     C                     MOVE '0JE '    W#RVDQ                                              CRT005
      *                                                                                       CRT005
     C           I#MSTY    WHEQ 'TLIN'                                                        CRT005
     C                     MOVE '00E '    W#DQNM                                              CRT005
     C                     MOVE '00F '    W#RVDQ                                              CRT005
      *                                                                                       CRT005
     C           I#MSTY    WHEQ 'TLOU'                                                        CRT005
     C                     MOVE '00F '    W#DQNM                                              CRT005
     C                     MOVE '00E '    W#RVDQ                                              CRT005
      *                                                                                       CRT005
     C                     ENDSL                                                              CRT005
      *                                                                                       CRT005
     C                     ENDIF                                                              CRT005
     C                     ENDIF                                                              CRT005
      *
     C           *IN64     IFEQ '0'
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0008' @MSGID
     C                     MOVELW#TX10    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
      **  Set up LDA DBERR.
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'TTRNM2L1'DBFILE
     C                     MOVEL@TTRNT    DBKEY
     C                     Z-ADD21        DBASE
     C                     EXSR DBERR
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITESTATO
      *
      **  If the message received has a valid transaction type.
      *
     C                     ELSE
      *
     C           I#MSTY    IFNE 'CSOV'                                                        CRT005
     C           I#MSTY    ANDNE'CSIV'                                                        CRT005
     C           I#MSTY    ANDNE'TLIN'                                                        CRT005
     C           I#MSTY    ANDNE'TLOU'                                                        CRT005
     C           W#TX10    ANDNE'SP251'                                                       CRT005
     C                     MOVELDTL,B     DTLDS
     C                     ENDIF                                                              CRT005
      *
     C                     MOVE 'L'       WCSTAT
     C                     MOVE 'CR'      WMSTAT
      *
     C                     SELEC
      *
     C           I#MSTY    WHEQ 'DIRQ'
     C                     EXSR DIMSG
      *
     C                     OTHER
     C                     EXSR MESG
      *
     C                     ENDSL
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF                                            -off
      *
     C                     ENDIF                                            -off
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            DIMSG  - Draft Issuance Message Processing.        *
      *                                                               *
      * CALLS      WRTDRI - Write to PF/REPDRIPD.                     *
      *            WRTLOG - Write to Communications Log.              *
      *                                                               *
      * CALLED BY  MSGVAL - Further Message Validation.               *
      *                                                               *
      *****************************************************************
     C           DIMSG     BEGSR
      *
     C                     OPEN REPDRIL1                                  122060
      *                                                                   122060
     C                     Z-ADD553       LENR                            122060
      *                                                                   122060
     C                     MOVELD#DRNO    KDRNO                           122060
     C                     MOVEL*BLANKS   KODRN                           122060
     C                     MOVELD#ACDE    KACDE                           122060
     C           KLPDRI    CHAINREPDRIL1            N24                   122060
      *                                                                   122060
     C           *IN24     IFEQ '1'                                       122060
      *                                                                   122060
     C                     CLOSEREPDRIL1                                  122060
      *                                                                   122060
     C                     MOVEL'C'       O#HMSS
     C                     MOVE *BLANKS   O#HMSI
     C                     MOVELFIELDI    O#HMSG
      *
     C                     EXSR WRTLOG
     C                     EXSR WRTDRI
      *
     C                     MOVEL'Y'       WRCVDQ                          122060
     C                     ENDIF                                          122060
      *                                                                   122060
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            MESG   - Message Processing.                       *
      *                                                               *
      * CALLS      WRTLOG - Write to Communications Log.              *
      *                                                               *
      * CALLED BY  MSGVAL - Further Message Validation.               *
      *                                                               *
      *****************************************************************
     C           MESG      BEGSR
      *
      **  Retrieve details from array DTL.
      *
     C           WRLBCK    IFEQ 'N'
      *
     C           I#MSTY    IFEQ 'RVSE'
      *
     C                     MOVE W#RVDQ    WTRID
     C                     Z-ADDW#RVDL    WDQLEN
      *
     C                     ELSE
      *
     C                     MOVE W#DQNM    WTRID
     C                     Z-ADDW#DQLN    WDQLEN  50
      *
     C                     ENDIF
      *
     C                     ELSE
      *
     C                     MOVE W#RVDQ    WTRID
     C                     Z-ADDW#RVDL    WDQLEN
      *
     C                     ENDIF
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVE *BLANKS   O#HMSI
     C                     MOVELFIELDI    O#HMSG
      *
     C                     EXSR WRTLOG
      *
     C                     MOVE 'N'       WDQROL  1
      *
      **  Set appropriate values for data queue send.
      *
     C                     MOVELWTRID     DTAQS
     C                     MOVEL'*LIBL'   LIBS
     C                     Z-ADDWDQLEN    LENS
     C                     CALL 'QSNDDTAQ'DTQSND
      *
      **  Set Receive Data Queue required Flag.
      *
     C                     MOVEL'Y'       WRCVDQ
     C                     Z-ADD2560      LENR                            122060
     C                     MOVELWJOBID    DTAQR                           122060
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            WRTLOG - Write to Communications Log.              *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  COMMSG - Comms Message Processing.                 *
      *            DIMSG  - Draft Issuance Message Processing.        *
      *            MESG   - Message Processing.                       *
      *            MSGVAL - Further Message Validation.               *
      *                                                               *
      *****************************************************************
     C           WRTLOG    BEGSR
      *
      **  Update DTAARA/CISTAT.
      *
     C           *LOCK     IN   CISTAT
     C                     ADD  1         WCSEQN
     C                     OUT  CISTAT
      *
     C                     TIME           WTMDAT 120
     C                     MOVE WTMDAT    TDATE
     C                     MOVELWTMDAT    TTIME
      *
     C                     MOVE WTHR      WFHR
     C                     MOVE WTMN      WFMN
     C                     MOVE WTSS      WFSS
     C                     MOVE WTDD      WFDD
     C                     MOVE WTMM      WFMM
     C                     MOVE WTYY      WFYY
      *
     C                     MOVELWCSEQN    RICMSQ
     C                     MOVELW#BRCA    RIBRCA
     C                     MOVELWTRID     RIDTQN
     C                     MOVELWIDID     RIRMDN
     C                     MOVELW#TELD    RITELD
     C           I#MSTY    IFNE 'DIRQ'                                    122060
     C                     MOVELW#TXP     RITXTP
     C                     ELSE                                           122060
     C           'SP'      CAT  D#TXP     RITXTP                          122060
     C                     ENDIF                                          122060
      *
      **  Load the Received Date & Time Stamps
      *
     C                     MOVE FDATE     RIRCDT
     C                     MOVE FTIME     RIRCTM
      *
      **  Load the Successful Completion flag
      *
     C                     MOVELWCSTAT    RISUCM
      *
      **  Load the Status & Status Time Stamp
      *
     C                     MOVELWMSTAT    RISTAT
     C                     MOVE FTIME     RISTTM
      *
      **  Load the 'RICMSG' field
      *
     C                     MOVELFLDI1     LOG01
     C                     MOVELFLDI2     LOG02
     C                     MOVELFLDI3     LOG03
     C                     MOVELFLDI4     LOG04
      *
     C                     MOVELI#MSTY    R#MSTY
     C                     MOVE I#USER    R#WKID
     C                     MOVELO#HMSG    R#HMSG
     C                     MOVE O#HMSS    R#HMSS
     C                     MOVE O#HMSI    R#HMSI
      *
     C                     MOVELWCSEQN    W#SEQN
      *
      **  Write to the Comms Log File.
      *
     C                     WRITEREPLOGD0
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            WRTDRI - Write to PF/REPDRIPD.                     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  DIMSG  - Draft Issuance Message Processing.        *
      *                                                               *
      *****************************************************************
     C           WRTDRI    BEGSR
      *
     C                     OPEN REPDRIPD                                  122060
      *                                                                   122060
     C                     MOVE *BLANKS   RNIMMR
     C                     MOVE *BLANKS   RNSTAT
      *
      **  Map fields from Draft Issue Request Message to fields in PF/REPDRIPD.
      *
     C                     MOVELI#MSTY    RNMSTY
     C                     MOVELW#BRCA    RNBRNO
     C                     MOVELI#USER    RNUSID
     C***********          MOVELI#ACNO    RNNOSA                          122060
     C***********          MOVELI#CUR1    RNDCCY                          122060
     C***********          MOVELI#CUR2    RNFCCY                          122060
     C***********          MOVELI#SPCD    RNSPC1                          122060
     C***********          MOVELI#SPC2    RNSPC2                          122060
     C***********          Z-ADDI#TAMT    RNDRAM                          122060
     C***********          MOVELI#VDAT    RNVDAT                          122060
      *                                                                   122060
     C                     MOVEL'D'       RNRECI                          122060
     C                     MOVELW#FWST    RNFWST                          122060
     C                     MOVELD#ACDE    RNACDE                          122060
     C                     MOVELD#NOSA    RNNOSA                          122060
     C                     MOVELD#NOST    RNNOST                          122060
     C                     MOVELD#DCCY    RNDCCY                          122060
     C                     MOVELD#FCCY    RNFCCY                          122060
     C                     MOVELD#TRC1    RNTRC1                          122060
     C                     MOVELD#TRC2    RNTRC2                          122060
     C                     MOVELD#TXP     RNSPC1                          122060
     C                     MOVELD#TXP2    RNSPC2                          122060
     C                     Z-ADDD#DRAM    RNDRAM                          122060
     C                     MOVELD#AFAN    RNFDAC                          122060
     C                     Z-ADDD#FDAM    RNFDAM                          122060
     C                     MOVELD#DRNO    RNDRNO                          122060
     C                     MOVELD#ODRN    RNODRN                          122060
     C                     Z-ADDD#DPOS    RNDPOS                          122060
     C                     Z-ADDD#CPOS    RNCPOS                          122060
     C                     MOVELD#BENF    RNBENF                          122060
     C                     MOVELD#VDAT    RNVDAT                          122060
     C                     MOVELD#TDAT    RNTDAT                          122060
     C                     MOVELD#TRF1    RNTRF1                          122060
     C                     MOVELD#TRF2    RNTRF2                          122060
     C                     MOVELD#TRF3    RNTRF3                          122060
     C                     MOVELD#TRF4    RNTRF4                          122060
     C                     MOVELD#SPAC    RNSPAC                          122060
     C                     MOVELD#SPTC    RNSPTC                          122060
     C                     MOVELD#AFAF    RNAFAF                          122060
     C                     MOVELD#AFAN    RNAFAN                          122060
     C                     MOVELD#ANAF    RNANAF                          122060
     C                     MOVELD#ANAN    RNANAN                          122060
     C                     MOVELWJOBID    RNCJDQ                          122060
     C                     MOVELD#CHCY    RNCHCY                          122060
      *                                                                   122060
     C                     CALL 'AOCURRR0'                                122060
     C                     PARM '*BLANK ' @RTCD   7                       122060
     C                     PARM '*KEY   ' @OPTN   7                       122060
     C                     PARM           D#CHCY                          122060
     C           SDCURR    PARM SDCURR    DSSDY                           122060
      *                                                                   122060
     C           @RTCD     IFEQ *BLANK                                    122060
     C                     MOVELA6NBDP    ZADEC                           122060
     C           15        SUB  ZADEC     ZADIG                           122060
     C                     ENDIF                                          122060
      *                                                                   122060
     C                     MOVELD#CHRG    ZFIELD                          122060
     C                     EXSR ZALIGN                                    122060
      *                                                                   122060
     C           *IN99     IFEQ '0'                                       122060
     C           ZFIELD    ANDNE*ZERO                                     122060
     C                     MOVE ZFIELD    RNCHAM                          122060
     C                     ENDIF                                          122060
      *
     C                     WRITEREPDRID0
      *
     C                     CLOSEREPDRIPD                                  122060
      *                                                                   122060
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            RCVDTQ - Receive Dataqueue Processing.             *
      *                                                               *
      * CALLS      ROLLBK - Rollback Processing.                      *
      *            RTVMSG - Retrieve Program Message Details.         *
      *            UPDLOG - Update Communications Log.                *
      *            *PSSR  - Program Error.                            *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing.                  *
      *                                                               *
      *****************************************************************
     C           RCVDTQ    BEGSR
      ***********                                                         122060
      ****Set*up*Data*Queue*Length*parm*for*receive*data*queue*(from*RBA).122060
      ***********                                                         122060
     C***********          Z-ADD2560      LENR                            122060
      *
     C                     CALL 'QRCVDTAQ'DTQRCV
      *
      **  If dataqueue is not empty.
      *
     C           LENR      IFGT 0
      *
      **  Set ICF File Read required Flag.
      *
     C                     MOVEL'Y'       WRDICF
      *
     C                     MOVELMSGR01    FLDO1
     C                     MOVELMSGR02    FLDO2
     C                     MOVELMSGR03    FLDO3
     C                     MOVELMSGR04    FLDO4
     C                     MOVELMSGR05    FLDO5
     C                     MOVELMSGR06    FLDO6
     C                     MOVELMSGR07    FLDO7
     C                     MOVELMSGR08    FLDO8
     C                     MOVELMSGR09    FLDO9
     C                     MOVELMSGR10    FLDO10
      *
      **  If dataqueue message is not due to rollback processing.
      *
     C           WRLBCK    IFNE 'Y'
      *
      **  Determine if received message requires a confirmation.
      *
     C           CONFRQ    IFEQ 'Y'
     C           M#HMSS    ANDEQ'C'
     C           CONFRQ    OREQ 'Y'
     C           M#HMSS    ANDEQ'W'
     C                     WRITEOUTACK                 22
      *
      **  If Confirm not received from the remote branch controller,
      **  retrieve error message data to send in host message.
      *
     C           MAJMIN    IFNE '0001'
      *
     C                     MOVEL'USR0058' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM MAJMIN    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM *BLANKS   @MSGDT
      *
     C                     EXSR ROLLBK
      *
     C                     ELSE
      *
      **  If PC application has sent a confirm.
      *
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR UPDLOG
     C                     END
      *
      ** If No acknowledgement required
     C                     ELSE
     C                     WRITEOUTNAK                 22
      *
      **  If DEVICE ERROR or any other error encountered on the WRITE.
     C           *IN22     IFEQ *ON
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0056' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM MAJMIN    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR UPDLOG
      *
     C                     WRITESTATO
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
     C                     ENDIF
      *
     C           M#HMSS    IFEQ 'E'                                       122060
     C           M#MSTY    ANDEQ'DIRQ'                                    122060
     C                     EXSR ROLLBK                                    122060
     C                     ENDIF                                          122060
      *                                                                   122060
     C                     ENDIF
      *
     C                     ELSE
      *
     C                     MOVE 'R'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR UPDLOG
     C                     END
      *
     C                     ELSE
      *
      **  Set ICF File Read required Flag.
      *
     C                     MOVEL'N'       WRDICF
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      /COPY ZSRSRC,RBRMSGC1
     C*****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            ROLLBK - Rollback Processing.                      *
      *                                                               *
      * CALLS      UPDLOG - Update Communications Log.                *
      *                                                               *
      * CALLED BY  RCVDTQ - Receive Dataqueue Processing.             *
      *                                                               *
      *****************************************************************
     C           ROLLBK    BEGSR
      *                                                                   122060
     C           I#MSTY    IFNE 'DIRQ'                                    122060
      *
      **  Access LF/REPLOGL9 to retrieve last record for this teller.
      *
     C                     MOVELW#BRCA    @BRCA
     C                     MOVELW#TELD    @TELD
     C           KLLOG9    SETGTREPLOGL9             70
      *
      **  Check that neither BRCA not TELD are different from those in the
      **  partial key. If so we have gone past our required teller.
      *
     C                     REDPEREPLOGL9                 70
      *
      **  Chain to REPLOGL0 to do the update to show that it has been rolled
      **  back (or perhaps write a new record in REPLOGPD).
      *
      ** Set the ROLLBACK flag.
      *
     C                     MOVE 'Y'       WRLBCK
      *
     C                     MOVE 'Y'       WDQROL
      *
     C                     MOVE 'L'       WCSTAT
     C                     MOVE 'CR'      WMSTAT
      *
     C                     MOVE W#RVDQ    WTRID
      *
     C                     EXSR WRTLOG
      *
     C                     MOVE W#RVDQ    DTAQS
     C                     Z-ADDW#RVDL    LENS
      *
      **  Set transaction reference fields for Reversal
      *
     C                     MOVELM#TRN1    R#TRN1
     C                     MOVELM#TRN2    R#TRN2
     C                     MOVELM#TRN3    R#TRN3
     C                     MOVELM#TRN4    R#TRN4
      *
     C                     CALL 'QSNDDTAQ'DTQSND
      *
      **  Set up Data Queue Length parm for receive data queue (from RBA).
      *
     C                     Z-ADD2560      LENR
      *
     C                     CALL 'QRCVDTAQ'DTQRCV
      *
     C                     ELSE                                           122060
      *                                                                   122060
     C                     OPEN REPDRIL1                                  122060
      *                                                                   122060
     C                     MOVELD#DRNO    KDRNO                           122060
     C                     MOVEL*BLANKS   KODRN                           122060
     C                     MOVELD#ACDE    KACDE                           122060
     C           KLPDRI    CHAINREPDRIL1            N24                   122060
      *                                                                   122060
     C           *IN24     IFEQ '0'                                       122060
     C                     MOVEL'*'       RNRECI                          122060
     C                     UPDATREPDRILF                                  122060
     C                     ENDIF                                          122060
      *                                                                   122060
     C                     CLOSEREPDRIL1                                  122060
      *                                                                   122060
     C                     ENDIF                                          122060
      *                                                                   122060
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            CLOPOS - Postings Received At Branch Closure       *
      *                                                               *
      * CALLS      RTVMSG - Retrieve Program Message Details.         *
      *            UPDLOG - Update Communications Log.                *
      *                                                               *
      * CALLED BY  COMMSG - Comms Message Processing.                 *
      *                                                               *
      *****************************************************************
     C           CLOPOS    BEGSR
      *
      **  Ignore these messages as Midas has no use for these Equation
      **  based messages. Midas has already received or will generate this
      **  information itself. Just answer the messages. As they are 'OITM'
      **  message types they require a confirmation to be used.
      *
     C                     WRITEOUTACK                 22
      *
      **  If Confirm not received from the remote branch controller,
      **  retrieve error message data to send in host message.
      *
     C           MAJMIN    IFNE '0001'
      *
     C                     MOVEL'USR0058' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM MAJMIN    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM *BLANKS   @MSGDT
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            INIT   - Initial Processing.                       *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling.                  *
      *            ZDATE9 - Cvt day nbr to date format YYYYMMDD.      *
      *            *PSSR  - Program Error.                            *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing.                  *
      *                                                               *
      *****************************************************************
     C           INIT      BEGSR
      *
     C                     MOVEACPY@      BIS@   80
      *
      **  Define Keylist(s).
      **  Set up key list for LF/TTRNM2L1.
      *
     C           KTTRNT    KLIST
     C                     KFLD           KTBRI   1
     C                     KFLD           KTBID   3
     C                     KFLD           KRCTP   1
      *
      **  Set up parameters for key list KTTRNT.
      *
     C                     MOVEL'T'       KTBRI
     C                     MOVEL*BLANKS   KTBID
     C                     MOVEL'1'       KRCTP
      *
      **  Set up partial key list for Communications Log File LF/REPLOGL9.
      *
     C           KLLOG9    KLIST
     C                     KFLD           @BRCA   3
     C                     KFLD           @TELD  10
      *
      **  Set up key list for nostro file SDNOSTL0.
      *
     C           KNOST     KLIST
     C                     KFLD           WNSC    3
     C                     KFLD           WNSN    2
      *                                                                   122060
      **  Set up key list for accounts file ACCNTL0.                      122060
      *                                                                   122060
     C           KACNT     KLIST                                          122060
     C**********           KFLD           KCUST   60                                   122060 CSD027
     C                     KFLD           KCUST   6                                           CSD027
     C                     KFLD           KCCY    3                       122060
     C**********           KFLD           KACOD   40                                   122060 CGL029
     C                     KFLD           KACOD  100                                          CGL029
     C                     KFLD           KACSQ   20                      122060
     C                     KFLD           KBRCD   3                       122060
      *                                                                   122060
      **  Set up key list for Drafs Incoming Msg REPDRIL1.                122060
      *                                                                   122060
     C           KLPDRI    KLIST                                          122060
     C                     KFLD           KDRNO  16                       122060
     C                     KFLD           KODRN  16                       122060
     C                     KFLD           KACDE   3                       122060
      *
      **  Clear DB ERROR information in LDA.
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVEL*BLANK    DBLOT
     C                     OUT  LDA
      *                                                                   118528
      **  Clear Trickle Feed Time Stamp.                                  118528
      *                                                                   118528
     C           *NAMVAR   DEFN           CITFTS                          118528
     C           *LOCK     IN   CITFTS                                    118528
     C                     MOVEL*BLANK    WNNSS                           118528
     C                     OUT  CITFTS                                    118528
      *
     C                     CALL 'SF0410'
     C                     PARM *BLANKS   PGRP   50
     C                     PARM USRID     PUSR   25
     C                     PARM *ZEROS    PLVL    40
     C                     PARM *ZEROS    PTIM    50
     C                     PARM *ZEROS    PERR    10
     C                     PARM *BLANKS   PMLT    2
      *
     C           PMLT      IFEQ *BLANK
     C                     MOVEL'GB'      PMLT
     C                     ENDIF
      *
     C           PMLT      CAT  'CIMSGF'  @MSGF
      *
     C                     Z-ADD0         DBASE
      *
      **  Define DTAARA/CISTAT.
      *
     C           *NAMVAR   DEFN           CISTAT
      *
     C           'CASH'    CAT  JOBNUM    WJOBID 10
      *
      **  Set Session Active Flag.
      *
     C                     MOVEL'Y'       WACTIV
      *
      **  Define Parmlist(s).
      **  Parameters for QRCVDTAQ (From RBA).
      *
     C           DTQRCV    PLIST
     C                     PARM           DTAQR
     C                     PARM           LIBR
     C                     PARM           LENR
     C                     PARM           MSGR
     C                     PARM           WAITR
      *
      **  Parameters for QSNDDTAQ (To RBA).
      *
     C           DTQSND    PLIST
     C                     PARM           DTAQS
     C                     PARM           LIBS
     C                     PARM           LENS
     C                     PARM           MSGS
      *
      **  Set up parameters for receive data queue (from RBA).
      *
     C                     MOVELWJOBID    DTAQR  10
     C                     MOVEL'*LIBL'   LIBR   10
     C***********          Z-ADD1714      LENR    50                      122060
     C                     Z-ADD2560      LENR    50                      122060
     C                     Z-ADD-1        WAITR   50
      *
      **  Set up parameters for send data queue (to RBA).
      *
     C                     MOVEL*BLANKS   DTAQS  10
     C                     MOVEL'*LIBL'   LIBS   10
     C                     MOVEL*BLANKS   LENS    50
      *
      **  Check if CRT104 if On.
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*VERIFY' @OPTN   7
     C                     PARM 'CRT104'  @SARD   6
     C           SCSARD    PARM SCSARD    DSFDY
      *
     C           @RTCD     IFEQ *BLANKS
     C                     MOVEL'Y'       CRT104  1
     C                     ELSE
     C                     MOVEL'N'       CRT104
     C                     ENDIF
      *
     C                     MOVEL'CIPGMD'  PGMDEV
      *
      **  Issue acquire operation.
      *
     C           PGMDEV    ACQ  RE4401CM               23
      *
      **  Unrecoverable error for "ACQ"  -> database error.
      *
     C           *IN23     IFEQ '1'
     C           MAJCOD    ORGE '80'
      *
      **  Report error.
      *
     C                     MOVEL'USR0050' @MSGID
     C                     MOVELPGMDEV    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM MAJMIN    MMCODE
     C                     PARM *BLANKS   P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CR'      WMSTAT
     C                     EXSR WRTLOG
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     EXSR *PSSR
      *
     C                     END
      *                                                                   CEU025
      ** Check if CEU025 is On.                                           CEU025
      *                                                                   CEU025
     C                     CALL 'AOSARDR0'                                CEU025
     C                     PARM *BLANKS   @RTCD                           CEU025
     C                     PARM '*VERIFY' @OPTN                           CEU025
     C                     PARM 'CEU025'  @SARD                           CEU025
     C           SCSARD    PARM SCSARD    DSFDY                           CEU025
      *                                                                   CEU025
      **  Report error.                                                   CEU025
     C           @RTCD     IFNE *BLANKS                                   CEU025
     C                     MOVEL'N'       CEU025  1                       CEU025
     C                     ELSE                                           CEU025
     C                     MOVEL'Y'       CEU025                          CEU025
     C                     ENDIF                                          CEU025
      *                                                                                       CRT005
      ** Check if CRT005 is On                                                                CRT005
      *                                                                                       CRT005
     C                     CALL 'AOSARDR0'                                                    CRT005
     C                     PARM *BLANKS   @RTCD                                               CRT005
     C                     PARM '*VERIFY' @OPTN                                               CRT005
     C                     PARM 'CRT005'  @SARD                                               CRT005
     C           SCSARD    PARM SCSARD    DSFDY                                               CRT005
      *                                                                                       CRT005
     C           @RTCD     IFNE *BLANKS                                                       CRT005
     C           @RTCD     ANDNE'*NRF   '                                                     CRT005
      *                                                                                       CRT005
      ** Report error                                                                         CRT005
      *                                                                                       CRT005
     C                     MOVEL'USR0093' @MSGID                                              CRT005
     C                     MOVEL*BLANKS   WMDTA1                                              CRT005
     C                     MOVEL*BLANKS   WMDTA2                                              CRT005
     C                     EXSR RTVMSG                                                        CRT005
     C                     MOVEL@MSGTX    O#HMSG                                              CRT005
     C                     MOVE 'E'       O#HMSS                                              CRT005
     C                     MOVE @MSGID    O#HMSI                                              CRT005
     C                     MOVE 'SARD'    O#MSTY                                              CRT005
     C                     MOVELW#BRCA    O#BRCA                                              CRT005
     C                     MOVELW#TELD    O#TELD                                              CRT005
      *                                                                                       CRT005
     C                     CALL 'REC4411'                                                     CRT005
     C                     PARM 'RE4401'  PROG   10                                           CRT005
     C                     PARM           JOBNUM  6                                           CRT005
     C                     PARM '0000'    MMCODE  4                                           CRT005
     C                     PARM *BLANKS   P#BRCA  3                                           CRT005
     C                     PARM           @MSGID  7                                           CRT005
     C                     PARM *BLANKS   @MSGDT                                              CRT005
      *                                                                                       CRT005
     C                     MOVE 'N'       WCSTAT                                              CRT005
     C                     MOVE 'CR'      WMSTAT                                              CRT005
     C                     EXSR WRTLOG                                                        CRT005
      *                                                                                       CRT005
     C                     WRITESTATO                  22                                     CRT005
      *                                                                                       CRT005
      ** Set up LDA DBERR                                                                     CRT005
      *                                                                                       CRT005
     C           *LOCK     IN   LDA                                                           CRT005
     C                     MOVEL'SCSARDPD'DBFILE                                              CRT005
     C                     MOVEL@OPTN     DBKEY                                               CRT005
     C                     Z-ADD30        DBASE                                               CRT005
     C                     EXSR DBERR                                                         CRT005
      *                                                                                       CRT005
      ** Set Off Session Active Flag                                                          CRT005
      *                                                                                       CRT005
     C                     MOVEL'N'       WACTIV  1                                           CRT005
      *                                                                                       CRT005
     C                     EXSR *PSSR                                                         CRT005
      *                                                                                       CRT005
     C                     ENDIF                                                              CRT005
      *                                                                                       CRT005
     C           @RTCD     IFNE *BLANKS                                                       CRT005
     C                     MOVEL'N'       CRT005  1                                           CRT005
     C                     ELSE                                                               CRT005
     C                     MOVEL'Y'       CRT005                                              CRT005
     C                     ENDIF                                                              CRT005
      *
      **  Access Bank Details.
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      **  If error on access to Bank Details.
      *
     C           @RTCD     IFNE *BLANKS
      *
      **  Report error.
      *
     C                     MOVEL'USR0051' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
     C                     MOVE 'BANK'    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG   10
     C                     PARM           JOBNUM  6
     C                     PARM '0000'    MMCODE  4
     C                     PARM *BLANKS   P#BRCA  3
     C                     PARM           @MSGID  7
     C                     PARM *BLANKS   @MSGDT
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CR'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
      **  Set up LDA DBERR.
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD1         DBASE
     C                     EXSR DBERR
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV  1
      *
     C                     EXSR *PSSR
      *
      **  Access to Bank Details OK.
      *
     C                     ELSE
      *
      **  Convert Date to 'YYYYMMDD' Format.
      *
     C                     Z-ADDBJRDNB    @@DAYN  50
     C                     EXSR ZDATE9
     C                     END
      *                                                                   175838
     C           CEU025    IFEQ 'Y'                        B*1            175838
      *                                                                   175838
     C**********           CALL 'AOGELRR0'                                             175838 CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*BLANK ' @RTCD   7                       175838
     C                     PARM '*FIRST ' @OPTN   7                       175838
     C********** SDGELR    PARM SDGELR    DSFDY                                        175838 CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
      *                                                                   175838
      **  If error on access to General Ledger Details.                   175838
      *                                                                   175838
     C           @RTCD     IFNE *BLANKS                    B*2            175838
      *                                                                   175838
      **  Report error.                                                   175838
      *                                                                   175838
     C                     MOVEL'USR0077' @MSGID                          175838
     C                     MOVEL*BLANKS   WMDTA1                          175838
     C                     MOVEL*BLANKS   WMDTA2                          175838
     C                     EXSR RTVMSG                                    175838
     C                     MOVEL@MSGTX    O#HMSG                          175838
     C                     MOVE 'E'       O#HMSS                          175838
     C                     MOVE @MSGID    O#HMSI                          175838
      *                                                                   175838
     C                     CALL 'REC4411'                                 175838
     C                     PARM 'RE4401'  PROG   10                       175838
     C                     PARM           JOBNUM  6                       175838
     C                     PARM '0000'    MMCODE  4                       175838
     C                     PARM *BLANKS   P#BRCA  3                       175838
     C                     PARM           @MSGID  7                       175838
     C                     PARM *BLANKS   @MSGDT                          175838
      *                                                                   175838
     C                     MOVE 'N'       WCSTAT                          175838
     C                     MOVE 'CR'      WMSTAT                          175838
     C                     EXSR WRTLOG                                    175838
      *                                                                   175838
     C                     WRITESTATO                  22                 175838
      *                                                                   175838
      **  Set up LDA DBERR.                                               175838
      *                                                                   175838
     C           *LOCK     IN   LDA                                       175838
     C                     MOVEL'SDGELRPD'DBFILE                          175838
     C                     MOVEL@OPTN     DBKEY                           175838
     C                     Z-ADD28        DBASE                           175838
     C                     EXSR DBERR                                     175838
      *                                                                   175838
      **  Set Off Session Active Flag.                                    175838
      *                                                                   175838
     C                     MOVEL'N'       WACTIV  1                       175838
      *                                                                   175838
     C                     EXSR *PSSR                                     175838
      *                                                                   175838
     C                     END                                            175838
      *                                                                   175838
     C                     END                                            175838
      *
      **  Access Cashier Interface ICD Details.
      *
     C**********           CALL 'AOBAIIR0'                                                    CRT005
     C                     CALL 'AOBAIIR1'                                                    CRT005
     C                     PARM '*BLANK ' @RTCD
     C                     PARM '*FIRST ' @OPTN
     C********** SDBAII    PARM SDBAII    DSFDY                                               CRT005
     C           SDBAII    PARM SDBAII    DSSDY                                               CRT005
      *
      **  If error on access to Cashier Interface ICD Details.
      *
     C           @RTCD     IFNE *BLANK
      *
      **  Report error.
      *
     C                     MOVEL'USR0052' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
     C                     MOVE 'BAII'    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM *BLANKS   P#BRCA
     C                     PARM           @MSGID
     C                     PARM *BLANKS   @MSGDT
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CR'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
      **  Set up LDA DBERR.
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBAIIPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD2         DBASE
     C                     EXSR DBERR
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV  1
      *
     C                     EXSR *PSSR
      *
     C                     ENDIF
      *
      **  Initiation of indices.
      *
     C                     Z-ADD999       A       30
     C                     Z-ADD999       B       30
     C                     Z-ADD999       C       30
      *
      **  Access Teller Id details.
      *
     C                     CALL 'AOTELDR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*FIRST ' @OPTN
     C                     PARM *BLANKS   @TLR    3
     C           SDTELD    PARM SDTELD    DSFDY
      *
      **  Load Valid Teller Arrays.
      *
     C           @RTCD     DOWEQ*BLANKS
     C                     MOVELFRTLID    TLR,A
     C                     MOVELFRTLBC    TBR,A
      *
      **  Check Teller Status.
      *
     C                     MOVELFRTLID    KTBID
     C           KTTRNT    CHAINTTRNM2L1             30
      *
     C           *IN30     IFEQ *ON
     C           RECI      ORNE 'D'
      *
      **  Report error.
      *
     C                     MOVEL'USR0055' @MSGID
     C                     MOVELFRTLID    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM *BLANKS   P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVE 'N'       WCSTAT
     C                     MOVE 'CR'      WMSTAT
     C                     EXSR WRTLOG
      *
      **  Set up LDA DBERR.
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'TTRNM2L1'DBFILE
     C                     MOVEL@TTRNT    DBKEY
     C                     Z-ADD3         DBASE
     C                     EXSR DBERR
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     EXSR *PSSR
      *
     C                     ELSE
      *
     C           TWID      IFEQ *BLANKS
     C                     MOVE 'OFF'     TST,A
     C                     ELSE
     C                     MOVE ' ON'     TST,A
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     SUB  1         A
      *
     C                     CALL 'AOTELDR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*NEXT  ' @OPTN
     C                     PARM *BLANKS   @TLR
     C           SDTELD    PARM SDTELD    DSFDY
      *
     C                     ENDDO
      *
     C                     ADD  1         A
      *
      **  Save Lowest Index to use as a Position pointer to start 'LOKUP'.
      *
     C                     Z-ADDA         WAPOS   30
      *
      **  Access transaction types details.
      *
     C                     CALL 'AOBAITR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*FIRST ' @OPTN
     C                     PARM *BLANKS   @BAIT  10
     C                     PARM '*TTYP  ' @KYST   7
     C           SDBAIT    PARM SDBAIT    DSFDY
      *
      **  Do while no errors found.
      *
     C           @RTCD     DOWEQ*BLANKS
      *
      **  Load Transaction Type Details.
      *
     C                     MOVELFXBAIT    TXP,B
     C                     MOVELFXTTFC    W#TTFC
     C                     MOVELFXDQNM    W#DQNM
     C                     MOVELFXDQLN    W#DQLN
     C                     MOVELFXRVFN    W#RVFN
     C                     MOVELFXRVDQ    W#RVDQ
     C                     MOVELFXRVDL    W#RVDL
     C                     MOVELDTLDS     DTL,B
     C                     SUB  1         B
      *
     C                     CALL 'AOBAITR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*NEXT  ' @OPTN
     C                     PARM *BLANKS   @BAIT
     C                     PARM '*TTYP  ' @KYST
     C           SDBAIT    PARM SDBAIT    DSFDY
      *
     C                     ENDDO
      *
     C                     ADD  1         B
      *
      **  Save Lowest Index to use as a Position pointer to start 'LOKUP'.
      *
     C                     Z-ADDB         WBPOS   30
      *
      ****Check*Authorised*Devices*If*Product*In*Cashier*ICD*not*'CASHIER*8'.*****            164273
      **  Check Authorised Devices If Product In Cashier ICD not 'CASHIER  '.                 164273
      *
     C           FUPROD    IFNE W#ICDP
      *
      **  Access authorised devices.
      *
     C                     CALL 'AOBAIDR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*FIRST ' @OPTN
     C                     PARM *BLANKS   P@BRCA  3                                           222373
     C                     PARM *BLANKS   @BAID  10
     C           SDBAID    PARM SDBAID    DSFDY
      *
      **  If record not found.
      *
     C           @RTCD     DOWEQ*BLANKS
     C                     MOVE FWBAID    CDV,C
     C                     SUB  1         C
      *
     C                     CALL 'AOBAIDR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*NEXT  ' @OPTN
     C                     PARM *BLANKS   P@BRCA                                              222373
     C                     PARM *BLANKS   @BAID
     C           SDBAID    PARM SDBAID    DSFDY
      *
     C                     ENDDO
      *
     C                     ADD  1         C
      *
      **  Save Lowest Index to use as a Position pointer to start 'LOKUP'.
      *
     C                     Z-ADDC         WCPOS   30
      *
     C                     ENDIF
      *
      **  Set ICF File Read required Flag.
      *
     C                     MOVEL'Y'       WRDICF  1
      *
     C                     ENDSR
      *
     C/COPY ZSRSRC,ZDATE9Z3
      *
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            UPDLOG - Update Communications Log.                *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  RCVDTQ - Receive Dataqueue Processing.             *
      *            ROLLBK - Rollback Processing.                      *
      *                                                               *
      *****************************************************************
     C           UPDLOG    BEGSR
      *
     C           RICMSQ    CHAINREPLOGL0             35
      *
     C           *IN35     IFEQ '0'
      *
     C                     TIME           WTMDAT 120
     C                     MOVE WTMDAT    TDATE
     C                     MOVELWTMDAT    TTIME
      *
     C                     MOVE WTHR      WFHR
     C                     MOVE WTMN      WFMN
     C                     MOVE WTSS      WFSS
     C                     MOVE WTDD      WFDD
     C                     MOVE WTMM      WFMM
     C                     MOVE WTYY      WFYY
      *
     C           FUPROD    IFNE W#ICDP
     C                     MOVE *BLANKS   RIRMDN
     C                     END
      *
      **  Update the Successful Completion flag
      *
     C                     MOVELWCSTAT    RISUCM
      *
      **  Update the Status & Status Time Stamp
      *
     C                     MOVELWMSTAT    RISTAT
     C                     MOVE FTIME     RISTTM
      *
      **  Update the Comms Log File.
      *
     C                     UPDATREPLOGD0
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DBERR  - Database Error Handling.                  *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  INIT   - Initial Processing.                       *
      *                                                               *
      *****************************************************************
     C           DBERR     BEGSR
      *
     C                     MOVELPROG      DBPGM
     C                     OUT  LDA
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            *PSSR  - Program Error.                            *
      *                                                               *
      * CALLS                                                         *
      *                                                               *
      * CALLED BY  COMMSG - Comms Message Processing.                 *
      *            DBERR  - Database Error Handling.                  *
      *            INIT   - Initial Processing.                       *
      *            MSGVAL - Further Message Validation.               *
      *            RCVDTQ - Receive Dataqueue Processing.             *
      *                                                               *
      *****************************************************************
     C           *PSSR     BEGSR
      *                                                                   CEU025
     C           @MSGID    IFNE 'USR0044'                                 CEU025
     C           @MSGID    ANDNE'USR0050'                                 CEU025
     C           @MSGID    ANDNE'USR0051'                                 CEU025
     C           @MSGID    ANDNE'USR0052'                                 CEU025
      *
      **  Restore Branch Code and Teller details.
      *
     C                     MOVEL@WBRCA    W#BRCA
     C                     MOVEL@WTELD    W#TELD
      *
      **  Sign off teller from Teller Totals and Controls File.
      *
     C                     MOVELW#TELD    KTBID
     C           KTTRNT    CHAINTTRNM2L1             30
      *
     C           *IN30     IFEQ *ON
     C           RECI      ORNE 'D'
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0055' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVEL*BLANKS   @WRK4   4
     C                     MOVEL*BLANKS   @WRK5   5
     C           KTBRI     CAT  KTBID     @WRK4
     C           @WRK4     CAT  KRCTP     @WRK5
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'TTRNM2L1'DBFILE
     C                     MOVEL@WRK5     DBKEY
     C                     Z-ADD19        DBASE
     C                     EXSR DBERR
      *
     C                     ELSE
      *
     C                     MOVE *BLANKS   TWID
     C                     UPDATTTRNTM2F
      *
     C                     ENDIF
      *                                                                   CEU025
     C                     ENDIF                                          CEU025
      *
     C                     DUMP
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P06    - Retrieve System Control Data Routine.     *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling.                  *
      *            RVFBDT - Retrieve First Business Dates.            *
      *            ZDATE2 - Convert day number to a date.             *
      *            ZFWDT  - Find nth working day from given date.     *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P06       BEGSR                           ** P06    **
      *
      **  Initialise fields.
      *
     C                     MOVEL*BLANKS   ICDATD
     C                     MOVEL*BLANKS   OCDATD
     C                     MOVEA*BLANKS   BDY
     C                     MOVELFLDI1     ICDATD
      *
      **  Assign values.
      *
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
     C                     MOVELICFBDT    OCFBDT
     C                     MOVELICLBDT    OCLBDT
     C                     Z-ADD24        OCPBLN
     C                     Z-ADD10        OCXRTL
     C                     MOVEL'Y'       OCLCLY
     C                     MOVEL'N'       OCLCLN
     C                     MOVEL'N'       OCEACV
     C                     MOVEL'Y'       OCCQRF
     C                     MOVEL'M'       OCHSID
     C                     MOVEL*BLANKS   OCRTOF                          120072
     C                     MOVEL*BLANKS   OCCYOF                          120072
     C*********************MOVEL*BLANKS   OCLCEC                    120072124248
     C                     MOVEL*BLANKS   OCERSZ                          CEU025
     C                     MOVEL*BLANKS   OCAACN                          CEU025
     C                     MOVEL'N'       OCAACN                          CEU025
      *
     C                     MOVELBJLCCY    OCLCCY
      *                                                                   124248
     C** Find number of Decimal Places for Base Currency from Currency    124248
     C** File.                                                            124248
     C                     CALL 'AOCURRR0'                                124248
     C           RTNCDE    PARM '*MSG  '  RTNCDE  7                       124248
     C                     PARM '*KEY'    OPTION  7                       124248
     C                     PARM BJLCCY    KEYF    3                       124248
     C           SDCURR    PARM *BLANKS   DSSDY                           124248
     C**                                                                  124248
     C           RTNCDE    IFNE *BLANKS                                   124248
      *                                                                   124248
      **  Report error.                                                   124248
      *                                                                   124248
     C                     MOVEL'USR0047' @MSGID                          124248
     C                     MOVEL*BLANKS   WMDTA1                          124248
     C                     MOVEL*BLANKS   WMDTA2                          124248
     C                     EXSR RTVMSG                                    124248
     C                     MOVEL@MSGTX    O#HMSG                          124248
     C                     MOVE 'E'       O#HMSS                          124248
     C                     MOVE @MSGID    O#HMSI                          124248
     C                     MOVE 'BANK'    O#MSTY                          124248
     C                     MOVELW#BRCA    O#BRCA                          124248
     C                     MOVELW#TELD    O#TELD                          124248
      *                                                                   124248
     C                     CALL 'REC4411'                                 124248
     C                     PARM 'RE4401'  PROG   10                       124248
     C                     PARM           JOBNUM  6                       124248
     C                     PARM '0000'    MMCODE  4                       124248
     C                     PARM *BLANKS   P#BRCA  3                       124248
     C                     PARM           @MSGID  7                       124248
     C                     PARM *BLANKS   @MSGDT                          124248
      *                                                                   124248
     C                     MOVE 'N'       WCSTAT                          124248
     C                     MOVE 'CR'      WMSTAT                          124248
     C                     EXSR WRTLOG                                    124248
      *                                                                   124248
     C                     WRITESTATO                  22                 124248
      *                                                                   124248
      **  Set up LDA DBERR.                                               124248
      *                                                                   124248
     C           *LOCK     IN   LDA                                       124248
     C                     MOVEL'SDCURRPD'DBFILE                          124248
     C                     MOVEL@OPTN     DBKEY                           124248
     C                     Z-ADD23        DBASE                           124248
     C                     EXSR DBERR                                     124248
      *                                                                   124248
      **  Set Off Session Active Flag.                                    124248
      *                                                                   124248
     C                     MOVEL'N'       WACTIV  1                       124248
      *                                                                   124248
     C                     EXSR *PSSR                                     124248
      *                                                                   124248
      **  Access to Currency File OK.                                     124248
      *                                                                   124248
     C                     ELSE                                           124248
     C                     MOVELA6NBDP    OCLCEC                          124248
      *                                                                   124248
     C                     END                                            124248
      *
      **  Blank out base currency since this concerns Clean Payments in
      **  Equation.
      *
     C*                    MOVELBJCYCD    OCBCCY
     C                     MOVEL*BLANKS   OCBCCY
     C                     MOVEL*BLANKS   OCBRID
      *
      **  Assign date format.
      *
     C                     SELEC
      *
     C           BJDFIN    WHEQ 'D'
     C                     MOVEL'DMY'     OCDTFM
     C                     MOVEL'0'       *IN98
      *
     C           BJDFIN    WHEQ 'M'
     C                     MOVEL'MDY'     OCDTFM
     C                     MOVEL'1'       *IN98
      *
     C                     ENDSL
      *
      **  Check if Dealing Module is present.
      *
     C                     CALL 'AOMMODR0'
     C                     PARM '*MSG    '@RTCD
     C                     PARM '*FIRST  '@OPTN
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
     C           @RTCD     IFNE *BLANK
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0041' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM *BLANKS   P#BRCA
     C                     PARM           @MSGID
     C                     PARM *BLANKS   @MSGDT
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDMMODPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD4         DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ENDIF
      *
     C           WERROR    IFEQ 'N'
      *
     C           BGDLFX    IFEQ 'Y'
      *
     C**********           CALL 'AODEALR0'                                                    CGL029
     C                     CALL 'AODEALR1'                                                    CGL029
     C                     PARM '*BLANK'  @RTCD   7
     C                     PARM '*FIRST'  @OPTN   7
     C********** SDDEAL    PARM SDDEAL    DSFDY                                               CGL029
     C           SDDEAL    PARM SDDEAL    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANK
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0042' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM *BLANKS   @MSGDT
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDDEALPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD5         DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
      **  Assign separation characters.
      *
     C                     MOVELBNTHSP    OCINSC
     C                     MOVELBNDCSP    OCDCSC
      *
     C                     ENDIF
      *
     C                     ELSE
      *
     C                     MOVEL','       OCINSC
     C                     MOVEL'.'       OCDCSC
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Calculate business dates backward.
      *
     C           WERROR    IFEQ 'N'
      *
     C                     MOVE ICFBDT    NICFB   20
     C                     Z-ADDNICFB     I
     C                     Z-ADDBJRDNB    WDATE
     C                     MOVELOCLCCY    ZCCY
     C                     MOVEL*BLANKS   ZLOC
      *
     C           I         DOWGE1
      *
     C                     Z-ADD1         ZNRDYS
     C                     Z-ADDWDATE     ZDAYNO
     C                     EXSR RVFBDT
     C                     Z-ADDZDYNBR    WDATE
      *
     C                     Z-ADDWDATE     ZDAYNO
     C                     EXSR ZDATE2
     C           *IN98     IFEQ '0'
     C                     MOVE ZDATE     BDY,I
     C                     ENDIF
      *
     C                     SUB  1         I
      *
     C                     ENDDO
      *
      **  Format rundate.
      *
     C           NICFB     ADD  1         I
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     EXSR ZDATE2
     C           *IN98     IFEQ '0'
     C                     MOVE ZDATE     BDY,I
     C                     ENDIF
      *
      **  Calculate business dates forward.
      *
     C                     MOVE ICLBDT    NICLB   20
     C           I         ADD  1         J       20
     C                     Z-ADD1         I       20
     C                     Z-ADDBJRDNB    WDATE   50
     C                     MOVELOCLCCY    ZCCY
     C                     MOVEL*BLANKS   ZLOC
      *
     C           I         DOWLENICLB
      *
     C                     Z-ADD1         ZNRDYS
     C                     Z-ADDWDATE     ZDAYNO
     C                     EXSR ZFWDT
     C                     Z-ADDZDYNBR    WDATE
      *
     C                     Z-ADDWDATE     ZDAYNO
     C                     EXSR ZDATE2
     C           *IN98     IFEQ '0'
     C                     MOVE ZDATE     BDY,J
     C                     ENDIF
      *
     C                     ADD  1         I
     C                     ADD  1         J
      *
     C                     ENDDO
      *
      **  Assign business dates to outgoing message.
      *
     C                     MOVEABDY,1     OCBSD1
     C                     MOVEABDY,43    OCBSD2
     C                     MOVEABDY,85    OCBSD3
     C                     MOVEABDY,127   OCBSD4
     C                     MOVEABDY,169   OCBSD5
      *
      **  Retrieve branch name.
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*BLANK ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM W#BRCA    @KEY2   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           @RTCD     IFNE *BLANK
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0003' @MSGID
     C                     MOVELW#BRCA    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBRCHPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD6         DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
     C                     MOVELA8BRNM    OCBRNM
      *
      **  Retrieve customer addresses.
      *
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM A8BICN    @KEY1  10
     C                     PARM *BLANKS   @KYST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
     C           @RTCD     IFNE *BLANKS
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0043' @MSGID
     C                     MOVELA8BICN    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCUSTPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD7         DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
      **  Customer addresses.
      *
     C                     MOVELBBCNA1    OCBRA1
     C                     MOVELBBCNA2    OCBRA2
     C                     MOVELBBCNA3    OCBRA3
     C                     MOVELBBCNA4    OCBRA4
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Check if CRT301 is On.  (Cashier has local database.)
      *
     C           WERROR    IFEQ 'N'
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*VERIFY' @OPTN   7
     C                     PARM 'CRT301'  @SARD   6
     C           SCSARD    PARM SCSARD    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
     C                     MOVEL'N'       OCLDBF
     C                     ELSE
     C                     MOVEL'Y'       OCLDBF
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Perform implicit sign on for CDAT.
      *
     C***********WERROR    IFEQ 'N'                                       164275
      *
     C***********          MOVELW#TELD    KTBID                           164275
     C***********KTTRNT    CHAINTTRNM2L1             30                   164275
      *
     C************IN30     IFEQ *ON                                       164275
     C***********RECI      ORNE 'D'                                       164275
      *
     C***********          MOVEL'Y'       WERROR                          164275
      *
      **  Retrieve error message data to send in host message.
      *
     C***********          MOVEL'USR0013' @MSGID                          164275
     C***********          MOVELW#TELD    WMDTA1                          164275
     C***********          MOVEL*BLANKS   WMDTA2                          164275
     C***********WMDTA1    CAT  WMDTA2    @MSGDT                          164275
     C***********          EXSR RTVMSG                                    164275
     C***********          MOVEL@MSGTX    O#HMSG                          164275
     C***********          MOVE 'E'       O#HMSS                          164275
     C***********          MOVE @MSGID    O#HMSI                          164275
      *
      **  Report error.
      *
     C***********          CALL 'REC4411'                                 164275
     C***********          PARM 'RE4401'  PROG                            164275
     C***********          PARM           JOBNUM                          164275
     C***********          PARM '0000'    MMCODE                          164275
     C***********          PARM W#BRCA    P#BRCA                          164275
     C***********          PARM           @MSGID                          164275
     C***********          PARM           @MSGDT                          164275
      *
     C***********          MOVEL*BLANKS   @WRK4                           164275
     C***********          MOVEL*BLANKS   @WRK5                           164275
     C***********KTBRI     CAT  KTBID     @WRK4                           164275
     C***********@WRK4     CAT  KRCTP     @WRK5                           164275
      *
     C************LOCK     IN   LDA                                       164275
     C***********          MOVEL'TTRNM2L1'DBFILE                          164275
     C***********          MOVEL@WRK5     DBKEY                           164275
     C***********          Z-ADD16        DBASE                           164275
     C***********          EXSR DBERR                                     164275
      *
     C***********          MOVE 'N'       WCSTAT  1                       164275
     C***********          MOVE 'CS'      WMSTAT  2                       164275
     C***********          EXSR WRTLOG                                    164275
      *
     C***********          WRITESTATO                  22                 164275
      *
      **  Set Off Session Active Flag.
      *
     C***********          MOVEL'N'       WACTIV                          164275
      *
     C***********          ELSE                                           164275
      *
     C***********TWID      IFNE *BLANKS                                   164275
      *
     C***********          MOVEL'Y'       WERROR                          164275
      *
      **  Retrieve error message data to send in host message.
      *
     C***********          MOVEL'USR0015' @MSGID                          164275
     C***********          MOVELW#TELD    WMDTA1                          164275
     C***********          MOVELTWID      WMDTA2                          164275
     C***********WMDTA1    CAT  WMDTA2    @MSGDT                          164275
     C***********          EXSR RTVMSG                                    164275
     C***********          MOVEL@MSGTX    O#HMSG                          164275
     C***********          MOVE 'E'       O#HMSS                          164275
     C***********          MOVE @MSGID    O#HMSI                          164275
      *
      **  Report error.
      *
     C***********          CALL 'REC4411'                                 164275
     C***********          PARM 'RE4401'  PROG                            164275
     C***********          PARM           JOBNUM                          164275
     C***********          PARM '0000'    MMCODE                          164275
     C***********          PARM W#BRCA    P#BRCA                          164275
     C***********          PARM           @MSGID                          164275
     C***********          PARM           @MSGDT                          164275
      *
     C***********          MOVEL*BLANKS   @WRK4                           164275
     C***********          MOVEL*BLANKS   @WRK5                           164275
     C***********KTBRI     CAT  KTBID     @WRK4                           164275
     C***********@WRK4     CAT  KRCTP     @WRK5                           164275
      *
     C************LOCK     IN   LDA                                       164275
     C***********          MOVEL'TTRNM2L1'DBFILE                          164275
     C***********          MOVEL@WRK5     DBKEY                           164275
     C***********          Z-ADD18        DBASE                           164275
     C***********          EXSR DBERR                                     164275
      *
     C***********          MOVE 'N'       WCSTAT  1                       164275
     C***********          MOVE 'CS'      WMSTAT  2                       164275
     C***********          EXSR WRTLOG                                    164275
      *
     C***********          WRITESTATO                  22                 164275
      *
      **  Set Off Session Active Flag.
      *
     C***********          MOVEL'N'       WACTIV                          164275
      *
     C***********          ELSE                                           164275
      *
     C***********TST,A     IFNE ' ON'                                     164275
      *
      **  Update workstation id.
      *
     C***********'CASH'    CAT  JOBNUM    TWID                            164275
     C***********          UPDATTTRNTM2F                                  164275
      *
      **  Set teller status flag on.
      *
     C***********          MOVEL' ON'     TST,A                           164275
      *
     C***********          ENDIF                                          164275
      *
     C***********          ENDIF                                          164275
      *
     C***********          ENDIF                                          164275
      *
     C***********          ENDIF                                          164275
      *                                                                   176563
      ** Flag for retrieval of account                                    176563
      *                                                                   176563
     C                     MOVE 'Y'       OCTMPF  1                       176563
      *
      **  Write Data Comms File.
      *
     C           WERROR    IFEQ 'N'
      *
     C                     MOVEL'USR0016' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVELOSTATD    OCDAT
      *
     C                     MOVEL'Y'       WCSTAT
     C                     MOVEL'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITECDATO                  22
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P07    - Retrieve System Parameter Codes Routine.  *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling.                  *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P07       BEGSR                           ** P07    **
      *
      **  Assign initial values.
      *
     C                     MOVEL*BLANKS   ISPDT1
     C                     MOVEL*BLANKS   ISPDT2
     C                     MOVEL*BLANKS   OSPDT1
     C                     MOVEL*BLANKS   OSPDT2
     C                     MOVEL*BLANKS   OSPDT3
     C                     MOVEL*BLANKS   OSPDT4
     C                     MOVEL*BLANKS   OSPDT5
     C                     MOVEL*BLANKS   OSPDT6
     C                     MOVEL*BLANKS   OSPDT7
     C                     MOVEA*BLANKS   ASP
     C                     MOVEA*BLANKS   AOS
      *
     C                     MOVELFLDI1     ISPDT1
     C                     MOVELFLDI2     ISPDT2
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
     C                     MOVEL'+00'     OPOFDL
     C                     MOVEL'+00'     OPOFDF
     C                     MOVEL'+00'     OPOFCL
     C                     MOVEL'+00'     OPOFCF
     C                     MOVEL'401'     OPDRTC
     C                     MOVEL'901'     OPCRTC
      *
     C                     MOVEAIPSPP1    ASP,1
     C                     MOVEAIPSPP2    ASP,52
      *
     C                     Z-ADD1         I
     C                     Z-ADD1         J       20
      *
      **  While array of SP codes still has contents (up to 60 elements).
      *
     C           I         DOWLE60
     C           ASP,I     ANDNE*BLANK
      *
     C                     CALL 'AOBAITR0'
     C                     PARM '*BLANK'  @RTCD   7
     C                     PARM '*KEY  '  @OPTN   7
     C                     PARM ASP,I     @KEY1  10
     C                     PARM '*BLANKS' @KEY3   7
     C           SDBAIT    PARM SDBAIT    DSFDY
      *
     C           @RTCD     IFNE *BLANKS
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0008' @MSGID
     C                     MOVELASP,I     WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM MAJMIN    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C           *LOCK     IN   LDA
     C                     MOVE 'SDBAITPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD8         DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     MOVE *BLANKS   W#TXP
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
      **  Transfer array contents to outgoing message.
      *
     C                     MOVELASP,I     OPSPPM
     C                     MOVELOSPDTB    AOS,J
     C                     ADD  1         J
      *
     C                     ENDIF
      *
     C                     ADD  1         I
      *
     C                     ENDDO
      *
     C           WERROR    IFEQ 'N'
      *
     C                     MOVEAAOS,1     OSPDT2
     C                     MOVEAAOS,12    OSPDT3
     C                     MOVEAAOS,23    OSPDT4
     C                     MOVEAAOS,34    OSPDT5
     C                     MOVEAAOS,45    OSPDT6
     C                     MOVEAAOS,56    OSPDT7
      *
      **  Write Data Comms File.
      *
     C           I         IFGT 1
     C           I         SUB  1         K       20
     C                     ELSE
     C                     Z-ADD1         K
     C                     ENDIF
      *
     C                     MOVEL'USR0017' @MSGID
     C                     MOVELASP,1     WMDTA1
     C                     MOVELASP,K     WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVE *BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVELOSTATD    OSPDT1
      *
     C                     MOVEL'Y'       WCSTAT
     C                     MOVEL'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITESPDTO                  22
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P08    - Retrieve Exchange Rates Information.      *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling.                  *
      *            ZEDIT  - Insert decimal point and 0s for numeric.  *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P08       BEGSR                           ** P08    **
      *
      **  Initialise fields.
      *
     C                     MOVEL*BLANKS   IBSER
     C                     MOVEL*BLANKS   OBSERD
     C***********          MOVEA*BLANKS   ACY                             CEU025
     C                     MOVEA*BLANKS   AC1                             CEU025
     C                     MOVEA*BLANKS   AC2                             CEU025
      *
     C                     Z-ADD1         I
      *
     C                     MOVELFLDI1     IBSER
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
      **  At the start, no currencies have yet been loaded, set
      **  pointer to the beginning of the file.
      *
     C           IXCCY     IFEQ '***'
     C           *LOVAL    SETLLSDCURRL0
     C                     ELSE
      *
      **  Otherwise, some currencies have already been loaded, IXCCY
      **  contains the last CCY loaded, set pointer to that position,
      **  then read next record.
      *
     C           IXCCY     CHAINSDCURRL0             42
     C*          FXCCY     CHAINSDCURRL0             42
     C                     ENDIF
      *
     C                     READ SDCURRL0                 42
      *
      **  Assign values.
      *
     C           *IN42     DOWEQ'0'
     C           I         ANDLE10
      *
     C                     Z-ADDA6SMLD    WSMLD   50
      *
      **  Smallest denomination to have decimal point.
      *
     C                     MOVEL*BLANKS   ZFIELD
     C                     MOVE WSMLD     ZFIELD
     C                     Z-ADDA6NBDP    ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    WMNDN   8
     C                     MOVEL*BLANKS   WFIELD 16
     C                     MOVELWMNDN     WFIELD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   WMNDN
     C                     MOVEARATE,1    WMNDN
      *
      **  Assign appropriate values.
      *
     C***********          MOVEL*BLANKS   OBSCYB                          CEU025
     C                     MOVEL*BLANKS   OXOXS1                          CEU025
     C                     MOVEL*BLANKS   OXOXS2                          CEU025
     C                     MOVELA6CYCD    OXCCY
     C                     MOVELA6CYNM    OXCCYD
     C                     MOVELA6NBDP    OXCCYE
     C                     MOVE WMNDN     OXMNBC
     C                     MOVE WMNDN     OXMNBT
     C                     MOVE WMNDN     OXMNSC
     C                     MOVE WMNDN     OXMNST
     C           A6MDIN    IFEQ 'M'
     C                     MOVEL'Y'       OXRCRT
     C                     ELSE
     C                     MOVEL'N'       OXRCRT
     C                     END
     C           A6CYCD    IFEQ BJCYCD
     C                     MOVEL'N'       OXRCRT
     C                     END
     C                     MOVELA6ISON    OXCCYN
     C                     MOVE '00.000'  OXCMBC
     C                     MOVE '00.000'  OXCMBT
     C                     MOVE '00.000'  OXCMSC
     C                     MOVE '00.000'  OXCMST
      *
      **  If CRT104 is on, retrieve rates from PF/REBDCRPD.
      *
     C           CRT104    IFEQ 'Y'
      *
     C           A6CYCD    CHAINREBDCRPD             43
      *
     C           *IN43     IFEQ '1'
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0045' @MSGID
     C                     MOVELA6CYCD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM *BLANKS   P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C           *LOCK     IN   LDA
     C                     MOVE 'REBDCRPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD9         DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
      **  Edit rates to include decimal points before assigning to output msg.
      *
     C                     MOVEL*ZEROS    OXXRBC
     C                     Z-ADD*ZEROS    W#RT   138
     C                     MOVEL*BLANKS   ZFIELD
     C           FEVNRT    DIV  FEAMNT    W#RT
     C                     MOVE W#RT      ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C           13        SUBSTZFIELD:3  OXXRBC
     C                     MOVEL*BLANKS   WFIELD 16
     C                     MOVELOXXRBC    WFIELD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   OXXRBC
     C                     MOVEARATE,1    OXXRBC
      *                                                                   CEU025
     C                     MOVEL*BLANKS   OXEXBC                          CEU025
     C                     MOVEARATE,1    OXEXBC                          CEU025
      *
     C                     MOVEL*ZEROS    OXXRSC
     C                     Z-ADD*ZEROS    W#RT
     C                     MOVEL*BLANKS   ZFIELD
     C           FEVPRT    DIV  FEAMNT    W#RT
     C                     MOVE W#RT      ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C           13        SUBSTZFIELD:3  OXXRSC
     C                     MOVEL*BLANKS   WFIELD 16
     C                     MOVELOXXRSC    WFIELD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   OXXRSC
     C                     MOVEARATE,1    OXXRSC
      *                                                                   CEU025
     C                     MOVEL*BLANKS   OXEXSC                          CEU025
     C                     MOVEARATE,1    OXEXSC                          CEU025
      *
     C                     MOVEL*ZEROS    OXXRBT
     C                     Z-ADD*ZEROS    W#RT
     C                     MOVEL*BLANKS   ZFIELD
     C           FEDNRT    DIV  FEAMNT    W#RT
     C                     MOVE W#RT      ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C           13        SUBSTZFIELD:3  OXXRBT
     C                     MOVEL*BLANKS   WFIELD 16
     C                     MOVELOXXRBT    WFIELD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   OXXRBT
     C                     MOVEARATE,1    OXXRBT
      *                                                                   CEU025
     C                     MOVEL*BLANKS   OXEXBT                          CEU025
     C                     MOVEARATE,1    OXEXBT                          CEU025
      *
     C                     MOVEL*ZEROS    OXXRST
     C                     Z-ADD*ZEROS    W#RT
     C                     MOVEL*BLANKS   ZFIELD
     C           FEDPRT    DIV  FEAMNT    W#RT
     C                     MOVE W#RT      ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C           13        SUBSTZFIELD:3  OXXRST
     C                     MOVEL*BLANKS   WFIELD 16
     C                     MOVELOXXRST    WFIELD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   OXXRST
     C                     MOVEARATE,1    OXXRST
      *                                                                   CEU025
     C                     MOVEL*BLANKS   OXEXST                          CEU025
     C                     MOVEARATE,1    OXEXST                          CEU025
      *
     C                     ENDIF
      *
     C                     ELSE
      *
     C                     MOVEL*ZEROS    OXXRBC
     C                     MOVEL*BLANKS   ZFIELD
     C                     MOVE A6SPRT    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C           13        SUBSTZFIELD:3  OXXRBC
     C                     MOVEL*BLANKS   WFIELD 16
     C                     MOVELOXXRBC    WFIELD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   OXXRBC
     C                     MOVEARATE,1    OXXRBC
     C                     MOVELOXXRBC    OXXRBT
     C                     MOVELOXXRBC    OXXRSC
     C                     MOVELOXXRBC    OXXRST
      *
     C                     ENDIF
      *
     C                     MOVEL*BLANKS   OXEXSR                          CEU025
     C                     MOVEL*BLANKS   OXEXUR                          CEU025
      *                                                                   CEU025
     C           CEU025    IFEQ 'Y'                                       CEU025
      *                                                                   CEU025
     C           A6INCY    IFEQ 'Y'                                       CEU025
     C           BJRDNB    ANDGEA6TPSD                                    175838
     C********   BJRDNB    ANDLEA6TPED                                                 175838 199373
     C                     MOVEL'Y'       OXMBFL                          CEU025
     C                     ELSE                                           CEU025
     C                     MOVEL'N'       OXMBFL                          CEU025
     C                     ENDIF                                          CEU025
      *                                                                   CEU025
     C                     ELSE                                           CEU025
     C                     MOVEL'N'       OXMBFL                          CEU025
     C                     ENDIF                                          CEU025
      *                                                                   CEU025
     C***********          MOVELOBSCYB    ACY,I                           CEU025
     C                     MOVELOXOXS1    AC1,I                           CEU025
     C                     MOVELOXOXS2    AC2,I                           CEU025
      *
     C                     ADD  1         I
      *
     C                     READ SDCURRL0                 42
      *
     C                     ENDDO
      *
      **  EOF encountered before 10 elements have been filled up.
      *
     C           WERROR    IFEQ 'N'
      *
     C           *IN42     IFEQ '1'
     C           I         ANDLE10
      *
      **  Move '***' to last CCY block when EOF reached.
      *
     C***********          MOVEL*BLANK    OBSCYB                          CEU025
     C                     MOVEL*BLANKS   OXOXS1                          CEU025
     C                     MOVEL*BLANKS   OXOXS2                          CEU025
     C                     MOVEL'***'     OXCCY
     C***********          MOVELOBSCYB    ACY,I                           CEU025
     C                     MOVELOXOXS1    AC1,I                           CEU025
     C                     MOVELOXOXS2    AC2,I                           CEU025
      *
     C                     ENDIF
      *
      **  Move array contents to outgoing message.
      *
     C***********          MOVELACY,1     OXCB01                          CEU025
     C***********          MOVELACY,2     OXCB02                          CEU025
     C***********          MOVELACY,3     OXCB03                          CEU025
     C***********          MOVELACY,4     OXCB04                          CEU025
     C***********          MOVELACY,5     OXCB05                          CEU025
     C***********          MOVELACY,6     OXCB06                          CEU025
     C***********          MOVELACY,7     OXCB07                          CEU025
     C***********          MOVELACY,8     OXCB08                          CEU025
     C***********          MOVELACY,9     OXCB09                          CEU025
     C***********          MOVELACY,10    OXCB10                          CEU025
     C                     MOVELAC1,1     OXC01A                          CEU025
     C                     MOVELAC2,1     OXC01B                          CEU025
     C                     MOVELAC1,2     OXC02A                          CEU025
     C                     MOVELAC2,2     OXC02B                          CEU025
     C                     MOVELAC1,3     OXC03A                          CEU025
     C                     MOVELAC2,3     OXC03B                          CEU025
     C                     MOVELAC1,4     OXC04A                          CEU025
     C                     MOVELAC2,4     OXC04B                          CEU025
     C                     MOVELAC1,5     OXC05A                          CEU025
     C                     MOVELAC2,5     OXC05B                          CEU025
     C                     MOVELAC1,6     OXC06A                          CEU025
     C                     MOVELAC2,6     OXC06B                          CEU025
     C                     MOVELAC1,7     OXC07A                          CEU025
     C                     MOVELAC2,7     OXC07B                          CEU025
     C                     MOVELAC1,8     OXC08A                          CEU025
     C                     MOVELAC2,8     OXC08B                          CEU025
     C                     MOVELAC1,9     OXC09A                          CEU025
     C                     MOVELAC2,9     OXC09B                          CEU025
     C                     MOVELAC1,10    OXC10A                          CEU025
     C                     MOVELAC2,10    OXC10B                          CEU025
      *
      **  Write Data Comms File.
      *
     C           I         IFGT 1
     C           I         SUB  1         K
     C                     ELSE
     C                     Z-ADD1         K
     C                     ENDIF
     C***********          MOVELACY,1     @CCY1   3                       CEU025
     C***********          MOVELACY,K     @CCY2   3                       CEU025
     C                     MOVELAC1,1     @CCY1   3                       CEU025
     C                     MOVELAC1,K     @CCY2   3                       CEU025
      *
     C                     MOVEL'USR0018' @MSGID
     C                     MOVEL@CCY1     WMDTA1
     C                     MOVEL@CCY2     WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVELOSTATD    OBSER
      *
     C                     MOVEL'Y'       WCSTAT
     C                     MOVEL'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITEBSERO                  22
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P09    - Retrieve Nostro Account Details Routine.  *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling.                  *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P09       BEGSR                           ** P09    **
      *
     C                     MOVEL*BLANKS   INOST
     C                     MOVEL*BLANKS   ONOSTD
     C                     MOVEA*BLANKS   AN1
     C                     MOVEA*BLANKS   AN2
      *
     C                     MOVELFLDI1     INOST
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
     C                     MOVEL*BLANK    ONACSF
      *
      **  At the start, when no nostro details have been set up, set
      **  to the beginning of file.
      *
     C           INCCY     IFEQ '***'
     C           *LOVAL    SETLLSDNOSTL0
     C                     ELSE
      *
      **  Otherwise, INNSNM contains the last nostro loaded, so position
      **  the file pointer and read the record following.
      *
     C           3         SUBSTINNSNM:1  WNSC
     C           2         SUBSTINNSNM:4  WNSN
     C           KNOST     CHAINSDNOSTL0             44
     C                     ENDIF
      *
     C                     READ SDNOSTL0                 44
      *
     C                     Z-ADD1         I
      *
      **  While not EOF and nostro details to be sent at a time has a max of 4.
      *
     C           *IN44     DOWEQ'0'
     C           I         ANDLE4
      *
     C                     MOVELA7CUST    KCUST                           122060
     C                     MOVELA7CYCD    KCCY                            122060
     C                     MOVELA7ACCD    KACOD                           122060
     C                     Z-ADDA7ACSN    KACSQ                           122060
     C                     MOVELA7BRCD    KBRCD                           122060
      *                                                                   122060
     C           KACNT     CHAINACCNTL0              31                   122060
      *                                                                   122060
     C           *IN31     IFEQ '0'                                       122060
     C           ATYP      ANDEQ'R'                                       122060
      *                                                                   122060
     C                     MOVELA7CYCD    ONCCY
     C*                    MOVELA7NOSN    ONNSNM
     C           A7CYCD    CAT  A7NONB    ONNSNM
     C                     MOVELA7BRCD    ONACBR
     C                     MOVELA7CUST    ONACCN
     C***********          MOVELA7ACSN    WACSN   2                       122060
     C***********A7CUST    CAT  A7CYCD    WORK9   9                       122060
     C***********A7ACCD    CAT  WACSN     WORK6   6                       122060
     C***********WORK9     CAT  WORK6     WORK15 15                       122060
     C***********A7BRCD    CAT  WORK15    ONEXAC                          122060
     C                     MOVELACNO      WRK10  10                       122060
     C           A7BRCD    CAT  WRK10     ONEXAC                          122060
      *
      **  Retrieve customer details.
      *
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM A7CUST    @KEY1  10
     C                     PARM *BLANKS   @KYST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
     C           @RTCD     IFNE *BLANKS
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0043' @MSGID
     C                     MOVELA7CUST    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDCUSTPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD11        DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
      **  Assign nostro description and addresses.
      *
     C           BBCRNM    CAT  BBCRTN    ONNSDC
     C                     MOVELBBCNA1    ONNSA1
     C                     MOVELBBCNA2    ONNSA2
     C                     MOVELBBCNA3    ONNSA3
     C                     MOVELBBCNA4    ONNSA4
      *
     C                     ENDIF
      *
      **  Load details to array.
      *
     C                     MOVELONONS1    AN1,I
     C                     MOVELONONS2    AN2,I
      *
     C                     ADD  1         I
      *                                                                   122060
     C                     ENDIF                                          122060
      *
     C                     READ SDNOSTL0                 44
      *
     C                     ENDDO
      *
      **  EOF encountered before 4 nostro details have been loaded.
      *
     C           WERROR    IFEQ 'N'
      *
     C           *IN44     IFEQ '1'
     C           I         ANDLT4
      *
     C                     MOVEL*BLANKS   ONONSB
     C                     MOVEL'***'     ONCCY
     C                     MOVELONONS1    AN1,I
     C                     MOVELONONS2    AN2,I
      *
     C                     ENDIF
      *
      **  Move nostro contents to outgoing message.
      *
     C                     MOVEAAN1,1     ONNB1A
     C                     MOVEAAN2,1     ONNB1B
     C                     MOVEAAN1,2     ONNB2A
     C                     MOVEAAN2,2     ONNB2B
     C                     MOVEAAN1,3     ONNB3A
     C                     MOVEAAN2,3     ONNB3B
     C                     MOVEAAN1,4     ONNB4A
     C                     MOVEAAN2,4     ONNB4B
      *
      **  Write Data Comms File.
      *
     C           I         IFGT 1
     C           I         SUB  1         K
     C           5         SUBSTAN1,1:4   @NOS1   5
     C           5         SUBSTAN1,K:4   @NOS2   5
     C                     ELSE
     C                     Z-ADD1         K
     C                     MOVELAN1,1     @NOS1
     C                     MOVELAN1,K     @NOS2
     C                     ENDIF
      *
     C                     MOVEL'USR0019' @MSGID
     C                     MOVEL@NOS1     WMDTA1
     C                     MOVEL@NOS2     WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVELOSTATD    ONOST
      *
     C                     MOVEL'Y'       WCSTAT
     C                     MOVEL'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITENOSTO                  22
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P10    - Retrieve Branch Details Routine.          *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P10       BEGSR                           ** P10    **
      *
      **  Initialise fields.
      *
     C                     MOVEL*BLANKS   IMIDB
     C                     MOVEL*BLANKS   OMIDB1
     C                     MOVEL*BLANKS   OMIDB2
     C                     MOVEL*BLANKS   OMIDB3
     C                     MOVEL*BLANKS   OMIDB4
     C                     MOVEL*BLANKS   OMIDB5
     C                     MOVEL*BLANKS   OMIDB6
     C                     MOVEL*BLANKS   OMIDB7
     C                     MOVEL*BLANKS   OMIDB8
     C                     MOVEL*BLANKS   OMIDB9
     C                     MOVEL*BLANKS   OMID10
     C                     MOVEA*BLANKS   ABR
      *
     C                     MOVELFLDI1     IMIDB
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
      **  At the start, when no branch details have been loaded, set
      **  pointer to beginning of file.
      *
     C           IBBRCH    IFEQ '***'
     C           *LOVAL    SETLLSDBRCHL0
     C                     ELSE
      *
      **  Otherwise, IBBRCH contains the branch loaded last, so set
      **  pointer then load next record.
      *
     C           IBBRCH    CHAINSDBRCHL0             45
     C                     ENDIF
      *
     C                     READ SDBRCHL0                 45
      *
     C                     Z-ADD1         I
      *
      **  Load branch details. 50 is the max that can be sent at a time.
      *
     C           *IN45     DOWEQ'0'
     C           I         ANDLE50
      *
     C                     MOVELA8BRCD    OBBRCH
     C                     MOVELA8BRNM    OBBRNM
     C                     MOVELA8BICN    OBINCN
      *
     C                     MOVELOBBRBK    ABR,I
      *
     C                     ADD  1         I
      *
     C                     READ SDBRCHL0                 45
      *
     C                     ENDDO
      *
      **  EOF reached before 50 have been loaded.
      *
     C           *IN45     IFEQ '1'
     C           I         ANDLT50
      *
     C                     MOVEL*BLANKS   OBBRBK
     C                     MOVEL'***'     OBBRCH
      *
     C                     MOVELOBBRBK    ABR,I
      *
     C                     ENDIF
      *
      **  Load array contents to outgoing message.
      *
     C                     MOVEAABR,1     OMIDB2
     C                     MOVEAABR,7     OMIDB3
     C                     MOVEAABR,13    OMIDB4
     C                     MOVEAABR,19    OMIDB5
     C                     MOVEAABR,25    OMIDB6
     C                     MOVEAABR,31    OMIDB7
     C                     MOVEAABR,37    OMIDB8
     C                     MOVEAABR,43    OMIDB9
     C                     MOVEAABR,49    OMID10
      *
     C           I         IFGT 1
     C           I         SUB  1         K
     C                     ELSE
     C                     Z-ADD1         K
     C                     ENDIF
     C                     MOVELABR,1     @BRC1   3
     C                     MOVELABR,K     @BRC2   3
      *
     C                     MOVEL'USR0020' @MSGID
     C                     MOVEL@BRC1     WMDTA1
     C                     MOVEL@BRC2     WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
      *
     C                     MOVEL'Y'       WCSTAT
     C                     MOVEL'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     MOVELOSTATD    OMIDB1
      *
      **  Write Data Comms File.
      *
     C                     WRITEMIDBO                  22
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P11    - Branch Open Routine.                      *
      *                                                               *
      * CALLS      DBERR  - Database Error Handling.                  *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P11       BEGSR                           ** P11    **
      *
     C                     MOVEL*BLANKS   IBROP
     C                     MOVEL*BLANKS   OBROP
      *
     C                     MOVELFLDI1     IBROP
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
      **  Update branch status to open.
      *
     C           W#BRCA    CHAINSDBRCHL0             45
      *
      **  If no record found.
      *
     C           *IN45     IFEQ '1'
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0003' @MSGID
     C                     MOVELW#BRCA    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C           *LOCK     IN   LDA
     C                     MOVE 'SDBRCHPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD12        DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
     C           A8BRST    IFEQ 'O'
     C                     UNLCKSDBRCHL0
      *
     C                     MOVEL'USR0046' @MSGID
     C                     MOVELW#BRCA    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'W'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
     C                     MOVELOSTATD    OBROP
      *
     C                     ELSE
      *
     C                     MOVE 'O'       A8BRST
     C                     UPDAT@A8REB1                45
      *
     C                     MOVEL'USR0061' @MSGID
     C                     MOVELW#BRCA    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVELOSTATD    OBROP
      *
     C                     END
      *
      **  Write Data Comms File.
      *
     C                     MOVEL'Y'       WCSTAT
     C                     MOVEL'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITEBROPO                  22
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P12    - Branch Close Routine.                     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P12       BEGSR                           ** P12    **
      *
     C                     MOVEL*BLANKS   IBRCL
     C                     MOVEL*BLANKS   OBRCL
      *
     C                     MOVELFLDI1     IBRCL
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
     C           W#BRCA    CHAINTTRNM2L2             46
      *
      **  Tellers are still signed on to the system.
      *
     C           *IN46     IFEQ '1'
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0011' @MSGID
     C                     MOVELTBID      WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
      **  Update branch status to closed.
      *
     C           W#BRCA    CHAINSDBRCHL0             45
      *
     C           *IN45     IFEQ '1'
      *
     C                     MOVEL'Y'       WERROR
      *
     C                     MOVEL'USR0003' @MSGID
     C                     MOVELW#BRCA    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C           *LOCK     IN   LDA
     C                     MOVE 'SDBRCHPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD13        DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
     C                     ELSE
      *
     C                     MOVE 'C'       A8BRST
     C                     UPDAT@A8REB1
     C                     ENDIF
      *
     C                     MOVEL'USR0062' @MSGID
     C                     MOVELW#BRCA    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVELOSTATD    OBRCL
      *
     C                     MOVEL'Y'       WCSTAT
     C                     MOVEL'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
      **  Write Data Comms File.
      *
     C                     WRITEBRCLO                  22
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P13    - Sign-Off Routine.                         *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P13       BEGSR                           ** P13    **
      *
     C                     MOVEL*BLANKS   IKSOF
     C                     MOVEL*BLANKS   OKSOF
      *
     C                     MOVELFLDI1     IKSOF
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
     C                     MOVELW#TELD    KTBID
     C           KTTRNT    CHAINTTRNM2L1             30
      *
     C           *IN30     IFEQ *ON
     C           RECI      ORNE 'D'
      *
     C                     MOVEL'Y'       WERROR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0055' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVEL*BLANKS   @WRK4   4
     C                     MOVEL*BLANKS   @WRK5   5
     C           KTBRI     CAT  KTBID     @WRK4
     C           @WRK4     CAT  KRCTP     @WRK5
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'TTRNM2L1'DBFILE
     C                     MOVEL@WRK5     DBKEY
     C                     Z-ADD14        DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     ELSE
      *
     C           TST,A     IFEQ 'OFF'
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0006' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'W'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     ELSE
      *
      **  Update workstation id.
      *
     C                     MOVE *BLANKS   TWID
     C                     UPDATTTRNTM2F
      *
      **  Set teller status flag off.
      *
     C                     MOVEL'OFF'     TST,A
      *
     C                     MOVEL'USR0063' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVELW#BRCA    WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
      *
     C                     ENDIF
      *
     C                     MOVE 'Y'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     MOVELOSTATD    OKSOF
     C                     WRITEKSOFO                  22
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P14    - Sign-On Routine.                          *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P14       BEGSR                           ** P14    **
      *
     C                     MOVEL*BLANKS   IKSON
     C                     MOVEL*BLANKS   OKSON
      *
     C                     MOVELFLDI1     IKSON
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
     C                     MOVELW#TELD    KTBID
     C           KTTRNT    CHAINTTRNM2L1             30
      *
     C           *IN30     IFEQ *ON
     C           RECI      ORNE 'D'
      *
     C                     MOVEL'Y'       WERROR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0055' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVEL*BLANKS   @WRK4
     C                     MOVEL*BLANKS   @WRK5
     C           KTBRI     CAT  KTBID     @WRK4
     C           @WRK4     CAT  KRCTP     @WRK5
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'TTRNM2L1'DBFILE
     C                     MOVEL@WRK5     DBKEY
     C                     Z-ADD15        DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     ELSE
      *
     C           TWID      IFNE *BLANKS
      *
     C                     MOVEL'Y'       WERROR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0015' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVELTWID      WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'E'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4401'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM W#BRCA    P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C                     MOVEL*BLANKS   @WRK4
     C                     MOVEL*BLANKS   @WRK5
     C           KTBRI     CAT  KTBID     @WRK4
     C           @WRK4     CAT  KRCTP     @WRK5
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'TTRNM2L1'DBFILE
     C                     MOVEL@WRK5     DBKEY
     C                     Z-ADD17        DBASE
     C                     EXSR DBERR
      *
     C                     MOVE 'N'       WCSTAT  1
     C                     MOVE 'CS'      WMSTAT  2
     C                     EXSR WRTLOG
      *
     C                     WRITESTATO                  22
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     ELSE
      *
     C           TST,A     IFEQ ' ON'
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0005' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVE 'W'       O#HMSS
     C                     MOVE @MSGID    O#HMSI
      *
     C                     ELSE
      *
      **  Update workstation id.
      *
     C           'CASH'    CAT  JOBNUM    TWID
     C                     UPDATTTRNTM2F
      *
      **  Set teller status flag on.
      *
     C                     MOVEL' ON'     TST,A
      *
     C                     MOVEL'USR0064' @MSGID
     C                     MOVELW#TELD    WMDTA1
     C                     MOVELW#BRCA    WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
      *
     C                     ENDIF
      *
     C                     MOVE 'Y'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     MOVELOSTATD    OKSON
     C                     WRITEKSONO                  22
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P15    - Retail Rates Routine.                     *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P15       BEGSR                           ** P15    **
      *
     C                     MOVEL*BLANKS   ICPRR
     C                     MOVEL*BLANKS   OCPRRD
     C                     MOVEA*BLANKS   AR1
     C                     MOVEA*BLANKS   AR2
      *
     C                     Z-ADD1         I
      *
     C                     MOVELFLDI1     ICPRR
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
      **  At the start, no retail rates have yet been loaded, set
      **  pointer to the beginning of the file.
      *
     C           IRRRTY    IFEQ '***'
     C           *LOVAL    SETLLSDCURRL0
     C                     MOVEL'CSH'     WRRTY   3
     C                     MOVELNAR,1     WRRDS  35
     C                     ELSE
      *
      **  Otherwise, some retail rates have already been loaded, WCCYSV
      **  contains the last rate loaded, set pointer to that position,
      **  then read next record.
      *
     C           WCCYSV    IFNE *BLANKS
     C           WCCYSV    CHAINSDCURRL0             42
     C                     ENDIF
     C                     ENDIF
      *
     C                     READ SDCURRL0                 42
      *
      **  Assign values.
      *
     C           *IN42     DOWEQ'0'
     C           I         ANDLE10
      *
     C                     MOVELA6CYCD    WCCYSV  3
     C                     Z-ADDA6SMLD    WSMLD   50
      *
      **  Smallest denomination to have decimal point.
      *
     C                     MOVEL*BLANKS   ZFIELD
     C                     MOVE WSMLD     ZFIELD
     C                     Z-ADDA6NBDP    ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    WMNDN   8
     C                     MOVEL*BLANKS   WFIELD 16
     C                     MOVELWMNDN     WFIELD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   WMNDN
     C                     MOVEARATE,1    WMNDN
      *
      **  Assign appropriate values.
      *
     C                     MOVEL*BLANKS   OCPRRB
     C                     MOVELWRRTY     ORRRTY
     C                     MOVELWRRDS     ORRRDS
     C                     MOVELA6CYCD    ORCCY
     C                     MOVELA6ISON    ORCCYN
     C                     MOVELA6CYNM    ORCCYD
     C                     MOVELA6NBDP    OREDCD
     C           A6MDIN    IFEQ 'M'
     C                     MOVEL'Y'       ORRCFL
     C                     ELSE
     C                     MOVEL'N'       ORRCFL
     C                     END
     C           A6CYCD    IFEQ BJCYCD
     C                     MOVEL'N'       ORRCFL
     C                     END
     C                     MOVE '0000.000'ORBYCM
     C                     MOVE WMNDN     ORBMDN
     C                     MOVE '0000.000'ORSLCM
     C                     MOVE WMNDN     ORSMDN
      *                                                                   141921
      **  If CRT104 is on, retrieve rates from PF/REBDCRPD.               141921
      *                                                                   141921
     C           CRT104    IFEQ 'Y'                                       141921
      *                                                                   141921
     C           A6CYCD    CHAINREBDCRPD             43                   141921
      *                                                                   141921
     C           *IN43     IFEQ '1'                                       141921
      *                                                                   141921
     C                     MOVEL'Y'       WERROR                          141921
      *                                                                   141921
     C                     MOVEL'USR0045' @MSGID                          141921
     C                     MOVELA6CYCD    WMDTA1                          141921
     C                     MOVEL*BLANKS   WMDTA2                          141921
     C           WMDTA1    CAT  WMDTA2    @MSGDT                          141921
     C                     EXSR RTVMSG                                    141921
     C                     MOVEL@MSGTX    O#HMSG                          141921
     C                     MOVE 'E'       O#HMSS                          141921
     C                     MOVE @MSGID    O#HMSI                          141921
      *                                                                   141921
     C                     CALL 'REC4411'                                 141921
     C                     PARM 'RE4401'  PROG                            141921
     C                     PARM           JOBNUM                          141921
     C                     PARM '0000'    MMCODE                          141921
     C                     PARM *BLANKS   P#BRCA                          141921
     C                     PARM           @MSGID                          141921
     C                     PARM           @MSGDT                          141921
      *                                                                   141921
     C           *LOCK     IN   LDA                                       141921
     C                     MOVE 'REBDCRPD'DBFILE                          141921
     C                     MOVEL@OPTN     DBKEY                           141921
     C                     Z-ADD9         DBASE                           141921
     C                     EXSR DBERR                                     141921
      *                                                                   141921
     C                     MOVE 'N'       WCSTAT  1                       141921
     C                     MOVE 'CS'      WMSTAT  2                       141921
     C                     EXSR WRTLOG                                    141921
      *                                                                   141921
     C                     WRITESTATO                  22                 141921
      *                                                                   141921
     C                     ELSE                                           141921
      *                                                                   141921
      **  Edit rates to include decimal points before assigning to output 141921
      *                                                                   141921
     C***********IRRRTY    IFEQ 'CSH'                              141921 CEU025
     C***********IRRTYP    IFEQ 'CSH'                                     CEU025              164946
     C           IRRRTY    IFEQ 'CSH'                                                         164946
      *                                                                   141921
     C                     MOVEL*ZEROS    ORBYRT                          141921
     C                     Z-ADD*ZEROS    W#RT   138                      141921
     C                     MOVEL*BLANKS   ZFIELD                          141921
     C           FEDNRT    DIV  FEAMNT    W#RT                            141921
     C                     MOVE W#RT      ZFIELD                          141921
     C                     Z-ADD8         ZADEC                           141921
     C                     EXSR ZEDIT                                     141921
     C           13        SUBSTZFIELD:3  ORBYRT                          141921
     C                     MOVEL*BLANKS   WFIELD 16                       141921
     C                     MOVELORBYRT    WFIELD                          141921
     C                     EXSR PAD                                       141921
     C                     MOVEL*BLANKS   ORBYRT                          141921
     C                     MOVEARATE,1    ORBYRT                          141921
      *                                                                   CEU025
     C                     MOVEL*BLANKS   OREXBR                          CEU025
     C                     MOVEARATE,1    OREXBR                          CEU025
      *                                                                   CEU025
     C                     MOVEL*BLANKS   OREBPR                          CEU025
     C                     MOVEARATE,1    OREBPR                          CEU025
      *                                                                   141921
     C                     MOVEL*ZEROS    ORSLRT                          141921
     C                     Z-ADD*ZEROS    W#RT                            141921
     C                     MOVEL*BLANKS   ZFIELD                          141921
     C           FEDPRT    DIV  FEAMNT    W#RT                            141921
     C                     MOVE W#RT      ZFIELD                          141921
     C                     Z-ADD8         ZADEC                           141921
     C                     EXSR ZEDIT                                     141921
     C           13        SUBSTZFIELD:3  ORSLRT                          141921
     C                     MOVEL*BLANKS   WFIELD 16                       141921
     C                     MOVELORSLRT    WFIELD                          141921
     C                     EXSR PAD                                       141921
     C                     MOVEL*BLANKS   ORSLRT                          141921
     C                     MOVEARATE,1    ORSLRT                          141921
      *                                                                   CEU025
     C                     MOVEL*BLANKS   OREXSR                          CEU025
     C                     MOVEARATE,1    OREXSR                          CEU025
      *                                                                   CEU025
     C                     MOVEL*BLANKS   ORESPR                          CEU025
     C                     MOVEARATE,1    ORESPR                          CEU025
      *                                                                   141921
     C                     ELSE                                           141921
      *                                                                   141921
     C                     MOVEL*ZEROS    ORBYRT                          141921
     C                     Z-ADD*ZEROS    W#RT   138                      141921
     C                     MOVEL*BLANKS   ZFIELD                          141921
     C           FEVNRT    DIV  FEAMNT    W#RT                            141921
     C                     MOVE W#RT      ZFIELD                          141921
     C                     Z-ADD8         ZADEC                           141921
     C                     EXSR ZEDIT                                     141921
     C           13        SUBSTZFIELD:3  ORBYRT                          141921
     C                     MOVEL*BLANKS   WFIELD 16                       141921
     C                     MOVELORBYRT    WFIELD                          141921
     C                     EXSR PAD                                       141921
     C                     MOVEL*BLANKS   ORBYRT                          141921
     C                     MOVEARATE,1    ORBYRT                          141921
      *                                                                   141921
     C                     MOVEL*ZEROS    ORSLRT                          141921
     C                     Z-ADD*ZEROS    W#RT                            141921
     C                     MOVEL*BLANKS   ZFIELD                          141921
     C           FEVPRT    DIV  FEAMNT    W#RT                            141921
     C                     MOVE W#RT      ZFIELD                          141921
     C                     Z-ADD8         ZADEC                           141921
     C                     EXSR ZEDIT                                     141921
     C           13        SUBSTZFIELD:3  ORSLRT                          141921
     C                     MOVEL*BLANKS   WFIELD 16                       141921
     C                     MOVELORSLRT    WFIELD                          141921
     C                     EXSR PAD                                       141921
     C                     MOVEL*BLANKS   ORSLRT                          141921
     C                     MOVEARATE,1    ORSLRT                          141921
      *                                                                   141921
     C                     ENDIF                                          141921
      *                                                                   141921
     C                     ENDIF                                          141921
      *                                                                   141921
     C                     ELSE                                           141921
      *
     C                     MOVEL*BLANKS   ZFIELD
     C                     MOVE A6SPRT    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C           13        SUBSTZFIELD:3  ORBYRT
     C                     MOVEL*BLANKS   WFIELD 16
     C                     MOVELORBYRT    WFIELD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   ORBYRT
     C                     MOVEARATE,1    ORBYRT
     C                     MOVE ORBYRT    ORSLRT                          141921
      *                                                                   141921
     C                     ENDIF                                          141921
      *                                                                   141921
      *
     C                     MOVEL*ZEROS    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C           13        SUBSTZFIELD:3  ORBPRT
     C                     MOVEL*BLANKS   WFIELD 16
     C                     MOVELORBPRT    WFIELD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   ORBPRT
     C                     MOVEARATE,1    ORBPRT
      *
     C                     MOVEL*ZEROS    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    ORBPAM
     C                     MOVEL*BLANKS   WFLD   16
     C                     MOVELORBPAM    WFLD
     C                     EXSR PAD
     C                     MOVEL*BLANKS   ORBPAM
     C                     MOVEARATE,1    ORBPAM
      *
     C***********          MOVE ORBYRT    ORSLRT                          141921
     C                     MOVE ORBPRT    ORSPRT
     C                     MOVE ORBPAM    ORSPAM
      *
     C           CEU025    IFEQ 'Y'                                       CEU025
      *                                                                   CEU025
     C           A6INCY    IFEQ 'Y'                                       CEU025
     C           BJRDNB    ANDGEA6TPSD                                    175838
     C********** BJRDNB    ANDLEA6TPED                                                 175838 199373
     C                     MOVEL'Y'       ORMBFL                          CEU025
     C                     ELSE                                           CEU025
     C                     MOVEL'N'       ORMBFL                          CEU025
     C                     ENDIF                                          CEU025
      *                                                                   CEU025
     C                     ELSE                                           CEU025
     C                     MOVEL'N'       ORMBFL                          CEU025
     C                     ENDIF                                          CEU025
      *                                                                   CEU025
     C                     MOVELORORS1    AR1,I
     C                     MOVELORORS2    AR2,I
      *
     C                     ADD  1         I
      *
     C                     READ SDCURRL0                 42
      *
     C           WERROR    IFEQ 'N'
     C           *IN42     ANDEQ'1'
     C           I         ANDLE10
     C***********IRRRTY    ANDNE'TCQ'                                     CEU025
     C***********IRRTYP    ANDNE'TCQ'                                     CEU025              164946
     C           IRRRTY    ANDNE'TCQ'                                                         164946
      *
     C                     MOVEL'TCQ'     WRRTY
     C                     MOVELNAR,2     WRRDS
     C           *LOVAL    SETLLSDCURRL0
     C                     READ SDCURRL0                 42
      *
     C                     ENDIF
      *
     C                     ENDDO
      *
      **  EOF encountered before 10 elements have been filled up.
      *
     C           WERROR    IFEQ 'N'
      *
     C           *IN42     IFEQ '1'
     C           I         ANDLE10
     C***********IRRRTY    ANDEQ'TCQ'                                     CEU025
     C***********IRRTYP    ANDEQ'TCQ'                                     CEU025              164946
     C           IRRRTY    ANDEQ'TCQ'                                                         164946
      *
      **  Move '***' to last CCY block when EOF reached.
      *
     C                     MOVEL*BLANK    OCPRRB
     C                     MOVEL'***'     ORRRTY
     C                     MOVELORORS1    AR1,I
     C                     MOVELORORS2    AR2,I
      *
     C                     ELSE
      *
     C           *IN42     IFEQ '1'
     C           I         ANDGT10
     C***********IRRRTY    ANDNE'TCQ'                                     CEU025
     C***********IRRTYP    ANDNE'TCQ'                                     CEU025              164946
     C           IRRRTY    ANDNE'TCQ'                                                         164946
      *
     C                     MOVEL'TCQ'     WRRTY
     C                     MOVELNAR,2     WRRDS
     C           *LOVAL    SETLLSDCURRL0
     C                     MOVEL*BLANKS   WCCYSV
      *
     C                     ELSE
      *
     C           *IN42     IFEQ '1'
     C           I         ANDGT10
     C***********IRRRTY    ANDEQ'TCQ'                                     CEU025
     C***********IRRTYP    ANDEQ'TCQ'                                     CEU025              164946
     C           IRRRTY    ANDEQ'TCQ'                                                         164946
     C           AR1,1     ANDEQ*BLANKS
      *
      **  Move '***' to last CCY block when EOF reached.
      *
     C                     MOVEL*BLANK    OCPRRB
     C                     MOVEL'***'     ORRRTY
     C                     MOVELORORS1    AR1,1
     C                     MOVELORORS2    AR2,1
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Move array contents to outgoing message.
      *
     C                     MOVELAR1,1     ORD01A
     C                     MOVELAR2,1     ORD01B
     C                     MOVELAR1,2     ORD02A
     C                     MOVELAR2,2     ORD02B
     C                     MOVELAR1,3     ORD03A
     C                     MOVELAR2,3     ORD03B
     C                     MOVELAR1,4     ORD04A
     C                     MOVELAR2,4     ORD04B
     C                     MOVELAR1,5     ORD05A
     C                     MOVELAR2,5     ORD05B
     C                     MOVELAR1,6     ORD06A
     C                     MOVELAR2,6     ORD06B
     C                     MOVELAR1,7     ORD07A
     C                     MOVELAR2,7     ORD07B
     C                     MOVELAR1,8     ORD08A
     C                     MOVELAR2,8     ORD08B
     C                     MOVELAR1,9     ORD09A
     C                     MOVELAR2,9     ORD09B
     C                     MOVELAR1,10    ORD10A
     C                     MOVELAR2,10    ORD10B
      *
      **  Write Data Comms File.
      *
     C           I         IFGT 1
     C           I         SUB  1         K
     C                     ELSE
     C                     Z-ADD1         K
     C                     ENDIF
     C                     MOVELAR1,1     @RRT1   3
     C                     MOVELAR1,K     @RRT2   3
     C           3         SUBSTAR1,1:39  @CCY1   3
     C           3         SUBSTAR1,K:39  @CCY2   3
      *
     C                     MOVEL'USR0025' @MSGID
     C           @RRT1     CAT  @CCY1     WMDTA1
     C           @RRT2     CAT  @CCY2     WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL@MSGTX    O#HMSG
     C                     MOVELOSTATD    OCPRR
      *
     C                     MOVE 'Y'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     WRITECPRRO                  22
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            P16    - Alternative Currency Descriptions Routine.*
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  P05    - Retrieve Message Details Processing.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           P16       BEGSR                           ** P16    **
      *
     C                     MOVEL*BLANKS   ICDES
     C                     MOVEL*BLANKS   OCDES
     C                     MOVEA*BLANKS   ACD
      *
     C                     Z-ADD1         I
      *
     C                     MOVELFLDI1     ICDES
     C                     MOVELI#MSTY    O#MSTY
     C                     MOVELW#BRCA    O#BRCA
     C                     MOVELW#TELD    O#TELD
      *
      **  At the start, no currencies have yet been loaded, set
      **  pointer to the beginning of the file.
      *
     C           IDCCY     IFEQ '***'
     C           *LOVAL    SETLLSDCURRL0
     C                     ELSE
      *
      **  Otherwise, some currencies have already been loaded, IDCCY
      **  contains the last CCY loaded, set pointer to that position,
      **  then read next record.
      *
     C           IDCCY     CHAINSDCURRL0             42
     C                     ENDIF
      *
     C                     READ SDCURRL0                 42
      *
      **  Assign values.
      *
     C           *IN42     DOWEQ'0'
     C           I         ANDLE16
      *
     C                     MOVEL*BLANKS   OCDESB
     C                     MOVELA6CYCD    ODCCY
     C                     MOVELA6MACD    ODMJCD
     C                     MOVELA6FRAC    ODFRFL
     C                     MOVELA6NUWD    ODNMWD
     C                     MOVELA6MICD    ODMNCD
      *
     C                     MOVELOCDESB    ACD,I
      *
     C                     ADD  1         I
      *
     C                     READ SDCURRL0                 42
      *
     C                     ENDDO
      *
      **  EOF encountered before 16 elements have been filled up.
      *
     C           WERROR    IFEQ 'N'
      *
     C           *IN42     IFEQ '1'
     C           I         ANDLE16
      *
      **  Move '***' to last CCY block when EOF reached.
      *
     C                     MOVEL*BLANK    OCDESB
     C                     MOVEL'***'     ODCCY
     C                     MOVELOCDESB    ACD,I
      *
     C                     ENDIF
      *
      **  Move array contents to outgoing message.
      *
     C                     MOVELACD,1     ODD01
     C                     MOVELACD,2     ODD02
     C                     MOVELACD,3     ODD03
     C                     MOVELACD,4     ODD04
     C                     MOVELACD,5     ODD05
     C                     MOVELACD,6     ODD06
     C                     MOVELACD,7     ODD07
     C                     MOVELACD,8     ODD08
     C                     MOVELACD,9     ODD09
     C                     MOVELACD,10    ODD10
     C                     MOVELACD,11    ODD11
     C                     MOVELACD,12    ODD12
     C                     MOVELACD,13    ODD13
     C                     MOVELACD,14    ODD14
     C                     MOVELACD,15    ODD15
     C                     MOVELACD,16    ODD16
      *
      **  Write Data Comms File.
      *
     C           I         IFGT 1
     C           I         SUB  1         K
     C                     ELSE
     C                     Z-ADD1         K
     C                     ENDIF
     C                     MOVELACD,1     @DCY1   3
     C                     MOVELACD,K     @DCY2   3
      *
     C                     MOVEL'USR0026' @MSGID
     C                     MOVEL@DCY1     WMDTA1
     C                     MOVEL@DCY2     WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     EXSR RTVMSG
      *
     C                     MOVEL'C'       O#HMSS
     C                     MOVEL*BLANKS   O#HMSI
     C                     MOVEL*BLANKS   O#HMSG
      *
     C                     MOVE 'Y'       WCSTAT
     C                     MOVE 'CS'      WMSTAT
     C                     EXSR WRTLOG
      *
     C                     MOVELOSTATD    OCDES
     C                     WRITECDESO                  22
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************   118528
      /EJECT                                                              118528
      *****************************************************************   118528
      *                                                               *   118528
      *            P17    - Reversal of Account Balance Hold.         *   118528
      *                                                               *   118528
      * CALLS      DBERR  - Database Error Handling.                  *   118528
      *            RTVMSG - Retrieve Program message details          *   118528
      *            WRTLOG - Write to Communications Log               *   118528
      *            PAD    - Pad field with leading zeros              *   118528
      *            ZDATE9 -                                           *   118528
      *                                                               *   118528
      * CALLED BY  COMMSG - Comms Message Processing                  *   118528
      *                                                               *   118528
      * FLDS USED         -                                           *   118528
      *                                                               *   118528
      *****************************************************************   118528
     C           P17       BEGSR                           ** P17    **   118528
      *                                                                   118528
      **  Initialise fields.                                              118528
      *                                                                   118528
     C                     MOVEL*BLANKS   IRACBD                          118528
     C                     MOVEL*BLANKS   ORACBD                          118528
      *                                                                   118528
      **  Assign values.                                                  118528
      *                                                                   118528
     C                     MOVELFLDI1     IRACBD                          118528
     C                     MOVELI#MSTY    O#MSTY                          118528
     C                     MOVELW#BRCA    O#BRCA                          118528
     C                     MOVELW#TELD    O#TELD                          118528
      *                                                                   118528
      **  Access LF/MEMOSL1                                               118528
      *                                                                   118528
     C                     MOVELIRAACN    WK13   13                       118528
     C                     MOVE WK13      W#AACN 100                      118528
      *                                                                   118528
     C                     CALL 'AOMEMSR0'                                118528
     C                     PARM *BLANKS   @RTCD                           118528
     C                     PARM '*KEY    '@OPTN                           118528
     C                     PARM W#AACN    @RETL  100                      118528
     C**********           PARM 0         W#CNUM  60                                   118528 CSD027
     C                     PARM *BLANKS   W#CNUM  6                                           CSD027
     C                     PARM *BLANKS   W#CCY   3                       118528
     C                     PARM 0         W#ACDD  40                      118528
     C                     PARM 0         W#ACSQ  20                      118528
     C                     PARM *BLANKS   W#BRCA  3                       118528
     C           DSMEMS    PARM DSMEMS    DSFDY                           118528
      *                                                                   118528
      **  Shadow Balance not found.                                       118528
      *                                                                   118528
     C           @RTCD     IFNE *BLANK                                    118528
      *                                                                   118528
     C                     MOVEL'Y'       WERROR                          118528
      *                                                                   118528
      **  Retrieve error message data to send in host message.            118528
      *                                                                   118528
     C                     MOVEL'USR0073' @MSGID                          118528
     C                     MOVELW#BRCA    WMDTA1                          118528
     C                     MOVEL*BLANKS   WMDTA2                          118528
     C           WMDTA1    CAT  WMDTA2    @MSGDT                          118528
     C                     EXSR RTVMSG                                    118528
     C                     MOVEL@MSGTX    O#HMSG                          118528
     C                     MOVE 'E'       O#HMSS                          118528
     C                     MOVE @MSGID    O#HMSI                          118528
      *                                                                   118528
      **  Report Error.                                                   118528
      *                                                                   118528
     C                     CALL 'REC4411'                                 118528
     C                     PARM 'RE4401'  PROG                            118528
     C                     PARM           JOBNUM                          118528
     C                     PARM '0000'    MMCODE                          118528
     C                     PARM W#BRCA    P#BRCA                          118528
     C                     PARM           @MSGID                          118528
     C                     PARM           @MSGDT                          118528
      *                                                                   118528
     C           *LOCK     IN   LDA                                       118528
     C                     MOVEL'MEMOS   'DBFILE                          118528
     C                     MOVEL@OPTN     DBKEY                           118528
     C                     Z-ADD23        DBASE                           118528
     C                     EXSR DBERR                                     118528
      *                                                                   118528
     C                     MOVE 'N'       WCSTAT  1                       118528
     C                     MOVE 'CS'      WMSTAT  2                       118528
     C                     EXSR WRTLOG                                    118528
      *                                                                   118528
     C                     WRITESTATO                  22                 118528
      *                                                                   118528
      **  Shadow balance found                                            118528
      *                                                                   118528
     C                     ELSE                                           118528
      *                                                                   118528
      **  Retrieve overdraft, currency and held amounts.                  118528
      *                                                                   118528
     C           W#AACN    CHAINACNUMF               31                   118528
      *                                                                   118528
      **  Account Details not found                                       118528
      *                                                                   118528
     C           *IN31     IFEQ '1'                                       118528
      *                                                                   118528
     C                     MOVEL'Y'       WERROR                          118528
      *                                                                   118528
      **  Retrieve error message data to send in host message.            118528
      *                                                                   118528
     C                     MOVEL'USR0074' @MSGID                          118528
     C                     MOVELW#BRCA    WMDTA1                          118528
     C                     MOVEL*BLANKS   WMDTA2                          118528
     C           WMDTA1    CAT  WMDTA2    @MSGDT                          118528
     C                     EXSR RTVMSG                                    118528
     C                     MOVEL@MSGTX    O#HMSG                          118528
     C                     MOVE 'E'       O#HMSS                          118528
     C                     MOVE @MSGID    O#HMSI                          118528
      *                                                                   118528
      **  Report Error.                                                   118528
      *                                                                   118528
     C                     CALL 'REC4411'                                 118528
     C                     PARM 'RE4401'  PROG                            118528
     C                     PARM           JOBNUM                          118528
     C                     PARM '0000'    MMCODE                          118528
     C                     PARM W#BRCA    P#BRCA                          118528
     C                     PARM           @MSGID                          118528
     C                     PARM           @MSGDT                          118528
      *                                                                   118528
     C           *LOCK     IN   LDA                                       118528
     C                     MOVEL'ACNUM   'DBFILE                          118528
     C                     MOVELW#AACN    DBKEY                           118528
     C                     Z-ADD24        DBASE                           118528
     C                     EXSR DBERR                                     118528
      *                                                                   118528
     C                     MOVE 'N'       WCSTAT  1                       118528
     C                     MOVE 'CS'      WMSTAT  2                       118528
     C                     EXSR WRTLOG                                    118528
      *                                                                   118528
     C                     WRITESTATO                  22                 118528
      *                                                                   118528
      **  Account Details found                                           118528
      *                                                                   118528
     C                     ELSE                                           118528
      *                                                                   118528
     C           CCY       CHAINSDCURRL0             42                   118528
      *                                                                   118528
      **  Currency not found                                              118528
      *                                                                   118528
     C           *IN42     IFEQ '1'                                       118528
      *                                                                   118528
     C                     MOVEL'Y'       WERROR                          118528
      *                                                                   118528
      **  Retrieve error message data to send in host message.            118528
      *                                                                   118528
     C                     MOVEL'USR0047' @MSGID                          118528
     C                     MOVELW#BRCA    WMDTA1                          118528
     C                     MOVEL*BLANKS   WMDTA2                          118528
     C           WMDTA1    CAT  WMDTA2    @MSGDT                          118528
     C                     EXSR RTVMSG                                    118528
     C                     MOVEL@MSGTX    O#HMSG                          118528
     C                     MOVE 'E'       O#HMSS                          118528
     C                     MOVE @MSGID    O#HMSI                          118528
      *                                                                   118528
      **  Report Error.                                                   118528
      *                                                                   118528
     C                     CALL 'REC4411'                                 118528
     C                     PARM 'RE4401'  PROG                            118528
     C                     PARM           JOBNUM                          118528
     C                     PARM '0000'    MMCODE                          118528
     C                     PARM W#BRCA    P#BRCA                          118528
     C                     PARM           @MSGID                          118528
     C                     PARM           @MSGDT                          118528
      *                                                                   118528
     C           *LOCK     IN   LDA                                       118528
     C                     MOVEL'SDCURRL0'DBFILE                          118528
     C                     MOVELCCY       DBKEY                           118528
     C                     Z-ADD25        DBASE                           118528
     C                     EXSR DBERR                                     118528
      *                                                                   118528
     C                     MOVE 'N'       WCSTAT  1                       118528
     C                     MOVE 'CS'      WMSTAT  2                       118528
     C                     EXSR WRTLOG                                    118528
      *                                                                   118528
     C                     WRITESTATO                  22                 118528
      *                                                                   118528
      **  Currency found                                                  118528
      *                                                                   118528
     C                     ELSE                                           118528
      *                                                                   118528
      **  Format Balance with correct decimal places                      118528
      *                                                                   118528
     C                     MOVEL*BLANK    ORAVBL                          118528
      *                                                                   118528
      **  Overdraft has expired.                                          118528
      *                                                                   118528
     C           ODED      IFLT BJRDNB                                    118528
     C                     Z-ADD0         @ODLN  150                      118528
      *                                                                   118528
      **  Overdraft has not expired                                       118528
      *                                                                   118528
     C                     ELSE                                           118528
     C                     Z-ADDODLN      @ODLN                           118528
     C                     ENDIF                                          118528
      *                                                                   118528
      ** Calculate available balance                                      118528
      *                                                                   118528
     C                     Z-ADDCLBLN     W#AVBL 160                      118528
     C           W#AVBL    IFLT 0                                         118528
     C                     Z-SUBW#AVBL    W#AVBL                          118528
     C                     ENDIF                                          118528
     C                     SUB  @ODLN     W#AVBL                          118528
     C                     ADD  HELD      W#AVBL                          118528
      *                                                                   118528
     C                     MOVE W#AVBL    ZFIELD                          118528
     C                     Z-ADDA6NBDP    ZADEC                           118528
     C                     EXSR ZEDIT                                     118528
     C                     MOVEL*BLANKS   WFIELD 16                       118528
     C                     MOVE ZFIELD    WFIELD                          118528
     C                     EXSR PAD                                       118528
     C                     MOVEARATE,1    ORAVBL                          118528
      *                                                                   118528
      **  Assign appropriate Available Balance sign                       118528
      *                                                                   118528
     C           CLBLN     IFGE 0                                         118528
     C                     MOVE '+'       ORAVBS                          118528
     C                     ELSE                                           118528
     C                     MOVE '-'       ORAVBS                          118528
     C                     ENDIF                                          118528
      *                                                                   118528
     C                     ENDIF                                          118528
      *                                                                   118528
     C                     ENDIF                                          118528
      *                                                                   118528
     C                     ENDIF                                          118528
      *                                                                   118528
      ** Assign Value to Funds to be Cleared field.                       118528
      *                                                                   118528
     C                     MOVEL*BLANKS   ORFBCF                          118528
      *                                                                   118528
     C                     MOVEL*BLANKS   ORFTBC                          118528
     C           CLBLN     SUB  LDBLN     WK16   160                      118528
     C                     MOVELWK16      ZFIELD                          118528
     C                     Z-ADDA6NBDP    ZADEC                           118528
     C                     EXSR ZEDIT                                     118528
     C                     MOVEL*BLANKS   WFIELD 16                       118528
     C                     MOVE ZFIELD    WFIELD                          118528
     C                     EXSR PAD                                       118528
     C                     MOVEARATE,1    ORFTBC                          118528
      *                                                                   118528
      ** Set date/time stamp                                              118528
      *                                                                   118528
     C           *LOCK     IN   CITFTS                                    118528
     C                     Z-ADD0         WNSNS   20                      118528
     C                     MOVE WNNSS     WNSNS                           118528
     C                     ADD  1         WNSNS                           118528
      *                                                                   118528
     C                     MOVE *BLANKS   WNNSS                           118528
     C                     MOVE WNSNS     WNNSS                           118528
     C                     OUT  CITFTS                                    118528
      *                                                                   118528
     C                     Z-ADDBJRDNB    @@DAYN  50                      118528
     C                     EXSR ZDATE9                                    118528
     C           @@RTN     IFEQ '0'                                       118528
     C                     MOVE @@VDT     WCDAT   7                       118528
     C                     ENDIF                                          118528
     C           @@YR      IFGE 2000                                      118528
     C                     MOVEL'1'       WCDAT                           118528
     C                     ELSE                                           118528
     C                     MOVEL'0'       WCDAT                           118528
     C                     ENDIF                                          118528
      *                                                                   118528
     C                     TIME           WTIME   60                      118528
     C                     MOVE WTIME     WTIMEC  6                       118528
      *                                                                   118528
     C           WCDAT     CAT  WTIMEC    WDT13  13                       118528
     C           WDT13     CAT  WNNSS     ORTMST                          118528
      *                                                                   118528
      **  Write Data Comms File.                                          118528
      *                                                                   118528
     C           WERROR    IFEQ 'N'                                       118528
      *                                                                   118528
     C                     MOVEL'USR0075' @MSGID                          118528
     C                     MOVEL*BLANKS   WMDTA1                          118528
     C                     MOVEL*BLANKS   WMDTA2                          118528
     C                     EXSR RTVMSG                                    118528
      *                                                                   118528
     C                     MOVEL'C'       O#HMSS                          118528
     C                     MOVEL*BLANKS   O#HMSI                          118528
     C                     MOVEL@MSGTX    O#HMSG                          118528
     C                     MOVELOSTATD    ORACB                           118528
      *                                                                   118528
     C                     MOVEL'Y'       WCSTAT                          118528
     C                     MOVEL'CS'      WMSTAT                          118528
     C                     EXSR WRTLOG                                    118528
      *                                                                   118528
     C                     WRITERACBO                  22                 118528
      *                                                                   118528
     C                     ENDIF                                          118528
      *                                                                   118528
     C                     ENDSR                                          118528
      *****************************************************************
      /EJECT                                                              CEU025
      *****************************************************************   CEU025
      *                                                               *   CEU025
      *            P18    - Fixed Rates Download Routine              *   CEU025
      *                                                               *   CEU025
      * CALLS      ZEDIT  - Insert decimal point and 0s for numeric.  *   CEU025
      *            PAD    - Pad field with leading zeros              *   CEU025
      *            RTVMSG - Retrieve Program message details          *   CEU025
      *            WRTLOG - Write to Communications Log               *   CEU025
      *                                                               *   CEU025
      * CALLED BY  COMMSG - Comms Message Processing                  *   CEU025
      *                                                               *   CEU025
      * FLDS USED         -                                           *   CEU025
      *                                                               *   CEU025
      *****************************************************************   CEU025
     C           P18       BEGSR                                          CEU025
      *                                                                   CEU025
      **  Initialise fields.                                              CEU025
      *                                                                   CEU025
     C                     MOVEL*BLANKS   IFRAT                           CEU025
     C                     MOVEL*BLANKS   OFRATD                          CEU025
     C                     MOVEL*BLANKS   AFR                             CEU025
      *                                                                   CEU025
     C                     Z-ADD1         I                               CEU025
     C***********          Z-ADD0         WRATE1 138                      CEU025              164948
     C***********          Z-ADD0         WRATE2 138                      CEU025              164948
     C***********          Z-ADD0         WRATE3 138                      CEU025              164948
     C                     Z-ADD0         WRATE1 148                                          164948
     C                     Z-ADD0         WRATE2 148                                          164948
     C                     Z-ADD0         WRATE3 148                                          164948
      *                                                                   CEU025
     C                     MOVELFLDI1     IFRAT                           CEU025
     C                     MOVELI#MSTY    O#MSTY                          CEU025
     C                     MOVELW#BRCA    O#BRCA                          CEU025
     C                     MOVELW#TELD    O#TELD                          CEU025
      *                                                                   CEU025
     C           CEU025    IFEQ 'Y'                                       CEU025
      *                                                                   CEU025
     C***********CRT104    IFEQ 'Y'                        B*1            CEU025              164948
      ***********                                                         CEU025              164948
     C***********          CALL 'AOGELRR0'                                CEU025              164948
     C***********          PARM '*BLANK ' @RTCD   7                       CEU025              164948
     C***********          PARM '*FIRST ' @OPTN   7                       CEU025              164948
     C***********SDGELR    PARM SDGELR    DSFDY                           CEU025              164948
      ***********                                                         CEU025              164948
      ****If*error*on*access*to*General*Ledger*Details.                   CEU025              164948
      ***********                                                         CEU025              164948
     C***********@RTCD     IFNE *BLANKS                    B*2            CEU025              164948
      ***********                                                         CEU025              164948
      ****Report*error.                                                   CEU025              164948
      ***********                                                         CEU025              164948
     C***********          MOVEL'USR0077' @MSGID                          CEU025              164948
     C***********          MOVEL*BLANKS   WMDTA1                          CEU025              164948
     C***********          MOVEL*BLANKS   WMDTA2                          CEU025              164948
     C***********          EXSR RTVMSG                                    CEU025              164948
     C***********          MOVEL@MSGTX    O#HMSG                          CEU025              164948
     C***********          MOVE 'E'       O#HMSS                          CEU025              164948
     C***********          MOVE @MSGID    O#HMSI                          CEU025              164948
      ***********                                                         CEU025              164948
     C***********          CALL 'REC4411'                                 CEU025              164948
     C***********          PARM 'RE4401'  PROG   10                       CEU025              164948
     C***********          PARM           JOBNUM  6                       CEU025              164948
     C***********          PARM '0000'    MMCODE  4                       CEU025              164948
     C***********          PARM *BLANKS   P#BRCA  3                       CEU025              164948
     C***********          PARM           @MSGID  7                       CEU025              164948
     C***********          PARM *BLANKS   @MSGDT                          CEU025              164948
      ***********                                                         CEU025              164948
     C***********          MOVE 'N'       WCSTAT                          CEU025              164948
     C***********          MOVE 'CR'      WMSTAT                          CEU025              164948
     C***********          EXSR WRTLOG                                    CEU025              164948
      ***********                                                         CEU025              164948
     C***********          WRITESTATO                  22                 CEU025              164948
      ***********                                                         CEU025              164948
      ****Set*up*LDA*DBERR.                                               CEU025              164948
      ***********                                                         CEU025              164948
     C************LOCK     IN   LDA                                       CEU025              164948
     C***********          MOVEL'SDGELRPD'DBFILE                          CEU025              164948
     C***********          MOVEL@OPTN     DBKEY                           CEU025              164948
     C***********          Z-ADD28        DBASE                           CEU025              164948
     C***********          EXSR DBERR                                     CEU025              164948
      ***********                                                         CEU025              164948
      ****Set*Off*Session*Active*Flag.                                    CEU025              164948
      ***********                                                         CEU025              164948
     C***********          MOVEL'N'       WACTIV  1                       CEU025              164948
      ***********                                                         CEU025              164948
     C***********          EXSR *PSSR                                     CEU025              164948
      ***********                                                         CEU025              164948
      ****Access*to Bank Details OK.                                      CEU025              164948
      ***********                                                         CEU025              164948
     C***********          ELSE                                           CEU025              164948
      ***********                                                         CEU025              164948
     C***********BKEURO    CHAINREBDCRPD             89                   CEU025              164948
      ***********                                                         CEU025              164948
     C************IN89     IFEQ *OFF                       B*3            CEU025              164948
      ***********                                                         CEU025              164948
     C***********FEVSRT    DIV  FEAMNT    WRATE2                          CEU025              164948
     C***********          ELSE                            X*3            CEU025              164948
      ***********                                                         CEU025              164948
     C***********          MOVEL'USR0045' @MSGID                          CEU025              164948
     C***********          MOVELBKEURO    WMDTA1                          CEU025              164948
     C***********          MOVEL*BLANKS   WMDTA2                          CEU025              164948
     C***********WMDTA1    CAT  WMDTA2    @MSGDT                          CEU025              164948
     C***********          EXSR RTVMSG                                    CEU025              164948
     C***********          MOVEL@MSGTX    O#HMSG                          CEU025              164948
     C***********          MOVE 'E'       O#HMSS                          CEU025              164948
     C***********          MOVE @MSGID    O#HMSI                          CEU025              164948
      ***********                                                         CEU025              164948
     C***********          CALL 'REC4411'                                 CEU025              164948
     C***********          PARM 'RE4401'  PROG                            CEU025              164948
     C***********          PARM           JOBNUM                          CEU025              164948
     C***********          PARM '0000'    MMCODE                          CEU025              164948
     C***********          PARM *BLANKS   P#BRCA                          CEU025              164948
     C***********          PARM           @MSGID                          CEU025              164948
     C***********          PARM           @MSGDT                          CEU025              164948
      ***********                                                         CEU025              164948
     C************LOCK     IN   LDA                                       CEU025              164948
     C***********          MOVE 'REBDCRPD'DBFILE                          CEU025              164948
     C***********          MOVEL@OPTN     DBKEY                           CEU025              164948
     C***********          Z-ADD026       DBASE                           CEU025              164948
     C***********          EXSR DBERR                                     CEU025              164948
      ***********                                                         CEU025              164948
     C***********          MOVE 'N'       WCSTAT  1                       CEU025              164948
     C***********          MOVE 'CS'      WMSTAT  2                       CEU025              164948
     C***********          EXSR WRTLOG                                    CEU025              164948
      ***********                                                         CEU025              164948
     C***********          WRITESTATO                  22                 CEU025              164948
     C***********          ENDIF                           E*3            CEU025              164948
      ***********                                                         CEU025              164948
     C***********          ENDIF                           E*2            CEU025              164948
      ***********                                                         CEU025              164948
     C***********          ENDIF                           E*1            CEU025              164948
      *                                                                   CEU025
      **  At the start, no currencies have yet been loaded, set           CEU025
      **  pointer to the beginning of the file.                           CEU025
      *                                                                   CEU025
     C           IFEUCY    IFEQ '***'                      B*1            CEU025
     C           *LOVAL    SETLLSDCURRL0                                  CEU025
     C                     ELSE                            X*1            CEU025
      *                                                                   CEU025
      **  Otherwise, some currencies have already been loaded, IFEUCY     CEU025
      **  contains the last CCY loaded, set pointer to that position,     CEU025
      **  then read next record.                                          CEU025
      *                                                                   CEU025
     C           IFEUCY    CHAINSDCURRL0             42                   CEU025
     C                     ENDIF                           E*1            CEU025
      *                                                                   CEU025
     C                     READ SDCURRL0                 42               CEU025
      *                                                                   CEU025
      **  Assign values.                                                  CEU025
      *                                                                   CEU025
     C           *IN42     DOWEQ'0'                        B*1            CEU025
     C***********I         ANDLE21                                        CEU025              164946
     C           I         ANDLE20                                                            164946
      *                                                                   CEU025
     C                     MOVELA6CYCD    OFFRCY                          CEU025
     C                     MOVELBKEURO    OFGRCY                          CEU025
      *                                                                   CEU025
     C***********CRT104    IFEQ 'Y'                                       CEU025              164948
      ***********                                                         CEU025              164948
     C***********A6CYCD    CHAINREBDCRPD             89                   CEU025              164948
      ***********                                                         CEU025              164948
     C************IN89     IFEQ *OFF                                      CEU025              164948
      ***********                                                         CEU025              164948
     C***********          MOVEL'Y'       OFRCFL                   CEU025 163862
     C***********A6MDIN    IFEQ 'M'                                       163862              164948
     C***********          MOVEL'Y'       OFRCFL                          163862              164948
     C***********          ELSE                                           163862              164948
     C***********          MOVEL'N'       OFRCFL                          163862              164948
     C***********          ENDIF                                          163862              164948
     C***********FEVSRT    DIV  FEAMNT    WRATE1                          CEU025              164948
     C***********WRATE1    DIV  WRATE2    WRATE3                          CEU025              164948
     C***********          MOVEL*BLANKS   ZFIELD                          CEU025              164948
     C***********          MOVE WRATE3    ZFIELD                          CEU025              164948
      *                                                                   CEU025              164948
     C***********          ELSE                                           CEU025              164948
      *                                                                   CEU025              164948
     C***********          MOVEL'USR0045' @MSGID                          CEU025              164948
     C***********          MOVELA6CYCD    WMDTA1                          CEU025              164948
     C***********          MOVEL*BLANKS   WMDTA2                          CEU025              164948
     C***********WMDTA1    CAT  WMDTA2    @MSGDT                          CEU025              164948
     C***********          EXSR RTVMSG                                    CEU025              164948
     C***********          MOVEL@MSGTX    O#HMSG                          CEU025              164948
     C***********          MOVE 'E'       O#HMSS                          CEU025              164948
     C***********          MOVE @MSGID    O#HMSI                          CEU025              164948
      *                                                                   CEU025              164948
     C***********          CALL 'REC4411'                                 CEU025              164948
     C***********          PARM 'RE4401'  PROG                            CEU025              164948
     C***********          PARM           JOBNUM                          CEU025              164948
     C***********          PARM '0000'    MMCODE                          CEU025              164948
     C***********          PARM *BLANKS   P#BRCA                          CEU025              164948
     C***********          PARM           @MSGID                          CEU025              164948
     C***********          PARM           @MSGDT                          CEU025              164948
      ***********                                                         CEU025              164948
     C************LOCK     IN   LDA                                       CEU025              164948
     C***********          MOVE 'REBDCRPD'DBFILE                          CEU025              164948
     C***********          MOVEL@OPTN     DBKEY                           CEU025              164948
     C***********          Z-ADD027       DBASE                           CEU025              164948
     C***********          EXSR DBERR                                     CEU025              164948
      ***********                                                         CEU025              164948
     C***********          MOVE 'N'       WCSTAT  1                       CEU025              164948
     C***********          MOVE 'CS'      WMSTAT  2                       CEU025              164948
     C***********          EXSR WRTLOG                                    CEU025              164948
      ***********                                                         CEU025              164948
     C***********          WRITESTATO                  22                 CEU025              164948
     C***********          ENDIF                                          CEU025              164948
      ***********                                                         CEU025              164948
     C***********          ELSE                                           CEU025              164948
      *                                                                   CEU025
     C           A6INCY    IFEQ 'Y'                                                           164948
     C           BJRDNB    ANDGEA6TPSD                                                        164948
     C********** BJRDNB    ANDLEA6TPED                                                 164948 199373
      *                                                                                       164948
     C***********A6MDIN    IFEQ 'M'                        B*3            CEU025              163862
     C           A6EUMD    IFEQ 'M'                        B*3                                163862
     C                     MOVEL'Y'       OFRCFL                          CEU025
     C                     ELSE                            X*3            CEU025
     C                     MOVEL'N'       OFRCFL                          CEU025
     C                     ENDIF                           E*3            CEU025
      *                                                                   CEU025
     C                     MOVEL*BLANKS   ZFIELD                          CEU025
     C                     MOVE A6EUER    ZFIELD                          CEU025
     C***********          ENDIF                                          CEU025              164948
      *                                                                   CEU025
     C                     Z-ADD8         ZADEC                           CEU025
     C                     MOVEL*ZEROS    OFFRRT                          CEU025
     C                     EXSR ZEDIT                                     CEU025
     C           13        SUBSTZFIELD:3  OFFRRT                          CEU025
     C                     MOVEL*BLANKS   WFIELD 16                       CEU025
     C                     MOVELOFFRRT    WFIELD                          CEU025
     C                     EXSR PAD                                       CEU025
     C                     MOVEL*BLANKS   OFFRRT                          CEU025
     C                     MOVEARATE,1    OFFRRT                          CEU025
      *                                                                   CEU025
     C                     MOVELOFRATB    AFR,I                           CEU025
      *                                                                   CEU025
     C                     ADD  1         I                               CEU025
      *                                                                   CEU025
     C                     ENDIF                                                              164948
      *                                                                                       164948
     C                     READ SDCURRL0                 42               CEU025
      *                                                                   CEU025
     C                     ENDDO                           E*1            CEU025
      *                                                                   CEU025
     C                     ENDIF                                          CEU025
      *                                                                   CEU025
     C           *IN42     IFEQ *ON                        B*1            CEU025
     C***********I         ANDLE21                                        CEU025              164946
     C           I         ANDLE20                                                            164946
     C           CEU025    OREQ 'N'                                       CEU025
     C                     MOVEL*BLANKS   OFRATB                          CEU025
     C                     MOVEL'***'     OFFRCY                          CEU025
     C                     MOVELOFRATB    AFR,I                           CEU025
     C                     ENDIF                           E*1            CEU025
      *                                                                   CEU025
      **  Move array contents to outgoing message.                        CEU025
      *                                                                   CEU025
     C                     MOVELAFR,1     OFDB01                          CEU025
     C                     MOVELAFR,2     OFDB02                          CEU025
     C                     MOVELAFR,3     OFDB03                          CEU025
     C                     MOVELAFR,4     OFDB04                          CEU025
     C                     MOVELAFR,5     OFDB05                          CEU025
     C                     MOVELAFR,6     OFDB06                          CEU025
     C                     MOVELAFR,7     OFDB07                          CEU025
     C                     MOVELAFR,8     OFDB08                          CEU025
     C                     MOVELAFR,9     OFDB09                          CEU025
     C                     MOVELAFR,10    OFDB10                          CEU025
     C                     MOVELAFR,11    OFDB11                          CEU025
     C                     MOVELAFR,12    OFDB12                          CEU025
     C                     MOVELAFR,13    OFDB13                          CEU025
     C                     MOVELAFR,14    OFDB14                          CEU025
     C                     MOVELAFR,15    OFDB15                          CEU025
     C                     MOVELAFR,16    OFDB16                          CEU025
     C                     MOVELAFR,17    OFDB17                          CEU025
     C                     MOVELAFR,18    OFDB18                          CEU025
     C                     MOVELAFR,19    OFDB19                          CEU025
     C                     MOVELAFR,20    OFDB20                          CEU025
     C**********           MOVELAFR,21    OFDB21                          CEU025              164946
      *                                                                   CEU025
      **  Write Data Comms File.                                          CEU025
      *                                                                   CEU025
     C           I         IFGT 1                          B*1            CEU025
     C           I         SUB  1         K                               CEU025
     C                     ELSE                            X*1            CEU025
     C                     Z-ADD1         K                               CEU025
     C                     ENDIF                           E*1            CEU025
      *                                                                   CEU025
     C                     MOVELAFR,1     @CCY1                           CEU025
     C                     MOVELAFR,K     @CCY2                           CEU025
      *                                                                   CEU025
     C                     MOVEL'USR0076' @MSGID                          CEU025
     C                     MOVEL@CCY1     WMDTA1                          CEU025
     C                     MOVEL@CCY2     WMDTA2                          CEU025
     C           WMDTA1    CAT  WMDTA2    @MSGDT                          CEU025
     C                     EXSR RTVMSG                                    CEU025
      *                                                                   CEU025
     C                     MOVEL'C'       O#HMSS                          CEU025
     C                     MOVEL*BLANKS   O#HMSI                          CEU025
     C                     MOVEL@MSGTX    O#HMSG                          CEU025
     C                     MOVELOSTATD    OFRAT                           CEU025
      *                                                                   CEU025
     C                     MOVEL'Y'       WCSTAT                          CEU025
     C                     MOVEL'CS'      WMSTAT                          CEU025
     C                     EXSR WRTLOG                                    CEU025
      *                                                                   CEU025
     C                     WRITEFRATO                  22                 CEU025
      *                                                                   CEU025
     C                     ENDSR                                          CEU025
      *****************************************************************   CEU025
      /EJECT
      *****************************************************************
      *                                                               *
      *            PAD    - Pad field with leading zeros.             *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  P08    - Retrieve Exchange Rates Information.      *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           PAD       BEGSR                           *** PAD    ***
      *
      **  Pad field with zeros to coincide with Cashier format.
      *
     C                     Z-ADD1         L       20
     C                     Z-ADD0         WEND    20
     C           ' '       CHECKWFIELD    WEND
     C                     MOVEA*BLANKS   RATE,1
     C                     MOVEAWFIELD    RATE,1
      *
     C           L         DOWLTWEND
     C                     MOVEL'0'       RATE,L
     C                     ADD  1         L
     C                     ENDDO
      *                                                                   119318
      **  Replace any commas caused by County-specific character sets     119318
      **  by decimal points to ensure Cashier compatibility.              119318
      *                                                                   119318
     C                     Z-ADD1         X       20                      119318
     C                     MOVE '0'       *IN68                           119318
      *                                                                   119318
     C           ','       LOKUPRATE,X                   68               119318
     C           *IN68     IFEQ *ON                                       119318
     C                     MOVEL'.'       RATE,X                          119318
     C                     ENDIF                                          119318
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RVFBDT - Calculate Working Days Backward.          *
      *                                                               *
      * CALLS      ZACCH  - Access record for Holidays file.          *
      *                                                               *
      * CALLED BY  P06    - Retrieve System Control Data Routine.     *
      *                                                               *
      * FLDS USED         -                                           *
      *                                                               *
      *****************************************************************
     C           RVFBDT    BEGSR                           *** RVFBDT ***
      *
      **  Define input parameters.
      *
     C                     Z-ADDZDAYNO    ZDAYNO  50       STARTING DATE
     C                     MOVE ZCCY      ZCCY    3        DATE CURRENCY
     C                     MOVE ZLOC      ZLOC    3        LOCATION
     C                     Z-ADDZNRDYS    ZNRDYS  20       NBR OF WORKING
      *                                                    DAYS BACKWARD
      **  Define output parameters.
      *
     C                     Z-ADD0         ZDYNBR  50
      *
      **  Move input date to output date.
      *
     C                     Z-ADDZDAYNO    ZDYNBR
      *
      **  Save original value of ZDAYNO.
      *
     C                     Z-ADDZDAYNO    ZDAYNT     50
      *
      **  Access holiday record.
      *
     C                     MOVE '*SETGT ' ZOPTN
     C                     EXSR ZACCH
      *
      **  If no record was found, then just subtract no. of days backward
      **  required to input date to give output.
      *
     C           RTNCD     IFEQ '*NRF   '
      *
     C           ZDAYNO    SUB  ZNRDYS    ZDYNBR
      *
     C                     ELSE
      *
      **  Otherwise, a holiday record was found and so need to count days
      **  backward to get required result.
      **  Subtract 1st Jan date from given date and add 1 to give the
      **  nth day in the year (ZINDX).
      *
     C           ZDAYNO    SUB  DGJDNB    ZINDX
     C                     ADD  1         ZINDX
      *
      **  If no. of working days backward wanted is zero, then check first
      **  that given date is not a holiday.  If it is, then change no. of
      **  days backward wanted to one to get next working day.
      *
     C           ZNRDYS    IFEQ 0
     C           ZHL,ZINDX ANDEQ'X'
     C                     ADD  1         ZNRDYS
     C                     ENDIF
      *
      **  While no. of working days left to find is greater than zero
      *
     C           ZNRDYS    DOWGT0
      *
      **  Subtract one to day in year index and to output date.
      *
     C                     SUB  1         ZINDX
     C                     SUB  1         ZDYNBR
      *
      **  If output date is before stored 1st Jan date, then need to
      **  get next holiday record with new parameters: output date is new
      **  input date; no. of days forward is current no. of days left to
      **  find.
      *
     C           ZDYNBR    IFLT DGJDNB
      *
     C                     Z-ADDZDYNBR    ZDAYNO
      *
     C                     MOVE '*SETGT ' ZOPTN
     C                     EXSR ZACCH
      *
      **  If no record was found, then subtract no. of days left to find to
      **  output date and subtract 1 to give required result and change
      **  no. left to find to zero to terminate loop.
      *
     C           RTNCD     IFEQ '*NRF   '
      *
     C                     SUB  ZNRDYS    ZDYNBR
     C                     ADD  1         ZDYNBR
     C                     Z-ADD0         ZNRDYS
      *
     C                     ELSE
      *
      **  Otherwise, reset day in year value to last.
      *
     C                     Z-ADD366       ZINDX
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  If working day then no. left to find is one less.
      *
     C           ZNRDYS    IFNE 0
     C           ZHL,ZINDX ANDEQ' '
     C                     SUB  1         ZNRDYS
     C                     ENDIF
      *
     C                     ENDDO
      *
      **  Move back original value of ZDAYNO.
      *
     C                     Z-ADDZDAYNT    ZDAYNO
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /COPY ZSRSRC,ZACCH
      *
      /COPY ZSRSRC,ZDATE2Z2
      *
      /COPY ZSRSRC,ZEDITZ2
      *
      /COPY ZSRSRC,ZALIGNZ2                                               122060
      *                                                                   122060
      /COPY ZSRSRC,ZFWDT
      *
      *****************************************************************
      /EJECT
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**  DLY      - DELAY JOB
DLYJOB DLY(1)
** MTYP Valid Messages and required ACK/NAK.
BRCLN
BROPN
BSERN
CDATN
CDESN
CPRRN
CQDHY
CQDIY
DIRQY
EQUIN
EQUPN
KSOFN
KSONN
MIDBN
NOSTN
OITMY
PBCVN
PBLNN
RACBN
RVSEY
SFSON
SPDTN
SWSFN
FRATN                                                                     CEU025
CSOVY                                                                                         CRT005
CSIVY                                                                                         CRT005
TLINY                                                                                         CRT005
TLOUY                                                                                         CRT005
** @YD  USED BY SR. ZDATE9 - YEARS, IN DAYS, CUMULATIVE IN 4 YEAR SPAN
00366007310109601461
** @MD  USED BY SR. ZDATE9 - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
00000000310005900090001200015100181002120024300273003040033400365
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   NAR - NARRATIVE FOR RETAIL RATES DESCRIPTION
Cash
Travellers Cheques
