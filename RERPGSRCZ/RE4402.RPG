     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas RE CI branch monitor')                           *
      *****************************************************************
      *                                                               *
      *  Midas - Retail Module                                        *
      *                                                               *
      *  RE4402 - CI Branch Monitor                                   *
      *                                                               *
      *  Function:  This program will be evoked automatically during  *
      *  (I/C)      Input Cycle by each remote Branch Monitor job     *
      *             starting at the AS/400.  It will provide the      *
      *             communications link between the Midas system      *
      *             on the AS/400 and the remote branch monitor by    *
      *             opening  a conversation with the requester.  This *
      *             function will provide monitoring of the status of *
      *             the remote branch.  It will also provide the      *
      *             communications to download the start of day       *
      *             information for accounts and stopped cheques      *
      *             before the 'Open Branch' process can be run.  It  *
      *             will also handle 'trickle feed' communications    *
      *             throughout the day for transactions performed     *
      *             outside of the account branch and for any account *
      *             maintenance performed e.g. holds placed, accounts *
      *             opened and closed and account referral conditions.*
      *                                                               *
      *  Called By: REC4402 - CI Branch Monitor Control               *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. CCB020             Date 06Aug12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *  Prev Amend No. CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CRT004             Date 04May00               *
      *                 CDL008             Date 02May00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 174733             Date 04FEB00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 142083             Date 09NOV98               *
      *                 120072             Date 03Aug97               *
      *                 118737             Date 03Jun97               *
      *                 118566             Date 29MAY97               *
      *                 118516             Date 15MAY97               *
      *                 CRT003  *CREATE    Date 22JUL96               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  CCB020 - COB Restructure - Secondary COB Infrastructure      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CRT004 - Cashier Midas TCP/IP interface.                     *
      *             Recompiled over SDBRCHPD Changes                  *
      *  CDL008 - Continuous Linked Settlement (recompile SDBRCHPD)   *
      *  174733 - Branch status change not moved to saved brch status *
      *  142083 - Call access object to close the file for the        *
      *           journalling process in COB to be run .              *
      *  120072 - Extend file layouts for Cashier B version.          *
      *  118737 - Remove data area deletion: no longer needed.        *
      *           Allocate branch data area                           *
      *  118566 - Correct data structure lengths (delivered incorrect)*
      *  118516 - Free the Branch Codes file lock for the COB Save    *
      *  CRT003 - Cashier Interface.                                  *
      *                                                               *
      *****************************************************************
      /EJECT
     FRECIADL0IF  E           K        DISK         KINFSR *PSSR      UC
      **  CS Account Details Download by branch, a/c no
      *
     FRECISCL0IF  E           K        DISK         KINFSR *PSSR      UC
      **  CS Stopped Cheques Extract by branch, a/c no
      *
     FRECITFL0IF  E           K        DISK         KINFSR *PSSR      UC
      **  CS Trickle Feed Details by branch
      *
     FRECITFL1UF  E           K        DISK         KINFSR *PSSR      UC
     F            RECITFD0                          KRENAMERECITFD1
      **  CS Trickle Feed Dtls by branch, a/c, trkl feed type, status
      *
     FSDBRCHL0UF  E           K        DISK         KINFSR *PSSR      UC
      **  SD Branch Codes Update
      *
     FRE4402CMCF  E                    WORKSTN
     F                                              KNUM        1
     F                                              KINFSR *PSSR
     F                                              KINFDS FEEDBK
     F                                              KID    PGMDEV
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *                  FUNCTION OF INDICATORS                       *
      *                  ----------------------                       *
      *                                                               *
      *       20         End Of File for ICFF/RE4402CM.               *
      *       21         'READ' error on device ICFF/RE4402CM.        *
      *       23         'ACQUIRE' error on device ICFF/RE4402CM.     *
      *       25         RCVFAIL on ICFF/RE4402CM                     *
      *       26         RCVCONFIRM on ICFF/RE4402CM                  *
      *       27         'DETACH' on ICFF/RE4402CM.                   *
      *                                                               *
      *       31         End of File for LF/RECIADL0.                 *
      *       32         End of File for LF/RECISCL0.                 *
      *       33         End of File for LF/RECITFL0                  *
      *       34         End of File for LF/RECITFL1
      *       41         Chain fail                                   *
      *       55         DLTDTAARA fail on QCMDEXC                    *
      *       60         SHUTDOWN Indicator                           *
      *                                                               *
      *       80-89      Standard RTS subroutines                     *
      *                                                               *
      *       90-99      Standard MIDAS subroutines                   *
      *                                                               *
      *                                                               *
      *       U6         System error                                 *
      *       U7+U8      Database error occurs                        *
      *                                                               *
      *****************************************************************
      *                                                               *
      *  S U B R O U T I N E   I N D E X                              *
      *                                                               *
      *  DBERR  - Database Error Handling.                            *
      *  INIT   - Initialisation.                                     *
      *  *PSSR  - Program Error.                                      *
      *                                                               *
      *  ACDWNL - Account Download Processing                         *
      *  CHKBRS - Check Branch Status                                 *
      *  UPDBRS - Update Branch Status                                *
      *  DOWNLD - Data Download Processing                            *
      *  INCTRK - Incomplete Trickle Feed Processing                  *
      *  RCVDET - Detail Instruction Received on ICF Read.            *
      *  RCVDTQ - Receive Dataqueue Processing                        *
      *  RCVSAC - Branch Status Acknowledgement on ICF Read           *
      *  SCDWNL - Stopped Cheques Download Processing                 *
      *  SNDSUS - Send 'SUSP'end msg to Host Monitor                  *
      *  TRKLFD - Trickle Feed Processing                             *
      *  ZDATE2 - Convert Midas Day No. to a date format              *
      *                                                               *
      *****************************************************************
      /EJECT
      *
     E                    CPY@    1   1 80
      **  Array containing Copyright statement.
      *
      /COPY ZSRSRC,ZDATE2Z1
      ** Array for SR.ZDATE1, SR.ZDATE2
      *
     E                    ALC     1   1 80                                118737
      **  Array containing ALCOBJ command for QCMDEXEC.                   118737
      *                                                                   118737
     IFEEDBK      DS
      **  File Informational Data Structure for error handling (RE4402CM).
      *
     I                                     *STATUS  STATUS
     I                                       38  45 FMTNM
     I                                      261 268 ICFREC
     I                                      273 282 CMID
     I                                    B 372 3750ACTLEN
     I                                      401 404 MAJMIN
     I                                      401 402 MAJCOD
     I                                      403 404 MINCOD
      *
     IPSDS       SDS
      **  Program status data structure.
      *
     I                                     *PROGRAM ZAPGM
     I                                      244 246 WSID
     I                                      245 246 WSID2
     I                                      244 253 WSJOB
     I                                      254 263 USRID
     I                                      264 2690JNUMBR
     I                                      264 269 JOBNUM
      *
     IDATR        DS                             29
      **  Data structure for message data returned on Dataqueue from RBA.
      *
     I                                        1   3 R#BRCA
     I                                        4  13 R#ACNT
     I                                       14  15 R#TFTP
     I                                       16  21 R#TFSQ
     I                                       22  22 R#TFST
     I                                        1   4 R#SUSP
     I                                        1   9 R#LOCK
      *
     IDSACNT    E DSRECIADL0
      **  Data structure for a/c details download record
      *
     IDSSTCQ    E DSRECISCL0
      **  Data structure for stopped chqs download record
      *
     ICONECT      DS
      **  Data structure for initial connection
      *
     I                                        1   4 C#BRCA
     I***********************************     5  14 C#USID                118566
     I***********************************    15  17 C#UNID                118566
     I                                        5   8 C#USID                118566
     I                                        9  11 C#UNID                118566
      *
     IFLDWLD      DS
      **  Data structure for Start Database Download
      *
     I                                        1   4 D#DWLD
     I                                        5  10 D#DATE
      *
     IFSTATR      DS
      **  Data struc for Branch Status Request
      *
     I                                        1   4 RQSTAT
     I                                        5   5 RQHMSS
     I                                        6   9 RQHMSI
     I                                       10  87 RQHSMS
      *
     IFSTATA      DS
      **  Data struc Branch Status Acknowledgement
      *
     I                                        1   4 ACSTAT
     I                                        5   5 ACBRST
     I                                        6   6 ACABRT
     I                                        7   9 ACVERS
     I                                       10  10 ACBLNK                120072
      *
     IFLDWAC      DS
      **  Data structure for A/c Download to ICF file
      *
     I                                        1   4 DATYPE
     I                                        5   60DARCNT
     I                                        7   7 DAMRDT
     I                                        8 210 DADB1
     I                                      211 413 DADB2
     I                                      414 616 DADB3
     I                                      617 819 DADB4
     I                                      8201022 DADB5
     I                                     10231225 DADB6
     I                                     12261428 DADB7
     I                                     14291631 DADB8
     I                                     16321834 DADB9
     I                                     18352037 DADB10
     I                                     20382240 DADB11
     I                                     22412443 DADB12
     I                                     24442646 DADB13
     I                                     26472849 DADB14
     I                                     28503052 DADB15
     I                                     30533255 DADB16
     I                                     32563458 DADB17
     I                                     34593661 DADB18
     I                                     36623864 DADB19
     I                                     38654067 DADB20
     I                                     40684270 DADB21
     I                                     42714473 DADB22
     I                                     44744676 DADB23
     I                                     46774879 DADB24
     I                                     48805082 DADB25
     I                                     50835285 DADB26
     I                                     52865488 DADB27
     I                                     54895691 DADB28
     I                                     56925894 DADB29
     I                                     58956097 DADB30
      *
     IFLDWSC      DS
      **  Data structure for Stopped Chqs Download to ICF file
      *
     I                                        1   4 DQTYPE
     I                                        5   60DQRCNT
     I                                        7   7 DQMRDT
     I                                        8  93 DQDB1
     I                                       94 179 DQDB2
     I                                      180 265 DQDB3
     I                                      266 351 DQDB4
     I                                      352 437 DQDB5
     I                                      438 523 DQDB6
     I                                      524 609 DQDB7
     I                                      610 695 DQDB8
     I                                      696 781 DQDB9
     I                                      782 867 DQDB10
     I                                      868 953 DQDB11
     I                                      9541039 DQDB12
     I                                     10401125 DQDB13
     I                                     11261211 DQDB14
     I                                     12121297 DQDB15
     I                                     12981383 DQDB16
     I                                     13841469 DQDB17
     I                                     14701555 DQDB18
     I                                     15561641 DQDB19
     I                                     16421727 DQDB20
     I                                     17281813 DQDB21
     I                                     18141899 DQDB22
     I                                     19001985 DQDB23
     I                                     19862071 DQDB24
     I                                     20722157 DQDB25
     I                                     21582243 DQDB26
     I                                     22442329 DQDB27
     I                                     23302415 DQDB28
     I                                     24162501 DQDB29
     I                                     25022587 DQDB30
     I                                     25882673 DQDB31
     I                                     26742759 DQDB32
     I                                     27602845 DQDB33
     I                                     28462931 DQDB34
     I                                     29323017 DQDB35
     I                                     30183103 DQDB36
     I                                     31043189 DQDB37
     I                                     31903275 DQDB38
     I                                     32763361 DQDB39
     I                                     33623447 DQDB40
     I                                     34483533 DQDB41
     I                                     35343619 DQDB42
     I                                     36203705 DQDB43
     I                                     37063791 DQDB44
     I                                     37923877 DQDB45
     I                                     38783963 DQDB46
     I                                     39644049 DQDB47
     I                                     40504135 DQDB48
     I                                     41364221 DQDB49
     I                                     42224307 DQDB50
      *
     IFLTFAO      DS
      **  Data structure for Trickle Feed A/c Open format
      *
     I                                        1   4 TOTYPE
     I                                        5  17 TOACNT
     I                                       18  37 TOEXAC
     I                                       38  72 TOCNAM
     I                                       73  87 TOANAM
     I                                       88  88 TOSTRC
     I                                       89  91 TOCCY
     I                                       92 126 TOARFN
     I                                      127 129 TOPXTC
     I                                      130 132 TOSXTC
     I                                      133 147 TOARSN
     I                                      148 149 TOCTYP
      *
     IFLTFAM      DS
      **  Data structure for Trickle Feed A/c Maintenance fmt
      *
     I                                        1   4 TMTYPE
     I                                        5  17 TMACNT
     I                                       18  52 TMCNAM
     I                                       53  67 TMANAM
     I                                       68  68 TMSTRC
     I                                       69  71 TMCCY
     I                                       72  72 TMRL
     I                                       73  73 TMRLC
     I                                       74  74 TMRLD
     I                                       75  75 TMADL
     I                                       76  76 TMABL
     I                                       77  77 TMADM
     I                                       78  78 TMACL
     I                                       79  79 TMSGO
     I                                       80  80 TMR9
     I                                       81  81 TMR10
     I                                       82 116 TMARFN
     I                                      117 119 TMPXTC
     I                                      120 122 TMSXTC
     I                                      123 137 TMARSN
     I                                      138 157 TMEXA
      *
     IFLTFAD      DS
      **  Data structure for Trickle Feed A/c Delete fmt
      *
     I                                        1   4 TDTYPE
     I                                        5  17 TDACNT
     I                                       18  37 TDEXA
      *
     IFLTFBL      DS
      **  Data structure for Trickle Feed Balance Change fmt
      *
     I                                        1   4 TBTYPE
     I                                        5  17 TBACNT
     I                                       18  34 TBAVB
     I                                       35  50 TBFDC
     I                                       51  65 TBDTT
     I                                       66  85 TBEXA
      *
     IFLTFFC      DS
      **  Data structure for Trickle Feed Funds Cleared fmt
      *
     I                                        1   4 TCTYPE
     I                                        5   5 TCSTAT
      *
     IFLTFSU      DS
      **  Data structure for Trickle Feed Stop Maintenance fmt
      *
     I                                        1   4 TUTYPE
     I                                        5  17 TUACNT
     I                                       18  22 TUREF
     I                                       23  38 TU1SN
     I                                       39  54 TULSN
     I                                       55  70 TUSAM
     I                                       71  90 TUEXA
      *
     IFLTFSD      DS
      **  Data structure for Trickle Feed Stop Deletion fmt
      *
     I                                        1   4 TZTYPE
     I                                        5  17 TZACNT
     I                                       18  22 TZREF
     I                                       23  42 TZEXA
      *
     ILDA         DS                            256
      **  Local Data Area to identify database errors.
      *
     I                                        1   3 PBRCA
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I                                      134 183 DBLOT
      *
     IMPHAS       DS                              1
      **  Module Phase of Day Data area.
      *
     I                                        1   1 WPHAS
      *
     ISDBANK    E DSSDBANKPD
      **  Bank Details
      *
     ISDBRCH    E DSSDBRCHPD
      **  Branch Details
      *
     ISCSARD    E DSSCSARDPD
      **  Switchable SARs
      *
     IDSFDY     E DSDSFDY
      **  First DS for access programs, short data structure
      *
     IDSSDY     E DSDSSDY
      **  Second DS for access programs, long data structure
      *
     I            DS                                                      118737
      **  DS for ALCOBJ command for QCMDEXEC                              118737
      *                                                                   118737
     I                                        1  80 @CMD                  118737
     I                                       19  21 @BRC                  118737
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            MAIN   - Main Control Processing.                  *
      *                                                               *
      * CALLS      DOWNLD - Data Download Processing.                 *
      *            INCTRK - Incomplete Trickle Feed Processing.       *
      *            INIT   - Initial Processing.                       *
      *            RCVDTQ - Receive Dataqueue Processing.             *
      *            TRKLFD - Trickle Feed Processing.                  *
      *                                                               *
      *****************************************************************
      *
     C                     MOVEACPY@      MKI@   80
      *
     C                     EXSR INIT
      *
      **  Loop while session is still active.
      *
     C           WACTIV    DOWEQ'Y'
      *
     C                     SELEC
      *
      **  Data Download Request.
      *
     C           WDLRQ     WHEQ 'Y'
     C                     EXSR DOWNLD
      *
      **  Include Unprocessed Trickle Feed.
      *
     C           WITFRQ    WHEQ 'Y'
     C                     EXSR INCTRK
      *
      **  Trickle Feed Request.
      *
     C           WTFRQ     WHEQ 'Y'
     C                     EXSR TRKLFD
      *
     C                     OTHER
      *
      **  Check Branch Status.
      *
     C           WLOCK     IFEQ 'N'
     C                     EXSR CHKBRS
     C                     ENDIF
      *
      **  Data Download requested.
      *
     C           A8BRST    IFEQ 'D'
      *
     C                     MOVEL'Y'       WDLRQ
      *
     C                     ELSE
      *
      **  Receive Dataqueue Processing.
      *
     C                     EXSR RCVDTQ
      *
     C                     ENDIF
      *
     C                     ENDSL
      *
     C                     SHTDN                     60
     C           *IN60     IFEQ *ON
     C                     MOVEL'N'       WACTIV
     C                     ENDIF
      *
     C                     ENDDO
      *
     C***********          CALL 'QCMDEXC'              55                 118737
     C***********          PARM           WDLT                            118737
     C***********          PARM           LEN                             118737
      *
     C                     MOVE '1'       *INLR
      *
     C                     RETRN
      *
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            CHKBRS - Check Branch Status.                      *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing.                  *
      *            INIT   - Initial Processing.                       *
      *                                                               *
      *****************************************************************
     C           CHKBRS    BEGSR
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM PBRCA     @BRCA   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
      **  Branch not found.
      *
     C           @RTCD     IFNE *BLANKS
      *
      **  Report error.
      *
     C                     MOVEL'USR0003' @MSGID
     C                     MOVELPBRCA     WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    RQHSMS
     C                     MOVE 'E'       RQHMSS
     C                     MOVE @MSGID    RQHMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM 'USR0003' @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITEDATSRQ
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBRCHPD'DBFILE
     C                     MOVELPBRCA     DBKEY
     C                     Z-ADD2         DBASE
     C                     EXSR DBERR
      *
     C                     ELSE
      *
     C           A8BRST    IFEQ 'D'
     C                     MOVEL'Y'       WDLRQ   1
     C                     ENDIF
      *                                                                   142083
     C**********           CALL 'AOBRCHR0'                                             142083 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD                           142083
     C                     PARM '*FREE  ' @OPTN                           142083
     C                     PARM           @BRCA                           142083
     C**********           PARM           DSFDY                                        142083 CGL029
     C                     PARM           DSSDY                                               CGL029
      *
      **  Initialise Include Trickle Feed Required flag.
      *
     C                     MOVEL'Y'       WITFRQ  1
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            RCVDTQ - Receive Dataqueue Processing.             *
      *                                                               *
      * CALLS      *PSSR  - Program Error.                            *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing.                  *
      *                                                               *
      *****************************************************************
     C           RCVDTQ    BEGSR
      *
     C                     CALL 'QRCVDTAQ'DTQRCV
      *
      **  If dataqueue is not empty.
      *
     C           LENR      IFGT 0
      *
      **  If dataqueue has Trickle Feed message
      *
     C           R#TFTP    IFEQ 'TF'
     C                     MOVE R#BRCA    WTFBC
     C                     MOVE R#ACNT    WTFAC
     C                     MOVE R#TFTP    WTFTP
     C                     MOVE R#TFSQ    WTFSQ
     C                     MOVE 'Y'       WTFRQ   1
     C                     ENDIF
      *
      **  If dataqueue has 'SUSP'end Branch Monitor message.
      *
     C           R#SUSP    IFEQ 'SUSP'
     C***********WLOCK     ANDEQ'N'                                       118516
     C                     EXSR SNDSUS
      *
      **  Update the Branch Status.
      *
     C                     MOVE 'P'       W8BRST  1
     C           WLOCK     IFEQ 'N'                                       118516
     C                     EXSR UPDBRS
     C                     ENDIF                                          118516
     C                     ENDIF
      *
     C                     SELEC
     C           R#LOCK    WHEQ 'COBLOCK'
     C                     MOVEL'Y'       WLOCK
      *                                                                   118516
      ** Free the lock on the Branch Codes file for the COB Save.         118516
      *                                                                   118516
     C**********           CALL 'AOBRCHR0'                                             118516 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD                           118516
     C                     PARM '*FREE  ' @OPTN                           118516
     C                     PARM           @BRCA                           118516
     C**********           PARM           DSFDY                                        118516 CGL029
     C                     PARM           DSSDY                                               CGL029
      *                                                                   118516
     C           R#LOCK    WHEQ 'COBUNLCK'
     C                     MOVEL'N'       WLOCK
     C                     ENDSL
      *
     C                     ELSE
      *
      **  Read the ICF File.
      *
     C                     EXSR RCVSAC
      *
      **  Update the Branch Status if changed.
      *
     C           ACBRST    IFNE WBRSSV
     C           ACBRST    ORNE A8BRST                                    174733
     C           WLOCK     ANDEQ'N'
     C                     MOVELACBRST    WBRSSV  1
     C                     MOVELACBRST    W8BRST
     C                     EXSR UPDBRS
     C                     ENDIF
      *
      **  Send Status message (for polling).
      *
     C           WACTIV    IFNE 'N'
      *
      **  Write the ICF File.
      *
     C                     WRITEDATSRQ
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            UPDBRS - Update Branch Status.                     *
      *                                                               *
      * CALLS      RCVSAC - Branch Status Acknowledgement on ICF Read.*
      *                                                               *
      * CALLED BY  RCVDTQ - Receive Dataqueue Processing.             *
      *                                                               *
      *****************************************************************
     C           UPDBRS    BEGSR
      *
     C                     OPEN SDBRCHL0
      *
     C           PBRCA     CHAINSDBRCHL0             41
      *
     C           *IN41     IFEQ '1'
      *
     C                     MOVEL'USR0003' @MSGID
     C                     MOVELPBRCA     WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    RQHSMS
     C                     MOVE 'E'       RQHMSS
     C                     MOVE @MSGID    RQHMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM 'USR0003' @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     EXSR RCVSAC
      *
     C                     WRITEDATSRQ
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBRCHPD'DBFILE
     C                     MOVELPBRCA     DBKEY
     C                     Z-ADD4         DBASE
     C                     EXSR DBERR
      *
     C                     ELSE
      *
     C                     MOVELW8BRST    A8BRST
     C                     MOVELW8BRST    WBRSSV                          174733
     C                     UPDAT@A8REB1
      *
     C                     CLOSESDBRCHL0
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RCVSAC - Branch Status Acknowledgement on ICF Read.*
      *                                                               *
      * CALLS      RCVDET - Detach instruction received on ICF Read.  *
      *                                                               *
      * CALLED BY  ACDWNL - Account Download Processing.              *
      *            DOWNLD - Data Download Processing.                 *
      *            INIT   - Initial Processing.                       *
      *            RCVDTQ - Receive Data Queue.                       *
      *            SCDWNL - Stopped Cheques Download Processing.      *
      *            SNDSUS - Send 'SUSP' msg to Host Monitor.          *
      *            TRKLFD - Trickle Feed Processing.                  *
      *                                                               *
      *****************************************************************
     C           RCVSAC    BEGSR
      *
     C                     MOVEL*BLANKS   FSTATA
      *
     C                     READ DATSAC                 2120
      *
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
      *
     C           *IN27     IFEQ '1'
     C                     EXSR RCVDET
     C                     ENDIF
      *
     C           *IN20     IFEQ '1'
     C           *IN21     OREQ '1'
      *
      **  Report error.
      *
     C                     MOVEL'USR0053' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    RQHSMS
     C                     MOVE 'E'       RQHMSS
     C                     MOVE @MSGID    RQHMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM MAJMIN    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITEDATSRQ
      *
     C                     ELSE
      *
      **  If not Branch Status Acknowledgement, blanks, or abort.
      *
     C           ICFREC    IFNE 'DATSAC'
     C           FSTATA    OREQ *BLANKS
     C           ACABRT    OREQ 'Y'
      *
     C           ICFREC    IFNE 'DATSAC'
     C           FSTATA    OREQ *BLANKS
     C                     MOVEL'USR0054' @MSGID
     C                     MOVELICFREC    WMDTA1
     C                     MOVEL'RE4402CM'WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     ELSE
      *
     C                     MOVEL'USR0059' @MSGID
     C                     MOVELPBRCA     WMDTA1
     C                     MOVEL'RE4402CM'WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
     C                     ENDIF
      *
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    RQHSMS
     C                     MOVE 'E'       RQHMSS
     C                     MOVE @MSGID    RQHMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITEDATSRQ
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            TRKLFD - Trickle Feed Processing                   *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *            INCTRK - Incomplete Trickle Feed Processing        *
      *                                                               *
      *****************************************************************
     C           TRKLFD    BEGSR
      *
     C                     OPEN RECITFL1
      *
     C                     MOVE 'N'       WTFRQ
      *
     C                     MOVE WTFBC     KTBRC
     C                     MOVE WTFAC     KTACN
     C                     MOVE WTFTP     KTYPE
     C                     MOVE WTFSQ     KTSEQ
     C           KLTF      CHAINRECITFL1             41
     C                     UNLCKRECITFL1
      *
      **  If the trickle feed record is found and status is incomplete.
      *
     C           *IN41     IFEQ '0'
     C           RRTFST    ANDNE'C'
      *
     C                     EXSR RCVSAC
      *
     C           WACTIV    IFNE 'N'
      *
     C                     MOVELRRTFDT    WTFMT   4
      *
      **  Write the corresponding Trickle Feed msg to ICF file.
      *
     C                     SELEC
     C           WTFMT     WHEQ 'TFAO'
     C                     MOVELRRTFDT    FLTFAO
     C                     WRITEDATFAO
     C           WTFMT     WHEQ 'TFAM'
     C                     MOVELRRTFDT    FLTFAM
     C                     WRITEDATFAM
     C           WTFMT     WHEQ 'TFAD'
     C                     MOVELRRTFDT    FLTFAD
     C                     WRITEDATFAD
     C           WTFMT     WHEQ 'TFBL'
     C                     MOVELRRTFDT    FLTFBL
     C                     WRITEDATFBL
     C           WTFMT     WHEQ 'TFFC'
     C                     MOVELRRTFDT    FLTFFC
     C                     WRITEDATFFC
     C           WTFMT     WHEQ 'TFSU'
     C                     MOVELRRTFDT    FLTFSU
     C                     WRITEDATFSU
     C           WTFMT     WHEQ 'TFSD'
     C                     MOVELRRTFDT    FLTFSD
     C                     WRITEDATFSD
     C                     ENDSL
      *
     C           KLTF      CHAINRECITFL1             41
      *
      **  If the trickle feed record is found.
      *
     C           *IN41     IFEQ '0'
     C                     MOVE 'C'       RRTFST
     C                     UPDATRECITFD1
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     CLOSERECITFL1
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            DOWNLD - Data Download Processing.                 *
      *                                                               *
      * CALLS      ACDWNL - Account Download Processing               *
      *            SCDWNL - Stopped Cheques Download Processing       *
      *            DBERR  - Database Error Handling.                  *
      *            *PSSR  - Program Error.                            *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing.                  *
      *                                                               *
      *****************************************************************
     C           DOWNLD    BEGSR
      *
     C                     MOVEL'N'       WDLRQ
     C                     MOVEL'N'       WACDL   1
     C                     MOVEL'N'       WSCDL   1
     C                     MOVEL'N'       WACLD   1
     C                     MOVEL'N'       WSCLD   1
      *
     C                     OPEN RECIADL0
     C                     OPEN RECISCL0
      *
     C                     EXSR RCVSAC
      *
      **  If not in I/C Initiation or Input Cycle.
      *
     C           WPHAS     IFNE 'A'
     C********** WPHAS     ANDNE'F'                                                           CCB020
     C           WPHAS     ANDNE'G'                                                           CCB020
      *
      **  Report error.
      *
     C                     MOVEL'USR0014' @MSGID
     C                     MOVEL*BLANKS   WMDTA1 10
     C                     MOVEL*BLANKS   WMDTA2 10
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    RQHSMS
     C                     MOVE 'E'       RQHMSS
     C                     MOVE @MSGID    RQHMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITEDATSRQ
      *
     C                     ELSE
      *
      **  Position LFs/RECSADL0 and RECSSCL0.
      *
     C                     MOVE PBRCA     KBRCA
     C                     Z-ADD1         KACNO
     C           KLACNT    SETLLRECIADL0
     C           KLACNT    SETLLRECISCL0
      *
     C                     READ RECIADL0                 31
      *
      **  If Branch Code of record read is the same as the parameter,
      **  perform Account Details and Stopped Cheques Download.
      **  Perform initial read for Account Details Download.
      *
     C           *IN31     IFEQ '0'
     C           RUBRCA    ANDEQPBRCA
     C                     MOVEL'DWLD'    D#DWLD
     C                     MOVE WRDATE    D#DATE
     C                     WRITEDATDLD
     C                     MOVEL'Y'       WACDL
     C                     MOVEL'Y'       WACLD
      *
      **  Perform initial read for Stopped Cheques Download.
      *
     C                     READ RECISCL0                 32
     C           *IN32     IFEQ '0'
     C           RTBRCA    ANDEQPBRCA
     C                     MOVEL'Y'       WSCDL
     C                     MOVEL'Y'       WSCLD
     C                     ENDIF
      *
      ** Perform the down loads if necessary
      *
     C           WACDL     IFEQ 'Y'
     C                     EXSR ACDWNL
     C                     ENDIF
     C           WSCDL     IFEQ 'Y'
     C                     EXSR SCDWNL
     C                     ENDIF
      *
     C                     EXSR RCVSAC
      *
     C                     ELSE
      *
     C                     READ RECISCL0                 32
      *
      **  Perform Stopped Cheques Download if the same branch.
      *
     C           *IN32     IFEQ '0'
     C           RTBRCA    ANDEQPBRCA
     C                     MOVEL'DWLD'    D#DWLD
     C                     MOVE WRDATE    D#DATE
     C                     WRITEDATDLD
     C                     MOVEL'Y'       WSCDL
     C                     MOVEL'Y'       WSCLD
     C                     EXSR SCDWNL
     C                     EXSR RCVSAC
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Update Branch Status to 'S' if download was successful.
      *
     C           WACTIV    IFEQ 'Y'
     C           WACLD     ANDEQ'Y'
     C           WLOCK     ANDEQ'N'
     C           WACTIV    OREQ 'Y'
     C           WSCLD     ANDEQ'Y'
     C           WLOCK     ANDEQ'N'
      *
     C                     MOVE 'S'       W8BRST
     C                     EXSR UPDBRS
      *
      **  Send Status message (for polling).
      *
     C                     WRITEDATSRQ
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     CLOSERECIADL0
     C                     CLOSERECISCL0
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            ACDWNL - Account Download Processing.              *
      *                                                               *
      * CALLS      *PSSR  - Program Error                             *
      *                                                               *
      * CALLED BY  DOWNLD - Data Download Processing.                 *
      *                                                               *
      *****************************************************************
     C           ACDWNL    BEGSR
      *
     C           WACTIV    DOWEQ'Y'
     C           WACDL     ANDEQ'Y'
      *
     C                     EXSR RCVSAC
      *
     C           WACTIV    IFNE 'N'
      *
     C                     MOVE *BLANKS   FLDWAC
     C                     Z-ADD0         DARCNT
     C                     MOVEL'N'       DAMRDT
     C                     MOVE RUBRCA    WCBRC   3
      *
     C           DARCNT    DOWLT30
     C           RUBRCA    ANDEQWCBRC
     C           *IN31     ANDEQ'0'
      *
     C                     ADD  1         DARCNT
      *
     C                     SELEC
     C           DARCNT    WHEQ 1
     C                     MOVELDSACNT    DADB1
     C           DARCNT    WHEQ 2
     C                     MOVELDSACNT    DADB2
     C           DARCNT    WHEQ 3
     C                     MOVELDSACNT    DADB3
     C           DARCNT    WHEQ 4
     C                     MOVELDSACNT    DADB4
     C           DARCNT    WHEQ 5
     C                     MOVELDSACNT    DADB5
     C           DARCNT    WHEQ 6
     C                     MOVELDSACNT    DADB6
     C           DARCNT    WHEQ 7
     C                     MOVELDSACNT    DADB7
     C           DARCNT    WHEQ 8
     C                     MOVELDSACNT    DADB8
     C           DARCNT    WHEQ 9
     C                     MOVELDSACNT    DADB9
     C           DARCNT    WHEQ 10
     C                     MOVELDSACNT    DADB10
     C           DARCNT    WHEQ 11
     C                     MOVELDSACNT    DADB11
     C           DARCNT    WHEQ 12
     C                     MOVELDSACNT    DADB12
     C           DARCNT    WHEQ 13
     C                     MOVELDSACNT    DADB13
     C           DARCNT    WHEQ 14
     C                     MOVELDSACNT    DADB14
     C           DARCNT    WHEQ 15
     C                     MOVELDSACNT    DADB15
     C           DARCNT    WHEQ 16
     C                     MOVELDSACNT    DADB16
     C           DARCNT    WHEQ 17
     C                     MOVELDSACNT    DADB17
     C           DARCNT    WHEQ 18
     C                     MOVELDSACNT    DADB18
     C           DARCNT    WHEQ 19
     C                     MOVELDSACNT    DADB19
     C           DARCNT    WHEQ 20
     C                     MOVELDSACNT    DADB20
     C           DARCNT    WHEQ 21
     C                     MOVELDSACNT    DADB21
     C           DARCNT    WHEQ 22
     C                     MOVELDSACNT    DADB22
     C           DARCNT    WHEQ 23
     C                     MOVELDSACNT    DADB23
     C           DARCNT    WHEQ 24
     C                     MOVELDSACNT    DADB24
     C           DARCNT    WHEQ 25
     C                     MOVELDSACNT    DADB25
     C           DARCNT    WHEQ 26
     C                     MOVELDSACNT    DADB26
     C           DARCNT    WHEQ 27
     C                     MOVELDSACNT    DADB27
     C           DARCNT    WHEQ 28
     C                     MOVELDSACNT    DADB28
     C           DARCNT    WHEQ 29
     C                     MOVELDSACNT    DADB29
     C           DARCNT    WHEQ 30
     C                     MOVELDSACNT    DADB30
     C                     ENDSL
      *
     C                     READ RECIADL0                 31
      *
     C                     ENDDO
      *
     C           RUBRCA    IFNE WCBRC
     C           *IN31     OREQ '1'
     C                     MOVE 'N'       WACDL
     C                     ENDIF
      *
     C           DARCNT    IFEQ 30
     C           WACDL     ANDEQ'Y'
     C           WSCDL     OREQ 'Y'
     C                     MOVEL'Y'       DAMRDT
     C                     ENDIF
      *
     C                     MOVEL'DWAC'    DATYPE
     C                     WRITEDATWAC
      *
     C                     ENDIF
      *
     C                     ENDDO
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            SCDWNL - Stopped Cheques Download Processing       *
      *                                                               *
      * CALLS      *PSSR  - Program Error                             *
      *                                                               *
      * CALLED BY  DOWNLD - Data Download Processing.                 *
      *                                                               *
      *****************************************************************
     C           SCDWNL    BEGSR
      *
     C           WACTIV    DOWEQ'Y'
     C           WSCDL     ANDEQ'Y'
      *
     C                     EXSR RCVSAC
      *
     C           WACTIV    IFNE 'N'
      *
     C                     MOVE *BLANKS   FLDWSC
     C                     Z-ADD0         DQRCNT
     C                     MOVEL'N'       DQMRDT
     C                     MOVE RTBRCA    WCBRC
      *
     C           DQRCNT    DOWLT50
     C           RTBRCA    ANDEQWCBRC
     C           *IN32     ANDEQ'0'
      *
     C                     ADD  1         DQRCNT
      *
     C                     SELEC
     C           DQRCNT    WHEQ 1
     C                     MOVELDSSTCQ    DQDB1
     C           DQRCNT    WHEQ 2
     C                     MOVELDSSTCQ    DQDB2
     C           DQRCNT    WHEQ 3
     C                     MOVELDSSTCQ    DQDB3
     C           DQRCNT    WHEQ 4
     C                     MOVELDSSTCQ    DQDB4
     C           DQRCNT    WHEQ 5
     C                     MOVELDSSTCQ    DQDB5
     C           DQRCNT    WHEQ 6
     C                     MOVELDSSTCQ    DQDB6
     C           DQRCNT    WHEQ 7
     C                     MOVELDSSTCQ    DQDB7
     C           DQRCNT    WHEQ 8
     C                     MOVELDSSTCQ    DQDB8
     C           DQRCNT    WHEQ 9
     C                     MOVELDSSTCQ    DQDB9
     C           DQRCNT    WHEQ 10
     C                     MOVELDSSTCQ    DQDB10
     C           DQRCNT    WHEQ 11
     C                     MOVELDSSTCQ    DQDB11
     C           DQRCNT    WHEQ 12
     C                     MOVELDSSTCQ    DQDB12
     C           DQRCNT    WHEQ 13
     C                     MOVELDSSTCQ    DQDB13
     C           DQRCNT    WHEQ 14
     C                     MOVELDSSTCQ    DQDB14
     C           DQRCNT    WHEQ 15
     C                     MOVELDSSTCQ    DQDB15
     C           DQRCNT    WHEQ 16
     C                     MOVELDSSTCQ    DQDB16
     C           DQRCNT    WHEQ 17
     C                     MOVELDSSTCQ    DQDB17
     C           DQRCNT    WHEQ 18
     C                     MOVELDSSTCQ    DQDB18
     C           DQRCNT    WHEQ 19
     C                     MOVELDSSTCQ    DQDB19
     C           DQRCNT    WHEQ 20
     C                     MOVELDSSTCQ    DQDB20
     C           DQRCNT    WHEQ 21
     C                     MOVELDSSTCQ    DQDB21
     C           DQRCNT    WHEQ 22
     C                     MOVELDSSTCQ    DQDB22
     C           DQRCNT    WHEQ 23
     C                     MOVELDSSTCQ    DQDB23
     C           DQRCNT    WHEQ 24
     C                     MOVELDSSTCQ    DQDB24
     C           DQRCNT    WHEQ 25
     C                     MOVELDSSTCQ    DQDB25
     C           DQRCNT    WHEQ 26
     C                     MOVELDSSTCQ    DQDB26
     C           DQRCNT    WHEQ 27
     C                     MOVELDSSTCQ    DQDB27
     C           DQRCNT    WHEQ 28
     C                     MOVELDSSTCQ    DQDB28
     C           DQRCNT    WHEQ 29
     C                     MOVELDSSTCQ    DQDB29
     C           DQRCNT    WHEQ 30
     C                     MOVELDSSTCQ    DQDB30
     C           DQRCNT    WHEQ 31
     C                     MOVELDSSTCQ    DQDB31
     C           DQRCNT    WHEQ 32
     C                     MOVELDSSTCQ    DQDB32
     C           DQRCNT    WHEQ 33
     C                     MOVELDSSTCQ    DQDB33
     C           DQRCNT    WHEQ 34
     C                     MOVELDSSTCQ    DQDB34
     C           DQRCNT    WHEQ 35
     C                     MOVELDSSTCQ    DQDB35
     C           DQRCNT    WHEQ 36
     C                     MOVELDSSTCQ    DQDB36
     C           DQRCNT    WHEQ 37
     C                     MOVELDSSTCQ    DQDB37
     C           DQRCNT    WHEQ 38
     C                     MOVELDSSTCQ    DQDB38
     C           DQRCNT    WHEQ 39
     C                     MOVELDSSTCQ    DQDB39
     C           DQRCNT    WHEQ 40
     C                     MOVELDSSTCQ    DQDB40
     C           DQRCNT    WHEQ 41
     C                     MOVELDSSTCQ    DQDB41
     C           DQRCNT    WHEQ 42
     C                     MOVELDSSTCQ    DQDB42
     C           DQRCNT    WHEQ 43
     C                     MOVELDSSTCQ    DQDB43
     C           DQRCNT    WHEQ 44
     C                     MOVELDSSTCQ    DQDB44
     C           DQRCNT    WHEQ 45
     C                     MOVELDSSTCQ    DQDB45
     C           DQRCNT    WHEQ 46
     C                     MOVELDSSTCQ    DQDB46
     C           DQRCNT    WHEQ 47
     C                     MOVELDSSTCQ    DQDB47
     C           DQRCNT    WHEQ 48
     C                     MOVELDSSTCQ    DQDB48
     C           DQRCNT    WHEQ 49
     C                     MOVELDSSTCQ    DQDB49
     C           DQRCNT    WHEQ 50
     C                     MOVELDSSTCQ    DQDB50
     C                     ENDSL
      *
     C                     READ RECISCL0                 32
      *
     C                     ENDDO
      *
     C           RTBRCA    IFNE WCBRC
     C           *IN32     OREQ '1'
     C                     MOVE 'N'       WSCDL
     C                     ENDIF
      *
     C           DQRCNT    IFEQ 50
     C           WSCDL     ANDEQ'Y'
     C                     MOVEL'Y'       DQMRDT
     C                     ENDIF
      *
     C                     MOVEL'DWSC'    DQTYPE
     C                     WRITEDATWSC
     C                     ENDIF
      *
     C                     ENDDO
      *
     C                     ENDSR
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            INCTRK - Incomplete Trickle Feed Processing        *
      *                                                               *
      * CALLS      TRKLFD - Trickle Feed Processing                   *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing                   *
      *                                                               *
      *****************************************************************
     C           INCTRK    BEGSR
      *
     C                     OPEN RECITFL0
      *
     C           PBRCA     CHAINRECITFL0             33
      *
     C           WACTIV    DOWEQ'Y'
     C           *IN33     ANDEQ'0'
      *
     C           RRTFST    IFEQ *BLANK
     C                     MOVE RRBRCA    WTFBC   3
     C                     MOVE RRACNT    WTFAC  10
     C                     MOVE RRTFTP    WTFTP   2
     C                     MOVE RRTFSQ    WTFSQ   6
     C                     EXSR TRKLFD
     C                     ENDIF
      *
     C                     READERECITFL0                 33
     C                     ENDDO
      *
      **  Reset Include Trickle Feed Required flag.
      *
     C                     MOVEL'N'       WITFRQ
      *
     C                     CLOSERECITFL0
      *
     C                     ENDSR
      *****************************************************************
      /COPY ZSRSRC,RBRMSGC1
      /EJECT
      /COPY ZSRSRC,ZDATE2Z2
      *
      *****************************************************************
     C/EJECT
      *****************************************************************
      *                                                               *
      *            INIT   - Initial Processing.                       *
      *                                                               *
      * CALLS      ZDATE2 - Convert Midas dayno to a date format      *
      *            DBERR  - Database Error Handling                   *
      *            *PSSR  - Program Error.                            *
      *                                                               *
      * CALLED BY  MAIN   - Main Control Processing.                  *
      *                                                               *
      *****************************************************************
     C           INIT      BEGSR
      *
      **  Clear DB ERROR information in LDA.
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVEL*BLANK    DBLOT
     C                     OUT  LDA
      *
     C           *NAMVAR   DEFN           MPHAS
     C                     IN   MPHAS
      *
      **  Define keylist.
      *
     C           KLACNT    KLIST
     C                     KFLD           KBRCA   3
     C                     KFLD           KACNO  100
      *
     C           KLTF      KLIST
     C                     KFLD           KTBRC   3
     C                     KFLD           KTACN  10
     C                     KFLD           KTYPE   2
     C                     KFLD           KTSEQ   6
      *
      **  Define Parmlist(s).
      **  Parameters for QRCVDTAQ (From RBA).
      *
     C           DTQRCV    PLIST
     C                     PARM           DTAQR
     C                     PARM           LIBR
     C                     PARM           LENR
     C                     PARM           DATR
     C                     PARM           WAITR
      *
      ** Check if SAR CRT301 is set on.
      ** It is 'ON' if there is a local database on the PC.
      *
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*VERIFY' @OPTN   7
     C                     PARM 'CRT301'  @SARD   6
     C           SCSARD    PARM SCSARD    DSFDY
      *
     C           @RTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CRT301  1
     C                     ELSE
     C                     MOVE 'N'       CRT301
     C                     END
      *                                                                   118737
      **  Allocate lock on branch data area.                              118737
      *                                                                   118737
     C                     MOVELALC,1     @CMD                            118737
     C                     MOVE PBRCA     @BRC                            118737
      *                                                                   118737
     C                     CALL 'QCMDEXC'                                 118737
     C                     PARM           @CMD                            118737
     C                     PARM 80        LEN    155                      118737
      *
      **  Set the value of the Branch Trickle Feed data queue name.
      *
     C           'CASHTF_' CAT  PBRCA     WTFBR  10
      *
      **  Set up parameters for the Branch Trickle Feed data queue.
      *
     C                     MOVELWTFBR     DTAQR  10
     C                     MOVEL'*LIBL'   LIBR   10
     C                     Z-ADD29        LENR    50
     C                     Z-ADD60        WAITR   50
      *
      ****Set*the*value*of*the*Branch*Monitor*Data*Area**                 118737
      ****and*build*the*command*DLTDTAARA*{Branch*Monitor*DTAARA}.**      118737
      ***********                                                         118737
     C***********'CASH_'   CAT  PBRCA     WBMDA  10                       118737
      ***********                                                         118737
     C***********          MOVEL'DLT'     WLT3    3                       118737
     C***********          MOVEL'DTAARA ' WLT7    7                       118737
     C***********WLT3      CAT  WLT7      WLT10  10                       118737
      ***********                                                         118737
     C***********WLT10     CAT  WBMDA     WDLT   20                       118737
     C***********          Z-ADD20        LEN    155                      118737
      *
     C                     CALL 'SF0410'
     C                     PARM *BLANKS   PGRP   50
     C                     PARM USRID     PUSR   25
     C                     PARM *ZEROS    PLVL    40
     C                     PARM *ZEROS    PTIM    50
     C                     PARM *ZEROS    PERR    10
     C                     PARM *BLANKS   PMLT    2
      *
     C           PMLT      IFEQ *BLANK
     C                     MOVEL'GB'      PMLT
     C                     ENDIF
      *
     C           PMLT      CAT  'CIMSGF'  @MSGF  10
     C                     MOVEL*BLANKS   PMSID   7
      *
      **  Set Session Active Flag.
      *
     C                     MOVEL'Y'       WACTIV  1
     C                     MOVEL'N'       WLOCK   1
      *
     C                     MOVEL'STAT'    RQSTAT
     C                     MOVEL*BLANKS   RQHMSS
     C                     MOVEL*BLANKS   RQHMSI
     C                     MOVEL*BLANKS   RQHSMS
      *
      **  Acquire program device 'CSPGMD'.
      *
     C                     MOVEL'CIPGMD'  PGMDEV
     C           PGMDEV    ACQ  RE4402CM               23
      *
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
      *
      **  Unrecoverable error for "ACQ"  -> database error.
      *
     C           *IN23     IFEQ '1'
     C           MAJCOD    ORGE '80'
      *
      **  Report error.
      *
     C                     MOVEL'USR0050' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG   10
     C                     PARM           JOBNUM  6
     C                     PARM MAJMIN    MMCODE  4
     C                     PARM PBRCA     P#BRCA  3
     C                     PARM           @MSGID  7
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     EXSR *PSSR
      *
     C                     ELSE
      *
     C                     MOVEL*BLANKS   CONECT
      *
     C                     READ DATCON                 2120
      *
     C           *IN27     IFEQ '1'
     C                     EXSR RCVDET
     C                     ENDIF
      *
      **  If EOF or device error detected.
      *
     C           *IN20     IFEQ '1'
     C           *IN21     OREQ '1'
      *
      **  Report error.
      *
     C                     MOVEL'USR0053' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    RQHSMS
     C                     MOVE 'E'       RQHMSS
     C                     MOVE @MSGID    RQHMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM MAJMIN    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITEDATSRQ
      *
     C                     ELSE
      *
      **  If the Connection data has not been read or the msg is blank.
      *
     C           ICFREC    IFNE 'DATCON'
      *
      **  Report error.
      *
     C                     MOVEL'USR0054' @MSGID
     C                     MOVELICFREC    WMDTA1
     C                     MOVEL'RE4402CM'WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    RQHSMS
     C                     MOVE 'E'       RQHMSS
     C                     MOVE @MSGID    RQHMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITEDATSRQ
      *
     C                     ELSE
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST ' @OPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
      **  If error on access to Bank Details.
      *
     C           @RTCD     IFNE *BLANKS
      *
      **  Report error.
      *
     C                     MOVEL'USR0051' @MSGID
     C                     MOVEL*BLANKS   WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    RQHSMS
     C                     MOVE 'E'       RQHMSS
     C                     MOVE @MSGID    RQHMSI
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Set Off Session Active Flag.
      *
     C                     MOVEL'N'       WACTIV
      *
     C                     WRITEDATSRQ
      *
      **  Set up LDA DBERR.
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE
     C                     MOVEL@OPTN     DBKEY
     C                     Z-ADD1         DBASE
     C                     EXSR DBERR
      *
     C                     ELSE
      *
      **  System run date.
      *
     C                     Z-ADDBJRDNB    ZDAYNO
     C           BJDFIN    IFEQ 'D'
     C                     MOVE '0'       *IN98
     C                     ELSE
     C                     MOVE '1'       *IN98
     C                     ENDIF
      *
     C                     EXSR ZDATE2
     C                     Z-ADDZDATE     WRDATE  60
      *
      *
     C           CRT301    IFEQ 'Y'
     C           WLOCK     ANDEQ'N'
     C                     EXSR CHKBRS
     C                     ENDIF
      *
     C           WACTIV    IFNE 'N'
     C                     WRITEDATSRQ
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            RCVDET - Detach instruction received on ICF Read.  *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  INIT   - Initial Processing.                       *
      *            RCVSAC - Branch Status Acknowledgement on ICF Read.*
      *                                                               *
      *****************************************************************
     C           RCVDET    BEGSR
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0067' @MSGID
     C                     MOVELPBRCA     WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM MAJMIN    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
     C***********          CALL 'QCMDEXC'              55                 118737
     C***********          PARM           WDLT                            118737
     C***********          PARM           LEN                             118737
      *
      **  End the program.
      *
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            SNDSUS - Send 'SUSP' msg to Host Monitor.          *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY  RCVDTQ - Receive Dataqueue Processing.             *
      *                                                               *
      *****************************************************************
     C           SNDSUS    BEGSR
      *
      **  Receive outstanding messages.
      *
     C                     EXSR RCVSAC
      *
      **  Retrieve error message data to send in host message.
      *
     C                     MOVEL'USR0065' @MSGID
     C                     MOVELPBRCA     WMDTA1
     C                     MOVEL*BLANKS   WMDTA2
     C           WMDTA1    CAT  WMDTA2    @MSGDT
      *
     C                     EXSR RTVMSG
     C                     MOVEL@MSGTX    RQHSMS
     C                     MOVE 'C'       RQHMSS
     C                     MOVE @MSGID    RQHMSI
      *
      **  Report error.
      *
     C                     CALL 'REC4411'
     C                     PARM 'RE4402'  PROG
     C                     PARM           JOBNUM
     C                     PARM '0000'    MMCODE
     C                     PARM PBRCA     P#BRCA
     C                     PARM           @MSGID
     C                     PARM           @MSGDT
      *
      **  Write 'SUSP' msg to the host monitor
      *
     C                     MOVEL'SUSP'    RQSTAT
     C                     WRITEDATSRQ
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            DBERR  - Database Error Handling.                  *
      *                                                               *
      * CALLS      *PSSR  - Program Error.                            *
      *                                                               *
      * CALLED BY  INIT   - Initial Processing.                       *
      *                                                               *
      *****************************************************************
     C           DBERR     BEGSR
      *
     C                     MOVELPROG      DBPGM
     C                     OUT  LDA
      *
     C                     DUMP
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *            *PSSR  - Program Error.                            *
      *                                                               *
      * CALLS             -                                           *
      *                                                               *
      * CALLED BY         -                                           *
      *                                                               *
      *****************************************************************
     C           *PSSR     BEGSR
      *
      ****Delete*the*Branch*Data*Area.**                                  118737
      ***********                                                         118737
     C***********          CALL 'QCMDEXC'              55                 118737
     C***********          PARM           WDLT                            118737
     C***********          PARM           LEN                             118737
      *
     C                     DUMP
      *
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   ALC  - Command for ALCOBJ in QCMDEXEC                                118737
ALCOBJ  OBJ((CASH_     *DTAARA *EXCL))
