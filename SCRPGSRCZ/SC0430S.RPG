     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SC SAR maintenance insert feature screen')       *
      *****************************************************************
      *                                                               *
      *  Midas - System Control Module                                *
      *                                                               *
      *  SC0430S - Insert Switchable Features with passwords.         *
      *                                                               *
      *  Function:  Insert Switchable feature screen processing       *
      *  program for SC3010M. This program is called for all core     *
      *  switchable features and also for non-core features if the    *
      *  password switchable feature has been set on.                 *
      *                                                               *
      *  Called By: SC3010M                                           *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. CUP023             Date 17Mar11               *
      *  Prev Amend No. CUP007             Date 12Apr06               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 BUG10771           Date 12Apr06               *
      *                 CSD027             Date 09Dec05               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.02 -----------------------------------------------*
      *                 171530             Date 30Nov99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CSC010             Date 19Jan99               *
      *                 CSC007             Date 08Nov98               *
      *                 CSC005  *CREATE    Date 08May98               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  CUP023 - Addition of sequence numbers for release levels     *
      *           (Recompile)                                         *
      *  CUP007 - BUG10771 should be in SC3010M                       *
      *  BUG10771 - Automatically replicate SFMENUPD to GZSFMENUPD    *
      *             and SCSARDPD to GZSCSARDPD. Then, call APCCRTNDFL.*
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  171530 - Error if nothing to show on subfile fixed.          *
      *  CSC010 - Substitution variables added to message IDs.        *
      *  CSC007 - Swap WZSARN and WZSARD                              *
      *  CSC005 - New suite of programs and files to permit           *
      *           insertion of switchable features via passwords.     *
      *                                                               *
      *****************************************************************
     FSC0430S#CF  E                    WORKSTN
     F                                        ##RR  KSFILE #SFLRCD
     F                                              KINFDS INFDS#
      * DSP: Select Mutually Exclusive Select record
      *
     FSCSARAJ0IF  E           K        DISK
     F                                              KINFDS INFDS1
      *
      /EJECT
      * Data structures:-
     IPGMDS     ESDSY2PGDSP
      * Program data structure.
     IJBDTTM      DS
      * Job date/time.
     I                                        1   60##JDT
     I                                        1   20##JYY
     I                                        3   40##JMM
     I                                        5   60##JDD
     I                                        7  120##JTM
     I                                        7   80##JHH
     I                                        9  100##JNN
     I                                       11  120##JSS
     IINFDS#    E DSY2I#DSP
      * Display file information data structure.
      *
     IINFDS1    E DSY2I1DSP
      * File information data structure.
      *
      /EJECT
      * Parameter declarations.
     IP1PARM      DS
      * FLD: Mutually Exclusive Compnt
      * B:MAP Switchable feature description
     I                                        1  50 P1SARD
      * B:MAP Switchable feature ID
     I                                       51  56 P1SARN
      /EJECT
      *****************************************************************
     C           *ENTRY    PLIST                           Entry parameter
     C                     PARM           P0RTN   7        Return code
     C***********P1SARD****PARM P1SARD    WP0001 50        SF Descript ionCSC007
     C***********P1SARN****PARM P1SARN    WP0002  6        SF ID          CSC007
     C           P1SARD    PARM P1SARD    WP0002 50        SF ID          CSC007
     C           P1SARN    PARM P1SARN    WP0001  6        SF Descript ionCSC007
      *****************************************************************
      * Initialise
     C                     EXSR ZZINIT
      *
     C                     DO   *HIVAL                     DO
      * Initialise & load subfile page.
     C                     EXSR BAIZSF
     C                     MOVEL'N'       W0RSF   1
      * Display screen until reload requested:
     C           W0RSF     DOWEQ'N'                        DOW
      * Display screen.
     C                     EXSR CAEXFM
      *   Process response:
      * Cancel & exit program.
     C   03                CAS            ZXEXPG
      * HOME: Request subfile reload.
     C   05                CAS            FBRQRL
      *   Display next SFL page.
     C   27                CAS            BBLDSF
      *   Process screen input.
     C                     CAS            DAPR##
     C                     END
      *
     C                     END                             OD W0RSF
     C                     END                             OD *HIVAL
      *****************************************************************
      /EJECT
     CSR         BAIZSF    BEGSR
      *================================================================
      * Initialise & Load subfile page.
      *================================================================
      * Clear subfile.
     C                     SETON                     80
     C                     WRITE#SFLCTL
     C                     SETOF                     80
      * Reset no of records in subfile.
     C                     Z-ADD*ZERO     ##RRMX  50 81     SETOF 81
      *................................................................
      * Position DBF file:
     C                     MOVEL#2SARN    AXSARN           Component Name
     C           AXSARN    SETLLSCSARAJF
      *
      * Read SCSARAJ0, which contains all the SFs which the client
      * may switch on at their current release level.
      *
     C                     READ SCSARAJF               8782*82=EOF
      *
      * Save previous selector values.
     C           *LIKE     DEFN #2RSTS    WZRSTS
     C                     MOVEL#2RSTS    WZRSTS           Mutually Excl.
     C************LIKE*****DEFN #2SARD    WZSARD                          CSC007
     C*********************MOVEL#2SARD    WZSARD           Component Name CSC007
     C************LIKE*****DEFN #2SARN    WZSARN                          CSC007
     C*********************MOVEL#2SARN    WZSARN           Component SequeCSC007
     C           *LIKE     DEFN #2SARN    WZSARN                          CSC007
     C                     MOVEL#2SARN    WZSARN           Component Name CSC007
     C           *LIKE     DEFN #2SARD    WZSARD                          CSC007
     C                     MOVEL#2SARD    WZSARD           Component SequeCSC007
     C           *LIKE     DEFN #2RELL    WZRELL
     C                     MOVEL#2RELL    WZRELL           Mut. Excl. Comp
     C           *LIKE     DEFN #2IREL    WZIREL
     C                     MOVEL#2IREL    WZIREL           Mut. Excl. Comp
      * Load SFL page.
     C                     Z-ADD*ZERO     ##RROK  50
     C                     EXSR BBLDSF
      *================================================================
     CSR         BAEXIT    ENDSR
      /EJECT
     CSR         BBLDSF    BEGSR
      *================================================================
      * Load subfile page.
      *================================================================
      * Re-establish fields in read-ahead record.
     C   27                DO
     C  N82                READPSCSARAJF                 90*
     C  N82                READ SCSARAJF                 90*
     C                     END
      *
      * Setof record error indicators.
     C                     MOVE *ALL'0'   WKINDS  1
     C                     MOVEAWKINDS    *IN,35
      * Start at previous highest record in SFL.
     C                     Z-ADD##RRMX    ##RR    50
      * Reset count of DBF records read.
     C                     Z-ADD*ZERO     ##RRRD  50
      *................................................................
      * Load next SFL page until SFL page full,
      * or scan limit reached,
      * or end of file reached.
     C           *IN82     DOWEQ'0'                        DO
     C           ##RROK    ANDLT##SFPG
     C           ##RRRD    ANDLTW0SLM
      * Check selection fields - if fail, read next record.
     C***********#2SARD****IFEQ *BLANK                     Component Name CSC007
     C***********#2SARN****OREQ *BLANK                     Component SequeCSC007
     C           #2SARN    IFEQ *BLANK                     Component Name CSC007
     C           #2SARD    OREQ *BLANK                     Component SequeCSC007
     C           #2RSTS    IFNE *BLANK                     Mutually Excl.
     C           AXRSTS    CABNE#2RSTS    CD020            Mutually Excl.
     C                     END
     C                     END
     C***********#2SARD****IFEQ *BLANK                     Component Name CSC007
     C***********#2SARN****IFNE *BLANK                     Component SequeCSC007
     C***********AXSARN****CABNE#2SARN    CD020            Component SequeCSC007
     C           #2SARN    IFEQ *BLANK                     Component Name CSC007
     C           #2SARD    IFNE *BLANK                     Component SequeCSC007
     C           AXSARD    CABNE#2SARD    CD020            Component SequeCSC007
     C                     END
     C                     END
     C           #2RELL    IFNE *BLANK                     Mut. Excl. Comp
     C           AXRELL    CABNE#2RELL    CD020            Mut. Excl. Comp
     C                     END
     C           #2IREL    IFNE *BLANK                     Mut. Excl. Comp
     C           AXIREL    CABNE#2IREL    CD020            Mut. Excl. Comp
     C                     END
      * Load SFL fields.
     C                     EXSR MBFL#1
      * Output to subfile.
     C                     ADD  1         ##RR       81    *
     C                     ADD  1         ##RROK
     C                     WRITE#SFLRCD
      *
     C           CD020     TAG
      * Increment scan check count.
     C                     ADD  1         ##RRRD
      * Read next record.
      *
      * Read SCSARAJ0, which contains all the SFs which the client
      * may switch on at their current release level.
      *
     C                     READ SCSARAJF               8782*82=EOF
     C                     END                             WOD
      *................................................................
      * If no DBF records found, display error message.
     C           ##RR      IFEQ *ZERO
     C           *IN82     ANDEQ'1'
      * Send message '*No data to display'
     C                     MOVEL'Y2U0008' ZAMSID           Message id.
     C                     MOVEL'Y2USRMSG'ZAMSGF           Message file.
     C***********          MOVE '*PRV'    ZAPGRL  5                                           CSC010
     C                     MOVEL'*PRV'    ZAPGRL  5                                    CSC010 171530
     C                     EXSR ZASNMS                     Send message
     C                     EXSR ZYEXPG                                    CSC010
     C                     END
      *
      * Save highest SFL record load can continue at end point.
     C           ##RR      IFGT ##RRMX
     C           ##RRMX    ADD  1         ##SFRC
     C                     Z-ADD##RR      ##RRMX
     C                     END
      *
      * If scan limit reached, display error message.
     C           ##RRRD    IFGE W0SLM
      * Send message '*Scan limit reached'
     C                     MOVEL'Y2U0017' ZAMSID           Message id.
     C                     MOVEL'Y2USRMSG'ZAMSGF           Message file.
     C                     EXSR ZASNMS                     Send message
     C                     ELSE
     C                     Z-ADD*ZERO     ##RROK  50
     C                     END
      *================================================================
     CSR         BBEXIT    ENDSR
      /EJECT
     CSR         CAEXFM    BEGSR
      *================================================================
      * Display screen.
      *================================================================
      * Update screen time.
     C                     TIME           ##TME            Screen time.
     C           W0HLP     DOUEQ'N'
      * PUTOVR unless conditioned fields change.
     C                     SETON                     86
     C           *IN81     IFNE CAIN81
     C                     SETOF                     86
     C                     END
     C                     MOVE *IN81     CAIN81  1
     C                     WRITE#MSGCTL
     C                     WRITE#CMDTXT1
     C                     EXFMT#SFLCTL
     C                     MOVEL'N'       W0HLP   1        Reset help requ
      * If help requested, display help text.
     C   25                EXSR ZHHPKY                     Display help te
     C                     END
      * Update job time.
     C                     TIME           ##JTM            Job time.
      * Clear messages from program message queue.
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*PRV'    ZAPGRL  5
      * Reset first message only flag.
     C                     MOVEL'Y'       ZAFSMS  1      99*
     C                     SETOF                       8883*
      *================================================================
     CSR         CAEXIT    ENDSR
      /EJECT
     CSR         DAPR##    BEGSR
      *================================================================
      * Process screen input.
      *================================================================
      * Maintain subfile position where possible.
     C           @#SFRC    IFGT *ZERO
     C                     Z-ADD@#SFRC    ##SFRC
     C                     END
      *
     C           *IN81     IFEQ '1'
      * Process subfile records.
     C                     EXSR DBPRSF
      * If error, exit subroutine:
     C           *IN99     CABEQ'1'       DAEXIT
     C                     END
      * Change of position specified.
     C           WZRSTS    CASNE#2RSTS    FBRQRL           Mutually Excl.
     C***********WZSARD****CASNE#2SARD    FBRQRL           Component Name CSC007
     C***********WZSARN****CASNE#2SARN    FBRQRL           Component SequeCSC007
     C           WZSARN    CASNE#2SARN    FBRQRL           Component Name CSC007
     C           WZSARD    CASNE#2SARD    FBRQRL           Component SequeCSC007
     C           WZRELL    CASNE#2RELL    FBRQRL           Mut. Excl. Comp
     C           WZIREL    CASNE#2IREL    FBRQRL           Mut. Excl. Comp
     C                     END
      *================================================================
     CSR         DAEXIT    ENDSR
      /EJECT
     CSR         DBPRSF    BEGSR
      *================================================================
      * Process modified subfile records.
      *================================================================
      * Read first changed record (if any).
     C                     READC#SFLRCD                  88*
     C           *IN88     DOWEQ'0'
     C                     EXSR DCSFRC
     C                     MOVEL*BLANK    #1SEL
     C                     UPDAT#SFLRCD
      * Read next record.
     C                     READC#SFLRCD                  88*
     C                     END
      *================================================================
     CSR         DBEXIT    ENDSR
      /EJECT
     CSR         DCSFRC    BEGSR
      *================================================================
      * Process subfile record.
      *================================================================
      * Setof error indicators and SFLNXTCHG.
     C                     MOVEAWKINDS    *IN,35
     C                     SETOF                     84    *
      * Check selection option
     C           #1SEL     CASEQ'X'       DESLRC
     C                     END
      *================================================================
     CSR         DCEXIT    ENDSR
      /EJECT
     CSR         DESLRC    BEGSR
      *================================================================
      * Select record & return to calling program
      *================================================================
      * Move record values to parameters.
     C*********************MOVEL#1SARD    P1SARD           Component Name CSC007
     C*********************MOVEL#1SARN    P1SARN           Component SequeCSC007
     C                     MOVEL#1SARN    P1SARN           Component Name CSC007
     C                     MOVEL#1SARD    P1SARD           Component SequeCSC007
     C                     MOVEL*BLANK    P0RTN
      *
      * At this point the user has selected a SAR for insertion.
      * First, the dependency checking program SC3010X is called
      * to see if this SAR requires another SAR to be active before
      * it can be switched on. If the SAR passes the dependency
      * checking, the window program SC0430W0 is called so a
      * password may be entered. If the password is valid, the blank
      * return code is returned below or an error message is displayed
      * on the main screen.
      *
     C                     MOVEL'I'       ACTCOD
      *
      * call dependency checking program
      *
     C                     CALL 'SC3010X'
     C                     PARM           P0RTN
     C                     PARM           ACTCOD  1
     C                     PARM           P1SARN
     C                     PARM           ALLOW   1
      *
      * set up fields for call to error handling subroutine ZASNMS
      *
     C                     MOVEL'SC0430S' ZAPGM
     C                     MOVEL'CBUSRMSG'ZAMSGF
      *
      * if dependency checking program disallows insertion of SAR...
      *
     C           ALLOW     IFNE 'Y'
     C                     MOVEL'*DEP'    P0RTN
     C                     MOVE 'CBM0229' ZAMSID
     C                     MOVELP1SARN    ZAMSDA                          CSC010
     C                     EXSR ZASNMS
     C                     ELSE
      *
      * Dependency checking OK so call the window program and
      * prompt for the password.
      *
     C                     CALL 'SC0430W0'
      * Return code
     C                     PARM           P0RTN
      * KEYP defines whether F3 or F12 has been pressed in SC0430W0
     C                     PARM           KEYP    6
      * Switchable Feature number
     C                     PARM           P1SARN
      *
      * Return code if equals blanks, then insertion is successful.
      * Error case is handled in window program (SC0430W0).
      *
     C           P0RTN     IFEQ *BLANKS
      *
      * Display message that SAR inserted successfully.
      *
     C                     MOVE 'CBM0230' ZAMSID
     C                     MOVELP1SARN    ZAMSDA                          CSC010
     C                     EXSR ZASNMS
      ********                                                                       BUG10771 CUP007
      **Call*SCC0430 to replicate SFMENUPD to GZSFMENUPD and                         BUG10771 CUP007
      *******SCSARDPD to GZSCSARDPD. Then, call APCCRTNDFL.                          BUG10771 CUP007
      ********                                                                       BUG10771 CUP007
     C********             CALL 'SCC0430'                                            BUG10771 CUP007
      ********                                                                       BUG10771 CUP007
     C                     ENDIF
     C                     ENDIF
     C           KEYP      IFEQ '*F12'
      *
      * If F12 pressed process subfile reload.
      *
     C                     EXSR FBRQRL
     C                     ELSE
      *
      * If F3 pressed or password entry successful return to SC3010M
      * (main screen)
      *
     C                     EXSR ZYEXPG
     C                     ENDIF
     C                     MOVE *BLANKS   KEYP
      *================================================================
     CSR         DEEXIT    ENDSR
      /EJECT
     CSR         FBRQRL    BEGSR
      *================================================================
      * Request subfile reload.
      *================================================================
     C                     MOVEL'Y'       W0RSF
      *================================================================
     CSR         FBEXIT    ENDSR
      /EJECT
     CSR         MBFL#1    BEGSR
      *================================================================
      * Move SCSARAJF fields to #SFLRCD
      *================================================================
     C                     MOVEL*BLANK    #1SEL
     C*********************MOVELAXSARD    #1SARD           Component Name CSC007
     C*********************MOVELAXSARN    #1SARN           Component SequeCSC007
     C                     MOVELAXSARN    #1SARN           Component Name CSC007
     C                     MOVELAXSARD    #1SARD           Component SequeCSC007
     C                     MOVEL*BLANK    #1SEL            *SFLSEL
      *================================================================
     CSR         MBEXIT    ENDSR
      /EJECT
     CSR         MEIZ#2    BEGSR
      *================================================================
      * Initialise subfile control.
      *================================================================
     C                     MOVEL*BLANK    #2RSTS           Mutually Excl.
     C*********************MOVELP1SARD    #2SARD           Component Name CSC007
     C*********************MOVELP1SARN    #2SARN           Component SequeCSC007
     C                     MOVELP1SARN    #2SARN           Component Name CSC007
     C                     MOVELP1SARD    #2SARD           Component SequeCSC007
     C                     MOVEL*BLANK    #2RELL           Mut. Excl. Comp
     C                     MOVEL*BLANK    #2IREL           Mut. Excl. Comp
      * Drop ? from positioning key fields.
     C*********************MOVEL#2SARD    W0X1    1                       CSC007
     C***********W0X1      IFEQ '?'                                       CSC007
     C************LIKE     DEFN #2SARD    W0SARD- 1                       CSC007
     C*********************MOVE #2SARD    W0SARD                          CSC007
     C*********************MOVELW0SARD    #2SARD           Component Name CSC007
     C*********************MOVE ' '       #2SARD                          CSC007
     C*********************END                                            CSC007
     C*
     C                     MOVEL#2SARN    W0X1    1                       CSC007
     C           W0X1      IFEQ '?'
     C           *LIKE     DEFN #2SARN    W0SARN- 1
     C                     MOVE #2SARN    W0SARN
     C*********************MOVELW0SARN    #2SARN           Component SequeCSC007
     C                     MOVELW0SARN    #2SARN           Component Name CSC007
     C                     MOVE ' '       #2SARN
     C                     END
      *
     C                     MOVEL#2SARD    W0X1    1                       CSC007
     C           W0X1      IFEQ '?'                                       CSC007
     C           *LIKE     DEFN #2SARD    W0SARD- 1                       CSC007
     C                     MOVE #2SARD    W0SARD                          CSC007
     C                     MOVELW0SARD    #2SARD           Component SequeCSC007
     C                     MOVE ' '       #2SARD                          CSC007
     C                     END                                            CSC007
      *
      *================================================================
     CSR         MEEXIT    ENDSR
      /EJECT
     CSR         ZASNMS    BEGSR
      *================================================================
      * Send message to program's message queue.
      *================================================================
      * Send if first error message or not an error message.
     C           ZAMSTP    IFNE *BLANK
     C           ZAFSMS    ORNE 'N'
     C           ZAMSTP    IFEQ *BLANK
      * Signal first error message sent.
     C                     MOVEL'N'       ZAFSMS
     C                     END
     C           ZAPGM     IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGM
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGM  10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message Id.
     C                     PARM           ZAMSGF 10        Message file.
     C                     PARM           ZAMSDA132        Message data.
     C                     PARM           ZAMSTP  7        Message type.
     C                     END
      * Clear all fields for default mechanism next time.
     C                     MOVEL*BLANK    ZAPGM            Program queue
     C                     MOVEL*BLANK    ZAPGRL           Rel queue
     C                     MOVEL*BLANK    ZAMSID           Message Id.
     C                     MOVEL*BLANK    ZAMSGF           Message file.
     C                     MOVEL*BLANK    ZAMSDA           Message data.
     C                     MOVEL*BLANK    ZAMSTP           Message type.
      *================================================================
     CSR         ZAEXIT    ENDSR
      /EJECT
     CSR         ZHHPKY    BEGSR
      *================================================================
      * Display HELP text.
      *================================================================
     C                     MOVEL'Y'       W0HLP   1        Signal help req
     C                     CALL 'YDDSHPR'
     C                     PARM ##PGM     W0HPMB 10        Member name.
     C                     PARM *BLANK    YYHPFL 10        *DFT text file.
     C                     PARM *BLANK    YYHPLB 10        Help text lib.
     C                     PARM           W0RTN   7        Return Code.
      *================================================================
     CSR         ZHEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Cancel & exit program.
      *================================================================
      * Send message '*No value selected'
     C                     MOVEL'Y2U0016' ZAMSID           Message id.
     C                     MOVEL'Y2USRMSG'ZAMSGF           Message file.
     C                     MOVEL'*PRV '   ZAPGRL           Pgmq rel.
     C                     EXSR ZASNMS                     Send message
     C                     MOVEL'Y2U0016' P0RTN
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct.
      *================================================================
      * Terminate program.
     C                     SETON                     LR
      *
      * Exit program.
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation.
      *================================================================
     C           P0RTN     IFEQ 'B'                                       CSC007
     C                     MOVE *ON       *IN46                           CSC007
     C                     ENDIF                                          CSC007
     C           P0RTN     IFEQ 'C'                                       CSC007
     C                     MOVE *ON       *IN45                           CSC007
     C                     ENDIF                                          CSC007
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
      * Setup job date/time.
     C                     Z-ADDUDATE     ##JDT            Job date.
     C                     TIME           ##JTM            Job time.
     C                     TIME           ##TME   60       Screen time.
      * Signal first error message outstanding.
     C                     MOVEL'Y'       ZAFSMS  1
     C                     MOVEL'SEL'     W0PMD   3        Program Mode
      *
     C                     Z-ADD13        ##SFPG  30       SFLPAG
     C                     Z-ADD1         ##SFRC
     C                     Z-ADD*ZERO     ##RRMX           MAX RECNO
     C                     Z-ADD500       W0SLM   50       SCAN LIMIT
      * Clear subfile control fields.
     C                     EXSR MEIZ#2
      *================================================================
     CSR         ZZEXIT    ENDSR
