/*********************************************************************/
/*STD    CLPBASEBND                                                  */
/*EXI    TEXT('Midas SD ARR Calculator Batch Job')                   */
/*********************************************************************/
/*                                                                   */
/*       Midas - Standing Data Module                                */
/*                                                                   */
/*       SDC000114 - ARR Calculator Batch Job                        */
/*                                                                   */
/*       (c) Finastra International Limited 2020                     */
/*                                                                   */
/*       Last Amend No. CSD103  *CREATE    Date 10Aug20              */
/*                                                                   */
/*********************************************************************/
/*                                                                   */
/*       CSD103 - LIBOR Deregulation - Common Layer/Standing Data    */
/*                                                                   */
/*********************************************************************/
             PGM

             DCL        VAR(&MPHAS) TYPE(*CHAR) LEN(1)
             DCL        VAR(&PREFIX) TYPE(*CHAR) LEN(2)
             DCL        VAR(&RUNDATE) TYPE(*DEC) LEN(5 0)

             DCLF       FILE(SDCSTSTD) OPNID(STAT)
             DCLF       FILE(SDBANKPD) OPNID(BANK)

             COPYRIGHT  TEXT('(c) Finastra International Limited +
                          2020')

/** Global monitor message */

             MONMSG     MSGID(CPF0000 MCH0000 RPG0000) EXEC(GOTO +
                          CMDLBL(ABNOR))

             SNDPGMMSG  MSG('SDC000114 - ARR Calculator Batch Job') +
                          TOMSGQ(MRUNQ)

/** Retrieve Midas phase */

             RTVDTAARA  DTAARA(MPHAS) RTNVAR(&MPHAS)

/** Read Status File */
READ:
             RCVF       OPNID(STAT)
             MONMSG     MSGID(CPF0864) EXEC(DO)
                GOTO CMDLBL(CONTINUE)
             ENDDO

/** If called in COB, run program if Status is not yet completed */

             IF         COND(&MPHAS *EQ 'C') THEN(DO)

/** Retrieve Midas rundate */

                RCVF       OPNID(BANK)
                CHGVAR     VAR(&RUNDATE) VALUE(&BANK_BJRDNB)

                IF         COND((&STAT_SDSTAT *EQ 'C') *AND +
                          (&STAT_SDSTDT *EQ &RUNDATE)) THEN(DO)
                   GOTO CMDLBL(END)
                ENDDO

             ENDDO

/** Allocate data area to be used in checking if job is running */
CONTINUE:
             ALCOBJ     OBJ((SDARRCLCK *DTAARA *EXCL)) WAIT(0)
             MONMSG     MSGID(CPF1002) EXEC(DO)
                SNDPGMMSG  MSG('ARR Calculator Batch Job is already +
                             running') TOMSGQ(MOPERQ MRUNQ)
                GOTO CMDLBL(END)
             ENDDO

/** Retrieve zone system prefix */

             RTVDTAARA  DTAARA(SDSTAT (6 2)) RTNVAR(&PREFIX)

/** Clear Work File */

             CLRPFM     FILE(LELIBEPD)

/** Call ARR Calculator Batch Job Pogram */

             CALL       PGM(SD000114)
             IF         COND(%SWITCH(XXXXXX11)) THEN(DO)
                GOTO       CMDLBL(ABNOR)
             ENDDO

/** Call program to produce Daily Rates Report */

             CALL       PGM(SD001110P)
             IF         COND(%SWITCH(XXXXXX11)) THEN(DO)
                GOTO       CMDLBL(ABNOR)
             ENDDO

/** Call program to produce Exception Error Report */

             CALL       PGM(SD001112)
             IF         COND(%SWITCH(XXXXXX11)) THEN(DO)
                GOTO       CMDLBL(ABNOR)
             ENDDO

             GOTO       CMDLBL(END)

/** Abnormal termination */
ABNOR:
             CHGJOB     SWS(XXXXXX11)
             SNDPGMMSG  MSGID(CPF9898) MSGF(QCPFMSG) MSGDTA('Program +
                          SDC000114 ended abnormally - see job log') +
                          TOMSGQ(MOPERQ MRUNQ)
             MONMSG     MSGID(CPF0000 MCH0000)

END:
             ENDPGM
