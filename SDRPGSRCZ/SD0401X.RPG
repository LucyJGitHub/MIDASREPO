     H        1   Y
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SD External retrieve extended settlements')
      *****************************************************************
      *                                                               *
      *  Midas - Standing Data Module                                 *
      *                                                               *
      *  SD0401X - Midas SD Retrieve extended settlements             *
      *                                                               *
      *  Function:  This program retrieves extended settlements       *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *  Prev Amend No. CSD027             Date 09Dec05               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CSD003             Date 01Jul99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 066562             Date 09Feb94               *
      *                 S01459             DATE 09FEB94               *
      *                 LN1267             DATE 10MAY91               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CSD003 - Synon Closedown Project (SD):                       *
      *           - Program removed from SD model.                    *
      *  066562 - Field BLRSS renamed to BLRSST on SDTRADPD.          *
      *           Regenerate and recompile program.                   *
      *  S01459 - Addition of headerbox and PSSR processing.          *
      *  LN1267 - Regenerated to reflect undocumented changes in the  *
      *           model:-                                             *
      *           SDMMODPD not retrieved in this program              *
      *                                                               *
      *****************************************************************
     FSDTRADL1IF  E           K        DISK                           UC
     F                                              KINFDS ID0001
     F                                              KINFSR *PSSR
      * RTV : Midas SD Trading data retrieval
      *
     FSDBANKL1IF  E           K        DISK                           UC
     F                                              KINFDS ID0002
     F                                              KINFSR *PSSR
      * RTV : Midas SD Bank details ICD retrieval
      *
     FSDRETLL1IF  E           K        DISK                           UC
     F                                              KINFDS ID0003
     F                                              KINFSR *PSSR
      * RTV : Midas SD Retail details retrieval
      *
     E* Description     : Copyright notice for inclusion in all programs
     E*
     E********************************************************************
     E                    CPY@    1   1 80               Copyright array
     I*
     I* Description     : Copyright notice for inclusion in all programs
     I*
      /EJECT
      * Data structures:
     IPGMDS     ESDSY2PGDSP
      * Program data structure
     IJBDTTM      DS
      * Job date/time
     I                                        1   70##JDT
     I                                        1   10##JCC
     I                                        2   30##JYY
     I                                        4   50##JMM
     I                                        6   70##JDD
     I                                        8  130##JTM
     I                                        8   90##JHH
     I                                       10  110##JNN
     I                                       12  130##JSS
     IA@CPY       DS
     I* Copyright array
     I                                        1  80 CPY@
     IID0001      DS                            528
      * File information data structure
      *
     IID0002      DS                            528
      * File information data structure
      *
     IID0003      DS                            528
      * File information data structure
      *
      /EJECT
      * Parameter declarations
     IP1PARM      DS
      * I : MAP Retail Present
     I                                        1   1 P1REPR
     IP2PARM      DS
      * O : MAP US Dollars Currency Code
     I                                        1   3 P2USCY
     IP3PARM      DS
      * O : MAP Back value period parm
     I                                        1   30P3BVPP
     IP4PARM      DS
      * O : MAP Branch code
     I                                        1   3 P4BRCD
     IP5PARM      DS
      * O : MAP Account Code
     I**********                              1   4 P5ACCD                                    CGL029
     I                                        1  10 P5ACCD                                    CGL029
     IP6PARM      DS
      * O : MAP Retail A/C Nos. Required?
     I                                        1   1 P6RANR
     I            DS
     I                                        1 132 ZAMSDA
      * Message data for 'Database Error (ICD)'
      * Filename
     I                                        1  10 ZA0001
      * Message data for 'Database Error (ICD)'
      * Filename
     I                                        1  10 ZA0002
      * Message data for 'Database Error (ICD)'
      * Filename
     I                                        1  10 ZA0003
      * Message data for 'Database Error (ICD)'
      * Filename
     I                                        1  10 ZA0004
      /EJECT
      *****************************************************************
      * Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           P0RTN   7
     C           P1REPR    PARM           WP0001  1        Retail Present
     C           P2USCY    PARM P2USCY    WP0002  3        US Dollars Curr
     C           P3BVPP    PARM P3BVPP    WP0003  30       Back value peri
     C           P4BRCD    PARM P4BRCD    WP0004  3        Branch code
     C********** P5ACCD    PARM P5ACCD    WP0005  4        Account Code                       CGL029
     C           P5ACCD    PARM P5ACCD    WP0005 10                                           CGL029
     C           P6RANR    PARM P6RANR    WP0006  1        Retail A/C Nos.
      *****************************************************************
      * Initialize
     C                     EXSR ZZINIT
      *
      * External Retrieve
      * Start of S01459
      * SD0401X  Precompiler - Extended Settlements  *
      * Remove Last Amend Box and Creation Parameter Functions
      * End of S01459
      * Copyright Statement - Standard Functions  *
      * retrieve USD ccy code - Trading Data  *
     C                     EXSR SARVGN
      * Get Back Value Period - Bank Details  *
     C                     EXSR SBRVGN
      * get default branch - Bank Details  *
     C                     EXSR SCRVGN
      * CASE: PAR.Retail Present is Yes
     C           P1REPR    IFEQ 'Y'                        *IF
      * Get A/C Nos supported fld - Retail Details  *
     C                     EXSR SDRVGN
     C                     ELSE
      * CASE: *OTHERWISE
     C                     MOVEL'N'       P6RANR           Retail A/C Nos.
     C                     END                             *FI
      *----------------------------------------------------------------
      * Exit program
     C           AAEXIT    TAG
     C                     MOVEL*BLANK    P0RTN
     C                     EXSR ZYEXPG
      *================================================================
      /EJECT
     CSR         SARVGN    BEGSR
      *================================================================
      * retrieve USD ccy code - Trading Data  *
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KRSSA     KLIST
     C                     KFLD           BLTRAD           Trading
      * Move fields to key list
     C                     MOVE *BLANK    BLTRAD           Trading
     C                     MOVEL'TRAD'    BLTRAD           Trading
     C           KRSSA     CHAIN@BLREEO              90    *
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR0201' W0RTN   7
      * USER: Processing if Data record not found
     C                     MOVEL'Y2U0005' W0RTN            *Return code
      * Setup message data for message
     C                     MOVEL'SDTRADPD'ZA0001           Filename
      * Send message 'Database Error (ICD)'
     C                     MOVEL'USR0377' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     99    *
      *
     C                     GOTO SAEXIT                     *QUIT
     C                     GOTO SAEXIT
     C                     END
      *
     C           *IN90     IFEQ '0'
      * USER: Process Data record
     C                     MOVELBLUSCY    WUUSCY           US Dollars Curr
     C                     END
      *================================================================
     CSR         SAEXIT    ENDSR
      /EJECT
     CSR         SBRVGN    BEGSR
      *================================================================
      * Get Back Value Period - Bank Details  *
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KRSSB     KLIST
     C                     KFLD           BJBANK           Bank
      * Move fields to key list
     C                     MOVE *BLANK    BJBANK           Bank
     C                     MOVEL'BANK'    BJBANK           Bank
     C           KRSSB     CHAIN@BJREEF              90    *
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR0197' W0RTN   7
      * USER: Processing if Data record not found
     C                     MOVEL'Y2U0005' W0RTN            *Return code
      * Setup message data for message
     C                     MOVEL'SDBANKPD'ZA0002           Filename
      * Send message 'Database Error (ICD)'
     C                     MOVEL'USR0377' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     99    *
      *
     C                     GOTO SBEXIT                     *QUIT
     C                     GOTO SBEXIT
     C                     END
      *
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * PAR = DB1 By name
     C                     Z-ADDBJBVPD    WUBVPD           Back Value Peri
     C                     END
      *================================================================
     CSR         SBEXIT    ENDSR
      /EJECT
     CSR         SCRVGN    BEGSR
      *================================================================
      * get default branch - Bank Details  *
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KRSSC     KLIST
     C                     KFLD           BJBANK           Bank
      * Move fields to key list
     C                     MOVE *BLANK    BJBANK           Bank
     C                     MOVEL'BANK'    BJBANK           Bank
     C           KRSSC     CHAIN@BJREEF              90    *
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR0197' W0RTN   7
      * USER: Processing if Data record not found
     C                     MOVEL'Y2U0005' W0RTN            *Return code
      * Setup message data for message
     C                     MOVEL'SDBANKPD'ZA0003           Filename
      * Send message 'Database Error (ICD)'
     C                     MOVEL'USR0377' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     99    *
      *
     C                     GOTO SCEXIT                     *QUIT
     C                     GOTO SCEXIT
     C                     END
      *
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * PAR = DB1 By name
     C                     MOVELBJSBRC    WUSBRC           Single Branch C
     C                     END
      *================================================================
     CSR         SCEXIT    ENDSR
      /EJECT
     CSR         SDRVGN    BEGSR
      *================================================================
      * Get A/C Nos supported fld - Retail Details  *
      *================================================================
     C                     MOVEL*BLANK    W0RTN   7
      * Define keylist
     C           KRSSD     KLIST
     C                     KFLD           BMRETL           Retail
      * Move fields to key list
     C                     MOVE *BLANK    BMRETL           Retail
     C                     MOVEL'RETL'    BMRETL           Retail
     C           KRSSD     CHAIN@BMREEL              90    *
     C           *IN90     IFEQ '1'
      * Data record not found
     C                     MOVEL'USR0203' W0RTN   7
      * USER: Processing if Data record not found
     C                     MOVEL'Y2U0005' W0RTN            *Return code
      * Setup message data for message
     C                     MOVEL'SDRETLPD'ZA0004           Filename
      * Send message 'Database Error (ICD)'
     C                     MOVEL'USR0377' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     99    *
      *
     C                     GOTO SDEXIT                     *QUIT
     C                     GOTO SDEXIT
     C                     END
      *
     C           *IN90     IFEQ '0'
      * USER: Process Data record
      * PAR = DB1 By name
     C                     MOVELBMACCD    P5ACCD           Account Code
     C                     MOVELBMRANR    P6RANR           Retail A/C Nos.
     C                     MOVEL*BLANK    W0RTN            *Return code
     C                     END
      *================================================================
     CSR         SDEXIT    ENDSR
      /EJECT
     CSR         ZASNMS    BEGSR
      *================================================================
      * Send message to program's message queue
      *================================================================
     C           ZAPGMQ    IFEQ *BLANK
     C                     MOVEL##PGM     ZAPGMQ
     C                     END
      * If no message file specified, use default
     C           ZAMSGF    IFEQ *BLANK
     C                     MOVELZADFMF    ZAMSGF
     C                     END
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message ID
     C                     PARM           ZAMSGF 10        Message file
     C                     PARM           ZAMSDA132        Message data
     C                     PARM           ZAMSTP  7        Message type
      * Clear all fields for default mechanism next time
     C                     MOVEL*BLANK    ZAPGMQ
     C                     MOVEL*BLANK    ZAPGRL
     C                     MOVEL*BLANK    ZAMSID
     C                     MOVEL*BLANK    ZAMSGF
     C                     MOVEL*BLANK    ZAMSDA
     C                     MOVEL*BLANK    ZAMSTP
      *================================================================
     CSR         ZAEXIT    ENDSR
      /EJECT
     CSR         ZXEXPG    BEGSR
      *================================================================
      * Exit program: Normal
      *================================================================
     C                     EXSR ZYEXPG
      *================================================================
     CSR         ZXEXIT    ENDSR
      /EJECT
     CSR         ZYEXPG    BEGSR
      *================================================================
      * Exit program: Direct
      *================================================================
      * Terminate program
     C                     SETON                     LR
      *
      * Exit program
     C                     RETRN
      *
      *================================================================
     CSR         ZYEXIT    ENDSR
      /EJECT
     CSR         ZZINIT    BEGSR
      *================================================================
      * Initialisation
      *================================================================
     C           W0ICL     IFEQ *BLANK
     C                     MOVEL'Y'       W0ICL   1        *Initial call
     C                     ELSE
     C                     MOVEL'N'       W0ICL
     C                     END
     C                     MOVE *BLANK    P0RTN
     C                     MOVE *BLANK    W0RTN   7
     C                     MOVEL*BLANK    W0RSL   1
     C                     MOVEL*BLANK    W0RSF   1
     C                     MOVEL*ZEROS    W0RTW   90
     C                     MOVEL'400'     W0ENV   3
      * Setup job date/time
      *
     C                     Z-ADDUDATE     ##JDT
      * Set century digit (If YY prior to 1940 treat as 20YY)
     C           ##JYY     IFLT 40
     C                     Z-ADD1         ##JCC
     C                     ELSE
     C                     Z-ADD0         ##JCC
     C                     END
     C                     TIME           ##JTM
      * Update screen time
     C                     TIME           ##TME   60
      * Define work field US Dollars Currency Code
     C                     MOVEL*BLANK    WUUSCY  3
      * Obtain default message file
     C           *NAMVAR   DEFN Y2MGFLA   ZADFMF 10
     C                     IN   ZADFMF
      * Define work field Back Value Period in Days
     C                     Z-ADD*ZERO     WUBVPD  30
      * Define work field Single Branch Code
     C                     MOVEL*BLANK    WUSBRC  3
      * Move main file information to JOB context
     C                     MOVE @1FFL     ZZFFL  10        Main file name
     C                     MOVE @1FLB     ZZFLB  10        Main file lib
     C                     MOVE @1FMB     ZZFMB  10        Main file mbr
     C                     MOVE ZZFFL     @1FFL  10
     C                     MOVE ZZFLB     @1FLB  10
     C                     MOVE ZZFMB     @1FMB  10
     C                     CALL 'Y2QLVNR'
     C                     PARM           ZZFFL  10
     C                     PARM           ZZFLB  10
     C                     PARM           ZZFQL  21        LIBRARY/FILE
      * Open files
     C                     OPEN SDTRADL1
     C                     OPEN SDBANKL1
     C                     OPEN SDRETLL1
     C                     MOVEL'N'       W0PMT   1
      *================================================================
     CSR         ZZEXIT    ENDSR
      /EJECT
     CSR         *PSSR     BEGSR
      *****************************************************************
      *                                                               *
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      *****************************************************************
      *
      * Core function specific processing.
      *
     C/COPY WNCPYSRC,SD0401XPSC
      *
      * Start of PSSR user point.
      *
     C/COPY WNCPYSRC,SD0401XPS1
      *
      * Standard Midas PSSR processing.
      *
     C/COPY SDCPYSRC,SDPSSRINT
      *
      * End of PSSR user point.
      *
     C/COPY WNCPYSRC,SD0401XPS2
      *
      *================================================================
     CSR                   ENDSR
      *================================================================
** CPY@     : Copyright notice for inclusion in all programs
(c) Finastra International Limited 2001
