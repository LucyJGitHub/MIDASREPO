     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Security trade settlement maintenance')
/*OVRF*: OVRDBF FILE(TRADSX) TOFILE(TRADS) SHARE(*NO)               : *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Securities Trading Module
     F*                                                               *
     F*  SE0060 - SECURITY TRADES SETTLEMENT MAINTENANCE              *
     F*                                                               *
     F*  Function: This program allows the review, amendment and      *
     F*   (I/C)    deletion of Settlement details received from       *
     F*            Euclid (if required by the installation), and      *
     F*            the insertion or reversal of Settlements for       *
     F*            trades.                                            *
     F*                                                               *
     F*  Called By: SEC02 - Input Cycle Processing                    *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD058285           Date 22Jun21               *
      *  Prev Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CPK024             Date 24Feb06               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 CAS006             Date 21Jan03               *
      *                 CSD015             Date 14Oct02               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
     F*                 122711             Date 26Apr00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 CEU017             Date 11May98               *
     F*                 CSE007             Date 19Jan98               *
     F*                 089949             DATE 06AUG96               *
     F*                 077259             DATE 20MAY96               *
     F*                 036931             DATE 16MAY96               *
     F*                 S01408             DATE 29APR96               *
     F*                 082738             DATE 12MAR95               *
     F*                 080050             DATE 26JAN95               *
     F*                 S01502             DATE 08JUL94               *
     F*                 052254             DATE 05JAN94               *
     F*                 051418             DATE 05JAN94               *
     F*                 050907             DATE 08NOV93               *
     F*                 S01401             DATE 16JUN93               *
     F*                 047225             DATE 22MAR93               *
     F*                 S01397             DATE 10SEP92               *
     F*                 E38126             DATE 06APR92               *
     F*                 E30659             DATE 20JAN92               *
     F*                 E31061             DATE 20JAN92               *
     F*                 E32106             DATE 19NOV90               *
     F*                 S01220             DATE 12NOV90               *
     F*                 S01117             DATE 29OCT90               *
     F*                 S01195             DATE 29OCT90               *
     F*                 S01269             DATE 07NOV90               *
     F*                 S01271             DATE 29OCT90               *
     F*                 E22832             DATE 29AUG90               *
     F*                 E21218             DATE 26FEB90               *
     F*                 E21236             DATE 26FEB90               *
     F*                 E21112             DATE 12FEB90               *
     F*                 E20719             DATE 10JAN90               *
     F*                 E20125             DATE 08NOV89               *
     F*                 E19400             DATE 08NOV89               *
     F*                 E20036             DATE 31OCT89               *
     F*                 E19813             DATE 11OCT89               *
     F*                 S01199             DATE 01AUG89               *
     F*                 S01190             DATE 07/07/89              *
     F*                 E18199             DATE 06/06/89              *
     F*                 S01154             DATE 15/03/89              *
     F*                 E16843             DATE 09/03/89              *
     F*                 E16187             DATE 07/02/89              *
     F*                 E16182             DATE 07/02/89              *
     F*                 E15846             DATE 03/11/88              *
     F*                 S01176             DATE 10/11/88              *
     F*                 E15286             DATE 27/09/88              *
     F*                 E14509             DATE 01/09/88              *
     F*                 E14538             DATE 11/08/88              *
     F*                 E13688             DATE 22/07/88              *
     F*                 E14218             DATE 21/07/88              *
     F*                 E14239             DATE 21/07/88              *
     F*                 S01158             DATE 05/05/88              *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD058285 - Change base rate code to alphanumeric (Recompile) *
      *  MD046248 - Finastra Rebranding                               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CPK024 - Packaging for MPLUS 1.2.1. EUTX from data structure *
      *           SESTAT was renamed to EUTXB                         *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CAS006 - Hedge Accounting Phase B (Recompile)                *
      *  CSD015 - Midas Compliance Watch - Watch List Checking        *
     F*  122711 - Multiply/Divide ind needs reversing before call of  *
     F*           ZCONV regarding discrepancy tests.                  *
     F*  CEU017 - Securities Redenomination Euro Changes              *
     F*  CSE007 - Corporate Actions                                   *
     F*  089949 - Get the values of Accnt Code and Accnt Sequence     *
     F*           from CLINTSE only if they are not entered on the    *
     F*           PAYFM/PAYT field.                                   *
     F*  077259 - Settlement not allowed if security matured          *
     F*  036931 - Nominal Settled cannot be blank for full settlement.*
     F*           Calculate discrepancy correctly.                    *
     F*  S01408 - Addition of core hooks: SE0060IIP1                  *
     F*                                   SE0060IIP2                  *
     F*                                   SE0060CCP1                  *
     F*                                   SE0060CCP2                  *
     F*                                   SE0060CCP3                  *
     F*                                   SE0060CCP4                  *
     F*  082738 - Rewrite of projected account movements.             *
     F*  080050 - Narrative code on RSACMTPD changed to alphanumeric  *
     F*  S01502 - BLI Telekurs Processing.  Recompiled due to change  *
     F*           in length of SESTAT, 133 long.                      *
     F*  052254 - RECOMPILED as CURRENT FACTOR amended from 9,8       *
     F*           to 10,9                                             *
     F*  051418 - PROBLEMS WITH SHADOW POSTING                        *
     F*  050907 - Trades created by book transfers should not be      *
     F*           manually settled.                                   *
     F*  S01401 - MT500 SWIFT Messages Feature:                       *
     F*          - Recompiled due to changes to files.                *
     F*  047225 - Condition Call to AORETLR0 on Retail being present. *
     F*           (U1 Set On in CL if RE or IA present.)              *
     F*  S01397 - Rel 10 Incorporation of BNZ SARs A46008 and A46013. *
     F*          - Recompiled due to changes to files.                *
     F*  E38126 - If screen reversal indicator is blank then the      *
     F*           reversal indicator on SETLED should be 'N'          *
     F*  E30659 - Settlement of nominal with zero amount should not   *
     F*           produce a zero amount record on the Account         *
     F*           Movement file.                                      *
     F*  E31061 - If the nominal settled and value settled are equal  *
     F*           to the nominal outstanding and value outstanding    *
     F*           respectively, 'Full Settlement' flag should be 'Y'  *
     F*  E32106 - DB error in ACCNT                                   *
     F*  S01220 - STRATEGIC RISK MANAGEMENT                           *
     F*           Recompiled over changed PF/SECTYD                   *
     F*  S01117 - Multibranching.                                     *
     F*  S01195 - Holiday amendment                                   *
     F*  S01269 - Trades Authorisation - Check if record is already   *
     F*           Authorised                                          *
     F*  S01271 - Recompiled for Pay/Receive in Input Cycle changes   *
     F*           to TRADSD and/or DPTMVD                             *
     F*  E22832 - Warning for holiday in settlement currency          *
     F*           changed to W03 as W02 is different.                 *
     F*  E21218 - Truncation of Value Settled on Output to File.      *
     F*  E21236 - Discrepancy only occurs on Full Settlement.         *
     F*  E21112 - Rec Id on TRADSD Updated to 'S' in error.           *
     F*  E20719 - Rec Id on TRADSD never updated for Settlement or    *
     F*           Reversal. RECITR field should be referenced instead *
     F*           of RECI.                                            *
     F*  E20125 - Wrong conditioning on Discrepancy calcs. (part of   *   E20125
     F*           original fix was incorporated as E13688).           *   E20125
     F*         - Database error upon exiting program with CMD/3      *   E20125
     F*           after rejection of an invalid Trade Reference.      *   E20125
     F*  E19400 - The Nominal and Value Settled fields were defined   *   E19400
     F*           too small, causing the loss of significant digits.  *   E19400
     F*           Also, Nomimal should be edited using SR/ZSEDIT and  *   E19400
     F*           not SR/ZEDIT.                                       *   E19400
     F*  E20036 - Recompiled over new Diisplay File                   *   E20036
     F*           Nominal Settled field was not large enough to       *   E20036
     F*           accumulate Outstanding Nominal.                     *   E20036
     F*           Warning Message 'W01' should not appear for Full    *   E20036
     F*           Settlement.                                         *   E20036
     F*  E19813 - DATABASE ERROR INCORRECTLY CAUSED IF A/C IS         *   E19813
     F*           BLOCKED FOR SETTMT METHODS OTHER THAN 4,5,14 OR 15  *   E19813
     F*  S01199 - HELP SYSTEM.                                        *   S01199
     F*  S01190 - EUCLID FIX/ENHANCEMENTS                             *   S01190
     F*  E18199 - FAULT WITH ERROR MESSAGE 108.                       *   E18199
     F*  S01154 - WRITE A RECORD TO THE ACCOUNT MOVEMENTS FILE        *   S01154
     F*           UPON UPDATE OF MEMOS OR PRONO.                      *   S01154
     F*  E16843 - Update Shadow balances correctly.                   *   E16843
     F*  E16187 - ON REVERSALS THE AMOUNTS ALREADY SETTLED            *   E16187
     F*           SHOULD BE DISPLAYED INSTEAD OF THE AMOUNTS          *   E16187
     F*           OUTSTANDING.                                        *   E16187
     F*  E16182 - ALLOW REVERSAL ENTRY ON FULLY-SETTLED TRADE.        *   E16182
     F*           ALSO, THE O/S DISCREPANCY SHOULD NOT AFFECT THE     *   E16182
     F*           ALLOWABLE AMOUNT SETTLED.                           *   E16182
     F*  E15846 - RECI ON THE TRADS FILE IS BEING OVERWRITTEN         *   E15846
     F*           BECAUSE OF READS ON OTHER FILES.                    *   E15846
     F*  S01176 - ST  3.1  AUSTRALIA                                  *   S01176
     F*  E15286 - DEFAULT ADDED FOR MOVEMENT DATE, AND FOR NOMINAL    *   E15286
     F*           AND VALUE SETTLED IF FULL SETTLE = 'Y'              *   E15286
     F*  E14509 - WRONG USER DEPOT POSITION UPDATED                   *   E14509
     F*  E14538 - Reversal of deal ,gave oversettlement warning       *   E14538
     F*           error W01                                           *   E14538
     F*  E13688 - INCORRECT DISCREPANCY AMOUNTS WRITTEN TO SETLED.    *   E13688
     F*  E14218 - INCORRECT NARRATIVE DISPLAYED.                      *   E14218
     F*  E14239 - A BLANK MOVEMENT DATE SHOULD DEFAULT TO RUN DATE.   *   E14239
     F*  S01158 - POST INCORPORATION DEVELOPMENT FIX                  *   S01158
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
      *
     FSE0060DFCF  E                    WORKSTN
     FACCNT   IF  E           K        DISK
     FACNUM   IF  E           K        DISK
     F            ACCNTABF                          KRENAMEACNUMF
     FSECTY   IF  E           K        DISK
     FTRADSX  IF  E           K        DISK
     F            TRADSDF                           KRENAMETRADSDFX
     F*CLINT**IF**E*****      K        DISK                               S01117
     F*********** CLINTCAF                          KIGNORE               S01117
     F*********** CLINTCCF                          KIGNORE               S01117
     F*********** CLINTC1F                          KIGNORE               S01117
     F*TABSE***IF**E****       K        DISK                              S01117
     F*********** TABLETAF                          KIGNORE               S01117
     F*********** TABTB10F                          KIGNORE               S01117
     F*********** TABTE10F                          KIGNORE               S01117
     F*********** TABTE20F                          KIGNORE               S01117
     F*********** TABTG20F                          KIGNORE               S01117
     F*********** TABLETHF                          KIGNORE               S01117
     F*********** TABLETKF                          KIGNORE               S01117
     F*********** TABLETLF                          KIGNORE               S01117
     F*********** TABLETNF                          KIGNORE               S01117
     F*********** TABLETPF                          KIGNORE               S01117
     F*********** TABLETRF                          KIGNORE               S01117
     F*********** TABLETXF                          KIGNORE               S01117
     F*********** TABLET2F                          KIGNORE               S01117
     F*********** TABLET3F                          KIGNORE               S01117
     F*********** TABLET5F                          KIGNORE               S01117
     F*********** TABTB40F                          KIGNORE               S01117
     F*SETLT**IF**E           K        DISK                        051418 082738
     F************SETLEDF                           KRENAMESETLEDFX051418 082738
     FSETLE   O   E                    DISK         KCOMIT
     FESETT   UF  E           K        DISK         KCOMIT
     FTRADS   UF  E           K        DISK         KCOMIT
     F                                              KINFDS INFDS
     F                                              KINFSR INFSR
     FSETLEA  UF  E                    DISK         KCOMIT
     F*MEMOS**UF**E                    DISK         KCOMIT            U1  082738
     F*PRONO**UF**E           K        DISK         KCOMIT         051418 082738
     F*SACMTPDO***E                    DISK                        S01154 082738
     F************                                  KCOMIT         S01154 082738
     FCDEPP   UF  E           K        DISK         KCOMIT       A        S01158
     FCDEPPA  UF  E                    DISK         KCOMIT                S01158
     FUDEPP   UF  E           K        DISK         KCOMIT       A        S01158
     FUDEPPA  UF  E                    DISK         KCOMIT                S01158
     F*TABTB20*IF**E***                 DISK                    U1  E16843S01117
      *                                                                                       CSD015
      ** Compliance Watch Hit List by Function Type, Identifier, Branch                       CSD015
     FSDCWHTL1IF  E           K        DISK                                                   CSD015
      *                                                                                       CSD015
     F/COPY WNCPYSRC,SE0060F001
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   01  - F/3 pressed - End job                                 *
     F*   04  - F/10 pressed - Cancel Euroclear settlement            *
     F*   05  - F/12 pressed - Ignore Euroclear settlement            *
     F*   06  - HELP key pressed                                      *
     F*   19  - Seton if change made to Euroclear settlement          *
     F*   21  - Seton to non-display key entry fields for             *
     F*         Euroclear settlements and display correct headings    *
     F*   25  - Warning error controller if value exceeds             *
     F*         discrepancy limits for full settlement                *
     F*   29  - ON-Deliver to/Pay from, OFF-Deliver from/Pay to       *
     F*   33  - General Work Indicator                                *
     F*   34  - Control reading of Euroclear settlements file         *
     F*   35  - Prevent display of Euroclear settlement if user is    *   S01117
     F*         not authorised to that settlement                     *   S01117
     F*   41  - Account blocked for debits                            *   E16843
     F*   42  - Account blocked for credits                           *   E16843
     F*   60  - Reversal                                              *   E16187
     F*   70  - Seton to display error codes                          *
     F*   71  - Error on Trade reference field                        *
     F*   72  - Error on Movement date field                          *
     F*   73  - Error on Fully settled indicator                      *
     F*   74  - Error on Reversal indicator                           *
     F*   75  - Error on Nominal settled field                        *
     F*   76  - Error on Value settled field                          *
     F*   77  - Error on Settlement reference field                   *
     F*   88  - Multibranching Indicator                              *   S01117
     F*                                                               *
     F* 90-99 -  Used in standard sub-routines                        *
     F*                                                               *
     F*   U1  - Passed to program - ON if Retail Module present       *
     F*   U7  - Database error                                        *
     F*   U8  - Database / Control error                              *
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*   CLTPOS - Update Client positions                            *   S01158
     F*   DETAIL - Process Detail screen (Format SE0060F2)            *
     F*   EURSET - Process Euroclear settlements                      *
     F*   INFSR  - Exception/Error handling                           *
     F*   INITL  - Process Initial screen (Format SE0060F1)           *
     F*   LOADF2 - Load format fields on detail screen from files     *
     F****RTIME**-*Write Account Movement Record PF/RSACMTPD       S01154 082738
     F*   SETDET - Prepare Settlement details for output to file      *
     F****SHADOW*-*Do Shadow Posting                               051418 082738
     F****UPDMEM*-*Update PF/MEMOS                                    *   082738
     F****UPDPRO*-*Update PF/PRONOPN                               051418 082738
     F****AONOST*-*Call access object - Nostros                    051418 082738
     F*   UPDNON - Update database for Non-Euroclear settlements      *
     F*   USRPOS - Update User Depot position                         *   S01158
     F*   VLDDET - Validate detail screen                             *
     F*   VLDITL - Validate initial screen                            *
     F*   *PSSR  - Handle abnormal error conditions                   *   S01117
     F*                                                               *
     F*   ZACCH  - Holiday Processing                                 *   S01117
     F*   ZALIGN - Validate and right-align numeric fields            *
     F*   ZCHKH  - Holiday Processing                                 *   S01117
     F*   ZCONV  - Convert an amount from one currency to another     *
     F*   ZDATE1 - DATE - DAYNO conversion                            *
     F*   ZDATE2 - DAYNO - DATE conversion                            *
     F****ZICD2**-*Access*ICD*record*2******                          *   S01117
     F****ZICDSE*-*Access*ICD*record*for*Securities*Trading******     *   S01117
     F*   ZSEDIT - Insert a decimal point and sign into a numeric fiel*   S01158
     F****ZSYSTM*-*Access*ICD*record******                            *   S01117
     F*   ZTNLU1 - Fetch next available transaction number            *
     F*                                                               *
     F*****************************************************************
      /EJECT
     E                    CPY@    1   1 80
     E                    ERR        19  4
     E                    INF     1   1 76
     E/COPY ZSRSRC,ZSEDITZ1
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZALIGNZ1
     E/COPY ZSRSRC,ZPOWERZ1
     E***/COPY*ZSRSRC*ZDATE6Z1                                            S01195
     E********************TABMTH  1   5  2 0 TABMTN 22                    E14218
     E                    TABMTH  1   6  1 0 TABMTN 22                    E14218
     E                    REF         6  1
     E********************NNB         5 15 0             NOSTRO BAL051418 082738
     E********************ANB         5  8               NOSTRO BAL051418 082738
     E/COPY ZSRSRC,ZHOLE                                                  S01195
      /EJECT
     ITRADSDF
     I              RECI                            RECITR                E15846
     I              LCD                             LCDTR
     I              CHTP                            CHTPTR
     I/COPY WNCPYSRC,SE0060I001
     I*                                                                   051418
     I***Rename*fields for numeric arrays                          051418 082738
     I************                                                 051418 082738
     I*RONOPNF****                                                 051418 082738
     I************  PNB                             PNBA           051418 082738
     I************  CNUM                            CNUMA          051418 082738
     I************                                                 051418 082738
     I***Data*structures to format numeric arrays/fields           051418 082738
     I************DS                                               051418 082738
     I************                        P   1  40 NNB            051418 082738
     I************                            1  40 ANB            051418 082738
     I/COPY ZSRSRC,ZSEDITZ2                                               S01158
     I*
     I**DATA*STRUCTURE*FOR*ZDATE5*                                        S01195
     I***********                                                         S01195
     I*********** DS                                                      S01195
     I***********                             1  75 HCCY                  S01195
     I***********                             1  75 XCCY                  S01195
     ISESTAT    E DS
     I              EUTX                            EUTXB                                     CPK024
     I            DS
     I                                        1  76 ERR
     I                                        1  76 ERRMSG
     IDSACC       DS                                                      E16843
     I**********                              1   60KYCNUM                             E16843 CSD027
     I                                        1   6 KYCNUM                                    CSD027
     I                                        7   9 KYCCY                 E16843
     I**********                             10  130KYACOD                             E16843 CGL029
     I**********                             14  150KYACSQ                             E16843 CGL029
     I**********                             16  18 KYBRCA                             S01117 CGL029
     I                                       10  190KYACOD                                    CGL029
     I                                       20  210KYACSQ                                    CGL029
     I                                       22  24 KYBRCA                                    CGL029
     I*
     IINFDS       DS
     I                                     *STATUS  STATUS
     I*
     I***LDA*****   UDS                            256                    S01117
     ILDA         DS                            256                       S01117
     I** *LOCK IN LDA immediately before and OUT LDA immediately          S01117
     I** after each database error handling.                              S01117
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 177 DBASE                 S01117
     I                                      134 183 DBLOT                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     I/COPY ZSRSRC,ZTNLU1Z1
     I*                                                                   S01195
     I/COPY ZSRSRC,ZHOLI                                                  S01195
      **  EXTERNAL DS FOR HOLIDAY DETAILS                                 S01195
     I*                                                                   S01195
     I/COPY ZSRSRC,ZHOLDS                                                 S01195
      **  EXTERNAL DS FOR HOLIDAY DETAILS AND ACCESS OBJECTS              S01195
      *
     ICMTTXT      DS
     I                                        1   50NATN
     I                                        6   7 MDID
     I                                        8  15 PGMN
     I                                       16  18 WSIDX
     I                                       19  240MTIME
     I                                       25  25 ACTNX
     I                                       26  35 USIDX
     I                                       51 306 DET
     I           SDS
     I*                                                                   S01408
     I/COPY WNCPYSRC,SE0060IIP1                                           S01408
     I*                                                                   S01408
     I                                      244 246 WSID
     I                                      254 263 USID
      *
      ** Data structure for compilation - copyright insertion
      *
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *                                                                   S01117
     IRUNDT       DS                                                      S01117
      *                                                                   S01117
      ** Data area RUNDAT                                                 S01117
      *                                                                   S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
      *                                                                   S01117
     IZMUSER      DS                             17                       S01117
      *                                                                   S01117
      ** Data area of menu user                                           S01117
      *                                                                   S01117
     I                                       11  13 USRBCH                S01117
      *                                                                   S01117
     ISDBANK    E DSSDBANKPD                                              S01117
      *                                                                   S01117
      ** External data structure for Bank details                         S01117
      *                                                                   S01117
     ISDBRCH    E DSSDBRCHPD                                              S01117
      *                                                                   S01117
      ** External data structure for Branch details                       S01117
      *                                                                   S01117
     ISDCURR    E DSSDCURRPD                                              S01117
      *                                                                   S01117
      ** External data structure for Currency Details                     S01117
      *                                                                   S01117
     ISDCUST    E DSSDCUSTPD                                              S01117
     I              QQDFAC                          DFACQQ                                    CGL029
      *                                                                   S01117
      ** External data structure for Customer Details                     S01117
      *                                                                   S01117
     ISDRETL    E DSSDRETLPD                                              S01117
      *                                                                   S01117
      ** External data structure for Retail Details                       S01117
      *                                                                   S01117
     ISDSECS    E DSSDSECSPD                                              S01117
     I              QQACCD                          ACCDQQ                                    CGL029
      *                                                                   S01117
      ** External data structure for Securities Customer Details          S01117
      *                                                                   S01117
     ISDSTRD    E DSSDSTRDPD                                              S01117
      *                                                                   S01117
      ** External data structure for Securities Trading Details           S01117
      *                                                                   S01117
     ISDNOST    E DSSDNOSTPD                                              S01195
     I              QQACCD                          ACD2QQ                                    CGL029
      *                                                                   S01195
      ** External data structure for nostro details                       S01195
      *                                                                   S01195
     IDSPAYA      DS                             12                       S01195
      *                                                                   S01195
      ** Data area for the nostro location code in pay from/to account    S01195
      *                                                                   S01195
     I                                        1   2 SNOS                  S01195
      *                                                                   S01117
     IDSFDY     E DSDSFDY                                                 S01117
      *                                                                   S01117
      ** First DS for access programs, short data structure               S01117
      *                                                                                       CSD015
      ** Midas Functions for Watch List Checking Details File                                 CSD015
     ISDWLCC    E DSSDWLCCPD                                                                  CSD015
      *                                                                                       CSD015
      ** External DS for SAR Details                                                          CSD015
     ISCSARD    E DSSCSARDPD                                                                  CSD015
      *                                                                                       CSD015
      ** Midas 24 x 7 Status Data Structure                                                   CSD015
     ISC24X7    E DSSC24X7                                                                    CSD015
      *                                                                                       CSD015
      ** SD data area                                                                         CSD015
     ISDSTAT    E DSSDSTAT                                                                    CSD015
     I*                                                                   S01408
     I/COPY WNCPYSRC,SE0060IIP2                                           S01408
     I*                                                                   S01408
      *                                                                   S01117
     C/EJECT
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
     C*                                                                   S01158
     C* Assemble key to access Customer Position file                     S01158
     C*                                                                   S01158
     C           CPOSKA    KLIST                                          S01158
     C***********          KFLD           TDBR                      S01158S01117
     C                     KFLD           TDBA                            S01117
     C                     KFLD           TDSS                            S01158
     C                     KFLD           TCNR                            S01158
     C*                                                                   S01158
     C* Assemble key to access Customer Depot Position file               S01158
     C*                                                                   S01158
     C           CDEPKA    KLIST                                          S01158
     C***********          KFLD           TDBR                      S01158S01117
     C                     KFLD           TDBA                            S01117
     C                     KFLD           TCNR                            S01158
     C                     KFLD           TDSS                            S01158
     C**********           KFLD           DEPOT   60                                   S01158 CSD027
     C                     KFLD           DEPOT   6                                           CSD027
     C                     KFLD           TDMI                            S01158
     C*                                                                   S01158
     C* Assemble key to access User Depot Position file                   S01158
     C*                                                                   S01158
     C           UDEPKA    KLIST                                          S01158
     C***********          KFLD           TDBR                      S01158S01117
     C                     KFLD           TDBA                            S01117
     C                     KFLD           TDSS                            S01158
     C**********           KFLD           DEPOT   60                                   S01158 CSD027
     C                     KFLD           DEPOT   6                                           CSD027
     C                     KFLD           TDBK                            S01158
     C                     KFLD           TDMI                            S01158
     C*                                                                   S01158
     C* Key to fetch ACNUM record                                         S01158
     C*                                                                   S01158
     C           ACNKA     KLIST                                          S01158
     C                     KFLD           KEY10  100                      S01158
     C*                                                                   S01158
     C* Assemble key to fetch ACCNT record                                S01158
     C*                                                                   S01158
     C***********ACCKA     KLIST                                   S01158 E16843
     C***********          KFLD           CNUM                     S01158 E16843
     C***********          KFLD           CCY                      S01158 E16843
     C***********          KFLD           ACOD                     S01158 E16843
     C***********          KFLD           ACSQ                     S01158 E16843
     C           ACCKA     KLIST                                          E16843
     C                     KFLD           KYCNUM                          E16843
     C                     KFLD           KYCCY                           E16843
     C                     KFLD           KYACOD                          E16843
     C                     KFLD           KYACSQ                          E16843
     C                     KFLD           KYBRCA                          S01117
     C*
     C* Assemble key for pointer reference on Euroclear Settlements file
     C*
     C           ESEKA     KLIST
     C                     KFLD           SCRF
     C                     KFLD           TRDF
      *
      ** Prepare LDA
      *
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE *BLANKS   DBLOT
     C                     MOVE 'SE0060  'DBPGM
     C                     OUT  LDA                                       S01117
      *
      ** Prepare COMIT text
      *
     C                     MOVEL'SE'      MDID
     C                     MOVEL'SE0060'  PGMN
     C                     MOVELWSID      WSIDX
     C                     MOVELUSID      USIDX
      *
     C**Get*Installation*Control*Data*record*1*                           S01117
     C***********                                                         S01117
     C***********          EXSR ZSYSTM                                    S01117
     C***********                                                         S01117
     C**If*error*in*ZSYSTM,*terminate*program*                            S01117
     C***********                                                         S01117
     C************IN99     IFEQ '1'                        ***************S01117
     C***********          MOVE '01'      DBASE            **DB ERROR 01**S01117
     C***********          MOVEL'TABLE'   DBFILE           ***************S01117
     C***********          MOVELZTABKY    DBKEY                           S01117
     C***********          SETON                     U7U801               S01117
     C***********          END                                            S01117
      *                                                                   S01117
      ** Access Bank Details                                              S01117
      ** Do this before reading in RUNDAT to ensure MBIN is obtained      S01117
      ** from RUNDAT.                                                     S01117
      *                                                                   S01117
     C                     CALL 'AOBANKR0'                                S01117
     C                     PARM '*DBERR ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDBANK    PARM SDBANK    DSFDY                           S01117
      *                                                                   S01117
      ** Read in RUNDAT data area                                         S01117
      *                                                                   S01117
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
     C                     IN   RUNDT                                     S01117
      *                                                                   S01117
      ** Check system date format  DDMMYY or MMDDYY.                      S01117
      *                                                                   S01117
     C           DATF      COMP 'M'                      98               S01117
      *                                                                   S01117
     C           MBIN      IFEQ 'Y'                                       S01117
     C                     SETON                         88               S01117
     C                     END                                            S01117
      *                                                                   S01117
      ** Read in ZMUSER data area                                         S01117
      *                                                                   S01117
     C           *NAMVAR   DEFN           ZMUSER                          S01117
     C                     IN   ZMUSER                                    S01117
      *                                                                   E15286
      ** Convert run date to MMDDYY format for movement date default      E15286
      *                                                                   E15286
     C                     Z-ADDRUND      ZDAYNO                          E15286
     C                     EXSR ZDATE2                                    E15286
     C                     MOVE ZDATE     RUNMDY  6                       E15286
      ***********                                                         S01117
      ***Get*Installation*Control*Data*record*for*Securities*trading**    S01117
      ***********                                                         S01117
     C***********          EXSR ZICDSE                                    S01117
      ***********                                                         S01117
      ***If*error*in*ZICDSE,*terminate*program.*******                    S01117
      ***********                                                         S01117
     C************IN99     IFEQ '1'                                       S01117
     C************LOCK     IN   LDA                        ***************S01117
     C***********          MOVE '02'      DBASE            * DB ERROR 02 *S01117
     C***********          MOVEL'TABLE'   DBFILE           ***************S01117
     C***********          MOVELZTABKY    DBKEY                           S01117
     C***********          SETON                     U7U801               S01117
     C***********          END                                            S01117
      *                                                                   S01117
      **  Access Securities Trading details                               S01117
      *                                                                   S01117
     C                     CALL 'AOSTRDR0'                                S01117
     C                     PARM '*DBERR ' @RTCD                           S01117
     C                     PARM '*FIRST ' @OPTN                           S01117
     C           SDSTRD    PARM SDSTRD    DSSDY                           S01117
      *                                                                   S01117
     C**Get*Installation*Control*Data*record*2****************************S01117
     C***********                                                         S01117
     C***********          EXSR ZICD2                                     S01117
     C***********                                                         S01117
     C**If*error*in*ZICD2,*terminate*program******************************S01117
     C***********                                                         S01117
     C************IN99     IFEQ '1'                        ***************S01117
     C***********          MOVE '03'      DBASE            **DB ERROR 03**S01117
     C***********          MOVEL'TABLE'   DBFILE           ***************S01117
     C***********          MOVELZTABKY    DBKEY                           S01117
     C***********          SETON                     U7U801               S01117
     C***********          END                                            S01117
      ***********                                                   E16843S01117
      ***Get*Installation*Control*Data*record*3********             E16843S01117
      ***********                                                   E16843S01117
     C***********1         CHAINTABTB20              99             E16843S01117
      ***********                                                   E16843S01117
      ***If*error,*terminate*program***********                     E16843S01117
      ***********                                                   E16843S01117
     C************IN99     IFEQ '1'                                 E16843S01117
     C***********          MOVE '04'      DBASE            *********E16843S01117
     C***********          MOVEL'TABLE'   DBFILE     * DB ERROR 04 *E16843S01117
     C***********          MOVEL'TB20'    DBKEY            *********E16843S01117
     C***********          SETON                     U7U801         E16843S01117
     C***********          END                                      E16843S01117
      *                                                                   S01117
      **  Access Retail details                                           S01117
      *                                                                   S01117
     C           *INU1     IFEQ '1'                                       047225
     C                     CALL 'AORETLR0'                                S01117
     C                     PARM '*DBERR ' @RTCD                           S01117
     C                     PARM '*FIRST ' @OPTN                           S01117
     C           SDRETL    PARM SDRETL    DSFDY                           S01117
     C                     END                                            047225
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE0060CCP1                                           S01408
     C*                                                                   S01408
      *                                                                   CSE007
      **  Access Switchable features CSE007                               CSE007
      *                                                                   CSE007
     C                     MOVE 'N'       CSE007                          CSE007
     C                     CALL 'AOSARDR0'                                CSE007
     C                     PARM '       ' @RTCD   7                       CSE007
     C                     PARM '*VERIFY' @OPTN   7                       CSE007
     C                     PARM 'CSE007'  @SARD   6                       CSE007
      *                                                                   CSE007
     C           @RTCD     IFEQ *BLANK                                    CSE007
     C                     MOVE 'Y'       CSE007  1                       CSE007
     C                     END                                            CSE007
      *                                                                   CEU017
      **  Access Switchable features CEU017                               CEU017
      *                                                                   CEU017
     C                     MOVE 'N'       CEU017                          CEU017
     C                     CALL 'AOSARDR0'                                CEU017
     C                     PARM '       ' @RTCD   7                       CEU017
     C                     PARM '*VERIFY' @OPTN   7                       CEU017
     C                     PARM 'CEU017'  @SARD   6                       CEU017
      *                                                                   CEU017
     C           @RTCD     IFEQ *BLANK                                    CEU017
     C                     MOVE 'Y'       CEU017  1                       CEU017
     C                     END                                            CEU017
      *                                                                                       CSD015
      ** Key List for LF/SDCWHTL1                                                             CSD015
      *                                                                                       CSD015
     C           KCWHTL    KLIST                                                              CSD015
     C                     KFLD           KFUNT   8                                           CSD015
     C                     KFLD           KIDEN  40                                           CSD015
     C                     KFLD           KBRCH   3                                           CSD015
      *                                                                                       CSD015
      ** Define dataara SDSTAT and SC24X7                                                     CSD015
      *                                                                                       CSD015
     C           *NAMVAR   DEFN           SC24X7                                              CSD015
     C           *NAMVAR   DEFN           SDSTAT                                              CSD015
     C                     IN   SDSTAT                                                        CSD015
      *                                                                                       CSD015
      ** Check if 24x7 Midas Availability is installed                                        CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   @RTCD                                               CSD015
     C                     PARM '*VERIFY' @OPTN                                               CSD015
     C                     PARM 'CSC011'  @SARD                                               CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
      ** If return code not blank nor *NRF, then issue database error                         CSD015
      *                                                                                       CSD015
     C           @RTCD     IFNE *BLANKS                                                       CSD015
     C           @RTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVE 'SCSARDPD'DBFILE                                              CSD015
     C                     MOVE 'CSC011'  DBKEY                                               CSD015
     C                     Z-ADD43        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     SETON                     U7U8                                     CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           @RTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSC011  1                                           CSD015
     C                     IN   SC24X7                                                        CSD015
     C                     ELSE                                                               CSD015
     C                     MOVE 'N'       CSC011                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if Compliance Watch Enhancement is installed                                   CSD015
      *                                                                                       CSD015
     C                     CALL 'AOSARDR0'                                                    CSD015
     C                     PARM *BLANKS   @RTCD                                               CSD015
     C                     PARM '*VERIFY' @OPTN                                               CSD015
     C                     PARM 'CSD015'  @SARD                                               CSD015
     C           SCSARD    PARM SCSARD    DSFDY                                               CSD015
      *                                                                                       CSD015
      ** If return code not blank nor *NRF, then issue database error                         CSD015
      *                                                                                       CSD015
     C           @RTCD     IFNE *BLANKS                                                       CSD015
     C           @RTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVE 'SCSARDPD'DBFILE                                              CSD015
     C                     MOVE 'CSD015'  DBKEY                                               CSD015
     C                     Z-ADD44        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     SETON                     U7U8                                     CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           @RTCD     IFEQ *BLANKS                                                       CSD015
     C                     MOVE 'Y'       CSD015  1                                           CSD015
     C                     ELSE                                                               CSD015
     C                     MOVE 'N'       CSD015                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
      ** Check if function code is being monitored by compliance watch                        CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C                     CALL 'AOWLCCR0'                                                    CSD015
     C                     PARM *BLANKS   @RTCD                                               CSD015
     C                     PARM '*KEY   ' @OPTN                                               CSD015
     C                     PARM 'SECTTRAD'PFUNC   8                                           CSD015
     C           SDWLCC    PARM SDWLCC    DSSDY                                               CSD015
      *                                                                                       CSD015
      ** If return code not blank nor *NRF, then issue database error                         CSD015
      *                                                                                       CSD015
     C           @RTCD     IFNE *BLANKS                                                       CSD015
     C           @RTCD     ANDNE'*NRF   '                                                     CSD015
     C           *LOCK     IN   LDA                                                           CSD015
     C                     MOVE 'SECTTRAD'DBKEY                                               CSD015
     C                     MOVE 'SCWLCCPD'DBFILE                                              CSD015
     C                     Z-ADD45        DBASE                                               CSD015
     C                     OUT  LDA                                                           CSD015
     C                     SETON                     U7U8                                     CSD015
     C                     EXSR *PSSR                                                         CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
     C*
     C* Define work fields
     C*
     C           *LIKE     DEFN SCRF      SCRF2
     C           *LIKE     DEFN TRDF      TRDF2
     C           *LIKE     DEFN TSSQ      STSSQ
     C           *LIKE     DEFN EC        WEC
     C*
     C**If*Autpost*indicator*is*2,*and*DTAARA*SESTAT*(55 1)*is*'N',****   S01190
     C**process*Euroclear*Settlements**********************************   S01190
     C* If Auto Trans Interface indicator is 2, and DTAARA SESTAT         S01190
     C* (55 1) is 'N', process Euroclear Settlements.                     S01190
     C*
     C* Read in data area
     C*
     C           *NAMVAR   DEFN           SESTAT
     C           *LOCK     IN   SESTAT
     C*
     C***********APNS      IFEQ '2'                                       S01190
     C***********ATRM      IFEQ '2'                                 S01190S01117
     C           BVATI     IFEQ '2'                                       S01117
     C***********EUSP      ANDEQ'N'                                       S01190
     C           EUSP      ANDNE'Y'                                       S01190
     C                     EXSR EURSET
     C                     ELSE
     C                     OUT  SESTAT
     C                     END
     C*
     C                     SETOF                     05
     C*
     C* Process manual entries until end of program requested
     C* or until database error encountered.                              E20125
     C*
     C           *IN01     DOWEQ'0'
     C           *INU7     ANDEQ'0'                                       E20125
     C*
     C* Process Initial screen
     C*
     C                     SETOF                     05
     C                     EXSR INITL
     C*
     C* Process Detail screen (not if Cmd 1 or Cmd 5 pressed)
     C* Also skip if database error encountered during validation.        E20125
     C*
     C           *IN01     IFEQ '0'
     C           *IN05     ANDEQ'0'
     C           *INU7     ANDEQ'0'                                       E20125
     C                     EXSR LOADF2
     C                     EXSR DETAIL
     C                     END
     C*
     C                     END
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *                                                               *
     C                     SETON                     LRRT
     C                     RETRN
      *                                                               *
      *================================================================
      /EJECT                                                              S01158
      *****************************************************************   S01158
      *                                                               *   S01158
      *  CLTPOS - Subroutine to Update Client Positions.              *   S01158
      *                                                               *   S01158
      *****************************************************************   S01158
      *                                                                   S01158
     C           CLTPOS    BEGSR                           *** CLTPOS *** S01158
     C*                                                                   S01158
     C* Update Client Depot position                                      S01158
     C*                                                                   S01158
     C           TDTP      IFEQ 'TP'                                      S01158
     C**********           Z-ADDDELF      DEPOT                                        S01158 CSD027
     C                     MOVE DELF      DEPOT                                               CSD027
     C                     ELSE                                           S01158
     C           TDTP      IFEQ 'TS'                                      S01158
     C**********           Z-ADDDELT      DEPOT                                        S01158 CSD027
     C                     MOVE DELT      DEPOT                                               CSD027
     C                     END                                            S01158
     C                     END                                            S01158
      *                                                                   S01158
     C           CDEPKA    CHAINCDEPPDF              33                   S01158
      *                                                                   S01158
      ***  Record Id, Branch, Customer Number, Security, Market.          S01158
      *                                                                   S01158
     C                     MOVE 'D'       RECI                            S01158
     C***********          Z-ADDTDBR      CDBR                      S01158S01117
     C                     MOVE TDBA      CDPA                            S01117
     C**********           Z-ADDTCNR      CDCN                                         S01158 CSD027
     C                     MOVE TCNR      CDCN                                                CSD027
     C                     MOVE TDSS      CDSN                            S01158
     C                     MOVE TDMI      CDMK                            S01158
      *                                                                   S01158
      ***  Depot                                                          S01158
      *                                                                   S01158
     C           TDTP      IFEQ 'TP'                                      S01158
     C**********           Z-ADDDELF      CDPT                                         S01158 CSD027
     C                     MOVE DELF      CDPT                                                CSD027
     C                     ELSE                                           S01158
     C           TDTP      IFEQ 'TS'                                      S01158
     C**********           Z-ADDDELT      CDPT                                         S01158 CSD027
     C                     MOVE DELT      CDPT                                                CSD027
     C                     END                                            S01158
     C                     END                                            S01158
      *                                                                   S01158
      ***  Nominal (COB) - Trade, Value and Settlement Bases              S01158
     C   33                Z-ADD*ZEROS    CDNT                            S01158
     C   33                Z-ADD*ZEROS    CDNV                            S01158
     C   33                Z-ADD*ZEROS    CDNS                            S01158
      *                                                                   S01158
      ***  Nominal Settled (I/C)                                          S01158
     C           SREVE     IFNE 'Y'                                       S01158
     C           TDTP      IFEQ 'TP'                                      S01158
     C                     SUB  NOMSET    CNSI                            S01158
     C                     ELSE                                           S01158
     C                     ADD  NOMSET    CNSI                            S01158
     C                     END                                            S01158
     C*                                                                   S01158
     C                     ELSE                                           S01158
     C           TDTP      IFEQ 'TP'                                      S01158
     C                     ADD  NOMSET    CNSI                            S01158
     C                     ELSE                                           S01158
     C                     SUB  NOMSET    CNSI                            S01158
     C                     END                                            S01158
     C                     END                                            S01158
      *                                                                   S01158
      ***  Sum Nominals and A P Numerators                                S01158
     C           *IN33     IFEQ '1'                                       S01158
     C                     Z-ADD*ZEROS    SNPT                            S01158
     C                     Z-ADD*ZEROS    CDST                            S01158
     C                     Z-ADD*ZEROS    SAPP                            S01158
     C                     Z-ADD*ZEROS    SAPS                            S01158
     C                     Z-ADD*ZEROS    CNPV                            S01158
     C                     Z-ADD*ZEROS    CNSV                            S01158
     C                     Z-ADD*ZEROS    SAPV                            S01158
     C                     Z-ADD*ZEROS    SPSV                            S01158
     C                     END                                            S01158
      *                                                                   S01158
     C                     Z-ADDNATN      TNLU                            S01158
     C           *IN33     IFEQ '0'                                       S01158
     C                     UPDATCDEPPDF                                   S01158
     C                     ELSE                                           S01158
     C                     WRITECDEPPDF                                   S01158
     C*                                                                   S01158
     C           1         CHAINCDEPPAF              33                   S01158
     C           *IN33     IFEQ '1'                                       S01158
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '08'      DBASE                     S01158S01117
     C                     Z-ADD8         DBASE            ***************S01117
     C                     MOVEL'CDEPP'   DBFILE           * DB ERROR 08 *S01158
     C                     MOVEL'AUDIT'   DBKEY            ***************S01158
     C                     OUT  LDA                                       S01117
     C                     SETON                     U7U801               S01158
     C                     EXSR *PSSR                                     S01117
     C                     ELSE                                           S01158
     C                     ADD  1         NORE                            S01158
     C                     MOVELNATN      TNLU                            S01158
     C                     UPDATCDEPPAF                                   S01158
     C                     END                                            S01158
     C                     END                                            S01158
     C*                                                                   S01158
     C                     ENDSR                                          S01158
      *                                                                   S01158
      *****************************************************************   S01158
      /EJECT
      *****************************************************************
      *                                                               *
      *  DETAIL - Subroutine to process Detail Screen.                *
      *                                                               *
      *****************************************************************
      *
     C           DETAIL    BEGSR                           *** DETAIL ***
     C*
     C* Display Detail screen
     C*
     C                     MOVE 'Y'       FIRST   1
      *
     C           DETAG1    TAG                             ** DETAG1 TAG *
     C                     EXFMTSE0060F2
     C*
     C* F/3 or F/12 - Return to Main processing
     C*
     C   01
     COR 05                GOTO DEEND
     C*
     C**'HELP'*key*pressed*-*Display*error*codes***********************   S01199
     C***********                                                         S01199
     C************IN06     IFEQ '1'                                       S01199
     C***********          CALL 'MHELP'                                   S01199
     C***********          PARM           DBPGM                           S01199
     C***********          PARM           ERRMSG                          S01199
     C***********                                                         S01199
     C***********          GOTO DETAG1                                    S01199
     C***********          END                                            S01199
     C*
     C                     SETOF                     70
      *
      **  IF BEEN THROUGH AT LEAST ONCE, ALL ERRORS ARE WARNING ERRORS,
      **  AND NO SCREEN CHANGES, DO THE UPDATE, NO NEED TO VALIDATE.
      *
     C           FIRST     IFEQ 'N'
     C           WEC       ANDEQEC
     C           *IN19     ANDEQ'0'
     C                     GOTO UPD
     C                     END
     C*
     C* Validate Detail screen
     C*
     C                     EXSR VLDDET
      *
     C                     MOVE 'N'       FIRST
     C*
     C* If errors, re-display screen
     C*
     C           EC        CABNE*ZEROS    DETAG1     70
      *
     C           UPD       TAG                             ***  UPD   ***
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE0060CCP2                                           S01408
     C*                                                                   S01408
     C*
     C* If no errors, update database for non-Euroclear settlements
     C*
     C                     EXSR UPDNON
     C*
     C* If updated by another workstation, re-display screen
     C*
     C           *IN70     CABEQ'1'       DETAG1
     C*
     C           DEEND     ENDSR                           * DEEND ENDSR *
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  EURSET - Subroutine to process Euroclear Settlements.        *
      *                                                               *
      *****************************************************************
      *
     C           EURSET    BEGSR                           *** EURSET ***
     C*
     C* Update data area
     C*
     C                     MOVE 'Y'       EUSP
     C                     OUT  SESTAT
     C*                                                                   S01190
     C* Set up key for ESETTST                                            S01190
     C*                                                                   S01190
     C                     MOVE '99999999'ESCHN  10                       S01190
     C                     MOVEL'99'      ESCHN                           S01190
     C*
     C* Read in all outstanding settlements
     C*
     C                     Z-ADD*ZEROS    COUNT
     C                     SETOF                     34
     C           *IN34     DOWEQ'0'
     C                     READ ESETTSSF                 34
     C           *IN34     IFEQ '0'
     C*
     C* Count records to re-position pointer
     C*
     C                     ADD  1         COUNT   30
     C           SCRF      IFNE SCRF2
     C           TRDF      ORNE TRDF2
     C                     MOVE SCRF      SCRF2
     C                     MOVE TRDF      TRDF2
     C                     Z-ADD1         COUNT
     C                     END
     C*
     C           RECI      IFEQ 'D'
     C           SEDT      ANDLERUND                                      S01190
      *                                                                   S01117
      ** Fetch Trade detail                                               S01117
      *                                                                   S01117
     C                     MOVE TRDF      WORK6A                          S01117
     C                     MOVEAWORK6A    REF                             S01117
     C                     SETOF                     33                   S01117
     C                     Z-ADD*ZERO     X                               S01117
     C           *IN33     DOUEQ'1'                                       S01117
     C                     ADD  1         X                               S01117
     C           REF,X     IFNE '0'                                       S01117
     C           REF,X     ANDNE' '                                       S01117
     C                     SETON                     33                   S01117
     C                     ELSE                                           S01117
     C                     MOVEA' '       REF,X                           S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     MOVEAREF       WORK6A  6                       S01117
     C           WORK6A    CHAINTRADSDFX             33                   S01117
      *                                                                   S01117
      ** Reset indicator 35                                               S01117
      *                                                                   S01117
     C                     SETOF                     35                   S01117
      *                                                                   S01117
      ** Set on indicator 35 to inhibit the display of the Euroclear      S01117
      ** settlement record if the user is not authorised to that branch   S01117
      *                                                                   S01117
      ** If single branch environment                                     S01117
      *                                                                   S01117
     C           MBIN      IFNE 'Y'                                       S01117
     C                     CALL 'ZVACTU'                                  S01117
     C                     PARM 'I'       @ZACTN  1                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE *ZERO                                     S01117
     C                     SETON                     35                   S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     ELSE                                           S01117
      *                                                                   S01117
      ** If multibranching environment                                    S01117
      *                                                                   S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM 'I'       @ZACTN  1                       S01117
     C                     PARM TDBA      @ZBR    3                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE *ZERO                                     S01117
     C                     SETON                     35                   S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     END                                            S01117
      *
      ** Load format fields for display
      *
     C           *IN35     IFEQ '0'                                       S01117
     C                     SETON                     2125
     C                     Z-ADD*ZEROS    WK13N
     C                     EXSR LOADF2
     C*
     C* Display Detail screen
     C*
     C           EUTAG1    TAG                             ** EUTAG1 TAG *
     C                     EXFMTSE0060F2
     C*
     C* F/3 pressed - End program
     C*
     C   01                GOTO EUREND
     C*
     C**'HELP'*key*pressed*-*Display*error*codes***********************   S01199
     C***********                                                         S01199
     C************IN06     IFEQ '1'                                       S01199
     C***********          CALL 'MHELP'                                   S01199
     C***********          PARM           DBPGM                           S01199
     C***********          PARM           ERRMSG                          S01199
     C***********                                                         S01199
     C***********          GOTO EUTAG1                                    S01199
     C***********          END                                            S01199
     C*
     C                     SETOF                     70
     C*
     C* F/10 pressed - Reject this record
     C*
     C           *IN04     IFEQ '1'
      *                                                                   S01117
     C                     Z-ADD*ZEROS    EC                              S01117
     C                     Z-ADD*ZEROS    WEC                             S01117
     C                     SETOF                     70                   S01117
     C                     MOVE *BLANKS   ERRMSG                          S01117
      *                                                                   S01117
      ** If single branch environment                                     S01117
      *                                                                   S01117
     C           MBIN      IFNE 'Y'                                       S01117
     C                     CALL 'ZVACTU'                                  S01117
     C                     PARM 'D'       @ZACTN  1                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE *ZERO                                     S01117
     C                     ADD  1         EC                              S01117
     C                     MOVE ' 302'    ERR,EC                          S01117
     C                     SETON                     70                   S01117
     C                     GOTO EUTAG1                                    S01117
     C                     END                                            S01117
     C                     ELSE                                           S01117
      *                                                                   S01117
      ** If multibranching environment                                    S01117
      *                                                                   S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM 'D'       @ZACTN  1                       S01117
     C                     PARM TDBA      @ZBR    3                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE *ZEROS                                    S01117
     C                     ADD  1         EC                              S01117
     C                     MOVE ' 304'    ERR,EC                          S01117
     C                     SETON                     70                   S01117
     C                     GOTO EUTAG1                                    S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *                                                                   S01117
     C           @ERR      IFEQ *ZERO                                     S01117
     C                     MOVE 'C'       RECI
     C                     UPDATESETTSSF
      *
      ** Subtract 1 from audit record
      *
     C***********ESEKA     CHAINESETTSTF             33                   S01190
     C           ESCHN     CHAINESETTSTF             33                   S01190
     C                     EXSR ZTNLU1
     C                     SUB  1         NORE
     C                     Z-ADDRUND      LCD
     C                     MOVE 'C'       CHTP
     C                     MOVELNATN      TNLU
     C  N33                UPDATESETTSTF
     C*                                                                   S01190
     C* Re-position pointer on settlements file                           S01190
     C*                                                                   S01190
     C                     MOVE TRDF2     TRDF                            S01190
     C                     MOVE SCRF2     SCRF                            S01190
     C           ESEKA     SETLLESETTSSF                                  S01190
     C                     DO   COUNT                                     S01190
     C                     READ ESETTSSF                 33               S01190
     C                     END                                            S01190
      *                                                                   S01190
      ** COMIT Updates.                                                   S01190
      *
     C                     COMIT                                          S01190
     C                     END                                            S01117
      *                                                                   S01117
     C                     END
      *
      ** F/12 pressed - Ignore this record
      *
     C           *IN05     IFEQ '1'
     C                     SETOF                     757677
     C                     Z-ADD*ZEROS    EC
     C                     Z-ADD*ZEROS    WEC
     C                     MOVE *BLANKS   ERRMSG
     C                     END
     C*
     C* Validate input
     C*
     C           *IN04     IFEQ '0'
     C           *IN05     ANDEQ'0'
     C                     EXSR VLDDET
     C*
     C* If errors, re-display screen
     C*
     C           WEC       IFNE EC
     C           EC        CABGT*ZEROS    EUTAG1     70
     C                     END
     C                     END
     C*
     C* If no errors and F/10 and F/12 not pressed, Accept Euroclear
     C* settlement
     C*
     C           *IN04     IFEQ '0'
     C           *IN05     ANDEQ'0'
     C*
     C* Update Settlement record
     C*
     C                     MOVE '*'       RECI
     C   19                MOVE 'A'       RECI
     C                     UPDATESETTSSF
     C*
     C* Update trailer record
     C*
     C***********ESEKA     CHAINESETTSTF             33                   S01190
     C           ESCHN     CHAINESETTSTF             33                   S01190
     C                     EXSR ZTNLU1
     C                     SUB  1         NORE
     C                     Z-ADDRUND      LCD
     C                     MOVE 'A'       CHTP
     C                     MOVELNATN      TNLU
     C  N33                UPDATESETTSTF
     C*
     C* Re-position pointer on settlements file
     C*
     C                     MOVE TRDF2     TRDF                            S01190
     C                     MOVE SCRF2     SCRF                            S01190
     C           ESEKA     SETLLESETTSSF
     C                     DO   COUNT
     C                     READ ESETTSSF                 33
     C                     END
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE0060CCP3                                           S01408
     C*                                                                   S01408
     C*
     C* Update Non-euroclear settlement
     C*
     C                     EXSR UPDNON
     C*
     C* If updated by another workstation, re-display screen
     C*
     C************IN70     CABEQ'1'       EUTAG1                          S01190
     C           *IN70     IFEQ '1'                                       S01190
     C                     ROLBK                                          S01190
     C                     GOTO EUTAG1                                    S01190
     C                     END                                            S01190
     C*
     C                     END
     C                     END                                            S01117
     C                     END
     C                     END
     C                     END
     C*
     C                     SETOF                     21
     C*                                                                   S01190
     C           EUREND    TAG                             ** EUREND TAG *S01190
     C*
     C* Update data area
     C*
     C           *LOCK     IN   SESTAT
     C                     MOVE 'N'       EUSP
     C                     OUT  SESTAT
     C*
     C*R*********EUREND    ENDSR                           ** EUREND TAG *S01190
     C                     ENDSR                                          S01190
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  INFSR  - File Exception/Error Handling Subroutine.           *
      *                                                               *
      *****************************************************************
      *
     C           INFSR     BEGSR                           *** INFSR  ***
     C**
     C**   CHECK ERROR TYPE
     C**
     C           STATUS    IFEQ 01021
     C**
     C**   CHAIN TO FILE TO GET CURRENT DETAILS
     C**
     C           STRDR     CHAINTRADSDF              99
     C**
     C           *IN99     IFEQ '0'
     C**
     C**   ROLL BACK UPDATES ALREADY DONE
     C**
     C                     ROLBK
     C**
     C                     END
     C**
     C                     END
     C**
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  INITL  - Subroutine to process Initial Screen.               *
      *                                                               *
      *****************************************************************
      *
     C           INITL     BEGSR                           *** INITL  ***
     C*
     C                     SETOF                     25
     C                     Z-ADD*ZEROS    WK13N
     C                     MOVEA'00000'   *IN,70
     C*
     C                     MOVE *BLANKS   STRDR
     C*                                                                   E15286
     C* Let movement date default to run date                             E15286
     C***********          MOVE *BLANKS   SMVDT                           E15286
     C                     MOVE RUNMDY    SMVDT                           E15286
     C                     MOVE *BLANK    SFSET
     C                     MOVE *BLANK    SREVE
     C*
     C                     MOVE 'Y'       FIRST   1
     C*
     C* Display Initial screen
     C*
     C           INTAG1    TAG                             ** INTAG1 TAG *
     C                     EXFMTSE0060F1
     C                     SETOF                     70
     C*
     C* F/3 - End program
     C*
     C   01                GOTO INIEND
     C*
     C**'HELP'*key*pressed*-*Display*error*codes***********************   S01199
     C***********                                                         S01199
     C************IN06     IFEQ '1'                                       S01199
     C***********          CALL 'MHELP'                                   S01199
     C***********          PARM           DBPGM                           S01199
     C***********          PARM           ERRMSG                          S01199
     C***********                                                         S01199
     C***********          GOTO INTAG1                                    S01199
     C***********          END                                            S01199
     C*
     C                     SETOF                     70
      *
      **  IF BEEN THROUGH AT LEAST ONCE, ALL ERRORS ARE WARNING ERRORS,
      **  AND NO SCREEN CHANGES, DO THE UPDATE, NO NEED TO VALIDATE.
      *
     C           FIRST     IFEQ 'N'
     C           WEC       ANDEQEC
     C           *IN19     ANDEQ'0'
     C***********          GOTO UPD1                                      S01158
     C                     GOTO INIEND                                    S01158
     C                     END
     C*
     C* Validate Initial screen
     C*
     C                     EXSR VLDITL
      *
     C                     MOVE 'N'       FIRST
     C*
     C* If errors, re-display screen
     C*
     C           EC        CABGT*ZEROS    INTAG1     70
      *
     C***********UPD1      TAG                                            S01158
     C*
     C           INIEND    ENDSR                           ** INIEND TAG *
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  LOADF2 - Subroutine to load Format fields on Detail Screen.  *
      *                                                               *
      *****************************************************************
      *
     C           LOADF2    BEGSR                           *** LOADF2 ***
     C*
     C* Setof error indicators
     C*
     C                     MOVEA'000'     *IN,75
     C                     Z-ADD*ZEROS    EC
     C                     MOVE *BLANKS   ERRMSG
     C*
     C* Fetch Trade detail
     C*
     C***********                                                         S01117
     C************IN21     IFEQ '1'                                       S01117
     C***********          MOVE TRDF      WORK6A                          S01117
     C***********          MOVEAWORK6A    REF                             S01117
     C***********          SETOF                     33                   S01117
     C***********          Z-ADD*ZERO     X                               S01117
     C************IN33     DOUEQ'1'                                       S01117
     C***********          ADD  1         X                               S01117
     C***********REF,X     IFNE '0'                                       S01117
     C***********REF,X     ANDNE' '                                       S01117
     C***********          SETON                     33                   S01117
     C***********          ELSE                                           S01117
     C***********          MOVEA' '       REF,X                           S01117
     C***********          END                                            S01117
     C***********          END                                            S01117
     C***********                                                         S01117
     C***********          MOVEAREF       WORK6A  6                       S01117
     C***********WORK6A    CHAINTRADSDFX             33                   S01117
     C***********          ELSE                                           S01117
     C*
     C           *IN21     IFEQ '0'                                       S01117
     C           STRDR     CHAINTRADSDFX             33
     C                     END
     C*
     C                     Z-ADDTNLU      STNLU   50
     C*
     C* Fetch Security detail
     C*
     C           TDSS      CHAINSECTYDF              33
     C*
     C* Fetch Client detail
     C*
     C***********TCNR      CHAINCLINTCBF             33                   S01117
     C                     MOVELTCNR      CUSTNO 10                       S01117
     C                     CALL 'AOCUSTR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM CUSTNO    @KEY1  10                       S01117
     C                     PARM *BLANKS   @KYST   7                       S01117
     C           SDCUST    PARM SDCUST    DSSDY                           S01117
     C*
     C* Trade type (Literal)
     C*
     C                     MOVE *BLANKS   SSLPR
     C                     SETOF                     29
     C           TDTP      IFEQ 'TP'
     C                     MOVE 'Purchase'SSLPR
     C                     SETON                     29
     C                     ELSE
     C           TDTP      IFEQ 'TS'
     C                     MOVEL'Sale'    SSLPR
     C                     END
     C                     END
     C*
     C* Branch code
     C*
     C***********          MOVE TDBR      SBRCD                           S01117
     C                     MOVE TDBA      SBRCD                           S01117
     C*
     C* Security report name
     C*
     C                     MOVELSRPN      SSRNM
     C*
     C* Customer report name and town
     C*
     C***********          MOVE CRNM      SCLNM                           S01117
     C***********          MOVE CTWN      STOWN                           S01117
     C                     MOVE BBCRNM    SCLNM                           S01117
     C                     MOVE BBCRTN    STOWN                           S01117
     C*
     C* Settlement type
     C*
     C                     MOVE SMTH      SSTYP
     C*
     C* Payment method name
     C*
     C                     MOVE *BLANKS   SPMTN
     C***********SMTH      LOKUPTABMTH    TABMTN         33               E14218
     C                     MOVE PCOD      PCODN   10
     C           PCODN     LOKUPTABMTH    TABMTN         33               E14218
     C   33                MOVE TABMTN    SPMTN
     C*
     C* If type is Purchase, text is 'Deliver to/Pay from'
     C*
     C                     SETOF                     29
     C           TDTP      IFEQ 'TP'
     C                     MOVE DELT      SDELI
     C                     MOVE PYFM      SPAYI
     C                     SETON                     29
     C                     ELSE
     C*
     C* else type is Sale, text is 'Deliver from/Pay to'
     C*
     C                     MOVE DELF      SDELI
     C                     MOVE PAYT      SPAYI
     C                     END
     C*
     C* Security shortname
     C*
     C                     MOVE TDSS      SSECS
     C*
     C* Trade reference
     C*
     C                     MOVE TDRF      STRAD
     C*
     C* Value date
     C*
     C                     Z-ADDTDVD      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     SVALD
     C*
     C* Client
     C*
     C                     MOVE TCNR      SCLNT
     C*
     C* Nominal currency
     C*
     C                     MOVE TNMC      SNOMC
     C*
     C* Settlement/Value currency
     C*
     C                     MOVE SETC      SVALC
     C*
     C* If Euroclear settlement, use fields Movement date, Full settle,
     C* Reversal, Nominal settled and Value settled from file
     C*
     C           *IN21     IFEQ '1'
     C*
     C                     Z-ADDSEDT      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     SMDAT
     C*
     C                     MOVE SEFU      SFULS
     C*
     C                     MOVE RVIN      SREVR
     C*
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE NMSE      ZFLD15
     C                     MOVE 'L'       ZECODE
     C                     MOVE TNMD      ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SNOMS
     C*                                                                   S01158
      ***  The following is incorrect as Nominal can potentially          E19400
      ***  be negative when dealing with oversettlement.                  E19400
     C***********          MOVE *BLANKS   ZFIELD                   S01158 E19400
     C***********          MOVE NMSE      ZFIELD                   S01158 E19400
     C***********          MOVE TNMD      ZADEC                    S01158 E19400
     C***********          EXSR ZEDIT                              S01158 E19400
     C***********          MOVE ZFIELD    SNOMS                    S01158 E19400
      *                                                                   E19400
     C                     MOVE *BLANKS   ZFLD15                          E19400
     C                     MOVE NMSE      ZFLD15                          E19400
     C                     MOVE 'L'       ZECODE                          E19400
     C                     MOVE TNMD      ZDECS                           E19400
     C                     EXSR ZSEDIT                                    E19400
     C                     MOVE ZOUT21    SNOMS                           E19400
     C*
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVELVSUN      WK15N  150
     C                     MOVE VSDE      WK15N
     C                     MOVE WK15N     ZFLD15
     C*
     C* Fetch settlement currency decimal places
     C*
     C***********          MOVE *BLANKS   KEY12A 12                       S01117
     C***********          MOVELSETC      WORK4   4                       S01117
     C***********          MOVE '1'       WORK4                           S01117
     C***********          MOVEL'20'      KEY12A                          S01117
     C***********          MOVE WORK4     KEY12A                          S01117
     C***********KEY12A    CHAINTABTG10F             33                   S01117
     C***********          MOVE CDP       ZDECS                           S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM SETC      @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZDECS                           S01117
     C                     MOVE 'L'       ZECODE
     C*
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SVALS
     C*
     C                     ELSE
     C*
     C* Else use inputs from initial screen and blanks
     C*
     C                     MOVE SMVDT     SMDAT
     C                     MOVE SFSET     SFULS
     C                     MOVE SREVE     SREVR
     C                     MOVE *BLANKS   SNOMS
     C                     MOVE *BLANKS   SVALS
     C                     END
     C*
     C**O/S*nominal****************************************************   E16187
     C* O/S nominal ( or if reversal then total nominal settled )         E16187
     C*
     C                     MOVE *BLANKS   ZFLD15
     C                     SETOF                         60               E16187
     C           SREVR     IFEQ 'Y'                                       E16187
     C                     SETON                         60               E16187
     C                     Z-ADDTNSN      WTNS   120                      E16187
     C                     ADD  TNSP      WTNS                            E16187
     C                     MOVE WTNS      ZFLD15                          E16187
     C                     ELSE                                           E16187
     C                     MOVE TOSN      ZFLD15
     C                     END                                            E16187
     C*                                                                   E16187
     C                     MOVE TNMD      ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SONOM
     C*
     C**O/S*Value******************************************************   E16187
     C* O/S Value ( or if reversal then total value settled )             E16187
     C*
     C                     MOVE *BLANKS   ZFLD15
     C           SREVR     IFEQ 'Y'                                       E16187
     C                     Z-ADDTVSN      WTVS   120                      E16187
     C                     ADD  TVSP      WTVS                            E16187
     C                     MOVE WTVS      ZFLD15                          E16187
     C                     ELSE                                           E16187
     C                     MOVE TOSV      ZFLD15
     C                     END                                            E16187
     C*
     C* Fetch settlement currency decimal places
     C*
     C***********          MOVE *BLANKS   KEY12A                          S01117
     C***********          MOVELSETC      WORK4                           S01117
     C***********          MOVE '1'       WORK4                           S01117
     C***********          MOVEL'20'      KEY12A                          S01117
     C***********          MOVE WORK4     KEY12A                          S01117
     C***********KEY12A    CHAINTABTG10F             33                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM SETC      @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZDECS                           S01117
     C                     MOVE 'L'       ZECODE
     C***********          MOVE CDP       ZDECS
     C*
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SOVAL
     C*                                                                   E15286
     C* If full settlement, allow nominal and value settled to default    E15286
     C*                                                                   E15286
     C           SFULS     IFEQ 'Y'                                       E15286
     C           *IN21     ANDEQ'0'                                       S01190
     C                     MOVE SONOM     SNOMS                           E15286
     C                     MOVE SOVAL     SVALS                           E15286
     C                     END                                            E15286
     C*
     C* Narrative
     C*
     C                     MOVE *BLANKS   SNARR
     C*
     C* Reference
     C*
     C                     MOVE *BLANKS   SSREF
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SETDET - Subroutine to set up Settlement details for output  *
      *           to file.                                            *
      *                                                               *
      *****************************************************************
      *
     C           SETDET    BEGSR                           *** SETDET ***
     C*
     C                     MOVE 'D'       RECI
     C*
     C* Trade reference
     C*
     C                     MOVE STRAD     STDR
     C*
     C* Settlement sequence
     C*
     C           STSSQ     ADD  1         SSQN
     C*
     C* Branch code
     C*
     C***********          MOVE TDBR      SBCD                            S01117
     C                     MOVE TDBA      SBCA                            S01117
     C*
     C* Date of movement
     C*
     C                     MOVE SMDAT     ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    SEDE
     C*
     C* Full settlement indicator
     C*
     C           SFSET     IFEQ *BLANKS
     C                     MOVE 'N'       SFSI
     C                     ELSE
     C                     MOVE SFSET     SFSI
     C                     END
     C*
     C* Reversal indicator
     C*
     C                     MOVE SREVE     SRIN
     C           SREVE     IFEQ *BLANKS                                   E38126
     C                     MOVE 'N'       SRIN                            E38126
     C                     END                                            E38126
     C*
     C* Nominal settled
     C*
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SNOMS     ZFIELD
     C                     MOVE TNMD      ZADEC
     C           11        SUB  TNMD      ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    SNMS
     C*
     C* Value settled
     C*
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SVALS     ZFIELD
     C*
     C* Fetch settlement currency decimal places
     C*
     C***********          MOVE *BLANKS   KEY12A                          S01117
     C***********          MOVELSETC      WORK4                           S01117
     C***********          MOVE '1'       WORK4                           S01117
     C***********          MOVEL'20'      KEY12A                          S01117
     C***********          MOVE WORK4     KEY12A                          S01117
     C***********KEY12A    CHAINTABTG10F             33                   S01117
     C***********          MOVE CDP       ZADEC                           S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM SETC      @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZADEC                           S01117
     C***********13        SUB  CDP       ZADIG                           E21218
     C***********15        SUB  CDP       ZADIG                     E21218S01117
     C           15        SUB  A6NBDP    ZADIG                           S01117
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    SVLS
     C*
     C* Settlement reference
     C*
     C                     MOVE SSREF     SSRF
     C*
     C* Narrative
     C*
     C                     MOVE SNARR     SNTV
     C*
     C                     MOVE *BLANKS   SRSL
     C*
     C* Value fully settled indicator
     C*
     C           TOSV      IFGT *ZEROS
     C                     MOVE 'P'       SFSL
     C                     ELSE
     C           TOSV      IFLT *ZEROS
     C                     MOVE 'O'       SFSL
     C                     ELSE
     C                     MOVE 'F'       SFSL
     C                     END
     C                     END
     C*
     C* Nominal fully settled indicator
     C*
     C           TOSN      IFGT *ZEROS
     C                     MOVE 'P'       SNFS
     C                     ELSE
     C           TOSN      IFLT *ZEROS
     C                     MOVE 'O'       SNFS
     C                     ELSE
     C                     MOVE 'F'       SNFS
     C                     END
     C                     END
     C*
     C* Over-settlement indicator
     C*
     C           TOSV      IFLT *ZEROS
     C                     MOVE 'Y'       SOSI
     C                     ELSE
     C                     MOVE ' '       SOSI
     C                     END
     C*
     C* Discrepancy amount
     C*
     C*  IF FULLY SETTLED, DISCREPANCY S/B ZERO, ELSE CALCULATE.          E20125
     C***********SFSET     IFEQ 'Y'                                       E20125
     C***********SFSET     IFNE 'Y'                                E20125 E21236
     C           SFSET     IFEQ 'Y'                                       E21236
     C*                                                                   E20125
     C**  Save settlement currency decimal places, and access file        S01117
     C**  SDCURRPD to fetch nominal currency decimal places               S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZCDPO                           S01117
     C*                                                                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM TNMC      @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZCDPI                           S01117
     C           TVSN      ADD  TVSP      WK13N  130
     C                     Z-ADDTCTR      ZAMTCI
     C                     Z-ADDTDER      ZEXCH
     C                     MOVE TMDI      ZMD
     C                     MOVE TNMC      ZCCYI
     C                     MOVE SETC      ZCCYO
     C                     EXSR ZCONV
      *                                                                   S01158
      ****ZAMTCO*IS*15,0*BUT*HAS*THE*DPS*INCLUDED.*GET*RID*OF*THE*DPS01158E13688
      ****BEFORE*CALCULATING*DISCREPANCY.*CDP*IS*OBTAINED*BY*ZCONV. S01158E13688
      ***********                                                   S01158E13688
     C***********1         DO   CDP                                 S01158E13688
     C***********          DIV  10        ZAMTCO    H               S01158E13688
     C***********          END                                      S01158E13688
     C           WK13N     SUB  ZAMTCO    SDAM
     C                     ELSE
     C                     Z-ADD0         SDAM
     C                     END
     C*
     C* Discrepancy indicator
     C*
     C           SDAM      IFNE *ZEROS
     C                     MOVE 'Y'       SDSI
     C                     ELSE
     C                     MOVE ' '       SDSI
     C                     END
     C*
     C* Security shortname, Client number, Market indicator, Trade type,
     C* Settlement currency and Book
     C*
     C                     MOVE TDSS      SSSN
     C                     MOVE TCNR      SCPN
     C                     MOVE TDMI      SMKI
     C                     MOVE TDTP      STET
     C                     MOVE SETC      SSCY
     C                     MOVE TDBK      SBOC
     C*
     C                     Z-ADDRUND      LCD
     C                     MOVE 'I'       CHTP
     C                     Z-ADDNATN      TNLU
     C*
     C                     ENDSR
      *
      *****************************************************************
      *EJECT*****                                                         082738
      *****************************************************************
      ***********                                                         082738
      *  UPDMEM - Subroutine to Update the MEMOS File.                *
      ***********                                                         082738
      *****************************************************************
      ***********                                                         082738
     C***********UPDMEM    BEGSR                           *** UPDMEM     082738
     C***********                                                         082738
     C**If*sale,*use*'Pay to'******************************************   E16843
     C***********                                                         E16843
     C***********TDTP      IFEQ 'TS'                                      E16843
     C***********          MOVELPAYT      KEY10                           E16843
     C***********                                                         E16843
     C**If*purchase,*use*'Pay*from'************************************   E16843
     C***********                                                         E16843
     C***********          ELSE                                           E16843
     C***********TDTP      IFEQ 'TP'                                      E16843
     C***********          MOVELPYFM      KEY10                           E16843
     C***********          END                                            E16843
     C***********          END                                            E16843
     C***********                                                         E16843
     C***********ACNKA     CHAINACNUMF               33                   E16843
     C***********                                                         E16843
     C***********                                                         E16843
     C**If*Account*type*is*'R',*update*related*PF/MEMOS*record*********   E16843
     C***********                                                         E16843
     C***********ATYP      IFEQ 'R'                                       E16843
     C***********                                                  E16843 082738
     C***********ACCKA     CHAINACCNTABF             33                   082738
     C************IN33     IFEQ '1'                                E16843 082738
     C***********RECI      ORNE 'D'                                E16843 082738
     C***********          SETON                       U7U8        E16843 082738
     C************LOCK     IN   LDA                        ********S01117 082738
     C***********          MOVE 'ACCNT'   DBFILE           * DB ER*E16843 082738
     C***********          MOVELDSACC     DBKEY            ********E16843 082738
     C***********          MOVE '11'      DBASE                     E16843S01117
     C***********          Z-ADD11        DBASE                    S01117 082738
     C***********          OUT  LDA                                S01117 082738
     C***********          EXSR *PSSR                              S01117 082738
     C***********          GOTO ENDMEM                             E16843 082738
     C***********          END                                     E16843 082738
     C***********ATYP      IFEQ 'R'                                E16843 082738
     C***********RRNM      CHAINMEMOSMDF             33                   082738
     C************IN33     IFEQ '1'                                E16843 082738
     C***********          SETON                       U7U8        E16843 082738
     C************LOCK     IN   LDA                        ********S01117 082738
     C***********          MOVE 'MEMOS'   DBFILE           * DB ER*E16843 082738
     C***********          MOVELRRNM      DBKEY            ********E16843 082738
     C***********          MOVE '12'      DBASE                     E16843S01117
     C***********          Z-ADD12        DBASE                    S01117 082738
     C***********          OUT  LDA                                S01117 082738
     C***********          EXSR *PSSR                              S01117 082738
     C***********          GOTO ENDMEM                             E16843 082738
     C***********          END                                     E16843 082738
     C***********                                                         082738
      ***  Ledger and Cleared Balances.
     C***********TDTP      IFEQ 'TP'                                      082738
      ***********                                                         082738
     C***********SREVE     IFNE 'Y'                                       051418
     C***********          SUB  VALSET    LDBLN                           051418
     C***********          SUB  VALSET    CLBLN                           051418
     C***********          ELSE                                           051418
     C***********          ADD  VALSET    LDBLN                           051418
     C***********          ADD  VALSET    CLBLN                           051418
     C***********          END                                            051418
     C***********REVERS    IFNE 'Y'                                051418 082738
     C***********          SUB  SETAMT    LDBLN                    051418 082738
     C***********          SUB  SETAMT    CLBLN                    051418 082738
     C***********          ELSE                                    051418 082738
     C***********          ADD  SETAMT    LDBLN                    051418 082738
     C***********          ADD  SETAMT    CLBLN                    051418 082738
     C***********          END                                     051418 082738
      ***********                                                         082738
     C***********          ELSE                                           082738
     C***********TDTP      IFEQ 'TS'                                      082738
      ***********                                                         082738
     C***********SREVE     IFEQ 'Y'                                       051418
     C***********          SUB  VALSET    LDBLN                           051418
     C***********          SUB  VALSET    CLBLN                           051418
     C***********          ELSE                                           051418
     C***********          ADD  VALSET    LDBLN                           051418
     C***********          ADD  VALSET    CLBLN                           051418
     C***********          END                                            051418
     C***********REVERS    IFEQ 'Y'                                051418 082738
     C***********          SUB  SETAMT    LDBLN                    051418 082738
     C***********          SUB  SETAMT    CLBLN                    051418 082738
     C***********          ELSE                                    051418 082738
     C***********          ADD  SETAMT    LDBLN                    051418 082738
     C***********          ADD  SETAMT    CLBLN                    051418 082738
     C***********          END                                     051418 082738
      ***********                                                         082738
     C***********          END                                            082738
     C***********          END                                            082738
     C***********                                                         082738
     C***********          UPDATMEMOSMDF                                  082738
     C***********                                                  S01154 051418
     C****Upon*Update of memos write a record to Account Mvmt File S01154 051418
     C***********                                                  S01154 051418
     C***********                                                  051418 082738
     C** Write account movement record                                    051418
     C***********                                                  051418 082738
     C***********          EXSR RTIME                              S01154 082738
     C***********                                                  S01154 082738
     C***********          END                                            082738
     C***********                                                         082738
     C***********          ENDSR                                          E16843
     C***********ENDMEM    ENDSR                                   E16843 082738
      ***********                                                         082738
      *****************************************************************
      *EJECT*****                                                  051418 082738
      *****************************************************************   051418
      ***********                                                  051418 082738
      ***UPDPRO*- Subroutine to Update PRONOPN.                    051418 082738
      ***********                                                  051418 082738
      *****************************************************************   051418
      ***********                                                  051418 082738
     C***********UPDPRO    BEGSR                           *** UPD 051418 082738
     C***********                                                  051418 082738
     C***Access*nostro details for Pay From A/C if Purchase        051418 082738
     C***********                  Pay To   A/C if Sale            051418 082738
     C***********                                                  051418 082738
     C***********TDTP      IFEQ 'TP'                               051418 082738
     C***********          MOVE SETC      PCCY                     051418 082738
     C***********          MOVELPYFM      PNOS                     051418 082738
     C***********          ELSE                                    051418 082738
     C***********          MOVE SETC      PCCY                     051418 082738
     C***********          MOVELPAYT      PNOS                     051418 082738
     C***********          END                                     051418 082738
     C***********                                                  051418 082738
     C***********PRONOK    KLIST                                   051418 082738
     C***********          KFLD           PCCY    3                051418 082738
     C***********          KFLD           PNOS    20               051418 082738
     C***********                                                  051418 082738
     C***********PRONOK    CHAINPRONOPNF             33            051418 082738
     C***********                                                  051418 082738
     C***Update*nostro balances                                    051418 082738
     C***********                                                  051418 082738
     C************IN33     IFEQ '0'                                051418 082738
     C***********RECI      ANDNE'*'                                051418 082738
     C***********          MOVEAPNBA      ANB                      051418 082738
     C***********                                                  051418 082738
     C**All*balances must be updated (settlement can't be forward  051418 082738
     C***********                                                  051418 082738
     C***********TDTP      IFEQ 'TP'                               051418 082738
     C***********REVERS    IFNE 'Y'                                051418 082738
     C***********          SUB  SETAMT    NNB                      051418 082738
     C***********          ELSE                                    051418 082738
     C***********          ADD  SETAMT    NNB                      051418 082738
     C***********          END                                     051418 082738
     C***********          ELSE                                    051418 082738
     C***********REVERS    IFEQ 'Y'                                051418 082738
     C***********          SUB  SETAMT    NNB                      051418 082738
     C***********          ELSE                                    051418 082738
     C***********          ADD  SETAMT    NNB                      051418 082738
     C***********          END                                     051418 082738
     C***********          END                                     051418 082738
     C***********                                                  051418 082738
     C***********          MOVEAANB       PNBA                     051418 082738
     C***********                                                  051418 082738
     C***********          UPDATPRONOPNF                           051418 082738
     C***********                                                  051418 082738
     C***Write*account movement record, if not done yet            051418 082738
     C***********                                                  051418 082738
     C***********          MOVE '*DBERR ' @RTCD                    051418 082738
     C***********          MOVELPCCY      P@CYCD                   051418 082738
     C***********          MOVELPNOS      P@NONB                   051418 082738
     C***********                                                  051418 082738
     C***Get*customer, account code and sequence from SDNOSTPD     051418 082738
     C***********                                                  051418 082738
     C***********          EXSR AONOST                             051418 082738
     C***********          MOVELA7BRCD    BRCA                     051418 082738
     C***********          MOVELA7CUST    CNUM                     051418 082738
     C***********          MOVELPCCY      CCY                      051418 082738
     C***********          MOVELA7ACCD    ACOD                     051418 082738
     C***********          MOVELA7ACSN    ACSQ                     051418 082738
     C***********          EXSR RTIME                              051418 082738
     C***********          END                                     051418 082738
     C***********          ENDSR                                   051418 082738
      *****************************************************************   051418
     C***********                                                  051418 082738
     C* AONOST - SUBROUTINE TO CALL ACCESS OBJECT : NOSTRO DETAILS        051418
     C***********                                                  051418 082738
     C***********AONOST    BEGSR                                   051418 082738
     C***********                                                  051418 082738
     C***********          CALL 'AONOSTR0'                         051418 082738
     C***********          PARM           @RTCD   7                051418 082738
     C***********          PARM '*KEY   ' @OPTN   7                051418 082738
     C***********          PARM *BLANKS   P@CUST  6          Custom051418 082738
     C***********          PARM           P@CYCD  3          Curren051418 082738
     C***********          PARM *BLANKS   P@ACCD  4          A/c Co051418 082738
     C***********          PARM *BLANKS   P@ACSN  2          A/c Se051418 082738
     C***********          PARM           P@NONB  2          Nostro051418 082738
     C***********          PARM *BLANKS   P@BRCD  3          Branch051418 082738
     C***********          PARM *BLANKS   P@CSSN 10          Cust S051418 082738
     C***********          PARM *BLANKS   P@PNOI  1          Prime 051418 082738
     C***********SDNOST    PARM SDNOST    DSFDY                    051418 082738
     C***********                                                  051418 082738
     C***********          ENDSR                                   051418 082738
     C********************************************************************051418
      *EJECT*****                                                  S01154 082738
      *****************************************************************   S01154
      ***********                                                  S01154 082738
      ***RTIME**- Subroutine to Write Account Movements Record.    S01154 082738
      ***********                                                  S01154 082738
      *****************************************************************   S01154
      ***********                                                  S01154 082738
     C***********RTIME     BEGSR                           *** RTIMS01154 082738
     C***********                                                  S01154 082738
     C**Write*Account Movement Record                              S01154 082738
     C***********                                                  S01154 082738
      *****Movement Amount, Cheque Number, Transaction Number,            082738
      *****Narrative Description.                                         082738
      ***********                                                         082738
     C*********************MOVE VALSET    MVAM                     S01154 051418
     C***********          Z-ADDSETAMT    MVAM                     051418 082738
     C***********          MOVE *BLANKS   NRTD                     S01154 082738
     C***********          Z-ADD*ZEROS    CQNR                     S01154 082738
     C***********          MOVE TDRF      TNMR                     S01154 082738
     C***********          MOVELTDSS      NRTD                     S01154 082738
     C***********                                                  S01154 082738
      *****Debit*or Credit (1 or 0)                                       082738
     C***********SREVE     IFNE 'Y'                                S01154 051418
     C***********REVERS    IFNE 'Y'                                051418 082738
     C***********TDTP      ANDEQ'TP'                               S01154 082738
     C***********SREVE     OREQ 'Y'                                S01154 051418
     C***********REVERS    OREQ 'Y'                                051418 082738
     C***********TDTP      ANDEQ'TS'                               S01154 082738
     C***********          Z-ADD1         DORC                     S01154 082738
     C***********          ELSE                                    S01154 082738
     C***********          Z-ADD0         DORC                     S01154 082738
     C***********          END                                     S01154 082738
     C***********                                                  S01154 082738
      *****Narrative Code, Transaction Date, Value Date, Posting Date     082738
      *****Customer Number, Account Code, Account Sequence, Curren        082738
      ***********                                                         082738
     C************         Z-ADD*ZEROS    NRTC                     S01154 080050
     C*********************MOVE *BLANK    NRTC              S01154 080050 082738
     C***********          MOVE TDTP      TRYP                     S01154 082738
     C***********          Z-ADDTDVD      VUDT                     S01154 082738
     C***********          Z-ADDRUND      PTDT                     S01154 082738
     C***********          Z-ADDCNUM      CUSN                     S01154 082738
     C***********          Z-ADDACOD      ACDE                     S01154 082738
     C***********          Z-ADDACSQ      ASNC                     S01154 082738
     C***********          MOVE SETC      CCYD                     S01154 082738
     C***********                                                  S01154 082738
     C***********          WRITERSACMTPO                           S01154 082738
     C***********                                                  S01154 082738
     C***********          ENDSR                                   S01154 082738
      ***********                                                  S01154 082738
      *****************************************************************   S01154
      /EJECT
      *****************************************************************
      *                                                               *
      *  UPDNON - Subroutine to Update the Database for Non-Euroclear *
      *           Settlements.                                        *
      *                                                               *
      *****************************************************************
      *
     C           UPDNON    BEGSR                           *** UPDNON ***
     C*
     C* Fetch next available transaction number
     C*
     C                     EXSR ZTNLU1
     C*
     C* Fetch Trade details
     C*
     C           STRDR     IFEQ *BLANKS
     C                     MOVE TRDF      WORK6A
     C                     MOVEAWORK6A    REF
     C                     SETOF                     33
     C                     Z-ADD*ZERO     X
     C           *IN33     DOUEQ'1'
     C                     ADD  1         X
     C           REF,X     IFNE '0'
     C           REF,X     ANDNE' '
     C                     SETON                     33
     C                     ELSE
     C                     MOVEA' '       REF,X
     C                     END
     C                     END
     C*
     C                     MOVEAREF       WORK6A
     C*
     C                     ELSE
     C                     MOVE STRDR     WORK6A
     C                     END
     C*
     C           WORK6A    CHAINTRADSDF              31
     C*****************    MOVE RECI      XRECI   1                S01176 E20719
     C                     MOVE RECITR    XRECI   1                       E21112
     C           TNLU      IFNE STNLU
     C                     SETON                     70
     C                     MOVEAINF,1     ERRMSG
     C                     Z-ADD01021     STATUS
     C                     EXSR INFSR
     C                     GOTO ENDUPD
     C*
     C                     ELSE
     C*
     C* Increase settlement sequence number
     C*
     C                     Z-ADDTSSQ      STSSQ
     C                     ADD  1         TSSQ
     C*
     C* Date fully settled - write if blank and now fully settled
     C*
     C           TDFS      IFEQ *ZEROS
     C           SFSET     IFEQ 'Y'
     C                     Z-ADDRUND      TDFS
     C***********          MOVE 'S'       XRECI                    E20719 E21112
     C                     END
     C                     END
     C*
     C* OR make blank if reversal indicated
     C*
     C           SREVE     IFEQ 'Y'
     C                     Z-ADD*ZEROS    TDFS
     C*                                                                   E16182
     C* If reversing fully-settled trade, make RECI 'D'                   E16182
     C*                                                                   E16182
     C***********RECI      IFEQ 'S'                                E16182 E20719
     C           RECITR    IFEQ 'S'                                       E20719
     C                     MOVE 'D'       XRECI                           E16182
     C                     END                                            E16182
     C*                                                                   E16182
     C                     END
     C*
     C* Outstanding nominal
     C*
     C* Convert nominal entered to number
     C*
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SNOMS     ZFIELD
     C                     MOVE TNMD      ZADEC
     C           11        SUB  TNMD      ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    NOMSET 110
     C*
     C* If reversal, add - else subtract
     C*
     C           SREVE     IFEQ 'Y'
     C                     ADD  NOMSET    TOSN
     C                     ELSE
     C                     SUB  NOMSET    TOSN
     C                     END
     C*
     C* Outstanding value
     C*
     C* Convert nominal entered to number
     C*
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SVALS     ZFIELD
     C*
     C* Fetch settlement currency decimal places
     C*
     C***********          MOVE *BLANKS   KEY12A                          S01117
     C***********          MOVELSETC      WORK4                           S01117
     C***********          MOVE '1'       WORK4                           S01117
     C***********          MOVEL'20'      KEY12A                          S01117
     C***********          MOVE WORK4     KEY12A                          S01117
     C***********KEY12A    CHAINTABTG10F             33                   S01117
     C***********          MOVE CDP       ZADEC                           S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM SETC      @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZADEC                           S01117
     C***********15        SUB  CDP       ZADIG                           S01117
     C           15        SUB  A6NBDP    ZADIG                           S01117
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    VALSET 150
     C***********                                                  051418 082738
     C***Determine if any manual settlement has been done to date  051418 082738
     C***If*not,*reverse shadow posting done already for trade (TO 051418 082738
     C***********                                                  051418 082738
     C***********          MOVEL'N'       REVERS                   051418 082738
     C***********TDRF      CHAINSETLEDFX             99            051418 082738
     C************IN99     IFEQ '1'                                051418 082738
     C***********TOSV      ANDNE*ZERO                              051418 082738
     C***********          MOVEL'Y'       REVERS  1                051418 082738
     C***********          Z-ADDTOSV      SETAMT 150               051418 082738
     C***********          END                                     051418 082738
     C*
     C* If reversal, add - else subtract
     C*
     C           SREVE     IFEQ 'Y'
     C                     ADD  VALSET    TOSV
     C                     ELSE
     C                     SUB  VALSET    TOSV
     C                     END
     C*
     C* Nominal settled not posted - subtract if reversal, else add
     C*
     C           SREVE     IFEQ 'Y'
     C                     SUB  NOMSET    TNSN
     C                     ELSE
     C                     ADD  NOMSET    TNSN
     C                     END
     C*
     C* Value settled not posted - subtract if reversal, else add
     C*
     C           SREVE     IFEQ 'Y'
     C                     SUB  VALSET    TVSN
     C                     ELSE
     C                     ADD  VALSET    TVSN
     C                     END
     C*
     C* Discrepancy not posted
     C*
     C* For full settlement:
     C*
     C           SFSET     IFEQ 'Y'
     C           TVSN      ADD  TVSP      WK15N  150
     C*                                                                   S01117
     C**  Save settlement currency decimal places, and access file        S01117
     C**  SDCURRPD to fetch nominal currency decimal places               S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZCDPO                           S01117
     C*                                                                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM TNMC      @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZCDPI                           S01117
     C                     Z-ADDTCTR      ZAMTCI
     C                     Z-ADDTDER      ZEXCH
     C                     MOVE TMDI      ZMD
     C                     MOVE TNMC      ZCCYI
     C                     MOVE SETC      ZCCYO
     C                     EXSR ZCONV
     C           WK15N     SUB  ZAMTCO    TDSN
     C                     END
     C*
     C* For reversal:
     C*
     C           SREVE     IFEQ 'Y'
     C                     Z-SUBTDSP      TDSN
     C                     END
     C*
     C*
     C**N31******          MOVE XRECI     RECI                     S01176 E20719
     C  N31                MOVE XRECI     RECITR                          E20719
     C  N31                UPDATTRADSDF
     C*
     C*
     C                     END
     C*
     C* Write Settlement details
     C*
     C                     EXSR SETDET
     C                     WRITESETLEDF
     C/COPY WNCPYSRC,SE0060C003
     C*
     C* Fetch Settlement Audit record
     C*
     C           1         CHAINSETLEAF              U8
     C*
     C* Update if found
     C*
     C           *INU8     IFEQ '0'
     C*
     C                     ADD  1         SINS
     C                     ADD  1         NORE
     C*
     C                     Z-ADDRUND      LCD
     C                     MOVE 'A'       CHTP
     C                     MOVELNATN      TNLU
     C*
     C                     UPDATSETLEAF
     C*
     C                     ELSE
     C                     SETON                     U7
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVEL'05'      DBASE            ***************S01117
     C                     Z-ADD5         DBASE            * DB ERROR 05 *S01117
     C                     MOVEL'SETLEA'  DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     END
     C*
     C* If trade is with a portfolio customer and settlement is for       S01158
     C* nominal(or reversal), update Client positions                     S01158
     C*                                                                   S01158
     C***********TCNR      CHAINCLINTSEF             33                   S01117
     C                     MOVELTCNR      CUST6A  6                       S01117
     C                     CALL 'AOSECSR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM CUST6A    CUST    6                       S01117
     C           SDSECS    PARM SDSECS    DSSDY                           S01117
     C*                                                                   S01117
     C*
     C************IN33     IFEQ '0'                                 S01158S01117
     C***********C1DI      IFEQ 'S'                                 S01158S01117
     C***********C1DI      OREQ 'D'                                 S01158S01117
     C           BFCLAS    IFEQ 'S'                                       S01117
     C           BFCLAS    OREQ 'D'                                       S01117
     C           SNOMS     IFNE *BLANKS                                   S01158
     C           SREVE     OREQ 'Y'                                       S01158
     C                     EXSR CLTPOS                                    S01158
     C                     END                                            S01158
     C                     END                                            S01158
     C***********          END                                      S01158S01117
     C*                                                                   S01158
     C* If settlement is for nominal (or reversal), update User positions S01158
     C*                                                                   S01158
     C           SNOMS     IFNE *BLANKS                                   S01158
     C           SREVE     OREQ 'Y'                                       S01158
     C                     EXSR USRPOS                                    S01158
     C                     END                                            S01158
     C***********                                                  051418 082738
     C***If*no*manual settlement has been done to date,            051418 082738
     C***reverse*shadow posting done already for trade (TOSV)      051418 082738
     C***********                                                  051418 082738
     C***********REVERS    IFEQ 'Y'                                051418 082738
     C***********          EXSR SHADOW                             051418 082738
     C***********          END                                     051418 082738
     C***********                                                  051418 082738
     C***Do*shadow posting for manual settlement                   051418 082738
     C***(if*settlement value is not equal to zero)                051418 082738
     C***********                                                  051418 082738
     C***********          MOVELSREVE     REVERS                   051418 082738
     C***********          Z-ADDVALSET    SETAMT                   051418 082738
     C***********SETAMT    IFNE *ZERO                              051418 082738
     C***********          EXSR SHADOW                             051418 082738
     C***********          END                                     051418 082738
     C***********                                                  S01158 051418
     C**If*Retail module present and settlement is for value (or reversal)051418
     C***update*MEMOS                                                     051418
     C***********                                                         051418
     C************INU1     IFEQ '1'                                       051418
     C***********                                                  E30659 051418
     C***Only*update if settlement value is not equal to zero      E30659 051418
     C***********                                                  E30659 051418
     C***********SVALS     IFNE *BLANKS                                   E30659
     C***********VALSET    IFNE *ZERO                              E30659 051418
     C***********SREVE     OREQ 'Y'                                       051418
     C***********                                                  E16843 051418
     C***********SMTH      IFEQ 04                                 E16843 051418
     C***********SMTH      OREQ 05                                 E16843 051418
     C***********SMTH      OREQ 14                                 E16843 051418
     C***********SMTH      OREQ 15                                 E16843 051418
     C***********          EXSR UPDMEM                                    051418
     C***********          END                                     E16843 051418
     C***********          END                                            051418
     C***********          END                                            051418
     C*
     C                     COMIT
     C*
     C           ENDUPD    ENDSR
      *
      *****************************************************************
      *EJECT*****                                                  051418 082738
      *****************************************************************   051418
      ***********                                                  051418 082738
      ***SHADOW*- Shadow posting                                   051418 082738
      ***********                                                  051418 082738
      *****************************************************************   051418
      ***********                                                  051418 082738
     C***********SHADOW    BEGSR                           *** SHAD051418 082738
     C***********                                                  051418 082738
     C**If*Retail module present update MEMOS                      051418 082738
     C***********                                                  051418 082738
     C************INU1     IFEQ '1'                                051418 082738
     C***********SMTH      IFEQ 04                                 051418 082738
     C***********SMTH      OREQ 05                                 051418 082738
     C***********SMTH      OREQ 14                                 051418 082738
     C***********SMTH      OREQ 15                                 051418 082738
     C***********          EXSR UPDMEM                             051418 082738
     C***********          END                                     051418 082738
     C***********          END                                     051418 082738
     C***********                                                  051418 082738
     C**If*settlement across a nostro, update projected nostro bal 051418 082738
     C***********                                                  051418 082738
     C***********SMTH      IFEQ 01                                 051418 082738
     C***********SMTH      OREQ 02                                 051418 082738
     C***********SMTH      OREQ 07                                 051418 082738
     C***********SMTH      OREQ 08                                 051418 082738
     C***********SMTH      OREQ 12                                 051418 082738
     C***********          EXSR UPDPRO                             051418 082738
     C***********          END                                     051418 082738
     C***********          ENDSR                                   051418 082738
      *****************************************************************   051418
      /EJECT                                                              S01158
      *****************************************************************   S01158
      *                                                               *   S01158
      *  USRPOS - Subroutine to Update User Depot Position.           *   S01158
      *                                                               *   S01158
      *****************************************************************   S01158
      *                                                                   S01158
     C           USRPOS    BEGSR                           *** USRPOS *** S01158
     C*                                                                   S01158
     C* Update User Depot position                                        S01158
     C*                                                                   S01158
     C           TDTP      IFEQ 'TP'                                      S01158
     C***********          Z-ADDDELF      DEPOT                     S01158E14509
     C**********           Z-ADDDELT      DEPOT                                        E14509 CSD027
     C                     MOVE DELT      DEPOT                                               CSD027
     C                     ELSE                                           S01158
     C           TDTP      IFEQ 'TS'                                      S01158
     C***********          Z-ADDDELT      DEPOT                     S01158E14509
     C**********           Z-ADDDELF      DEPOT                                        E14509 CSD027
     C                     MOVE DELF      DEPOT                                               CSD027
     C                     END                                            S01158
     C                     END                                            S01158
      *                                                                   S01158
     C           UDEPKA    CHAINUDEPPDF              33                   S01158
      *                                                                   S01158
      ***  Record Id, Branch, Security, Book, Market.                     S01158
     C                     MOVE 'D'       RECI                            S01158
     C***********          Z-ADDTDBR      UDBR                      S01158S01117
     C                     MOVE TDBA      UDBA                            S01117
     C                     MOVE TDSS      UDSN                            S01158
     C                     MOVE TDBK      UDBK                            S01158
     C                     MOVE TDMI      UDMK                            S01158
      *                                                                   S01158
      ***  Depot                                                          S01158
     C           TDTP      IFEQ 'TP'                                      S01158
     C**********           Z-ADDDELT      UDPT                                         S01158 CSD027
     C                     MOVE DELT      UDPT                                                CSD027
     C                     ELSE                                           S01158
     C           TDTP      IFEQ 'TS'                                      S01158
     C**********           Z-ADDDELF      UDPT                                         S01158 CSD027
     C                     MOVE DELF      UDPT                                                CSD027
     C                     END                                            S01158
     C                     END                                            S01158
      *                                                                   S01158
      ***  Nominal (COB) Trade, Value and Settled Bases.                  S01158
     C   33                Z-ADD*ZEROS    UDNT                            S01158
     C   33                Z-ADD*ZEROS    UDNV                            S01158
     C   33                Z-ADD*ZEROS    UDNS                            S01158
      *                                                                   S01158
      ***  Nominal Settled (I/C).                                         S01158
     C           SREVE     IFNE 'Y'                                       S01158
     C           TDTP      IFEQ 'TP'                                      S01158
     C                     ADD  NOMSET    UNSI                            S01158
     C                     ELSE                                           S01158
     C                     SUB  NOMSET    UNSI                            S01158
     C                     END                                            S01158
     C*                                                                   S01158
     C                     ELSE                                           S01158
     C           TDTP      IFEQ 'TP'                                      S01158
     C                     SUB  NOMSET    UNSI                            S01158
     C                     ELSE                                           S01158
     C                     ADD  NOMSET    UNSI                            S01158
     C                     END                                            S01158
     C                     END                                            S01158
      *                                                                   S01158
      ***  Sum Nominals.                                                  S01158
     C           *IN33     IFEQ '1'                                       S01158
     C                     Z-ADD*ZEROS    UDTP                            S01158
     C                     Z-ADD*ZEROS    UDTS                            S01158
     C                     Z-ADD*ZEROS    UDPV                            S01158
     C                     Z-ADD*ZEROS    UDSV                            S01158
     C                     Z-ADD*ZEROS    UNRT                            S01158
     C                     Z-ADD*ZEROS    UNRV                            S01158
     C                     Z-ADD*ZEROS    USNT                            S01158
     C                     Z-ADD*ZEROS    USNR                            S01158
     C                     Z-ADD*ZEROS    USNV                            S01158
     C                     Z-ADD*ZEROS    USRV                            S01158
     C                     END                                            S01158
      *                                                                   S01158
     C                     Z-ADDNATN      TNLU                            S01158
     C           *IN33     IFEQ '0'                                       S01158
     C  N33                UPDATUDEPPDF                                   S01158
     C                     ELSE                                           S01158
     C   33                WRITEUDEPPDF                                   S01158
     C*                                                                   S01158
     C           1         CHAINUDEPPAF              33                   S01158
     C           *IN33     IFEQ '1'                                       S01158
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '06'      DBASE                     S01158S01117
     C                     Z-ADD6         DBASE            ***************S01117
     C                     MOVEL'UDEPP'   DBFILE           * DB ERROR 06 *S01158
     C                     MOVEL'AUDIT'   DBKEY            ***************S01158
     C                     OUT  LDA                                       S01117
     C                     SETON                     U7U801               S01158
     C                     EXSR *PSSR                                     S01117
     C                     ELSE                                           S01158
     C                     ADD  1         NORE                            S01158
     C                     MOVELNATN      TNLU                            S01158
     C                     UPDATUDEPPAF                                   S01158
     C                     END                                            S01158
     C                     END                                            S01158
     C*                                                                   S01158
     C                     ENDSR                                          S01158
      *                                                                   S01158
      *****************************************************************   S01158
      /EJECT
      *****************************************************************
      *                                                               *
      *  VLDDET - Subroutine to Validate Detail Screen entries.       *
      *                                                               *
      *****************************************************************
      *
     C           VLDDET    BEGSR                           *** VLDDET ***
     C*
     C* Setof error indicators
     C*
     C                     SETOF                         25               E18199
     C                     MOVEA'000'     *IN,75
     C                     Z-ADD*ZEROS    EC
     C                     Z-ADD*ZEROS    WEC
     C                     MOVE *BLANKS   ERRMSG
     C*
     C* Nominal settled
     C*
     C           SNOMS     IFNE *BLANKS
     C*
     C* Check valid number
     C*
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SNOMS     ZFIELD
     C           13        SUB  TNMD      ZADIG
     C                     MOVE TNMD      ZADEC
     C                     EXSR ZALIGN
     C           *IN99     IFEQ '1'
     C                     ADD  1         EC
     C                     MOVEA' 100'    ERR,EC
     C                     SETON                     75
     C                     ELSE
     C*
     C**If*ok,*must*be*multiple*of*stock*denomination*(if present)****    S01176
     C* If ok, must be multiple of trade denomination (if present)        S01176
     C*
     C                     MOVE ZFIELD    WK13N  130
     C                     Z-ADD1         FACTOR 100
     C                     DO   TNMD
     C           FACTOR    MULT 10        FACTOR
     C                     END
     C           WK13N     DIV  FACTOR    WK158N 158
     C           SDNM      IFNE *ZEROS
     C           WK158N    DIV  SDNM      WK13N2 130
     C                     MVR            WK01N   21
     C           WK01N     IFNE *ZEROS
     C                     ADD  1         EC
     C/COPY WNCPYSRC,SE0060C001
     C           CSE007    IFEQ 'N'                                       CSE007
     C           CEU017    ANDEQ'N'                                       CEU017
     C                     MOVEA' 101'    ERR,EC
     C/COPY WNCPYSRC,SE0060C002
     C                     ELSE                                           CSE007
     C                     ADD  1         WEC                             CSE007
     C                     MOVEA' W18'    ERR,EC                          CSE007
     C                     ENDIF                                          CSE007
     C                     SETON                     75
     C                     END
     C                     END
     C*
     C* Must be LE to O/S nominal
     C*
     C           SREVE     IFNE 'Y'                                       E14538
     C           SFSET     IFNE 'Y'                                       E20036
     C           WK13N     IFGT TOSN
     C                     ADD  1         EC
     C                     ADD  1         WEC
     C                     MOVEA' W01'    ERR,EC
     C                     SETON                     75
     C                     END
     C                     END                                            E20036
     C                     END                                            E14538
     C*
     C* If Reversal specified, must be LE than Nominal settled
     C*
     C           SREVE     IFEQ 'Y'
     C           TNSN      ADD  TNSP      WK13N2
     C           WK13N     IFGT WK13N2
     C                     ADD  1         EC
     C                     MOVEA' 103'    ERR,EC
     C                     SETON                     75
     C                     END
     C                     END
     C*
     C* If full settlement specified, os nom - nom set must = 0
     C*
     C           SFSET     IFEQ 'Y'
     C           TOSN      SUB  WK13N     WK13N2
     C           WK13N2    IFNE 0
     C                     ADD  1         EC
     C                     MOVEA' 109'    ERR,EC
     C                     SETON                     75
     C                     END
     C                     END
     C*
     C                     END
     C                     END
     C*                                                                   036931
     C*  Cannot be blank for full settlement                              036931
     C           SNOMS     IFEQ *BLANKS                                   036931
     C           SFSET     ANDEQ'Y'                                       036931
     C                     ADD  1         EC                              036931
     C                     MOVEA' 102'    ERR,EC                          036931
     C                     SETON                     75                   036931
     C                     END                                            036931
     C*
     C* Value settled
     C*
     C           SVALS     IFNE *BLANKS
     C*
     C* Check valid amount in settlement currency
     C*
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SVALS     ZFIELD
     C*                                                                   S01117
     C**  Fetch base currency decimal places for ZCONV                    S01117
     C*                                                                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM BJCYCD    @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZCDPI                           S01117
     C*
     C* Fetch settlement currency decimal places
     C*
     C***********          MOVE *BLANKS   KEY12A                          S01117
     C***********          MOVELSETC      WORK4                           S01117
     C***********          MOVE '1'       WORK4                           S01117
     C***********          MOVEL'20'      KEY12A                          S01117
     C***********          MOVE WORK4     KEY12A                          S01117
     C***********KEY12A    CHAINTABTG10F             33                   S01117
     C***********          MOVE CDP       ZADEC                           S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*DBERR'  @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM SETC      @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C                     Z-ADDA6NBDP    ZADEC                           S01117
     C***********15        SUB  CDP       ZADIG                           S01117
     C           15        SUB  A6NBDP    ZADIG                           S01117
     C                     EXSR ZALIGN
     C           *IN99     IFEQ '1'
     C                     ADD  1         EC
     C                     MOVEA' 104'    ERR,EC
     C                     SETON                     76
     C                     ELSE
     C*
     C* If full settlement, check value does not exceed discrepancy
     C* limits
     C*
     C                     MOVE ZFIELD    WK150N 150
     C           SFSET     IFEQ 'Y'
     C           *IN25     ANDEQ'0'
     C*
     C* Convert discrepancy under value to settlement currency
     C*
     C***********          Z-ADDSMDU      ZAMTCI                          S01117
     C***********          Z-ADDSPOT      ZEXCH                           S01117
     C***********          MOVE MDIN      ZMD                             S01117
     C***********          MOVE BCCY      ZCCYI                           S01117
     C                     Z-ADDBVSDUN    ZAMTCI                          S01117
     C                     Z-ADDA6SPRT    ZEXCH                           S01117
     C***********          MOVE A6MDIN    ZMD                       S01117122711
     C           A6MDIN    IFEQ 'M'                                       122711
     C                     MOVE 'D'       ZMD                             122711
     C                     ELSE                                           122711
     C                     MOVE 'M'       ZMD                             122711
     C                     END                                            122711
     C                     MOVE BJCYCD    ZCCYI                           S01117
     C                     Z-ADDA6NBDP    ZCDPO                           S01117
     C*                                                                   S01117
     C                     MOVE SETC      ZCCYO
     C                     EXSR ZCONV
     C           *IN99     IFEQ '1'
     C                     ADD  1         EC
     C                     ADD  1         WEC
     C                     MOVEA' W02'    ERR,EC
     C                     SETON                     7625
     C                     ELSE
     C                     MOVE ZAMTCO    DUNDER 150
     C*
     C* Convert discrepancy over
     C*
     C***********          Z-ADDSMDO      ZAMTCI                          S01117
     C***********          Z-ADDSPOT      ZEXCH                           S01117
     C***********          MOVE MDIN      ZMD                             S01117
     C***********          MOVE BCCY      ZCCYI                           S01117
     C***********          MOVE SETC      ZCCYO                           S01117
     C                     Z-ADDBVSDOV    ZAMTCI                          S01117
     C                     EXSR ZCONV
     C           *IN99     IFEQ '1'
     C                     ADD  1         EC
     C                     ADD  1         WEC
     C                     MOVEA' W02'    ERR,EC
     C                     SETON                     7625
     C                     ELSE
     C                     MOVE ZAMTCO    DOVER  150
     C*
     C* Fetch working amount
     C*
     C           TOSV      SUB  WK150N    WK15N
     C*
     C* Check against discrepancy amounts  - UNDER
     C*
     C           WK15N     IFGT DUNDER
     C                     ADD  1         EC
     C                     MOVEA' 108'    ERR,EC
     C                     SETON                     7625
     C                     ELSE
     C*
     C           WK150N    SUB  TOSV      WK15N
     C*
     C* Check against discrepancy amounts  - OVER
     C*
     C           WK15N     IFGT DOVER
     C                     ADD  1         EC
     C                     MOVEA' 108'    ERR,EC
     C                     SETON                     7625
     C                     END
     C                     END
     C*
     C                     END
     C                     END
     C                     END
     C*
     C**If*Reversal,*must*be*equal*to*sum*of*value*settled*and*****       E16182
     C**Discrepancy************************************************       E16182
     C* If Reversal, must be equal to sum of value settled.               E16182
     C*
     C           SREVE     IFEQ 'Y'
     C           TVSN      ADD  TVSP      WK13N2
     C***********          ADD  TDSN      WK13N2                          E16182
     C***********          ADD  TDSP      WK13N2                          E16182
     C                     MOVE ZFIELD    WK13V  130
     C           WK13V     IFGT WK13N2
     C                     ADD  1         EC
     C                     MOVEA' 105'    ERR,EC
     C                     SETON                     76
     C                     END
     C                     END
     C*
     C                     END
     C                     END
     C*
     C* Nominal settled and Value settled cannot both be blank
     C*
     C           SNOMS     IFEQ *BLANKS
     C           SVALS     ANDEQ*BLANKS
     C                     ADD  1         EC
     C                     MOVEA' 106'    ERR,EC
     C                     SETON                     7576
     C                     END
     C*
     C* Settlement reference
     C*
     C           SSREF     IFNE *BLANKS
     C*
     C* Must be a six-digit number
     C*
     C                     MOVEASSREF     REF
     C                     Z-ADD1         X       10
     C           X         DOUEQ6
     C           REF,X     IFLT '0'
     C           REF,X     ORGT '9'
     C                     ADD  1         EC
     C                     MOVEA' 107'    ERR,EC
     C                     SETON                     77
     C                     Z-ADD6         X
     C                     ELSE
     C                     ADD  1         X
     C                     END
     C*
     C                     END
     C                     END
     C*
     C*  If Nominal Settled = O/S Nominal and the Value Settled =         E31061
     C*     O/S Value, the Fully Settled flag should be input as 'Y'.     E31061
     C*                                                                   E31061
     C                     Z-ADD0         WKNOM  110                      E31061
     C                     Z-ADD0         WKVAL  130                      E31061
     C*                                                                   E31061
     C*  Reformat input fields                                            E31061
     C*                                                                   E31061
     C                     MOVE *BLANKS   ZFIELD                          E31061
     C                     MOVE SNOMS     ZFIELD                          E31061
     C                     MOVE TNMD      ZADEC                           E31061
     C           11        SUB  TNMD      ZADIG                           E31061
     C                     EXSR ZALIGN                                    E31061
     C                     MOVE ZFIELD    WKNOM                           E31061
     C*                                                                   E31061
     C                     MOVE *BLANKS   ZFIELD                          E31061
     C                     MOVE SVALS     ZFIELD                          E31061
     C*                                                                   E31061
     C*  Fetch settlement ccy decimal places                              E31061
     C*                                                                   E31061
     C                     CALL 'AOCURRR0'                                E31061
     C                     PARM '*DBERR'  @RTCD                           E31061
     C                     PARM '*KEY   ' @OPTN                           E31061
     C                     PARM SETC      @AJCD   3                       E31061
     C           SDCURR    PARM SDCURR    DSSDY                           E31061
     C*                                                                   E31061
     C                     Z-ADDA6NBDP    ZADEC                           E31061
     C           15        SUB  A6NBDP    ZADIG                           E31061
     C                     EXSR ZALIGN                                    E31061
     C                     MOVE ZFIELD    WKVAL                           E31061
     C*                                                                   E31061
     C*  Compare 'Outstanding' and 'Settled' values                       E31061
     C*                                                                   E31061
     C           WKNOM     IFEQ TOSN                                      E31061
     C           WKVAL     ANDEQTOSV                                      E31061
     C           SFSET     ANDNE'Y'                                       E31061
     C                     ADD  1         EC                              E31061
     C                     MOVEA' 110'    ERR,EC                          E31061
     C                     SETON                     7576                 E31061
     C                     END                                            E31061
     C*                                                                   E31061
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  VLDITL - Subroutine to Validate Initiial Screen entries.     *
      *                                                               *
      *****************************************************************
      *
     C           VLDITL    BEGSR                           *** VLDITL ***
     C*
     C* Setof error indicators
     C*
     C                     MOVEA'0000'    *IN,71
     C                     Z-ADD*ZEROS    EC      20
     C                     Z-ADD*ZEROS    WEC
     C                     MOVE *BLANKS   ERRMSG
     C                     MOVE '0'       E200    1
     C*
     C* Trade reference - Mandatory entry
     C*
     C           STRDR     IFEQ *BLANKS
     C                     ADD  1         EC
     C                     MOVEA' 200'    ERR,EC
     C                     SETON                     71
     C                     MOVE '1'       E200
     C                     ELSE
     C*
     C* Must reference an active, complete trade
     C*    - or a reversal of a fully-settled trade                       E16182
     C*
     C           STRDR     CHAINTRADSDFX             33
     C           *IN33     IFEQ '1'
     C                     ADD  1         EC
     C                     MOVEA' 200'    ERR,EC
     C                     MOVE '1'       E200
     C                     SETON                     71
     C                     ELSE
      *                                                                   S01117
      ** If multibranching environment                                    S01117
      *                                                                   S01117
     C           MBIN      IFEQ 'Y'                                       S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM 'I'       @ZACTN  1                       S01117
     C                     PARM TDBA      @ZBR    3                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE *ZEROS                                    S01117
     C                     ADD  1         EC                              S01117
     C                     MOVEA' 304'    ERR,EC                          S01117
     C                     MOVE '1'       E200                            S01117
     C                     SETON                     71                   S01117
     C                     END                                            S01117
      *                                                                   S01117
      *                                                                   S01117
     C                     ELSE                                           S01117
      *                                                                   S01117
      ** If single branch environment                                     S01117
      *                                                                   S01117
     C           MBIN      IFNE 'Y'                                       S01117
     C                     CALL 'ZVACTU'                                  S01117
     C                     PARM 'I'       @ZACTN  1                       S01117
     C                     PARM           @ERR    10                      S01117
      *                                                                   S01117
     C           @ERR      IFNE *ZERO                                     S01117
     C                     ADD  1         EC                              S01117
     C                     MOVEA' 302'    ERR,EC                          S01117
     C                     MOVE '1'       E200                            S01117
     C                     SETON                     71                   S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     END                                            S01117
      *                                                                   S01117
     C           @ERR      IFEQ *ZERO                                     S01117
      *
      ** Check record is active
      *
     C***********RECI      IFNE 'D'                                       E16182
     C***********RECI      ANDNE'A'                                       E16182
     C           RECI      IFEQ '*'                                       E16182
     C           RECI      OREQ 'C'                                       E16182
     C           RECI      OREQ 'S'                                       E16182
     C           SREVE     ANDNE'Y'                                       E16182
     C                     ADD  1         EC
     C                     MOVEA' 200'    ERR,EC
     C                     SETON                     71
     C                     MOVE '1'       E200
     C                     ELSE
     C*                                                                   050907
     C** Must not reference a trade created by a book transfer.           050907
     C*                                                                   050907
     C                     MOVELTCNR      CUST6A  6                       050907
     C                     CALL 'AOSECSR0'                                050907
     C                     PARM '*DBERR'  @RTCD                           050907
     C                     PARM '*KEY   ' @OPTN                           050907
     C                     PARM CUST6A    CUST    6                       050907
     C           SDSECS    PARM SDSECS    DSSDY                           050907
     C*
     C* and not flagged for automatic settlement                          S01176
     C*                                                                   S01176
     C           AUTS      IFEQ 'Y'                                       S01176
     C           BFCLAS    OREQ 'I'                                       050907
     C                     ADD  1         EC                              S01176
     C                     MOVEA' 209'    ERR,EC                          S01176
     C                     SETON                     71                   S01176
     C                     MOVE '1'       E200                            S01176
     C                     ELSE                                           S01176
     C*                                                                   S01176
     C* Check record is complete
     C*
     C           TINC      IFNE 'C'
     C                     ADD  1         EC
     C                     MOVEA' 200'    ERR,EC
     C                     SETON                     71
     C                     MOVE '1'       E200
     C                     ELSE
     C*                                                                   S01269
     C* Check record is authorised                                        S01269
     C*                                                                   S01269
     C           RECI      IFEQ 'L'                                       S01269
     C           RECI      OREQ 'R'                                       S01269
     C           RECI      OREQ 'P'                                       S01269
     C                     ADD  1         EC                              S01269
     C                     MOVEA' 211'    ERR,EC                          S01269
     C                     SETON                     71                   S01269
     C                     MOVE '1'       E200                            S01269
     C                     ELSE                                           S01269
     C*
     C* and not already fully settled - unless reversal being entered
     C*
     C           TDFS      IFNE *ZEROS
     C           SREVE     ANDNE'Y'
     C                     ADD  1         EC         71
     C                     MOVEA' 200'    ERR,EC
     C                     MOVE '1'       E200
     C*                                                                   077259
     C* Fetch Security detail                                             077259
     C*                                                                   077259
     C                     ELSE                                           077259
     C           TDSS      CHAINSECTYDF              33                   077259
     C  N33      RECI      COMP 'D'                  3333                 077259
     C           *IN33     IFEQ '1'                                       077259
     C                     ADD  1         EC         71                   077259
     C                     MOVEA' 111'    ERR,EC                          077259
     C*
     C* If record ok, check Deliver To field there for purchase
     C*
     C                     ELSE
     C           TDTP      IFEQ 'TP'
     C********** DELT      IFEQ *ZEROS                                                        CSD027
     C           DELT      IFEQ *BLANKS                                                       CSD027
     C                     ADD  1         EC
     C                     MOVEA' 201'    ERR,EC
     C                     SETON                     71
     C                     END
     C*
     C* OR Deliver From field there for Sale
     C*
     C                     ELSE
     C           TDTP      IFEQ 'TS'
     C********** DELF      IFEQ *ZEROS                                                        CSD027
     C           DELF      IFEQ *BLANKS                                                       CSD027
     C                     ADD  1         EC
     C                     MOVEA' 201'    ERR,EC
     C                     SETON                     71
     C                     END
     C                     END
     C*
     C                     END
     C                     END                                            S01176
     C                     END                                            S01269
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END                                            077259
     C*
     C                     Z-ADDTNLU      STNLU
     C*
     C** If trade reference is invalid, other validation is superfluous   E20125
     C** and may cause U7 and U8 to be set on erroneously.                E20125
     C** Note 1: U7 and U8, which used to be ignored, are now checked     E20125
     C**         in mainline processing.                                  E20125
     C** Note 2: Although no warning errors currently exist for STRDR,    E20125
     C**         we compare EC to WEC (rather than zero) in case warning  E20125
     C**         errors for this field are added at a later date.         E20125
     C           EC        IFGT WEC                                       E20125
     C                     GOTO ENDVLD                                    E20125
     C                     END                                            E20125
     C*                                                                   E20125
     C**Movement*date*-*Mandatory*entry********************************   E14239
     C*
     C           SMVDT     IFEQ *BLANKS
     C***********          ADD  1         EC                              E14239
     C***********          MOVEA' 202'    ERR,EC                          E14239
     C***********          SETON                     72                   E14239
     C***********          ELSE                                           E14239
     C                     MOVE RUND      ZDAYNO                          E14239
     C                     EXSR ZDATE2                                    E14239
     C                     MOVE ZDATE     SMVDT                           E14239
     C                     END                                            E14239
     C*
     C* Check valid date entered
     C*
     C                     MOVE SMVDT     DATEN   60
     C                     MOVE DATEN     DATEA   6
     C           SMVDT     IFNE DATEA
     C                     ADD  1         EC
     C                     MOVEA' 202'    ERR,EC
     C                     SETON                     72
     C                     ELSE
     C                     MOVE SMVDT     ZDATE
     C                     EXSR ZDATE1
     C           *IN99     IFEQ '1'
     C                     ADD  1         EC
     C                     MOVEA' 202'    ERR,EC
     C                     SETON                     72
     C                     ELSE
     C*
     C* If ok, check before Run date
     C*
     C           ZDAYNO    IFGT RUND
     C                     ADD  1         EC
     C                     MOVEA' 203'    ERR,EC
     C                     SETON                     72
     C                     END
     C*
     C* Check after Value date of trade
     C*
     C           ZDAYNO    IFLT TDVD
     C                     ADD  1         EC
     C                     MOVEA' 204'    ERR,EC
     C                     SETON                     72
     C                     END
     C*
     C* Check if not equal to Value date but equal to particular Settle
     C*  -ment methods that it is not a holiday in Settlement Currency.
     C*
     C           TDVD      IFNE ZDAYNO
     C           SMTH      IFEQ 01
     C           SMTH      OREQ 02
     C           SMTH      OREQ 07
     C           SMTH      OREQ 08
     C           SMTH      OREQ 12
      *                                                                   S01195
     C                     MOVE *BLANKS   ZLOC                            S01195
      *                                                                   S01195
      ** Get Nostro Number                                                S01195
      *                                                                   S01195
     C           TDTP      IFEQ 'TP'                                      S01195
     C                     MOVELPYFM      DSPAYA                          S01195
     C                     ELSE                                           S01195
     C           TDTP      IFEQ 'TS'                                      S01195
     C                     MOVELPAYT      DSPAYA                          S01195
     C                     END                                            S01195
     C                     END                                            S01195
      *                                                                   S01195
      ** Call Access Object to find the Customer shortname                S01195
      *                                                                   S01195
     C                     CALL 'AONOSTR0'                                S01195
     C                     PARM *BLANKS   @RTCD   7                       S01195
     C                     PARM '*KEY   ' @OPTN   7                       S01195
     C                     PARM *BLANKS   @KEYA   6                       S01195
     C                     PARM SETC      @KEYB   3                       S01195
     C**********           PARM *BLANKS   @KEYC   4                                    S01195 CGL029
     C                     PARM *BLANKS   @KEYC  10                                           CGL029
     C                     PARM *BLANKS   @KEYD   2                       S01195
     C                     PARM SNOS      @KEYE   2                       S01195
     C                     PARM *BLANKS   @KEYF   3                       S01195
     C                     PARM *BLANKS   @KEYG  10                       S01195
     C                     PARM *BLANKS   @KEYH   1                       S01195
     C           SDNOST    PARM SDNOST    DSFDY                           S01195
      *                                                                   S01195
     C           @RTCD     IFEQ *BLANKS                                   S01195
      *                                                                   S01195
      **  Use branch code from Nostro record to get nostro location       S01195
      *                                                                   S01195
     C**********           CALL 'AOBRCHR0'                                             S01195 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD                           S01195
     C                     PARM '*KEY   ' @OPTN                           S01195
     C                     PARM A7BRCD    @DSNB   3                       S01195
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        S01195 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01195
     C                     MOVE A8LCCD    ZLOC                            S01195
     C                     END                                            S01195
     C*                                                                   S01195
     C                     MOVE SETC      ZCCY
     C************         MOVE ' '       ZOPT                            S01195
     C***********          EXSR ZDATE5                                    S01195
     C                     EXSR ZCHKH                                     S01195
     C************IN99     IFEQ '1'                                       S01195
     C           ZIND      IFEQ 'H'                                       S01195
     C                     ADD  1         EC
     C                     ADD  1         WEC
     C***********          MOVEA'W02'     ERR,EC                          E22832
     C                     MOVEA'W03'     ERR,EC                          E22832
     C                     SETON                     7625
     C                     END
     C                     END
     C                     END
     C*
     C                     END
     C                     END
     C***********          END                                            E14239
     C*
     C* Fully settled - Can only be 'Y', 'N' or blank
     C*
     C           SFSET     IFNE 'Y'
     C           SFSET     ANDNE'N'
     C           SFSET     ANDNE' '
     C                     ADD  1         EC
     C                     MOVEA' 205'    ERR,EC
     C                     SETON                     73
     C                     ELSE
     C*
     C* If 'Y', the trade cannot already be fully settled
     C*
     C           SFSET     IFEQ 'Y'
     C           E200      ANDEQ'0'
     C           TDFS      ANDNE*ZEROS
     C                     ADD  1         EC
     C                     MOVEA' 206'    ERR,EC
     C                     SETON                     73
     C                     END
     C*
     C                     END
     C*
     C* Reversal - Can only be 'Y', 'N' or blank
     C*
     C           SREVE     IFNE 'Y'
     C           SREVE     ANDNE'N'
     C           SREVE     ANDNE' '
     C                     ADD  1         EC
     C                     MOVEA' 207'    ERR,EC
     C                     SETON                     74
     C                     ELSE
     C*
     C* If 'Y', the trade must be partly or fully settled already
     C*
     C           SREVE     IFEQ 'Y'
     C           TNSP      IFEQ *ZEROS
     C           TNSN      ANDEQ*ZEROS
     C           TVSP      ANDEQ*ZEROS
     C           TVSN      ANDEQ*ZEROS
     C                     ADD  1         EC
     C                     MOVEA' 208'    ERR,EC
     C                     SETON                     74
     C                     END
     C*
     C                     END
     C                     END
     C*                                                                   E16843
     C* Check that account is not blocked                                 E16843
     C*                                                                   E16843
     C*                                                                   E16843
     C*      Settlement method 04                                         E16843
     C*                                                                   E16843
     C           SMTH      IFEQ 4                                         E16843
     C                     MOVE TDBA      KYBRCA                          S01117
     C**********           Z-ADDTCNR      KYCNUM                                       E16843 CSD027
     C                     MOVE TCNR      KYCNUM                                              CSD027
     C                     MOVELSETC      KYCCY                           E16843
     C***********          Z-ADDCADC      KYACOD                    E16843S01117
     C                     Z-ADD0         KYACOD                          S01117
     C                     MOVELBMACCD    KYACOD                          S01117
     C***********MBIN      IFEQ 'N'                                 E16843S01117
     C                     Z-ADD1         KYACSQ                          E16843
     C***********          ELSE                                     E16843S01117
     C***********          MOVE *BLANKS   KEY12  12                 E16843S01117
     C***********TDTP      IFEQ 'TP'                                E16843S01117
     C***********          MOVE PYFB      KEY12                     E16843S01117
     C***********          ELSE                                     E16843S01117
     C***********          MOVE PYTA      KEY12                     E16843S01117
     C***********          END                                      E16843S01117
     C***********          MOVEL'10'      KEY12                     E16843S01117
     C***********KEY12     CHAINTABLETRF             33             E16843S01117
     C************IN33     IFEQ '1'                                 E16843S01117
     C***********          SETON                       U7U8         E16843S01117
     C***********          MOVE 'TABLE'   DBFILE           *********E16843S01117
     C***********          MOVELKEY12     DBKEY            ** DB ERRE16843S01117
     C***********          MOVE '09'      DBASE            *********E16843S01117
     C***********          GOTO ENDVLD                              E16843S01117
     C***********          END                                      E16843S01117
     C***********          Z-ADDNSACS     KYACSQ                    E16843S01117
     C***********          END                                      E16843S01117
     C                     END                                            E16843
     C*                                                                   E16843
     C*      Settlement method 05                                         E16843
     C*                                                                   E16843
     C           SMTH      IFEQ 5                                         E16843
     C           TDTP      IFEQ 'TP'                                      E16843
     C                     MOVE PYFA      KYBRCA                          S01117
     C                     MOVELPYFM      KYCNUM                          E16843
     C**********           MOVE PYFM      WORK6   6                                    E16843 CGL029
     C                     MOVE PYFM      WORK6  12                                           CGL029
     C                     END                                            E16843
     C           TDTP      IFEQ 'TS'                                      E16843
     C                     MOVE PYTA      KYBRCA                          S01117
     C                     MOVELPAYT      KYCNUM                          E16843
     C**********           MOVE PAYT      WORK6   6                                    E16843 CGL029
     C                     MOVE PAYT      WORK6                                               CGL029
     C                     END                                            E16843
     C                     MOVELSETC      KYCCY                           E16843
     C                     MOVELWORK6     KYACOD                          E16843
     C                     MOVE WORK6     KYACSQ                          E16843
     C                     END                                            E16843
     C*                                                                   E16843
     C*      Settlement method 14                                         E16843
     C*                                                                   E16843
     C           SMTH      IFEQ 14                                        E16843
     C           TDTP      IFEQ 'TP'                                      E16843
     C                     MOVELPYFM      KEY10                           E16843
     C                     END                                            E16843
     C           TDTP      IFEQ 'TS'                                      E16843
     C                     MOVELPAYT      KEY10                           E16843
     C                     END                                            E16843
     C           ACNKA     CHAINACNUMF               33                   E16843
     C           *IN33     IFEQ '1'                                       E16843
     C           RECI      ORNE 'D'                                       E16843
     C                     MOVE *BLANKS   ATYP                            E16843
     C                     GOTO ENDVLD                                    E16843
     C                     END                                            E16843
     C                     MOVE CNUM      KYCNUM                          E16843
     C                     MOVE CCY       KYCCY                           E16843
     C                     Z-ADDACOD      KYACOD                          E16843
     C                     Z-ADDACSQ      KYACSQ                          E16843
     C                     MOVE BRCA      KYBRCA                          S01117
     C                     END                                            E16843
     C*                                                                   E16843
     C*      Settlement method 15                                         E16843
     C*                                                                   E16843
     C           SMTH      IFEQ 15                                        E16843
     C***********          MOVE BRCA      TDBA                     S01117 E32106
     C           TDTP      IFEQ 'TP'                                      E16843
     C                     MOVELPYFM      KYCNUM                          E16843
     C                     MOVELPYFA      KYBRCA                          E32106
     C**********           MOVE PYFM      @CDSQ   60                                   089949 CGL029
     C                     MOVE PYFM      @CDSQ  120                                          CGL029
     C                     END                                            E16843
     C           TDTP      IFEQ 'TS'                                      E16843
     C                     MOVELPAYT      KYCNUM                          E16843
     C                     MOVELPYTA      KYBRCA                          E32106
     C                     MOVE PAYT      @CDSQ                           089949
     C                     END                                            E16843
     C                     MOVELSETC      KYCCY                           E16843
     C***********KYCNUM    CHAINCLINTSEF             33             E16843S01117
     C************IN33     IFEQ '1'                                 E16843S01117
     C***********RECI      ORNE 'D'                                 E16843S01117
     C***********          SETON                 U7U8***************E16843S01117
     C***********          MOVE 'CLINT'   DBFILE     * DB ERROR 10 *E16843S01117
     C***********          MOVELKYCNUM    DBKEY      ***************E16843S01117
     C***********          MOVE '10'      DBASE                     E16843S01117
     C***********          GOTO ENDVLD                              E16843S01117
     C***********          END                                      E16843S01117
     C*                                                                   089949
     C** If the Account Code and Account Sequence are blank, get the      089949
     C** values from CLINTSE, else, use the input.                        089949
     C*                                                                   089949
     C           @CDSQ     IFEQ 0                                         089949
     C                     MOVELKYCNUM    CUST6A  6                       S01117
     C                     CALL 'AOSECSR0'                                S01117
     C                     PARM 'DBERR'   @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM CUST6A    CUST    6                       S01117
     C           SDSECS    PARM SDSECS    DSSDY                           S01117
     C*                                                                   S01117
     C***********          Z-ADDC1AC      KYACOD                    E16843S01117
     C***********          Z-ADDC1SQ      KYACSQ                    E16843S01117
     C                     Z-ADD0         KYACOD                          S01117
     C                     MOVELBFACCD    KYACOD                          S01117
     C                     Z-ADDBFACSN    KYACSQ                          S01117
     C                     ELSE                                           089949
     C                     MOVEL@CDSQ     KYACOD                          089949
     C                     MOVE @CDSQ     KYACSQ                          089949
     C                     END                                            089949
     C                     END                                            E16843
     C*                                                                   E16843
      ** Check if Compliance Watch is installed and watch listing                             CSD015
      ** checking is applied                                                                  CSD015
      *                                                                                       CSD015
     C           CSD015    IFEQ 'Y'                                                           CSD015
     C           W1EWLC    ANDEQ'Y'                                                           CSD015
      *                                                                                       CSD015
      ** Check if 24X7 Midas availability is not installed or it is                           CSD015
      ** installed and is in the main system                                                  CSD015
      *                                                                                       CSD015
     C           CSC011    IFEQ 'N'                                                           CSD015
     C           S1MAIN    OREQ LIBR                                                          CSD015
      *                                                                                       CSD015
      ** Determine transaction has a pending compliance case                                  CSD015
      *                                                                                       CSD015
     C                     MOVEL'TRADSD  'KFUNT                                               CSD015
     C                     MOVELTDRF      KIDEN                                               CSD015
     C                     MOVELTDBA      KBRCH                                               CSD015
     C           KCWHTL    CHAINSDCWHTL1             36                                       CSD015
      *                                                                                       CSD015
      ** If transaction is has a pending case other than Temporarily                          CSD015
      ** Released, set-up error code 401 ("Item under review by                               CSD015
      ** Compliance Officer")                                                                 CSD015
      *                                                                                       CSD015
     C           *IN36     IFEQ '0'                                                           CSD015
     C           W3TREL    ANDNE'Y'                                                           CSD015
     C                     ADD  1         EC                                                  CSD015
     C                     MOVEA' 401'    ERR,EC                                              CSD015
     C                     SETON                     71                                       CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
     C                     ENDIF                                                              CSD015
      *                                                                                       CSD015
     C           SMTH      IFNE 4                                         E19813
     C           SMTH      ANDNE5                                         E19813
     C           SMTH      ANDNE14                                        E19813
     C           SMTH      ANDNE15                                        E19813
     C                     GOTO ENDVLD                                    E19813
     C                     END                                            E19813
     C*                                                                   E19813
     C           ACCKA     CHAINACCNTABF             33                   E16843
     C           *IN33     IFEQ '1'                                       E16843
     C           RECI      ORNE 'D'                                       E16843
     C                     SETON                       U7U8               E16843
     C           *LOCK     IN   LDA                        ***************S01117
     C                     MOVE 'ACCNT'   DBFILE           * DB ERROR 13 *E16843
     C                     MOVELDSACC     DBKEY            ***************E16843
     C***********          MOVE '13'      DBASE                     E16843S01117
     C                     Z-ADD13        DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     ELSE                                           E16843
     C                     TESTB'2'       RETB           41               E16843
     C                     TESTB'3'       RETB           42               E16843
     C           TDTP      IFEQ 'TP'                                      E16843
     C           *IN41     ANDEQ'1'                                       E16843
     C           SREVE     ANDNE'Y'                                       E16843
     C           TDTP      OREQ 'TP'                                      E16843
     C           *IN42     ANDEQ'1'                                       E16843
     C           SREVE     ANDEQ'Y'                                       E16843
     C           TDTP      OREQ 'TS'                                      E16843
     C           *IN42     ANDEQ'1'                                       E16843
     C           SREVE     ANDNE'Y'                                       E16843
     C           TDTP      OREQ 'TS'                                      E16843
     C           *IN41     ANDEQ'1'                                       E16843
     C           SREVE     ANDEQ'Y'                                       E16843
     C                     ADD  1         EC                              E16843
     C                     MOVEA' 210'    ERR,EC                          E16843
     C                     SETON                     71                   E16843
     C                     END                                            E16843
     C                     END                                            E16843
     C*
     C                     END                                            S01117
     C*                                                                   S01117
     C********             ENDSR                                          E16843
     C           ENDVLD    ENDSR                                          E16843
      *
      /EJECT                                                              S01117
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE0060CCP4                                           S01408
     C*                                                                   S01408
      *****************************************************************   S01117
      *                                                               *   S01117
      *  *PSSR - Subroutine to handle abnormal error conditions       *   S01117
      *                                                               *   S01117
      *  Called from: after abnormal operation occurs                 *   S01117
      *                                                               *   S01117
      *  Calls: None                                                  *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
      *                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR **    S01117
      *                                                                   S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C                     ENDSR                           ** *PSSR **    S01117
      *                                                                   S01117
      *****************************************************************
      /EJECT                                                              S01195
     C/COPY ZSRSRC,ZACCH                                                  S01195
      /EJECT
     C/COPY ZSRSRC,ZALIGNZ2
      /EJECT
     C/COPY ZSRSRC,ZCHKH                                                  S01195
      /EJECT                                                              S01195
     C/COPY ZSRSRC,ZCONVZ1
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z4
      /EJECT
     C***/COPY*ZSRSRC*ZDATE6Z2                                            S01195
      /EJECT                                                              S01158
     C/COPY ZSRSRC,ZEDITZ2                                                S01158
      /EJECT
     C*COPY*ZSRSRC*ZICDSEZ1*****                                          S01117
      *EJECT*****                                                         S01117
     C*COPY*ZSRSRC*ZICD2Z1******                                          S01117
      *EJECT*****                                                         S01117
     C/COPY ZSRSRC,ZSEDITZ3
      /EJECT
     C***/COPY*ZSRSRC*ZSYSTMZ1*****                                       S01117
      /EJECT
     C/COPY ZSRSRC,ZTNLU1Z2
      ***
**  CPY@
(c) Finastra International Limited 2001
**   INF  - File updated error message
RECORD UPDATED BY ANOTHER WORKSTATION
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**   TABMTH/TABMTN  -  Settlement type/description
0As required
1Against Payment
2Payment after delivery
3Free
4Delivery after payment
5Against Payment
