     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Project Book Position Events (+ CPK003)')     *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Securities Trading Module                            *
     F*                                                               *
     F*  SE1440 - PROJECT BOOK POSITION EVENTS                        *
     F*                                                               *
     F*  Function: The Forward Security Events File is read, and the  *
     F*   (COB)    following types of Security Events and Event Codes *
     F*            on Book Positions are produced:                    *
     F*                                                               *
     F*            PP: 31B1  (PP Call)    CP: 31B2  (Coupon)          *
     F*            DV: 31B3  (Dividend)   MP: 31B4  (Mortgage Payt)   *
     F*            MA: 31B5  (Maturity)                               *
     F*                                                               *
     F*            These Events are used in production of Events by   *
     F*            Security report, Shadow Posting, and Dealing       *
     F*            Module Event reports.                              *
     F*                                                               *
     F*  Called By: SEC1105 - Project Book Position Events            *
     F*                                                               *
     F*  Calls: ZACRFB - Calculate Interest on Book Positions         *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*  Note: This program is very similar to SE1460 and SE1480. Any *
     F*        changes made to this program should also be considered *
     F*        for the other two programs.                            *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. CER059             Date 19Jul10               *
      *  Prev Amend No. CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 241795             Date 13Sep06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSE078             Date 14Feb06               *
      *                 BUG11199           Date 02May06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE075             Date 06Mar06               *
      *                 CSE075             Date 17Nov05               *
      *                 CSE071             Date 19Jul05               *
      *                 CGL029             Date 01Sep03               *
      *                 CSE037             Date 29Apr02               *
      *                 CSE035             Date 22Apr02               *
      *                 CAS006             Date 21Jan03               *
      *                 206316             Date 19Jul02               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 192467             Date 26Jul01               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CSE031             Date 09Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 187848             Date 28Dec00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CAC005             Date 10Nov98               *
      *                 130862             Date 16Oct98               *
      *                 CEU011             Date 11Mar98               *
      *                 CSE005             Date 04Feb97               *
     F*                 S01408             DATE 30SEP96               *
     F*                 073040             DATE 26JUL96               *
     F*                 100228             DATE 30MAY96               *
     F*                 103070             DATE 10MAY96               *
     F*                 103011             DATE 09MAY96               *
     F*                 099890             DATE 16APR96               *
     F*                 101125             DATE 14MAR96               *
     F*                 091254             DATE 20OCT95               *
     F*                 087712             DATE 15JUN95               *
     F*                 085494             DATE 06JUN95               *
     F*                 CPK003             DATE 15MAY95               *
     F*                 S01512             DATE 30SEP94               *
     F*                 076693             DATE 30SEP94               *
     F*                 076692             DATE 30SEP94               *
     F*                 076214             DATE 20SEP94               *
     F*                 S01510             DATE 10AUG94               *
     F*                 S01509             DATE 10AUG94               *
     F*                 060719             DATE 16JAN94               *
     F*                 052254             DATE 10JAN94               *
     F*                 S01401             DATE 16JUN93               *
     F*                 S01397             DATE 10SEP92               *
     F*                 S01393             DATE 01OCT92               *
     F*                 E34185             DATE 09JAN92               *
     F*                 E34034             DATE 07JAN92               *
     F*                 E33157             DATE 11DEC91               *
     F*                 E33042             DATE 09DEC91               *
     F*                 E32883             DATE 04DEC91               *
     F*                 E29170             DATE 18NOV91               *
     F*                 E29978             DATE 22OCT91               *
     F*                 E24175             DATE 01OCT91               *
     F*                 E29031             DATE 01OCT91               *
     F*                 E27092             DATE 04SEP91               *
     F*                 S01117             DATE 04JUN91               *
     F*                 E24075             DATE 12MAR91               *
     F*                 S01220             DATE 23JUL90               *
     F*                 E23955             DATE 23OCT90               *
     F*                 E21514             DATE 15JUN90               *
     F*                 E21639             DATE 24APR90               *
     F*                 E21616             DATE 03APR90               *
     F*                 E21075             DATE 08FEB90               *
     F*                 E20651             DATE 05FEB90               *
     F*                 E19101             DATE 25JAN90               *
     F*                 E20568             DATE 09DEC89               *
     F*                 E20085             DATE 07NOV89               *
     F*                 E20086             DATE 07NOV89               *
     F*                 E16180             DATE 24OCT89               *
     F*                 E16772             DATE 31/05/89              *
     F*                 S01176             DATE 08/08/88              *
     F*                                                               *
     F*---------------------------------------------------------------*
      *                                                               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  241795 - Populate ECSS whether CEU011 is switched on or off. *
      *  CSE078 - Sort Report using Currency Sort Sequence            *
      *  BUG11199 - Ensure that the number of dec. place is correct.  *
      *             Applied fix 238955.                               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE075 - CSE075 Change Control. Display Coupon Delay period  *
      *           for all interest-bearing securities.                *
      *  CSE075 - US Enhanced Treasury Upgrade to MidasPlus           *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CSE037 - Bond Pricing - 3 Decimal Places in Trades Input     *
      *  CSE035 - NX/NNX Coupon Payment Processing.                   *
      *  CAS006 - Hedge Accounting Phase B (Recompile)                *
      *  206316 - Recompiled over changed ZLCDZ1.                     *
      *  192467 - No maturity position settlement was generated.  Set *
      *           price for records with processing type '1' and      *
      *           price basis 'U'.                                    *
      *  CSE031 - Coupon Fixing for Floating Rate Notes.              *
      *           (recompilation due to change to ZNCD/ZLCD)          *
      *  187848 - Only generate projected event if position           *
      *           settlement is not being generated when CSE023       *
      *           Treaty Tax is present                               *
      *  CAC005 - PCA-SE Enhancement.                                 *
     F*  130862 - Recompiled over changed ZLCDZ1.                     *
     F*  CEU011 - Position/Risk Enquiries & Reports                   *
     F*  CSE005 - Effect of holidays on FRN Coupon Dates              *
     F*           (recompilation due to change to ZNCD/ZLCD)          *
     F*  S01408 - Addition of core hook SE1440FFP1                    *
     F*           Addition of core hook SE1440IIP1                    *
     F*           Addition of core hook SE1440CCP7                    *
     F*           Addition of core hook SE1440CCP6                    *
     F*           Addition of core hook SE1440CCP5                    *
     F*           Addition of core hook SE1440CCP4                    *
     F*           Addition of core hook SE1440CCP3                    *
     F*           Addition of core hook SE1440CCP2                    *
     F*           Addition of core hook SE1440CCP1                    *
     F*  073040 - For Mortgage-backed securities at maturity, if there*
     F*           is no Redemption record on Security Diary event file*
     F*           program shall look for the current factor on the    *
     F*           latest Mortgage Repayment record. (Apply fix 048177)*
     F*  100228 - RECOMPILED FOR CHANGES TO SR ZLCDZ1.                *
     F*  103070 - Database error occurs when Book Code is blank.      *
     F*  103011 - The system creates a position settlement MT* for    *
     F*           warrant which can lead to confusion for cashflow    *
     F*  099890 - Coupon amount included ex-coupon nominal where      *
     F*           coupon date is on a holiday, because Last Coupon    *
     F*           Date is updated before forward events generated.    *
     F*           Use the event date to work out the LCD and use      *
     F*           this to check against the position date.            *
     F*  101125 - Divide by Zero, on a Redemption Call - only perform *
     F*           the calculation if the total issued amount is not 0.*
     F*  091254 - RECOMPILE OVER CHANGED ZLCDZ1 & ZNCDZ3              *
     F*  087712 - Percentage price-based shares have dividend amount  *
     F*           calculated 100 times too much                       *
     F*  085494 - Output correct pgm name if DB error, as pgm name    *
     F*           on LDA may be overwritten by called programs.       *
     F*  CPK003 - RMSPEVP was made redundant by CRM001 (T-Mark        *
     F*           interface). However this program was overlooked.    *
     F*           RMSPEVP has been temporarily reinstated in DPLIB for*
     F*           Release 10.6 packaging to allow the pgm to compile. *
     F*  S01512 - Add payment date for coupon event due on a holiday  *
     F*           and payment on next working date                    *
     F*  076693 - M/D indicator must be taken from XR or RC event on  *
     F*           SEDEVD (field SDMD)                                 *
     F*  076692 - Replace #NCDP with #ECDP in SR/SRDE                 *
     F*  076214 - Wrong field is being checked for return code after  *
     F*           calls to AOBRCHR0 causing DB errors                 *
     F*  S01510 - Dividend payments based on ex-date                  *
     F*  S01509 - Value currency to be currency of issuer of payments *
     F*  060719 - DB Error in BOOKDD                                  *
     F*  052254 - CURRENT FACTOR amended from 9,8 to 10,9             *
     F*  S01401 - MT5xx SWIFT Messages Feature:                       *
     F*          - Recompiled due to changes to files.                *
     F*  S01397 - Rel 10 Incorporation of BNZ SARs A46008 and A46013. *
     F*          - Recompiled due to changes to files.                *
     F*  S01393 - Upgraded for Strategic Risk Management.             *
     F*           Always generate events for RM                       *
     F*  E34185 - Event types DE & DV still don't have event branches *
     F*  E34034 - Recompiled over changed printer file                *
     F*  E33157 - Event types DE and DV get blank event branches      *
     F*  E33042 - Fields EBRC and COBB should have something output   *
     F*           to them on BPEVED                                   *
     F*  E32883 - SRDE subroutine uses array POWER whereas it should  *
     F*           be using array POWER8                               *
     F*  E29170 - Report Control Facility changes                     *
     F*  E29978 - In SR/SROUT, for Value Date calculations, if the    *
     F*           Position obtained from the Input Record has a Date  *
     F*           preceding the Last Coupon Date, then any Ex-Coupon  *
     F*           Nominal should not be deducted from total Position. *
     F*  E24175 - Calculation of event amount 'DE' events does not    *
     F*            take account of nominal decimal places             *
     F*  E29031 - File controls permanently out of balance because    *
     F*           of Risk Management changes                          *
     F*  E27092 - Recompiled over changed SR/ZLCD                     *
     F*  S01117 - Multibranching                                      *
     F*  E24075 - DB error on BOOKDD caused by E21639                 *
     F*  S01220 - Strategic Risk Management                           *
     F*           Generate additional book position events and write  *
     F*           them to new file PF/RMSPEVP.                        *
     F*  E23955 - Fix E20085 incomplete - Interest processing at      *
     F*           maturity and for Mortgage-backed securities has been*
     F*           amended, so processing to calculate interest and add*
     F*           to principal should be removed as this is done      *
     F*           elsewhere.                                          *
     F*  E21514 - Exclude Discount Securities when setting '#INTR'    *   E21514
     F*           for Interest-Bearing Securities.                    *   E21514
     F*  E21639 - Dividend Events should be based on Trade Daye Posn. *   E21639
     F*  E21616 - Recompiled over changed SR/ZLCD.                    *   E21616
     F*  E21075 - Book Position retrievals must be in the same Market.*   E20651
     F*  E20651 - DB Error Numbers used in more than one place.       *   E20651
     F*           New Error Numbers as follows:                       *   E20651
     F*           DB ERROR 06 -> 11                                   *   E20651
     F*           DB ERROR 06 -> 12                                   *   E20651
     F*           DB ERROR 06 -> 13                                   *   E20651
     F*  E19101 - Short Positions changed to Positive Event Value.    *   E19101
     F*  E20568 - ZACCZ changed to read Non-Diary Events File -       *   E20568
     F*           renamed record format of SECEO.                     *   E20568
     F*  E20085 - Interest and Coupon Calculations Rewrite:           *   E20085
     F*          - Don't produce Coupon Events for Discount Securities*   E20085
     F*          - Separate Coupon Event at Maturity so do not include*   E20085
     F*            Interest in the Maturity Amount.                   *   E20085
     F*          - Nominal field used in dividend amount calculation  *   E20085
     F*            was not long enough.                               *   E20085
     F*          - LF/SECEO member SEDEVD changed to omit RECI = 'C'. *   E20085
     F*          - Coupon Amount should be calculated from Last Coupon*   E20085
     F*            Date based on EVENT Date, not LCPN.                *   E20085
     F*          - If Position changes on Coupon Date, Base Coupon    *   E20085
     F*            calculates on Last Position prior to Coupon Date.  *   E20085
     F*  E20086 - Mortgage-Backs and Current Factor Processing Rewrite*   E20086
     F*          - CFCT on SECTYD is updated before this program is   *   E20086
     F*            run, so (Old CF - New CF) is always zero. To get   *   E20086
     F*            the correct Factor, read the prior MP Diary Event. *   E20086
     F*          - As a CP Event is generated separately, it is very  *   E20086
     F*            misleading to have it included in the MP Amount.   *   E20086
     F*          - CF Work field redefined as (9,8) NOT (15,7).       *   E20086
     F*          - MA process changed to use LF/SECEO to avoid mess.  *   E20086
     F*          - MP - SETLL supposed to be SETGT (for CF).          *   E20086
     F*  E16180 - Last Coupon Date should be used instead of Interest *   E16180
     F*           Accrual Control Date for calculation of Coupon      *   E16180
     F*           Amount.                                             *   E16180
     F*  E16772 - The Dividend Payment Amount field SDDV has been     *   E16772
     F*           replaced by the field SDVA, to increase its size    *   E16772
     F*           from 9,4 to 13,8                                    *   E16772
     F*  S01176 - RELEASE 3.1 MODIFICATIONS                           *   S01176
     F*                                                               *
     F*****************************************************************
      *
     F***SECEF***IPE E           K        DISK                            S01220
     F*********** SEDEVDF                           KRENAMESECEVDF        E20086
     FSECEFRM IPE E           K        DISK                               S01220
     F***PIBKPD**IF  E           K        DISK                            S01220
     FPIBKPD  UF  E           K        DISK                               S01220
     FBKPHD   IF  E           K        DISK
     FBKPCF   IF  E           K        DISK
     FBKPOS   IF  E           K        DISK                               E21639
     F            BKPOSDF                           KRENAMEBKPOSDO        E21639
     FSECTY   IF  E           K        DISK
     F***SEDEV***IF**E           K        DISK                            E20086
     FSECEO   IF  E           K        DISK                               E20086
     F**********  SNDEVDF                           KIGNORE         E20086E20568
     F            SNDEVDF                           KRENAMESNDEVDO        E20568
     F            SEDEVDF                           KRENAMESEDEVDO        E20086
     FINVTP   IF  E           K        DISK
     FBOOKD   IF  E           K        DISK
     FTABSE   IF  E           K        DISK
     F            TABLETAF                          KIGNORE
     F            TABLETHF                          KIGNORE
     F************TABLETJF                          KIGNORE               S01117
     F            TABLETLF                          KIGNORE
     F            TABLETKF                          KIGNORE
     F            TABLETNF                          KIGNORE
     F            TABLETPF                          KIGNORE
     F            TABLETRF                          KIGNORE
     F            TABLETXF                          KIGNORE
     F**ICD*1*****TABTB10F                          KIGNORE
     F**ICD*2*****TABTB11F                          KIGNORE
     F            TABTB36F                          KIGNORE
     F            TABTB40F                          KIGNORE
     F            TABTE10F                          KIGNORE
     F            TABTE20F                          KIGNORE
     F**CCY*d.p.**TABTG10F                          KIGNORE
     F            TABTG20F                          KIGNORE
     F            TABLET2F                          KIGNORE
     F            TABLET3F                          KIGNORE
     F            TABLET5F                          KIGNORE
     F***SDRISKL1IF  E                    DISK                     S01220 S01393
     FSEDEVA  IF  E                    DISK
     FSNDEFA  IF  E                    DISK
      *                                                                   CEU011
     FSDCURRL1IF  E           K        DISK                               CEU011
      *                                                                   CEU011
      ** Currencies File                                                  CEU011
      *                                                                   S01408
     F/COPY WNCPYSRC,SE1440FFP1                                           S01408
      *                                                                   S01408
     FBPEVED  O   E                    DISK
     FBPEVEA  O   E                    DISK
     FRMSPEVP O   E                    DISK                               S01220
     FSE1440AUO   E                    PRINTER
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   L1  - Security Shortname change                             *
     F*                                                               *
     F*   11  - Security Diary Events File read                       *
     F*   12  - Security Non-Diary Events File read                   *
     F*   13  - Security Risk Management Non-Diary Events             *   S01220
     F*                                                               *
     F*   40  - Detail records read                                   *
     F*   41  - Currencies array lokup indicator                      *   CEU011
     F*   42  - Currencies EOF indicator                              *   CEU011
     F*   50  - Work indicator                                        *
     F*   52  - Record not found (DBERR)                              *
     F*   53  - DBERR from called program                             *
     F*                                                               *
     F* 90-99 - Used in Standard Subroutines                          *
     F*                                                               *
     F*   U7  - Database Error                                        *
     F*   U8  - Database / Control Error                              *
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  SRHASH - Add Event Amounts To Hash Totals                    *
     F*  SROUT  - Set up Event record data & write Event record.      *
     F*  SRRMS  - Set up Risk Management Event record data            *   S01220
     F*  SRRMW  - Write Event record                                  *   S01220
     F*                                                               *
     F*  SRPP   - Calculate PP Call Event Amount                      *
     F*  SRCP   - Calculate Coupon Event Amount                       *
     F*  SRDV   - Calculate Dividend Event Amount                     *
     F*  SRDE   - Calculate Dividend Event Amount                     *
     F*  SRMP   - Calculate Mort. Payment Event Amount                *
     F*  SRMA   - Calculate Maturity Event Amount                     *
     F*  SRRC   - Calculate Redemption Call Amount                    *   S01220
     F*  SRLR   - Total Time calculations                             *
     F*  *PSSR  - Error handling                                      *   S01117
     F*                                                               *
     F*  ZCNSD  - Calculate consideration                             *   087712
     F*  ZCONV  - CCY1 to CCY2 Amount conversion                      *
     F*  ZDATE1 - Validates Dates and converts to Number of Days.     *
     F*  ZDATE2 - Converts a Day Number to Date Format.               *
     F*  ZLCD   - Obtains prior Coupon Date.                          *
     F*  ZSYSTM - Access ICD 1 record                                 *
     F*                                                               *
     F*****************************************************************
      /EJECT
     E                    CPY@    1   1 80
     E                    CUR       200  3   SRT     2 0                  CEU011
      *                                                                   CEU011
      ** Array to store Ccy and Sort Sequence no.                         CEU011
      *                                                                   CEU011
      *                                                                   CEU011
     E/COPY ZSRSRC,ZDATE2Z1                                               E20085
     E/COPY ZSRSRC,ZNCDZ1                                                 E20085
     E/COPY ZSRSRC,ZPOWERZ1
     E/COPY ZSRSRC,ZPOWER8Z1
     E/COPY ZSRSRC,ZHOLE                                                  S01512
      /EJECT
     I***SECEVDF*****11                                                   E20086
     ISEDEVDF     11                                                      E20086
      * Security Diary Events
     I              SDSN                            CCSS  L1
     I              SDED                            CCDT
     I              SDET                            CCET
      *
     ISNDEVDF     12
      * Security Non-Diary Events
     I              SNSN                            CCSS  L1
     I              SNDT                            CCDT
     I              SNET                            CCET
     ISRMNDEF     13                                                      S01220
     I** Security Risk Management Non-Diary Events                        S01220
     I              SNSN                            CCSS  L1              S01220
     I              SNDT                            CCDT                  S01220
     I              SNET                            CCET                  S01220
      *
     IPIBKPDF
      * Book Position Index
     I***********   PIBR                            CCBR                  S01117
     I              PIBH                            CCBA                  S01117
     I              PIBK                            CCBK
     I              PIMK                            CCMK
      *
     IBKPOSDO                                                             E21639
      * Book Position                                                     E21639
     I***********   BPBR                            CCBR           E21639 S01117
     I              BPBA                            CCBA                  S01117
     I              BPBK                            CCBK                  E21639
     I              BPMK                            CCMK                  E21639
      *
     ISECTYDF
      * Securities
     I              NMCY                            CCNC
     I/COPY WNCPYSRC,SE1440I001
      *
     IBOOKDDF
      * Book Details file (Book Desc. 30A)
     I              BOKD                            CCBD
      *
     I***SEDEVDF****                                                      E20086
     ISEDEVDO                                                             E20086
      * Security Diary Events
     I              RECI                            XRECI
     I              SDSN                            XSDSN
     I              SDED                            XSDED
     I              SDET                            XSDET
     I              SDNV                            XSDNV
     I**************SDDV                            XSDDV                 E16772
     I              SDVA                            XSDVA                 E16772
     I              SDCP                            XSDCP
     I              SRPT                            XSRPT
     I              SDTR                            XSDTR
     I              SRMI                            XSRMI
     I              SDPD                            XSDPD
     I              SDNC                            XSDNC
     I              SDPP                            XSDPP
     I              SDPC                            XSDPC
     I              SDTA                            XSDTA
     I              SDTP                            XSDTP
     I              SDRP                            XSDRP
     I              SDCV                            XSDCV
     I              SDCX                            XSDCX
     I              SDCE                            XSDCE
     I              SDMD                            XSDMD
     I              NMCY                            XNMCY
     I              SDAD                            XSDAD
     I              SDDT                            XSDDT
     I              LCD                             XLCD
     I              CHTP                            XCHTP
     I              TNLU                            XTNLU
     I              SDXD                            XSDXD                 S01510
      *                                                                                       CSE075
     ISNDEVDO                                                                                 CSE075
      ** Security Non-Diary Events                                                            CSE075
      *                                                                                       CSE075
     I              RECI                            XRECI                                     CSE075
     I              SNSN                            XSNSN                                     CSE075
     I              SNDT                            XSNDT                                     CSE075
     I              SNET                            XSNET                                     CSE075
     I              SNCR                            XSNCR                                     CSE075
     I              SNCF                            XSNCF                                     CSE075
     I              SNCP                            XSNCP                                     CSE075
     I              SNCA                            XSNCA                                     CSE075
     I              SNPR                            XSNPR                                     CSE075
     I              SNNA                            XSNNA                                     CSE075
     I              MDTI                            XMDTI                                     CSE075
     I              LCCP                            XLCCP                                     CSE075
      *                                                                                       CSE037
     IINVTPDF                                                                                 CSE037
     I              SFLG                            ISFLG                                     CSE037
      *                                                                   S01408
     I/COPY WNCPYSRC,SE1440IIP1                                           S01408
      *                                                                   S01408
     I*                                                                   E33042
     ISDBRCH    E DSSDBRCHPD                                              E33042
     I*                                                                   E33042
     I** Branch details                                                   E33042
     I*                                                                   E33042
     I*                                                                   S01220
     ISDMMOD    E DSSDMMODPD                                              S01220
     I*                                                                   S01220
     I** Module details                                                   S01220
     I*                                                                   S01220
     IDSFDY     E DSDSFDY                                                 S01220
     I*                                                                   S01220
     I** DS for access programs, short data structure                     S01220
     I*                                                                   S01220
      *
      ***  Local Data Area for DB Error Information
     I*LDA******* UDS                            256                      S01117
     ILDA         DS                            256                       S01117
     I***********                           134 177 #DBLOT
     I*********** DS
     I                                      134 183 DBLOT                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 177 DBASE                 S01117
     I*
     I           SDS
     I                                      244 246 WSID
     I                                      254 263 USID
      *
      * Book Position - Input
      * Book Position Header (LF/BKPHD)
      *
     I            DS
     I************                            1  15 BOOK                  E21075
     I                                        1  16 BOOK                  E21075
     I                                        1  17 BKPH
     I                                        1  10 CCSS
     I***********                            11  130CCBR                  S01117
     I                                       11  13 CCBA                  S01117
     I                                       14  15 CCBK
     I                                       16  16 CCMK
     I                                       17  17 XXTV
      *
      * Book Position - Chain
     I            DS
     I************                            1  15 BOOK1                 E21075
     I                                        1  16 BOOK1                 E21075
     I                                        1  10 BPSC
     I***********                            11  130BPBR                  S01117
     I                                       11  13 BPBA                  S01117
     I                                       14  15 BPBK
     I                                       16  16 BPMK                  E21075
     I*
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I*
     I/COPY ZSRSRC,ZNCDZ2                                                 E20085
     I/COPY ZSRSRC,ZHOLI                                                  S01512
     I/COPY ZSRSRC,ZHOLDS                                                 S01512
     C/EJECT
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
      *
      ***  Initial Processing
     C/COPY WNCPYSRC,SE1440C003
      *
      * Book Position (LF/BKPCF)
      *
     C           KBKPC     KLIST
     C                     KFLD           CCSS
     C***********          KFLD           CCBR                            S01117
     C                     KFLD           CCBA                            S01117
     C                     KFLD           CCBK
     C                     KFLD           CCMK
     C                     KFLD           CCDT
      *                                                                   E21639
      * Book Position (LF/BKPOS)                                          E21639
      *                                                                   E21639
     C           KBKPOS    KLIST                                          E21639
     C                     KFLD           CCSS                            E21639
     C***********          KFLD           BHBR                     E21639 S01117
     C                     KFLD           BHBA                            S01117
     C                     KFLD           BHBK                            E21639
     C                     KFLD           BHMK                            E21639
     C                     KFLD           BHTV                            E21639
     C                     KFLD           CCDT                            E21639
      *
      * Book Position Header (LF/BKPHD)
      *
     C           KBKPH     KLIST
     C                     KFLD           CCSS
     C***********          KFLD           CCBR                            S01117
     C                     KFLD           CCBA                            S01117
     C                     KFLD           CCBK
     C                     KFLD           CCMK
     C                     KFLD           XXTV    1
     C                     MOVE 'V'       XXTV
      *
      * Investment Type (LF/INVTP)
      *
     C           KINV      KLIST
     C                     KFLD           CCNC
     C                     KFLD           SITP
      *
      **Security*Diary*(LF/SEDEV)**************************************   E20086
      *    (LF/SECEO)                                                     E20086
      ***  Security Diary in 'Security/Event Type/Reverse Date' order.    E20086
      *                                                                   E20086
     C           KSED      KLIST
     C                     KFLD           CCSS
     C***********          KFLD           MATY                            E20086
     C***********          KFLD           TYPE02  2                       E20086
     C                     KFLD           XSDET                           E20086
     C                     KFLD           XSDED                           E20086
      *
      * Accrue Interest on Book Positions
      *
     C           ACRFB     PLIST
     C***********          PARM           ICLD                            E16180
     C***********          PARM           LCPN                     E16180 E20085
     C                     PARM           ZZLCD                           E20085
     C                     PARM           CCDT
     C***********CCBR      PARM CCBR      #CCBR   30                      S01117
     C           CCBA      PARM CCBA      #CCBA   3                       S01117
     C                     PARM           CCSS
     C                     PARM           CCBK
     C                     PARM           CCMK
     C                     PARM           #NCDP
     C                     PARM           #AMT   150
     C                     PARM           FCAD             Fwd Called Amt S01220
      /EJECT
      *================================================================
      *
      ***  First Cycle Processing
      *
     C           *IN40     IFEQ '0'
      *
      * Prepare LDA for the database error output
      *
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C***********          IN   LDA                                       S01117
     C                     MOVEL*BLANK    DBLOT
     C***********          OUT  LDA                                       S01117
     C                     MOVEL'SE1440'  DBPGM
     C                     OUT  LDA                                       S01117
      *
      * Access the I.C.D. record 1  (PF/TABTB10)
      *
     C                     EXSR ZSYSTM
      *
      * Error in ZSYSTM
      *
     C           *IN99     IFEQ '1'
     C                     MOVE '1'       *INLR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'TABLE'   DBFILE           ***************
     C***********          MOVEL'01'      DBASE            **DB ERROR 01**S01117
     C                     Z-ADD1         DBASE            ***************S01117
     C                     MOVELZTABKY    DBKEY
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     OUT  LDA                                       S01117
     C                     SETON                     U7U8                 S01117
     C                     EXSR *PSSR                                     S01117
      *
     C                     ELSE
     C*                                                                   S01220
     C** Find if Strategic Risk Management module is present              S01220
     C*                                                                   S01220
     C***********          MOVE 'N'       RMRUN                     S01220S01393
     C                     MOVE 'N'       RMRUN   1                       S01393
     C*                                                                   S01220
     C                     CALL 'AOMMODR0'                                S01220
     C                     PARM '*MSG  '  @RTCD   7                       S01220
     C                     PARM '*FIRST ' @OPTN   7                       S01220
     C           SDMMOD    PARM SDMMOD    DSFDY                           S01220
     C*                                                                   S01220
     C           @RTCD     IFNE *BLANKS                                   S01220
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE '1'       *INLR            ***************S01220
     C***********          MOVEL'16'      DBASE            **DB ERROR 16**S01117
     C                     Z-ADD16        DBASE            ***************S01117
     C                     MOVEL'SDMMODPD'DBFILE                          S01220
     C                     MOVEL@OPTN     DBKEY                           S01220
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     ELSE                                           S01220
     C*                                                                   S01220
     C** Access ICD Record 2                                              S01220
     C*                                                                   S01220
     C           BGRKMG    IFEQ 'Y'                                       S01220
     C                     READ TABTB11F                 52               S01220
     C*                                                                   S01220
     C** If record not found, database error                              S01220
     C*                                                                   S01220
     C           *IN52     IFEQ '1'                                       S01220
     C                     MOVE '1'       *INLR            End of job     S01220
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'TABTB11 'DBFILE                          S01220
     C***********          MOVEL'14'      DBASE            ********S01220*S01117
     C                     Z-ADD14        DBASE            **DB ERROR 14**S01117
     C                     MOVEL*BLANK    DBKEY            ***************S01220
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C*                                                                   S01220
     C***Otherwise,*access*Risk*Management*ICD*file**************** S01220S01393
     C** Otherwise, this is Risk Management run                           S01393
     C*                                                                   S01220
     C                     ELSE                                           S01220
     C                     MOVE 'Y'       RMRUN                           S01393
     C***********          READ SDRISKL1                 52         S01220S01393
     C************************************************************* S01220S01393
     C***If*record*not*found,*database*error*********************** S01220S01393
     C************************************************************* S01220S01393
     C************IN52     IFEQ '1'                                 S01220S01393
     C***********          MOVE '1'       *INLR            End of j S01220S01393
     C************LOCK     IN   LDA                                 S01117S01393
     C***********          MOVEL'SDRISKL1'DBFILE           *********S01220S01393
     C***********          MOVEL'15'      DBASE            **S01220*S01117S01393
     C***********          Z-ADD15        DBASE            RROR 15**S01117S01393
     C***********          MOVEL*BLANK    DBKEY            *********S01220S01393
     C***********          SETON                     U7U8           S01117S01393
     C***********          OUT  LDA                                 S01117S01393
     C***********          EXSR *PSSR                               S01117S01393
     C********************************************************      S01220S01393
     C***Otherwise,*determine*if*RM*run*is*required***********      S01220S01393
     C**************(Next*RM*Run*Date*<*Date*of*Next*Workin***      S01220S01393
     C********************************************************      S01220S01393
     C***********          ELSE                                     S01220S01393
     C***********NRDT      IFLT DNWD                                S01220S01393
     C***********          MOVE 'Y'       RMRUN   1                 S01220S01393
     C***********          ELSE                                     S01220S01393
     C***********          MOVE 'N'       RMRUN                     S01220S01393
     C***********          END                                      S01220S01393
     C***********          END                                      E29031S01393
     C                     END                                            E29031
     C                     END                                            E29031
      *
      *  Hash Totals Output  HRWN  (15/0)   Whole Numbers
      *                      HRDC  (3/0)    Decimal Places
      *
     C                     Z-ADD0         HRWN   150
     C                     Z-ADD0         HRDC    30
      *
     C                     MOVE '1'       *IN40
     C           *LIKE     DEFN CFCT      CFDIF                           052254
     C           *LIKE     DEFN CCDT      WCCDT                           S01510
      *
     C***********          END                                     S01220 E29031
     C***********          END                                     S01220 E29031
     C***********          END                                     S01220 E29031
     C*                                                                   S01509
     C** Check if Value currency is active                                S01509
     C*                                                                   S01509
     C                     CALL 'AOSARDR0'                                S01509
     C                     PARM *BLANKS   @RTCD   7                       S01509
     C                     PARM '*VERIFY' @OPTN   7                       S01509
     C                     PARM 'S01509'  @SARD   6                       S01509
     C*                                                                   S01509
     C                     MOVE 'N'       S01509                          S01509
     C           @RTCD     IFEQ *BLANK                                    S01509
     C                     MOVE 'Y'       S01509  1                       S01509
     C                     ELSE                                           S01509
     C*                                                                   S01509
     C** database error (return code other than *NRF)                     S01509
     C*                                                                   S01509
     C           @RTCD     IFNE '*NRF   '                                 S01509
     C           *LOCK     IN   LDA                                       S01509
     C                     MOVEL'SCSARDPD'DBFILE           ***************S01509
     C                     MOVEL'*VERIFY' DBKEY            * DB ERROR 19 *S01509
     C                     Z-ADD19        DBASE            ***************S01509
     C                     OUT  LDA                                       S01509
     C                     SETON                     U7U8LR               S01509
     C                     EXSR *PSSR                                     S01509
     C                     END                                            S01509
     C                     END                                            S01509
     C*                                                                   S01510
     C** Check if Dividend Payments based on ex-date is active            S01510
     C*                                                                   S01510
     C                     CALL 'AOSARDR0'                                S01510
     C                     PARM *BLANKS   @RTCD   7                       S01510
     C                     PARM '*VERIFY' @OPTN   7                       S01510
     C                     PARM 'S01510'  @SARD   6                       S01510
     C*                                                                   S01510
     C                     MOVE 'N'       S01510                          S01510
     C           @RTCD     IFEQ *BLANK                                    S01510
     C                     MOVE 'Y'       S01510  1                       S01510
     C                     ELSE                                           S01510
     C*                                                                   S01510
     C** database error (return code other than *NRF)                     S01510
     C*                                                                   S01510
     C           @RTCD     IFNE '*NRF   '                                 S01510
     C           *LOCK     IN   LDA                                       S01510
     C                     MOVEL'SCSARDPD'DBFILE           ***************S01510
     C                     MOVEL'*VERIFY' DBKEY            * DB ERROR 20 *S01510
     C                     Z-ADD20        DBASE            ***************S01510
     C                     OUT  LDA                                       S01510
     C                     SETON                     U7U8LR               S01510
     C                     EXSR *PSSR                                     S01510
     C                     END                                            S01510
     C                     END                                            S01510
     C*                                                                   S01512
     C** Check if Dividend Payments based on ex-date is active            S01512
     C*                                                                   S01512
     C                     CALL 'AOSARDR0'                                S01512
     C                     PARM *BLANKS   @RTCD   7                       S01512
     C                     PARM '*VERIFY' @OPTN   7                       S01512
     C                     PARM 'S01512'  @SARD   6                       S01512
     C*                                                                   S01512
     C                     MOVE 'N'       S01512                          S01512
     C           @RTCD     IFEQ *BLANK                                    S01512
     C                     MOVE 'Y'       S01512  1                       S01512
     C                     ELSE                                           S01512
     C*                                                                   S01512
     C** database error (return code other than *NRF)                     S01512
     C*                                                                   S01512
     C           @RTCD     IFNE '*NRF   '                                 S01512
     C           *LOCK     IN   LDA                                       S01512
     C                     MOVEL'SCSARDPD'DBFILE           ***************S01512
     C                     MOVEL'*VERIFY' DBKEY            * DB ERROR 21 *S01512
     C                     Z-ADD21        DBASE            ***************S01512
     C                     OUT  LDA                                       S01512
     C                     SETON                     U7U8LR               S01512
     C                     EXSR *PSSR                                     S01512
     C                     END                                            S01512
     C                     END                                            S01512
     C*                                                                   S01512
     C                     MOVE 'N'       CSE078                                              CSE078
     C                     CALL 'AOSARDR0'                                                    CSE078
     C                     PARM '       ' @RTCD                                               CSE078
     C                     PARM '*VERIFY' @OPTN                                               CSE078
     C                     PARM 'CSE078'  WSARD   6                                           CSE078
      *                                                                                       CSE078
     C           @RTCD     IFEQ *BLANK                                                        CSE078
     C                     MOVE 'Y'       CSE078  1                                           CSE078
     C                     END                                                                CSE078
      *                                                                                       CSE078
      ** Check if Position/Risk Enquiries & Reports feature (CEU011)      CEU011
      ** is on.                                                           CEU011
      *                                                                   CEU011
     C                     CALL 'AOSARDR0'                                CEU011
     C                     PARM *BLANKS   @RTCD   7                       CEU011
     C                     PARM '*VERIFY' @OPTN   7                       CEU011
     C                     PARM 'CEU011'  @SARD   6                       CEU011
      *                                                                   CEU011
     C                     MOVE 'N'       CEU011                          CEU011
     C           @RTCD     IFEQ *BLANK                                    CEU011
     C                     MOVE 'Y'       CEU011  1                       CEU011
     C                     ELSE                                           CEU011
      *                                                                   CEU011
      ** database error (return code other than *NRF)                     CEU011
      *                                                                   CEU011
     C           @RTCD     IFNE '*NRF   '                                 CEU011
     C           *LOCK     IN   LDA                                       CEU011
     C                     MOVEL'SCSARDPD'DBFILE           ***************CEU011
     C                     MOVEL'CEU011 ' DBKEY            * DB ERROR 22 *CEU011
     C                     Z-ADD22        DBASE            ***************CEU011
     C                     OUT  LDA                                       CEU011
     C                     SETON                     U7U8LR               CEU011
     C                     EXSR *PSSR                                     CEU011
     C                     ENDIF                                          CEU011
     C                     ENDIF                                          CEU011
      *                                                                   CEU011
      ** Retrieve Ccy sort sequence no and store into array               CEU011
      ** to be used when writing record to PF/BPEVED.                     CEU011
      *                                                                   CEU011
     C********** CEU011    IFEQ 'Y'                                                    CEU011 241795
     C********** CSE078    OREQ 'Y'                                                    CSE078 241795
     C           CSE078    IFEQ 'Y'                                                           241795
     C                     Z-ADD1         S       30                      CEU011
     C           *LOVAL    SETLLSDCURRL1                                  CEU011
     C           *IN42     DOUEQ'1'                                       CEU011
     C                     READ SDCURRL1                 42               CEU011
     C           *IN42     IFEQ '0'                                       CEU011
     C                     MOVE A6CYCD    CUR,S                           CEU011
     C                     MOVE A6SSNB    SRT,S                           CEU011
     C                     ADD  1         S                               CEU011
     C                     ENDIF                                          CEU011
     C                     ENDDO                                          CEU011
     C                     ENDIF                                          CEU011
      *                                                                   CEU011
      *                                                                   CAC005
      ***  Check if CAC005 - PCA-SE Enhancement is on.                    CAC005
      *                                                                   CAC005
     C                     MOVE 'N'       CAC005  1                       CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   @RTCD   7                       CAC005
     C                     PARM '*VERIFY' @OPTN   7                       CAC005
     C                     PARM 'CAC005'  @SARD   6                       CAC005
      *                                                                   CAC005
     C           @RTCD     IFEQ *BLANK                                    CAC005
     C                     MOVE 'Y'       CAC005                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   187848
      ***  Check if CSE023 - Treaty Tax is on.                            187848
      *                                                                   187848
     C                     MOVE 'N'       CSE023  1                       187848
     C                     CALL 'AOSARDR0'                                187848
     C                     PARM *BLANKS   @RTCD   7                       187848
     C                     PARM '*VERIFY' @OPTN   7                       187848
     C                     PARM 'CSE023'  @SARD   6                       187848
      *                                                                   187848
     C           @RTCD     IFEQ *BLANK                                    187848
     C                     MOVE 'Y'       CSE023                          187848
     C                     ENDIF                                          187848
      *                                                                                       CSE035
      ** Access SAR details file to see if CSE035 is installed                                CSE035
      *                                                                                       CSE035
     C                     CALL 'AOSARDR0'                                                    CSE035
     C                     PARM *BLANKS   @RTCD   7                                           CSE035
     C                     PARM '*VERIFY' @OPTN   7                                           CSE035
     C                     PARM 'CSE035'  @SARD   6                                           CSE035
      *                                                                                       CSE035
     C           @RTCD     IFEQ *BLANK                                                        CSE035
     C                     MOVE 'Y'       CSE035  1                                           CSE035
     C                     ELSE                                                               CSE035
     C                     MOVE 'N'       CSE035                                              CSE035
     C                     ENDIF                                                              CSE035
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1440CCP1                                           S01408
      *                                                                   S01408
      ** Access SAR details file to see if CSE075 - Enhanced Treasury                         CSE075
      ** switchable feature is installed.                                                     CSE075
      *                                                                                       CSE075
     C                     CALL 'AOSARDR0'                                                    CSE075
     C                     PARM *BLANKS   PRTCD   7                                           CSE075
     C                     PARM '*VERIFY' POPTN   7                                           CSE075
     C                     PARM 'CSE075'  PSARD   6                                           CSE075
      *                                                                                       CSE075
     C                     MOVE 'N'       CSE075  1                                           CSE075
     C           PRTCD     IFEQ *BLANK                                                        CSE075
     C                     MOVE 'Y'       CSE075                                              CSE075
     C                     ELSE                                                               CSE075
      *                                                                                       CSE075
      ** Database Error (return code other than *NRF)                                         CSE075
      *                                                                                       CSE075
     C           PRTCD     IFNE '*NRF   '                                                     CSE075
     C           *LOCK     IN   LDA                                                           CSE075
     C                     MOVEL'SCSARDPD'DBFILE                                              CSE075
     C                     MOVEL'CSE075 ' DBKEY                                               CSE075
     C                     Z-ADD23        DBASE                                               CSE075
     C                     OUT  LDA                                                           CSE075
     C                     MOVE *ON       *INU7                                               CSE075
     C                     MOVE *ON       *INU8                                               CSE075
     C                     MOVE *ON       *INLR                                               CSE075
     C                     EXSR *PSSR                                                         CSE075
     C                     ENDIF                                                              CSE075
     C                     ENDIF                                                              CSE075
      *                                                                                       CSE075
     C                     END                                            S01220
     C                     END
     C                     END
      *
      *================================================================
      /EJECT
      *================================================================
     C/COPY WNCPYSRC,SE1440C001
      *
      *  L E V E L    B R E A K  ---   S E C U R I T Y
      *
      *   Access Securities details file  (LF/SECTY)
      *    at change of the Secrity Shortname (LF/SECEF - CCSS)
      *
     C           *INL1     IFEQ '1'
     C           *IN40     ANDEQ'1'
     C           CCSS      CHAINSECTY                52
      *
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     MOVE '1'       *IN52
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE '1'       *INLR            ***************
     C***********          MOVEL'02'      DBASE            * DB ERROR 02 *S01117
     C                     Z-ADD2         DBASE            * DB ERROR 02 *S01117
     C                     MOVEL'SECTY'   DBFILE           ***************
     C                     MOVELCCSS      DBKEY
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     ELSE
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1440CCP2                                           S01408
      *                                                                   S01408
      *
      *   Set >  CCEC - Event Ccy  (ie. Settlement Ccy)  to Equal
      *         Payment Ccy (if non-blank), else Value Ccy (if non-balnk),
      *         else Nominal Ccy. (LF/SECTY)
      *
     C** If S01509 is active, do not set up event currency at change      S01509
     C** in security                                                      S01509
     C*                                                                   S01509
     C           S01509    IFEQ 'N'                                       S01509
     C                     MOVE CCNC      CCEC
     C           VLCY      IFNE '   '
     C                     MOVE VLCY      CCEC
     C                     END
     C           SPYC      IFNE '   '
     C                     MOVE SPYC      CCEC
     C                     END
     C                     END                                            S01509
      *
      *   Set >  #NCDP  - Nominal Ccy Decimal Positions.
      *
     C                     MOVE *BLANKS   KEY
     C                     MOVEL'20'      KEY
     C                     MOVE '1'       ZWK4
     C                     MOVELCCNC      ZWK4    4
     C                     MOVE ZWK4      KEY
      *
     C           KEY       CHAINTABTG10F             52
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     MOVE '1'       *INLR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE '1'       *IN52            ***************
     C***********          MOVEL'03'      DBASE            * DB ERROR 03 *S01117
     C                     Z-ADD3         DBASE            * DB ERROR 03 *S01117
     C                     MOVEL'TABTG10F'DBFILE           ***************
     C                     MOVELKEY       DBKEY
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     ELSE
     C                     MOVE CDP       #NCDP   10
     C                     MOVE CDP       #ECDP                                             BUG11199
      *
      *  Set  >  #ECDP  - Event Ccy Decimal Positions.
     C** If S01509 is active, this processs should be performed later     S01509
     C*                                                                   S01509
     C           S01509    IFEQ 'N'                                       S01509
     C                     MOVELCCEC      ZWK4    4
     C                     MOVE ZWK4      KEY
      *
     C           KEY       CHAINTABTG10F             52
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     MOVE '1'       *INLR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE '1'       *IN52            ***************
     C***********          MOVEL'04'      DBASE            * DB ERROR 04 *S01117
     C                     Z-ADD4         DBASE            * DB ERROR 04 *S01117
     C                     MOVEL'TABTG10F'DBFILE           ***************
     C                     MOVELKEY       DBKEY
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     ELSE
     C                     MOVE CDP       #ECDP   10
     C                     END
     C                     END                                            S01509
      *
     C                     END
     C                     END
      *
      *  Set  >  PROT   - Processing Type from the Investment Type's Rec.
     C                     MOVE ' '       PROT
      *
     C           *IN52     IFEQ '0'
     C           KINV      CHAININVTP                52
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     MOVE '1'       *INLR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE '1'       *IN52            ***************
     C***********          MOVEL'05'      DBASE            * DB ERROR 05 *S01117
     C                     Z-ADD5         DBASE            * DB ERROR 05 *S01117
     C                     MOVEL'INVTP   'DBFILE           ***************
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     MOVELCCNC      WRK6    6
     C                     MOVE SITP      WRK6
     C                     MOVELWRK6      DBKEY
     C                     END
     C                     END
      *
      *  Check if Interest Bearing Security
     C                     MOVE 'N'       #INTR   1
      *
     C           DYBS      IFNE '4'
     C           STBS      ANDNE'D'                                       E21514
     C           *IN52     ANDEQ'0'
      *
     C           PROT      IFEQ '1'
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '6'
     C           PROT      OREQ '8'
     C           PROT      OREQ '9'                                       S01176
     C                     MOVE 'Y'       #INTR
     C                     END
     C                     END
     C*                                                                   S01220
     C** If RM run required AND the processing type of the security is    S01220
     C** not '8', set RM processing flag to 'Y'                           S01220
     C*                                                                   S01220
     C           RMRUN     IFEQ 'Y'                                       S01220
     C           PROT      ANDNE'8'                                       S01220
     C                     MOVE 'Y'       RMPROC  1                       S01220
     C*                                                                   S01220
     C** Otherwise, set RM processing flag to 'N'                         S01220
     C*                                                                   S01220
     C                     ELSE                                           S01220
     C                     MOVE 'N'       RMPROC                          S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C                     END
      *                                                                   187848
      ** If CSE023 is switched ON, check if the event is affected by      187848
      ** Treaty tax changes with position settlement being genertated.    187848
      *                                                                   187848
     C                     MOVE 'Y'       NEEDED  1                       187848
     C           CSE023    IFEQ 'Y'                                       187848
     C           CRTT      ANDNE*BLANK                                    187848
      *                                                                   187848
      ** For Dividend event, if position settlement already generated     187848
      ** then donot process the event.                                    187848
      *                                                                   187848
     C           *IN11     IFEQ '1'                                       187848
     C           CCET      ANDEQ'DV'                                      187848
     C           SDDT      ANDNE0                                         187848
     C                     MOVE 'N'       NEEDED                          187848
     C                     ENDIF                                          187848
      *                                                                   187848
      ** For Coupon event, if position settlement already generated       187848
      ** then donot process the event.                                    187848
      *                                                                   187848
     C           *IN12     IFEQ '1'                                       187848
     C           CCET      IFEQ 'CP'                                      187848
     C           CCET      OREQ 'MA'                                      187848
     C           CCET      IFEQ 'CP'                                      187848
     C                     MOVE 'CG'      XSDET                           187848
     C                     ELSE                                           187848
     C                     MOVE 'MG'      XSDET                           187848
     C                     ENDIF                                          187848
     C                     Z-ADDCCDT      XSDED                           187848
     C           KSED      CHAINSECEO                44                   187848
     C           *IN44     IFEQ '0'                                       187848
     C                     MOVE 'N'       NEEDED                          187848
     C                     ELSE                                           187848
     C                     MOVE CCET      XSDET                           187848
     C           KSED      CHAINSECEO                44                   187848
     C           *IN44     IFEQ '0'                                       187848
     C                     MOVE 'N'       NEEDED                          187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
      *
      *================================================================
      /EJECT
      *================================================================
      *
      ***  Main Processing
      *
      ** Maintain the 'transactions read' count.                          187848
      *                                                                   187848
     C           *IN40     IFEQ '1'                                       187848
     C           *IN52     ANDEQ'0'                                       187848
     C           *IN11     IFEQ '1'                                       187848
      *                                                                   187848
      ** Diary Event                                                      187848
      *                                                                   187848
     C                     ADD  1         IN01    50                      187848
     C                     ELSE                                           187848
      *                                                                   187848
      ** Non-Diary Event                                                  187848
      *                                                                   187848
     C           *IN12     IFEQ '1'                                       187848
     C                     ADD  1         IN02    50                      187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
      *                                                                   187848
     C           *IN40     IFEQ '1'
     C           *IN52     ANDEQ'0'
     C           NEEDED    ANDEQ'Y'                                       187848
     C*                                                                   S01509
     C** If S01509 is active, set up the event currency and number of     S01509
     C** decimal places after every event read from SECEFRM as follows    S01509
     C*                                                                   S01509
     C           S01509    IFEQ 'Y'                                       S01509
     C                     SELEC                                          S01509
     C           CCET      WHEQ 'DV'                                      S01509
     C           CCET      OREQ 'DE'                                      S01509
     C           CCET      OREQ 'CP'                                      S01509
     C                     MOVE VLCY      CCEC                            S01509
     C           CCET      WHEQ 'MA'                                      S01509
     C                     MOVE 'RC'      XSDET                           S01509
     C                     Z-ADDMATY      XSDED                           S01509
     C           KSED      CHAINSEDEVDO              51                   S01509
     C           *IN51     IFEQ '0'                                       S01509
     C           XSDCX     ANDNE*BLANKS                                   S01509
     C                     MOVE XSDCX     CCEC                            S01509
     C                     ELSE                                           S01509
     C                     MOVE CCNC      CCEC                            S01509
     C                     END                                            S01509
     C                     OTHER                                          S01509
     C                     MOVE CCNC      CCEC                            S01509
     C                     ENDSL                                          S01509
     C*                                                                   S01509
     C** If the event currency is different from the nominal currency     S01509
     C** get the number of decimal places (#ECDP) for this currency       S01509
     C*                                                                   S01509
     C           CCNC      IFNE CCEC                                      S01509
     C                     MOVE *BLANKS   KEY                             S01509
     C                     MOVEL'20'      KEY                             S01509
     C                     MOVE '1'       ZWK4                            S01509
     C                     MOVELCCEC      ZWK4    4                       S01509
     C                     MOVE ZWK4      KEY                             S01509
     C*                                                                   S01509
     C           KEY       CHAINTABTG10F             52                   S01509
     C           *IN52     IFEQ '1'                                       S01509
     C           RECI      ORNE 'D'                                       S01509
     C                     MOVE '1'       *INLR                           S01509
     C           *LOCK     IN   LDA                                       S01509
     C                     MOVE '1'       *IN52            ***************S01509
     C                     Z-ADD21        DBASE            * DB ERROR 21 *S01509
     C                     MOVEL'TABTG10F'DBFILE           ***************S01509
     C                     MOVELKEY       DBKEY                           S01509
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01509
     C                     OUT  LDA                                       S01509
     C                     EXSR *PSSR                                     S01509
     C                     ELSE                                           S01509
     C                     MOVE CDP       #ECDP   10                      S01509
     C                     END                                            S01509
     C                     END                                            S01509
     C*                                                                   S01509
     C                     END                                            S01509
      *
      ** Transaction count being moved forwards.                          187848
      *                                                                   187848
      **Maintain*the*'transactions*read'*count.                           187848
      ***********                                                         187848
     C************IN11     IFEQ '1'                                       187848
      *****Diary*Event                                                    187848
     C***********          ADD  1         IN01    50                      187848
     C***********          ELSE                                           187848
      *****Non-Diary*Event                                                187848
     C************IN12     IFEQ '1'                                S01220 187848
     C***********          ADD  1         IN02    50                      187848
     C***********          END                                     S01220 187848
     C***********          END                                            187848
      *
      * Omit UNWANTED Events
     C** Include AC and RC events if RM run required                      S01220
     C** NB. AC events are only held on PF/SRMNDE so will only be         S01220
     C**    processed if RM run required                                  S01220
     C**    RC events only included if Include Redemption Call in         S01220
     C**    Risk Analysis Cashflow flag is 'Y'                            S01220
      *
     C           CCET      IFEQ 'PP'
     C           CCET      OREQ 'CP'
     C***********CCET      OREQ 'DV'                                      E21639
     C***********CCET      OREQ 'DE'                                      E21639
     C           CCET      OREQ 'MP'
     C           CCET      OREQ 'MA'
     C           CCET      OREQ 'AC'                                      S01220
     C           CCET      OREQ 'RC'                                      S01220
     C           RMRUN     ANDEQ'Y'                                       S01220
     C           RCIC      ANDEQ'Y'                                       S01220
     C*                                                                   S01220
     C** If RM run not required, only process events from PF/SEDEVD and   S01220
     C** PF/SNDEVD                                                        S01220
     C** If RM run required, process all events                           S01220
     C*                                                                   S01220
     C           RMRUN     IFEQ 'N'                                       S01220
     C           *IN13     ANDNE'1'                                       S01220
     C           RMRUN     OREQ 'Y'                                       S01220
      *
      *   Access all Book Positions for this Securiry
      *
     C                     MOVE '0'       *IN50
     C           CCSS      SETLLPIBKPD
      *
      ***  Do Until End of File or DB Error
      *
     C           *IN50     DOUEQ'1'
     C           *IN52     OREQ '1'
      *
     C***********          Z-ADD0         CCBR                            S01117
     C                     MOVE *BLANKS   CCBA                            S01117
     C           CCSS      READEPIBKPDF                  50
      *
      * Maintain the 'Positions read' count.
      *
     C           *IN50     IFEQ '0'
     C*                                                                   S01220
     C** Do not include events read from PF/SRMNDE or events with event   S01220
     C** type 'RC' in the book position count                             S01220
     C*                                                                   S01220
     C           *IN13     IFNE '1'                                       S01220
     C           CCET      ANDNE'RC'                                      S01220
      *                                                                   S01220
     C                     ADD  1         PCNT    50
      *                                                                   S01220
     C                     END                                            S01220
      *
      * Access Book Position Header (LF/BKPHD)
      *  for Interest Bearing Securities
      *
     C                     Z-ADD0         ICLD
     C***********          Z-ADD0         IACR                            E23955
      *
     C           #INTR     IFEQ 'Y'
      *
     C           RETRY     TAG                             *** RETRY  ***
     C           KBKPH     CHAINBKPHDDF              52
      *
     C           *IN52     IFEQ '1'
      *
     C           XXTV      IFEQ 'V'
     C                     MOVE 'T'       XXTV
     C                     GOTO RETRY
     C                     END
      *
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE '1'       *INLR            ***************
     C***********          MOVEL'06'      DBASE            **DB*ERROR*06**E20651
     C***********          MOVEL'11'      DBASE            * DB 1 *E20651 S01117
     C                     Z-ADD11        DBASE            * DB ERROR 11 *S01117
     C                     MOVEL'BKPHD   'DBFILE           ***************
     C                     MOVELBKPH      DBKEY
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     END
     C                     MOVE 'V'       XXTV
     C                     END
      *
      * Obtain Position at Event Date (LF/BKPCF)
      * Set up Output field values :
      * Write a record to the event's file
      *
     C************IN52     CASEQ'0'       SROUT                           S01220
     C***********          END                                            S01220
      *
     C** If event record is not from PF/SRMNDE AND the event type is      S01220
     C** not 'RC', execute SR. SROUT to write event to PF/BPEVED          S01220
     C*                                                                   S01220
     C           *IN52     IFEQ '0'                                       S01220
     C           *IN13     IFEQ '0'                                       S01220
     C           CCET      ANDNE'RC'                                      S01220
     C                     EXSR SROUT                                     S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C** If RM processing flag is 'Y', execute SR. SRRMS to write event   S01220
     C** to PF/RMSPEVP                                                    S01220
     C*                                                                   S01220
     C           RMPROC    IFEQ 'Y'                                       S01220
     C                     EXSR SRRMS                                     S01220
     C                     END                                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C                     END
     C                     END
     C                     END                                            S01220
     C                     END
      *                                                                   E21639
      * Process dividend events using trade date positions                E21639
      *                                                                   E21639
     C           CCET      IFEQ 'DV'                                      E21639
     C           CCET      OREQ 'DE'                                      E21639
     C*                                                                   S01220
     C** If RM run not required, only process events from PF/SEDEVD and   S01220
     C** PF/SNDEVD                                                        S01220
     C** If RM run required, process all events                           S01220
     C*                                                                   S01220
     C           RMRUN     IFEQ 'N'                                       S01220
     C           *IN13     ANDNE'1'                                       S01220
     C           RMRUN     OREQ 'Y'                                       S01220
      *                                                                   E21639
      *   Access all Book Positions for this Security                     E21639
      *                                                                   E21639
     C                     MOVE '0'       *IN50                           E21639
     C           CCSS      SETLLBKPHD                                     E21639
      *                                                                   E21639
      ***  Do Until End of File                                           E21639
      *                                                                   E21639
     C           *IN50     DOUEQ'1'                                       E21639
      *                                                                   E21639
     C***********          Z-ADD0         CCBR                     E21639 S01117
     C***********          MOVE *BLANKS   CCBA                      S01117E33157
     C           CCSS      READEBKPHD                    50               E21639
     C                     MOVELBHBA      CCBA                            E34185
     C                     MOVELBHBK      CCBK                            E34185
     C                     MOVELBHMK      CCMK                            E34185
      *                                                                   E21639
      * Maintain the 'Positions read' count.                              E21639
      *                                                                   E21639
     C           *IN50     IFEQ '0'                                       E21639
     C           BHTV      ANDEQ'T'                                       E21639
     C*                                                                   S01220
     C** Do not include events read from PF/SRMNDE in the book position   S01220
     C** count or PF/BPEVED                                               S01220
     C*                                                                   S01220
     C           *IN13     IFEQ '0'                                       S01220
     C                     ADD  1         PCNT    50                      E21639
      *                                                                   E21639
      * Obtain Position at Event Date (LF/BKPOS)                          E21639
      * Set up Output field values :                                      E21639
      * Write a record to the event's file                                E21639
      *                                                                   E21639
     C                     EXSR SROUT                                     E21639
     C                     END                                            S01220
     C*                                                                   S01220
     C** If RM processing flag is 'Y', execute SR. SRRMS to write event   S01220
     C** to PF/RMSPEVP                                                    S01220
     C*                                                                   S01220
     C           RMPROC    IFEQ 'Y'                                       S01220
     C                     EXSR SRRMS                                     S01220
     C                     END                                            S01220
      *                                                                   E21639
     C                     END                                            S01220
     C                     END                                            E21639
     C                     END                                            E21639
     C                     END                                            E21639
     C                     END
     C/COPY WNCPYSRC,SE1440C002
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *                                                               *
     CLR                   EXSR SRLR
      *                                                               *
      *================================================================
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRHASH - Subroutine to add Event Amounts To Hash Totals      *
      *           (Determine Dec. Posn. and ADD as Positive Values)   *
      *                                                               *
      *       Input   #HAMT (15/0)   Un-edited Amount                 *
      *       Output  HRWN  (15/0)   Whole Numbers                    *
      *               HRDC   (3/0)   Decimal Places                   *
      *                                                               *
      *****************************************************************
      *
     C           SRHASH    BEGSR                           *** SRHASH ***
      *
      *    Set up fields to be hashed as positive
      *
     C           #HAMT     IFGE 0
     C                     Z-ADD#HAMT     #HAMT  150
     C                     ELSE
     C                     Z-SUB#HAMT     #HAMT
     C                     END
      *
      *   Split up the Hash Amount as Integer and Decimal parts
      *
     C                     MOVEL#HAMT     #HI    120
     C                     MOVE #HAMT     #HD     30
      *
      *   Add to the DECIMAL HASH TOTAL part and check for carry
      *
     C                     ADD  #HD       HRDC    30
      *
     C           HRDC      IFLT #HD
     C                     ADD  1         #HI
     C                     END
      *
      *   Add to the INTEGER HASH TOTAL part
      *
     C                     ADD  #HI       HRWN   150
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SROUT  - Subroutine to obtain 'Position At Event Date', Set  *
      *           up data for the Event record and write this record  *
      *           to the Events file (PF/BPEVEDF).                    *
      *                                                               *
      *****************************************************************
      *
     C           SROUT     BEGSR                           *** SROUT ***
      *
      * Obtain Position at Event Date (LF/BKPCF)
      *   If record found, calculate 'Position' (CCNP), and 'Cum Coupon
      *****/Dividend Nom.**(#CCDM*-*9/4),*Else*set*both*to*EQ*zero.****   E20085
      *    /Dividend Nom.' (#CCDM - 15/4), Else set both to EQ zero.      E20085
      *
     C                     Z-ADD0         CCNP
     C                     Z-ADD0         CCEP
     C***********          Z-ADD0         #CCDM   94                      E20085
     C                     Z-ADD0         #CCDM  154                      E20085
     C                     MOVE CCBA      EBRC                            E33042
     C*                                                                   E33042
     C**********           CALL 'AOBRCHR0'                                             E33042 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C***********          PARM *BLANKS   @PARM   7                E33042 076214
     C                     PARM *BLANKS   @RTCD   7                       076214
     C                     PARM '*KEY   ' @OPTN   7                       E33042
     C                     PARM CCBA      @BRKEY  3                       E33042
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        E33042 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   E33042
     C           @RTCD     IFNE *BLANKS                                   E33042
     C           *LOCK     IN   LDA                                       E33042
     C                     Z-ADD6         DBASE            ***************E33042
     C                     MOVELCCBA      DBKEY            * DB ERROR 06 *E33042
     C                     MOVEL'SDBRCHPD'DBFILE           ***************E33042
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     OUT  LDA                                       E33042
     C                     SETON                     U7U8LR               E33042
     C                     EXSR *PSSR                                     E33042
     C                     ELSE                                           E33042
     C                     MOVELA8CMCD    COBB                            E33042
     C                     END                                            E33042
      *                                                                   E21639
      ** Save book value read from LF/BKPHD                               103070
     C                     MOVE BHBK      WKSAV1  2                       103070
      *                                                                   103070
      * If dividend event access trade date position                      E21639
      *                                                                   E21639
     C           CCET      IFEQ 'DV'                                      E21639
     C           CCET      OREQ 'DE'                                      E21639
     C*                                                                   S01510
     C** If S01510 is active and type 'DV', use ex-date for access        S01510
     C*                                                                   S01510
     C                     MOVE '0'       *IN54                           S01510
     C           S01510    IFEQ 'Y'                                       S01510
     C           CCET      ANDEQ'DV'                                      S01510
     C                     Z-ADDCCDT      WCCDT                           S01510
     C                     Z-ADDSDXD      CCDT                            S01510
     C                     MOVE '1'       *IN54                           S01510
     C                     END                                            S01510
      *                                                                   E21639
     C           KBKPOS    SETLLBKPOS                                     E21639
     C                     READPBKPOS                    50               E21639
      *                                                                   E21639
     C           *IN50     IFEQ '0'                                       E21639
     C           CCSS      ANDEQBPSC                                      E21639
     C***********BHBR      ANDEQCCBR                               E21639 S01117
     C           BHBA      ANDEQCCBA                                      S01117
     C           BHBK      ANDEQCCBK                                      E21639
     C           BHMK      ANDEQCCMK                                      E21639
     C           BHTV      ANDEQBPTV                                      E21639
     C                     Z-ADDNPSN      CCNP                            E21639
     C                     Z-ADDECNP      CCEP                            E21639
     C           *IN54     IFEQ '1'                                       S01510
     C                     Z-ADDNPSN      #CCDM                           S01510
     C                     Z-ADDWCCDT     CCDT                            S01510
     C                     ELSE                                           S01510
     C           NPSN      SUB  ECNP      #CCDM                           E21639
     C                     END                                            S01510
      *                                                                   103070
      ** If book field(BPBK renamed CCBK) from LF/BKPOS not equal to      103070
      ** Book field(BHBK) from LF/BKPHD then move BHBK into CCBK          103070
      ** preventing DB Error 07.                                          103070
      *                                                                   103070
     C                     ELSE                                           103070
     C                     MOVE WKSAV1    CCBK                            103070
     C                     END                                            E21639
      *                                                                   E21639
     C                     ELSE                                           E21639
      *                                                                   E21639
      * access value date position                                        E21639
      *
     C** Disregard position changes on event date.                        E20085
     C***********KBKPC     SETGTBKPCF                                     E20085
     C           KBKPC     SETLLBKPCF                                     E20085
     C                     READPBKPCF                    50
      *
     C           *IN50     IFEQ '0'
     C           BOOK      ANDEQBOOK1
     C                     Z-ADDNPSN      CCNP
      *                                                                   E29978
      ***  If the Position Date precedes the Last Coupon Date, then do    E29978
      ***  not deduct Ex-Coupon Nominal from the total Position.          E29978
     C***  (Need to recaluclate Last Coupon date before event date as     099890
     C***   LCPN already updated with the new Coupon date)                099890
      *                                                                   E29978
     C           CCDT      SUB  1         ZECD                            099890
     C                     EXSR ZLCD                                      099890
      *                                                                   099890
     C***********BPPD      IFLT LCPN                               E29978 099890
     C           BPPD      IFLT ZZLCD                                     099890
     C                     Z-ADD0         ECNP                            E29978
     C                     END                                            E29978
      *                                                                   E29978
     C                     Z-ADDECNP      CCEP
     C           NPSN      SUB  ECNP      #CCDM
      *                                                                   103070
      ** If book field(BPBK) from LF/BKPCF not equal to                   103070
      ** Book field(BHBK) from LF/BKPHD then move BHBK into CCBK          103070
      ** preventing DB Error 07.                                          103070
      *                                                                   103070
     C                     ELSE                                           103070
     C                     MOVE WKSAV1    CCBK                            103070
     C                     END
      *
     C                     END                                            E21639
     C                     MOVE '0'       *IN50
      *
      * Set up Output field values :
      *
      *   Set >  CCNA - Event Amount in Nominal Currency.
      ********>**CCAN*-*Coupon*Amount*in*Nominal*Currency.*(MP,*MA*only)  E20085
      *       >  CCCE - Event Code
      *
     C                     Z-ADD0         #NAMT  150
     C                     Z-ADD0         #EAMT  150
     C***********          Z-ADD0         #CAMT  150                      E23955
     C                     MOVE '    '    CCCE
      *
      ***  Security Diary and Non-Diary Events
      *
     C           CCET      CASEQ'DV'      SRDV
     C           CCET      CASEQ'DE'      SRDE
     C           CCET      CASEQ'PP'      SRPP
     C           CCET      CASEQ'MP'      SRMP
     C           CCET      CASEQ'CP'      SRCP
     C           CCET      CASEQ'MA'      SRMA
     C                     END
      *
      *  Check for Data Base Error from Called Program
      *
     C           *INU7     IFEQ '1'
     C           *INU8     OREQ '1'
     C                     MOVE '1'       *INLR
     C                     MOVE '1'       *IN52
     C                     MOVE '1'       *IN53
     C                     END
      *
     C                     Z-ADD#NAMT     CCNA   150
     C***********          Z-ADD#CAMT     CCAN   150                      E23955
      *
      *   Set >  CCEA - Event Amount in  Event Ccy
      *          to EQ  Event Amt in Nominal Ccy, If Event Ccy EQ Nom Ccy
      *          else   convert using the ZCONV routine.
      *
     C                     Z-ADD0         CCEA
     C           CCET      IFEQ 'DE'
     C                     Z-ADD#EAMT     CCEA
     C                     ELSE
      *
     C           CCNA      IFNE 0
     C           *IN52     ANDEQ'0'
      *
     C           CCNC      IFEQ CCEC
     C                     Z-ADDCCNA      CCEA
     C                     ELSE
     C*                                                                   S01509
     C** If S01509 is active, do not perform conversion for type 'DV'     S01509
     C*                                                                   S01509
     C           S01509    IFEQ 'Y'                                       S01509
     C           CCET      ANDEQ'DV'                                      S01509
     C                     Z-ADDCCNA      CCEA                            S01509
     C                     ELSE                                           S01509
      *
      ***  Nominal Currency, Event Currency, Amount (Nominal Currency),
      ***  Exchange Rate, Multiply/Divide Indicator.
     C                     MOVE CCNC      ZCCYI
     C                     Z-ADD#NCDP     ZCDPI                           S01117
     C                     MOVE CCEC      ZCCYO
     C                     Z-ADD#ECDP     ZCDPO                           S01117
     C                     Z-ADDCCNA      ZAMTCI
     C*                                                                   S01509
     C** If S01509 is active, exchange rate may vary                      S01509
     C** ... if 'CP', set to the value from the latest 'XR' event         S01509
     C** ... if 'MA', set to the value from the 'RC' event                S01509
     C*                                                                   S01509
     C           S01509    IFEQ 'Y'                                       S01509
     C*                                                                   S01509
     C           CCET      IFEQ 'CP'                                      S01509
     C                     MOVE 'XR'      XSDET                           S01509
     C                     Z-ADDCCDT      XSDED                           S01509
     C           KSED      SETLLSEDEVDO                                   S01509
     C                     READ SEDEVDO                  55               S01509
     C           *IN55     IFEQ '1'                                       S01509
     C           XSDSN     ORNE CCSS                                      S01509
     C           XSDET     ORNE 'XR'                                      S01509
     C                     Z-ADDSEXR      ZEXCH                           S01509
     C                     MOVE SMDI      ZMD                             076693
     C                     ELSE                                           S01509
     C                     Z-ADDXSDCE     ZEXCH                           S01509
     C                     MOVE XSDMD     ZMD                             076693
     C                     END                                            S01509
     C                     END                                            S01509
     C*                                                                   S01509
     C           CCET      IFEQ 'MA'                                      S01509
     C                     MOVE XSDCE     ZEXCH                           S01509
     C                     MOVE XSDMD     ZMD                             076693
     C                     END                                            S01509
     C*                                                                   S01509
     C                     ELSE                                           S01509
     C                     Z-ADDSEXR      ZEXCH
     C***********          END                                     S01509 076693
     C                     MOVE SMDI      ZMD
     C                     END                                            076693
     C*                                                                   076693
     C                     EXSR ZCONV
      *
     C************INU8     IFEQ '1'                                       S01117
     C***********          MOVE '1'       *IN52                           S01117
     C***********          MOVE '1'       *INLR            ***************S01117
     C***********          MOVEL'06'      DBASE            **DB*ERROR*06**E20651
     C***********          MOVEL'12'      DBASE            * DB 2 *E20651 S01117
     C***********          MOVEL'ZCONV   'DBFILE           ***************S01117
     C***********          MOVELTKEY      DBKEY                           S01117
     C***********          ELSE                                           S01117
     C                     Z-ADDZAMTCO    CCEA
     C***********          END                                            S01117
     C                     END
     C                     END                                            S01509
     C                     END
     C                     END
      *
      ****Set*>**CCAS*-*Coupon*Amount*in**Settl*Ccy********************   E23955
      *
     C                     Z-ADD0         CCAS
     C***********CCAN      IFNE 0                                         E23955
     C************IN52     ANDEQ'0'                                       E23955
      ***********                                                         E23955
     C***********CCNC      IFEQ CCEC                                      E23955
     C***********          Z-ADDCCAN      CCAS                            E23955
     C***********          ELSE                                           E23955
     C***********          MOVE CCNC      ZCCYI                           E23955
     C***********          MOVE CCEC      ZCCYO                           E23955
     C***********          Z-ADDCCAN      ZAMTCI                          E23955
     C***********          Z-ADDSEXR      ZEXCH                           E23955
     C***********          MOVE SMDI      ZMD                             E23955
     C***********          EXSR ZCONV                                     E23955
      ***********                                                         E23955
     C************INU8     IFEQ '1'                                       E23955
     C***********          MOVE '1'       *IN52                           E23955
     C***********          MOVE '1'       *INLR            ***************E23955
     C***********          MOVEL'06'      DBASE            **DB*ERROR*06**E20651
     C***********          MOVEL'13'      DBASE            **DB ERROR 13**E23955
     C***********          MOVEL'ZCONV   'DBFILE           ***************E23955
     C***********          MOVELTKEY      DBKEY                           E23955
     C***********          ELSE                                           E23955
     C***********          Z-ADDZAMTCO    CCAS                            E23955
     C***********          END                                            E23955
     C***********          END                                            E23955
     C***********          END                                            E23955
      *
     C           *IN52     IFEQ '0'
      *
      *   Set >  CCFB - Due TO, FROM Book indicator
      *       >  CCIO - Incoming/Outgoing indicator
      *
     C                     MOVE ' '       CCFB
     C                     MOVE ' '       CCIO
      *
      ***  PP Call
     C           CCET      IFEQ 'PP'
     C           CCNA      IFGE 0
     C                     MOVE 'F'       CCFB
     C                     ELSE
     C                     MOVE 'T'       CCFB
     C                     Z-SUBCCNA      CCNA                            E19101
     C                     Z-SUBCCEA      CCEA                            E19101
     C                     END
     C                     END
      *
     C           CCET      IFEQ 'CP'
     C           CCET      OREQ 'DV'
     C           CCET      OREQ 'DE'
     C           CCET      OREQ 'MA'
     C           CCET      OREQ 'MP'
     C           CCNA      IFGE 0
     C                     MOVE 'T'       CCFB
     C                     ELSE
     C                     MOVE 'F'       CCFB
     C                     Z-SUBCCNA      CCNA                            E19101
     C                     Z-SUBCCEA      CCEA                            E19101
     C                     END
     C                     END
      *
     C           CCFB      IFEQ 'T'
      ***  Outgoing
     C                     MOVE 'I'       CCIO
     C                     END
     C           CCFB      IFEQ 'F'
      ***  Incoming
     C                     MOVE 'O'       CCIO
     C                     END
      *
      *   Set >  CCBD - Book Description
      *
     C                     MOVE *BLANKS   CCBD
     C                     MOVELCCBK      WBOOK   2                       CAC005
      *                                                                   CAC005
      ** If CAC005 is on, retrieve user book from AOBKPCR0.               CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C           PMBKCD    PARM *BLANKS   PMBKCD  2                       CAC005
     C           PMPRFC    PARM *BLANKS   PMPRFC  4                       CAC005
     C                     PARM CCBK      PMPSBK  2                       CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMBKCD    WBOOK                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *
     C***********CCBK      CHAINBOOKDDF              52                   E24075
     C***********BHBK      CHAINBOOKDDF              52            E24075 060719
     C***********CCBK      CHAINBOOKDDF              52            060719 CAC005
     C           WBOOK     CHAINBOOKDDF              52                   CAC005
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     MOVE '1'       *INLR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE '1'       *IN52            ***************
     C***********          MOVEL'07'      DBASE            **DB ERROR 07**S01117
     C                     Z-ADD7         DBASE            **DB ERROR 07**S01117
     C                     MOVEL'BOOKD   'DBFILE           ***************
     C***********          MOVELCCBK      DBKEY                           E24075
     C***********          MOVELBHBK      DBKEY                    E24075 060719
     C***********          MOVELCCBK      DBKEY                    060719 CAC005
     C                     MOVELWBOOK     DBKEY                           CAC005
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     END
     C                     END
      *
      * Set > Maturity Date Indicator                                     S01176
      *                                                                   S01176
     C           CCET      IFNE 'MA'                                      S01176
     C                     MOVE *BLANKS   MDTI                            S01176
     C                     END                                            S01176
     C*                                                                   S01512
     C** Setup payment date for Coupon event                              S01512
     C*                                                                   S01512
     C                     Z-ADDCCDT      CCPD                            S01512
     C           S01512    IFEQ 'Y'                                       S01512
     C           CCET      IFEQ 'CP'                                      S01512
     C                     Z-ADDCCDT      ZDAYNO                          S01512
     C                     MOVE CCEC      ZCCY                            S01512
     C                     MOVE *BLANKS   ZLOC                            S01512
     C                     Z-ADD0         ZNRDYS                          S01512
     C                     EXSR ZFWDT                                     S01512
     C           CCDT      IFNE ZDYNBR                                    S01512
     C                     Z-ADDZDYNBR    CCPD                            S01512
     C                     END                                            S01512
     C                     END                                            S01512
     C                     END                                            S01512
      *
     C           *IN52     IFEQ '0'
      *
      * Accumulate Hash Totals of the Event Amount
      *
     C                     Z-ADDCCEA      #HAMT
     C           #HAMT     CASNE0         SRHASH
     C                     END
      *                                                                   CEU011
      ** Get corresponding 'In' ccy Sort Sequnce no                       CEU011
      ** from PF/SDCURRPD.                                                CEU011
      *                                                                   CEU011
     C********** CEU011    IFEQ 'Y'                                                    CEU011 241795
     C********** CSE078    OREQ 'Y'                                                    CSE078 241795
     C           CSE078    IFEQ 'Y'                                                           241795
     C                     Z-ADD1         S                               CEU011
     C           CCEC      LOKUPCUR,S                    41               CEU011
     C           *IN41     IFEQ *ON                                       CEU011
     C                     MOVE SRT,S     ECSS                            CEU011
     C                     ENDIF                                          CEU011
     C                     ENDIF                                          CEU011
      *
      * Write a record to the event's file
      *
     C           #HAMT     IFNE 0                                         E20085
     C           CCET      OREQ 'DE'                                      E20085
     C                     ADD  1         OUTREC  50
     C                     MOVE 'D'       RECI
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1440CCP3                                           S01408
      *                                                                   S01408
      *                                                                                       CSE075
      ** If Enhanced Treasury is switched on:                                                 CSE075
      ** Apply delay period from SECTY to MBS coupons and repayments.                         CSE075
      *                                                                                       CSE075
     C           CSE075    IFEQ 'Y'                                                           CSE075
     C********** PROT      ANDEQ'8'                                                    CSE075 CSE075
     C           STBS      ANDEQ'P'                                                           CSE075
     C           PROT      ANDNE'2'                                                           CSE075
     C           PROT      ANDNE'4'                                                           CSE075
     C           PROT      ANDNE'7'                                                           CSE075
     C           PPDI      ANDNE'Y'                                                           CSE075
     C           CCET      ANDNE'MA'                                                          CSE075
     C           CSE075    OREQ 'Y'                                                           CSE075
     C           STBS      ANDEQ'Y'                                                           CSE075
     C           PROT      ANDNE'2'                                                           CSE075
     C           PROT      ANDNE'4'                                                           CSE075
     C           PROT      ANDNE'7'                                                           CSE075
     C           PROT      ANDNE'9'                                                           CSE075
     C           PPDI      ANDNE'Y'                                                           CSE075
     C           CCET      ANDNE'MA'                                                          CSE075
      *                                                                                       CSE075
     C                     ADD  CPDY      CCDT                                                CSE075
     C                     WRITEBPEVEDF                                                       CSE075
     C                     SUB  CPDY      CCDT                                                CSE075
     C                     ELSE                                                               CSE075
      *                                                                                       CSE075
     C                     WRITEBPEVEDF
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1440CCP4                                           S01408
      *                                                                   S01408
     C                     ENDIF                                                              CSE075
     C                     END                                            E20085
      *                                                                   E20085
     C                     END
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT                                                              S01220
     C********************************************************************S01220
     C**                                                                  S01220
     C**   SRRMS SR.  Obtain 'Position At Event Date', Set up             S01220
     C**               data for the Event record and write this record    S01220
     C**               to the events file (PF/RMSPEVP)                    S01220
     C**                                                                  S01220
     C           SRRMS     BEGSR                           *** SRRMS ***  S01220
     C**                                                                  S01220
     C********************************************************************S01220
     C*                                                                   S01220
     C** If forward position not already accessed in SROUT (ie. event     S01220
     C** is from PF/SRMNDE or the event type is 'RC'), access it now      S01220
     C*                                                                   S01220
     C           *IN13     IFEQ '1'                                       S01220
     C           CCET      OREQ 'RC'                                      S01220
     C*                                                                   S01220
     C** Obtain Position at Event Date (LF/BKPCF)                         S01220
     C*                                                                   S01220
     C                     Z-ADD0         CCNP                            S01220
     C                     Z-ADD0         CCEP                            S01220
     C                     Z-ADD0         #CCDM                           S01220
     C*                                                                   S01220
     C** Disregard position changes on event date.                        S01220
     C           KBKPC     SETLLBKPCF                                     S01220
     C                     READPBKPCF                    50               S01220
     C*                                                                   S01220
     C           *IN50     IFEQ '0'                        Position at    S01220
     C           BOOK      ANDEQBOOK1                       E.Dat found   S01220
     C                     Z-ADDNPSN      CCNP                            S01220
     C                     Z-ADDECNP      CCEP                            S01220
     C           CCNP      SUB  CCEP      #CCDM                           S01220
     C                     END                                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C** If event type is 'RC' or 'AC' AND event date is equal to         S01220
     C** maturity date, do not process event                              S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'RC'                                      S01220
     C           CCET      OREQ 'AC'                                      S01220
     C           CCDT      IFEQ MATY                                      S01220
     C                     GOTO ENDPR                                     S01220
     C                     END                                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C** Calculate adjusted forward position                              S01220
     C*                                                                   S01220
     C                     SUB  FCAD      #CCDM                           S01220
     C                     SUB  FCAD      CCNP                            S01220
     C                     MOVE '0'       *IN50                           S01220
     C*                                                                   S01220
     C                     Z-ADD0         #NAMT                           S01220
     C                     Z-ADD0         #EAMT                           S01220
     C                     MOVE '    '    CCCE                            S01220
     C*                                                                   S01220
     C** Calculate event amount                                           S01220
     C*                                                                   S01220
     C           CCET      CASEQ'CP'      SRCP             -Coupon        S01220
     C           CCET      CASEQ'DE'      SRDE              -Dividend     S01220
     C           CCET      CASEQ'DV'      SRDV              -Dividend     S01220
     C           CCET      CASEQ'PP'      SRPP               -Call        S01220
     C           CCET      CASEQ'MA'      SRMA                -Maturity   S01220
     C           CCET      CASEQ'RC'      SRRC                 -RedemptionS01220
     C           CCET      CASEQ'AC'      SRRC                  -ArtificiaS01220
     C                     END                                            S01220
     C*                                                                   S01220
     C**  Check for Data Base Error from Called Pgm.                      S01220
     C*                                                                   S01220
     C           *INU7     IFEQ '1'                                       S01220
     C           *INU8     OREQ '1'                                       S01220
     C                     MOVE '1'       *INLR                           S01220
     C                     MOVE '1'       *IN52                           S01220
     C                     MOVE '1'       *IN53                           S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C                     Z-ADD#NAMT     CCNA   150       E.Amt, Nom.Ccy S01220
     C*                                                                   S01220
     C*                                                                   S01220
     C**  Set >  CCEA - Event Amount in  Event Ccy                        S01220
     C**         to EQ  Event Amt in Nominal Ccy, If Event Ccy EQ Nom Ccy S01220
     C**         else   convert using the ZCONV routine.                  S01220
     C*                                                                   S01220
     C                     Z-ADD0         CCEA                            S01220
     C           CCET      IFEQ 'DE'                                      S01220
     C                     Z-ADD#EAMT     CCEA                            S01220
     C                     ELSE                                           S01220
     C           CCNA      IFNE 0                                         S01220
     C           *IN52     ANDEQ'0'                                       S01220
     C*                                                                   S01220
     C           CCNC      IFEQ CCEC                                      S01220
     C                     Z-ADDCCNA      CCEA                            S01220
     C                     ELSE                                           S01220
     C                     MOVE CCNC      ZCCYI            Nom Ccy        S01220
     C                     Z-ADD#NCDP     ZCDPI                           S01117
     C                     MOVE CCEC      ZCCYO            Event Ccy      S01220
     C                     Z-ADD#ECDP     ZCDPO                           S01117
     C                     Z-ADDCCNA      ZAMTCI           Amt (Nom Ccy)  S01220
     C                     Z-ADDSEXR      ZEXCH            Ex-chg Rate    S01220
     C                     MOVE SMDI      ZMD              Mult/Div Ind.  S01220
     C                     EXSR ZCONV                                     S01220
     C*                                                                   S01220
     C************INU8     IFEQ '1'                                S01220 S01117
     C***********          MOVE '1'       *IN52                    S01220 S01117
     C***********          MOVE '1'       *INLR            ********S01220 S01117
     C***********          MOVEL'16'      DBASE            **DB 6**S01220 S01117
     C***********          MOVEL'ZCONV   'DBFILE           ********S01220 S01117
     C***********          MOVELTKEY      DBKEY                    S01220 S01117
     C***********          ELSE                                    S01220 S01117
     C                     Z-ADDZAMTCO    CCEA             Event          S01220
     C***********          END                              in Ey  S01220 S01117
     C                     END                              in Ey  S01220 S01117
     C                     END                                     S01220 S01117
     C                     END                                     S01220 S01117
     C*                                                                   S01220
     C           *IN52     IFEQ '0'                                       S01220
     C*                                                                   S01220
     C**  Set >  CCFB - Due TO, FROM Book indicator                       S01220
     C**      >  CCIO - Incoming/Outgoing indicator                       S01220
     C*                                                                   S01220
     C                     MOVE ' '       CCFB                            S01220
     C                     MOVE ' '       CCIO                            S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'PP'                       PP Call        S01220
     C           CCNA      IFGE 0                                         S01220
     C                     MOVE 'F'       CCFB                            S01220
     C                     ELSE                                           S01220
     C                     MOVE 'T'       CCFB                            S01220
     C                     Z-SUBCCNA      CCNA                            S01220
     C                     Z-SUBCCEA      CCEA                            S01220
     C                     END                                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'CP'                       Coupon         S01220
     C           CCET      OREQ 'DE'                        Dividend      S01220
     C           CCET      OREQ 'DV'                        Dividend      S01220
     C           CCET      OREQ 'MA'                         Maturity     S01220
     C           CCET      OREQ 'RC'                       Redemption CallS01220
     C           CCET      OREQ 'AC'                       Artificial CallS01220
     C           CCNA      IFGE 0                                         S01220
     C                     MOVE 'T'       CCFB                            S01220
     C                     ELSE                                           S01220
     C                     MOVE 'F'       CCFB                            S01220
     C                     Z-SUBCCNA      CCNA                            S01220
     C                     Z-SUBCCEA      CCEA                            S01220
     C                     END                                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C           CCFB      IFEQ 'T'                                       S01220
     C                     MOVE 'I'       CCIO             Outgoing       S01220
     C                     END                                            S01220
     C           CCFB      IFEQ 'F'                                       S01220
     C                     MOVE 'O'       CCIO             Incoming       S01220
     C                     END                                            S01220
     C                     END                                            S01220
     C*                                                                   S01393
     C** Obtain Company of branch                                         S01393
     C*                                                                   S01393
     C**********           CALL 'AOBRCHR0'                                             S01393 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C***********          PARM *BLANKS   @PARM   7                S01393 076214
     C                     PARM *BLANKS   @RTCD   7                       076214
     C                     PARM '*KEY   ' @OPTN   7                       S01393
     C                     PARM CCBA      @BRKEY  3                       S01393
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        S01393 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01393
     C           @RTCD     IFNE *BLANKS                                   S01393
     C           *LOCK     IN   LDA                                       S01393
     C                     Z-ADD18        DBASE            ***************S01393
     C                     MOVELCCBA      DBKEY            * DB ERROR 18 *S01393
     C                     MOVEL'SDBRCHPD'DBFILE           ***************S01393
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     OUT  LDA                                       S01393
     C                     SETON                     U7U8LR               S01393
     C                     EXSR *PSSR                                     S01393
     C                     ELSE                                           S01393
     C                     MOVELA8CMCD    COBB                            S01393
     C                     END                                            S01393
     C*                                                                   S01220
     C** Write event record to PF/RMSPEVP                                 S01220
     C*                                                                   S01220
     C                     EXSR SRRMW                                     S01220
     C*                                                                   S01220
     C** If event type is 'RC'                                            S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'RC'                                      S01220
     C*                                                                   S01220
     C** Convert from nominal currency decimal places to nominal          S01220
     C** decimal places                                                   S01220
     C** NB. Event amount in nominal currency has nominal currency        S01220
     C**     decimal places, but Forward Called Amount on PIBKPD          S01220
     C**     is held with nominal decimal places, hence the need to       S01220
     C**     convert                                                      S01220
     C*                                                                   S01220
     C           #NCDP     IFNE NMDP                                      S01220
     C           #NCDP     SUB  NMDP      X                               S01220
     C                     ADD  5         X                               S01220
     C           #NAMT     DIV  POWER8,X  #NAMT     H                     S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C** Add event amount to called amount on PF/PIBKPD and update        S01220
     C** record                                                           S01220
     C*                                                                   S01220
     C                     ADD  #NAMT     FCAD                            S01220
     C                     UPDATPIBKPDF                                   S01220
     C*                                                                   S01220
     C** If called percentage on PF/SEDEVD not equal to zero              S01220
     C** AND (100 - total called percentage on PF/SEDEVD) equal to zero,  S01220
     C** set RM processing flag to 'N'                                    S01220
     C*                                                                   S01220
     C           SDPC      IFNE 0                                         S01220
     C           SDTP      ANDEQ100                                       S01220
     C                     MOVE 'N'       RMPROC                          S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C** If called amount on PF/SEDEVD not equal to zero                  S01220
     C** AND (issue amount on PF/SECTYD - total called amount on          S01220
     C** PF/SEDEVD) equal to zero, set RM processing flag to 'N'          S01220
     C*                                                                   S01220
     C           SDPP      IFNE 0                                         S01220
     C           SDTA      ANDEQISSA                                      S01220
     C                     MOVE 'N'       RMPROC                          S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C           ENDPR     TAG                                            S01220
     C*                                                                   S01220
     C                     ENDSR                                          S01220
     C*****************************************************************   S01220
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRPP   - Subroutine to calculate Event Amount for PP Call.   *
      *                                                               *
      *****************************************************************
      *
     C           SRPP      BEGSR                           ***  SRPP  ***
      *
      ***  Event Code '31B1' = PP CAll
      *
     C                     MOVE '31B1'    CCCE
      *
      * To calculate the Event Amount, use the PP CALL amount,
      *   or percentage, depending on the Processing Type.
      *
     C           PROT      IFEQ '4'
      *
     C           CCNP      MULT SDPP      #NAMT
      *
     C                     ELSE
      *
     C           CCNP      MULT SDPC      #NAMT     H
     C           #NAMT     DIV  100       #NAMT     H
      *
      * Convert from Nom D.p. to the CCY D.p.
      *          'to' ccy   -  'from' ccy
      *
     C           #NCDP     IFNE NMDP
     C           #NCDP     SUB  NMDP      X       20
     C                     ADD  5         X
     C           #NAMT     MULT POWER8,X  #NAMT     H
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRCP   - Subroutine to calculate Event Amount for Coupon.    *
      *                                                               *
      *****************************************************************
      *
     C           SRCP      BEGSR                           ***  SRCP  ***
      *
      ***  Event Code '31B2' = Coupon
      *
     C                     MOVE '31B2'    CCCE
      *                                                                   E20085
     C*****Obtain*the*Coupon*Date*prior*to*the*Event*Coupon*Date.* E20085 099890
     C***  This is move to subroutine SROUT before SRCP is called.        099890
     C************************************************************ E20085 099890
     C***********CCDT      SUB  1         ZECD                     E20085 099890
     C***********          EXSR ZLCD                               E20085 099890
      *
      * Calculate Coupon Amount
      *
     C/COPY WNCPYSRC,SE1440C004
     C                     CALL 'ZACRFB'  ACRFB
     C/COPY WNCPYSRC,SE1440C005
      *
     C***********IACR      ADD  #AMT      #NAMT                           E23955
     C                     Z-ADD#AMT      #NAMT                           E23955
      *
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1440CCP5                                           S01408
      *                                                                   S01408
      *                                                                                       CSE075
      ** The correct factor for projected MBS coupons is held in field                        CSE075
      ** SNCF on 'CP' non-diary events.  Unfortunately, ZACCZ (called from                    CSE075
      ** ZACRFB) uses a factor obtained from the prior 'CP' event on                          CSE075
      ** SNDEVD.  In order to apply the correct factor to future coupons,                     CSE075
      ** it is necessary to undo the factoring performed by ZACCZ.                            CSE075
      ** Note: This fix assumes that factors change ONLY on coupon dates.                     CSE075
      *                                                                                       CSE075
      **  If Enhanced Treasury is switched on:                                                CSE075
      *                                                                                       CSE075
     C           CSE075    IFEQ 'Y'                                                           CSE075
     C********** PROT      ANDEQ'8'                                                    CSE075 CSE075
     C           STBS      ANDEQ'P'                                                           CSE075
     C           PROT      ANDNE'2'                                                           CSE075
     C           PROT      ANDNE'4'                                                           CSE075
     C           PROT      ANDNE'7'                                                           CSE075
     C           CSE075    OREQ 'Y'                                                           CSE075
     C           STBS      ANDEQ'Y'                                                           CSE075
     C           PROT      ANDNE'2'                                                           CSE075
     C           PROT      ANDNE'4'                                                           CSE075
     C           PROT      ANDNE'7'                                                           CSE075
     C           PROT      ANDNE'9'                                                           CSE075
      *                                                                                       CSE075
      ** First, obtain the factor that ZACCZ will have used.                                  CSE075
      *                                                                                       CSE075
     C                     MOVE 'CP'      XSDET                                               CSE075
     C                     Z-ADDCCDT      XSDED                                               CSE075
     C           KSED      SETGTSNDEVDO                                                       CSE075
     C                     READ SNDEVDO                  50                                   CSE075
      *                                                                                       CSE075
      ** If no prior CP is found on SNDEVD, ZACCZ uses factor from SECTY.                     CSE075
      *                                                                                       CSE075
     C           *IN50     IFEQ *ON                                                           CSE075
     C           XSNSN     ORNE CCSS                                                          CSE075
     C           XSNET     ORNE 'CP'                                                          CSE075
     C                     Z-ADDCFCT      XSNCF                                               CSE075
     C                     ENDIF                                                              CSE075
      *                                                                                       CSE075
      ** Now adjust for the difference between the two factors.                               CSE075
      *                                                                                       CSE075
     C           XSNCF     IFNE 0                                                             CSE075
     C           SNCF      DIV  XSNCF     CPFCTR 109H                                         CSE075
     C                     MULT CPFCTR    #NAMT     H                                         CSE075
     C                     ELSE                                                               CSE075
     C                     MULT SNCF      #NAMT     H                                         CSE075
     C                     ENDIF                                                              CSE075
     C                     ENDIF                                                              CSE075
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRDV   - Subroutine to calculate Event Amount for Dividend.  *
      *                                                               *
      *****************************************************************
      *
     C           SRDV      BEGSR                           ***  SRDV  ***
      *
      ***  Event Code '31B3' = Dividend
      *
     C                     MOVE '31B3'    CCCE
      *
      * Calculate Dividend Due Amount
      *
      *  = Cum Coupon/Dividend Nominal  x  Expected Dividend
      *
     C***********#ECDP     ADD  4         DC      30                      087712
     C***********SDDV      MULT POWER,DC  WKSDDV 157                      E16772
     C***********SDVA      MULT POWER,DC  WKSDDV 158               E16772 087712
     C***********#CCDM     MULT WKSDDV    N13#0  130H                     087712
     C*                                                                   087712
     C** Use subroutine ZCNSD to calculate dividend due.                  087712
     C*                                                                   087712
     C                     Z-ADD#ECDP     ZCDP                            087712
     C                     Z-ADD#CCDM     ZNOML                           087712
     C                     Z-ADDSDVA      ZPRC                            087712
     C                     EXSR ZCNSD                                     087712
     C                     Z-ADDZCONS     N13#0  130                      087712
     C                     Z-ADDN13#0     #NAMT
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRDE   - Subroutine to calculate Event Amount for Expected   *
      *           Dividend.                                           *
      *                                                               *
      *****************************************************************
      *
     C           SRDE      BEGSR                           ***  SRDE  ***
      *
     C                     MOVE *BLANKS   CCCE
      *
      * Calculate Dividend Due Amount
      *
      *  = Cum Coupon/Dividend Nominal  x  Total called amount %
      *
     C           #CCDM     MULT SNCP      N13#0  130H
     C                     Z-ADDN13#0     #EAMT
      *
     C**  Adjust for Nominal Decimal Places in case of Unit Trusts only   E24175
     C*                                                                   E24175
     C***********NMDP      ADD  4         X                         E24175E32883
     C***********#EAMT     DIV  POWER,X   #EAMT     H               E24175E32883
     C*                                                                   E24175
     C** Replace the nominal dec places with event dec places             076692
     C*                                                                   076692
     C***********#NCDP     IFNE NMDP                               E32883 076692
     C***********#NCDP     SUB  NMDP      X                        E32883 076692
     C           #ECDP     IFNE NMDP                                      076692
     C           #ECDP     SUB  NMDP      X                               076692
     C                     ADD  5         X                               E32883
     C           #EAMT     DIV  POWER8,X  #EAMT     H                     E32883
     C                     END                                            E32883
     C*                                                                   E32883
     C           CCNC      IFEQ CCEC
     C                     Z-ADD#EAMT     #NAMT
     C                     ELSE
     C                     MOVE CCEC      ZCCYI
     C                     Z-ADD#ECDP     ZCDPI                           S01117
     C                     MOVE CCNC      ZCCYO
     C***********          Z-ADD#NCDP     ZCDPO                    S01117 076692
     C                     Z-ADD#ECDP     ZCDPO                           076692
     C                     Z-ADD#EAMT     ZAMTCI
     C                     Z-ADDSEXR      ZEXCH
     C                     MOVE SMDI      ZMD
     C                     EXSR ZCONV
      *
     C************INU8     IFEQ '1'                                       S01117
     C***********          MOVE '1'       *IN52                           S01117
     C***********          MOVE '1'       *INLR            ***************S01117
     C***********          MOVEL'10'      DBASE            * DB ERROR 10 *S01117
     C***********          MOVEL'ZCONV   'DBFILE           ***************S01117
     C***********          MOVELTKEY      DBKEY                           S01117
     C***********          ELSE                                           S01117
      *
      ***  Event Amount in Nominal Currency
     C                     Z-ADDZAMTCO    #NAMT
     C***********          END                                            S01117
     C                     END
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRMP   - Subroutine to calculate Event Amount for Mortgage   *
      *           Paymemt.                                            *
      *                                                               *
      *****************************************************************
      *
     C           SRMP      BEGSR                           ***  SRMP  ***
      *
      ***  Event Code '31B4' = Mortgage Payment
      *
     C                     MOVE '31B4'    CCCE
     C***********          Z-ADD0         N15#7  157                      E20086
     C***********          Z-ADD1         CFDIF   98               E20086 052254
     C                     Z-ADD1         CFDIF                           052254
     C                     Z-ADD0         #NAMT
     C***********          Z-ADD0         #CAMT                           E20086
      *
      **Calculate*Interest*Due*****************************************   E20086
      *
      ***  Interest is already taken care of in Coupon Payments.          E20086
      *                                                                   E20086
     C***********          CALL 'ZACRFB'  ACRFB                           E20086
     C***********          ADD  IACR      #AMT                            E20086
     C***********#AMT      MULT CFCT      #CAMT     H                     E20086
      *
      * Obtain Principal Repayment
      *                                                                   E20086
      *****If*Repayment*Method*EQ*'Y',*use*Repayment*Amount,*else******   E20086
      *****calculate*Princ.Repmnt**=*Position*x*(*Current*Factor/SECTY*   E20086
      ******-*Current*Factor/SEDEVD)***********************************   E20086
      *                                                                   E20086
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1440CCP6                                           S01408
      *                                                                   S01408
      ** If Enhanced Treasury is switched on:                                                 CSE075
      *                                                                                       CSE075
     C           CSE075    IFEQ 'Y'                                                           CSE075
      *                                                                                       CSE075
      ** The following steps apply only to diary events.  If the event                        CSE075
      ** being processed is from the non-diary file, it holds both old                        CSE075
      ** and new factors, so there's no need to access prior 'MP' event.                      CSE075
      *                                                                                       CSE075
     C           *IN11     IFEQ *ON                                                           CSE075
      *                                                                                       CSE075
      ** If Repayment Method = 'Y', use the Repayment Amount                                  CSE075
      *                                                                                       CSE075
     C           SRMI      IFEQ 'Y'                                                           CSE075
     C                     Z-ADDSRPT      #NAMT                                               CSE075
      *                                                                                       CSE075
      ***  Else, obtain the previous Current Factor from the Security                         CSE075
      ***  Diary, then calculate Principal Repayment as:                                      CSE075
      ***     (Old CF - New CF) * Current Position                                            CSE075
      *                                                                                       CSE075
     C                     ELSE                                                               CSE075
      *                                                                                       CSE075
     C                     MOVE 'MP'      XSDET                                               CSE075
     C                     Z-ADDCCDT      XSDED                                               CSE075
     C           KSED      SETGTSEDEVDO                                                       CSE075
     C                     READ SEDEVDO                  50                                   CSE075
      *                                                                                       CSE075
     C           *IN50     IFEQ *ON                                                           CSE075
     C           XSDSN     ORNE CCSS                                                          CSE075
     C           XSDET     ORNE 'MP'                                                          CSE075
     C                     Z-ADD1         XSDCP                                               CSE075
     C                     ENDIF                                                              CSE075
      *                                                                                       CSE075
     C           XSDCP     SUB  SDCP      CFDIF                                               CSE075
     C           CFDIF     MULT CCNP      #NAMT     H                                         CSE075
      *                                                                                       CSE075
     C                     ENDIF                                                              CSE075
      *                                                                                       CSE075
      ** *IN11 off means non-diary event is being processed.                                  CSE075
      *                                                                                       CSE075
     C                     ELSE                                                               CSE075
     C           SNPR      SUB  SNCF      CFDIF                                               CSE075
     C           CFDIF     MULT CCNP      #NAMT     H                                         CSE075
     C                     ENDIF                                                              CSE075
      *                                                                                       CSE075
      ** If Enhanced Treasury is switched off:                                                CSE075
      *                                                                                       CSE075
     C                     ELSE                                                               CSE075
      *                                                                                       CSE075
      ***  If Repayment Method = 'Y', use the Repayment Amount            E20086
      *                                                                   E20086
     C           SRMI      IFEQ 'Y'                                       E20086
     C                     Z-ADDSRPT      #NAMT
      *                                                                   E20086
      ***  Else, obtain the previous Current Factor from the Security     E20086
      ***  Diary, then calculate Principal Repayment as:                  E20086
      ***     (Old CF - New CF) * Current Position                        E20086
      *                                                                   E20086
     C***********SRMI      IFNE 'Y'                                       E20086
     C                     ELSE                                           E20086
      *                                                                   E20086
     C                     MOVE 'MP'      XSDET                           E20086
     C                     Z-ADDCCDT      XSDED                           E20086
     C           KSED      SETGTSEDEVDO                                   E20086
     C                     READ SEDEVDO                  50               E20086
      *                                                                   E20086
     C           *IN50     IFEQ '1'                                       E20086
     C           XSDSN     ORNE CCSS                                      E20086
     C           XSDET     ORNE 'MP'                                      E20086
     C                     Z-ADD1         XSDCP                           E20086
     C                     END                                            E20086
      *                                                                   E20086
     C***********CFCT      SUB  SDCP      N15#7                           E20086
     C***********N15#7     MULT CCNP      #NAMT     H                     E20086
     C           XSDCP     SUB  SDCP      CFDIF                           E20086
     C           CFDIF     MULT CCNP      #NAMT     H                     E20086
      *
     C                     END
      *
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1440CCP7                                           S01408
      *                                                                   S01408
      *                                                                                       CSE075
      ** End of Enhanced Treasury loop.                                                       CSE075
      *                                                                                       CSE075
     C                     ENDIF                                                              CSE075
      *                                                                                       CSE075
      **Event*Amount*=*Principal*Repayment*+*Interest*Due**************   E20086
      ***********                                                         E20086
     C***********          ADD  #CAMT     #NAMT                           E20086
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRMA   - Subroutine to calculate Event Amount for Maturity.  *
      *                                                               *
      *****************************************************************
      *
     C           SRMA      BEGSR                           ***  SRMA  ***
      *
      ***  Event Code '31B5' = Maturity
      *
     C                     MOVE '31B5'    CCCE
      *
     C                     Z-ADD0         N15#7  157
     C                     Z-ADD0         #NAMT
     C***********          Z-ADD0         #CAMT                           E23955
      *                                                                   E20085
      ***  Obtain the Coupon Date prior to the Event Maturity Date.       E20085
      *                                                                   E20085
     C           CCDT      SUB  1         ZECD                            E20085
     C                     EXSR ZLCD                                      E20085
      *
      **Calculate*Interest*Due*****************************************   E20085
      ***********                                                         E20085
     C***********          CALL 'ZACRFB'  ACRFB                           E20085
     C***********IACR      ADD  #AMT      #CAMT                             0085
      *
      * Obtain Price At Maturity
      *
     C***********          MOVE 'RC'      TYPE02                          E20086
     C                     MOVE 'RC'      XSDET                           E20086
     C                     Z-ADDMATY      XSDED                           E20086
     C***********KSED      CHAINSEDEV                50                   E20086
     C           KSED      CHAINSEDEVDO              50                   E20086
     C           *IN50     IFEQ '1'
     C***********          MOVE 'RP'      TYPE02                          E20086
     C                     MOVE 'RP'      XSDET                           E20086
     C***********KSED      CHAINSEDEV                50                   E20086
     C           KSED      CHAINSEDEVDO              50                   E20086
     C                     END
      *
     C           *IN50     IFEQ '0'
     C                     Z-ADDXSDRP     N15#7
     C                     ELSE
      *
     C           SPBS      IFEQ 'P'
     C                     Z-ADD100       N15#7
     C                     END
      *
     C***********SPBS      IFEQ 'U'                                       103011
     C***********          Z-ADD1         N15#7                           103011
     C***********          END                                            103011
     C           PROT      IFEQ '1'                                                           192467
     C           SPBS      ANDEQ'U'                                                           192467
     C                     Z-ADD1         N15#7                                               192467
     C                     ENDIF                                                              192467
     C*                                                                   073040
     C*** For Mortgage-Backed Securities, obtain the current factor       073040
     C*** from the latest mortgage repayment record.                      073040
     C*                                                                   073040
     C           PROT      IFEQ '8'                                       073040
     C                     MOVE 'MP'      XSDET                           073040
     C                     MOVE CCDT      XSDED                           073040
     C           KSED      SETGTSECEO                                     073040
     C                     READ SECEO                    50               073040
     C           *IN50     IFEQ '0'                                       073040
     C           XSDET     ANDEQ'MP'                                      073040
     C           XSDSN     ANDEQCCSS                                      073040
     C                     MULT XSDCP     N15#7                           073040
     C                     END                                            073040
     C                     END                                            073040
     C*                                                                   073040
     C                     END
     C                     MOVE '0'       *IN50
      *
      * Calculate Nominal Maturing for Book
      *
     C           CCNP      MULT N15#7     #AMT      H
      *
     C           SPBS      IFEQ 'P'
     C           #AMT      DIV  100       #AMT      H
     C                     END
      *
      * Convert (#AMT) to Event Ccy Decimal Positions.
      * Convert from Nom D.p. to the CCY D.p.
      *          'to' ccy   -  'from' ccy
      *
     C           #NCDP     IFNE NMDP
     C           #NCDP     SUB  NMDP      X       20
     C                     ADD  5         X
     C           #AMT      MULT POWER8,X  #AMT      H
     C                     END
      *
      **Event*Amount*=*Nom*+*Intr*Due**********************************   E20085
      ***********                                                         E20085
     C***********#AMT      ADD  #CAMT     #NAMT                           E23955
     C                     Z-ADD#AMT      #NAMT                           E23955
     C/COPY WNCPYSRC,SE1440C006
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRLR   - Subroutine for Control Processing                   *
      *                                                               *
      *****************************************************************
      *
     C           SRLR      BEGSR                           ***  SRLR  ***
      *
      * If no records read - Empty Primary File,
      *  access the I.C.D. record (PF/TABTB10)
      *
     C           *IN40     IFEQ '0'
     C           *IN99     ANDEQ'0'
     C                     EXSR ZSYSTM
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL*BLANK    DBLOT                           S01117
     C                     MOVEL'SE1440'  DBPGM                           S01117
     C                     MOVEL'TABLE'   DBFILE           ***************
     C***********          MOVEL'08'      DBASE            * DB ERROR 08 *S01117
     C                     Z-ADD8         DBASE            * DB ERROR 08 *S01117
     C                     MOVELZTABKY    DBKEY            ***************
     C                     MOVEL'SE1440  'DBPGM                           085494
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     END
     C                     END
      *
      * Write control report headings
      *
     C                     WRITEHEADAU
      *
      **Database*Errors***DB**01-10**********************                 S01117
      ***********                                                         S01117
     C************IN99     IFEQ '1'                                       S01117
     C************IN52     OREQ '1'                                       S01117
     C***********          MOVE '1'       *INU8                           S01117
     C***********          MOVE '1'       *INU7                           S01117
      ***********                                                         S01117
      **CALLED*PGM*Errors****************                                 S01117
     C************IN53     IFEQ '1'                                       S01117
     C***********          IN   LDA                                       S01117
     C***********          MOVEL#DBLOT    DBLOT                           S01117
     C***********          OUT  LDA                                       S01117
     C***********          END                                            S01117
      *
     C           *INU7     IFEQ '1'
     C                     WRITEERROR
      *
     C                     END
      *
      *  Access AUDIT records / Compare Totals
      *
     C                     Z-ADD0         NORE       50
     C                     READ SEDEVAF                  50
     C                     Z-ADDNORE      AUDIT1  50
     C                     WRITETOT01
      *                   ~~~~~~~~~~~~
      /EJECT
      *
     C                     Z-ADD0         NORE       50
     C                     READ SNDEFAF                  50
     C                     Z-ADDNORE      AUDIT2  50
     C                     WRITETOT02
      *
     C           IN02      IFNE AUDIT2
     C                     WRITEDIFF
     C           *INU8     IFEQ '0'
     C                     MOVE '1'       *INU8            ***************
     C***********          MOVEL'09'      DBASE            **DB ERROR 09**S01117
     C***********          MOVEL'SNDEFA  'DBFILE           ***************S01117
     C***********          MOVEL'*AUDIT**'DBKEY                           S01117
     C***********          WRITEERROR                                     S01117
     C                     END
     C                     END
      *
      * Write AUDIT record
      *
     C                     Z-ADDOUTREC    NORE
     C                     WRITEBPEVEAF
      *
      ***IF*NO*OUTPUT/EMPTY*FILES*-*Print*a*message*to*this*effect*****   E29170
      ***********                                                         E29170
     C************IN40     IFEQ '0'                                       E29170
     C***********          WRITENONE                                      E29170
      ***********                                                         E29170
      **********ELSE****-*Print*Records*Written*Total******************   E29170
      *                   Print Records Written Total                     E29170
     C***********          ELSE                                           E29170
     C                     WRITECONTROL
     C***********          END                                            E29170
      *
      *  END OF PROGRAM
     C***********          WRITETRAILAU                                   E29170
      *                  ~~~~~~~~~~~~~~~~
      *
      ***If*Database*Erorrs*found,*update*LDA**********************       S01117
     C************NAMVAR   DEFN           LDA                             S01117
      ***********                                                         S01117
     C************INU8     IFEQ '1'                                       S01117
     C************IN53     ANDEQ'0'                                       S01117
     C************LOCK     IN   LDA                                       S01117
     C***********          MOVELDBLOT     #DBLOT                          S01117
     C***********          OUT  LDA                                       S01117
     C***********          END                                            S01117
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
     C********************************************************************S01220
     C**                                                                  S01220
     C**   SRRC  SR.  Calculate Event Amount -  RC  REDEMPTION CALL       S01220
     C**                                        AC  ARTIFICIAL CALL       S01220
     C           SRRC      BEGSR                           *** SRRC ***   S01220
     C**                                                                  S01220
     C********************************************************************S01220
     C*                                                                   S01220
     C** If event type is 'AC', set called percentage and total called    S01220
     C** percentage to 100                                                S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'AC'                                      S01220
     C                     Z-ADD100       SDPC                            S01220
     C                     Z-ADD100       SDTP                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C** If called percentage not equal to zero                           S01220
     C*                                                                   S01220
     C           SDPC      IFNE 0                                         S01220
     C*                                                                   S01220
     C** Calculate event amount as:                                       S01220
     C**   adjusted position X               called %                     S01220
     C**                      -------------------------------------       S01220
     C**                        100 - (total called % - called %)         S01220
     C*                                                                   S01220
     C           SDTP      SUB  SDPC      WRK73   73                      S01220
     C           100       SUB  WRK73     WRK73                           S01220
     C           SDPC      DIV  WRK73     WRK157 157H                     S01220
     C           #CCDM     MULT WRK157    #NAMT     H                     S01220
     C*                                                                   S01220
     C** Otherwise, called percentage equal to zero                       S01220
     C*                                                                   S01220
     C                     ELSE                                           S01220
     C*                                                                   S01220
     C** If called amount not equal to zero                               S01220
     C*                                                                   S01220
     C           SDPP      IFNE 0                                         S01220
     C           ISSA      ANDNE0                                         101125
     C*                                                                   S01220
     C** Calculate event amount as:                                       S01220
     C**   adjusted position X             call amount                    S01220
     C**                      ------------------------------------        S01220
     C**                        issue  - (total called - called)          S01220
     C**                        amount       amount      amount           S01220
     C*                                                                   S01220
     C           SDTA      SUB  SDPP      WRK15  150                      S01220
     C           ISSA      SUB  WRK15     WRK15                           S01220
     C           SDPP      DIV  WRK15     WRK155 155H                     S01220
     C           #CCDM     MULT WRK155    #NAMT     H                     S01220
     C                     END                                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C** Convert from Nom D.p. to the CCY D.p.                            S01220
     C**          'to' ccy   -  'from' ccy                                S01220
     C*                                                                   S01220
     C           #NCDP     IFNE NMDP                                      S01220
     C           #NCDP     SUB  NMDP      X       20                      S01220
     C                     ADD  5         X                               S01220
     C           #NAMT     MULT POWER8,X  #NAMT     H                     S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C                     ENDSR                                          S01220
     C*****************************************************************   S01220
      /EJECT                                                              S01220
     C********************************************************************S01220
     C**                                                                  S01220
     C**   SRRMW SR.  Write event record to RMSPEVP                       S01220
     C**                                                                  S01220
     C           SRRMW     BEGSR                           *** SRRMW ***  S01220
     C**                                                                  S01220
     C********************************************************************S01220
     C*                                                                   S01220
     C** Set up fields for output to PF/RMSPEVP                           S01220
     C*                                                                   S01220
     C** Record id: 'D'                                                   S01220
     C                     MOVE 'D'       RECI                            S01220
     C*                                                                   S01220
     C** Branch code: from PF/PIBKPD                                      S01220
     C*                                                                   S01220
     C** Book code: from PF/PIBKPD                                        S01220
     C*                                                                   S01220
     C** Security: from LF/SECEFRM                                        S01220
     C*                                                                   S01220
     C** Event code:                                                      S01220
     C           CCET      IFEQ 'PP'                                      S01220
     C                     MOVE '31R1'    CCCE                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'CP'                                      S01220
     C           PROT      IFEQ '3'                                       S01220
     C           PROT      OREQ '5'                                       S01220
     C                     MOVE '31R2'    CCCE                            S01220
     C                     ELSE                                           S01220
     C                     MOVE '31R3'    CCCE                            S01220
     C                     END                                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'DE'                                      S01220
     C           CCET      OREQ 'DV'                                      S01220
     C                     MOVE '31R4'    CCCE                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'MA'                                      S01220
     C                     MOVE '31R5'    CCCE                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'RC'                                      S01220
     C                     MOVE '31R6'    CCCE                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C           CCET      IFEQ 'AC'                                      S01220
     C                     MOVE '31R7'    CCCE                            S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C** Event date: from LF/SECEFRM                                      S01220
     C*                                                                   S01220
     C** Event currency: as set up in main processing                     S01220
     C*                                                                   S01220
     C** Event amount: as set up in main processing                       S01220
     C*                                                                   S01220
     C** I/O indicator: as set up in SR. SRRMS                            S01220
     C*                                                                   S01220
     C** Company of Branch: as set up in SR. SRRMS                        S01393
     C*                                                                   S01393
     C** Multibranch event:                                               S01393
     C*                                                                   S01393
     C                     MOVE 'N'       IBRE                            S01393
     C*                                                                   S01220
     C** Write record to PF/RMSPEVP if Event Amount not equal to zero     S01220
     C*                                                                   S01220
     C           CCEA      IFNE 0                                         S01220
     C                     WRITERMSPEVPF                                  S01220
     C                     END                                            S01220
     C*                                                                   S01220
     C                     ENDSR                                          S01220
      *****************************************************************
      /EJECT                                                              S01117
     C*****************************************************************   S01117
     C*                                                               *   S01117
     C* *PSSR - SUBROUTINE TO HANDLE ABNORMAL ERROR CONDITIONS        *   S01117
     C*                                                               *   S01117
     C* CALLED FROM : AFTER ABNORMAL OPERATION OCCURS                 *   S01117
     C*                                                               *   S01117
     C* CALLS : NOTHING                                               *   S01117
     C*                                                               *   S01117
     C*****************************************************************   S01117
     C*                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR **    S01117
     C*                                                                   S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     ENDSR                                          S01117
     C*****************************************************************   S01220
      /EJECT                                                              S01220
     C/COPY ZSRSRC,ZCONVZ1
      /EJECT                                                              E20085
     C/COPY ZSRSRC,ZDATE1Z2                                               E20085
      /EJECT                                                              E20085
     C/COPY ZSRSRC,ZDATE2Z4                                               E20085
      /EJECT                                                              E20085
     C/COPY ZSRSRC,ZLCDZ1                                                 E20085
      /EJECT
     C/COPY ZSRSRC,ZSYSTMZ1
      /EJECT
     C/COPY ZSRSRC,ZACCH                                                  S01512
     C/EJECT                                                              S01512
     C/COPY ZSRSRC,ZFWDT                                                  S01512
     C/EJECT                                                              S01512
     C/COPY ZSRSRC,ZCNSDZ1                                                087712
     C/EJECT                                                              087712
      ***
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN                      E20085
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR                        E20085
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES                                            E20085
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
