     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Project customer position events')            *
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  SE1480 - PROJECT CUSTOMER POSTITION EVENTS                   *
      *                                                               *
      *  Function: The Forward Security Events file is read, and the  *
      *   (COB)    following types of Security Events and Event Codes *
      *            on Customer Positions are produced:                *
      *                                                               *
      *            PP: 31C1  (PP Call)      CP: 31C2  (Coupon)        *
      *            DV: 31C3  (Dividend)     MP: 31C4  (Mortgage Payt) *
      *            MA: 31C5  (Maturity)                               *
      *                                                               *
      *            These events are used in production of Events by   *
      *            Security report, Shadow Posting, and Dealing       *
      *            module event reports.                              *
      *                                                               *
      *  Called by: SEC1109 - Project Customer Position Events        *
      *                                                               *
      *  Calls: ZACRFC - Calculate Interest on Customer Positions     *
      *                                                               *
      *---------------------------------------------------------------*
      *  Note: This program is very similar to SE1440 and SE1460. Any *
      *        changes made to this program should also be considered *
      *        for the other two programs.                            *
      *---------------------------------------------------------------*
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. AR906833           Date 18Dec12               *
      *  Prev Amend No. CSW210             Date 04May10               *
      *                 CER059             Date 19Jul10               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 241795             Date 13Sep06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 BUG11199           Date 02May06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 CSE037             Date 29Apr02               *
      *                 CSE035             Date 22Apr02               *
      *                 206316             Date 19Jul02               *
      *                 209299             Date 22Jan03               *
      * Midas Release 4.01.02 ----------------------------------------*
      *                 197766             Date 22Mar02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CSE034             Date 22Apr02               *
      *                 CSE031             Date 09Nov01               *
      *                 153701             Date 22Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CSE028             Date 06Jun01               *
      *                 CSE022             Date 29Mar01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 170108             Date 01Mar01               *
      *                 187848             Date 28Dec00               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 178458             Date 28Aug00               *
      * Midas DBA 3.03 -----------------------------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 130862             Date 16Oct98               *
      *                 151542             Date 05Jan99               *
      *                 148428             Date 30Nov98               *
      *                 CEU011             Date 11Mar98               *
      *                 101283             DATE 20FEB97               *
      *                 119742             DATE 04FEB98               *
      *                 CSE005             Date 04Feb97               *
      *                 S01408             Date 02Sep96               *
      *                 073040             DATE 26JUL96               *
      *                 100228             DATE 30MAY96               *
      *                 103150             DATE 13MAY96               *
      *                 103011             DATE 09MAY96               *
      *                 091254             DATE 20OCT95               *
      *                 088542             DATE 07JUN95               *
      *                 087712             DATE 15JUN95               *
      *                 081439             DATE 10JAN95               *
      *                 S01496             DATE 15JUL94               *
      *                 S01522             DATE 28NOV94               *
      *                 S01512             DATE 30SEP94               *
      *                 076693             DATE 30SEP94               *
      *                 S01510             DATE 10AUG94               *
      *                 S01509             DATE 10AUG94               *
      *                 050723             DATE 07JAN94               *
      *                 052254             DATE 07JAN94               *
      *                 062344             DATE 26OCT93               *
      *                 S01447             DATE 21OCT93               *
      *                 S01401             DATE 16JUN93               *
      *                 047360             DATE 01FEB93               *
      *                 E37428             DATE 30OCT92               *
      *                 S01397             DATE 10SEP92               *
      *                 E38182             DATE 07APR92               *
      *                 E34974             DATE 28JAN92               *
      *                 E34034             DATE 07JAN92               *
      *                 E29170             DATE 18NOV91               *
      *                 E29978             DATE 22OCT91               *
      *                 E27092             DATE 04SEP91               *
      *                 S01117             DATE 17JUN91               *
      *                 E23955             DATE 23OCT90               *
      *                 E21639             DATE 09APR90               *
      *                 E21616             DATE 03APR90               *
      *                 E20651             DATE 05FEB90               *
      *                 E19101             DATE 25JAN90               *
      *                 E20568             DATE 11DEC89               *
      *                 E20085             DATE 07NOV89               *
      *                 E20086             DATE 07NOV89               *
      *                 E16772             DATE 31/05/89              *
      *                 E16813             DATE 08/02/89              *
      *                 S01176             DATE 08/08/88              *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  AR906833 - DBASE 12 on SE1460 due to deleted SE Client.      *
      *             Do not consider positions equal to zero.          *
      *             Applied fix AR663084B. (Child: AR906834)          *
      *  CSW210 - SWIFT 2010 Changes (Recompile)                      *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                         *
      *  241795 - Populate ECSS whether CEU011 is switched on or off. *
      *  BUG11199 - Ensure that the number of dec. place is correct.  *
      *             Applied fix 238955.                               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CSE037 - Bond Pricing - 3 Decimal Places in Trades Input     *
      *  CSE035 - NX/NNX Coupon Payment Processing.                   *
      *  206316 - Recompiled over changed ZLCDZ1.                     *
      *  209299 - Wrong settlement details used. Fix is to treat CCFC *
      *           as due to or from customer and not bank.            *
      *  197766 - Original value of Event Currency being overwritten  *
      *           which leads to event amounts not being converted    *
      *           properly. Fix is to keep original value of event    *
      *           currency.                                           *
      *  CSE034 - Standard Settlement Instruction improvements        *
      *  CSE031 - Coupon Fixing for Floating Rate Notes.              *
      *           (recompilation due to change to ZNCD/ZLCD)          *
      *  153701 - Due to level break on security shortname, fix       *
      *           151542 does not work properly. Complete it.         *
      *  CSE028 - Standing Settlement Instructions Enhancement.       *
      *  CSE022 - Depository Definition Enhancement                   *
      *  170108 - Database error does not halt the Close of Business  *
      *           run. The system does not register the error and the *
      *           Close of Business processing continue. Set-on U7U8. *
      *  187848 - Only generate projected event if position           *
      *           settlement is not being generated when CSE023       *
      *           Treaty Tax is present                               *
      *  178458 - Coupons are being generated for incorrect currency  *
      *           and/or amount for positions where there is no       *
      *           record for the branch/customer/ccy/inv type on SE   *
      *           Standard Sett Ins file - amended fix 151542 so      *
      *           that processing for different settlement currency   *
      *           is done only if SETLED record found.                *
      *  130862 - Recompiled over changed ZLCDZ1.                     *
      *  151542 - Euro processing : due to changes in STDSED, the     *
      *           settlement currency can be different to the         *
      *           nominal or the value currency of the security       *
      *           If this new field is used, change the event currency*
      *           to this one and convert the settlement amount       *
      *  148428 - Amount due for dividend wrong (num dec places) due  *
      *           to EURO changes                                     *
      *  CEU011 - EMU Position/Risk Reporting                         *
      *  CSE005 - Effect of holidays on FRN Coupon Dates              *
      *           (recompilation due to change to ZNCD/ZLCD)          *
      *  101283 - For event 'PP', event date instead of payment date  *
      *           should be used when writing to customer position    *
      *           events file.                                        *
      *  119742 - Should only try to retrieve the Retail details if   *
      *           Retail 3 is switched on.  APPLY PART FIX 112937     *
      *  S01408 - Addition of hooks SE1480CCP5                        *
      *         - Addition of hooks SE1480CCP4                        *
      *         - Addition of hooks SE1480CCP3                        *
      *         - Addition of hooks SE1480CCP2                        *
      *         - Addition of hooks SE1480CCP1                        *
      *  073040 - For Mortgage-backed securities at maturity, if there*
      *           is no Redemption record on Security Diary event file*
      *           program shall look for the current factor on the    *
      *           latest Mortgage Repayment record. Fix 048177 applied*
      *  100228 - RECOMPILED FOR CHANGES TO SR ZLCDZ1.                *
      *  103150 - If settlement method is '04' and settlement account *
      *           is blank, retrieve prime account number             *
      *  103011 - The system creates a position settlement MT* for    *
      *           warrant which can lead to confusion for cashflow    *
      *  091254 - RECOMPILE OVER CHANGED ZLCDZ1 & ZNCDZ3              *
      *  088542 - If S01510 is on, dividend events not correctly      *
      *           generated                                           *
      *  087712 - Percentage price-based shares have dividend amount  *
      *           calculated 100 times too much                       *
      *  081439 - Wrong update of field tax rate - Recompile          *
      *  S01496 - Incorporation of SE Enhancements (S010982)          *
      *           Recompiled due to file change (SESWHTLO)            *
      *  S01522 - User Defined Correspondence                         *
      *  S01512 - Add payment date for coupon event due on a holiday  *
      *           and payment on next working date                    *
      *  076693 - Multiply/divide indicator if S01509 is active must  *
      *           be taken from SEDEVD (field SDMD)                   *
      *  S01510 - Dividend payments based on ex-date                  *
      *  S01509 - Value currency to be currency of issuer of payments *
      *  052254 - CURRENT FACTOR amended from 9,8 to 10,9             *
      *  050723 - Updating of Booking and Event Branches and their    *
      *           associated Company Codes was incorrect.             *
      *  062344 - Ensure correct database error handling.             *
      *  S01447 - Withholding tax. Calculate and subtract out tax     *
      *           withheld on Coupons and Dividends.                  *
      *  S01401 - MT5xx SWIFT Messages Feature:                       *
      *          - Recompiled due to changes to files.                *
      *  047360 - Company of Booking Branch needs to be filled in     *
      *  E37428 - For portfolio client (i.e. C1DI = 'S' or 'D') only  *
      *           access standard settlement record with currency.    *
      *           Otherwise use Investment type as well. Remove part  *
      *           of E16813.                                          *
      *  S01397 - Rel 10 Incorporation of BNZ SARs A46008 and A46013. *
      *          - Recompiled due to changes to files.                *
      *  E38182 - Second and third records were being generated       *
      *           when in single branch mode                          *
      *  E34974 - Events reported in the wrong branch                 *
      *  E34034 - Recompiled over changed printer file                *
      *  E34034 - Recompiled over changed printer file                *
      *  E29170 - Report Control Facility changes                     *
      *  E29978 - In SR/SROUT, for Value Date calculations, if the    *
      *           Position obtained from the Input Record has a Date  *
      *           preceding the Last Coupon Date, then any Ex-Coupon  *
      *           Nominal should not be deducted from total Position. *
      *  E27092 - Recompiled over changed SR/ZLCD                     *
      *  S01117 - Multibranching (Release 10.0)                       *
      *  E23955 - Fix E20085 incomplete - Interest processing at      *
      *           maturity and for Mortgage-backed securities has been*
      *           amended, so processing to calculate interest and add*
      *           to principal should be removed (Interest is now     *
      *           calculeted separately)                              *
      *  E21639 - Dividend Events should be based on Trade Daye Posn. *   E21639
      *  E21616 - Recompiled over changed SR/ZLCD.                    *   E21616
      *  E20651 - DB Error Numbers used in more than one place.       *   E20651
      *           New Error Numbers as follows:                       *   E20651
      *           DB ERROR 10 -> 13                                   *   E20651
      *           DB ERROR 10 -> 14                                   *   E20651
      *  E19101 - Short Positions changed to Positive Event Value.    *   E19101
      *  E20568 - ZACCZ changed to read Non-Diary Events File -       *   E20568
      *           renamed record format of SECEO.                     *   E20568
      *  E20085 - Interest and Coupon Calculations Rewrite:           *   E20085
      *          - Don't produce Coupon Events for Discount Securities*   E20085
      *          - Separate Coupon Event at Maturity so do not include*   E20085
      *            Interest in the Maturity Amount.                   *   E20085
      *          - Nominal field used in dividend amount calculation  *   E20085
      *            was not long enough.                               *   E20085
      *          - LF/SECEO member SEDEVD changed to omit RECI = 'C'. *   E20085
      *          - Coupon Amount should be calculated from Last Coupon*   E20085
      *            Date based on EVENT Date, not LCPN.                *   E20085
      *          - If Position changes on Coupon Date, Base Coupon    *   E20085
      *            calculates on Last Position prior to Coupon Date.  *   E20085
      *  E20086 - Mortgage-Backs and Current Factor Processing Rewrite*   E20086
      *          - CFCT on SECTYD is updated before this program is   *   E20086
      *            run, so (Old CF - New CF) is always zero. To get   *   E20086
      *            the correct Factor, read the prior MP Diary Event. *   E20086
      *          - As a CP Event is generated separately, it is very  *   E20086
      *            misleading to have it included in the MP Amount.   *   E20086
      *          - CF Work field redefined as (9,8) NOT (15,7).       *   E20086
      *          - MA process changed to use LF/SECEO to avoid mess.  *   E20086
      *          - MP - SETLL supposed to be SETGT (for CF).          *   E20086
      *  E16772 - The Dividend Payment Amount field SDDV has been     *   E16772
      *           replaced by the field SDVA, to increase its size    *   E16772
      *           from 9,4 to 13,8                                    *   E16772
      *  E16813 - Fetch correct Standard Settlement Instructions.     *   E16813
      *  S01176 - Securities Trading 3.1 (Australia).                 *   S01176
      *                                                               *
      *****************************************************************
      *
     FSECEF   IPE E           K        DISK
     F*********** SEDEVDF                           KRENAMESECEVDF        E20086
     FPICSPD  IF  E           K        DISK
     FCPSCF   IF  E           K        DISK
     FCPOSS   IF  E           K        DISK                               E21639
     F            CPOSNDF                           KRENAMECPOSNDO        E21639
     F            DPOSNDF                           KIGNORE               E21639
     FCPOSF   IF  E           K        DISK                           UC  088542
     F            CPOSNDF                           KRENAMECPOSNDX        088542
     F            CPOSFDF                           KRENAMECPOSFDX        088542
     FSECTY   IF  E           K        DISK
     F***SEDEV***IF**E           K        DISK                            E20086
     FSESWHTL0IF  E           K        DISK                               S01447
     F* Securities WHT details file                                       S01447
     FSECEO   IF  E           K        DISK                               E20086
     F**********  SNDEVDF                           KIGNORE         E20086E20568
     F            SNDEVDF                           KRENAMESNDEVDO        E20568
     F            SEDEVDF                           KRENAMESEDEVDO        E20086
     FINVTP   IF  E           K        DISK
     FSTDSED  IF  E           K        DISK
     FCLINT   IF  E           K        DISK
     F            CLINTCAF                          KIGNORE
     F************CLINTCBF                          KIGNORE
     F            CLINTCCF                          KIGNORE
     F            CLINTC1F                          KIGNORE
     F************CLINTSEF                          KIGNORE
     FTABSE   IF  E           K        DISK
     F            TABLETAF                          KIGNORE
     F            TABLETHF                          KIGNORE
     F************TABLETJF                          KIGNORE               S01117
     F            TABLETLF                          KIGNORE
     F            TABLETKF                          KIGNORE
     F            TABLETNF                          KIGNORE
     F            TABLETPF                          KIGNORE
     F            TABLETRF                          KIGNORE
     F            TABLETXF                          KIGNORE
     F**ICD*1*****TABTB10F                          KIGNORE
     F**ICD*2*****TABTB11F                          KIGNORE
     F            TABTB36F                          KIGNORE
     F            TABTB40F                          KIGNORE
     F            TABTE10F                          KIGNORE
     F            TABTE20F                          KIGNORE
     F**CCY*d.p.**TABTG10F                          KIGNORE
     F            TABTG20F                          KIGNORE
     F            TABLET2F                          KIGNORE
     F            TABLET3F                          KIGNORE
     F            TABLET5F                          KIGNORE
     FSEDEVA  IF  E                    DISK
     FSNDEFA  IF  E                    DISK
      *                                                                   CEU011
     FSDCURRL1IF  E           K        DISK                               CEU011
     FCPEVED  O   E                    DISK
     FCPEVEA  O   E                    DISK
     FSE1480AUO   E                    PRINTER
     F/COPY WNCPYSRC,SE1480F001
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   L1  - Security Shortname change                             *
     F*                                                               *
     F*   11  - Security Diary Events File read                       *
     F*   12  - Security Non-Diary Events File read                   *
     F*                                                               *
     F*   40  - Detail records read                                   *
     F*   50  - Work indicator                                        *
     F*   52  - Record not found (DBERR)                              *
     F*   53  - DBERR from called program                             *
     F*   54  - Record not found (Not a DB Error)                     *   050723
     F*                                                               *
     F* 90-99 - Used in Standard Subroutines                          *
     F*                                                               *
     F*   U7  - Database Error                                        *
     F*   U8  - Database / Control Error                              *
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  SRHASH - Add Event Amounts To Hash Totals                    *
     F*  GETCTY - Determine country of branch                         *   S01447
     F*  SROUT  - Set up Event record data & write Event record.      *
     F*                                                               *
     F*  SRPP   - Calculate PP Call Event Amount                      *
     F*  SRCP   - Calculate Coupon Event Amount                       *
     F*  SRDV   - Calculate Dividend Event Amount                     *
     F*  SRDE   - Calculate Dividend Event Amount                     *
     F*  SRMP   - Calculate Mort. Payment Event Amount                *
     F*  SRMA   - Calculate Maturity Event Amount                     *
     F*  CSTLOC - Get Customer's country of domicile                  *   S01447
     F*  CALCTX - Calculate withheld tax for Coupons/Dividends.       *   S01447
     F*  SRLR   - Total Time calculations                             *
     F*                                                               *
     F*  ZCONV  - CCY1 to CCY2 Amount conversion                      *
     F*  ZCNSD  - Calculate consideration                             *   087712
     F*  ZSYSTM - Access ICD 1 record                                 *
     F*  *PSSR  - Exception error routine                             *
     F*                                                               *
     F*****************************************************************
      /EJECT
     E                    CPY@    1   1 80
     E                    CUR       200  3                                CEU011
      *                                                                   CEU011
      ** Currency array                                                   CEU011
      *                                                                   CEU011
     E                    SRT       200  2 0                              CEU011
      *                                                                   CEU011
      ** Currency Sort Sequence array                                     CEU011
      *                                                                   CEU011
     E/COPY ZSRSRC,ZDATE2Z1                                               E20085
     E/COPY ZSRSRC,ZNCDZ1                                                 E20085
     E/COPY ZSRSRC,ZPOWERZ1
     E/COPY ZSRSRC,ZPOWER8Z1
     E/COPY ZSRSRC,ZHOLE                                                  S01510
      /EJECT
     I***SECEVDF*****11                                                   E20086
     ISEDEVDF     11                                                      E20086
      * Security Diary Events
     I              SDSN                            CCSS  L1
     I              SDED                            CCDT
     I              SDET                            CCET
      *
     ISNDEVDF     12
      * Security Non-Diary Events
     I              SNSN                            CCSS  L1
     I              SNDT                            CCDT
     I              SNET                            CCET
      *
     IPICSPDF
      * Customer Position Index
     I              PICN                            CCCN
     I***********   PIBR                            CCBR                  S01117
     I              PIBH                            CCBA                  S01117
      *
     ICPOSNDO                                                             E21639
      * Customer Position                                                 E21639
     I              CSCN                            CCCN                  E21639
     I***********   CSBR                            CCBR           E21639
     I              CSBA                            CCBA                  S01117
      *
     ISECTYDF
      * Securities
     I              NMCY                            CCNC
      *
     ICLINTCBF
      * Client's Master
     I              CRNM                            CCRN
     I              CTWN                            CCTR
      *
     I***SEDEVDF****                                                      E20086
     ISEDEVDO                                                             E20086
      * Security Diary Events
     I              RECI                            XRECI
     I              SDSN                            XSDSN
     I              SDED                            XSDED
     I              SDET                            XSDET
     I              SDNV                            XSDNV
     I**************SDDV                            XSDDV                 E16772
     I              SDVA                            XSDVA                 E16772
     I              SDCP                            XSDCP
     I              SRPT                            XSRPT
     I              SDTR                            XSDTR
     I              SRMI                            XSRMI
     I              SDPD                            XSDPD
     I              SDNC                            XSDNC
     I              SDPP                            XSDPP
     I              SDPC                            XSDPC
     I              SDTA                            XSDTA
     I              SDTP                            XSDTP
     I              SDRP                            XSDRP
     I              SDCV                            XSDCV
     I              SDCX                            XSDCX
     I              SDCE                            XSDCE
     I              SDMD                            XSDMD
     I              NMCY                            XNMCY
     I              SDAD                            XSDAD
     I              SDDT                            XSDDT
     I              LCD                             XLCD
     I              CHTP                            XCHTP
     I              TNLU                            XTNLU
     I              SDXD                            XSDXD                 S01510
      *
     ISEDEVAF
     I              NORE                            AUDIT1
      *
     ISNDEFAF
     I              NORE                            AUDIT2
      *                                                                                       CSE037
     IINVTPDF                                                                                 CSE037
     I              SFLG                            ISFLG                                     CSE037
     I*                                                                   S01117
     ISDMMOD    E DSSDMMODPD                                              119742
     I**  Data structure for module details                               119742
     I/COPY WNCPYSRC,SE1480I001
     I*                                                                   119742
     ISDBRCH    E DSSDBRCHPD                                              S01117
     I** Branch Details                                                   S01117
     I*                                                                   S01117
     ISECNTR    E DSSECNTRPD                                              S01447
     I** SE Country tax rate details                                      S01447
     I*                                                                   S01447
     ISECBTX    E DSSECBTXPD                                              S01447
     I** SE Country to Branch tax rate details                            S01447
     I*                                                                   103150
     ISDRETL    E DSSDRETLPD                                              103150
     I** Retail ICD details                                               103150
     I*                                                                   S01447
      *                                                                   CEU011
     ISCSARD    E DSSCSARDPD                                              CEU011
      **  Switchable Features File                                        CEU011
     IDSFDY     E DSDSFDY                                                 S01117
     I*  FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE               S01117
     I*                                                                   S01447
     IDSSDY     E DSDSSDY                                                 S01447
     I*  SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE               S01447
     I*                                                                   S01117
      *                                                                                       CSE028
      ** DS for customer/book standard settlement instruction                                 CSE028
      **  to be passed to SESSIR0                                                             CSE028
      *                                                                                       CSE028
     IPCBSTD    E DSSTDSED                    2                                               CSE028
     I              LCD                             SLCD                                      CSE028
      *                                                                                       CSE028
      ** Data structure for standard additional settlement details                            CSE028
      ** for customer/book to be passed to SESSIR0                                            CSE028
      *                                                                                       CSE028
     IPCBSAD    E DSSTDADSED                  8                                               CSE028
      *                                                                                       CSE028
     IRUNDAT      DS                                                      S01117
     I** Data area RUNDAT                                                 S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
      *                                                                   S01117
      *
      ***  Local Data Area for DB ERROR Information
     ILDA         DS                            256                       S01117
     I**********                            134 183 #DBLOT         S01117 170108
     I**********  DS                                               S01117 170108
     I                                      134 183 DBLOT                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     I*                                                                   S01117
     I***********LDA        UDS                            256            S01117
     I***********                           134 177 #DBLOT                S01117
     I*********** DS                                                      S01117
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 177 DBASE                 S01117
     I*
     I           SDS
     I                                      244 246 WSID
     I                                      254 263 USID
      *
      * Customer Position - Input
     I            DS
     I                                        1  19 CUST
      *
     I**********                              1   60CCCN                                      CSD027
     I                                        1   6 CCCN                                      CSD027
     I***********                             7   90CCBR                  S01117
     I                                        7   9 CCBA                  S01117
     I                                       10  19 CCSS
      *
      * Customer Position - Chain
     I            DS
     I                                        1  19 CUST1
      *
     I**********                              1   60CSCN                                      CSD027
     I                                        1   6 CSCN                                      CSD027
     I***********                             7   90CSBR                  S01117
     I                                        7   9 CSBA                  S01117
     I                                       10  19 CSSC
      *
      * Standard Settlement Instr.- Chain
     I            DS
     I                                        1  15 SSTD
      *
     I***********                             1   30XXBR                  S01117
     I                                        1   3 XXBR                  S01117
     I                                        4   90XXCN
     I                                       10  12 CCEC
     I                                       13  15 SITP
     I*                                                                   103150
     I* Prime account code                                                103150
     I            DS                                                      103150
     I**********                              1  12 PRACCT                             103150 CGL029
     I                                        1  18 PRACCT                                    CGL029
     I                                        1   6 PRCNUM                103150
     I**********                              7  10 PRACOD                             103150 CGL029
     I**********                             11  12 PRACSQ                             103150 CGL029
     I                                        7  16 PRACOD                                    CGL029
     I                                       17  18 PRACSQ                                    CGL029
     I*
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *                                                                   E20085
     I/COPY ZSRSRC,ZNCDZ2                                                 E20085
     I/COPY ZSRSRC,ZHOLI                                                  S01510
      *                                                                   E20085
     C/EJECT
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
      *
      ***  Initial Processing
      *
      * Customer Position (LF/CPSCF)
      *
     C           KCPS      KLIST
     C***********          KFLD           CCBR                            S01117
     C                     KFLD           CCBA                            S01117
     C                     KFLD           CCSS
     C                     KFLD           CCCN
     C                     KFLD           CCDT
      *
      * Investment Type (LF/INVTP)
      *
     C           KINV      KLIST
     C                     KFLD           CCNC
     C                     KFLD           SITP
      *
      **Security*Diary*(LF/SEDEV)**************************************   E20086
      **   (LF/SECEO)                                                     E20086
      **   Security Diary in 'Security/Event Type/Reverse Date' order.    E20086
      *
     C           KSED      KLIST
     C                     KFLD           CCSS
     C***********          KFLD           MATY                            E20086
     C***********          KFLD           TYPE02  2                       E20086
     C                     KFLD           XSDET                           E20086
     C                     KFLD           XSDED                           E20086
      *
      * Standard Settlement Instructions
      *
     C           KSTD      KLIST
     C***********          KFLD           CCBR                            S01117
     C                     KFLD           CCBA                            S01117
     C                     KFLD           CCCN
     C                     KFLD           SIBK                                                CSE028
     C                     KFLD           CCEC
     C                     KFLD           SITP
     C                     KFLD           SPTFR                                               CSE028
      *                                                                                       CSE028
     C                     MOVE *BLANKS   SIBK                                                CSE028
     C                     MOVE *BLANKS   SPTFR                                               CSE028
      *
      * Standard Settlement Instructions  (Partial key)
      *
     C           KSTDA     KLIST
     C***********          KFLD           CCBR                            S01117
     C                     KFLD           CCBA                            S01117
     C                     KFLD           CCCN
     C                     KFLD           SIBK                                                CSE028
     C                     KFLD           CCEC
      *
      * TO CALCULATE INTEREST CALL --- ZACRFC
      * Accrue Interest on Customer Positions
      *
     C           ACRFC     PLIST
     C***********          PARM           LCPN                            E20085
     C                     PARM           ZZLCD                           E20085
     C                     PARM           CCDT
     C***********          PARM CCBR      #CCBR   30                      S01117
     C                     PARM CCBA      #CCBA   3                       S01117
     C**********           PARM CCCN      PCCCN   60                                          CSD027
     C                     PARM CCCN      PCCCN   6                                           CSD027
     C                     PARM           CCSS
     C                     PARM #NCDP     PNCDP   10
     C                     PARM           #AMT   150
      *
     C/COPY WNCPYSRC,SE1480C001
      /EJECT
      *================================================================
      *
      ***  First Cycle Processing
      *
     C           *IN40     IFEQ '0'
     C*                                                                   S01117
     C**  Define like field definitions                                   S01117
     C*                                                                   S01117
     C************LIKE     DEFN A8BRCD    @@BKBR                   S01117 050723
     C************LIKE     DEFN A8BRCD    @@SEBR                   S01117 050723
     C************LIKE     DEFN A8CMCD    @@BKCY                   S01117 050723
     C************LIKE     DEFN A8CMCD    @@SECY                   S01117 050723
     C************LIKE     DEFN A8BICN    @@SECS                   S01117 050723
     C           *LIKE     DEFN A8CMCD    WSECY                           050723
     C           *LIKE     DEFN A8BICN    WSBICN                          050723
     C           *LIKE     DEFN CFCT      CFDIF                           052254
      *
     C           *LIKE     DEFN A8BRCD    UBRCH            prev branch    S01447
     C           *LIKE     DEFN CCCN      UCCCN            prev cust no   S01447
     C           *LIKE     DEFN CLOC      UBRLOC           brch ctry      S01447
     C           *LIKE     DEFN CLOC      UCLOC            cust's ctry    S01447
     C           *LIKE     DEFN CCEA      UTXSRC           src tax amt    S01447
     C           *LIKE     DEFN CCEA      UTXUSR           usr tax amt    S01447
     C           *LIKE     DEFN S1RASO    UTXRSR           src tax rate   S01447
     C           *LIKE     DEFN TBRAUS    UTXRUS           usr tax rate   S01447
     C           *LIKE     DEFN TBDLOR    UDLOR            ded.tax local  S01447
     C           *LIKE     DEFN CCCN      UBICN            Int. cust no   S01117
     C********** *LIKE     DEFN CCCN      WCCDT                                        S01510 CSD027
     C                     Z-ADDWCCDT     WCCDT   60                                          CSD027
     C           *LIKE     DEFN CCEC      WCCEC                                               197766
     C           *LIKE     DEFN CCSS      WCCSS                                               197766
      **  Fields used event ccy exch rate and mult/div indicator          151542
     C           *LIKE     DEFN SPOT      EEXCH                           151542
     C           *LIKE     DEFN MDIN      EMDIN                           151542
      *                                                                   S01447
      * Prepare LDA for the database error output
      *
     C***********          IN   LDA                                       S01117
     C           *NAMVAR   DEFN           LDA                             170108
     C           *LOCK     IN   LDA                                       S01117
     C**********           MOVE *BLANKS   #DBLOT                          170108
     C**********           OUT  LDA                                       170108
      *
     C                     MOVE *BLANKS   DBLOT
     C                     MOVEL'SE1480'  DBPGM
     C                     OUT  LDA                                       170108
     C                     MOVE ' '       WERR    1                       170108
      *                                                                   S01117
      * Access Data area RUNDAT for mutli branching indicator             S01117
      *                                                                   S01117
     C           *NAMVAR   DEFN           RUNDAT                          S01117
     C                     IN   RUNDAT                                    S01117
     C*                                                                   119742
     C**  Get module details using access object                          119742
     C*                                                                   119742
     C                     CALL 'AOMMODR0'                                119742
     C                     PARM '*MSG   ' @RTCD                           119742
     C                     PARM '*FIRST ' @OPTN                           119742
     C           SDMMOD    PARM SDMMOD    DSFDY                           119742
     C*                                                                   119742
     C**  Check if error occurred                                         119742
     C*                                                                   119742
     C           @RTCD     IFNE *BLANKS                                   119742
     C           *LOCK     IN   LDA                                       119742
     C                     MOVEL'SDMMODPD'DBFILE           ***************119742
     C                     Z-ADD50        DBASE            * DB ERROR 50 *119742
     C                     SETON                       U7U8***************119742
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     119742
     C                     END                                            119742
      *
      * Access the I.C.D. record 1  (PF/TABTB10)
      *
     C                     EXSR ZSYSTM
      *
      * Error in ZSYSTM
      *
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR
     C                     MOVEL'TABLE'   DBFILE           ***************
     C***********          MOVEL'01'      DBASE            **DB*ERROR*01**S01117
     C                     Z-ADD01        DBASE            * DB ERROR 01 *S01117
     C                     MOVELZTABKY    DBKEY            ***************
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
      *
     C                     ELSE
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1480CCP1                                           S01408
      *                                                                   S01408
      ** Access SAR details file to see if CSE035 is installed                                CSE035
      *                                                                                       CSE035
     C                     CALL 'AOSARDR0'                                                    CSE035
     C                     PARM *BLANKS   @RTCD                                               CSE035
     C                     PARM '*VERIFY' @OPTN                                               CSE035
     C                     PARM 'CSE035'  @SARD                                               CSE035
      *                                                                                       CSE035
     C           @RTCD     IFEQ *BLANK                                                        CSE035
     C                     MOVE 'Y'       CSE035  1                                           CSE035
     C                     ELSE                                                               CSE035
     C                     MOVE 'N'       CSE035                                              CSE035
     C                     ENDIF                                                              CSE035
      *                                                                   S01447
     C                     CALL 'AOSARDR0'                                S01447
     C                     PARM *BLANKS   @RTCD                           S01447
     C                     PARM '*VERIFY' @OPTN                           S01447
     C                     PARM 'S01447'  @SARD   6                       S01447
      *                                                                   S01447
     C           @RTCD     IFEQ *BLANK                                    S01447
     C                     MOVE 'Y'       S01447  1                       S01447
     C                     ELSE                                           S01447
     C                     MOVE 'N'       S01447                          S01447
     C                     END                                            S01447
     C*                                                                   S01509
     C** Check if Value Currency is active                                S01509
     C*                                                                   S01509
     C                     CALL 'AOSARDR0'                                S01509
     C                     PARM *BLANKS   @RTCD                           S01509
     C                     PARM '*VERIFY' @OPTN                           S01509
     C                     PARM 'S01509'  @SARD   6                       S01509
     C*                                                                   S01509
     C           @RTCD     IFEQ *BLANK                                    S01509
     C                     MOVE 'Y'       S01509  1                       S01509
     C                     ELSE                                           S01509
     C                     MOVE 'N'       S01509                          S01509
     C                     END                                            S01509
     C*                                                                   S01510
     C** Check if Dividend Payments is active                             S01510
     C*                                                                   S01510
     C                     CALL 'AOSARDR0'                                S01510
     C                     PARM *BLANKS   @RTCD                           S01510
     C                     PARM '*VERIFY' @OPTN                           S01510
     C                     PARM 'S01510'  @SARD   6                       S01510
     C*                                                                   S01510
     C           @RTCD     IFEQ *BLANK                                    S01510
     C                     MOVE 'Y'       S01510  1                       S01510
     C                     OPEN CPOSF                                     088542
     C                     ELSE                                           S01510
     C                     MOVE 'N'       S01510                          S01510
     C                     END                                            S01510
     C*                                                                   S01512
     C** Check if Dividend Payments based on ex-date is active            S01512
     C*                                                                   S01512
     C                     CALL 'AOSARDR0'                                S01512
     C                     PARM *BLANKS   @RTCD                           S01512
     C                     PARM '*VERIFY' @OPTN                           S01512
     C                     PARM 'S01512'  @SARD   6                       S01512
     C*                                                                   S01512
     C           @RTCD     IFEQ *BLANK                                    S01512
     C                     MOVE 'Y'       S01512  1                       S01512
     C                     ELSE                                           S01512
     C                     MOVE 'N'       S01512                          S01512
     C                     END                                            S01512
     C/COPY WNCPYSRC,SE1480C006
      *
      *  Hash Totals Output  HRWN  (15/0)   Whole Numbers
      *                      HRDC  (3/0)    Decimal Places
      *
     C                     Z-ADD0         HRWN   150
     C                     Z-ADD0         HRDC    30
      *
      ** Retrieve prime account code                                      103150
      *                                                                   103150
     C           BGRTBN    IFEQ 'Y'                                       119742
     C           BGNXST    OREQ 'Y'                                       119742
     C                     CALL 'AORETLR0'                                103150
     C                     PARM *BLANKS   @RTCD   7                       103150
     C                     PARM '*FIRST ' @OPTN   7                       103150
     C           SDRETL    PARM SDRETL    DSFDY                           103150
     C           @RTCD     IFNE *BLANKS                                   103150
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR            ***************103150
     C                     Z-ADD15        DBASE            **DB ERROR 15**103150
     C                     MOVEL'SDRETLL1'DBFILE           ***************103150
     C                     MOVEL*BLANKS   DBKEY                           103150
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     103150
     C                     END                                            103150
     C                     END                                            119742
      *                                                                   103150
     C                     MOVE '1'       *IN40
      *
     C                     END
      *                                                                   CEU011
      ** Call Access pgm AOSARDR0 to check if CEU011 is ON.               CEU011
      *                                                                   CEU011
     C                     MOVE 'N'       CEU011  1                       CEU011
     C                     CALL 'AOSARDR0'                                CEU011
     C                     PARM *BLANKS   @RTCD                           CEU011
     C                     PARM '*VERIFY' @OPTN                           CEU011
     C                     PARM 'CEU011'  @SARD   6                       CEU011
     C           SCSARD    PARM SCSARD    DSFDY                           CEU011
      *                                                                   CEU011
     C           @RTCD     IFEQ *BLANKS                                   CEU011
     C                     MOVE 'Y'       CEU011                          CEU011
     C                     END                                            CEU011
      *                                                                   CEU011
     C           @RTCD     IFNE *BLANKS                                   CEU011
     C           @RTCD     ANDNE'*NRF   '                                 CEU011
      *                                                                   CEU011
      ** Call to program ended in error                                   CEU011
      *                                                                   CEU011
     C           *LOCK     IN   LDA                                       CEU011
     C                     MOVE *ON       *INU7                           CEU011
     C                     MOVE *ON       *INU8                           CEU011
     C                     MOVE *ON       *INLR                           CEU011
     C                     MOVEL'CEU011'  DBKEY            ************   CEU011
     C                     MOVE 'SCSARDPD'DBFILE           * DBERR 06 *   CEU011
     C                     Z-ADD6         DBASE            ************   CEU011
     C                     MOVEL'SE1480'  DBPGM                           CEU011
     C                     OUT  LDA                                       CEU011
     C                     EXSR *PSSR                                     CEU011
     C                     ENDIF                                          CEU011
      *                                                                   CEU011
     C********** CEU011    IFEQ 'Y'                                                    CEU011 241795
     C                     Z-ADD1         A       30                      CEU011
     C           *LOVAL    SETLLSDCURRL1                                  CEU011
     C                     READ SDCURRL1                 70               CEU011
      *                                                                   CEU011
     C           A         DOWLE200                                       CEU011
     C           *IN70     ANDEQ*OFF                                      CEU011
      *                                                                   CEU011
     C                     MOVE A6CYCD    CUR,A                           CEU011
     C                     Z-ADDA6SSNB    SRT,A                           CEU011
      *                                                                   CEU011
     C                     READ SDCURRL1                 70               CEU011
     C                     ADD  1         A                               CEU011
     C                     ENDDO                                          CEU011
     C**********           ENDIF                                                       CEU011 241795
      *                                                                   CEU011
      ** Check if CSE023 - Treaty Tax is on.                              187848
      *                                                                   187848
     C                     MOVE 'N'       CSE023  1                       187848
     C                     CALL 'AOSARDR0'                                187848
     C                     PARM *BLANKS   @RTCD   7                       187848
     C                     PARM '*VERIFY' @OPTN   7                       187848
     C                     PARM 'CSE023'  @SARD   6                       187848
      *                                                                   187848
     C           @RTCD     IFEQ *BLANK                                    187848
     C                     MOVE 'Y'       CSE023                          187848
     C                     ENDIF                                          187848
      *                                                                   187848
      ** Check if CSE028 feature is installed                                                 CSE028
      *                                                                                       CSE028
     C                     MOVE 'N'       CSE028  1                                           CSE028
     C                     CALL 'AOSARDR0'                                                    CSE028
     C                     PARM *BLANKS   @RTCD                                               CSE028
     C                     PARM '*VERIFY' @OPTN                                               CSE028
     C                     PARM 'CSE028'  @SARD                                               CSE028
      *                                                                                       CSE028
     C           @RTCD     IFNE *BLANKS                                                       CSE028
     C           @RTCD     ANDNE'*NRF   '                                                     CSE028
     C           *LOCK     IN   LDA                                                           CSE028
     C                     MOVEL@SARD     DBKEY                                               CSE028
     C                     MOVEL'SCSARDPD'DBFILE                                              CSE028
     C                     Z-ADD19        DBASE                                               CSE028
     C                     OUT  LDA                                                           CSE028
     C                     MOVE *ON       *INU7                                               CSE028
     C                     MOVE *ON       *INU8                                               CSE028
     C                     MOVE *ON       *INLR                                               CSE028
     C                     EXSR *PSSR                                                         CSE028
     C                     ENDIF                                                              CSE028
      *                                                                                       CSE028
     C           @RTCD     IFEQ *BLANKS                                                       CSE028
     C                     MOVE 'Y'       CSE028                                              CSE028
     C                     ENDIF                                                              CSE028
      *                                                                                       CSE028
     C                     END
      *================================================================
      /EJECT
      *================================================================
      *
      *  L E V E L    B R E A K  ---   S E C U R I T Y
      *
      *   Access Securities details file  (LF/SECTY)
      *    at change of the Security Shortname (LF/SECEF - CCSS)
      *
     C           *INL1     IFEQ '1'
     C           *IN40     ANDEQ'1'
      *
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1480CCP2                                           S01408
      *                                                                   S01408
     C           CCSS      CHAINSECTY                52
     C           *IN52     IFEQ '1'
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR            ***************
     C***********          MOVEL'02'      DBASE            **DB*ERROR*02**S01117
     C                     Z-ADD02        DBASE            * DB ERROR 02 *S01117
     C                     MOVEL'SECTY'   DBFILE           ***************
     C                     MOVELCCSS      DBKEY
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
     C                     ELSE
      *
      *   Set >  CCEC - Event Ccy  (ie. Settlement Ccy)  to Equal
      *         Payment Ccy (if non-blank), else Value Ccy (if non-balnk),
      *         else Nominal Ccy. (LF/SECTY)
      *
     C** If S01509 is active, do not set up event currency at change      S01509
     C** in security                                                      S01509
     C*                                                                   S01509
     C           S01509    IFEQ 'N'                                       S01509
     C                     MOVE CCNC      CCEC
     C           VLCY      IFNE '   '
     C                     MOVE VLCY      CCEC
     C                     END
     C           SPYC      IFNE '   '
     C                     MOVE SPYC      CCEC
     C                     END
     C                     END                                            S01509
      *
      *   Set >  #NCDP  - Nominal Ccy Decimal Positions.
      *
     C                     MOVE *BLANKS   KEY
     C                     MOVEL'20'      KEY
     C                     MOVE '1'       ZWK4
     C                     MOVELCCNC      ZWK4    4
     C                     MOVE ZWK4      KEY
      *
     C           KEY       CHAINTABTG10F             52
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR
     C                     MOVE '1'       *IN52            ***************
     C***********          MOVEL'03'      DBASE            **DB*ERROR*03**S01117
     C                     Z-ADD03        DBASE            * DB ERROR 03 *S01117
     C                     MOVEL'TABTG10F'DBFILE           ***************
     C                     MOVELKEY       DBKEY
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
     C                     ELSE
      *
     C                     MOVE CDP       #NCDP   10
     C** Set exchange rate and mult/div indicator                         151542
     C                     Z-ADDSPOT      EEXCH                           151542
     C                     MOVE MDIN      EMDIN                           151542
     C                     Z-ADDCDP       #ECDP   10                      151542
      *
      *  Set  >  #ECDP  - Event Ccy Decimal Positions.
     C** If S01509 is active, this process should be performed later      S01509
      *
     C           S01509    IFEQ 'N'                                       S01509
     C                     MOVELCCEC      ZWK4    4
     C                     MOVE ZWK4      KEY
      *
     C           KEY       CHAINTABTG10F             52
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR
     C                     MOVE '1'       *IN52            ***************
     C***********          MOVEL'04'      DBASE            **DB*ERROR*04**S01117
     C                     Z-ADD04        DBASE            * DB ERROR 04 *S01117
     C                     MOVEL'TABTG10F'DBFILE           ***************
     C                     MOVELKEY       DBKEY
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
     C                     ELSE
      *
     C                     MOVE CDP       #ECDP   10
     C                     END
     C                     END                                            S01509
     C                     END
      *
      *  Set  >  PROT   - Processing Type from the Investment Type's Rec.
      *
     C                     MOVE ' '       PROT
      *
     C           *IN52     IFEQ '0'
     C           KINV      CHAININVTP                52
      *
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR
     C                     MOVE '1'       *IN52            ***************
     C***********          MOVEL'05'      DBASE            **DB*ERROR*05**S01117
     C                     Z-ADD05        DBASE            * DB ERROR 05 *S01117
     C                     MOVEL'INVTP   'DBFILE           ***************
     C                     MOVELCCNC      WRK6    6
     C                     MOVE SITP      WRK6
     C                     MOVELWRK6      DBKEY
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
     C                     END
     C                     END
      *
     C/COPY WNCPYSRC,SE1480C011
     C                     END
     C                     END
      *                                                                   187848
      ** If CSE023 is switched ON, check if the event is affected by      187848
      ** Treaty tax changes with position settlement being genertated.    187848
      *                                                                   187848
     C                     MOVE 'Y'       NEEDED  1                       187848
     C           CSE023    IFEQ 'Y'                                       187848
     C           CRTT      ANDNE*BLANK                                    187848
      *                                                                   187848
      ** For Dividend event, if position settlement already generated     187848
      ** then donot process the event.                                    187848
      *                                                                   187848
     C           *IN11     IFEQ '1'                                       187848
     C           CCET      ANDEQ'DV'                                      187848
     C           SDDT      ANDNE0                                         187848
     C                     MOVE 'N'       NEEDED                          187848
     C                     ENDIF                                          187848
      *                                                                   187848
      ** For Coupon event, if position settlement already generated       187848
      ** then donot process the event.                                    187848
      *                                                                   187848
     C           *IN12     IFEQ '1'                                       187848
     C           CCET      IFEQ 'CP'                                      187848
     C           CCET      OREQ 'MA'                                      187848
     C           CCET      IFEQ 'CP'                                      187848
     C                     MOVE 'CG'      XSDET                           187848
     C                     ELSE                                           187848
     C                     MOVE 'MG'      XSDET                           187848
     C                     ENDIF                                          187848
     C                     Z-ADDCCDT      XSDED                           187848
     C           KSED      CHAINSECEO                44                   187848
     C           *IN44     IFEQ '0'                                       187848
     C                     MOVE 'N'       NEEDED                          187848
     C                     ELSE                                           187848
     C                     MOVE CCET      XSDET                           187848
     C           KSED      CHAINSECEO                44                   187848
     C           *IN44     IFEQ '0'                                       187848
     C                     MOVE 'N'       NEEDED                          187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
      *
      *================================================================
      /EJECT
      *================================================================
      *
      ***  Main Processing
      *
      ** Maintain the 'transactions read' count.                          187848
      *                                                                   187848
     C           *IN40     IFEQ '1'                                       187848
     C           *IN52     ANDEQ'0'                                       187848
     C           *IN11     IFEQ '1'                                       187848
      *                                                                   187848
      ** Diary Event                                                      187848
      *                                                                   187848
     C                     ADD  1         IN01    50                      187848
     C                     ELSE                                           187848
      *                                                                   187848
      ** Non-Diary Event                                                  187848
      *                                                                   187848
     C                     ADD  1         IN02    50                      187848
     C                     ENDIF                                          187848
     C                     ENDIF                                          187848
      *                                                                   187848
      * Maintain the 'transactions read' count.
     C           *IN40     IFEQ '1'
     C           *IN52     ANDEQ'0'
     C           NEEDED    ANDEQ'Y'                                       187848
      *                                                                   187848
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1480CCP3                                           S01408
      *                                                                   S01408
      *
      ** Transaction count being moved forwards.                          187848
      *                                                                   187848
     C************IN11     IFEQ '1'                                       187848
      *****Diary*Event                                                    187848
     C***********          ADD  1         IN01    50                      187848
     C***********          ELSE                                           187848
      *****Non-Diary*Event                                                187848
     C***********          ADD  1         IN02    50                      187848
     C***********          END                                            187848
     C*                                                                   S01509
     C** If S01509 is active, set up the event currency and number of     S01509
     C** decimal places after every event read from SECEF as follows      S01509
     C*                                                                   S01509
     C           S01509    IFEQ 'Y'                                       S01509
     C                     SELEC                                          S01509
     C           CCET      WHEQ 'DV'                                      S01509
     C           CCET      OREQ 'DE'                                      S01509
     C           CCET      OREQ 'CP'                                      S01509
     C                     MOVE VLCY      CCEC                            S01509
     C           CCET      WHEQ 'MA'                                      S01509
     C                     MOVE 'RC'      XSDET                           S01509
     C                     Z-ADDMATY      XSDED                           S01509
     C           KSED      CHAINSEDEVDO              51                   S01509
     C           *IN51     IFEQ '0'                                       S01509
     C           XSDCX     ANDNE*BLANKS                                   S01509
     C                     MOVE XSDCX     CCEC                            S01509
     C                     ELSE                                           S01509
     C                     MOVE CCNC      CCEC                            S01509
     C                     END                                            S01509
     C                     OTHER                                          S01509
     C                     MOVE CCNC      CCEC                            S01509
     C                     ENDSL                                          S01509
     C*                                                                   S01509
     C** If the event currency is different from the nominal currency     S01509
     C** get the number of decimal places (#ECDP) for this currency       S01509
     C*                                                                   S01509
     C           CCNC      IFNE CCEC                                      S01509
     C                     MOVE *BLANKS   KEY                             S01509
     C                     MOVEL'20'      KEY                             S01509
     C                     MOVE '1'       ZWK4                            S01509
     C                     MOVELCCEC      ZWK4    4                       S01509
     C                     MOVE ZWK4      KEY                             S01509
     C*                                                                   S01509
     C           KEY       CHAINTABTG10F             52                   S01509
     C           *IN52     IFEQ '1'                                       S01509
     C           RECI      ORNE 'D'                                       S01509
     C                     MOVE '1'       *INLR                           S01509
     C           *LOCK     IN   LDA                                       S01509
     C                     MOVE '1'       *IN52            ***************S01509
     C                     Z-ADD21        DBASE            * DB ERROR 21 *S01509
     C                     MOVEL'TABTG10F'DBFILE           ***************S01509
     C                     MOVELKEY       DBKEY                           S01509
     C                     SETON                     U7U8                 S01509
     C                     OUT  LDA                                       S01509
     C                     EXSR *PSSR                                     S01509
     C                     ELSE                                           S01509
     C                     MOVE CDP       #ECDP   10                      S01509
     C                     Z-ADDSPOT      EEXCH                           151542
     C                     MOVE MDIN      EMDIN                           151542
     C                     END                                            S01509
     C                     END                                            S01509
      *                                                                                       197766
      ** Keep original value of CCEC for processing of other depots                           197766
      ** under the same Security.                                                             197766
      *                                                                                       197766
     C                     MOVE CCSS      WCCSS                                               197766
     C                     MOVE CCEC      WCCEC                                               197766
     C*                                                                   S01509
     C                     END                                            S01509
      *
      *   Access all Customer Positions for this Security
     C                     MOVE '0'       *IN50
      *                                                                   E21639
      *   Access current trade date position for dividend events          E21639
      *                                                                   E21639
     C           CCET      IFEQ 'DV'                                      E21639
     C           CCET      OREQ 'DE'                                      E21639
      *                                                                   E21639
     C           CCSS      SETLLCPOSS                                     E21639
      *
      ***  Do Until End of File or DB Error
      *                                                                   E21639
     C           *IN50     DOUEQ'1'                                       E21639
     C           *IN52     OREQ '1'                                       E21639
     C           CCSS      READECPOSS                    50               E21639
      *                                                                   E21639
     C           CSNT      IFEQ 0                                                           AR906833
     C           CSNV      ANDEQ0                                                           AR906833
     C           CSEX      ANDEQ0                                                           AR906833
     C           CSNS      ANDEQ0                                                           AR906833
     C                     MOVE '1'       *IN50                                             AR906833
     C                     ENDIF                                                            AR906833
      *                                                                                     AR906833
     C           *IN50     IFEQ '0'                                       E21639
     C                     ADD  1         PCNT    50                      E21639
     C                     EXSR GETCTY                                    S01447
      *                                                                   E21639
      * Set up Output field values :                                      E21639
      * Write a record to the event's file                                E21639
      *                                                                   E21639
     C           *IN52     IFEQ '0'                                       S01447
     C                     EXSR SROUT                                     E21639
     C                     END                                            S01447
      *                                                                   E21639
     C                     END                                            E21639
     C                     END                                            E21639
      *                                                                   E21639
     C                     ELSE                                           E21639
      *                                                                   E21639
     C           CCSS      SETLLPICSPD
      *
      ***  Do Until End of File or DB Error
      *
     C           *IN50     DOUEQ'1'
     C           *IN52     OREQ '1'
     C           CCSS      READEPICSPDF                  50
      *
     C           *IN50     IFEQ '0'
     C                     ADD  1         PCNT    50
     C                     EXSR GETCTY                                    S01447
      *
      * Obtain Position at Event Date (LF/CPSCF)
      * Set up Output field values :
      * Write a record to the event's file
     C           *IN52     IFEQ '0'                                       S01447
     C                     EXSR SROUT
     C                     END                                            S01447
      *
     C                     END
     C                     END
     C                     END                                            E21639
     C                     END
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *                                                               *
     CLR                   EXSR SRLR
      *                                                               *
      *================================================================
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRHASH - Subroutine to add Event Amounts To Hash Totals      *
      *           (Determine Dec. Posn. and ADD as Positive Values)   *
      *                                                               *
      *       Input   #HAMT (15/0)   Un-edited Amount                 *
      *       Output  HRWN  (15/0)   Whole Numbers                    *
      *               HRDC   (3/0)   Decimal Places                   *
      *                                                               *
      *****************************************************************
      *
     C           SRHASH    BEGSR                           *** SRHASH ***
      *
      *    Set up fields to be hashed as positive
      *
     C           #HAMT     IFGE 0
     C                     Z-ADD#HAMT     #HAMT  150
     C                     ELSE
     C                     Z-SUB#HAMT     #HAMT
     C                     END
      *
      *   Split up the hash amount as  Integer & Decimal parts
      *
     C                     MOVEL#HAMT     #HI    120
     C                     MOVE #HAMT     #HD     30
      *
      *   Add to the DECIMAL HASH TOTAL part and check for carry
      *
     C                     ADD  #HD       HRDC    30
      *
     C           HRDC      IFLT #HD
     C                     ADD  1         #HI
     C                     END
      *
      *   Add to the INTEGER HASH TOTAL part
      *
     C                     ADD  #HI       HRWN   150
      *
     C                     ENDSR
      *
      *****************************************************************   S01447
      /EJECT                                                              S01447
      *****************************************************************   S01447
      *                                                               *   S01447
      *  GETCTY - If withholding tax on(S01447), and branch has       *   S01447
      *           changed, access new branch record and determine the *   S01447
      *           branch's country.                                   *   S01447
      *  CALLED BY:    MAIN                                           *   S01447
      *  CALLS:        NONE                                           *   S01447
      *                                                               *   S01447
      *****************************************************************   S01447
      *                                                                   S01447
     C           GETCTY    BEGSR                                       *  S01447
      *                                                                   S01447
     C           S01447    IFEQ 'Y'                        *B1            S01447
     C           UBRCH     ANDNECCBA                                      S01447
      *                                                                   S01447
     C**********           CALL 'AOBRCHR0'                                             S01447 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD                           S01447
     C                     PARM '*KEY   ' @OPTN                           S01447
     C                     PARM CCBA      @DSNB                           S01447
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        S01447 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C           @RTCD     IFNE *BLANKS                    *B2            S01447
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INLR                           S01447
     C                     MOVE '1'       *IN52                           S01447
     C                     MOVEL'SDBRCHPD'DBFILE           ***************S01447
     C                     MOVELCCBA      DBKEY            ** DB ERROR 16 S01447
     C                     Z-ADD16        DBASE            ***************S01447
     C                     SETON                       U7U8               S01447
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01447
     C                     ELSE                            *X2            S01447
      *                                                                   S01447
     C                     MOVE A8BICN    UBICN                           S01447
     C           UBICN     CHAINCLINTCBF             52    *B3            S01447
     C           *IN52     IFEQ '1'                                       S01447
     C           RECI      ORNE 'D'                                       S01447
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR                           S01447
     C                     MOVE '1'       *IN52            ***************S01447
     C                     Z-ADD17        DBASE            * DB ERROR 17 *S01447
     C                     MOVEL'CLINTCBF'DBFILE           ***************S01447
     C                     MOVELUBICN     DBKEY                           S01447
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01447
     C                     ELSE                            *X3            S01447
      *                                                                   S01447
     C                     MOVE CLOC      UBRLOC                          S01447
     C                     MOVE CCBA      UBRCH            SAV COMP BR    S01447
     C                     END                             *E3            S01447
     C                     END                             *E2            S01447
     C                     END                             *E1            S01447
      *                                                                   S01447
     C                     ENDSR                                          S01447
      *                                                                   S01447
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SROUT  - Subroutine to obtain 'Position At Event Date', Set  *
      *           up data for the Event record and write this record  *
      *           to the Events file (PF/CPEVEDF).                    *
      *                                                               *
      *****************************************************************
      *
     C           SROUT     BEGSR                           *** SROUT ***
      *
      * Obtain Position at Event Date (LF/CPSCF)
      * If record found, calculate 'Position' (CCNP  - 15/0 ),
      *****calculate*'Cum*Coupon/Dividend*Nom.'*(#CCDM*-*9/4)**********   E20085
      **   calculate 'Cum Coupon/Dividend Nom.' (#CCDM - 15/4)            E20085
      *   else set both fields to EQ zero.
      *
     C           WCCEC     IFNE *BLANKS                                                       197766
     C           WCCSS     ANDEQCCSS                                                          197766
     C                     MOVE WCCEC     CCEC                                                197766
     C                     ENDIF                                                              197766
      *                                                                                       197766
     C                     Z-ADD0         CCEP
     C                     Z-ADD0         CCNP
     C***********          Z-ADD0         #CCDM   94                      E20085
     C                     Z-ADD0         #CCDM  154                      E20085
     C*                                                                   S01117
     C** Set up interbranch fields                                        S01117
     C*                                                                   S01117
     C                     MOVE *BLANKS   EXEI                            S01117
     C                     MOVE 'B'       ELVB                            S01117
     C                     MOVE 'C'       ELVC                            S01117
     C                     MOVE 'S'       ELVS                            S01117
     C                     MOVE 'N'       IBRE                            S01117
     C                     MOVE 'Y'       ICYE                            S01117
      *                                                                   E21639
     C           CCET      IFEQ 'DV'                                      E21639
     C           CCET      OREQ 'DE'                                      E21639
     C*                                                                   S01510
     C** If S01510 is active, use ex-date positions for dividend events   S01510
     C*                                                                   S01510
     C           S01510    IFEQ 'Y'                                       S01510
     C           CCET      ANDEQ'DV'                                      S01510
     C                     Z-ADDCCDT      WCCDT                           S01510
     C                     Z-ADDSDXD      CCDT                            S01510
     C***********KCPS      SETLLCPSCF                              S01510 088542
     C***********          READPCPSCF                    56        S01510 088542
     C           KCPS      SETLLCPOSF                                     088542
     C                     READPCPOSF                    56               088542
     C           *IN56     IFEQ '0'                                       S01510
     C           CUST      ANDEQCUST1                                     S01510
     C                     Z-ADDCSNT      CCNP                            S01510
     C                     Z-ADDCSEX      CCEP                            S01510
     C                     Z-ADDCSNT      #CCDM                           S01510
     C                     END                                            S01510
     C                     Z-ADDWCCDT     CCDT                            S01510
      *                                                                   E21639
     C                     ELSE                                           S01510
     C                     Z-ADDCSNT      CCNP                            E21639
     C                     Z-ADDCSEX      CCEP                            E21639
     C           CSNT      SUB  CSEX      #CCDM                           E21639
     C                     END                                            S01510
      *                                                                   E21639
     C                     ELSE                                           E21639
      ***  Access Value Date Position.
      *
      ***  Disregard Position changes on Event Date.                      E20085
     C***********KCPS      SETGTCPSCF                                     E20085
     C           KCPS      SETLLCPSCF                                     E20085
     C                     READPCPSCF                    50
      *
     C           *IN50     IFEQ '0'
     C           CUST      ANDEQCUST1
     C                     Z-ADDCSNV      CCNP
      *                                                                   E29978
      ***  If the Position Date precedes the Last Coupon Date, then do    E29978
      ***  not deduct Ex-Coupon Nominal from the total Position.          E29978
      *                                                                   E29978
     C           CSDA      IFLT LCPN                                      E29978
     C                     Z-ADD0         CSEX                            E29978
     C                     END                                            E29978
      *                                                                   E29978
     C                     Z-ADDCSEX      CCEP
     C           CSNV      SUB  CSEX      #CCDM
     C                     END
     C                     END                                            E21639
     C                     MOVE '0'       *IN50
      *
      * Set up Output field values :
      *
      *   Set >  CCNA - Event Amount in Nominal Currency.
      ********>**CCAN*-*Coupon*Amount*in*Nominal*Currency.*(MP,*MA*only)  E23955
      *       >  CCCE - Event Code
     C                     Z-ADD0         #NAMT  150
     C                     Z-ADD0         #EAMT  150
     C***********          Z-ADD0         #CAMT  150                      E23955
     C                     MOVE '    '    CCCE
      *
      ***  Security Diary Events
      *
     C           *IN11     IFEQ '1'
     C           CCET      CASEQ'DV'      SRDV
     C           CCET      CASEQ'PP'      SRPP
     C           CCET      CASEQ'MP'      SRMP
     C                     END
     C                     END
      *
      ***  Security Diary and Non-Diary Events
      *
     C           CCET      CASEQ'CP'      SRCP
     C           CCET      CASEQ'MA'      SRMA
     C           CCET      CASEQ'DE'      SRDE
     C                     END
      *
      *  Check for Data Base Error from Called Program
      *
     C           *INU7     IFEQ '1'
     C           *INU8     OREQ '1'
     C                     MOVE '1'       *INLR
     C                     MOVE '1'       *IN52
     C                     MOVE '1'       *IN53
     C                     END
      *
     C                     Z-ADD#NAMT     CCNA
     C***********          Z-ADD#CAMT     CCAN   150                      E23955
      *
      *   Set >  CCEA - Event Amount in  Event Ccy
      *          to EQ  Event Amt in Nominal Ccy, If Event
      *          else   convert using the ZCONV routine.
      *
     C                     Z-ADD0         CCEA
     C           CCET      IFEQ 'DE'
     C                     Z-ADD#EAMT     CCEA
     C                     ELSE
     C           CCNA      IFNE 0
     C           *IN52     ANDEQ'0'
      *
     C           CCNC      IFEQ CCEC
     C                     Z-ADDCCNA      CCEA
     C                     ELSE
     C*                                                                   S01509
     C** If S01509 is active, do not perform conversion for type 'DV'     S01509
     C*                                                                   S01509
     C           S01509    IFEQ 'Y'                                       S01509
     C           CCET      ANDEQ'DV'                                      S01509
     C                     Z-ADDCCNA      CCEA
     C                     ELSE
     C                     MOVE CCNC      ZCCYI
     C                     MOVE CCEC      ZCCYO
     C                     Z-ADDCCNA      ZAMTCI
     C*                                                                   S01509
     C** If S01509 is active, exchange rate may vary                      S01509
     C** ... if 'CP', set to the value from the latest 'XR' event         S01509
     C** ... if 'MA', set to the value from the 'RC' event                S01509
     C*                                                                   S01509
     C           S01509    IFEQ 'Y'                                       S01509
     C*                                                                   S01509
     C           CCET      IFEQ 'CP'                                      S01509
     C                     MOVE 'XR'      XSDET                           S01509
     C                     Z-ADDCCDT      XSDED                           S01509
     C           KSED      SETLLSEDEVDO                                   S01509
     C                     READ SEDEVDO                  55               S01509
     C           *IN55     IFEQ '1'                                       S01509
     C           XSDSN     ORNE CCSS                                      S01509
     C           XSDET     ORNE 'XR'                                      S01509
     C                     Z-ADDSEXR      ZEXCH                           S01509
     C                     MOVE SMDI      ZMD                             076693
     C                     ELSE                                           S01509
     C                     Z-ADDXSDCE     ZEXCH                           S01509
     C                     MOVE XSDMD     ZMD                             076693
     C                     END                                            S01509
     C                     END                                            S01509
     C*                                                                   S01509
     C           CCET      IFEQ 'MA'                                      S01509
     C                     Z-ADDXSDCE     ZEXCH                           S01509
     C                     MOVE XSDMD     ZMD                             076693
     C                     END                                            S01509
     C*                                                                   S01509
     C                     ELSE                                           S01509
     C                     Z-ADDSEXR      ZEXCH
     C***********          END                                     S01509 076693
     C                     MOVE SMDI      ZMD
     C                     END                                            076693
     C*                                                                   S01117
     C** Set in currency decimal places parameter for SR.ZCONV            S01117
     C*                                                                   S01117
     C                     Z-ADD#NCDP     ZCDPI                           S01117
     C*                                                                   S01117
     C** Set out currency decimal places parameter for SR.ZCONV           S01117
     C*                                                                   S01117
     C                     Z-ADD#ECDP     ZCDPO                           S01117
     C*                                                                   S01117
     C                     EXSR ZCONV
      *
     C************INU8     IFEQ '1'                                       S01117
     C***********          MOVE '1'       *IN52                           S01117
     C***********          MOVE '1'       *INLR            ***************S01117
     C***********          MOVEL'06'      DBASE            * DB ERROR 06 *S01117
     C***********          MOVEL'ZCONV   'DBFILE           ***************S01117
     C***********          MOVELTKEY      DBKEY                           S01117
     C***********          ELSE                                           S01117
     C                     Z-ADDZAMTCO    CCEA
     C***********          END                                            S01117
     C                     END                                            S01509
     C                     END
     C                     END
     C                     END
      *
      ****Set*>**CCAS*-*Coupon*Amount*in**Settl*Ccy********************   E23955
      *
     C                     Z-ADD0         CCAS
     C***********CCAN      IFNE 0                                         E23955
     C************IN52     ANDEQ'0'                                       E23955
      ***********                                                         E23955
     C***********CCNC      IFEQ CCEC                                      E23955
     C***********          Z-ADDCCAN      CCAS                            E23955
     C***********          ELSE                                           E23955
     C***********          MOVE CCNC      ZCCYI                           E23955
     C***********          MOVE CCEC      ZCCYO                           E23955
     C***********          Z-ADDCCAN      ZAMTCI                          E23955
     C***********          Z-ADDSEXR      ZEXCH                           E23955
     C***********          MOVE SMDI      ZMD                             E23955
     C***********          EXSR ZCONV                                     E23955
      ***********                                                         E23955
     C************INU8     IFEQ '1'                                       E23955
     C***********          MOVE '1'       *IN52                           E23955
     C***********          MOVE '1'       *INLR            ***************E23955
     C***********          MOVEL'07'      DBASE            **DB ERROR 07**E23955
     C***********          MOVEL'ZCONV   'DBFILE           ***************E23955
     C***********          MOVELTKEY      DBKEY                           E23955
     C***********          ELSE                                           E23955
     C***********          Z-ADDZAMTCO    CCAS                            E23955
     C***********          END                                            E23955
     C***********          END                                            E23955
     C***********          END                                            E23955
      *
      *** If withholding tax option on, and event amount > zero, cal-     S01447
      *** culate tax to withhold.                                         S01447
      *                                                                   S01447
     C           *IN52     IFEQ '0'                        *B1            S01447
     C           S01447    ANDEQ'Y'                                       S01447
     C           CCEA      ANDGT*ZERO                                     S01447
      *                                                                   S01447
     C           CCET      IFEQ 'DV'                       *B2            S01447
     C           CCET      OREQ 'CP'                                      S01447
      *                                                                   S01447
     C                     EXSR CSTLOC                     GET CUS LOCN   S01447
      *                                                                   S01447
     C           *IN52     IFEQ '0'                        *B3            S01447
     C                     EXSR CALCTX                                    S01447
     C                     SUB  UTXSRC    CCEA                            S01447
     C                     SUB  UTXUSR    CCEA                            S01447
     C                     END                             *E3            S01447
      *                                                                   S01447
     C                     END                             *E2            S01447
     C                     END                             *E1            S01447
      *                                                                   S01447
     C           *IN52     IFEQ '0'
      *
      *   Set >  CPYD - Payment Date
      *
     C***********          Z-ADD0         CPYD                            S01512
     C                     Z-ADDCCDT      CPYD                            S01512
      *                                                                   CEU011
     C********** CEU011    IFEQ 'Y'                                                    CEU011 241795
     C                     Z-ADD1         A                               CEU011
     C           CCEC      LOKUPCUR,A                    70               CEU011
      *                                                                   CEU011
     C           *IN70     IFEQ *ON                                       CEU011
     C                     Z-ADDSRT,A     ECSS                            CEU011
     C                     ELSE                                           CEU011
      *                                                                   CEU011
     C           *LOCK     IN   LDA                                       CEU011
     C                     MOVE *ON       *INU7                           CEU011
     C                     MOVE *ON       *INU8                           CEU011
     C                     MOVE *ON       *INLR                           CEU011
     C                     MOVELCCEC      DBKEY            ************   CEU011
     C                     MOVE 'SDCURRPD'DBFILE           * DBERR 08 *   CEU011
     C                     Z-ADD8         DBASE            ************   CEU011
     C                     MOVEL'SE1480'  DBPGM                           CEU011
     C                     OUT  LDA                                       CEU011
     C                     EXSR *PSSR                                     CEU011
     C                     ENDIF                                          CEU011
     C**********           ENDIF                                                       CEU011 241795
      *
     C           *IN11     IFEQ '1'
     C           CCET      ANDNE'PP'                                      101283
     C                     Z-ADDSDPD      CPYD
     C                     END
      *
      *   Set >  CCFC - Due TO, FROM Cust. indicator
      *       >  CCIO - Incoming/Outgoing indicator
      *
     C                     MOVE ' '       CCFC
     C                     MOVE ' '       CCIO
      *
      ***  PP Call
     C           CCET      IFEQ 'PP'
     C           CCNA      IFGE 0
     C                     MOVE 'F'       CCFC
     C                     ELSE
     C                     MOVE 'T'       CCFC
     C                     Z-SUBCCNA      CCNA                            E19101
     C                     Z-SUBCCEA      CCEA                            E19101
     C                     END
     C                     END
      *
     C           CCET      IFEQ 'CP'
     C           CCET      OREQ 'DV'
     C           CCET      OREQ 'DE'
     C           CCET      OREQ 'MA'
     C           CCET      OREQ 'MP'
     C           CCNA      IFGE 0
     C                     MOVE 'T'       CCFC
     C                     ELSE
     C                     MOVE 'F'       CCFC
     C                     Z-SUBCCNA      CCNA                            E19101
     C                     Z-SUBCCEA      CCEA                            E19101
     C                     END
     C                     END
      *
     C           CCFC      IFEQ 'T'
     C                     MOVE 'O'       CCIO
     C                     END
     C           CCFC      IFEQ 'F'
     C                     MOVE 'I'       CCIO
     C                     END
      *
      *   Get >  C1DI - Client discretionary indicator
      *
     C           CCCN      CHAINCLINTSEF             52
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR
     C                     MOVE '1'       *IN52            ***************
     C***********          MOVEL'12'      DBASE            **DB*ERROR*12**S01117
     C                     Z-ADD12        DBASE            * DB ERROR 12 *S01117
     C                     MOVEL'CLINTSEF'DBFILE           ***************
     C                     MOVELCCCN      DBKEY
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
     C                     END
     C                     END
      *                                                                   050723
      ***  Set up Booking Branch and Company of Booking Branch.           050723
      ***  The Booking Branch is CCBA and is renamed on input from:       050723
      ***       PIBH off PICSPD                                           050723
      ***   or  CSBA off CPOSND                                           050723
      ***  So, just need to obtain Company Code.                          050723
      *                                                                   050723
     C           *IN52     IFEQ '0'                                       050723
     C**********           CALL 'AOBRCHR0'                                             050723 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' WRTCD   7                       050723
     C                     PARM '*KEY   ' WOPTN   7                       050723
     C                     PARM CCBA      WBRCH   3                       050723
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        050723 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *                                                                   050723
     C           WRTCD     IFNE *BLANKS                                   050723
     C           *LOCK     IN   LDA                                       170108
     C                     MOVEL'SDBRCHPD'DBFILE           ***************050723
     C                     MOVELWOPTN     DBKEY            * DB ERROR 13 *050723
     C                     Z-ADD13        DBASE            ***************050723
     C                     MOVELWOPTN     DBOPTN  7                       050723
     C                     SETON                       U7U8LR             050723
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     050723
     C                     ELSE                                           050723
      *                                                                   050723
      ***  Set up Company for Booking Branch.                             050723
      *                                                                   050723
     C                     MOVE A8CMCD    COBB                            050723
     C                     END                                            050723
     C                     END                                            050723
      *
      *   Set >  CCSM - Settlement Method
      *       >  CCSA - Settlement Account
      ********>**CCBN*-*Settlement Branch                                 S01117
      *       >  CCTA - Settlement Branch                                 S01117
      *       >  CCTC - Clearance Type
      ***     >  EBRC - Event Branch                                      050723
      ***     >  ECPY - Company of Event Branch                           050723
      ***     >  WSEBR - Work field for checking Company of Settlement    050723
      *
     C           *IN52     IFEQ '0'
      *
      ***  Initialise Settlement fields.                                  050723
      *                                                                   050723
     C                     Z-ADD0         CCSM
     C                     MOVE *BLANKS   CCSA
     C***********          MOVE *BLANKS   CCBN                            S01117
     C***********          MOVE *BLANKS   CCTA                     S01117 050723
     C                     MOVE *BLANK    CCTC
      *                                                                   050723
      ***  The Event Branch and Company are the Booking Branch and        050723
      ***  Company on the first Event.                                    050723
      *                                                                   050723
     C                     MOVE CCBA      EBRC                            050723
     C                     MOVE COBB      ECPY                            050723
      *                                                                   050723
      ***  Default the Settlement Branch/Company to the same.             050723
      *                                                                   050723
     C                     MOVE CCBA      CCTA                            050723
     C                     MOVE COBB      WSECY                           050723
      *                                                                                       CSE028
      ** If CSE028 is on, call SESSIR0 for default of MT5xx information                       CSE028
      *                                                                                       CSE028
     C           CSE028    IFEQ 'Y'                                                           CSE028
      *                                                                                       CSE028
     C                     MOVELCCCN      PCUST                                               CSE028
     C                     CALL 'SESSIR0'                                                     CSE028
     C                     PARM 'D'       POTYP   1                                           CSE028
     C                     PARM CCBA      PBRCH   3                                           CSE028
     C                     PARM           PCUST   6                                           CSE028
     C                     PARM SIBK      PBOOK   2                                           CSE028
     C                     PARM CCEC      PCURR   3                                           CSE028
     C                     PARM SMCC      PMRKT   2                                           CSE034
     C                     PARM SITP      PINVT   3                                           CSE028
     C                     PARM SPTFR     PPTFR   4                                           CSE028
     C                     PARM           PCBSTD                                              CSE028
     C                     PARM           PCBSAD                                              CSE028
     C                     PARM *BLANKS   PRTCD   5                                           CSE028
      *                                                                                       CSE028
     C           PRTCD     IFNE '*NRF '                                                       CSE028
     C           PRTCD     ANDNE'*NCRF'                                                       CSE028
     C           2         OCUR PCBSTD                                                        CSE028
     C                     MOVE *OFF      *IN54                                               CSE028
     C                     ELSE                                                               CSE028
      *                                                                                       CSE028
      ** Set on Record Not Found indicator.                                                   CSE028
     C                     MOVE *ON       *IN54                                               CSE028
     C                     ENDIF                                                              CSE028
      *                                                                                       CSE028
     C                     ELSE                                                               CSE028
      *
      *   For portfolio client ..
      *
     C***********C1DI      IFEQ 'S'                                       E16813
     C***********C1DI      OREQ 'D'                                       E16813
     C***********C1DI      IFNE 'M'                                E16813 E37428
     C           C1DI      IFEQ 'S'                                       E37428
     C           C1DI      OREQ 'D'                                       E37428
     C***********KSTDA     CHAINSTDSEDF              52                   050723
     C/COPY WNCPYSRC,SE1480C004
     C           KSTDA     CHAINSTDSEDF              54                   050723
     C/COPY WNCPYSRC,SE1480C005
     C                     ELSE
      *    .. else
     C***********KSTD      CHAINSTDSEDF              52                   050723
     C/COPY WNCPYSRC,SE1480C012
     C           KSTD      CHAINSTDSEDF              54                   050723
     C************IN52     IFEQ '1'                                E37428 050723
     C           *IN54     IFEQ '1'                                       050723
     C           RECI      OREQ '*'                                       E37428
     C           C1DI      IFEQ 'E'                                       E37428
     C           C1DI      OREQ 'C'                                       E37428
     C********** C1DI      OREQ 'K'                                       E37428              CSE022
     C           C1DI      OREQ 'X'                                       E37428
     C***********KSTDA     CHAINSTDSEDF              52            E37428 050723
     C           KSTDA     CHAINSTDSEDF              54                   050723
     C                     END                                            E37428
     C                     END                                            E37428
     C/COPY WNCPYSRC,SE1480C013
     C                     END
      *                                                                                       CSE028
     C                     ENDIF                                                              CSE028
      *                                                                                       CSE028
     C************IN52     IFEQ '1'                                       050723
     C***********RECI      OREQ '*'                                       050723
      ***  The following defaulted already.                               050723
     C***********          MOVE '0'       *IN52                           050723
     C***********          MOVE '00'      CCSM                            050723
     C***********          MOVE *BLANKS   CCSA                            050723
     C***********          MOVE *BLANKS   SRAB                     E34974 050723
     C***********          MOVE *BLANKS   SPBA                     E34974 050723
     C***********          MOVE *BLANKS   CCBN                            S01117
     C***********          MOVE *BLANKS   CCTA                     S01117 050723
     C***********          MOVE *BLANKS   CCTC                            050723
     C***********          END                                            E16813
     C***********          END                                            E16813
     C***********          ELSE                                    E16813 050723
      *****Payment*From*Us*-*Details****************************** E34974 050723
     C***********CCFC      IFEQ 'F'                                E34974 050723
     C***********          Z-ADDSPSM      CCSM                     E34974 050723
     C***********          MOVELSPAT      CCSA                     E34974 050723
     C***********          MOVELSPBA      CCTA                     E34974 050723
     C***********          MOVE SCLP      CCTC                     E34974 050723
     C***********          END                                     E34974 050723
      ***********                                                  E34974 050723
      *****Payment*To*Us*-*Details******************************** E34974 050723
     C***********CCFC      IFEQ 'T'                                E34974 050723
     C***********          Z-ADDSRSM      CCSM                     E34974 050723
     C***********          MOVELSRAC      CCSA                     E34974 050723
     C***********          MOVELSRAB      CCTA                     E34974 050723
     C***********          MOVE SCLS      CCTC                     E34974 050723
     C***********          END                                     E34974 050723
     C***********          END                                     E34974 050723
     C***********          END                                     E34974 050723
     C***********                                                  S01117 050723
     C***Obtain*branch,*and*hence*company*details*of*both*booking* S01117 050723
     C***and*settlement*branches*(the*latter*only*if*a*multi*branchS01117 050723
     C***system*where*the*two*branches*differ********************* S01117 050723
     C************************************************************ S01117 050723
     C***Obtain*Booking*Branch*details**************************** S01117 050723
     C***********                                                  S01117 050723
     C***********          CALL 'AOBRCHR0'                         S01117 050723
     C***********          PARM '*MSG   ' @RTCD   7                S01117 050723
     C***********          PARM '*KEY   ' @OPTN   7                S01117 050723
     C***********          PARM CCBA      @DSNB   3                S01117 050723
     C***********SDBRCH    PARM SDBRCH    DSFDY                    S01117 050723
     C***********                                                  S01117 050723
     C***********@RTCD     IFNE *BLANKS                            S01117 050723
     C***********          MOVE '1'       *INLR                    S01117 050723
     C***********          MOVEL'SDBRCHPD'DBFILE           ***************050723
     C***********          MOVEL@OPTN     DBKEY            ** DB ERROR 06 050723
     C***********          Z-ADD6         DBASE            ***************050723
     C***********          MOVEL@OPTN     DBOPTN  7                S01117 050723
     C***********          SETON                       U7U8        S01117 050723
     C***********          EXSR *PSSR                              S01117 050723
     C***********          ELSE                                    S01117 050723
     C***Save*Booking*branch*and*related*company****************** S01117 050723
     C***********                                                  S01117 050723
     C***********          MOVE CCBA      @@BKBR                   S01117 050723
     C***********          MOVE A8CMCD    @@BKCY                   S01117 050723
     C***********          END                                     S01117 050723
     C***********                                                  S01117 050723
     C***Set*up*event*branch*as*booking*branch******************** S01117 050723
     C***********                                                  S01117 050723
     C***********          MOVE @@BKBR    EBRC                     S01117 050723
     C***********          MOVE @@BKCY    ECPY                     S01117 050723
     C***********          MOVE @@BKCY    COBB                     047360 050723
     C***********                                                  S01117 050723
     C***Obtain*branch,*and*hence*company*details*of*settlement*** S01117 050723
     C***branches*but*only*if*ssystem*is*multi*branched*and*the*twoS01117 050723
     C***branches*differ****************************************** S01117 050723
     C***********                                                  S01117 050723
     C***********MBIN      IFEQ 'Y'                                S01117 050723
     C***********CCIO      IFEQ 'O'                                S01117 050723
     C***********CCBA      ANDEQSRAB                               S01117 050723
     C***********CCIO      OREQ 'I'                                S01117 050723
     C***********CCBA      ANDEQSPBA                               S01117 050723
     C***********SRAB      OREQ *BLANKS                            E34974 050723
     C***********SPBA      OREQ *BLANKS                            E34974 050723
     C***********                                                  S01117 050723
     C***A*booking*and*settlement*branches*are*same*************** S01117 050723
     C***********                                                  S01117 050723
     C***********          MOVE CCBA      @@BKBR                   S01117 050723
     C***********          MOVE CCBA      @@SEBR                   S01117 050723
     C***********          MOVE A8CMCD    @@BKCY                   S01117 050723
     C***********          MOVE A8CMCD    @@SECY                   S01117 050723
     C***********          END                                     S01117 050723
     C***********                                                  S01117 050723
     C***********CCIO      IFEQ 'O'                                S01117 050723
     C***********CCBA      ANDNESRAB                               S01117 050723
     C***********SRAB      ANDNE*BLANKS                            E34974 050723
     C***********                                                  S01117 050723
     C***A*Receipt*event****************************************** S01117 050723
     C*                                                                   S01117
      ***  If no Standard Settlements set up then leave the Settlement    178458
      ***  fields to the defaults, otherwise...                           178458
      *                                                                   178458
     C           *IN54     IFEQ '0'                                       178458
     C           RECI      ANDNE'*'                                       178458
     C           SCCY      ANDNE'   '                                     153701
      *                                                                   151542
      ** If settlement ccy from STDSED is not the same as event           151542
      ** ccy, set event ccy to this ccy and convert amount                151542
      *                                                                   151542
     C           SCCY      IFNE CCEC                                      151542
     C********** SCCY      ANDNE'   '                              151542 153701
      *                                                                   151542
      *   Set >  #SCDP  - Settlement Ccy Decimal Positions.               151542
      *                                                                   151542
     C                     MOVE *BLANKS   KEY                             151542
     C                     MOVEL'20'      KEY                             151542
     C                     MOVE '1'       ZWK4                            151542
     C                     MOVELSCCY      ZWK4    4                       151542
     C                     MOVE ZWK4      KEY                             151542
      *                                                                   151542
     C           KEY       CHAINTABTG10F             52                   151542
     C           *IN52     IFEQ '1'                                       151542
     C           RECI      ORNE 'D'                                       151542
     C           *LOCK     IN   LDA                                       151542
     C                     SETON                     U7U8                 151542
     C                     MOVE '1'       *INLR                           151542
     C                     MOVE '1'       *IN52            ***************151542
     C                     Z-ADD03        DBASE            * DB ERROR 03 *151542
     C                     MOVEL'TABTG10F'DBFILE           ***************151542
     C                     MOVELKEY       DBKEY                           151542
     C                     OUT  LDA                                       151542
     C                     EXSR *PSSR                                     151542
     C                     ELSE                                           151542
     C                     MOVE CDP       #SCDP   10                      151542
     C                     END                                            151542
     C           MDIN      IFNE EMDIN                                     151542
     C********** 1         DIV  EEXCH     EEXCH                    151542 153701
     C           1         DIV  EEXCH     ZEXCH                           153701
     C                     ELSE                                           153701
     C                     Z-ADDEEXCH     ZEXCH                           153701
     C                     END                                            151542
     C********** EEXCH     DIV  SPOT      ZEXCH                    151542 153701
     C           ZEXCH     DIV  SPOT      ZEXCH                           153701
     C           MDIN      IFEQ 1                                         151542
     C                     MOVE 'M'       ZMD                             151542
     C                     ELSE                                           151542
     C                     MOVE 'D'       ZMD                             151542
     C                     END                                            151542
     C                     Z-ADD#ECDP     ZCDPI                           151542
     C                     Z-ADD#SCDP     ZCDPO                           151542
     C                     MOVE CCEC      ZCCYI                           151542
     C                     MOVE SCCY      ZCCYO                           151542
     C                     Z-ADDCCEA      ZAMTCI                          151542
     C                     EXSR ZCONV                                     151542
     C                     Z-ADDZAMTCO    CCEA                            151542
     C                     MOVE SCCY      CCEC                            151542
     C                     END                                            151542
      *                                                                   151542
      *****If*no*Standard*Settlements*set*up*then*leave*the*Settleme050723178458
      *****fields*to*the*defaults,*otherwise...*                    050723178458
      ************                                                  050723178458
     C************IN54     IFEQ '0'                                 050723178458
     C***********RECI      ANDNE'*'                                 050723178458
      *                                                                   050723
      ***  In a multientity system, the Booking Branch and Settlement     050723
      ***  Branch may differ. If they are different, then need to         050723
      ***  obtain Settlement Branch details.                              050723
      *                                                                   050723
     C           MBIN      IFEQ 'Y'                                       050723
      *                                                                   050723
     C           CCIO      IFEQ 'I'                                       050723
     C           CCBA      ANDNESPBA                                      050723
     C           SPBA      ANDNE*BLANKS                                   050723
      *                                                                   050723
     C           CCIO      OREQ 'O'                                       050723
     C           CCBA      ANDNESRAB                                      050723
     C           SRAB      ANDNE*BLANKS                                   050723
      *                                                                   050723
      ***  Settlement Branch.                                             050723
      *                                                                   050723
     C           CCIO      IFEQ 'I'                                       050723
     C                     MOVE SPBA      CCTA                            050723
     C                     ELSE                                           050723
     C                     MOVE SRAB      CCTA                            050723
     C                     END                                            050723
      *                                                                   050723
      ***  Company of Settlement Branch.                                  050723
      *                                                                   050723
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C***********          PARM SRAB      @DSNB   3                S01117 050723
     C                     PARM CCTA      @DSNB   3                       050723
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*
     C           @RTCD     IFNE *BLANKS                                   S01117
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INLR                           S01117
     C***********          MOVEL'SDBANKPD'DBFILE           ********S01117*E34974
     C                     MOVEL'SDBRCHPD'DBFILE           ***************E34974
     C                     MOVEL@OPTN     DBKEY            ** DB ERROR 7  S01117
     C                     Z-ADD7         DBASE            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7                       S01117
     C                     SETON                       U7U8               S01117
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
     C                     ELSE                                           S01117
     C***********          MOVE SRAB      @@SEBR                   S01117 050723
     C***********          MOVE A8CMCD    @@SECY                   S01117 050723
     C***********          MOVE A8BICN    @@SECS                   S01117 050723
      *                                                                   050723
     C                     MOVE A8CMCD    WSECY                           050723
     C                     MOVE A8BICN    WSBICN                          050723
     C                     END                                            S01117
      *                                                                   050723
     C                     END                                            050723
     C                     END                                            S01117
      *                                                                   050723
      *****Payment*From*Us*-*Details***********************************                050723 209299
      ** Payment to customer                                                                  209299
      *                                                                   050723
     C********** CCFC      IFEQ 'F'                                                    050723 209299
     C           CCFC      IFEQ 'T'                                                           209299
     C                     Z-ADDSPSM      CCSM                            050723
     C                     MOVELSPAT      CCSA                            050723
     C                     MOVE SCLP      CCTC                            050723
     C                     END                                            050723
      *                                                                   050723
      *****Payment*To*Us*-*Details****************************************             050723 209299
      ** Payment from customer                                                                209299
      *                                                                   050723
     C********** CCFC      IFEQ 'T'                                                    050723 209299
     C           CCFC      IFEQ 'F'                                                           209299
     C                     Z-ADDSRSM      CCSM                            050723
     C                     MOVELSRAC      CCSA                            050723
     C                     MOVE SCLS      CCTC                            050723
     C                     END                                            050723
      *                                                                   050723
     C                     ELSE                                           153701
      *                                                                   153701
      ** If no settl. ccy in STDSED or record not found                   153701
      ** reset to the value by default                                    153701
      *                                                                   153701
     C           S01509    IFEQ 'N'                                       153701
     C                     MOVE CCNC      CCEC                            153701
     C           VLCY      IFNE '   '                                     153701
     C                     MOVE VLCY      CCEC                            153701
     C                     ENDIF                                          153701
     C           SPYC      IFNE '   '                                     153701
     C                     MOVE SPYC      CCEC                            153701
     C                     ENDIF                                          153701
     C                     ELSE                                           153701
     C                     SELEC                                          153701
     C           CCET      WHEQ 'DV'                                      153701
     C           CCET      OREQ 'DE'                                      153701
     C           CCET      OREQ 'CP'                                      153701
     C                     MOVE VLCY      CCEC                            153701
     C           CCET      WHEQ 'MA'                                      153701
     C                     MOVE 'RC'      XSDET                           153701
     C                     Z-ADDMATY      XSDED                           153701
     C           KSED      CHAINSEDEVDO              51                   153701
     C           *IN51     IFEQ '0'                                       153701
     C           XSDCX     ANDNE*BLANKS                                   153701
     C                     MOVE XSDCX     CCEC                            153701
     C                     ELSE                                           153701
     C                     MOVE CCNC      CCEC                            153701
     C                     ENDIF                                          153701
     C                     OTHER                                          153701
     C                     MOVE CCNC      CCEC                            153701
     C                     ENDSL                                          153701
      *                                                                   153701
     C                     ENDIF                                          153701
      *                                                                   153701
      ***  End of Standard Settlement Instruction processing.             050723
     C                     END                                            050723
      ***  End of *IN52 = '0'                                             050723
     C                     END                                            050723
     C*                                                                   S01117
     C***********CCIO      IFEQ 'I'                                S01117 050723
     C***********CCBA      ANDNESPBA                               S01117 050723
     C***********SPBA      ANDNE*BLANKS                            E34974 050723
     C***********                                                  S01117 050723
     C***A*payment event                                           S01117 050723
     C***********                                                  S01117 050723
     C***********          CALL 'AOBRCHR0'                         S01117 050723
     C***********          PARM '*MSG   ' @RTCD   7                S01117 050723
     C***********          PARM '*KEY   ' @OPTN   7                S01117 050723
     C***********          PARM SPBA      @DSNB   3                S01117 050723
     C***********SDBRCH    PARM SDBRCH    DSFDY                    S01117 050723
     C***********                                                  S01117 050723
     C***********@RTCD     IFNE *BLANKS                            S01117 050723
     C***********          MOVE '1'       *INLR                    S01117 050723
     C***********          MOVEL'SDBRCHPD'DBFILE           ***************050723
     C***********          MOVEL@OPTN     DBKEY            ** DB ERROR 07 050723
     C***********          Z-ADD7         DBASE            ***************050723
     C***********          MOVEL@OPTN     DBOPTN  7                S01117 050723
     C***********          SETON                       U7U8        S01117 050723
     C***********          EXSR *PSSR                              S01117 050723
     C***********          ELSE                                    S01117 050723
     C***********          MOVE SPBA      @@SEBR                   S01117 050723
     C***********          MOVE A8CMCD    @@SECY                   S01117 050723
     C***********          MOVE A8BICN    @@SECS                   S01117 050723
     C***********          END                                     S01117 050723
     C***********          END                                     S01117 050723
     C***********          ELSE                                    E38182 050723
     C***********          MOVE CCBA      @@SEBR                   E38182 050723
     C***********          MOVE A8CMCD    @@SECY                   E38182 050723
     C***********          END                                     S01117 050723
     C***********                                                         050723
     C************IN52     IFEQ '0'                                       E16813
      ***********                                                         050723
      *****Payment*From*Us*-*Details***********************************   E34974
     C***********CCFC      IFEQ 'F'                                       E34974
     C***********          Z-ADDSPSM      CCSM                            E34974
     C***********          MOVELSPAT      CCSA                            E34974
     C***********          MOVELSPBR      CCBN                            S01117
     C***********          MOVELSPBA      CCTA                     S01117 E34974
     C***********          MOVE SCLP      CCTC                            E34974
     C***********          END                                            E34974
      ***********                                                         E34974
      ***  Payment To Us - Details
     C***********CCFC      IFEQ 'T'                                       E34974
     C***********          Z-ADDSRSM      CCSM                            E34974
     C***********          MOVELSRAC      CCSA                            E34974
     C***********          MOVELSRBR      CCBN                            S01117
     C***********          MOVELSRAB      CCTA                     S01117 E34974
     C***********          MOVE SCLS      CCTC                            E34974
     C***********          END                                            E34974
      *
     C***********          END                                            E34974
     C***********          END                                     E16813 E34974
     C*                                                                   103150
     C* If settlement method is '04' and settlement account is blank,     103150
     C* retrieve prime account number                                     103150
     C*                                                                   103150
     C           CCSM      IFEQ 04                                        103150
     C           CCSA      ANDEQ*BLANKS                                   103150
     C                     MOVE CCCN      PRCNUM                          103150
     C                     MOVE BMACCD    PRACOD                          103150
     C                     MOVE '01'      PRACSQ                          103150
     C                     MOVE PRACCT    CCSA                            103150
     C                     END                                            103150
     C*                                                                   S01117
     C** If an interbranch event then settlement account will be blank    S01117
     C** and settlement method 00.                                        S01117
     C*                                                                   S01117
     C***********@@BKBR    IFNE @@SEBR                             S01117 050723
     C           CCBA      IFNE CCTA                                      050723
     C                     MOVE *BLANKS   CCSA                            S01117
     C                     MOVE '00'      CCSM                            S01117
     C                     END                                            S01117
     C*                                                                   S01117
      *
      *   Set >  CCRN/CCTR - Customer Report Name/Town
      *
     C           *IN52     IFEQ '0'
     C                     MOVE *BLANKS   CCRN
     C                     MOVE *BLANKS   CCTR
      *
     C           CCCN      CHAINCLINTCBF             52
     C           *IN52     IFEQ '1'
     C           RECI      ORNE 'D'
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR
     C                     MOVE '1'       *IN52            ***************
     C***********          MOVEL'09'      DBASE            **DB*ERROR*09**S01117
     C                     Z-ADD09        DBASE            * DB ERROR 09 *S01117
     C                     MOVEL'CLINTCBF'DBFILE           ***************
     C                     MOVELCCCN      DBKEY
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
     C                     END
     C                     END
      *
      * Maturity Date Indicator                                           S01176
      *                                                                   S01176
     C           CCET      IFNE 'MA'                                      S01176
     C                     MOVE *BLANKS   MDTI                            S01176
     C                     END                                            S01176
     C*                                                                   S01512
     C** Setup payment date for Coupon event if S01512 is active          S01512
     C*                                                                   S01512
     C           S01512    IFEQ 'Y'                                       S01512
     C           CCET      IFEQ 'CP'                                      S01512
     C           CCET      OREQ 'MA'                                      S01512
     C                     Z-ADDCCDT      ZDAYNO                          S01512
     C                     MOVE CCEC      ZCCY                            S01512
     C                     MOVE *BLANKS   ZLOC                            S01512
     C                     Z-ADD0         ZNRDYS                          S01512
     C                     EXSR ZFWDT                                     S01512
     C           CCDT      IFNE ZDYNBR                                    S01512
     C                     Z-ADDZDYNBR    CPYD                            S01512
     C                     END                                            S01512
     C                     END                                            S01512
     C                     END                                            S01512
      *
     C           *IN52     IFEQ '0'
      *
      * Accumulate Hash Totals of the Event Amount
      *
     C                     Z-ADDCCEA      #HAMT
     C           #HAMT     CASNE0         SRHASH
     C                     END
      *
      * Write a record to the event's file
      *
     C           #HAMT     IFNE 0                                         E20085
     C           CCET      OREQ 'DE'                                      E20085
     C                     ADD  1         OUTREC  50
     C                     MOVE 'D'       RECI
     C                     WRITECPEVEDF
     C                     END
      *                                                                   E20085
     C                     END                                            E20085
     C*                                                                   S01117
     C** Generate second and third event records if a multibranch event   S01117
      ***  These are the two Events for the Settlement Branch.            050723
     C*                                                                   S01117
     C***********@@BKBR    IFNE @@SEBR                             S01117 050723
     C           CCBA      IFNE CCTA                                      050723
     C*                                                                   S01117
     C** Second record                                                    S01117
      ***  Between Settlement Branch and Depot.                           050723
     C*                                                                   S01117
     C***********          MOVE @@SEBR    EBRC                     S01117 050723
     C***********          MOVE @@SECY    ECPY                     S01117 050723
     C                     MOVE CCTA      EBRC                            050723
     C                     MOVE WSECY     ECPY                            050723
     C                     MOVE 'Y'       IBRE                            S01117
     C***********@@BKCY    IFNE @@SECY                             S01117 050723
     C           COBB      IFNE WSECY                                     050723
     C                     MOVE 'Y'       ICYE                            S01117
     C                     ELSE                                           S01117
     C                     MOVE 'N'       ICYE                            S01117
     C                     END                                            S01117
      *                                                                   050723
     C********** CCFC      IFEQ 'T'                                                    S01117 209299
     C           CCFC      IFEQ 'F'                                                           209299
     C                     MOVE SRSM      CCSM                            S01117
     C                     MOVE SRAC      CCSA                            S01117
     C                     END                                            S01117
     C********** CCFC      IFEQ 'F'                                                    S01117 209299
     C           CCFC      IFEQ 'T'                                                           209299
     C                     MOVE SPSM      CCSM                            S01117
     C                     MOVE SPAT      CCSA                            S01117
     C                     END                                            S01117
      *                                                                   S01117
      * Accumulate Hash Totals of the Event Amount                        S01117
      *                                                                   S01117
     C                     Z-ADDCCEA      #HAMT                           S01117
     C           #HAMT     CASNE0         SRHASH                          S01117
     C                     END                                            S01117
      *                                                                   S01117
      * Write a record to the event's file                                S01117
      *                                                                   S01117
     C           #HAMT     IFNE 0                                         S01117
     C           CCET      OREQ 'DE'                                      S01117
     C                     ADD  1         OUTREC  50                      S01117
     C                     MOVE 'D'       RECI                            S01117
     C                     WRITECPEVEDF                                   S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C** Third record                                                     S01117
      ***  Between Settlement Branch and Booking Branch.                  050723
     C*                                                                   S01117
     C*                                                                   S01117
     C** Swith the incoming/outgoing indicator                            S01117
     C*                                                                   S01117
     C           CCIO      IFEQ 'I'                                       S01117
     C                     MOVE 'O'       CCIO                            S01117
     C                     ELSE                                           S01117
     C                     MOVE 'I'       CCIO                            S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C** Blank the settlement account and method                          S01117
     C*                                                                   S01117
     C                     MOVE '00'      CCSM                            S01117
     C                     MOVE *BLANKS   CCSA                            S01117
     C*                                                                   S01117
     C** Depot is now the settlement branch internal customer number      S01117
     C*                                                                   S01117
     C***********          MOVE @@SECS    CCCN                     S01117 050723
     C                     MOVE WSBICN    CCCN                            050723
      *                                                                   S01117
      * Accumulate Hash Totals of the Event Amount                        S01117
      *                                                                   S01117
     C                     Z-ADDCCEA      #HAMT                           S01117
     C           #HAMT     CASNE0         SRHASH                          S01117
     C                     END                                            S01117
      *                                                                   S01117
      * Write a record to the event's file                                S01117
      *                                                                   S01117
     C           #HAMT     IFNE 0                                         S01117
     C           CCET      OREQ 'DE'                                      S01117
     C                     ADD  1         OUTREC  50                      S01117
     C                     MOVE 'D'       RECI                            S01117
     C                     WRITECPEVEDF                                   S01117
     C                     END                                            S01117
      *                                                                   050723
      ***  End of Second and Third Event processing.                      050723
     C                     END                                            S01117
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRPP   - Subroutine to calculate Event Amount for PP Call.   *
      *                                                               *
      *****************************************************************
      *
     C           SRPP      BEGSR                           ***  SRPP  ***
      *
      ***  Event Code '31C1' = PP Call
      *
     C                     MOVE '31C1'    CCCE             Event Code
      *
      * To calculate the Event Amount, use the PP CALL amount,
      *   or percentage, depending on the Processing Type.
      *
     C           PROT      IFEQ '4'
     C           CCNP      MULT SDPP      #NAMT
      *
     C                     ELSE
      *
     C           CCNP      MULT SDPC      #NAMT     H
     C           #NAMT     DIV  100       #NAMT     H
      *
      * Convert from Nom D.p. to the CCY D.p.
      *          'to' ccy   -  'from' ccy
      *
     C           #NCDP     IFNE NMDP
     C           #NCDP     SUB  NMDP      X       20
     C                     ADD  5         X
     C           #NAMT     MULT POWER8,X  #NAMT     H
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRCP   - Subroutine to calculate Event Amount for Coupon.    *
      *                                                               *
      *****************************************************************
      *
     C           SRCP      BEGSR                           ***  SRCP  ***
      *
      ***  Event Code '31C2' = Coupon
      *
     C                     MOVE '31C2'    CCCE
      *                                                                   E20085
      ***  Obtain the Coupon Date prior to the Event Coupon Date.         E20085
      *                                                                   E20085
     C           CCDT      SUB  1         ZECD                            E20085
     C/COPY WNCPYSRC,SE1480C014
     C                     EXSR ZLCD                                      E20085
      *
      * Calculate Coupon Amount
      *
     C/COPY WNCPYSRC,SE1480C002
     C           CSNT      IFNE 0                                                           AR906833
     C           CSNV      ORNE 0                                                           AR906833
     C           CSEX      ORNE 0                                                           AR906833
     C           CSNS      ORNE 0                                                           AR906833
     C                     CALL 'ZACRFC'  ACRFC
     C                     ELSE                                                             AR906833
     C                     Z-ADD0         #AMT                                              AR906833
     C                     ENDIF                                                            AR906833
     C/COPY WNCPYSRC,SE1480C003
      *
     C                     Z-ADD#AMT      #NAMT
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRDV   - Subroutine to calculate Event Amount for Dividend.  *
      *                                                               *
      *****************************************************************
      *
     C           SRDV      BEGSR                           ***  SRDV  ***
      *
      ***  Event Code '31C3' = Dividend
      *
     C                     MOVE '31C3'    CCCE             Event Code
      *
      * Calculate Dividend Due Amount
      *
      *  = Cum Coupon/Dividend Nominal  x  Expected Dividenv
      *
     C***********#ECDP     ADD  4         DC      30                      087712
     C***********SDDV      MULT POWER,DC  WKSDDV 157                      E16772
     C***********SDVA      MULT POWER,DC  WKSDDV 158               E16772 087712
     C***********#CCDM     MULT WKSDDV    N13#0  130H                     087712
     C*                                                                   087712
     C** Use subroutine ZCNSD to calculate dividend due.                  087712
     C*                                                                   087712
     C                     Z-ADD#ECDP     ZCDP                            087712
     C                     Z-ADD#CCDM     ZNOML                           087712
     C                     Z-ADDSDVA      ZPRC                            087712
     C                     EXSR ZCNSD                                     087712
     C                     Z-ADDZCONS     N13#0  130                      087712
     C                     Z-ADDN13#0     #NAMT
      *****************************************************************              148428 BUG11199
      **Amount*was*wrong*due*to*NMDP***********************************              148428 BUG11199
      *****************************************************************              148428 BUG11199
     C********** NMDP      ADD  5         X                                          148428 BUG11199
     C********** #NAMT     MULT POWER8,X  #NAMT     H                                148428 BUG11199
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRDE   - Subroutine to calculate Event Amount for Expected   *
      *           Dividend.                                           *
      *                                                               *
      *****************************************************************
      *
     C           SRDE      BEGSR                           ***  SRDE  ***
      *
     C                     MOVE *BLANKS   CCCE
      *
      * Calculate Dividend Due Amount
      *
      *  = Cum Coupon/Dividend Nominal  x  Total called amount %
      *
     C           #CCDM     MULT SNCP      N13#0  130H
     C                     Z-ADDN13#0     #EAMT
      *
     C           CCNC      IFEQ CCEC
     C                     Z-ADD#EAMT     #NAMT
     C                     ELSE
     C                     MOVE CCEC      ZCCYI
     C                     MOVE CCNC      ZCCYO
     C                     Z-ADD#EAMT     ZAMTCI
     C                     Z-ADDSEXR      ZEXCH
     C                     MOVE SMDI      ZMD
     C*                                                                   S01117
     C** Set out currency decimal places parameter for SR.ZCONV           S01117
     C*                                                                   S01117
     C                     Z-ADD#NCDP     ZCDPO                           S01117
     C*                                                                   S01117
     C** Set in currency decimal places parameter for SR.ZCONV            S01117
     C*                                                                   S01117
     C                     Z-ADD#ECDP     ZCDPI                           S01117
     C*                                                                   S01117
     C                     EXSR ZCONV
      *
     C************INU8     IFEQ '1'                                       S01117
     C***********          MOVE '1'       *IN52                           S01117
     C***********          MOVE '1'       *INLR            ***************S01117
     C***********          MOVEL'10'      DBASE      **DB*ERROR*10**E20651S01117
     C***********          MOVEL'13'      DBASE      * DB ERROR 13 *E20651S01117
     C***********          MOVEL'ZCONV   'DBFILE           ***************S01117
     C***********          MOVELTKEY      DBKEY                           S01117
     C***********          ELSE                                           S01117
     C                     Z-ADDZAMTCO    #NAMT
     C***********          END                                            S01117
     C                     END
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRMP   - Subroutine to calculate Event Amount for Mortgage   *
      *           Paymemt.                                            *
      *                                                               *
      *****************************************************************
      *
     C           SRMP      BEGSR                           ***  SRMP  ***
      *
      ***  Event Code '31C4' = Mortgage Payment
      *
     C                     MOVE '31C4'    CCCE
      *
     C***********          Z-ADD0         N15#7  157                      E20086
     C**********           Z-ADD1         CFDIF   98               E20086 052254
     C                     Z-ADD1         CFDIF                           052254
     C                     Z-ADD0         #NAMT
     C***********          Z-ADD0         #CAMT                           E20086
      **                                                                  E20086
      **Calculate*Interest*Due*****************************************   E20086
      *
      ***  Interest is already taken care of in Coupon Payments.          E20086
      *
     C***********          CALL 'ZACRFC'  ACRFC                           E20086
     C***********#AMT      MULT CFCT      #CAMT     H                     E20086
      *
      * Obtain Principal Repayment
      *
      *****If*Repayment*Method*EQ*'Y',*use*Repayment*Amount,*else******   E20086
      *****calculate*Princ.Repmnt**=*Position*x*(*Current*Factor/SECTY*   E20086
      ******-*Current*Factor/SEDEVD)***********************************   E20086
      *
      ***  If Repayment Method = 'Y', use the Repayment Amount            E20086
      *                                                                   E20086
     C           SRMI      IFEQ 'Y'                                       E20086
     C                     Z-ADDSRPT      #NAMT
      *
      ***  Else, obtain the previous Current Factor from the Security     E20086
      ***  Diary, then calculate Principal Repayment as:                  E20086
      ***     (Old CF - New CF) * Current Position                        E20086
      *                                                                   E20086
     C***********SRMI      IFNE 'Y'                                       E20086
     C                     ELSE                                           E20086
      *                                                                   E20086
     C                     MOVE 'MP'      XSDET                           E20086
     C                     Z-ADDCCDT      XSDED                           E20086
     C           KSED      SETGTSEDEVDO                                   E20086
     C                     READ SEDEVDO                  50               E20086
      *                                                                   E20086
     C           *IN50     IFEQ '1'                                       E20086
     C           XSDSN     ORNE CCSS                                      E20086
     C           XSDET     ORNE 'MP'                                      E20086
     C                     Z-ADD1         XSDCP                           E20086
     C                     END                                            E20086
      *                                                                   E20086
     C***********CFCT      SUB  SDCP      N15#7                           E20086
     C***********N15#7     MULT CCNP      #NAMT     H                     E20086
     C           XSDCP     SUB  SDCP      CFDIF                           E20086
     C           CFDIF     MULT CCNP      #NAMT     H                     E20086
     C                     END
      *
      **Event*Amount*=*Principal*Repayment*+*Interest*Due**************   E20086
      ***********                                                         E20086
     C***********          ADD  #CAMT     #NAMT                           E20086
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRMA   - Subroutine to calculate Event Amount for Maturity.  *
      *                                                               *
      *****************************************************************
      *
     C           SRMA      BEGSR                           ***  SRMA  ***
      *
      ***  Event Code '31C5' = Maturity
      *
     C                     MOVE '31C5'    CCCE
      *
     C                     Z-ADD0         N15#7  157
     C                     Z-ADD0         #NAMT
     C***********          Z-ADD0         #CAMT                           E23955
      *                                                                   E20085
      ***  Obtain the Coupon Date prior to the Event Maturity Date.       E20085
      *                                                                   E20085
     C           CCDT      SUB  1         ZECD                            E20085
     C/COPY WNCPYSRC,SE1480C015
     C                     EXSR ZLCD                                      E20085
     C/COPY WNCPYSRC,SE1480C016
      *
      **Calculate*Interest*Due*****************************************   E20085
      ***********                                                         E20085
     C***********          CALL 'ZACRFC'  ACRFC                           E20085
     C***********          Z-ADD#AMT      #CAMT                           E20085
      *
      * Obtain Price At Maturity
      *
     C***********          MOVE 'RC'      TYPE02                          E20086
     C                     MOVE 'RC'      XSDET                           E20086
     C                     Z-ADDMATY      XSDED                           E20086
     C***********KSED      CHAINSEDEV                50                   E20086
     C           KSED      CHAINSEDEVDO              50                   E20086
     C           *IN50     IFEQ '1'
     C***********          MOVE 'RP'      TYPE02                          E20086
     C                     MOVE 'RP'      XSDET                           E20086
     C***********KSED      CHAINSEDEV                50                   E20086
     C           KSED      CHAINSEDEVDO              50                   E20086
     C                     END
      *
     C           *IN50     IFEQ '0'
     C                     Z-ADDXSDRP     N15#7
     C                     ELSE
      *
     C           SPBS      IFEQ 'P'
     C                     Z-ADD100       N15#7
     C                     END
      *
     C***********SPBS      IFEQ 'U'                                       103011
     C***********          Z-ADD1         N15#7                           103011
     C***********          END                                            103011
     C*                                                                   073040
     C*** For Mortgage-Backed Securities, obtain the current factor       073040
     C*** from the latest mortgage repayment record.                      073040
     C*                                                                   073040
     C           PROT      IFEQ '8'                                       073040
     C                     MOVE 'MP'      XSDET                           073040
     C                     MOVE CCDT      XSDED                           073040
     C           KSED      SETGTSECEO                                     073040
     C                     READ SECEO                    50               073040
     C           *IN50     IFEQ '0'                                       073040
     C           XSDET     ANDEQ'MP'                                      073040
     C           XSDSN     ANDEQCCSS                                      073040
     C                     MULT XSDCP     N15#7                           073040
     C                     END                                            073040
     C                     END                                            073040
     C*                                                                   073040
     C                     END
     C                     MOVE '0'       *IN50
      *
      * Calculate Nominal Maturing for Book
      *
     C           CCNP      MULT N15#7     #AMT      H
      *
     C           SPBS      IFEQ 'P'
     C           #AMT      DIV  100       #AMT      H
     C                     END
      *
      * Convert (#AMT) to Event Ccy Decimal Positions.
      * Convert from Nom D.p. to the CCY D.p.
      *          'to' ccy   -  'from' ccy
      *
     C           #NCDP     IFNE NMDP
     C           #NCDP     SUB  NMDP      X       20
     C                     ADD  5         X
     C           #AMT      MULT POWER8,X  #AMT      H
     C                     END
      *
      **Event*Amount*=*Nom*+*Intr*Due**********************************   E23955
      ***********                                                         E23955
     C***********#AMT      ADD  #CAMT     #NAMT                           E23955
     C                     Z-ADD#AMT      #NAMT                           E23955
      *
     C                     ENDSR
      *
      *****************************************************************   S01447
      /EJECT                                                              S01447
      *****************************************************************   S01447
      *                                                               *   S01447
      *  CSTLOC - Find customer's country of domicile - only if       *   S01447
      *           customer changed from last record read.             *   S01447
      *                                                               *   S01447
      *  CALLED BY:    SROUT                                          *   S01447
      *  CALLS:        NONE                                           *   S01447
      *                                                               *   S01447
      *****************************************************************   S01447
      *                                                                   S01447
     C           CSTLOC    BEGSR                                          S01447
      *                                                                   S01447
     C           CCCN      IFNE UCCCN                      *B1            S01447
      *                                                                   S01447
     C           CCCN      CHAINCLINTCBF             52    *B2            S01447
     C           *IN52     IFEQ '1'                                       S01447
     C           RECI      ORNE 'D'                                       S01447
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVE '1'       *INLR                           S01447
     C                     MOVE '1'       *IN52            ***************S01447
     C                     Z-ADD18        DBASE            * DB ERROR 18 *S01447
     C                     MOVEL'CLINTCBF'DBFILE           ***************S01447
     C                     MOVELCCCN      DBKEY                           S01447
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01447
     C                     ELSE                            *X2            S01447
     C                     MOVE CLOC      UCLOC                           S01447
     C**********           Z-ADDCCCN      UCCCN                                        S01447 CSD027
     C                     MOVE CCCN      UCCCN                                               CSD027
     C                     END                             *E2            S01447
     C                     END                             *E1            S01447
      *                                                                   S01447
     C                     ENDSR                                          S01447
      *                                                                   S01447
      *****************************************************************   S01447
      /EJECT                                                              S01447
      *****************************************************************   S01447
      *                                                               *   S01447
      *  CALCTX - Subroutine to calculate amount for DV or CP         *   S01447
      *                                                               *   S01447
      *  CALLED FROM: SROUT                                           *   S01447
      *  CALLS:       NONE                                            *   S01447
      *                                                               *   S01447
      *****************************************************************   S01447
      *                                                                   S01447
     C           CALCTX    BEGSR                                       ** S01447
      *                                                                   S01447
      *** Initialise work tax rate and amount fields                      S01447
      *                                                                   S01447
     C                     CLEARUTXRSR                                    S01447
     C                     CLEARUTXRUS                                    S01447
     C                     CLEARUTXSRC                                    S01447
     C                     CLEARUTXUSR                                    S01447
      *                                                                   S01447
      *** Access securities WHT details file to get tax band              S01447
      *                                                                   S01447
     C           CCSS      CHAINSESWHTL0             54                   S01447
     C           *IN54     IFEQ '0'                        *B1            S01447
      *                                                                   S01447
      *** If tax band not zero, then access SE country tax rate file      S01447
      *** to get tax rate at source, and access country to branch tax     S01447
      *** rate file to get tax rate by user.                              S01447
      *** Otherwise get rates from security file.                         S01447
      *                                                                   S01447
     C           S1TABD    IFEQ *ZERO                      *B2            S01447
     C                     Z-ADDS1RASO    UTXRSR                          S01447
     C                     ELSE                            *X2            S01447
      *                                                                   S01447
     C                     MOVELS1CTTA    UKEY    3                       S01447
     C                     MOVE S1TABD    UKEY                            S01447
      *                                                                   S01447
     C                     CALL 'AOSCTXR0'                                S01447
     C                     PARM *BLANKS   @RTCD                           S01447
     C                     PARM '*KEY   ' @OPTN                           S01447
     C                     PARM S1CTTA    @CTTA   2                       S01447
     C                     PARM S1TABD    @TABD   10                      S01447
     C           SECNTR    PARM SECNTR    DSSDY                           S01447
     C*                                                                   S01447
     C           @RTCD     IFNE *BLANKS                    *B3            S01447
     C           TXRECI    ORNE 'D'                                       S01447
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INLR                           S01447
     C                     MOVE '1'       *IN52                           S01447
     C                     MOVEL'SECNTRL0'DBFILE           ***************S01447
     C                     MOVELUKEY      DBKEY            ** DB ERROR 20 S01447
     C                     Z-ADD20        DBASE            ***************S01447
     C                     SETON                       U7U8               S01447
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01447
     C                     ELSE                            *X3            S01447
     C                     Z-ADDTXRASO    UTXRSR                          S01447
     C                     END                             *E3            S01447
     C                     END                             *E2            S01447
      *                                                                   S01447
     C           S1TABU    IFEQ *ZERO                      *B2            S01447
     C                     Z-ADD*ZERO     UTXRUS                          S01447
     C                     MOVE *BLANK    UDLOR                           S01447
     C                     ELSE                            *X2            S01447
      *                                                                   S01447
     C/COPY WNCPYSRC,SE1480C007
     C                     CALL 'AOCBTXR0'                                S01447
     C                     PARM *BLANKS   @RTCD                           S01447
     C                     PARM '*KEY   ' @OPTN                           S01447
     C                     PARM CCBA      @BRCA   3                       S01447
     C                     PARM S1CTTA    @CTTA                           S01447
     C                     PARM S1TABU    @TABU   10                      S01447
     C           SECBTX    PARM SECBTX    DSFDY                           S01447
     C/COPY WNCPYSRC,SE1480C008
     C*                                                                   S01447
     C           @RTCD     IFNE *BLANKS                    *B3            S01447
     C           TBRECI    ORNE 'D'                                       S01447
     C                     Z-ADD*ZERO     UTXRUS                          S01447
     C                     MOVE *BLANK    UDLOR                           S01447
     C                     ELSE                            *X3            S01447
     C                     Z-ADDTBRAUS    UTXRUS                          S01447
     C                     MOVE TBDLOR    UDLOR                           S01447
     C                     END                             *E3            S01447
     C                     END                             *E2            S01447
      *                                                                   S01447
      *** calculate amount deducted at source                             S01447
      *                                                                   S01447
     C           UTXRSR    DIV  100       URATE   54                      S01447
     C           CCEA      MULT URATE     UTXSRC    H                     S01447
      *                                                                   S01447
      *** calculate amount deducted by user                               S01447
      *                                                                   S01447
     C           UCLOC     IFNE UBRLOC                     *B2            S01447
     C           UDLOR     OREQ 'Y'                                       S01447
     C           UTXRUS    DIV  100       URATE                           S01447
     C/COPY WNCPYSRC,SE1480C009
     C           CCEA      MULT URATE     UTXUSR    H                     S01447
     C/COPY WNCPYSRC,SE1480C010
     C                     ELSE                            *X2            S01447
     C                     Z-ADD*ZERO     UTXUSR                          S01447
     C                     END                             *E2            S01447
      *                                                                   S01447
     C                     END                             *E1            S01447
      *                                                                   S01447
     C                     ENDSR                                          S01447
      *                                                                   S01447
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRLR   - Subroutine for Control Processing                   *
      *                                                               *
      *****************************************************************
      *
     C           SRLR      BEGSR                           ***  SRLR  ***
      *
      * If no records read - Empty Primary File,
      *  access the I.C.D. record (PF/TABTB10)
      *
     C           *IN40     IFEQ '0'
     C           *IN99     ANDEQ'0'
     C                     EXSR ZSYSTM
      *
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU7                           170108
     C                     MOVE '1'       *INU8                           170108
     C                     MOVEL'TABLE'   DBFILE           ***************
     C***********          MOVEL'10'      DBASE            **DB*ERROR*10**E20651
     C***********          MOVEL'14'      DBASE      **DB*ERROR*14**E20651S01117
     C                     Z-ADD14        DBASE            * DB ERROR 14 *S01117
     C                     MOVELZTABKY    DBKEY            ***************
     C                     CLEARDBPGM                                     170108
     C                     MOVEL'SE1480'  DBPGM                           170108
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
     C                     END
     C                     END
      *
      * Write control report headings
      *
     C                     WRITEHEADAU
      *
      * Database Errors **DB**01-09**
      *
     C           *IN99     IFEQ '1'
     C           *IN52     OREQ '1'
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INU7
      *
     C           *IN53     IFEQ '1'
     C***********          IN   LDA                                       S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     OUT  LDA
     C**********           MOVE #DBLOT    DBLOT                           170108
     C                     END
     C                     WRITEERROR
      *
     C                     END
      *
      *  Access AUDIT records / Compare Totals
      *
     C                     READ SEDEVAF                  50
     C                     WRITETOT01
      *
     C                     READ SNDEFAF                  50
     C                     WRITETOT02
      *
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1480CCP4                                           S01408
      *                                                                   S01408
     C           IN02      IFNE AUDIT2
     C                     WRITEDIFF
     C           *INU8     IFEQ '0'
     C                     MOVE 'Y'       WERR                            170108
     C           *LOCK     IN   LDA                                       170108
     C                     MOVE '1'       *INU8            ***************
     C************         MOVEL'11'      DBASE            **DB*ERROR*11**S01117
     C                     Z-ADD11        DBASE            * DB ERROR 11 *S01117
     C                     MOVEL'SNDEFA  'DBFILE           ***************
     C                     MOVEL'*AUDIT**'DBKEY
     C                     CLEARDBPGM                                     170108
     C                     MOVEL'SE1480'  DBPGM                           170108
     C                     WRITEERROR
     C                     OUT  LDA                                       170108
     C                     EXSR *PSSR                                     S01117
     C                     END
     C                     END
      *                                                                   S01408
     C/COPY WNCPYSRC,SE1480CCP5                                           S01408
      *                                                                   S01408
      *
      * Write AUDIT record
      *
     C                     Z-ADDOUTREC    NORE
     C                     WRITECPEVEAF
      *
      ***IF*NO*OUTPUT/EMPTY*FILES*-*Print*a*message*to*this*effect*****   E29170
      ***********                                                         E29170
     C************IN40     IFEQ '0'                                       E29170
     C***********          WRITENONE                                      E29170
     C***********          ELSE                                           E29170
      *
      ********ELSE****-*Print*Records*Written*Total********************   E29170
      *                 Print Records Written Total                       E29170
     C                     WRITECONTROL
     C***********          END                                            E29170
      *
      *  END OF PROGRAM
     C***********          WRITETRAILAU                                   E29170
      **********                                                          170108
      ***If*Database*Erorrs*found,*update*LDA**************************   170108
      **********                                                          170108
     C********** *NAMVAR   DEFN           LDA                             170108
      *
     C********** *INU8     IFEQ '1'                                       170108
     C********** *IN53     ANDEQ'0'                                       170108
      *
     C********** *LOCK     IN   LDA                                       170108
     C**********           MOVELDBLOT     #DBLOT                          170108
     C**********           OUT  LDA                                       170108
     C**********           END                                            170108
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT                                                              S01117
      *****************************************************************   S01117
      *                                                               *   S01117
      *  *PSSR  - Error control subroutine                            *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
      *                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR **    S01117
     C**                                                                  S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C           WERR      IFNE 'Y'                                       170108
     C                     WRITEHEADAU                                    170108
     C                     WRITEERROR                                     170108
     C                     ENDIF                                          170108
     C                     RETRN                                          CEU011
     C                     END                                            S01117
     C**                                                                  S01117
     C                     ENDSR                                          S01117
      *                                                                   S01117
     C*****************************************************************   S01117
      /EJECT
     C/COPY ZSRSRC,ZCONVZ1
      /EJECT                                                              E20085
     C/COPY ZSRSRC,ZDATE1Z2                                               E20085
      /EJECT                                                              E20085
     C/COPY ZSRSRC,ZDATE2Z4                                               E20085
      /EJECT                                                              E20085
     C/COPY ZSRSRC,ZLCDZ1                                                 E20085
      /EJECT
     C/COPY ZSRSRC,ZSYSTMZ1
      /EJECT
     C/COPY ZSRSRC,ZACCH                                                  S01512
     C/EJECT                                                              S01512
     C/COPY ZSRSRC,ZFWDT                                                  S01512
     C/EJECT                                                              S01512
     C/COPY ZSRSRC,ZCNSDZ1                                                087712
     C/EJECT                                                              087712
      ***
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN                      E20085
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR                        E20085
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES                                            E20085
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
