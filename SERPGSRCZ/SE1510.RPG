     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Project Fwd Customer Depot Posns')
     F*****************************************************************
     F*                                                               *
     F*  Midas - Securities Trading Module
     F*                                                               *
     F*  SE1510 - PROJECT FORWARD CUSTOMER DEPOT POSITIONS            *
     F*                                                               *
     F*  Function: This program projects forward Portfolio Customer   *
     F*   (COB)    Positions by Branch/Security/Customer/Depot/Market *
     F*            /Date using forward-valued Trades (PCTEVD).  The   *
     F*            data held is as for Current Positions, with only   *
     F*            two fields projected; Nominal-Value Date Basis,    *
     F*            and Ex-Coupon Nominal.  The Current Position if it *
     F*            exists, is used as a starting point for these two  *
     F*            Nominal Balances.                                  *
     F*                                                               *
     F*  Called by: SEC1111 - Project Forward Customer/Depot Positions*
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *  Prev Amend No. S01496             Date 15Jul94               *
      *                 052254             Date 10Jan94               *
     F*                 E34034             DATE  7JAN92               *
     F*                 S01117             DATE 06NOV90               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD046248 - Finastra Rebranding                               *
     F*  S01496 - Incorporation of JYSKE Enhancements (S10978)        *
     F*  052254 - RECOMPILED as CURRENT FACTOR amended from 9,8       *
     F*           to 10,9                                             *
     F*  E34034 - Recompiled over changed printer file                *
     F*  S01117 - Multi-branching                                     *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
      *
     FCDPEV   IPE E           K        DISK
     F*CDEPP***IF**E***********K********DISK                              S01496
     FCDEPP   IF  E           K        DISK                           UC  S01496
     F******CDEPP1  IF  E           K        DISK                     UC  S01496
     FSECDEPL3IF  E           K        DISK                           UC  S01496
     F            CDEPPDF                           KRENAMECDEPPDFY       S01496
     F*TABSE***IF* E           K        DISK                              S01117
     F*********** TABLETAF                          KIGNORE               S01117
     F*********** TABLETHF                          KIGNORE               S01117
     F*********** TABLETJF                          KIGNORE               S01117
     F*********** TABLETLF                          KIGNORE               S01117
     F*********** TABLETKF                          KIGNORE               S01117
     F*********** TABLETNF                          KIGNORE               S01117
     F*********** TABLETPF                          KIGNORE               S01117
     F*********** TABLETRF                          KIGNORE               S01117
     F*********** TABLETXF                          KIGNORE               S01117
     F**ICD*1*****TABTB10F                          KIGNORE
     F*********** TABTB11F                          KIGNORE               S01117
     F*********** TABTB36F                          KIGNORE               S01117
     F*********** TABTB40F                          KIGNORE               S01117
     F*********** TABTE10F                          KIGNORE               S01117
     F*********** TABTE20F                          KIGNORE               S01117
     F*********** TABTG10F                          KIGNORE               S01117
     F*********** TABTG20F                          KIGNORE               S01117
     F*********** TABLET2F                          KIGNORE               S01117
     F*********** TABLET3F                          KIGNORE               S01117
     F*********** TABLET5F                          KIGNORE               S01117
     FPCTEVA  IF  E                    DISK
     FCDEPFD  O   E                    DISK
     F            CDEPPDF                           KRENAMECDEPFDF
     FCDEPFA  O   E                    DISK
     FSE1510AUO   E                    PRINTER
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F****L1**-*Branch/Security/Book/Depot/Mkt/Date*combination change*   S01496
     F*   L1  - Branch/Security/Book/Ptfr/Depot/Mkt/Date comb.change  *   S01496
     F****L1**-*Branch/Security/Cust/Depot/Mkt*combination*change******   S01496
     F*   L1  - Branch/Security/Cust/Ptfr/Depot/Mkt combination change*   S01496
     F****L2* -*Branch/Security/Cust/Depot/Mkt/Date*combination change*   S01496
     F*   L2  - Branch/Sec/Cust/Ptfr/Depot/Mkt/Date combination change*   S01496
     F*                                                               *
     F*   40  - Portfolio Customer Trade Event - first record         *
     F*   50  - Work indicator                                        *
     F*                                                               *
     F* 90-99 - Used in Standard Subroutines                          *
     F*                                                               *
     F*   U7  - Database Error                                        *
     F*   U8  - Database / Control Error                              *
     F*                                                               *
     F*****************************************************************
      /SPACE 3
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  L2DET  - Access Customer Depot Positions (Current)           *
     F*  *PSSR  - Error Handling Subroutine                           *   S01117
     F*                                                               *
     F***ZSYSTM*-*Access*ICD*record*                                  *   S01117
     F*                                                               *
     F*****************************************************************
      /EJECT
     E                    CPY@    1   1 80                                S01117
      /EJECT
     IPCTEVDF
     I***********                                   TRBN  L2              S01117
     I                                              TRBA  L2              S01117
     I                                              TRSS  L2
     I                                              TRPT  L2
     I                                              PTFR  L2              S01496
     I                                              TROD  L2
     I                                              TRMK  L2
     I                                              TRVD  L1
     ICDEPPDF
     I              DDTE                            XDDTE
     I              CDNT                            XCDNT
     I              CDNS                            XCDNS
     I              SNPT                            XSNPT
     I              CNPV                            XCNPV
     I              CDST                            XCDST
     I              SAPP                            XSAPP
     I              SAPS                            XSAPS
     I              CNSV                            XCNSV
     I              SAPV                            XSAPV
     I              SPSV                            XSPSV
     I              TNLU                            XTNLU
     ICDEPPDFY                                                            S01496
     I              DDTE                            YDDTE                 S01496
     I              CDNT                            YCDNT                 S01496
     I              CDNS                            YCDNS                 S01496
     I              SNPT                            YSNPT                 S01496
     I              CNPV                            YCNPV                 S01496
     I              CDST                            YCDST                 S01496
     I              SAPP                            YSAPP                 S01496
     I              SAPS                            YSAPS                 S01496
     I              CNSV                            YCNSV                 S01496
     I              SAPV                            YSAPV                 S01496
     I              SPSV                            YSPSV                 S01496
     I              TNLU                            YTNLU                 S01496
     IPCTEVAF
     I              NORE                            TRIN
     I*                                                                   S01117
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION            S01117
     ICPYR@#      DS                                                      S01117
     I                                        1  80 CPY@                  S01117
     I                                        1  20 CPY@##                S01117
     I*
     I*LDA*******UDS                            256                       S01117
     I***********                           134 177 #DBLOT                S01117
     I*********** DS                                                      S01117
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 177 DBASE                 S01117
     ILDA         DS                            256                       S01117
     I                                      134 183 DBLOT                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     I*                                                                   S01117
     IRUNDT       DS                                                      S01117
     I*                                                                   S01117
     I** DATA AREA RUNDAT                                                 S01117
     I*                                                                   S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
     I*                                                                   S01117
     ISDBANK    E DSSDBANKPD                                              S01117
     I*                                                                   S01117
     I**  EXTERNAL DS FOR BANK DETAILS                                    S01117
     I*                                                                   S01117
     I              BJURPT                          TITL                  S01117
     I*                                                                   S01117
     I**  FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE              S01117
     I*                                                                   S01117
     IDSFDY     E DSDSFDY                                                 S01117
     I*                                                                   S01117
     I*
     I           SDS
     I                                      244 246 WSID
     I                                      254 263 USID
     C/EJECT
      *================================================================
      *
      *  P R O G R A M     S T A R T  - Initial Processing
      *
      *================================================================
      *
     C*
     C           *IN40     IFEQ '0'
      *
      * Prepare LDA for the database error output
      *
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL*BLANK    DBLOT
     C                     MOVEL'SE1510'  DBPGM
     C                     OUT  LDA                                       S01117
      *
      **Access*the*I.C.D.*record*(PF/TABTB10)**************************   S01117
      ***********                                                         S01117
     C***********          EXSR ZSYSTM                                    S01117
     C*                                                                   S01117
     C**  In the dataarea rundat                                          S01117
     C*                                                                   S01117
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
     C                     IN   RUNDT                                     S01117
     C*                                                                   S01117
     C**  Get Bank Title by access object                                 S01117
     C*                                                                   S01117
     C                     CALL 'AOBANKR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDBANK    PARM SDBANK    DSFDY                           S01117
      *
      **Error*in*ZSYSTM**********************                             S01117
      ***********                                                         S01117
     C************IN99     IFEQ '1'                                       S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     MOVE '1'       *INLR            End of job
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDBANKPD'DBFILE           ************** S01117
     C                     MOVEL@OPTN     DBKEY            * DB ERROR 2 * S01117
     C                     Z-ADD2         DBASE            ************** S01117
     C                     OUT  LDA                                       S01117
     C                     MOVEL@OPTN     DBOPTN  7                       S01117
     C                     SETON                       U7U8               S01117
     C                     EXSR *PSSR                                     S01117
     C                     ELSE
      *
      * ICD record found.
      *
     C                     MOVE '1'       *IN40
     C                     END
      *                                                                   S01496
      **  Access SAR details file to see if JYSKE Enhcmts is installed.   S01496
      *                                                                   S01496
     C           *IN40     IFEQ '1'                                       S01496
     C                     CALL 'AOSARDR0'                                S01496
     C                     PARM '       ' @RTCD   7                       S01496
     C                     PARM '*VERIFY' @OPTN   7                       S01496
     C                     PARM 'S01496'  WSARD   6                       S01496
      *                                                                   S01496
     C           @RTCD     IFEQ *BLANK                                    S01496
     C                     MOVE 'Y'       S01496  1                       S01496
     C                     END                                            S01496
      *                                                                   S01496
     C           S01496    IFEQ 'Y'                                       S01496
     C                     OPEN SECDEPL3                                  S01496
     C                     ELSE                                           S01496
     C                     OPEN CDEPP                                     S01496
     C                     END                                            S01496
     C                     END                                            S01496
      *                                                                   S01496
     C                     END
      /EJECT
      *================================================================
      *
      *  M A I N L I N E   P R O C E S S I N G
      *
      *================================================================
      *
     C           *IN40     IFEQ '1'
      *
      **At*change*of*Br/Sec/Cust/Depot/Mkt*set*up*initial*values          S01496
      * At change of Br/Sec/Cust/Ptfr/Depot/Mkt set up initial values     S01496
      *  of the accumulator fields  1. Nominal - Value Date Basis (CDNV)
      *                             2. Ex-Coupon Nominal.         (CECN)
      *
     C           *INL2     CASEQ'1'       L2DET
     C                     END
      *
      * For each event record add/sub event nominal to Nominal-Vdat basis.
      * (Pfolio Customer Trade Events - Trade type TP : add, TS : sub.)
      *
      * Set up output fields.
      *
     C                     Z-ADDTRVD      DDTE
     C                     ADD  1         TRCNT   50       No of TRADE
      *
      *   Update : Nominal - Value Date Basis
      *
     C           TRTT      IFEQ 'TP'
     C                     Z-SUBTRON      TRON
     C                     END
      *
     C                     ADD  TRON      CDNV
      *
      *   Update : Ex-Coupon Nominal
      *
     C           TRED      IFEQ 'X'
     C                     ADD  TRON      CECN
     C                     END
      *
     C                     END
      *
      *================================================================
      *
      *  T O T A L   T I M E   P R O C E S S I N G
      *
      *================================================================
      *
     CL1                   EXSR SRL1
      *
     CLR                   EXSR SRLR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  T O T A L   T I M E   P R O C E S S I N G                    *
      *                                                               *
      *****************************************************************
      *
     C           SRL1      BEGSR
      *
      * Output Projected Positions record at value date change.
      *
     C           *IN40     IFEQ '1'
      *
     C                     ADD  1         OUTREC
     C                     MOVE 'D'       RECI
      *
     C                     WRITECDEPFDF
      *
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      **                                                              *
      **  L2DET SR. To access the Cust Depot Positions (Current) file *
      **            and set up the initial values for the accumulator *
      **            fields :  Nominal - Value Date Basis  (CDNV)      *
      **                      Ex-Coupon Nominal           (CECN)      *
      **                                                              *
      *****************************************************************
      **
     C           L2DET     BEGSR                           *** L2DET ***
      *
      * Set up Key/Output fields.
      *
     C**********           Z-ADDTRBN      CDBR                            S01117
     C                     MOVE TRBA      CDPA                            S01117
     C                     MOVELTRSS      CDSN
     C                     MOVELTROD      CDPT
     C                     MOVELTRPT      CDCN
     C                     MOVELTRMK      CDMK
      *
      * Zero the initial accumulator values.
      *
     C                     Z-ADD0         CDNV
     C                     Z-ADD0         CECN
      *                                                                   S01496
     C           S01496    IFNE 'Y'                                       S01496
      *
      * Access the Cust Depot Positions (Current) file  - LF/CDEPP
      * Set up output fileds.
      *
     C           KEY01     KLIST
     C***********          KFLD           CDBR                            S01117
     C                     KFLD           CDPA                            S01117
     C                     KFLD           CDCN
     C                     KFLD           CDSN
     C                     KFLD           CDPT
     C                     KFLD           CDMK
      *
     C           KEY01     CHAINCDEPP                50
      *                                                                   S01496
     C                     ELSE                                           S01496
      *                                                                   S01496
      * Access the Cust Depot Positions (Current) file  - LF/SECDEPL3     S01496
      * Set up output fileds.                                             S01496
      *                                                                   S01496
     C           KEY02     KLIST                                          S01496
     C                     KFLD           CDPA                            S01496
     C                     KFLD           CDCN                            S01496
     C                     KFLD           PTFR                            S01496
     C                     KFLD           CDSN                            S01496
     C                     KFLD           CDPT                            S01496
     C                     KFLD           CDMK                            S01496
      *                                                                   S01496
     C           KEY02     CHAINSECDEPL3             50                   S01496
      *                                                                   S01496
     C                     END                                            S01496
      *
     C                     ENDSR
     C*****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  E.O.J. - C O N T R O L   P R O C E S S I N G                 *
      *                                                               *
      *****************************************************************
      *
     C           SRLR      BEGSR
      *
      * If no records read,
      ***access*the*I.C.D.*record*(PF/TABTB10)**                          S01117
     C**  In the dataarea rundat                                          S01117
      *
     C           *IN40     IFEQ '0'
     C************IN99     ANDEQ'0'                                       S01117
     C           @RTCD     ANDEQ*BLANKS                                   S01117
     C***********          EXSR ZSYSTM                                    S01117
     C                     IN   RUNDT                                     S01117
     C*                                                                   S01117
     C* Get Bank Title by access object                                   S01117
     C*                                                                   S01117
     C                     CALL 'AOBANKR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDBANK    PARM SDBANK    DSFDY                           S01117
     C*                                                                   S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL*BLANK    DBLOT                           S01117
     C                     MOVEL'SE1510'  DBPGM                           S01117
     C                     MOVEL'SDBANKPD'DBFILE           ***************S01117
     C                     MOVEL@OPTN     DBKEY            * DB ERROR 03 *S01117
     C                     Z-ADD3         DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     MOVEL@OPTN     DBOPTN  7                       S01117
     C                     SETON                       U7U8               S01117
     C                     EXSR *PSSR                                     S01117
     C                     END                                            S01117
     C                     END
      *
      * Write control report headings
      *
     C                     WRITEHEADAU
      *
      **Error*in*ZSYSTM***************************************************S01117
      *
     C************IN99     IFEQ '1'                                       S01117
     C***********          MOVE '1'       *INU7                           S01117
     C***********          MOVE '1'       *INU8                           S01117
     C***********          MOVEL'01'      DBASE            **DB ERROR 01**S01117
     C***********          MOVEL'TABLE'   DBFILE                          S01117
     C***********          MOVELZTABKY    DBKEY                           S01117
     C*                                                                   S01117
     C           *INU7     IFEQ '1'                                       S01117
     C           *INU8     ANDEQ'1'                                       S01117
     C*                                                                   S01117
     C                     WRITEERROR
      *
     C                     END
      *
      *  Access AUDIT record for Portfolio Customer Trade Events.
      *
     C                     READ PCTEVAF                  50
     C                     WRITETRTOT
      *
      *          - WRITE Audit record
      *
     C                     Z-ADDOUTREC    NORE
     C                     WRITECDEPFAF
      *
      ***IF*NO*OUTPUT/EMPTY*FILES*-*Print*a*message*to*this*effect**      S01117
      ***********                                                         S01117
     C************IN40     IFEQ '0'                                       S01117
     C***********          WRITENONE                                      S01117
      ***********                                                         S01117
     C***********          ELSE                                           S01117
      ***********                                                         S01117
      ***********-*Print*Records*Written*Total**                          S01117
      ***********                                                         S01117
     C                     WRITECONTROL
      *
     C***********          END                                            S01117
      *
      *  END OF PROGRAM
      *
     C***********          WRITETRAILAU                                   S01117
      *
      ***If*Database*Errors*found,*update*LDA**************************** S01117
      ***********                                                         S01117
     C************NAMVAR   DEFN           LDA                             S01117
      ***********                                                         S01117
     C************INU8     IFEQ '1'                                       S01117
     C************LOCK     IN   LDA                                       S01117
     C***********          MOVELDBLOT     #DBLOT                          S01117
     C***********          OUT  LDA                                       S01117
     C***********          END                                            S01117
      *
     C           *IN40     IFEQ '1'                                       S01496
      *                                                                   S01496
     C           S01496    IFEQ 'Y'                                       S01496
     C                     CLOSESECDEPL3                                  S01496
     C                     ELSE                                           S01496
     C                     CLOSECDEPP                                     S01496
     C                     END                                            S01496
     C                     END                                            S01496
      *                                                                   S01496
     C                     ENDSR
      *****************************************************************
      /EJECT                                                              S01117
     C*****************************************************************   S01117
     C*                                                               *   S01117
     C* *PSSR - SUBROUTINE TO HANDLE ABNORMAL ERROR CONDITIONS        *   S01117
     C*                                                               *   S01117
     C* CALLED FROM : AFTER ABNORMAL OPERATION OCCURS                 *   S01117
     C*                                                               *   S01117
     C* CALLS : NOTHING                                               *   S01117
     C*                                                               *   S01117
     C*****************************************************************   S01117
     C*                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR **    S01117
     C*                                                                   S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     ENDSR                                          S01117
     C********************************************************************S01117
      /EJECT
     C*COPY*ZSRSRC,ZSYSTMZ1**                                             S01117
** CPY@
(c) Finastra International Limited 2001
