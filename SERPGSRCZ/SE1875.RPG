     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Trade extract for confirmations')             *
      *****************************************************************
      *                                                               *
      *  Midas - Securities and Trading Module                        *
      *                                                               *
      *  SE1875 - SE Trade Extract for Confirmations                  *
      *                                                               *
      *  Function:  This program will extract information from trades *
      *  (IC)       and output the data to new file PF/MGF51NPD.      *
      *                                                               *
      *                                                               *
      *  Called By: SEC0304 - Input Cycle Confirmation Print          *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. 226449             Date 24Jun15               *
      *  Prev Amend No. CRE075             Date 06Dec10               *
      *                 AR589197           Date 11Aug10               *
      *                 AR580937           Date 26Jul10               *
      *                 AR581532           Date 21Jul10               *
      *                 AR549800           Date 11Jun10               *
      *                 AR467409           Date 04Jun10               *
      *                 CSW210             Date 04May10               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 246866             Date 12Apr07               *
      *                 246420             Date 19Mar07               *
      *                 246272             Date 08Mar07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 234140             Date 26Oct06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 239053             Date 30Aug06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 219242             Date 01Jul03               *
      *                 219241             Date 01Jul03               *
      *                 210796             Date 27Jan03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CSW025             Date 26Mar02               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CSE028             Date 06Jun01               *
      *                 169150             Date 02Jul01               *
      *                 155959             Date 02Jul01               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CSE023             Date 12Jul00               *
      *                 CDL008             Date 02May00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 166684             Date 27Jun00               *
      *                 155314             Date 27Jun00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSE006             Date 02SEP99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 140439             Date 05Aug98               *
      *                 140428             Date 05Aug98               *
      *                 140437             Date 04Aug98               *
      *                 CSW014             Date 22Jun98               *
      *                 CSW098  *CREATE    Date 31Mar98               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  CRE075 - Effective Date for Retail Accounts (Recompile)      *
      *  AR589197 - The input validation of //xx has been removed if  *
      *             ISO15022 is switched on, it should be reapplied   *
      *             as the code is still used                         *
      *  AR580937 - Correct formatting of Field 97A tag               *
      *  AR581532 - Field tag 97A CASH included the slash after       *
      *             invalid account as output in MT515 and MT518      *
      *  AR549800 - Introduce IBAN flag to PF/MGF51NPD                *
      *  AR467409 - DDUSW2010 - If the SWIFT changes 2002 is switched *
      *             on The first characters of account lines should   *
      *             not start with a / anymore.                       *
      *  CSW210 - SWIFT 2010 Changes                                  *
      *  246866 - Safekeeping account is truncated. Fix is to omit    *
      *           the 1st character of the code if equal to '/'.      *
      *  246420 - When extended settlement is being use, the delivery *
      *           A/C for trade sale (trade type TS) should be the    *
      *           bank's account.                                     *
      *  246272 - Applied fix 229270.                                 *
      *  229270 - Update correct action code for MMM to MGOREFPD      *
      *           during authorisation of deleted trade.              *
      *  234140 - EU witholding tax                                   *
      *  239053 - Safekeeping account line can be inserted without '/'*
      *           If input has no preceding '/', just move the value  *
      *           to MGSA1L.                                          *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits (Recompile)      *
      *  219242 - Not possible to create MT103+ payment msg from      *
      *           non-FT transaction (Recompile)                      *
      *  219241 - Defaulting of "Details of Charges" assign a         *
      *           system value (Recompile)                            *
      *  210796 - Extend Our a/c at Nostro field                      *
      *  CSW025 - Midas Message Manager                               *
      *           - Pass original change type                         *
      *  CSE028 - Standing Settlement Instructions Enhancement.       *
      *           (Recompiled).                                       *
      *  169150 - Correction to 155959.                               *
      *           Fix is to call SR/SRVALD in SR/SRF5IN after the     *
      *           message type (field MGMTYP) has been initialised.   *
      *  155959 - Message type 518 is still generated even though it  *
      *           is defined in the customer details that this should *
      *           not be produced.  Added validation to determine if  *
      *           message types are to be generated for a customer.   *
      *  CSE023 - Treaty Withholding Tax                              *
      *   CDL008 - Continuous Linked Settlement (Recompiled MGOREFPD) *
      *  166684 - Reset TRADSDX1/T1CONG to 'N' after successful write *
      *           to extract PF/MGF51NPD.                             *
      *  155314 - Data base in error in MG051N at "007".              *
      *           T1@CONG is "Y" but message was already dropped.     *
      *           As message was dropped,SE1875 can not find it       *
      *           anymore and do not call MG5910 to reset CONG.       *
      *  CSE006 - Repurchase Agreements (REPOs) enhancement           *
      *  140439 - SWIFT98 fix                                         *
      *           If settle method is 04, account details not         *
      *           properly output to field 97A of MT515.   Fix is     *
      *           to set up prime retail account details.             *
      *  140428 - SWIFT98 fix                                         *
      *           Record locking error in MGF51NPD when updated       *
      *           or written records in this program are accessed     *
      *           by M051N or MG5900. Fix is to issue a COMIT         *
      *           after successful update/write.                      *
      *  140437 - SWIFT98 fix                                         *
      *           Dbase error 27 when trying to  access SDSECSPD      *
      *           record for DELF = 000000 when trade type is TP.     *
      *           This  access should only be done if trade type      *
      *           is TS.                                              *
      *  CSW014 - ERI Information for non-EMU users.                  *
      *  CSW098 - SWIFT 1998 changes.                                 *
      *                                                               *
      *****************************************************************
     FTRADSDJ2IF  E           K        DISK         KINFSR *PSSR
     FTRADSDY2IF  E           K        DISK         KINFSR *PSSR
     FTRAUT   IF  E           K        DISK         KINFSR *PSSR
     FSECTY   IF  E           K        DISK         KINFSR *PSSR
     FSECGT   IF  E           K        DISK         KINFSR *PSSR
     FACNUM   IF  E           K        DISK         KINFSR *PSSR
     FINVTP   IF  E           K        DISK         KINFSR *PSSR
     FTRADS   IF  E           K        DISK         KINFSR *PSSR          CSE006
     FSECRTNL1IF  E           K        DISK         KINFSR *PSSR          CSE006
     FMGOREFL0UF  E           K        DISK         KINFSR *PSSR
     F            MGOREFD0                          KRENAMEOREFL0
     FMGOMSGLAIF  E           K        DISK         KINFSR *PSSR
     F            MGOMSGD0                          KRENAMEOMSGLA
     FTRADSDY1UF  E           K        DISK
     F            TRADSDD1                          KRENAMEUPDIDX
     FMGF51NPDO   E                    DISK         KINFSR *PSSR
     F                                              KCOMIT
     FMGOREFPDO   E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
     FMGOMSGPDO   E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
     FSE1875AUO   E                    PRINTER      KINFDS SPOOLU
     F                                              KINFSR *PSSR
     F/COPY WNCPYSRC,SE1875F001
      /TITLE FUNCTION OF INCICATORS
      *****************************************************************
      *                                                               *
      *  F U N C T I O N   O F   I N D I C A T O R S                  *
      *                                                               *
      *    20  - Control of call to MG9505                            *
      *    21  - Control of call to MG5900                            *
      *    22  - Control of call to MG5910                            *
      *    23  - Control of call to ZM0060                            *
      *                                                               *
      *    30  - Control of write to PF/MGOMSGPD                      *
      *    31  - Control of write to PF/MGOREFPD                      *
      *    32  - Control of write to PF/MGF51NPD                      *
      *                                                               *
      *    50  - Control of chain to TRADSDJ2                         *
      *    51  - Control of chain to TRAUT                            *
      *    52  - Control of chain to TRADSDY1                         *
      *    53  - Control of chain to TRADSDY2                         *
      *    54  - Control of chain to MGOMSGLA                         *
      *    55  - Control of chain to ACNUM                            *
      *    56  - Control of chain to SECTY                            *
      *    58  - Chain to TRADS                                       *   CSE006
      *    59  - READE ON SECRTNL1                                    *   CSE006
      *                                                               *
      *                                                               *
      *    98  - Date Format: DDMMYY (off); MMDDYY (on)               *
      *  90-99 - Used by Standard Subroutines                         *
      *                                                               *
      *  U7+U8 - Database Error                                       *
      *                                                               *
      *****************************************************************
      /TITLE SUBROUTINE INDEX
      *****************************************************************
      *                                                               *
      *  S U B R O U T I N E   I N D E X                              *
      *                                                               *
      *  SRINIT - Initial Processing                                  *
      *  SRPROC - Detail Processing                                   *
      *  SRAMSF - Access Master Files                                 *
      *  SRCMSG - Delete or Cancel Previous Messages                  *
      *  SRTRAN - Rerieve and update last SWIFT sequence              *
      *  SROMSG - Output cancellation record to MGOMSGPD              *
      *  SROREF - Output cancellation record to MGOREFPD              *
      *  SRSECG - Access LF/SECGT details (Swift Id)                  *
      *  SRPIF  - Sets up Repurchase Information                      *   CSE006
      *                                                               *
      *  DAYSAC - Calculate the Number of Days of Accrued Interest    *
      *  CONVT  - Converts an amount from one currency to another     *
      *  ZLCD   - Determines Last Coupon Date                         *
      *  ZNCD   - Determines Next Coupon Date                         *
      *  AUDIT  - Run Control Process                                 *
      *                                                               *
      *  *PSSR  - Program error handling routine                      *
      *                                                               *
      *****************************************************************
     E/TITLE E-SPECIFICATIONS
      *                                                                   155959
      ** Message types not generated                                      155959
      *                                                                   155959
     E                    NGN        15  3                                155959
      *
     E                    CPY@    1   1 80
      *
      ** Array containing Copyright statement
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZDAYSZ1
     E/COPY ZSRSRC,ZPOWERZ1
     E/COPY ZSRSRC,ZPOWER8Z1
     E/COPY ZSRSRC,ZNCDZ1
      *                                                                   CSW014
     E                    OA         13  1                                CSW014
     E                    @OA        13  1                                CSW014
      *                                                                   CSW014
      ** Array for Original Amount                                        CSW014
      /SPACE 3
     IOREFL0
      *** Rename LF/MGOREFL0 fields
     I              MTRN                            IMTRN
     I              TNTP                            ITNTP
     I              TRNO                            ITRNO
     I              MTPY                            IMTPY
     I              LSCC                            ILSCC
     IOMSGLA
      *** Rename LF/MGOMSGLA fields
     I              MTAG                            AMTAG
     I              MFLD                            AMFLD
     I              TRNO                            ATRNO
     I              MSEQ                            AMSEQ
      *
     ISDMGME    E DSSDMGMEPD                                              155314
      *                                                                   155314
      ** Branch Details                                                   155314
      *                                                                   155314
     ILDA       E DSLDA                         256
      *
      ** Local data area for database error details
      ** *LOCK IN LDA immediately before and OUT LDA immediately
      ** after each database error handling.
      **
      **                                    134 141 DBFILE
      **       Defines:                     142 170 DBKEY
      **                                    171 180 DBPGM
      **                                    181 1830DBASE
      *
     IRUNDAT    E DSRUNDAT
      *
      ** Data Area giving Installation Control Details
      *
     IPSDS       SDS
      *
      ** Program Status Data Structure
      *
     I                                     *PROGRAM PGM
     I                                      244 253 WSID
     I                                      254 263 USER
     ISPOOLU      DS
      ***  File Information Data Structure for SE1875AU.
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
      *
     IMULT        DS                        500
      *** Multiple occurrence data structure for message
     I                                        1   5 MTAG
     I                                        6  55 MFLD
     I                                       56  57 CTRC
     I                                       58  73 TRNO
     I                                       74  74 PTDL
     I                                       75  77 MSEQ
     I            DS
     I                                        1   2 CRLF
     I                                        1   1 WWCR
     I                                        2   2 WWLF
      *
     I            DS
      *** Data Structure
     I**********                              1  12 WWOURA                                    CGL029
     I                                        1  18 WWOURA                                    CGL029
     I                                        1   6 WO0106
     I**********                              7  12 WO0712                                    CGL029
     I                                        7  18 WO0712                                    CGL029
     I                                        1  100WO0110
      *
     I**********                              1  12 PAYT12                                    CGL029
     I                                        1  18 PAYT12                                    CGL029
     I                                        1   6 WWPY16
     I**********                              7  12 WWPY12                                    CGL029
     I                                        7  18 WWPY12                                    CGL029
     I                                        1  100WWPY10
      *
     I            DS
      *** Data Structure for 'Pay To' (PAYT) field
     I                                        1  10 PAYT10
     I**********                              1   60WPAY16                                    CSD027
     I                                        1   6 WPAY16                                    CSD027
     IKYMGDS      DS
      *** Data Structure for LF/MGOREFL0
     I                                        1  16 WMGKEY
     I                                        1   3 WM0103
     I                                        4   9 WM0409
     I                                       10  16 WM1016
     IKY5900      DS
      *** DS use to set up PTRAN (parm passed to MG5900)
     I                                        1  15 PTRAN
     I                                        1   6 TDRF
     I I            '       '                 7  13 P713
     I I            'TR'                     14  15 P1415
     I            DS
      *** DS use to set up TRNO field
     I                                        1  16 WTRNO
     I                                        1   3 WTR13
     I                                        4   9 WTR49
     I                                       10  16 WTR16
     I            DS
      *** DS use to extract MGDSS1, MGRSS1, MGAWIL, & MGBOF1
     I                                        1  35 WDRAB
     I                                        1   1 WP0101
     I                                        1   2 WP0102
     I                                        1   3 WP0103                                  AR589197
     I                                        3   4 WP0304
     I                                        2  35 WP0235
     I                                        3  35 WP0335
     I                                        4  35 WP0435                                  AR580937
     I                                        5  35 WP0535
     I            DS
      *** DS used to extract T1EUCL field
     I                                        1  10 T1EUCL
     I                                        1   4 EU0104
     I                                        2  10 EU0210
     I                                        5  10 EU0510
     I            DS
      *** DS used to extract T1SAFA field
     I                                        1   6 T1SAFA
     I                                        1   1 SA0101                                    246866
     I                                        2   6 SA0206
     I            DS
      *** DS used to format Midas Full Account Number
     I**********                              1  18 MFACNO                                    CGL029
     I                                        1  24 MFACNO                                    CGL029
     I                                        1   3 WBRCA
     I                                        4   9 WCNUM
     I                                       10  12 WCYCD
     I**********                             13  18 WACOD                                     CGL029
     I                                       13  24 WACOD                                     CGL029
      *
     I/COPY ZSRSRC,ZNCDZ2
      *
     IDSFDY     E DSDSFDY
      ** First Data Structure for Access Objects
      *
     IDSSDY     E DSDSSDY
      ** Second Data Structure for Access Objects
      *
     ISDBANK    E DSSDBANKPD
      ** Bank Details
      *
     ISDBRCH    E DSSDBRCHPD
      ** Branch Details
      *
     ISDCURR    E DSSDCURRPD
      ** Currency Details
      *
     ISDSTRD    E DSSDSTRDPD
      ** Securities Trading ICD Details
      *
     ISDGELR    E DSSDGELRPD
      ** General Ledger Details
      *
     ISDSECS    E DSSDSECSPD
      ** Securities Trading Clients
     I              QQACCD                          QQACCX                                    CGL029
      *
     ISDNOST    E DSSDNOSTPD
      ** Nostro Details
     I              QQACCD                          QQACCY                                    CGL029
      *
     ISDCCSY    E DSSDCCSYPD
      ** Currency Clearing Details
      *
     ISDCUST    E DSSDCUSTPD
     I              QQDFAC                          QQDFAX                                    CGL029
      *                                                                   140439
     ISDRETL    E DSSDRETLPD                                              140439
     I              QQACCD                          QQACCZ                                    CGL029
      *                                                                   CSE006
     ISDBOOK    E DSSDBOOKPD                                              CSE006
     I** Book details                                                     CSE006
      *
      ** Customer Details
     ITRADS2    E DSTRADSDY2
      *
      ** Customer Details
      *                                                                                       CSW210
     IACCNT     E DSACCNTAB                                                                   CSW210
      ** Midas GL Accounts master detail                                                      CSW210
      *                                                                                       CSW210
     I              'ABCDEFGHIJKLMNOPQRST-C         ALPHA                                   AR549800
     I              'UVWXYZ'                                                                AR549800
     I              '0123456789'          C         NMBRS                                   AR549800
      *****************************************************************
     C/TITLE Main Processing
      *
      *****************************************************************
      *  P R O G R A M     S T A R T                                  *
      *****************************************************************
      *
      *** Perform Initialisation.
     C                     EXSR SRINIT
      *
      ***  Perform Detail Processing.
     C                     EXSR SRPROC
      *
      *****************************************************************
      *  P R O G R A M     E N D                                      *
      *****************************************************************
      *                                                               *
     C/COPY WNCPYSRC,SE1875C001
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
      *****************************************************************
      /TITLE SR/SRINIT
      *****************************************************************
      *                                                               *
      *  SRINIT - Subroutine to do program initialisation.            *
      *                                                               *
      *  Called By: Main Processing                                   *
      *  Calls    :                                                   *
      *                                                               *
      *****************************************************************
      *
     C           SRINIT    BEGSR
      *
      *** Receive entry parameter: blank sequence number.
     C           *ENTRY    PLIST
     C                     PARM           PSEQ    5
      *
      *** Copyright Statement
     C                     MOVEACPY@      MKI    80
      *
      *** Define Local Data Area
     C           *NAMVAR   DEFN           LDA
      *
      *** KLIST for TRADSDY2 (Trade Reference and To/From Indicator)
     C           KTRDY2    KLIST
     C                     KFLD           TDRF
     C                     KFLD           T1WHEN
      *
      *** KLIST for SECGT (Nominal Ccy and Charge/Commission Code)
     C           KSECGT    KLIST
     C                     KFLD           TNMC
     C                     KFLD           WCOM    2
      *
      *** KLIST for INVTP (Nominal Ccy and Security Investment Type)
     C           KINVTP    KLIST
     C                     KFLD           TNMC
     C                     KFLD           SITP
      *
      *** Access Bank Details.
     C                     CALL 'AOBANKR0'
     C                     PARM '*MSG   ' WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD001       DBASE            ***************
     C                     MOVEL'SDBANKPD'DBFILE           * DB ERROR 01 *
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Check System Date Format, DDMMYY (*IN98 off)
      ***                           MMDDYY (*IN98 on).
     C           BJDFIN    IFEQ 'M'
     C                     SETON                     98
     C                     END
      *
      *** Access GL ICD details
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*MSG   ' WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C********** SDGELR    PARM SDGELR    DSFDY                                               CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD002       DBASE            ***************
     C                     MOVEL'SDGELRPD'DBFILE           * DB ERROR 02 *
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *
      *** Access Securities Trading ICD details
     C                     CALL 'AOSTRDR0'
     C                     PARM '*MSG   ' WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C           SDSTRD    PARM SDSTRD    DSSDY
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD003       DBASE            ***************
     C                     MOVEL'SDSTRDPD'DBFILE           * DB ERROR 03 *
     C                     MOVE *BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END
      *                                                                   140439
      * Access Retail ICD Record                                          140439
     C                     CALL 'AORETLR0'                                140439
     C                     PARM '*DBERR ' @RTCD   7                       140439
     C                     PARM '*FIRST ' @OPTN   7                       140439
     C           SDRETL    PARM SDRETL    DSFDY                           140439
      *                                                                   140439
     C           WRTCD     IFNE *BLANKS                                   140439
     C           *LOCK     IN   LDA                                       140439
     C                     Z-ADD031       DBASE            ***************140439
     C                     MOVEL'SDRETLPD'DBFILE           * DB ERROR 31 *140439
     C                     MOVE *BLANKS   DBKEY            ***************140439
     C                     OUT  LDA                                       140439
     C                     EXSR *PSSR                                     140439
     C                     END                                            140439
      *
      *** Check if (CSW003) MT5XX - Phase 2 Message Generation is On.
      *
     C                     CALL 'AOSARDR0'
     C                     PARM '*BLANKS' WRTCD
     C                     PARM '*VERIFY' WOPTN
     C                     PARM 'CSW003'  @SARD   6
      *
     C           WRTCD     IFNE *BLANKS
     C           WRTCD     ANDNE'*NRF   '
     C           *LOCK     IN   LDA
     C                     Z-ADD004       DBASE            ***************
     C                     MOVEL'SDSARDPD'DBFILE           * DB ERROR 04 *
     C                     MOVEL@SARD     DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           WRTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CSW003  1
     C                     ENDIF
      *
      *** Check if SAR CEU005 is present
      *
     C                     CALL 'AOSARDR0'
     C                     PARM '*BLANKS' WRTCD
     C                     PARM '*VERIFY' WOPTN
     C                     PARM 'CEU005'  @SARD   6
      *
     C           WRTCD     IFNE *BLANKS
     C           WRTCD     ANDNE'*NRF   '
     C           *LOCK     IN   LDA
     C                     Z-ADD028       DBASE            ***************
     C                     MOVEL'SDSARDPD'DBFILE           * DB ERROR 28 *
     C                     MOVEL@SARD     DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           WRTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CEU005  1
     C                     ENDIF
      *                                                                   CSW014
      *** Check if SAR CSW014 is present                                  CSW014
      *                                                                   CSW014
     C                     CALL 'AOSARDR0'                                CSW014
     C                     PARM '*BLANKS' WRTCD                           CSW014
     C                     PARM '*VERIFY' WOPTN                           CSW014
     C                     PARM 'CSW014'  @SARD                           CSW014
      *                                                                   CSW014
     C           WRTCD     IFNE *BLANKS                                   CSW014
     C           WRTCD     ANDNE'*NRF   '                                 CSW014
     C           *LOCK     IN   LDA                                       CSW014
     C                     Z-ADD030       DBASE            ***************CSW014
     C                     MOVEL'SDSARDPD'DBFILE           * DB ERROR 30 *CSW014
     C                     MOVEL@SARD     DBKEY            ***************CSW014
     C                     OUT  LDA                                       CSW014
     C                     EXSR *PSSR                                     CSW014
     C                     ENDIF                                          CSW014
      *                                                                   CSW014
     C           WRTCD     IFEQ *BLANKS                                   CSW014
     C                     MOVE 'Y'       CSW014  1                       CSW014
     C                     ENDIF                                          CSW014
     C/COPY WNCPYSRC,SE1875C002
      *                                                                   155314
      **  Access SDMGMEPD for message management data                     155314
      *                                                                   155314
     C                     CALL 'AOMGMER0'                                155314
     C                     PARM '*MSG   ' WRTCD                           155314
     C                     PARM '*FIRST ' WOPTN                           155314
     C           SDMGME    PARM SDMGME    DSFDY                           155314
      *                                                                   155314
     C           WRTCD     IFNE *BLANKS                                   155314
     C           *LOCK     IN   LDA                                       155314
     C                     Z-ADD102       DBASE            ***************155314
     C                     MOVEL'SDMGMEPD'DBFILE           *DB ERROR 102 *155314
     C                     MOVEL*BLANKS   DBKEY            ***************155314
     C                     OUT  LDA                                       155314
     C                     EXSR *PSSR                                     155314
     C                     ENDIF                                          155314
      *                                                                   CSE006
      *** Check if SAR CSE006 is present                                  CSE006
      *                                                                   CSE006
     C                     CALL 'AOSARDR0'                                CSE006
     C                     PARM '*BLANKS' WRTCD                           CSE006
     C                     PARM '*VERIFY' WOPTN                           CSE006
     C                     PARM 'CSE006'  @SARD                           CSE006
      *                                                                   CSE006
     C           WRTCD     IFNE *BLANKS                                   CSE006
     C           WRTCD     ANDNE'*NRF   '                                 CSE006
     C           *LOCK     IN   LDA                                       CSE006
     C                     Z-ADD032       DBASE            ***************CSE006
     C                     MOVEL'SDSARDPD'DBFILE           * DB ERROR 32 *CSE006
     C                     MOVEL@SARD     DBKEY            ***************CSE006
     C                     OUT  LDA                                       CSE006
     C                     EXSR *PSSR                                     CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C           WRTCD     IFEQ *BLANKS                                   CSE006
     C                     MOVE 'Y'       CSE006  1                       CSE006
     C                     ELSE                                           CSE006
     C                     MOVE 'N'       CSE006                          CSE006
     C                     ENDIF                                          CSE006
      *
      *** Initialise Record Count (PRTF/SE1875AU field) to zero
     C                     Z-ADD*ZERO     RCOUNT
      *
      ** Set CRLF control character
     C                     MOVE *LOVAL    CRLF
     C                     BITON'457'     WWCR
     C                     BITON'257'     WWLF
      *
      ** Check if SWIFT Changes 2010 (CSW210) is installed.                                   CSW210
      *                                                                                       CSW210
     C                     CALL 'SWIF2010'                                                    CSW210
     C                     PARM *BLANKS   WRTCD                                               CSW210
      *                                                                                       CSW210
     C           WRTCD     IFEQ 'CSW2010'                                                     CSW210
     C                     MOVE 'Y'       CSW210  1                                           CSW210
     C                     ELSE                                                               CSW210
     C                     MOVE 'N'       CSW210                                              CSW210
     C                     ENDIF                                                              CSW210
      *                                                                                       CSW210
      ** Access Switchable SAR details for the existence of CFT004                            CSW210
      *                                                                                       CSW210
     C                     CALL 'AOSARDR0'                                                    CSW210
     C                     PARM *BLANKS   WRTCD                                               CSW210
     C                     PARM '*VERIFY' WOPTN                                               CSW210
     C                     PARM 'CFT004'  @SARD                                               CSW210
     C           WRTCD     IFNE *BLANKS                                                       CSW210
     C           WRTCD     ANDNE'*NRF   '                                                     CSW210
     C           *LOCK     IN   LDA                                                           CSW210
     C                     Z-ADD040       DBASE                                               CSW210
     C                     MOVEL'AOSARDR0'DBFILE                                              CSW210
     C                     MOVE '*CALL   'DBKEY                                               CSW210
     C                     OUT  LDA                                                           CSW210
     C                     EXSR *PSSR                                                         CSW210
     C                     ENDIF                                                              CSW210
     C           WRTCD     IFEQ *BLANKS                                                       CSW210
     C                     MOVE 'Y'       CFT004  1                                           CSW210
     C                     ELSE                                                               CSW210
     C                     MOVE 'N'       CFT004                                              CSW210
     C                     ENDIF                                                              CSW210
      *                                                                                       CSW210
     C                     ENDSR
      *****************************************************************
      /TITLE SR/SRPROC
      *****************************************************************
      *                                                               *
      *  SRPROC - Subroutine to do the Detail Processing.             *
      *                                                               *
      *  Called By: Main Processing                                   *
      *  Calls: SRAMSF, SRCMSG, SRF5IN                                *
      *                                                               *
      *****************************************************************
      *
     C           SRPROC    BEGSR
      *
      ***  Read the Trades/Extension Join File. Note that the Logical
      ***  is choosing the following Trades:
      ***     Complete, Authorised, Clearance Type Not= 0, Trade
      ***     Confirmation required and Confirmation Message requested.
      *
     C                     READ TRADSDJ2                 50
     C                     MOVE CHTP      @CHG    1                                           CSW025
      *
      *** Process all Trades requiring S.W.I.F.T Confirmation Messages
     C           *IN50     DOWEQ'0'
      *
      *** Count the record read.
     C                     ADD  1         RCOUNT
     C                     MOVEL'A'       MGCHG                                               CSW025
      *
      *** Set WEXTCT TO 'N'. This field will be used to determine
      *** wether the record has been extracted to MGF51NPD.
     C                     MOVE 'N'       WEXTCT  1
      *
      *** Save Record Id and Last Change Type from Trades File.
     C                     MOVE CHTP      WTCHTP  1
     C                     MOVE RECI      WTRECI  1
      *
      *** If the Last Change to the Trade is Authorisation, Access the
      *** Trade Authorisation Audit record prior to the Authorisation
      *** to see if the Trade has been Cancelled.
     C           WTCHTP    IFEQ 'Y'
     C           TDRF      SETGTTRAUTDF
     C                     READPTRAUTDF                  51
     C                     READPTRAUTDF                  51
     C           TATYP     IFEQ 'DL'
     C           WTRECI    ANDEQ'C'
     C                     MOVE 'D'       WTCHTP
     C                     ENDIF
     C                     ENDIF
     C                     SELEC                                                              229270
     C           TATYP     WHEQ 'AM'                                                          229270
     C                     MOVE 'A'       @CHG                                                229270
     C           TATYP     WHEQ 'IN'                                                          229270
     C                     MOVE 'I'       @CHG                                                229270
     C                     ENDSL                                                              229270
      *
      *** Initialise PF/MGF51NPD fields to blanks/zeroes
     C                     CLEARMGF51ND0
      *
      *** Access Master Files
     C                     EXSR SRAMSF
      *
      *** Delete or Cancel previous messages
     C                     EXSR SRCMSG
      *
      *** If the Last Change was not a Deletion, then continue to
      *** process MT51n Message.
      *
     C           WTCHTP    IFNE 'D'
      *
      *** Set up and output PF/MGF51NPD fields
     C                     EXSR SRF5IN
      *                                                                   166684
      ** If a record was extracted to PF/MGF51NPD, check the value of     166684
      ** TRADSDX1/T1CONG.                                                 166684
      *                                                                   166684
     C           WEXTCT    IFEQ 'Y'                                       166684
     C                     CALL 'MG5910'               22                 166684
     C                     PARM 'SE'      PMODI   2                       166684
     C                     PARM           PTRAN  15                       166684
     C                     PARM 'CE'      PPROG   2                       166684
     C                     PARM *BLANKS   PMODE   1                       166684
     C                     PARM *BLANKS   PCONG   1                       166684
     C                     PARM *BLANKS   PRCDG   1                       166684
     C                     PARM *BLANKS   PERCD   1                       166684
     C                     PARM           CSW003                          166684
      *                                                                   166684
      ** If program not found, perform DB Error processing                166684
      *                                                                   166684
     C           *IN22     IFEQ '1'                                       166684
     C           *LOCK     IN   LDA                                       166684
     C                     Z-ADD115       DBASE            ***************166684
     C                     MOVE *BLANKS   DBKEY            *DB ERROR 115 *166684
     C                     MOVEL'SE1875'  DBPGM            ***************166684
     C                     OUT  LDA                                       166684
     C                     EXSR *PSSR                                     166684
     C                     ENDIF                                          166684
      *                                                                   166684
      ** If an error occured in MG5910, perform DB Error processing       166684
      *                                                                   166684
     C           PERCD     IFEQ 'Y'                                       166684
     C           *LOCK     IN   LDA                                       166684
     C                     Z-ADD116       DBASE            ***************166684
     C                     MOVE *BLANKS   DBKEY            *DB ERROR 116 *166684
     C                     MOVELPTRAN     DBKEY            ***************166684
     C                     MOVEL'SE1875'  DBPGM                           166684
     C                     OUT  LDA                                       166684
     C                     EXSR *PSSR                                     166684
     C                     ENDIF                                          166684
      *                                                                   166684
      ** Force TRADSDX1/T1CONG (PCONG) to 'N' if it is still 'Y' to       166684
      ** prevent database error at 007 in program MG051N.                 166684
      *                                                                   166684
     C           PCONG     IFEQ 'Y'                                       166684
      *                                                                   166684
     C                     CALL 'MG5910'               22                 166684
     C                     PARM 'SE'      PMODI   2                       166684
     C                     PARM           PTRAN  15                       166684
     C                     PARM 'CE'      PPROG   2                       166684
     C                     PARM 'C'       PMODE   1                       166684
     C                     PARM *BLANKS   PCONG   1                       166684
     C                     PARM *BLANKS   PRCDG   1                       166684
     C                     PARM *BLANKS   PERCD   1                       166684
     C                     PARM           CSW003  1                       166684
      *                                                                   166684
      *** If MG5910 is not found                                          166684
      *                                                                   166684
     C           *IN22     IFEQ '1'                                       166684
     C           *LOCK     IN   LDA                                       166684
     C                     Z-ADD117       DBASE            ***************166684
     C                     MOVE *BLANKS   DBKEY            *DB ERROR 117 *166684
     C                     MOVEL'SE1875'  DBPGM            ***************166684
     C                     OUT  LDA                                       166684
     C                     EXSR *PSSR                                     166684
     C                     ENDIF                                          166684
      *                                                                   166684
      *** If MG5910 ended abnormally                                      166684
      *                                                                   166684
     C           PERCD     IFEQ 'Y'                                       166684
     C           *LOCK     IN   LDA                                       166684
     C                     Z-ADD118       DBASE            ***************166684
     C                     MOVE *BLANKS   DBKEY            *DB ERROR 118 *166684
     C                     MOVELPTRAN     DBKEY            ***************166684
     C                     MOVEL'SE1875'  DBPGM                           166684
     C                     OUT  LDA                                       166684
     C                     EXSR *PSSR                                     166684
     C                     ENDIF                                          166684
      *                                                                   166684
     C                     ENDIF                                          166684
     C                     ENDIF                                          166684
      *                                                                   166684
     C                     ENDIF
      *
      *** If the record has not been extracted then reset T1GMEC to 'N'
     C           WEXTCT    IFEQ 'N'
     C                     COMIT                                          155314
     C           TDRF      CHAINUPDIDX               52
     C           *IN52     IFEQ *OFF
     C                     MOVE 'N'       T1GMEC
     C                     UPDATUPDIDX
     C                     ENDIF
     C                     ENDIF
      *                                                                   140428
     C                     COMIT                                          140428
      *
      ***  Read the next record from the Trade/Extension Join File.
      *
     C                     READ TRADSDJ2                 50
     C                     MOVE CHTP      @CHG    1                                           CSW025
      *
      ***  End of Do While Not End of File.
     C                     ENDDO
      *
      *** Produce Audit Report
     C                     EXSR AUDIT
      *
     C                     ENDSR
      *
      *****************************************************************
      /TITLE SR/SRAMSF
      *****************************************************************
      *                                                               *
      *  SRAMSF - Access Master Files                                 *
      *                                                               *
      *  Called By: SRPROC                                            *
      *                                                               *
      *  Calls    :                                                   *
      *                                                               *
      *****************************************************************
      *
     C           SRAMSF    BEGSR
      *
      *** Access Branch Internal Customer Number (A8BICN)
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM TDBA      WBRCH   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
      *** Handle Database Error
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD005       DBASE            ***************
     C                     MOVEL'SDBRCHPD'DBFILE           * DB ERROR 05 *
     C                     MOVELWBRCH     DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Save Branch Internal Customer
     C**********           MOVE A8BICN    WWBICN  60                                          CSD027
     C                     MOVE A8BICN    WWBICN  6                                           CSD027
     C                     MOVELWWBICN    WKEY   10
      *
      *** Access Branch Internal Customer Details (BBCSSN)
     C                     CALL 'AOCUSTR0'
     C                     PARM *BLANKS   WRTCD   7
     C                     PARM '*KEY   ' WOPTN   7
     C                     PARM           WKEY   10
     C                     PARM *BLANKS   WKYST   7
     C           SDCUST    PARM SDCUST    DSSDY
      *
      *** Handle Database Error
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD029       DBASE            ***************
     C                     MOVEL'SDCUSTPD'DBFILE           * DB ERROR 29 *
     C                     MOVELWWBICN    DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Save Counterparty Customer Number as a character field
     C                     MOVE TCNR      WWCUST  6
      *
      *** Access LF/SDSECSPD using key Counterparty Customer Number
     C                     CALL 'AOSECSR0'
     C                     PARM *BLANKS   WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM           WWCUST
     C           SDSECS    PARM SDSECS    DSFDY
      *
      *** Handle Database error
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD006       DBASE            ***************
     C                     MOVEL'SDSECSPD'DBFILE           * DB ERROR 06 *
     C                     MOVELWWCUST    DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Access LF/SDCURRPD using key nominal currency
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM TNMC      WCUCY   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      *** Handle Database error
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD007       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 07 *
     C                     MOVELTNMC      DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Save number of decimal places
     C                     MOVE A6NBDP    WWDPI   10
      *
      *** Access LF/SDCURRPD using key settlement currency
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM SETC      WCUCY   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      *** Handle Database error
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD008       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 08 *
     C                     MOVELSETC      DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Save the number of decimal places
     C                     MOVE A6NBDP    WWDPO   10
      *
      *** Clear workfields
     C                     CLEARPAYT10
     C                     CLEARWWOA35
     C                     MOVE 'N'       WWIBFL                                            AR549800
      *
      *** If Trade Purchase (TDTP='TP') and settling
      *** through Nostro, CHIPS or SWIFT, then, Move
      *** "Pay To" field to PAYT10 workfield. PAYT10
      *** will be used is SR/SRF5IN.
     C           TDTP      IFEQ 'TP'
      *
     C           SMTH      IFEQ 01
     C           SMTH      OREQ 02
     C           SMTH      OREQ 07
     C           SMTH      OREQ 08
     C           SMTH      OREQ 12
     C                     MOVELPAYT      PAYT10
     C                     ENDIF
      *
     C                     ENDIF
      *
     C           TDTP      IFEQ 'TP'
     C                     MOVELPYFM      PAYT12
     C                     MOVELPYFA      W@BRCA  3
     C                     ELSE
     C                     MOVELPAYT      PAYT12
     C                     MOVELPYTA      W@BRCA
     C                     ENDIF
      *
      *** If settling through Nostro, CHIPS or SWIFT
     C           SMTH      IFEQ 01
     C           SMTH      OREQ 02
     C           SMTH      OREQ 07
     C           SMTH      OREQ 08
     C           SMTH      OREQ 12
      *
      *** Extract the Nostro Number from Pay From/To field
     C                     MOVELPAYT12    WWFLD2  2
      *
      *** Access LF/SDNOSTL0 using key Settlement Ccy (SETC)
      *** and the extracted Nostro Number (WWFLD2)
     C                     CALL 'AONOSTR0'
     C                     PARM *BLANKS   WRTCD   7
     C                     PARM '*KEY   ' WOPTN   7
     C                     PARM *BLANKS   PWCUST  6
     C                     PARM SETC      PWCYCD  3
     C**********           PARM *BLANKS   PWACCD  4                                           CGL029
     C                     PARM *BLANKS   PWACCD 10                                           CGL029
     C                     PARM *BLANKS   PWACSN  2
     C                     PARM WWFLD2    PWNONB  2
     C                     PARM *BLANKS   PWBRCD  3
     C                     PARM *BLANKS   PWCSSN 10
     C                     PARM *BLANKS   PWPNOI  1
     C           SDNOST    PARM SDNOST    DSFDY
      *
      *** Handle Database error
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD009       DBASE            ***************
     C                     MOVEL'SDNOSTPD'DBFILE           * DB ERROR 09 *
     C                     MOVELSETC      DBKEY5  5        ***************
     C                     MOVE WWFLD2    DBKEY5
     C                     MOVELDBKEY5    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C***********A7OANN    IFNE *BLANKS                                                       210796
     C           A7OACN    IFNE *BLANKS                                                       210796
      *
      ****Our*Account*Number*at*Nostro*(14A)*                                                 210796
     C***********          MOVELA7OANN    WWOA35 35                                           210796
      *** Our Account Number at Nostro (35A)                                                  210796
     C                     MOVELA7OACN    WWOA35 35                                           210796
     C           CSW210    IFEQ 'Y'                                                         AR549800
     C           CFT004    ANDEQ'Y'                                                         AR549800
     C                     EXSR SRVIBA                                                      AR549800
     C                     ENDIF                                                            AR549800
     C                     ELSE
      *
      *** Nostro Shortname (10A)
     C                     MOVELA7NOSN    WWOA35
     C                     ENDIF
      *
     C                     ENDIF
      *
      *** If Settlement Method is:
      ***    Counterpaty's Prime Current or Retail Account ("04") or
      ***    Any Account ("05") or
      ***    Designated Security Trading ("15"),
      *** then, Move Midas Full Account Number to workfield
     C***********SMTH      IFEQ 04                                        140439
     C***********SMTH      OREQ 05                                        140439
     C           SMTH      IFEQ 05                                        140439
     C           SMTH      OREQ 15
     C                     MOVE W@BRCA    WBRCA
     C                     MOVE WWPY16    WCNUM
     C                     MOVE SETC      WCYCD
     C                     MOVE WWPY12    WACOD
     C                     MOVELMFACNO    WWOA35
     C                     EXSR SRIBAN                                                        CSW210
     C                     ENDIF
     C*
     C           SMTH      IFEQ 04                                        140439
     C                     MOVE W@BRCA    WBRCA                           140439
     C                     MOVE TCNR      WCNUM                           140439
     C                     MOVE SETC      WCYCD                           140439
     C                     MOVELBMACCD    WACOD                           140439
     C                     MOVE '01'      WACOD                           140439
     C                     MOVELMFACNO    WWOA35                          140439
     C                     EXSR SRIBAN                                                        CSW210
     C                     ENDIF                                          140439
      *
      *** If Settlement Method is
      ***    Unknown ("00") or
      ***    Compensation with another trade ("03") or
      ***    Suspense Account,
      *** Save Branch Internal Customer Shortname
     C           SMTH      IFEQ 00
     C           SMTH      OREQ 03
     C           SMTH      OREQ 06
     C                     MOVELBBCSSN    PAYT10
     C                     ENDIF
      *
      *** If settling through any Current Retail Account ("14"),
      *** then, access account master file
     C           SMTH      IFEQ 14
      *
      *** Access LF/ACNUM using the first 10 Chars of PAYT12
     C           WWPY10    CHAINACNUM                55
      *
      *** Handle Database Error
     C           *IN55     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD010       DBASE            ***************
     C                     MOVEL'ACNUM'   DBFILE           * DB ERROR 10 *
     C                     MOVELWWPY10    DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     MOVE BRCA      WBRCA
     C                     MOVE CNUM      WCNUM
     C                     MOVE CCY       WCYCD
     C                     MOVELACOD      WACOD
     C                     MOVE ACSQ      WACOD
     C                     MOVELMFACNO    WWOA35
     C                     EXSR SRIBAN                                                        CSW210
      *
     C                     ENDIF
      *
      *** Access PF/TRADSDY2 using key of Trade Reference (TDRF) and
      *** To/From Indicator (T1WHEN)
     C           KTRDY2    CHAINTRADSDY2             53
      *
     C           *IN53     IFEQ '0'
      *
      *** Set flag to indicate Extended Settlement record
      *** present for this trade
     C                     MOVE 'Y'       WWEXSS  1
     C                     ELSE
     C                     CLEARTRADS2
     C                     MOVE 'N'       WWEXSS
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /TITLE SR/SRCMSG
      *****************************************************************
      *                                                               *
      *  SRCMSG - Delete or Cancel previous messages.                 *
      *                                                               *
      *  Called By: Main Processing                                   *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SRCMSG    BEGSR
      *
      *** Set Record-Found workfield to 'N'
     C                     MOVE 'N'       WRFND   1
      *
      *** Set up key field
     C                     MOVE 'SET'     WM0103
     C                     MOVE TDRF      WM0409
     C                     MOVE *HIVAL    WM1016
      *
      *** Set file pointer to the last generated msg for the trans
      *
     C                     MOVE 'Y'       WNREC   1                       166684
     C           WMGKEY    SETGTMGOREFL0
     C                     READPMGOREFL0            N    51
      *                                                                   166684
      ** Messages were not found in MGOREFPD,                             166684
      ** TRADSDX1/T1CONG must be reset to 'N'                             166684
      *                                                                   166684
     C           *IN51     IFEQ '1'                                       166684
     C                     MOVE 'N'       WNREC   1                       166684
     C                     ENDIF                                          166684
      *
     C           *IN51     DOWEQ*OFF
     C           ITNTP     ANDEQ'TR'
     C           IMTRN     ANDEQTDRF
     C           WRFND     ANDNE'Y'
      *
      *** Save the Transaction Reference Number for later CHAIN/UPDATE
     C                     MOVE ITRNO     W@TRNO 16
      *
     C           IMTPY     IFEQ '515'
     C           IMTPY     OREQ '518'
      *
     C           MGST      IFEQ 'CRTD'
     C           MGST      OREQ 'AMND'
     C           ILSCC     ANDNE'CANCEL  '
      *
      *** Update PF/MGOREFPD record with MGST='DLTD' and MGSG='4'
     C                     CALL 'MG9505'               20
     C                     PARM ITRNO     WTNUM  16
     C                     PARM *BLANKS   WRTNC   1
      *
      ** If MG9505 is not found
     C           *IN20     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD011       DBASE            ***************
     C                     MOVE *BLANKS   DBKEY            * DB ERROR 11 *
     C                     MOVEL'MG9505'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** If MG9505 ended abnormally
     C           WRTNC     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     Z-ADD012       DBASE            ***************
     C                     MOVE *BLANKS   DBKEY            * DB ERROR 12 *
     C                     MOVELWTNUM     DBKEY            ***************
     C                     MOVEL'MG9505'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Set Record-Found workfield to 'Y'
     C                     MOVE 'Y'       WRFND
      *
     C                     ENDIF
      *
      *** If message is already sent or logically acknowledge
     C           MGSG      IFEQ '2'
     C           MGSG      OREQ '3'
      *
     C           CARQ      IFNE 'Y'
     C           ILSCC     ANDNE'CANCEL  '
      *
      *** Retrieve and update last SWIFT Sequence for transaction
     C                     EXSR SRTRAN
      *
      *** Output cancellation record to PF/MGOMSGPD
     C                     EXSR SROMSG
      *
      *** Output cancellation record to PF/MGOREFPD
     C                     EXSR SROREF
      *
      *** Set record-found-workfield to 'Y'
     C                     MOVE 'Y'       WRFND
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      *** If previous message is the old counterpart (MT510/MT512),
      *** set record-found-workfield to 'Y' too so that the
      *** Confirmation Generated indictor is reset properly.
      *
     C           IMTPY     IFEQ '510'
     C           IMTPY     OREQ '512'
      *
     C           MGST      IFEQ 'CRTD'
     C           MGST      OREQ 'AMND'
     C           ILSCC     ANDNE'CANCEL  '
     C                     MOVE 'Y'       WRFND
     C                     ENDIF
      *
      *** If message is already sent or logically acknowledge
     C           MGSG      IFEQ '2'
     C           MGSG      OREQ '3'
     C           CARQ      IFNE 'Y'
     C           ILSCC     ANDNE'CANCEL  '
     C                     MOVE 'Y'       WRFND
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      *** If record was cancelled successfully
     C           WRFND     IFEQ 'Y'
      *
      *** Update TRADSDX1/T1CONG  to 'N'
     C                     CALL 'MG5910'               22
     C                     PARM 'SE'      PMODI   2
     C                     PARM           PTRAN  15
     C                     PARM 'CE'      PPROG   2
     C                     PARM 'C'       PMODE   1
     C                     PARM *BLANKS   PCONG   1
     C                     PARM *BLANKS   PRCDG   1
     C                     PARM *BLANKS   PERCD   1
     C                     PARM           CSW003  1
      *
      *** If MG5910 is not found
     C           *IN22     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD013       DBASE            ***************
     C                     MOVE *BLANKS   DBKEY            * DB ERROR 13 *
     C                     MOVEL'MG5910'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** If MG5900 ended abnormally
     C           PERCD     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     Z-ADD014       DBASE            ***************
     C                     MOVE *BLANKS   DBKEY            * DB ERROR 14 *
     C                     MOVELPTRAN     DBKEY            ***************
     C                     MOVEL'MG5910'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      ****************************************************************    140428
      ****Comit*record*changes*to*prevent*record**********************    140428
      ****locking*error*during*TRADSDY1*update************************    140428
     C***********          COMIT                                          140428
      *
     C                     ENDIF
      *
      *** Read previous record
     C                     READPMGOREFL0            N    51
      *
     C                     ENDDO
      *                                                                   155314
      ** Calculate the retention date.( HRDT= TDVD+ENDSMM)                155314
      ** If the retention date is lower than rundat, that mean that       155314
      ** previous message may have been dropped.                          155314
      ** In that case call MG5910 to reset T1CONG flag to "N".            155314
     C                     Z-ADD0         CHKDT   50                      155314
     C           TDVD      ADD  ENDSMN    CHKDT                           155314
     C           WRFND     IFEQ 'N'                                       155314
     C           CHKDT     ANDLTBJRDNB                                    155314
      *                                                                   166684
      ** For some unknown reasons (possibly a corrupt database),          166684
      ** messages were not found in MGOREFPD                              166684
      *                                                                   166684
     C           WRFND     OREQ 'N'                                       166684
     C           WNREC     ANDEQ'N'                                       166684
      *                                                                   155314
      *** Update TRADSDX1/T1CONG  to 'N'                                  155314
     C                     CALL 'MG5910'               22                 155314
     C                     PARM 'SE'      PMODI   2                       155314
     C                     PARM           PTRAN  15                       155314
     C                     PARM 'CE'      PPROG   2                       155314
     C                     PARM 'C'       PMODE   1                       155314
     C                     PARM *BLANKS   PCONG   1                       155314
     C                     PARM *BLANKS   PRCDG   1                       155314
     C                     PARM *BLANKS   PERCD   1                       155314
     C                     PARM           CSW003  1                       155314
      *                                                                   155314
      *** If MG5910 is not found                                          155314
     C           *IN22     IFEQ '1'                                       155314
     C           *LOCK     IN   LDA                                       155314
     C                     Z-ADD113       DBASE            ***************155314
     C                     MOVE *BLANKS   DBKEY            * DB ERROR113 *155314
     C                     MOVEL'MG5910'  DBPGM            ***************155314
     C                     OUT  LDA                                       155314
     C                     EXSR *PSSR                                     155314
     C                     ENDIF                                          155314
      *                                                                   155314
      *** If MG5900 ended abnormally                                      155314
     C           PERCD     IFEQ 'Y'                                       155314
     C           *LOCK     IN   LDA                                       155314
     C                     Z-ADD114       DBASE            ***************155314
     C                     MOVE *BLANKS   DBKEY            * DB ERROR114 *155314
     C                     MOVELPTRAN     DBKEY            ***************155314
     C                     MOVEL'MG5910'  DBPGM                           155314
     C                     OUT  LDA                                       155314
     C                     EXSR *PSSR                                     155314
     C                     ENDIF                                          155314
     C                     ENDIF                                          155314
      *
     C                     MOVEL'D'       MGCHG                                               CSW025
      *
     C                     ENDSR
      *
      *****************************************************************
      /TITLE SR/SRTRAN
      *****************************************************************
      *                                                               *
      *  SRTRAN - Retrieve and Update Last SWIFT Sequence Number      *
      *                                                               *
      *  Called By: SRCMSG                                            *
      *  Calls: MG5900                                                *
      *                                                               *
      *****************************************************************
      *
     C           SRTRAN    BEGSR
      *
     C                     CALL 'MG5900'               21
     C                     PARM 'SE'      PMODI   2
     C                     PARM           PTRAN  15
     C                     PARM           PPROG   2
     C                     PARM 'U'       PMODE   1
     C                     PARM *ZEROS    PLSWS   70
     C                     PARM *BLANKS   PERCD   1
     C                     PARM           CSW003  1
      *
      *** If MG5900 is not found
     C           *IN21     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD015       DBASE            ***************
     C                     MOVE *BLANKS   DBKEY            * DB ERROR 15 *
     C                     MOVEL'MG5900'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** If MG5900 ended abnormally
     C           PERCD     IFEQ 'Y'
     C           *LOCK     IN   LDA
     C                     Z-ADD016       DBASE            ***************
     C                     MOVE *BLANKS   DBKEY            * DB ERROR 16 *
     C                     MOVELPTRAN     DBKEY            ***************
     C                     MOVEL'MG5900'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** If MG5900 returns successfully
     C           PLSWS     IFEQ 9999999
     C                     Z-ADD1         WLSWS   70
     C                     ELSE
     C           PLSWS     ADD  1         WLSWS
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /TITLE SR/SROMSG
      *****************************************************************
      *                                                               *
      *  SROMSG - Output cancellation message to PF/MGOMSGPD          *
      *                                                               *
      *  Called By: SRCMSG                                            *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SROMSG    BEGSR
      *
      *** Clear multiple occurrence data structure
     C                     Z-ADD1         X       20
     C           X         OCUR MULT
      *
     C           X         DOWLE500
     C           MFLD      ANDNE*BLANKS
     C                     MOVE *BLANKS   MULT
     C                     ADD  1         X
     C           X         OCUR MULT
     C                     ENDDO
      *
      *** Reset X to zero
     C                     Z-ADD*ZEROS    X
      *
     C           ITRNO     CHAINMGOMSGLA             54
      *
      *** Process all records in MGOMSGLA with the same
      *** Transaction Reference Number
     C           *IN54     DOWEQ*OFF
     C           ITRNO     ANDEQATRNO
      *
     C           AMTAG     IFEQ ':16R:'
      *
     C           AMFLD     IFEQ 'GENL'
     C                     MOVE 'GENL'    WBLOCK  4
     C                     ELSE
     C           AMFLD     IFEQ 'LINK'
     C                     MOVE 'LINK'    WBLOCK
     C                     ELSE
     C                     MOVE *BLANKS   WBLOCK
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      *** Set up TRNO field
     C                     MOVEL'SET'     WTR13
     C                     MOVELTDRF      WTR49
     C                     MOVELWLSWS     WTR16
     C                     MOVELWTRNO     TRNO
      *
      *** Access the xth element of MULT
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     MOVELAMTAG     MTAG
     C                     MOVELAMFLD     MFLD
     C                     MOVELWTRNO     TRNO
     C                     MOVELCRLF      CTRC
     C                     MOVELAMSEQ     MSEQ
      *
     C           AMTAG     IFEQ ':20C:'
     C           WBLOCK    ANDEQ'GENL'
     C                     MOVE *BLANKS   MFLD
     C           ':SEME//' CAT  WTRNO:0   MFLD
     C                     ENDIF
      *
     C           AMTAG     IFEQ ':23G:'
     C                     MOVE *BLANKS   MFLD
     C                     MOVEL'CANC'    MFLD
     C                     ENDIF
      *
     C           IMTPY     IFEQ '515'
     C           AMTAG     IFEQ ':20C:'
     C           WBLOCK    ANDEQ'LINK'
     C                     MOVE *BLANKS   MFLD
     C           ':PREV//' CAT  ITRNO:0   MFLD
     C                     ENDIF
     C                     ENDIF
      *
      *** Output subsequence A1 for MT518
     C           IMTPY     IFEQ '518'
     C           AMTAG     ANDEQ':22F:'
     C           WBLOCK    ANDEQ'GENL'
      *
      *** Access the xth element of MULT
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     MOVEL':16R:'   MTAG
     C                     MOVEL'LINK'    MFLD
     C                     MOVELWTRNO     TRNO
     C                     MOVELCRLF      CTRC
     C                     MOVEL'A1'      MSEQ
      *
      *** Access the xth element of MULT
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     MOVEL':20C:'   MTAG
     C           ':PREV//' CAT  ITRNO:0   MFLD
     C                     MOVELWTRNO     TRNO
     C                     MOVELCRLF      CTRC
     C                     MOVEL'A1'      MSEQ
      *
      *** Access the xth element of MULT
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     MOVEL':16S:'   MTAG
     C                     MOVEL'LINK'    MFLD
     C                     MOVELWTRNO     TRNO
     C                     MOVELCRLF      CTRC
     C                     MOVEL'A1'      MSEQ
      *
     C                     ENDIF
      *
      *** Read the next record on LF/MGOMSGLA
     C                     READ MGOMSGLA                 54
      *
     C                     ENDDO
      *
      **  Write multiple occurrence data structure to PF/MGOMSGPD
     C                     Z-ADD1         X       20
     C           X         OCUR MULT
      *
     C           X         DOWLE500
     C           MFLD      ANDNE*BLANKS
      *
     C                     WRITEMGOMSGD0               30
      *
      **  Error on write to PF/MGOMSGPD
     C           *IN30     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD017       DBASE            * * * * * * * *
     C                     MOVE *BLANKS   DBKEY            *  DBERR 17   *
     C                     MOVEL'MGOMSGPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ADD  1         X
     C           X         OCUR MULT
      *
     C                     ENDDO
      *
     C                     ENDSR
      *****************************************************************
      /TITLE SR/SROREF
      *****************************************************************
      *                                                               *
      *  SROREF - Output cancellation record to PF/MGOREFPD           *
      *                                                               *
      *  Called By: SRCMSG                                            *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SROREF    BEGSR
      *
      *** Update LF/MGOREFL0
     C           W@TRNO    CHAINOREFL0               51
     C           *IN51     IFEQ *OFF
      *
     C                     MOVEL'Y'       CARQ
     C                     MOVELBJMRDT    LADT
     C                     TIME           LATM
      *
      *** Update LF/MGOREFL0
     C                     UPDATOREFL0
      *
     C                     ENDIF
      *
      *** Set up MGOREFPD/TRNO field
     C                     MOVEL'SET'     WTR13
     C                     MOVELTDRF      WTR49
     C                     MOVELWLSWS     WTR16
     C                     MOVELWTRNO     TRNO
      *
     C                     MOVELBJMRDT    LADT
      *
      **  Convert run date to YYMMDD, for Message Generation Date
     C                     CALL 'ZM0060'               23
     C                     PARM BJRDNB    ZMDAY   50
     C                     PARM           ZSDAT   6
      *
      ** Program ended in error.
     C           *IN23     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD018       DBASE              * * * * * * *
     C                     MOVEL'       ' DBKEY              * DBERR 018 *
     C                     MOVEL'ZM0060'  DBFILE             * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     MOVE ZSDAT     MGDE
     C                     TIME           LATM
     C                     MOVEL'1'       MGSG
     C                     MOVEL'CRTD'    MGST
     C                     MOVE *BLANK    CARQ
     C                     MOVEL'CANCEL  'LSCC
      *
      *** Move fields from LF/MGOREFL0
     C                     MOVELIMTRN     MTRN
     C                     MOVELITNTP     TNTP
     C                     MOVELIMTPY     MTPY
     C           WTCHTP    IFNE 'Y'                                                           229270
     C                     MOVE WTCHTP    AORR                                                229270
     C                     ELSE                                                               229270
     C                     MOVE @CHG      AORR                                                229270
     C                     ENDIF                                                              229270
     C/COPY WNCPYSRC,SE1875C003
      *
      *** Write record PF/MGOREFPD
     C                     WRITEMGOREFD0               31
      *
      **  Error on write to PF/MGOREFPD
     C           *IN31     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD019       DBASE            * * * * * * * *
     C                     MOVE *BLANKS   DBKEY            *  DBERR 019  *
     C                     MOVEL'MGOREFPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /TITLE SR/SRVALD                                                    155959
      *****************************************************************   155959
      *                                                               *   155959
      *  SRVALD - Determine if message type is to be generated for    *   155959
      *           the destination customer.                           *   155959
      *                                                               *   155959
      *  Called By: SRPROC                                            *   155959
      *                                                               *   155959
      *  Calls: None                                                  *   155959
      *                                                               *   155959
      *****************************************************************   155959
      *                                                                   155959
     C           SRVALD    BEGSR                                          155959
      *                                                                   155959
      **  Set up wildcard for message group (eg 5**)                      155959
      **  Field IMTPY is from MGOREFPD; The correct one is field MGMTYP   169150
      *                                                                   155959
     C                     MOVELMGMTYP    @WLD                            169150
     C                     MOVE '**'      @WLD    3                       155959
      *                                                                   155959
      **  and for message category (eg 51*)                               155959
      *                                                                   155959
     C                     MOVELMGMTYP    @WLDR                           169150
     C                     MOVE '*'       @WLDR   3                       155959
      *                                                                   155959
      **  Access Customer details using counterparty customer             155959
      *                                                                   155959
     C                     MOVE *BLANKS   WKEY                            155959
     C                     MOVELTCNR      WKEY                            155959
     C                     CALL 'AOCUSTR0'                                155959
     C                     PARM '*MSG   ' WRTCD                           155959
     C                     PARM '*KEY   ' WOPTN                           155959
     C                     PARM           WKEY                            155959
     C                     PARM *BLANKS   WKYST                           155959
     C           SDCUST    PARM SDCUST    DSSDY                           155959
      *                                                                   155959
     C           WRTCD     IFNE *BLANKS                                   155959
     C           *LOCK     IN   LDA                                       155959
     C                     Z-ADD032       DBASE            ***************155959
     C                     MOVEL'SDCUSTPD'DBFILE           * DB ERROR 32 *155959
     C                     MOVELTCNR      DBKEY            ***************155959
     C                     OUT  LDA                                       155959
     C                     EXSR *PSSR                                     155959
     C                     END                                            155959
      *                                                                   155959
      **  Load array NGN with all message types that are not              155959
      **  to be generated for this customer                               155959
      *                                                                   155959
     C                     MOVE BBNG01    NGN,1                           155959
     C                     MOVE BBNG02    NGN,2                           155959
     C                     MOVE BBNG03    NGN,3                           155959
     C                     MOVE BBNG04    NGN,4                           155959
     C                     MOVE BBNG05    NGN,5                           155959
     C                     MOVE BBNG06    NGN,6                           155959
     C                     MOVE BBNG07    NGN,7                           155959
     C                     MOVE BBNG08    NGN,8                           155959
     C                     MOVE BBNG09    NGN,9                           155959
     C                     MOVE BBNG10    NGN,10                          155959
     C                     MOVE BBNG11    NGN,11                          155959
     C                     MOVE BBNG12    NGN,12                          155959
     C                     MOVE BBNG13    NGN,13                          155959
     C                     MOVE BBNG14    NGN,14                          155959
     C                     MOVE BBNG15    NGN,15                          155959
      *                                                                   155959
      **  Determine if message type is not to be generated for the        155959
      **  destination customer, using both message and wildcard to        155959
      **  check against array entries                                     155959
      *                                                                   155959
     C           MGMTYP    LOKUPNGN                      25               155959
     C           @WLD      LOKUPNGN                      26               155959
     C           @WLDR     LOKUPNGN                      27               155959
      *                                                                   155959
     C                     ENDSR                                          155959
      *                                                                   155959
      *****************************************************************   155959
      /TITLE SR/SRF5IN
      *****************************************************************
      *                                                               *
      *  SRF5IN - Output PF/MGF51NPD record                           *
      *                                                               *
      *  Called By: Main Processing                                   *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SRF5IN    BEGSR
      *
      *** Message Type
     C           T1CCID    IFEQ 'C'
     C                     MOVEL'515'     MGMTYP
     C                     ELSE
     C                     MOVEL'518'     MGMTYP
     C                     ENDIF
      *                                                                   169150
      ** Determine if message type is to be generated for customer        169150
      *                                                                   169150
     C                     EXSR SRVALD                                    169150
      *                                                                   169150
      ** Message type for this customer/counterparty is to be generated   169150
      *                                                                   169150
     C           *IN25     IFEQ '0'                                       169150
     C           *IN26     ANDEQ'0'                                       169150
     C           *IN27     ANDEQ'0'                                       169150
      *
      *** Destination Customer
     C                     MOVELTCNR      MGDEST
      *
      *** Transaction Reference Number
     C                     MOVELTDRF      MGTNUM
      *
      *** Module Id
     C                     MOVEL'SE'      MGMODI
      *
      *** Transaction Type
     C                     MOVEL'TR'      MGTTYP
      *
      *** Transaction Sub-Type
     C                     MOVELTDTP      MGTSTP
      *
      *** Branch Code of Sender
     C                     MOVELTDBA      MGSNBR
      *
      *** Settlement Type
     C                     MOVELSMTH      MGSETP
      *
      *** Value Date
     C                     MOVELTDVD      MGVDAT
      *
      *** Trade Date
     C                     MOVELTDDT      MGTDAT
      *
      *** Trade Time (HH:MM:SS) where SS is always '00'
     C           T1TRTT    IFNE *BLANKS
     C                     MOVELT1TRTT    MGTRTT
     C                     MOVE '00'      MGTRTT
     C                     ENDIF
      *
      *** Market Price
     C                     Z-ADDTPDY      MGPRIC
      *
      ** Access LF/SECTYDX1 using Security Shortname as key
     C           TDSS      CHAINSECTY                56
     C           *IN56     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD020       DBASE            ***************
     C                     MOVEL'SECTY   'DBFILE           * DB ERROR 20 *
     C                     MOVELTDSS      DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Trade Basis
     C                     MOVELSTBS      MGSTBS
      *
      *** Price Basis
     C                     MOVELSPBS      MGSPBS
      *
      ** Access LF/INVTP using TRADSDJ2/TNMC and SECTYD/SITP
     C           KINVTP    CHAININVTP                57
     C           *IN57     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD026       DBASE            ***************
     C                     MOVEL'INVTP   'DBFILE           * DB ERROR 26 *
     C                     MOVELTNMC      DBKEY5           ***************
     C                     MOVE SITP      DBKEY5
     C                     MOVELDBKEY5    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Cum/Ex Indicator
     C           PROT      IFEQ '4'
     C           PROT      OREQ '7'
     C                     MOVELEXDV      MGEXIN
     C                     ELSE
     C           PROT      IFEQ '1'
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '6'
     C           PROT      OREQ '8'
     C                     MOVELACIN      MGEXIN
     C                     ENDIF
     C                     ENDIF
      *
      ***  Number of Days of Accrued Interest. If Security is not
      ***  Interest-Bearing, (implied by Initial Date = 0 or Coupon
      ***  Rate = 0), or if the Interest Amount is zero or if the Trade
      ***  is Flat of Interest, then set the Number of Days to zero.
      *
     C           ITLD      IFEQ 0
     C           CPNR      OREQ 0
     C           ITRA      OREQ 0
     C           ACIN      OREQ 'F'
     C                     Z-ADD0         MGACND
     C                     ELSE
     C                     EXSR DAYSAC
     C           DADJ      IFNE 0
     C                     Z-ADDDADJ      MGACND
     C                     ELSE
     C                     Z-ADDZDDAYS    MGACND
     C                     ENDIF
     C                     ENDIF
      *
      *** Interest Amount
     C                     Z-ADDITRA      MGITRA
      *
      *** Settlement Currecny
     C                     MOVELSETC      MGSTCY
      *
      *** Settlement Amount
     C                     Z-ADDTCTR      WWSTAM 150
      *
      *** Convert Settlement Amount from Nominal to Settlement Ccy
     C                     Z-ADDWWSTAM    WWAMTI
     C                     Z-ADDTDER      WWEXCH
     C                     MOVELTMDI      WWZMD
     C                     EXSR CONVT
     C                     Z-ADDWWAMTO    MGSTAM
      *
      **  Settlement amount in alternate currency
      *
     C           TNMC      IFNE SETC
     C                     Z-ADDTCTR      MGRESU
     C                     ENDIF
      *
      *** Pay Code
     C           PCOD      IFEQ '1'
     C           T1GDEL    ANDEQ'G'
     C                     MOVEL'5'       MGPCOD
     C                     ELSE
     C                     MOVELPCOD      MGPCOD
     C                     ENDIF
      *
      *** Investor
     C                     MOVELT2INVE    MGINVE
      *
      *** Euroclear/Cedel Code
     C                     MOVELT1EUCL    MGEUCL
      *
      *** Safekeeping Ac Line
     C           WWEXSS    IFEQ 'Y'
      *
     C           TDTP      IFEQ 'TP'                                                          246420
     C                     MOVELT2SA1L    WSA1L1  1
     C                     MOVELT2SA1L    WSA1L3  3
     C                     MOVELT2SA1L    WSA1L  35                                           246420
     C                     ELSE                                                               246420
     C                     MOVELT2SKAL    WSA1L1                                              246420
     C                     MOVELT2SKAL    WSA1L3                                              246420
     C                     MOVELT2SKAL    WSA1L                                               246420
     C                     ENDIF                                                              246420
     C                     MOVE *BLANKS   W@SA1L 35
      *
     C           WSA1L3    IFEQ '/C/'
     C           WSA1L3    OREQ '/D/'
     C           32        SUBSTT2SA1L:4  W@SA1L
     C                     MOVELW@SA1L    MGSA1L
     C                     ELSE
     C           WSA1L1    IFEQ '/'
     C           34        SUBSTT2SA1L:2  W@SA1L
     C                     MOVELW@SA1L    MGSA1L
      *                                                                                       239053
     C                     ELSE                                                               239053
     C**********           MOVELT2SA1L    MGSA1L                                       239053 246420
     C                     MOVELWSA1L     MGSA1L                                              246420
      *                                                                                       239053
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
     C                     MOVE *BLANKS   MGSA1L
     C                     ENDIF
      *
      *** Account for Payment
     C           T2AWIN    IFEQ *BLANKS
     C           T2AWIL    ANDEQ*BLANKS
      *
     C           WWEXSS    IFEQ 'Y'
     C           T2AP1L    ANDNE*BLANKS
      *
     C                     MOVELT2AP1L    WAP1L1  1
     C                     MOVELT2AP1L    WAP1L3  3
     C                     MOVE *BLANKS   W@AP1L 35
      *                                                                                     AR549800
     C                     MOVELT2FAP1    MGFAP1                                            AR549800
      *
     C           WAP1L3    IFEQ '/C/'
     C           WAP1L3    OREQ '/D/'
     C           32        SUBSTT2AP1L:4  W@AP1L
     C                     MOVELW@AP1L    MGAP1L
     C                     ELSE
     C           WAP1L1    IFEQ '/'
     C           34        SUBSTT2AP1L:2  W@AP1L
     C                     MOVELW@AP1L    MGAP1L
     C                     ELSE                                                             AR467409
     C                     MOVELT2AP1L    MGAP1L                                            AR467409
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
      *
     C           TDTP      IFEQ 'TP'
      *
     C           SMTH      IFEQ 01
     C           SMTH      OREQ 02
     C           SMTH      OREQ 07
     C           SMTH      OREQ 08
     C           SMTH      OREQ 12
     C           WPAY16    OREQ TCNR
     C                     MOVELWWOA35    MGAP1L
     C                     MOVELWWIBFL    MGFAP1                                            AR549800
     C                     ENDIF
     C                     ENDIF
      *
     C           TDTP      IFEQ 'TS'
     C                     MOVELWWOA35    MGAP1L
     C                     MOVELWWIBFL    MGFAP1                                            AR549800
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      *** Processing Type
     C                     MOVELPROT      MGPROT
      *
      *** Quantity of Securities
     C                     Z-ADDNOML      MGQANT
      *
      ** ISIN Code Of Security
     C                     MOVELISIN      MGISIN
      *
      *
      ** Format Security Full Name
      *
      *** Check if Security Full Name-1 is not blank
     C           SFN1      IFNE *BLANKS
     C                     MOVELSFN1      MGSFN1
     C                     MOVELSFN2      MGSFN2
     C                     ELSE
     C                     MOVELSESN      MGSFN1
     C                     MOVELSRPN      MGSFN2
     C                     ENDIF
      *
      *** Day Basis
     C                     MOVELDYBS      MGDYBS
      *
      *** Divisor Basis
     C                     MOVELDVBS      MGDVBS
      *
      *** Payment Frequency
     C           CPNR      IFGT *ZERO
      *
     C                     Z-ADD1         XX      20
     C                     Z-ADD0         YY      20
     C           XX        DOWLE12
      *
     C           CD,XX     IFNE *ZERO
     C                     ADD  1         YY
     C                     ENDIF
      *
     C                     ADD  1         XX
     C                     ENDDO
      *
     C                     SELEC
     C           YY        WHEQ 12
     C                     MOVEL'MNTH'    MGPFRE
     C           YY        WHEQ 4
     C                     MOVEL'QUTR'    MGPFRE
     C           YY        WHEQ 2
     C                     MOVEL'SEMI'    MGPFRE
     C           YY        WHEQ 1
     C                     MOVEL'ANNU'    MGPFRE
     C                     OTHER
     C                     MOVEL*BLANK    MGPFRE
     C                     ENDSL
      *
     C                     ENDIF
      *
      *** Partly Paid
     C                     MOVELPPDI      MGPRTP
      *
      *** Nominal Currency
     C                     MOVELNMCY      MGNMCY
      *
      *** Next Coupon Date. If Security is not Interest-Bearing,
      *** (implied by Initial Date = 0 or Coupon Rate = 0), then set
      *** the Next Coupon Date to zero.
      *
     C           ITLD      IFEQ 0
     C           CPNR      OREQ 0
     C                     Z-ADD0         MGNCDT
     C                     ELSE
      *
      *** Want Next Coupon AFTER Value Date, so add 1.
     C                     Z-ADD*ZERO     ECD     50
     C           TDVD      ADD  1         ECD
     C                     EXSR ZNCD
     C                     Z-ADDNCD       MGNCDT
     C                     ENDIF
      *
      *** Next Rate Change Date
     C                     EXSR SRNRDT
      *
      *** Maturity Date
     C                     Z-ADDMATY      MGMDAT
      *
      *** Currency Factor
     C                     Z-ADDCFCT      MGCUFC
      *
      *** Coupon Rate
     C                     Z-ADDCPNR      MGCPNR
      *
      ** Find whether DELF is a Cedel depot
      ** for Trade Type = TS only                                         140437
     C           TDTP      IFEQ 'TS'                                      140437
     C                     MOVE DELF      WWCUST
      *
     C                     CALL 'AOSECSR0'
     C                     PARM *BLANKS   WRTCD   7
     C                     PARM '*KEY   ' WOPTN   7
     C                     PARM           WWCUST  6
     C           SDSECS    PARM SDSECS    DSSDY
      *
     C           WRTCD     IFNE *BLANKS
     C                     Z-ADD027       DBASE            ***************
     C                     MOVEL'SDSECSPD'DBFILE           * DB ERROR 27 *
     C                     MOVELWWCUST    DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF                                          140437
      *
      ** Format Certificate Numbers Required Indicator - only Yes if
      ** Trade sale, non-Fungible, Fungible Trade Code 1 or 2
      ** (ie. 'from' non-fungible with Certificate Numbers given)
      ** and Deliver is from Cedel.
      *
     C           TDTP      IFEQ 'TS'
     C           T1FTID    ANDEQ'N'
     C           T1FCOD    ANDEQ'1'
     C           BFCLAS    ANDEQ'C'
      *
     C           TDTP      OREQ 'TS'
     C           T1FTID    ANDEQ'N'
     C           T1FCOD    ANDEQ'2'
     C           BFCLAS    ANDEQ'C'
      *
     C                     MOVEL'Y'       MGCRTN
     C                     ELSE
     C                     MOVEL'N'       MGCRTN
      *
     C                     ENDIF
      *
      *** Instruction Sub-type
     C                     MOVELT1INSS    MGINSS
      *
      *** Standing Instr Override
     C                     MOVELT1SIOR    MGSTAN
      *
      *** Deliverer of Securities & Deliverer of Securities-1
     C           T1CCID    IFEQ 'C'
      *
      *** Customer-Counterpary Ind (T1CCID) is 'C'
     C           WWEXSS    IFEQ 'Y'
     C           T2DSSN    ANDNE*BLANKS
     C           WWEXSS    OREQ 'Y'
     C           T2DSS1    ANDNE*BLANKS
      *
     C                     MOVELT2DSSN    MGDSSN
     C                     MOVELT2DSS1    MGDSS1
      *
     C                     MOVE *BLANKS   WDRAB
     C                     MOVELT2DSS1    WDRAB
     C********** WP0102    IFEQ '/C'                                                        AR580937
     C********** WP0102    OREQ '/D'                                                        AR580937
     C********** WP0102    IFEQ '/C/'                                              AR580937 AR589197
     C********** WP0102    OREQ '/D/'                                              AR580937 AR589197
     C           WP0103    IFEQ '/C/'                                                       AR589197
     C           WP0103    OREQ '/D/'                                                       AR589197
     C                     MOVE *BLANKS   MGDSS1
     C**********           MOVELWP0335    MGDSS1                                            AR580937
     C                     MOVELWP0435    MGDSS1                                            AR580937
     C                     ELSE
     C           WP0101    IFEQ '/'
     C                     MOVE *BLANKS   MGDSS1
     C                     MOVELWP0235    MGDSS1
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
      *
     C           TDTP      IFEQ 'TP'
      *
     C           DELF      IFNE WWBICN
     C********** DELF      ANDNE0                                                             CSD027
     C           DELF      ANDNE*BLANKS                                                       CSD027
     C                     MOVELDELF      MGDSSN
     C                     ENDIF
      *
     C           T2DSS1    IFEQ *BLANKS
     C           EU0104    IFEQ '//XC'
     C           EU0104    OREQ '//XE'
     C                     MOVELEU0510    MGDSS1
     C                     ELSE
     C                     MOVELEU0210    MGDSS1
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
     C           TDTP      IFEQ 'TS'
      *
     C           DELT      IFNE WWBICN
     C********** DELT      ANDNE0                                                             CSD027
     C           DELT      ANDNE*BLANKS                                                       CSD027
     C                     MOVELDELT      MGDSSN
     C                     ENDIF
      *
     C           T2DSS1    IFEQ *BLANKS
      *                                                                                       246866
     C           SA0101    IFEQ '/'                                                           246866
     C                     MOVELSA0206    MGDSS1
     C                     ELSE                                                               246866
     C                     MOVELT1SAFA    MGDSS1                                              246866
     C                     ENDIF                                                              246866
      *                                                                                       246866
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ELSE
      *
      *** Customer-Counterpary Ind (T1CCID) is 'P'
     C           WWEXSS    IFEQ 'Y'
     C           T2DSSN    ANDNE*BLANKS
     C           WWEXSS    OREQ 'Y'
     C           T2DSS1    ANDNE*BLANKS
      *
     C                     MOVELT2DSSN    MGDSSN
     C                     MOVELT2DSS1    MGDSS1
      *
     C                     MOVE *BLANKS   WDRAB
     C                     MOVELT2DSS1    WDRAB
     C********** WP0102    IFEQ '/C'                                                        AR580937
     C********** WP0102    OREQ '/D'                                                        AR580937
     C********** WP0102    IFEQ '/C/'                                              AR580937 AR589197
     C********** WP0102    OREQ '/D/'                                              AR580937 AR589197
     C           WP0103    IFEQ '/C/'                                                       AR589197
     C           WP0103    OREQ '/D/'                                                       AR589197
     C                     MOVE *BLANKS   MGDSS1
     C**********           MOVELWP0335    MGDSS1                                            AR580937
     C                     MOVELWP0435    MGDSS1                                            AR580937
     C                     ELSE
     C           WP0101    IFEQ '/'
     C                     MOVE *BLANKS   MGDSS1
     C                     MOVELWP0235    MGDSS1
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
      *
     C********** DELF      IFNE *ZEROS                                                        CSD027
     C           DELF      IFNE *BLANKS                                                       CSD027
     C                     MOVELDELF      MGDSSN
     C                     ELSE
     C           TDTP      IFEQ 'TP'
     C                     MOVELTCNR      MGDSSN
     C                     ENDIF
     C                     ENDIF
      *
     C           T2DSS1    IFEQ *BLANKS
     C           TDTP      IFEQ 'TP'
      *
     C           EU0104    IFEQ '//XC'
     C           EU0104    OREQ '//XE'
     C                     MOVELEU0510    MGDSS1
     C                     ELSE
     C                     MOVELEU0210    MGDSS1
     C                     ENDIF
      *
     C                     ELSE
      *                                                                                       246866
     C           SA0101    IFEQ '/'                                                           246866
     C                     MOVELSA0206    MGDSS1
     C                     ELSE                                                               246866
     C                     MOVELT1SAFA    MGDSS1                                              246866
     C                     ENDIF                                                              246866
      *                                                                                       246866
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      *** Receiver of Securities and Receiver of Secuties-1
      *
     C           WWEXSS    IFEQ 'Y'
     C           T2RSSN    ANDNE*BLANKS
     C           WWEXSS    OREQ 'Y'
     C           T2RSS1    ANDNE*BLANKS
      *
     C                     MOVELT2RSSN    MGRSSN
     C                     MOVELT2RSS1    MGRSS1
      *
     C                     MOVE *BLANKS   WDRAB
     C                     MOVELT2RSS1    WDRAB
     C********** WP0102    IFEQ '/C'                                                        AR580937
     C********** WP0102    OREQ '/D'                                                        AR580937
     C********** WP0102    IFEQ '/C/'                                              AR580937 AR589197
     C********** WP0102    OREQ '/D/'                                              AR580937 AR589197
     C           WP0103    IFEQ '/C/'                                                       AR589197
     C           WP0103    OREQ '/D/'                                                       AR589197
     C                     MOVE *BLANKS   MGRSS1
     C**********           MOVELWP0335    MGRSS1                                            AR580937
     C                     MOVELWP0435    MGRSS1                                            AR580937
     C                     ELSE
     C           WP0101    IFEQ '/'
     C                     MOVE *BLANKS   MGRSS1
     C                     MOVELWP0235    MGRSS1
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
      *
     C********** DELT      IFNE *ZEROS                                                        CSD027
     C           DELT      IFNE *BLANKS                                                       CSD027
     C                     MOVELDELT      MGRSSN
     C                     ELSE
     C           TDTP      IFEQ 'TS'
     C                     MOVELTCNR      MGRSSN
     C                     ENDIF
     C                     ENDIF
      *
     C           T2RSS1    IFEQ *BLANKS
      *
     C           TDTP      IFEQ 'TP'
      *                                                                                       246866
     C           SA0101    IFEQ '/'                                                           246866
     C                     MOVELSA0206    MGRSS1
     C                     ELSE                                                               246866
     C                     MOVELT1SAFA    MGRSS1                                              246866
     C                     ENDIF                                                              246866
      *                                                                                       246866
     C                     ELSE
     C           EU0104    IFEQ '//XC'
     C           EU0104    OREQ '//XE'
     C                     MOVELEU0510    MGRSS1
     C                     ELSE
     C                     MOVELEU0210    MGRSS1
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** Account with Institution & A/C Line
     C           WWEXSS    IFEQ 'Y'
     C           T2AWIN    ANDNE*BLANKS
     C           WWEXSS    OREQ 'Y'
     C           T2AWIL    ANDNE*BLANKS
      *
     C                     MOVELT2AWIN    MGAWIN
     C                     MOVELT2AWIL    MGAWIL
      *
     C                     MOVE *BLANKS   WDRAB
     C                     MOVELMGAWIL    WDRAB
      *                                                                                     AR549800
     C                     MOVELT2FAI1    MGFAI1                                            AR549800
      *
     C********** WP0102    IFEQ '/C'                                                        AR580937
     C********** WP0102    OREQ '/D'                                                        AR580937
      ****Extract*Position*3*-*35**************************************                     AR580937
      *** Extract Position 4 - 35                                                           AR580937
     C********** WP0102    IFEQ '/C/'                                              AR580937 AR589197
     C********** WP0102    OREQ '/D/'                                              AR580937 AR589197
     C           WP0103    IFEQ '/C/'                                                       AR589197
     C           WP0103    OREQ '/D/'                                                       AR589197
     C                     MOVE *BLANKS   MGAWIL
     C**********           MOVELWP0335    MGAWIL                                            AR580937
     C                     MOVELWP0435    MGAWIL                                            AR580937
     C                     ELSE
     C           WP0102    IFEQ '//'
      *** Extract Position 5 - 35
     C                     MOVE *BLANKS   MGAWIL
     C                     MOVELWP0535    MGAWIL
      *
      *** Account with Inst IC
     C                     CALL 'AOCCSYR0'
     C                     PARM *BLANKS   WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM NMCY      CYCD    3
     C                     PARM WP0304    CLSY    2
     C           SDCCSY    PARM SDCCSY    DSFDY
      *
      *** Handle Database Error
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD021       DBASE            ***************
     C                     MOVEL'SDCCSYPD'DBFILE           * DB ERROR 21 *
     C                     MOVELCYCD      DBKEY5           ***************
     C                     MOVE CLSY      DBKEY5
     C                     MOVELDBKEY5    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Move Issuer Code (DPISCD) to MGAWIC
     C                     MOVELDPISCD    MGAWIC
      *
     C                     ELSE
     C           WP0101    IFEQ '/'
      *** Extract Position 2 - 35
     C                     MOVE *BLANKS   MGAWIL
     C                     MOVELWP0235    MGAWIL
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
      *
     C           TDTP      IFEQ 'TP'
     C           WPAY16    ANDNETCNR
      *
     C           SMTH      IFEQ 01
     C           SMTH      OREQ 02
     C           SMTH      OREQ 07
     C           SMTH      OREQ 08
     C           SMTH      OREQ 12
     C                     MOVELPAYT10    MGAWIN
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      *
      *** Beneficiary of Money & A/C line
     C           MGAWIN    IFNE *BLANKS
     C           MGAWIL    ORNE *BLANKS
      *
     C           WWEXSS    IFEQ 'Y'
     C           T2BOFN    ANDNE*BLANKS
     C           WWEXSS    OREQ 'Y'
     C           T2BOF1    ANDNE*BLANKS
     C                     MOVELT2BOFN    MGBOFN
     C                     MOVELT2BOF1    MGBOF1
      *
     C                     MOVE *BLANKS   WDRAB
     C                     MOVELMGBOF1    WDRAB
      *                                                                                     AR549800
     C                     MOVELT2FBF1    MGFBF1                                            AR549800
      *
     C                     SELEC
     C********** WP0102    WHEQ '/C'                                                        AR580937
     C********** WP0102    OREQ '/D'                                                        AR580937
      ***Extract*position*3*-*35***************************************                     AR580937
     C********** WP0102    WHEQ '/C/'                                              AR580937 AR589197
     C********** WP0102    OREQ '/D/'                                              AR580937 AR589197
     C           WP0103    WHEQ '/C/'                                                       AR589197
     C           WP0103    OREQ '/D/'                                                       AR589197
      ** Extract position 4 - 35                                                            AR580937
     C                     MOVE *BLANKS   MGBOF1
     C**********           MOVELWP0335    MGBOF1                                            AR580937
     C                     MOVELWP0435    MGBOF1                                            AR580937
      *
     C           WP0102    WHEQ '//'
      ** Extract position 5 - 35
     C                     MOVE *BLANKS   MGBOF1
     C                     MOVELWP0535    MGBOF1
      *
      ** Ben of Money Issuer Code
     C                     CALL 'AOCCSYR0'
     C                     PARM *BLANKS   WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM NMCY      CYCD    3
     C                     PARM WP0304    CLSY    2
     C           SDCCSY    PARM SDCCSY    DSFDY
      *
      *** Handle Database Error
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD022       DBASE            ***************
     C                     MOVEL'SDCCSYPD'DBFILE           * DB ERROR 22 *
     C                     MOVELCYCD      DBKEY5           ***************
     C                     MOVE CLSY      DBKEY5
     C                     MOVELDBKEY5    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Move Issuer Code (DPISCD) to MGAWIC
     C                     MOVELDPISCD    MGBOFC
      *
     C           WP0101    WHEQ '/'
      *** Extract Position 2 - 35
     C                     MOVE *BLANKS   MGBOF1
     C                     MOVELWP0235    MGBOF1
      *
     C                     ENDSL
      *
     C                     ELSE
     C           TDFA      IFNE *BLANKS
     C                     MOVELTDFA      MGBOFN
     C                     ELSE
     C                     MOVELPAYT      MGBOFN
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      *** Deal Amount
     C                     Z-ADDTCSR      MGDLAM
      *
      *** Reallowance
     C                     Z-ADDRALL      ZPRC   169
     C                     Z-ADDNOML      ZNOML
     C                     Z-ADDTNMD      NMDP    10
     C                     Z-ADDWWDPI     ZCDP    10
     C                     EXSR ZCNSD
     C                     Z-ADDZCONS     MGISDI
      *
      *** Broker Commission ID
      *** (Get SWIFT Id from SECGT if TRADSD/Broker Comm Code is not blank)
     C           TBCC      IFNE *BLANKS
     C                     MOVELTBCC      WCOM
     C                     EXSR SRSECG
     C                     MOVELSWID      MGTBCI
     C                     ENDIF
      *
      *** Broker Commission Amount
     C                     Z-ADDTBCA      MGTBCA
      *
      *** Customer Com ID
     C           TCCA      IFNE *ZERO
     C                     MOVELTCCC      WCOM
     C                     EXSR SRSECG
     C                     MOVELSWID      MGTCCI
     C                     ENDIF
      *
      *** Customer Com Amount
     C                     Z-ADDTCCA      MGTCCA
      *
      *** Charge 1 ID
     C           TCA1      IFNE *ZERO
     C                     MOVELTCC1      WCOM
     C                     EXSR SRSECG
     C                     MOVELSWID      MGTCI1
     C                     ENDIF
      *
      *** Charge Amount 1
     C                     Z-ADDTCA1      MGTCA1
      *
      *** Charge 2 ID
     C           TCA2      IFNE *ZERO
     C                     MOVELTCC2      WCOM
     C                     EXSR SRSECG
     C                     MOVELSWID      MGTCI2
     C                     ENDIF
      *
      *** Charge Amount 2
     C                     Z-ADDTCA2      MGTCA2
      *
      *** Charge 3 ID
     C           TCA3      IFNE *ZERO
     C                     MOVELTCC3      WCOM
     C                     EXSR SRSECG
     C                     MOVELSWID      MGTCI3
     C                     ENDIF
      *
      *** Charge Amount 3
     C                     Z-ADDTCA3      MGTCA3
      *
      *** Charge 4 ID
     C           TCA4      IFNE *ZERO
     C                     MOVELTCC4      WCOM
     C                     EXSR SRSECG
     C                     MOVELSWID      MGTCI4
     C                     ENDIF
      *
      *** Charge Amount 4
     C                     Z-ADDTCA4      MGTCA4
      *
      *** Charge 5 ID
     C           TCA5      IFNE *ZERO
     C                     MOVELTCC5      WCOM
     C                     EXSR SRSECG
     C                     MOVELSWID      MGTCI5
     C                     ENDIF
      *
      *** Charge Amount 5
     C                     Z-ADDTCA5      MGTCA5
      *
      *** Charge 6 ID
     C           TCA6      IFNE *ZERO
     C                     MOVELTCC6      WCOM
     C                     EXSR SRSECG
     C                     MOVELSWID      MGTCI6
     C                     ENDIF
      *
      *** Charge Amount 6
     C                     Z-ADDTCA6      MGTCA6
      *
      *** Charge 7 ID
     C           TCA7      IFNE *ZERO
     C                     MOVELTCC7      WCOM
     C                     EXSR SRSECG
     C                     MOVELSWID      MGTCI7
     C                     ENDIF
      *
      *** Charge Amount 7
     C                     Z-ADDTCA7      MGTCA7
      *                                                                   CSE023
      ** Backup withholding Tax                                           CSE023
      *                                                                   CSE023
     C                     Z-ADDWHTX      MGWHTX                          CSE023
      *
      *** Tax ID
     C                     MOVELTCNR      WCUST   6
     C                     CALL 'AOSECSR0'
     C                     PARM *BLANKS   WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM           WCUST
     C           SDSECS    PARM SDSECS    DSFDY
      *
      *** Handle Database Error
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD023       DBASE            ***************
     C                     MOVEL'SDSECSPD'DBFILE           * DB ERROR 23 *
     C                     MOVELTCNR      DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Chain to SECGT using Tax Code (BFTCD)
      *** (Get SWIFT Id from SECGT if SDSECSPD/Tax Code is not blank)
     C           BFTCD     IFNE *BLANKS
     C                     MOVELBFTCD     WCOM
     C                     EXSR SRSECG
     C           TAXA      IFNE *ZERO
     C                     MOVELSWID      MGTAX1
     C                     ENDIF
     C                     ENDIF
      *
      *** Tax Amount
     C                     Z-ADDTAXA      MGTAXA
      *
      ** Original Currency and Amount
      *
     C           CEU005    IFEQ 'Y'
     C           ICCY      IFNE *BLANKS
     C           ICCY      IFEQ TNMC
      * Set up the original transaction amount as the countervalue in
      * nominal currency
     C                     Z-ADDTCTR      MGOTRA
      * Set up the original transaction currency as the nominal currency
     C                     MOVE TNMC      MGOTRC
     C                     ELSE
      * Set up the original transaction amount as the countervalue in
      * nominal currency converted to the 'In' currency in field 72
     C                     CALL 'EU0200'
     C                     PARM *BLANK    P@RTCD  7        Return Code
     C                     PARM TCTR      P@FRAM 183       FROM Ccy Amount
     C                     PARM TNMC      P@FRCY  3        FROM Currency
     C                     PARM ICCY      P@TOCY  3        TO Currency
     C                     PARM           P@OUTA 150       Outright Amount
     C                     PARM           P@INTA 183       Interim Amount
     C                     PARM           P@EXRT 159       Exchange Rate
     C                     PARM           P@MDIN  1        Mult/Div Ind.
     C                     MOVE P@OUTA    MGOTRA    P
      * Set up the original transaction currency as the 'In' currency
     C                     MOVE ICCY      MGOTRC
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *                                                                   CSW014
      *** If CSW014 is on AND Sender to Receiver (T2SRL1) OR              CSW014
      *** Special Instruction (TDSI) field was entered,                   CSW014
      *** then, extract Original Currency and Amount                      CSW014
     C           CSW014    IFEQ 'Y'                                       CSW014
     C           T2SRL1    ANDNE*BLANKS                                   CSW014
     C           CSW014    OREQ 'Y'                                       CSW014
     C           TDSI      ANDNE*BLANKS                                   CSW014
     C                     EXSR SROCMT                                    CSW014
     C                     ENDIF                                          CSW014
      *
      *** Exchange Rate
     C           TMDI      IFEQ 'M'
     C                     Z-ADDTDER      MGDAXR
     C                     ELSE
     C           TDER      IFEQ 0
     C                     CLEARMGDAXR
     C                     ELSE
     C           1         DIV  TDER      MGDAXR
     C                     ENDIF
     C                     ENDIF
      *
      *** Nominal Decimal Place
     C                     Z-ADDTNMD      MGNMDP
      *                                                                   CSE006
      *** If Repurchase Agreements feature is active and there exists     CSE006
      *** a LInk Ref for the trade then set up Repurchase info.           CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           LKRF      ANDNE*BLANKS                                   CSE006
     C                     EXSR SRPIF                                     CSE006
     C                     ENDIF                                          CSE006
      *                                                                                       CSW210
     C           CSW210    IFEQ 'Y'                                                           CSW210
     C                     MOVELT2DIDN    MGDIDN                                              CSW210
     C                     MOVELT2DAD1    MGDAD1                                              CSW210
     C                     MOVELT2DAD2    MGDAD2                                              CSW210
     C                     MOVELT2DAD3    MGDAD3                                              CSW210
     C                     MOVELT2DAD4    MGDAD4                                              CSW210
     C                     MOVELT2DLIN    MGDLIN                                              CSW210
      *                                                                                     AR581532
     C                     MOVE *BLANKS   WDRAB                                             AR581532
     C                     MOVELMGDLIN    WDRAB                                             AR581532
      *                                                                                     AR581532
     C                     SELEC                                                            AR581532
      *                                                                                     AR581532
     C********** WP0102    WHEQ '/C'                                               AR581532 AR580937
     C********** WP0102    OREQ '/D'                                               AR581532 AR580937
     C********** WP0102    WHEQ '/C/'                                              AR580937 AR589197
     C********** WP0102    OREQ '/D/'                                              AR580937 AR589197
     C           WP0103    WHEQ '/C/'                                                       AR589197
     C           WP0103    OREQ '/D/'                                                       AR589197
      *                                                                                     AR581532
      ***Extract*position*3*-*35***************************************            AR581532 AR580937
      ** Extract position 4 - 35                                                            AR580937
      *                                                                                     AR581532
     C                     MOVE *BLANKS   MGDLIN                                            AR581532
     C**********           MOVELWP0335    MGDLIN                                   AR581532 AR580937
     C                     MOVELWP0435    MGDLIN                                            AR580937
      *                                                                                     AR581532
     C           WP0102    WHEQ '//'                                                        AR581532
      *                                                                                     AR581532
      ** Extract position 5 - 35                                                            AR581532
      *                                                                                     AR581532
     C                     MOVE *BLANKS   MGDLIN                                            AR581532
     C                     MOVELWP0535    MGDLIN                                            AR581532
      *                                                                                     AR581532
     C           WP0101    WHEQ '/'                                                         AR581532
      *                                                                                     AR581532
      ** Extract Position 2 - 35                                                            AR581532
      *                                                                                     AR581532
     C                     MOVE *BLANKS   MGDLIN                                            AR581532
     C                     MOVELWP0235    MGDLIN                                            AR581532
      *                                                                                     AR581532
     C                     ENDSL                                                            AR581532
      *                                                                                     AR581532
     C                     MOVELT2FDBT    MGFDBT                                            AR549800
     C                     ENDIF                                                              CSW210
      *
      *** Write record to PF/MGF51NPD
     C                     MOVE @CHG      MGCHG                                               CSW025
     C                     WRITEMGF51ND0               32
      *
      **  Error on write to PF/MGF51NPD
     C           *IN32     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD024       DBASE            * * * * * * * *
     C                     MOVE *BLANKS   DBKEY            *  DBERR 024  *
     C                     MOVEL'MGF51NPD'DBFILE           * * * * * * * *
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      *** Set Record Extract workfield (WEXTCT) to 'Y'
     C                     MOVEL'Y'       WEXTCT
      *                                                                   169150
      ** (ENDIF) for message type to be generated                         169150
      *                                                                   169150
     C                     ENDIF                                          169150
      *
     C                     ENDSR
      *****************************************************************   CSW014
      /TITLE SR/SROCMT                                                    CSW014
      *****************************************************************   CSW014
      *                                                               *   CSW014
      *  SROCMT - Subroutine to extract Original Currency and Amount  *   CSW014
      *           from Sender to Receiver OR Special Instruction field*   CSW014
      *                                                               *   CSW014
      *  Called By: SRF5IN                                            *   CSW014
      *  Calls:                                                       *   CSW014
      *                                                               *   CSW014
      *****************************************************************   CSW014
      *                                                                   CSW014
     C           SROCMT    BEGSR                           *** SROCMT *** CSW014
      *                                                                   CSW014
     C                     MOVE *BLANKS   WWSR29 29                       CSW014
     C                     MOVE *BLANKS   WWSR06  6                       CSW014
      *                                                                   CSW014
     C                     MOVELT2SRL1    WWSR06                          CSW014
     C           WWSR06    IFEQ '/OCMT/'                                  CSW014
     C           29        SUBSTT2SRL1:7  WWSR29                          CSW014
     C                     ELSE                                           CSW014
     C                     MOVELTDSI      WWSR06                          CSW014
     C           WWSR06    IFEQ '/OCMT/'                                  CSW014
     C           29        SUBSTTDSI:7    WWSR29                          CSW014
     C                     ENDIF                                          CSW014
     C                     ENDIF                                          CSW014
      *                                                                   CSW014
     C           WWSR29    IFNE *BLANKS                                   CSW014
      *                                                                   CSW014
      ** Original Currency (posn. 1 - 3)                                  CSW014
     C           3         SUBSTWWSR29:1  MGOTRC                          CSW014
      *                                                                   CSW014
      ** Original Amount (posn. 4 - 16)                                   CSW014
     C           13        SUBSTWWSR29:4  WWOTRA 13                       CSW014
      *                                                                   CSW014
     C                     MOVE *BLANKS   OA                              CSW014
     C                     Z-ADD1         X       20                      CSW014
     C                     Z-ADD1         Y       20                      CSW014
     C           X         DOWLE13                                        CSW014
      *                                                                   CSW014
     C           1         SUBSTWWOTRA:X  WCHAR1  1                       CSW014
      *                                                                   CSW014
     C                     MOVE WCHAR1    WNUMB1  10                      CSW014
     C                     MOVE WNUMB1    WALPA1  1                       CSW014
     C           WCHAR1    IFEQ WALPA1                                    CSW014
     C                     MOVE WCHAR1    OA,Y                            CSW014
     C                     ADD  1         Y                               CSW014
     C                     ENDIF                                          CSW014
      *                                                                   CSW014
     C                     ADD  1         X                               CSW014
     C                     ENDDO                                          CSW014
      *                                                                   CSW014
     C                     MOVE *BLANKS   @OA                             CSW014
     C                     Z-ADD13        X                               CSW014
     C                     Z-ADD13        Y                               CSW014
     C           X         DOWGE1                                         CSW014
     C           OA,X      IFNE *BLANK                                    CSW014
     C                     MOVE OA,X      @OA,Y                           CSW014
     C                     SUB  1         Y                               CSW014
     C                     ENDIF                                          CSW014
     C                     SUB  1         X                               CSW014
     C                     ENDDO                                          CSW014
     C                     MOVEA@OA       W@OTRA 13                       CSW014
     C                     MOVE W@OTRA    MGOTRA                          CSW014
      *                                                                   CSW014
     C                     ENDIF                                          CSW014
      *                                                                   CSW014
     C                     ENDSR                           *** SROCMT *** CSW014
      *****************************************************************
      /TITLE SR/DAYSAC
      *****************************************************************
      *                                                               *
      *  DAYSAC - Subroutine to calculate the Number of Days of       *
      *           Accrued Interest.                                   *
      *                                                               *
      *  Called By: SRF5IN                                            *
      *  Calls: ZLCD, ZNCD, ZDAYS                                     *
      *                                                               *
      *****************************************************************
      *
     C           DAYSAC    BEGSR                           *** DAYSAC ***
      *
      ***  Determine the Start and End Dates for Calculating the number
      ***  of Days in the Period.
      *
      ***  Cum Coupon Trades:
      *
     C           ACIN      IFEQ 'C'
      *
      ***  The Start Date is the Last Coupon Date before (or on) the
      ***  Value Date of the Trade.
      *
     C                     Z-ADDTDVD      ZECD
     C                     EXSR ZLCD
     C                     Z-ADDZZLCD     ZSDATE
      *
      ***  The End Date is the Value Date of the Trade.
      *
     C                     Z-ADDTDVD      ZEDATE
     C                     ENDIF
      *
      ***  Ex-Coupon Trades:
      *
     C           ACIN      IFEQ 'X'
      *
      ***  The Start Date is the Value Date of the Trade.
      *
     C                     Z-ADDTDVD      ZSDATE
      *
      ***  The End Date is the Next Coupon Date after (or on) the Value
      ***  Date of the Trade.
      *
     C                     Z-ADDTDVD      ECD
     C                     EXSR ZNCD
     C                     Z-ADDNCD       ZEDATE
     C                     ENDIF
      *
      ***  Calculate Number of Days from Start Date to End Date.
      *
     C                     EXSR ZDAYS
      *
     C                     ENDSR
      *****************************************************************
      /TITLE SR/CONVT
      *****************************************************************
      *                                                               *
      *   CONVT - Converts an amount from one currency to another.    *
      *                                                               *
      *    INPUT  - WWAMTI (15,0) AMOUNT INPUT                        *
      *             WWEXCH (13,8) EXCHANGE RATE                       *
      *             WWZMD  (1)    MULTIPLY/DIVIDE INDICATOR           *
      *             WWDPI  (1,0)  CURRENCY INPUT                      *
      *             WWDPO  (1,0)  CURRENCY TO BE CONVERTED TO         *
      *                                                               *
      *   Arrays       - POWER  powers of 10                          *
      *                                                               *
      *   OUTPUT -  WWAMTO (15,0) AMOUNT OUTPUT                       *
      *                                                               *
      *   CALLS    - NONE                                             *
      *                                                               *
      *****************************************************************
      *
     C           CONVT     BEGSR
      *
      ** DEFINE ALL FIELDS
     C                     Z-ADDWWAMTI    WWAMTI 150
     C                     Z-ADD0         WWAMTO 150
     C                     Z-ADDWWDPI     WWDPI   10
     C                     Z-ADDWWDPO     WWDPO   10
     C                     Z-ADDWWEXCH    WWEXCH 138
     C                     MOVE WWZMD     WWZMD   1
      *
      *** IF DECIMAL PLACES DIFFER -
      ***      CALCULATE DIFFERENCE IN DECIMAL PLACES TO USE AS POWER INDEX
      *
     C           WWDPO     SUB  WWDPI     ZPX     10
     C                     ADD  4         ZPX
      *
      ** CALCULATE CURRENCY AMOUNT OUTPUT BY MULTIPLYING INPUT AMOUNT BY
      **  POWER ARRAY ENTRY AND THEN MULTIPLYING RESULT BY EXCHANGE RATE
      **  DEPENDING ON INDICATOR
      *
     C           WWAMTI    MULT POWER,ZPX Z21S3  213
      *
     C           WWZMD     IFEQ 'D'
     C           Z21S3     DIV  WWEXCH    WWAMTO    H
     C                     ELSE
     C           Z21S3     MULT WWEXCH    WWAMTO    H
     C                     END
      *
     C                     ENDSR
      *****************************************************************
      /TITLE SR/SRNRDT
      *****************************************************************
      *                                                               *
      *  SRNRDT - Find the next rate change date                      *
      *                                                               *
      *  Called By: SRF5IN                                            *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SRNRDT    BEGSR
      *
     C           RCFQ      IFNE *BLANKS
      *
     C           NCHD      IFGT BJRDNB
     C                     Z-ADDNCHD      MGNRDT
     C                     ENDIF
      *
     C                     ELSE
      *
     C           CD01      IFNE *ZERO
     C           CPNR      ANDNE*ZERO
      *
      *** Want Next Rate Change Date AFTER Value Date, so add 1.
     C                     Z-ADD*ZERO     ECD
     C           TDVD      ADD  1         ECD
     C                     EXSR ZNCR
     C                     Z-ADDNCR       MGNRDT
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /TITLE SR/SRSECG
      *****************************************************************
      *                                                               *
      * SRSECG - Access LF/SECGT                                      *
      *                                                               *
      * Called by: SR/SRF5IN                                          *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
      *
     C           SRSECG    BEGSR
      *
     C           KSECGT    CHAINSECGT                57
     C           *IN57     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD025       DBASE            ***************
     C                     MOVEL'SECGT   'DBFILE           * DB ERROR 25 *
     C                     MOVELTNMC      DBKEY5           ***************
     C                     MOVE WCOM      DBKEY5
     C                     MOVELDBKEY5    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************   CSE006
      /TITLE SR/SRPIF                                                     CSE006
      *****************************************************************   CSE006
      *                                                               *   CSE006
      * SRPIF  -  Sets up Repurchase Information                      *   CSE006
      *                                                               *   CSE006
      * Called by: SR/SRF5IN                                          *   CSE006
      * Calls: None                                                   *   CSE006
      *                                                               *   CSE006
      *****************************************************************   CSE006
      *                                                                   CSE006
     C           SRPIF     BEGSR                                          CSE006
      *                                                                   CSE006
      *** Retrieve Book info to see if Book is a Buy/Sell Book            CSE006
      *                                                                   CSE006
     C                     CALL 'AOBOOKR0'                                CSE006
     C                     PARM '*MSG    'WRTCD   7                       CSE006
     C                     PARM '*KEY   ' WOPTN   7                       CSE006
     C                     PARM TDBK      WBOOK   2                       CSE005
     C           SDBOOK    PARM SDBOOK    DSFDY                           CSE006
      *                                                                   CSE006
      *** Handle Database error                                           CSE006
      *                                                                   CSE006
     C           WRTCD     IFNE *BLANKS                                   CSE006
     C           *LOCK     IN   LDA                                       CSE006
     C                     MOVEL'SDBOOK'  DBFILE           ***************CSE006
     C                     Z-ADD33        DBASE            **DB ERROR 33 *CSE006
     C                     MOVELTDBK      DBKEY            ***************CSE006
     C                     OUT  LDA                                       CSE006
     C                     EXSR *PSSR                                     CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
      *** If BYSL set up Repurchase Info                                  CSE006
      *                                                                   CSE006
     C           BDBYSL    IFEQ 'Y'                                       CSE006
      *                                                                   CSE006
     C                     Z-ADDTDVD      @TDVD   50                      CSE006
     C                     Z-ADDTCTR      @TCTR  130                      CSE006
      *                                                                   CSE006
      *** Use Link Ref of TRADSDJ2 to get LF/TRADS info                   CSE006
      *                                                                   CSE006
     C           LKRF      CHAINTRADS                58                   CSE006
      *                                                                   CSE006
     C           *IN58     IFEQ '1'                                       CSE006
     C           *LOCK     IN   LDA                                       CSE006
     C                     Z-ADD034       DBASE            ***************CSE006
     C                     MOVEL'TRADS   'DBFILE           * DB ERROR 34 *CSE006
     C                     MOVELLKRF      DBKEY            ***************CSE006
     C                     OUT  LDA                                       CSE006
     C                     EXSR *PSSR                                     CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
      *** If Value Date for 2nd trade is more the 1st trade               CSE006
      *** Move Value date into Maturity date of the repo (MGF51NPD)       CSE006
      *                                                                   CSE006
     C           TDVD      IFGT @TDVD                                     CSE006
      *                                                                   CSE006
     C                     Z-ADDTDVD      MGMD                            CSE006
     C                     Z-ADDTDVD      @MDATE  50                      CSE006
     C                     Z-ADD@TDVD     @VDATE  50                      CSE006
     C                     ELSE                                           CSE006
     C                     Z-ADD@TDVD     MGMD                            CSE006
     C                     Z-ADD@TDVD     @MDATE                          CSE006
     C                     Z-ADDTDVD      @VDATE  50                      CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     MOVE TDRF      MGARF                           CSE006
      *                                                                   CSE006
     C           TDTP      IFEQ 'TP'                                      CSE006
     C                     Z-ADDTCTR      @PVAL  130                      CSE006
     C                     Z-ADD@TCTR     @SVAL  130                      CSE006
     C                     ELSE                                           CSE006
     C                     Z-ADDTCTR      @SVAL                           CSE006
     C                     Z-ADD@TCTR     @PVAL                           CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C           DYBS      IFEQ *BLANK                                    CSE006
     C           @MDATE    SUB  @VDATE    @DDIFF  50                      CSE006
     C                     ELSE                                           CSE006
     C                     Z-ADD@VDATE    ZSDATE                          CSE006
     C                     Z-ADD@MDATE    ZEDATE                          CSE006
     C                     EXSR ZDAYS                                     CSE006
     C                     Z-ADDZDDAYS    @DDIFF                          CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C           DVBS      IFEQ *BLANK                                    CSE006
     C                     Z-ADD365       @YDAYS  30                      CSE006
     C                     ELSE                                           CSE006
     C                     EXSR ZDYYR                                     CSE006
     C                     Z-ADDZINTDD    @YDAYS                          CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
      ***  Implied Repo Rate                                              CSE006
      *                                                                   CSE006
     C           @PVAL     SUB  @SVAL     @SVAL                           CSE006
     C           @SVAL     MULT @YDAYS    @YDAYS                          CSE006
     C           @YDAYS    DIV  @DDIFF    @DDIFF                          CSE006
     C           @DDIFF    MULT 100       @IRATE 138                      CSE006
      *                                                                   CSE006
     C                     Z-ADD@IRATE    MGRR                            CSE006
      *                                                                   CSE006
     C           LKRF      SETLLSECRTNL1                                  CSE006
     C           LKRF      READESECRTNL1                 59               CSE006
      *                                                                   CSE006
     C           *IN59     IFEQ '0'                                       CSE006
     C                     MOVE 'Y'       MGCRTN                          CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     ENDSR                                          CSE006
      *                                                                   CSE006
      *****************************************************************                       CSW210
      /TITLE SR/SRPROC                                                                        CSW210
      *****************************************************************                       CSW210
      *                                                               *                       CSW210
      *  SRIBAN - Subroutine to do the Detail Processing.             *                       CSW210
      *                                                               *                       CSW210
      *  Called By: Main Processing                                   *                       CSW210
      *  Calls:                                                       *                       CSW210
      *                                                               *                       CSW210
      *****************************************************************                       CSW210
      *                                                                                       CSW210
     C           SRIBAN    BEGSR                                                              CSW210
      *                                                                                       CSW210
     C           CSW210    IFEQ 'Y'                                                           CSW210
     C           CFT004    ANDEQ'Y'                                                           CSW210
      *                                                                                       CSW210
     C                     MOVELWACOD     PACOD  10                                         AR549800
     C                     MOVE WACOD     PASEQ   2                                         AR549800
     C                     CALL 'AOACCTR0'                                                  AR549800
     C                     PARM *BLANKS   PRTCD   7                                         AR549800
     C                     PARM '*KEY'    POPTN   7                                         AR549800
     C                     PARM *BLANKS   PACCT  10                                         AR549800
     C                     PARM WCNUM     PCNUM   6                                         AR549800
     C                     PARM WCYCD     PCCY    3                                         AR549800
     C                     PARM           PACOD                                             AR549800
     C                     PARM           PASEQ                                             AR549800
     C                     PARM WBRCA     PBRCH   3                                         AR549800
     C           ACCNT     PARM ACCNT     DSSDY                                             AR549800
      *                                                                                       CSW210
     C           WRTCD     IFNE *BLANKS                                                       CSW210
     C           *LOCK     IN   LDA                                                           CSW210
     C                     Z-ADD041       DBASE                                               CSW210
     C                     MOVEL'AOACCTR0'DBFILE                                              CSW210
     C                     MOVE '*CALL   'DBKEY                                               CSW210
     C                     OUT  LDA                                                           CSW210
     C                     EXSR *PSSR                                                         CSW210
     C                     ELSE                                                               CSW210
     C           IBAN      IFNE *BLANKS                                                     AR549800
     C                     MOVELIBAN      WWOA35    P                                         CSW210
     C                     MOVEL'Y'       WWIBFL  1                                         AR549800
     C                     ENDIF                                                            AR549800
     C                     ENDIF                                                              CSW210
      *                                                                                       CSW210
     C                     ENDIF                                                              CSW210
      *                                                                                       CSW210
     C                     ENDSR                                                              CSW210
      *                                                                                       CSW210
      *****************************************************************                     AR549800
      **                                                              *                     AR549800
      **  SRVIBA    - IBAN Validation                                 *                     AR549800
      **                                                              *                     AR549800
      **  Calls     - None                                            *                     AR549800
      **  Called By - SRAMSF                                          *                     AR549800
      **                                                              *                     AR549800
      *****************************************************************                     AR549800
      *                                                                                     AR549800
     C           SRVIBA    BEGSR                                                            AR549800
      *                                                                                     AR549800
     C                     MOVEL*BLANKS   WTIBA1 47                                         AR549800
      *                                                                                     AR549800
     C                     CALL 'AOIBANR3'                                                  AR549800
     C                     PARM *BLANKS   @RTCD                                             AR549800
     C                     PARM WWOA35    WTIBA1                                            AR549800
     C                     PARM           WIBLNK 47                                         AR549800
     C                     PARM           WOBLNK 34                                         AR549800
      *                                                                                     AR549800
     C           2         SUBSTWOBLNK:1  WOBCH   2                                         AR549800
     C           2         SUBSTWOBLNK:3  WOBNB   2                                         AR549800
      *                                                                                     AR549800
     C           ALPHA     CHECKWOBCH                    81                                 AR549800
     C           NMBRS     CHECKWOBNB                    82                                 AR549800
      *                                                                                     AR549800
      ** IBAN starts with 'AANN'                                                            AR549800
     C           *IN81     IFEQ *OFF                                                        AR549800
     C           *IN82     ANDEQ*OFF                                                        AR549800
      *                                                                                     AR549800
     C                     CALL 'AOIBANR5'             82                                   AR549800
     C                     PARM *BLANKS   @RTCD                                             AR549800
     C                     PARM WOBLNK    WTIBAN 34                                         AR549800
      *                                                                                     AR549800
     C           @RTCD     IFEQ *BLANKS                                                     AR549800
     C           *IN82     ANDEQ*OFF                                                        AR549800
     C                     MOVE 'Y'       WWIBFL                                            AR549800
     C                     ENDIF                                                            AR549800
     C                     ENDIF                                                            AR549800
      *                                                                                     AR549800
     C                     ENDSR                                                            AR549800
      *****************************************************************
      /TITLE SR/AUDIT
      *****************************************************************
      *                                                               *
      * AUDIT - Run Control Process                                   *
      *                                                               *
      * Called by: SR/SRPROC                                          *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
      *
     C           AUDIT     BEGSR
      *
      ***  Write Heading and control information
     C                     WRITEHEADAU
     C                     WRITECONTROL
      *
      ***  If there is a DB Error, Output the DB Error Information.
     C           *INU7     IFEQ '1'
     C                     WRITEDBERROR
     C                     ELSE
      *
      ***  Or, if no valid records read, Output "No Details" message.
     C           RCOUNT    IFLT 1
     C                     WRITENODTLS
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
     C/COPY WNCPYSRC,SE1875C004
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      * Called by: (**calling routines**)                             *
      *                                                               *
      * Calls: None                                                   *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR                           ** *PSSR SR **
      *
     C           @RUN      IFEQ *BLANK
     C                     MOVE 'Y'       @RUN    1
     C                     DUMP
     C                     END
      *
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *
      ********************************************************************
      /TITLE SR/ZLCD
     C/COPY ZSRSRC,ZLCDZ1
      /TITLE SR/ZNCD
     C/COPY ZSRSRC,ZNCDZ3
      /TITLE SR/ZNCR
     C/COPY ZSRSRC,ZNCRZ1
      /TITLE SR/ZDATE1
     C/COPY ZSRSRC,ZDATE1Z2
      /TITLE SR/ZDATE2
     C/COPY ZSRSRC,ZDATE2Z2
      /TITLE SR/ZDAYS
     C/COPY ZSRSRC,ZDAYSZ2
      /TITLE SR/ZDYYR                                                     CSE006
     C/COPY ZSRSRC,ZDYYRZ3                                                CSE006
      /TITLE SR/ZCNSD
     C/COPY ZSRSRC,ZCNSDZ1
      /TITLE COMPILE-TIME ARRAYS
      ***
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
