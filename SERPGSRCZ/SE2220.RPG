     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Generate a/c keys - book posns')              *
/*XBIA*: OVRDBF HTRACBX HTRACB                                      : *
/*XBIB*  OVRDBF BPACCU  BPACC                                         *                       168141
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  SE2220 - GENERATE ACCOUNT KEYS FOR BOOK POSITIONS            *
      *                                                               *
      *  Function: This program reads the Book Position Actions files *
      *   (COB)    for changes to positions today as well as changes  *
      *            to previous positions on the Historic Book Position*
      *            Actions file which require recalculation due to    *
      *            back valuations.                                   *
      *            Book Position data is updated, and position related*
      *            Account Keys are generated. Book Position Monthly  *
      *            Statistics are also updated.                       *
      *            This program is run in either Reversal (U1 on) or  *
      *            Forward (U1 off) mode:                             *
      *            1. Reversal mode - Historic Actions which are dated*
      *               after the first backvaluation on a Position are *
      *               re-actioned, and the Reversal Indicator is set  *
      *               on for all Account Keys created.                *
      *            2. Forward mode - these Historic Actions are re-   *
      *               actioned, adding all book positions, current and*
      *               backvalued, which are new today.                *
      *                                                               *
      *  Called by: SEC0605  - Generate A/c Keys - Book Positions,    *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. 229720             Date 29Nov05               *
      *  Prev Amend No. 215959             Date 21Mar16               *
      *                 MD036550           Date 25May16               *
      *                 226449             Date 24Jun15               *
      *                 MD031745A          Date 27Jul15               *
      *                 MD031745           Date 27Jul15               *
      *                 MD034776           Date 09Jul15               *
      *                 AR1066579          Date 08Feb13               *
      *                 AR1067108          Date 11Dec12               *
      *                 AR1001183A         Date 20Nov12               *
      *                 CSE105             Date 06Dec10               *
      *                 CER059             Date 19Jul10               *
      *                 BUG24061           Date 21May09               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 BUG18062           Date 28Apr08               *
      *                 248281             Date 06Jun07               *
      *                 248336             Date 06Jun07               *
      *                 247926             Date 29May07               *
      *                 247279             Date 24Apr07               *
      *                 247179             Date 19Apr07               *
      *                 246619             Date 29Mar07               *
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 244962             Date 25Jan07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSE091             Date 09Mar06               *
      *                 CSD027             Date 09Dec05               *
      *                 CGL035             Date 01Mar05               *
      *                 CSE075             Date 17Nov05               *
      *                 233707             Date 27May05               *
      *                 CSE065             Date 08Nov04               *
      *                 CSE071             Date 19Jul05               *
      *                 BUG8813            Date  7Nov05               *
      *                 230115             Date 14Oct04               *
      *                 230033             Date 12Oct04               *
      *                 229857             Date 07Oct04               *
      *                 228948             Date 27Sep04               *
      *                 229289             Date 01Sep04               *
      *                 226570             Date 27Jun04               *
      *                 228110             Date 07Jun04               *
      *                 226138             Date 12Apr04               *
      *                 CAS006             Date 21Jan03               *
      *                 211407             Date 09Nov02               *
      *                 194370             Date 12Jul01               *
      *                 207543             Date 17Jul02               *
      *                 CSE037             Date 29Apr02               *
      *                 CSE035             Date 22Apr02               *
      *                 CSE036             Date 22Apr02               *
      *                 CGL020             Date 12Dec02               *
      *                 206316             Date 19Jul02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun01               *
      *                 CSE031             Date 09Nov01               *
      *                 182505             Date 13Sep00               *
      *                 180707             Date 25Jul00               *
      *                 168141             Date 01Oct99               *
      *                 CSE032             Date 13Dec01               *
      *                 188515             Date 24Aug01               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.05 -----------------------------------------------*
      *                 187328             Date 28Mar01               *
      *                 166661             Date 21Mar01               *
      *                 186249             Date 04Dec00               *
      * Midas DBA 3.04 -----------------------------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 174050             Date 10Apr00               *
      *                 174234             Date 10May00               *
      *                 124140             Date 05May00               *
      *                 155100             Date 03May00               *
      *                 140272             Date 20Apr00
      *                 132717             DATE 19Apr00               *
      *                 149946             DATE 15Mar00               *
      *                 147449             DATE 15Mar00               *
      *                 148044             DATE 15Mar00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSE006             Date 26AUG99               *
      *                 CPB001             Date 13Sep99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CAC005             Date 23Nov98               *
      *                 102506             Date 18Oct98               *
      *                 129596             Date 11Oct98               *
      *                 151945             DATE 06Jan99               *
      *                 CEU017             Date 02Apr98               *
      *                 CSE007             Date 17Mar98               *
      *                 S01408             DATE 26SEP96               *
      *                 108186             DATE 24FEB98               *
      *                 108024             DATE 17FEB98               *
      *                 120518             DATE 15JUL97               *
      *                 106567             DATE 28JAN98               *
      *                 CSE005             DATE 04FEB97               *
      *                 111157             DATE 05Feb97               *
      *                 CAC002             Date 15Sep96               *
      *                 109565             DATE 01NOV96               *
      *                 S01408             DATE 26SEP96               *
      *                 091803             DATE 20AUG96               *
      *                 090364             DATE 19AUG96               *
      *                 090108             DATE 13AUG96               *
      *                 084704             DATE 01AUG96               *
      *                 083039             DATE 01AUG96               *
      *                 059110             DATE 25JUL96               *
      *                 088047             DATE 26JUN96               *
      *                 100228             DATE 31MAY96               *
      *                 100100             DATE 24MAY96               *
      *                 103176             DATE 14MAY96               *
      *                 097328             DATE 05FEB96               *
      *                 049865             DATE 01MAY96               *
      *                 040431             DATE 30APR96               *
      *                 S01408             DATE 30APR96               *
      *                 076681             DATE 25APR96               *
      *                 099591             DATE 17APR96               *
      *                 099886             DATE 17APR96               *
      *                 100017             DATE 17APR96               *
      *                 099384             DATE 17APR96               *
      *                 101037             DATE 16APR96               *
      *                 101300             DATE 16APR96               *
      *                 CPM004             DATE 08FEB96               *
      *                 092961             DATE 04OCT95               *
      *                 091254             DATE 20OCT95               *
      *                 056394             DATE 18OCT95               *
      *                 061822             DATE 18OCT95               *
      *                 031177             DATE 18OCT95               *
      *                 086491             DATE 15JUN95               *
      *                 S01486     VP      DATE 28OCT94               *
      *                 S01502             DATE 02DEC94               *
      *                 064575             DATE 15AUG94               *
      *                 065301             DATE 05MAY94               *
      *                 055950             DATE 05MAY94               *
      *                 052480             DATE 08APR94               *
      *                 051044             DATE 18MAR93               *
      *                 055893             DATE 02FEB94               *
      *                 054257             DATE 26NOV93               *
      *                 053703             DATE 26NOV93               *
      *                 052254             DATE 26NOV93               *
      *                 051339             DATE 26NOV93               *
      *                 052573             DATE 26NOV93               *
      *                 S01401             DATE 16JUN93               *
      *                 E39495             DATE 17FEB93               *
      *                 047922             DATE 01FEB93               *
      *                 047370             DATE 01FEB93               *
      *                 S01397             DATE 16SEP92               *
      *                 E38721             DATE 26JUN92               *
      *                 E40426             DATE 18MAY92               *
      *                 E38112             DATE 03APR92               *
      *                 E37811             DATE 31MAR92               *
      *                 E37180             DATE 18MAR92               *
      *                 E36391             DATE 17MAR92               *
      *                 E36622             DATE 03MAR92               *
      *                 E36547             DATE 28FEB92               *
      *                 E34618             DATE 16JAN92               *
      *                 E34532             DATE 15JAN92               *
      *                 E32464             DATE 15JAN92               *
      *                 E29170             DATE 06NOV91               *
      *                 E27934             DATE 22OCT91               *
      *                 E29207             DATE 08OCT91               *
      *                 E29236             DATE 08OCT91               *
      *                 E29244             DATE 08OCT91               *
      *                 E29246             DATE 08OCT91               *
      *                 E27092             DATE 04SEP91               *
      *                 S01117             DATE 03JUN91               *
      *                 S01195             DATE 03JUN91               *
      *                 E23987             DATE 01NOV90               *
      *                 S01269             DATE 31JUL90               *
      *                 S01288             DATE 06JUL90               *
      *                 E23748             DATE 28SEP90               *
      *                 E23747             DATE 28SEP90               *
      *                 E22957             DATE 10AUG90               *
      *                 E23184             DATE 07AUG90               *
      *                 E21574             DATE 08JUN90               *
      *                 E21546             DATE 08JUN90               *
      *                 E21545             DATE 08JUN90               *
      *                 E21539             DATE 08JUN90               *
      *                 E21535             DATE 08JUN90               *
      *                 E21603             DATE 04JUN90               *
      *                 E21670             DATE 30MAY90               *
      *                 E21531             DATE 30MAY90               *
      *                 E21608             DATE 30MAY90               *
      *                 E21668             DATE 01MAY90               *
      *                 E21616             DATE 03APR90               *
      *                 E21429             DATE 14MAR90               *
      *                 E21355             DATE 08MAR90               *
      *                 E21304             DATE 06MAR90               *
      *                 E21240             DATE 26FEB90               *
      *                 E21232             DATE 26FEB90               *
      *                 E21225             DATE 26FEB90               *
      *                 E21130             DATE 14FEB90               *
      *                 E21113             DATE 12FEB90               *
      *                 E21097             DATE 08FEB90               *
      *                 E21084             DATE 07FEB90               *
      *                 E20651             DATE 06FEB90               *
      *                 E20993             DATE 02FEB90               *
      *                 E20986             DATE 30JAN90               *
      *                 E20953             DATE 29JAN90               *
      *                 E20958             DATE 26JAN90               *
      *                 E20960             DATE 25JAN90               *
      *                 E20921             DATE 24JAN90               *
      *                 E20896             DATE 19JAN90               *
      *                 E20732             DATE 08JAN90               *
      *                 E20785             DATE 08JAN90               *
      *                 E20620             DATE 14DEC89               *
      *                 S01232             DATE 14DEC89               *
      *                 S01233             DATE 12DEC89               *
      *                 E20232             DATE 11DEC89               *
      *                 E20552             DATE 10DEC89               *
      *                 E20568             DATE 09DEC89               *
      *                 E20475             DATE 01DEC89               *
      *                 E20191             DATE 01DEC89               *
      *                 E20492             DATE 30NOV89               *
      *                 E20380             DATE 30NOV89               *
      *                 E20427             DATE 25NOV89               *
      *                 E20384             DATE 24NOV89               *
      *                 E20018             DATE 17NOV89               *
      *                 E20125             DATE 08NOV89               *
      *                 E20144             DATE 08NOV89               *
      *                 E20149             DATE 08NOV89               *
      *                 E19429             DATE 08NOV89               *
      *                 E19397             DATE 08NOV89               *
      *                 E19485             DATE 08NOV89               *
      *                 E19445             DATE 08NOV89               *
      *                 E19494             DATE 08NOV89               *
      *                 E19433             DATE 08NOV89               *
      *                 E19411             DATE 08NOV89               *
      *                 E20087             DATE 08NOV89               *
      *                 E20086             DATE 08NOV89               *
      *                 E20085             DATE 08NOV89               *
      *                 E18803             DATE 17AUG89               *
      *                 E18651             DATE 13JUL89               *
      *                 E18652             DATE 04/07/89              *
      *                 E18800             DATE 03/07/89              *
      *                 E18668             DATE 28/06/89              *
      *                 E18667             DATE 28/06/89              *
      *                 E17686             DATE 27/06/89              *
      *                 E15950             DATE 23/06/89              *
      *                 E16772             DATE 20/06/89              *
      *                 E18009             DATE 21/04/89              *
      *                 E15746             DATE 14/03/89              *
      *                 E16822             DATE 09/02/89              *
      *                 E16780             DATE 09/02/89              *
      *                 S01176             DATE 09/11/88              *
      *                 E15965             DATE 31/10/88              *
      *                 E14616             DATE 26/10/88              *
      *                 E15324             DATE 13/10/88              *
      *                 E15564             DATE 13/10/88              *
      *                 E15598             DATE 13/10/88              *
      *                 E15573             DATE 13/10/88              *
      *                 E15715             DATE 13/10/88              *
      *                 E15549             DATE 10/10/88              *
      *                 E15442             DATE 29/09/88              *
      *                 E14235             DATE 23/09/88              *
      *                 E14236             DATE 12/09/88              *
      *                 E14680             DATE 10/09/88              *
      *                 E14514             DATE 09/08/88              *
      *                 E13817             DATE 24/06/88              *
      *                 S01129             DATE 12/04/88              *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  229720 - Incorrect generation of accrued interest when       *
      *           nominal position is flat and ex-date position       *
      *           is non-zero. Fix is to ensure that PILP and ARPC    *
      *           are zeroised only if NPSN and ECNP are zeroes.      *
      *           Corrected core fix 166661. Applied fix 232165.      *
      *  215959 - Truncation error on event amount in SE2450P3.       *
      *           Recompiled due to changes in PF/SEKEYD.             *
      *         - Applied for MD-37439.                               *
      *  MD036550 - Interest adjustment is not generated. Fix is to   *
      *             reset ARPC when NPSN and INDO is zero.            *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  MD031745A - Revise fix MD031745. RP/RL computation must      *
      *              include the amortised discount/premium proportion*
      *              to Sale Nominal.                                 *
      *  MD031745 - Currency Imbalance. CSE105 does not consider the  *
      *             FIFO processing. Average price of previous nominal*
      *             should be used instead of price in historic file. *
      *  MD034776 - Reverse AR1001183A to allow negative interest     *
      *             rate. (Recompile)                                 *
      *  AR1066579 - Missing Premium/Discount postings due to conflict*
      *              in 241968 fix and CSE105 changes.                *
      *  AR1067108 - PMC1140 Component failed during Clean COB        *
      *              Applied fix AR1001183A                           *
      *  AR1001183A - Coupon rate was still used in computation of    *
      *              interest instead of using the details in FRN tab *
      *              (Reopen) (Recompile)                             *
      *  CSE105 - Portuguese Upgrade - Discount/Premium Amortisation  *
      *           on Trade Date                                       *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  BUG24061 - Error on SEC0605 Sec 00001                        *
      *  BUG18062 - Apply 252207                                      *
      *  252207 - COB Report SEC0606J - Book position recon error.    *
      *           Nominal in book position got truncated. Increase    *
      *           DS/RECST1 by 8 due to add'l BKPOSD field PNOM (8P). *
      *  248281 - DS account key wrong. If Prot = 8 field BCCN        *
      *           coming from BPACCD or BPACBD already contains the   *
      *           the current factor so need to find back the gross   *
      *           consideration amount (WCONS = Nominal x Price)      *
      *  248336 - Apply 226359                                        *
      *  226359 - Discrepancy key posted twice.  No need to generate  *
      *           another account key for reversal since discrepancy  *
      *           key is already generated by SE2290 and account      *
      *           setup of client is already correct with DR and CR   *
      *           entries to close out the discrepancy amount.        *
      *  247926 - If posting is trade-based, get profit centre from   *
      *           TRADSD.                                             *
      *  247279 - Consideration amount on MBB security wrong          *
      *  247179 - Apply 241968.                                       *
      *  241968 - Corrupted book position records lead to average     *
      *           price being calculated incorrectly.                 *
      *  246619 - Need to keep track the previous nominal position    *
      *           om each record in PF/BKPOSD. Field PNOM will be     *
      *           used during reversal of negative a/c key of         *
      *           Unrealised Profit & Loss.                           *
      *  244962 - Get the trade details from TRADS file and determine *
      *           the trade type (Purchase/Sale), to know wether      *
      *           DELT or DELF should move the value to KCUST.        *
      *  CSE091 - Upgrade LBV023 to Midas Plus                        *
      *           Discount/Premium on Securities                      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CGL035 - EUSD Upgrade to MidasPlus                           *
      *  CSE075 - US Enhanced Treasury Upgrade to MidasPlus           *
      *  233707 - Use the average life date regardless of the mark to *
      *           market flag.                                        *
      *  CSE065 - Cost Yield Amort. on Mortgage Backed Assets         *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  BUG8813  Ensure profit centres are used before accessing     *
      *           book profit centre                                  *
      *  230115 - Use the prevailing coupon rate for the period       *
      *           during amortisation processing.                     *
      *           Reverse fix 129596 but make this conditional on     *
      *           CSE032 and constant yield books.                    *
      *  230033 - During backvaluation processing, trade basis should *
      *           hold its original value. Reposition some codings    *
      *           under 229289.                                       *
      *  229857 - Recompiled due to change in ZYLDZ2.                 *
      *  228948 - Add 'Exclude Accrued Interest in Unrealized Profit  *
      *           or Loss'.                                           *
      *  229289 - Use the original value of the trade basis when      *
      *           processing the average price change.                *
      *  226570 - Recompiled due to change in ZYLDZ2.                 *
      *  228110 - No profit/loss posted for securities whose average  *
      *           price equals market price.  Applied fix to continue *
      *           processing of profit/loss if accrued interest to    *
      *           date is not zero.                                   *
      *  226138 - Allow amortisation of Schuldshein on a yield curve  *
      *           basis.                                              *
      *  CAS006 - Hedge Accounting Phase B                            *
      *  211407 - Recompile after change on copy sources ZYLDZ2,      *
      *           ZACCRZ1 and ZYCEZ1 for NX/NNX processing.           *
      *           The change was to call subroutine ZLCD1 instead     *
      *           of ZLCD in retrieving the PERIOD for NNX processing *
      *           and ZNCD1 is called instead of ZNCD in retrieving   *
      *           the WBENCD for NNX processing. Also rewrite tests   *
      *           for identifying if position is NX,NNX or CUM.       *
      *  194370 - Recompile after change on copy sources ZYLDZ2,      *
      *           For securities with divisor basis = '5' and first   *
      *           coupon date > valuation date (rundate + 1), set     *
      *           event control date to first coupon date before      *
      *           processing SR/ZDYYR. This is to ensure that the     *
      *           correct hypothetical last and next coupon dates are *
      *           used in deriving the price/yield rate.              *
      *  207543 - CEU018 not working on a price basis.                *
      *           Recompile over changed ZYLDZ2.                      *
      *  CSE037 - Bond Pricing - 3 Decimal Places in Trades Input     *
      *  CSE035 - NX/NNX Coupon Payment Processing.                   *
      *         - Recompile over changed ZACCRZ1/ZYLDZ2/ZYCEZ1        *
      *         - The original coding is under fix 180056 for this    *
      *           source. For other sources, 180056 was used for the  *
      *           changes.                                            *
      *  CSE036 - Unrealised Profit and Loss Report by Trade          *
      *  CGL020 - Midas Compliance Watch - Additional A/C Postings    *
      *           Information (Recompile)                             *
      *  206316 - Recompiled over changed ZLCDZ1.                     *
      *  CPK015 - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed ZYLDZ2.                      *
      *  CSE031 - Coupon Fixing for Floating Rate Notes.              *
      *           (recompilation due to change to ZNCD/ZLCD)          *
      *  182505 - Parameters for call on SE0045 not setup correctly   *
      *           causing it to dump. Fix is to setup SITP and NMCY   *
      *           accordingly.                                        *
      *  180707 - No Position Settlements generated. Recompile over   *
      *           changes in /COPY ZNCDZ3.                            *
      *  168141 - SEC0605 loops during the running of SE2220. used    *  *
      *           existing fix 162495.                                *  *
      *  CSE032 - Allow entry of yield basis if trade basis and       *
      *           price basis are 'P'.                                *
      *  187328 - Problem on Premium/Discount A/C Key generation.     *
      *           Generate two A/C keys if position changes from long-*
      *           to short or short to long or if the price changes   *
      *           from discount to premium or from premium to         *
      *           discount.                                           *
      *  166661 - Purchased interest reset to '0' if NPSN = 0         *
      *  186249 - Book code used to chain the book file is sometimes  *
      *           incorrect.                                          *
      *  174050 - System generate UP posting even if ICD was setup to *
      *           post UL only and vice versa.  Prevent system to     *
      *           generate acct keys to SEKEYD if it didnt satisfy    *
      *           conditions on ICD setup.                            *
      *  174234 - Wrong accounting for ex-coupon transaction. Interest*
      *           amounting to the due interest to be received on     *
      *           coupon date is posted prematurely.                  *
      *  124140 - Incorrect Mark-to-market when trade is amended.     *
      *  155100 - System not generating correct security trading A/C  *
      *           keys.  Check ICD setting if sub-type to be included *
      *           when producing Discrepancy keys.  USED FIX 136636.  *
      *  140272 - Recompile over changed ZYLDZ2                       *
      *  132717 - Mortgage payment nominal on asset backed securities *
      *           are accounting incorrectly because wrong previous   *
      *           current factor was being used, retrieve it using    *
      *           GETCUF subroutine.                                  *
      *  149946 - Need to change calc of profit / loss depending on   *
      *           whether position is long or short.                  *
      *           Correct Sign of RL/RP keys for MP Payments.         *
      *  147449 - If Nominal Zero then don't allow MP Event keys      *
      *  148044 - If Mortgage Payment amount entered - use it instead *
      *           of Current Factor as this introduces rounding error *
      *  CSE006 - Repurchase Agreements (REPOs) enhancement           *
      *  CPB001 - 'Private banking' Module                            *
      *  CAC005 - Profit Centre Accounting - SE Enhancement           *
      *  102506 - Accrue 30 days interest over February for day basis *
      *           '1' & '5'. Removed fix 086491 in ZDAYSZ2 and        *
      *           replaced with 067811.                               *
      *  129596 - Unexpected Discount Amortisation posting was gene-  *
      *           rated in response to a backvalued Interest Rate     *
      *           Change. Fix was to remove amortisation in 'IR'      *
      *           action as it is not necessary. Applied fix 109152.  *
      *  151945 - Recompiled Over changed ZDYYRZ3 .                   *
      *  CEU017 - Securities Redenomination Euro Changes              *
      *           Same coding than CSE007                             *
      *  CSE007 - Corporate Actions                                   *
      *  S01408 - Auto-added Hooks moved to match position in 10.6    *
      *           Core Hook SE2220C067 moved                          *
      *           Core Hook SE2220C069 moved                          *
      *           Core Hook SE2220C070 moved                          *
      *           Addition of core hook SE2220CP67 as replacement.    *
      *           Addition of core hook SE2220CP69 as replacement.    *
      *           Addition of core hook SE2220CP70 as replacement.    *
      *  108187 - APPLIED CORRECTION 090200:                          *
      *           PURCHASE INTEREST MUST BE ZEROISED IN BKPOSD WHEN   *
      *           TRADING AGAIN ON A FLAT POSITION EVENT IN PIAI SUBR.*
      *           ACCOUNT KEYS PRODUCED WITH PREVIOUS PURCHASE        *
      *           INTEREST ON REVERSED TRADE                          *
      *  108024 - FIX 100100 NOT COMPLETE. 'RP' KEYS WERE GENERATED   *
      *           WITH EVENT DATE TO 00000.                           *
      *  120518 - To set up of the negative indicator for realised    *
      *           P/L key from Mark-to-Market, program should use     *
      *           the current position.                               *
      *  106567 - RECI of BPACHD is being corrupted and caused SE0740 *
      *           file control out of balance for BPACHD.             *
      *  CSE005 - Effect of holidays on FRN Coupon Dates:             *
      *           declare SITP before calling amended SRs ZNCD/ZLCD,  *
      *           and SR ZACCR amended.                               *
      *  111157 - Remove 055893                                       *
      *  CAC002 - Profit Centre Accounting Development - Phase 2      *
      *           If Analytical Accounting is available, define the   *
      *           profit centre for posting.                          *
      *  109565 - If Portfolio is 9997 equivalent use this for SEKEY  *
      *  S01408 - Addition of core hook SE2220FFP1
      *           Addition of core hook SE2220CP10
      *           Addition of core hook SE2220CCP9
      *           Addition of core hook SE2220CCP8
      *           Addition of core hook SE2220CCP7
      *  091803 - DO UNREALISED PROFIT/LOSS PROCESSING WHEN MARKET    *
      *           PRICE EXISTS AS ZERO.                               *
      *  090364 - Output key for interest discrepancy then            *
      *           reset Adjustments (accumulated) to zero when        *
      *           Nominal Position goes flat.                         *
      *  090108 - INPUTS OF PRICE CHANGE SHOULD NOT GENERATE          *
      *           ACCRUED INTEREST POSTING.                           *
      *  084704 - RECOMPILE OVER CHANGED ZYLDZ2 SUB.                  *
      *  083039 - RECOMPILE OVER CHANGED ZYLDZ2 SUB.                  *
      *  059110 - Recompile over changed ZYLDZ2 sub.                  *
      *  088047 - RECOMPILE over change SR/ZYLDZ2.                    *
      *  100228 - RECOMPILE OVER CHANGED ZDYYRZ3, ZLCDZ1 & ZNCDZ3.    *
      *  100100 - On the maturity of a security, the 'RP' key with a  *
      *           forward value date and an unwanted 'AI' key (as a   *
      *           result of a M-M) were incorrectly generated.        *
      *  103176 - Partly paid A/C Keys are produced twice (on both    *
      *           Value and Trade Date positions). Should be on Trade *
      *           date or on Suppressed keys value date SKDT.         *
      *  097328 - Zeroise ARPC if trading on a flat position.         *
      *  049865 - PGM LOOPS IN ZACCR                                  *
      *           DO NOT CALCULATE ACCRUALS IF IRATE = 0              *
      *  040431 - Split of accrued interest not correct for           *
      *           Schuldschein (Long to short & short to long)        *
      *  S01408 - Addition of core hooks: SE2220CCP1                  *
      *                                   SE2220CCP2                  *
      *                                   SE2220CCP3                  *
      *                                   SE2220CCP4                  *
      *                                   SE2220CCP5                  *
      *                                   SE2220CCP6                  *
      *  076681 - FOOB in SE0740. A record on BPACHD with RECI '*'.   *HD.
      *           Applied B9089  from GEMS.                           *
      *  099591 - Double counted PP Call for calculation of APNC      *
      *  099886 - Rounding problem for partly paid securities.        *
      *           Recompile over amended standard subroutine ZACCZ.   *
      *  100017 - Position settlement unable to pick up day adj. on   *
      *           SECTYD. Change subroutine to use DADJN to stop      *
      *           interest day adjustment being used for amortisation.*
      *           Recompile over amended subroutine ZDAYS.            *
      *  099384 - Negative position in PP Call account key is being   *
      *           produced even if position is long.                  *
      *  101037 - Unable to reconcile the value date used for accrual *
      *           interest during reversal and forward run after      *
      *           back-value action.  Program changed to used accrual *
      *           end date/end date-1 for first day accrue.           *
      *  101300 - Incorrect current factor is used for trade date     *
      *           action - program changed to use current factor as   *
      *           at value date of trade.                             *
      *  CPM004 - Bank Portfolios                                     *
      *  092961 - Recompile over ZDAYSZ2 which was amended by 086491  *
      *           (Wrong number of days calculated for day basis 1    *
      *           when start or end day is last day of February)      *
      *  091254 - RECOMPILE OVER CHANGED ZLCDZ1 & ZNCDZ3              *
      *  056394 - Ex-coupon nominal position should be reset          *
      *           on accruals following a coupon date.                *
      *  061822 - Discount amortization wrong if back-valuation to    *
      *           position change date (eg coupon date, rate change   *
      *           date) equal to last amortized to date (LATD)        *
      *  031177 - RP/RL incorrect on a sale.                          *
      *  086491 - Wrong nbr of days calculated for day basis 1        *
      *           when start or end day is last day of February       *
      *           Recompiled for ZSRSRC/ZDAYSZ2 changes.              *
      *  S01486 - Incorporation of PM Enhancement  (S01235).          *
      *  S01502 - BLI TELEKURS PROCESSING, RECOMPILED DUE TO CHANGE   *
      *           IN LENGTH OF SESTAT, 133 LONG.                      *
      *  064575 - Recompiled over amended ZYLDZ2 subroutine.          *
      *  065301 - Recompiled over changed copy source ZACCR subr.     *
      *           with ZAMT increased to 15,0.                        *
      *  055950 - Recompiled over changed ZAPORTZ1.                   *
      *  052480 - There is no record in BKMTHD of realised P/L due to *
      *           mortgaged backed securites repayments. Solution is  *
      *           update Realised P/L in BKMTHD after generating key. *
      *  051044 - Purchased interest must be zeroized on BKPOSD when  *
      *           trading again on a flat position (applied 050598)   *
      *  055893 - Don't stop amortizing after coupon date for AU yield*
      *  054257 - RECOMPILED as PREV CURRENT FACTOR amended from 9,8  *
      *           to 10,9                                             *
      *  053703 - 0.01 DISCREPANCY ON DISCOUNT AMOUNT.                *
      *  051339 - FACE VALUE/REALIZED P/L KEYS NOT PRODUCED           *
      *  052254 - CURRENT FACTOR amended from 9,8 to 10,9             *
      *  052573 - Premium/Discount key calculated incorrectly on      *
      *           trade date for processing type '8'. Current Factor  *
      *           for Mortgage backed security not taken into         *
      *           account when calculating posting amount.            *
      *  S01401 - MT5xx SWIFT Messages Feature:                       *
      *           - Recompiled due to changes to files.               *
      *  E39495 - New /COPY subroutime ZCALCD added (called from      *
      *           SR. ZYLD)                                           *
      *         - Recompiled over changed ZYLDZ2                      *
      *  047922 - Recompiled over changed SR/ZYLDZ2.                  *
      *  047370 - PREMIUM/DISCOUNT KEY CALCULATED WRONGLY ON TRADE DTE*
      *  S01397 - Rel 10 Incorporation of BNZ SARs A46008 and A46013. *
      *         - Added processing for Discount/Premium since First   *
      *           Position Date for Amortisation by Security Report   *
      *         - Recompiled for New Zealand Bond Formula             *
      *  E38721 - Today's Profit in Trading Position is equal to 0.   *
      *           Problem was resolved to produce today's profit if   *
      *           profit basis in ICD = 'B'.                          *
      *  E40426 - Only access Book Positions Profit Centres PF/SEPCBD *
      *           if Profit Centres used and Trade and Book Positions *
      *           are to be reconciled.                               *
      *  E38112 - Yield-based security was marked to market when at a *
      *           profit, but should have done so at a loss only      *
      *  E37811 - For a price change need to output the realised      *
      *           profit and loss                                     *
      *  E37180 - Only update BPIT on BKMTHD if reversed trade was    *
      *           entered previous month and action date is prev mnth *
      *  E36391 - Face value keys on mortgage repayments are not      *
      *           based on the correct change in current factor.      *
      *  E36622 - Incorrect PI and AI keys when position goes from    *
      *           short to long                                       *
      *  E36547 - Discount not reversed properly on backvaluation to  *
      *           a date later than the last position date            *
      *  E34618 - Accrual keys produced when not wanted.  Caused by   *
      *           R10 changes.                                        *
      *  E34532 - Accrual keys produced when not wanted.  Further to  *
      *           and caused by E23987                                *
      *  E32464 - Discount Amortisation                               *
      *           Error in Amortisation when trades are deleted and   *
      *           backvalue trades are re-input.                      *
      *  E29170 - Report Control Facility changes                     *
      *  E27934 - Recompiled over the changed version of ZACCRZ1      *
      *  E29207 - Discount amortization                               *
      *           - Amortization wrong if back-valuation done prior   *
      *             to LATD but after LPCD. (No records are read into *
      *             the reversal run of SE2220 as there are no actions*
      *             to reaction.Solved by generating dummy actions).  *
      *           - Amortization wrong if first day accruals          *
      *           - Amortization wrong if trade deleted.              *
      *           - Trading again on a flat position causes           *
      *             discount amortization to be wrong.                *
      *  E29236 - Partly paid securities                              *
      *           - Problems with back-valuation                      *
      *           - Problems with discount amortization               *
      *           - 2 keys produced on part payment, should only be 1 *
      *  E29244 - Spurious postings on a coupon date                  *
      *  E29246 - Mark to market is not generating realized P/L keys. *
      *  E27092 - Recompiled over changed SR/ZLCD                     *
      *  S01117 - Multibranching                                      *
      *  S01195 - New holiday processing                              *
      *  E23987 - Incorrect Interest Accrued on Coupon date for       *
      *           ex-dividend trades.                                 *
      *  S01269 - Trade authorisation: recompile over changed file    *
      *           TABSE.                                              *
      *  S01288 - Lower of Book or Market price on Mark to Market     *
      *           Revaluation.                                        *
      *  E23748 - Erroneous Accrual key produced after Coupon Event   *
      *  E23747 - Liquidation of a position causes DB Error in SE0740 *
      *         - Reversal indicator missed from key to BPACC causing *
      *           wrong record to be updated and dup keys on BKPHH    *
      *  E22957 - BOOK POSITION REVIEW                                *
      *         - Remove dependence upon LAVP for P&L and Amort.      *
      *         - Run Fwd Accruals/Amortisation upto Last ACPD        *
      *         - Amortise upto Partly Paid percentage                *
      *         - Maintain Unamortised Value date Cost price          *
      *         - Unrealised P&L on APDA only done in SE2210          *
      *         - Aust Price not calculated properly                  *
      *         - ZYCE does not work on 'Business Days' Formula       *
      *         - BKPHHD re-Keyed LPSD                                *
      *         - remove ex-coupon calc.in cum coupon Period (AUS.YLD)*
      *         - When PI is being apportioned result was truncated   *
      *         - Suppress RP and RL key generation if trade date     *
      *           entries suppressed                                  *
      *         - BKPHDD record can exist with no BKPOSD rec (SE2230) *
      *         - Post PP Called amount not Total Called Amount       *
      *         - LPCD now NOT maintained in SE2210 (uses ICLD)       *
      *         - BPIT - PI reversed this month was not output (BKMTH)*
      *         - SECEO Diary events did not use SOBSND in Rev. Mode) *
      *  E23184 - Recompiled over the changed HTRACB.                 *
      *  E21574 - Incorrect figures on BKPHH causing several problems,*
      *           including DB errors due to corruption of LPSD.      *
      *  E21546 - Interest Adjustment on Position, (INDO on BKPHDD),  *
      *           must be zeroed on Coupon Date. (Was only partially  *
      *           done during System Testing).                        *
      *  E21545 - Mishandling of a Reversal Action in SR/CLOSE led to *
      *           a Database Error during a subsequent liquidation.   *
      *  E21539 - Error in Case 6 of SR/PIAI: Zero Purchased Interest *
      *           calculated for a Sale against a Flat Position.      *
      *  E21535 - Price Change Actions updated randomly selected Trade*
      *           Actions due to failure of S01129 to set up KLIST.   *
      *  E21603 - PP Amount 100 times too much for a Share.           *
      *  E21670 - If doing Trade Date Accounting and wish to suppress *
      *           Value Date Keys, Pr and DS Keys must still be posted*
      *           as no Discount Accruals are performed on Trade Date *
      *           Basis. However if suppressing Trade Date entries, PR*
      *           and DS Keys must be suppressed.                     *
      *  E21531 - Suppress Unrealized P/L Keys in Reversal mode. They *
      *           were wrong, and served no real purpose since SE2210 *
      *           and Forward run of SE2220 will adjust Unrealized P/L*
      *           Note:                                               *
      *           - This fix has to be applied with E19445 (SE2220).  *
      *           Also:                                               *
      *           - Wrong Value Date on Unrealized P/L Postings.      *
      *  E21608 - Average Price was corrupted after Amortization.     *
      *  E21668 - Recompiled over changed SR/ZYLDZ2.                  *
      *  E21616 - Recompiled over changed SR/ZLCD.                    *
      *  E21429 - Problems with 'DI' and 'DF' keys for Coupon Action  *
      *           on flat position.                                   *
      *  E21355 - Remove coding to accrue for trades backvalued into  *
      *           a previous month - it is unnecessary and causes loop*
      *  E21304 - Use Last Coupon Date as Start Date for Schuldschein *
      *           Accrued Interest if it is greater than Last         *
      *           Position Date.                                      *
      *  E21240 - Realised Profit/Loss in Error.                      *
      *  E21232 - Reversal of Interest Accruals Incorrect.            *
      *  E21225 - Do Not Suppress Discount Accruals.                  *
      *  E21130 - Post negative 'PA' keys when necessary.             *
      *  E21113 - Trade date P&L wrong while Value Date P&L Correct.  *
      *  E21097 - Rounding Error in calculation of Average Price.     *
      *  E21084 - More Australian Yield/Amortization fixes.           *
      *  E20651 - DB Error Numbers used in more than one place.       *
      *           New Error Numbers as follows:                       *
      *           DB ERROR 17 -> 20                                   *
      *           DB ERROR 17 -> 21                                   *
      *  E20993 - Reverse out amortization done to last accrual date  *
      *           if backvaluation done prior to this date but not    *
      *           prior to the Last Position Date.                    *
      *  E20986 - Add new key field on BPACC to key list for chain to *
      *           prevent looping.                                    *
      *  E20953 - Use consistent method to calculate interest for use *
      *           in Australian Price/Yield conversion.               *
      *  E20958 - Partly paid calls for unit priced securities were   *
      *           out by a factor of 10 when updating LAVP.           *
      *  E20960 - 'DS' or 'PR' a/c keys wrong when NPAC is 'N' and    *
      *           position goes from long to short or vice-versa, and *
      *           position stays at discount or at premium.           *
      *  E20921 - On change from discount to premium or vice-versa,   *
      *           old amount must be reversed out with negative amount*
      *           on 'DS' or 'PR' account key.                        *
      *  E20896 - Use new av. price to calculate discount to amortize *
      *           when changing for premium to discount or vice-versa.*
      *  E20732 - For a price change, LAVP should be passed to HCNTP  *
      *           since BCPR is in Price/Discount/Yield form.         *
      *  E20785 - For a price change, HTBKEY must be updated with     *
      *           date and reference fields else it only updates the  *
      *           first record.                                       *
      *  E20620 - In reversal mode subtract Mark to Market Profit.    *
      *  S01232 - Australian Yields Modification.                     *
      *  S01233 - Australian modifications for Amortization of        *
      *           Premium/Discount (Yield curve basis).               *
      *  E20232 - Truncation due to a common method of calculation    *
      *           in this program.                                    *
      *  E20552 - Policy decision to remove the new coding for the    *
      *           Amortization of Discount on a Trade Date Basis.     *
      *  E20568 - ZACCZ changed to read non-diary events file -       *
      *           renamed record format of SECEO.                     *
      *  E20475 - Do not add mark to market revaluation profits into  *
      *           realised profit.                                    *
      *  E20191 - Mixup between charges and commission fields.        *
      *  E20492 - Reverse sign on ex-coupon trade 'AI' keys.          *
      *           Also update 'AI on ex-coupon position' field on     *
      *           BKPHDD.                                             *
      *  E20380 - Problems with ZYLD for Div basis 5, CALL ZLCDZ1.    *
      *  E20427 - FIFO Purchase interest is being used (zero) on      *
      *           Sale when Previous Nominal Position is zero, and    *
      *           CLOSE has not been called.                          *
      *  E20384 - Book month records are being generated when a new   *
      *           position is processed i.e. stored key is not equal  *
      *           current key.BKMTH key is generated from the stored  *
      *           key fields except for the EOM date which is being   *
      *           incorrectly generated from the current position date*
      *           and not the stored position date.                   *
      *  E20018 - The Average price is corrupted in CLOSE by          *
      *           Charges, Commissions and Reallowance.               *
      *  E20125 - Various Cargill Fixes that have no other number:    *
      *           - E15746 does not reverse the sign if negative      *
      *             Dividend Amount and SNAC = 'Y'.                   *
      *  E20144 - I/O error attempting to access a record already     *
      *           allocated to the job via another access path.       *
      *           Solution to any locking - release BPACC after the   *
      *           read and then chain it back before update.          *
      *  E20149 - Rounding error in calculating Average Price.        *
      *  E19429 - Must consider first-day accruals when converting a  *
      *           market yield to percentage price for unrealized P/L.*
      *  E19397 - Incorrect posting basis on unrealized P/L keys.     *
      *  E19485 - In reversal mode, RPTM and DPTM on BKMTH must be    *
      *           adjusted to reflect backvaluations/reversals.       *
      *           (Reversals caused incorrect reporting of realized   *
      *           P/L and amortized discount).                        *
      *           And:                                                *
      *           - Since RPTM is now adjusted in reversal mode,      *
      *             there's no longer any need to back out realized   *
      *             profit from BPACHD records in forward mode.       *
      *  E19445 - Errors on unrealized profit/loss keys:              *
      *           - Backvaluations caused redundant posting of        *
      *             unrealized profit/loss amounts.                   *
      *           - Incorrect event code on account key when unreal-  *
      *             ized profit on a holding goes from positive to    *
      *             zero.                                             *
      *  E19494 - For flat positions, Avg. Price fields should be 0.  *
      *  E19433 - E15746 uses SNAC for Unrealized P/L - it should use *
      *           NPAC. Also, corrected long to short and vice versa. *
      *  E19411 - With E15549 in, E15564 only works if RPBS = 'B'.    *
      *  E20087 - Discount Amortization Processing:                   *
      *           - It has been necessary to remove E18651 to apply   *
      *             these fixes. Some of it may need to be put back   *
      *             at a later stage.                                 *
      *           - Last Change Date is not updated with Last Position*
      *             Date for Trade Actions, which causes Amortization *
      *             of Discount on today's Trades.                    *
      *           - Must accumulate discount/premium amortized this   *
      *             month so that the Monthly Profitability Report    *
      *             may properly reflect interest income/expense.     *
      *           - Must perform amortization processing for trade    *
      *             date positions to obtain correct average prices.  *
      *             BUT, exclude Trades which have not reached Value. *
      *           - SR/CLOSE calculating incorrect realized           *
      *             profit/loss for discounted instruments.           *
      *           - SR/UNRLPL used wrong date when converting a market*
      *             discount rate to a percentage price.              *
      *           - In reversal mode, must produce account key to     *
      *             reverse out amortization since LPSD.              *
      *           - Redundant amortization was performed in processing*
      *             an action for an existing Discounted Position.    *
      *           - Realized P/L on a Discounted Position was         *
      *             calculated incorrectly when a Trade liquidated    *
      *             portions of more than one Historic Trade.         *
      *           - If FIFO processing requested in ICD, must liqui-  *
      *             date Unamortized Discount (BUDU) on a FIFO Basis. *
      *  E20086 - Mortgage-Backs and Current Factor Processing Rewrite*
      *           - BCCN (orig calc ZCTRVZ1 by SE0050) must be net of *
      *             the Current Factor.                               *
      *           - Neg Ind of MP Key should be same as FV Key.       *
      *           - Do not Adjust MORT.PAYMENT by Current Factor.     *
      *           - Maintain Unamortized Discount/Premium, Discount/  *
      *             Premium Amortized sinc LPD, Average Price Numera- *
      *             tor and Unrealized Profit/Loss net of Current     *
      *             Factor.                                           *
      *           - Maintain Current Factor on BKPOSD - in field AAPR.*
      *           - Consideration calculated incorrectly. Should use  *
      *             Trade Price, not Book Price.                      *
      *  E20085 - Interest and Coupon Calculations Rewrite:           *
      *           - E18667 is wrong and done in wrong place - remove. *
      *           - Split Purchased/Sold Interest - on a FIFO basis,  *
      *             and output Purch. Int on Position to Action       *
      *             Record.                                           *
      *           - SR/ZACCZ rewritten to do the Interest Accrual     *
      *             calculations correctly.                           *
      *             File definitions added/amended for this purpose.  *
      *           - E15715 is far too specific - the DIV/MULT 1M trick*
      *             to retain accuracy in Interest calculations that  *
      *             could contain large numbers should be applied for *
      *             all currencies and all calculations of this type. *
      *           - BKMTHD fields are zeroed in BKPHD processing,     *
      *             which can have very bad results. Other serious    *
      *             errors in updating of fields on this file,        *
      *             (notably CPDD and BPIT) has been corrected.       *
      *           - If a Trade is backvalued into a previous month,   *
      *             the Tot Int on Posn as at EOM field (TIPN), needs *
      *             to be updated with the Interest Accrued from      *
      *             Value Date of Trade to EOPM. This is the only way *
      *             that the 'Interest Earned' calculation in SE0920  *
      *             can take account of this bit of Interest.         *
      *           - Interest Adjustment was just accumulated whether  *
      *             trade was Purchase or Sale, causing problems such *
      *             as incorrect Discrepancy Account Keys.            *
      *           - LF/SECEO member SEDEVD changed to omit RECI = 'C'.*
      *           - Case 2 of PI/AI Subroutine has a mistake in the   *
      *             FIFO updating of EVAM/PEVAM/WBCP1). This caused   *
      *             Proportional PI postings with AI adjustment.      *
      *           - FIFO Purchased Interest Calculations:             *
      *           - Now that LCCP has finally been added to HTRACB/T, *
      *             it must have override to XXLCCP.                  *
      *           - SR/CLOSE calcs shouldn't be condit'nd on H/ACRI=  *
      *             'C' as Flat Trades may have Interest. They should *
      *             be condit'nd on PI = 0, (and maybe HACRI='X' ???).*
      *           - NB that WBCP1/2 get set to Zero when appropriate. *
      *           - SR/CLOSE, 3rd section, intermediate step was being*
      *             conditioned incorrectly causing weird results.    *
      *           - SR/PIAI, FIFO calcs should be condt'nd on FIFO Ind*
      *             AND, WBCP1/2 MUST be used, even if they are zero. *
      *           - For Prop. Int., BCP1/2 should be updated correctly*
      *           - PI Keys may need to be produced for ACRI = 'F' as *
      *             well as 'C', so add to conditioning.              *
      *  E18803 - Set Account Key Sequence number to zero to allow    *
      *           for Multi-Branch Systems.                           *
      *  E18651 - Accrual Reversals.                                  *
      *  E18652 - Changes to process Trades done on Coupon Date.      *
      *  E18800 - Mark to Market P/L this month incorrectly set to    *
      *           zero on BKPHHD. (What about all the other BKMTH     *
      *           records incorrectly zeroed? - Done by E20085).      *
      *  E18668 - Purchased Interest wrong on Positions if Ex-Coupon  *
      *           or Sales Added/Subtracted instead of Subtracted/    *
      *           Added.                                              *
      *  E18667 - Purchased Interest always zero for Position in      *
      *           Profit Adjustment Report(SE0740).                   *
      *  E17686 - Remove duplicate code to process Amortization of    *
      *           Discount.                                           *
      *  E15950 - Monthly Profitability showed 0 for Realized         *
      *           Profit/Loss, even though the End of the Month run   *
      *           showed a different figure.                          *
      *  E16772 - The Dividend Payment Amount fields have been        *
      *           increased in size from 9,4 to 13,8. Hence the field *
      *           BBAU has been replaced by BBUN and BCAU by BCUN.    *
      *  E18009 - Recompile over correct SESTAT, 128 long.            *
      *  E15746 - Negative Position Indicators on Dividend and        *
      *           Unrealized Profit/Loss Account Keys should be 'N'   *
      *           for Short Positions if Negative Indicator requested *
      *           on the ICD.                                         *
      *  E16822 - Do not use Action Date from the Reversal Record.    *
      *  E16780 - Write out BKMTHD Record for next month when         *
      *           processing an Action Dated next month.              *
      *  S01176 - Release 3.1 Modifications.                          *
      *  E15965 - Mark to market revaluation                          *
      *  E14616 - Interest Accrual incorrect if Events of Type        *
      *           IR, PP, MP exist for Security during the Accrual    *
      *           Period.                                             *
      *  E15324 - Rename ALL fields from backvalued file to correspond*
      *           with field names used in the program                *
      *  E15564 - Failure to clear FIFO field RPLINC caused carryover *
      *           of realized P/L from one security to another.       *
      *  E15598 - Truncation of average price numerator caused        *
      *           inaccurate FIFO average price calculation.          *
      *  E15573 - Average prices for percentage-priced securities were*
      *           1/100th of correct values due to error in FIFO.     *
      *  E15715 - For some Yen Bonds the purchased interest was not   *
      *           being correctly calculated for update of BKPOSD.    *
      *           In some cases in SR/PIAI, nominal x purchase int.   *
      *           exceeds 15 characters, causing truncation and       *
      *           subsequent problems in the interest calculations.   *
      *  E15549 - 1.LAST COUPON DATE MUST BE FOR 'CURRENT' PERIOD     *
      *           2.ZEROIZE PURCH.INT/EX-COUPON NOMINAL WHEN          *
      *             CROSSING OVER A COUPON/DIV. DATE                  *
      *           3.ZEROIZE PURCHASED INTEREST ON COUPON DATE         *
      *           4.DIVIDEND AMOUNT NOT CORRECTLY EDITED              *
      *           5.PRODUCE P&L KEYS WHEN T/V KEYS SUPPRESSED         *
      *  E15442 - AVERAGE PRICE IS NOT BEING UPDATED BY AMORTISATION) *
      *           OF DISCOUNT,AMORTISED AMOUNTS ARE INCORRECT.        *
      *  E14235 - ERROR IN SR/ZNCD TO FETCH NEXT COUPON DATE. PROGRAM *
      *           RE-COMPILED TO ALLOW FOR NEW SUB-ROUTINE.           *
      *  E14236 - PROCESS MATURITY BOOK POSN. ACTIONS (TO REMOVE THEM)*
      *  E14680 - COUPON EVENTS ARE OUTPUT AS 'CP' RATHER THAN 'CO'   *
      *           ON NON-DIARY EVENTS FILE.                           *
      *  E14514 - RE-ALLOWANCE WAS NOT BEING INCLUDED IN THE          *
      *           AVERAGE PRICE FOR SECURITIES, EVEN THOUGH REQUESTED *
      *           IN THE ICD.                                         *
      *  E13817 - PROGRAM RESUPPLIED FROM JULIUS BAER, S01129 FIXES   *
      *           RE-ANNOTATED INTO NEW SOURCE.                       *
      *  S01129 - FIXES SUPPLIED BY MARKETING.                        *
      *                                                               *
      *****************************************************************
      *
     F*BPACC**UF**E           K        DISK         KINFDS BPADS          168141
     F************                                  KINFSR BPASR          168141
     FBPACC   IF  E           K        DISK                               168141
     FBPACCU  UF  E           K        DISK         KINFDS BPADS          168141
     F                                              KINFSR BPASR          168141
     F            BPACCDF                           KRENAMEBPACDFX        168141
     F            BPACBDF                           KRENAMEBPABDFX        168141
     F            BPACHDF                           KRENAMEBPAHDFX        168141
     FBPACCA  IF  E           K        DISK
     FBPACBA  IF  E           K        DISK
     FBPACHA  IF  E           K        DISK
     FBKPHD   UF  E           K        DISK         KINFDS BKHDS A
     F                                              KINFSR BKHSR
     FBKPHDA  UF  E           K        DISK         KINFDS BHADS
     F                                              KINFSR BHASR
     FBKPOS   UF  E           K        DISK         KINFDS BKPDS A
     F                                              KINFSR BKPSR
     FBKPOSA  UF  E           K        DISK         KINFDS BKADS
     F                                              KINFSR BKASR
     FBKPOP   IF  E           K        DISK                                                   246619
     F            BKPOSDF                           KRENAMEBKPOPDF                            246619
     FBKMTH   UF  E           K        DISK         KINFDS BKMDS A
     F                                              KINFSR BKMSR
     FBKMTHA  UF  E           K        DISK         KINFDS BMADS
     F                                              KINFSR BMASR
     FSEPCBD  IF  E           K        DISK                               S01117
     FPRICED  IF  E           K        DISK                               091803
     FBOOKD   IF  E           K        DISK
     FSECTY   IF  E           K        DISK
     FINVTP   IF  E           K        DISK
     F***SEDEV***IF**E***        K        DISK                            E20085
     FSECED   IF  E           K        DISK
     F*********** SEDEVDF                           KRENAMESEDEVD1F       E20085
     F***SECET***IF**E***        K        DISK                     E14616 E20085
     F*********** SEDEVDF                           KRENAMESEDEVDF2 14616 E20085
     FSECEO   IF  E           K        DISK                               E20085
     F            SEDEVDF                           KRENAMESEDEVDO        E20085
     F*********** SNDEVDF                           KIGNORE        E20085 E20568
     F            SNDEVDF                           KRENAMESNDEVDO        E20568
     FCLINT   IF  E           K        DISK
     F            CLINTCAF                          KIGNORE
     F            CLINTCBF                          KIGNORE
     F            CLINTC1F                          KIGNORE
     F            CLINTCCF                          KIGNORE
     F***TRADS***IF**E           K        DISK                      E20086E36391
     FTRADS   IF  E           K        DISK                               101300
     F*TRDMTHT*IF**E           K        DISK                       E20087 E20552
     F************TRADSDF                           KRENAMETRDMTHF E20087 E20552
     F***ACT  IF  E           K        DISK                               S01129
     FHTRACT  UF  E           K        DISK                               S01129
     F            BPACCDF                           KRENAMEBPACCH1F
     F            BPACBDF                           KRENAMEBPACBH1F
     F            BPACHDF                           KRENAMEBPACHH1F
     FHTRACB  IF  E           K        DISK
     F            BPACCDF                           KRENAMEBPACCH2F
     F            BPACBDF                           KRENAMEBPACBH2F
     F            BPACHDF                           KRENAMEBPACHH2F
     FHTRACBX UF  E           K        DISK                               S01129
     F            BPACCDF                           KRENAMEBPACCH3F       S01129
     F            BPACBDF                           KRENAMEBPACBH3F       S01129
     F            BPACHDF                           KRENAMEBPACHH3F       S01129
     FBKPHH   O   E           K        DISK         KINFDS HHDDS
     F                                              KINFSR HHDSR
     F            BKPHDDF                           KRENAMEBKPHHDF
     FBKPHHA  UF  E           K        DISK         KINFDS HHADS
     F                                              KINFSR HHASR
     FBSPOSDL0UF  E           K        DISK                               CSE006
     FSEKEYD  O   E           K        DISK         KINFDS SKDDS
     F                                              KINFSR SKDSR
     FSEKEYA  O   E           K        DISK         KINFDS SKADS
     F                                              KINFSR SKASR
     FSEDEVAL1IF  E           K        DISK                                                   CSE065
     F            SEDEVDF                           KRENAMESEDEVDAL                           CSE065
     FSE2220AUO   E                    PRINTER
     F***TABICD  IF  E           K        DISK                            S01232
     F* ICD 1     TABTB10F                          KIGNORE               S01232
     F* ICD 2     TABTB11F                          KIGNORE               S01232
     F**********  TABTB20F                          KIGNORE               S01232
     F**********  TABTB30F                          KIGNORE               S01232
     F**********  TABTB35F                          KIGNORE               S01232
     F* ICD SE    TABTB36F                          KIGNORE               S01232
     F**********  TABTB40F                          KIGNORE               S01232
     F**********  TABTB50F                          KIGNORE               S01232
     F**********  TABTB55F                          KIGNORE               S01232
     F**********  TABTB70F                          KIGNORE               S01232
     F**********  TABTE10F                          KIGNORE               S01232
     F**********  TABTE20F                          KIGNORE               S01232
     F* CURRENCY  TABTG10F                          KIGNORE               S01232
     F**********  TABTG20F                          KIGNORE               S01232
     F**********  TABLETHF                          KIGNORE               S01232
     F**********  TABLETRF                          KIGNORE               S01232
     F**********  TABLETXF                          KIGNORE               S01232
     F**********  TABLET5F                          KIGNORE               S01232
     F**********  TABLETAF                          KIGNORE               S01232
     FTABSE   IF  E           K        DISK                               S01232
     F            TABLETAF                          KIGNORE               S01232
     F* ICD 1 *** TABTB10F                          KIGNORE               S01232
     F* ICD 2 *** TABTB11F                          KIGNORE               S01232
     F* ICD SE ** TABTB36F                          KIGNORE               S01232
     F* ICD 5 *** TABTB40F                          KIGNORE        S01232 E40425
     F            TABTE10F                          KIGNORE               S01232
     F            TABTE20F                          KIGNORE               S01232
     F* CCY ***** TABTG10F                          KIGNORE               S01232
     F            TABTG20F                          KIGNORE               S01232
     F            TABLETHF                          KIGNORE               S01232
     F* HOLS **** TABLETJF                          KIGNORE               S01232
     F            TABLETKF                          KIGNORE               S01232
     F            TABLETLF                          KIGNORE               S01232
     F            TABLETNF                          KIGNORE               S01232
     F            TABLETPF                          KIGNORE               S01232
     F* BRANCH ** TABLETRF                          KIGNORE               S01232
     F            TABLETXF                          KIGNORE               S01232
     F            TABLET2F                          KIGNORE               S01232
     F            TABLET3F                          KIGNORE               S01232
     F            TABLET5F                          KIGNORE               S01232
     F*
     F*                                                                   S01408
     F/COPY WNCPYSRC,SE2220FFP1                                           S01408
     F*                                                                   S01408
     F*****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  F U N C T I O N   O F   I N D I C A T O R S                  *
      *                                                               *
      *   01  -  BPACCD READ )                                        *
      *   02  -  BPACBD READ ) FROM BPACC                             *
      *   03  -  BPACHD READ )                                        *
      *   04  -  BPACCD READ)                                         *
      *   05  -  BPACBD READ) FROM HTRACT                             *
      *   06  -  BPACHD READ)                                         *
      *   07  -  BPACCD READ )                                        *
      *   08  -  BPACBD READ ) FROM HTRACB                            *
      *   09  -  BPACHD READ )                                        *
      *   10  -  BOOK POSITION HEADER NOT FOUND                       *
      *   11  -  BOOK POSITION NOT FOUND                              *
      *   12  -  BKMTHD RECORD PRESENT                                *
      *   13  -  BPACCD READ )                                        *   S01129
      *   14  -  BPACBD READ ) FROM HTRACBX                           *   S01129
      *   15  -  BPACHD READ )                                        *   S01129
      *   19  -  TRADE ACTIONS HAVE BEEN PROCESSED ON THIS POSITION   *   S01129
      *   20  -  ACTION HAS BEEN PROCESSED                            *
      *   21  -  TRADE ACTIONS HAVE BEEN PROCESSED ON THIS POSITION   *
      *   22  -  ONE ACCOUNT KEY IS REQUIRED                          *
      *   23  -  TWO ACCOUNT KEYS ARE REQUIRED                        *
      *   24  -  REALPL CALLED FROM P10                               *
      *   25  -  REALPL CALLED FROM P60                               *
      *   28  -  AVERAGE PRICE CHANGED FROM DISC/PREM OR PREM/DISC    *
      *   29  -  AVERAGE PRICE HAS REMAINED LONG(+VE) OR SHORT(-VE)   *
      *   30  -  NOMINAL POSITION HAS REMAINED LONG OR SHORT          *
      *   31  -  NONINAL POSITION HAS CHANGED LONG/SHORT OR SHORT/LONG*
      *   32  -  TRADE IS SALE,NEW NOMINAL LONG OR TRADE IS PURCHASE, *
      *           NEW NOMINAL SHORT                                   *
      *   33  -  TRADE IS SALE,NEW NOMINAL SHORT OR TRADE IS PURCHASE,*
      *          NEW NOMINAL LONG                                     *
      *   34  -  TRADE IS SALE,OLD NOMINAL LONG OR TRADE IS PURCHASE, *
      *          OLD NOMINAL SHORT                                    *
      *   36  -  TRADE IS SALE,OLD NOMINAL SHORT OR TRADE IS PURCHASE,*
      *          OLD NOMINAL LONG                                     *
      *   37  -  OLD AND NEW UNREALISED P/L BOTH +VE OR BOTH -VE      *
      *          AND old and new nominal both positive or both negativ*   E19433
      ****39**-**PORTFOLIO*MANAGEMENT*INDICATOR********************S01486 CPM004
      ****40**-**SECURITY*EVENT*LESS*THAN*OR*EQUAL*TO*NCD**************   E20085
      ****41**-**BYPASS*FIRST*EVENT*RECORD*****************************
      *   41  -  NOMINAL CHANGES CASE 1 (P10)                         *
      *   42  -  NOMINAL CHANGES CASE 2 (P10)                         *
      *   43  -  NOMINAL CHANGES CASE 3 (P10)                         *
      *   44  -  CUM-COUPON NOMINAL CHANGES CASE 1 (P10)              *
      *   45  -  CUM-COUPON NOMINAL CHANGES CASE 2 (P10)              *
      *   46  -  CUM-COUPON NOMINAL CHANGES CASE 3 (P10)              *
      *   48  -  NO RECORDS IN PRICED FILE                            *   091803
      *   49  -  NO PRICE RECORD EXISTS FOR A SECURITY                *   091803
      *   50  -  FILE AND CALCULATED TOTALS DISAGREE - BPACCD         *
      *   51  -  FILE AND CALCULATED TOTALS DISAGREE - BPACBD         *
      *   52  -  FILE AND CALCULATED TOTALS DISAGREE - BPACHD         *
      *   53  -  AUSTRALIAN YIELD TRADED SECURITY                     *   S01232
      ****69**-**ONE*TIME*INDICATOR*IN*MAIN*PROCESSING*****************   E20085
      *   70  -  NOMINAL CURRENCY DECIMAL PLACES IS 0                 *
      *   71  -  NOMINAL CURRENCY DECIMAL PLACES IS 1                 *
      *   72  -  NOMINAL CURRENCY DECIMAL PLACES IS 2                 *
      *   73  -  NOMINAL CURRENCY DECIMAL PLACES IS 3                 *
      ****76**-**INTEREST*CHANGES*IN*COUPON*PERIOD*********************   E20085
      ****77**-**SECURITY*DIARY*RECORD*READ****************************   E20085
      *   79  -  EOF on READ/READP of SEDEVAL                                                 CSE065
      *   80  -  ERROR ON CHAIN PROCESS                               *
      *   81  -  USED IN Z-SUBROUTINES                                *
      *   82     CURRENT FIFO TRADE FOUND FOR THIS POSITION           *   E20087
      *   83     END OF FORWARD TRADES FOR THIS POSITION              *   E20087
      *   85  -  EOF ON READE OF HTRACB                               *
      *   86  -  ERROR ON CHAIN TO HTRACB                             *
      *   87  -  ERROR ON CHAIN TO HTRACT                             *
      ****88**-**END*O *FILE*ON*SEDEV**********************************   E20085
      *   88  -  CHAIN-FOR-UPDATE ON BPACC FAILED.                    *   E20144
      *   89  -  END OF FILE ON BPACC                                 *
      *                                                               *
      * 90-99 -  USED IN Z-SUBROUTINES                                *
      *                                                               *
      *   U1  -  REVERSAL MODE                                        *
      * U7-U8 -  DATABASE ERROR                                       *
      *   U8  -  CONTROL TOTALS OUT OF BALANCE                        *
      *                                                               *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  S U B R O U T I N E   I N D E X                              *
      *                                                               *
      *  FIRST  - ACCESSES INFO FROM ICD,ICD2 AND ICDSE               *
      *  BKSET  - SETS UP FIELDS FOR CALCULATION IF RECORDS NOT FOUND *
      *  P05    - PROCESSES PP CALL ACTIONS                           *
      *  P06    - Processes Calculation of Book Value Change          *                       CSE065
      *  P07    - Processes Calculation of Equity Amount              *                       CSE065
      *  P10    - PROCESSES TRADE ACTIONS                             *
      *  P20    - PROCESSES MORTGAGE PAYMENT ACTIONS                  *
      *  P30    - PROCESSES COUPON ACTIONS                            *
      *  P35    - PROCESSES DIVIDEND ACTIONS                          *
      *  P50    - PROCESSES INTEREST RATE CHANGE ACTIONS              *
      *  P60    - PROCESSES AVERAGE PRICE CHANGE ACTIONS              *
      *  P70    - PROCESSES MATURITY DATE ACTIONS                     *   E14236
      *  P80    - Processes Amortisation on End of Average Life Date  *                       CSE065
      *  AMORT  - AMORTIZES DISCOUNT/PREMIUM                          *
      *  AAMORT - AMORTIZES DISCOUNT/PREMIUM ON A YIELD CURVED BASIS  *   S01233
      *  AMORSL - Calculate Amortisation (Straight Line Method)       *                       CSE065
      *  AAMORC - Calculate Amortisation (Constant Yield Method)      *                       CSE065
      *  AMTPL  - CALCULATE AMORTISED PROFIT/LOSS FOR BUY-SELL TRADES *   CSE006
      *  CALPL  - CALCULATE P/L FOR B/S TRADES  FOR AMORTISATION      *   CSE006
      *  BSPLS  - CALCULATE P/L FOR B/S TRADES                        *   CSE006
      *****AMORTR**-**In*reversal*mode,*generates*reversal*key*for*E20087 E22957
      ****************amortization*done*since*Last*Position Date.**E20087 E22957
      ***ADJBUD*-*Adjusts*unamortized*discount*for*trade*date***** E20087 E20552
      ************positions*with*outstanding*forward*trades.****** E20087 E20552
      *  ACCRUE - CALCULATES ACCREUD INTEREST UP TO DATE              *
      ***ACCRX**-*CALCULATES*EX-COUPON*ACCRUAL*************************
      ***INTCPN*-*CALCULATES*EX-COUPON*ACCRUAL*************************
      *  FVAL   - PRODUCES FACE VALUE ACCOUNT KEYS                    *
      *  CONS   - PRODUCES CONSIDERATION ACCOUNT KEYS                 *
      *  CLOSE  - ACCESSES HISTORIC ACTIONS FOR TRADES TO BE CLOSED   *
      *  REALPL - PRODUCES REALIZED P/L ACCOUNT KEYS                  *
      *  AVPR   - CALCULATES AVERAGE PRICE                            *
      *  AVPRAM - UPDATES AVERAGE PRICE AFTER AMORTIZATION            *   E15442
      *  DSPRT  - PRODUCES DISCOUNT/PREMIUM KEYS FOR TRADE DATE       *
      *  DSPRV  - PRODUCES DISCOUNT/PREMIUM KEYS FOR VALUE DATE       *
      *  PIAI   - PRODUCES PURCHASED/ACCRUED ACCOUNT KEYS             *
      *  PI     - PRODUCES PURCHASED INTEREST ACCOUNT KEYS            *
      *  UNRLPL - CALCULATES UNREALIZED P/L AND PRODUCES ACCOUNT KEYS *
      ***ADJUPL*-*Unrealized*P/L*for*discounted*'T'*positions.**** E20087 E20552
      ***ACCUM**-*Accumulates*trade*details*for*SR/ADJUPL.******** E20087 E20552
      *                                                               *   E40426
      *  W01    - OUTPUTS ACCOUNT KEYS TO SEKEYD                      *
      *  W02    - OUTPUTS A NEW BOOK POSTION RECORD                   *
      *  W03    - OUTPUTS A NEW BOOK POSITION HEADER RECORD           *
      *  W04    - OUTPUTS A BOOK POSITION MONTHLY STATISTICS RECRD    *
      *  W05    - OUTPUTS A HISTORIC BOOK POSITION HEADER RECORD      *
      *  W06    - Outputs Book Value Change and Equity Amount A/C Key *                       CSE065
      *  U01    - UPDATES ACTION RECORD                               *
      *  U02    - UPDATES BOOK POSITION HEADER RECORD                 *
      ***U03****-*UPDATES*BOOK*POSITION*RECORD*************************   E15965
      *  U04    - UPDATES A BOOK POSITION MONTHLY STATISTICS RECOR    *
      *  GETPPP - SUBROUTINE TO GET PARTLY PAID PRICE PRIOR TO ACTION.    E29236
      *  AUDIT  - PRODUCES CONTROL REPORT AND UPDATES AUDIT RECORD    *
      *                                                               *   E40426
      *  BKHCHN - CHAINS TO BOOK POSITION HEADER                      *
      *  BKPCHN - CHAINS TO BOOK POSITION                             *
      *  PPCCHN - CHAINS TO BOOK POSITION PROFIT CENTRE               *   S01117
      *  BOKCHN - CHAINS TO BOOK DESCRIPTION FILE                     *
      *  SECCHN - CHAINS TO SECURITIES FILE                           *
      *  INVCHN - CHAINS TO INVESTMENTS FILE                          *
      *  CLICHN - CHAINS TO CLIENT FILE                               *
      *  TABCHN - CHAINS TO TABTG10 FILE                              *
      *                                                               *
      ***XDATE3*-*WORKS OUT A NUMBER OF WORKING DAYS BACKWARDS *   S01232 S01117
      *  ZBKDT  - WORKS OUT A NUMBER OF WORKING DAYS BACKWARDS *   S01232 S01117
      *  ZACCR  - CALCULATES ACCRUED INTEREST                         *
      *  ZACCZ  - SUBROUTINE TO CALCULATE INTEREST ACCRUED ON A    E14616 E20085
      *           SECURITY (NOT SCHULDSHEIN) UP TO A SPECIFIED DATE 14616 E20085
      *  ZCALCD - Calculate long term CD price from yield             *   E39495
      *  ZCNSD  - CALCULATES AMOUNT FROM NOMINAL AND PRICE            *   E20232
      *  ZDATE1 - CONVERTS DATES TO DAYS                              *
      *  ZDATE2 - CONVERTS DAYS TO DATES                              *
      *  ZDAYS  - CALCULATES NO OF DAYS BETWEEN TWO DATES             *
      *  ZDYYR  - CALCULATES NO OF DAYS IN INTEREST YEAR              *
      *  ZD5DYS - TO CALCULATE NO OF DAYS IN INT. YEAR FOR DVBS 5.    *
      *  ZEVCD  - CALCULATES EVENT CONTROL DATE                       *
      *  ZICD2  - OBTAINS ICD2 INFO                                   *
      *  ZICDSE - OBTAINS ICDSE INFO                                  *
      *  ZLCD   - CALCULATES PREVIOUS COUPON DATE                     *   E20380
      *  ZNCD   - CALCULATES NEXT COUPON DATE                         *
      *  ZPRCI  - CONVERTS PRICE TO %PRICE                            *
      *  ZRATE  - CALCULATES EFFECTIVE RATE                           *
      *  ZSYSTM - OBTAINS ICD INFO                                    *
      *  ZYCE   - SET UP AUSTRALIAN YIELD CUM/EX PARAMETER            *   S01232
      *  ZYLDI  - OUTPUTS YIELD AS PERCENTAGE                         *
      *  *PSSR  - EXCEPTION ERROR ROUTINE                             *   S01117
      *                                                               *
      *****************************************************************
      /EJECT
     E                    CPY@    1   1 80
     E/COPY ZSRSRC,ZDAYSZ1
     E/COPY ZSRSRC,ZDATE2Z1
     E***/COPY*ZSRSRC,ZDATE6Z1                                     S01232 S01195
     E/COPY ZSRSRC,ZPOWER8Z1
     E/COPY ZSRSRC,ZNCDZ1
     E/COPY ZSRSRC,ZHASHZ1
     E/COPY ZSRSRC,ZHOLE                                                  S01195
     E                    WWARRZ  1   5  5                                CPM004
      /EJECT
     I*
     I* RECORD IDENTIFIERS
      ***  Read from LF/BPACC - 01, 02, 03.
     I*
     IBPACCDF     01
     I*
     I*   RENAME FIELDS USED ON BPACBD TO LOOK LIKE BPACCD AND BPACHD
     IBPACBDF     02
     I              BBSS                            BCSS
     I***********   BBBR                            BCBR                  S01117
     I              BBBA                            BCBA                  S01117
     I              BBMK                            BCMK
     I              BBBK                            BCBO
     I              BBAD                            BCAD
     I              BBED                            BCED
     I              BBAS                            BCAS
     I              BBTP                            BCTP                  E15324
     I              BBIT                            BCIT                  E15324
     I**************BBAU                            BCAU                  E16772
     I              BBUN                            BCUN                  E16772
     I              BBCA                            BCCP
     I              BBTA                            BCTA
     I              BBCF                            BCCF
     I              BBPC                            BCPC
     I              BBNC                            BCNC
     I              BBNR                            BCNR                  E15324
     I              BBOD                            BCOT                  E15324
     I              BBTV                            BCTV
     I              BBTR                            BCTR
     I              BBTS                            BCTS
     I              BBPS                            BCPS
     I              BBNM                            BCNL
     I              BBCN                            BCCN
     I              BBRA                            BCRA
     I              BBCC                            BCCC
     I              BBCT                            BCCT
     I              BBPT                            BCTD
     I              BBRI                            BCRV
     I              BBPR                            BCPR
     I              BBP1                            BCP1
     I              BBP2                            BCP2
     I              BBPL                            BCPL
     I              BBAP                            BCAT
     I              BBDV                            BCDV
     I              BBCOAF                          BCCOAF                CSE007
     I              BBPN                            BCPN                                      CAS006
     I*
     IBPACHDF     03
     I*
     IBPABDFX                                                             168141
     I              BBSS                            BCSS                  168141
     I              BBBA                            BCBA                  168141
     I              BBMK                            BCMK                  168141
     I              BBBK                            BCBO                  168141
     I              BBAD                            BCAD                  168141
     I              BBED                            BCED                  168141
     I              BBAS                            BCAS                  168141
     I              BBTP                            BCTP                  168141
     I              BBIT                            BCIT                  168141
     I              BBUN                            BCUN                  168141
     I              BBCA                            BCCP                  168141
     I              BBTA                            BCTA                  168141
     I              BBCF                            BCCF                  168141
     I              BBPC                            BCPC                  168141
     I              BBNC                            BCNC                  168141
     I              BBNR                            BCNR                  168141
     I              BBOD                            BCOT                  168141
     I              BBTV                            BCTV                  168141
     I              BBTR                            BCTR                  168141
     I              BBTS                            BCTS                  168141
     I              BBPS                            BCPS                  168141
     I              BBNM                            BCNL                  168141
     I              BBCN                            BCCN                  168141
     I              BBRA                            BCRA                  168141
     I              BBCC                            BCCC                  168141
     I              BBCT                            BCCT                  168141
     I              BBPT                            BCTD                  168141
     I              BBRI                            BCRV                  168141
     I              BBPR                            BCPR                  168141
     I              BBP1                            BCP1                  168141
     I              BBP2                            BCP2                  168141
     I              BBPL                            BCPL                  168141
     I              BBAP                            BCAT                  168141
     I              BBDV                            BCDV                  168141
     I              BBPN                            BCPN                                      CAS006
      *                                                                   168141
      ***  Read from LF/HTRACT - 04, 05, 06.
      *
     IBPACCH1F    04
     I              BCSS                            HBCSS
     I***********   BCBR                            HBCBR                 S01117
     I              BCBA                            HBCBA                 S01117
     I              BCMK                            HBCMK
     I              BCBO                            HBCBO
     I              BCAD                            HBCAD
     I              BCOT                            HBCOT                 E20087
     I              BCTV                            HBCTV
     I              BCTP                            HBCTP                 E15324
     I              BCTR                            HBCTR
     I              BCPS                            HBCPS
     I              BCNL                            HBCNL
     I              BCCN                            HBCCN
     I              BCRA                            HBCRA
     I              BCCC                            HBCCC
     I              BCCT                            HBCCT
     I              PCHI                            HPCHI                 E20085
     I              CNTP                            HCNTP
     I              ACRI                            HACRI                 E20085
     I              BCCF                            HBCCF
     I              BCPR                            HBCPR                 S01129
     I              LCCP                            XXLCCP                E15549
     I              CFAP                            HCFAP                 S01486
     I              BCRV                            HBCRV                 E21545
     I              CNTN                            HCNTN                                     CAS006
     I/COPY WNCPYSRC,SE2220I004
      *                                                                   E21545
     IBPACBH1F    05
     I              BBSS                            HBCSS
     I***********   BBBR                            HBCBR                 S01117
     I              BBBA                            HBCBA                 S01117
     I              BBMK                            HBCMK
     I              BBBK                            HBCBO
     I              BBAD                            HBCAD
     I              BBOD                            HBCOT                 E20087
     I              BBTV                            HBCTV
     I              BBTP                            HBCTP                 E15324
     I              BBTR                            HBCTR
     I              BBPS                            HBCPS
     I              BBNM                            HBCNL
     I              BBCN                            HBCCN
     I              BBRA                            HBCRA
     I              BBCC                            HBCCC
     I              BBCT                            HBCCT
     I              PCHI                            HPCHI                 E20085
     I              CNTP                            HCNTP
     I              ACRI                            HACRI                 E20085
     I              BBCF                            HBCCF
     I              BBPR                            HBCPR                 S01129
     I              LCCP                            XXLCCP                E15549
     I              CFAP                            HCFAP                 S01486
     I              BBRI                            HBCRV                 E21545
     I              CNTN                            HCNTN                                     CAS006
     I              BBPN                            HBCPN                                     CAS006
     I/COPY WNCPYSRC,SE2220I005
      *                                                                   E21545
     IBPACHH1F    06
     I              BCSS                            HBCSS
     I***********   BCBR                            HBCBR                 S01117
     I              BCBA                            HBCBA                 S01117
     I              BCMK                            HBCMK
     I              BCBO                            HBCBO
     I              BCAD                            HBCAD
     I              BCOT                            HBCOT                 E20087
     I              BCTV                            HBCTV
     I              BCTR                            HBCTR
     I              BCTP                            HBCTP                 E15324
     I              BCPS                            HBCPS
     I              BCNL                            HBCNL
     I              BCCN                            HBCCN
     I              BCRA                            HBCRA
     I              BCCC                            HBCCC
     I              BCCT                            HBCCT
     I              PCHI                            HPCHI                 E20085
     I              CNTP                            HCNTP
     I              ACRI                            HACRI                 E20085
     I              BCCF                            HBCCF
     I              BCPR                            HBCPR                 S01129
     I              LCCP                            XXLCCP                E20085
     I              CFAP                            HCFAP                 S01486
     I              BCRV                            HBCRV                 E21545
     I              CNTN                            HCNTN                                     CAS006
     I/COPY WNCPYSRC,SE2220I006
     I*
      ***  Read from LF/HTRACB - 07, 08, 09.
      *
     IBPACCH2F    07
     I              BCSS                            HBCSS
     I***********   BCBR                            HBCBR                 S01117
     I              BCBA                            HBCBA                 S01117
     I              BCMK                            HBCMK
     I              BCBO                            HBCBO
     I              BCAD                            HBCAD
     I              BCOT                            HBCOT                 E20087
     I              BCTV                            HBCTV
     I              BCTP                            HBCTP                 E15324
     I              BCTR                            HBCTR
     I              BCPS                            HBCPS
     I              BCNL                            HBCNL
     I              BCCN                            HBCCN
     I              BCRA                            HBCRA
     I              BCCC                            HBCCC
     I              BCCT                            HBCCT
     I              PCHI                            HPCHI                 E20085
     I              CNTP                            HCNTP
     I              ACRI                            HACRI                 E20085
     I              BCCF                            HBCCF
     I              BCPR                            HBCPR                 S01129
     I              LCCP                            XXLCCP                E15549
     I              CFAP                            HCFAP                 S01486
     I              BCRV                            HBCRV                 E21545
     I              CNTN                            HCNTN                                     CAS006
     I/COPY WNCPYSRC,SE2220I007
      *                                                                   E21545
     IBPACBH2F    08
     I              BBSS                            HBCSS
     I***********   BBBR                            HBCBR                 S01117
     I              BBBA                            HBCBA                 S01117
     I              BBMK                            HBCMK
     I              BBBK                            HBCBO
     I              BBAD                            HBCAD
     I              BBOD                            HBCOT                 E20087
     I              BBTV                            HBCTV
     I              BBTP                            HBCTP                 E15324
     I              BBTR                            HBCTR
     I              BBPS                            HBCPS
     I              BBNM                            HBCNL
     I              BBCN                            HBCCN
     I              BBRA                            HBCRA
     I              BBCC                            HBCCC
     I              BBCT                            HBCCT
     I              PCHI                            HPCHI                 E20085
     I              CNTP                            HCNTP
     I              ACRI                            HACRI                 E20085
     I              BBCF                            HBCCF
     I              BBPR                            HBCPR                 S01129
     I              LCCP                            XXLCCP                E15549
     I              CFAP                            HCFAP                 S01486
     I              BBRI                            HBCRV                 E21545
     I              CNTN                            HCNTN                                     CAS006
     I              BBPN                            HBCPN                                     CAS006
     I/COPY WNCPYSRC,SE2220I008
      *                                                                   E21545
     IBPACHH2F    09
     I              BCSS                            HBCSS
     I***********   BCBR                            HBCBR                 S01117
     I              BCBA                            HBCBA                 S01117
     I              BCMK                            HBCMK
     I              BCBO                            HBCBO
     I              BCAD                            HBCAD
     I              BCOT                            HBCOT                 E20087
     I              BCTV                            HBCTV
     I              BCTP                            HBCTP                 E15324
     I              BCTR                            HBCTR
     I              BCPS                            HBCPS
     I              BCNL                            HBCNL
     I              BCCN                            HBCCN
     I              BCRA                            HBCRA
     I              BCCC                            HBCCC
     I              BCCT                            HBCCT
     I              PCHI                            HPCHI                 E20085
     I              CNTP                            HCNTP
     I              ACRI                            HACRI                 E20085
     I              BCCF                            HBCCF
     I              BCPR                            HBCPR                 S01129
     I              LCCP                            XXLCCP                E20085
     I              CFAP                            HCFAP                 S01486
     I              BCRV                            HBCRV                 E21545
     I              CNTN                            HCNTN                                     CAS006
     I/COPY WNCPYSRC,SE2220I009
     I*                                                                   S01129
      ***  Read from LF/HTRACBX - 13, 14, 15.
      *
     IBPACCH3F    13                                                      S01129
     I              BCSS                            HBCSS                 S01129
     I***********   BCBR                            HBCBR          S01129 S01117
     I              BCBA                            HBCBA                 S01117
     I              BCMK                            HBCMK                 S01129
     I              BCBO                            HBCBO                 S01129
     I              BCAD                            HBCAD                 S01129
     I              BCOT                            HBCOT                 E20087
     I              BCTV                            HBCTV                 S01129
     I              BCTP                            HBCTP                 E15324
     I              BCTR                            HBCTR                 S01129
     I              BCPS                            HBCPS                 S01129
     I              BCNL                            HBCNL                 S01129
     I              BCCN                            HBCCN                 S01129
     I              BCRA                            HBCRA                 S01129
     I              BCCC                            HBCCC                 S01129
     I              BCCT                            HBCCT                 S01129
     I              PCHI                            HPCHI                 E20085
     I              CNTP                            HCNTP                 S01129
     I              ACRI                            HACRI                 E20085
     I              BCCF                            HBCCF                 S01129
     I              BCPR                            HBCPR                 S01129
     I              LCCP                            XXLCCP                E15549
     I              CFAP                            HCFAP                 S01486
     I              BCRV                            HBCRV                 E21545
     I              CNTN                            HCNTN                                     CAS006
     I/COPY WNCPYSRC,SE2220I010
      *                                                                   E21545
     IBPACBH3F    14                                                      S01129
     I              BBSS                            HBCSS                 S01129
     I***********   BBBR                            HBCBR          S01129 S01117
     I              BBBA                            HBCBA                 S01117
     I              BBMK                            HBCMK                 S01129
     I              BBBK                            HBCBO                 S01129
     I              BBAD                            HBCAD                 S01129
     I              BBOD                            HBCOT                 E20087
     I              BBTV                            HBCTV                 S01129
     I              BBTP                            HBCTP                 E15324
     I              BBTR                            HBCTR                 S01129
     I              BBPS                            HBCPS                 S01129
     I              BBNM                            HBCNL                 S01129
     I              BBCN                            HBCCN                 S01129
     I              BBRA                            HBCRA                 S01129
     I              BBCC                            HBCCC                 S01129
     I              BBCT                            HBCCT                 S01129
     I              PCHI                            HPCHI                 E20085
     I              CNTP                            HCNTP                 S01129
     I              ACRI                            HACRI                 E20085
     I              BBCF                            HBCCF                 S01129
     I              BBPR                            HBCPR                 S01129
     I              LCCP                            XXLCCP                E15549
     I              CFAP                            HCFAP                 S01486
     I              BBRI                            HBCRV                 E21545
     I              CNTN                            HCNTN                                     CAS006
     I              BBPN                            HBCPN                                     CAS006
     I/COPY WNCPYSRC,SE2220I011
      *                                                                   E21545
     IBPACHH3F    15                                                      S01129
     I              BCSS                            HBCSS                 S01129
     I***********   BCBR                            HBCBR          S01129 S01117
     I              BCBA                            HBCBA                 S01117
     I              BCMK                            HBCMK                 S01129
     I              BCBO                            HBCBO                 S01129
     I              BCAD                            HBCAD                 S01129
     I              BCOT                            HBCOT                 E20087
     I              BCTV                            HBCTV                 S01129
     I              BCTP                            HBCTP                 E15324
     I              BCTR                            HBCTR                 S01129
     I              BCPS                            HBCPS                 S01129
     I              BCNL                            HBCNL                 S01129
     I              BCCN                            HBCCN                 S01129
     I              BCRA                            HBCRA                 S01129
     I              BCCC                            HBCCC                 S01129
     I              BCCT                            HBCCT                 S01129
     I              PCHI                            HPCHI                 E20085
     I              CNTP                            HCNTP                 S01129
     I              ACRI                            HACRI                 E20085
     I              BCCF                            HBCCF                 S01129
     I              BCPR                            HBCPR                 S01129
     I              LCCP                            XXLCCP                E20085
     I              CFAP                            HCFAP                 S01486
     I              BCRV                            HBCRV                 E21545
     I              CNTN                            HCNTN                                     CAS006
     I/COPY WNCPYSRC,SE2220I012
      *                                                                   E21545
     ITRADSDF                                                             101300
     I              RECI                            TRECI                 101300
     I              TDVD                            TRDVD                 101300
     I              EUTX                            TEUTX                                     CGL035
     I*                                                                   101300
     IBKPOSDF
     I              RECI                            BRECI
     ISECTYDF
     I              SITP                            SSITP
     I              NMCY                            SNMCY
     I*
     I* TO RENAME SNDEVD FIELDS
     I*
     ISNDEVDF
     I              RECI                            RECINS                076681
     I              SNDT                            SDED
     I              SNET                            SDET
     I              LCCP                            XXLCCP                E15549
      *                                                                   E20085
     ISEDEVDF                                                             E20085
     I/COPY WNCPYSRC,SE2220I015
     I              RECI                            RECISD                E20085
      *                                                                   E20085
     ISEDEVDO                                                             E20085
     I/COPY WNCPYSRC,SE2220I016
     I              RECI                            RECISO                E20085
     ISNDEVDO                                                             E29244
     I              RECI                            RECINO                076681
     I              LCCP                            XXLCCP                E29244
     IBKPOPDF                                                                                 246619
     I              RECI                            JRECI                                     246619
     I              BPSC                            JBPSC                                     246619
     I              BPBA                            JBPBA                                     246619
     I              BPBK                            JBPBK                                     246619
     I              BPMK                            JBPMK                                     246619
     I              BPTV                            JBPTV                                     246619
     I              BPPD                            JBPPD                                     246619
     I              NPSN                            JNPSN                                     246619
     I              ECNP                            JECNP                                     246619
     I              APPB                            JAPPB                                     246619
     I              RPTP                            JRPTP                                     246619
     I              PILP                            JPILP                                     246619
     I              APNC                            JAPNC                                     246619
     I              SNPI                            JSNPI                                     246619
     I              SNSI                            JSNSI                                     246619
     I              SANP                            JSANP                                     246619
     I              SANS                            JSANS                                     246619
     I              ANMP                            JANMP                                     246619
     I              ZZ005                           JZZ005                                    246619
     I              ADJI                            JADJI                                     246619
     I              TNLU                            JTNLU                                     246619
     I              AAPR                            JAAPR                                     246619
     I              FXAP                            JFXAP                                     246619
     I              APPN                            JAPPN                                     246619
     I              APNN                            JAPNN                                     246619
     I              PILN                            JPILN                                     246619
     I              BKCOST                          JBKCOS                                    246619
     I              PNOM                            JPNOM                                     246619
      *                                                                                       CSE037
     IINVTPDF                                                                                 CSE037
     I              SFLG                            ISFLG                                     CSE037
      *                                                                                       CSE065
      ** Rename SEDEV fields                                                                  CSE065
      *                                                                                       CSE065
     ISEDEVDAL                                                                                CSE065
     I              RECI                            C#RECI                                    CSE065
     I              SDSN                            C#SDSN                                    CSE065
     I              SDED                            C#SDED                                    CSE065
     I              SDET                            C#SDET                                    CSE065
     I              SDNV                            C#SDNV                                    CSE065
     I              SDVA                            C#SDVA                                    CSE065
     I              ZZ005                           C#ZZ05                                    CSE065
     I              SRPT                            C#SRPT                                    CSE065
     I              SDTR                            C#SDTR                                    CSE065
     I              SRMI                            C#SRMI                                    CSE065
     I              SDPD                            C#SDPD                                    CSE065
     I              SDNC                            C#SDNC                                    CSE065
     I              SDPP                            C#SDPP                                    CSE065
     I              SDPC                            C#SDPC                                    CSE065
     I              SDTA                            C#SDTA                                    CSE065
     I              SDTP                            C#SDTP                                    CSE065
     I              SDRP                            C#SDRP                                    CSE065
     I              SDCV                            C#SDCV                                    CSE065
     I              SDCX                            C#SDCX                                    CSE065
     I              SDCE                            C#SDCE                                    CSE065
     I              SDMD                            C#SDMD                                    CSE065
     I              NMCY                            C#NMCY                                    CSE065
     I              SDAD                            C#SDAD                                    CSE065
     I              SDDT                            C#SDDT                                    CSE065
     I              RCIC                            C#RCIC                                    CSE065
     I              LCD                             C#LCD                                     CSE065
     I              CHTP                            C#CHTP                                    CSE065
     I              TNLU                            C#TNLU                                    CSE065
     I              SDCP                            C#SDCP                                    CSE065
     I              SDXD                            C#SDXD                                    CSE065
     I              FRNT                            C#FRNT                                    CSE065
     I              REPA                            C#REPA                                    CSE065
     I              TMST                            C#TMST                                    CSE065
     I              SCRS                            C#SCRS                                    CSE065
     I              SLQP                            C#SLQP                                    CSE065
     I              SDNN                            C#SDNN                                    CSE065
     I              SDAL                            C#SDAL                                    CSE065
      *                                                                                       CSE065
      ** External DS for Bank Details                                                         CSE065
      *                                                                                       CSE065
     ISDBANK    E DSSDBANKPD                                                                  CSE065
     I*
     I* INPUT RECORD
     I*
     I/COPY WNCPYSRC,SE2220I002
     IRECIN     E DSBPACC
     I*
     I* STORE FOR INPUT RECORD
     I*
     I            DS
     I                                        1 232 STREC
     I*
     I* DATA STRUCTURES FOR Z-SUBROUTINES
     I*
     I/COPY ZSRSRC,ZHASHZ2                                                S01094
     I*
     I/COPY ZSRSRC,ZNCDZ2
     I****Data*structure for array used in ZDATE5                  E22957 S01195
     I*********** DS                                               E22957 S01195
     I***********                             1  75 HCCY           E22957 S01195
     I***********                             1  75 XCCY           E22957 S01195
     I*
     I            DS
     I                                        1   6 IKEY
     I                                        1   3 SNMCY
     I                                        4   6 SSITP
     I*
     I            DS
     I                                        1  15 EKEY
     I                                        1  10 ESEC
     I                                    P  11  130EDTE
     I                                       14  15 ETYP
     I*
     I            DS
     I                                        1  12 TKEY
     I                                        1   20RECT
     I                                        3  10 ZZ008
     I                                       11  120RCDE
     I*
     I* DATA STRUCTURE FOR ACCOUNT KEY
     I*
     I/COPY WNCPYSRC,SE2220I013
     I            DS
     I                                        1  20 ACKY
     I                                        1  18 ACKY2                                     CSE065
     I                                        1   3 IVTP
     I                                        4   4 EVTP
     I                                        5   5 TRTP
     I                                        6   6 PORT
     I                                        7   8 BHBK
     I                                        9   9 PSBS
     I                                       10  10 FILL
     I                                        9  10 TRST
     I                                       11  12 CHGT
     I                                       13  13 BHMK
     I                                       14  14 CNVI
     I                                       15  15 NEGI
     I                                       16  18 FIL3
     I                                       19  20 AMCD
     I/COPY WNCPYSRC,SE2220I014
      *                                                                   E20144
      ***  Define BPACC Key fields.                                       E20144
      *                                                                   E20144
     I            DS                                                      E20144
     I                                        1  30 BPBCKY                E20144
     I                                        1  10 BPBCSS                E20144
     I***********                            11  130BPBCBR         E20144 S01117
     I                                       11  13 BPBCBA                S01117
     I                                       14  14 BPBCMK                E20144
     I                                       15  16 BPBCBO                E20144
     I                                       17  17 BPBCTV                E20144
     I                                    P  18  200BPBCAD                E20144
     I                                       21  22 BPBCAS                E20144
     I                                       23  23 BPBCTS                E20144
     I                                       24  29 BPBCTR                E20144
     I                                       30  30 BPBCRV                E20986
     I*
     I* DATA STRUCTURES TO STORE KEYS FOR PREVIOUS ACTION
     I*
     I            DS
     I                                        1  17 BCKEY
     I                                        1  20 BPKEY
     I                                        1  10 PBCSS
     I***********                            11  130PBCBR                 S01117
     I                                       11  13 PBCBA                 S01117
     I                                       14  15 PBCBO
     I                                       16  16 PBCMK
     I                                       17  17 PBCTV
     I                                    P  18  200LPSD
     I*
     I            DS
     I                                        1  17 BCKEYP
     I************                            1  20 BPKEYP                E22957
     I                                        1  10 KBCSS
     I***********                            11  130KBCBR                 S01117
     I                                       11  13 KBCBA                 S01117
     I                                       14  15 KBCBO
     I                                       16  16 KBCMK
     I                                       17  17 KBCTV
     I************                        P  18  200KLPSD                 E22957
     I*
     I* DATA STRUCTURE TO SET UP KEY FIELDS FOR HIST TRD FILES
     I*
     I            DS
     I                                        1  17 TRKEY
     I***********                             1   30HBCBR                 S01117
     I                                        1   3 HBCBA                 S01117
     I                                        4  13 HBCSS
     I                                       14  15 HBCBO
     I                                       16  16 HBCMK
     I                                       17  17 HBCTV
     I*
     I            DS
     I                                        1  17 KTRKEY
     I************                            1   30KHBCBR                S01117
     I                                        1   3 KHBCBA                S01117
     I                                        4  13 KHBCSS
     I                                       14  15 KHBCBO
     I                                       16  16 KHBCMK
     I                                       17  17 KHBCTV
     I*                                                                   S01117
     IKSEPCR      DS                                                      S01117
     I*                                                                   S01117
     I*  Data structure to enable reporting of Book Position Profit       S01117
     I*  Centre database errors                                           S01117
     I                                        1   2 KBOKC                 S01117
     I                                        3   5 KBRCA                 S01117
     I                                        6  15 KSESN                 S01117
     I                                       16  16 KMKTI                 S01117
     I*
     I* DATA STRUCTURE TO STORE RECORDS FOR BOOK POSITION
     I*
     IBKPREC    E DSBKPOS
     I              RECI                            BRECI
     I              ZZ005                           ZZ005X                052254
     I*
     I            DS
     I**********                              1 119 RECST1                                    CAS006
     I**********                              1 142 RECST1                             CAS006 252207
     I                                        1 150 RECST1                                    252207
     I                                      120 238 RECST2
     I*
     I* DATA AREA SESTAT
     I*
     ISESTAT    E DS
     I/COPY WNCPYSRC,SE2220I001
     I*
     I* DATA STRUCTURES FOR ERROR HANDLING
     I*
     IBKHDS       DS
     I                                     *STATUS  STSBKH
     I*
     IBKPDS       DS
     I                                     *STATUS  STSBKP
     I*
     IBPADS       DS
     I                                     *STATUS  STSBPA
     I*
     ISKDDS       DS
     I                                     *STATUS  STSSKD
     I*
     ISKADS       DS
     I                                     *STATUS  STSSKA
     I*
     IBHADS       DS
     I                                     *STATUS  STSBHA
     I*
     IBKADS       DS
     I                                     *STATUS  STSBKA
     I*
     IBKMDS       DS
     I                                     *STATUS  STSBKM
     I*
     IBMADS       DS
     I                                     *STATUS  STSBMA
     I*
     IHHDDS       DS
     I                                     *STATUS  STSHHD
     I*
     IHHADS       DS
     I                                     *STATUS  STSHHA
     I*
     ILDA         DS                            256                       S01117
      ***  Local Data Area for Database Error Information.                S01117
     I                                      134 183 DBLOT                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
      ***  Local Data Area for Database Error Information.                S01117
     I***********LDA        UDS                            256            S01117
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 1770DBASE                 S01117
     I*
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I*
     I/COPY ZSRSRC,ZYLDZ1
     I/COPY ZSRSRC,ZHOLI                                                  S01195
     I/COPY ZSRSRC,ZHOLDS                                                 S01195
      *                                                                   CPM004
     I            DS                                                      CPM004
     I                                        1   5 WWKY                  CPM004
     I                                        1   1 WWKY1                 CPM004
     I                                        2   2 WWKY2                 CPM004
     I                                        3   3 WWKY3                 CPM004
     I                                        4   5 WWKY4                 CPM004
      *                                                                   CPM004
      ** Input parameters on call to AOPLCSR1                             CPM004
     II@PARM      DS                            256                       CPM004
     I                                        1   1 I#PORS                CPM004
     I                                        2   5 I#R997                CPM004
     I                                        6  15 I#CUST                CPM004
     I                                       16  18 I#BRCA                CPM004
     I                                       19  20 I#BOOK                CPM004
     I                                       21  24 I#PTFR                CPM004
     I                                       25  34 I#CPGM                CPM004
     I*                                                                   CPM004
      ** Output parameters on call to AOPLCSR1                            CPM004
     IO@PARM      DS                            256                       CPM004
     I                                        1   2 O#BOOK                CPM004
     I                                        3   6 O#PTFR                CPM004
     I                                        7  12 O#BICN                CPM004
     I                                       13  22 O#CRNM                CPM004
     I                                       23  24 O#ACOF                CPM004
     I*
     ISDMMOD    E DSSDMMODPD                                              S01486
     I**  Data structure for module details                               S01486
     I*                                                                   S01486
     ISDPORT    E DSSDPORTPD                                              CPM004
     I**  Data structure for Porfolio Management ICD                      CPM004
     I*                                                                   CPM004
     ISDPLCS    E DSSDPLCSPD                                              CPM004
     I**  Data structure for Porfolio Customer details                    CPM004
     I*                                                                   CPM004
     ISDSTRD    E DSSDSTRDPD                                              CAC002
     I**  Securities Trading Details                                      CAC002
     I*                                                                   CSE006
     ISCSARD    E DSSCSARDPD                                              CSE006
     I** Switchable features file                                         CSE006
     I*                                                                   CAC002
     ISDHEDG    E DSSDHEDGPD                                                                  228948
      ** Hedge ICD                                                                            228948
      *                                                                                      BUG8813
     ISDGELR    E DSSDGELRPD                                                                 BUG8813
      ** EXTERNAL DS FOR GENERAL LEDGER DETAILS                                              BUG8813
      *                                                                                       228948
     IDSFDY     E DSDSFDY                                                 S01486
     I** First data structure for access programs, short data structure   S01486
     I*                                                                   S01486
     I              'DiscPremAmortPostn  'C         SVALKK                                    CSE105
      *                                                                                       CSE105
     I/COPY WNCPYSRC,SE2220I003
     C/EJECT
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
      *                                                                   S01486
      *** Copyright Statement                                             S01486
     C                     MOVEACPY@      ACT@   80                       S01486
     C*
     C* KEYLISTS FOR FILE CHAINS
     C/COPY WNCPYSRC,SE2220C061
     C*
     C*   - BOOK POSITION HEADER
     C*
     C           BKHKEY    KLIST
     C                     KFLD           KBCSS
     C***********          KFLD           KBCBR                           S01117
     C                     KFLD           KBCBA                           S01117
     C                     KFLD           KBCBO
     C                     KFLD           KBCMK
     C                     KFLD           KBCTV
     C*
     C*  - BOOK POSITION
     C           BKPKEY    KLIST
     C                     KFLD           KBCSS
     C***********          KFLD           KBCBR                           S01117
     C                     KFLD           KBCBA                           S01117
     C                     KFLD           KBCBO
     C                     KFLD           KBCMK
     C                     KFLD           KBCTV
     C                     KFLD           LPSD
     C*
     C** Keylist for chain to BKPOSD in W02
     C**
     C           BKPKY2    KLIST
     C                     KFLD           BHSC
     C***********          KFLD           BHBR                            S01117
     C                     KFLD           BHBA                            S01117
     C                     KFLD           BHBK
     C                     KFLD           BHMK
     C                     KFLD           BHTV
     C                     KFLD           KBCAD
     C*                                                                   S01117
     C*   - Book position profit centre (PF/SEPCBD)                       S01117
     C*                                                                   S01117
     C           KSEPCB    KLIST                                          S01117
     C                     KFLD           KBOKC                           S01117
     C                     KFLD           KBRCA                           S01117
     C                     KFLD           KSESN                           S01117
     C                     KFLD           KMKTI                           S01117
     C*  - BOOK
     C           BOKKEY    KLIST
     C                     KFLD           BCBO
     C*
     C*  - SECURITY
     C           SECKEY    KLIST
     C                     KFLD           BCSS
     C*
     C*  - SECURITY DIARY EVENTS
     C           SEDKEY    KLIST
     C                     KFLD           BCSS
     C***********          KFLD           EDTE                            E20085
     C                     KFLD           ETYP
     C                     KFLD           TDVD                            E20085
     C***********                                                         E20085
     C***-*SECURITY*DIARY*EVENTS***************************************   E20085
     C***********SEDKY2    KLIST                                          E20085
     C***********          KFLD           BCSS                            E20085
     C*
     C*  - INVESTMENT TYPE
     C           INVKEY    KLIST
     C                     KFLD           SNMCY
     C                     KFLD           SSITP
     C*
     C*  - CLIENTS
     C           CLIKEY    KLIST
     C                     KFLD           TRCP
     C*
     C*  - TABLE
     C           TABKEY    KLIST
     C                     KFLD           TKEY
      *                                                                   E20144
      ***  Full Key for BPACC to CHAIN before UPDATE.                     E20144
      *                                                                   E20144
     C           BPCKEY    KLIST                                          E20144
     C                     KFLD           BPBCSS                          E20144
     C***********          KFLD           BPBCBR                   E20144 S01117
     C                     KFLD           BPBCBA                          S01117
     C                     KFLD           BPBCMK                          E20144
     C                     KFLD           BPBCBO                          E20144
     C                     KFLD           BPBCTV                          E20144
     C                     KFLD           BPBCAD                          E20144
     C                     KFLD           BPBCAS                          E20144
     C                     KFLD           BPBCTS                          E20144
     C                     KFLD           BPBCTR                          E20144
     C                     KFLD           BPBCRV                          E20986
     C*
     C*  - HISTORIC TRADE ACTIONS BY TRADE
     C           HTTKEY    KLIST
     C                     KFLD           KBHTR   6
     C                     KFLD           BHTV
     C                     KFLD           KBCSS                                               241968
     C*
     C*  - HISTORIC TRADE ACTIONS BY BRANCH
     C           HTBKEY    KLIST
     C***********          KFLD           KHBCBR                          S01117
     C                     KFLD           KHBCBA                          S01117
     C                     KFLD           KHBCSS
     C                     KFLD           KHBCBO
     C                     KFLD           KHBCMK
     C                     KFLD           KHBCTV
     C                     KFLD           KDTE    50
     C                     KFLD           KREF    6
     C*
     C           HTBKY2    KLIST
     C***********          KFLD           KHBCBR                          S01117
     C                     KFLD           KHBCBA                          S01117
     C                     KFLD           KHBCSS
     C                     KFLD           KHBCBO
     C                     KFLD           KHBCMK
     C                     KFLD           KHBCTV
      *                                                                   E20087
      *****Trades*by*branch/book/security/market*(LF/TRDMTH)****** E20087 E20552
      ***********                                                  E20087 E20552
     C***********TRDKEY    KLIST                                   E20087 E20552
     C***********          KFLD           BHBR                     E20087 E20552
     C***********          KFLD           BHBK                     E20087 E20552
     C***********          KFLD           BHSC                     E20087 E20552
     C***********          KFLD           BHMK                     E20087 E20552
     C*                                                                   091803
     C** PRICED FILE KEY                                                  091803
     C*                                                                   091803
     C           PKEY      KLIST                                          091803
     C                     KFLD           PSSN                            091803
     C                     KFLD           PPRT                            091803
     C                     KFLD           PVDT                            091803
     C***********                                                  S01486 CPM004
     C***********HSEXKY    KLIST                                   S01486 CPM004
     C***********          KFLD           NMCY                     S01486 CPM004
     C***********          KFLD           BCAD                     S01486 CPM004
      *                                                                   CSE006
      ** Buy/Selk Book File Key List (TDRF)                               CSE006
      *                                                                   CSE006
     C           BSKEY1    KLIST                                          CSE006
     C                     KFLD           BCBA                            CSE006
     C                     KFLD           BCBO                            CSE006
     C                     KFLD           TDRF                            CSE006
      *                                                                   CSE006
      ** Buy/Selk Book File Key List (LKRF)                               CSE006
      *                                                                   CSE006
     C           BSKEY2    KLIST                                          CSE006
     C                     KFLD           BCBA                            CSE006
     C                     KFLD           BCBO                            CSE006
     C                     KFLD           LKRF                            CSE006
      *                                                                                       CSE065
      ** Security Events Diary Key List                                                       CSE065
      *                                                                                       CSE065
     C           SEKEY1    KLIST                                                              CSE065
     C                     KFLD           CSDSN  10                                           CSE065
     C                     KFLD           CSDET   2                                           CSE065
     C                     KFLD           CSDED   50                                          CSE065
      *                                                                   CSE006
     C*
     C* ACCESS ICD INFORMATION
     C*
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE *BLANK    DBLOT
     C                     MOVE 'SE2220  'DBPGM
     C                     OUT  LDA                                       S01117
     C*
     C                     EXSR FIRST
     C           *INU7     IFEQ '1'
     C                     GOTO EAUDIT
     C                     END
     C*
     C* DEFINE AND CLEAR WORK FIELDS AND INDICATORS
     C*
     C/COPY WNCPYSRC,SE2220C138
     C           *LIKE     DEFN BCP1      WBCP1
     C           *LIKE     DEFN BCP2      WBCP2
     C           *LIKE     DEFN BCPL      WBCPL
     C           *LIKE     DEFN BCDV      WBCDV
     C           *LIKE     DEFN INAJ      WINAJ
     C           *LIKE     DEFN PCHI      WPCHI
     C           *LIKE     DEFN CNTP      WCNTP
     C           *LIKE     DEFN RMIP      WRMIP
     C           *LIKE     DEFN ACRI      WACRI
     C********** *LIKE     DEFN TRCP      WTRCP                                               CSD027
     C                     MOVE *ZEROS    WTRCP   60                                          CSD027
     C           *LIKE     DEFN LPSD      TLPSD
     C           *LIKE     DEFN APNC      PAPNC                           E22957
     C************LIKE     DEFN LCPN      WSTDT                           E14616
     C           *LIKE     DEFN CFCT      WBCCF                           052254
     C                     MOVE *BLANK    BCKEYP
     C                     MOVE *ZEROS    KBCAD   50
     C                     Z-ADD0         ICREC   50
     C                     Z-ADD0         IXREC   50                      E29207
     C                     Z-ADD0         IBREC   50
     C                     Z-ADD0         IHREC   50
     C                     Z-ADD0         OREC    50
     C                     Z-ADD0         BHUREC  50
     C                     Z-ADD0         BHAREC  50
     C                     Z-ADD0         BPAREC  50
     C                     Z-ADD0         HHAREC  50
     C                     Z-ADD0         W04CNT  50
     C                     Z-ADD0         U04CNT  50
     C                     MOVE 'N'       DADJN                           100017
     C*
     C* READ AND PROCESS ALL BOOK POSITION ACTION RECORDS UNTIL EOF
     C*
     C           *IN89     DOUEQ'1'
     C           *INU7     OREQ '1'
     C*
     C                     SETOF                     010203
     C*
     C                     READ BPACC                    89
     C           *IN89     IFEQ '0'
      *                                                                   E20144
      ***  Store Key of BPACC record just read (for reCHAIN later).       E20144
      *                                                                   E20144
     C                     MOVE BCSS      BPBCSS                          E20144
     C***********          MOVE BCBR      BPBCBR                   E20144 S01117
     C                     MOVE BCBA      BPBCBA                          S01117
     C                     MOVE BCMK      BPBCMK                          E20144
     C                     MOVE BCBO      BPBCBO                          E20144
     C                     MOVE BCTV      BPBCTV                          E20144
     C                     MOVE BCAD      BPBCAD                          E20144
     C                     MOVE BCAS      BPBCAS                          E20144
     C                     MOVE BCTS      BPBCTS                          E20144
     C                     MOVE BCTR      BPBCTR                          E20144
     C***********          MOVE BCTV      BPBCTV                   E22957 E23747
     C                     MOVE BCRV      BPBCRV                          E23747
      *                                                                   E20144
      ***  Release the BPACC record, to avoid possible locking.           E20144
      *                                                                   E20144
     C*******              EXCPTRELBPC                              E20144168141
     C*
     C* STORE KEYS AND INCREMENT COUNTS
     C*
     C                     MOVE BCSS      PBCSS
     C***********          MOVE BCBR      PBCBR                           S01117
     C                     MOVE BCBA      PBCBA                           S01117
     C                     MOVE BCBO      PBCBO
     C                     MOVE BCMK      PBCMK
     C                     MOVE BCTV      PBCTV
     C*
     C***01****************ADD  1         ICREC                           E29207
     C*                                                                   E29207
     C* BPACCD may include 'DUMMY' actions (BCAS=00) generated by SE2230  E29207
     C* these are omitted from the file control check                     E29207
     C*                                                                   E29207
     C   01                DO                                             E29207
     C           BCAS      IFEQ '00'                                      E29207
     C                     ADD  1         IXREC                           E29207
     C                     ELSE                                           E29207
     C                     ADD  1         ICREC                           E29207
     C                     END                                            E29207
     C                     END                                            E29207
     C   02                ADD  1         IBREC
     C   03                ADD  1         IHREC
      *
      ***  Else Record not found.
     C                     ELSE
     C*
     C* IF EOF AND NO RECORDS READ - EXIT
     C*
     C           ICREC     IFEQ 0
     C           IXREC     ANDEQ0                                         E29207
     C           IBREC     ANDEQ0
     C           IHREC     ANDEQ0
     C                     GOTO ENDLP
     C                     ELSE
     C                     MOVE *BLANK    BCKEY
     C                     Z-ADD0         BCAD
     C                     END
      *
     C                     END
     C*
     C* CLEAR INDICATORS AND WORK FIELDS
     C*
     C                     MOVEA'0000'    *IN,22
     C                     MOVEA'0000000' *IN,28
     C                     MOVEA'000000'  *IN,36
     C                     MOVEA'0000'    *IN,85
     C*
     C                     Z-ADD0         WBCP1
     C                     Z-ADD0         WBCP2
     C                     Z-ADD0         WBCPL
     C                     Z-ADD0         WBCDV
     C/COPY WNCPYSRC,SE2220C080
      *                                                                   E20085
      ***  Chain to these two files on first time through is pointless    E20085
      ***  as no information from these files is required before the      E20085
      ***  chains are done again in the change of key processing.         E20085
     C***********                                                         E20085
     C**ACCESS*SECURITIES*FILE*AND*INVESTMENT*TYPE*********************   E20085
     C***********                                                         E20085
     C************IN89     IFEQ '0'                                       E20085
     C************IN69     ANDEQ'0'                                       E20085
     C***********          EXSR SECCHN                                    E20085
     C************INU7     IFEQ '1'                                       E20085
     C***********          GOTO ENDLP                                     E20085
     C***********          END                                            E20085
     C***********                                                         E20085
     C***********          EXSR INVCHN                                    E20085
     C************INU7     IFEQ '1'                                       E20085
     C***********          GOTO ENDLP                                     E20085
     C***********          END                                            E20085
     C***********                                                         E20085
     C***********          SETON                     69                   E20085
     C***********          END                                            E20085
     C*
     C* IF ACTION DATE HAS CHANGED AND TRADE ACTIONS WERE PROCESSED FOR
     C* PREVIOUS ACTION DATE - UPDATE PREVIOUS BOOK POSITION IF PRESENT
     C* AND WRITE NEW BOOK POSITION
     C*
     C           BCAD      IFNE KBCAD
     C           KBCAD     ANDNE*ZEROS
     C           *IN21     ANDEQ'1'
     C           BCKEYP    ORNE BCKEY
     C           BCKEYP    ANDNE*BLANKS
     C           *IN21     ANDEQ'1'
     C                     MOVE '0'       *IN21
     C************IN11     IFEQ '1'                                       E15965
     C***********          MOVE '0'       *IN11                           E15965
     C***********          EXSR U03                                       E15965
     C***********          EXSR W02                                       E15965
     C***********                                                         E15965
     C**WRITE*COPY*O *BOOK*POSITION*HEADER*TO*HISTORIC*FILE************   E15965
     C***********                                                         E15965
     C***********          EXSR W05                                       E15965
     C***********                                                         E15965
     C***********          ELSE                                           E15965
     C*                                                                   E15965
     C* UPDATE/WRITE TO BOOK POSITION DETAIL FILE                         E15965
     C*                                                                   E15965
     C                     EXSR W02
     C***********                                                         E22957
     C**WRITE*COPY*O *BOOK*POSITION*HEADER*TO*HISTORIC*FILE******         E22957
     C***********                                                         E22957
     C***********          EXSR W05                                       E22957
     C***********          END                                            E15965
     C*                                                                   E15442
     C* AS A BOOK POSITION RECORD HAS BEEN WRITTEN,RESET THE DISCOUNT/    E15442
     C* PREMIUM POSTED SINCE LAST POSITION DATE (BKPHDD) TO ZERO          E15442
     C*                                                                   E15442
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADD0         DPAN                                                CAS006
     C                     Z-ADD0         WEDN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADD*ZERO     DPAP                            E15442
     C                     Z-ADD*ZERO     WEDP                            S01176
     C                     Z-ADD*ZERO     BHPP                            E29236
     C/COPY WNCPYSRC,SE2220C055
     C*                                                                   E22957
     C* WRITE COPY OF BOOK POSITION HEADER TO HISTORIC FILE               E22957
     C*                                                                   E22957
     C                     EXSR W05                                       E22957
     C                     END                                            E22957
     C***********                                                  S01117 E34618
     C****Access*related*Book*PositionProfit*Centre*************   S01117 E34618
     C***********                                                  S01117 E34618
     C***********          MOVE BCBO      KBOKC                    S01117 E34618
     C***********          MOVE BCBA      KBRCA                    S01117 E34618
     C***********          MOVE BCSS      KSESN                    S01117 E34618
     C***********          MOVE BCMK      KMKTI                    S01117 E34618
     C***********          EXSR PPCCHN                             S01117 E34618
     C************INU7     IFEQ '1'                                S01117 E34618
     C***********          GOTO EAUDIT                             S01117 E34618
     C***********          END                                     S01117 E34618
     C*                                                                   CAC002
     C**  If Analytical Accounting module is installed, access related    CAC002
     C**  book profit centre.                                             CAC002
     C*                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
     C*                                                                   CAC002
     C           *LIKE     DEFN RECI      WRECI                           CAC002
     C           *LIKE     DEFN BOKC      WBOKC                           CAC002
     C           *LIKE     DEFN BRCA      WBRCA                           CAC002
     C           *LIKE     DEFN SESN      WSESN                           CAC002
     C           *LIKE     DEFN MKTI      WMKTI                           CAC002
     C           *LIKE     DEFN LCD       WLCD                            CAC002
     C           *LIKE     DEFN CHTP      WCHTP                           CAC002
     C           *LIKE     DEFN TNLU      WTNLU                           CAC002
     C*                                                                   CAC002
     C                     MOVE RECI      WRECI                           CAC002
     C                     MOVE BOKC      WBOKC                           CAC002
     C                     MOVE BRCA      WBRCA                           CAC002
     C                     MOVE SESN      WSESN                           CAC002
     C                     MOVE MKTI      WMKTI                           CAC002
     C                     MOVE LCD       WLCD                            CAC002
     C                     MOVE CHTP      WCHTP                           CAC002
     C                     MOVE TNLU      WTNLU                           CAC002
     C*                                                                   CAC002
     C                     MOVE BCBO      KBOKC                           CAC002
     C                     MOVE BCBA      KBRCA                           CAC002
     C                     MOVE BCSS      KSESN                           CAC002
     C                     MOVE BCMK      KMKTI                           CAC002
      *                                                                   CAC005
      ** If CAC005 is installed, retrieve user book                       CAC005
      ** BCBO in the Book Position file is being held as a pseudo book    CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM *BLANKS   PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C                     PARM           PBKCD   2                       CAC005
     C                     PARM           PPRFC   4                       CAC005
     C                     PARM BCBO      PPSBK   2                       CAC005
      *                                                                   CAC005
     C           PRTCD     IFNE *BLANKS                                   CAC005
     C           *LOCK     IN   LDA                                       CAC005
     C                     MOVEL'SDBKPCPD'DBFILE           ************   CAC005
     C                     Z-ADD27        DBASE            * DBERR  27*   CAC005
     C                     MOVELBCBO      DBKEY            ************   CAC005
     C                     MOVE *ON       *INU7                           CAC005
     C                     MOVE *ON       *INU8                           CAC005
     C                     OUT  LDA                                       CAC005
     C                     DUMP                                           CAC005
     C                     ENDIF                                          CAC005
     C                     ELSE                                           CAC005
     C           BKPRCU    IFEQ 'Y'                                                          BUG8813
     C                     EXSR PPCCHN                                    CAC002
     C                     ENDIF                                                             BUG8813
     C                     ENDIF                                          CAC005
     C           *INU7     IFEQ '1'                                       CAC002
     C                     GOTO EAUDIT                                    CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C                     MOVE WRECI     RECI                            CAC002
     C                     MOVE WBOKC     BOKC                            CAC002
     C                     MOVE WBRCA     BRCA                            CAC002
     C                     MOVE WSESN     SESN                            CAC002
     C                     MOVE WMKTI     MKTI                            CAC002
     C                     MOVE WLCD      LCD                             CAC002
     C                     MOVE WCHTP     CHTP                            CAC002
     C                     MOVE WTNLU     TNLU                            CAC002
     C*                                                                   CAC002
     C                     ENDIF                                          CAC002
     C*
     C* IF POSITION HAS NOT CHANGED - STORE NEW ACTION DATE
     C*
     C           BCKEYP    IFEQ BCKEY
     C                     Z-ADDBCAD      KBCAD
     C                     ELSE
     C*
     C* IF POSITION HAS CHANGED
     C*    and an Action has been processed                               E22957
     C***********                                                         E22957
     C*****-**PRODUCE*UNREALISED*P/L*KEYS*I *REQUIRED***********          E22957
     C***********                                                         E22957
     C           BCKEYP    IFNE *BLANK
     C           *IN20     ANDEQ'1'                                       E22957
     C*                                                                   E22957
     C*** Amortise Prem/Discount to Last Date Accrued to                  E22957
     C***     Set by SE2210 and SE2230                                    E22957
     C*                                                                   E22957
     C                     Z-ADDBCAD      BCADXX  50                      E22957
     C*********************Z-ADDLATD      BCAD                     E22957 E29207
     C***********LATDXX    IFGT BCAD                               E29207 E32464
     C           LATDXX    IFGT LATD                                      E32464
     C                     Z-ADDLATDXX    BCAD                            E29207
     C                     ELSE                                           E32464
     C                     Z-ADDLATD      BCAD                            E32464
     C                     END                                            E29207
     C*                                                                   E22957
     C                     MOVEL'N'       AMTDP   1                       E22957
     C********** KBCTV     IFEQ 'V'                                                 241968 AR1066579
     C           MATY      IFNE 99999                                     E22957
     C           STAD      IFEQ 'Y'                                       E22957
     C           STAD      OREQ 'C'                                       E22957
     C/COPY WNCPYSRC,SE2220C218
     C           STBS      OREQ 'D'                                       E22957
     C           GDPK      ANDEQ'Y'                                       E22957
     C*                                                                   E22957
     C/COPY WNCPYSRC,SE2220C118
      *                                                                                       CSE105
      ** If CSE105 is installed, perform the routines when the new                            CSE105
      ** Trade/Value Amortization flag is "Both" or EQUAL to previous                         CSE105
      ** Trade Basis Indicator.                                                               CSE105
      *                                                                                       CSE105
     C                     MOVE ' '       IPL7K   1                                           CSE105
     C           CSE105    IFEQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQ'B'                                                           CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQKBCTV                                                         CSE105
     C           CSE105    OREQ 'N'                                                           CSE105
     C           CSE105    IFEQ 'Y'                                                           CSE105
     C                     MOVE 'K'       IPL7K                                               CSE105
     C                     END                                                                CSE105
      *                                                                                       CSE105
      *                                                                   CSE006
      *** Only do SR/AMORT if BYSL not eq 'Y' and switchable feature      CSE006
      *** is on.                                                          CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
      *                                                                   CSE006
     C                     EXSR AMORT                                     E22957
     C                     EXSR AVPRAM                                    E22957
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C/COPY WNCPYSRC,SE2220C119
      *                                                                                       CSE105
     C                     ENDIF                                                              CSE105
     C                     MOVE ' '       IPL7K                                               CSE105
      *                                                                                       CSE105
     C                     END                                            E22957
     C                     END                                            E22957
     C**********           END                                                      241968 AR1066579
     C*                                                                   E22957
     C**  ACCRUED TO DATE (ICLD) SET BY SE2210 and SE2230                 E22957
     C*                                                                   E22957
     C           KBCTV     IFEQ 'V'                                       E22957
     C           ICLD      ANDGEKBCAD                                     E22957
     C           DYBS      ANDNE'4'                                       E22957
     C                     Z-ADDICLD      BCAD                            E22957
     C*                                                                   E22957
     C*   ACCRUE INTEREST ON THIS POSITION IF REQUIRED                    E22957
     C*                                                                   E22957
     C           PROT      IFEQ '1'                                       E22957
     C           PROT      OREQ '3'                                       E22957
     C           PROT      OREQ '5'                                       E22957
     C           PROT      OREQ '6'                                       E22957
     C           PROT      OREQ '8'                                       E22957
     C           PROT      OREQ '9'                                       E22957
     C                     MOVE 'Y'       DADJN                           100017
     C                     EXSR ACCRUE                                    E22957
     C                     MOVE 'N'       DADJN                           100017
     C                     END                                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C                     Z-ADDBCADXX    BCAD                            E22957
     C*                                                                   E22957
     C*    -  PRODUCE UNREALISED P/L KEYS IF REQUIRED                     E22957
     C*                                                                   E22957
     C           AUPR      IFEQ 'Y'
     C           UPPS      ANDNE' '
     C           APDA      ANDGEDNWD                                      E22957
      *                                                                   E21531
      ***  Don't generate Unrealized P/L Keys in Reversal mode.           E21531
     C           *INU1     ANDEQ'0'                                       E21531
     C*
     C           UPBS      IFEQ 'B'
     C           UPBS      OREQ KBCTV
     C*                                                                   091803
     C***  Chain to SECTYD FILE EARLIER WAS REMOVED BECAUSE IT WAS        091803
     C***  DEEMED POINTLESS, BUT THEN WHEN DOING THE UNRLPL SUBR.         091803
     C***  SYSTEM NEEDS MARKET PRICE FROM THE SECTYD FILE.                091803
     C*                                                                   091803
     C                     EXSR SECCHN                                    091803
     C           *INU7     IFEQ '1'                                       091803
     C                     GOTO ENDLP                                     091803
     C                     END                                            091803
     C/COPY WNCPYSRC,SE2220C135
      *                                                                                       CSE036
      ** If CSE036 don't do unrealised P/L                                                    CSE036
      *                                                                                       CSE036
     C           CSE036    IFEQ 'Y'                                                           CSE036
     C                     MOVE 'N'       #EXSR   1                                           CSE036
     C                     ENDIF                                                              CSE036
      *                                                                   CSE006
      *** Only do SR/UNRLPL if BYSL not eq 'Y' and switchable feature     CSE006
      *** is on.                                                          CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
      *                                                                   CSE006
     C                     EXSR UNRLPL
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C/COPY WNCPYSRC,SE2220C136
     C                     END
     C*
     C                     END
     C*
     C*    - UPDATE OR ADD BOOK POSITION HEADER AND COUNT RECORD FOR
     C*        BOOK POSITION ADDED OR CHANGED
     C*
     C           *IN10     IFEQ '1'
     C                     EXSR U02
     C                     ELSE
     C                     EXSR W03
     C***********          SETOF                     19            E15965 E22957
     C                     END
     C*
     C* UPDATE/ADD BOOK POSITION MONTHLY STATS FILE RECORD
     C*******IF*NOT*A*REVERSAL*RUN*************************************   E19485
      ** BKMTH must be updated even in reversal mode because RPTM, DPTM,  E19485
      ** DPTR and DPSP may change. (Note: SEC0605B amended accordingly)   E19485
      ** *** THIS CHANGE IS REQUIRED FOR LOTS OF FIXES!                   E19485
      ***  Also affects the Interest fields.                              E20085
     C*
     C********** *INU1     IFEQ '0'                                       E19485
     C*
     C           *IN12     IFEQ '1'
     C                     EXSR U04
     C                     ELSE
     C                     EXSR W04
     C                     END
     C*                                                                   E21232
     C***********                                                  E21232 E22957
     C****IF*THIS*IS*A*REVERSAL*RUN,*ACCRUE*TO******************** E21232 E22957
     C****ACCRUED*TO*DATE*(ICLD)*SET*BY*SE2230*(LPSD*OR*LPCD)***** E21232 E22957
     C***********                                                  E21232 E22957
     C************INU1     IFEQ '1'                                E21232 E22957
     C***********KBCTV     ANDEQ'V'                                E21232 E22957
     C***********ICLD      ANDGT*ZERO                              E21232 E22957
     C***********DYBS      ANDNE'4'                                E21232 E22957
     C***********          Z-ADDBCAD      BCADXX  50               E21232 E22957
     C***********          Z-ADDICLD      BCAD                     E21232 E22957
     C***********                                                  E21232 E22957
     C****ACCRUE*INTEREST*ON*THIS*POSITION*IF*REQUIRED************ E21232 E22957
     C***********                                                  E21232 E22957
     C***********PROT      IFEQ '1'                                E21232 E22957
     C***********PROT      OREQ '3'                                E21232 E22957
     C***********PROT      OREQ '5'                                E21232 E22957
     C***********PROT      OREQ '6'                                E21232 E22957
     C***********PROT      OREQ '8'                                E21232 E22957
     C***********PROT      OREQ '9'                                E21232 E22957
     C***********          EXSR ACCRUE                             E21232 E22957
     C***********          END                                     E21232 E22957
     C***********          Z-ADDBCADXX    BCAD                     E21232 E22957
     C***********          END                                     E21232 E22957
     C***********                                                         E22957
     C****ELSE*IF*THIS*IS*A*REVERSAL*RUN,*ACCRUE/AMORTIZE*TO****** E18651 E20087
     C****ACCRUED*TO*DATE*(ICLD)*SET*BY*SE2230*(LPSD*OR*LPCD)***** E18651 E20087
     C***********                                                  E18651 E20087
     C***********          ELSE                                    E18651 E20087
     C***********KBCTV     IFEQ 'V'                                E18651 E20087
     C***********ICLD      ANDGT*ZERO                              E18651 E20087
     C***********          Z-ADDBCAD      BCADXX  50               E18651 E20087
     C***********          Z-ADDICLD      BCAD                     E18651 E20087
     C***********                                                  E18651 E20087
     C****PRODUCE*AMORTISED*DISC/PREM*KEYS*IF*DISC/PREM*TO*BE*AMORTISED 1 E18651
     C***********                                                  E18651 E20087
     C***********MATY      IFNE 99999                              E18651 E20087
     C***********STAD      IFEQ 'Y'                                E18651 E20087
     C***********STBS      OREQ 'D'                                E18651 E20087
     C***********GDPK      ANDEQ'Y'                                E18651 E20087
     C***********          EXSR AMORT                              E18651 E20087
     C***********          EXSR AVPRAM                             E18651 E20087
     C***********          END                                     E18651 E20087
     C***********          END                                     E18651 E20087
     C***********                                                  E18651 E20087
     C****ACCRUE*INTEREST*ON*THIS*POSITION*IF*REQUIRED************ E18651 E20087
     C***********                                                  E18651 E20087
     C***********PROT      IFEQ '1'                                E18651 E20087
     C***********PROT      OREQ '3'                                E18651 E20087
     C***********PROT      OREQ '5'                                E18651 E20087
     C***********PROT      OREQ '6'                                E18651 E20087
     C***********PROT      OREQ '8'                                E18651 E20087
     C***********PROT      OREQ '9'                                E18651 E20087
     C***********DYBS      IFNE '4'                                E18651 E20087
     C***********          EXSR ACCRUE                             E18651 E20087
     C***********          END                                     E18651 E20087
     C***********          END                                     E18651 E20087
     C***********          Z-ADDBCADXX    BCAD                     E18651 E20087
     C***********                                                  E18651 E20087
     C***********          END                                     E18651 E20087
     C*
     C***********          END                                            E19485
     C*
     C* IF END OF FILE WAS ENCOUNTERED - END PROGRAM
     C*
     C           *IN89     IFEQ '1'
     C                     GOTO ENDLP
     C                     END
     C*
     C                     END
     C*
     C*  - ACCESS BOOK POSITION HEADER AND LATEST BOOK POSITION FOR NEW
     C*    ACTION READ (STORE NEW ACTION KEY)
     C*
     C                     Z-ADD0         WRPTP  130
      *                                                                   E19485
      ** No longer need to accumulate realized P/L from BPACHD records.   E19485
     C***********          Z-ADD0         XBCPL  130                      E19485
     C*
     C                     MOVE BCKEY     BCKEYP
     C                     Z-ADDBCAD      KBCAD
     C*
     C                     EXSR BKHCHN
     C           *IN10     IFEQ '1'
     C*
     C                     EXSR BKPCHN
     C************INU7     IFEQ '1'                                       E22957
     C***********          GOTO ENDLP                                     E22957
     C***********          END                                            E22957
     C                     END                                            E19485
      *                                                                   E19485
      ** If reversal run, chain to BKMTH even if BKPHR record not found.  E19485
      ** (SE2230 may not have written a record to BKPHR.)                 E19485
      *                                                                   E19485
     C           *IN10     IFEQ '1'                                       E19485
     C           *INU1     OREQ '1'                                       E19485
     C                     EXSR BKMCHN
     C************INU7     IFEQ '1'                                       E19485
     C************         GOTO ENDLP                                     E19485
     C************         END                                            E19485
     C                     END
     C*
     C**SETUP*FIELDS*FOR*ACCUMULATION*OF*BOOK*POSITION*HEADER*AND*DETAIL  E15965
     C*******FIELDS****************************************************   E15965
     C***********                                                         E15965
     C***********          EXSR BKSET                                     E15965
     C*
     C* ACCESS BOOK DESC. FILE
     C*
     C                     EXSR BOKCHN
     C           *INU7     IFEQ '1'
     C                     GOTO ENDLP
     C                     END
     C*
     C* ACCESS SECURITIES FILE AND INVESTMENT TYPE
     C*
     C                     EXSR SECCHN
     C           *INU7     IFEQ '1'
     C                     GOTO ENDLP
     C                     END
     C*
     C                     EXSR INVCHN
     C           *INU7     IFEQ '1'
     C                     GOTO ENDLP
     C                     END
     C*                                                                   E34618
     C**  Access related Book PositionProfit Centre                       E34618
      ***  ... if Profit Centres are used and Trade and Book Positions    E40425
      ***  are to be reconciled.                                          E40425
      *                                                                   E40425
     C           PFUS      IFEQ 'Y'                                       E40425
     C********** TBRC      ANDEQ'Y'                                       E40425 188515
     C*                                                                   E34618
     C                     MOVE BCBO      KBOKC                           E34618
     C                     MOVE BCBA      KBRCA                           E34618
     C                     MOVE BCSS      KSESN                           E34618
     C                     MOVE BCMK      KMKTI                           E34618
      *                                                                   CAC005
      ** If CAC005 is installed, call AOBKPCR0                            CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM *BLANKS   PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C                     PARM           PBKCD   2                       CAC005
     C                     PARM           PPRFC   4                       CAC005
     C                     PARM BCBO      PPSBK   2                       CAC005
      *                                                                   CAC005
     C           PRTCD     IFNE *BLANKS                                   CAC005
     C           *LOCK     IN   LDA                                       CAC005
     C                     MOVEL'SDBKPCPD'DBFILE           ************   CAC005
     C                     Z-ADD28        DBASE            * DBERR  28*   CAC005
     C                     MOVELBCBO      DBKEY            ************   CAC005
     C                     MOVE *ON       *INU7                           CAC005
     C                     MOVE *ON       *INU8                           CAC005
     C                     OUT  LDA                                       CAC005
     C                     DUMP                                           CAC005
     C                     ENDIF                                          CAC005
     C                     ELSE                                           CAC005
     C                     EXSR PPCCHN                                    E34618
     C                     ENDIF                                          CAC005
     C           *INU7     IFEQ '1'                                       E34618
     C                     GOTO EAUDIT                                    E34618
     C                     END                                            E34618
      *                                                                   E40425
     C                     END                                            E40425
      *                                                                   E20085
      ***  Event Control Date only needs to be obtained ONCE, not every   E20085
      ***  Position change! Moved ZEVCD execution to SR/FIRST.            E20085
     C***********                                                         E20085
     C**CALCULATE*EVENT*CONTROL*DATE*AND*THEN*NEXT*COUPON*DATE*********   E20085
     C***********                                                         E20085
     C***********          EXSR ZEVCD                                     E20085
      *                                                                   CSE005
      ** rename SSITP as SITP before calling ZNCD/ZLCD                    CSE005
      *                                                                   CSE005
     C                     MOVE SSITP     SITP    3                       CSE005
      *                                                                   E20085
      ***  Obtain Next Coupon Date.                                       E20085
     C                     EXSR ZNCD
     C*
     C* OBTAIN NOMINAL CURRENCY DECIMAL PLACES FROM TABTG10
     C*
     C                     EXSR TABCHN
     C           *INU7     IFEQ '1'
     C                     GOTO ENDLP
     C                     END
     C                     Z-ADDCDP       NCDP                            S01232
     C*                                                                   S01117
     C** Set up currency decimal places parameter for use in:-            S01117
     C** SR.ZACCR - Calculate interest accrued between two dates          S01117
     C** SR.ZACCZ - Calculate interest accrued between two specified datesS01117
     C** SR.ZAVPR - Calculate average price                               S01117
     C** SR.ZCNSD - Calculate consideration                               S01117
     C*                                                                   S01117
     C                     Z-ADDCDP       ZCDP                            S01117
     C*                                                                   E15965
     C* SETUP FIELDS FOR ACCUMULATION OF BOOK POSITION HEADER AND DETAIL  E15965
     C*      FIELDS                                                       E15965
     C                     EXSR BKSET                                     E15965
     C*
     C                     MOVE '0'       *IN20
     C                     END
     C*
     C* PROCESS REVERSED ACTIONS
     C*
     C           BCRV      IFEQ 'Y'
     C                     EXSR REVMTH
     C** - Set *in20 on to process upto ICLD/LATD                         E22957
     C                     MOVE '1'       *IN20                           E22957
     C                     GOTO ENDLP
     C                     END
     C*
     C* EXECUTE SUBROUTINES DEPENDING ON TYPE OF ACTION READ
     C*
     C           BCAS      CASEQ'05'      P05
     C***********BCAS      CASEQ'10'      P10                             E18652
     C           BCAS      CASEQ'40'      P10                             E18652
     C           BCAS      CASEQ'20'      P20
     C           BCAS      CASEQ'30'      P30
     C           BCAS      CASEQ'35'      P35
     C           BCAS      CASEQ'50'      P50
     C           BCAS      CASEQ'60'      P60
     C           BCAS      CASEQ'70'      P70                             E14236
     C                     END
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C           BCAS      IFEQ '80'                                                          CSE065
     C                     EXSR P80                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C*
     C* IF ACTION HAS BEEN PROCESSED IN CASE - UPDATE ACTION
     C*    ELSE IGNORE
     C*
     C           *IN20     IFEQ '1'
     C                     EXSR U01
     C           ICLD      IFLT BCAD                                      E22957
     C           BCAS      ANDNE'60'                                      090108
     C                     Z-ADDBCAD      ICLD                            E22957
     C                     END                                            E22957
     C                     Z-ADDBCAD      LPCD                            E22957
     C                     END
     C*
     C           ENDLP     TAG                             ***  ENDLP  ***
      *
      ***  END of Do Until Read/Process all BPACC records.
     C                     END
     C*
     C* UPDATE BOOK POSTION AUDIT RECORD AND OUTPUT CONTROL REPORT
     C*
     C           EAUDIT    TAG
     C*
     C                     EXSR AUDIT
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *                                                               *
     C/COPY WNCPYSRC,SE2220C204
     C                     SETON                     LR
      *                                                               *
      *================================================================
      /EJECT
      *****************************************************************
      *                                                               *
      * FIRST - SUBROUTINE TO ACCESS ICD INFORMATION AND TO CALCULATE *
      *         ACCRUAL CONTROL DATE                                  *
      *                                                               *
      *****************************************************************
      *
     C           FIRST     BEGSR                           *** FIRST  ***
     C*
     C* ACCESS ICD
     C*
     C                     EXSR ZSYSTM
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE 'TABLE'   DBFILE           ***************
     C                     MOVELZTABKY    DBKEY            * DB ERROR 01 *
     C                     Z-ADD1         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C*
     C* ACCESS ICD2
     C*
     C                     EXSR ZICD2
     C           *INU7     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE '1'       *IN99
     C                     MOVE 'TABLE'   DBFILE           ***************
     C                     MOVELTKEY      DBKEY            * DB ERROR 02 *
     C                     Z-ADD2         DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C*
     C*
     C* ACCESS ZICDSE
     C*
     C                     EXSR ZICDSE
     C           *INU8     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     SETON                     99U7
     C                     MOVEL'TABLE'   DBFILE           ***************
     C                     MOVELTKEY      DBKEY            * DB ERROR 03 *
     C                     Z-ADD03        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
      *                                                                   E40425
     C                     ELSE                                           E40425
      *                                                                   E40425
     C                     MOVE *BLANKS   TKEY                            E40425
     C                     MOVEL'01'      TKEY                            E40425
     C                     MOVE '40'      TKEY                            E40425
     C           TKEY      CHAINTABTB40F             80                   E40425
      *                                                                   E40425
     C           *IN80     IFEQ '1'                                       E40425
     C           RECI      ORNE 'D'                                       E40425
     C           *LOCK     IN   LDA                                       E40425
     C                     Z-ADD10        DBASE            ***************E40425
     C                     MOVEL'TABTB40' DBFILE           * DB ERROR 10 *E40425
     C                     MOVELTKEY      DBKEY            ***************E40425
     C                     SETON                     U7U8                 E40425
     C                     OUT  LDA                                       E40425
     C                     DUMP                                           E40425
      *                                                                   E40425
     C                     ELSE
     C*                                                                   S01486
     C**  Get module details using access object                          S01486
     C*                                                                   S01486
     C                     CALL 'AOMMODR0'                                S01486
     C                     PARM *BLANKS   WLRTCD  7                       S01486
     C                     PARM '*FIRST'  WLOPTN  7                       S01486
     C           SDMMOD    PARM SDMMOD    DSFDY                           S01486
     C*                                                                   S01486
     C           WLRTCD    IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD25        DBASE            ***************S01486
     C                     MOVE 'SDMMODPD'DBFILE           * DB ERROR 25 *S01486
     C                     MOVELWLOPTN    DBKEY            ***************S01486
     C                     SETON                     U7U8                 S01486
     C                     OUT  LDA                                       S01486
     C                     DUMP                                           S01486
     C*                                                                   S01486
     C                     ELSE                                           S01486
     C***********                                                  S01486 CPM004
     C****Check*if Portfolio Management is present                 S01486 CPM004
     C***********                                                  S01486 CPM004
     C***********BGPFMG    IFEQ 'Y'                                S01486 CPM004
     C***********          MOVE '1'       *IN39                    S01486 CPM004
     C***********          END                                     S01486 CPM004
     C*                                                                   CAC002
     C**  Access Securities Trading details                               CAC002
     C*                                                                   CAC002
     C                     CALL 'AOSTRDR0'                                CAC002
     C                     PARM *BLANKS   WLRTCD                          CAC002
     C                     PARM '*FIRST ' WLOPTN                          CAC002
     C           SDSTRD    PARM SDSTRD    DSSDY                           CAC002
      *                                                                   CAC002
     C           WLRTCD    IFNE *BLANKS                                   CAC002
     C           *LOCK     IN   LDA                                       CAC002
     C                     Z-ADD26        DBASE            ************   CAC002
     C                     MOVEL'SDSTRDPD'DBFILE           * DBERR 26 *   CAC002
     C                     MOVELWLOPTN    DBKEY            ************   CAC002
     C                     OUT  LDA                                       CAC002
     C                     SETON                     U7U8                 CAC002
     C                     DUMP                                           CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CPM004
     C** If Portfolio Management is present, get ICD                      CPM004
     C*                                                                   CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C                     CALL 'AOPORTR0'                                CPM004
     C                     PARM *BLANKS   WLRTCD                          CPM004
     C                     PARM '*FIRST'  WLOPTN                          CPM004
     C           SDPORT    PARM SDPORT    DSFDY                           CPM004
     C           WLRTCD    IFNE *BLANKS                                   CPM004
     C           *LOCK     IN   LDA                                       CPM004
     C                     Z-ADD90        DBASE            ***************CPM004
     C                     MOVE 'SDPORTPD'DBFILE           * DB ERROR 90 *CPM004
     C                     MOVELWLOPTN    DBKEY            ***************CPM004
     C                     SETON                     U7U8                 CPM004
     C                     OUT  LDA                                       CPM004
     C                     DUMP                                           CPM004
     C                     END                                            CPM004
     C                     END                                            CPM004
     C/COPY WNCPYSRC,SE2220C175
     C*                                                                   S01117
     C** Set up date next working day and accrual profit date parameters  S01117
     C** for use in SR.ZEVCD - Determine event control date               S01117
     C*                                                                   S01117
     C                     Z-ADDDNWD      ZZDNWD                          S01117
     C                     Z-ADDAPDA      ZZAPDT                          S01117
     C*
     C* READ IN DATA AREA SESTAT
     C*
     C           *NAMVAR   DEFN           SESTAT
     C                     IN   SESTAT
     C/COPY WNCPYSRC,SE2220C115
      *                                                                                       CSE035
      ** Access SAR details file to see if CSE035 is installed                                CSE035
      *                                                                                       CSE035
     C                     CALL 'AOSARDR0'                                                    CSE035
     C                     PARM *BLANKS   @RTCD                                               CSE035
     C                     PARM '*VERIFY' @OPTN                                               CSE035
     C                     PARM 'CSE035'  @SARD                                               CSE035
      *                                                                                       CSE035
     C           @RTCD     IFEQ *BLANK                                                        CSE035
     C                     MOVE 'Y'       CSE035  1                                           CSE035
     C                     ELSE                                                               CSE035
     C                     MOVE 'N'       CSE035                                              CSE035
     C                     ENDIF                                                              CSE035
      *                                                                                       207543
      ** Access SAR details file to see if CEU018 is installed                                207543
      *                                                                                       207543
     C                     CALL 'AOSARDR0'                                                    207543
     C                     PARM *BLANKS   @RTCD                                               207543
     C                     PARM '*VERIFY' @OPTN                                               207543
     C                     PARM 'CEU018'  @SARD                                               207543
      *                                                                                       207543
     C           @RTCD     IFEQ *BLANK                                                        207543
     C                     MOVE 'Y'       CEU018  1                                           207543
     C                     ELSE                                                               207543
     C                     MOVE 'N'       CEU018                                              207543
     C                     ENDIF                                                              207543
      *                                                                                       CSE036
      ** Access SAR details file to see if CSE036 is installed                                CSE036
      *                                                                                       CSE036
     C                     CALL 'AOSARDR0'                                                    CSE036
     C                     PARM *BLANKS   @RTCD                                               CSE036
     C                     PARM '*VERIFY' @OPTN                                               CSE036
     C                     PARM 'CSE036'  @SARD                                               CSE036
      *                                                                                       CSE036
     C           @RTCD     IFEQ *BLANK                                                        CSE036
     C                     MOVE 'Y'       CSE036  1                                           CSE036
     C                     ELSE                                                               CSE036
     C                     MOVE 'N'       CSE036                                              CSE036
     C                     ENDIF                                                              CSE036
      *                                                                   E20085
      ***  Define End of Previous Month field from SESTAT as a numeric.   E20085
      *                                                                   E20085
     C                     MOVE EOPM      EOPMTH  50                      E20085
      *                                                                   E20085
      ***  Obtain Event Control Date.                                     E20085
      *                                                                   E20085
     C                     EXSR ZEVCD                                     E20085
     C*
     C                     END                                            S01486
     C*                                                                   S01486
     C                     END
     C                     END                                            E40425
     C                     END
     C                     END
      *                                                                   CAC005
      ** Check if CAC005 is installed                                     CAC005
      *                                                                   CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   PRTCD   7                       CAC005
     C                     PARM '*VERIFY' POPTN   7                       CAC005
     C                     PARM 'CAC005'  PSARD   6                       CAC005
      *                                                                   CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVE 'Y'       CAC005  1                       CAC005
     C                     ELSE                                           CAC005
     C                     MOVE 'N'       CAC005                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CSE006
      ** Check if CSE006 is installed                                     CSE006
      *                                                                   CSE006
     C                     CALL 'AOSARDR0'                                CSE006
     C                     PARM *BLANKS   PRTCD                           CSE006
     C                     PARM '*VERIFY' POPTN                           CSE006
     C                     PARM 'CSE006'  PSARD   6                       CSE006
     C           SCSARD    PARM SCSARD    DSFDY                           CSE006
      *                                                                   CSE006
      * Database Error                                                    CSE006
      *                                                                   CSE006
     C           PRTCD     IFNE *BLANKS                                   CSE006
     C           PRTCD     ANDNE'*NRF'                                    CSE006
     C           *LOCK     IN   LDA                                       CSE006
     C                     MOVEL'SCSARDPD'DBFILE           ***************CSE006
     C                     MOVEL'*FIRST'  DBKEY            * DB ERROR 23 *CSE006
     C                     Z-ADD23        DBASE            ***************CSE006
     C                     OUT  LDA                                       CSE006
     C                     SETON                     U7U8                 CSE006
     C                     DUMP                                           CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C           PRTCD     IFEQ *BLANK                                    CSE006
     C                     MOVEL'Y'       CSE006  1                       CSE006
     C                     ELSE                                           CSE006
     C                     MOVEL'N'       CSE006                          CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
      **  Determine if feature CSE032 is installed.                       CSE032
      *                                                                   CSE032
     C                     MOVE 'N'       CSE032  1                       CSE032
     C                     CALL 'AOSARDR0'                                CSE032
     C                     PARM '       ' @RTCD   7                       CSE032
     C                     PARM '*VERIFY' @OPTN   7                       CSE032
     C                     PARM 'CSE032'  @SARD   6                       CSE032
      *                                                                   CSE032
     C           @RTCD     IFEQ *BLANK                                    CSE032
     C                     MOVE 'Y'       CSE032                          CSE032
     C                     END                                            CSE032
     C*
     C                     CALL 'AOSARDR0'                                                    CAS006
     C                     PARM *BLANKS   PRTCD   7                                           CAS006
     C                     PARM '*VERIFY' POPTN   7                                           CAS006
     C                     PARM 'CAS006'  PSARD   6                                           CAS006
     C           SCSARD    PARM SCSARD    DSFDY                                               CAS006
      *                                                                                       CAS006
     C           PRTCD     IFNE *BLANKS                                                       CAS006
     C           PRTCD     ANDNE'*NRF    '                                                    CAS006
     C           *LOCK     IN   LDA                                                           CAS006
     C                     MOVE 'SCSARDPD'DBFILE                                              CAS006
     C                     Z-ADD46        DBASE                                               CAS006
     C                     MOVEL'CAS006'  DBKEY                                               CAS006
     C                     MOVE '1'       *INU7                                               CAS006
     C                     MOVE '1'       *INU8                                               CAS006
     C                     OUT  LDA                                                           CAS006
     C                     EXSR *PSSR                                                         CAS006
     C                     MOVE '1'       *INLR                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C           PRTCD     IFEQ *BLANKS                                                       CAS006
     C                     MOVE 'Y'       CAS006  1                                           CAS006
     C                     ELSE                                                               CAS006
     C                     MOVE 'N'       CAS006                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       228948
      ** If SE Hedge Accounting is ON (CAS006), access Hedge ICD                              228948
      *                                                                                       228948
     C           CAS006    IFEQ 'Y'                                                           228948
     C                     CALL 'AOHEDGR0'                                                    228948
     C                     PARM *BLANKS   PRTCD                                               228948
     C                     PARM '*FIRST ' POPTN                                               228948
     C           SDHEDG    PARM SDHEDG    DSSDY                                               228948
      *                                                                                       228948
     C           PRTCD     IFNE *BLANK                                                        228948
     C           *LOCK     IN   LDA                                                           228948
     C                     MOVEL'SDHEDGPD'DBFILE                                              228948
     C                     Z-ADD13        DBASE                                               228948
     C                     MOVEL'*FIRST'  DBKEY                                               228948
     C                     OUT  LDA                                                           228948
     C                     SETON                     U7U8LR                                 BUG24061
     C                     EXSR *PSSR                                                         228948
      ** Call Database Error Control program.                                               BUG24061
      *                                                                                     BUG24061
     C                     CALL 'DBERRCTL'                                                  BUG24061
      *                                                                                     BUG24061
     C                     ENDIF                                                              228948
     C                     ENDIF                                                              228948
      *                                                                                      BUG8813
      ** Access General Ledger details                                                       BUG8813
      *                                                                                      BUG8813
     C                     CALL 'AOGELRR1'                                                   BUG8813
     C                     PARM '*DBERR ' @RTCD   7                                          BUG8813
     C                     PARM '*FIRST ' @OPTN   7                                          BUG8813
     C           SDGELR    PARM SDGELR    DSSDY                                              BUG8813
      *                                                                                       CSE065
      ** Check if CSE065 feature is installed                                                 CSE065
      *                                                                                       CSE065
     C                     CALL 'AOSARDR0'                                                    CSE065
     C                     PARM *BLANKS   PRTCD                                               CSE065
     C                     PARM '*VERIFY' POPTN                                               CSE065
     C                     PARM 'CSE065'  PSARD                                               CSE065
     C           SCSARD    PARM SCSARD    DSFDY                                               CSE065
      *                                                                                       CSE065
     C           PRTCD     IFNE *BLANKS                                                       CSE065
     C           PRTCD     ANDNE'*NRF    '                                                    CSE065
     C           *LOCK     IN   LDA                                                           CSE065
     C                     MOVE 'SCSARDPD'DBFILE                                              CSE065
     C                     Z-ADD47        DBASE                                               CSE065
     C                     MOVEL'CSE065'  DBKEY                                               CSE065
     C                     MOVE '1'       *INU7                                               CSE065
     C                     MOVE '1'       *INU8                                               CSE065
     C                     OUT  LDA                                                           CSE065
     C                     EXSR *PSSR                                                         CSE065
     C                     MOVE '1'       *INLR                                               CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C           PRTCD     IFEQ *BLANKS                                                       CSE065
     C                     MOVE 'Y'       CSE065  1                                           CSE065
     C                     ELSE                                                               CSE065
     C                     MOVE 'N'       CSE065                                              CSE065
     C                     ENDIF                                                              CSE065
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CCP7                                           S01408
      *                                                                                       CSE105
      ** Access SAR details file to see if feature CSE105 is installed.                       CSE105
      *                                                                                       CSE105
     C                     CALL 'AOSARDR0'                                                    CSE105
     C                     PARM '       ' @RTCD                                               CSE105
     C                     PARM '*VERIFY' @OPTN                                               CSE105
     C                     PARM 'CSE105'  @SARD                                               CSE105
     C           SCSARD    PARM SCSARD    DSFDY                                               CSE105
      *                                                                                       CSE105
     C           @RTCD     IFEQ *BLANKS                                                       CSE105
     C                     MOVE 'Y'       CSE105  1                                           CSE105
     C                     ELSE                                                               CSE105
     C                     MOVE 'N'       CSE105                                              CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
      ** Check system values if CSE105 is switched on                                         CSE105
      *                                                                                       CSE105
     C           CSE105    IFEQ 'Y'                                                           CSE105
      *                                                                                       CSE105
     C                     CALL 'AOSVALR0'                                                    CSE105
     C                     PARM *BLANKS   @RTCD                                               CSE105
     C                     PARM SVALKK    SVALK1 20                                           CSE105
     C                     PARM           SVAL1 200                                           CSE105
     C                     PARM *BLANK    SVALK2 20                                           CSE105
     C                     PARM           SVAL2 200                                           CSE105
     C                     PARM *BLANK    SVALK3 20                                           CSE105
     C                     PARM           SVAL3 200                                           CSE105
     C                     PARM *BLANK    SVALK4 20                                           CSE105
     C                     PARM           SVAL4 200                                           CSE105
     C                     PARM *BLANK    SVALK5 20                                           CSE105
     C                     PARM           SVAL5 200                                           CSE105
     C                     PARM *BLANK    SVALK6 20                                           CSE105
     C                     PARM           SVAL6 200                                           CSE105
     C                     PARM *BLANK    SVALK7 20                                           CSE105
     C                     PARM           SVAL7 200                                           CSE105
     C                     PARM *BLANK    SVALK8 20                                           CSE105
     C                     PARM           SVAL8 200                                           CSE105
     C                     PARM *BLANK    SVALK9 20                                           CSE105
     C                     PARM           SVAL9 200                                           CSE105
     C                     PARM *BLANK    SVALK0 20                                           CSE105
     C                     PARM           SVAL10200                                           CSE105
      *                                                                                       CSE105
     C           @RTCD     IFNE *BLANKS                                                       CSE105
     C           *LOCK     IN   LDA                                                           CSE105
     C                     MOVE 'SDSVALPD'DBFILE                                              CSE105
     C                     MOVELSVALK1    DBKEY                                               CSE105
     C                     Z-ADD31        DBASE                                               CSE105
     C                     OUT  LDA                                                           CSE105
     C                     EXSR *PSSR                                                         CSE105
     C                     SETON                       U7U8                                   CSE105
     C                     ELSE                                                               CSE105
     C                     MOVELSVAL1     SESVAL  1                                           CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
     C           SESVAL    IFEQ *BLANKS                                                       CSE105
     C                     MOVE 'V'       SESVAL                                              CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
     C                     ENDIF                                                              CSE105
     C*                                                                   S01408
      *                                                                                       CSE075
      ** Access SAR details file to see if CSE075 is installed                                CSE075
      *                                                                                       CSE075
     C                     CALL 'AOSARDR0'                                                    CSE075
     C                     PARM *BLANKS   PRTCD                                               CSE075
     C                     PARM '*VERIFY' POPTN                                               CSE075
     C                     PARM 'CSE075'  PSARD                                               CSE075
     C           SCSARD    PARM SCSARD    DSFDY                                               CSE075
      *                                                                                       CSE075
     C           PRTCD     IFNE *BLANKS                                                       CSE075
     C           PRTCD     ANDNE'*NRF    '                                                    CSE075
     C           *LOCK     IN   LDA                                                           CSE075
     C                     MOVE 'SCSARDPD'DBFILE                                              CSE075
     C                     Z-ADD47        DBASE                                               CSE075
     C                     MOVEL'CSE075'  DBKEY                                               CSE075
     C                     MOVE *ON       *INU7                                               CSE075
     C                     MOVE *ON       *INU8                                               CSE075
     C                     MOVE *ON       *INLR                                               CSE075
     C                     OUT  LDA                                                           CSE075
     C                     EXSR *PSSR                                                         CSE075
     C                     ENDIF                                                              CSE075
      *                                                                                       CSE075
     C           PRTCD     IFEQ *BLANKS                                                       CSE075
     C                     MOVE 'Y'       CSE075  1                                           CSE075
     C                     ELSE                                                               CSE075
     C                     MOVE 'N'       CSE075                                              CSE075
     C                     ENDIF                                                              CSE075
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  BKSET  - SUBROUTINE TO SET BOOK POSITION HEADER FIELDS AND   *
      *           BOOK POSTION FIELDS                                 *
      *                                                               *
      *****************************************************************
      *
     C           BKSET     BEGSR                           *** BKSET  ***
     C*
     C* IF NO BOOK POSITION HEADER READ - SET FIELDS TO ZERO OR TO
     C*   ACTION VALUES
     C*
     C           *IN10     IFEQ '0'
     C/COPY WNCPYSRC,SE2220C139
     C                     MOVE BCSS      BHSC
     C***********          MOVE BCBR      BHBR                            S01117
     C                     MOVE BCBA      BHBA                            S01117
     C                     MOVE BCBO      BHBK
     C                     MOVE BCMK      BHMK
     C                     MOVE BCTV      BHTV
     C*
     C                     Z-ADDBCAD      FPSD
     C                     Z-ADDBCAD      LPSD
     C                     Z-ADDBCAD      LPCD
     C***********          Z-ADDBCAD      ICLD                            E18651
     C***********          Z-ADD0         ICLD                     E18651 E20087
     C***********          Z-ADDBCAD      ICLD                     E20087 E21232
     C*
     C                     Z-ADD0         LATD
     C                     Z-ADD0         DNAT                            102506
     C                     Z-ADD0         LATDXX                          E29207
     C                     Z-ADD0         ARPC
     C                     Z-ADD0         IACR
     C                     Z-ADD0         IACP
     C                     Z-ADD0         INDO
      *                                                                   E20085
      ***  DO NOT zero BKMTH fields in BKPHD processing.                  E20085
      *                                                                   E20085
     C***********          Z-ADD0         BPIT                            E20085
     C***********          Z-ADD0         TIPN                            E20085
     C***********          Z-ADD0         UPLE                            E20085
     C                     Z-ADD0         UPPT
     C                     Z-ADD0         DPAP
     C                     Z-ADD0         DPFP                            S01397
     C***********          Z-ADD0         CPDD                            E20085
     C***********          Z-ADD0         BCDM                            E20085
     C***********          Z-ADD0         BCCM                            E20085
     C                     Z-ADD0         BUDU
     C***********          Z-ADD0         MMPL                            E20085
     C***********          Z-ADD0         RPTM                            E20085
     C***********          Z-ADD0         DPTM                            E20085
     C                     Z-ADD0         LPRC
     C                     Z-ADD0         BHDP
     C                     Z-ADD0         BHCP
     C                     Z-ADD0         BHPP
     C***********          Z-ADD0         TNLU                            E20085
     C                     Z-ADD2220      TNLU                            E20085
     C                     Z-ADD0         BHTR                            E20087
     C                     Z-ADD0         BHRN                            E20087
     C                     Z-ADD0         BUDN                                                CAS006
     C                     Z-ADD0         DPAN                                                CAS006
     C                     Z-ADD0         INDN                                                CAS006
     C************IN39*****IFEQ '1'                                S01486 CPM004
     C                     Z-ADD0         LFXP                            S01486
     C*********************END                                     S01486 CPM004
     C*
     C           SPBS      IFEQ 'U'
     C                     Z-ADD0         PLAVP
     C                     Z-ADD0         LAVP
     C                     ELSE
     C                     Z-ADD100       PLAVP
     C                     Z-ADD100       LAVP
     C                     END
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           SPBS      IFEQ 'U'                                                           CAS006
     C                     Z-ADD0         LAVN                                                CAS006
     C                     ELSE                                                               CAS006
     C                     Z-ADD100       LAVN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           STAD      IFEQ 'Y'                                                           CSE065
     C           STAD      OREQ 'C'                                                           CSE065
     C           SPBS      IFEQ 'U'                                                           CSE065
     C                     Z-ADD0         NAVP                                                CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADD100       NAVP                                                CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
     C/COPY WNCPYSRC,SE2220C213
     C*
     C                     ELSE
     C*                                                                   E29207
     C* Store last amortized to date                                      E29207
     C*                                                                   E29207
     C                     Z-ADDLATD      LATDXX  50                      E29207
     C*                                                                   061822
     C* IF NO DISCOUNT/PREMIUM AMORTIZED, LATD SHOULD BE ZERO.            061822
     C* IF AMORTIZATION IS TO BE DONE, IT WILL START FROM LPSD            061822
     C*                                                                   061822
     C           DPAP      IFEQ 0                                         061822
     C                     Z-ADD0         LATD                            061822
     C                     Z-ADD0         DNAT                            102506
     C                     END                                            061822
     C*
     C* STORE FIRST AVERAGE PRICE FOR UPDATE
     C*
     C***********          Z-ADDLAVP      WLAVP  158                      E15965
     C                     Z-ADDLAVP      PLAVP
     C*                                                                   E15965
     C** IF LATEST POSITION DATE IS DIFFERENT FROM LATEST POSITION CHANGE E15965
     C** DATE THEN USE AVERAGE PRICE ON BOOK POSITION HEADER AS OPPOSED   E15965
     C** TO AVERAGE PRICE ON LATEST BOOK POSITION.THEY MAY BE DIFFERENT   E15965
     C** DUE TO AMORTIZATION OR INTERVENING MARK TO MARKET REVALUATION.   E15965
     C** THE AVERAGE PRICE NUMERATOR MUST BE CALCULATED FOR THIS PRICE.   E15965
     C*
     C************IN11     IFEQ '1'                                E15965 E22957
     C***********LPSD      ANDNELPCD                               E15965 E22957
     C***********          Z-ADDLAVP      APPB                     E15965 E22957
     C***********          Z-ADD*ZEROS    APNC0  150               E15965 E20232
     C***********          Z-ADD*ZEROS    APNC1  151               E15965 E20232
     C***********          Z-ADD*ZEROS    APNC2  152               E15965 E20232
     C***********          Z-ADD*ZEROS    APNC3  153               E15965 E20232
     C***********          MOVEA'0000'    *IN,70                   E15965 E20232
     C***********70        ADD  CDP       J       20               E15965 E20232
     C***********          MOVEA'1'       *IN,J                    E15965 E20232
     C***70******NPSN      MULT LAVP      APNC0     H              E15965 E20232
     C***71******NPSN      MULT LAVP      APNC1     H              E15965 E20232
     C***72******NPSN      MULT LAVP      APNC2     H              E15965 E20232
     C***73******NPSN      MULT LAVP      APNC3     H              E15965 E20232
     C***********                                                  E15965 E20232
     C***********                                                  E15965 E20232
     C***70******          MOVE APNC0     APNC                     E15965 E20232
     C***71******          MOVE APNC1     APNC                     E15965 E20232
     C***72******          MOVE APNC2     APNC                     E15965 E20232
     C***73******          MOVE APNC3     APNC                     E15965 E20232
     C*                                                                   E15965
     C* Reformat amount, allowing for nominal decimal places              E15965
     C*                                                                   E15965
     C***********5         SUB  NMDP      DC      10                      E15965
     C***********APNC      MULT POWER8,DC APNC      H              E15965 E20232
     C***********          Z-ADDNPSN      ZNOML                    E20232 E22957
     C***********          Z-ADDLAVP      ZPRC                     E20232 E22957
     C***********          EXSR ZCNSD                              E20232 E22957
     C***********          Z-ADDZCONS     APNC                     E20232 E22957
     C*                                                                   E15965
     C**Price*basis*'P'********************************************E15965 E20232
     C*                                                                   E15965
     C***********SPBS      IFEQ 'P'                                E15965 E20232
     C***********          DIV  100       APNC                     E15965 E20232
     C***********          END                                     E15965 E20232
     C***********          END                                     E15965 E22957
     C*                                                                   E15965
     C                     END
     C*
     C* IF NO BOOK POSITION READ - SET FIELDS FROM ACTION VALUES OR TO
     C*      ZERO
     C*
     C           *IN11     IFEQ '0'
     C/COPY WNCPYSRC,SE2220C140
      *                                                                                       CSE065
     C                     Z-ADD0         BKCOST                                              CSE065
      *                                                                                       CSE065
     C                     MOVE BCSS      BPSC
     C***********          MOVE BCBR      BPBR                            S01117
     C                     MOVE BCBA      BPBA                            S01117
     C                     MOVE BCBO      BPBK
     C                     MOVE BCMK      BPMK
     C                     MOVE BCTV      BPTV
     C*
     C                     Z-ADDBCAD      BPPD
     C*
     C                     Z-ADD0         NPSN
     C                     Z-ADD0         ECNP
     C                     Z-ADD0         APPB
     C                     Z-ADD0         RPTP
     C                     Z-ADD0         PILP
     C                     Z-ADD0         APNC
     C************IN39*****IFEQ '1'                                S01486 CPM004
     C                     Z-ADD0         FXAP                            S01486
     C*********************END                                     S01486 CPM004
     C                     Z-ADD0         PAPNC                           E22957
     C                     Z-ADD0         ANMP                            E22957
     C                     Z-ADD0         PNPSN
     C                     Z-ADD0         ONPSN  150
     C                     Z-ADD0         APNN                                                CAS006
     C                     Z-ADD0         APPN                                                CAS006
     C                     Z-ADD0         PILN                                                CAS006
      *                                                                   E20086
      ***  Note: AAPR field now holds the Current Factor.                 E20086
     C                     Z-ADD1         AAPR                            E20086
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CCP8                                           S01408
     C*                                                                   S01408
      *                                                                                       CSE075
      ** If Enhanced Treasury is switched on:                                                 CSE075
      *                                                                                       CSE075
     C           CSE075    IFEQ 'Y'                                                           CSE075
      *                                                                                       CSE075
      ** Setting AAPR to 1 caused the first principal repayment on a                          CSE075
      ** holding to be grossly overstated.  Set AAPR to current factor.                       CSE075
      *                                                                                       CSE075
     C                     Z-ADDBCCF      AAPR                                                CSE075
     C                     ENDIF                                                              CSE075
      *                                                                                       CSE075
     C                     Z-ADD2220      TNLU                            E20085
      *                                                                   E20086
     C                     ELSE
     C                     Z-ADDAPNC      PAPNC                           E22957
     C                     Z-ADDNPSN      PNPSN
     C                     Z-ADDNPSN      ONPSN
     C                     MOVE BKPREC    RECST1
     C                     END
     C*                                                                   031177
     C** RECALCULATE APNC ( = NPSN X LAVP) IF NON-AMORTIZING POSITION     031177
     C** (THERE MAY HAVE BEEN MARK TO MARKET DONE SINCE LAST TRADE)       031177
     C*                                                                   031177
     C           BUDU      IFEQ *ZERO                                     031177
     C                     Z-ADDNPSN      ZNOML                           031177
     C                     Z-ADDLAVP      ZPRC                            031177
     C                     EXSR ZCNSD                                     031177
     C                     Z-ADDZCONS     APNC                            031177
     C                     ELSE                                           099591
     C                     ADD  BHPP      APNC                            099591
     C                     END                                            031177
     C*                                                                   E22957
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           PROT      ANDNE'2'                                                           CSE065
     C           PROT      ANDNE'4'                                                           CSE065
     C           PROT      ANDNE'7'                                                           CSE065
     C           STAD      IFEQ 'Y'                                                           CSE065
     C           STAD      OREQ 'C'                                                           CSE065
     C                     Z-ADDNPSN      ZNOML                                               CSE065
     C                     Z-ADDNAVP      ZPRC                                                CSE065
     C                     EXSR ZCNSD                                                         CSE065
     C                     Z-ADDZCONS     BKCOST                                              CSE065
     C                     ELSE                                                               CSE065
     C                     ADD  BHPP      BKCOST                                              CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           BUDN      IFEQ *ZERO                                                         CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     Z-ADDLAVN      ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     APNN                                                CAS006
     C                     ELSE                                                               CAS006
     C                     ADD  BHPP      APNN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ADD  DPAN      APNN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C** AP NUMERATOR EQUALS  APNC FROM BKPOSN + AMORTISED DISCOUNT       E22957
     C***************+*BHPP*FROM*BKPHDD*(RESET*ON*O/P*TO*BKPOSD)***E29236 099591
     C*                                                                   E22957
     C                     ADD  DPAP      APNC                            E22957
     C***********          ADD  BHPP      APNC                     E29236 099591
     C*                                                                   CPM004
     C** RESET BOOK COST IN PORTFOLIO CURRENCY                            CPM004
     C*                                                                   CPM004
     C                     Z-ADDLFXP      FXAP                            CPM004
     C*                                                                   E22957
     C                     Z-ADDNPSN      ZNOML                           E22957
     C/COPY WNCPYSRC,SE2220C056
     C*                                                                   E22957
     C*** Build and store the NOMINAL Book value.                         E22957
     C*                                                                   E22957
     C           PPDI      IFEQ 'Y'                                       E22957
     C*                                                                   E29236
     C* Get the partly paid price from the security diary                 E29236
     C* prior to the date of the action.                                  E29236
     C*                                                                   E29236
     C                     MOVEL'Y'       PRIOR   1                       E29236
     C                     EXSR GETPPP                                    E29236
     C*                                                                   E29236
     C* Adjust the nominal by the partly paid price                       E29236
     C*                                                                   E29236
     C                     MOVE BCTA      BCTA3   63                      E22957
     C           BCTA3     DIV  100       WBCTA  158H                     E22957
     C           ZNOML     MULT WBCTA     ZNOML     H                     E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C           SPBS      IFEQ 'P'                                       E22957
     C                     Z-ADD100       ZPRC                            E22957
     C                     ELSE                                           E22957
     C                     Z-ADD1         ZPRC                            E22957
     C                     END                                            E22957
     C/COPY WNCPYSRC,SE2220C214
     C*                                                                   E22957
     C                     EXSR ZCNSD                                     E22957
     C                     Z-ADDZCONS     BKVAL  150                      E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDZCONS     BKVALN 150                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADDZCONS     PBKVAL 150                      E22957
     C*                                                                   E22957
     C           PROT      IFEQ '8'                                       E36391
     C*                                                                   E36391
     C* GET THE CURRENT FACTOR FROM THE SECURITY DIARY                    E36391
     C* PRIOR TO THE DATE OF THE ACTION.                                  E36391
     C*                                                                   E36391
     C                     MOVEL'Y'       PRIOR   1                       E36391
     C                     EXSR GETCUF                                    E36391
     C                     END                                            E36391
     C/COPY WNCPYSRC,SE2220C141
     C*
     C* IF NO BOOK POSITION MONTHLY STATS RECORD FOUND, INITIALISE FIELDS
     C*   FOR ACCUMULATION
     C*
     C           *IN12     IFEQ '0'
     C*
     C                     Z-ADD0         BPIT
     C                     Z-ADD0         TIPN
     C                     Z-ADD0         UPLE
      *                                                                   E19445
      ***  No reason to clear Unrealized P/L; it's on BKPHD, not BKMTH.   E19445
     C***********          Z-ADD0         UPPT                            E19445
      *                                                                   E19445
     C                     Z-ADD0         CPDD
     C                     Z-ADD0         BCDM
     C                     Z-ADD0         BCCM
     C                     Z-ADD0         MMPL
     C                     Z-ADD0         RPTM
     C                     Z-ADD0         DPTM                            E20087
     C                     Z-ADD0         DPTR                            E20085
     C                     MOVE *BLANKS   DPSP                            E20085
     C                     Z-ADD0         BKAMTM                                              CSE065
     C                     Z-ADD0         EQAMTM                                              CSE065
     C***********          Z-ADD0         TNLU                            E20085
     C                     Z-ADD2220      TNLU                            E20085
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  REVMTH - SUBROUTINE TO PROCESS REVERSED ACTIONS              *
      *                                                               *
      *****************************************************************
      *
     C           REVMTH    BEGSR                           *** REVMTH ***
     C*
     C***********          Z-ADDBCAD      TLPSD                           E16822
     C*
     C* FOR TRADE ACTIONS
     C*
     C***********BCAS      IFEQ '10'                                      E18652
     C           BCAS      IFEQ '40'                                      E18652
     C           BCAS      OREQ '00'                                      E36547
     C*                                                                   E29207
     C* Produce amortised Disc/Prem keys if Disc/Prem to be amortised     E29207
     C*                                                                   E29207
     C           BCTV      IFEQ 'V'                                       E29207
     C           MATY      ANDNE99999                                     E29207
     C/COPY WNCPYSRC,SE2220C120
      *                                                                                       CSE105
     C           CSE105    ANDEQ'N'                                                           CSE105
      *                                                                                       CSE105
      ** If CSE105 is installed, perform the routines when the new                            CSE105
      ** Trade/Value Amortization flag is "Both" or EQUAL to original                         CSE105
      ** flag.                                                                                CSE105
      *                                                                                       CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQ'B'                                                           CSE105
     C           MATY      ANDNE99999                                                         CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQBCTV                                                          CSE105
     C           MATY      ANDNE99999                                                         CSE105
      *                                                                                       CSE105
     C           STAD      IFEQ 'Y'                                       E29207
     C           STAD      OREQ 'C'                                       E29207
     C/COPY WNCPYSRC,SE2220C219
     C           STBS      OREQ 'D'                                       E29207
     C           GDPK      ANDEQ'Y'                                       E29207
     C/COPY WNCPYSRC,SE2220C176
      *                                                                   CSE006
      *** Only do SR/AMORT and SR/AVPRAM if BYSL is not 'Y' or if         CSE006
      *** switchable feature CSE006 is off.                               CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
      *                                                                   CSE006
     C                     EXSR AMORT                                     E29207
     C                     EXSR AVPRAM                                    E29207
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     END                                            E29207
     C                     END                                            E29207
     C*                                                                   E23747
     C*** Set on *in21 for trade reversal to output to BKPHHD and BKPOSD  E23747
     C*                                                                   E23747
     C                     MOVE '1'       *IN21                           E23747
     C                     Z-ADDBCAD      LPSD                            E23747
     C                     Z-ADDBCAD      LPCD                            E23747
     C***                                                                 E23747
     C           RMIP      IFEQ 'Y'                                       E37180
     C           BCPS      IFEQ 'P'                                       E20085
     C           BPIT      SUB  PCHI      BPIT
     C                     ELSE                                           E20085
     C                     ADD  PCHI      BPIT                            E20085
     C                     END                                            E20085
     C                     END                                            E37180
     C/COPY WNCPYSRC,SE2220C142
     C                     ELSE
     C*
     C* FOR COUPON/DIVIDEND ACTIONS
     C*
     C           BCAS      IFEQ '30'
     C           BCAS      OREQ '35'
     C           CPDD      SUB  BCDV      CPDD
     C                     END
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  P05   - SUBROUTINE TO PROCESS ACTION TYPE 05 (PP CALL ACTION)*
      *                                                               *
      *****************************************************************
      *
     C           P05       BEGSR                           ***  P05   ***
      *
     C                     MOVE '1'       *IN20
     C*
     C* IF VALUE DATE POSITION AND FIRST ACTION FOR ACTION DATE
     C*     - BRING ACCRUALS UP TO DATE
     C*
      *****Must*perform*amortization*for*trade*date*positions*to*obtain87 E20552
      *****correct*average*prices*for*discounted*instruments.****  E20087 E20552
     C***********BCTV      IFEQ 'V'                                E20087 E20552
     C           BCTV      IFEQ 'V'                                       E20087
     C/COPY WNCPYSRC,SE2220C121
      *                                                                                       CSE105
     C           CSE105    ANDEQ'N'                                                           CSE105
      *                                                                                       CSE105
      ** If CSE105 is installed, perform the routines when the new                            CSE105
      ** Trade/Value Amortization flag is "Both" or EQUAL to original                         CSE105
      ** flag.                                                                                CSE105
      *                                                                                       CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQ'B'                                                           CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQBCTV                                                          CSE105
      *                                                                                       CSE105
     C*
     C* PRODUCE AMORTISED DISC/PREM KEYS IF DISC/PREM TO BE AMORTISED
     C*
     C***********MATY      IFNE 99999                                     E15442
     C***********STBS      ANDEQ'D'                                       E15442
     C***********STAD      IFEQ 'Y'                                       E15442
     C***********GDPK      OREQ 'Y'                                       E15442
     C***********          EXSR AMORT                                     E15442
     C***********          END                                            E15442
     C***********          END                                            E15442
     C           MATY      IFNE 99999                                     E15442
     C           STAD      IFEQ 'Y'                                       E15442
     C           STAD      OREQ 'C'                                       S01233
     C/COPY WNCPYSRC,SE2220C220
     C           STBS      OREQ 'D'                                       E15442
     C           GDPK      ANDEQ'Y'                                       E15442
     C/COPY WNCPYSRC,SE2220C177
      *                                                                   CSE006
      *** Only do SR/AMORT if BYSL not eq 'Y' and switchable feature      CSE006
      *** is on.                                                          CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
      *                                                                   CSE006
     C                     EXSR AMORT                                     E15442
     C                     EXSR AVPRAM                                    E15442
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     END                                            E15442
     C                     END                                            E15442
     C/COPY WNCPYSRC,SE2220C122
      *                                                                                       CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
      ** Do not condition SR/ACCRUE processing on CSE105...                                   CSE105
      *                                                                                       CSE105
     C           BCTV      IFEQ 'V'                                                           CSE105
      *                                                                                       CSE105
      *                                                                   E20087
      *****Following*line*moved*here*to*condition*accruals*only.** E20087 E20552
     C***********BCTV      IFEQ 'V'                                E20087 E20552
     C*
     C*  ACCRUE INTEREST ON THIS POSITION IF REQUIRED
     C*
     C           PROT      IFEQ '1'
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '6'
     C           PROT      OREQ '8'
     C           PROT      OREQ '9'                                       S01176
     C*
     C           DYBS      IFNE '4'
     C*                                                                   E15549
     C* FOR LAST COUPON DATE USE LAST COUPON DATE OF THE ACTION           E15549
     C*                                                                   E15549
     C                     Z-ADDLCCP      LCPN                            E15549
     C                     MOVE 'Y'       DADJN                           100017
     C                     EXSR ACCRUE
     C                     MOVE 'N'       DADJN                           100017
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C* CALCULATE NEW LATEST AVERAGE PRICE FOR BOOK POSITION HEADER
     C*
     C                     Z-ADDLAVP      PLAVP
     C*                                                                   E20958
     C* Unit based securities need to be corrected for CDP                E20958
     C*                                                                   E20958
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CCP1                                           S01408
     C*                                                                   S01408
     C                     MOVE BCCP      BCCP3   63
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CCP2                                           S01408
     C*                                                                   S01408
     C*                                                                   E20958
     C           PROT      IFEQ '4'                                       E20958
     C***********8         SUB  CDP       DC      10               E20958 E22957
     C           5         SUB  CDP       DC      10                      E22957
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CCP4                                           S01408
     C*                                                                   S01408
     C           BCCP3     MULT POWER8,DC BCCP3                           E20958
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CCP3                                           S01408
     C*                                                                   S01408
     C                     END                                            E20958
     C*                                                                   E20958
     C           LAVP      ADD  BCCP3     LAVP
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           STAD      IFEQ 'Y'                                                           CSE065
     C           STAD      OREQ 'C'                                                           CSE065
     C           NAVP      ADD  BCCP3     NAVP                                                CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                      CAS006
     C           CAS006    IFEQ 'Y'                                                          CAS006
     C           LAVN      ADD  BCCP3     LAVN                                               CAS006
     C                     ENDIF                                                             CAS006
     C*
     C* RESET LATEST POSITION DATE
     C*
     C                     Z-ADDBCAD      LPCD
     C*
     C* PRODUCE ACCOUNT KEYS FOR CALLED AMOUNT ON USERS BOOK POSITION
     C*
     C****-*CALCULATE*CALLED*AMOUNT*IN*NOM*CCY*************************   E29236
     C*
     C***********PROT      IFNE '4'                                       E29236
     C***********          MOVE BCTA      BCTA3   63                      E29236
     C***********BCTA3     DIV  100       WBCTA  158H                     E29236
     C***********          ELSE                                           E29236
     C***********          Z-ADDBCTA      WBCTA                           E21603
     C***********5         SUB  CDP       N                        E21603 E29236
     C***********BCTA      MULT POWER8,N  WBCTA                    E21603 E29236
     C***********          END                                            E29236
     C*
     C****Post*Amount*being*Called*not*Total*Called*Amount*********E22957 E29236
     C***********NPSN      MULT WBCTA     WCNOM  154H                     E22957
     C***********NPSN      MULT BCCP3     WCNOM  154               E22957 E29236
     C*
     C****-*CONVERT*NOMINAL*TO*CURRENCY*DECIMAL*PLACES*****************   E29236
     C*
     C***********CDP       SUB  NMDP      N       10                      E29236
     C***********N         ADD  5         N                               E29236
     C***********WCNOM     MULT POWER8,N  EVAM      H                     E29236
     C*                                                                   E29236
     C*** Calculate the amount being called = nominal position X % called E29236
     C*                                                                   E29236
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CCP5                                           S01408
     C*                                                                   S01408
     C           BCCP3     DIV  100       WBCTA     H                     E29236
     C           NPSN      MULT WBCTA     ZNOML     H                     E29236
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CCP6                                           S01408
     C*                                                                   S01408
     C*                                                                   E29236
     C           SPBS      IFEQ 'P'                                       E29236
     C                     Z-ADD100       ZPRC                            E29236
     C                     ELSE                                           E29236
     C                     Z-ADD1         ZPRC                            E29236
     C                     END                                            E29236
     C/COPY WNCPYSRC,SE2220C215
     C*                                                                   E29236
     C                     EXSR ZCNSD                                     E29236
     C                     Z-ADDZCONS     EVAM                            E29236
      *                                                                   E20086
      ***  Accumulate Called Amounts for this Position.                   E20086
      *                                                                   E20086
     C           EVAM      ADD  BHPP      BHPP                            E20086
     C*                                                                   E20086
     C** UPDATE AP NUMERATOR                                              E22957
     C                     ADD  EVAM      APNC                            E22957
     C                     ADD  EVAM      BKVAL                           E22957
     C*                                                                   E22957
     C** Maintain Original Cost Price, (No Amortisation)                  E22957
     C                     ADD  EVAM      ANMP                            E22957
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           PROT      ANDNE'2'                                                           CSE065
     C           PROT      ANDNE'4'                                                           CSE065
     C           PROT      ANDNE'7'                                                           CSE065
     C           STAD      IFEQ 'Y'                                                           CSE065
     C           STAD      OREQ 'C'                                                           CSE065
     C                     ADD  EVAM      BKCOST                                              CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     ADD  EVAM      APNN                                                CAS006
     C                     ADD  EVAM      BKVALN                                              CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   E20086
     C           PROT      IFEQ '8'
     C/COPY WNCPYSRC,SE2220C143
     C***********BCCF      MULT EVAM      EVAM      H                     E20086
     C           AAPR      MULT EVAM      EVAM      H                     E20086
     C                     END
     C*
     C*   - OUTPUT ACCOUNT KEY FOR CALLED AMOUNT
     C*
     C                     MOVE 'P'       EVTP
     C                     MOVE ' '       TRTP
     C                     MOVE '  '      TRST
     C                     MOVE ' '       PORT
     C*
     C***********NPSN      IFLT 0                                         099384
     C           NPSN      IFGE 0                                         099384
     C           NPAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C*
     C                     MOVE 'PP'      AMCD
     C                     MOVE '0'       RVRS
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C                     MOVE *ZEROS    TRFR
     C*                                                                   E29236
     C* Only write out part payment key, if T/V keys not suppressed       E29236
     C*                                                                   E29236
     C           BCTV      IFNE SKTD                                      E29236
     C*
     C           SKTD      IFNE *BLANKS                                   103176
     C           SKTD      OREQ *BLANKS                                   103176
     C           BCTV      ANDEQ'T'                                       103176
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C001
     C                     END
     C                     END                                            103176
     C*
     C                     END                                            E29236
     C***********                                                         E20086
     C**ACCUMULATE*CALLED*AMOUNTS*FOR*THIS*POSITION********************   E20086
     C***********                                                         E20086
     C***********EVAM      ADD  BHPP      BHPP                            E20086
     C*
     C                     ENDSR
      *****************************************************************                       CSE065
      /EJECT                                                                                  CSE065
      *****************************************************************                       CSE065
      *                                                               *                       CSE065
      *  P06   - Calculate Book Value Change                          *                       CSE065
      *                                                               *                       CSE065
      *****************************************************************                       CSE065
      *                                                                                       CSE065
     C           P06       BEGSR                                                              CSE065
      *                                                                                       CSE065
      ** Book Value Amount                                                                    CSE065
      *                                                                                       CSE065
     C                     SELEC                                                              CSE065
     C           BCAS      WHEQ '60'                                                          CSE065
     C           LAVP      SUB  NAVP      WBKVMT 308                                          CSE065
     C                     MULT NPSN      WBKVMT                                              CSE065
     C                     OTHER                                                              CSE065
     C           CNTP      SUB  NAVP      WBKVMT                                              CSE065
     C                     MULT NPSN      WBKVMT                                              CSE065
     C                     ENDSL                                                              CSE065
      *                                                                                       CSE065
      ** Book difference                                                                      CSE065
      *                                                                                       CSE065
     C           WBKVMT    ADD  BKVAMT    WBOKDF 308                                          CSE065
      *                                                                                       CSE065
     C                     SELEC                                                              CSE065
      *                                                                                       CSE065
      ** If Book Value Change is positive                                                     CSE065
      ** and BKVAMT is neqative                                                               CSE065
      *                                                                                       CSE065
     C           WBKVMT    WHGE 0                                                             CSE065
     C           BKVAMT    ANDLT0                                                             CSE065
      *                                                                                       CSE065
     C           WBOKDF    IFGT 0                                                             CSE065
     C                     MOVE 'BD'      AMCD                                                CSE065
     C                     Z-ADDBKVAMT    EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     MOVE 'BI'      AMCD                                                CSE065
     C                     MOVE WBOKDF    EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     ELSE                                                               CSE065
     C                     MOVE 'BD'      AMCD                                                CSE065
     C           WBKVMT    MULT -1        EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** If Book Value Change is negative                                                     CSE065
      ** and BKVAMT is positive                                                               CSE065
      *                                                                                       CSE065
     C           WBKVMT    WHLT 0                                                             CSE065
     C           BKVAMT    ANDGE0                                                             CSE065
      *                                                                                       CSE065
     C           WBOKDF    IFLT 0                                                             CSE065
     C                     MOVE 'BI'      AMCD                                                CSE065
     C           BKVAMT    MULT -1        EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     MOVE 'BD'      AMCD                                                CSE065
     C           WBOKDF    MULT -1        EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     ELSE                                                               CSE065
     C                     MOVE 'BI'      AMCD                                                CSE065
     C                     Z-ADDWBKVMT    EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** If Book Value Change is negative                                                     CSE065
      ** and BKVAMT is negative                                                               CSE065
      *                                                                                       CSE065
     C           WBKVMT    WHLT 0                                                             CSE065
     C           BKVAMT    ANDLT0                                                             CSE065
      *                                                                                       CSE065
     C                     MOVE 'BD'      AMCD                                                CSE065
     C           WBKVMT    MULT -1        EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** If Book Value Change is positive                                                     CSE065
      ** and BKVAMT is positive                                                               CSE065
      *                                                                                       CSE065
     C           WBKVMT    WHGE 0                                                             CSE065
     C           BKVAMT    ANDGE0                                                             CSE065
      *                                                                                       CSE065
     C                     MOVE 'BI'      AMCD                                                CSE065
     C                     Z-ADDWBKVMT    EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     ENDSL                                                              CSE065
      *                                                                                       CSE065
     C                     Z-ADDWBOKDF    BKVAMT                                              CSE065
      *                                                                                       CSE065
     C                     ENDSR                                                              CSE065
      *****************************************************************                       CSE065
      /EJECT                                                                                  CSE065
      *****************************************************************                       CSE065
      *                                                               *                       CSE065
      *  P07   - Calculate Equity Amount                              *                       CSE065
      *                                                               *                       CSE065
      *****************************************************************                       CSE065
      *                                                                                       CSE065
     C           P07       BEGSR                                                              CSE065
      *                                                                                       CSE065
      ** Equity Amount                                                                        CSE065
      *                                                                                       CSE065
     C           BCAS      IFEQ '60'                                                          CSE065
     C           BCAS      OREQ '80'                                                          CSE065
     C           WBKVMT    SUB  WADP      WEQAMT 308                                          CSE065
     C                     ELSE                                                               CSE065
     C           WBKVMT    SUB  WRLPL     WEQAMT                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** Equity Difference                                                                    CSE065
      *                                                                                       CSE065
     C           WEQAMT    ADD  EQTAMT    WEQDIF 308                                          CSE065
      *                                                                                       CSE065
      ** If Equity Amount is positive                                                         CSE065
      ** and EQTAMT is negative                                                               CSE065
      *                                                                                       CSE065
     C                     SELEC                                                              CSE065
     C           WEQAMT    WHGE 0                                                             CSE065
     C           EQTAMT    ANDLT0                                                             CSE065
      *                                                                                       CSE065
     C           WEQDIF    IFGT 0                                                             CSE065
     C                     MOVE 'ED'      AMCD                                                CSE065
     C                     Z-ADDEQTAMT    EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     MOVE 'EI'      AMCD                                                CSE065
     C                     Z-ADDWEQDIF    EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     ELSE                                                               CSE065
     C                     MOVE 'ED'      AMCD                                                CSE065
     C           WEQAMT    MULT -1        EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** If Equity Amount is negative                                                         CSE065
      ** and EQTAMT is positive                                                               CSE065
      *                                                                                       CSE065
     C           WEQAMT    WHLT 0                                                             CSE065
     C           EQTAMT    ANDGE0                                                             CSE065
      *                                                                                       CSE065
     C           WEQDIF    IFLT 0                                                             CSE065
     C                     MOVE 'EI'      AMCD                                                CSE065
     C           EQTAMT    MULT -1        EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     MOVE 'ED'      AMCD                                                CSE065
     C           WEQDIF    MULT -1        EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     ELSE                                                               CSE065
     C                     MOVE 'EI'      AMCD                                                CSE065
     C                     Z-ADDWEQAMT    EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** If Equity Amount is negative                                                         CSE065
      ** and EQTAMT is negative                                                               CSE065
      *                                                                                       CSE065
     C           WEQAMT    WHLT 0                                                             CSE065
     C           EQTAMT    ANDLT0                                                             CSE065
      *                                                                                       CSE065
     C                     MOVE 'ED'      AMCD                                                CSE065
     C           WEQAMT    MULT -1        EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** If Equity Amount is positive                                                         CSE065
      ** and EQTAMT is positive                                                               CSE065
      *                                                                                       CSE065
     C           WEQAMT    WHGE 0                                                             CSE065
     C           EQTAMT    ANDGE0                                                             CSE065
      *                                                                                       CSE065
     C                     MOVE 'EI'      AMCD                                                CSE065
     C                     Z-ADDWEQAMT    EVAM                                                CSE065
     C           EVAM      IFNE 0                                                             CSE065
     C                     EXSR W06                                                           CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     ENDSL                                                              CSE065
      *                                                                                       CSE065
     C                     Z-ADDWEQDIF    EQTAMT                                              CSE065
      *                                                                                       CSE065
     C                     ENDSR                                                              CSE065
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  P10    - SUBROUTINE TO PROCESS ACTION TYPE 10 (TRADE ACTIONS)*
      *                                                               *
      *****************************************************************
      *
     C           P10       BEGSR                           **  P10 **
      ***********                                                   E20086E36391
      **Access*Current*Factor*for*Value*Date*of*Trade*if*Mort-BackedE20086E36391
      ***********                                                   E20086E36391
     C***********PROT      IFEQ '8'                                 E20086E36391
     C***********BCTR      CHAINTRADS                81             E20086E36391
      ***********                                                   E20086E36391
     C************IN81     IFEQ '0'                                 E20086E36391
     C***********RECI      ANDNE'*'                                 E20086E36391
     C***********          MOVE 'MP'      ETYP                      E20086E36391
     C***********SEDKEY    SETLLSEDEVDO                             E20086E36391
     C***********          READ SEDEVDO                  81         E20086E36391
      ***********                                                   E20086E36391
     C************IN81     IFEQ '0'                                 E20086E36391
     C***********SDSN      ANDEQBCSS                                E20086E36391
     C***********SDET      ANDEQ'MP'                                E20086E36391
     C***********          Z-ADDSDCP      AAPR                      E20086E36391
     C***********          END                                      E20086E36391
      ***********                                                   E20086E36391
     C***********          END                                      E20086E36391
     C***********          END                                      E20086E36391
      *                                                                   CSE006
      *** Check if action is for the first or second trade of the         CSE006
      *** Buy/Sell.                                                       CSE006
      *                                                                   CSE006
     C           BYSL      IFEQ 'Y'                                       CSE006
      *                                                                   CSE006
      *** Get trade details                                               CSE006
     C           BCTR      CHAINTRADS                80                   CSE006
      *                                                                   CSE006
     C           *IN80     IFEQ '1'                                       CSE006
     C           RECI      ORNE 'D'                                       CSE006
     C           *LOCK     IN   LDA                                       CSE006
     C                     Z-ADD24        DBASE            ***************CSE006
     C                     MOVEL'TRADS  ' DBFILE           * DB ERROR 24 *CSE006
     C                     MOVELBCTR      DBKEY            ***************CSE006
     C                     SETON                     U7U8                 CSE006
     C                     OUT  LDA                                       CSE006
     C                     DUMP                                           CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
      *** Define and initialise work field (second trade)                 CSE006
      *                                                                   CSE006
     C                     MOVE 'N'       @SECTR  1                       CSE006
      *                                                                   CSE006
      *** Get Buy-Sell details for trade ref                              CSE006
      *                                                                   CSE006
     C           BSKEY1    CHAINBSPOSDL0             80                   CSE006
      *                                                                   CSE006
      *** If not found chain use LKRF and set on second trade indicat     CSE006
      *                                                                   CSE006
     C           *IN80     IFEQ *ON                                       CSE006
     C                     MOVE 'Y'       @SECTR                          CSE006
     C           BSKEY2    CHAINBSPOSDL0             80                   CSE006
      *                                                                   CSE006
     C           *IN80     IFEQ '1'                                       CSE006
     C           RECI      ORNE 'D'                                       CSE006
     C           *LOCK     IN   LDA                                       CSE006
     C                     Z-ADD29        DBASE            ***************CSE006
     C                     MOVEL'TRADS  ' DBFILE           * DB ERROR 29 *CSE006
     C                     MOVELBCTR      DBKEY            ***************CSE006
     C                     SETON                     U7U8                 CSE006
     C                     OUT  LDA                                       CSE006
     C                     DUMP                                           CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     MOVE '0'       @BSL    10                      CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
      *                                                                   CSE006
     C           PROT      IFEQ '8'                                       E36391
     C*                                                                   E36391
     C** Get the Current Factor from the Security Diary                   E36391
     C** at or before the date of the action.                             E36391
     C*                                                                   E36391
     C                     MOVEL'N'       PRIOR                           E36391
     C                     EXSR GETCUF                                    E36391
     C                     END                                            E36391
     C/COPY WNCPYSRC,SE2220C144
     C*                                                                   E29236
     C* Get the partly paid price from the security diary                 E29236
     C* at or before the date of the action.                              E29236
     C*                                                                   E29236
     C           PPDI      IFEQ 'Y'                                       E29236
     C                     MOVEL'N'       PRIOR                           E29236
     C                     EXSR GETPPP                                    E29236
     C                     END                                            E29236
     C*
     C* SET INDICATORS TO SHOW TRADE ACTIONS PROCESSED
     C*
     C                     MOVEA'111'     *IN,19
      *
      ***  If Value Date Position, bring Accruals up to date.
      *
     C           BCTV      IFEQ 'V'
     C/COPY WNCPYSRC,SE2220C123
      *                                                                                       CSE105
     C           CSE105    ANDEQ'N'                                                           CSE105
      *                                                                                       CSE105
      ** If CSE105 is installed, perform the routines when the new                            CSE105
      ** Trade/Value Amortization flag is "Both" or EQUAL to original                         CSE105
      ** flag.                                                                                CSE105
      *                                                                                       CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQ'B'                                                           CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQBCTV                                                          CSE105
      *                                                                                       CSE105
     C*
     C* AMORTISE DISC/PREM IF REQUIRED
     C*
     C***********MATY      IFNE 99999                                     E15442
     C***********STBS      ANDEQ'D'                                       E15442
     C***********STAD      IFEQ 'Y'                                       E15442
     C***********GDPK      OREQ 'Y'                                       E15442
     C***********          EXSR AMORT                                     E15442
     C***********          END                                            E15442
     C***********          END                                            E15442
     C                     MOVEL'N'       AMTDP   1                       S01176
     C           MATY      IFNE 99999                                     E15442
     C           STAD      IFEQ 'Y'                                       E15442
     C           STAD      OREQ 'C'                                       S01233
     C/COPY WNCPYSRC,SE2220C221
     C           STBS      OREQ 'D'                                       E15442
     C           GDPK      ANDEQ'Y'                                       E15442
     C/COPY WNCPYSRC,SE2220C178
      *                                                                   CSE006
      *** Only do SR/AMORT if BYSL not eq 'Y' and switchable feature      CSE006
      *** is on.                                                          CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
      *                                                                   CSE006
     C                     EXSR AMORT                                     E15442
     C                     EXSR AVPRAM                                    E15442
      *                                                                   CSE006
     C                     ELSE                                           CSE006
      *                                                                   CSE006
     C                     EXSR AMTPL                                     CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     END                                            E15442
     C                     END                                            E15442
     C/COPY WNCPYSRC,SE2220C124
      *                                                                                       CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
      ** Do not condition SR/ACCRUE processing on CSE105...                                   CSE105
      *                                                                                       CSE105
     C           BCTV      IFEQ 'V'                                                           CSE105
      *                                                                                       CSE105
     C*
     C* ACCRUE INTEREST ON THIS POSITION IF REQUIRED
     C*
     C           PROT      IFEQ '1'
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '6'
     C           PROT      OREQ '8'
     C           PROT      OREQ '9'                                       S01176
     C           DYBS      IFNE '4'
     C*                                                                   E15549
     C* FOR LAST COUPON DATE USE LAST COUPON DATE OF THE ACTION           E15549
     C*                                                                   E15549
     C                     Z-ADDLCCP      LCPN                            E15549
     C                     MOVE 'Y'       DADJN                           100017
     C                     EXSR ACCRUE
     C                     MOVE 'N'       DADJN                           100017
     C                     END
     C                     END
     C*
     C                     END
     C*
     C* Save action date to update BKPHD
     C*
     C                     Z-ADDBCAD      TLPSD
     C*                                                                   E15549
     C** IF THIS TRADE ACTION IS CROSSING OVER A COUPON DATE              E15549
     C** (OR A DIVIDEND PAYMENT DATE IF SECURITY IS A SHARE)              E15549
     C** THEN ZEROIZE EX-COUPON NOMINAL AND PURCHASED INTEREST            E15549
      ***  and Interest Adjustment on Position.                           E21546
     C*                                                                   E15549
     C           LPSD      IFLT SVLCPN                                    E15549
     C           BCAD      ANDGESVLCPN                                    E15549
     C/COPY WNCPYSRC,SE2220C145
     C                     Z-ADD*ZERO     ECNP                            E15549
     C                     Z-ADD*ZERO     IACP                            E20085
     C                     Z-ADD*ZERO     PILP                            E15549
     C                     Z-ADD*ZERO     INDO                            E20085
     C                     Z-ADD0         PILN                                                CAS006
     C                     Z-ADD0         INDN                                                CAS006
     C                     END                                            E15549
     C*
     C* CALCULATE NEW NOMINAL AND EX-COUPON NOMINAL POSITIONS
     C*
     C                     Z-ADDNPSN      PNPSN  150
     C                     Z-ADDECNP      PECNP  150
     C*
     C* If FIFO accounting and previous nominal 0, save this trade ref
     C* for subsequent processing in SR/CLOSE for later actions
     C*
     C           FIFO      IFEQ 'Y'
     C           BYSL      ANDNE'Y'                                       CSE006
     C           PNPSN     ANDEQ*ZEROS
     C                     MOVE BCTR      BHTR
     C                     Z-ADDBCNL      BHRN
     C                     END
     C/COPY WNCPYSRC,SE2220C168
     C*
     C*    - CALCULATE NEW NOMINAL
     C*
     C           BCPS      IFEQ 'P'
     C           NPSN      ADD  BCNL      NPSN
     C                     ELSE
     C           NPSN      SUB  BCNL      NPSN
     C                     END
     C*
     C*    - CALCULATE NEW EX-COUPON NOMINAL
     C*
     C           ACRI      IFEQ 'X'
     C           BCPS      IFEQ 'P'
     C           ECNP      ADD  BCNL      ECNP
     C                     ELSE
     C           ECNP      SUB  BCNL      ECNP
     C                     END
     C***********          Z-SUBPCHI      PCHI                            E20492
     C                     END
     C*
     C* HAVING UPDATED NOMINAL AND EX-COUPON NOMINAL -
     C*    SET INDICATOR IF TRADE HAS CHANGED FROM SHORT TO LONG OR
     C*    LONG TO SHORT
     C*
     C           PNPSN     IFGE 0
     C           NPSN      ANDGE0
     C                     MOVE '1'       *IN30
     C                     ELSE
      *
     C           PNPSN     IFLE 0
     C           NPSN      ANDLE0
     C                     MOVE '1'       *IN30
     C                     ELSE
     C                     MOVE '1'       *IN31
     C                     END
      *
     C                     END
     C*
     C* CALCULATE CUM-COUPON NOMINAL
     C*   - (I.E. NOMINAL - EX-COUPON NOMINAL)
     C*
     C           PNPSN     SUB  PECNP     PCUMP  150
     C           NPSN      SUB  ECNP      CUMP   150
     C*
     C* CLEAR CASE INDICATORS
     C*
     C                     MOVEA'000000'  *IN,41
     C*
     C* - SET INDICATORS FOR CUM COUPON NOMINAL CASES
     C*
     C*    - FOR PURCHASES
     C           BCPS      IFEQ 'P'
      *
     C           PCUMP     IFLT 0
     C           CUMP      ANDGE0
     C                     MOVE '1'       *IN44
     C                     ELSE
     C           PCUMP     IFLT 0
     C           CUMP      ANDLT0
     C                     MOVE '1'       *IN45
     C                     ELSE
     C           PCUMP     IFGE 0
     C           CUMP      ANDGT0
     C                     MOVE '1'       *IN46
     C                     END
     C                     END
     C                     END
     C*
     C                     ELSE
     C*
     C*    - FOR SALES
     C*
     C           PCUMP     IFGE 0
     C           CUMP      ANDLT0
     C                     MOVE '1'       *IN44
     C                     ELSE
     C           PCUMP     IFGT 0
     C           CUMP      ANDGE0
     C                     MOVE '1'       *IN45
     C                     ELSE
     C           PCUMP     IFLT 0
     C           CUMP      ANDLT0
     C                     MOVE '1'       *IN46
     C                     END
     C                     END
     C                     END
     C*
     C                     END
     C*
     C*  - SET INDICATORS ACCORDING TO PURCHASE/SALE
     C*
     C           BCPS      IFEQ 'S'
      *
     C           PNPSN     IFGE 0
     C                     MOVE '1'       *IN34
     C                     ELSE
     C                     MOVE '1'       *IN36
     C                     END
     C           NPSN      IFGE 0
     C                     MOVE '1'       *IN32
     C                     ELSE
     C                     MOVE '1'       *IN33
     C                     END
     C*
     C                     ELSE
     C           BCPS      IFEQ 'P'
      *
     C           PNPSN     IFLT 0
     C                     MOVE '1'       *IN34
     C                     ELSE
     C                     MOVE '1'       *IN36
     C                     END
     C*
     C           NPSN      IFLT 0
     C                     MOVE '1'       *IN32
     C                     ELSE
     C                     MOVE '1'       *IN33
     C                     END
      *
     C                     END
     C                     END
     C*
     C* - SET INDICATORS FOR NOMINAL CASES
     C*
     C*    - FOR PURCHASES
     C           BCPS      IFEQ 'P'
     C*
     C           PNPSN     IFLT 0
     C           NPSN      ANDGE0
     C                     MOVE '1'       *IN41
     C                     ELSE
     C           PNPSN     IFLT 0
     C           NPSN      ANDLT0
     C                     MOVE '1'       *IN42
     C                     ELSE
     C           PNPSN     IFGE 0
     C           NPSN      ANDGT0
     C                     MOVE '1'       *IN43
     C                     END
     C                     END
     C                     END
     C*
     C                     ELSE
     C*
     C*    - FOR SALES
     C*
     C           PNPSN     IFGE 0
     C           NPSN      ANDLT0
     C                     MOVE '1'       *IN41
     C                     ELSE
     C           PNPSN     IFGT 0
     C           NPSN      ANDGE0
     C                     MOVE '1'       *IN42
     C                     ELSE
     C           PNPSN     IFLT 0
     C           NPSN      ANDLT0
     C                     MOVE '1'       *IN43
     C                     END
     C                     END
     C                     END
     C*
     C                     END
     C*
     C*  OBTAIN CLIENT INFORMATION FOR FACE VALUE AND CONSIDERATION KEY
     C*
     C                     EXSR CLICHN
     C           *INU7     IFEQ '1'
     C                     GOTO EP10
     C                     END
     C*
     C* PRODUCE FACE VALUE AND CONSIDERATION KEYS FOR THIS TRADE
     C*
     C           BCTR      CHAINTRADS                80                                       244962
     C           *IN80     IFEQ '0'                                                           244962
     C           BCPS      IFEQ 'P'                                                           244962
     C                     MOVE DELT      KCUST                                               244962
     C                     ELSE                                                               244962
     C                     MOVE DELF      KCUST                                               244962
     C                     ENDIF                                                              244962
     C                     ENDIF                                                              244962
     C/COPY WNCPYSRC,SE2220C002
     C           PROT      IFNE '2'
     C           PROT      ANDNE'4'
     C           PROT      ANDNE'7'
     C                     EXSR FVAL
     C                     ELSE
     C                     Z-ADD0         WFVAL  130
     C                     END
     C/COPY WNCPYSRC,SE2220C003
     C*
     C                     EXSR CONS
     C*
     C* Calculate reallowance amount from rate
     C*
     C***********          Z-ADDBCRA      WDRALL 158                      E14514
     C                     Z-ADDBCRA      WDRAL1 158                      E14514
     C*   . if Discount
     C*
     C           STBS      IFEQ 'D'
     C           BCRA      ANDNE0
     C                     Z-ADDBCAD      ZSDATE
     C                     Z-ADDMATY      ZEDATE
     C                     EXSR ZDAYS
     C                     Z-ADDZDDAYS    #DDAYS  50
     C                     EXSR ZDYYR
      *
     C           ZINTDD    IFNE 0
     C           BCRA      MULT #DDAYS    WPRIC1 158
     C           WPRIC1    DIV  ZINTDD    WDRAL2 158H
      *
     C           WDRAL2    IFGE 0
     C           1         SUB  WDRAL2    WDRAL1 158
     C                     ELSE
     C                     Z-SUBWDRAL2    WDRAL2
     C           1         SUB  WDRAL2    WDRAL1
     C                     Z-SUBWDRAL1    WDRAL1
     C                     END
      *
     C                     ELSE
     C                     Z-ADD0         WDRAL1
     C                     END
      *
     C                     END
     C*
     C***********BCNL      MULT WDRAL1    REALLW 130H                     E14514
     C                     Z-ADD*ZEROS    REALLW 130                      E14514
     C***********          Z-ADD*ZEROS    REALL0 130               E14514 E20232
     C***********          Z-ADD*ZEROS    REALL1 131               E14514 E20232
     C***********          Z-ADD*ZEROS    REALL2 132               E14514 E20232
     C***********          Z-ADD*ZEROS    REALL3 133               E14514 E20232
     C***********                                                  E14514 E20232
     C***70******BCNL      MULT WDRAL1    REALL0    H              E14514 E20232
     C***71******BCNL      MULT WDRAL1    REALL1    H              E14514 E20232
     C***72******BCNL      MULT WDRAL1    REALL2    H              E14514 E20232
     C***73******BCNL      MULT WDRAL1    REALL3    H              E14514 E20232
     C***********                                                  E14514 E20232
     C***********SPBS      IFEQ 'P'                                E14514 E20232
     C***70******          DIV  100       REALL0    H              E14514 E20232
     C***71******          DIV  100       REALL1    H              E14514 E20232
     C***72******          DIV  100       REALL2    H              E14514 E20232
     C***73******          DIV  100       REALL3    H              E14514 E20232
     C***********          END                                     E14514 E20232
     C***********                                                  E14514 E20232
     C***70******          MOVE REALL0    REALLW                   E14514 E20232
     C***71******          MOVE REALL1    REALLW                   E14514 E20232
     C***72******          MOVE REALL2    REALLW                   E14514 E20232
     C***73******          MOVE REALL3    REALLW                   E14514 E20232
     C***********                                                  E14514 E20232
     C***********5         SUB  NMDP      DC                       E14514 E20232
     C***********REALLW    MULT POWER8,DC REALLW                   E14514 E20232
     C                     Z-ADDBCNL      ZNOML                           E20232
     C                     Z-ADDWDRAL1    ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     REALLW                          E20232
     C*                                                                   E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       REALLW    H                     E20232
     C***********          END                                            E20232
     C*
     C* IF FIFO ACCOUNTING AND TRADE IS SALE,PREVIOUS NOM LONG OR TRADE
     C*     IS PURCHASE,PREVIOUS NOM SHORT
     C*             - DETERMINE HISTORIC TRADES BEING CLOSED
     C*
     C/COPY WNCPYSRC,SE2220C169
     C           FIFO      IFEQ 'Y'
     C           BYSL      ANDNE'Y'                                       CSE006
     C           *IN43     ANDEQ'0'
     C           PNPSN     ANDNE*ZEROS
     C                     EXSR CLOSE
     C* CHECK FOR DB ERROR
     C           *INU7     IFEQ '1'
     C                     GOTO EP10
     C                     END
     C*
     C                     END
     C*
     C* CALCULATE NEW AVERAGE PRICE
     C*
     C                     EXSR AVPR
     C***********          MOVEL'N'       AMTDP   1                S01176 E17686
     C*
     C* PRODUCE REALISED P/L, DISC/PREM AND PURCHASED/ACCRUED INT KEYS
     C*   IF TRADE ACCOUNT KEYS NOT SUPPRESSED
     C*
     C***********SKTD      IFNE BCTV                                      E15549
     C*
     C           RPBS      IFEQ 'B'
     C           RPBS      OREQ BCTV
     C                     MOVE '1'       *IN24
      *                                                                   CSE006
      *** Only do SR/REALPL if not Buy/Sell trade or CSE006 off           CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
     C                     EXSR REALPL
     C                     ELSE                                           CSE006
     C                     EXSR BSPLS                                     CSE006
     C                     ENDIF                                          CSE006
      *                                                                   E19411
      ***  The following two lines were added to E15664 fix because       E19411
      ***  if RPBS was not 'B', Realized P/L could still be corrupted.    E19411
      *                                                                   E19411
     C                     ELSE                                           E19411
     C                     Z-ADD0         RPLINC                          E19411
      *                                                                   E19411
     C                     END
     C*
     C***********SKTD      IFNE BCTV                               E15549 E21225
     C           SKTD      IFEQ 'V'                                       E21670
     C           SKTD      ORNE BCTV                                      E21670
     C*                                                                   E15549
     C***********MATY      IFNE 99999                                     E15442
     C***********STBS      ANDEQ'D'                                       E15442
     C***********STAD      IFEQ 'Y'                                       E15442
     C***********GDPK      OREQ 'Y'                                       E15442
     C           MATY      IFNE 99999                                     E15442
     C           PROT      ANDNE'2'                                       E15442
     C           PROT      ANDNE'4'                                       E15442
     C           PROT      ANDNE'7'                                       E15442
     C/COPY WNCPYSRC,SE2220C206
      * If CSE091 is present always calculate Premium/Discount on a Trade                     CSE091
      *                                                                                       CSE091
      ** Access CAR details file to determine if feature is installed                         CSE091
      *                                                                                       CSE091
     C                     CALL 'AOSARDR0'                                                    CSE091
     C                     PARM *BLANKS   @RTCD   7                                           CSE091
     C                     PARM '*VERIFY' @OPTN   7                                           CSE091
     C                     PARM 'CSE091'  @SARD   6                                           CSE091
     C           SCSARD    PARM *BLANKS   DSFDY                                               CSE091
      *                                                                                       CSE091
     C           @RTCD     IFEQ *BLANKS                                                       CSE091
     C                     MOVEL'Y'       CSE091  1                                           CSE091
     C                     ELSE                                                               CSE091
     C                     MOVEL'N'       CSE091                                              CSE091
     C                     ENDIF                                                              CSE091
      *                                                                                       CSE091
     C*                                                                   E15549
     C           STAD      IFEQ 'Y'                                       E15442
     C           STAD      OREQ 'C'                                       S01233
     C/COPY WNCPYSRC,SE2220C222
     C           STBS      OREQ 'D'                                       E15442
     C           GDPK      ANDEQ'Y'                                       E15442
     C           CSE091    OREQ 'Y'                                                           CSE091
     C/COPY WNCPYSRC,SE2220C179
      *                                                                   CSE006
      *** Only Calculate disc/prem if book is not Buy/Sell                CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
     C*
     C* CALCULATE DISC/PREM ON TRADE
     C*
     C*   -  IF FACE VALUE NOT ALREADY CALCULATED - OBTAIN FACE VALUE
     C*
     C           WFVAL     IFEQ 0
     C                     Z-ADDBCNL      WFVAL
     C           PPDI      IFEQ 'Y'
     C                     MOVE BCTA      BCTA3   63
     C           BCTA3     DIV  100       WBCTA  158H
     C           WFVAL     MULT WBCTA     WFVAL     H
     C                     END
     C***********PROT      IFEQ '8'                                       E20086
     C***********WFVAL     MULT BCCF      WFVAL     H                     E20086
     C***********          END                                            E20086
     C                     END
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
     C*
     C***********          MOVEA'0000'    *IN,70                   E15442 E20232
     C***********70        ADD  CDP       J       20               E15442 E20232
     C***********          SUB  NMDP      J                        E20086 E20232
     C***********          MOVEA'1'       *IN,J                    E15442 E20232
     C***70******          MOVE WCONS     WCONS0                          E20232
     C***71******          MOVE WCONS     WCONS1                          E20232
     C***72******          MOVE WCONS     WCONS2                          E20232
     C***73******          MOVE WCONS     WCONS3                          E20232
     C***70******WFVAL     SUB  WCONS0    WDCPM  130               E15442 E20232
     C***71******WFVAL     SUB  WCONS1    WDCPM  130                      E15442
     C***72******WFVAL     SUB  WCONS2    WDCPM  130                      E15442
     C***73******WFVAL     SUB  WCONS3    WDCPM  130                      E15442
     C***********                                                  E15442 E20232
     C***70******WFVAL     SUB  WCONS0    WDCPM0 130               E15442 E20232
     C***71******WFVAL     SUB  WCONS1    WDCPM1 131               E15442 E20232
     C***72******WFVAL     SUB  WCONS2    WDCPM2 132               E15442 E20232
     C***73******WFVAL     SUB  WCONS3    WDCPM3 133               E15442 E20232
     C***********                                                  E15442 E20232
     C***70******          MOVE WDCPM0    WDCPM  130               E15442 E20232
     C***71******          MOVE WDCPM1    WDCPM                    E15442 E20232
     C***72******          MOVE WDCPM2    WDCPM                    E15442 E20232
     C***73******          MOVE WDCPM3    WDCPM                    E15442 E20232
     C***********5         SUB  NMDP      DC      10               E20232 E22957
     C***********          ADD  CDP       DC                       E20232 E22957
     C***********                                                  E20232 E22957
     C***********WFVAL     MULT POWER8,DC WFVAL     H              E20232 E22957
     C***********WFVAL     SUB  WCONS     WDCPM  130               E20232 E22957
     C*                                                                   E22957
     C*** Update BKVAL by Purchased/Sold Nominal                          E22957
     C*                                                                   E22957
     C           SPBS      IFEQ 'P'                                       E22957
     C                     Z-ADD100       ZPRC                            E22957
     C                     ELSE                                           E22957
     C                     Z-ADD1         ZPRC                            E22957
     C                     END                                            E22957
     C/COPY WNCPYSRC,SE2220C216
     C*                                                                   E22957
     C*** Trade value on sales is -ve                                     E22957
     C*                                                                   E22957
     C           BCPS      IFEQ 'S'                                       E22957
     C                     Z-SUBWFVAL     ZNOML                           E22957
     C                     ELSE                                           E22957
     C                     Z-ADDWFVAL     ZNOML                           E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C                     EXSR ZCNSD                                     E22957
     C/COPY WNCPYSRC,SE2220C189
     C*                                                                   E22957
     C                     Z-ADDBKVAL     PBKVAL                          E22957
     C                     ADD  ZCONS     BKVAL                           E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     ADD  ZCONS     BKVALN                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C           BCPS      IFEQ 'S'                                       047370
     C                     Z-SUBZCONS     ZCONS                           047370
     C                     END                                            047370
     C           ZCONS     SUB  WCONS     WDCPM                           E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           ZCONS     SUB  WCONSN    WDCPN                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C*                                                                   E22957
     C*                                                                   E22957
     C*
     C*  - DEPENDING ON TR/VAL BASIS , PRODUCE ACCOUNT KEYS ON TRADE OR
     C*    VALUE DATE
     C*
     C/COPY WNCPYSRC,SE2220C125
      *                                                                                       CSE105
      ** CSE105 is not installed...                                                           CSE105
      *                                                                                       CSE105
     C           CSE105    IFEQ 'N'                                                           CSE105
      *                                                                                       CSE105
     C           BCTV      IFEQ 'T'
     C                     EXSR DSPRT
     C                     ELSE
     C/COPY WNCPYSRC,SE2220C057
     C                     EXSR DSPRV
     C/COPY WNCPYSRC,SE2220C058
     C                     END
     C/COPY WNCPYSRC,SE2220C126
      *                                                                                       CSE105
      ** ...CSE105 is installed.                                                              CSE105
      *                                                                                       CSE105
     C                     ELSE                                                               CSE105
      *                                                                                       CSE105
      ** For Trade Date Position, process in the same way as Value                            CSE105
      ** Date Position.                                                                       CSE105
      *                                                                                       CSE105
     C           BCTV      IFEQ 'T'                                                           CSE105
      *                                                                                       CSE105
     C           SESVAL    IFEQ 'V'                                                           CSE105
     C                     EXSR DSPRT                                                         CSE105
     C                     ELSE                                                               CSE105
     C                     EXSR DSPRV                                                         CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
     C                     ELSE                                                               CSE105
      *                                                                                       CSE105
      ** Do the normal Value Date Position processing... if new Trade                         CSE105
      ** Basis indicator is 'T', do Trade Date Position processing...                         CSE105
      *                                                                                       CSE105
     C           SESVAL    IFNE 'T'                                                           CSE105
     C                     EXSR DSPRV                                                         CSE105
     C                     ELSE                                                               CSE105
     C                     EXSR DSPRT                                                         CSE105
     C                     ENDIF                                                              CSE105
     C                     ENDIF                                                              CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
     C                     END
     C                     END
     C*
     C***********          END                                            E21225
     C                     END                                            E21670
     C*
     C* IF INTEREST IS ACCRUED ON THIS POSITION - PRODUCE PURCHASED/ACCRUED
     C*   INTEREST KEYS IF REQUIRED - on a value date basis only.
     C*
     C           BCTV      IFEQ 'V'
     C           PROT      IFEQ '1'
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '8'
     C           PROT      OREQ '9'                                       S01176
     C           DYBS      IFNE '4'
      *                                                                   E20085
      ***  Accumulation of Interest Adjustment depends on Purch/Sale.     E20085
      *                                                                   E20085
     C           BCPS      IFEQ 'P'                                       E20085
     C           INDO      ADD  INAJ      INDO
     C                     ELSE                                           E20085
     C           INDO      SUB  INAJ      INDO                            E20085
     C                     END                                            E20085
      *                                                                   090364
      ***  If Nominal Posn goes flat, output discrepancy key and          090364
      ***   reset adjustments to zero.                                    090364
      *                                                                   090364
     C           NPSN      IFEQ 0                                         090364
     C**********           MOVE ' '       NEGI                            090364            226359
     C**********           MOVE 'V'       EVTP                            090364            226359
     C**********           MOVE BCPS      TRTP                            090364            226359
     C**********           MOVE ' '       PORT                            090364            226359
     C********** TSAK      IFEQ 'Y'                                       155100            226359
     C**********           MOVE BCTP      TRST                            155100            226359
     C**********           ELSE                                           155100            226359
     C**********           MOVE '  '      TRST                            090364            226359
     C**********           END                                            155100            226359
     C********** INDO      IFGT 0                                         090364            226359
     C**********           MOVE 'DN'      AMCD                            090364            226359
     C**********           Z-SUBINDO      EVAM                            090364            226359
     C**********           ELSE                                           090364            226359
     C**********           MOVE 'DF'      AMCD                            090364            226359
     C**********           Z-ADDINDO      EVAM                            090364            226359
     C**********           END                                            090364            226359
     C********** EVAM      IFNE 0                                         090364            226359
     C**********           EXSR W01                                       090364            226359
     C**********           END                                            090364            226359
     C                     Z-ADDINDO      WINDO  150                                      MD036550
     C                     Z-ADD0         INDO                            090364
     C                     END                                            090364
      *                                                                   E20085
      ***  Accumulation of Ex-Coupon 'Purchased Interest' for SE0901.     E20085
      *                                                                   E20085
     C           ACRI      IFEQ 'X'                                       E20085
     C           BCPS      IFEQ 'P'                                       E20085
     C                     ADD  PCHI      IACP                            E20085
     C                     ELSE                                           E20085
     C                     SUB  PCHI      IACP                            E20085
     C                     END                                            E20085
     C                     END                                            E20085
     C*
     C           SPIT      IFEQ 'Y'
     C                     EXSR PIAI
     C/COPY WNCPYSRC,SE2220C146
     C                     ELSE
     C                     EXSR PI
     C/COPY WNCPYSRC,SE2220C147
     C                     END
     C           NPSN      IFEQ 0                                         166661
     C           WINDO     ANDEQ0                                                           MD036550
     C           NPSN      OREQ 0                                                             229720
     C           ECNP      ANDEQ0                                                             229720  
     C                     Z-ADD0         PILP                            166661
     C                     Z-ADD0         PILN                                                CAS006
     C                     Z-ADD0         ARPC                            166661
     C                     END                                            166661
     C                     END
     C                     END
     C                     END
     C*
     C* ACCUMULATE FIELDS FOR BOOK POSITION HEADER AND MONTHLY STATS FILE
     C*
      ***  Critical error found when erroneous zeroing of fields was      E20085
      ***  removed from program. BPIT field is the Purchased Interest     E20085
      ***  on Trades Reversed this Month, NOT the Purchased Interest on   E20085
      ***  any Trades on BPACBD/CD processed in Forward Mode. This had    E20085
      ***  serious effects on 'Interest Earned'.                          E20085
      *                                                                   E20085
     C************INU1     IFEQ '0'                                       E20085
     C************IN03     ANDEQ'0'                                       E20085
     C***********BPIT      ADD  PCHI      BPIT                            E20085
     C***********          END                                            E20085
      ***********                                                  E20085 E21355
      *****If*Trade*backvalued*into*a*prior*month,*calculate*the***E20085 E21355
      *****Interest*Accrued*from*Value*Date*to*end*of*last*month.**E20085 E21355
      *****(TIPN*is*only*updated*on*Value*Date*BKMTH*records.)*****E20085 E21355
      *****(NOTE:*this*caters*for*Coupons,*Ex-coupon*and*everything).0085 E21355
      ***********                                                  E20085 E21355
     C***********KBCTV     IFEQ 'V'                                E20085 E21355
     C***********KBCAD     ANDLEEOPMTH                             E20085 E21355
      ***********                                                  E20085 E21355
     C***********          Z-ADDKBCAD     ZDCSDT                   E20085 E21355
     C***********EOPMTH    ADD  1         ZDCEDT                   E20085 E21355
     C***********          Z-ADDBCNL      ZAMT                     E20085 E21355
     C***********          EXSR ZACCZ                              E20085 E21355
      ***********                                                  E20085 E21355
      *****Whether*result*is*Added*To*or*Subtracted*From*TIPN*depends0085 E21355
      *****on*whether*Forward/Reversal*Run*and*Purchase/Sale.******E20085 E21355
      ***********                                                  E20085 E21355
     C************INU1     IFEQ '1'                                E20085 E21355
     C***********          Z-SUBZDCINT    ZDCINT                   E20085 E21355
     C***********          END                                     E20085 E21355
      ***********                                                  E20085 E21355
     C***********BCPS      IFEQ 'S'                                E20085 E21355
     C***********          Z-SUBZDCINT    ZDCINT                   E20085 E21355
     C***********          END                                     E20085 E21355
      ***********                                                  E20085 E21355
     C***********          ADD  ZDCINT    TIPN                     E20085 E21355
     C***********          END                                     E20085 E21355
     C*
     C* SET LATEST NOMINAL POSITION DATE EQUAL TO ACTION DATE
     C*
     C                     Z-ADDBCAD      LPSD
     C***********          Z-ADDBCAD      LPCD                     E18651 E20087
     C                     Z-ADDBCAD      LPCD                            E20087
      *                                                                   CSE006
      *** If Book is Buy/Sell, update BSPOSDL0                            CSE006
      *                                                                   CSE006
     C           BYSL      IFEQ 'Y'                                       CSE006
     C                     UPDATBSPOSD0                                   CSE006
     C                     ENDIF                                          CSE006
     C*
     C           EP10      ENDSR                           ***  EP10  ***
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  P20    - SUBROUTINE TO PROCESS MORTGAGE PAYMENT ACTION       *
      *                                                               *
      *****************************************************************
      *
     C           P20       BEGSR                           ***  P20   ***
     C*
     C                     MOVE '1'       *IN20
      *
      ***  If Value Date Position, bring Accruals up to date.
      *
      *****Must*perform*amortization*for*trade*date*positions*to*obtain87 E20552
      *****correct*average*prices*for*discounted*instruments.****  E20087 E20552
     C***********BCTV      IFEQ 'V'                                E20087 E20552
     C           BCTV      IFEQ 'V'                                       E20087
     C/COPY WNCPYSRC,SE2220C127
      *                                                                                       CSE105
     C           CSE105    ANDEQ'N'                                                           CSE105
      *                                                                                       CSE105
      ** If CSE105 is installed, perform the routines when the new                            CSE105
      ** Trade/Value Amortization flag is "Both" or EQUAL to original                         CSE105
      ** flag.                                                                                CSE105
      *                                                                                       CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQ'B'                                                           CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQBCTV                                                          CSE105
      *                                                                                       CSE105
     C*
     C*  PRODUCE AMORTISED DISC/PREM KEYS IF DISC/PREM TO BE AMORTISED
     C*
     C***********MATY      IFNE 99999                                     E15442
     C***********STBS      ANDEQ'D'                                       E15442
     C***********STAD      IFEQ 'Y'                                       E15442
     C***********GDPK      OREQ 'Y'                                       E15442
     C***********          EXSR AMORT                                     E15442
     C***********          END                                            E15442
     C***********          END                                            E15442
     C           MATY      IFNE 99999                                     E15442
     C           STAD      IFEQ 'Y'                                       E15442
     C           STAD      OREQ 'C'                                       S01233
     C           STBS      OREQ 'D'                                       E15442
     C/COPY WNCPYSRC,SE2220C223
     C           GDPK      ANDEQ'Y'                                       E15442
     C/COPY WNCPYSRC,SE2220C180
      *                                                                   CSE006
      *** Only do SR/AMORT if BYSL not eq 'Y' and switchable feature      CSE006
      *** is on.                                                          CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
     C                     EXSR AMORT                                     E15442
     C                     EXSR AVPRAM                                    E15442
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     END                                            E15442
     C                     END                                            E15442
     C/COPY WNCPYSRC,SE2220C128
      *                                                                                       CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
      ** Do not condition SR/ACCRUE processing on CSE105...                                   CSE105
      *                                                                                       CSE105
     C           BCTV      IFEQ 'V'                                                           CSE105
      *                                                                                       CSE105
      *                                                                   E20087
      *****Following*line*moved*here*to*condition*accruals*only.***E20087 E20552
     C***********BCTV      IFEQ 'V'                                E20087 E20552
     C*
     C* ACCRUE INTEREST ON THIS POSITION IF REQUIRED
     C*
     C           PROT      IFEQ '1'
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '6'
     C           PROT      OREQ '8'
     C           PROT      OREQ '9'                                       S01176
     C*
     C           DYBS      IFNE '4'
     C*                                                                   E15549
     C* FOR LAST COUPON DATE USE LAST COUPON DATE OF THE ACTION           E15549
     C*                                                                   E15549
     C                     Z-ADDLCCP      LCPN                            E15549
     C                     MOVE 'Y'       DADJN                           100017
     C                     EXSR ACCRUE
     C                     MOVE 'N'       DADJN                           100017
     C                     END
     C                     END
     C                     END
     C*
     C* RESET LATEST POSITION DATE
     C*
     C                     Z-ADDBCAD      LPCD
     C*
     C* PRODUCE FACE VALUE KEYS
     C*
     C*   -  CALCULATE FACE VALUE REPAID
     C*
     C           NPSN      IFLT 0
     C           NPSN      MULT -1        WKNOM  150
     C                     ELSE                                           051339
     C                     Z-ADDNPSN      WKNOM                           051339
     C                     END
     C                     MOVEL'Y'       PRIOR                           132717
     C                     EXSR GETCUF                                    132717
      *                                                                   148044
      * First check if MP amount has been entered. Use this if present    148044
      * because using Current Factor introduces rounding errors.          148044
      *                                                                   148044
     C                     Z-ADDBCAD      TDVD                            148044
     C                     MOVE 'MP'      ETYP                            148044
     C           SEDKEY    SETLLSEDEVDO                                   148044
     C                     READ SEDEVDO                  81               148044
      *                                                                   148044
     C           *IN81     IFEQ '0'                                       148044
     C           SDSN      ANDEQBCSS                                      148044
     C           SDET      ANDEQ'MP'                                      148044
     C                     MOVE SRMI      ##SRMI  1                       148044
     C                     ELSE                                           148044
     C                     MOVE 'N'       ##SRMI                          148044
     C                     MOVE SNMCY     NMCY                                                CSE065
     C                     ENDIF                                          148044
      *                                                                   148044
     C           ##SRMI    IFEQ 'Y'                                       148044
      *                                                                   147449
      * If Nominal is Zero then zero Face Value Repayment                 147449
      *                                                                   147449
     C           NPSN      IFNE *ZERO                                     147449
     C                     Z-ADDSRPT      WFVALR                          148044
     C                     ELSE                                           147449
     C                     Z-ADD*ZERO     WFVALR                          147449
     C                     ENDIF                                          147449
      *                                                                   147449
     C                     ELSE                                           148044
      *                                                                   148044
      * If no amount entered then use Current Factor                      148044
      *                                                                   148044
     C***********BCPC      SUB  BCCF      WBCCF   98                      E20086
     C********** AAPR      SUB  BCCF      WBCCF   98               E20086 052254
     C           AAPR      SUB  BCCF      WBCCF                           052254
     C           WBCCF     MULT WKNOM     WFVALR 130H
     C                     ENDIF                                          148044
     C*
     C*   -  OUTPUT FACE VALUE REPAID USER KEY
     C*
     C                     MOVE 'R'       EVTP
     C                     MOVE ' '       TRTP
     C                     MOVE ' '       PORT
     C                     MOVE '  '      TRST
     C                     MOVE 'FV'      AMCD
     C*
     C           NPSN      IFGE 0
     C           NPAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C*
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C                     MOVE *ZEROS    TRFR
     C*
     C                     Z-ADDWFVALR    EVAM
     C           NPSN      IFLT 0
     C           NPAC      ANDEQ'N'
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C004
     C                     END
     C*
     C* PRODUCE CONSIDERATION KEY
     C*
     C*   -  CALCULATE CONSIDERATION REPAID
     C*
     C/COPY WNCPYSRC,SE2220C190
     C                     Z-ADD*ZEROS    WCONSR 150
     C***********          Z-ADD*ZEROS    WCONS0 150                      E20232
     C***********          Z-ADD*ZEROS    WCONS1 151                      E20232
     C***********          Z-ADD*ZEROS    WCONS2 152                      E20232
     C***********          Z-ADD*ZEROS    WCONS3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******WFVALR    MULT LAVP      WCONS0    H                     E20232
     C***71******WFVALR    MULT LAVP      WCONS1    H                     E20232
     C***72******WFVALR    MULT LAVP      WCONS2    H                     E20232
     C***73******WFVALR    MULT LAVP      WCONS3    H                     E20232
     C***********                                                         E20232
     C***70******          MOVE WCONS0    WCONSR                          E20232
     C***71******          MOVE WCONS1    WCONSR                          E20232
     C***72******          MOVE WCONS2    WCONSR                          E20232
     C***73******          MOVE WCONS3    WCONSR                          E20232
     C*
     C* Convert consideration amount
     C*
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********WCONSR    MULT POWER8,DC WCONSR    H                     E20232
     C/COPY WNCPYSRC,SE2220C191
     C                     Z-ADDWFVALR    ZNOML                           E20232
     C                     Z-ADDLAVP      ZPRC                            E20232
     C/COPY WNCPYSRC,SE2220C192
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     WCONSR                          E20232
     C*
     C**If*Price*Basis*'P',*divide*by*100******************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********WCONSR    DIV  100       WCONSR    H                     E20232
     C***********          END                                            E20232
      *
      ***  Can't Factor the Amount of the MP.                             E20086
      *                                                                   E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********WCONSR    MULT CFCT      WCONSR    H                     E20086
     C***********          END                                            E20086
     C*
     C*   -  OUTPUT CONSIDERATION REPAID USER KEY
     C*
     C                     MOVE 'CO'      AMCD
     C                     Z-ADDWCONSR    EVAM
     C*
     C           NPSN      IFLT 0
     C           NPAC      ANDEQ'N'
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C005
     C                     END
     C*
     C* PRODUCE REALISED PROFIT/LOSS KEY
     C*
     C*  - CALCULATE REALISED PROFIT/LOSS
     C*
     C           NPSN      IFLT 0                                         149946
     C* If you are short and your average price is less than face value   149946
     C* --> you generate a loss.   (WCONSR is < WFAVLR)                   149946
     C* If you are short and your average price is more than face value   149946
     C* --> you generate a profit. (WCONSR is > WFAVLR)                   149946
     C           WCONSR    SUB  WFVALR    WRLPL                           149946
     C                     ELSE                                           149946
     C* If you are long and your average price is more than face value    149946
     C* --> you generate a loss.   (WCONSR is > WFAVLR)                   149946
     C* If you are long and your average price is less than face value    149946
     C* --> you generate a profit. (WCONSR is < WFAVLR)                   149946
     C           WFVALR    SUB  WCONSR    WRLPL  150
     C                     END                                            149946
     C*
     C*   - OUTPUT REALISED P/L KEY
     C*
     C           WRLPL     IFGT 0
     C                     MOVE 'RP'      AMCD
     C                     ELSE
     C                     MOVE 'RL'      AMCD
     C                     END
     C*
     C***********          MOVE ' '       NEGI                            E20086
     C*
     C                     Z-ADDWRLPL     EVAM
      *                                                                   149946
      * Removed check on short/long position as P/L key should always     149946
      * be positive. (RP/RL takes care of sign)                           149946
      *                                                                   149946
     C***********NPSN      IFGT 0                                         149946
     C           EVAM      IFLT 0
     C           EVAM      MULT -1        EVAM
     C                     END
     C***********          ELSE                                           149946
     C***********EVAM      IFGT 0                                         149946
     C***********EVAM      MULT -1        EVAM                            149946
     C***********          END                                            149946
     C***********          END                                            149946
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C006
     C                     END
      *                                                                   E20086
      ***  Update AAPR with the new Current Factor.                       E20086
      *                                                                   E20086
     C***********          Z-ADDBCCF      AAPR                     E20086 137217
     C                     MOVEL'N'       PRIOR                           132717
     C                     EXSR GETCUF                                    132717
     C*
     C                     ADD  WRLPL     WRPTP                           052480
     C/COPY WNCPYSRC,SE2220C203
      *                                                                                       CSE065
      ** If security is defined as available for sale,                                        CSE065
      ** calculate Book Value Change and Equity Amount                                        CSE065
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C           PROT      ANDNE'2'                                                           CSE065
     C           PROT      ANDNE'4'                                                           CSE065
     C           PROT      ANDNE'7'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           BCTV      ANDEQ'V'                                                           CSE065
      *                                                                                       CSE065
     C           STAD      IFEQ 'C'                                                           CSE065
     C           STAD      OREQ 'Y'                                                           CSE065
     C                     EXSR P06                                                           CSE065
     C                     EXSR P07                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
     C*                                                                   052480
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  P30    - SUBROUTINE TO PROCESS COUPON ACTION                 *
      *                                                               *
      *****************************************************************
      *
     C           P30       BEGSR                           ***  P30   ***
     C*
     C                     MOVE '1'       *IN20
     C/COPY WNCPYSRC,SE2220C007
     C*                                                                   E18652
     C*  IF NO MOVEMENTS SINCE THE PREVIOUS COUPON DATE                   E18652
     C*  THEN ZEROIZE EX-COUPON NOMINAL AND PURCHASED INTEREST            E18652
      ***  and Interest Adjustment on Position.                           E21546
     C*                                                                   E18652
     C           LPSD      IFLT LCCP                                      E18652
     C/COPY WNCPYSRC,SE2220C148
     C                     Z-ADD*ZERO     ECNP                            E18652
     C                     Z-ADD*ZERO     IACP                            E20085
     C                     Z-ADD*ZERO     PILP                            E18652
     C                     Z-ADD0         PILN                                                CAS006
     C                     Z-ADD0         INDN                                                CAS006
     C                     Z-ADD*ZERO     INDO                            E20085
     C                     END                                            E18652
      *
      ***  If Value Date Position, bring Accruals up to date.
      *
      *****Must*perform*amortization*for*trade*date*positions*to*obtain87 E20552
      *****correct*average*prices*for*discounted*instruments.****  E20087 E20552
     C***********BCTV      IFEQ 'V'                                E20087 E20552
     C           BCTV      IFEQ 'V'                                       E20087
     C/COPY WNCPYSRC,SE2220C129
      *                                                                                       CSE105
     C           CSE105    ANDEQ'N'                                                           CSE105
      *                                                                                       CSE105
      ** If CSE105 is installed, perform the routines when the new                            CSE105
      ** Trade/Value Amortization flag is "Both" or EQUAL to original                         CSE105
      ** flag.                                                                                CSE105
      *                                                                                       CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQ'B'                                                           CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQBCTV                                                          CSE105
      *                                                                                       CSE105
     C*
     C*  PRODUCE AMORTISED DISC/PREM KEYS IF DISC/PREM TO BE AMORTISED
     C*
     C***********MATY      IFNE 99999                                     E15442
     C***********STBS      ANDEQ'D'                                       E15442
     C***********STAD      IFEQ 'Y'                                       E15442
     C***********GDPK      OREQ 'Y'                                       E15442
     C***********          EXSR AMORT                                     E15442
     C***********          END                                            E15442
     C***********          END                                            E15442
     C           MATY      IFNE 99999                                     E15442
     C           STAD      IFEQ 'Y'                                       E15442
     C           STAD      OREQ 'C'                                       S01233
     C/COPY WNCPYSRC,SE2220C224
     C           STBS      OREQ 'D'                                       E15442
     C           GDPK      ANDEQ'Y'                                       E15442
     C/COPY WNCPYSRC,SE2220C181
      *                                                                   CSE006
      *** Only do SR/AMORT if BYSL not eq 'Y' and switchable feature      CSE006
      *** is on.                                                          CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
      *                                                                   CSE006
     C                     EXSR AMORT                                     E15442
     C                     EXSR AVPRAM                                    E15442
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     END                                            E15442
     C                     END                                            E15442
     C/COPY WNCPYSRC,SE2220C130
      *                                                                                       CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
      ** Do not condition SR/ACCRUE processing on CSE105...                                   CSE105
      *                                                                                       CSE105
     C           BCTV      IFEQ 'V'                                                           CSE105
      *                                                                                       CSE105
      *                                                                   E20087
      *****Following*line*moved*here*to*condition*accruals*only.***E20087 E20552
     C***********BCTV      IFEQ 'V'                                E20087 E20552
     C*
     C* ACCRUE INTEREST ON THIS POSITION IF REQUIRED
     C*
     C           PROT      IFEQ '1'
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '6'
     C           PROT      OREQ '8'
     C           PROT      OREQ '9'
     C*
     C           DYBS      IFNE '4'
     C*                                                                   E15549
     C* FOR LAST COUPON DATE USE LAST COUPON DATE OF THE ACTION           E15549
     C*                                                                   E15549
     C                     Z-ADDLCCP      LCPN                            E15549
     C                     MOVE 'Y'       DADJN                           100017
     C                     EXSR ACCRUE
     C                     MOVE 'N'       DADJN                           100017
     C                     END
     C                     END
     C                     END
     C*
     C* SET DATA COMMON TO COUPON KEYS
     C*
     C                     MOVE 'C'       EVTP
     C                     MOVE ' '       TRTP
     C                     MOVE ' '       PORT
     C                     MOVE '  '      TRST
     C           NPSN      IFGE 0
     C           SNAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C                     MOVE *ZEROS    TRFR
     C*
     C* PRODUCE KEY FOR INTEREST DUE
     C*
     C*   -  CALCULATE INTEREST DUE
     C*
     C           ARPC      ADD  PILP      WTINT  150
     C***********          ADD  INDO      WTINT                    E20085 E21429
     C                     SUB  INDO      WTINT                           E21429
     C*
     C*   -  OUTPUT KEY
     C*
     C                     MOVE 'DI'      AMCD
     C                     Z-ADDWTINT     EVAM
     C           WTINT     IFLT 0
     C           SNAC      ANDEQ'Y'
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C                     Z-ADDEVAM      WBCDV
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C008
     C                     END
     C*
     C*   -  OUTPUT KEY FOR INTEREST DISCREPANCY
     C*
     C                     MOVE ' '       NEGI
     C           INDO      IFGT 0
     C                     MOVE 'DN'      AMCD
     C                     Z-ADDINDO      EVAM                            E21429
     C                     ELSE
     C                     MOVE 'DF'      AMCD
     C                     Z-SUBINDO      EVAM                            E21429
     C                     END
     C*
     C***********          Z-ADDINDO      EVAM                            E21429
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C009
     C                     END
     C*
     C*   -  OUTPUT KEY/S FOR PURCHASED INTEREST RECEIVED IF REQUIRED
     C*        AMD ACCRUED INTEREST RECEIVABLE
     C*
     C           NPSN      IFGE 0
     C           SNAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C*
     C           SPIT      IFEQ 'Y'
     C           PROT      ANDNE'6'
     C*
     C                     MOVE 'PI'      AMCD
     C                     Z-ADDPILP      EVAM
     C           NPSN      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C010
     C                     END
     C*
     C                     MOVE 'AI'      AMCD
     C                     Z-ADDARPC      EVAM
     C           NPSN      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C011
     C                     END
     C                     END
     C/COPY WNCPYSRC,SE2220C149
     C*
     C* UPDATE BOOK POSITION HEADER,BOOK POSITION AND MONTHLY STATS FILES
     C*
     C                     Z-ADD0         ARPC
     C                     Z-ADD0         IACP                            E20085
     C                     Z-ADD0         INDO
     C           BHCP      ADD  WTINT     BHCP
     C*
      ***  CPDD should be updated properly in both Reverse and Forward    E20085
      ***  Modes in order to maintain the correct figure.                 E20085
      *                                                                   E20085
     C************IN03     IFEQ '0'                                       E20085
     C           *INU1     IFEQ '0'
     C           CPDD      ADD  WTINT     CPDD
     C                     ELSE                                           E20085
     C                     SUB  WTINT     CPDD                            E20085
     C                     END
     C***********          END                                            E20085
     C***********          Z-ADDBCAD      LPCD                     E18651 E20087
     C*
     C                     Z-ADD0         ECNP
     C*                                                                   E15549
     C                     Z-ADD0         PILP                            E15549
     C                     Z-ADD0         PILN                                                CAS006
     C                     Z-ADD0         INDN                                                CAS006
     C                     Z-ADD0         INDO                            E21546
     C*                                                                   E23748
     C*** Update Last coupon date                                         E23748
     C*                                                                   E23748
     C                     Z-ADDBCAD      LCPN                            E23748
     C/COPY WNCPYSRC,SE2220C012
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  P35    - SUBROUTINE TO PROCESS DIVIDEND ACTION               *
      *                                                               *
      *****************************************************************
      *
     C           P35       BEGSR                           ***  P35   ***
     C*
     C                     MOVE '1'       *IN20
     C*                                                                   E18652
     C*  IF NO MOVEMENTS SINCE THE PREVIOUS DIVIDEND DATE                 E18652
     C*  THEN ZEROIZE EX-DIVIDEND NOMINAL                                 E18652
     C*                                                                   E18652
     C           LPSD      IFLT LCCP                                      E18652
     C                     Z-ADD*ZERO     ECNP                            E18652
     C                     END                                            E18652
     C*
     C* CALCULATE DIVIDEND DUE
     C*
     C           NPSN      SUB  ECNP      WKNOM
     C***********WKNOM     MULT BCAU      WKDIV  130H                     E15549
     C***********5         SUB  NMDP      DC                              E15549
     C***********WKNOM     MULT POWER8,DC WRK154 154               E15549 E20232
     C***********                                                  E15549 E16772
     C***********WRK154    MULT BCAU      WRK154 154               E15549 E16772
     C***********WRK154    MULT BCUN      WRK158 158               E16772 E20232
     C***********CDP       ADD  5         DC                       E15549 E20232
     C***********WRK154    MULT POWER8,DC WRK154                   E15549 E16772
     C***********          Z-ADDWRK154    WKDIV  130H              E15549 E16772
     C***********WRK158    MULT POWER8,DC WRK158                   E16772 E20232
     C***********          Z-ADDWRK158    WKDIV  130H              E16772 E20232
     C                     Z-ADDWKNOM     ZNOML                           E20232
     C                     Z-ADDBCUN      ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     WKDIV  150                      E20232
     C*                                                                   E15549
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********WKDIV     DIV  100       WKDIV     H                     E20232
     C***********          END                                            E20232
     C*
     C* OUTPUT KEY FOR DIVIDEND DUE
     C*
     C                     MOVE 'H'       EVTP
     C                     MOVE ' '       TRTP
     C                     MOVE ' '       PORT
     C                     MOVE '  '      TRST
     C***********          MOVE ' '       NEGI                            E15746
     C*                                                                   E15746
     C* NEGI SHOULD BE 'N' FOR DIVIDEND ON SHORT POSITION IF SNAC = 'Y'   E15746
     C*                                                                   E15746
     C           WKNOM     IFGE 0                                         E15746
     C           SNAC      OREQ 'N'                                       E15746
     C                     MOVE ' '       NEGI                            E15746
     C                     ELSE                                           E15746
     C                     MOVE 'N'       NEGI                            E15746
     C                     END                                            E15746
     C*                                                                   E15746
     C                     MOVE 'DI'      AMCD
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C                     MOVE *ZEROS    TRFR
     C*
     C                     Z-ADDWKDIV     EVAM
     C*
      ***  Reverse sign on Output File if Split Negative Accrual = 'Y'    E20125
      ***  and Cum-Coupon Value is Less Than zero.                        E20125
      *                                                                   E20125
     C           SNAC      IFEQ 'Y'                                       E20125
     C           WKNOM     ANDLT0                                         E20125
     C                     Z-SUBEVAM      EVAM                            E20125
     C                     END                                            E20125
     C*                                                                   E20125
     C                     Z-ADDEVAM      WBCDV
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C013
     C                     END
     C*
     C* UPDATE BOOK POSITION AND MONTHLY STATS FILES
     C*
     C           BHDP      ADD  WKDIV     BHDP
     C*
      ***  CPDD should be updated properly in both Reverse and Forward    E20085
      ***  Modes in order to maintain the correct figure.                 E20085
      *                                                                   E20085
     C************IN03     IFEQ '0'                                       E20085
     C************INU1     ANDEQ'0'                                       E20085
     C           *INU1     IFEQ '0'                                       E20085
     C           CPDD      ADD  WKDIV     CPDD
     C                     ELSE                                           E20085
     C                     SUB  WKDIV     CPDD                            E20085
     C                     END
     C*
     C                     Z-ADD0         ECNP
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  P50    - SUBROUTINE TO PROCESS RATE CHANGE ACTION            *
      *                                                               *
      *****************************************************************
      *
     C           P50       BEGSR                           ***  P50   ***
     C*
     C                     MOVE '1'       *IN20
      *
      ***   If Value Date Position, bring Accruals up to date.
      *
      *****Must*perform*amortization*for*trade*date*positions*to*obtain87 E20552
      *****correct*average*prices*for*discounted*instruments.****  E20087 E20552
     C***********BCTV      IFEQ 'V'                                E20087 E20552
     C           BCTV      IFEQ 'V'                                       E20087
     C*
     C***PRODUCE*AMORTISED*DISC/PREM*KEYS*IF*DISC/PREM*TO*BE*AMORTISED    129596
     C*
     C***********MATY      IFNE 99999                                     E15442
     C***********STBS      ANDEQ'D'                                       E15442
     C***********STAD      IFEQ 'Y'                                       E15442
     C***********GDPK      OREQ 'Y'                                       E15442
     C***********          EXSR AMORT                                     E15442
     C***********          END                                            E15442
     C***********          END                                            E15442
     C           MATY      IFNE 99999                                     E15442
     C           STAD      IFEQ 'Y'                                       E15442
     C           STAD      OREQ 'C'                                       S01233
     C/COPY WNCPYSRC,SE2220C225
     C           STBS      OREQ 'D'                                       E15442
     C           GDPK      ANDEQ'Y'                                       E15442
     C/COPY WNCPYSRC,SE2220C182
     C***********          EXSR AMORT                              E15442 129596
     C***********          EXSR AVPRAM                             E15442 129596
     C           CSE032    IFEQ 'Y'                                                           230115
     C           STAD      ANDEQ'C'                                                           230115
     C                     EXSR AMORT                                                         230115
     C                     EXSR AVPRAM                                                        230115
     C                     ENDIF                                                              230115
     C                     END                                            E15442
     C                     END                                            E15442
      *                                                                   E20087
      *****Following*line*moved*here*to*condition*accruals*only.***E20087 E20552
     C***********BCTV      IFEQ 'V'                                E20087 E20552
     C*
     C* ACCRUE INTEREST ON THIS POSITION IF REQUIRED
     C*
     C           PROT      IFEQ '1'
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '6'
     C           PROT      OREQ '8'
     C           PROT      OREQ '9'                                       S01176
     C*
     C           DYBS      IFNE '4'
     C*                                                                   E15549
     C* FOR LAST COUPON DATE USE LAST COUPON DATE OF THE ACTION           E15549
     C*                                                                   E15549
     C                     Z-ADDLCCP      LCPN                            E15549
     C                     MOVE 'Y'       DADJN                           100017
     C                     EXSR ACCRUE
     C                     MOVE 'N'       DADJN                           100017
     C                     END
     C                     END
     C                     END
     C*
     C* RESET LATEST POSITION CHANGE DATE
     C*
     C                     Z-ADDBCAD      LPCD
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  P60    - SUBROUTINE TO PROCESS AVERAGE PRICE CHANGE ACTION   *
      *                                                               *
      *****************************************************************
      *
     C           P60       BEGSR                           ***  P60   ***
     C*
     C                     MOVE '1'       *IN20
      *                                                                   E21097
      ***  If Value Date Position, bring Accruals up to date.             E21097
      *                                                                   E21097
     C           BCTV      IFEQ 'V'                                       E21097
     C/COPY WNCPYSRC,SE2220C131
      *                                                                                       CSE105
     C           CSE105    ANDEQ'N'                                                           CSE105
      *                                                                                       CSE105
      ** If CSE105 is installed, perform the routines when the new                            CSE105
      ** Trade/Value Amortization flag is "Both" or EQUAL to original                         CSE105
      ** flag.                                                                                CSE105
      *                                                                                       CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQ'B'                                                           CSE105
     C           CSE105    OREQ 'Y'                                                           CSE105
     C           SESVAL    ANDEQBCTV                                                          CSE105
      *                                                                                       CSE105
     C*                                                                   E21097
     C*  PRODUCE AMORTISED DISC/PREM KEYS IF DISC/PREM TO BE AMORTISED    E21097
     C*                                                                   E21097
     C           MATY      IFNE 99999                                     E21097
     C           STAD      IFEQ 'Y'                                       E21097
     C           STAD      OREQ 'C'                                       E21097
     C/COPY WNCPYSRC,SE2220C226
     C           STBS      OREQ 'D'                                       E21097
     C           GDPK      ANDEQ'Y'                                       E21097
     C/COPY WNCPYSRC,SE2220C183
      *                                                                   CSE006
      *** Only do SR/AMORT if BYSL not eq 'Y' and switchable feature      CSE006
      *** is on.                                                          CSE006
      *                                                                   CSE006
     C           CSE006    IFEQ 'Y'                                       CSE006
     C           BYSL      ANDNE'Y'                                       CSE006
     C           CSE006    ORNE 'Y'                                       CSE006
      *                                                                   CSE006
     C                     EXSR AMORT                                     E21097
     C                     EXSR AVPRAM                                    E21097
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     END                                            E21097
     C                     END                                            E21097
     C                     END                                            E21097
     C*                                                                   E21097
     C* OBTAIN NEW AVERAGE PRICE ON A PRICE TRADE BASIS
     C*
     C                     Z-ADDLAVP      PLAVP
     C                     Z-ADDAPNC      PAPNC                           E22957
     C*                                                                   CPM004
     C** PORTFOLIO CURRENCY RATE                                          CPM004
     C*                                                                   CPM004
     C           APNC      IFNE *ZERO                                     CPM004
     C           FXAP      DIV  APNC      WFACT                           CPM004
     C                     ELSE                                           CPM004
     C                     Z-ADD*ZERO     WFACT                           CPM004
     C                     END                                            CPM004
     C*                                                                   E15965
     C* CONVERT PRICE ON THE ACTION TO PRICE FORMAT                       E15965
     C*
     C                     Z-ADDBCPR      ZPRCIN
     C***********          Z-ADDRUND      ZFDATE                          E15965
     C                     Z-ADDBCAD      ZFDATE                          E15965
     C*                                                                   S01232
     C*      Australian yield parameters                                  S01232
     C*                                                                   S01232
     C           *IN53     IFEQ '1'                                       S01232
     C           NPSN      ANDNE0                                         S01232
     C*                                                                   E20953
     C* set nominal to positive for working on                            E20953
     C           NPSN      IFLT 0                                         E20953
     C                     Z-SUBNPSN      WNOML  130                      E20953
     C                     ELSE                                           E20953
     C                     Z-ADDNPSN      WNOML                           E20953
     C                     END                                            E20953
     C*                                                                   E22957
     C* Obtain next coupon date                                           E22957
     C* (Add 1 to ECD so that if ZFDATE=NCD,calculate NCD after that)     E22957
     C           ZFDATE    ADD  1         ECD                             E22957
     C                     EXSR ZNCD                                      E22957
     C*                                                                   E22957
     C* Obtain last coupon date                                           E22957
     C           NCD       SUB  1         ZECD                            E22957
     C                     EXSR ZLCD                                      E22957
     C                     Z-ADDZZLCD     LCOUP   50                      E22957
     C*                                                                   E20953
     C* Determine if period Cum. or Ex                                    E20953
     C***********          Z-ADDBCAD      WRKD    50               E20953 E22957
     C                     Z-ADDZFDATE    WRKD    50                      E22957
     C                     EXSR ZYCE                                      E20953
     C*                                                                   E20953
     C* Calculate interest for Cum period (SCUMEX = C)                    E20953
     C           SCUMEX    IFEQ 'C'                                       E20953
     C***********          Z-ADDSVLCPN    ZDCSDT                   S01232 E22957
     C***********          Z-ADDBCAD      ZDCEDT                   S01232 E22957
     C                     Z-ADDLCOUP     ZDCSDT                          E22957
     C                     Z-ADDZFDATE    ZDCEDT                          E22957
     C***********          Z-ADDNPSN      ZAMT                     S01232 E20953
     C                     Z-ADDWNOML     ZAMT                            E20953
     C/COPY WNCPYSRC,SE2220C081
     C                     EXSR ZACCZ                                     S01232
     C/COPY WNCPYSRC,SE2220C082
     C                     Z-ADDZDCINT    TOTACC                          E20953
     C                     Z-ADDZDCINT    WRKPIX                          E22957
     C***********ZDCINT    DIV  NPSN      WRKPI                    S01232 E20953
     C***********          Z-ADDBCAD      WRKD    50               S01232 E20953
     C***********          EXSR ZYCE                               S01232 E20953
     C***********                                                  E20953 E22957
     C**Calculate*the*Accrued*Interest*on*the*Ex-Coupon*Nominal*** E20953 E22957
     C***********ECNP      IFEQ 0                                  E20953 E22957
     C***********          Z-ADD0         WTCPN                    E20953 E22957
     C***********          ELSE                                    E20953 E22957
     C***********          Z-ADDSVLCPN    ZDCSDT                   E20953 E22957
     C***********          Z-ADDNCD       ZDCEDT                   E20953 E22957
     C***********ECNP      IFLT 0                                  E20953 E22957
     C***********          Z-SUBECNP      ZAMT                     E20953 E22957
     C***********          ELSE                                    E20953 E22957
     C***********          Z-ADDECNP      ZAMT                     E20953 E22957
     C***********          END                                     E20953 E22957
     C***********          EXSR ZACCZ                              E20953 E22957
     C***********          Z-ADDZDCINT    WTCPN                    E20953 E22957
     C***********          END                                     E20953 E22957
     C***********                                                  E20953 E22957
     C***********TOTACC    SUB  WTCPN     WRKPIX                   E20953 E22957
     C***********WRKPIX    IFLT 0                                  E20953 E21084
     C***********WRKPIX    IFLE 0                                  E21084 E22957
     C***********          MOVE 'X'       SCUMEX                   E20953 E22957
     C***********          END                                     E20953 E22957
     C*                                                                   E20953
     C                     END                                            E20953
     C*                                                                   S01232
     C*          IF EX-COUPON THEN PI PASSED IS THE REMAINING INTEREST    S01232
     C*          TILL NCD AND IS NEGATIVE                                 S01232
     C*                                                                   S01232
     C           SCUMEX    IFEQ 'X'                                       S01232
     C***********          Z-ADDSVLCPN    ZDCSDT                   S01232 E22957
     C                     Z-ADDLCOUP     ZDCSDT                          E22957
     C                     Z-ADDNCD       ZDCEDT                          S01232
     C                     Z-ADDWNOML     ZAMT                            E20953
     C/COPY WNCPYSRC,SE2220C083
     C                     EXSR ZACCZ                                     S01232
     C/COPY WNCPYSRC,SE2220C084
     C                     Z-ADDZDCINT    NCDWRK                          E20953
     C***********ZDCINT    DIV  NPSN      WKWPI  159               S01232 E20953
     C***********WRKPI     SUB  WKWPI     WRKPI                    S01232 E20953
     C*                                                                   E20953
     C* Calculate interest to Next Coupon Date                            E20953
     C* ( = LCDWRK - NCDWRK )                                             E22957
     C***********          Z-ADDSVLCPN    ZDCSDT                   E20953 E22957
     C***********          Z-ADDBCAD      ZDCEDT                   E20953 E22957
     C                     Z-ADDLCOUP     ZDCSDT                          E22957
     C                     Z-ADDZFDATE    ZDCEDT                          E22957
     C/COPY WNCPYSRC,SE2220C085
     C                     EXSR ZACCZ                                     E20953
     C/COPY WNCPYSRC,SE2220C086
     C                     Z-ADDZDCINT    LCDWRK                          E20953
     C*                                                                   E20953
     C           LCDWRK    SUB  NCDWRK    WRKPIX                          E20953
     C*                                                                   E20953
     C                     END                                            E20953
     C*                                                                   E20953
     C**Make interest figure a percentage                                 E20953
     C           WRKPIX    DIV  WNOML     WRKPI                           E20953
     C*                                                                   E20953
     C***********          END                                     S01232 E20953
     C                     ELSE                                           S01232
     C                     Z-ADD0         WRKPI                           S01232
     C                     MOVE 'C'       SCUMEX                          S01232
     C                     END                                            S01232
     C*                                                                   E39495
     C                     Z-ADDNPSN      ZNOML                           E39495
     C           CSE032    IFEQ 'Y'                                                           229289
     C           WOTBS     ANDNE*BLANK                                                        229289
     C                     MOVE WOTBS     STBS                                                229289
     C                     ENDIF                                                              229289
     C*                                                                   S01232
     C                     EXSR ZPRCI
      **
      ** If "MARK TO MARKET" action indicated                             S01288
      **     If "ST revalue mark to market" is LOSS                       S01288
      **         If the position is SHORT                                 S01288
      **         AND"New av. price" LESS than "Current av. price"         S01288
      **         OR                                                       S01288
      **         If the position is LONG                                  S01288
      **         AND"New av. price" GREATER than "Current av. price"      S01288
      **         Skip to the end of of this sub-routine.                  S01288
      **                                                                  S01288
     C/COPY WNCPYSRC,SE2220C066
     C           BCTP      IFEQ 'MM'                                      S01288
     C           STRM      IFEQ 'L'                                       S01288
     C           NPSN      IFLT 0                                         S01288
     C***********BCPR      ANDLTLAVP                               S01288 E38112
     C           ZPRCOT    ANDLTLAVP                                      E38112
     C           NPSN      ORGT 0                                         S01288
     C***********BCPR      ANDGTLAVP                               S01288 E38112
     C           ZPRCOT    ANDGTLAVP                                      E38112
     C                     GOTO ENDP60                                    S01288
     C                     END                                            S01288
     C                     END                                            S01288
     C                     END                                            S01288
      *                                                                   S01288
     C* RESET LATEST AVERAGE PRICE
     C*
     C/COPY WNCPYSRC,SE2220C062
      *                                                                                       CSE065
      ** Calculate Mark to Market Book Cost and Average Price                                 CSE065
      ** for Available for Sale Book                                                          CSE065
      *                                                                                       CSE065
     C                     MOVE 'N'       WUPD    1                                           CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           PROT      ANDNE'2'                                                           CSE065
     C           PROT      ANDNE'4'                                                           CSE065
     C           PROT      ANDNE'7'                                                           CSE065
     C           STAD      IFEQ 'Y'                                                           CSE065
     C           STAD      OREQ 'C'                                                           CSE065
     C                     Z-ADDZPRCOT    NAVP                                                CSE065
     C                     Z-ADDNPSN      ZNOML                                               CSE065
     C                     Z-ADDNAVP      ZPRC                                                CSE065
     C                     EXSR ZCNSD                                                         CSE065
     C                     Z-ADDZCONS     BKCOST                                              CSE065
     C                     MOVE 'Y'       WUPD                                                CSE065
     C                     EXSR BKPCHN                                                        CSE065
     C           *IN65     IFEQ '0'                                                           CSE065
     C                     EXCPTUPDBKP                                                        CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C           WUPD      IFEQ 'N'                                                           CSE065
     C                     Z-ADDZPRCOT    LAVP
     C*                                                                   E29246
     C* Caclulate new AP numerator                                        E29246
     C*                                                                   E29246
     C                     Z-ADDNPSN      ZNOML                           E29246
     C                     Z-ADDLAVP      ZPRC                            E29246
     C                     EXSR ZCNSD                                     E29246
     C                     Z-ADDZCONS     APNC                            E29246
     C*                                                                   CPM004
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDBCPN      ZPRCIN                                              CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     EXSR ZPRCI                                                         CAS006
     C                     Z-ADDZPRCOT    LAVN                                                CAS006
      *                                                                                       CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     Z-ADDLAVN      ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     APNN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CSE065
      *                                                                                       CAS006
     C*  - Update portfolio currency equivalents                          CPM004
     C*                                                                   CPM004
     C           APNC      MULT WFACT     FXAP                            CPM004
     C                     Z-ADDFXAP      LFXP                            CPM004
     C*
     C**DO*SECTION*ONLY*IF*TRADE*BASIS*IS*'D'**************************   E15442
     C* IF PRICE CHANGE IS NOT DUE TO MARK TO MARKET REVALUATION          E15442
     C* AND AMORTIZATION IS BEING DONE FOR THIS SECURITY THEN             E15442
     C* GENERATE DISCOUNT/PREMIUM AMORTIZED KEYS                          E15442
     C*                                                                   E15442
     C***********STBS      IFEQ 'D'                                       E15442
     C                     Z-ADD*ZERO     WDCPM                           E15442
     C                     Z-ADD*ZERO     WDCPN                                               CAS006
     C*COP* WN*PYSRC*SE2220C067                                           S01408
     C/COPY WNCPYSRC,SE2220C067
     C/COPY WNCPYSRC,SE2220CP67                                           S01408
     C           BCTP      IFNE 'MM'                                      E15442
     C           PROT      ANDNE'2'                                       E15442
     C           PROT      ANDNE'4'                                       E15442
     C           PROT      ANDNE'7'                                       E15442
     C           MATY      ANDNE99999                                     E15442
      *                                                                   E15442
     C/COPY WNCPYSRC,SE2220C067                                           S01408
     C           STAD      IFEQ 'Y'                                       E15442
     C           STAD      OREQ 'C'                                       S01233
     C/COPY WNCPYSRC,SE2220C227
     C           STBS      OREQ 'D'                                       E15442
     C           GDPK      ANDEQ'Y'                                       E15442
     C/COPY WNCPYSRC,SE2220C184
     C*
     C* CALCULATE NEW UNAMORTISED DISC/PREM
     C*
     C***********ZPRCOT    DIV  100       WPRICE    H                     E22957
     C***********1         SUB  WPRICE    WPRICE                          E22957
     C***********NPSN      MULT WPRICE    WDCPM     H                     E22957
     C*                                                                   E22957
     C**********           Z-ADDLAVP      ZPRC                     E22957 E29246
     C**********           Z-ADDNPSN      ZNOML                    E22957 E29246
     C**********           EXSR ZCNSD                              E22957 E29246
     C**********           Z-ADDZCONS     APNC                     E22957 E29246
     C*                                                                   E22957
     C*                                                                   E22957
     C           BKVAL     SUB  APNC      WDCPM  150                      E22957
     C*                                                                   E29207
     C* Adjust Discount/Premium posted since last position date           E29207
     C/COPY WNCPYSRC,SE2220C228
     C*                                                                   E29207
     C                     SUB  WDCPM     DPAP                            E29207
     C                     ADD  BUDU      DPAP                            E29207
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           BKVALN    SUB  APNN      WDCPN  150                                          CAS006
     C                     SUB  WDCPN     DPAN                                                CAS006
     C                     ADD  BUDN      DPAN                                                CAS006
     C                     ENDIF                                                              CAS006
     C/COPY WNCPYSRC,SE2220C229
     C*                                                                   E22957
     C* POST CHANGE TO DISC/PREM ON POSITION
     C*
     C*   -  SET UP INDICATORS FOR AVERAGE PRICE CHANGES
     C*
     C***********                                                         E22957
     C***********PLAVP     IFGT 100                                       E22957
     C***********ZPRCOT    ANDGT100                                       E22957
     C***********          MOVE '1'       *IN29                           E22957
     C***********          ELSE                                           E22957
     C***********PLAVP     IFLT 100                                       E22957
     C***********ZPRCOT    ANDLT100                                       E22957
     C***********          MOVE '1'       *IN29                           E22957
     C***********          ELSE                                           E22957
     C***********          MOVE '1'       *IN28                           E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C                     MOVEA'00'      *IN,28                          E22957
     C           PAPNC     IFGT BKVAL                                     E22957
     C           APNC      ANDGTBKVAL                                     E22957
     C                     MOVE '1'       *IN29                           E22957
     C                     ELSE                                           E22957
     C           PAPNC     IFLT BKVAL                                     E22957
     C           APNC      ANDLTBKVAL                                     E22957
     C                     MOVE '1'       *IN29                           E22957
     C                     ELSE                                           E22957
     C                     MOVE '1'       *IN28                           E22957
     C                     END                                            E22957
     C                     END                                            E22957
     C*
     C*   -  SET COMMON KEY FIELDS
     C*
     C                     MOVE ' '       TRTP
     C                     MOVE ' '       PORT
     C                     MOVE '  '      TRST
     C                     MOVE *ZEROS    TRFR
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C*
     C*   -  IF POSITION HAS CHANGED FROM DISC TO PREM OR VICE VERSA
     C*       - TWO KEYS ARE PRODUCED
     C*
     C           *IN28     IFEQ '1'
     C*
     C*   SET UP FIRST KEY TO REDUCE EXISTING DISC/PREM TO ZERO
     C*
     C                     MOVE BCTV      EVTP
     C***********PLAVP     IFLT 100                                       E22957
     C           BKVAL     IFGT 0                                         E22957
     C           PAPNC     ANDLTBKVAL                                     E22957
     C           BKVAL     ORLT 0                                         E22957
     C           PAPNC     ANDGTBKVAL                                     E22957
     C                     MOVE 'DS'      AMCD
     C                     ELSE
     C                     MOVE 'PR'      AMCD
     C                     END
     C*
     C           NPSN      IFGE 0
     C           NPAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C*
     C***********          Z-ADDBUDU      EVAM                            E22957
     C***********NPSN      IFGE 0                                         E22957
     C***********NPAC      OREQ 'Y'                                       E22957
     C***********EVAM      IFGT 0                                         E22957
     C***********EVAM      MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********          ELSE                                           E22957
     C***********EVAM      IFLT 0                                         E22957
     C***********EVAM      MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***  Reverse Posted Premium / Discount and Reset to Zero            E22957
     C*                                                                   E22957
     C                     Z-SUBBUDU      EVAM                            E22957
     C                     Z-ADD0         BUDU                            E22957
     C                     Z-ADD0         BUDN                                                CAS006
     C/COPY WNCPYSRC,SE2220C072
     C*                                                                   E22957
     C** - Reverse sign on Premiums, because different key                E22957
     C*                                                                   E22957
     C           AMCD      IFEQ 'PR'                                      E22957
     C                     Z-SUBEVAM      EVAM                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C** - Reverse sign on Short positions if in key                      E22957
     C*                                                                   E22957
     C           NPSN      IFLT 0                                         E22957
     C           NPAC      ANDEQ'Y'                                       E22957
     C                     Z-SUBEVAM      EVAM                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
      *                                                                   E20086
      ***  Adjust posting amount by the Mortgage Current Factor.          E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C150
     C                     MULT AAPR      EVAM                            E20086
     C                     END                                            E20086
     C*
     C*  OUTPUT FIRST KEY
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C014
     C                     END
     C/COPY WNCPYSRC,SE2220C073
     C                     END                                            E22957
     C*
     C*  -  SET UP SECOND KEY FOR NEW DISC/PREM
     C*
     C                     MOVE BCTV      EVTP
     C***********LAVP      IFLT 100                                       E22957
     C           BKVAL     IFGT 0                                         E22957
     C           APNC      ANDLTBKVAL                                     E22957
     C           BKVAL     ORLT 0                                         E22957
     C           APNC      ANDGTBKVAL                                     E22957
     C                     MOVE 'DS'      AMCD
     C                     ELSE
     C                     MOVE 'PR'      AMCD
     C                     END
     C*
     C           NPSN      IFGE 0
     C           NPAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C*
     C***********          Z-ADDWDCPM     EVAM                            E22957
     C***********NPSN      IFGE 0                                         E22957
     C***********NPAC      OREQ 'Y'                                       E22957
     C***********EVAM      IFLT 0                                         E22957
     C***********EVAM      MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********          ELSE                                           E22957
     C***********EVAM      IFGT 0                                         E22957
     C***********EVAM      MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C*                                                                   E22957
     C** - Calculate Change to Unamortised Discount/Premium               E22957
     C*                                                                   E22957
     C           WDCPM     SUB  BUDU      EVAM                            E22957
     C*                                                                   E22957
     C** - Reverse sign on Premiums, because different key                E22957
     C*                                                                   E22957
     C           AMCD      IFEQ 'PR'                                      E22957
     C                     Z-SUBEVAM      EVAM                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C** - Reverse sign on Short positions if in key                      E22957
     C*                                                                   E22957
     C           NPSN      IFLT 0                                         E22957
     C           NPAC      ANDEQ'Y'                                       E22957
     C                     Z-SUBEVAM      EVAM                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
      *                                                                   E20086
      ***  Adjust posting amount by the Mortgage Current Factor.          E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C151
     C                     MULT AAPR      EVAM                            E20086
     C                     END                                            E20086
     C*
     C*  OUTPUT SECOND KEY
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C015
     C                     END
     C*
     C***********          ELSE                                           E22957
     C***********                                                         E22957
     C**IF*POSITION HAS REMAINED AT A DISCOUNT OR AT A PREMIUM            E22957
     C*****ONLY*ONE KEY IS REQUIRED                                       E22957
     C***********                                                         E22957
     C*****-**CALCULATE CHANGE TO UNAMORTISED DISC/PREM                   E22957
     C***********                                                         E22957
     C***********BUDU      SUB  WDCPM     WCAMT                           E22957
     C***********                                                         E22957
     C*****-**PRODUCE*KEY*FOR*CHANGE*******                               E22957
     C***********                                                         E22957
     C***********          MOVE BCTV      EVTP                            E22957
     C***********PLAVP     IFLT 100                                       E22957
     C***********          MOVE 'DS'      AMCD                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'PR'      AMCD                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********NPSN      IFGE 0                                         E22957
     C***********NPAC      OREQ 'N'                                       E22957
     C***********          MOVE ' '       NEGI                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'N'       NEGI                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          Z-ADDWCAMT     EVAM                            E22957
     C***********NPSN      IFGE 0                                         E22957
     C***********NPAC      OREQ 'Y'                                       E22957
     C***********EVAM      IFLT 0                                         E22957
     C***********EVAM      MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********          ELSE                                           E22957
     C***********EVAM      IFGT 0                                         E22957
     C***********EVAM      MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C***********                                                  E20086 E22957
     C*****Adjust*posting*amount*by*the*Mortgage*Current*Factor.** E20086 E22957
     C***********                                                  E20086 E22957
     C***********PROT      IFEQ '8'                                E20086 E22957
     C***********          MULT AAPR      EVAM                     E20086 E22957
     C***********          END                                     E20086 E22957
     C***********                                                         E22957
     C***********EVAM      IFNE 0                                         E22957
     C***********          EXSR W01                                       E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          END                                            E22957
     C*
     C* END OF SECTION ONLY IF TRADE BASIS IS 'D'
     C*                                                                   E15965
     C                     END                                            E15965
     C                     END
     C/COPY WNCPYSRC,SE2220C068
      *                                                                                       CSE036
      ** If CSE036 then don't do Unrelised P/L                                                CSE036
      *                                                                                       CSE036
     C           CSE036    IFEQ 'Y'                                                           CSE036
     C                     MOVE 'N'       #EXSR                                               CSE036
     C                     ENDIF                                                              CSE036
     C*
     C* PRODUCE UNREALISED P/L ACCOUNT KEYS
     C*
     C           AUPR      IFEQ 'Y'
     C           UPPS      ANDNE' '
      *                                                                   E21531
      ***  Don't generate Unrealized P/L Keys in Reversal mode.           E21531
     C           *INU1     ANDEQ'0'                                       E21531
     C/COPY WNCPYSRC,SE2220C137
     C*                                                                   E21531
     C           UPBS      IFEQ 'B'
     C           UPBS      OREQ BCTV
     C                     MOVEL'Y'       PRCCHG  1                       E15965
     C/COPY WNCPYSRC,SE2220C201
     C                     EXSR UNRLPL
     C/COPY WNCPYSRC,SE2220C202
     C                     MOVEL*BLANK    PRCCHG                          E15965
     C                     END
     C                     END
     C*
     C* PRODUCE REALISED P/L ACCOUNT KEYS
     C*
     C***********SKTD      IFNE BCTV                                      E15549
     C           RPBS      IFEQ 'B'
     C           RPBS      OREQ BCTV
     C                     MOVE '1'       *IN25
     C*                                                                   E22957
     C** -  Clear Trade Amount                                            E22957
     C                     Z-ADD0         WCAMT                           E22957
     C*                                                                   E22957
     C                     EXSR REALPL
     C*                                                                   E15965
     C** UPDATE MONTHLY STATISTICS TOTAL FOR M/M PROFIT                   E15965
     C*                                                                   E15965
     C           *INU1     IFEQ '0'                                       E20620
     C                     ADD  WRLPL     MMPL                            E15965
     C                     ELSE                                           E20620
     C                     SUB  WRLPL     MMPL                            E20620
     C                     END                                            E20620
     C                     END
     C***********          END                                            E15549
     C*
     C* RESET LATEST POSITION DATE
     C*
     C                     Z-ADDBCAD      LPCD
     C*
     C* RESET UNAMORTISED DISC/PREM
      *                                                                                       CSE065
      ** Reset only Unamortised Disc/Prem if not Available for Sale Book                      CSE065
      *                                                                                       CSE065
     C           WUPD      IFEQ 'N'                                                           CSE065
     C*
     C                     Z-ADDWDCPM     BUDU
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDWDCPN     BUDN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C*
     C* CALCULATE NEW AP NUMERATOR
     C*
     C***********LAVP      MULT NPSN      APNC      H                     S01129
     C*
     C***********          ENDSR                                          S01129
     C                     Z-ADDLAVP      APPB                            E15965
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDLAVN      APPN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CSE065
      *                                                                                       CAS006
     C***********          Z-ADD*ZEROS    APNC0  150               S01129 E20232
     C***********          Z-ADD*ZEROS    APNC1  151               S01129 E20232
     C***********          Z-ADD*ZEROS    APNC2  152               S01129 E20232
     C***********          Z-ADD*ZEROS    APNC3  153               S01129 E20232
     C***********          MOVEA'0000'    *IN,70                   S01129 E20232
     C***********70        ADD  CDP       J       20               S01129 E20232
     C***********          MOVEA'1'       *IN,J                    S01129 E20232
     C***70******NPSN      MULT LAVP      APNC0                    S01129 E20232
     C***71******NPSN      MULT LAVP      APNC1                    S01129 E20232
     C***72******NPSN      MULT LAVP      APNC2                    S01129 E20232
     C***73******NPSN      MULT LAVP      APNC3                    S01129 E20232
     C***********                                                  S01129 E20232
     C***70******          MOVE APNC0     APNC                     S01129 E20232
     C***71******          MOVE APNC1     APNC                     S01129 E20232
     C***72******          MOVE APNC2     APNC                     S01129 E20232
     C***73******          MOVE APNC3     APNC                     S01129 E20232
     C*                                                                   S01129
     C* Reformat amount, allowing for nominal decimal places              S01129
     C*                                                                   S01129
     C***********5         SUB  NMDP      DC      10               S01129 E20232
     C***********APNC      MULT POWER8,DC APNC      H              S01129 E20232
     C***********          Z-ADDNPSN      ZNOML                    E20232 E22957
     C***********          Z-ADDLAVP      ZPRC                     E20232 E22957
     C***********          EXSR ZCNSD                              E20232 E22957
     C***********          Z-ADDZCONS     APNC                     E20232 E22957
     C*                                                                   S01129
     C**Price*basis*'P'********************************************S01129 E20232
     C*                                                                   S01129
     C***********SPBS      IFEQ 'P'                                S01129 E20232
     C***********          DIV  100       APNC                     S01129 E20232
     C***********          END                                     S01129 E20232
     C*                                                                   S01129
     C* If FIFO accounting, reset all open trade prices                   S01129
     C*                                                                   S01129
     C           FIFO      IFEQ 'Y'                                       S01129
     C           NPSN      ANDNE*ZEROS                                    S01129
     C*                                                                   S01129
     C* STORE RECORDS FROM CURRENT ACTIONS THAT WILL BE OVERWRITTEN BY    S01129
     C* CHAIN TO HTRACT                                                   S01129
     C*                                                                   S01129
     C                     MOVELRECIN     STREC                           S01129
     C*                                                                   S01129
     C* ACCESS HISTORIC TRADE ACTIONS BY TRADE                            S01129
     C*                                                                   S01129
     C                     MOVE BHTR      KBHTR                           S01129
     C*                                                                   S01129
     C                     MOVEA'000'     *IN,04                          S01129
     C           HTTKEY    CHAINHTRACT               87                   S01129
     C           *IN87     IFEQ '1'                                       S01129
     C           *LOCK     IN   LDA                                       S01117
     C                     SETON                     U7U8                 S01129
     C                     MOVE 'HTRAC'   DBFILE           ***************S01129
     C                     MOVELBHTR      KEY7    7        ** DB ERROR 19 S01129
     C                     MOVE BHTV      KEY7             ***************S01129
     C                     MOVELKEY7      DBKEY                           S01129
     C                     Z-ADD19        DBASE                           S01129
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EP60                                      S01129
     C                     ELSE                                           S01129
     C*                                                                   S01129
     C*************        Z-ADDBCPR      HCNTP                    S01129 E20732
     C                     Z-ADDLAVP      HCNTP                    S01129 E20732
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDLAVN      HCNTN                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     EXCPTUPDACT                                    S01129
     C                     END                                            S01129
      *                                                                   E21535
      ***  These KLISTs were not set up before being used. Failure to     E21535
      ***  do this caused corruption of Prices on Trade Action records    E21535
      ***  that were unrelated to the Price Action.                       E21535
      *                                                                   E21535
     C                     MOVE TRKEY     KTRKEY                          E21535
     C*                                                                   S01129
     C           HTBKEY    SETGTHTRACB                                    S01129
     C                     SETOF                     86                   S01129
     C           *IN86     DOWEQ'0'                                       S01129
     C           HTBKY2    READEHTRACB                   86               S01129
     C*                                                                   S01129
     C           *IN86     IFEQ '0'                                       S01129
     C           PNPSN     IFGT 0                                         S01129
     C           HBCPS     ANDEQ'P'                                       S01129
     C           PNPSN     ORLT 0                                         S01129
     C           HBCPS     ANDEQ'S'                                       S01129
      *                                                                   S01129
     C           HBCTR     IFNE BCTR                                      S01129
     C                     SETOF                     131415               S01129
     C                     MOVE HBCAD     KDTE                            E20785
     C                     MOVE HBCTR     KREF                            E20785
     C           HTBKEY    CHAINHTRACBX              88                   S01129
     C*************        Z-ADDBCPR      HCNTP                    S01129 E20732
     C                     Z-ADDLAVP      HCNTP                    S01129 E20732
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDLAVN      HCNTN                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     EXCPTUPDACB                                    S01129
     C                     END                                            S01129
      *                                                                   S01129
     C                     END                                            S01129
     C                     END                                            S01129
     C*                                                                   S01129
     C                     END                                            S01129
     C*                                                                   E15965
     C                     MOVELSTREC     RECIN                           E15965
     C*                                                                   E15965
     C                     END                                            S01129
     C*                                                                   S01129
     C***********          MOVELSTREC     RECIN                    S01129 E15965
     C*                                                                   S01129
     C           ENDP60    TAG                                            S01288
     C           EP60      ENDSR                           ***  EP60  *** S01129
      *
      *****************************************************************
      /EJECT                                                              E14236
      *****************************************************************   E14236
      *                                                               *   E14236
      *  P70    - SUBROUTINE TO PROCESS MATURITY DATE ACTIONS         *   E14236
      *                                                               *   E14236
      *****************************************************************   E14236
      *                                                                   E14236
     C           P70       BEGSR                           ***  P70   *** E14236
     C*                                                                   E14236
     C                     MOVE '1'       *IN20                           E14236
     C*                                                                   E14236
     C                     ENDSR                                          E14236
      *                                                                   E14236
      *****************************************************************                       CSE065
      /EJECT                                                                                  CSE065
      ****************************************************************                        CSE065
      *                                                              *                        CSE065
      *  P80    - Subroutine to Amortise on End of Average Life Date *                        CSE065
      *                                                              *                        CSE065
      ****************************************************************                        CSE065
      *                                                                                       CSE065
     C           P80       BEGSR                                                              CSE065
      *                                                                                       CSE065
     C********** STRM      IFNE 'Y'                                                    CSE065 233707
     C********** STAD      ORNE 'Y'                                                    CSE065 233707
     C           STAD      IFNE 'Y'                                                           233707
     C           STAD      ANDNE'C'                                                           CSE065
     C           PROT      OREQ '2'                                                           CSE065
     C           PROT      OREQ '4'                                                           CSE065
     C           PROT      OREQ '7'                                                           CSE065
     C                     GOTO EP80                                                          CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** Perform Amortisation of Discount/Premium                                             CSE065
      *                                                                                       CSE065
     C                     MOVE 'N'       AMTDP                                               CSE065
     C                     EXSR AMORT                                                         CSE065
      *                                                                                       CSE065
      ** Update Average Price after amortising                                                CSE065
      *                                                                                       CSE065
     C                     EXSR AVPRAM                                                        CSE065
      *                                                                                       CSE065
      ** Post EI/ED key for amortisation                                                      CSE065
      *                                                                                       CSE065
     C           WADP      IFNE 0                                                             CSE065
     C           AMTDP     ANDEQ'Y'                                                           CSE065
     C                     EXSR P07                                                           CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     MOVE *ON       *IN20                                               CSE065
      *                                                                                       CSE065
     C           EP80      ENDSR                                                              CSE065
      *                                                                                       CSE065
      *****************************************************************   E14236
      /EJECT
      *****************************************************************
      *                                                               *
      *  AMORT  - SUBROUTINE TO AMORTIZE DISCOUNT/PREMIUM             *
      *                                                               *
      *****************************************************************
      *
     C           AMORT     BEGSR                           *** AMORT  ***
     C*                                                                   E15442
     C* ONLY AMORTIZE INTEREST-BEARING SECURITIES                         E15442
     C*                                                                   E15442
     C           PROT      IFEQ '2'                                       E15442
     C           PROT      OREQ '4'                                       E15442
     C           PROT      OREQ '7'                                       E15442
     C                     GOTO EAMORT                                    E15442
     C*COP* WN*PYS*C*SE2220C069                                           S01408
     C/COPY WNCPYSRC,SE2220C069
     C/COPY WNCPYSRC,SE2220CP69                                           S01408
     C                     END                                            E15442
     C*COP* WN*PYS*C*SE2220C070                                           S01408
     C/COPY WNCPYSRC,SE2220C070
     C/COPY WNCPYSRC,SE2220CP70                                           S01408
     C*                                                                   CPM004
     C** PORTFOLIO CURRENCY RATE                                          CPM004
     C*                                                                   CPM004
     C           APNC      IFNE *ZERO                                     CPM004
     C           FXAP      DIV  APNC      WFACT                           CPM004
     C                     ELSE                                           CPM004
     C                     Z-ADD*ZERO     WFACT                           CPM004
     C/COPY WNCPYSRC,SE2220C069                                           S01408
     C                     END                                            CPM004
     C/COPY WNCPYSRC,SE2220C070                                           S01408
     C***********                                                  E18651 E20087
     C***IF*BOOK*POSITION*ACTION*PRIOR*TO*LAST*POSITION*CHANGE*DATE 18651 E20087
     C***REVERSE*DISCOUNT*AMORTIZED*FROM*LAST*POSITION*DATE*(SET*TO*RDPA) E20087
     C***AND*RESET*LAST*POSITION*CHANGE*DATE*TO*LAST*POSITION*DATE E18651 E20087
     C***********                                                  E18651 E20087
     C***********          Z-ADD*ZERO     RDPA   130               E18651 E20087
     C***********LPCD      IFGT BCAD                               E18651 E20087
     C***********          ADD  DPAP      BUDU                     E18651 E20087
     C***********NPSN      IFGT *ZERO                              E18651 E20087
     C***********          SUB  DPAP      APNC                     E18651 E20087
     C***********          ELSE                                    E18651 E20087
     C***********          ADD  DPAP      APNC                     E18651 E20087
     C***********          END                                     E18651 E20087
     C***********          Z-ADDDPAP      RDPA                     E18651 E20087
     C***********          Z-ADD*ZERO     DPAP                     E18651 E20087
     C***********          Z-ADDLPSD      LPCD                     E18651 E20087
     C***********          END                                     E18651 E20087
      ***********                                                  E20085 E20552
      *****For*Trade*date*positions,*do*not*amortize*discount*on** E20087 E20552
      *****Trades*which*have*not*reached*value.******************* E20087 E20552
      ***********                                                  E20087 E20552
     C***********          Z-ADDBUDU      WKBUDU 150               E20087 E20552
     C***********KBCTV     IFEQ 'T'                                E20087 E20552
     C***********SPBS      ANDEQ'P'                                E20087 E20552
     C***********FIFO      ANDEQ'Y'                                E20087 E20552
     C***********PNPSN     ANDNE*ZERO                              E20427 E20552
     C***********          EXSR ADJBUD                             E20087 E20552
     C***********          END                                     E20087 E20552
      *                                                                   E20087
      ***  'Last amortized-to date' is now held in field LATD. If LATD    E20087
     C*****is*non-zero,*use*it,*not*LPCD,*in*amortization*calculations087 E22957
     C***  is before current action use it in amortization calculations   E22957
      *                                                                   E20087
     C           LATD      IFNE 0                                         E20087
     C***********LATD      ANDLTBCAD                               E22957 E29207
     C           LATD      ANDLEBCAD                                      E29207
     C                     Z-ADDLATD      LAMDAT  50                      E20087
     C                     Z-ADDDNAT      LAMDNA  20                      102506
     C                     ELSE                                           E20087
     C*********************Z-ADDLPCD      LAMDAT                   E20087 E29207
     C                     Z-ADDLPSD      LAMDAT                          E29207
     C                     Z-ADD*ZERO     LAMDNA                          102506
     C                     END                                            E20087
     C***********                                                  E20993 E22957
     C**If*'Last*amortized-to-date'*is*greater*than*the*action*date,*then E22957
     C**backvaluation*has*occurred*prior*to*the*last*system*accrual*date3 E22957
     C**but*NOT*prior*to*the*last*position*date.*Reverse*this*accural.993 E22957
     C***********                                                  E20993 E22957
     C***********LAMDAT    IFGT BCAD                               E20993 E22957
     C***********DPAP      ANDNE*ZERO                              E20993 E22957
     C***********          ADD  DPAP      BUDU                     E20993 E22957
     C***********NPSN      IFGT *ZERO                              E20993 E22957
     C***********          MOVEL' '       DPSP                     E20993 E22957
     C***********          SUB  DPAP      APNC                     E20993 E22957
     C***********          SUB  DPAP      DPTM                     E20993 E22957
     C***********          ELSE                                    E20993 E22957
     C***********          MOVEL'Y'       DPSP                     E20993 E22957
     C***********          ADD  DPAP      APNC                     E20993 E22957
     C***********          ADD  DPAP      DPTM                     E20993 E22957
     C***********          END                                     E20993 E22957
     C***********          MOVEL'Y'       AMTCAL  1                E20993 E22957
     C***********          Z-ADDDPAP      DPTR                     E20993 E22957
     C***********          EXSR AMORTR                             E20993 E22957
     C***********          Z-ADD*ZERO     DPAP                     E20993 E22957
     C***********          Z-ADDLPSD      LAMDAT                   E20993 E22957
     C***********          END                                     E20993 E22957
     C*
     C* DISCOUNT/PREMIUM AMORTISED ONLY IF NOT EQUAL ZERO
     C* AND BOOK POSITION ACTION PROCESSED IS FOR A NEW POSITION DATE     E15442
     C*
     C***********BUDU      IFNE 0                                         E20087
     C***********WKBUDU    IFNE 0                                  E20087 E20552
     C**********           MOVE *BLANK    WOTBS   1                                    229289 230033
     C           CSE032    IFNE 'Y'                                       CSE032
     C           BUDU      IFNE 0                                         E20552
     C***********LPCD      ANDLTBCAD                               E15442 E18651
     C           LAMDAT    ANDLTBCAD                                      E20087
     C********** STAD      OREQ 'C'                                055893 111157
     C********** SYBS      ANDEQ'AU'                               055893 111157
     C********** NPSN      ANDNE0                                  055893 111157
     C********** LAMDAT    ANDLTBCAD                               055893 111157
     C/COPY WNCPYSRC,SE2220C111
     C*
     C* AMORTIZE PREM/DISC ON YIELD CURVE BASIS FOR AUSTRALIA.            S01233
     C* -IF YIELD CURVE BASIS                                             S01233
     C* -AND NOT FIFO                                                     S01233
     C* -AND NOT SCHULDSHEIN                                              S01233
     C* -AND YIELD-BASED SECURITY                                         S01233
     C*                                                                   S01233
     C           STAD      IFEQ 'C'                                       S01233
     C           FIFO      ANDNE'Y'                                       S01233
     C********** PROT      ANDNE'6'                                                    S01233 226138
     C/COPY WNCPYSRC,SE2220C112
     C           STBS      ANDEQ'Y'                                       S01233
     C                     MOVE ' '       WAMORT                                              CSE065
     C                     EXSR AAMORT                                    S01233
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     EXSR AAMORN                                                        CAS006
     C                     ENDIF                                                              CAS006
     C/COPY WNCPYSRC,SE2220C113
     C*                                                                   S01233
     C                     ELSE                                           S01233
     C*                                                                   S01233
     C*   - CALCULATE DAYS TO MATURITY
     C*
     C***********          Z-ADDBPPD      ZSDATE                          E15442
     C***********          Z-ADDLPCD      ZSDATE                   E15442 E20087
     C                     Z-ADDLAMDAT    ZSDATE                          E20087
     C                     Z-ADDMATY      ZEDATE
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CCP9                                           S01408
     C*                                                                   S01408
      *                                                                                       CSE075
      ** If Enhanced Treasury is switched on:                                                 CSE075
      *                                                                                       CSE075
     C           CSE075    IFEQ 'Y'                                                           CSE075
      *                                                                                       CSE075
      ** For MBS, amortize to average life date, if available.                                CSE075
      *                                                                                       CSE075
     C           PROT      IFEQ '8'                                                           CSE075
     C           PPDI      ANDNE'Y'                                                           CSE075
     C           ALDT      ANDNE0                                                             CSE075
     C                     Z-ADDALDT      ZEDATE                                              CSE075
     C                     ENDIF                                                              CSE075
     C                     ENDIF                                                              CSE075
      *                                                                                       CSE075
     C                     Z-ADDLAMDNA    ZIDNAT                          102506
     C                     MOVE *BLANK    ZACLT                           102506
     C                     EXSR ZDAYS
     C                     Z-ADDZDDAYS    WDAYSM  50
     C/COPY WNCPYSRC,SE2220C232
     C*
     C*   - CALCULATE DAYS TO AMORTISE
     C*
     C***********          Z-ADDBPPD      ZSDATE                          E15442
     C***********          Z-ADDLPCD      ZSDATE                   E15442 E20087
     C                     Z-ADDLAMDAT    ZSDATE                          E20087
     C                     Z-ADDBCAD      ZEDATE
     C                     Z-ADDLAMDNA    ZIDNAT                          102506
     C                     MOVE 'D'       ZACLT                           102506
     C                     EXSR ZDAYS
     C                     Z-ADDZDDAYS    WDAYSA  50
     C*                                                                   102506
     C** Reset day number accrued to and accrual type                     102506
     C*                                                                   102506
     C                     Z-ADD*ZERO     ZIDNAT                          102506
     C                     MOVE *BLANK    ZACLT                           102506
     C*                                                                   102506
     C** Update day number accrued to                                     102506
     C*                                                                   102506
     C                     Z-ADDZODNAT    DNAT                            102506
     C*
     C*   - CALCULATE EARNED DISC/PREM SINCE LATEST POSN DATE
     C*
     C           WDAYSM    IFEQ 0
     C           WDAYSM    ORLT WDAYSA                                    E20087
      *                                                                   E20087
      ***  If issue is maturing, amortize remaining discount/premium.     E20087
     C***********          Z-ADD0         WEDP                            E20087
     C***********          Z-ADDWKBUDU    WEDP                     E20087 E20552
     C                     Z-ADDBUDU      WEDP                            E20552
     C                     ELSE
     C                     Z-ADDWDAYSM    ZPNPSN                          E22957
     C                     Z-ADDWDAYSA    ZNPSN                           E22957
     C                     Z-ADDBUDU      ZAPIN                           E22957
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    WEDP   130                      E22957
     C                     END                                            E22957
     C***********WDAYSA    DIV  WDAYSM    WDAYS   94H                     E15442
     C***********BUDU      MULT WDAYS     WEDP   130H                     E15442
     C***********BUDU      DIV  WDAYSM    WEDPXX 152H              E15442 E20087
     C***********WKBUDU    DIV  WDAYSM    WEDPXX 152H              E20087 E20552
     C***********BUDU      DIV  WDAYSM    WEDPXX 152H              E20552 E22957
     C***********WEDPXX    MULT WDAYSA    WEDP   130H              E15442 E22957
     C***********          END                                            E22957
     C*
     C*   - CALCULATE AMORTISED DISC/PREM TO POST
     C*
     C***********WEDP      SUB  DPAP      WADP   130                      E15442
     C                     Z-ADDWEDP      WADP   130                      E15442
     C***********          SUB  RDPA      WADP                     E18651 E20087
      *                                                                                       CAS006
      **  Calculate earned DISC/PREM since latest Position date for N-T-P.                    CAS006
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           WDAYSM    IFEQ 0                                                             CAS006
     C           WDAYSM    ORLT WDAYSA                                                        CAS006
      *                                                                                       CAS006
      **  If issue is maturing, amortize remaining discount/premium.                          CAS006
      *                                                                                       CAS006
     C                     Z-ADDBUDN      WEDN                                                CAS006
     C                     ELSE                                                               CAS006
     C                     Z-ADDWDAYSM    ZPNPSN                                              CAS006
     C                     Z-ADDWDAYSA    ZNPSN                                               CAS006
     C                     Z-ADDBUDN      ZAPIN                                               CAS006
     C                     EXSR ZAPORT                                                        CAS006
     C                     Z-ADDZAPOUT    WEDN   130                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADDWEDN      WADN   130                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END                                            S01233
     C*
     C*   - OUTPUT AMORTISED DISC/PREM KEY
      *                                                                   E20087
      *****This*subroutine*is*now*called*for*both*'T'*and*'V'*records,087 E20552
      *****but*account*keys*are*needed*only*for*value*date*positions.0087 E20552
      ***********                                                  E20087 E20552
     C***********BCTV      IFEQ 'V'                                E20087 E20552
     C*
     C                     MOVE 'A'       EVTP
     C                     MOVE ' '       TRTP
     C                     MOVE ' '       PORT
     C                     MOVE '  '      TRST
     C           NPAC      IFEQ 'N'
     C***********PNPSN     ORGE 0                                         E15442
     C           NPSN      ORGE 0                                         E15442
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C*
     C***********BUDU      IFGT 0                                         E20087
     C***********WKBUDU    IFGT 0                                  E20087 E20552
     C***********BUDU      IFGT 0                                  E20552 E22957
     C           NPSN      IFGT 0                                         E22957
     C           BUDU      ANDGT0                                         E22957
     C           NPSN      ORLT 0                                         E22957
     C           BUDU      ANDLT0                                         E22957
     C                     MOVE 'DA'      AMCD
     C                     ELSE
     C                     MOVE 'PA'      AMCD
     C                     END
     C*
     C                     MOVE *ZEROS    TRFR
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C***********WADP      IFLT 0                                         E18651
     C***********BUDU      IFLT 0                                  E18651 E20087
     C***********WADP      IFLT 0                                  E20087 E22957
     C***********WADP      ORGT 0                                  E21130 E22957
     C***********BUDU      ANDLT0                                  E21130 E22957
     C***********WADP      MULT -1        EVAM                            E22957
     C***********          ELSE                                           E22957
     C                     Z-ADDWADP      EVAM
     C***********          END                                            E22957
     C************************************************************ E15442 E22957
     C**IF*-*VE*POSITION*AND*NO*'N'*IN*POSITION*15*OF*A/C*KEY***** E15442 E22957
     C**THE*DISCOUNT/PREMIUM*AMORTISED*MUST*HAVE*ITS*SIGN*REVERSED E15442 E22957
     C**(AS*REVERSE*ENTRIES*ARE*REQUIRED*ON*PURCHASES*AND*SALES)** E15442 E22957
     C************************************************************        E22957
     C***********PNPSN     IFLT 0                                         E15442
     C/COPY WNCPYSRC,SE2220C205
     C*                                                                   E22957
     C** - Reverse sign on Premiums, because different key                E22957
     C*                                                                   E22957
     C           AMCD      IFEQ 'PA'                                      E22957
     C                     Z-SUBEVAM      EVAM                            E22957
     C                     END                                            E22957
     C/COPY WNCPYSRC,SE2220C132
      *                                                                                       CSE105
      ** If CSE105 is installed and this is a Trade Date Position,                            CSE105
      ** change to 'DT' when "discount" or 'PT' when "premium".                               CSE105
      *                                                                                       CSE105
     C           CSE105    IFEQ 'Y'                                                           CSE105
      *                                                                                       CSE105
     C           IPL7K     IFEQ ' '                                                           CSE105
     C           BCTV      ANDEQ'T'                                                           CSE105
      *                                                                                       CSE105
     C           IPL7K     OREQ 'K'                                                           CSE105
     C           KBCTV     ANDEQ'T'                                                           CSE105
      *                                                                                       CSE105
     C                     SELEC                                                              CSE105
     C           AMCD      WHEQ 'DA'                                                          CSE105
     C                     MOVE 'DT'      AMCD                                                CSE105
     C           AMCD      WHEQ 'PA'                                                          CSE105
     C                     MOVE 'PT'      AMCD                                                CSE105
     C                     ENDSL                                                              CSE105
      *                                                                                       CSE105
     C                     ENDIF                                                              CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
     C*                                                                   E22957
     C** - Reverse sign, if Negative Position on Key                      E22957
     C*                                                                   E22957
     C           NPSN      IFLT 0                                         E15442
     C***********NPAC      ANDEQ'N'                                       E22957
     C           NPAC      ANDEQ'Y'                                       E22957
     C           EVAM      MULT -1        EVAM
     C                     END
      *                                                                   E20086
      ***  Adjust posting amount by the Mortgage Current Factor.          E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C152
     C                     MULT AAPR      EVAM                            E20086
      *                                                                   E20087
      ***  Accumulate Amortized Discount/Premium for the Profitability    E20087
      ***  Report. NOTE: field DPTM has been added to PF/BKMTHD. It is    E20087
      ***  used only on 'V' records; the Trade Date Report will use       E20087
      ***  Value Date figures.                                            E20087
      *                                                                   E20087
     C           WADP      MULT AAPR      WADPCF 150                      E20087
     C                     ELSE                                           E20087
     C                     Z-ADDWADP      WADPCF                          E20087
     C                     END                                            E20086
      *                                                                   E19485
      ***  If Reversal Mode, reverse out the Amortized Discount/Premium   E19485
      ***  calculated from that on the BKMTHD file.                       E19485
      *                                                                   E19485
      ***  WADPCF is the same sign as BUDU - Discount Long  +ve           E22957
      ***                                  - Premium  Long  -ve           E22957
      ***                                  - Discount Short -ve           E22957
      ***                                  - Premium  Short +ve           E22957
      ***  A discount long gives income as does a premium Short           E22957
      *                                                                   E22957
     C***********NPSN      IFGT 0                                  E19485 E22957
      *                                                                   E19485
     C           *INU1     IFEQ '0'                                       E19485
     C                     ADD  WADPCF    DPTM                            E20087
     C                     ELSE                                           E19485
     C                     SUB  WADPCF    DPTM                            E19485
     C                     END                                            E19485
      *                                                                   E19485
     C***********          ELSE                                    E19485 E22957
     C************INU1     IFEQ '0'                                E19485 E22957
     C***********          SUB  WADPCF    DPTM                     E20087 E22957
     C***********          ELSE                                    E19485 E22957
     C***********          ADD  WADPCF    DPTM                     E19485 E22957
     C***********          END                                     E19485 E22957
      ***********                                                  E19485 E22957
     C***********          END                                     E19485 E22957
      *                                                                   E20087
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C016
     C                     END
     C/COPY WNCPYSRC,SE2220C217
      *                                                                   E20087
      *****End*of*calculations*performed*only*for*'V'*records.*****E20087 E20552
     C***********          END                                     E20087 E20552
     C***********                                                  E18651 E20087
     C***********          ADD  RDPA      WADP                     E18651 E20087
     C*
     C*  - CALCULATE NEW UNAMORTISED DISC/PREM ON POSITION
     C*
     C***********BUDU      SUB  WEDP      BUDU                            E15442
     C           BUDU      SUB  WADP      BUDU                            E15442
     C*
     C*  - SET DISC/PREM AMORTISED SINCE LATEST POSN DATE
     C*
     C***********          Z-ADDWEDP      DPAP                            E15442
     C                     ADD  WADP      DPAP                            E15442
     C                     ADD  WADP      DPFP                            S01397
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           BUDN      SUB  WADN      BUDN                                                CAS006
     C                     ADD  WADN      DPAN                                                CAS006
     C                     ADD  WADN      APNN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C*                                                                   E22957
     C*  - Update APNC, as NOM - APNC = BUDU                              E22957
     C*                                                                   E22957
     C                     ADD  WADP      APNC                            E22957
     C*                                                                   CPM004
     C*  - Update portfolio currency equivalents                          CPM004
     C*                                                                   CPM004
     C           APNC      MULT WFACT     FXAP                            CPM004
     C                     Z-ADDFXAP      LFXP                            CPM004
     C*                                                                   E15442
     C*   INDICATE THAT AMORTIZATION HAS BEEN DONE                        E15442
     C*                                                                   E15442
     C                     MOVEL'Y'       AMTDP                           E15442
      *                                                                   E20087
      *****Update*last*amortized/accrued-to*date.***************** E20087 E32464
     C***********BCAD      IFGT LATD                               E22957 E29207
     C***********          Z-ADDBCAD      LATD                     E20087 E29207
     C***********          END                                     E22957 E29207
     C***********          Z-ADDBCAD      LATD                     029207 E32464
     C*
     C                     END
      *                                                                   E32464
      ***  Update last amortized/accrued-to date.                         E32464
      *                                                                   E32464
     C           BUDU      IFNE *ZERO                                     E32464
     C                     Z-ADDBCAD      LATD                            E32464
     C                     ELSE                                           E32464
     C                     Z-ADD*ZERO     LATD                            E32464
     C                     Z-ADD*ZERO     DNAT                            102506
     C                     END                                            E32464
     C                     ELSE                                           CSE032
     C           BUDU      IFNE 0                                         CSE032
     C           LAMDAT    ANDLTBCAD                                      CSE032
     C           STAD      OREQ 'C'                                       CSE032
     C           SYBS      ANDNE*BLANK                                    CSE032
     C           NPSN      ANDNE0                                         CSE032
     C           LAMDAT    ANDLTBCAD                                      CSE032
     C*                                                                   CSE032
     C* AMORTIZE PREM/DISC ON YIELD CURVE BASIS FOR AUSTRALIA.            CSE032
     C* -IF YIELD CURVE BASIS                                             CSE032
     C* -AND NOT FIFO                                                     CSE032
     C* -AND NOT SCHULDSHEIN                                              CSE032
     C* -AND YIELD-BASED SECURITY                                         CSE032
     C*                                                                   CSE032
     C           STAD      IFEQ 'C'                                       CSE032
     C           FIFO      ANDNE'Y'                                       CSE032
     C********** PROT      ANDNE'6'                                                    CSE032 226138
     C           SYBS      ANDNE*BLANK                                    CSE032
     C*                                                                   CSE032
     C** Override trade basis to 'Y' as ZPRCI and ZPRCO standard          CSE032
     C** subroutines calculate yield for 'Y' trade basis only.            CSE032
     C*                                                                   CSE032
     C**********           MOVE STBS      WOTBS                                        229289 230033
     C                     MOVEL'Y'       STBS                            CSE032
     C                     MOVE ' '       WAMORT  1                                           CSE065
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C                     MOVE 'T'       WAMORT                                              CSE065
     C                     EXSR AAMORC                                                        CSE065
     C                     ELSE                                                               CSE065
     C                     EXSR AAMORT                                    CSE032
     C                     ENDIF                                                              CSE065
      *                                                                                       CAS006
     C                     MOVE ' '       WAMORT                                              CSE065
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C                     MOVE 'N'       WAMORT                                              CSE065
     C                     EXSR AAMORC                                                        CSE065
     C                     ELSE                                                               CSE065
     C                     EXSR AAMORN                                                        CAS006
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CAS006
     C/COPY WNCPYSRC,SE2220C113                                                               CSE065
     C*                                                                   CSE032
     C                     ELSE                                           CSE032
     C*                                                                   CSE032
     C*   - CALCULATE DAYS TO MATURITY                                    CSE032
     C*                                                                   CSE032
     C                     Z-ADDLAMDAT    ZSDATE                          CSE032
     C                     Z-ADDMATY      ZEDATE                          CSE032
      *                                                                                       CSE065
      ** If CSE065 is ON and Available for Sale Book,                                         CSE065
      ** amortisation is calculated base per Average Life                                     CSE065
      ** Date change.                                                                         CSE065
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           STAD      ANDEQ'Y'                                                           CSE065
     C                     EXSR AMORSL                                                        CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADDLAMDNA    ZIDNAT                          CSE032
     C                     MOVE *BLANK    ZACLT                           CSE032
     C                     EXSR ZDAYS                                     CSE032
     C                     Z-ADDZDDAYS    WDAYSM  50                      CSE032
     C*                                                                   CSE032
     C*   - CALCULATE DAYS TO AMORTISE                                    CSE032
     C*                                                                   CSE032
     C                     Z-ADDLAMDAT    ZSDATE                          CSE032
     C                     Z-ADDBCAD      ZEDATE                          CSE032
     C                     Z-ADDLAMDNA    ZIDNAT                          CSE032
     C                     MOVE 'D'       ZACLT                           CSE032
     C                     EXSR ZDAYS                                     CSE032
     C                     Z-ADDZDDAYS    WDAYSA  50                      CSE032
     C*                                                                   CSE032
     C** Reset day number accrued to and accrual type                     CSE032
     C*                                                                   CSE032
     C                     Z-ADD*ZERO     ZIDNAT                          CSE032
     C                     MOVE *BLANK    ZACLT                           CSE032
     C*                                                                   CSE032
     C** Update day number accrued to                                     CSE032
     C*                                                                   CSE032
     C                     Z-ADDZODNAT    DNAT                            CSE032
     C*                                                                   CSE032
     C*   - CALCULATE EARNED DISC/PREM SINCE LATEST POSN DATE             CSE032
     C*                                                                   CSE032
     C           WDAYSM    IFEQ 0                                         CSE032
     C           WDAYSM    ORLT WDAYSA                                    CSE032
      *                                                                   CSE032
      ***  If issue is maturing, amortize remaining discount/premium.     CSE032
     C                     Z-ADDBUDU      WEDP                            CSE032
     C                     ELSE                                           CSE032
     C                     Z-ADDWDAYSM    ZPNPSN                          CSE032
     C                     Z-ADDWDAYSA    ZNPSN                           CSE032
     C                     Z-ADDBUDU      ZAPIN                           CSE032
     C                     EXSR ZAPORT                                    CSE032
     C                     Z-ADDZAPOUT    WEDP   130                      CSE032
     C                     END                                            CSE032
     C*                                                                   CSE032
     C*   - CALCULATE AMORTISED DISC/PREM TO POST                         CSE032
     C*                                                                   CSE032
     C                     Z-ADDWEDP      WADP   130                      CSE032
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           WDAYSM    IFEQ 0                                                             CAS006
     C           WDAYSM    ORLT WDAYSA                                                        CAS006
      *                                                                                       CAS006
     C                     Z-ADDBUDN      WEDN                                                CAS006
     C                     ELSE                                                               CAS006
     C                     Z-ADDWDAYSM    ZPNPSN                                              CAS006
     C                     Z-ADDWDAYSA    ZNPSN                                               CAS006
     C                     Z-ADDBUDN      ZAPIN                                               CAS006
     C                     EXSR ZAPORT                                                        CAS006
     C                     Z-ADDZAPOUT    WEDN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADDWEDN      WADN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     ENDIF                                                              CSE065
     C                     END                                            CSE032
     C*                                                                   CSE032
     C*   - OUTPUT AMORTISED DISC/PREM KEY                                CSE032
     C*                                                                   CSE032
     C                     MOVE 'A'       EVTP                            CSE032
     C                     MOVE ' '       TRTP                            CSE032
     C                     MOVE ' '       PORT                            CSE032
     C                     MOVE '  '      TRST                            CSE032
     C           NPAC      IFEQ 'N'                                       CSE032
     C           NPSN      ORGE 0                                         CSE032
     C                     MOVE ' '       NEGI                            CSE032
     C                     ELSE                                           CSE032
     C                     MOVE 'N'       NEGI                            CSE032
     C                     END                                            CSE032
     C*                                                                   CSE032
     C           NPSN      IFGT 0                                         CSE032
     C           BUDU      ANDGT0                                         CSE032
     C           NPSN      ORLT 0                                         CSE032
     C           BUDU      ANDLT0                                         CSE032
     C                     MOVE 'DA'      AMCD                            CSE032
     C                     ELSE                                           CSE032
     C                     MOVE 'PA'      AMCD                            CSE032
     C                     END                                            CSE032
     C*                                                                   CSE032
     C                     MOVE *ZEROS    TRFR                            CSE032
     C**********           Z-ADDISSR      CSTN                                         CSE032 CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C                     Z-ADDWADP      EVAM                            CSE032
     C*                                                                   CSE032
     C** - Reverse sign on Premiums, because different key                CSE032
     C*                                                                   CSE032
     C           AMCD      IFEQ 'PA'                                      CSE032
     C                     Z-SUBEVAM      EVAM                            CSE032
     C                     END                                            CSE032
     C*                                                                   CSE032
     C** - Reverse sign, if Negative Position on Key                      CSE032
     C*                                                                   CSE032
     C           NPSN      IFLT 0                                         CSE032
     C           NPAC      ANDEQ'Y'                                       CSE032
     C           EVAM      MULT -1        EVAM                            CSE032
     C                     END                                            CSE032
      *                                                                   CSE032
      ***  Adjust posting amount by the Mortgage Current Factor.          CSE032
      *                                                                   CSE032
     C           PROT      IFEQ '8'                                       CSE032
     C                     MULT AAPR      EVAM                            CSE032
      *                                                                   CSE032
      ***  Accumulate Amortized Discount/Premium for the Profitability    CSE032
      ***  Report. NOTE: field DPTM has been added to PF/BKMTHD. It is    CSE032
      ***  used only on 'V' records; the Trade Date Report will use       CSE032
      ***  Value Date figures.                                            CSE032
      *                                                                   CSE032
     C           WADP      MULT AAPR      WADPCF 150                      CSE032
     C                     ELSE                                           CSE032
     C                     Z-ADDWADP      WADPCF                          CSE032
     C                     END                                            CSE032
      *                                                                   CSE032
      ***  If Reversal Mode, reverse out the Amortized Discount/Premium   CSE032
      ***  calculated from that on the BKMTHD file.                       CSE032
      *                                                                   CSE032
      ***  WADPCF is the same sign as BUDU - Discount Long  +ve           CSE032
      ***                                  - Premium  Long  -ve           CSE032
      ***                                  - Discount Short -ve           CSE032
      ***                                  - Premium  Short +ve           CSE032
      ***  A discount long gives income as does a premium Short           CSE032
      *                                                                   CSE032
     C           *INU1     IFEQ '0'                                       CSE032
     C                     ADD  WADPCF    DPTM                            CSE032
     C                     ELSE                                           CSE032
     C                     SUB  WADPCF    DPTM                            CSE032
     C                     END                                            CSE032
      *                                                                   CSE032
     C           EVAM      IFNE 0                                         CSE032
     C                     EXSR W01                                       CSE032
     C                     END                                            CSE032
     C*                                                                   CSE032
     C*  - CALCULATE NEW UNAMORTISED DISC/PREM ON POSITION                CSE032
     C*                                                                   CSE032
     C           BUDU      SUB  WADP      BUDU                            CSE032
     C*                                                                   CSE032
     C*  - SET DISC/PREM AMORTISED SINCE LATEST POSN DATE                 CSE032
     C*                                                                   CSE032
     C                     ADD  WADP      DPAP                            CSE032
     C                     ADD  WADP      DPFP                            CSE032
     C*                                                                   CSE032
     C*  - Update APNC, as NOM - APNC = BUDU                              CSE032
     C*                                                                   CSE032
     C                     ADD  WADP      APNC                            CSE032
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           BUDN      SUB  WADN      BUDN                                                CAS006
     C                     ADD  WADN      DPAN                                                CAS006
     C                     ADD  WADN      APNN                                                CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   CSE032
     C*  - Update portfolio currency equivalents                          CSE032
     C*                                                                   CSE032
     C           APNC      MULT WFACT     FXAP                            CSE032
     C                     Z-ADDFXAP      LFXP                            CSE032
     C*                                                                   CSE032
     C*   INDICATE THAT AMORTIZATION HAS BEEN DONE                        CSE032
     C*                                                                   CSE032
     C                     MOVEL'Y'       AMTDP                           CSE032
     C                     END                                            CSE032
      *                                                                   CSE032
      ***  Update last amortized/accrued-to date.                         CSE032
      *                                                                   CSE032
     C           BUDU      IFNE *ZERO                                     CSE032
     C                     Z-ADDBCAD      LATD                            CSE032
     C                     ELSE                                           CSE032
     C                     Z-ADD*ZERO     LATD                            CSE032
     C                     Z-ADD*ZERO     DNAT                            CSE032
     C                     END                                            CSE032
     C                     END                                            CSE032
     C*
     C***********          ENDSR                                          E15442
     C           EAMORT    ENDSR                                          E15442
      *
     C/COPY WNCPYSRC,SE2220C114
      *****************************************************************
      /EJECT                                                              E20087
      *****************************************************************87 E20552
      ***********                                                     *87 E20552
      ***ADJBUD*-*Subroutine*to*adjust*Unrealized*Discount/Premium*and*87 E20552
      ************Unrealized*P/L*on*'T'*Positions*with*Forward*Trades.*87 E20552
      ***********                                                     *87 E20552
      *****************************************************************87 E20552
      ***********                                                  E20087 E20552
     C***********ADJBUD    BEGSR                           *** ADJBUD 087 E20552
      ***********                                                  E20087 E20552
      *****Set*up*the*'Current*FIFO*Trade*Found'*Indicator*and*the*FIFO 7 E20552
      *****Trade*Reference.*************************************** E20087 E20552
      ***********                                                  E20087 E20552
     C***********BHTR      IFNE 0                                  E20087 E20552
     C***********          MOVE '0'       *IN82                    E20087 E20552
     C***********          MOVE BHTR      BHTRA   6                E20087 E20552
     C***********          ELSE                                    E20087 E20552
     C***********          MOVE '1'       *IN82                    E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
      *****Set*up*index*for*Currency*Decimal*Places.************** E20087 E20552
      ***********                                                  E20087 E20552
     C***********CDP       ADD  5         DC                       E20087 E20552
     C***********          SUB  NMDP      DC                       E20087 E20552
      ***********                                                  E20087 E20552
      *****Read*all*trades*for*this*position.*Only*accumulate*forwards.87 E20552
     C***********TRDKEY    CHAINTRDMTHF              83            E20087 E20552
      ***********                                                  E20087 E20552
      *****Loop*for*processing*trades.**************************** E20087 E20552
     C************IN83     DOWEQ'0'                                E20087 E20552
      ***********                                                  E20087 E20552
      *****Only*process*live,*complete*trades.******************** E20087 E20552
     C***********RECI      IFNE '*'                                E20087 E20552
     C***********TINC      ANDEQ'C'                                E20087 E20552
      ***********                                                  E20087 E20552
      *****Check*for*current*FIFO*trade.***************************E20087 E20552
     C************IN82     IFEQ '0'                                E20087 E20552
     C***********TDRF      ANDEQBHTRA                              E20087 E20552
     C***********          MOVE '1'       *IN82                    E20087 E20552
      ***********                                                  E20087 E20552
      *****For*current*FIFO*trade,*use*unliquidated*nominal*only.* E20087 E20552
     C***********          Z-ADDBHRN      NOML                     E20087 E20552
     C***********NOML      MULT POWER8,DC NOML15 150               E20087 E20552
     C***********PRIC      MULT NOML15    TCSR      H              E20087 E20552
     C***********          DIV  100       TCSR      H              E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
      *****Process*unliquidated*forward*trades.******************* E20087 E20552
      *****If*Trade*is*Purchase*and*current*position*is*Long,*or*Trade 87 E20552
      *****is*Sale*and*current*position*is*Short,*adjust*WKBUDU*so*that 7 E20552
      *****the*system*will*not*begin*to*Amortize*the*Discount/Premium 087 E20552
      *****on*the*trade*until*it*reaches*Value.******************* E20087 E20552
      *****NOTE:*Must*make*sure*trade*is*already*in*position!***** E20087 E20552
      ***********                                                  E20087 E20552
     C***********TDVD      IFGT BCAD                               E20087 E20552
     C************IN82     ANDEQ'1'                                E20087 E20552
     C***********NPSN      IFGT 0                                  E20087 E20552
     C***********TDTP      ANDEQ'TP'                               E20087 E20552
     C***********NPSN      ORLT 0                                  E20087 E20552
     C***********TDTP      ANDEQ'TS'                               E20087 E20552
     C***********TDDT      IFLT BCAD                               E20087 E20552
     C***********TDDT      OREQ BCAD                               E20087 E20552
     C***********TDRF      ANDLTBCTR                               E20087 E20552
      ***********                                                  E20087 E20552
      *****Calculate*Discount/Premium*on*Trade.******************* E20087 E20552
     C***********NOML      MULT POWER8,DC NOML15                   E20087 E20552
     C***********NOML15    SUB  TCSR      DSCPRM 150               E20087 E20552
     C***********          SUB  DSCPRM    WKBUDU                   E20087 E20552
      ***********                                                  E20087 E20552
     C***********          END                                     E20087 E20552
     C***********          END                                     E20087 E20552
     C***********          END                                     E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
     C***********TRDKEY    READETRDMTHF                8383        E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
     C***********          ENDSR                                   E20087 E20552
      ***********                                                  E20087 E20552
      *****************************************************************   E20087
      /EJECT                                                              CSE006
      *****************************************************************   CSE006
      *                                                               *   CSE006
      *  AMTPL  - SUBROUTINE TO CALCULATE AMORTISED PROFIT/LOSS       *   CSE006
      *           FOR BUY-SELL TRADES                                 *   CSE006
      *                                                               *   CSE006
      *****************************************************************   CSE006
      *                                                                   CSE006
     C           AMTPL     BEGSR                           *** AMTPL  *** CSE006
      *                                                                   CSE006
      *** If in reversal mode and amortised P/L is not zero               CSE006
      *                                                                   CSE006
     C           *INU1     IFEQ '1'                                       CSE006
     C           BSAPL     ANDNE0                                         CSE006
      *                                                                   CSE006
      *** Initialise event amount                                         CSE006
      *                                                                   CSE006
     C                     Z-ADDBSAPL     EVAM                            CSE006
      *                                                                   CSE006
     C           EVAM      IFGT 0                                         CSE006
     C                     MOVE 'RL'      AMCD                            CSE006
     C           EVAM      MULT -1        EVAM                            CSE006
      *                                                                   CSE006
     C                     ELSE                                           CSE006
      *                                                                   CSE006
     C                     MOVE 'RP'      AMCD                            CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     MOVE 'A'       EVTP                            CSE006
     C                     MOVE ' '       PSBS                            CSE006
     C                     MOVE ' '       PSBS                            CSE006
     C                     MOVE ' '       NEGI                            CSE006
      *                                                                   CSE006
     C                     EXSR W01                                       CSE006
      *                                                                   CSE006
     C                     Z-ADD*ZEROS    BSAPL                           CSE006
     C                     Z-ADD*ZEROS    BSLATD                          CSE006
     C                     Z-ADD*ZEROS    BSOPL                           CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
      *** If not in reversal mode calc profit/loss                        CSE006
      *                                                                   CSE006
     C           *INU1     IFEQ '0'                                       CSE006
     C           BSLATD    IFEQ 0                                         CSE006
     C                     EXSR CALPL                                     CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C           BSVD2     IFEQ BCAD                                      CSE006
      *                                                                   CSE006
     C                     Z-ADDBSOPL     EVAM                            CSE006
      *                                                                   CSE006
     C           EVAM      IFGT 0                                         CSE006
     C                     MOVE 'RL'      AMCD                            CSE006
     C           EVAM      MULT -1        EVAM                            CSE006
     C                     ELSE                                           CSE006
     C                     MOVE 'RP'      AMCD                            CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     MOVE 'A'       EVTP                            CSE006
     C                     MOVE ' '       PSBS                            CSE006
     C                     MOVE ' '       NEGI                            CSE006
     C                     EXSR W01                                       CSE006
     C           BSOPL     ADD  BSAPL     BSAPL                           CSE006
     C                     Z-ADDBCAD      BSLATD                          CSE006
     C                     Z-ADD*ZEROS    BSOPL                           CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     ENDSR                                       ** CSE006
      *                                                                   CSE006
      *****************************************************************   CSE006
      /EJECT                                                              CSE006
      *****************************************************************   CSE006
      *                                                               *   CSE006
      *  CALPL  - SUBROUTINE TO CALCULATE PROFIT/LOSS FOR BUY-SELL    *   CSE006
      *           TRADES FOR AMORTISATION                             *   CSE006
      *                                                               *   CSE006
      *****************************************************************   CSE006
      *                                                                   CSE006
     C           CALPL     BEGSR                           *** CALPL  *** CSE006
      *                                                                   CSE006
      *** If the action is for the second trade use the fields            CSE006
      *** from second trade                                               CSE006
      *                                                                   CSE006
     C           @SECTR    IFEQ 'Y'                                       CSE006
      *                                                                   CSE006
     C                     Z-ADDTDDT      BSTD2                           CSE006
     C                     Z-ADDTDVD      BSVD2                           CSE006
      *                                                                   CSE006
     C                     ELSE                                           CSE006
      *                                                                   CSE006
     C                     Z-ADDTDDT      BSTD1                           CSE006
     C                     Z-ADDTDVD      BSVD1                           CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     MOVE BCBA      BSBCH                           CSE006
     C                     MOVE BCBO      BSBOK                           CSE006
      *                                                                   CSE006
      *** Get Trades details using link reference                         CSE006
      *                                                                   CSE006
     C           LKRF      CHAINTRADS                80                   CSE006
      *                                                                   CSE006
     C           *IN80     IFEQ '1'                                       CSE006
     C           RECI      ORNE 'D'                                       CSE006
     C           *LOCK     IN   LDA                                       CSE006
     C                     Z-ADD30        DBASE            ***************CSE006
     C                     MOVEL'TRADS  ' DBFILE           * DB ERROR 30 *CSE006
     C                     MOVELBCTR      DBKEY            ***************CSE006
     C                     SETON                     U7U8                 CSE006
     C                     OUT  LDA                                       CSE006
     C                     DUMP                                           CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
      *** If action uses the second trade to get link ref then            CSE006
      *** move details into first trade.                                  CSE006
      *                                                                   CSE006
     C           @SECTR    IFEQ 'Y'                                       CSE006
      *                                                                   CSE006
     C                     Z-ADDTDDT      BSTD1                           CSE006
     C                     Z-ADDBSVD1     BSTD1                           CSE006
      *                                                                   CSE006
     C                     ELSE                                           CSE006
      *                                                                   CSE006
     C                     Z-ADDTDDT      BSTD2                           CSE006
     C                     Z-ADDTDVD      BSTD2                           CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C           BCPS      IFEQ 'S'                                       CSE006
     C           BCCN      SUB  TCSR      @BSPL  130                      CSE006
     C                     ELSE                                           CSE006
     C           TCSR      SUB  BCCN      @BSPL                           CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     Z-ADD@BSPL     BSOPL                           CSE006
     C                     Z-ADDBSVD1     BSLATD                          CSE006
      *                                                                   CSE006
     C                     MOVE 'D'       BSRECI                          CSE006
      *                                                                   CSE006
     C                     ENDSR                                          CSE006
      *                                                                   CSE006
      *****************************************************************   CSE006
      /EJECT                                                              CSE006
      *****************************************************************   CSE006
      *                                                               *   CSE006
      *  BSPLS  - SUBROUTINE TO CALCULATE PROFIT/LOSS FOR BUY-SELL    *   CSE006
      *           TRADES FOR AMORTISATION                             *   CSE006
      *                                                               *   CSE006
      *****************************************************************   CSE006
      *                                                                   CSE006
     C           BSPLS     BEGSR                           *** BSPLS  *** CSE006
      *                                                                   CSE006
      *** If in reversal mode and acton is for second trade               CSE006
      *** then do calculation                                             CSE006
      *                                                                   CSE006
     C           *INU1     IFEQ '1'                                       CSE006
     C           @SECTR    ANDEQ'Y'                                       CSE006
     C           BSPL      ANDNE0                                         CSE006
      *                                                                   CSE006
     C                     Z-ADDBSPL      EVAM                         ** CSE006
      *                                                                   CSE006
     C           EVAM      IFGT 0                                         CSE006
     C                     MOVE 'RL'      AMCD                         ** CSE006
     C           EVAM      MULT -1        EVAM                         ** CSE006
     C                     ELSE                                           CSE006
     C                     MOVE 'RP'      AMCD                            CSE006
     C                     ENDIF                                          CSE006
      *                                                                ** CSE006
      *** Change fields using Book Postions action file (BPACC)           CSE006
      *                                                                   CSE006
     C                     MOVE BCTV      EVAM                            CSE006
     C                     MOVE ' '       TRTP                            CSE006
     C                     MOVE ' '       TRST                            CSE006
     C                     MOVE ' '       PORT                            CSE006
      *                                                                ** CSE006
     C                     EXSR W01                                       CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
      *** Else if not in reversal mode                                    CSE006
      *                                                                   CSE006
     C           *INU1     IFNE '1'                                       CSE006
      *                                                                   CSE006
      *** And action is for first trade                                   CSE006
      *                                                                   CSE006
     C           @SECTR    IFEQ 'N'                                    ** CSE006
      *                                                                   CSE006
     C           @BSPL     IFEQ 0                                         CSE006
     C                     EXSR CALPL                                     CSE006
     C                     ENDIF                                          CSE006
     C                     Z-ADD@BSPL     BSPL                         ** CSE006
      *                                                                   CSE006
     C                     ENDIF                                       ** CSE006
      *                                                                   CSE006
      *** If action is for second trade and not in reversal mode          CSE006
      *                                                                   CSE006
     C           @SECTR    IFEQ 'Y'                                       CSE006
      *                                                                   CSE006
     C                     Z-ADDBSPL      EVAM                            CSE006
      *                                                                ** CSE006
     C           EVAM      IFGT 0                                         CSE006
     C                     MOVE 'RL'      AMCD                            CSE006
     C           EVAM      MULT -1        EVAM                            CSE006
     C                     ELSE                                        ** CSE006
     C                     MOVE 'RP'      AMCD                            CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     MOVE BCTV      EVTP                         ** CSE006
     C                     MOVE ' '       TRTP                            CSE006
     C                     MOVE ' '       TRST                            CSE006
     C                     MOVE ' '       PORT                            CSE006
      *                                                                ** CSE006
     C                     EXSR W01                                       CSE006
      *                                                                   CSE006
     C           BSVD2     IFEQ BCAD                                      CSE006
     C                     MOVE 'M'       BSRECI                          CSE006
     C                     Z-ADDBSVD2     BSLATD                          CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     ENDIF                                          CSE006
      *                                                                   CSE006
     C                     ENDSR                                       ** CSE006
      *                                                                   CSE006
      *****************************************************************   CSE006
      /EJECT
      *****************************************************************
      *                                                               *
      *  ACCRUE - SUBROUTINE TO CALCULATE ACCRUED INTEREST UP TO DATE *
      *                                                               *
      *****************************************************************
      *
     C           ACCRUE    BEGSR                           *** ACCRUE ***
     C/COPY WNCPYSRC,SE2220C153
     C*
      ***  If the Initial Date is Greater Than the Action Date, then
      ***  the Accrued Interest is zero.
     C*
     C                     Z-ADD0         TOTACC 150
     C*
     C           ITLD      IFGT BCAD
     C                     Z-ADD0         WAIRP  130
     C                     GOTO EACCRU
     C                     END
      *                                                                   100100
      **  If action date is greater than maturity date, then suppress     100100
      **  generation of this key                                          100100
      *                                                                   100100
     C           BCAD      IFGT MATY                                      100100
     C           MATY      ANDNE*ZEROS                                    108024
     C                     GOTO EACCRU                                    100100
     C                     ENDIF                                          100100
     C*
      ***  If the Last Position Date is Less Than the Last Coupon Date
      ***  then the Purchased Interest is zero.
     C*
     C           LPSD      IFLT LCPN
     C                     Z-ADD0         WPINT  130
     C                     Z-ADD0         ECNP                            056394
     C                     Z-ADD0         IACP                            056394
     C                     Z-ADD0         INDO                            056394
     C                     ELSE
     C                     Z-ADDPILP      WPINT
     C                     END
     C*                                                                   E23987
     C* Save Event Control Date.                                          E23987
     C                     Z-ADDECD       ECDPRV                          E23987
      *                                                                   E20085
     C*****Determine*the*Next*Coupon*Date.***********************  E20085 E23987
      ***  Determine the Next Coupon Date using Last Coupon Date (LCPN)   E23987
      ***  , not Event Control Date.                                      E23987
      *                                                                   E20085
     C***********          Z-ADDLCPN      ECD                      E23987 E34532
     C           LCPN      ADD  1         ECD                             E34532
     C                     EXSR ZNCD                                      E20085
     C*
     C* Return old Event Control Date                                     E23987
     C                     Z-ADDECDPRV    ECD                             E23987
     C*                                                                   E23987
     C* OBTAIN TOTAL INTEREST ON TOTAL NOMINAL POSITION
     C*
      ***  For non-Schuldschein
     C           PROT      IFNE '6'
     C                     Z-ADDLCPN      ZDCSDT                          E20085
     C                     Z-ADDBCAD      ZDCEDT                          E20085
     C                     Z-ADDNPSN      ZAMT                            E20085
     C/COPY WNCPYSRC,SE2220C087
     C                     EXSR ZACCZ                                     E20085
     C/COPY WNCPYSRC,SE2220C088
     C                     Z-ADDZDCINT    TOTACC                          E20085
      *
      ***  Else for Schuldschein
     C                     ELSE
     C           LPSD      IFGT LCPN                                      E21304
     C                     Z-ADDLPSD      ZSDATE
     C                     ELSE                                           E21304
     C                     Z-ADDLCPN      ZSDATE                          E21304
     C                     END                                            E21304
     C                     Z-ADDBCAD      ZEDATE
     C                     Z-ADDNPSN      ZAMT
     C                     Z-ADDCPNR      IRATE
     C           IRATE     IFNE 0                                         049865
     C/COPY WNCPYSRC,SE2220C089
     C                     EXSR ZACCR
     C/COPY WNCPYSRC,SE2220C090
     C                     ELSE                                           049865
     C                     Z-ADD0         ZACCRD                          049865
     C                     END                                            049865
     C                     Z-ADDZACCRD    TOTACC
     C                     END
     C*
      ***  Calculate the Total Coupon as at the Next Coupon Date on the
      ***  Ex-Coupon Position if Ex-Coupon Nominal is not zero.
     C*
     C           ECNP      IFNE 0
     C           IRATE     ANDNE0                                         049865
     C                     Z-ADDLCPN      ZDCSDT                          E20085
     C                     Z-ADDNCD       ZDCEDT                          E20085
     C                     Z-ADDECNP      ZAMT                            E20085
     C/COPY WNCPYSRC,SE2220C091
     C                     EXSR ZACCZ                                     E20085
     C/COPY WNCPYSRC,SE2220C092
     C                     Z-ADDZDCINT    WTCPN  150                      E20085
     C                     ELSE
     C                     Z-ADD0         WTCPN
     C                     END
     C*
     C* CALCULATE ACCRUED INTEREST TO POST
     C*
     C           TOTACC    SUB  WTCPN     WSTOT  150
     C           WSTOT     SUB  WPINT     WSTOT
     C***********WSTOT     SUB  ARPC      WAIRP                           040431
     C           PROT      IFEQ '6'                                       040431
     C           ARPC      IFLT 0                                         040431
     C           EVAM      ANDGT0                                         040431
     C           ARPC      ORGT 0                                         040431
     C           EVAM      ANDLT0                                         040431
     C           WSTOT     ADD  ARPC      WSTOT                           040431
     C                     ELSE                                           040431
     C           WSTOT     SUB  ARPC      WSTOT                           040431
     C                     END                                            040431
     C                     ELSE                                           040431
     C           WSTOT     SUB  ARPC      WSTOT                           040431
     C                     END                                            040431
     C*********************ADD  INDO      WAIRP                    E20085 040431
     C           WSTOT     ADD  INDO      WAIRP                    E20085 040431
     C***********                                                         E20085
      ***  WTINT no longer used hereafter, so don't need update here.     E20085
     C**DETERMINE*WHETHER*TOTAL*INTEREST*LESS*THAN*0*******************   E20085
     C***********                                                         E20085
     C***********TOTACC    SUB  WTCPN     WTINT                           E20085
     C/COPY WNCPYSRC,SE2220C065
     C*
     C* OUTPUT ACCRUED INTEREST RECEIVABLE ACCOUNT KEYS
     C*
     C                     MOVE 'A'       EVTP
     C                     MOVE ' '       TRTP
     C                     MOVE ' '       PORT
     C                     MOVE '  '      TRST
     C           NPSN      IFGE 0
     C           SNAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C*
     C* REVERSE NEGI IF -VE COUPON RATE AND SPLIT NEG ACCR. IS Y
     C*
     C           CPNR      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*                                                                   101037
     C*** For accrued interest value date equal to accrued end date       101037
     C*                                                                   101037
     C           ACLD      IFEQ 'Y'                                       101037
     C                     Z-ADDBCAD      EVDT                            101037
     C                     ELSE                                           101037
     C           BCAD      SUB  1         EVDT                            101037
     C                     END                                            101037
     C*
     C                     MOVE 'AI'      AMCD
     C                     MOVE *BLANK    TRFR
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C*
     C           NPSN      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           WAIRP     MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDWAIRP     EVAM
     C                     END
     C*
     C* REVERSE SIGN IF -VE COUPON RATE AND SPLIT NEG ACCR. Y
     C*
     C           CPNR      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C017
     C           PROT      IFEQ '6'                                      040431
     C           ARPC      IFLT 0                                        040431
     C           EVAM      ANDGT0                                        040431
     C                     Z-ADDARPC      EVAM                           040431
     C                     MOVE 'N'       NEGI                           040431
     C                     SUB  EVAM      ARPC                           040431
     C                     EXSR W01                                      040431
     C/COPY WNCPYSRC,SE2220C018
     C                     END                                           040431
     C           ARPC      IFGT 0                                        040431
     C           EVAM      ANDLT0                                        040431
     C                     Z-ADDARPC      EVAM                           040431
     C                     MOVE ' '       NEGI                           040431
     C                     SUB  EVAM      ARPC                           040431
     C                     EXSR W01                                      040431
     C/COPY WNCPYSRC,SE2220C019
     C                     END                                           040431
     C                     END                                           040431
     C                     END
     C*
     C* RESET AIR POSTED SINCE LAST CONTROL DATE
     C*
     C           WAIRP     ADD  ARPC      ARPC
     C*
     C           EACCRU    ENDSR                           *** EACCRU ***
      *
      *****************************************************************
      /EJECT                                                              S01233
      *****************************************************************   S01233
      *                                                               *   S01233
      *  AAMORT - Subroutine to Amortise Premium/Discount on a Yield  *   S01233
      *           Curve Basis for the Australian Market.              *   S01233
      *                                                               *   S01233
      *****************************************************************   S01233
      *                                                                   S01233
     C           AAMORT    BEGSR                           *** AAMORT *** S01233
     C*                                                                   S01233
     C* If initial date has not been reached yet, then bypass             S01233
     C           ITLD      IFGT BCAD                                      S01233
     C           CSE065    OREQ 'Y'                                                           CSE065
     C           ALDT      ANDLTRUND                                                          CSE065
     C           WAMORT    ANDNE' '                                                           CSE065
     C                     GOTO AAEND                                     S01233
     C                     END                                            S01233
     C*                                                                   S01233
     C                     Z-ADD0         YLDPRC 158                      S01233
     C                     Z-ADD0         LCDWRK 130                      S01233
     C                     Z-ADD0         NCDWRK 130                      S01233
     C                     Z-ADD0         ACTWRK 130                      S01233
     C                     Z-ADD0         WRKPIX 130                      S01233
     C                     Z-ADD0         WRKPI                           S01233
     C*                                                                   S01233
     C* Save Event Control Date.                                          S01233
     C                     Z-ADDECD       ECDPRV  50                      S01233
     C*                                                                   E21084
     C* set nominal to positive for working on                            E21084
     C           NPSN      IFLT 0                                         E21084
     C                     Z-SUBNPSN      WNOML  130                      E21084
     C                     ELSE                                           E21084
     C                     Z-ADDNPSN      WNOML                           E21084
     C                     END                                            E21084
     C*                                                                   S01233
     C* If Coupon rate = zeroes (eg. Commercial Paper) then zeroise       S01233
     C* WRKPI and bypass interest calcs.                                  S01233
     C           CPNR      IFEQ 0                                         S01233
     C           SYBS      ORNE 'AU'                                      S01233
     C/COPY WNCPYSRC,SE2220C193
     C                     Z-ADD*ZEROS    WRKPI                           S01233
     C*                                                                   S01233
     C                     ELSE                                           S01233
     C*                                                                   S01233
     C* Obtain next coupon date for previous period                       S01233
     C***********          Z-ADDLAMDAT    ECD                      S01233 E22957
     C           LAMDAT    ADD  1         ECD                             E22957
     C                     EXSR ZNCD                                      S01233
     C*                                                                   S01233
     C* Obtain last coupon date for previous period                       S01233
     C***********          Z-ADDLAMDAT    ZECD                     S01233 E22957
     C           NCD       SUB  1         ZECD                            E22957
     C                     EXSR ZLCD                                      S01233
     C                     Z-ADDZZLCD     LCOUP   50                      S01233
     C*                                                                   S01233
     C**set*nominal*to*positive*for*working*on******************** S01233 E21084
     C***********NPSN      IFLT 0                                  S01233 E21084
     C***********          Z-SUBNPSN      WNOML  130               S01233 E21084
     C***********          ELSE                                    S01233 E21084
     C***********          Z-ADDNPSN      WNOML                    S01233 E21084
     C***********          END                                     S01233 E21084
     C*                                                                   S01233
     C* Determine if period Cum. or Ex                                    S01233
     C                     Z-ADDLAMDAT    WRKD                            S01233
     C                     EXSR ZYCE                                      S01233
     C/COPY WNCPYSRC,SE2220C199
     C*                                                                   S01233
     C* Calculate interest for Cum period (SCUMEX = C)                    S01233
      *                                                                                       CSE035
     C           CSE035    IFEQ 'Y'                                                           CSE035
      *                                                                                       CSE035
     C                     Z-ADDLCOUP     ZDCSDT                                              CSE035
     C                     Z-ADDLAMDAT    ZDCEDT                                              CSE035
     C                     Z-ADDWNOML     ZAMT                                                CSE035
     C                     EXSR ZACCZ                                                         CSE035
     C                     Z-ADDZDCINT    TOTACC                                              CSE035
     C                     Z-ADDZDCINT    WRKPIX                                              CSE035
      *                                                                                       CSE035
     C                     ELSE                                                               CSE035
      *                                                                                       CSE035
     C           SCUMEX    IFEQ 'C'                                       S01233
     C/COPY WNCPYSRC,SE2220C207
     C                     Z-ADDLCOUP     ZDCSDT                          S01233
     C                     Z-ADDLAMDAT    ZDCEDT                          S01233
     C                     Z-ADDWNOML     ZAMT                            S01233
     C/COPY WNCPYSRC,SE2220C093
     C                     EXSR ZACCZ                                     S01233
     C/COPY WNCPYSRC,SE2220C094
     C                     Z-ADDZDCINT    TOTACC                          S01233
     C                     Z-ADDZDCINT    WRKPIX                          E22957
     C***********                                                  S01233 E22957
     C**Calculate*the*Accrued*Interest*on*the*Ex-Coupon*Nominal*** S01233 E22957
     C***********ECNP      IFEQ 0                                  S01233 E22957
     C***********          Z-ADD0         WTCPN                    S01233 E22957
     C***********          ELSE                                    S01233 E22957
     C***********          Z-ADDLCOUP     ZDCSDT                   S01233 E22957
     C***********          Z-ADDNCD       ZDCEDT                   S01233 E22957
     C***********ECNP      IFLT 0                                  S01233 E22957
     C***********          Z-SUBECNP      ZAMT                     S01233 E22957
     C***********          ELSE                                    S01233 E22957
     C***********          Z-ADDECNP      ZAMT                     S01233 E22957
     C***********          END                                     S01233 E22957
     C***********          EXSR ZACCZ                              S01233 E22957
     C***********          Z-ADDZDCINT    WTCPN                    S01233 E22957
     C***********          END                                     S01233 E22957
     C***********                                                  S01233 E22957
     C***********TOTACC    SUB  WTCPN     WRKPIX                   S01233 E22957
     C***********WRKPIX    IFLT 0                                  S01233 E21084
     C***********WRKPIX    IFLE 0                                  E21084 E22957
     C***********          MOVE 'X'       SCUMEX                   S01233 E22957
     C***********          END                                     S01233 E22957
     C*                                                                   S01233
     C/COPY WNCPYSRC,SE2220C208
     C                     END                                            S01233
     C/COPY WNCPYSRC,SE2220C209
      *                                                                                       CSE035
     C                     ENDIF                                                              CSE035
     C*                                                                   S01233
     C* Calculate interest for Ex period (SCUMEX = X)                     S01233
     C           SCUMEX    IFEQ 'X'                                       S01233
     C*                                                                   S01233
     C* Calculate interest to last (change/amort) date                    S01233
     C                     Z-ADDLCOUP     ZDCSDT                          S01233
     C                     Z-ADDLAMDAT    ZDCEDT                          S01233
     C                     Z-ADDWNOML     ZAMT                            S01233
     C/COPY WNCPYSRC,SE2220C095
     C                     EXSR ZACCZ                                     S01233
     C/COPY WNCPYSRC,SE2220C096
     C                     Z-ADDZDCINT    LCDWRK                          S01233
     C*                                                                   S01233
     C* Calculate interest to Next Coupon Date                            S01233
     C                     Z-ADDLCOUP     ZDCSDT                          S01233
     C                     Z-ADDNCD       ZDCEDT                          S01233
     C                     Z-ADDWNOML     ZAMT                            S01233
     C/COPY WNCPYSRC,SE2220C097
     C                     EXSR ZACCZ                                     S01233
     C/COPY WNCPYSRC,SE2220C098
     C                     Z-ADDZDCINT    NCDWRK                          S01233
     C*                                                                   S01233
     C           LCDWRK    SUB  NCDWRK    WRKPIX                          S01233
     C*                                                                   S01233
     C                     END                                            S01233
     C*                                                                   S01233
     C* Make interest figure a percentage                                 S01233
     C           WRKPIX    DIV  WNOML     WRKPI                           S01233
     C*                                                                   S01233
     C                     END                                            S01233
     C*                                                                   S01233
     C* Calculate Yield from last (change/amort) date                     S01233
      *                                                                                       230115
      ** Save the present coupon rate and get the prevailing rate for the period.             230115
      *                                                                                       230115
     C                     Z-ADDCPNR      WSCPNR 117                                          230115
     C                     MOVE 'IR'      SDET                                                230115
     C                     Z-ADD0         ZDCSDT                                              230115
     C           KZSEDF    SETLLSEDEVDF                                                       230115
     C           SESN      READESEDEVDF                  71                                   230115
     C           *IN71     DOWEQ'0'                                                           230115
     C           SDED      ANDLELAMDAT                                                        230115
     C           SDET      IFEQ 'IR'                                                          230115
     C                     Z-ADDSDNC      WPCPNR 117                                          230115
     C                     ENDIF                                                              230115
     C           SESN      READESEDEVDF                  71                                   230115
     C                     ENDDO                                                              230115
      *                                                                                       230115
     C                     Z-ADDWPCPNR    CPNR                                                230115
     C                     Z-ADDLAVP      ZPRICE                          S01233
     C                     Z-ADDLAMDAT    ZFDATE                          S01233
     C                     Z-ADDWNOML     ZNOML                           E39495
     C                     Z-ADDLAMDNA    ZIDNAT                          102506
     C                     MOVE *BLANK    ZACLT                           102506
     C                     EXSR ZPRCO                                     S01233
     C                     Z-ADDZPRCOT    YLDPRC                          S01233
      *                                                                                       230115
      ** Restore current coupon rate.                                                         230115
      *                                                                                       230115
     C                     Z-ADDWSCPNR    CPNR                                                230115
     C*                                                                   S01233
     C* CALCULATE PRICE FROM YIELD TO ACTION DATE.                        S01233
     C*                                                                   S01233
     C* If Coupon rate = zeroes (eg. Commercial Paper) then zeroise       S01233
     C* WRKPI and bypass interest calcs.                                  S01233
     C           CPNR      IFEQ 0                                         S01233
     C           SYBS      ORNE 'AU'                                      S01233
     C/COPY WNCPYSRC,SE2220C194
     C                     Z-ADD*ZEROS    WRKPI                           S01233
     C*                                                                   S01233
     C                     ELSE                                           S01233
     C*                                                                   E22957
     C* Obtain next coupon date for current period                        E22957
     C           BCAD      ADD  1         ECD                             E22957
     C                     EXSR ZNCD                                      E22957
     C*                                                                   E22957
     C* Obtain last coupon date for current period                        E22957
     C           NCD       SUB  1         ZECD                            E22957
     C                     EXSR ZLCD                                      E22957
     C                     Z-ADDZZLCD     LCOUP   50                      E22957
     C*                                                                   S01233
     C* Determine if period Cum. or Ex                                    S01233
     C                     Z-ADDBCAD      WRKD                            S01233
     C                     EXSR ZYCE                                      S01233
     C/COPY WNCPYSRC,SE2220C200
     C*                                                                   S01233
     C* Calculate interest for Cum period (SCUMEX = C)                    S01233
      *                                                                                       CSE035
     C           CSE035    IFEQ 'Y'                                                           CSE035
      *                                                                                       CSE035
     C                     Z-ADDLCOUP     ZDCSDT                                              CSE035
     C                     Z-ADDBCAD      ZDCEDT                                              CSE035
     C                     Z-ADDWNOML     ZAMT                                                CSE035
     C                     EXSR ZACCZ                                                         CSE035
     C                     Z-ADDZDCINT    TOTACC                                              CSE035
     C                     Z-ADDZDCINT    WRKPIX                                              CSE035
      *                                                                                       CSE035
     C                     ELSE                                                               CSE035
      *                                                                                       CSE035
     C           SCUMEX    IFEQ 'C'                                       S01233
     C/COPY WNCPYSRC,SE2220C210
     C*********************Z-ADDLCPN      ZDCSDT                   S01233 E22957
     C                     Z-ADDLCOUP     ZDCSDT                          E22957
     C                     Z-ADDBCAD      ZDCEDT                          S01233
     C                     Z-ADDWNOML     ZAMT                            S01233
     C/COPY WNCPYSRC,SE2220C099
     C                     EXSR ZACCZ                                     S01233
     C/COPY WNCPYSRC,SE2220C100
     C                     Z-ADDZDCINT    TOTACC                          S01233
     C                     Z-ADDZDCINT    WRKPIX                          E22957
     C***********
     C***********                                                  S01233 E22957
     C**Calculate*the*Accrued*Interest*on*the*Ex-Coupon*Nominal*** S01233 E22957
     C***********ECNP      IFEQ 0                                  S01233 E22957
     C***********          Z-ADD0         WTCPN                    S01233 E22957
     C***********          ELSE                                    S01233 E22957
     C***********          Z-ADDLCPN      ZDCSDT                   S01233 E22957
     C***********          Z-ADDNCD       ZDCEDT                   S01233 E22957
     C***********ECNP      IFLT 0                                  S01233 E22957
     C***********          Z-SUBECNP      ZAMT                     S01233 E22957
     C***********          ELSE                                    S01233 E22957
     C***********          Z-ADDECNP      ZAMT                     S01233 E22957
     C***********          END                                     S01233 E22957
     C***********          EXSR ZACCZ                              S01233 E22957
     C***********          Z-ADDZDCINT    WTCPN                    S01233 E22957
     C***********          END                                     S01233 E22957
     C***********                                                  S01233 E22957
     C***********TOTACC    SUB  WTCPN     WRKPIX                   S01233 E22957
     C***********WRKPIX    IFLT 0                                  S01233 E21084
     C***********WRKPIX    IFLE 0                                  E21084 E22957
     C***********          MOVE 'X'       SCUMEX                   S01233 E22957
     C***********          END                                     S01233 E22957
     C*                                                                   S01233
     C/COPY WNCPYSRC,SE2220C211
     C                     END                                            S01233
     C/COPY WNCPYSRC,SE2220C212
      *                                                                                       CSE035
     C                     ENDIF                                                              CSE035
     C*                                                                   S01233
     C* Calculate interest for Ex period (SCUMEX = X)                     S01233
     C           SCUMEX    IFEQ 'X'                                       S01233
     C*                                                                   S01233
     C* Calculate interest to Action date                                 S01233
     C***********          Z-ADDLCPN      ZDCSDT                   S01233 E22957
     C                     Z-ADDLCOUP     ZDCSDT                          E22957
     C                     Z-ADDBCAD      ZDCEDT                          S01233
     C                     Z-ADDWNOML     ZAMT                            S01233
     C/COPY WNCPYSRC,SE2220C101
     C                     EXSR ZACCZ                                     S01233
     C/COPY WNCPYSRC,SE2220C102
     C                     Z-ADDZDCINT    ACTWRK                          S01233
     C*                                                                   S01233
     C* Calculate interest to Next Coupon date                            S01233
     C*********************Z-ADDLCPN      ZDCSDT                   S01233 E22957
     C                     Z-ADDLCOUP     ZDCSDT                          E22957
     C                     Z-ADDNCD       ZDCEDT                          S01233
     C                     Z-ADDWNOML     ZAMT                            S01233
     C/COPY WNCPYSRC,SE2220C103
     C                     EXSR ZACCZ                                     S01233
     C/COPY WNCPYSRC,SE2220C104
     C                     Z-ADDZDCINT    NCDWRK                          S01233
     C*                                                                   S01233
     C           ACTWRK    SUB  NCDWRK    WRKPIX                          S01233
     C*                                                                   S01233
     C                     END                                            S01233
     C*                                                                   S01233
     C* Make interest figure a percentage                                 S01233
     C***********WRKPIX    DIV  NPSN      WRKPI                    S01233 E21084
     C           WRKPIX    DIV  WNOML     WRKPI                           E21084
     C*                                                                   S01233
     C                     END                                            S01233
     C*                                                                   S01233
     C* Calculate New Price from Action date                              S01233
     C                     Z-ADDYLDPRC    ZPRCIN                          S01233
     C                     Z-ADDBCAD      ZFDATE                          S01233
     C                     Z-ADDWNOML     ZNOML                           E39495
     C                     Z-ADD*ZERO     ZIDNAT                          102506
     C                     MOVE 'Y'       ZACLT                           102506
      *                                                                                       230115
      ** Save the present coupon rate and use the prevailing rate for the period.             230115
      *                                                                                       230115
     C                     Z-ADDCPNR      WSCPNR                                              230115
     C                     Z-ADDWPCPNR    CPNR                                                230115
     C                     EXSR ZPRCI                                     S01233
      *                                                                                       230115
      ** Restore current coupon rate.                                                         230115
      *                                                                                       230115
     C                     Z-ADDWSCPNR    CPNR                                                230115
     C*                                                                   102506
     C** Reset day number accrued to and accrual type                     102506
     C*                                                                   102506
     C                     Z-ADD*ZERO     ZIDNAT                          102506
     C                     MOVE *BLANK    ZACLT                           102506
     C*                                                                   102506
     C** Update day number accrued to                                     102506
     C*                                                                   102506
     C                     Z-ADDZODNAT    DNAT                            102506
     C*                                                                   S01233
     C* Calculate amount to amortise                                      S01233
     C           ZPRCOT    SUB  LAVP      ZPRC                            S01233
     C***********          Z-ADDWNOML     ZNOML                    S01233 E22957
     C                     Z-ADDNPSN      ZNOML                    S01233 E22957
     C                     EXSR ZCNSD                                     S01233
     C                     Z-ADDZCONS     WADP                            S01233
     C/COPY WNCPYSRC,SE2220C195
     C*                                                                   S01233
     C* Return old Event Control Date                                     S01233
     C                     Z-ADDECDPRV    ECD                             S01233
     C*                                                                   S01233
     C           AAEND     ENDSR                                          S01233
      *                                                                                       CSE065
      *****************************************************************                       CSE065
      /EJECT                                                                                  CSE065
      *****************************************************************                       CSE065
      *                                                               *                       CSE065
      *  AMORSL - Subroutine to Calculate amortisation for Straight   *                       CSE065
      *           Line Method base on changes in Average Life Date    *                       CSE065
      *                                                               *                       CSE065
      *****************************************************************                       CSE065
      *                                                                                       CSE065
     C           AMORSL    BEGSR                                                              CSE065
      *                                                                                       CSE065
     C                     Z-ADDBCAD      WKBCAD  50                                          CSE065
     C                     Z-ADDLAMDAT    ZSDATE                                              CSE065
     C                     Z-ADDLAMDNA    ZIDNAT                                              CSE065
     C                     Z-ADD0         WWADP                                               CSE065
     C                     Z-ADD0         WWEDN  130                                          CSE065
      *                                                                                       CSE065
     C                     MOVELSESN      CSDSN                                               CSE065
     C                     MOVE 'AL'      CSDET                                               CSE065
     C                     Z-ADDZSDATE    CSDED                                               CSE065
     C           SEKEY1    SETGTSEDEVAL1                                                      CSE065
     C                     READPSEDEVAL1                 79                                   CSE065
     C           *IN79     IFEQ *ON                                                           CSE065
     C           C#SDSN    ORNE CSDSN                                                         CSE065
     C           C#SDET    ORNE 'AL'                                                          CSE065
     C           *LOCK     IN   LDA                                                           CSE065
     C                     MOVE 'SEDEVD'  DBFILE                                              CSE065
     C                     Z-ADD50        DBASE                                               CSE065
     C                     MOVEL'INIT AL' DBKEY                                               CSE065
     C                     MOVE '1'       *INU7                                               CSE065
     C                     MOVE '1'       *INU8                                               CSE065
     C                     OUT  LDA                                                           CSE065
     C                     EXSR *PSSR                                                         CSE065
     C                     MOVE '1'       *INLR                                               CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADDC#SDAL    WALDT1  50                                          CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C           *IN79     DOUEQ*ON                                                           CSE065
     C           C#SDSN    ORNE CSDSN                                                         CSE065
     C           C#SDET    ORNE 'AL'                                                          CSE065
     C           C#SDED    ORGE WKBCAD                                                        CSE065
      *                                                                                       CSE065
      ** Read next 'AL' record                                                                CSE065
      *                                                                                       CSE065
     C                     READ SEDEVAL1                 79                                   CSE065
      *                                                                                       CSE065
      ** If found, set the dates                                                              CSE065
      *                                                                                       CSE065
     C           *IN79     IFEQ *OFF                                                          CSE065
     C           C#SDSN    ANDEQCSDSN                                                         CSE065
     C           C#SDET    ANDEQ'AL'                                                          CSE065
     C           C#SDED    ANDLEBCAD                                                          CSE065
     C                     Z-ADDC#SDED    BCAD                                                CSE065
     C                     Z-ADDC#SDAL    WALDT2  50                                          CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADDWKBCAD    BCAD                                                CSE065
     C                     Z-ADDWALDT1    WALDT2                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** Calculate number of days to Average Life Date                                        CSE065
      *                                                                                       CSE065
     C                     Z-ADDWALDT1    ZEDATE                                              CSE065
     C                     MOVE *BLANKS   ZACLT                                               CSE065
     C                     EXSR ZDAYS                                                         CSE065
      *                                                                                       CSE065
      ** Number of Days 1                                                                     CSE065
      *                                                                                       CSE065
     C                     Z-ADDZDDAYS    W#DAY1  50                                          CSE065
      *                                                                                       CSE065
      ** Calculate number of days to amortised                                                CSE065
      *                                                                                       CSE065
     C           WALDT1    IFLT BCAD                                                          CSE065
     C                     Z-ADDWALDT1    ZEDATE                                              CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADDBCAD      ZEDATE                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     MOVE 'D'       ZACLT                                               CSE065
     C                     EXSR ZDAYS                                                         CSE065
      *                                                                                       CSE065
      ** Number of days 2                                                                     CSE065
      *                                                                                       CSE065
     C                     Z-ADDZDDAYS    W#DAY2  50                                          CSE065
      *                                                                                       CSE065
     C                     Z-ADD0         ZIDNAT                                              CSE065
     C                     MOVE *BLANKS   ZACLT                                               CSE065
     C                     Z-ADDZODNAT    DNAT                                                CSE065
      *                                                                                       CSE065
      ** Calculate Earned Discount/Premium since Last Posn Date                               CSE065
      *                                                                                       CSE065
     C           W#DAY1    IFEQ 0                                                             CSE065
     C           W#DAY1    ORLT W#DAY2                                                        CSE065
     C                     Z-ADDBUDU      WEDP                                                CSE065
     C           CAS006    IFEQ 'Y'                                                           CSE065
     C                     Z-ADDBUDN      WEDP                                                CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADDW#DAY1    ZPNPSN                                              CSE065
     C                     Z-ADDW#DAY2    ZNPSN                                               CSE065
     C                     Z-ADDBUDU      ZAPIN                                               CSE065
     C                     EXSR ZAPORT                                                        CSE065
     C                     Z-ADDZAPOUT    WEDP                                                CSE065
     C           CAS006    IFEQ 'Y'                                                           CSE065
     C                     Z-ADDW#DAY1    ZPNPSN                                              CSE065
     C                     Z-ADDW#DAY2    ZNPSN                                               CSE065
     C                     Z-ADDBUDN      ZAPIN                                               CSE065
     C                     EXSR ZAPORT                                                        CSE065
     C                     Z-ADDZAPOUT    WEDN                                                CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
      ** Accymulate Amortised Discount/Premium to post                                        CSE065
      *                                                                                       CSE065
     C                     ADD  WEDP      WWADP                                               CSE065
     C           CAS006    IFEQ 'Y'                                                           CSE065
     C                     ADD  WEDN      WWEDN                                               CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     Z-ADDBCAD      ZSDATE                                              CSE065
     C                     Z-ADDWALDT2    WALDT1                                              CSE065
      *                                                                                       CSE065
     C                     ENDDO                                                              CSE065
      *                                                                                       CSE065
     C                     Z-ADDWWADP     WADP                                                CSE065
     C           CAS006    IFEQ 'Y'                                                           CSE065
     C                     Z-ADDWWEDN     WADN                                                CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     Z-ADDWKBCAD    BCAD                                                CSE065
      *                                                                                       CSE065
     C                     ENDSR                                                              CSE065
      *                                                                   S01233
      *****************************************************************   S01233
      /EJECT
      *****************************************************************                       CAS006
      *                                                               *                       CAS006
      *  AAMORN - Subroutine to Amortise Premium/Discount on a Yield  *                       CAS006
      *           Curve Basis for the Australian Market.              *                       CAS006
      *                                                               *                       CAS006
      *****************************************************************                       CAS006
      *                                                                                       CAS006
     C           AAMORN    BEGSR                           *** AAMORN ***                     CAS006
      *                                                                                       CAS006
      ** If initial date has not been reached yet, then bypass                                CAS006
      *                                                                                       CAS006
     C           ITLD      IFGT BCAD                                                          CAS006
     C           CSE065    OREQ 'Y'                                                           CSE065
     C           ALDT      ANDLTRUND                                                          CSE065
     C           WAMORT    ANDNE' '                                                           CSE065
     C                     GOTO AAENN                                                         CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                                       CAS006
     C                     Z-ADD0         YLDPRN 158                                          CAS006
     C                     Z-ADD0         LCDWRK                                              CAS006
     C                     Z-ADD0         NCDWRK                                              CAS006
     C                     Z-ADD0         ACTWRK                                              CAS006
     C                     Z-ADD0         WRKPIX                                              CAS006
     C                     Z-ADD0         WRKPI                                               CAS006
      *                                                                                       CAS006
      ** Save Event Control Date.                                                             CAS006
      *                                                                                       CAS006
     C                     Z-ADDECD       ECDPRV                                              CAS006
      *                                                                                       CAS006
      ** set nominal to positive for working on                                               CAS006
      *                                                                                       CAS006
     C           NPSN      IFLT 0                                                             CAS006
     C                     Z-SUBNPSN      WNOML                                               CAS006
     C                     ELSE                                                               CAS006
     C                     Z-ADDNPSN      WNOML                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
      ** If Coupon rate = zeroes (eg. Commercial Paper) then zeroise                          CAS006
      ** WRKPI and bypass interest calcs.                                                     CAS006
      *                                                                                       CAS006
     C           CPNN      IFEQ 0                                                             CAS006
     C           SYBS      ORNE 'AU'                                                          CAS006
     C                     Z-ADD*ZEROS    WRKPI                                               CAS006
     C                     ELSE                                                               CAS006
      *                                                                                       CAS006
      ** Obtain next coupon date for previous period                                          CAS006
      *                                                                                       CAS006
     C           LAMDAT    ADD  1         ECD                                                 CAS006
     C                     EXSR ZNCD                                                          CAS006
     C*                                                                                       CAS006
     C           NCD       SUB  1         ZECD                                                CAS006
     C                     EXSR ZLCD                                                          CAS006
     C                     Z-ADDZZLCD     LCOUP   50                                          CAS006
      *                                                                                       CAS006
      ** Determine if period Cum. or Ex                                                       CAS006
      *                                                                                       CAS006
     C                     Z-ADDLAMDAT    WRKD                                                CAS006
     C                     EXSR ZYCE                                                          CAS006
      *                                                                                       CAS006
      ** Calculate interest for Cum period (SCUMEX = C)                                       CAS006
      *                                                                                       CAS006
     C           SCUMEX    IFEQ 'C'                                                           CAS006
     C                     Z-ADDLCOUP     ZDCSDT                                              CAS006
     C                     Z-ADDLAMDAT    ZDCEDT                                              CAS006
     C                     Z-ADDWNOML     ZAMT                                                CAS006
     C                     EXSR ZACCZ                                                         CAS006
     C                     Z-ADDZDCINT    TOTACC                                              CAS006
     C                     Z-ADDZDCINT    WRKPIX                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
      ** Calculate interest for Ex period (SCUMEX = X)                                        CAS006
      *                                                                                       CAS006
     C           SCUMEX    IFEQ 'X'                                                           CAS006
      *                                                                                       CAS006
      ** Calculate interest to last (change/amort) date                                       CAS006
      *                                                                                       CAS006
     C                     Z-ADDLCOUP     ZDCSDT                                              CAS006
     C                     Z-ADDLAMDAT    ZDCEDT                                              CAS006
     C                     Z-ADDWNOML     ZAMT                                                CAS006
     C                     EXSR ZACCZ                                                         CAS006
     C                     Z-ADDZDCINT    LCDWRK                                              CAS006
      *                                                                                       CAS006
      ** Calculate interest to Next Coupon Date                                               CAS006
      *                                                                                       CAS006
     C                     Z-ADDLCOUP     ZDCSDT                                              CAS006
     C                     Z-ADDNCD       ZDCEDT                                              CAS006
     C                     Z-ADDWNOML     ZAMT                                                CAS006
     C                     EXSR ZACCZ                                                         CAS006
     C                     Z-ADDZDCINT    NCDWRK                                              CAS006
      *                                                                                       CAS006
     C           LCDWRK    SUB  NCDWRK    WRKPIX                                              CAS006
      *                                                                                       CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
      ** Make interest figure a percentage                                                    CAS006
      *                                                                                       CAS006
     C           WRKPIX    DIV  WNOML     WRKPI                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
      ** Calculate Yield from last (change/amort) date                                        CAS006
      *                                                                                       CAS006
     C                     Z-ADDLAVN      ZPRICE                                              CAS006
     C                     Z-ADDLAMDAT    ZFDATE                                              CAS006
     C                     Z-ADDWNOML     ZNOML                                               CAS006
     C                     Z-ADDLAMDNA    ZIDNAT                                              CAS006
     C                     MOVE *BLANK    ZACLT                                               CAS006
     C                     EXSR ZPRCO                                                         CAS006
     C                     Z-ADDZPRCOT    YLDPRN                                              CAS006
      *                                                                                       CAS006
      ** Calculate price from yield to action date.                                           CAS006
      ** If Coupon rate = zeroes (eg. Commercial Paper) then zeroise                          CAS006
      ** WRKPI and bypass interest calcs.                                                     CAS006
      *                                                                                       CAS006
     C           CPNN      IFEQ 0                                                             CAS006
     C           SYBS      ORNE 'AU'                                                          CAS006
     C                     Z-ADD*ZEROS    WRKPI                                               CAS006
      *                                                                                       CAS006
     C                     ELSE                                                               CAS006
      *                                                                                       CAS006
      ** Obtain next coupon date for current period                                           CAS006
      *                                                                                       CAS006
     C           BCAD      ADD  1         ECD                                                 CAS006
     C                     EXSR ZNCD                                                          CAS006
      *                                                                                       CAS006
      ** Obtain last coupon date for current period                                           CAS006
      *                                                                                       CAS006
     C           NCD       SUB  1         ZECD                                                CAS006
     C                     EXSR ZLCD                                                          CAS006
     C                     Z-ADDZZLCD     LCOUP   50                                          CAS006
      *                                                                                       CAS006
      ** Determine if period Cum. or Ex                                                       CAS006
      *                                                                                       CAS006
     C                     Z-ADDBCAD      WRKD                                                CAS006
     C                     EXSR ZYCE                                                          CAS006
      *                                                                                       CAS006
      ** Calculate interest for Cum period (SCUMEX = C)                                       CAS006
      *                                                                                       CAS006
     C           SCUMEX    IFEQ 'C'                                                           CAS006
     C                     Z-ADDLCOUP     ZDCSDT                                              CAS006
     C                     Z-ADDBCAD      ZDCEDT                                              CAS006
     C                     Z-ADDWNOML     ZAMT                                                CAS006
     C                     EXSR ZACCZ                                                         CAS006
     C                     Z-ADDZDCINT    TOTACC                                              CAS006
     C                     Z-ADDZDCINT    WRKPIX                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
      ** Calculate interest for Ex period (SCUMEX = X)                                        CAS006
      *                                                                                       CAS006
     C           SCUMEX    IFEQ 'X'                                                           CAS006
      *                                                                                       CAS006
      ** Calculate interest to Action date                                                    CAS006
      *                                                                                       CAS006
     C                     Z-ADDLCOUP     ZDCSDT                                              CAS006
     C                     Z-ADDBCAD      ZDCEDT                                              CAS006
     C                     Z-ADDWNOML     ZAMT                                                CAS006
     C                     EXSR ZACCZ                                                         CAS006
     C                     Z-ADDZDCINT    ACTWRK                                              CAS006
      *                                                                                       CAS006
      ** Calculate interest to Next Coupon date                                               CAS006
      *                                                                                       CAS006
     C                     Z-ADDLCOUP     ZDCSDT                                              CAS006
     C                     Z-ADDNCD       ZDCEDT                                              CAS006
     C                     Z-ADDWNOML     ZAMT                                                CAS006
     C                     EXSR ZACCZ                                                         CAS006
     C                     Z-ADDZDCINT    NCDWRK                                              CAS006
     C           ACTWRK    SUB  NCDWRK    WRKPIX                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
      ** Make interest figure a percentage                                                    CAS006
      *                                                                                       CAS006
     C           WRKPIX    DIV  WNOML     WRKPI                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
      ** Calculate New Price from Action date                                                 CAS006
      *                                                                                       CAS006
     C                     Z-ADDYLDPRN    ZPRCIN                                              CAS006
     C                     Z-ADDBCAD      ZFDATE                                              CAS006
     C                     Z-ADDWNOML     ZNOML                                               CAS006
     C                     Z-ADD*ZERO     ZIDNAT                                              CAS006
     C                     MOVE 'Y'       ZACLT                                               CAS006
     C                     EXSR ZPRCI                                                         CAS006
      *                                                                                       CAS006
      ** Reset day number accrued to and accrual type                                         CAS006
      *                                                                                       CAS006
     C                     Z-ADD*ZERO     ZIDNAT                                              CAS006
     C                     MOVE *BLANK    ZACLT                                               CAS006
      *                                                                                       CAS006
      ** Update day number accrued to                                                         CAS006
      *                                                                                       CAS006
     C                     Z-ADDZODNAT    DNAT                                                CAS006
      *                                                                                       CAS006
      ** Calculate amount to amortise                                                         CAS006
      *                                                                                       CAS006
     C           ZPRCOT    SUB  LAVN      ZPRC                                                CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WADN                                                CAS006
      *                                                                                       CAS006
      ** Return old Event Control Date                                                        CAS006
      *                                                                                       CAS006
     C                     Z-ADDECDPRV    ECD                                                 CAS006
      *                                                                                       CAS006
     C           AAENN     ENDSR                                                              CAS006
      *****************************************************************                       CSE065
      /EJECT                                                                                  CSE065
      *****************************************************************                       CSE065
      *                                                               *                       CSE065
      *  AAMORC - Calculate amortisation for Available for sale Book  *                       CSE065
      *                                                               *                       CSE065
      *****************************************************************                       CSE065
      *                                                                                       CSE065
     C           AAMORC    BEGSR                                                              CSE065
      *                                                                                       CSE065
     C                     Z-ADDMATY      WMATY   50                                          CSE065
     C                     Z-ADDLAMDAT    WLMDAT  50                                          CSE065
     C                     Z-ADDBCAD      WBCAD   50                                          CSE065
      *                                                                                       CSE065
     C                     Z-ADD0         WWADP  130                                          CSE065
     C                     Z-ADD0         WWEDN                                               CSE065
      *                                                                                       CSE065
     C                     MOVELSESN      CSDSN                                               CSE065
     C                     MOVE 'AL'      CSDET                                               CSE065
     C                     Z-ADDZSDATE    CSDED                                               CSE065
     C           SEKEY1    SETGTSEDEVAL1                                                      CSE065
     C                     READPSEDEVAL1                 79                                   CSE065
     C           *IN79     IFEQ *ON                                                           CSE065
     C           C#SDSN    ORNE CSDSN                                                         CSE065
     C           C#SDET    ORNE 'AL'                                                          CSE065
     C           *LOCK     IN   LDA                                                           CSE065
     C                     MOVE 'SEDEVD'  DBFILE                                              CSE065
     C                     Z-ADD51        DBASE                                               CSE065
     C                     MOVEL'INIT AL' DBKEY                                               CSE065
     C                     MOVE '1'       *INU7                                               CSE065
     C                     MOVE '1'       *INU8                                               CSE065
     C                     OUT  LDA                                                           CSE065
     C                     EXSR *PSSR                                                         CSE065
     C                     MOVE '1'       *INLR                                               CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADDC#SDAL    WALDT1                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C           *IN79     DOUEQ*ON                                                           CSE065
     C           C#SDSN    ORNE CSDSN                                                         CSE065
     C           C#SDET    ORNE 'AL'                                                          CSE065
     C           C#SDED    ORGE WBCAD                                                         CSE065
      *                                                                                       CSE065
      ** Read next 'AL' record                                                                CSE065
      *                                                                                       CSE065
     C                     READ SEDEVAL1                 79                                   CSE065
      *                                                                                       CSE065
      ** If found, set the dates                                                              CSE065
      *                                                                                       CSE065
     C           *IN79     IFEQ *OFF                                                          CSE065
     C           C#SDSN    ANDEQCSDSN                                                         CSE065
     C           C#SDET    ANDEQ'AL'                                                          CSE065
     C           C#SDED    ANDLEBCAD                                                          CSE065
     C                     Z-ADDC#SDED    BCAD                                                CSE065
     C                     Z-ADDC#SDAL    WALDT2                                              CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADDWKBCAD    BCAD                                                CSE065
     C                     Z-ADDWALDT1    WALDT2                                              CSE065
     C                     ENDIF                                                              CSE065
     C                     Z-ADDWALDT1    MATY                                                CSE065
     C           WAMORT    IFEQ 'N'                                                           CSE065
     C                     EXSR AAMORN                                                        CSE065
     C                     ELSE                                                               CSE065
     C                     EXSR AAMORT                                                        CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C           WAMORT    IFEQ 'N'                                                           CSE065
     C                     ADD  WADN      WWEDN                                               CSE065
     C                     ELSE                                                               CSE065
     C                     ADD  WADP      WWADP                                               CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     Z-ADDBCAD      LAMDAT                                              CSE065
     C                     Z-ADDWALDT2    WALDT1                                              CSE065
     C                     ENDDO                                                              CSE065
      *                                                                                       CSE065
     C           WAMORT    IFEQ 'N'                                                           CSE065
     C                     Z-ADDWWEDN     WADN                                                CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADDWWADP     WADP                                                CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     Z-ADDWMATY     MATY                                                CSE065
     C                     Z-ADDWLMDAT    LAMDAT                                              CSE065
     C                     Z-ADDWBCAD     BCAD                                                CSE065
      *                                                                                       CSE065
     C                     ENDSR                                                              CSE065
      *****************************************************************                       CAS006
      /EJECT                                                                                  CAS006
     C*****************************************************************   E20085
     C*                                                                   E20085
     C*  THIS SUBROUTINE WAS MADE REDUNDANT BY E14616                     E20085
     C*                                                                   E20085
     C*  IT HAS BEEN REMOVED BY E20085                                    E20085
     C*                                                                   E20085
     C*   INT     -  SUBROUTINE TO CALCULATE INTEREST FOR PROCESSING      E20085
     C*               TYPES 1,3,5 OR 8                                    E20085
     C*                                                                   E20085
     C*****************************************************************   E20085
      /SPACE 3                                                            E20085
     C*****************************************************************   E20085
     C******THIS SUBROUTINE IS NOW REDUNDANT*****************             E20085
     C*                                                                   E20085
     C*  REDUNDANT CODE REMOVED BY E20085                                 E20085
     C*                                                                   E20085
     C* ACCRX     -  SUBROUTINE TO CALCULATE EX-COUPON ACCRUAL            E20085
     C*                                                                   E20085
     C*****************************************************************   E20085
      /EJECT
      *****************************************************************
      *                                                               *
      *  FVAL   - SUBROUTINE TO PRODUCE FACE VALUE KEYS               *
      *                                                               *
      *****************************************************************
      *
     C           FVAL      BEGSR                           ***  FVAL  ***
     C*
     C* CALCULATE FACE VALUE
     C*
     C                     Z-ADDBCNL      WFVAL
     C           PPDI      IFEQ 'Y'
     C                     MOVE BCTA      BCTA3
     C           BCTA3     DIV  100       WBCTA     H
     C***********WFVAL     MULT WBCTA     WFVAL     H                     E20086
     C                     END
      *
      ***  Calculate Trade/Position Factor Discrepancy.                   E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'
     C***********WFVAL     MULT BCCF      WFVAL     H                     E20086
     C           WFVAL     MULT BCCF      DFVAL  130H                     E20086
     C           WFVAL     MULT AAPR      XFVAL  130H                     E20086
     C           XFVAL     SUB  DFVAL     DFVAL                           E20086
     C                     END
     C*
      ***  Check whether one or two Keys are required. (Two Keys are
      ***  required where Nominal Position changes from Positive to
      ***  Negative, or vice versa OR ICD requires Negative Position).
     C*
     C           NPAC      IFEQ 'N'
     C           *IN42     OREQ '1'
     C           *IN43     OREQ '1'
     C                     MOVE '1'       *IN22
     C                     ELSE
     C                     MOVE '1'       *IN23
     C                     END
     C*
     C* OUTPUT FIRST ACCOUNT KEY FOR FACE VALUE
     C*
     C                     MOVE BCTV      EVTP
     C                     MOVE BCPS      TRTP
     C*
     C           C1DI      IFEQ 'M'
     C                     MOVE ' '       PORT
     C                     ELSE
     C                     MOVE C1DI      PORT
     C                     END
     C*
     C           TSAK      IFEQ 'Y'
     C                     MOVE BCTP      TRST
     C                     ELSE
     C                     MOVE '  '      TRST
     C                     END
     C/COPY WNCPYSRC,SE2220C117
     C*
     C           *IN22     IFEQ '1'
     C*
     C           NPSN      IFGE 0
     C           NPAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     Z-ADDWFVAL     EVAM
     C*
     C                     ELSE
     C*
     C           PNPSN     IFLT 0
     C                     MOVE 'N'       NEGI
     C                     ELSE
     C                     MOVE ' '       NEGI
     C                     END
     C*
     C           PNPSN     IFLT 0
     C           PNPSN     MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDPNPSN     EVAM
     C                     END
     C*
     C*
     C                     END
     C*
     C                     MOVE 'FV'      AMCD
     C                     MOVE TRCP      CSTN
     C                     MOVE BCTR      TRFR
     C           5         SUB  NMDP      DC
     C                     ADD  CDP       DC
     C                     MULT POWER8,DC EVAM
     C*
     C           PPDI      IFEQ 'Y'                                       E20086
     C           EVAM      MULT WBCTA     EVAM      H                     E20086
     C                     END                                            E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C154
     C           EVAM      MULT AAPR      EVAM      H                     E20086
     C                     END                                            E20086
     C/COPY WNCPYSRC,SE2220C020
      *                                                                   E20086
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C021
     C                     END
     C*
     C* OUTPUT SECOND ACCOUNT KEY IF REQUIRED TO CREATE NEW POSITION
     C*
     C           *IN23     IFEQ '1'
     C*
     C           NPSN      IFLT 0
     C                     MOVE 'N'       NEGI
     C                     ELSE
     C                     MOVE ' '       NEGI
     C                     END
     C*
     C           NPSN      IFLT 0
     C           NPSN      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDNPSN      EVAM
     C                     END
     C*
     C           5         SUB  NMDP      DC
     C                     ADD  CDP       DC
     C                     MULT POWER8,DC EVAM
     C*
     C           PPDI      IFEQ 'Y'                                       E20086
     C           EVAM      MULT WBCTA     EVAM      H                     E20086
     C                     END                                            E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C155
     C           EVAM      MULT AAPR      EVAM      H                     E20086
     C                     END                                            E20086
      *                                                                   E20086
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C022
     C                     END
     C/COPY WNCPYSRC,SE2220C074
     C                     END
      *                                                                   E20086
      ***  Post Factor Difference Amount.                                 E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C                     MOVE 'FD'      AMCD                            E20086
     C                     Z-ADDDFVAL     EVAM                            E20086
     C           EVAM      IFNE 0                                         E20086
     C                     EXSR W01                                       E20086
     C/COPY WNCPYSRC,SE2220C023
     C                     END                                            E20086
     C                     END                                            E20086
     C*                                                                   E29236
     C* Calculate partly paid face value for use in P10                   E29236
     C*                                                                   E29236
     C           PPDI      IFEQ 'Y'                                       E29236
     C           WFVAL     MULT WBCTA     WFVAL     H                     E29236
     C                     END                                            E29236
     C*
     C           EFVAL     ENDSR                           *** EFVAL  ***
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  CONS   - SUBROUTINE TO PRODUCE CONSIDERATION KEYS            *
      *                                                               *
      *****************************************************************
      *
     C           CONS      BEGSR                           ***  CONS  ***
     C*
      ***  Check whether one or two Keys are required. (Two Keys are
      ***  required where Nominal Position changes from Positive to
      ***  Negative, or vice versa OR ICD requires Negative Position).
     C*
     C                     MOVEA'00'      *IN,22
     C           NPAC      IFEQ 'N'
     C           *IN42     OREQ '1'
     C           *IN43     OREQ '1'
     C                     MOVE '1'       *IN22
     C                     ELSE
     C                     MOVE '1'       *IN23
     C                     END
     C*
     C* OUTPUT FIRST ACCOUNT KEY FOR CONSIDERATION
     C*
     C                     MOVE BCTV      EVTP
     C                     MOVE BCPS      TRTP
     C*
     C           C1DI      IFEQ 'M'
     C                     MOVE ' '       PORT
     C                     ELSE
     C                     MOVE C1DI      PORT
     C                     END
     C*
     C           TSAK      IFEQ 'Y'
     C                     MOVE BCTP      TRST
     C                     ELSE
     C                     MOVE '  '      TRST
     C                     END
      *                                                                                       246619
      ** Calculate consideration 'CO' using contract price if                                 246619
      ** different from trade price and NPAC = 'Y'.                                           246619
      *                                                                                       246619
     C           CNTP      IFNE BCTD                                                          246619
     C           NPAC      ANDEQ'Y'                                                           246619
     C                     Z-ADDBCNL      ZNOML                                               246619
     C                     Z-ADDCNTP      ZPRC                                                246619
     C                     EXSR ZCNSD                                                         246619
     C                     Z-ADDZCONS     WZCONS 150                                          246619
     C                     MOVE 'Y'       WZPRIC                                              246619
     C                     ELSE                                                               246619
     C                     MOVE 'N'       WZPRIC  1                                           246619
     C                     ENDIF                                                              246619
      *                                                                   E20086
      ***  Calculate Position Consideration and Factor Difference.        E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C187
     C           WZPRIC    IFEQ 'Y'                                                           246619
     C***        WZCONS    MULT AAPR      EVAM      H                                  246619 247279
     C           WZCONS    MULT AAPR      XCONS  150H                                         247279
     C           WZCONS    MULT BCCF      DCONS  150H                                         246619
     C                     ELSE                                                               246619
     C***        BCCN      MULT AAPR      EVAM      H              E20086 247279
     C           BCCN      MULT AAPR      XCONS  150H                     247279
     C           BCCN      MULT BCCF      DCONS  150H                     E20086
     C                     ENDIF                                                              246619
     C***        EVAM      SUB  DCONS     DCONS                    E20086 247279
     C           DCONS     SUB  XCONS     DCONS                           247279
     C                     END                                            E20086
     C/COPY WNCPYSRC,SE2220C116
     C*
     C           *IN22     IFEQ '1'
     C*
     C           NPSN      IFGE 0
     C           NPAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C           PROT      IFNE '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C188
     C           WZPRIC    IFEQ 'Y'                                                           246619
     C                     Z-ADDWZCONS    EVAM                                                246619
     C                     ELSE                                                               246619
     C                     Z-ADDBCCN      EVAM
     C                     ENDIF                                                              246619
     C                     END                                            E20086
     C*
     C                     ELSE
     C*
     C           PNPSN     IFLT 0
     C                     MOVE 'N'       NEGI
     C                     ELSE
     C                     MOVE ' '       NEGI
     C                     END
     C*
     C                     Z-ADD*ZEROS    WCONS  150
     C                     Z-ADD*ZEROS    WCONSN 150                                          CAS006
     C***********          Z-ADD*ZEROS    WCONS0 150                      E20232
     C***********          Z-ADD*ZEROS    WCONS1 151                      E20232
     C***********          Z-ADD*ZEROS    WCONS2 152                      E20232
     C***********          Z-ADD*ZEROS    WCONS3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C*
     C***70******LAVP      MULT PNPSN     WCONS0    H                     E15442
     C***71******LAVP      MULT PNPSN     WCONS1    H                     E15442
     C***72******LAVP      MULT PNPSN     WCONS2    H                     E15442
     C***73******LAVP      MULT PNPSN     WCONS3    H                     E15442
     C***********                                                  E15442 E20232
     C***70******CNTP      MULT PNPSN     WCONS0    H              E15442 E20232
     C***71******CNTP      MULT PNPSN     WCONS1    H              E15442 E20232
     C***72******CNTP      MULT PNPSN     WCONS2    H              E15442 E20232
     C***73******CNTP      MULT PNPSN     WCONS3    H              E15442 E20232
     C***********                                                         E20232
     C***70******          MOVE WCONS0    WCONS                           E20232
     C***71******          MOVE WCONS1    WCONS                           E20232
     C***72******          MOVE WCONS2    WCONS                           E20232
     C***73******          MOVE WCONS3    WCONS                           E20232
     C*
     C* Convert event amount for Nominal Dec Places
     C***********5         SUB  NMDP      DC                              E20232
     C***********WCONS     MULT POWER8,DC WCONS     H                     E20232
     C                     Z-ADDPNPSN     ZNOML                           E20232
     C                     Z-ADDCNTP      ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     WCONS                           E20232
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDPNPSN     ZNOML                                               CAS006
     C                     Z-ADDCNTN      ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WCONSN                                              CAS006
     C                     ENDIF                                                              CAS006
     C*
     C**If*Price*Basis*'P',*divide*by*100******************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********WCONS     DIV  100       WCONS     H                     E20232
     C***********          END                                            E20232
     C*
     C           PROT      IFEQ '8'
     C/COPY WNCPYSRC,SE2220C156
     C***********WCONS     MULT CFCT      WCONS     H                     E20086
     C           WCONS     MULT AAPR      WCONS     H                     E20086
     C                     END
     C*
     C                     Z-ADDWCONS     EVAM
     C*
     C           EVAM      IFLT 0
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C                     END
     C*
     C           WZPRIC    IFEQ 'Y'                                       247279
     C                     Z-ADDWZCONS    EVAM                            247279
     C                     ELSE                                           247279
     C                     Z-ADDBCCN      EVAM                            247279
     C                     END                                            247279
     C                     MOVE 'CO'      AMCD
     C                     MOVE TRCP      CSTN
     C                     MOVE BCTR      TRFR
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C024
     C                     END
     C*
     C*  If PROT  = 8   BCNN already used the current factor so need to find back             248281
     C*                 the conideration amount with AAPR                                     248281
     C**********           Z-ADDBCCN      WCONS                                               248281
     C                     Z-ADDBCNL      ZNOML                                               248281
     C                     Z-ADDBCTD      ZPRC                                                248281
     C                     EXSR ZCNSD                                                         248281
     C                     Z-ADDZCONS     WCONS     H                                         248281
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C**********           Z-ADDBCCN      WCONSN                                       CAS006 248281
     C                     Z-ADDWCONS     WCONSN                                              248281
     C                     ENDIF                                                              CAS006
     C*
     C* OUTPUT SECOND ACCOUNT KEY IF REQUIRED TO POST NEW POSITION
     C*
     C           *IN23     IFEQ '1'
     C*
     C           NPSN      IFLT 0
     C                     MOVE 'N'       NEGI
     C                     ELSE
     C                     MOVE ' '       NEGI
     C                     END
     C*
     C                     Z-ADD*ZEROS    WCONS  150
     C                     Z-ADD*ZEROS    WCONSN                                              CAS006
     C***********          Z-ADD*ZEROS    WCONS0 150                      E20232
     C***********          Z-ADD*ZEROS    WCONS1 151                      E20232
     C***********          Z-ADD*ZEROS    WCONS2 152                      E20232
     C***********          Z-ADD*ZEROS    WCONS3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******NPSN      MULT CNTP      WCONS0    H                     E20232
     C***71******NPSN      MULT CNTP      WCONS1    H                     E20232
     C***72******NPSN      MULT CNTP      WCONS2    H                     E20232
     C***73******NPSN      MULT CNTP      WCONS3    H                     E20232
     C***********                                                         E20232
     C***70******          MOVE WCONS0    WCONS                           E20232
     C***71******          MOVE WCONS1    WCONS                           E20232
     C***72******          MOVE WCONS2    WCONS                           E20232
     C***73******          MOVE WCONS3    WCONS                           E20232
     C*
     C* Convert event amount for Nominal Dec Places
     C***********5         SUB  NMDP      DC                              E20232
     C***********WCONS     MULT POWER8,DC WCONS     H                     E20232
     C                     Z-ADDNPSN      ZNOML                           E20232
     C                     Z-ADDCNTP      ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     WCONS                           E20232
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     Z-ADDCNTN      ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WCONSN                                              CAS006
     C                     ENDIF                                                              CAS006
     C*
     C**If*Price*Basis*'P',*divide*by*100******************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********WCONS     DIV  100       WCONS                           E15442
     C***********WCONS     DIV  100       WCONS     H              E15442 E20232
     C***********          END                                            E20232
     C*
     C           PROT      IFEQ '8'
     C/COPY WNCPYSRC,SE2220C157
     C***********WCONS     MULT CFCT      WCONS     H                     E20086
     C           WCONS     MULT AAPR      WCONS     H                     E20086
     C                     END
     C*
     C                     Z-ADDWCONS     EVAM
     C*
     C           EVAM      IFLT 0
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C025
     C                     END
     C*
     C                     END
     C*
     C*  If PROT  = 8   BCNN already used the current factor so need to find back             248281
     C*                 the conideration amount with AAPR                                     248281
     C**********           Z-ADDBCCN      WCONS                                        E20086 248281
     C                     Z-ADDBCNL      ZNOML                                               248281
     C                     Z-ADDBCTD      ZPRC                                                248281
     C                     EXSR ZCNSD                                                         248281
     C                     Z-ADDZCONS     WCONS     H                                         248281
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C**********           Z-ADDBCCN      WCONSN                                       CAS006 248281
     C                     Z-ADDWCONS     WCONSN                                              248281
     C                     ENDIF                                                              CAS006
     C***********                                                  E15442 E20086
      *** Calculation Removed. BCCN = Trade Consideration (Unfactored).   E20086
     C**CALCULATE*TRADE*CONSIDERATION                              E15442 E20086
     C***********                                                  E15442 E20086
     C***********          Z-ADD*ZEROS    WCONS                    E15442 E20086
     C***********          Z-ADD*ZEROS    WCONS0                   E15442 E20086
     C***********          Z-ADD*ZEROS    WCONS1                   E15442 E20086
     C***********          Z-ADD*ZEROS    WCONS2                   E15442 E20086
     C***********          Z-ADD*ZEROS    WCONS3                   E15442 E20086
     C***********          MOVEA'0000'    *IN,70                   E15442 E20086
     C***********70        ADD  CDP       J                        E15442 E20086
     C***********          MOVEA'1'       *IN,J                    E15442 E20086
     C***********                                                  E15442 E20086
     C***70******BCNL      MULT CNTP      WCONS0    H              E15442 E20086
     C***71******BCNL      MULT CNTP      WCONS1    H              E15442 E20086
     C***72******BCNL      MULT CNTP      WCONS2    H              E15442 E20086
     C***73******BCNL      MULT CNTP      WCONS3    H              E15442 E20086
     C***********                                                  E15442 E20086
     C***70******          MOVE WCONS0    WCONS                    E15442 E20086
     C***71******          MOVE WCONS1    WCONS                    E15442 E20086
     C***72******          MOVE WCONS2    WCONS                    E15442 E20086
     C***73******          MOVE WCONS3    WCONS                    E15442 E20086
     C***********                                                  E15442 E20086
     C***********5         SUB  NMDP      DC                       E15442 E20086
     C***********WCONS     MULT POWER8,DC WCONS     H              E15442 E20086
     C***********                                                  E15442 E20086
     C***********SPBS      IFEQ 'P'                                E15442 E20086
     C***********WCONS     DIV  100       WCONS     H              E15442 E20086
     C***********          END                                     E15442 E20086
     C***********                                                  E15442 E20086
     C***********PROT      IFEQ '8'                                E15442 E20086
     C***********WCONS     MULT CFCT      WCONS     H              E15442 E20086
     C***********          END                                     E15442 E20086
     C*
      ***  Post Factor Difference Amount.                                 E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C196
     C                     MOVE 'CD'      AMCD                            E20086
     C                     Z-ADDDCONS     EVAM                            E20086
     C           EVAM      IFNE 0                                         E20086
     C                     EXSR W01                                       E20086
     C/COPY WNCPYSRC,SE2220C026
     C                     END                                            E20086
     C                     END                                            E20086
      *                                                                   E20086
     C           ECONS     ENDSR                           *** ECONS  ***
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  CLOSE  - SUBROUTINE TO ACCESS HISTORIC TRADE ACTIONS FOR     *
      *           FIFO ACCOUNTING                                     *
      *                                                               *
      *****************************************************************
      *
     C           CLOSE     BEGSR                           *** CLOSE  ***
     C*
      ***  Store current Action record so that fields may temporarily
      ***  be used by chain to HTRACT.
     C*
     C                     MOVELRECIN     STREC
     C*
     C* CLEAR INCREMENT FIELDS FOR ACCUMULATION
     C*
     C                     Z-ADD0         APINC  150
     C                     Z-ADD0         APINN  150                                          CAS006
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C                     Z-ADD0         APCST  150                      E22957
     C************IN39     IFEQ '1'                                S01486 CPM004
     C                     Z-ADD0         FXINC  150                      S01486
     C***********          END                                     S01486 CPM004
     C                     Z-ADD0         RPLINC 150
     C                     Z-ADD0         OSNOM  150
     C                     Z-ADD0         WKCNTP 158
      *                                                                   E20087
      ***  Set up accumulator for 'Unamortized Discount/Premium           E20087
      ***  Liquidated'.                                                   E20087
     C                     Z-ADD0         UDPLIQ 150                      E20087
      **********                                                                  MD031745 MD031745A
     C**********           Z-ADD0         WWAVPR 158                              MD031745 MD031745A
      **********                                                                  MD031745 MD031745A
     C********** CSE105    IFEQ 'Y'                                               MD031745 MD031745A
     C********** SESVAL    ANDEQ'B'                                               MD031745 MD031745A
     C********** CSE105    OREQ 'Y'                                               MD031745 MD031745A
     C********** SESVAL    ANDEQBCTV                                              MD031745 MD031745A
     C**********           Z-ADDPNPSN     ZNOML                                   MD031745 MD031745A
     C**********           Z-ADDAPNC      ZAPNC                                   MD031745 MD031745A
     C**********           EXSR ZAVPR                                             MD031745 MD031745A
     C**********           Z-ADDZPRC      WWAVPR    H                             MD031745 MD031745A
     C**********           ENDIF                                                  MD031745 MD031745A
     C*
     C* ACCESS HISTORIC TRADE ACTIONS BY TRADE
     C*
     C                     MOVE BHTR      KBHTR
     C*
     C                     MOVEA'000'     *IN,04                          S01129
     C           HTTKEY    CHAINHTRACT               87
     C           *IN87     IFEQ '1'
     C                     SETON                     U7U8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'HTRAC'   DBFILE           ***************
     C***********          MOVELBHTR      KEY7    7        **DB*ERROR*17**E20651
     C                     MOVELBHTR      KEY7    7        * DB ERROR 20 *E20651
     C                     MOVE BHTV      KEY7             ***************
     C                     MOVELKEY7      DBKEY
     C***********          Z-ADD17        DBASE                           E20651
     C                     Z-ADD20        DBASE                           E20651
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO ECLOSE
     C                     END
     C*
     C                     EXCPTRELACT                                    S01129
      *                                                                   E20087
      ***  For discounted instruments, historic price used for realized   E20087
      ***  P/L calculations must reflect discount already amortized.      E20087
      ***  This is achieved by converting the historic percentage price   E20087
      ***  into a discount rate, then converting the result back into a   E20087
      ***  percentage price as of the VALUE date of the liquidation.      E20087
      ***  Use Contract Prices if Position is Non-Discounted, or if       E20087
      ***  Value Dates of Historic Trade and Liquidation are the same.    E20087
      *                                                                   E20087
     C                     Z-ADDHCNTP     HSTPRC 158                      E21113
     C                     Z-ADDCNTP      CNTPRC 158                      E21113
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDHCNTN     HSTPRN 158                                          CAS006
     C                     Z-ADDCNTN      CNTPRN 158                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                   E21113
     C           MATY      IFNE 99999                                     E21113
     C           STAD      IFEQ 'Y'                                       E21113
     C           STAD      OREQ 'C'                                       E21113
     C/COPY WNCPYSRC,SE2220C230
     C           STBS      OREQ 'D'                                       E21113
     C           GDPK      ANDEQ'Y'                                       E21113
     C/COPY WNCPYSRC,SE2220C185
      *                                                                   E21113
     C***********STBS      IFNE 'D'                                E20087 E21113
     C***********BCTV      OREQ 'V'                                E20087 E21113
     C***********BCAD      ANDEQHBCAD                              E20087 E21113
     C***********BCTV      OREQ 'T'                                E20087 E20552
     C***********BCOT      ANDEQHBCOT                              E20087 E20552
     C***********          Z-ADDHCNTP     HSTPRC 158               E20087 E21113
     C***********          Z-ADDCNTP      CNTPRC 158               E20087 E21113
     C***********          ELSE                                    E20087 E21113
      *                                                                   E20087
      ***  For a Discounted Value Date Position, convert the Historic     E20087
      ***  Price to a Discount Rate, then back to a Percentage Price      E20087
      ***  as at the Value Date of the Liquidation.                       E20087
      *                                                                   E20087
     C           BCTV      IFEQ 'V'                                       E20087
     C           BCAD      ANDNEHBCAD                                     E21113
     C                     Z-ADDHCNTP     ZPRICE                          E20087
     C                     Z-ADDHBCAD     ZFDATE                          E20087
     C                     EXSR ZPRCO                                     E20087
     C                     Z-ADDZPRCOT    ZPRCIN                          E20087
     C                     Z-ADDBCAD      ZFDATE                          E20087
     C                     EXSR ZPRCI                                     E20087
     C                     Z-ADDZPRCOT    HSTPRC                          E20087
     C                     Z-ADDCNTP      CNTPRC                          E20087
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDHCNTN     ZPRICE                                              CAS006
     C                     Z-ADDHBCAD     ZFDATE                                              CAS006
     C                     EXSR ZPRCO                                                         CAS006
     C                     Z-ADDZPRCOT    ZPRCIN                                              CAS006
     C                     Z-ADDBCAD      ZFDATE                                              CAS006
     C                     EXSR ZPRCI                                                         CAS006
     C                     Z-ADDZPRCOT    HSTPRN                                              CAS006
     C                     Z-ADDCNTN      CNTPRN                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END                                            E21113
     C***********          ELSE                                    E20087 E20552
      ***********                                                  E20087 E20552
      *****For*a*Discounted*Trade*Date*Position*both*Prices*should E20087 E20552
      *****reflect*the*LATER*Value*Date,*whether*this*is*the*Value*Date 7 E20552
      *****of*the*Historic*Trade*or*the*Liquidation.*This*check*is E20087 E20552
      *****necessary*because*Trade*Dates*and*Value*Dates*may*not*be*in 87 E20552
      *****the*same*sequence.************************************* E20087 E20552
      ***********                                                  E20087 E20552
     C***********HBCOT     IFLT BCOT                               E20087 E20552
      ***********                                                  E20087 E20552
      *****Historic*Trade*is*Valued*earlier,*so*adjust*its*Price.* E20087 E20552
      ***********                                                  E20087 E20552
     C***********          Z-ADDHCNTP     ZPRICE                   E20087 E20552
     C***********          Z-ADDHBCOT     ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCO                              E20087 E20552
     C***********          Z-ADDZPRCOT    ZPRCIN                   E20087 E20552
     C***********          Z-ADDBCOT      ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCI                              E20087 E20552
     C***********          Z-ADDZPRCOT    HSTPRC                   E20087 E20552
     C***********          Z-ADDCNTP      CNTPRC                   E20087 E20552
     C***********          ELSE                                    E20087 E20552
      ***********                                                  E20087 E20552
      *****Liquidation*is*Valued*earlier,*so*adjust*its*Price.**** E20087 E20552
      ***********                                                  E20087 E20552
     C***********          Z-ADDCNTP      ZPRICE                   E20087 E20552
     C***********          Z-ADDBCOT      ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCO                              E20087 E20552
     C***********          Z-ADDZPRCOT    ZPRCIN                   E20087 E20552
     C***********          Z-ADDHBCOT     ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCI                              E20087 E20552
     C***********          Z-ADDZPRCOT    CNTPRC                   E20087 E20552
     C***********          Z-ADDHCNTP     HSTPRC                   E20087 E20552
     C***********          END                                     E20087 E20552
     C                     END                                            E20087
     C                     END                                            E20087
      *                                                                                    MD031745A
      ** Recalculate Premium/Discount based on FIFO trade                                  MD031745A
      *                                                                                    MD031745A
     C                     Z-ADDHBCNL     ZNOML                                            MD031745A
     C                     Z-ADDHSTPRC    ZPRC                                             MD031745A
     C                     EXSR ZCNSD                                                      MD031745A
     C                     Z-ADDZCONS     WPCON  150                                       MD031745A
      *                                                                                    MD031745A
     C           SPBS      IFEQ 'P'                                                        MD031745A
     C                     Z-ADD100       ZPRC                                             MD031745A
     C                     ELSE                                                            MD031745A
     C                     Z-ADD1         ZPRC                                             MD031745A
     C                     ENDIF                                                           MD031745A
      *                                                                                    MD031745A
     C                     EXSR ZCNSD                                                      MD031745A
     C                     Z-ADDZCONS     WBCON  150                                       MD031745A
      *                                                                                    MD031745A
      ** Premium / Discount equal Consideration minus Nominal                              MD031745A
      ** This premium/discount per trade is used in computing amortised                    MD031745A
      ** amount to be added to sale cost.                                                  MD031745A
      *                                                                                    MD031745A
     C           WPCON     SUB  WBCON     WPRDS  150                                       MD031745A
      *
      *---------------------------------------------------------------*
      * FOR FIFO REMAINING NOMINAL GREATER THAN CURRENT TRADE NOMINAL *
      *---------------------------------------------------------------*
      *
     C           BHRN      IFGT BCNL
     C/COPY WNCPYSRC,SE2220C170
     C*
     C*   - CALCULATE INCREMENT TO AP NUMERATOR
     C*
     C                     Z-ADD*ZEROS    WBCCN  150
     C                     Z-ADD*ZEROS    WBCNN  150                                          CAS006
     C***********          Z-ADD*ZEROS    WBCCN0 150                      E20232
     C***********          Z-ADD*ZEROS    WBCCN1 151                      E20232
     C***********          Z-ADD*ZEROS    WBCCN2 152                      E20232
     C***********          Z-ADD*ZEROS    WBCCN3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******BCNL      MULT HCNTP     WBCCN0    H                     E20087
     C***71******BCNL      MULT HCNTP     WBCCN1    H                     E20087
     C***72******BCNL      MULT HCNTP     WBCCN2    H                     E20087
     C***73******BCNL      MULT HCNTP     WBCCN3    H                     E20087
     C***70******BCNL      MULT HSTPRC    WBCCN0    H              E20087 E20232
     C***71******BCNL      MULT HSTPRC    WBCCN1    H              E20087 E20232
     C***72******BCNL      MULT HSTPRC    WBCCN2    H              E20087 E20232
     C***73******BCNL      MULT HSTPRC    WBCCN3    H              E20087 E20232
     C***********                                                         E20232
     C***70******          MOVE WBCCN0    WBCCN  150                      E20232
     C***71******          MOVE WBCCN1    WBCCN                           E20232
     C***72******          MOVE WBCCN2    WBCCN                           E20232
     C***73******          MOVE WBCCN3    WBCCN                           E20232
     C***********                                                         E20232
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********          MULT POWER8,DC WBCCN     H                     E20232
     C                     Z-ADDBCNL      ZNOML                           E20232
     C                     Z-ADDHSTPRC    ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     WBCCN                           E20232
     C*
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       WBCCN     H                     E20232
     C***********          END                                            E20232
     C***********                                                         E20232
     C***********PROT      IFEQ '8'                                       E20086
     C***********          MULT HBCCF     WBCCN     H                     E20086
     C***********          END                                            E20086
     C*
     C                     ADD  WBCCN     APINC
      *                                                                                    MD031745A
      ** Get the Amortised Amount proportion to Sale Nominal                               MD031745A
      *                                                                                    MD031745A
     C                     EXSR TAMOR                                                      MD031745A
      *                                                                                    MD031745A
     C           BCNL      DIV  HBCNL     WWAM   159H                                      MD031745A
     C           WWAM      MULT WTAMOR    WWPL   150H                                      MD031745A
      *                                                                                    MD031745A
     C                     SUB  WWPL      APINC                                            MD031745A
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDBCNL      ZNOML                                               CAS006
     C                     Z-ADDHSTPRN    ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WBCNN                                               CAS006
      *                                                                                       CAS006
     C**********           ADD  WBCCN     APINN                                        CAS006 248281
     C                     ADD  WBCNN     APINN                                               248281
     C                     ENDIF                                                              CAS006
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C                     ADD  HBCCN     APCST                           E22957
     C*                                                                   E22957
     C*
     C***********RBAP      IFEQ 'Y'                                       E20018
     C***********          ADD  BCRA      APINC                           E20018
     C***********          ADD  REALLW    APINC                           E20018
     C***********          END                                            E20018
     C***********COBP      IFEQ 'Y'                                       E20018
     C***********          ADD  BCCC      APINC                           E20018
     C***********          ADD  HBCCC     APINC                           E20018
     C***********          END                                            E20018
     C***********CBAP      IFEQ 'Y'                                       E20018
     C***********          ADD  BCCT      APINC                           E20018
     C***********          ADD  HBCCT     APINC                           E20018
     C***********          END                                            E20018
     C*
     C* For sale, amount should be negative
     C*
     C           HBCPS     IFEQ 'S'
     C                     Z-SUBAPINC     APINC
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-SUBAPINN     APINN                                               CAS006
     C                     ENDIF                                                              CAS006
     C                     END
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C                     Z-SUBAPCST     APCST                           E22957
     C***********                                                         E20086
     C**If*processing*type*8,*divide*amount*by*current*factor**********   E20086
     C***********                                                         E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********          DIV  HBCCF     APINC                           E20086
     C***********          END                                            E20086
     C*
     C*   - CALCULATE INCREMENT TO REALISED PROFIT/LOSS
     C*
     C***********CNTP      SUB  HCNTP     WKCNTP                          E20087
     C***********CNTPRC    SUB  HSTPRC    WKCNTP                   E20087 E22957
     C***********          Z-ADD*ZEROS    WRPL0  150                      E20232
     C***********          Z-ADD*ZEROS    WRPL1  151                      E20232
     C***********          Z-ADD*ZEROS    WRPL2  152                      E20232
     C***********          Z-ADD*ZEROS    WRPL3  153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******BCNL      MULT WKCNTP    WRPL0     H                     E20232
     C***71******BCNL      MULT WKCNTP    WRPL1     H                     E20232
     C***72******BCNL      MULT WKCNTP    WRPL2     H                     E20232
     C***73******BCNL      MULT WKCNTP    WRPL3     H                     E20232
     C***********                                                         E20232
     C***70******          MOVE WRPL0     WRPL   150                      E20232
     C***71******          MOVE WRPL1     WRPL                            E20232
     C***72******          MOVE WRPL2     WRPL                            E20232
     C***73******          MOVE WRPL3     WRPL                            E20232
     C*
     C* Convert Realised P/L Amount
     C*
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********          MULT POWER8,DC WRPL      H                     E20232
     C***********          Z-ADDBCNL      ZNOML                    E20232 E22957
     C***********          Z-ADDWKCNTP    ZPRC                     E20232 E22957
     C***********          EXSR ZCNSD                              E20232 E22957
     C***********          Z-ADDZCONS     WRPL   150               E20232 E22957
     C*
     C**If*Price*Basis*'P',*divide*by*100******************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       WRPL      H                     E20232
     C***********          END                                            E20232
     C*
     C***********PROT      IFEQ '8'                                       E22957
     C***********          MULT CFCT      WRPL      H                     E20086
     C***********          MULT AAPR      WRPL      H              E20086 E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C**If*historic trade is sale, reverse sign                           E22957
     C***********                                                         E22957
     C***********HBCPS     IFEQ 'S'                                       E22957
     C***********          Z-SUBWRPL      WRPL                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          ADD  WRPL      RPLINC                          E22957
      *                                                                   E20085
      *** Calculate POSN Purch Int on a FIFO basis                        E20085
      *                                                                   E20085
     C           HPCHI     IFNE 0                                         E20085
     C           HACRI     ANDNE'X'                                       E20085
     C           XXLCCP    ANDEQLCCP                                      E20085
      *                                                                   E20085
     C***********BCNL      DIV  1000000   BCNLY                    E20085 E22957
     C***********BCNLY     MULT HPCHI     WSTOT                    E20085 E22957
     C***********WSTOT     DIV  HBCNL     EVAMY                    E20085 E22957
     C***********EVAMY     MULT 1000000   WSTOT                    E20085 E22957
     C***********                                                  E20085 E22957
     C***********          Z-ADDWSTOT     WBCP1                    E20085 E22957
     C                     Z-ADDHPCHI     ZAPIN                           E22957
     C                     Z-ADDBCNL      ZNPSN                           E22957
     C                     Z-ADDHBCNL     ZPNPSN                          E22957
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    WBCP1                           E22957
     C                     ELSE                                           E20085
     C                     Z-ADD0         WBCP1                           E20085
     C                     END                                            E20085
      *                                                                   E20085
     C*****Calculate*the*change*to*Unamortized*Discount/Premium*on*E20085 E22957
     C*****a*FIFO*Basis.*************                              E20085 E22957
     C***********                                                  E21113 E22957
     C***********MATY      IFNE 99999                              E21113 E22957
     C***********STAD      IFEQ 'Y'                                E21113 E22957
     C***********STAD      OREQ 'C'                                E21113 E22957
     C***********STBS      OREQ 'D'                                E21113 E22957
     C***********GDPK      ANDEQ'Y'                                E21113 E22957
     C***********                                                  E21113 E22957
     C***********STBS      IFEQ 'D'                                E20085 E21113
     C***********                                                  E20085 E22957
     C*****Determine Current Discount/Premium %age on Historic Trade.0085 E22957
     C***********100       SUB  HSTPRC    HDPPCT 158               E20085 E22957
     C***********                                                  E20085 E22957
      *****Adjust*for*Percentage*Pricing*and*Currency*Decimal*Places.0085 E20149
      *****(Start*Index*at*3*rather*than*5*to*adjust*for*%age*Prices).085 E20149
     C***********3         ADD  CDP       DC                       E20085 E20149
     C***********          MULT POWER8,DC HDPPCT    H              E20085 E20149
     C***********                                                  E20085 E22957
     C*****Calculate remaining Discount/Premium on Liquidated AmounE20085 E22957
     C*****(using ZCNSD to get an adjusted figure)                 E20149 E22957
     C***********HDPPCT    MULT BCNL      WKDPLQ 150H              E20085 E20149
     C***********                                                  E20085 E22957
     C***********          Z-ADDBCNL      ZNOML                    E20149 E22957
     C***********          Z-ADDHDPPCT    ZPRC                     E20149 E22957
     C***********          EXSR ZCNSD                              E20149 E22957
     C***********          Z-ADDZCONS     WKDPLQ 150               E20149 E22957
     C***********          ADD  WKDPLQ    UDPLIQ                   E20085 E22957
     C***********          END                                     E20085 E22957
     C***********          END                                     E21113 E22957
     C*
     C*   - CALCULATE NEW FIFO REMAINING NOMINAL
     C*        (1ST TRADE REF FIELD UNCHANGED)
     C*
     C           BHRN      SUB  BCNL      BHRN
     C*                                                                   S01486
     C** If Portfolio Management is present                               S01486
     C*                                                                   S01486
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01486
     C* CALCULATE FX AP INCREMENT & LATEST FX AVERAGE PRICE               S01486
     C*                                                                   S01486
     C           BCNL      DIV  HBCNL     WFACT                           S01486
     C           WFACT     MULT HCFAP     FXINC                           S01486
     C           HBCPS     IFEQ 'S'                                       S01486
     C                     Z-SUBFXINC     FXINC                           S01486
     C                     END                                            S01486
     C           LFXP      SUB  FXINC     LFXP                            S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C*
     C                     GOTO ECLOSE
     C                     END
      *
      *---------------------------------------------------------------*
      * FOR FIFO REMAINING NOMINAL EQUAL TO CURRENT TRADE NOMINAL     *
      *---------------------------------------------------------------*
      *
     C           BHRN      IFEQ BCNL
     C*
     C*   - CALCULATE INCREMENT TO AP NUMERATOR
     C/COPY WNCPYSRC,SE2220C171
     C*
     C                     Z-ADD*ZEROS    WBCCN  150
     C***********          Z-ADD*ZEROS    WBCCN0 150                      E20232
     C***********          Z-ADD*ZEROS    WBCCN1 151                      E20232
     C***********          Z-ADD*ZEROS    WBCCN2 152                      E20232
     C***********          Z-ADD*ZEROS    WBCCN3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******BCNL      MULT HCNTP     WBCCN0    H                     E20087
     C***71******BCNL      MULT HCNTP     WBCCN1    H                     E20087
     C***72******BCNL      MULT HCNTP     WBCCN2    H                     E20087
     C***73******BCNL      MULT HCNTP     WBCCN3    H                     E20087
     C***70******BCNL      MULT HSTPRC    WBCCN0    H              E20087 E20232
     C***71******BCNL      MULT HSTPRC    WBCCN1    H              E20087 E20232
     C***72******BCNL      MULT HSTPRC    WBCCN2    H              E20087 E20232
     C***73******BCNL      MULT HSTPRC    WBCCN3    H              E20087 E20232
     C***********                                                         E20232
     C***70******          MOVE WBCCN0    WBCCN  150                      E20232
     C***71******          MOVE WBCCN1    WBCCN                           E20232
     C***72******          MOVE WBCCN2    WBCCN                           E20232
     C***73******          MOVE WBCCN3    WBCCN                           E20232
     C***********                                                         E20232
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********          MULT POWER8,DC WBCCN     H                     E20232
     C                     Z-ADDBCNL      ZNOML                           E20232
     C                     Z-ADDHSTPRC    ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     WBCCN                           E20232
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDBCNL      ZNOML                                               CAS006
     C                     Z-ADDHSTPRN    ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WBCNN                                               CAS006
     C                     ADD  WBCNN     APINN                                               CAS006
     C                     ENDIF                                                              CAS006
     C*
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       WBCCN     H                     E20232
     C***********          END                                            E20232
     C***********                                                         E20232
     C***********PROT      IFEQ '8'                                       E20086
     C***********          MULT HBCCF     WBCCN     H                     E20086
     C***********          END                                            E20086
     C*
     C                     ADD  WBCCN     APINC
      *                                                                                    MD031745A
     C                     Z-ADDBCNL      ZNOML                                            MD031745A
     C                     Z-ADDHSTPRC    ZPRC                                             MD031745A
     C                     EXSR ZCNSD                                                      MD031745A
     C                     Z-ADDZCONS     WPCON                                            MD031745A
      *                                                                                    MD031745A
     C           SPBS      IFEQ 'P'                                                        MD031745A
     C                     Z-ADD100       ZPRC                                             MD031745A
     C                     ELSE                                                            MD031745A
     C                     Z-ADD1         ZPRC                                             MD031745A
     C                     ENDIF                                                           MD031745A
      *                                                                                    MD031745A
     C                     EXSR ZCNSD                                                      MD031745A
     C                     Z-ADDZCONS     WBCON                                            MD031745A
      *                                                                                    MD031745A
     C           WPCON     SUB  WBCON     WPRDS  150                                       MD031745A
      *                                                                                    MD031745A
     C                     EXSR TAMOR                                                      MD031745A
      *                                                                                    MD031745A
     C           BCNL      DIV  BHRN      WWAM   159H                                      MD031745A
     C           WWAM      MULT WTAMOR    WWPL   150H                                      MD031745A
      *                                                                                    MD031745A
     C                     SUB  WWPL      APINC                                            MD031745A
     C*                                                                   E22957
     C*** Maintain Original Cost                                          E22957
     C*                                                                   E22957
     C                     ADD  HBCCN     APCST                           E22957
     C*
     C***********RBAP      IFEQ 'Y'                                       E20018
     C***********          ADD  BCRA      APINC                           E20018
     C***********          ADD  REALLW    APINC                           E20018
     C***********          END                                            E20018
     C***********COBP      IFEQ 'Y'                                       E20018
     C***********          ADD  BCCC      APINC                           E20018
     C***********          ADD  HBCCC     APINC                           E20018
     C***********          END                                            E20018
     C***********CBAP      IFEQ 'Y'                                       E20018
     C***********          ADD  BCCT      APINC                           E20018
     C***********          ADD  HBCCT     APINC                           E20018
     C***********          END                                            E20018
     C*
     C* For sale, amount should be negative
     C*
     C           HBCPS     IFEQ 'S'
     C                     Z-SUBAPINC     APINC
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C*                                                                   E22957
     C                     Z-SUBAPCST     APCST                           E22957
     C*                                                                   E22957
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-SUBAPINN     APINN                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END
     C***********                                                         E20086
     C**If*processing*type*8,*divide*amount*by*current*factor**********   E20086
     C***********                                                         E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********          DIV  HBCCF     APINC                           E20086
     C***********          END                                            E20086
     C*
     C*   - CALCULATE INCREMENT TO REALISED P/L
     C*
     C***********CNTP      SUB  HCNTP     WKCNTP                          E20087
     C***********CNTPRC    SUB  HSTPRC    WKCNTP                   E20087 E22957
     C***********BCNL      MULT WKCNTP    WRPL   150H              E20085 E22957
     C***********          Z-ADD*ZEROS    WRPL0  150                      E20232
     C***********          Z-ADD*ZEROS    WRPL1  151                      E20232
     C***********          Z-ADD*ZEROS    WRPL2  152                      E20232
     C***********          Z-ADD*ZEROS    WRPL3  153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******BCNL      MULT WKCNTP    WRPL0     H                     E20232
     C***71******BCNL      MULT WKCNTP    WRPL1     H                     E20232
     C***72******BCNL      MULT WKCNTP    WRPL2     H                     E20232
     C***73******BCNL      MULT WKCNTP    WRPL3     H                     E20232
     C***********                                                         E20232
     C***70******          MOVE WRPL0     WRPL   150                      E20232
     C***71******          MOVE WRPL1     WRPL                            E20232
     C***72******          MOVE WRPL2     WRPL                            E20232
     C***73******          MOVE WRPL3     WRPL                            E20232
     C*
     C* Convert Realised P/L Amount
     C*
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********          MULT POWER8,DC WRPL      H                     E20232
     C***********          Z-ADDBCNL      ZNOML                    E20232 E22957
     C***********          Z-ADDWKCNTP    ZPRC                     E20232 E22957
     C***********          EXSR ZCNSD                              E20232 E22957
     C***********          Z-ADDZCONS     WRPL                     E20232 E22957
     C*
     C**If*Price*Basis*'P',*divide*by*100******************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       WRPL      H                     E20232
     C***********          END                                            E20232
     C***********                                                         E22957
     C***********PROT      IFEQ '8'                                       E22957
     C***********          MULT CFCT      WRPL      H                     E20086
     C***********          MULT AAPR      WRPL      H              E20086 E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********                                                         E22957
     C**If*historic trade is sale, reverse sign                           E22957
     C***********                                                         E22957
     C***********HBCPS     IFEQ 'S'                                       E22957
     C***********          Z-SUBWRPL      WRPL                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          ADD  WRPL      RPLINC                          E22957
      *                                                                   E20085
      *** Calculate POSN Purch Int on a FIFO basis                        E20085
      *                                                                   E20085
     C           HPCHI     IFNE 0                                         E20085
     C           HACRI     ANDNE'X'                                       E20085
     C           XXLCCP    ANDEQLCCP                                      E20085
      *                                                                   E20085
     C***********BHRN      DIV  1000000   BCNLY                    E20085 E22957
     C***********BCNLY     MULT HPCHI     WSTOT                    E20085 E22957
     C***********WSTOT     DIV  HBCNL     EVAMY                    E20085 E22957
     C***********EVAMY     MULT 1000000   WSTOT                    E20085 E22957
     C***********                                                  E20085 E22957
     C***********          Z-ADDWSTOT     WBCP1                    E20085 E22957
     C                     Z-ADDHPCHI     ZAPIN                           E22957
     C                     Z-ADDBHRN      ZNPSN                           E22957
     C                     Z-ADDHBCNL     ZPNPSN                          E22957
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    WBCP1                           E22957
     C                     ELSE                                           E20085
     C                     Z-ADD0         WBCP1                           E20085
     C                     END                                            E20085
      *                                                                   E20085
      *****Calculate*the*change*to*Unamortized*Discount/Premium*on**      E20085
      *****a*FIFO*Basis.*********                                         E20085
     C***********                                                  E21113 E22957
     C***********MATY      IFNE 99999                              E21113 E22957
     C***********STAD      IFEQ 'Y'                                E21113 E22957
     C***********STAD      OREQ 'C'                                E21113 E22957
     C***********STBS      OREQ 'D'                                E21113 E22957
     C***********GDPK      ANDEQ'Y'                                E21113 E22957
     C***********                                                  E21113 E22957
     C***********STBS      IFEQ 'D'                                E20085 E21113
     C***********                                                  E20085 E22957
     C*****Determine*Current*Discount/Premium*%age*on*Historic*TradE20085 E22957
     C***********100       SUB  HSTPRC    HDPPCT                   E20085 E22957
     C***********                                                  E20085 E22957
     C*****Adjust*for*Percentage*Pricing*and*Currency*Decimal*PlaceE20085 E22957
      *****(Start*Index*at*3*rather*than*5*to*adjust*for*%age*Prices).    E20085
     C***********3         ADD  CDP       DC                       E20085 E20149
     C***********          MULT POWER8,DC HDPPCT    H              E20085 E20149
     C***********                                                  E20085 E22957
     C*****Calculate*remaining*Discount/Premium*on*Liquidated*AmounE20085 E22957
     C*****(using*ZCNSD*to*get*an*adjusted*figure)***********      E20149 E22957
     C***********HDPPCT    MULT BCNL      WKDPLQ    H              E20085 E20149
     C***********                                                  E20085 E22957
     C***********          Z-ADDBCNL      ZNOML                    E20149 E22957
     C***********          Z-ADDHDPPCT    ZPRC                     E20149 E22957
     C***********          EXSR ZCNSD                              E20149 E22957
     C***********          Z-ADDZCONS     WKDPLQ                   E20149 E22957
     C***********          ADD  WKDPLQ    UDPLIQ                   E20085 E22957
     C***********          END                                     E20085 E22957
     C***********          END                                     E21113 E22957
     C*
     C*   - OBTAIN NEW FIFO 1ST TRADE REF AND NOMINAL FROM NEXT HISTORIC
     C*         TRADES ACTION
     C*
     C                     MOVE TRKEY     KTRKEY
     C                     Z-ADDHBCAD     KDTE
     C                     MOVE BHTR      KREF
     C*
     C                     MOVEA'000'     *IN,07                          S01129
      *                                                                   E21545
      ***  Following CHAIN changed to SETGT for consistency.              E21545
     C***********HTBKEY    CHAINHTRACB               86                   E21545
     C           HTBKEY    SETGTHTRACB                                    E21545
     C                     SETOF                     86                   E21545
     C*                                                                   E21545
     C           *IN86     DOWEQ'0'
     C           HTBKY2    READEHTRACB                   86
     C*
     C           *IN86     IFEQ '1'
     C                     MOVE *BLANKS   BHTR
     C                     Z-ADD*ZEROS    BHRN
     C                     END
     C*
     C           *IN86     IFEQ '0'
      *                                                                   E21545
      ***  In selecting new FIFO trade, must disregard Reversal Actions!  E21545
     C           HBCRV     ANDNE'Y'                                       E21545
     C*
     C           PNPSN     IFGE 0
     C           HBCPS     ANDEQ'P'
     C           PNPSN     ORLT 0
     C           HBCPS     ANDEQ'S'
     C                     MOVE HBCTR     BHTR
     C                     Z-ADDHBCNL     BHRN
     C                     MOVE '1'       *IN86
     C                     END
     C                     END
     C                     END
     C*                                                                   S01486
     C** If Portfolio Management is present                               S01486
     C*                                                                   S01486
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01486
     C* CALCULATE FX AP INCREMENT & LATEST FX AVERAGE PRICE               S01486
     C*                                                                   S01486
     C           BCNL      DIV  HBCNL     WFACT                           S01486
     C           WFACT     MULT HCFAP     FXINC                           S01486
     C           HBCPS     IFEQ 'S'                                       S01486
     C                     Z-SUBFXINC     FXINC                           S01486
     C                     END                                            S01486
     C           LFXP      SUB  FXINC     LFXP                            S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C*
     C                     GOTO ECLOSE
     C                     END
      *
      *---------------------------------------------------------------*
      * IF FIFO REMAINING NOMINAL IS LESS THAN CURRENT TRADE NOMINAL  *
      *---------------------------------------------------------------*
      *
     C           BHRN      IFLT BCNL
     C/COPY WNCPYSRC,SE2220C172
     C*
     C*   - CALCULATE INCREMENT TO AP NUMERATOR
     C*
     C***********          Z-ADD*ZEROS    WBCCN  150                      E20232
     C***********          Z-ADD*ZEROS    WBCCN0 150                      E20232
     C***********          Z-ADD*ZEROS    WBCCN1 151                      E20232
     C***********          Z-ADD*ZEROS    WBCCN2 152                      E20232
     C***********          Z-ADD*ZEROS    WBCCN3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******BHRN      MULT HCNTP     WBCCN0    H                     E20087
     C***71******BHRN      MULT HCNTP     WBCCN1    H                     E20087
     C***72******BHRN      MULT HCNTP     WBCCN2    H                     E20087
     C***73******BHRN      MULT HCNTP     WBCCN3    H                     E20087
     C***70******BHRN      MULT HSTPRC    WBCCN0    H              E20087 E20232
     C***71******BHRN      MULT HSTPRC    WBCCN1    H              E20087 E20232
     C***72******BHRN      MULT HSTPRC    WBCCN2    H              E20087 E20232
     C***73******BHRN      MULT HSTPRC    WBCCN3    H              E20087 E20232
     C***********                                                         E20232
     C***70******          MOVE WBCCN0    WBCCN  150                      E20232
     C***71******          MOVE WBCCN1    WBCCN                           E20232
     C***72******          MOVE WBCCN2    WBCCN                           E20232
     C***73******          MOVE WBCCN3    WBCCN                           E20232
     C***********                                                         E20232
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********          MULT POWER8,DC WBCCN     H                     E20232
      *
     C********** CSE105    IFEQ 'Y'                                               MD031745 MD031745A
     C********** SESVAL    ANDEQ'B'                                               MD031745 MD031745A
     C********** CSE105    OREQ 'Y'                                               MD031745 MD031745A
     C********** SESVAL    ANDEQBCTV                                              MD031745 MD031745A
     C**********           Z-ADDBHRN      ZNOML                                   MD031745 MD031745A
     C**********           Z-ADDWWAVPR    ZPRC                                    MD031745 MD031745A
     C**********           EXSR ZCNSD                                             MD031745 MD031745A
     C**********           Z-ADDZCONS     WBCCN                                   MD031745 MD031745A
     C**********           ELSE                                                   MD031745 MD031745A
     C                     Z-ADDBHRN      ZNOML                           E20232
     C                     Z-ADDHSTPRC    ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     WBCCN                           E20232
     C**********           ENDIF                                                  MD031745 MD031745A
     C*
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDBHRN      ZNOML                                               CAS006
     C                     Z-ADDHSTPRN    ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WBCNN                                               CAS006
     C                     ADD  WBCNN     APINN                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       WBCCN     H                     E20232
     C***********          END                                            E20232
     C***********                                                         E20232
     C***********PROT      IFEQ '8'                                       E20086
     C***********          MULT HBCCF     WBCCN     H                     E20086
     C***********          END                                            E20086
     C*
     C                     ADD  WBCCN     APINC
      *                                                                                    MD031745A
      * Calculate Premium/Discount of Trade in history                                     MD031745A
     C                     Z-ADDHBCNL     ZNOML                                            MD031745A
     C                     Z-ADDHSTPRC    ZPRC                                             MD031745A
     C                     EXSR ZCNSD                                                      MD031745A
     C                     Z-ADDZCONS     WPCON                                            MD031745A
      *                                                                                    MD031745A
     C           SPBS      IFEQ 'P'                                                        MD031745A
     C                     Z-ADD100       ZPRC                                             MD031745A
     C                     ELSE                                                            MD031745A
     C                     Z-ADD1         ZPRC                                             MD031745A
     C                     ENDIF                                                           MD031745A
      *                                                                                    MD031745A
     C                     EXSR ZCNSD                                                      MD031745A
     C                     Z-ADDZCONS     WBCON                                            MD031745A
      *                                                                                    MD031745A
     C           WPCON     SUB  WBCON     WPRDS  150                                       MD031745A
      *                                                                                    MD031745A
     C                     EXSR TAMOR                                                      MD031745A
      *                                                                                    MD031745A
     C           BHRN      DIV  HBCNL     WWAM   159H                                      MD031745A
     C           WWAM      MULT WTAMOR    WWPL   150H                                      MD031745A
      *                                                                                    MD031745A
     C                     SUB  WWPL      APINC                                            MD031745A
     C*                                                                   E22957
     C*** Maintain Original Cost                                          E22957
     C*                                                                   E22957
     C                     Z-ADDBHRN      ZNOML                           E22957
     C                     Z-ADDHCNTP     ZPRC                            E22957
     C                     EXSR ZCNSD                                     E22957
     C                     Z-ADDZCONS     APCST                           E22957
     C*                                                                   E22957
     C*
     C***********RBAP      IFEQ 'Y'                                       E20018
     C***********          ADD  HBCRA     APINC                           E20018
     C***********                                                         E20018
     C**Calculate*reallowance*amount*from*rate*************************   E20018
     C***********                                                         E20018
     C***********          Z-ADDHBCRA     HDRALL 158                      E20018
     C****.*if*Discount************************************************   E20018
     C***********                                                         E20018
     C***********STBS      IFEQ 'D'                                       E20018
     C***********HBCRA     ANDNE0                                         E20018
     C***********          Z-ADDHBCAD     ZSDATE                          E20018
     C***********          Z-ADDMATY      ZEDATE                          E20018
     C***********          EXSR ZNCD                                      E20018
     C***********                                                         E20018
     C***********          EXSR ZDYYR                                     E20018
     C***********ZINTDD    IFNE 0                                         E20018
     C***********HBCRA     MULT 0.01      WPRIC1                          E20018
     C***********WPRIC1    MULT ZDDAYS    WPRIC1                          E20018
     C***********WPRIC1    DIV  ZINTDD    HDRALL    H                     E20018
     C***********          ELSE                                           E20018
     C***********          Z-ADD*ZEROS    HDRALL                          E20018
     C***********          END                                            E20018
     C***********          END                                            E20018
     C***********                                                         E20018
     C***********HBCNL     MULT HDRALL    HREALL 130H                     E20018
     C***********          ADD  HREALL    APINC                           E20018
     C***********          END                                            E20018
     C***********COBP      IFEQ 'Y'                                       E20018
     C***********          ADD  HBCCC     APINC                           E20018
     C***********          END                                            E20018
     C***********CBAP      IFEQ 'Y'                                       E20018
     C***********          ADD  HBCCT     APINC                           E20018
     C***********          END                                            E20018
     C*
     C* For sale, amount should be negative
     C*
     C           HBCPS     IFEQ 'S'
     C                     Z-SUBAPINC     APINC
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C                     Z-SUBAPCST     APCST                           E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-SUBAPINN     APINN                                               CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   E22957
     C                     END
     C*                                                                   S01486
     C** If Portfolio Management is present                               S01486
     C*                                                                   S01486
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01486
     C* CALCULATE FX AP INCREMENT                                         S01486
     C*                                                                   S01486
     C           BHRN      DIV  HBCNL     WFACT                           S01486
     C           WFACT     MULT HCFAP     FXINC                           S01486
     C           HBCPS     IFEQ 'S'                                       S01486
     C                     Z-SUBFXINC     FXINC                           S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C***********                                                         E20086
     C**If*processing*type*8,*divide*amount*by*current*factor**********   E20086
     C***********                                                         E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********          DIV  HBCCF     APINC                           E20086
     C***********          END                                            E20086
     C*
     C*   - CALCULATE INCREMENT TO REALISED P/L
     C*
     C***********CNTP      SUB  HCNTP     WKCNTP                          E20087
     C***********CNTPRC    SUB  HSTPRC    WKCNTP                   E20087 E22957
     C***********          Z-ADD*ZEROS    WRPL0  150                      E20232
     C***********          Z-ADD*ZEROS    WRPL1  151                      E20232
     C***********          Z-ADD*ZEROS    WRPL2  152                      E20232
     C***********          Z-ADD*ZEROS    WRPL3  153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******BHRN      MULT WKCNTP    WRPL0     H                     E20232
     C***71******BHRN      MULT WKCNTP    WRPL1     H                     E20232
     C***72******BHRN      MULT WKCNTP    WRPL2     H                     E20232
     C***73******BHRN      MULT WKCNTP    WRPL3     H                     E20232
     C***********                                                         E20232
     C***70******          MOVE WRPL0     WRPL   150                      E20232
     C***71******          MOVE WRPL1     WRPL                            E20232
     C***72******          MOVE WRPL2     WRPL                            E20232
     C***73******          MOVE WRPL3     WRPL                            E20232
     C*
     C* Convert Realised P/L Amount
     C*
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********          MULT POWER8,DC WRPL      H                     E20232
     C***********          Z-ADDBCNL      ZNOML                    E20232 E22957
     C***********          Z-ADDWKCNTP    ZPRC                     E20232 E22957
     C***********          EXSR ZCNSD                              E20232 E22957
     C***********          Z-ADDZCONS     WRPL                     E20232 E22957
     C*
     C**If*Price*Basis*'P',*divide*by*100******************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       WRPL      H                     E20232
     C***********          END                                            E20232
     C***********                                                         E22957
     C***********PROT      IFEQ '8'                                       E22957
     C***********          MULT CFCT      WRPL      H                     E20086
     C***********          MULT AAPR      WRPL      H              E20086 E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********                                                         E22957
     C**If*historic trade is sale, reverse sign                           E22957
     C***********                                                         E22957
     C***********HBCPS     IFEQ 'S'                                       E22957
     C***********          Z-SUBWRPL      WRPL                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          ADD  WRPL      RPLINC                          E22957
      *                                                                   E20085
      *** Calculate POSN Purch Int on a FIFO basis                        E20085
      ***    - Reduce Current PI posted to zero                           E20085
      *                                                                   E20085
     C           HPCHI     IFNE 0                                         E20085
     C           HACRI     ANDNE'X'                                       E20085
     C           XXLCCP    ANDEQLCCP                                      E20085
      *                                                                   E20085
     C***********BHRN      DIV  1000000   BCNLY                    E20085 E22957
     C***********BCNLY     MULT HPCHI     WSTOT                    E20085 E22957
     C***********WSTOT     DIV  HBCNL     EVAMY                    E20085 E22957
     C***********EVAMY     MULT 1000000   WSTOT                    E20085 E22957
     C***********                                                  E20085 E22957
     C***********          Z-ADDWSTOT     WBCP1                    E20085 E22957
     C                     Z-ADDHPCHI     ZAPIN                           E22957
     C                     Z-ADDBHRN      ZNPSN                           E22957
     C                     Z-ADDHBCNL     ZPNPSN                          E22957
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    WBCP1                           E22957
     C                     ELSE                                           E20085
     C                     Z-ADD0         WBCP1                           E20085
     C                     END                                            E20085
     C***********                                                  E20085 E22957
     C*****Calculate the change to Unamortized Discount/Premium on E20085 E22957
     C*****a*FIFO Basis.                                           E20085 E22957
     C***********                                                  E21113 E22957
     C***********MATY      IFNE 99999                              E21113 E22957
     C***********STAD      IFEQ 'Y'                                E21113 E22957
     C***********STAD      OREQ 'C'                                E21113 E22957
     C***********STBS      OREQ 'D'                                E21113 E22957
     C***********GDPK      ANDEQ'Y'                                E21113 E22957
     C***********                                                  E21113 E22957
     C***********STBS      IFEQ 'D'                                E20085 E21113
     C***********                                                  E20085 E22957
     C*****Determine Current Discount/Premium %age on Historic TradE20085 E22957
     C***********100       SUB  HSTPRC    HDPPCT                   E20085 E22957
     C***********                                                  E20085 E22957
     C*****Adjust for Percentage Pricing and Currency Decimal PlaceE20085 E22957
      ***  (Start Index at 3 rather than 5 to adjust for %age Prices).    E20085
     C***********3         ADD  CDP       DC                       E20085 E20149
     C***********          MULT POWER8,DC HDPPCT    H              E20085 E20149
     C***********                                                  E20085 E22957
     C*****Calculate remaining Discount/Premium on Liquidated AmounE20085 E22957
     C*****(using ZCNSD to get an adjusted figure)                 E20149 E22957
     C***********HDPPCT    MULT BCNL      WKDPLQ    H              E20085 E20149
      *                                                                   E20085
     C***********          Z-ADDBCNL      ZNOML                    E20149 E22957
     C***********          Z-ADDHDPPCT    ZPRC                     E20149 E22957
     C***********          EXSR ZCNSD                              E20149 E22957
     C***********          Z-ADDZCONS     WKDPLQ                   E20149 E22957
     C***********          ADD  WKDPLQ    UDPLIQ                   E20085 E22957
     C***********          END                                     E20085 E22957
     C***********          END                                     E21113 E22957
     C*
     C*  - SET OUTSTANDING NOMINAL ON CURRENT TRADE
      ***  INFO: After the subtraction below, OSNOM WILL be > zero.       E20085
     C*
     C           BCNL      SUB  BHRN      OSNOM
     C*
     C*  - UNTIL NOM ON TRADE REDUCED TO ZERO OR -VE, READ THROUGH HISTORIC
     C*      TRADE ACTIONS RECALCULATING O/S NOMINALS EACH TIME
     C*       AND THEN SETTING FIFO FIELDS ON BKPHDD
     C*
     C                     MOVE TRKEY     KTRKEY
     C                     Z-ADDHBCAD     KDTE
     C                     MOVE BHTR      KREF
     C*
     C           HTBKEY    SETGTHTRACB
     C                     SETOF                     86
     C           *IN86     DOWEQ'0'
     C           HTBKY2    READEHTRACB                   86
     C*
     C           *IN86     IFEQ '1'
     C                     MOVE BCTR      BHTR
     C                     Z-ADDOSNOM     BHRN
     C                     END
     C*
     C           *IN86     IFEQ '0'
     C           BCAD      IFLT HBCAD                                     S01129
     C           BCAD      OREQ HBCAD                                     S01129
     C           BCTR      ANDEQHBCTR                                     S01129
     C                     MOVE BCTR      BHTR                            S01129
     C                     Z-ADDOSNOM     BHRN                            S01129
     C                     MOVE '1'       *IN86                           S01129
     C                     END                                            S01129
     C                     END                                            S01129
     C*                                                                   S01129
     C           *IN86     IFEQ '0'                                       S01129
      *                                                                   E21545
      ***  In selecting new FIFO trade, must disregard Reversal Actions.  E21545
     C           HBCRV     ANDNE'Y'                                       E21545
      *                                                                   E21545
     C           PNPSN     IFGE 0
     C           HBCPS     ANDEQ'P'
     C           PNPSN     ORLT 0
     C           HBCPS     ANDEQ'S'
      *                                                                   E20087
      ***  For discounted instruments, historic price used for realized   E20087
      ***  P/L calculations must reflect discount already amortized.      E20087
      ***  Use Contract Prices if Position is Non-Discounted, or if       E20087
      ***  Value Dates of Historic Trade and Liquidation are the same.    E20087
      *                                                                   E20087
     C                     Z-ADDHCNTP     HSTPRC                          E21113
     C                     Z-ADDCNTP      CNTPRC                          E21113
      * Recalculate Premium/Discount                                                       MD031745A
     C                     Z-ADDHBCNL     ZNOML                                            MD031745A
     C                     Z-ADDHSTPRC    ZPRC                                             MD031745A
     C                     EXSR ZCNSD                                                      MD031745A
     C                     Z-ADDZCONS     WPCON  150                                       MD031745A
      *                                                                                    MD031745A
     C           SPBS      IFEQ 'P'                                                        MD031745A
     C                     Z-ADD100       ZPRC                                             MD031745A
     C                     ELSE                                                            MD031745A
     C                     Z-ADD1         ZPRC                                             MD031745A
     C                     ENDIF                                                           MD031745A
      *                                                                                    MD031745A
     C                     EXSR ZCNSD                                                      MD031745A
     C                     Z-ADDZCONS     WBCON  150                                       MD031745A
      *                                                                                    MD031745A
     C           WPCON     SUB  WBCON     WPRDS                                            MD031745A
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDHCNTN     HSTPRN                                              CAS006
     C                     Z-ADDCNTN      CNTPRN                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                   E21113
     C           MATY      IFNE 99999                                     E21113
     C           STAD      IFEQ 'Y'                                       E21113
     C           STAD      OREQ 'C'                                       E21113
     C/COPY WNCPYSRC,SE2220C231
     C           STBS      OREQ 'D'                                       E21113
     C           GDPK      ANDEQ'Y'                                       E21113
     C/COPY WNCPYSRC,SE2220C186
      *                                                                   E21113
     C***********STBS      IFNE 'D'                                E20087 E21113
     C***********BCTV      OREQ 'V'                                E20087 E21113
     C***********BCAD      ANDEQHBCAD                              E20087 E21113
     C***********BCTV      OREQ 'T'                                E20087 E21113
     C***********BCOT      ANDEQHBCOT                              E20087 E21113
     C***********          Z-ADDHCNTP     HSTPRC                   E20087 E21113
     C***********          Z-ADDCNTP      CNTPRC                   E20087 E21113
     C***********          ELSE                                    E20087 E21113
      *                                                                   E20087
      ***  For a Discounted Value Date Position, convert the Historic     E20087
      ***  Price to a Discount Rate, then back to a Percentage Price      E20087
      ***  as at the Value Date of the Liquidation.                       E20087
      *                                                                   E20087
     C           BCTV      IFEQ 'V'                                       E20087
     C           BCAD      ANDNEHBCAD                                     E21113
     C                     Z-ADDHCNTP     ZPRICE                          E20087
     C                     Z-ADDHBCAD     ZFDATE                          E20087
     C                     EXSR ZPRCO                                     E20087
     C                     Z-ADDZPRCOT    ZPRCIN                          E20087
     C                     Z-ADDBCAD      ZFDATE                          E20087
     C                     EXSR ZPRCI                                     E20087
     C                     Z-ADDZPRCOT    HSTPRC                          E20087
     C                     Z-ADDCNTP      CNTPRC                          E20087
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDHCNTN     ZPRICE                                              CAS006
     C                     Z-ADDHBCAD     ZFDATE                                              CAS006
     C                     EXSR ZPRCO                                                         CAS006
     C                     Z-ADDZPRCOT    ZPRCIN                                              CAS006
     C                     Z-ADDBCAD      ZFDATE                                              CAS006
     C                     EXSR ZPRCI                                                         CAS006
     C                     Z-ADDZPRCOT    HSTPRN                                              CAS006
     C                     Z-ADDCNTN      CNTPRN                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END                                            E21113
     C***********          ELSE                                           E21113
      ***********                                                  E20087 E20552
      *****For*a*Discounted*Trade*Date*Position*both*Prices*should E20087 E20552
      *****reflect*the*LATER*Value*Date,*whether*this*is*the*Value*Date 7 E20552
      *****of*the*Historic*Trade*or*the*Liquidation.*This*check*is E20087 E20552
      *****necessary*because*Trade*Dates*and*Value*Dates*may*not*be*in 87 E20552
      *****the*same*sequence.************************************* E20087 E20552
      ***********                                                         E20087
     C***********HBCOT     IFLT BCOT                                      E20087
      ***********                                                         E20087
      *****Historic*Trade*is*Valued*earlier,*so*adjust*its*Price.* E20087 E20552
      ***********                                                  E20087 E20552
     C***********          Z-ADDHCNTP     ZPRICE                   E20087 E20552
     C***********          Z-ADDHBCOT     ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCO                              E20087 E20552
     C***********          Z-ADDZPRCOT    ZPRCIN                   E20087 E20552
     C***********          Z-ADDBCOT      ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCI                              E20087 E20552
     C***********          Z-ADDZPRCOT    HSTPRC                   E20087 E20552
     C***********          Z-ADDCNTP      CNTPRC                   E20087 E20552
     C***********          ELSE                                    E20087 E20552
      ***********                                                  E20087 E20552
      *****Liquidation*is*Valued*earlier,*so*adjust*its*Price.**** E20087 E20552
      ***********                                                  E20087 E20552
     C***********          Z-ADDCNTP      ZPRICE                   E20087 E20552
     C***********          Z-ADDBCOT      ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCO                              E20087 E20552
     C***********          Z-ADDZPRCOT    ZPRCIN                   E20087 E20552
     C***********          Z-ADDHBCOT     ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCI                              E20087 E20552
     C***********          Z-ADDZPRCOT    CNTPRC                   E20087 E20552
     C***********          Z-ADDHCNTP     HSTPRC                   E20087 E20552
     C***********          END                                     E20087 E20552
     C                     END                                            E20087
     C                     END                                            E20087
     C*
     C*   - CALCULATE INCREMENT TO AP NUMERATOR
     C*
     C           OSNOM     IFGE HBCNL
     C***********          Z-ADDHBCCN     WAPINC                          E22957
     C*                                                                   S01486
     C** If Portfolio Management is present                               S01486
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01486
     C** Calculate FX AP Increment                                        S01486
     C                     Z-ADDHCFAP     WFXINC 150                      S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C                     Z-ADDHBCNL     ZNOML                           E22957
     C                     Z-ADDHSTPRC    ZPRC                            E22957
     C                     EXSR ZCNSD                                     E22957
     C                     Z-ADDZCONS     WAPINC                          E22957
      *                                                                                    MD031745A
     C                     EXSR TAMOR                                                      MD031745A
      *                                                                                    MD031745A
     C           HBCNL     DIV  HBCNL     WWAM   159H                                      MD031745A
     C           WWAM      MULT WTAMOR    WWPL   150H                                      MD031745A
      *                                                                                    MD031745A
     C                     SUB  WWPL      WAPINC                                           MD031745A
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDHBCNL     ZNOML                                               CAS006
     C                     Z-ADDHSTPRN    ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WAPINN                                              CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   E22957
     C*** Maintain Original Cost                                          E22957
     C*                                                                   E22957
     C                     Z-ADDHBCNL     ZNOML                           E22957
     C                     Z-ADDHCNTP     ZPRC                            E22957
     C                     EXSR ZCNSD                                     E22957
     C                     Z-ADDZCONS     WAPCST 150                      E22957
     C*                                                                   E22957
     C                     ELSE
     C                     Z-ADD*ZEROS    WBCCN  150
     C***********          Z-ADD*ZEROS    WBCCN0 150                      E20232
     C***********          Z-ADD*ZEROS    WBCCN1 151                      E20232
     C***********          Z-ADD*ZEROS    WBCCN2 152                      E20232
     C***********          Z-ADD*ZEROS    WBCCN3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******OSNOM     MULT HCNTP     WBCCN0    H                     E20087
     C***71******OSNOM     MULT HCNTP     WBCCN1    H                     E20087
     C***72******OSNOM     MULT HCNTP     WBCCN2    H                     E20087
     C***73******OSNOM     MULT HCNTP     WBCCN3    H                     E20087
     C***70******OSNOM     MULT HSTPRC    WBCCN0    H              E20087 E20232
     C***71******OSNOM     MULT HSTPRC    WBCCN1    H              E20087 E20232
     C***72******OSNOM     MULT HSTPRC    WBCCN2    H              E20087 E20232
     C***73******OSNOM     MULT HSTPRC    WBCCN3    H              E20087 E20232
     C***********                                                         E20232
     C***70******          MOVE WBCCN0    WBCCN  150                      E20232
     C***71******          MOVE WBCCN1    WBCCN                           E20232
     C***72******          MOVE WBCCN2    WBCCN                           E20232
     C***73******          MOVE WBCCN3    WBCCN                           E20232
     C***********                                                         E20232
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********          MULT POWER8,DC WBCCN     H                     E20232
      **********                                                                  MD031745 MD031745A
     C********** CSE105    IFEQ 'Y'                                               MD031745 MD031745A
     C********** SESVAL    ANDEQ'B'                                               MD031745 MD031745A
     C********** CSE105    OREQ 'Y'                                               MD031745 MD031745A
     C********** SESVAL    ANDEQBCTV                                              MD031745 MD031745A
     C**********           Z-ADDOSNOM     ZNOML                                   MD031745 MD031745A
     C**********           Z-ADDWWAVPR    ZPRC                                    MD031745 MD031745A
     C**********           EXSR ZCNSD                                             MD031745 MD031745A
     C**********           Z-ADDZCONS     WBCCN                                   MD031745 MD031745A
     C**********           ELSE                                                   MD031745 MD031745A
     C                     Z-ADDOSNOM     ZNOML                           E20232
     C                     Z-ADDHSTPRC    ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     WBCCN                           E20232
     C**********           ENDIF                                                  MD031745 MD031745A
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDOSNOM     ZNOML                                               CAS006
     C                     Z-ADDHSTPRN    ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WBCNN                                               CAS006
     C                     Z-ADDWBCNN     WAPINN 150                                          CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   E22957
     C*** Maintain Original Cost                                          E22957
     C*                                                                   E22957
     C                     Z-ADDOSNOM     ZNOML                           E22957
     C                     Z-ADDHCNTP     ZPRC                            E22957
     C                     EXSR ZCNSD                                     E22957
     C                     Z-ADDZCONS     WAPCST                          E22957
     C*                                                                   E22957
     C*
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       WBCCN     H                     E20232
     C***********          END                                            E20232
     C***********                                                         E20232
     C***********PROT      IFEQ '8'                                       E20086
     C***********          MULT HBCCF     WBCCN     H                     E20086
     C***********          END                                            E20086
     C*
     C                     Z-ADDWBCCN     WAPINC 150
      *                                                                                    MD031745A
     C                     EXSR TAMOR                                                      MD031745A
      *                                                                                    MD031745A
     C           OSNOM     DIV  HBCNL     WWAM   159H                                      MD031745A
     C           WWAM      MULT WTAMOR    WWPL   150H                                      MD031745A
      *                                                                                    MD031745A
     C                     SUB  WWPL      WAPINC                                           MD031745A
     C*                                                                   S01486
     C** If Portfolio Management is present                               S01486
     C*                                                                   S01486
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C           OSNOM     DIV  HBCNL     WFACT                           S01486
     C           WFACT     MULT HCFAP     WFXINC 150                      S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     END
     C*
     C***********RBAP      IFEQ 'Y'                                       E20018
     C***********          ADD  HBCRA     APINC                           E20018
     C***********                                                         E20018
     C**Calculate*reallowance*amount*from*rate*************************   E20018
     C***********                                                         E20018
     C***********          Z-ADDHBCRA     HDRALL 158                      E20018
     C****.*if*Discount************************************************   E20018
     C***********                                                         E20018
     C***********STBS      IFEQ 'D'                                       E20018
     C***********HBCRA     ANDNE0                                         E20018
     C***********          Z-ADDHBCAD     ZSDATE                          E20018
     C***********          Z-ADDMATY      ZEDATE                          E20018
     C***********          EXSR ZNCD                                      E20018
     C***********                                                         E20018
     C***********          EXSR ZDYYR                                     E20018
     C***********ZINTDD    IFNE 0                                         E20018
     C***********HBCRA     MULT 0.01      WPRIC1                          E20018
     C***********WPRIC1    MULT ZDDAYS    WPRIC1                          E20018
     C***********WPRIC1    DIV  ZINTDD    HDRALL    H                     E20018
     C***********          ELSE                                           E20018
     C***********          Z-ADD*ZEROS    HDRALL                          E20018
     C***********          END                                            E20018
     C***********          END                                            E20018
     C***********                                                         E20018
     C***********HBCNL     MULT HDRALL    HREALL 130H                     E20018
     C***********          ADD  HREALL    WAPINC                          E20018
     C***********          END                                            E20018
     C***********COBP      IFEQ 'Y'                                       E20018
     C***********          ADD  HBCCC     WAPINC                          E20018
     C***********          END                                            E20018
     C***********CBAP      IFEQ 'Y'                                       E20018
     C***********          ADD  HBCCT     WAPINC                          E20018
     C***********          END                                            E20018
     C***********                                                         E20086
     C**If*processing*type*8,*divide*amount*by*current*factor**********   E20086
     C***********                                                         E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********          DIV  HBCCF     WAPINC                          E20086
     C***********          END                                            E20086
     C*
     C* For sale, amount should be negative
     C*
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C           HBCPS     IFEQ 'S'
     C                     SUB  WAPINC    APINC
     C                     SUB  WAPCST    APCST                           E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     SUB  WAPINN    APINN                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     SUB  WFXINC    FXINC                           S01486
     C                     END                                            S01486
     C                     ELSE
     C                     ADD  WAPINC    APINC
     C                     ADD  WAPCST    APCST                           E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     ADD  WAPINN    APINN                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     ADD  WFXINC    FXINC                           S01486
     C                     END                                            S01486
     C                     END
     C*
     C****-*CALCULATE INCREMENT TO REALISED P/L                           E22957
     C***********                                                         E22957
     C***********CNTP      SUB  HCNTP     WKCNTP                    E20087E22957
     C***********CNTPRC    SUB  HSTPRC    WKCNTP                    E20087E22957
     C***********BHRN      MULT WKCNTP    WRPL                            E22957
     C***********          Z-ADD*ZEROS    WRPL0  150                      E20232
     C***********          Z-ADD*ZEROS    WRPL1  151                      E20232
     C***********          Z-ADD*ZEROS    WRPL2  152                      E20232
     C***********          Z-ADD*ZEROS    WRPL3  153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***********OSNOM     IFLT HBCNL                                     E20232
     C***70******OSNOM     MULT WKCNTP    WRPL0     H                     E20232
     C***71******OSNOM     MULT WKCNTP    WRPL1     H                     E20232
     C***72******OSNOM     MULT WKCNTP    WRPL2     H                     E20232
     C***73******OSNOM     MULT WKCNTP    WRPL3     H                     E20232
     C***********          ELSE                                           E20232
     C***70******HBCNL     MULT WKCNTP    WRPL0     H                     E20232
     C***71******HBCNL     MULT WKCNTP    WRPL1     H                     E20232
     C***72******HBCNL     MULT WKCNTP    WRPL2     H                     E20232
     C***73******HBCNL     MULT WKCNTP    WRPL3     H                     E20232
     C***********          END                                            E20232
     C***********                                                         E20232
     C***70******          MOVE WRPL0     WRPL   150                      E20232
     C***71******          MOVE WRPL1     WRPL                            E20232
     C***72******          MOVE WRPL2     WRPL                            E20232
     C***73******          MOVE WRPL3     WRPL                            E20232
     C**Convert*Realised P/L Amount                                       E22957
     C***********                                                         E22957
     C*
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********          MULT POWER8,DC WRPL      H                     E20232
     C***********OSNOM     IFLT HBCNL                              E20232 E22957
     C***********          Z-ADDOSNOM     ZNOML                    E20232 E22957
     C***********          ELSE                                    E20232 E22957
     C***********          Z-ADDHBCNL     ZNOML                    E20232 E22957
     C***********          END                                     E20232 E22957
     C***********          Z-ADDWKCNTP    ZPRC                     E20232 E22957
     C***********          EXSR ZCNSD                              E20232 E22957
     C***********          Z-ADDZCONS     WRPL                     E20232 E22957
     C*
     C**If*Price*Basis*'P',*divide*by*100******************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       WRPL      H                     E20232
     C***********          END                                            E20232
     C*
     C***********PROT      IFEQ '8'                                       E22957
     C***********          MULT CFCT      WRPL      H                     E20086
     C***********          MULT AAPR      WRPL      H                     E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C**If*historic trade is sale, reverse sign                           E22957
     C***********                                                         E22957
     C***********HBCPS     IFEQ 'S'                                       E22957
     C***********          Z-SUBWRPL      WRPL                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          ADD  WRPL      RPLINC                          E22957
      *                                                                   E20085
      *** Calculate POSN Purch Int on a FIFO basis                        E20085
      ***    - Accumulate old PI to be cleared                            E20085
      *                                                                   E20085
     C           HPCHI     IFNE 0                                         E20085
     C           HACRI     ANDNE'X'                                       E20085
     C           XXLCCP    ANDEQLCCP                                      E20085
      *                                                                   E20085
      ***  Proportionment below should be conditioned on 'Outstanding     E20085
      ***  Nominal to be Liquidated' being Less Than the 'Nominal of the  E20085
      ***  Trade being Liquidated', ELSE the whole Trade is Liquidated    E20085
      ***  and whole HPCHI should be added. Not having this condition     E20085
      ***  causes some very funny results.                                E20085
      *                                                                   E20085
     C           OSNOM     IFLT HBCNL                                     E20085
      *                                                                   E20085
     C***********OSNOM     DIV  1000000   BCNLY                    E20085 E22957
     C***********BCNLY     MULT HPCHI     WSTOT                    E20085 E22957
     C***********WSTOT     DIV  HBCNL     EVAMY                    E20085 E22957
     C***********EVAMY     MULT 1000000   WSTOT                    E20085 E22957
     C***********          Z-ADDWSTOT     WBCP1                    E20085 E22957
      ***********                                                         E20085
     C                     Z-ADDHPCHI     ZAPIN                           E22957
     C                     Z-ADDOSNOM     ZNPSN                           E22957
     C                     Z-ADDHBCNL     ZPNPSN                          E22957
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    WBCP1                           E22957
     C                     ELSE                                           E20085
     C                     ADD  HPCHI     WBCP1                           E20085
     C                     END                                            E20085
      *                                                                   E20085
     C                     END                                            E20085
      *                                                                   E20085
     C*****Calculate the change to Unamortized Discount/Premium on E20085 E22957
     C*****a*FIFO Basis.                                           E20085 E22957
     C***********                                                  E21113 E22957
     C***********MATY      IFNE 99999                              E21113 E22957
     C***********STAD      IFEQ 'Y'                                E21113 E22957
     C***********STAD      OREQ 'C'                                E21113 E22957
     C***********STBS      OREQ 'D'                                E21113 E22957
     C***********GDPK      ANDEQ'Y'                                E21113 E22957
     C***********                                                  E21113 E22957
      *                                                                   E21113
     C***********STBS      IFEQ 'D'                                E20085 E21113
      *                                                                   E20085
     C***********                                                  E20085 E22957
     C*****Determine Current Discount/Premium %age on Historic TradE20085 E22957
     C***********100       SUB  HSTPRC    HDPPCT                   E20085 E22957
     C***********                                                  E20085 E22957
     C*****Adjust for Percentage Pricing and Currency Decimal Places.0085 E22957
     C*****(Start Index at 3 rather than 5 to adjust for %age Prices)0085 E22957
     C***********3         ADD  CDP       DC                       E20085 E20149
     C***********          MULT POWER8,DC HDPPCT    H              E20085 E20149
     C***********                                                  E20085 E22957
     C*****Calculate remaining Discount/Premium on Liquidated Amount20085 E22957
     C*****(using ZCNSD to get an adjusted figure)                 E20149 E22957
     C***********                                                  E20085 E22957
     C***********OSNOM     IFLT HBCNL                              E20085 E22957
     C***********HDPPCT    MULT OSNOM     WKDPLQ    H              E20085 E20149
     C***********          Z-ADDOSNOM     ZNOML                    E20149 E22957
     C***********          ELSE                                    E20085 E22957
     C***********HDPPCT    MULT HBCNL     WKDPLQ    H              E20085 E20149
     C***********          Z-ADDHBCNL     ZNOML                    E20149 E22957
     C***********          END                                     E20085 E22957
     C***********          Z-ADDHDPPCT    ZPRC                     E20149 E22957
     C***********          EXSR ZCNSD                              E20149 E22957
     C***********          Z-ADDZCONS     WKDPLQ                   E20149 E22957
     C***********          ADD  WKDPLQ    UDPLIQ                   E20085 E22957
     C***********          END                                     E20085 E22957
     C***********          END                                     E21113 E22957
     C*
     C           OSNOM     SUB  HBCNL     OSNOM
     C*
     C*   - IF O/S NOMINAL HAS BECOME -VE OR ZERO, SET BKPHDD FIELDS
     C*
     C           OSNOM     IFEQ 0
      *                                                                   E20085
      ***  Keep reading Historic Trades by Book until a Trade is found    E20085
      ***  that is opposite P/S to the one currently being processed.     E20085
      ***  Don't need to worry about what happens if there are no more    E20085
      ***  Trades as Position is then flat and SR/P10 will set up new     E20085
      ***  BHTR/BHRN from the next Trade and this SR won't be called.     E20085
      *                                                                   E20085
     C           *IN85     DOUEQ'1'
     C           HTBKY2    READEHTRACB                   85
     C           *IN85     IFEQ '0'
     C           PNPSN     IFGE 0
     C           HBCPS     ANDEQ'P'
     C           PNPSN     ORLT 0
     C           HBCPS     ANDEQ'S'
     C/COPY WNCPYSRC,SE2220C173
     C                     MOVE HBCTR     BHTR
     C                     Z-ADDHBCNL     BHRN
     C*********************Z-ADDHCFAP     LFXP                            S01486
     C                     MOVEA'11'      *IN,85
     C                     END
     C                     END
      *                                                                   E20085
     C                     END
     C*
     C                     ELSE
     C           OSNOM     IFLT 0
     C                     MOVE HBCTR     BHTR
     C                     Z-SUBOSNOM     BHRN
     C                     MOVE '1'       *IN86
     C                     END
     C*
     C                     END
     C                     END
     C                     ELSE                                           E20085
      *                                                                   E20085
      ***  Store New remaining FIFO Purch int. on a New Position          E20085
      *                                                                   E20085
     C           PCHI      IFNE 0                                         E20085
     C           ACRI      ANDNE'X'                                       E20085
      *                                                                   E20085
     C***********OSNOM     DIV  1000000   BCNLY                    E20085 E22957
     C***********BCNLY     MULT PCHI      WSTOT                    E20085 E22957
     C***********WSTOT     DIV  BCNL      EVAMY                    E20085 E22957
     C***********EVAMY     MULT 1000000   WSTOT                    E20085 E22957
     C***********          Z-ADDWSTOT     WBCP2                    E20085 E22957
     C                     Z-ADDPCHI      ZAPIN                           E22957
     C                     Z-ADDOSNOM     ZNPSN                           E22957
     C                     Z-ADDBCNL      ZPNPSN                          E22957
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    WBCP2                           E22957
     C                     ELSE                                           E20085
     C                     Z-ADD0         WBCP2                           E20085
     C                     END                                            E20085
      *                                                                   E20085
     C                     END
     C                     END
     C                     END
     C*
     C* RESTORE CURRENT ACTION FIELDS
     C*
     C           ECLOSE    TAG
     C*
     C                     MOVELSTREC     RECIN
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************                    MD031745A
      *                                                               *                    MD031745A
      *  TAMORT - SUBROUTINE TO PRODUCE AMORTISED AMOUNT IN EACH      *                    MD031745A
      *           TRADE IN FIFO BASIS                                 *                    MD031745A
      *                                                               *                    MD031745A
      *****************************************************************                    MD031745A
     C           TAMOR     BEGSR                                                           MD031745A
      *                                                                                    MD031745A
     C                     Z-ADDHBCAD     ZSDATE                                           MD031745A
     C                     Z-ADDMATY      ZEDATE                                           MD031745A
     C                     Z-ADD0         ZIDNAT                                           MD031745A
     C                     MOVE *BLANK    ZACLT                                            MD031745A
     C                     EXSR ZDAYS                                                      MD031745A
     C                     Z-ADDZDDAYS    WNDYM   50                                       MD031745A
      *                                                                                    MD031745A
     C                     Z-ADDHBCAD     ZSDATE                                           MD031745A
     C                     Z-ADDLATD      ZEDATE                                           MD031745A
     C                     EXSR ZDAYS                                                      MD031745A
     C                     Z-ADDZDDAYS    WNDYS1  50                                       MD031745A
      *                                                                                    MD031745A
     C           WPRDS     DIV  WNDYM     WDAMOR 152H                                      MD031745A
     C           WDAMOR    MULT WNDYS1    WTAMOR 151H                                      MD031745A
      *                                                                                    MD031745A
     C                     ENDSR                                                           MD031745A
      *****************************************************************                    MD031745A
      /EJECT
     C/COPY WNCPYSRC,SE2220C174
      *****************************************************************
      *                                                               *
      *  REALPL - SUBROUTINE TO PRODUCE REALIZED PROFIT/LOSS KEYS     *
      *                                                               *
      *****************************************************************
      *
     C           REALPL    BEGSR                           *** REALPL ***
     C*
     C* CLEAR WORKFIELD
     C*
     C                     Z-ADD0         WRLPL
     C                     Z-ADD*ZEROS    WPRLS  150
     C***********                                                         E22957
     C**PROCESSING FOR A TRADE CALL                                       E22957
     C***********                                                         E22957
     C************IN24     IFEQ '1'                                       E22957
      *
      ***  If the Trade is a Sale and Previous Nominal is Long OR Trade
      ***  is a Purchase and Previous Nominal is Short:
      *
     C************IN41     IFEQ '1'                                       E22957
     C************IN42     OREQ '1'                                       E22957
     C***********PNPSN     ANDNE*ZEROS                                    E22957
     C*
     C*  - IF FIFO ACCOUNTING NOT REQUIRED
     C*
     C***********FIFO      IFNE 'Y'                                       E22957
     C*
     C*** P&L CALCULATION HAS BEEN CHANGED TO PREVENT ROUNDING ERRORS     E22957
     C*** AND UNBALANCED ACCOUNTING ENTRIES.                              E22957
     C*** P&L =  CONTRACT VALUE - (CURRENT AP NUMERATOR  LESS             E22957
     C*** PREVIOUS AP NUMERATOR                                           E22957
     C*                                                                   E22957
     C                     MOVE 'N'       WUPD                                                CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           BCAS      ANDEQ'60'                                                          CSE065
     C           PROT      ANDNE'2'                                                           CSE065
     C           PROT      ANDNE'4'                                                           CSE065
     C           PROT      ANDNE'7'                                                           CSE065
     C           STAD      IFEQ 'Y'                                                           CSE065
     C           STAD      OREQ 'C'                                                           CSE065
     C           APNC      SUB  BKCOST    WPRLS                                               CSE065
     C                     MOVE 'Y'       WUPD                                                CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
     C           WUPD      IFEQ 'N'                                                           CSE065
     C           APNC      SUB  PAPNC     WPRLS                           E22957
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     SUB  WCAMT     WPRLS                           E22957
     C*                                                                   E22957
     C****-*CALCULATE*NOMINAL*ON*WHICH*P/L*IS*CALCULATED                  E22957
     C*
     C************IN42     IFEQ '1'                                       E22957
     C***********          Z-ADDBCNL      WNOM   150                      E22957
     C***********          ELSE                                           E22957
     C***********PNPSN     IFLT *ZEROS                                    E22957
     C***********          Z-SUBPNPSN     WNOM                            E22957
     C***********          ELSE                                           E22957
     C***********          Z-ADDPNPSN     WNOM                            E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C*
     C*     - CALCULATE REALISED P/L
     C*
     C************IN41     IFEQ '0'                                       E22957
     C***********CNTP      SUB  LAVP      WPRICE 158                      E22957
     C***********          ELSE                                           E22957
     C***********CNTP      SUB  PLAVP     WPRICE                          E22957
     C***********          END                                            E22957
     C*
     C***********          Z-ADD*ZEROS    WPRLS0 150                      E20232
     C***********          Z-ADD*ZEROS    WPRLS1 151                      E20232
     C***********          Z-ADD*ZEROS    WPRLS2 152                      E20232
     C***********          Z-ADD*ZEROS    WPRLS3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******WNOM      MULT WPRICE    WPRLS0    H                     E20232
     C***71******WNOM      MULT WPRICE    WPRLS1    H                     E20232
     C***72******WNOM      MULT WPRICE    WPRLS2    H                     E20232
     C***73******WNOM      MULT WPRICE    WPRLS3    H                     E20232
     C***********                                                         E20232
     C***70******          MOVE WPRLS0    WPRLS                           E20232
     C***71******          MOVE WPRLS1    WPRLS                           E20232
     C***72******          MOVE WPRLS2    WPRLS                           E20232
     C***73******          MOVE WPRLS3    WPRLS                           E20232
     C*
     C* Convert Realised P/L Amount
     C*
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********WPRLS     MULT POWER8,DC WPRLS     H                     E20232
     C***********          Z-ADDWNOM      ZNOML                    E20232 E22957
     C***********          Z-ADDWPRICE    ZPRC                     E20232 E22957
     C***********          EXSR ZCNSD                              E20232 E22957
     C***********          Z-ADDZCONS     WPRLS                    E20232 E22957
     C*
     C**If*Price*Basis*'P',*divide*by*100******************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********WPRLS     DIV  100       WPRLS     H                     E20232
     C***********          END                                            E20232
     C*
     C           PROT      IFEQ '8'
     C/COPY WNCPYSRC,SE2220C158
     C***********WPRLS     MULT CFCT      WPRLS     H                     E20086
     C           WPRLS     MULT AAPR      WPRLS     H                     E20086
     C                     END
     C*
     C**For*purchase,*value*should*be*negative********                    E22957
     C*                                                                   E22957
     C***********BCPS      IFEQ 'P'                                       E22957
     C***********          Z-SUBWPRLS     WPRLS                           E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C****-*IF*FIFO ACCOUNTING IS REQUIRED                                E22957
     C***********                                                         E22957
     C***********          ELSE                                           E22957
     C***********                                                         E22957
     C******-*CALCULATE REALISED PROFIT/LOSS                              E22957
     C***********                                                         E22957
     C***********          Z-ADDRPLINC    WRLPL                           E22957
     C***********          Z-ADDRPLINC    WPRLS                           E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C***********                                                  E15564 E22957
     C**MUST*CLEAR RPLINC HERE!!! ELSE FIFO REALIZED P/L CORRUPTED!E15564 E22957
     C***********          Z-ADD0         RPLINC                   E15564 E22957
     C***********                                                  E15564 E22957
     C***********                                                         E22957
     C* SET NEGATIVE IND FOR ACCOUNT KEY
     C*
     C*** Only use the opening position for trade action else use         120518
     C*** the current position.                                           120518
     C*                                                                   120518
     C           BCAS      IFNE '60'                                      120518
     C*                                                                   120518
     C           NPAC      IFEQ 'Y'
     C           PNPSN     ANDLT0
     C                     MOVE 'N'       NEGI
     C                     ELSE
     C                     MOVE ' '       NEGI
     C                     END
     C*                                                                   120518
     C                     ELSE                                           120518
     C*                                                                   120518
     C           NPAC      IFEQ 'Y'                                       120518
     C           NPSN      ANDLT0                                         120518
     C                     MOVE 'N'       NEGI                            120518
     C                     ELSE                                           120518
     C                     MOVE ' '       NEGI                            120518
     C                     END                                            120518
     C*                                                                   120518
     C                     END                                            120518
     C*
     C***********          END                                            E22957
     C***********                                                         E22957
     C**PROCESSING IF CALLED FROM P60 (AVERAGE PRICE ACTION)              E22957
     C***********                                                         E22957
     C************IN25     IFEQ '1'                                       E22957
     C***********LAVP      SUB  PLAVP     WPRICE                          E22957
     C*
     C***********          Z-ADD*ZEROS    WPRLS0 150                      E20232
     C***********          Z-ADD*ZEROS    WPRLS1 151                      E20232
     C***********          Z-ADD*ZEROS    WPRLS2 152                      E20232
     C***********          Z-ADD*ZEROS    WPRLS3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******NPSN      MULT WPRICE    WPRLS0    H                     E20232
     C***71******NPSN      MULT WPRICE    WPRLS1    H                     E20232
     C***72******NPSN      MULT WPRICE    WPRLS2    H                     E20232
     C***73******NPSN      MULT WPRICE    WPRLS3    H                     E20232
     C***********                                                         E20232
     C***70******          MOVE WPRLS0    WPRLS                           E20232
     C***71******          MOVE WPRLS1    WPRLS                           E20232
     C***72******          MOVE WPRLS2    WPRLS                           E20232
     C***73******          MOVE WPRLS3    WPRLS                           E20232
     C*                                                                   E20232
     C* Convert Realised P/L Amount                                       E20232
     C*                                                                   E20232
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********WPRLS     MULT POWER8,DC WPRLS     H                     E20232
     C***********          Z-ADDNPSN      ZNOML                    E20232 E22957
     C***********          Z-ADDWPRICE    ZPRC                     E20232 E22957
     C***********          EXSR ZCNSD                              E20232 E22957
     C***********          Z-ADDZCONS     WPRLS                    E20232 E22957
     C*                                                                   E20232
     C**If*Price*Basis*'P',*divide*by*100******************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********WPRLS     DIV  100       WPRLS     H                     E20232
     C***********          END                                            E20232
     C*
     C***********PROT      IFEQ '8'                                       E22957
     C***********WPRLS     MULT CFCT      WPRLS     H                     E20086
     C***********WPRLS     MULT AAPR      WPRLS     H              E20086 E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C**SET*NEGATIVE IND FOR ACCOUNT KEY                                  E22957
     C***********                                                         E22957
     C***********NPAC      IFEQ 'Y'                                       E22957
     C***********PNPSN     ANDLT0                                         E22957
     C***********          MOVE 'N'       NEGI                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE ' '       NEGI                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          END                                            E22957
     C*
     C                     Z-ADDWPRLS     WRLPL
     C*
     C**WRITE*REALISED*P/L*KEY******                                      E22957
     C* WRITE REALISED P/L KEY UNLESS ENTRIES ARE TO BE SUPPRESSED        E22957
     C*                                                                   E22957
     C           BCTV      IFNE SKTD                                      E22957
     C*
     C                     MOVE BCTV      EVTP
     C                     MOVE ' '       TRTP
     C                     MOVE '  '      TRST
     C                     MOVE ' '       PORT
      *
     C           WRLPL     IFGT 0
     C                     MOVE 'RP'      AMCD
     C/COPY WNCPYSRC,SE2220C063
     C                     Z-ADDWRLPL     EVAM
     C                     ELSE
     C                     MOVE 'RL'      AMCD
     C/COPY WNCPYSRC,SE2220C064
     C           WRLPL     MULT -1        EVAM
     C                     END
     C/COPY WNCPYSRC,SE2220C071
      *
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C           *IN24     IFEQ '1'
     C                     MOVE BCTR      TRFR
     C                     ELSE
     C                     MOVE *ZEROS    TRFR
     C                     END
     C*
     C                     Z-ADDWRLPL     WBCPL
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C027
     C                     END
      *                                                                                       CSE065
      ** If security is defined as available for sale,                                        CSE065
      ** calculate Book Value Change and Equity Amount                                        CSE065
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C           PROT      ANDNE'2'                                                           CSE065
     C           PROT      ANDNE'4'                                                           CSE065
     C           PROT      ANDNE'7'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           BCTV      ANDEQ'V'                                                           CSE065
      *                                                                                       CSE065
     C           STAD      IFEQ 'C'                                                           CSE065
     C           STAD      OREQ 'Y'                                                           CSE065
     C                     EXSR P06                                                           CSE065
     C                     EXSR P07                                                           CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     END                                            E22957
     C*                                                                   E38721
     C** IF PROFIT BASIS IS BOTH, PRODUCE TODAY'S PROFIT                  E38721
     C           RPBS      IFEQ 'B'                                       E38721
     C                     Z-ADDWRLPL     WBCPL                           E38721
     C                     END                                            E38721
     C*
     C* ACCUMULATE TOTAL REALISED P/L POSTED ON POSITION FOR THIS ACTION
     C*                                                                   E20475
     C* ADD TO REALISED PROFIT ONLY IF NOT FROM MARK TO MARKET REVAL.     E20475
     C*                                                                   E20475
     C           BCAS      IFNE '60'                                      E20475
     C                     ADD  WRLPL     WRPTP
     C                     ELSE                                           E37811
     C                     Z-ADDWRLPL     WBCPL                           E37811
     C                     END                                            E20475
      *                                                                   E19485
      ***  No longer need to accumulate realized P/L from BPACHD records. E19485
     C***03******          ADD  BCPL      XBCPL                           E19485
     C*
     C                     ENDSR
     C*
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  AVPR   - SUBROUTINE TO CALCULATE AVERAGE PRICE               *
      *                                                               *
      *****************************************************************
      *
     C           AVPR      BEGSR                           ***  AVPR  ***
     C*
     C* CHANGE AVERAGE PRICE FOR SALE(NEW NP SHORT) OR PURCHASE(NEW    NP
     C*   LONG)
     C*
     C*   - STORE PREVIOUS AVERAGE PRICE
     C*
     C                     Z-ADDLAVP      PLAVP  158
     C*
     C*   - STORE PREV AP NUMERATOR                                       E22957
     C*                                                                   E22957
     C                     Z-ADDAPNC      PAPNC                           E22957
     C*   - CHECK SALE OR PURCHASE
     C*
     C*** CALC WCAMT EVERY TIME AS NOW USED IN P&L CALC                   E22957
     C*                                                                   E22957
     C************IN42     IFEQ '0'                        B1             E22957
     C*
     C****-*CALCULATE*CHANGE*TO*AP*NUMERATOR***************************   S01486
     C*   - CALCULATE CHANGE TO AP NUMERATOR AND BOOK COST IN BASE CCY    S01486
     C*
     C***********          Z-ADDBCCN      WCAMT  130                      E21097
     C***********RBAP      IFEQ 'Y'                                       E21097
     C***********          ADD  BCRA      WCAMT                           E21097
     C***********          ADD  REALLW    WCAMT                           E21097
     C***********          END                                            E21097
     C***********COBP      IFEQ 'Y'                                       E21097
     C***********          ADD  BCCC      WCAMT                     E20191E21097
     C***********          ADD  BCCT      WCAMT                     E20191E21097
     C***********          END                                            E21097
     C***********CBAP      IFEQ 'Y'                                       E21097
     C***********          ADD  BCCT      WCAMT                     E20191E21097
     C***********          ADD  BCCC      WCAMT                     E20191E21097
     C***********          END                                            E21097
     C*                                                                   E21097
     C                     Z-ADDBCNL      ZNOML                           E21097
     C                     Z-ADDCNTP      ZPRC                            E21097
     C                     EXSR ZCNSD                                     E21097
     C                     Z-ADDZCONS     WCAMT  150                      E21097
     C*
     C* For sale, amount should be negative
     C*
     C           BCPS      IFEQ 'S'
     C                     Z-SUBWCAMT     WCAMT
     C                     END
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDBCNL      ZNOML                                               CAS006
     C                     Z-ADDCNTN      ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WCAMN  150                                          CAS006
     C*                                                                                       CAS006
     C* For sale, amount should be negative                                                   CAS006
     C*                                                                                       CAS006
     C           BCPS      IFEQ 'S'                                                           CAS006
     C                     Z-SUBWCAMN     WCAMN                                               CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
     C***********                                                         E20086
     C**If*processing*type*8,*divide*amount*by*current*factor***          E20086
     C***********                                                         E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********          DIV  BCCF      WCAMT                           E20086
     C***********          END                                            E20086
     C*
     C****-*UPDATE*AP*NUMERATOR*AND*AVERAGE*PRICE**********************   S01486
     C*   - UPDATE AP NUMERATOR/BOOK COST IN BASE CCY AND AVERAGE PRICE   S01486
     C*                                                                   E15442
     C*   *IN41 = SHORT TO LONG OR LONG TO SHORT                          E15442
     C*           -        TO   + OR 0   (PURCHASE)                       E15442
     C*           + OR 0   TO   -        (SALE)                           E15442
     C*                                                                   E15442
     C           *IN42     IFEQ '0'                                       E22957
     C           *IN41     IFEQ '1'
     C           PNPSN     ANDNE0
     C***********                                                  S01176 E17686
     C****ADD*ANY*AMOUNT*AMORTIZED*INTO*THE*AP*NUMERATOR*AND*******S01176 E17686
     C****UPDATE*THE*PREVIOUS*AVERAGE*PRICE*IF*AMORTIZATION*WAS*DONS01176 E17686
     C***********                                                  S01176 E17686
     C***********AMTDP     IFEQ 'Y'                                S01176 E17686
     C***********                                                  S01176 E17686
     C***********PNPSN     IFGT 0                                  S01176 E17686
     C***********          ADD  WEDP      APNC                     S01176 E17686
     C***********          ELSE                                    S01176 E17686
     C***********          SUB  WEDP      APNC                     S01176 E17686
     C***********          END                                     S01176 E17686
     C***********                                                  S01176 E17686
     C***********PNPSN     IFEQ 0                                  S01176 E17686
     C***********          Z-ADDAPNC      APPB                     S01176 E17686
     C***********          ELSE                                    S01176 E17686
     C***********APNC      DIV  PNPSN     APPB                     S01176 E17686
     C***********          END                                     S01176 E17686
     C***********                                                  S01176 E17686
     C***********SPBS      IFEQ 'P'                                S01176 E17686
     C***********          MULT 100       APPB                     S01176 E17686
     C***********          END                                     S01176 E17686
     C***********                                                  S01176 E17686
     C***********5         ADD  CDP       DC                       S01176 E17686
     C***********          SUB  NMDP      DC                       S01176 E17686
     C***********APPB      DIV  POWER8,DC APPB      H              S01176 E17686
     C***********          Z-ADDAPPB      PLAVP                    S01176 E17686
     C***********          END                                     S01176 E17686
     C***********                                                  S01176 E17686
     C                     Z-ADDCNTP      WNAP   158
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDCNTN      WNAN   158                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C***********          Z-ADD*ZEROS    WAPN0  150                      E20232
     C***********          Z-ADD*ZEROS    WAPN1  151                      E20232
     C***********          Z-ADD*ZEROS    WAPN2  152                      E20232
     C***********          Z-ADD*ZEROS    WAPN3  153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******NPSN      MULT CNTP      WAPN0     H                     E20232
     C***71******NPSN      MULT CNTP      WAPN1     H                     E20232
     C***72******NPSN      MULT CNTP      WAPN2     H                     E20232
     C***73******NPSN      MULT CNTP      WAPN3     H                     E20232
     C***********                                                         E20232
     C***70******          MOVE WAPN0     WAPN   150                      E20232
     C***71******          MOVE WAPN1     WAPN                            E20232
     C***72******          MOVE WAPN2     WAPN                            E20232
     C***73******          MOVE WAPN3     WAPN                            E20232
     C*
     C* Reformat amount, allowing for nominal & currency decimal places
     C*
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********WAPN      DIV  POWER8,DC WAPN      H                     E20232
     C                     Z-ADDNPSN      ZNOML                           E20232
     C                     Z-ADDCNTP      ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     WAPN   150                      E20232
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     Z-ADDCNTN      ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     WANN   150                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C*                                                                   E22957
     C                     Z-ADDZCONS     ANMP                            E22957
     C*                                                                   E22957
     C*
     C**Price*basis*'P'***************************************************E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       WAPN                            E20232
     C***********          END                                            E20232
     C*                                                                   S01486
     C**  If Portfolio Management is present                              S01486
     C*                                                                   S01486
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01486
     C* CALCULATE FX AVERAGE PRICE NUMERATOR                              S01486
     C           NPSN      DIV  BCNL      WFACT  238                      S01486
     C           WFACT     MULT CFAP      FXAP                            S01486
     C*                                                                   CPM004
     C***********APNC******IFLT 0                                  S01486 CPM004
     C*********************Z-SUBFXAP      FXAP                     S01486 CPM004
     C*********************END                                     S01486 CPM004
     C*                                                                   S01486
     C                     END                                            S01486
     C*
     C                     ELSE
     C*                                                                   E15442
     C*   *IN43 = LONG TO LONG OR SHORT TO SHORT                          E15442
     C*           + OR 0   TO   +        (PURCHASE)                       E15442
     C*           -        TO   -        (SALE)                           E15442
     C****GOING*LONGER*OR*SHORTER,AVERAGE*PRICE*CHANGES*BY*AP*NUMERATOR 6 E17686
     C****OF*TRADE*BEING*PROCESSED*-*PLUS*AMORTIZATION*FROM*LAST*POSN 176 E17686
     C*                                                                   E15442
     C           APNC      ADD  WCAMT     WAPN
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           APNN      ADD  WCAMN     WANN                                                CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   E22957
     C*** Maintain Original Cost                                          E22957
     C*                                                                   E22957
     C           ANMP      ADD  WCAMT     ANMP                            E22957
     C*                                                                   E22957
     C***********                                                  S01176 E17686
     C****ADD*ANY*AMOUNT*AMORTIZED*INTO*THE*AP*NUMERATOR********** S01176 E17686
     C***********                                                  S01176 E17686
     C***********AMTDP     IFEQ 'Y'                                S01176 E17686
     C***********                                                  S01176 E17686
     C***********PNPSN     IFGT 0                                  S01176 E17686
     C***********          ADD  WEDP      WAPN                     S01176 E17686
     C***********          ELSE                                    S01176 E17686
     C***********          SUB  WEDP      WAPN                     S01176 E17686
     C***********          END                                     S01176 E17686
     C***********          END                                     S01176 E17686
     C*    - CHECK NOMINAL FOR ZERO
     C           NPSN      IFEQ 0
      *                                                                   E20149
      ***  Following line unnecessary.                                    E20149
     C***********          Z-ADDWAPN      WNAP                            E20149
     C                     Z-ADD0         WNAP                            E20149
     C                     Z-ADD0         WNAN                                                CAS006
     C                     ELSE                            X3
     C                     Z-ADDNPSN      ZNOML                           E22957
     C                     Z-ADDWAPN      ZAPNC                           E22957
     C                     EXSR ZAVPR                                     E22957
     C                     Z-ADDZPRC      WNAP                            E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     Z-ADDWANN      ZAPNC                                               CAS006
     C                     EXSR ZAVPR                                                         CAS006
     C                     Z-ADDZPRC      WNAN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END                             E3             E22957
     C***********                                                  E20149 E22957
     C****Adjust*A*P*numerator*to*NMDP*to*avoid*rounding*errors.*  E20149 E22957
     C***********                                                  E20149 E22957
     C***********5         ADD  CDP       DC      10               E20149 E22957
     C***********          SUB  NMDP      DC                       E20149 E22957
     C***********DC        IFLT 5                          B4      E20149 E22957
     C***********WAPN      DIV  POWER8,DC WAPN      H              E20149 E22957
     C***********          END                             E4      E20149 E22957
     C***********                                                         E22957
     C**Price*basis*'P'******************************************         E22957
     C***********                                                         E22957
     C***********SPBS      IFEQ 'P'                        B4             E22957
     C***********          MULT 100       WNAP                     E21097 E22957
     C***********          MULT 100       WAPN                     E21097 E22957
     C***********          END                             E4             E22957
     C***********                                                         E22957
     C***********                                                  E21097 E22957
     C****Calculate*price*and*adjust*figures*(if*needed).********  E21097 E22957
     C***********                                                  E21097 E22957
     C***********WAPN      DIV  NPSN      WNAP      H              E21097 E22957
     C***********DC        IFGE 5                          B4      E21097 E22957
     C***********WNAP      DIV  POWER8,DC WNAP      H              E21097 E22957
     C***********          END                             E4      E21097 E22957
     C***********                                                         E22957
     C****Reset*A*P*numerator.***********************************  E21097 E22957
     C***********                                                  E21097 E22957
     C***********APNC      ADD  WCAMT     WAPN                     E21097 E22957
     C***********                                                  E21097 E22957
     C***********          END                             E3             E22957
     C**Reformat*price,*allowing*for*nominal*&*currency*decimal*places    E21097
     C***********                                                         E21097
     C***********5         ADD  CDP       DC      10                      E20149
     C***********          END                                            E20149
     C***********          SUB  NMDP      DC                              E20149
     C***********WNAP      DIV  POWER8,DC WNAP      H                     E20149
     C*                                                                   S01486
     C**  If Portfolio Management is present                              S01486
     C*                                                                   S01486
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01486
     C* ADD CHANGE TO FX AP TO FXAP                                       S01486
     C           BCPS      IFEQ 'S'                                       S01486
     C           FXAP      SUB  CFAP      FXAP                            S01486
     C                     ELSE                                           S01486
     C           FXAP      ADD  CFAP      FXAP                            S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C*
     C                     END
     C*
     C* SIGN PRICE POSITIVE
     C*
     C           WNAP      IFLT 0
     C           WNAP      MULT -1        WNAP
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           WNAN      MULT -1        WNAN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END
     C*
     C* RESET AVERAGE PRICE FOR BOOK POSITION AND HEADER
     C*
     C                     Z-ADDWAPN      APNC
     C                     Z-ADDWNAP      APPB
     C                     Z-ADDWNAP      LAVP
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           PROT      ANDNE'2'                                                           CSE065
     C           PROT      ANDNE'4'                                                           CSE065
     C           PROT      ANDNE'7'                                                           CSE065
     C           STAD      IFEQ 'Y'                                                           CSE065
     C           STAD      OREQ 'C'                                                           CSE065
      *                                                                                       CSE065
     C           *IN42     IFEQ '0'                                                           CSE065
     C           *IN41     IFEQ '1'                                                           CSE065
     C           PNPSN     ANDEQ0                                                             CSE065
     C                     Z-ADDCNTP      NAVP                                                CSE065
     C                     Z-ADDNPSN      ZNOML                                               CSE065
     C                     Z-ADDCNTP      ZPRC                                                CSE065
     C                     EXSR ZCNSD                                                         CSE065
     C                     Z-ADDZCONS     BKCOST                                              CSE065
     C                     ELSE                                                               CSE065
     C           BKCOST    ADD  WCAMT     BKCOST                                              CSE065
     C           NPSN      IFEQ 0                                                             CSE065
     C                     Z-ADD0         NAVP                                                CSE065
     C                     ELSE                                                               CSE065
     C                     Z-ADDNPSN      ZNOML                                               CSE065
     C                     Z-ADDBKCOST    ZAPNC                                               CSE065
     C                     EXSR ZAVPR                                                         CSE065
     C                     Z-ADDZPRC      NAVP                                                CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C           NAVP      IFLT 0                                                             CSE065
     C           NAVP      MULT -1        NAVP                                                CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDWANN      APNN                                                CAS006
     C                     Z-ADDWNAN      APPN                                                CAS006
     C                     Z-ADDWNAN      LAVN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     Z-ADDFXAP      LFXP                            S01486
     C                     END                                            S01486
     C*
     C                     ELSE
     C*
     C* UPDATE PRICE AND NUMERATOR FIELDS IF FIFO ACCOUNTING NOT
     C*    REQUIRED
     C*
     C           FIFO      IFNE 'Y'
     C*                                                                   E15442
     C*   *IN41 = SHORT TO LONG OR LONG TO SHORT                          E15442
     C*           -        TO   0 OR +   (PURCHASE)                       E15442
     C*           + OR 0   TO   -        (SALE)                           E15442
     C*                                                                   E15442
     C****SALE*ON*A*LONG*POSITION*OR*PURCHASE*ON*A*SHORT*POSITION*MS01176 E17686
     C****AVEARAGE*PRICE*IS*UNCHANGED*APART*FROM*AMORTISN*FROM*LASTS01176 E17686
     C***********                                                  S01176 E17686
     C****ADD*ANY*AMOUNT*AMORTIZED*INTO*THE*AP*NUMERATOR*AND*******S01176 E17686
     C****RECALCULATE*THE*AVERAGE*PRICE*IF*AMORTIZATION*WAS*DONE***S01176 E17686
     C***********                                                  S01176 E17686
     C***********AMTDP     IFEQ 'Y'                                S01176 E17686
     C***********                                                  S01176 E17686
     C***********PNPSN     IFGT 0                                  S01176 E17686
     C***********          ADD  WEDP      APNC                     S01176 E17686
     C***********          ELSE                                    S01176 E17686
     C***********          SUB  WEDP      APNC                     S01176 E17686
     C***********          END                                     S01176 E17686
     C***********                                                  S01176 E17686
     C***********PNPSN     IFEQ 0                                  S01176 E17686
     C***********          Z-ADDAPNC      APPB                     S01176 E17686
     C***********          ELSE                                    S01176 E17686
     C***********APNC      DIV  PNPSN     APPB                     S01176 E17686
     C***********          END                                     S01176 E17686
     C***********                                                  S01176 E17686
     C***********SPBS      IFEQ 'P'                                S01176 E17686
     C***********          MULT 100       APPB                     S01176 E17686
     C***********          END                                     S01176 E17686
     C***********                                                  S01176 E17686
     C***********5         ADD  CDP       DC                       S01176 E17686
     C***********          SUB  NMDP      DC                       S01176 E17686
     C***********APPB      DIV  POWER8,DC APPB      H              S01176 E17686
     C***********          Z-ADDAPPB      LAVP                     S01176 E17686
     C***********          END                                     S01176 E17686
     C***********                                                  S01176 E17686
     C*                                                                   E15442
     C                     Z-ADDLAVP      APPB
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDLAVN      APPN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C***********          Z-ADD*ZEROS    APNC0  150                      E20232
     C***********          Z-ADD*ZEROS    APNC1  151                      E20232
     C***********          Z-ADD*ZEROS    APNC2  152                      E20232
     C***********          Z-ADD*ZEROS    APNC3  153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******NPSN      MULT LAVP      APNC0     H                     E20232
     C***71******NPSN      MULT LAVP      APNC1     H                     E20232
     C***72******NPSN      MULT LAVP      APNC2     H                     E20232
     C***73******NPSN      MULT LAVP      APNC3     H                     E20232
     C***********                                                         E20232
     C***70******          MOVE APNC0     APNC                            E20232
     C***71******          MOVE APNC1     APNC                            E20232
     C***72******          MOVE APNC2     APNC                            E20232
     C***73******          MOVE APNC3     APNC                            E20232
     C*
     C* Reformat amount, allowing for nominal decimal places
     C*
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********APNC      MULT POWER8,DC APNC      H                     E20232
     C                     Z-ADDNPSN      ZNOML                           E20232
     C                     Z-ADDLAVP      ZPRC                            E20232
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     APNC                            E20232
      *                                                                                       CSE065
      ** Maintain Mark to Market Book Price                                                   CSE065
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C********** STRM      ANDEQ'Y'                                                    CSE065 233707
     C           PROT      ANDNE'2'                                                           CSE065
     C           PROT      ANDNE'4'                                                           CSE065
     C           PROT      ANDNE'7'                                                           CSE065
     C           STAD      IFEQ 'Y'                                                           CSE065
     C           STAD      OREQ 'C'                                                           CSE065
     C                     Z-ADDNPSN      ZNOML                                               CSE065
     C                     Z-ADDNAVP      ZPRC                                                CSE065
     C                     EXSR ZCNSD                                                         CSE065
     C                     Z-ADDZCONS     BKCOST                                              CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     Z-ADDLAVN      ZPRC                                                CAS006
     C                     EXSR ZCNSD                                                         CAS006
     C                     Z-ADDZCONS     APNN                                                CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C*                                                                   E22957
     C                     Z-ADDANMP      ZAPNC                           E22957
     C                     Z-ADDPNPSN     ZNOML                           E22957
     C                     EXSR ZAVPR                                     E22957
     C                     Z-ADDNPSN      ZNOML                           E22957
     C                     EXSR ZCNSD                                     E22957
     C                     Z-ADDZCONS     ANMP                            E22957
     C*
     C**Price*basis*'P'************************************************   E20232
     C***********                                                         E20232
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********          DIV  100       APNC                            E20232
     C***********          END                                            E20232
     C*                                                                   S01486
     C**  If Portfolio Management is present                              S01486
     C*                                                                   S01486
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01486
     C* CALCULATE FX AVERAGE PRICE NUMERATOR                              S01486
     C           NPSN      DIV  PNPSN     WFACT                           S01486
     C           WFACT     MULT LFXP      FXAP                            S01486
     C***********BCPS******IFEQ 'P'                                S01486 CPM004
     C***********FXAP******ANDGT0                                  S01486 CPM004
     C*********************Z-SUBFXAP      FXAP                     S01486 CPM004
     C*********************END                                     S01486 CPM004
     C                     Z-ADDFXAP      LFXP                            S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C*
     C                     ELSE
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C*                                                                   E22957
     C           ANMP      SUB  APCST     ANMP                            E22957
     C*                                                                   E22957
     C           APNC      SUB  APINC     APNC
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           APNN      SUB  APINN     APNN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C*                                                                   S01486
     C**  If Portfolio Management is present                              S01486
     C*                                                                   S01486
     C************IN39     IFEQ '1'                                S01486 CPM004
     C           BGPFMG    IFEQ 'Y'                                       CPM004
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01486
     C* CALCULATE LATEST FX AVERAGE PRICE NUMERATOR                       S01486
     C           FXAP      SUB  FXINC     FXAP                            S01486
     C                     Z-ADDFXAP      LFXP                            S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C***********          END                                     E21097 E21240
      *                                                                   E19494
      ***  If NPSN is zero, Avg. Price fields should be zero as well.     E19494
     C*
..   C           NPSN      IFEQ 0
      *                                                                   E19494
     C***********          Z-ADDWNAP      LAVP                            E19494
     C***********          Z-ADDWNAP      APPB                            E19494
     C                     Z-ADD0         LAVP                            E19494
     C                     Z-ADD0         APPB                            E19494
     C                     Z-ADD0         APNC                            E19494
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADD0         LAVN                                                CAS006
     C                     Z-ADD0         APPN                                                CAS006
     C                     Z-ADD0         APNN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     ELSE
     C                     Z-ADDNPSN      ZNOML                           E22957
     C                     Z-ADDAPNC      ZAPNC                           E22957
     C                     EXSR ZAVPR                                     E22957
     C                     Z-ADDZPRC      LAVP                            E22957
     C                     Z-ADDZPRC      APPB                            E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     Z-ADDAPNN      ZAPNC                                               CAS006
     C                     EXSR ZAVPR                                                         CAS006
     C                     Z-ADDZPRC      LAVN                                                CAS006
     C                     Z-ADDZPRC      APPN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END                                            E22957
     C***********SPBS      IFEQ 'P'                        B4             E22957
     C*
     C***********          MULT 100       APNC0                           E15573
     C***********APNC      MULT 100       APNC0                    E15573 E20232
     C***********APNC      MULT 100       APNC0  150               E20232 E22957
     C***********          ELSE                            X4      E15573 E22957
     C***********          Z-ADDAPNC      APNC0                    E15573 E22957
     C***********          END                             E4             E22957
     C***********                                                         E22957
     C**Adjust*for*nominal*and*currency*decimal*places************        E22957
     C***********                                                         E22957
     C***********5         SUB  NMDP      DC                              E22957
     C***********          ADD  CDP       DC                              E22957
     C***********DC        IFLT 5                          B4      E20149 E22957
     C***********APNC0     DIV  POWER8,DC APNC0     H              E21097 E22957
     C***********          END                             E4      E20149 E22957
     C***********                                                         E22957
     C*
     C***********APNC      DIV  POWER8,DC APNC0                           E15598
     C*
     C***********APNC      DIV  NPSN      LAVP      H                     E20149
     C***********                                                         E22957
     C**Calculate*average*price*using*adjusted*figures*(if*needed) E20149 E22957
     C***********                                                         E22957
     C***********APNC0     DIV  NPSN      LAVP      H                     E22957
     C***********DC        IFGE 5                          B4      E20149 E22957
     C***********LAVP      DIV  POWER8,DC LAVP      H              E15598 E22957
     C***********          END                             E4      E20149 E22957
     C***********                                                         E22957
     C***********          Z-ADDLAVP      APPB                            E22957
     C***********          END                                            E21097
     C***********          END                             E3      E21240 E22957
     C                     END
     C*
     C                     END
     C*                                                                   E15564
     C* MUST CLEAR APINC HERE!!! ELSE FIFO AVERAGE PRICE CORRUPTED!!!     E15564
     C                     Z-ADD0         APINC                           E15564
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADD0         APINN                                               CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   E22957
     C*** - Maintain Original Cost                                        E22957
     C*                                                                   E22957
     C                     Z-ADD0         APCST                           E22957
     C*                                                                   E15564
     C                     MOVEL'N'       AMTDP   1                       E15442
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT                                                              E15442
      *****************************************************************   E15442
      *                                                               *   E15442
      *  AVPRAM - SUBROUTINE TO UPDATE AVERAGE PRICE AFTER AMORTIZING *   E15442
      *                                                               *   E15442
      *****************************************************************   E15442
      *                                                                   E15442
     C           AVPRAM    BEGSR                           *** AVPRAM *** E15442
     C*                                                                   E15442
     C*   ADD ANY AMOUNT AMORTIZED INTO THE AP NUMERATOR                  E15442
     C*   AND RECALCULATE THE AVERAGE PRICE                               E15442
     C*                                                                   E15442
     C           AMTDP     IFEQ 'Y'                                       E15442
      *                                                                   E20087
      ***  Average price must reflect amortization regardless of FIFO.    E20087
     C***********FIFO      ANDNE'Y'                                E15442 E20087
     C* - Removed Update of WADP as performed in AMORT Subrountine Now    E22957
     C*                                                                   E22957
     C***********NPSN      IFGT 0                                  E15442 E22957
     C***********          ADD  WADP      APNC                     E15442 E22957
     C***********          ELSE                                    E15442 E22957
     C***********          SUB  WADP      APNC                     E15442 E22957
     C***********          END                                     E15442 E22957
     C***********                                                  E15442 E22957
     C*                                                                   E15442
     C           NPSN      IFEQ 0                                         E15442
     C                     Z-ADDAPNC      APPB                            E15442
     C                     ELSE                                           E15442
     C                     Z-ADDNPSN      ZNOML                           E22957
     C                     Z-ADDAPNC      ZAPNC                           E22957
     C                     EXSR ZAVPR                                     E22957
     C                     Z-ADDZPRC      APPB                            E22957
     C                     END                                            E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           NPSN      IFEQ 0                                                             CAS006
     C                     Z-ADDAPNN      APPN                                                CAS006
     C                     ELSE                                                               CAS006
     C                     Z-ADDNPSN      ZNOML                                               CAS006
     C                     Z-ADDAPNN      ZAPNC                                               CAS006
     C                     EXSR ZAVPR                                                         CAS006
     C                     Z-ADDZPRC      APPN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C*
     C***********SPBS      IFEQ 'P'                                E21097 E22957
     C***********APNC      MULT 100       APNC0                    E21097 E22957
     C***********          ELSE                                    E21608 E22957
     C***********          Z-ADDAPNC      APNC0                    E21608 E22957
     C***********          END                                     E21097 E22957
     C***********                                                  E21097 E22957
     C***********5         ADD  CDP       DC                       E21097 E22957
     C***********          SUB  NMDP      DC                       E21097 E22957
     C***********                                                  E21097 E22957
     C***********DC        IFLT 5                                  E21097 E22957
     C***********APNC0     DIV  POWER8,DC APNC0     H              E21097 E22957
     C***********          END                                     E21097 E22957
     C***********                                                  E21097 E22957
     C***********APNC      DIV  NPSN      APPB                     E15442 E21097
     C***********APNC0     DIV  NPSN      APPB      H              E21097 E22957
     C***********                                                  E21097 E22957
     C***********DC        IFGE 5                                  E21097 E22957
     C***********APPB      DIV  POWER8,DC APPB      H              E15442 E21097
     C***********          END                                     E21097 E22957
     C***********          END                                     E15442 E21097
     C***********                                                  E15442 E21097
     C***********SPBS      IFEQ 'P'                                E15442 E21097
     C***********          MULT 100       APPB                     E15442 E21097
     C***********          END                                     E15442 E21097
     C***********                                                  E15442 E21097
     C***********5         ADD  CDP       DC                       E15442 E21097
     C***********          SUB  NMDP      DC                       E15442 E21097
     C***********APPB      DIV  POWER8,DC APPB      H              E15442 E21097
     C***********          END                                     E21097 E22957
     C                     Z-ADDAPPB      LAVP                            E15442
     C                     Z-ADDAPPB      PLAVP                           E15442
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDAPPN      LAVN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C/COPY WNCPYSRC,SE2220C197
     C*                                                                   E15442
     C                     END                                            E15442
     C*                                                                   E15442
     C                     MOVEL'N'       AMTDP   1                       E15442
     C*                                                                   E15442
     C                     ENDSR                                          E15442
     C*                                                                   E15442
     C*****************************************************************   E15442
      /EJECT
      *****************************************************************
      *                                                               *
      *  DSPRT  - SUBROUTINE TO PRODUCE DISCOUNT/PREMIUM KEYS FOR     *
      *           TRADE DATA                                          *
      *                                                               *
      *****************************************************************
      *
     C           DSPRT     BEGSR                           *** DSPRT  ***
     C*
     C*   SET UP DETAILS FOR OUTPUT OF ACCOUNT KEY
     C*
     C                     MOVE 'T'       EVTP
     C/COPY WNCPYSRC,SE2220C133
      *                                                                                       CSE105
      ** If CSE105 is installed, and this is a Value Date Basis, set                          CSE105
      ** EVTP to BCTV.                                                                        CSE105
      *                                                                                       CSE105
     C           CSE105    IFEQ 'Y'                                                           CSE105
     C           BCTV      ANDEQ'V'                                                           CSE105
     C                     MOVE 'V'       EVTP                                                CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
     C                     MOVE BCPS      TRTP
     C                     MOVE ' '       PORT
     C                     MOVE '  '      TRST
     C*
     C***********PNPSN     IFGE 0                                         047370
     C                     MOVE ' '       NEGI
     C***********          ELSE                                           047370
     C***********          MOVE 'N'       NEGI                            047370
     C***********          END                                            047370
     C*
     C           WDCPM     IFGT 0
     C                     MOVE 'DS'      AMCD
     C                     ELSE
     C                     MOVE 'PR'      AMCD
     C                     END
     C*
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C                     MOVE BCTR      TRFR
     C*
     C           WDCPM     IFLT 0
     C           WDCPM     MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDWDCPM     EVAM
     C                     END
     C*                                                                   052573
     C***  Adjust posting amount by the Mortgage Current Factor.          052573
     C*                                                                   052573
     C           PROT      IFEQ '8'                                       052573
     C/COPY WNCPYSRC,SE2220C159
     C***********          MULT AAPR      EVAM                     052573 053703
     C                     MULT AAPR      EVAM      H                     053703
     C                     END                                            052573
     C*
     C**RESET*NEGATIVE*INDICATOR*AND*EVENT*AMOUNT*DEPENDING*ON*ICD********047370
     C*****INDICATORS*****************************************************047370
     C***********                                                         047370
     C***********NPAC      IFEQ 'N'                                       047370
     C***********NEGI      ANDEQ'N'                                       047370
     C***********          MOVE ' '       NEGI                            047370
     C***********EVAM      MULT -1        EVAM                            047370
     C***********          END                                            047370
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C028
     C                     END
     C*
     C**UPDATE*UNAMORTISED*DISC/PREM***********************************   E15442
     C***********                                                         E15442
     C***********BUDU      ADD  WDCPM     BUDU                            E15442
     C*************************************************************E20087 E22957
     C*****Actually,*BUDU*must*be*updated*to*permit*correct*amortization7 E22957
     C*****and*average*price*calculations,*but*it's*more*complicated20087 E22957
     C*****than*just*adding*WDCPM*to*BUDU.**The*processing*which*follows7 E22957
     C*****has*been*adapted*from*SR/DSPRV,*but*with*no*account*keys.20087 E22957
     C*************************************************************E20087 E22957
     C***Purchase*on*long/flat*position*or*sale*on*short/flat*position087 E22957
     C***Simply*add*discount/premium*for*trade*to*BUDU.************E20087 E22957
     C*************************************************************E20087 E22957
     C*                                                                   E22957
     C***  Unamortised Prem/Discount is Nominal Book Value Less Average   E22957
     C***  Price Numerator.                                               E22957
     C*                                                                   E22957
     C** - New discount is -ve short posn and +ve long Position           E22957
     C** - New Premium  is +ve short posn and -ve long Position           E22957
     C*                                                                   E22957
     C           BKVAL     SUB  APNC      BUDU                            E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           BKVALN    SUB  APNN      BUDN                                                CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   E22957
     C************IN36     IFEQ '1'                                E20087 E22957
     C***********PNPSN     OREQ 0                                  E20087 E22957
     C***********                                                  E20087 E22957
     C***********BUDU      ADD  WDCPM     BUDU                     E20087 E22957
     C***********                                                  E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********                                                  E20087 E22957
     C*****Set*indicator*for*average*price*changes.****************E20087 E22957
     C***********                                                  E20087 E22957
     C***********          MOVE '0'       *IN29                    E20087 E22957
     C***********PLAVP     IFGT 100                                E20087 E22957
     C***********LAVP      ANDGT100                                E20087 E22957
     C***********          MOVE '1'       *IN29                    E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********PLAVP     IFLT 100                                E20087 E22957
     C***********LAVP      ANDLT100                                E20087 E22957
     C***********          MOVE '1'       *IN29                    E20087 E22957
     C***********          END                                     E20087 E22957
     C***********                                                  E20087 E22957
     C***********          END                                     E20087 E22957
     C***********                                                  E20087 E22957
     C*****If*holding*does*not*cross*long/short*or*Discount/PremiumE20087 E22957
     C*****boundary.                                               E20087 E22957
     C***********                                                  E20087 E22957
     C************IN29     IFEQ '1'                                E20087 E22957
     C************IN30     ANDEQ'1'                                E20087 E22957
     C***********                                                  E20087 E22957
     C*****Must*be*sale*against*long*position*or*purchase*against*short87 E22957
     C*****position*(but*no*change*from*short*to*long*or*vice-versa).0087 E22957
     C*****Calculate*reduction*to*discount/premium*on*proportional*basis7 E22957
     C***********                                                  E20087 E22957
     C***********PNPSN     IFLT 0                                  E20087 E22957
     C***********PNPSN     MULT -1        WNOM                     E20087 E22957
     C***********PNPSN     MULT -1        WNOM   150               E22957 E22957
     C***********          ELSE                                    E20087 E22957
     C***********          Z-ADDPNPSN     WNOM                     E20087 E22957
     C***********          END                                     E20087 E22957
     C***********WNOM      IFNE 0                                  E20087 E22957
     C***********                                                  E20087 E22957
     C****If*FIFO*processing*requested*in*ICD,*reduction*to*Unamortized87 E22957
     C****Discount/Premium*has*already*been*calculated*in*SR/CLOSE.E20087 E22957
     C***********                                                  E20087 E22957
     C***********FIFO      IFEQ 'Y'                                E20087 E22957
     C***********          Z-ADDUDPLIQ    EVAM                     E20087 E22957
     C***********          Z-ADD0         UDPLIQ                   E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********BCNL      DIV  WNOM      WTOTXX 156H              E20087 E22957
     C***********BUDU      MULT WTOTXX    EVAM      H              E20087 E22957
     C***********          END                                     E20087 E22957
     C***********BUDU      SUB  EVAM      BUDU                     E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********          Z-ADDWDCPM     BUDU                     E20087 E22957
     C***********          END                                     E20087 E22957
     C***********                                                  E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********                                                  E20087 E22957
     C*****Holding*has*crossed*long/short*or*discount/premium*boundary.87 E22957
     C***********                                                  E20087 E22957
     C***********NPSN      IFLT 0                                  E20087 E22957
     C***********NPSN      MULT -1        WNOM                     E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********          Z-ADDNPSN      WNOM                     E20087 E22957
     C***********          END                                     E20087 E22957
     C***********                                                  E20087 E22957
     C***If*position*has*gone*from*long*to*short*or*vice/versa:****E20087 E22957
     C***Calculate*new*value*of*BUDU*proportionally.***************E20087 E22957
     C***********                                                  E20087 E22957
     C************IN30     IFEQ '0'                                E20087 E22957
     C***********                                                  E20087 E22957
     C***********BCNL      IFNE 0                                  E20087 E22957
     C***********WNOM      DIV  BCNL      WTOTXX    H              E20087 E22957
     C***********WDCPM     MULT WTOTXX    BUDU      H              E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********          Z-ADD0         BUDU                     E20087 E22957
     C***********          END                                     E20087 E22957
     C***********                                                  E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C*****If*average*price*has*gone*from*discount*to*premium*or*vice0087 E22957
     C*****versa,*and*position*has*not*gone*from*long*to*short*or*short87 E22957
     C*****to*long,*calculate*new*value*of*BUDU*proportionally.****E20087 E22957
     C***********                                                  E20087 E22957
     C***********WNOM      IFNE 0                                  E20087 E22957
     C***********BCNL      DIV  WNOM      WTOTXX    H              E20087 E22957
     C***********WDCPM     MULT WTOTXX    BUDU      H              E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********          Z-ADD0         BUDU                     E20087 E22957
     C***********          END                                     E20087 E22957
     C***********                                                  E20087 E22957
     C***********          END                                     E20087 E22957
     C***********          END                                     E20087 E22957
     C***********          END                                     E20087 E22957
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  DSPRV  - SUBROUTINE TO PRODUCE DISCOUNT/PREMIUM ACCOUNT KEYS *
      *           ON VALUE DATE                                       *
      *                                                               *
      *****************************************************************
      *
     C           DSPRV     BEGSR                           *** DSPRV  ***
     C*
     C* SET UP COMMON INFORMATION FOR ACCOUNT KEYS
     C*
     C                     MOVE 'V'       EVTP
     C/COPY WNCPYSRC,SE2220C134
      *                                                                                       CSE105
      ** If CSE105 is installed, and this is a Trade Date Basis, set                          CSE105
      ** EVTP to BCTV.                                                                        CSE105
      *                                                                                       CSE105
     C           CSE105    IFEQ 'Y'                                                           CSE105
     C           BCTV      ANDEQ'T'                                                           CSE105
     C                     MOVE BCTV      EVTP                                                CSE105
     C                     ENDIF                                                              CSE105
      *                                                                                       CSE105
     C                     MOVE BCPS      TRTP
     C                     MOVE ' '       PORT
     C                     MOVE '  '      TRST
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C                     MOVE BCTR      TRFR
     C*
     C* SET UP INDICATORS FOR AVERAGE PRICE CHANGES
     C*
     C***********PLAVP     IFGT 100                                       E22957
     C***********LAVP      ANDGT100                                       E22957
     C***********          MOVE '1'       *IN29                           E22957
     C***********          ELSE                                           E22957
     C***********PLAVP     IFLT 100                                       E22957
     C***********LAVP      ANDLT100                                       E22957
     C*                                                                   E22957
     C                     MOVEA'00'      *IN,28                          E22957
     C*                                                                   E22957
      ** If the position changes from long to short or short to long      187328
      ** or if there is a change in the price from premium to discount or 187328
      ** discount to premium, two account keys should be produced.        187328
      *                                                                   187328
     C********** PAPNC     IFGT PBKVAL                             E22957 187328
     C********** APNC      ANDGTBKVAL                              E22957 187328
     C           PAPNC     IFGE 0                                         187328
     C           APNC      ANDGE0                                         187328
     C           PAPNC     IFGE PBKVAL                                    187328
     C           APNC      ANDGEBKVAL                                     187328
     C           PAPNC     ORLT PBKVAL                                    187328
     C           APNC      ANDLTBKVAL                                     187328
     C                     MOVE '1'       *IN29                           E22957
     C                     ELSE                                           187328
     C                     MOVE '1'       *IN28                           187328
     C                     ENDIF                                          187328
     C                     ELSE                                           E22957
     C********** PAPNC     IFLT PBKVAL                             E22957 187328
     C********** APNC      ANDLTBKVAL                              E22957 187328
     C           PAPNC     IFLT 0                                         187328
     C           APNC      ANDLT0                                         187328
     C           PAPNC     IFLE PBKVAL                                    187328
     C           APNC      ANDLEBKVAL                                     187328
     C           PAPNC     ORGT PBKVAL                                    187328
     C           APNC      ANDGTBKVAL                                     187328
     C                     MOVE '1'       *IN29
     C                     ELSE
     C                     MOVE '1'       *IN28
     C                     END
     C                     ELSE                                           187328
     C                     MOVE '1'       *IN28                           187328
     C                     ENDIF                                          187328
     C                     END
     C*
     C*  CHECK WHETHER ONE OR TWO ACCOUNT KEYS ARE REQUIRED -
     C*    (TWO KEYS ARE REQUIRED IF POSITION CHANGES FROM LONG TO SHORT
     C*     OR SHORT TO LONG OR IF AVERAGE PRICE CHANGES FROM DISCOUNT
     C*     TO PREMIUM OR FROM PREMIUM TO DISCOUNT)
     C*
     C*                                                                   E22957
     C* CASES FOR OUTPUT OF TWO ACCOUNT KEYS                              E22957
     C*                                                                   E22957
     C           *IN28     IFEQ '1'                                       E22957
     C           NPAC      OREQ 'Y'                                       E22957
     C           *IN41     ANDEQ'1'                                       E22957
     C*                                                                   E22957
     C*  -  SET UP FIRST ACCOUNT KEY TO SET DISC/PREM TO ZERO             E22957
     C*                                                                   E22957
     C           PNPSN     IFGT 0                                         E22957
     C           PAPNC     ANDLTPBKVAL                                    E22957
     C           PNPSN     ORLT 0                                         E22957
     C           PAPNC     ANDGTPBKVAL                                    E22957
     C                     MOVE 'DS'      AMCD                            E22957
     C                     ELSE                                           E22957
     C                     MOVE 'PR'      AMCD                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C           PNPSN     IFGE 0                                         E22957
     C           NPAC      OREQ 'N'                                       E22957
     C                     MOVE ' '       NEGI                            E22957
     C                     ELSE                                           E22957
     C                     MOVE 'N'       NEGI                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C***  Reverse Posted Premium / Discount and Reset to Zero            E22957
     C*                                                                   E22957
     C                     Z-SUBBUDU      EVAM                            E22957
     C                     Z-ADD0         BUDU                            E22957
     C                     Z-ADD0         BUDN                                                CAS006
     C/COPY WNCPYSRC,SE2220C075
     C*                                                                   E22957
     C** - Reverse sign on Premiums, because different key                E22957
     C*                                                                   E22957
     C           AMCD      IFEQ 'PR'                                      E22957
     C                     Z-SUBEVAM      EVAM                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C** - Reverse sign on Sales, because different key                   E22957
     C*                                                                   E22957
     C           BCPS      IFEQ 'S'                                       E22957
     C                     Z-SUBEVAM      EVAM                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C***  Adjust posting amount by the Mortgage Current Factor.          E22957
     C*                                                                   E22957
     C           PROT      IFEQ '8'                                       E22957
     C/COPY WNCPYSRC,SE2220C160
     C**********           MULT AAPR      EVAM                     E22957 248281
     C                     MULT AAPR      EVAM      H                     248281
     C                     END                                            E22957
     C*                                                                   E22957
     C*  OUTPUT FIRST KEY                                                 E22957
     C*                                                                   E22957
     C           EVAM      IFNE 0                                         E22957
     C                     EXSR W01                                       E22957
     C/COPY WNCPYSRC,SE2220C029
     C                     END                                            E22957
     C/COPY WNCPYSRC,SE2220C076
     C*                                                                   E22957
     C                     END                                       *IN28E22957
     C*                                                                   E22957
     C*                                                                   E22957
     C***  OUTPUT OF NEW UNAMORTISED AMOUNT                               E22957
     C*                                                                   E22957
     C*                                                                   E22957
     C*  -  SET UP REST OF FIELDS FOR ACCOUNT KEY                         E22957
     C*                                                                   E22957
     C           NPSN      IFGT 0                                         E22957
     C           APNC      ANDLTBKVAL                                     E22957
     C           NPSN      ORLT 0                                         E22957
     C           APNC      ANDGTBKVAL                                     E22957
     C                     MOVE 'DS'      AMCD                            E22957
     C                     ELSE                                           E22957
     C                     MOVE 'PR'      AMCD                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C           NPSN      IFGE 0                                         E22957
     C           NPAC      OREQ 'N'                                       E22957
     C                     MOVE ' '       NEGI                            E22957
     C                     ELSE                                           E22957
     C                     MOVE 'N'       NEGI                            E22957
     C                     END                                            E22957
     C/COPY WNCPYSRC,SE2220C077
     C*                                                                   E22957
     C***  Unamortised Prem/Discount is Nominal Book Value Less Average   E22957
     C***  Price Numerator.                                               E22957
     C*                                                                   E22957
     C           BKVAL     SUB  APNC      WBUDU  150                      E22957
     C*                                                                   E22957
     C** - New discount is -ve short posn and +ve long Position           E22957
     C** - New Premium  is +ve short posn and -ve long Position           E22957
     C*                                                                   E22957
     C           WBUDU     SUB  BUDU      EVAM                            E22957
     C                     Z-ADDWBUDU     BUDU                            E22957
     C/COPY WNCPYSRC,SE2220C078
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           BKVALN    SUB  APNN      WBUDN  150                                          CAS006
     C                     Z-ADDWBUDN     BUDN                                                CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   E22957
     C** - Reverse sign on Premiums, because different key                E22957
     C*                                                                   E22957
     C           AMCD      IFEQ 'PR'                                      E22957
     C                     Z-SUBEVAM      EVAM                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C** - Reverse sign on Sales, because different key                   E22957
     C*                                                                   E22957
     C           BCPS      IFEQ 'S'                                       E22957
     C                     Z-SUBEVAM      EVAM                            E22957
     C                     END                                            E22957
     C*                                                                   E22957
     C***  Adjust posting amount by the Mortgage Current Factor.          E22957
     C*                                                                   E22957
     C           PROT      IFEQ '8'                                       E22957
     C/COPY WNCPYSRC,SE2220C161
     C**********           MULT AAPR      EVAM                     E22957 248281
     C                     MULT AAPR      EVAM      H                     248281
     C                     END                                            E22957
     C*                                                                   E22957
     C*  OUTPUT Last  KEY                                                 E22957
     C*                                                                   E22957
     C           EVAM      IFNE 0                                         E22957
     C                     EXSR W01                                       E22957
     C/COPY WNCPYSRC,SE2220C030
     C                     END                                            E22957
     C************IN29     IFEQ '1'                                       E22957
     C************IN30     ANDEQ'1'                                       E22957
     C***********PNPSN     OREQ 0                                         E22957
     C***********PLAVP     OREQ 100                                       E22957
     C***********                                                         E22957
     C**CASES*FOR OUTPUT OF ONE ACCOUNT KEY                               E22957
     C***********                                                         E22957
     C***-**FOR*SALE AND PREVIOUS NOMINAL LONG OR PURCHASE AND PREVIOUS   E22957
     C********NOMINAL SHORT                                               E22957
     C***********                                                         E22957
     C************IN34     IFEQ '1'                                       E22957
     C***********PNPSN     ANDNE0                                         E22957
     C***********                                                         E22957
     C***-**SET*UP REST OF FIELDS FOR ACCOUNT KEY                         E22957
     C***********                                                         E22957
     C***********PLAVP     IFLT 100                                       E22957
     C***********          MOVE 'DS'      AMCD                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'PR'      AMCD                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**MAKE*PREVIOUS*NOMINAL*NEGATIVE*FOR*CALCULATION*************   E20087
     C***-**MAKE*PREVIOUS NOMINAL POSITIVE. (Comment was misleading).0087 E22957
     C***********                                                         E22957
     C***********PNPSN     IFLT 0                                         E22957
     C***********PNPSN     MULT -1        WNOM                            E22957
     C***********          ELSE                                           E22957
     C***********          Z-ADDPNPSN     WNOM                            E22957
     C***********          END                                            E22957
     C***********WNOM      IFNE 0                                         E22957
     C***********                                                  E20087 E22957
     C****If*FIFO processing requested in ICD, reduction to Unamortized87 E22957
     C****Discount/Premium has already been calculated in SR/CLOSE.E20087 E22957
     C***********                                                  E20087 E22957
     C***********FIFO      IFEQ 'Y'                                E20087 E22957
     C***********          Z-ADDUDPLIQ    EVAM                     E20087 E22957
     C***********          Z-ADD0         UDPLIQ                   E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********                                                  E20087 E22957
     C*****Otherwise, calculate reduction on a Proportional Basis  E20087 E22957
     C***********                                                  E20087 E22957
     C*********  BCNL      DIV  WNOM      WTOT   154H                     E15442
     C***********BCNL      DIV  WNOM      WTOTXX 156H              E15442 E22957
     C***********          ELSE                                           E20087
     C*********            Z-ADDBCNL      WTOT                            E15442
     C***********          Z-ADDBCNL      WTOTXX                   E15442 E20087
     C***********          END                                            E20087
     C********** BUDU      MULT WTOT      EVAM      H                     E15442
     C***********BUDU      MULT WTOTXX    EVAM      H              E15442 E22957
     C***********          END                                     E20087 E22957
     C***********                                                  E20087 E22957
     C***********          ELSE                                    E20087 E22957
     C***********                                                  E20087 E22957
     C*****Following line should never execute, since WNOM cannot be20087 E22957
     C*****zero*at this point.                                     E20087 E22957
     C***********                                                  E20087 E22957
     C***********          Z-ADDBUDU      EVAM                     E20087 E22957
     C***********          END                                     E20087 E22957
     C***********                                                         E22957
     C***********PNPSN     IFGE 0                                         E22957
     C***********NPAC      OREQ 'N'                                E15442 E22957
     C***********          MOVE ' '       NEGI                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'N'       NEGI                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**UPDATE UNAMORTISED DISC/PREM                                  E22957
     C***********                                                         E22957
     C***********BUDU      SUB  EVAM      BUDU                            E22957
     C***********                                                         E22957
     C***-**REVERSE*SIGN*OF*EVENT*AMOUNT**********************************E15442
     C***********                                                         E15442
     C***********EVAM      IFGT 0                                         E15442
     C***********EVAM      MULT -1        EVAM                            E15442
     C***********          END                                            E15442
     C***********                                                         E22957
     C***********                                                  E15442 E22957
     C***-**REVERSE SIGN OF EVENT AMOUNT IF A PREMIUM              E15442 E22957
     C***********                                                  E15442 E22957
     C***********AMCD      IFEQ 'PR'                               E15442 E22957
     C***********          Z-SUBEVAM      EVAM                     E15442 E22957
     C***********          END                                     E15442 E22957
     C***********                                                         E22957
     C***********          ELSE                                           E22957
     C***********                                                         E22957
     C***-**FOR*PURCHASE AND PREVIOUS NOMINAL LONG OR SALE AND PREVIOUS   E22957
     C********NOMINAL SHORT                                               E22957
     C***********                                                         E22957
     C************IN36     IFEQ '1'                                       E22957
     C***********PNPSN     ANDNE0                                         E22957
     C***********                                                         E22957
     C**SET*UP*REST OF FIELDS FOR ACCOUNT KEY                             E22957
     C***********                                                         E22957
     C***********PNPSN     IFGE 0                                         E22957
     C***********NPAC      OREQ 'N'                                E15442 E22957
     C***********          MOVE ' '       NEGI                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'N'       NEGI                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********PLAVP     IFLT 100                                       E22957
     C***********          MOVE 'DS'      AMCD                            E22957
     C***********          Z-ADDWDCPM     EVAM                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'PR'      AMCD                            E22957
     C***********WDCPM     MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**UPDATE UNAMORTISED DISC/PREM                                  E22957
     C***********                                                         E22957
     C***********BUDU      ADD  WDCPM     BUDU                            E22957
     C***********                                                         E22957
     C***********          ELSE                                           E22957
     C***********                                                         E22957
     C***-***FOR*PREVIOUS NOMINAL FLAT (ZERO)                             E22957
     C***********                                                         E22957
     C***********PNPSN     IFEQ 0                                         E22957
     C***********                                                         E22957
     C***-**SET*UP REST OF FIELDS FOR ACCOUNT KEY                         E22957
     C***********                                                         E22957
     C***********WDCPM     IFGT 0                                         E22957
     C***********          MOVE 'DS'      AMCD                            E22957
     C***********          Z-ADDWDCPM     EVAM                     E15442 E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'PR'      AMCD                            E22957
     C***********          Z-SUBWDCPM     EVAM                     E15442 E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          Z-ADDWDCPM     EVAM                     E15442 E22957
     C***********                                                         E22957
     C***********BCPS      IFEQ 'P'                                       E22957
     C***********NPAC      OREQ 'N'                                E15442 E22957
     C***********          MOVE ' '       NEGI                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'N'       NEGI                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**UPDATE UNAMORTISED DISC/PREM                                  E22957
     C***********                                                         E22957
     C***********BUDU      ADD  WDCPM     BUDU                            E22957
     C***********                                                         E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**REVERSE*SIGN*OF*AMOUNT*AND*CHANGE*NEGATIVE*INDICATOR*IF****   E15442
     C*******THIS*IS*NEGATIVE*POSTION**********************************   E15442
     C***********                                                         E15442
     C***********NPAC      IFEQ 'N'                                       E15442
     C***********NEGI      ANDEQ'N'                                       E15442
     C***********          MOVE ' '       NEGI                            E15442
     C***********EVAM      MULT -1        EVAM                            E15442
     C***********          END                                            E15442
     C***********                                                  E20086 E22957
     C*****Adjust posting amount by the Mortgage Current Factor.   E20086 E22957
     C***********                                                  E20086 E22957
     C***********PROT      IFEQ '8'                                E20086 E22957
     C***********          MULT AAPR      EVAM                     E20086 E22957
     C***********          END                                     E20086 E22957
     C***********                                                         E22957
     C***-**OUTPUT ACCOUNT KEY                                            E22957
     C***********                                                         E22957
     C***********EVAM      IFNE 0                                         E22957
     C***********          EXSR W01                                       E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          ELSE                                           E22957
     C***********                                                         E22957
     C**CASES*FOR OUTPUT OF TWO ACCOUNT KEYS                              E22957
     C***********                                                         E22957
     C***-**FOR*CHANGE IN AVERAGE PRICE FROM DISC TO PREM OR VICE VERSA   E22957
     C*******AND*EITHER PURCHASE WITH PREVIOUS NOMINAL LONG OR SALE WITH  E22957
     C*******PREVIOUS NOMINAL SHORT                                       E22957
     C***********                                                         E22957
     C************IN36     IFEQ '1'                         **            E22957
     C************IN28     ANDEQ'1'                                       E22957
     C***********                                                         E22957
     C***-**SET*UP FIRST ACCOUNT KEY TO SET DISC/PREM TO ZERO             E22957
     C***********                                                         E22957
     C***********PLAVP     IFLT 100                                       E22957
     C***********          MOVE 'DS'      AMCD                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'PR'      AMCD                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********PNPSN     IFGT 0                                         E22957
     C***********NPAC      OREQ 'N'                               E15442  E22957
     C***********          MOVE ' '       NEGI                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'N'       NEGI                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********BUDU      IFLT 0                                         E15442
     C***********BUDU      IFGT 0                                  E15442 E20921
     C***********BUDU      IFLT 0                                  E20921 E22957
     C***********          Z-ADDBUDU      EVAM                            E22957
     C***********          ELSE                                           E22957
     C***********BUDU      MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**REVERSE*SIGN*OF*AMOUNT*AND*CHANGE*NEGATIVE*IND*IF*THIS*IS**   E15442
     C********NEGATIVE*POSITION****************************************   E15442
     C***********                                                         E15442
     C***********NPAC      IFEQ 'N'                                       E15442
     C***********NEGI      ANDEQ'N'                                       E15442
     C***********          MOVE ' '       NEGI                            E15442
     C***********EVAM      MULT -1        EVAM                            E15442
     C***********          END                                            E15442
     C***********                                                  E20086 E22957
     C*****Adjust posting amount by the Mortgage Current Factor    E20086 E22957
     C***********                                                  E20086 E22957
     C***********PROT      IFEQ '8'                                E20086 E22957
     C***********          MULT AAPR      EVAM                     E20086 E22957
     C***********          END                                     E20086 E22957
     C***********                                                         E22957
     C***-**OUTPUT FIRST ACCOUNT KEY                                      E22957
     C***********                                                         E22957
     C***********EVAM      IFNE 0                                         E22957
     C***********          EXSR W01                                       E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**PRODUCE SECOND KEY TO START NEW DISC/PREM ACCOUNT             E22957
     C***********                                                         E22957
     C***********LAVP      IFLT 100                                       E22957
     C***********          MOVE 'DS'      AMCD                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'PR'      AMCD                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********PNPSN     IFGT 0                                         E22957
     C***********NPAC      OREQ 'N'                                E15442 E22957
     C***********          MOVE ' '       NEGI                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'N'       NEGI                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********BCNL      IFNE 0                                         E20896
     C********** NPSN      DIV  BCNL      WTOT      H                     E15442
     C***********NPSN      DIV  BCNL      WTOTXX    H              E15442 E20896
     C***********          ELSE                                           E20896
     C**********           Z-ADDNPSN      WTOT                            E15442
     C***********          Z-ADDNPSN      WTOTXX                   E15442 E20896
     C***********          END                                            E20896
     C********** WDCPM     MULT WTOT      EVAM      H                     E15442
     C***********WDCPM     MULT WTOTXX    EVAM      H              E15442 E20896
     C***********NPSN      IFGT 0                                  E20896 E22957
     C***********          Z-ADDNPSN      ZNOML                    E20896 E22957
     C***********          ELSE                                    E20896 E22957
     C***********          Z-SUBNPSN      ZNOML                    E20896 E22957
     C***********          END                                     E20896 E22957
     C***********                                                  E20896 E22957
     C***********          Z-ADDLAVP      ZPRC                     E20896 E22957
     C***********          EXSR ZCNSD                              E20896 E22957
     C***********                                                  E20896 E22957
     C***********          Z-ADDZNOML     WBKVAL 130               E20896 E22957
     C***********PPDI      IFEQ 'Y'                                E20896 E22957
     C***********          MOVE BCTA      BCTA3   63               E20896 E22957
     C***********BCTA3     DIV  100       WBCTA  158H              E20896 E22957
     C***********WBKVAL    MULT WBCTA     WBKVAL    H              E20896 E22957
     C***********          END                                     E20896 E22957
     C***********5         SUB  NMDP      DC      10               E20896 E22957
     C***********          ADD  CDP       DC                       E20896 E22957
     C***********                                                  E20896 E22957
     C***********WBKVAL    MULT POWER8,DC WBKVAL    H              E20896 E22957
     C***********WBKVAL    SUB  ZCONS     EVAM                     E20896 E22957
     C***********          Z-ADDEVAM      BUDU                     E20896 E22957
     C***********EVAM      IFLT 0                                         E22957
     C***********EVAM      MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********          Z-ADDEVAM      BUDU                     E20086 E20896
     C***********                                                         E20086
     C**REVERSE*SIGN*IF*NEGATIVE*POSITION******************************   E15442
     C***********                                                         E15442
     C***********NPAC      IFEQ 'N'                                       E15442
     C***********NEGI      ANDEQ'N'                                       E15442
     C***********          MOVE ' '       NEGI                            E15442
     C***********EVAM      MULT -1        EVAM                            E15442
     C***********          END                                            E15442
     C***********                                                         E20086
     C*****Adjust posting amount by the Mortgage Current Factor.          E20086
     C***********                                                         E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********          MULT AAPR      EVAM                            E20086
     C***********          END                                            E20086
     C***********                                                         E22957
     C***-**OUTPUT SECOND ACCOUNT KEY                                     E22957
     C***********                                                         E22957
     C***********EVAM      IFNE 0                                         E22957
     C***********          EXSR W01                                       E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**UPDATE UNAMORTISED DISC/PREM                                  E22957
     C***********                                                         E22957
     C***********          Z-ADDEVAM      BUDU                            E20086
     C***********PLAVP     IFLT 100                                       E20896
     C***********EVAM      IFLT 0                                         E20896
     C***********BUDU      MULT -1        BUDU                            E20896
     C***********          END                                            E20896
     C***********          ELSE                                           E20896
     C***********BUDU      IFGT 0                                         E20896
     C***********BUDU      MULT -1        BUDU                            E20896
     C***********          END                                            E20896
     C***********          END                                            E20896
     C***********                                                         E22957
     C***********          ELSE                                           E22957
     C***********                                                         E22957
     C***-**FOR*CASES WHERE NOMINAL HAS CHANGED FROM LONG TO SHORT OR     E22957
     C*********VICE VERSA                                                 E22957
     C***********                                                         E22957
     C******AND*WHERE PRICE HAS CHANGED FROM DISC/PREM OR VICE VERSA      E22957
     C***********                                                         E22957
     C***********NPAC      IFEQ 'Y'                                       E22957
     C************IN28     OREQ '1'                                       E22957
     C***********                                                         E22957
     C************IN31     IFEQ '1'                                       E22957
     C***********                                                         E22957
     C***-**SET*UP FIRST ACCOUNT KEY FOR POSITION GOING FLAT              E22957
     C***********                                                         E22957
     C***********PLAVP     IFLT 100                                       E22957
     C***********          MOVE 'DS'      AMCD                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'PR'      AMCD                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********PNPSN     IFGT 0                                         E22957
     C***********NPAC      OREQ 'N'                                       E15442
     C***********          MOVE ' '       NEGI                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'N'       NEGI                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********BUDU      IFLT 0                                         E15442
     C***********BUDU      IFGT 0                                         E15442
     C***********          Z-ADDBUDU      EVAM                            E22957
     C***********          ELSE                                           E22957
     C***********BUDU      MULT -1        EVAM                            E22957
     C***********          END                                            E22957
     C***********                                                         E20086
     C*****Adjust posting amount by the Mortgage Current Factor.          E20086
     C***********                                                         E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********          MULT AAPR      EVAM                            E20086
     C***********          END                                            E20086
     C***********                                                         E22957
     C***********                                                         E22957
     C***-**OUTPUT FIRST ACCOUNT KEY                                      E22957
     C***********                                                         E22957
     C***********EVAM      IFNE 0                                         E22957
     C***********          EXSR W01                                       E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**SET*UP SECOND KEY FOR NEW POSITION                            E22957
     C***********                                                         E22957
     C***********LAVP      IFLT 100                                       E22957
     C***********          MOVE 'DS'      AMCD                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'PR'      AMCD                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********NPSN      IFLT 0                                         E22957
     C***********NPAC      ANDNE'N'                                       E15442
     C***********          MOVE 'N'       NEGI                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE ' '       NEGI                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********NPSN      IFLT 0                                         E22957
     C***********NPSN      MULT -1        WNOM                            E22957
     C***********          ELSE                                           E22957
     C***********          Z-ADDNPSN      WNOM                            E22957
     C***********          END                                            E22957
     C***********BCNL      IFNE 0                                         E20896
     C***********WNOM      DIV  BCNL      WTOT      H                     E15442
     C***********WNOM      DIV  BCNL      WTOTXX    H              E15442 E20896
     C***********          ELSE                                           E20896
     C***********          Z-ADDWNOM      WTOT                            E15442
     C***********          Z-ADDWNOM      WTOTXX                   E15442 E20896
     C***********          END                                            E20896
     C***********WDCPM     MULT WTOT      EVAM      H                     E15442
     C***********WDCPM     MULT WTOTXX    EVAM      H              E15442 E20896
     C***********                                                         E20896
     C***********          Z-ADDWNOM      ZNOML                           E20896
     C***********          Z-ADDLAVP      ZPRC                            E20896
     C***********          EXSR ZCNSD                                     E20896
     C***********                                                         E20896
     C***********          Z-ADDZNOML     WBKVAL 130                      E20896
     C***********PPDI      IFEQ 'Y'                                       E20896
     C***********          MOVE BCTA      BCTA3   63                      E20896
     C***********BCTA3     DIV  100       WBCTA  158H                     E20896
     C***********WBKVAL    MULT WBCTA     WBKVAL    H                     E20896
     C***********          END                                            E20896
     C***********5         SUB  NMDP      DC      10                      E20896
     C***********          ADD  CDP       DC                              E20896
     C***********                                                         E20896
     C***********WBKVAL    MULT POWER8,DC WBKVAL    H                     E20896
     C***********WBKVAL    SUB  ZCONS     EVAM                            E20896
     C***********          Z-ADDEVAM      BUDU                            E20086
     C***********                                                         E22957
     C***-**RESET*NEGATIVE*INDICATOR*AND*REVERSE*AMOUNT*SIGN*IF*NEGATIVE  E15442
     C*******POSITION**************************************************   E15442
     C***********                                                         E15442
     C***********NPAC      IFEQ 'N'                                       E15442
     C***********NEGI      ANDEQ'N'                                       E15442
     C***********          MOVE ' '       NEGI                            E15442
     C***********EVAM      MULT -1        EVAM                            E15442
     C***********          END                                            E15442
     C***********                                                         E20921
     C**Reverse*sign for account key if premium                           E20921
     C***********EVAM      IFLT 0                                         E20921
     C***********          Z-SUBEVAM      EVAM                            E20921
     C***********          END                                            E20921
     C***********                                                         E20086
     C*****Adjust posting amount by the Mortgage Current Factor.          E20086
     C***********                                                         E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********          MULT AAPR      EVAM                            E20086
     C***********          END                                            E20086
     C***********                                                         E22957
     C***-**WRITE SECOND ACCOUNT KEY                                      E22957
     C***********                                                         E22957
     C***********EVAM      IFNE 0                                         E22957
     C***********          EXSR W01                                       E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**UPDATE UNAMORTISED DISC/PREM                                  E22957
     C***********                                                         E22957
     C***********          Z-ADDEVAM      BUDU                            E20086
     C***********PLAVP     IFLT 100                                       E20896
     C***********BUDU      IFLT 0                                         E20896
     C***********BUDU      MULT -1        BUDU                            E20896
     C***********          END                                            E20896
     C***********          ELSE                                           E20896
     C***********BUDU      IFGT 0                                         E20896
     C***********BUDU      MULT -1        BUDU                            E20896
     C***********          END                                            E20896
     C***********          END                                            E20896
     C***********                                                         E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          ELSE                                           E22957
     C***********                                                         E22957
     C***-**FOR*CASES FOR TWO KEYS BUT BOTH WOULD BE PR OR DS             E22957
     C******BUT*A NEGATIVE POSITION                                       E22957
     C***********                                                         E22957
     C***********PLAVP     IFLT 100                                       E22957
     C***********          MOVE 'DS'      AMCD                            E22957
     C***********          ELSE                                           E22957
     C***********          MOVE 'PR'      AMCD                            E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          MOVE ' '       NEGI                            E22957
     C***********                                                         E22957
     C***********WDCPM     IFLT 0                                         E15442
     C***********WDCPM     IFGT 0                                  E15442 E20960
     C***********          Z-ADDWDCPM     EVAM                            E20960
     C***********          ELSE                                           E20960
     C***********WDCPM     MULT -1        EVAM                            E20960
     C***********          END                                            E20960
     C***********                                                         E20960
     C***********NPSN      IFLT 0                                         E20960
     C***********NPSN      MULT -1        WNOM                            E20960
     C***********          ELSE                                           E20960
     C***********          Z-ADDNPSN      WNOM                            E20960
     C***********          END                                            E20960
     C***********                                                         E20960
     C***********          Z-ADDWNOM      ZNOML                           E20960
     C***********          Z-ADDLAVP      ZPRC                            E20960
     C***********          EXSR ZCNSD                                     E20960
     C***********                                                         E20960
     C***********          Z-ADDZNOML     WBKVAL 130                      E20960
     C***********PPDI      IFEQ 'Y'                                       E20960
     C***********          MOVE BCTA      BCTA3   63                      E20960
     C***********BCTA3     DIV  100       WBCTA  158H                     E20960
     C***********WBKVAL    MULT WBCTA     WBKVAL    H                     E20960
     C***********          END                                            E20960
     C***********5         SUB  NMDP      DC      10                      E20960
     C***********          ADD  CDP       DC                              E20960
     C***********                                                         E20960
     C***********WBKVAL    MULT POWER8,DC WBKVAL    H                     E20960
     C***********WBKVAL    SUB  ZCONS     WBKVAL                          E20960
     C***********                                                         E20960
     C***********BUDU      ADD  WBKVAL    EVAM                            E20960
     C***********EVAM      IFLT 0                                         E20960
     C***********          Z-SUBEVAM      EVAM                            E20960
     C***********          END                                            E20960
     C***********                                                         E20086
     C*****Adjust posting amount by the Mortgage Current Factor.          E20086
     C***********                                                         E20086
     C***********PROT      IFEQ '8'                                       E20086
     C***********          MULT AAPR      EVAM                            E20086
     C***********          END                                            E20086
     C***********                                                         E22957
     C***-**OUTPUT JUST ONE ACCOUNT KEY                                   E22957
     C***********                                                         E22957
     C***********EVAM      IFNE 0                                         E22957
     C***********          EXSR W01                                       E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***-**UPDATE UNAMORTISED DISC/PREM                                  E22957
     C***********                                                         E22957
     C***********          Z-ADDWBKVAL    BUDU                            E20960
     C***********BCPS      IFEQ 'P'                                       E20960
     C***********BUDU      ADD  WDCPM     BUDU                            E20960
     C***********          ELSE                                           E20960
     C***********BCPS      IFEQ 'S'                                       E20960
     C***********BUDU      SUB  WDCPM     BUDU                            E20960
     C***********          END                                            E20960
     C***********          END                                            E20960
     C***********                                                         E22957
     C***********LAVP      IFGT 100                                       E20960
     C***********BUDU      MULT -1        BUDU                            E20960
     C***********          END                                            E20960
     C***********                                                         E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C***********          END                                            E22957
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  PIAI   - SUBROUTINE TO PRODUCE KEYS FOR PURCHASED/ACCRUED    *
      *           INTEREST.                                           *
      *                                                               *
      *****************************************************************
      *
     C           PIAI      BEGSR                           ***  PIAI  ***
     C*
     C* SET COMMON FIELDS ON ACCOUNT KEY
     C*
     C                     MOVE 'V'       EVTP
     C                     MOVE BCPS      TRTP
     C                     MOVE ' '       PORT
     C                     MOVE TRCP      CSTN
     C           TSAK      IFEQ 'Y'
     C                     MOVE BCTP      TRST
     C                     ELSE
     C                     MOVE '  '      TRST
     C                     END
     C                     MOVE BCTR      TRFR
      *
      *----------------------------------------------------------------
      * CASE 1 : SPLIT NEG ACCR. IS N    OR  NOMINAL CASE 2 OR 3 (P10)*
      *     AND  CUM-COUPON CASE 3 (P10) OR  TRADE IS EX-COUPON       *
      *----------------------------------------------------------------
      *
     C           SNAC      IFEQ 'N'
     C           *IN42     OREQ '1'
     C           *IN43     OREQ '1'
     C*
     C           *IN46     IFEQ '1'
     C           ACRI      OREQ 'X'
     C*
     C*  - IF ACCRUED IND IS CUM-COUPON, WRITE PI KEY
     C*
     C           ACRI      IFEQ 'C'
     C           ACRI      OREQ 'F'                                       E20085
     C                     MOVE 'PI'      AMCD
     C                     ELSE
     C*
     C*  - IF ACCRUED IND IS EX-COUPON, WRITE AI KEY
     C*
     C                     MOVE 'AI'      AMCD
     C                     END
     C*
     C           SNAC      IFEQ 'N'
     C           PNPSN     ORGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C           CPNR      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*
     C                     Z-ADDPCHI      EVAM
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDPCHN      EVAN   130                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C031
     C                     END
     C*
     C*  - UPDATE PURCHASED AND ACCRUED INTEREST ON POSITION
     C*
     C           BCPS      IFEQ 'P'
      *
     C           ACRI      IFEQ 'C'
     C           ACRI      OREQ 'F'                                       E20085
     C                     ADD  EVAM      PILP
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     ADD  EVAN      PILN                                                CAS006
     C                     Z-ADDEVAN      WBCPX  130                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADDEVAM      WBCP1                           E20085
     C                     ELSE
     C                     ADD  EVAM      ARPC
     C                     END
      *
     C                     ELSE
     C           ACRI      IFEQ 'C'
     C           ACRI      OREQ 'F'                                       E20085
     C           PILP      SUB  EVAM      PILP
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           PILN      SUB  EVAN      PILN                                                CAS006
     C                     Z-SUBEVAN      WBCPX                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C***********          Z-ADDEVAM      WBCP1                     E20085108187
     C                     Z-SUBEVAM      WBCP1                           108187
     C                     ELSE
     C           ARPC      SUB  EVAM      ARPC
     C                     END
      *
     C                     END
     C*
     C                     GOTO EPIAI
     C*
     C                     END
     C                     END
      *
      *----------------------------------------------------------------
      * CASE 2 : SPLIT NEG ACCR. N   OR   NOMINAL CASES 2 OR 3 (P10)  *
      *     AND  CUM COUPON NOM CASE 2 (P10)                          *
      *----------------------------------------------------------------
      *
     C           SNAC      IFEQ 'N'
     C           *IN42     OREQ '1'
     C           *IN43     OREQ '1'
     C*
     C           *IN45     IFEQ '1'
     C*
     C*  - SET UP AND WRITE PURCHASED INTEREST KEY
     C*
     C                     MOVE 'PI'      AMCD
      *
     C           SNAC      IFEQ 'N'
     C           PNPSN     ORGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
      *                                                                   E20085
     C           FIFO      IFNE 'Y'                                       E20085
     C           PNPSN     OREQ *ZERO                                     E20427
     C*
      ***  Avoid truncation in WSTOT by using DIV/MULT trick.             E20085
      ***  This applies for all currencies.                               E20085
      *
     C***E15715*-*Avoid*truncation*in*WSTOT*by*dividing*nominal*by*****   E15715
     C************1000000*and*then*multiplying*EVAM*by*1000000*if******   E15715
     C************processing*a*Yen*Bond.*******************************   E15715
     C***********                                                         E15715
     C***********PROT      IFNE '5'                                E15715 E20085
     C***********                                                         E20085
     C***********BCNL      MULT PILP      WSTOT                           E20085
     C***********                                                  E15715 E20085
     C***********          ELSE                                    E15715 E20085
     C***********BCNL      DIV  1000000   BCNLY  156               E15715 E22957
     C***********BCNLY     MULT PILP      WSTOT                    E15715 E22957
     C***********          END                                     E15715 E20085
     C*
     C*** To prevent rounding of PI when nominal less than 1,000,000      E22957
     C**                                                                  E22957
     C           PCUMP     IFNE 0
     C                     Z-ADDPCUMP     ZPNPSN                          E22957
     C                     Z-ADDBCNL      ZNPSN                           E22957
     C                     Z-ADDPILP      ZAPIN                           E22957
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    EVAM                            E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDPCUMP     ZPNPSN                                              CAS006
     C                     Z-ADDBCNL      ZNPSN                                               CAS006
     C                     Z-ADDPILN      ZAPIN                                               CAS006
     C                     EXSR ZAPORT                                                        CAS006
     C                     Z-ADDZAPOUT    EVAN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C***********PROT      IFEQ '5'                                E15715 E20085
     C***********WSTOT     DIV  PCUMP     EVAMY  156H              E15715 E22957
     C***********EVAMY     MULT 1000000   EVAM                     E15715 E22957
     C***********          ELSE                                    E15715 E20085
     C***********WSTOT     DIV  PCUMP     EVAM      H                     E20085
     C***********          END                                     E15715 E20085
     C                     ELSE
     C                     Z-ADD0         EVAM
     C                     Z-ADD0         EVAN                                                CAS006
     C                     END
      *                                                                   E20085
     C                     Z-ADDEVAM      WBCP1                           E20085
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDEVAN      WBCPX                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     ELSE                                           E20085
      *                                                                   E20085
      ***  PEVAM should be updated after the WBCP1 checking in case       E20085
      ***  EVAM is updated. (Section was incorrectly updating PEVAM).     E20085
      *                                                                   E20085
     C***********          Z-ADDEVAM      PEVAM  150                      E20085
      *                                                                   E20085
      *** Store Position PI if not calced                                 E20085
      *** OR use FIFO PI for posting & calc of AI                         E20085
      *                                                                   E20085
     C                     Z-ADDWBCP1     EVAM                            E20085
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDWBCPX     EVAN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END                                            E20085
      *                                                                   E20085
     C                     Z-ADDEVAM      PEVAM  150                      E20085
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDEVAN      PEVAN  150                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C032
     C                     END
     C*
     C*  - SET UP AND WRITE ACCRUED INTEREST KEY
     C*
     C                     MOVE 'AI'      AMCD
     C           PCHI      SUB  EVAM      EVAM
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C033
     C                     END
     C*
     C*  - UPDATE PURCHASED AND ACCRUED INTEREST ON POSITION
     C*
     C           BCPS      IFEQ 'P'
     C                     ADD  PEVAM     PILP
     C                     ADD  EVAM      ARPC
     C                     ELSE
     C           PILP      SUB  PEVAM     PILP
     C           ARPC      SUB  EVAM      ARPC
     C                     END
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           BCPS      IFEQ 'P'                                                           CAS006
     C                     ADD  PEVAN     PILN                                                CAS006
     C                     ELSE                                                               CAS006
     C           PILN      SUB  PEVAN     PILN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
     C*
     C                     GOTO EPIAI
     C*
     C                     END
     C                     END
      *
      *----------------------------------------------------------------
      * CASE 3 : SPLIT NEG ACCR. N   OR   NOMINAL CASES 2 OR 3 (P10)  *
      *     AND  CUM-COUPON CASE 1 (P10)                              *
      *----------------------------------------------------------------
      *
     C           SNAC      IFEQ 'N'
     C           *IN42     OREQ '1'
     C           *IN43     OREQ '1'
     C*
     C           *IN44     IFEQ '1'
     C*
     C*   - CALCULATE PURCHASED INTEREST ON NEW POSITION
      *                                                                   E20085
     C           FIFO      IFNE 'Y'                                       E20085
     C           PNPSN     OREQ *ZERO                                     E20427
     C*
     C           PCUMP     IFLT 0
     C           PCUMP     MULT -1        RPCUMP
     C                     ELSE
     C                     Z-ADDPCUMP     RPCUMP
     C                     END
     C**                                                                  E22957
     C*** To prevent rounding of PI when nominal less than 1,000,000      E22957
     C**                                                                  E22957
     C*
     C           BCNL      IFNE 0
     C                     Z-ADDBCNL      ZPNPSN                          E22957
     C                     Z-ADDRPCUMP    ZNPSN                           E22957
     C                     Z-ADDPCHI      ZAPIN                           E22957
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    WSTOT                           E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDBCNL      ZPNPSN                                              CAS006
     C                     Z-ADDRPCUMP    ZNPSN                                               CAS006
     C                     Z-ADDPCHN      ZAPIN                                               CAS006
     C                     EXSR ZAPORT                                                        CAS006
     C                     Z-ADDZAPOUT    WSTON  150                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C********** PCHI      DIV  BCNL      WTOT      H                     E15442
      *                                                                   E20085
      ***  Avoid truncation in WSTOT by using DIV/MULT 1M trick.          E20085
      *                                                                   E20085
     C***********PCHI      DIV  BCNL      WTOT   154H                     E20085
     C***********BCNL      DIV  1000000   BCNLY                    E20085 E22957
     C***********RPCUMP    DIV  1000000   RPCUMY 156               E20085 E22957
     C***********PCHI      DIV  BCNLY     WTOT   154H              E20085 E22957
      *                                                            E20085 E22957
      *                                                                   E20085
     C                     ELSE
     C                     Z-ADD0         WSTOT                           E22957
     C                     Z-ADD0         WSTON                                               CAS006
     C***********          Z-ADD0         WTOT                            E22957
     C                     END
      *
     C***********WTOT      MULT RPCUMP    WSTOT     H                     E20085
     C***********WTOT      MULT RPCUMY    WSTOT     H              E20085 E22957
     C           PCHI      SUB  WSTOT     WSTOT
      *
     C           BCPS      IFEQ 'P'
     C           WSTOT     SUB  PILP      EVAM
     C                     ELSE
     C           WSTOT     ADD  PILP      EVAM
     C                     END
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
      *                                                                                       CAS006
     C           PCHN      SUB  WSTON     WSTON                                               CAS006
     C           BCPS      IFEQ 'P'                                                           CAS006
     C           WSTON     SUB  PILN      EVAN                                                CAS006
     C                     ELSE                                                               CAS006
     C           WSTON     ADD  PILN      EVAN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                   E20085
     C                     Z-ADDEVAM      WBCP1                           E20085
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDEVAN      WBCPX                                               CAS006
     C                     ENDIF                                                              CAS006
     C                     ELSE                                           E20085
      *                                                                   E20085
      *** Store Position PI if not calced                                 E20085
      *** OR use FIFO PI for posting & calc of AI                         E20085
      *                                                                   E20085
     C                     Z-ADDWBCP1     EVAM                            E20085
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDWBCPX     EVAN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END                                            E20085
     C*
     C*  - SET UP AND WRITE PURCHASED INTEREST KEY
     C*
     C                     MOVE 'PI'      AMCD
     C           SNAC      IFEQ 'N'
     C           PNPSN     ORGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*
     C                     Z-ADDEVAM      PEVAM
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDEVAN      PEVAN                                               CAS006
     C                     ENDIF                                                              CAS006
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C034
     C                     END
     C*
     C*  - SET UP AND WRITE ACCRUED INTEREST KEY
     C*
     C                     MOVE 'AI'      AMCD
     C           PCHI      SUB  EVAM      EVAM
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C035
     C                     END
     C*
     C*  - UPDATE PURCHASED AND ACCRUED INTEREST ON POSITION
     C*
     C           BCPS      IFEQ 'P'
     C                     ADD  PEVAM     PILP
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     ADD  PEVAN     PILN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     ADD  EVAM      ARPC
     C                     ELSE
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           PILN      SUB  PEVAN     PILN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C           PILP      SUB  PEVAM     PILP
     C           ARPC      SUB  EVAM      ARPC
     C                     END
     C*
     C                     GOTO EPIAI
     C*
     C                     END
     C                     END
      *
      *----------------------------------------------------------------
      * CASE 4 : NOMINAL CASE 1  (P10)                                *
      *     AND  CUM-COUPON NOM CASE 3 (P10)  OR  TRADE IS EX-COUPON  *
      *----------------------------------------------------------------
      *
     C           *IN41     IFEQ '1'
     C*
     C           *IN46     IFEQ '1'
     C           ACRI      OREQ 'X'
     C*
     C*  - SET UP AND WRITE PURCHASED INTEREST KEY
     C*
     C                     MOVE 'PI'      AMCD
     C           PNPSN     IFGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*
     C*
     C           BCPS      IFEQ 'P'
     C           PILP      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDPILP      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C036
     C                     END
     C*
     C*  - SET UP AND WRITE ACCRUED INTEREST KEY
     C*
     C                     MOVE 'AI'      AMCD
     C*
     C           BCPS      IFEQ 'P'
     C           ARPC      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDARPC      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C037
     C                     END
     C*
     C*  - CALCULATE PURCHASED INTEREST ON NEW POSITION
     C*
     C           ACRI      IFEQ 'C'
     C           ACRI      OREQ 'F'                                       E20085
     C           BCPS      IFEQ 'P'
     C           PILP      ADD  PCHI      PILP
     C                     Z-ADDPCHI      WBCP1                           E20085
     C                     ELSE
     C           PILP      SUB  PCHI      PILP
     C***********          Z-ADDPCHI      WBCP1                     E20085108187
     C                     Z-SUBPCHI      WBCP1                           108187
     C                     END
     C                     END
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
      *                                                                                       CAS006
     C           ACRI      IFEQ 'C'                                                           CAS006
     C           ACRI      OREQ 'F'                                                           CAS006
     C           BCPS      IFEQ 'P'                                                           CAS006
     C           PILN      ADD  PCHN      PILN                                                CAS006
     C                     Z-ADDPCHN      WBCPX                                               CAS006
     C                     ELSE                                                               CAS006
     C           PILN      SUB  PCHN      PILN                                                CAS006
     C                     Z-SUBPCHN      WBCPX                                               CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
     C*
     C*  - SET UP AND WRITE NEW PURCHASED INTEREST KEY
     C*
     C                     MOVE 'PI'      AMCD
     C           NPSN      IFGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*
     C           BCPS      IFEQ 'S'
     C           PILP      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDPILP      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C038
     C                     END
     C*
     C*  - SET UP AND WRITE NEW ACCRUED INTEREST KEY
     C*
     C                     MOVE 'AI'      AMCD
     C*
     C           ACRI      IFEQ 'X'
     C           BCPS      IFEQ 'P'
     C           ARPC      ADD  PCHI      ARPC
     C                     ELSE
     C           ARPC      SUB  PCHI      ARPC
     C                     END
     C                     END
     C*
     C           BCPS      IFEQ 'S'
     C           ARPC      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDARPC      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C039
     C                     END
     C*
     C                     GOTO EPIAI
     C*
     C                     END
     C                     END
      *
      *----------------------------------------------------------------
      * CASE 5 : NOMINAL CASE 1 (P10)                                 *
      *     AND  CUM-COUPON NOM CASE 2 (P10)                          *
      *----------------------------------------------------------------
      *
     C           *IN41     IFEQ '1'
     C           *IN45     ANDEQ'1'
     C*
     C*  - SET AND WRITE PURCHASED INTEREST KEY
     C*
     C                     MOVE 'PI'      AMCD
     C           PNPSN     IFGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*
     C           BCPS      IFEQ 'P'
     C           PILP      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDPILP      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C040
     C                     END
     C*
     C*  - SET UP AND WRITE ACCRUED INTEREST KEY
     C*
     C                     MOVE 'AI'      AMCD
     C*
     C           BCPS      IFEQ 'P'
     C           ARPC      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDARPC      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C041
     C                     END
     C*
     C*  - CALCULATE PURCHASED INTEREST ON NEW POSITION
     C*
     C           FIFO      IFNE 'Y'                                       E20085
     C           PNPSN     OREQ *ZERO                                     E20427
      *                                                                   E20085
     C           PCUMP     IFLT 0
     C           PCUMP     MULT -1        RPCUMP 150
     C                     ELSE
     C                     Z-ADDPCUMP     RPCUMP
     C                     END
     C*
      ***  Avoid truncation in WSTOT by DIV/MULT 1M trick.                E20085
      ***  This applies to all currencies.                                E20085
      *
     C***E15715*-*Avoid*truncation*in*WSTOT*by*dividing*nominal*by*E15715 E20085
     C************1000000*and*then*multiplying*WTOT*by*1000000*if**E15715 E20085
     C************processing*a*Yen*Bond.***************************E15715 E20085
     C*                                                                   E15715
     C***********PROT      IFNE '5'                                E15715 E22957
     C***********PILP      MULT BCNL      WSTOT                           E22957
     C*                                                                   E15715
     C***********          ELSE                                    E15715 E22957
     C***********BCNL      DIV  1000000   BCNLY  156               E15715 E22957
     C***********BCNLY     MULT PILP      WSTOT                    E15715 E22957
     C***********          END                                     E15715 E22957
     C**                                                                  E22957
     C*** To prevent rounding of PI when nominal less than 1,000,000      E22957
     C*
     C           RPCUMP    IFNE 0
     C                     Z-ADDRPCUMP    ZPNPSN                          E22957
     C                     Z-ADDBCNL      ZNPSN                           E22957
     C                     Z-ADDPILP      ZAPIN                           E22957
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    WSTOT                           E22957
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDRPCUMP    ZPNPSN                                              CAS006
     C                     Z-ADDBCNL      ZNPSN                                               CAS006
     C                     Z-ADDPILN      ZAPIN                                               CAS006
     C                     EXSR ZAPORT                                                        CAS006
     C                     Z-ADDZAPOUT    WSTON                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C***********PROT      IFEQ '5'                                E15715 E20085
     C***********WSTOT     DIV  RPCUMP    WTOTY  156H              E15715 E22957
     C***********WTOTY     MULT 1000000   WTOT                     E15715 E22957
     C***********          ELSE                                    E15715 E20085
     C***********WSTOT     DIV  RPCUMP    WTOT      H                     E20085
     C***********          END                                     E15715 E20085
     C                     ELSE
     C***********          Z-ADD0         WTOT                            E22957
     C                     Z-ADD0         WSTOT                           E22957
     C                     Z-ADD0         WSTON                                               CAS006
     C                     END
      *
     C***********PILP      SUB  WTOT      EVAM                            E22957
     C           PILP      SUB  WSTOT     EVAM                            E22957
     C                     Z-ADDEVAM      PEVAM
      *                                                                   E20085
     C                     Z-ADDEVAM      WBCP2                           E20085
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           PILN      SUB  WSTON     EVAN                                                CAS006
     C                     Z-ADDEVAN      PEVAN                                               CAS006
     C                     Z-ADDEVAN      WBCPY  130                                          CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     ELSE                                           E20085
      *                                                                   E20085
      *** Store Position PI if not calced                                 E20085
      *** OR use FIFO PI for posting & calc of AI                         E20085
      *                                                                   E20085
     C           BCPS      IFEQ 'S'                                       E20085
     C                     Z-SUBWBCP2     EVAM                            E20085
     C                     ELSE                                           E20085
     C                     Z-ADDWBCP2     EVAM                            E20085
     C                     END                                            E20085
     C                     END                                            E20085
     C*
     C*  - SET UP AND WRITE NEW PURCHASED INTEREST KEY
     C*
     C                     MOVE 'PI'      AMCD
     C           NPSN      IFGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*
     C           BCPS      IFEQ 'S'
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C042
     C                     END
     C*
     C*  - SET UP AND WRITE NEW ACCRUED INTEREST KEY
     C*    - REVERSE SIGN OF PURCHASED INTEREST FOR SALE
     C*
     C           BCPS      IFEQ 'S'
     C           PCHI      MULT -1        RBCPI  130
     C                     ELSE
     C                     Z-ADDPCHI      RBCPI
     C                     END
     C*
     C                     MOVE 'AI'      AMCD
     C           PILP      SUB  PEVAM     WSTOT
     C           WSTOT     ADD  RBCPI     WSTOT
     C           ARPC      ADD  WSTOT     ARPC
     C           BCPS      IFEQ 'S'
     C           ARPC      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDARPC      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C043
     C                     END
     C*
     C*  - UPDATE PURCHASED AND ACCRUED INTEREST ON POSITION
     C*
     C                     Z-ADDPEVAM     PILP
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDPEVAN     PILN                                                CAS006
     C                     ENDIF                                                              CAS006
     C*
     C                     GOTO EPIAI
     C*
     C                     END
      *
      *----------------------------------------------------------------
      * CASE 6 : NOMINAL CASE 1 (P10)                                 *
      *     AND  CUM-COUPON CASE 1 (P10)                              *
      *----------------------------------------------------------------
      *
     C           *IN41     IFEQ '1'
     C           *IN44     ANDEQ'1'
     C*
     C*  - SET UP AND WRITE PURCHASED INTEREST KEY
     C*
     C                     MOVE 'PI'      AMCD
     C           PNPSN     IFGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*
     C           BCPS      IFEQ 'P'
     C           PILP      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDPILP      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C044
     C                     END
     C*
     C*  - SET UP AND WRITE ACCRUED INTEREST KEY
     C*
     C                     MOVE 'AI'      AMCD
     C           BCPS      IFEQ 'P'
     C           ARPC      MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDARPC      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C045
     C                     END
     C*
     C*  - CALCULATE PURCHASED INTEREST ON NEW POSITION
      *                                                                   E20085
     C           FIFO      IFNE 'Y'                                       E20085
     C           PNPSN     OREQ *ZERO                                     E20427
     C*
     C           PCUMP     IFLT 0
     C           PCUMP     MULT -1        RPCUMP
     C                     ELSE
     C                     Z-ADDPCUMP     RPCUMP
     C                     END
     C**                                                                  E22957
     C*** To prevent rounding of PI when nominal less than 1,000,000      E22957
     C*
     C           BCNL      IFNE 0
     C                     Z-ADDBCNL      ZPNPSN                          E22957
     C                     Z-ADDRPCUMP    ZNPSN                           E22957
     C***********          Z-ADDPILP      ZAPIN                    E22957 E36622
     C                     Z-ADDPCHI      ZAPIN                           E36622
     C                     EXSR ZAPORT                                    E22957
     C                     Z-ADDZAPOUT    WSTOT                           E22957
     C*
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDBCNL      ZPNPSN                                              CAS006
     C                     Z-ADDRPCUMP    ZNPSN                                               CAS006
     C                     Z-ADDPCHN      ZAPIN                                               CAS006
     C                     EXSR ZAPORT                                                        CAS006
     C                     Z-ADDZAPOUT    WSTON                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                            E20085 E22957
     C*****Avoid*truncation*in*WSTOT*by*DIV/MULT*1M*trick.         E20085 E22957
      *                                                            E20085 E22957
     C***********PCHI      DIV  BCNL      WTOT      H              E20085 E22957
     C***********BCNL      DIV  1000000   BCNLY                    E20085 E22957
     C***********RPCUMP    DIV  1000000   RPCUMY 156               E20085 E22957
     C***********PCHI      DIV  BCNLY     WTOT      H              E20085 E22957
      *                                                                   E20085
     C                     ELSE
     C***********          Z-ADD0         WTOT                            E22957
     C                     Z-ADD0         WSTOT                           E22957
     C                     Z-ADD0         WSTON                                               CAS006
     C                     END
      *                                                                   E20085
     C***********WTOT      MULT RPCUMP    WSTOT     H                     E20085
     C***********WTOT      MULT RPCUMY    WSTOT     H              E20085 E22957
     C           PCHI      SUB  WSTOT     EVAM
      *                                                                   E20085
     C                     Z-ADDEVAM      WBCP2                           E20085
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           PCHN      SUB  WSTON     EVAN                                                CAS006
     C                     Z-ADDEVAN      WBCPY                                               CAS006
     C                     ENDIF                                                              CAS006
     C                     ELSE                                           E20085
      *                                                                   E20085
      *** Store Position PI if not calced                                 E20085
      *** OR use FIFO PI for posting & calc of AI                         E20085
      *                                                                   E20085
      ***  If going from flat to short, SR/CLOSE has not executed.        E21539
     C           PNPSN     IFEQ *ZERO                                     E21539
     C           WBCP2     ANDEQ*ZERO                                     E21539
     C                     Z-ADDPCHI      EVAM                            E21539
     C                     Z-ADDPCHI      WBCP2                           E21539
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDPCHN      EVAN                                                CAS006
     C                     Z-ADDPCHN      WBCPY                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     ELSE                                           E21539
     C                     Z-ADDWBCP2     EVAM                            E20085
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDWBCPY     EVAN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     END                                            E21539
     C                     END                                            E20085
      *                                                                   E20085
     C                     Z-ADDEVAM      PEVAM
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDEVAN      PEVAN                                               CAS006
     C                     ENDIF                                                              CAS006
     C*
     C*  - SET UP AND WRITE NEW PURCHASED INTEREST KEY
     C*
     C                     MOVE 'PI'      AMCD
     C           NPSN      IFGE 0
     C           SNAC      OREQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C046
     C                     END
     C*
     C*  - SET UP AND WRITE NEW ACCRUED INTEREST KEY
     C*
     C                     MOVE 'AI'      AMCD
     C           BCPS      IFEQ 'S'
     C           PCHI      SUB  PILP      WSTOT
     C           WSTOT     SUB  ARPC      WSTOT
     C                     ELSE
     C           PCHI      ADD  PILP      WSTOT
     C           WSTOT     ADD  ARPC      WSTOT
     C                     END
     C*
     C           WSTOT     SUB  EVAM      ARPC
     C                     Z-ADDARPC      EVAM
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C047
     C                     END
     C*
     C*    - UPDATE PURCHASED AND ACCRUED INTEREST ON POSITION
     C*
     C           BCPS      IFEQ 'S'
     C                     Z-SUBPEVAM     PILP
     C                     Z-SUBEVAM      ARPC
     C                     ELSE
     C                     Z-ADDPEVAM     PILP
     C                     Z-ADDEVAM      ARPC
     C                     END
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           BCPS      IFEQ 'S'                                                           CAS006
     C                     Z-SUBPEVAN     PILN                                                CAS006
     C                     ELSE                                                               CAS006
     C                     Z-ADDPEVAN     PILN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
     C*
     C                     END
     C*
     C           EPIAI     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  PI     - SUBROUTINE TO PRODUCE ACCOUNT KEY/S FOR PURCHASED   *
      *           INTEREST.                                           *
      *                                                               *
      *****************************************************************
      *
     C           PI        BEGSR                           ***   PI   ***
     C*
     C* SET COMMON FIELDS FOR KEY
     C*
     C                     MOVE 'V'       EVTP
     C                     MOVE BCPS      TRTP
     C                     MOVE ' '       PORT
     C           TSAK      IFEQ 'Y'
     C                     MOVE BCTP      TRST
     C                     ELSE
     C                     MOVE '  '      TRST
     C                     END
     C                     MOVE 'PI'      AMCD
     C                     MOVE TRCP      CSTN
     C                     MOVE BCTR      TRFR
      *
      *----------------------------------------------------------------
      * CASE 1 : ONE KEY REQUIRED                                     *
      *          NOMINAL CASE 2 OR 3 (P10)  OR  SPLIT NEG ACCR. N     *
      *----------------------------------------------------------------
      *
     C           *IN42     IFEQ '1'
     C           *IN43     OREQ '1'
     C           SNAC      OREQ 'N'
     C*
     C*  - SET UP AND WRITE PURCHASED INTEREST KEY
     C*
     C           SNAC      IFEQ 'N'
     C           NPSN      ORGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           SNAC      ANDEQ'Y'
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
      *
     C                     Z-ADDPCHI      EVAM
     C                     Z-ADDPCHI      WBCP1                           E20085
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C048
     C                     END
     C*
     C*  -  UPDATE PURCHASED INTEREST ON POSITION
     C*
     C           BCPS      IFEQ 'P'
     C           PNPSN     IFEQ 0                                         051044
     C           PECNP     ANDEQ0                                         174234
     C                     Z-ADDPCHI      PILP                            051044
     C                     Z-ADD0         ARPC                            097328
     C                     ELSE                                           051044
     C           PILP      ADD  PCHI      PILP
     C                     END                                            051044
     C                     ELSE
     C           PNPSN     IFEQ 0                                         051044
     C           PECNP     ANDEQ0                                         174234
     C                     Z-SUBPCHI      PILP                            051044
     C                     Z-ADD0         ARPC                            097328
     C                     ELSE                                           051044
     C           PILP      SUB  PCHI      PILP
     C                     END                                            051044
     C                     END
     C*
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           BCPS      IFEQ 'P'                                                           CAS006
     C           PNPSN     IFEQ 0                                                             CAS006
     C           PECNP     ANDEQ0                                                             CAS006
     C                     Z-ADDPCHN      PILN                                                CAS006
     C                     ELSE                                                               CAS006
     C           PILN      ADD  PCHN      PILN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ELSE                                                               CAS006
     C           PNPSN     IFEQ 0                                                             CAS006
     C           PECNP     ANDEQ0                                                             CAS006
     C                     Z-SUBPCHN      PILN                                                CAS006
     C                     ELSE                                                               CAS006
     C           PILN      SUB  PCHN      PILN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                                       CAS006
     C                     ELSE
      *
      *----------------------------------------------------------------
      * CASE 2 : NOMINAL CHANGES CASE 1 (P10)                         *
      *     AND  SPLIT NEG ACCR. Y                                    *
      *----------------------------------------------------------------
      *
     C           *IN41     IFEQ '1'
     C           SNAC      ANDEQ'Y'
     C*
     C*  - SET UP AND WRITE PURCHASED INTEREST KEY
     C*
     C           PNPSN     IFGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
      *
     C           BCPS      IFEQ 'S'
     C           ARPC      ADD  PILP      EVAM
     C                     ELSE
     C           ARPC      ADD  PILP      EVAM
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C049
     C                     END
     C*
     C*  -  CALCULATE PURCHASED INTEREST ON NEW POSITION
     C*
     C           BCPS      IFEQ 'S'
     C           PCHI      MULT -1        RBCPI
     C                     ELSE
     C                     Z-ADDPCHI      RBCPI
     C                     END
     C*
     C           ACRI      IFEQ 'X'
     C           ARPC      ADD  RBCPI     ARPC
     C                     ELSE
     C           PILP      ADD  RBCPI     PILP
     C                     Z-ADDPCHI      WBCP1                           E20085
     C                     END
     C*
     C*  -  PRODUCE SECOND KEY FOR PURCHASED INTEREST ON NEW POSITION
     C*
     C           NPSN      IFGE 0
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
      *
     C           CPNR      IFLT 0
     C           NEGI      IFEQ 'N'
     C                     MOVE ' '       NEGI
     C                     ELSE
     C                     MOVE 'N'       NEGI
     C                     END
     C                     END
     C*
     C           BCPS      IFEQ 'P'
     C           ARPC      ADD  PILP      EVAM
     C                     ELSE
     C           ARPC      ADD  PILP      EVAM
     C           EVAM      MULT -1        EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C050
     C                     END
     C*
     C                     END
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  UNRLPL - SUBROUTINE TO CALCULATE UNREALIZED PROFIT/LOSS AND  *
      *           TO OUTPUT UNREALIZED P/L ACCOUNT KEYS               *
      *                                                               *
      *****************************************************************
      *
     C           UNRLPL    BEGSR                           *** UNRLPL ***
     C*
     C**UNREALISED*P/L*IS*SET*TO*ZERO*OF*MARKET*PRICE*IS*ZERO*******      091803
      ***  If this Subroutine was called from SR/P60 (Price Changes),     E15965
      ***  then use details of the Price Change, Else Subroutine was      E15965
      ***  called on change of Position for Daily Unrealsed P/L Posting   E15965
     C*
     C***********MKPR      IFEQ 0                                         E15965
     C           PRCCHG    IFEQ 'Y'                                       E15965
     C           BCPR      ANDEQ*ZERO                                     E15965
     C           PRCCHG    ORNE 'Y'                                       E15965
     C           MKPR      ANDEQ*ZERO                                     E15965
     C*                                                                   091803
     C** IF MARKET PRICE EQUALS TO ZERO CHAIN TO PRICED FILE IF A         091803
     C** PRICE EXISTS.                                                    091803
     C*                                                                   091803
     C                     MOVE BCSS      PSSN                            091803
     C                     MOVE 'V '      PPRT                            091803
     C                     Z-ADDECD       PVDT                            091803
     C*                                                                   091803
     C           PKEY      SETGTPRICED                                    091803
     C                     READPPRICED                   48               091803
     C*                                                                   091803
     C           *IN48     IFEQ *OFF                                      091803
     C           PSSN      ANDEQBCSS                                      091803
     C           PPRT      ANDEQ'V '                                      091803
     C           PPRC      ANDEQ0                                         091803
     C                     SETOF                         49               091803
     C                     ELSE                                           091803
     C                     SETON                         49               091803
     C                     END                                            091803
     C*                                                                   091803
     C                     END                                            091803
     C*                                                                   091803
     C** IF NO MARKET PRICE EXISTS THEN SKIP UNREALISED PROFIT AND        091803
     C** LOSS PROCESSING.                                                 091803
     C*                                                                   091803
     C           *IN49     IFEQ *ON                                       091803
     C                     Z-ADD0         UPPT
     C                     SETOF                         49               091803
     C                     ELSE
     C*
     C* STORE UNREALISED P/L AS PREVIOUS
     C*
     C                     Z-ADDUPPT      PUPPT  130
      *                                                                   E20087
      *****If*this*is*a*discount-based*trade*date*position,*calculate 087 E20552
      *****unrealized*P/L*on*trade-by-trade*basis*in*ADJUPL(FIFO only).87 E20552
      ***********                                                  E20087 E20552
     C***********BHTV      IFEQ 'T'                                E20087 E20552
     C***********STBS      ANDEQ'D'                                E20087 E20552
     C***********FIFO      ANDEQ'Y'                                E20087 E20552
     C***********PNPSN     ANDNE*ZERO                              E20427 E20552
     C***********          EXSR ADJUPL                             E20087 E20552
     C***********          Z-ADDWKUPPT    UPPT                     E20087 E20552
     C***********          ELSE                                           E20087
     C*                                                                   E15965
     C* CONVERT MARKET PRICE FROM PRICE/DISC/YIELD FORMAT TO PRICE
     C*  FORMAT
     C*
     C           PRCCHG    IFEQ 'Y'                                       E15965
     C                     Z-ADDBCAD      ZFDATE                          E15965
     C                     Z-ADDBCPR      ZPRCIN                          E15965
     C                     ELSE                                           E15965
     C***********          Z-ADDRUND      ZFDATE                          E15965
      *                                                                   E20087
      ***  Average price on discounted instruments reflects amortization  E20087
      ***  up to date of last action, so use KBCAD in converting MKPR.    E20087
      *                                                                   E20087
     C***********          Z-ADDECD       ZFDATE                   E15965 E20087
     C                     Z-ADDKBCAD     ZFDATE                          E20087
      *                                                                   E20087
     C                     Z-ADDMKPR      ZPRCIN
     C                     END                                            E15965
      *                                                                   E19429
      *****For*yield-based*instruments, adjust for first-day accruaE19429 E22957
      *****Otherwise,*SE2210*will need to generate another account E19429 E22957
      *****even*if*date*on*the last action for this position was toE19429 E22957
      ****  This fix now redundant as unrealized P/L posting is not       E22957
      ****  done by SE2220 if accrual date is due.SE2210 will do this.    E22957
      *                                                                   E19429
     C***********STBS      IFEQ 'Y'                                E19429 E22957
     C***********ACLD      ANDEQ'N'                                E19429 E22957
     C***********          ADD  1         ZFDATE                   E19429 E22957
     C***********          END                                     E19429 E22957
     C*                                                                   S01232
     C*      Australian yield parameters                                  S01232
     C*                                                                   S01232
     C           *IN53     IFEQ '1'                                       S01232
     C           NPSN      ANDNE0                                         S01232
     C*                                                                   E20953
     C* set nominal to positive for working on                            E20953
     C           NPSN      IFLT 0                                         E20953
     C                     Z-SUBNPSN      WNOML  130                      E20953
     C                     ELSE                                           E20953
     C                     Z-ADDNPSN      WNOML                           E20953
     C                     END                                            E20953
     C*                                                                   E22957
     C* Obtain next coupon date                                           E22957
     C* (Add 1 to ECD so that if ZFDATE=NCD,calculate NCD after that)     E22957
     C           ZFDATE    ADD  1         ECD                             E22957
     C                     EXSR ZNCD                                      E22957
     C*                                                                   E22957
     C* Obtain last coupon date                                           E22957
     C           NCD       SUB  1         ZECD                            E22957
     C                     EXSR ZLCD                                      E22957
     C                     Z-ADDZZLCD     LCOUP   50                      E22957
     C*                                                                   E20953
     C* Determine if period is Cum or Ex                                  E20953
     C***********          Z-ADDBCAD      WRKD    50               E20953 E22957
     C                     Z-ADDZFDATE    WRKD    50                      E22957
     C                     EXSR ZYCE                                      E20953
     C*                                                                   E20953
     C* Calculate interest for Cum period (SCUMEX = C)                    E20953
     C           SCUMEX    IFEQ 'C'                                       E20953
     C***********          Z-ADDSVLCPN    ZDCSDT                   S01232 E22957
     C                     Z-ADDLCOUP     ZDCSDT                          E22957
     C                     Z-ADDZFDATE    ZDCEDT                          S01232
     C***********          Z-ADDNPSN      ZAMT                     S01232 E20953
     C                     Z-ADDWNOML     ZAMT                            E20953
     C/COPY WNCPYSRC,SE2220C105
     C                     EXSR ZACCZ                                     S01232
     C/COPY WNCPYSRC,SE2220C106
     C                     Z-ADDZDCINT    TOTACC                          E20953
     C                     Z-ADDZDCINT    WRKPIX                          E22957
     C***********ZDCINT    DIV  NPSN      WRKPI                    S01232 E20953
     C***********          Z-ADDBCAD      WRKD    50               S01232 E20953
     C***********          EXSR ZYCE                               S01232 E20953
     C***********                                                  E20953 E22957
     C**Calculate*the*Accrued*Interest*on*the*Ex-Coupon*Nominal*** E20953 E22957
     C***********ECNP      IFEQ 0                                  E20953 E22957
     C***********          Z-ADD0         WTCPN                    E20953 E22957
     C***********          ELSE                                    E20953 E22957
     C***********          Z-ADDSVLCPN    ZDCSDT                   E20953 E22957
     C***********          Z-ADDNCD       ZDCEDT                   E20953 E22957
     C***********ECNP      IFLT 0                                  E20953 E22957
     C***********          Z-SUBECNP      ZAMT                     E20953 E22957
     C***********          ELSE                                    E20953 E22957
     C***********          Z-ADDECNP      ZAMT                     E20953 E22957
     C***********          END                                     E20953 E22957
     C***********          EXSR ZACCZ                              E20953 E22957
     C***********          Z-ADDZDCINT    WTCPN                    E20953 E22957
     C***********          END                                     E20953 E22957
     C***********                                                  E20953 E22957
     C***********TOTACC    SUB  WTCPN     WRKPIX                   E20953 E22957
     C***********WRKPIX    IFLT 0                                  E20953 E21084
     C***********WRKPIX    IFLE 0                                  E21084 E22957
     C***********          MOVE 'X'       SCUMEX                   E20953 E22957
     C***********          END                                     E20953 E22957
     C*                                                                   E20953
     C                     END                                            E20953
     C*                                                                   S01232
     C*          IF EX-COUPON THEN PI PASSED IS THE REMAINING INTEREST    S01232
     C*          TILL NCD AND IS NEGATIVE                                 S01232
     C*                                                                   S01232
     C           SCUMEX    IFEQ 'X'                                       S01232
     C***********          Z-ADDSVLCPN    ZDCSDT                   S01232 E22957
     C                     Z-ADDLCOUP     ZDCSDT                          E22957
     C                     Z-ADDNCD       ZDCEDT                          S01232
     C/COPY WNCPYSRC,SE2220C107
     C                     EXSR ZACCZ                                     S01232
     C/COPY WNCPYSRC,SE2220C108
     C                     Z-ADDZDCINT    NCDWRK                          E20953
     C***********ZDCINT    DIV  NPSN      WKWPI  159               S01232 E20953
     C***********WRKPI     SUB  WKWPI     WRKPI                    S01232 E20953
     C*                                                                   E20953
     C* Calculate interest to Next Coupon Date                            E20953
     C* ( = LCDWRK - NCDWRK )                                             E22957
     C***********          Z-ADDSVLCPN    ZDCSDT                   E20953 E22957
     C***********          Z-ADDBCAD      ZDCEDT                   E20953 E22957
     C                     Z-ADDLCOUP     ZDCSDT                          E22957
     C                     Z-ADDZFDATE    ZDCEDT                          E22957
     C/COPY WNCPYSRC,SE2220C109
     C                     EXSR ZACCZ                                     E20953
     C/COPY WNCPYSRC,SE2220C110
     C                     Z-ADDZDCINT    LCDWRK                          E20953
     C*                                                                   E20953
     C           LCDWRK    SUB  NCDWRK    WRKPIX                          E20953
     C*                                                                   E20953
     C                     END                                            E20953
     C*                                                                   E20953
     C* Make interest figure a percentage                                 E20953
     C           WRKPIX    DIV  WNOML     WRKPI                           E20953
     C*                                                                   E20953
     C***********          END                                     S01232 E20953
     C                     ELSE                                           S01232
     C                     Z-ADD0         WRKPI                           S01232
     C                     MOVE 'C'       SCUMEX                          S01232
     C                     END                                            S01232
      *                                                                   E19429
     C                     Z-ADDNPSN      ZNOML                           E39495
     C*                                                                   E39495
     C                     EXSR ZPRCI
     C*
     C/COPY WNCPYSRC,SE2220C060
     C*  CALCULATE PRICE DIFFERENCE
     C*
     C           ZPRCOT    SUB  LAVP      WPRICE
     C*
     C* OBTAIN NEW UNREALISED P/L
     C*
     C                     Z-ADD*ZEROS    WPRLS  150
     C***********          Z-ADD*ZEROS    WPRLS0 150                      E20232
     C***********          Z-ADD*ZEROS    WPRLS1 151                      E20232
     C***********          Z-ADD*ZEROS    WPRLS2 152                      E20232
     C***********          Z-ADD*ZEROS    WPRLS3 153                      E20232
     C***********          MOVEA'0000'    *IN,70                          E20232
     C***********70        ADD  CDP       J       20                      E20232
     C***********          MOVEA'1'       *IN,J                           E20232
     C***70******NPSN      MULT WPRICE    WPRLS0    H                     E20232
     C***71******NPSN      MULT WPRICE    WPRLS1    H                     E20232
     C***72******NPSN      MULT WPRICE    WPRLS2    H                     E20232
     C***73******NPSN      MULT WPRICE    WPRLS3    H                     E20232
     C***********                                                         E20232
     C***70******          MOVE WPRLS0    WPRLS                           E20232
     C***71******          MOVE WPRLS1    WPRLS                           E20232
     C***72******          MOVE WPRLS2    WPRLS                           E20232
     C***73******          MOVE WPRLS3    WPRLS                           E20232
     C*
     C* Convert Realised P/L Amount
     C*
     C***********5         SUB  NMDP      DC      10                      E20232
     C***********WPRLS     MULT POWER8,DC UPPT      H                     E20232
     C                     Z-ADDNPSN      ZNOML                           E20232
     C                     Z-ADDWPRICE    ZPRC                            E20232
     C/COPY WNCPYSRC,SE2220C079
     C                     EXSR ZCNSD                                     E20232
     C                     Z-ADDZCONS     UPPT                            E20232
     C*
     C***********SPBS      IFEQ 'P'                                       E20232
     C***********UPPT      DIV  100       UPPT      H                     E20232
     C***********          END                                            E20232
     C***********                                                  E20087 E20552
     C***********          END                                     E20087 E20552
     C***********                                                         E20552
     C***********PROT      IFEQ '8'                                       E20086
     C***********UPPT      MULT CFCT      WTOT      H                     E20086
     C***********          Z-ADDWTOT      UPPT      H                     E20086
     C***********          END                                            E20086
     C*
     C* SET COMMON FIELDS FOR ACCOUNT KEYS
     C*
     C                     MOVE 'A'       EVTP
     C                     MOVE ' '       TRTP
     C                     MOVE ' '       PORT
      *                                                                   E19397
      ***  If this subroutine is called from mainline processing, BCTV    E19397
      ***  has already been overwritten by the next BPACC record.         E19397
      *                                                                   E19397
     C           PRCCHG    IFEQ 'Y'                                       E19397
     C                     MOVE BCTV      PSBS
     C                     ELSE                                           E19397
     C                     MOVE KBCTV     PSBS                            E19397
     C                     END                                            E19397
      *                                                                   E19397
     C                     MOVE ' '       FILL
     C**********           Z-ADDISSR      CSTN                                                CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C                     MOVE *ZEROS    TRFR
     C*                                                                   E15746
      ***  The following processing has been moved to permit correct      E19433
      ***  posting of Unrealized P/L when Nominal changes from long to    E19433
      ***  short or vice-versa. Also, should use NPAC, not SNAC.          E19433
     C*                                                                   E15746
     C**NEGI*SHOULD*BE*'N'*FOR*UNREAL*P/L*ON*SHORT*POS*IF*SNAC*=*'Y'15746 E19433
     C***********                                                  E15746 E19433
     C***********NPSN      IFGE 0                                  E15746 E19433
     C***********SNAC      OREQ 'N'                                E15746 E19433
     C***********          MOVE ' '       NEGI                     E15746 E19433
     C***********          ELSE                                    E15746 E19433
     C***********          MOVE 'N'       NEGI                     E15746 E19433
     C***********          END                                     E15746 E19433
     C***********                                                  E15746 E19433
     C*
     C* SET INDICATOR FOR NEW AND PREVIOUS UNREALISED P/L
     C*
      ***  And check move of Nominal from short to long and vice versa.   E19433
      *                                                                   E19433
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     MOVE '0'       *IN37                                               CAS006
     C                     ELSE                                                               CAS006
     C           ONPSN     IFGE 0                                         E19433
     C           NPSN      ANDGE0                                         E19433
     C           ONPSN     ORLE 0                                         E19433
     C           NPSN      ANDLE0                                         E19433
      *                                                                   E19433
     C           UPPT      IFLE 0
     C           PUPPT     ANDLE0
     C                     MOVE '1'       *IN37
     C                     ELSE
     C           UPPT      IFGE 0
     C           PUPPT     ANDGE0
     C                     MOVE '1'       *IN37
     C                     END
     C                     END
      *                                                                   E19433
     C                     END                                            E19433
     C                     ENDIF                                                              CAS006
     C*
     C* PRODUCE ACCOUNT KEYS IF NEW UNREALISED P/L GREATER THAN 0
     C*  AND POSTING BASIS IS NOT 'L' OR NEW UNREALISED P/L IS LESS THAN
     C*  ZER0 AND PROFIT POSTING IS NOT 'P'
     C*
     C           UPPT      IFGT 0
     C           UPPS      ANDNE'L'
     C                     GOTO UNRLKY
     C                     ELSE
      *
     C           UPPT      IFLT 0
     C           UPPS      ANDNE'P'
     C                     GOTO UNRLKY
     C                     ELSE
      *
     C           PUPPT     IFGT 0                                         E15965
     C           UPPS      ANDNE'L'                                       E15965
     C                     GOTO UNRLKY                                    E15965
     C                     END                                            E15965
      *
     C           PUPPT     IFLT 0                                         E15965
     C           UPPS      ANDNE'P'                                       E15965
     C                     GOTO UNRLKY                                    E15965
     C                     END                                            E15965
      *                                                                                       228110
      **  Accrued interest to date should be considered as the current                        228110
      **  profit/loss if market price entered results to zero profit                          228110
      **  or loss.                                                                            228110
      *                                                                                       228110
     C           CAS006    IFEQ 'Y'                                                           228110
     C           WPRICE    ANDEQ0                                                             228110
     C           ARPC      ANDNE0                                                             228110
     C                     GOTO UNRLKY                                                        228110
     C                     ENDIF                                                              228110
      *
     C                     GOTO EURLPL
     C                     END
     C                     END
     C*
     C           UNRLKY    TAG
     C*
     C*  -  PRODUCE ONE KEY IF PREVIOUS AND NEW UNREAL. P/L BOTH LESS
     C*      THAN OR BOTH GREATER THAN 0
      *** AND if nominal has not moved from short to long or vice-versa.  E19433
     C*
     C           *IN37     IFEQ '1'
     C*
     C           UPPT      IFGT 0
      *                                                                   E19445
      ***  Since UPPT may be zero, need to check PUPPT as well in deter-  E19445
      ***  mining whether this posting is a change to profit or loss.     E19445
      *                                                                   E19445
     C           PUPPT     ORGT 0                                         E19445
      *                                                                   E19445
     C                     MOVE 'UP'      AMCD
     C                     ELSE
     C                     MOVE 'UL'      AMCD
     C                     END
      *                                                                   E19433
      ***  Allow Negative Position Accounting for Unrealized P/L:- NEGI   E19433
      ***  should be 'N' for Unrealized P/L on short posn if NPAC = 'Y'.  E19433
      *                                                                   E19433
     C           NPSN      IFGE 0                                         E19433
     C           ONPSN     ANDGE0                                         E19433
     C           NPAC      OREQ 'N'                                       E19433
     C                     MOVE ' '       NEGI                            E19433
     C                     ELSE                                           E19433
     C                     MOVE 'N'       NEGI                            E19433
     C                     END                                            E19433
     C*
     C           UPPT      SUB  PUPPT     EVAM
     C*
     C           UPPT      IFLT 0
     C           PUPPT     ORLT 0                                         E19445
      *                                                                   E19445
     C           EVAM      MULT -1        EVAM
     C                     END
      *                                                                   E20086
      ***  Adjust posting amount by the Mortgage Current Factor.          E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C162
     C                     MULT AAPR      EVAM                            E20086
     C                     END                                            E20086
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C051
     C                     END
     C*
     C*  ELSE PRODUCE TWO KEYS IF TRADE MOVES FROM PROFIT TO LOSS OR
     C*  FROM LOSS TO PROFIT
     C*
     C                     ELSE
     C*
     C*  -  PRODUCE REVERSAL KEY FOR UNRL P/L
     C*
     C           PUPPT     IFGT 0
     C                     MOVE 'UP'      AMCD
     C                     ELSE
     C                     MOVE 'UL'      AMCD
     C                     END
      *                                                                   E19433
      ***  Allow Negative Position Accounting for Unrealized P/L:- NEGI   E19433
      ***  should be 'N' for Unrealized P/L on short posn if NPAC = 'Y'.  E19433
      *                                                                   E19433
     C           ONPSN     IFGE 0                                         E19433
     C           NPAC      OREQ 'N'                                       E19433
     C                     MOVE ' '       NEGI                            E19433
     C                     ELSE                                           E19433
     C                     MOVE 'N'       NEGI                            E19433
     C                     END                                            E19433
     C*
     C           PUPPT     IFGT 0
     C           PUPPT     MULT -1        EVAM
     C                     ELSE
     C                     Z-ADDPUPPT     EVAM
     C                     END
      *                                                                   E20086
      ***  Adjust posting amount by the Mortgage Current Factor.          E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C           CAS006    ANDNE'Y'                                                           CAS006
     C/COPY WNCPYSRC,SE2220C163
     C                     MULT AAPR      EVAM                            E20086
     C                     END                                            E20086
     C*
     C           EVAM      IFNE 0
     C           AMCD      ANDEQ'UL'                                      174050
     C           UPPS      ANDNE'P'                                       174050
     C           EVAM      ORNE 0                                         174050
     C           AMCD      ANDEQ'UP'                                      174050
     C           UPPS      ANDNE'L'                                       174050
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C052
     C                     END
     C*
     C*  -  PRODUCE  KEY FOR NEW UNRL. P/L
     C*
     C           UPPT      IFGT 0
     C                     MOVE 'UP'      AMCD
     C                     ELSE
     C                     MOVE 'UL'      AMCD
     C                     END
      *                                                                   E19433
      ***  Allow Negative Position Accounting for Unrealized P/L:- NEGI   E19433
      ***  should be 'N' for Unrealized P/L on short posn if NPAC = 'Y'.  E19433
      *                                                                   E19433
     C           NPSN      IFGE 0                                         E19433
     C           NPAC      OREQ 'N'                                       E19433
     C                     MOVE ' '       NEGI                            E19433
     C                     ELSE                                           E19433
     C                     MOVE 'N'       NEGI                            E19433
     C                     END                                            E19433
     C*
     C                     Z-ADDUPPT      EVAM
     C*
     C           UPPT      IFLT 0
     C           EVAM      MULT -1        EVAM
     C                     END
      *                                                                   E20086
      ***  Adjust posting amount by the Mortgage Current Factor.          E20086
      *                                                                   E20086
     C           PROT      IFEQ '8'                                       E20086
     C/COPY WNCPYSRC,SE2220C164
     C                     MULT AAPR      EVAM                            E20086
     C                     END                                            E20086
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C           UPPT      IFGT 0                                                             CAS006
     C                     Z-ADDEVAM      WEVAM  150                                          CAS006
     C                     ELSE                                                               CAS006
     C                     Z-SUBEVAM      WEVAM                                               CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       228948
      ** Do not add accrued interest in UP/UL if 'Supress Accrued                             228948
      ** Interest..' indicator in Hedge ICD is set to 'Y'.                                    228948
      *                                                                                       228948
     C           FSEXRL    IFEQ 'Y'                                                           228948
     C                     ADD  ARPC      WEVAM                                               CAS006
     C                     ENDIF                                                              228948
      *                                                                                       228948
     C                     Z-ADDWEVAM     UPPT                                                CAS006
      *                                                                                       CAS006
     C           UPPT      IFGT 0                                                             CAS006
     C                     MOVE 'UP'      AMCD                                                CAS006
     C                     ELSE                                                               CAS006
     C                     MOVE 'UL'      AMCD                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADDUPPT      EVAM                                                CAS006
     C           UPPT      IFLT 0                                                             CAS006
     C           UPPT      MULT -1        EVAM                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
     C*
     C           EVAM      IFNE 0
     C           AMCD      ANDEQ'UL'                                      174050
     C           UPPS      ANDNE'P'                                       174050
     C           EVAM      ORNE 0                                         174050
     C           AMCD      ANDEQ'UP'                                      174050
     C           UPPS      ANDNE'L'                                       174050
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2220C053
     C                     END
     C*
     C                     END
     C                     END
     C*
     C           EURLPL    ENDSR                           *** EURLPL ***
      *
      *****************************************************************
      /EJECT                                                              E20087
      ************************************************************ E20087 E20552
      ***********                                                  E20087 E20552
      ***ADJUPL*-*Subroutine*to*adjust*Unrealized*Profit/Loss*for* E20087 E20552
      ************Discounted*Trade*Date*Positions.**************** E20087 E20552
      ***********                                                  E20087 E20552
      ************************************************************ E20087 E20552
      ***********                                                  E20087 E20552
     C***********ADJUPL    BEGSR                                   E20087 E20552
      ***********                                                  E20087 E20552
      *****Clear*'Cerrent*FIFO*Trade*Found'*Indicator*and*Total*fields.87 E20552
      ***********                                                  E20087 E20552
     C***********          MOVE '0'       *IN82                    E20087 E20552
     C***********          Z-ADD0         TOTBC                    E20087 E20552
     C***********          Z-ADD0         TOTMV                    E20087 E20552
      ***********                                                  E20087 E20552
     C***********          MOVE BHTR      BHTRA   6                E20087 E20552
      ***********                                                  E20087 E20552
     C***********TRDKEY    CHAINTRDMTHF              83            E20087 E20552
      ***********                                                  E20087 E20552
      *****Loop*for*all*Trades*for*this*Position.***************** E20087 E20552
     C************IN83     DOWEQ'0'                                E20087 E20552
      ***********                                                  E20087 E20552
     C***********RECI      IFNE '*'                                E20087 E20552
     C***********TINC      ANDEQ'C'                                E20087 E20552
      ***********                                                  E20087 E20552
      *****If*Current*FIFO*Trade,*use*remaining*unliquidated*Nominal.0087 E20552
      ***********                                                  E20087 E20552
     C************IN82     IFEQ '0'                                E20087 E20552
     C***********TDRF      ANDEQBHTRA                              E20087 E20552
      ***********                                                  E20087 E20552
     C***********          MOVE '1'       *IN82                    E20087 E20552
     C***********          Z-ADDBHRN      NOML                     E20087 E20552
     C***********          MOVE TDTP      STDTP   2                E20087 E20552
      ***********                                                  E20087 E20552
      *****Convert*Market*Discount*Rate*to*Current*Percentage*Price.20087 E20552
      ***********                                                  E20087 E20552
     C***********PRCCHG    IFEQ 'Y'                                E20087 E20552
     C***********          Z-ADDBCPR      ZPRCIN                   E20087 E20552
     C***********          ELSE                                    E20087 E20552
     C***********          Z-ADDMKPR      ZPRCIN                   E20087 E20552
     C***********          END                                     E20087 E20552
     C***********          Z-ADDKBCAD     ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCI                              E20087 E20552
     C***********          Z-ADDZPRCOT    MPCURR 158               E20087 E20552
      ***********                                                  E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
      *****Only*process*Current*FIFO*Trade*and*later*Trades*of*same*type. E20552
      ***********                                                  E20087 E20552
     C************IN82     IFEQ '1'                                E20087 E20552
     C***********TDTP      ANDEQSTDTP                              E20087 E20552
     C***********TDDT      ANDLEKBCAD                              E20087 E20552
     C***********          EXSR ACCUM                              E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
     C***********TRDKEY    READETRDMTHF                8383        E20087 E20552
      ***********                                                  E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
      *****Calculate*unrealized*P/L*using*accumulated*values.***** E20087 E20552
      ***********                                                  E20087 E20552
     C************IN82     IFEQ '1'                                E20087 E20552
     C***********TOTMV     SUB  TOTBC     WKUPPT 150               E20087 E20552
      ***********                                                  E20087 E20552
      *****Adjust*for*percentage*pricing.************************* E20087 E20552
      ***********                                                  E20087 E20552
     C***********WKUPPT    DIV  100       WKUPPT                   E20087 E20552
      ***********                                                  E20087 E20552
      *****Update*average*price.********************************** E20087 E20552
     C***********5         ADD  CDP       DC      10               E20087 E20552
     C***********NPSN      MULT POWER8,DC POS150 150               E20087 E20552
     C***********TOTBC     DIV  POS150    LAVP      H              E20087 E20552
      ***********                                                  E20087 E20552
     C***********          ELSE                                    E20087 E20552
     C***********          Z-ADD0         WKUPPT                   E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
     C***********          ENDSR                                   E20087 E20552
      ***********                                                  E20087 E20552
      ************************************************************ E20087 E20552
      *EJECT*****                                                  E20087 E20552
      ************************************************************ E20087 E20552
      ***********                                                  E20087 E20552
      ***ACCUM*-*Subroutine*to*Accumulate*Adjusted*Consideration*from 087 E20552
      ***********Trades.****************************************** E20087 E20552
      ***********                                                  E20087 E20552
      *************************************************************E20087 E20552
      ***********                                                  E20087 E20552
     C***********ACCUM     BEGSR                                   E20087 E20552
      ***********                                                  E20087 E20552
      *****If*Trade*pre-dates*KBCAD,*convert*Discount*to*Price*as*of 0087 E20552
      *****KBCAD,*ELSE*use*Percentage*Price*(PRIC)*form*Trade*Record.0087 E20552
      ***********                                                  E20087 E20552
     C***********TDVD      IFLT KBCAD                              E20087 E20552
     C***********          Z-ADDTPDY      ZPRCIN                   E20087 E20552
     C***********          Z-ADDKBCAD     ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCI                              E20087 E20552
     C***********          Z-ADDZPRCOT    PRIC                     E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
      *****Calculate*Adjusted*Book*Cost.************************** E20087 E20552
     C***********5         ADD  CDP       DC      10               E20087 E20552
     C***********NOML      MULT POWER8,DC WRK150 150               E20087 E20552
     C***********WRK150    MULT PRIC      BKCT   150H              E20087 E20552
      ***********                                                  E20087 E20552
      *****Accumulate*Book*Cost.********************************** E20087 E20552
     C***********          ADD  BKCT      TOTBC  150               E20087 E20552
      ***********                                                  E20087 E20552
      *****Market*Price/Value*Calculations.*********************** E20087 E20552
      ***********                                                  E20087 E20552
      *****If*Trade*post-dates*KBCAD,*convert*Market*Discount*to*Price 87 E20552
      *****as*at*TDVD;*ELSE*use*Price*as*at*KBCAD*calculated*in*ADJUPL.87 E20552
      ***********                                                  E20087 E20552
     C***********TDVD      IFGT KBCAD                              E20087 E20552
     C***********PRCCHG    IFEQ 'Y'                                E20087 E20552
     C***********          Z-ADDBCPR      ZPRCIN                   E20087 E20552
     C***********          ELSE                                    E20087 E20552
     C***********          Z-ADDMKPR      ZPRCIN                   E20087 E20552
     C***********          END                                     E20087 E20552
     C***********          Z-ADDTDVD      ZFDATE                   E20087 E20552
     C***********          EXSR ZPRCI                              E20087 E20552
     C***********WRK150    MULT ZPRCOT    MKVL   150H              E20087 E20552
     C***********          ELSE                                    E20087 E20552
     C***********WRK150    MULT MPCURR    MKVL      H              E20087 E20552
     C***********          END                                     E20087 E20552
      ***********                                                  E20087 E20552
      *****Accumulate*Market*Value.******************************* E20087 E20552
     C***********          ADD  MKVL      TOTMV  150               E20087 E20552
      ***********                                                  E20087 E20552
     C***********          ENDSR                                   E20087 E20552
      ***********                                                  E20087 E20552
      ************************************************************ E20087 E20552
      /EJECT
      *****************************************************************
      *                                                               *
      *  W01    - SUBROUTINE TO OUTPUT ACCOUNT KEYS                   *
      *                                                               *
      *****************************************************************
      *
     C           W01       BEGSR                           ***  W01   ***
     C*
     C* SET UP ALL FIELDS NOT PASSED FROM CALLING ROUTINE
     C*
     C                     MOVE 'D'       RECI
     C           CIAK      IFEQ 'Y'
     C           SCVI      ANDEQ'Y'
     C                     MOVE SCVI      CNVI
     C                     ELSE                                           S01129
     C                     MOVE *BLANK    CNVI                            S01129
     C                     END
     C*
     C***********          MOVE BHBR      BRCH                            S01117
     C                     MOVE BHBA      BRHA                            S01117
     C                     MOVE SSITP     IVTP
     C***********          MOVE '01'      ASQN                            E18803
     C                     MOVE '00'      ASQN                            E18803
     C*                                                                   E21531
     C** Use of BCAD here caused incorrect date on unrealized P/L keys.   E21531
     C***********          Z-ADDBCAD      EVDT                            E21531
     C*                                                                   101037
     C*** Only use action date for value date for non-accrued interest    101037
     C*                                                                   101037
     C           AMCD      IFNE 'AI'                                      101037
     C/COPY WNCPYSRC,SE2220C165
     C                     Z-ADDKBCAD     EVDT                            E21531
     C                     END                                            101037
      *                                                                   100100
      ** The value date of RP key should be the maturity date of the      100100
      ** security if the security is maturing today                       100100
      *                                                                   100100
     C           AMCD      IFEQ 'RP'                                      100100
     C           MATY      ANDLEBCAD                                      100100
     C           MATY      ANDNE*ZEROS                                    108024
     C                     Z-ADDMATY      EVDT                            100100
     C                     ENDIF                                          100100
     C*                                                                   E21531
     C                     MOVE SNMCY     EVCY
     C                     MOVE BHSC      SESH
     C*
     C                     MOVE *BLANKS   STLA
     C***********          MOVE *BLANKS   KCCY                            E15442
     C                     MOVE SNMCY     KCCY                            E15442
     C                     MOVE *ZEROS    STLT
     C   U1                MOVE '1'       RVRS
     C  NU1                MOVE '0'       RVRS
     C**********           MOVE *ZEROS    KCUST                                               244962
     C                     Z-ADD0         KNCA
     C                     Z-ADD0         KBCA
     C*                                                                   S01117
     C**  Settlement branch is blank                                      S01117
     C*                                                                   S01117
     C                     MOVE *BLANKS   SEBR                            S01117
     C*                                                                   S01117
     C**  Profit centre on a/c key is profit centre from Book position    S01117
      *                                                                   CAC005
      ** If CAC005 is installed, set the profit centre from AOBKPCR0      CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     MOVE PPRFC     PRFC                            CAC005
     C                     ELSE                                           CAC005
     C*                                                                   S01117
     C**    If Analytical Accounting is installed and book position       CAC002
     C**    profit centre is blank, set the profit centre to              CAC002
     C**    SE ICD default profit centre.                                 CAC002
     C*                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
     C********** PCBK      ANDEQ*BLANKS                                                CAC002 247926
     C           PCBK      IFEQ *BLANKS                                                       247926
     C                     MOVE BVSEPC    PRFC                            CAC002
     C                     ELSE                                           CAC002
     C                     MOVE PCBK      PRFC                            S01117
     C                     ENDIF                                          CAC002
     C                     ELSE                                                               247926
     C           TRFR      IFEQ 0                                                             247926
     C                     MOVE PCBK      PRFC                                                247926
     C                     ENDIF                                                              247926
     C                     ENDIF                                                              247926
     C                     ENDIF                                          CAC005
     C*                                                                   CPM004
     C** If Bank Portfolios Supported, set portfolio reference            CPM004
     C*                                                                   CPM004
     C           FCPORS    IFEQ 'B'                                       CPM004
     C                     EXSR SETPTF                                    CPM004
     C                     END                                            CPM004
     C*
     C/COPY WNCPYSRC,SE2220C167
     C                     WRITESEKEYDF
     C*
     C* ACCUMULATE TOTAL OF ACCOUNT KEYS OUTPUT
     C*
     C                     Z-ADD1         Z
     C                     Z-ADD1         S
     C                     Z-ADDEVAM      ZZAMT
     C                     EXSR ZHASH
     C                     ADD  1         OREC
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  W02    - SUBROUTINE TO WRITE A NEW BOOK POSITION             *
      *                                                               *
      *****************************************************************
      *
     C           W02       BEGSR                           ***  W02   ***
      *
      ***  Prevent records with duplicate Keys being written to BKPOSD.
      *
     C                     MOVE BKPREC    RECST1
     C           BKPKY2    CHAINBKPOSDF              80
     C  N80      BRECI     COMP 'D'                  8080
     C           *IN80     IFEQ '0'
     C                     MOVE RECST1    BKPREC
     C                     END
     C*
     C* SET UP NEW FIELDS
     C*
     C                     MOVE 'D'       BRECI
     C                     MOVE BHSC      BPSC
     C***********          MOVE BHBR      BPBR                            S01117
     C                     MOVE BHBA      BPBA                            S01117
     C                     MOVE BHBK      BPBK
     C                     MOVE BHMK      BPMK
     C                     MOVE BHTV      BPTV
     C                     Z-ADDKBCAD     BPPD
     C                     Z-ADDWRPTP     RPTP
     C*
     C                     Z-ADD0         SNPI
     C                     Z-ADD0         SNSI
     C                     Z-ADD0         SANP
     C                     Z-ADD0         SANS
     C***********          Z-ADD0         ANMP                            E22957
     C***********          Z-ADD0         AAPR                            E20086
      *                                                                   E20085
      ***  There is no Field 'LCD' in PF/BKPOSD!                          E20085
     C***********          Z-ADD0         LCD                             E20085
     C                     MOVE 'N'       ADJI
     C                     Z-ADD2220      TNLU                            E20085
      *                                                                                       246619
     C           *INU1     IFEQ '0'                                                           246619
      *                                                                                       246619
     C           BKPKY2    CHAINBKPOP                82                                       246619
      *                                                                                       246619
     C           *IN82     IFEQ '0'                                                           246619
     C                     Z-ADDJNPSN     PNOM                                                246619
     C                     ELSE                                                               246619
     C                     Z-ADDONPSN     PNOM                                                246619
     C                     ENDIF                                                              246619
      *                                                                                       246619
     C                     ENDIF                                                              246619
     C*
     C** If existing BKPOSD record found, update it else write new record
     C**
     C   80                WRITEBKPOSDF
     C  N80                UPDATBKPOSDF
     C*
     C   80                ADD  1         BPAREC
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  W03    - SUBROUTINE TO WRITE A NEW BOOK POSITION HEADER      *
      *                                                               *
      *****************************************************************
      *
     C           W03       BEGSR                           ***  W03   ***
     C*
     C* SET UP FIELDS NOT ALREADY CALCULATED
     C*
     C/COPY WNCPYSRC,SE2220C166
     C                     MOVE 'D'       RECI
     C                     MOVE KBCSS     BHSC
     C***********          MOVE KBCBR     BHBR                            S01117
     C                     MOVE KBCBA     BHBA                            S01117
     C                     MOVE KBCBO     BHBK
     C                     MOVE KBCMK     BHMK
     C                     MOVE KBCTV     BHTV
     C**  Key Fields alrady set up                                        E22957
     C***********          Z-ADDKBCAD     LPSD                            E22957
     C***********          Z-ADDKBCAD     LPCD                            E22957
     C*                                                                   E22957
      *                                                                   E20085
      ***  Field ICLD is updated below. (Line has a later change date).   E20085
     C***********          Z-ADDKBCAD     ICLD                            E20085
      *                                                                   E20087
      ***  Retain amortized-to date for discounted instruments.           E20087
     C***********STBS      IFNE 'D'                                E20085 E21113
     C***********          Z-ADD0         LATD                            E21113
     C***********          END                                     E20087 E21113
      *                                                                   E20087
     C***********          Z-ADD0         ICLD                            E22957
     C                     Z-ADD0         IACR
     C***********          Z-ADD0         IACP                            E20492
      *                                                                   E20085
      ***  DO NOT zero BKMTH fields in BKPHD processing.                  E20085
      *                                                                   E20085
     C***********          Z-ADD0         TIPN                            E20085
     C***********          Z-ADD0         UPLE                            E20085
     C***********          Z-ADD0         CPDD                            E20085
     C***********          Z-ADD0         BCDM                            E20085
     C***********          Z-ADD0         BCCM                            E20085
     C***********          Z-ADD0         MMPL                            E20085
     C***********          Z-ADD0         TNLU                            E20085
     C                     Z-ADD2220      TNLU                            E20085
     C*
     C                     MOVE SSITP     INVT
     C                     MOVE SNMCY     NCRY
     C*
     C                     WRITEBKPHDDF
     C*
     C                     ADD  1         BHAREC
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  W04    - SUBROUTINE TO WRITE A NEW BOOK POSITION MONTHLY     *
      *           STATISTICS RECORD.                                  *
      *                                                               *
      *****************************************************************
      *
     C           W04       BEGSR                           ***  W04   ***
     C*
     C                     MOVE 'D'       BKID
     C                     MOVE KBCSS     BKSS
     C***********          MOVE KBCBR     BKBR                            S01117
     C                     MOVE KBCBA     BKBA                            S01117
     C                     MOVE KBCBO     BKBO
     C                     MOVE KBCMK     BKMK
     C                     MOVE KBCTV     BKTV
     C*
     C* CONVERT END OF MONTH DATE FOR OUTPUT
     C*
     C                     MOVE EOPT      PEOPT   50
     C***********BCAD      IFLE PEOPT                              E16780 E20384
     C           KBCAD     IFLE PEOPT                                     E20384
     C                     Z-ADDPEOPT     BKED
      *
     C           BKED      IFNE 0
     C                     Z-ADDPEOPT     ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVELZMTH      BKMY
     C                     MOVE ZYEAR     BKMY
     C                     ELSE
     C                     MOVE *BLANKS   BKMY
     C                     END
      *
     C                     ELSE                                           E16780
     C*                                                                   E16780
      ***  Write out record for next month                                E16780
     C*                                                                   E16780
     C************         Z-ADDBCAD      ZDAYNO                   E16780 E20384
     C                     Z-ADDKBCAD     ZDAYNO                          E20384
     C                     EXSR ZDATE2                                    E16780
     C*                                                                   E16780
      ***  Fetch 1st day of following month                               E16780
     C*                                                                   E16780
     C                     ADD  1         ZMTH                            E16780
     C           ZMTH      IFEQ 13                                        E16780
     C                     Z-ADD1         ZMTH                            E16780
     C                     ADD  1         ZYEAR                           E16780
     C                     END                                            E16780
      *
     C                     Z-ADD1         ZDAY                            E16780
     C                     MOVELZDAY      WORK4   4                       E16780
     C                     MOVE ZMTH      WORK4                           E16780
     C                     MOVELWORK4     ZDATE                           E16780
     C                     MOVE ZYEAR     ZDATE                           E16780
     C                     EXSR ZDATE1                                    E16780
     C*                                                                   E16780
      ***  Fetch last day of month required                               E16780
     C*                                                                   E16780
     C                     SUB  1         ZDAYNO                          E16780
     C                     EXSR ZDATE2                                    E16780
     C                     Z-ADDZDAYNO    BKED                            E16780
     C                     MOVELZMTH      BKMY                            E16780
     C                     MOVE ZYEAR     BKMY                            E16780
     C                     END                                            E16780
      *                                                                   E20085
      ***  The following fields are zeroed in SR/BKSET and may have       E20085
      ***  been updated during the program and therefore it is totally    E20085
      ***  wrong to zero them here.                                       E20085
     C***********                                                         E20085
     C**SET*UP*FIELDS*NOT*ALREADY*CALCULATED***************************   E20085
     C***********                                                         E20085
     C***********          Z-ADD0         BPIT                            E20085
     C***********          Z-ADD0         TIPN                            E20085
     C***********          Z-ADD0         UPLE                            E20085
      *                                                                   E19445
      ***  No reason to clear Unrealized P/L; it's on BKPHD, not BKMTH.   E19445
     C***********          Z-ADD0         UPPT                            E19445
     C*                                                                   E19445
     C***********          Z-ADD0         CPDD                            E20085
     C***********          Z-ADD0         BCDM                            E20085
     C***********          Z-ADD0         BCCM                            E20085
     C***********          Z-ADD0         MMPL                            E15965
     C***********          Z-ADD0         RPTM
      *                                                                   E19485
      * If reversal run then reverse out the Realized Profit calculated   E19485
     C***********          Z-ADDWRPTP     RPTM                            E19485
     C           *INU1     IFEQ '0'                                       E19485
     C                     Z-ADDWRPTP     RPTM                            E19485
     C                     ELSE                                           E19485
     C                     Z-SUBWRPTP     RPTM                            E19485
     C                     END                                            E19485
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C           *INU1     IFEQ '0'                                                           CSE065
     C                     Z-ADDBKVAMT    BKAMTM                                              CSE065
     C                     Z-ADDEQTAMT    EQAMTM                                              CSE065
     C                     ELSE                                                               CSE065
     C                     Z-SUBBKVAMT    BKAMTM                                              CSE065
     C                     Z-SUBEQTAMT    EQAMTM                                              CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      *                                                                   E19485
     C                     MOVE SNMCY     NCRY
     C                     MOVE SSITP     INVT
     C                     Z-ADD2220      TNLU                            E20085
     C*
     C                     WRITEBKMTHDF
     C                     ADD  1         W04CNT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  W05    - SUBROUTINE TO WRITE A HISTORIC BOOK POSITION HEADER *
      *                                                               *
      *****************************************************************
      *
     C           W05       BEGSR                           ***  W05   ***
     C*
     C* SET UP FIELDS NOT ALREADY CALCULATED
     C*
     C                     MOVE 'D'       RECI
      *                                                                   E21574
      ***  Setting up of most BKPHH fields here is at best redundant,     E21574
      ***  (SR/BKSET does this if no BKPHD record exists), and at worst   E21574
      ***  disastrous (if the current action isn't a trade, DB errors     E21574
      ***  can occur if LPSD is set to KBCAD; if it IS a Trade, SR/P10    E21574
      ***  has already reset LPSD).                                       E21574
      ***  Current Action is always a trade but still redundant           E22957
      *                                                                   E21574
     C***********          MOVE KBCSS     BHSC                            E21574
     C***********          MOVE KBCBR     BHBR                            E21574
     C***********          MOVE KBCBO     BHBK                            E21574
     C***********          MOVE KBCMK     BHMK                            E21574
     C***********          MOVE KBCTV     BHTV                            E21574
     C***********          Z-ADDKBCAD     LPSD                            E21574
     C***********          Z-ADDKBCAD     LPCD                            E22957
     C***********          Z-ADDKBCAD     ICLD                            E18651
     C***********          Z-ADDKBCAD     ICLD                     E20087 E21232
     C***********          Z-ADD0         IACR                            E21574
     C***********          Z-ADD0         IACP                            E21574
      *                                                                   E20085
      ***  DO NOT zero BKMTH fields in BKPHD processing.                  E20085
      *                                                                   E20085
     C***********          Z-ADD0         TIPN                            E20085
     C***********          Z-ADD0         UPLE                            E20085
     C***********          Z-ADD0         CPDD                            E20085
     C***********          Z-ADD0         BCDM                            E20085
     C***********          Z-ADD0         BCCM                            E20085
     C**********           Z-ADD0         MMPL                            E18800
     C***********          Z-ADD0         TNLU                            E20085
     C                     Z-ADD2220      TNLU                            E20085
     C*
     C                     MOVE SSITP     INVT
     C                     MOVE SNMCY     NCRY
     C*
     C************INU1     IFEQ '0'                                E18651 E20087
      *                                                                   E21574
      ***  Restore this part of E18651: Don't write out a BKPHH record    E21574
      ***  in Reversal mode.                                              E21574
     C           *INU1     IFEQ '0'                                       E21574
     C                     WRITEBKPHHDF
     C*
     C                     ADD  1         HHAREC
     C***********          END                                     E18651 E20087
     C                     END                                            E21574
     C*
     C                     ENDSR
      *****************************************************************                       CSE065
      /EJECT                                                                                  CSE065
      *****************************************************************                       CSE065
      *                                                               *                       CSE065
      *  W06    - Post Book Value Change and Equity Amount A/C Key    *                       CSE065
      *                                                               *                       CSE065
      *****************************************************************                       CSE065
      *                                                                                       CSE065
     C           W06       BEGSR                                                              CSE065
      *                                                                                       CSE065
      ** Set up fields not already calculated                                                 CSE065
      *                                                                                       CSE065
     C                     MOVE 'D'       RECI                                                CSE065
      * Setup ACKY                                                                            CSE065
     C                     MOVE *BLANKS   ACKY2                                               CSE065
      *                                                                                       CSE065
     C                     MOVE SSITP     IVTP                                                CSE065
     C                     MOVE 'V'       EVTP                                                CSE065
     C                     MOVE BCBO      BHBK                                                CSE065
     C                     MOVE BCMK      BHMK                                                CSE065
     C           CIAK      IFEQ 'Y'                                                           CSE065
     C           SCVI      ANDEQ'Y'                                                           CSE065
     C                     MOVE 'Y'       CNVI                                                CSE065
     C                     ELSE                                                               CSE065
     C                     MOVE *BLANKS   CNVI                                                CSE065
     C                     ENDIF                                                              CSE065
     C           NPAC      IFEQ 'N'                                                           CSE065
     C           NPSN      ORGE *ZEROS                                                        CSE065
     C                     MOVE *BLANK    NEGI                                                CSE065
     C                     ELSE                                                               CSE065
     C                     MOVE 'N'       NEGI                                                CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     MOVE *BLANKS   TRFR                                                CSE065
     C**********           Z-ADDISSR      CSTN                                         CSE065 CSD027
     C                     MOVE ISSR      CSTN                                                CSD027
     C                     MOVE BHBA      BRHA                                                CSE065
     C                     MOVE '00'      ASQN                                                CSE065
     C                     Z-ADDKBCAD     EVDT                                                CSE065
     C                     MOVE SNMCY     EVCY                                                CSE065
     C                     Z-ADD*ZEROS    STLT                                                CSE065
     C                     MOVE *BLANKS   STLA                                                CSE065
     C                     MOVE *BLANKS   SEBR                                                CSE065
     C           *INU1     IFEQ *ON                                                           CSE065
     C                     MOVE '1'       RVRS                                                CSE065
     C                     ELSE                                                               CSE065
     C                     MOVE '0'       RVRS                                                CSE065
     C                     ENDIF                                                              CSE065
     C**********           Z-ADD*ZEROS    KCUST                                        CSE065 CSD027
     C                     MOVE *BLANKS   KCUST                                               CSD027
     C                     Z-ADD*ZEROS    KNCA                                                CSE065
     C                     MOVE SNMCY     KCCY                                                CSE065
     C                     Z-ADD*ZEROS    KBCA                                                CSE065
     C                     MOVE BHSC      SESH                                                CSE065
     C           BGNOST    IFEQ 'Y'                                                           CSE065
     C           PCBK      ANDEQ*BLANKS                                                       CSE065
     C                     MOVE BVSEPC    PRFC                                                CSE065
     C                     ELSE                                                               CSE065
     C                     MOVE PCBK      PRFC                                                CSE065
     C                     ENDIF                                                              CSE065
     C           CAC005    IFEQ 'Y'                                                           CSE065
     C                     MOVE PPRFC     PRFC                                                CSE065
     C                     ENDIF                                                              CSE065
     C           FCPORS    IFEQ 'B'                                                           CSE065
     C                     EXSR SETPTF                                                        CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C                     WRITESEKEYDF                                                       CSE065
      *                                                                                       CSE065
      ** Accumulate totals                                                                    CSE065
      *                                                                                       CSE065
     C                     Z-ADD1         Z                                                   CSE065
     C                     Z-ADD1         S                                                   CSE065
     C                     Z-ADDEVAM      ZZAMT                                               CSE065
     C                     EXSR ZHASH                                                         CSE065
     C                     ADD  1         OREC                                                CSE065
      *                                                                                       CSE065
     C                     ENDSR                                                              CSE065
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  U01    - SUBROUTINE TO UPDATE ACTION RECORD                  *
      *                                                               *
      *****************************************************************
      *
     C           U01       BEGSR                           ***  U01   ***
      *                                                                   E20144
      ***  Store worked-on BPACC record, CHAIN for UPDATE and then        E20144
      ***  restore the worked-on fields to the record.                    E20144
      *                                                                   E20144
     C                     MOVELRECIN     STREC                           E20144
      *                                                                   E20144
     C***01***   BPCKEY    CHAINBPACCDF              88             E20144168141
     C***02***   BPCKEY    CHAINBPACBDF              88             E20144168141
     C***03***   BPCKEY    CHAINBPACHDF              88             E20144168141
     C   01      BPCKEY    CHAINBPACDFX              88                   168141
     C   02      BPCKEY    CHAINBPABDFX              88                   168141
     C   03      BPCKEY    CHAINBPAHDFX              88                   168141
      *                                                                   E20144
     C           *IN03     IFEQ '1'                                       106567
     C                     MOVE RECI      @RECI   1                       106567
     C                     END                                            106567
     C*                                                                   106567
     C           *IN88     IFEQ '1'                                       E20144
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BPACC-2' DBFILE           ***************E20144
     C                     MOVELBPBCKY    DBKEY            * DB ERROR 20 *E20144
     C                     Z-ADD20        DBASE            ***************E20144
     C                     SETON                     U7U8                 E20144
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE                                           E20144
      *                                                                   E20144
     C                     MOVELSTREC     RECIN                           E20144
     C*                                                                   106567
     C           *IN03     IFEQ '1'                                       106567
     C                     MOVE @RECI     RECI                            106567
     C                     END                                            106567
     C*                                                                   106567
     C*
     C*  RESET ACTIONED DATE FOR BPACCD BPACBD
     C*
     C           *IN03     IFEQ '0'
     C                     Z-ADDRUND      BCED
     C                     MOVE 'H'       RECI
     C                     END
     C*
     C***********BCAS      IFEQ '10'                                      E18652
     C           BCAS      IFEQ '40'                                      E18652
     C                     Z-ADDWBCP1     BCP1
      *                                                                   E20085
      ***  When WBCP2 is updated correctly in the first place, the        E20085
      ***  following fix becomes unnecessary, so its changed back.        E20085
      *                                                                   E20085
     C***********          Z-ADDWBCP2     BCP2                            E18667
     C***********          Z-ADDPILP      BCP2                     E18667 E20085
     C                     Z-ADDWBCP2     BCP2                            E20085
     C                     Z-ADDWBCPL     BCPL
     C                     Z-ADDLAVP      BCAT
     C                     ELSE
      *
     C           BCAS      IFEQ '30'
     C           BCAS      OREQ '35'
     C                     Z-ADDWBCDV     BCDV
     C                     ELSE                                           E37811
      *                                                                   E37811
     C           BCAS      IFEQ '60'                                      E37811
     C           *INU1     IFEQ '0'                                       124140
     C                     Z-ADDWBCPL     BCPL                            E37811
     C                     ELSE                                           124140
     C                     Z-SUBWBCPL     BCPL                            124140
     C                     END                                            124140
     C                     Z-ADDLAVP      BCAT                            CPM004
     C                     END                                            E37811
     C                     END
      *
     C                     END
     C*
     C***01******          UPDATBPACCDF                                   E18668
     C***02******          UPDATBPACBDF                                   E18668
     C***03******          UPDATBPACHDF                                   E18668
     C   01                EXCPTUBPACC                                    E18668
     C   02                EXCPTUBPACB                                    E18668
     C   03                EXCPTUBPACH                                    E18668
      *                                                                   E20144
     C                     END                                            E20144
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  U02    - SUBROUTINE TO UPDATE BOOK POSITION HEADER           *
      *                                                               *
      *****************************************************************
      *
     C           U02       BEGSR                           ***  U02   ***
     C*
     C************IN19     IFEQ '1'                                       E22957
     C***********          Z-ADDTLPSD     LPSD                            E22957
     C***********          SETOF                     19                   E22957
     C***********          END                                            E22957
     C***********                                                         E22957
     C***********          Z-ADDKBCAD     LPCD                            E22957
     C*
     C                     EXCPTUPDBKH
     C*
     C                     ADD  1         BHUREC
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************   E15965
     C***********                                                         E15965
     C***U03**-**SUBROUTINE*TO*UPDATE*BOOK*POSITION********************   E15965
     C***********                                                         E15965
     C***********U03       BEGSR                           **  U03 **     E15965
     C***********                                                         E15965
     C**STORE*RECORD*ACCUMULATED*AND*UPDATE*ORIGINAL*RECORD*BEFORE*****   E15965
     C******RE-STORING*ACCUMULATED*RECORD******************************   E15965
     C***********                                                         E15965
     C***********          MOVE BKPREC    RECST2                          E15965
     C***********          MOVE RECST1    BKPREC                          E15965
     C***********          Z-ADDWLAVP     APPB                            E15965
     C***********                                                         E15965
     C***********          EXCPTUPDBKP                                    E15965
     C***********                                                         E15965
     C***********          MOVE RECST2    BKPREC                          E15965
     C***********                                                         E15965
     C***********          ENDSR                                          E15965
      ***********                                                         E15965
      *****************************************************************   E15965
      /EJECT
      *****************************************************************
      *                                                               *
      *  U04    - SUBROUTINE TO UPDATE BOOK POSITION MONTHLY          *
      *           STATISTICS FILE.                                    *
      *                                                               *
      *****************************************************************
      *
     C           U04       BEGSR                           ***  U04   ***
     C*
      ** If reversal run then reverse out the realized P/L calculated.    E19485
      *                                                                   E19485
     C           *INU1     IFEQ '0'                                       E19485
     C                     ADD  WRPTP     RPTM
      *                                                                   E19485
      ***  Don't back out P/L from BPACHD records. Reversal run does it.  E19485
     C***********          SUB  XBCPL     RPTM                            E19485
     C                     ELSE                                           E19485
     C                     SUB  WRPTP     RPTM                            E19485
     C                     END                                            E22957
      *                                                                                       CSE065
     C           CSE065    IFEQ 'Y'                                                           CSE065
     C           *INU1     IFEQ '0'                                                           CSE065
     C                     ADD  BKVAMT    BKAMTM                                              CSE065
     C                     ADD  EQTAMT    EQAMTM                                              CSE065
     C                     ELSE                                                               CSE065
     C                     SUB  BKVAMT    BKAMTM                                              CSE065
     C                     SUB  EQTAMT    EQAMTM                                              CSE065
     C                     ENDIF                                                              CSE065
     C                     ENDIF                                                              CSE065
      ***********                                                  E20087 E22957
      *****Produce*reversal*key*for*amortization*since*LPSD,*if*needed087 E22957
     C***********DPTR      IFNE 0                                  E20087 E22957
     C***********          EXSR AMORTR                             E20087 E22957
     C***********          END                                     E20087 E22957
      ***********                                                  E20087 E22957
     C***********          END                                     E19485 E22957
     C*
     C                     EXCPTUPDBKM
     C*
     C                     ADD  1         U04CNT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT                                                              E20087
      *****************************************************************   CPM004
      *                                                               *   CPM004
      *  SETPTF - Subroutine to set portfolio reference on A/C key    *   CPM004
      *                                                               *   CPM004
      *****************************************************************   CPM004
     C           SETPTF    BEGSR                                          CPM004
     C*                                                                   CPM004
     C                     MOVEL*BLANK    PTFR                            CPM004
     C*                                                                   CPM004
     C                     MOVE EVTP      WWKY1                           CPM004
     C                     MOVE TRTP      WWKY2                           CPM004
     C                     MOVE PORT      WWKY3                           CPM004
     C                     MOVE AMCD      WWKY4                           CPM004
     C           WWKY      LOKUPWWARRZ                   99               CPM004
     C           *IN99     IFEQ '1'                                       CPM004
     C                     EXSR SRPORT                                    CPM004
     C                     END                                            CPM004
     C                     ENDSR                                          CPM004
      *****************************************************************   CPM004
      /EJECT                                                              CPM004
      ******************************************************************* CPM004
      *                                                                 * CPM004
      * SRPORT   - Access portfolio reference of book                   * CPM004
      *                                                                 * CPM004
      ******************************************************************* CPM004
     C           SRPORT    BEGSR                                          CPM004
     C*                                                                   CPM004
     C                     MOVEL'B'       I#PORS                          CPM004
     C                     MOVELFCR997    I#R997                          CPM004
     C                     MOVEL*BLANKS   I#CUST                          CPM004
     C                     MOVELBHBA      I#BRCA                          CPM004
     C                     MOVELBHBK      I#BOOK                          CPM004
     C                     MOVEL*BLANKS   I#PTFR                          CPM004
     C                     MOVEL*BLANKS   I#CPGM                          CPM004
     C*                                                                   CPM004
     C                     CALL 'AOPLCSR1'                                CPM004
     C                     PARM *BLANKS   P@RTCD  7        B:Return code  CPM004
     C                     PARM '*KEY   ' P@OPTN  7        I:Option       CPM004
     C                     PARM           I@PARM           I:Parameters   CPM004
     C                     PARM *BLANKS   O@PARM           O:Parameters   CPM004
     C           SDPLCS    PARM SDPLCS    DSFDY            O:Format       CPM004
     C*                                                                   CPM004
     C           P@RTCD    IFEQ *BLANKS                                   CPM004
     C           I#PTFR    ANDNEFCR997                                    109565
     C                     MOVELO#PTFR    PTFR                            CPM004
     C                     ELSE                                           109565
     C                     MOVELI#PTFR    PTFR                            109565
     C                     END                                            CPM004
     C*                                                                   CPM004
     C                     ENDSR                                          CPM004
      ******************************************************************* CPM004
      /EJECT                                                              CPM004
      *****************************************************************   E20087
      *                                                               *   E20087
      *  AMORTR - Subroutine to generate Reversal Key for Amortization*   E20087
      *           since Last Position Date.                           *   E20087
      *         Removed by E22957                                     *   E20087
      *                                                               *   E20087
      *****************************************************************   E20087
      *                                                                   E20087
     C           AMORTR    BEGSR                           *** AMORTR *** E20087
      *                                                                   E20087
      *                                                                   E20087
     C                     ENDSR                                          E20087
      *                                                                   E20087
      *****************************************************************   E20087
      /EJECT
      *****************************************************************   E29236
      *                                                                   E29236
      *  GETPPP -  SUBROUTINE TO GET PARTLY PAID PRICE PRIOR TO ACTION.   E29236
      *            THIS IS USED IN PREFERENCE TO THE PARTLY PAID PRICE    E29236
      *            ON THE ACTION ITSELF. THIS MAY BE WRONG DUE TO BACK-   E29236
      *            VALUATION OF TRADES OR OF PARTLY PAID CALLS.           E29236
      *                                                                   E29236
      *****************************************************************   E29236
     C           GETPPP    BEGSR                                          E29236
     C                     Z-ADD*ZERO     BCTA                            E29236
     C                     MOVE 'PP'      ETYP                            E29236
     C                     Z-ADDBCAD      TDVD                            E29236
     C           PRIOR     IFEQ 'Y'                                       E29236
     C           SEDKEY    SETGTSEDEVDO                                   E29236
     C                     ELSE                                           E29236
     C           SEDKEY    SETLLSEDEVDO                                   E29236
     C                     END                                            E29236
     C                     READ SEDEVDO                  81               E29236
     C*                                                                   E29236
     C* Get the total partly paid price prior to the action date from the E29236
     C* Security Diary. If no details are present, use the current partly E29236
     C* paid price from the security.                                     E29236
     C*                                                                   E29236
     C           *IN81     IFEQ '0'                                       E29236
     C           SDSN      ANDEQBCSS                                      E29236
     C           SDET      ANDEQ'PP'                                      E29236
     C           SDTP      IFEQ *ZERO                                     E29236
     C                     MOVE SDTA      BCTA                            E29236
     C                     ELSE                                           E29236
     C                     MOVE SDTP      BCTA                            E29236
     C                     END                                            E29236
     C                     ELSE                                           E29236
     C                     MOVE CPDP      BCTA                            E29236
     C                     MOVE SNMCY     NMCY                                                CSE065
     C                     END                                            E29236
     C                     ENDSR                                          E29236
      *****************************************************************   E29236
     C/EJECT                                                              E29236
     C********************************************************************E36391
     C*                                                                  *E36391
     C*  GETCUF -  Subroutine to get current factor prior to action.     *E36391
     C*            This is used in preference to the current factor      *E36391
     C*            on the action itself. This may be wrong due to back-  *E36391
     C*            valuation of trades or of mortgage payments.          *E36391
     C*                                                                  *E36391
     C********************************************************************E36391
     C*                                                                   E36391
     C           GETCUF    BEGSR                                          E36391
     C*                                                                   E36391
     C                     MOVE 'MP'      ETYP                            E36391
     C                     Z-ADDBCAD      TDVD    50                      E36391
     C*                                                                   101300
     C*** If this is for trade date action then need to access current    101300
     C*** factor based on value date.                                     101300
     C*                                                                   101300
     C           BCTV      IFEQ 'T'                                       101300
     C           BCAS      ANDEQ'40'                                      101300
     C           BCTR      CHAINTRADS                81                   101300
     C           *IN81     IFEQ '0'                                       101300
     C           TRECI     ANDNE'*'                                       101300
     C                     Z-ADDTRDVD     TDVD                            101300
     C                     END                                            101300
     C                     END                                            101300
     C*                                                                   101300
     C           PRIOR     IFEQ 'Y'                                       E36391
     C           SEDKEY    SETGTSEDEVDO                                   E36391
     C                     ELSE                                           E36391
     C           SEDKEY    SETLLSEDEVDO                                   E36391
     C                     END                                            E36391
     C                     READ SEDEVDO                  81               E36391
     C*                                                                   E36391
     C** Get the current factor prior to the action date from the         E36391
     C** security diary. If no details are present, use the current       E36391
     C** factor from the security.                                        E36391
     C*                                                                   E36391
     C           *IN81     IFEQ '0'                                       E36391
     C           SDSN      ANDEQBCSS                                      E36391
     C           SDET      ANDEQ'MP'                                      E36391
     C                     Z-ADDSDCP      AAPR                            E36391
     C                     ELSE                                           E36391
     C                     Z-ADDCFCT      AAPR                            E36391
     C                     MOVE SNMCY     NMCY                                                CSE065
     C                     END                                            E36391
     C                     ENDSR                                          E36391
      *****************************************************************   E36391
      /EJECT                                                              E36391
      *****************************************************************
      *                                                               *
      *  AUDIT  - SUBROUTINE TO UPDATE AUDIT RECORDS AND OUTPUT THE   *
      *           CONTROL REPORT                                      *
      *                                                               *
      *****************************************************************
      *
     C           AUDIT     BEGSR                           *** AUDIT  ***
     C*
     C* CHECK NO DBASE ERROR HAS BEEN ENCOUNTERED SO FAR
     C*    -  UPDATE BOOK POSITION AUDIT RECORD
     C*
     C           *INU7     IFEQ '0'
     C                     READ BKPOSAF                  86
     C           *IN86     IFEQ '1'
     C                     SETON                     U7U8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'BKPOS'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 10 *
     C                     Z-ADD10        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     Z-ADDNORE      BPREC   50
     C           NORE      ADD  BPAREC    BPTREC  50
     C                     Z-ADDBPTREC    NORE
     C                     UPDATBKPOSAF
     C*
     C*    -  UPDATE BOOK POSITION HEADER AUDIT RECORD
     C*
     C                     READ BKPHDAF                  86
     C           *IN86     IFEQ '1'
     C                     SETON                     U7U8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'BKPHD'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 11 *
     C                     Z-ADD11        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     Z-ADDNORE      BHREC   50
     C           NORE      ADD  BHAREC    BHTREC  50
     C                     Z-ADDBHTREC    NORE
     C                     UPDATBKPHDAF
     C*
     C*    -  UPDATE HISTORIC BOOK POSITION HEADER AUDIT FILE
     C*
     C                     READ BKPHHAF                  86
     C           *IN86     IFEQ '1'
     C                     SETON                     U7U8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'BKPHH'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 14 *
     C                     Z-ADD14        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     Z-ADDNORE      HHREC   50
     C           NORE      ADD  HHAREC    HHTREC  50
     C                     Z-ADDHHTREC    NORE
     C                     UPDATBKPHHAF
     C*
     C*    -  UPDATE BOOK POSITIONS MONTHLY STATISTICS AUDIT FILE
     C*
     C                     READ BKMTHAF                  86
     C           *IN86     IFEQ '1'
     C                     SETON                     U7U8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'BKMTH'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 18 *
     C                     Z-ADD18        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     Z-ADDNORE      MTREC   50
     C           NORE      ADD  W04CNT    MTTREC  50
     C                     Z-ADDMTTREC    NORE
     C                     UPDATBKMTHAF
     C*
     C*     -  READ ACTIONS AUDIT FILE FOR CONTROL TOTALS
     C*
     C           *INU1     IFEQ '0'
     C*
     C* ONLY READ AUDIT RECORDS FOR BPACCD AND BPACCB IF U1 OFF
     C*  WHEN U1 ON BPACC LF IS OVERRIDEN TO BPACR AND THESE PF'S
     C*  DO NOT EXIST IN BPACR AND SO NO COUNT CAN OF RECORDS OCCURS.
     C*
     C                     READ BPACCAF                  86
     C           *IN86     IFEQ '1'
     C                     SETON                     U7U8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'BPACC'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 12 *
     C                     Z-ADD12        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     Z-ADDNORE      ACREC   50
      *
     C           ICREC     IFNE NORE
     C                     MOVE '1'       *IN50
     C                     MOVE '1'       *INU8
     C                     END
     C*
     C*     -  READ (BPACB) ACTIONS AUDIT FILE FOR CONTROL TOTALS
     C*
     C                     READ BPACBAF                  86
     C           *IN86     IFEQ '1'
     C                     SETON                     U7U8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'BPACB'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 15 *
     C                     Z-ADD15        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     Z-ADDNORE      ABREC   50
      *
     C           IBREC     IFNE NORE
     C                     MOVE '1'       *IN51
     C                     MOVE '1'       *INU8
     C                     END
     C*
     C*     -  READ (BPACH) ACTIONS AUDIT FILE FOR CONTROL TOTALS
     C*
     C                     READ BPACHAF                  86
     C           *IN86     IFEQ '1'
     C                     SETON                     U7U8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'BPACH'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 16 *
     C                     Z-ADD16        DBASE            ***************
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     Z-ADDNORE      AHREC   50
     C                     END
      *
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     END
     C                     ELSE
     C*
     C*           *INU1 IS ON - ONLY DO AUDIT CHECK FOR BPACHD
     C*
     C*     -  READ (BPACH) ACTIONS AUDIT FILE FOR CONTROL TOTALS
     C*
     C                     READ BPACHAF                  86
     C           *IN86     IFEQ '1'
     C                     SETON                     U7U8
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'BPACH'   DBFILE           ***************
     C***********          MOVEL'AUDIT'   DBKEY            **DB*ERROR*17**E20651
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 21 *E20651
     C***********          Z-ADD17        DBASE            ***************E20651
     C                     Z-ADD21        DBASE                           E20651
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     Z-ADDNORE      AHREC   50
     C                     END
     C                     END
     C*
     C*    -  OUTPUT CONTROL REPORT
     C*
     C                     WRITEHEADAU
     C*
     C           *INU7     IFEQ '0'
     C*
     C***********ICREC     IFEQ 0                                         E29170
     C***********IXREC     ANDEQ0                                   E29207E29170
     C***********IBREC     ANDEQ0                                         E29170
     C***********IHREC     ANDEQ0                                         E29170
     C***********          WRITENONE                                      E29170
     C***********          ELSE                                           E29170
     C*
     C                     ADD  IXREC     ICREC                           E29207
     C                     ADD  IXREC     ACREC                           E29207
     C           OREC      IFNE 0
     C                     Z-ADDINT,S     OHASH1
     C                     Z-ADDDEC,S     OHASH2
     C                     ELSE
     C                     Z-ADD0         OHASH1
     C                     Z-ADD0         OHASH2
     C                     END
     C*
     C                     WRITECONTROL
     C                     WRITEHEADAU
     C                     WRITECONTROL1
     C***********          END                                            E29170
     C*
     C                     ELSE
     C                     WRITEERROR
     C                     END
     C***********                                                         E29170
     C***********          WRITETRAILAU                                   E29170
     C*
     C* IF NO DATATBASE ERRORS OUTPUT AUDIT RECORD TO SEKEYA
     C*
     C           *INU7     IFEQ '0'
     C                     MOVE OREC      NORE
     C                     Z-ADDOHASH1    HRWN
     C                     Z-ADDOHASH2    HRDC
     C                     WRITESEKEYAF
     C                     END
     C/COPY WNCPYSRC,SE2220C233
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  BKHCHN - SUBROUTINE TO CHAIN TO BOOK POSITION HEADER         *
      *                                                               *
      *****************************************************************
      *
     C           BKHCHN    BEGSR                           *** BKHCHN ***
     C*
     C                     MOVEA'000'     *IN,10
     C           BKHKEY    CHAINBKPHDDF              80
     C  N80      RECI      COMP 'D'                  8080
     C           *IN80     IFEQ '0'
     C                     MOVE '1'       *IN10
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BKPCHN - SUBROUTINE TO CHAIN TO BOOK POSITION RECORD         *
      *                                                               *
      *****************************************************************
      *
     C           BKPCHN    BEGSR                           *** BKPCHN ***
     C*
     C                     MOVE '0'       *IN11
     C                     MOVE '0'       *IN65                                               CSE065
     C           BKPKEY    CHAINBKPOSDF              80
      *                                                                                       CSE065
     C           *IN80     IFEQ '1'                                                           CSE065
     C                     MOVE '1'       *IN65                                               CSE065
     C                     ENDIF                                                              CSE065
      *                                                                                       CSE065
     C  N80      BRECI     COMP 'D'                  8080                 E15965
     C           *IN80     IFEQ '1'
     C***********          Z-ADDLPSD      KLPSD                           E22957
     C***********          MOVEL'BKPOS'   DBFILE       *****************  E22957
     C***********          MOVELBPKEYP    DBKEY        ** DB ERROR 04 **  E22957
     C***********          Z-ADD04        DBASE        *****************  E22957
     C***********          SETON                     U7U8                 E22957
     C                     ELSE
     C                     MOVE '1'       *IN11
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BKMCHN - SUBROUTINE TO CHAIN TO BOOK POSITION MONTHLY        *
      *           STATISTICS FILE.                                    *
      *                                                               *
      *****************************************************************
      *
     C           BKMCHN    BEGSR                           *** BKMCHN ***
     C*
     C                     MOVE '0'       *IN12
     C           BKHKEY    CHAINBKMTHDF              80
     C  N80      BKID      COMP 'D'                  8080
     C           *IN80     IFEQ '1'
     C                     ELSE
     C                     MOVE '1'       *IN12
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BOKCHN - SUBROUTINE TO CHAIN TO BOOK FILE                    *
      *                                                               *
      *****************************************************************
      *
     C           BOKCHN    BEGSR                           *** BOKCHN ***
      *                                                                   186249
      ** If CAC005 is installed, retrieve user book                       186249
      ** BCBO in the Book Position file is being held as a pseudo book    186249
      *                                                                   186249
     C           CAC005    IFEQ 'Y'                                       186249
     C                     CALL 'AOBKPCR0'                                186249
     C                     PARM *BLANKS   PRTCD   7                       186249
     C                     PARM '*USER  ' POPTN   7                       186249
     C                     PARM           PBKCD   2                       186249
     C                     PARM           PPRFC   4                       186249
     C                     PARM BCBO      PPSBK   2                       186249
      *                                                                   186249
     C           PRTCD     IFNE *BLANKS                                   186249
     C           *LOCK     IN   LDA                                       186249
     C                     MOVEL'SDBKPCPD'DBFILE           ************   186249
     C                     Z-ADD031       DBASE            * DBERR 031*   186249
     C                     MOVELBCBO      DBKEY            ************   186249
     C                     MOVE *ON       *INU7                           186249
     C                     MOVE *ON       *INU8                           186249
     C                     OUT  LDA                                       186249
     C                     DUMP                                           186249
     C                     ENDIF                                          186249
     C                     ENDIF                                          186249
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C           PBKCD     CHAINBOOKDDF              80                   CAC005
     C                     ELSE                                           CAC005
     C*
     C           BOKKEY    CHAINBOOKDDF              80
     C                     ENDIF                                          CAC005
     C  N80      RECI      COMP 'D'                  8080
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'BOOKD'   DBFILE           ***************
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     MOVELPBKCD     DBKEY                           CAC005
     C                     ELSE                                           CAC005
     C                     MOVELBCBO      DBKEY            * DB ERROR 05 *
     C                     ENDIF                                          CAC005
     C                     Z-ADD05        DBASE            ***************
     C                     SETON                     U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  SECCHN - SUBROUTINE TO CHAIN TO SECURITIES FILE              *
      *                                                               *
      *****************************************************************
      *
     C           SECCHN    BEGSR                           *** SECCHN ***
     C*
     C           SECKEY    CHAINSECTYDF              80
     C  N80      RECI      COMP '*'                      80
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SECTY'   DBFILE           ***************
     C                     MOVELBCSS      DBKEY            * DB ERROR 06 *
     C                     Z-ADD06        DBASE            ***************
     C                     SETON                     U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C*                                                                   S01232
     C*         Australian yield security ?                               S01232
     C*                                                                   S01232
     C           STBS      IFEQ 'Y'                                       S01232
     C           SYBS      ANDEQ'AU'                                      S01232
     C                     SETON                     53                   S01232
     C                     ELSE                                           S01232
     C                     SETOF                     53                   S01232
     C                     END                                            S01232
     C/COPY WNCPYSRC,SE2220C198
     C*                                                                   S01232
     C                     END
     C*                                                                   E15549
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE2220CP10                                           S01408
     C*                                                                   S01408
     C** SAVE LAST COUPON DATE OFF SECURITY                               E15549
     C*                                                                   E15549
     C                     Z-ADDLCPN      SVLCPN  50                      E15549
     C                     MOVE STBS      WOTBS   1                                           230033
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  INVCHN - SUBROUTINE TO CHAIN TO INVESTMENTS FILE             *
      *                                                               *
      *****************************************************************
      *
     C           INVCHN    BEGSR                           *** INVCHN ***
     C*
     C           INVKEY    CHAININVTPDF              80
     C  N80      RECI      COMP 'D'                  8080
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'INVTP'   DBFILE           ***************
     C                     MOVELIKEY      DBKEY            * DB ERROR 07 *
     C                     Z-ADD07        DBASE            ***************
     C                     SETON                     U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     END
     C*                                                                   182505
     C** Setup SITP and NMCY for ZLCD and ZNCD subroutine for CSE005.     182505
     C*                                                                   182505
     C                     MOVE SSITP     SITP                            182505
     C                     MOVE SNMCY     NMCY                            182505
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT                                                              S01117
      *****************************************************************   S01117
      *                                                               *   S01117
      *  PPCCHN - SR to chain to Book positions profit centre file    *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
      *                                                                   S01117
     C           PPCCHN    BEGSR                           *** PPCCHN *** S01117
     C*                                                                   S01117
     C           KSEPCB    CHAINSEPCBDF              80                   S01117
     C           *IN80     IFEQ '1'                                       S01117
     C           RECI      ORNE 'D'                                       S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SEPCBD'  DBFILE           ***************S01117
     C                     MOVELKSEPCR    DBKEY            * DB ERROR 22 *S01117
     C                     Z-ADD22        DBASE            ***************S01117
     C                     SETON                     U7U8                 S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     ENDSR                                          S01117
      *                                                                   S01117
      *****************************************************************   S01117
      /EJECT
      *****************************************************************
      *                                                               *
      *  CLICHN - SUBROUTINE TO CHAIN TO CLIENTS FILE                 *
      *                                                               *
      *****************************************************************
      *
     C           CLICHN    BEGSR                           *** CLICHN ***
     C*
     C           CLIKEY    CHAINCLINTSEF             80
     C  N80      RECI      COMP 'D'                  8080
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'CLINT'   DBFILE
     C                     MOVELTRCP      KEY7    7
     C                     MOVE '1'       KEY7             ***************
     C                     MOVELKEY7      DBKEY            * DB ERROR 08 *
     C                     Z-ADD08        DBASE            ***************
     C                     SETON                     U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  TABCHN - SUBROUTINE TO CHAIN TO TABTG10                      *
      *                                                               *
      *****************************************************************
      *
     C           TABCHN    BEGSR                           *** TABCHN ***
     C*
     C                     MOVE *BLANK    TKEY
     C                     MOVEL'20'      TKEY
     C                     MOVELSNMCY     KEY4    4
     C                     MOVE '1'       KEY4
     C                     MOVE KEY4      TKEY
     C           TABKEY    CHAINTABTG10F             80
     C  N80      RECI      COMP 'D'                  8080
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C                     SETON                     U7U8  ***************
     C                     MOVE 'TABLE'   DBFILE           * DB ERROR 09 *
     C                     MOVELTKEY      DBKEY            ***************
     C                     Z-ADD09        DBASE
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     END
     C*
     C                     ENDSR
     C*
      *****************************************************************
      /SPACE 3
     C***************************************************************     E14616
     C*                                                                   E20085
     C*  REDUNDANT CODE HAS BEEN REMOVED BY E20085                        E20085
     C*                                                                   E20085
     C***SEDCHN**-**SUBROUTINE*TO*CHAIN*TO*SECURITY*DIARY*EVENTS*FILE**   E14616
     C*************************************************************       E14616
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BKHSR  - SUBROUTINE FOR ERROR HANDLING OF BOOK POSITION      *
      *           HEADER.                                             *
      *                                                               *
      *****************************************************************
      *
     C           BKHSR     BEGSR                           *** BKHSR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BKPHDD'  DBFILE
     C                     MOVELBCKEY     DBKEY
     C                     Z-ADD90        DBASE
     C                     MOVE STSBKH    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BKPSR  - SUBROUTINE FOR ERROR HANDLING OF BOOK POSITIONS     *
      *                                                               *
      *****************************************************************
      *
     C           BKPSR     BEGSR                           *** BKPSR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BKPOS'   DBFILE
     C                     MOVELBCKEY     DBKEY
     C                     Z-ADD91        DBASE
     C                     MOVE STSBKP    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  SKDSR  - SUBROUTINE FOR ERROR HANDLING OF ACCOUNT KEYS       *
      *                                                               *
      *****************************************************************
      *
     C           SKDSR     BEGSR                           *** SKDSR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'SEKEY'   DBFILE
     C                     MOVELACKY      DBKEY
     C                     Z-ADD92        DBASE
     C                     MOVE STSSKD    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  SKASR  - SUBROUTINE FOR ERROR HANDLING OF ACCOUNT KEYS AUDIT *
      *           RECORD                                              *
      *                                                               *
      *****************************************************************
      *
     C           SKASR     BEGSR                           *** SKASR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'SEKEY'   DBFILE
     C                     MOVEL'AUDIT'   DBKEY
     C                     Z-ADD93        DBASE
     C                     MOVE STSSKA    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BHASR  - SUBROUTINE FOR ERROR HANDLING OF BOOK POSITION      *
      *           HEADER AUDIT RECORD.                                *
      *                                                               *
      *****************************************************************
      *
     C           BHASR     BEGSR                           *** BHASR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BKPHD'   DBFILE
     C                     MOVEL'AUDIT'   DBKEY
     C                     Z-ADD94        DBASE
     C                     MOVE STSBHA    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BKASR  - SUBROUTINE FOR ERROR HANDLING OF BOOK POSITIONS     *
      *           AUDIT RECORD.                                       *
      *                                                               *
      *****************************************************************
      *
     C           BKASR     BEGSR                           *** BKASR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BKPOS'   DBFILE
     C                     MOVEL'AUDIT'   DBKEY
     C                     Z-ADD95        DBASE
     C                     MOVE STSBKA    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BPASR  - SUBROUTINE FOR ERROR HANDLING OF ACTIONS RECORD     *
      *                                                               *
      *****************************************************************
      *
     C           BPASR     BEGSR                           *** BPASR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BPACC'   DBFILE
     C                     MOVELBCKEY     DBKEY
     C                     Z-ADD96        DBASE
     C                     MOVE STSBPA    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BKMSR  - SUBROUTINE FOR ERROR HANDLING OF MONTHLY STATISTICS *
      *           FILE                                                *
      *                                                               *
      *****************************************************************
      *
     C           BKMSR     BEGSR                           *** BKMSR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BKMTH'   DBFILE
     C                     MOVELBCKEYP    DBKEY
     C                     Z-ADD97        DBASE
     C                     MOVE STSBKM    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  BMASR  - SUBROUTINE FOR ERROR HANDLING OF MONTHLY STATISTICS *
      *           AUDIT FILE                                          *
      *                                                               *
      *****************************************************************
      *
     C           BMASR     BEGSR                           *** BMASR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BKMTH'   DBFILE
     C                     MOVEL'AUDIT'   DBKEY
     C                     Z-ADD81        DBASE
     C                     MOVE STSBMA    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  HHDSR  - SUBROUTINE FOR ERROR HANDLING OF HISTORIC BOOK      *
      *           POSITION HEADERS FILE                               *
      *                                                               *
      *****************************************************************
      *
     C           HHDSR     BEGSR                           *** HHDSR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BKPHH'   DBFILE
     C                     MOVELBPKEY     DBKEY
     C                     Z-ADD98        DBASE
     C                     MOVE STSHHD    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  HHASR  - SUBROUTINE FOR ERROR HANDLING OF HISTORIC BOOK      *
      *           POSITION HEADERS AUDIT FILE.                        *
      *                                                               *
      *****************************************************************
      *
     C           HHASR     BEGSR                           *** HHASR  ***
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'BKPHH'   DBFILE
     C                     MOVEL'AUDIT'   DBKEY
     C                     Z-ADD99        DBASE
     C                     MOVE STSHHA    DBSTAT
     C                     MOVE '1'       *IN87
     C                     SETON                       U7U8
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO EAUDIT
     C*
     C                     ENDSR
     C*
     C/COPY WNCPYSRC,SE2220C059
     C*****************************************************************
      /EJECT                                                              S01117
      *****************************************************************   S01117
      *                                                               *   S01117
      *  *PSSR  - Error control subroutine                            *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
      *                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR **    S01117
     C**                                                                  S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C**                                                                  S01117
     C                     ENDSR                                          S01117
      *                                                                   S01117
     C*****************************************************************
     C/COPY WNCPYSRC,SE2220C054
      ***********/EJECT                                            S01232 S01195
     C***********/COPY ZSRSRC,XDATE3Z1                             S01232 S01195
      /EJECT                                                              S01195
     C/COPY ZSRSRC,ZACCH                                                  S01195
      /EJECT                                                              S01195
     C/COPY ZSRSRC,ZBKDT                                                  S01195
      /EJECT
     C/COPY ZSRSRC,ZACCRZ1
      /EJECT                                                              E14616
     C/COPY ZSRSRC,ZACCZZ1                                                E14616
      /EJECT                                                              E20232
     C/COPY ZSRSRC,ZCNSDZ1                                                E20232
      /EJECT                                                              E22957
     C/COPY ZSRSRC,ZAVPRZ1                                                E22957
      /EJECT                                                              E22957
     C/COPY ZSRSRC,ZAPORTZ1                                               E22957
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z2
      /EJECT
     C/COPY ZSRSRC,ZDAYSZ2
      /EJECT
     C/COPY ZSRSRC,ZDYYRZ3
      /EJECT
     C/COPY ZSRSRC,ZEVCDZ1
      /EJECT
     C/COPY ZSRSRC,ZHASHZ3
      /EJECT
     C/COPY ZSRSRC,ZICD2Z1
      /EJECT
     C/COPY ZSRSRC,ZICDSEZ1
      /EJECT
     C/COPY ZSRSRC,ZLCDZ1                                                 E20380
      /EJECT                                                              E20380
     C/COPY ZSRSRC,ZNCDZ3
      /EJECT
     C/COPY ZSRSRC,ZPRCIZ1
      /EJECT                                                              E20087
     C/COPY ZSRSRC,ZPRCOZ1                                                E20087
      /EJECT
     C/COPY ZSRSRC,ZRATEZ1
      /EJECT
     C/COPY ZSRSRC,ZSYSTMZ1
      /EJECT                                                              S01232
     C/COPY ZSRSRC,ZYCEZ1                                                 S01232
      /EJECT
     C/COPY ZSRSRC,ZYLDIZ1
      /EJECT                                                              E20087
     C/COPY ZSRSRC,ZYLDOZ1                                                E20087
      /EJECT
     C/COPY ZSRSRC,ZYLDZ2
     O/EJECT
     C/COPY ZSRSRC,ZCALCD                                                 E39495
     C/EJECT                                                              E39495
     O*BPACCDF*E**             UBPACC                               E18668168141
     OBPACDFX E                UBPACC                                     168141
     O                         RECI                                       E18668
     O                         BCED                                       E18668
     O                         BCP1                                       E18668
     O                         BCP2                                       E18668
     O                         BCPL                                       E18668
     O                         BCAT                                       E18668
     O                         BCDV                                       E18668
     O*BPACBDF*E**             UBPACB                               E18668168141
     OBPABDFX E                UBPACB                                     168141
     O                         RECI                                       E18668
     O                         BCED                                       E18668
     O                         BCP1                                       E18668
     O                         BCP2                                       E18668
     O                         BCPL                                       E18668
     O                         BCAT                                       E18666
     O                         BCDV                                       E18668
     O*BPACHDF*E**             UBPACH                               E18668168141
     OBPAHDFX E                UBPACH                                     168141
     O                         RECI                                       E18668
     O                         BCED                                       E18668
     O                         BCP1                                       E18668
     O                         BCP2                                       E18668
     O                         BCPL                                       E18668
     O                         BCAT                                       E18668
     O                         BCDV                                       E18668
     OBKPHDDF E                UPDBKH
     O                         LPSD
     O                         LPCD
     O                         LAVP
     O                         LATD
     O                         ARPC
     O                         ICLD
     O                         IACR
     O                         IACP
     O                         UPPT
     O                         DPAP
     O                         BUDU
     O                         INDO
     O                         BHCP
     O                         BHDP
     O                         BHPP
     O                         BHTR
     O                         BHRN
     O*****************39******LFXP                                S01486 CPM004
     O                         LFXP                                       CPM004
     O                         DPFP                                       S01397
     O                         DNAT                                       102506
     O                         LAVN                                                           CAS006
     O                         BUDN                                                           CAS006
     O                         DPAN                                                           CAS006
     O                         NAVP                                                           CSE065
     O                         BKVAMT                                                         CSE065
     O                         EQTAMT                                                         CSE065
     O/COPY WNCPYSRC,SE2220O001
     O*
     O*BKPOSDF*E**              UPDBKP                                    E15965
     O************             NPSN                                       E15965
     O************             APPB                                       E15965
     O************             APNC                                       E15965
     O*
     OBKMTHDF E                UPDBKM
     O                         BPIT                                       E22957
     O                         CPDD                                       E15950
     O                         RPTM
     O                         MMPL                                       E15965
     O                         DPTM                                       E20087
     O**********               DPTR                                E20087 E22957
     O**********               DPSP                                E20087 E22957
     O                         BKAMTM                                                         CSE065
     O                         EQAMTM                                                         CSE065
     O/COPY WNCPYSRC,SE2220O002
      *                                                                   E20144
     O*BPACCDF*E       01      RELBPC                               E20144168141
     O*BPACBDF*E       02      RELBPC                               E20144168141
     O*BPACHDF*E       03      RELBPC                               E20144168141
     O*                                                                   S01129
     OBPACCH1FE        04      UPDACT                                     S01129
     O                         HCNTP                                      S01129
     O                         HCNTN                                                          CAS006
     O*                                                                   S01129
     OBPACBH1FE        05      UPDACT                                     S01129
     O                         HCNTP                                      S01129
     O                         HCNTN                                                          CAS006
     O*                                                                   S01129
     OBPACHH1FE        06      UPDACT                                     S01129
     O                         HCNTP                                      S01129
     O                         HCNTN                                                          CAS006
     O*                                                                   S01129
     OBPACCH3FE        13      UPDACB                                     S01129
     O                         HCNTP                                      S01129
     O                         HCNTN                                                          CAS006
     O*                                                                   S01129
     OBPACBH3FE        14      UPDACB                                     S01129
     O                         HCNTP                                      S01129
     O                         HCNTN                                                          CAS006
     O*                                                                   S01129
     OBPACHH3FE        15      UPDACB                                     S01129
     O                         HCNTP                                      S01129
     O                         HCNTN                                                          CAS006
     O*                                                                   S01129
     OBPACCH1FE        04      RELACT                                     S01129
     OBPACBH1FE        05      RELACT                                     S01129
     OBPACHH1FE        06      RELACT                                     S01129
     OBKPOSDF E                UPDBKP                                                         CSE065
     O                         BKCOST                                                         CSE065
      /EJECT
      ***
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  WWARRZ                                                                CPM004
P  PP                                                                     CPM004
R  CO                                                                     CPM004
C  DI                                                                     CPM004
H  DI                                                                     CPM004
M  CV                                                                     CPM004
