     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Generate a/c keys - trades')                  *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Securities Trading Module                            *
     F*                                                               *
     F*  SE2290 - GENERATE TRADE ACCOUNT KEYS                         *
     F*                                                               *
     F*  Function: This program generates Trade-based Account Keys    *
     F*    (COB)   for all Trades (including Book Transfers and Trade *
     F*            Amendments), on Trade and Value date. The Trade    *
     F*            Actions due today for both Dates are then written  *
     F*            to the Trade Actions File (PF/TRDACD), which is    *
     F*            used in COB to identify Book, Customer and Depot   *
     F*            Positions which are affected by the Trade Actions. *
     F*            Records are written to PF/SETLXD if Telexes are    *
     F*            due (processed in SEC0603).                        *
     F*            Trades past Backvalue period are transferred to    *
     F*            the Historical Trades File and Cancelled Trades    *
     F*            are shown on the Cancelled Trades file.            *
     F*            Automatic Settlement Actions for Book Transfers    *
     F*            are written (PF/ASTACD).                           *
     F*            Any changes made to Trades after Trade or Value    *
     F*            Date are monitored and changes affecting Positions *
     F*            are written to User/Customer Depot Movements Files.*
     F*            Indicators to signify that Trade and Value Date    *
     F*            Accounting have been done are updated on the       *
     F*            Trades file.                                       *
     F*                                                               *
     F*  Called by: SEC0602C - Generate A/c Keys - Trades             *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. 258975             Date 22May20               *
      *  Prev Amend No. 243841             Date 22May20               *
      *                 MD046248           Date 27Oct17               *
      *                 215959             Date 21Mar16               *
      *                 226449             Date 24Jun15               *
      *                 250925             Date 15Jun15               *
      *                 CSW210             Date 04May10               *
      *                 CER059             Date 19Jul10               *
      *                 CER054             Date 07Apr09               *
      *                 BUG23123           Date 09Mar09               *
      *                 CER048             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 BUG12826           Date 05Dec06
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 BUG9864            Date 13Jan06               *
      *                 236063             Date 25Aug05               *
      *                 235615             Date 25Aug05               *
      *                 235751             Date 29Aug05               *
      *                 235174             Date 27Jul05               *
      *                 234844             Date 08Jul05               *
      *                 234440             Date 26Jun05               *
      *                 234300             Date 23Jun05               *
      *                 233999             Date 08Jun05               *
      *                 233566             Date 26May05               *
      *                 CGL031             Date 05Jul04               *
      *                 CSE071             Date 19Jul05               *
      *                 223183             Date 21Nov03               *
      *                 BUG3122            Date 17Jul04               *
      *                 CGL029             Date 01Sep03               *
      *                 CGP001             Date 14Oct03               *
      *                 194370             Date 12Jul01               *
      *                 CAS006             Date 21Jan03               *
      *                 211407             Date 07Jan03               *
      *                 180056             Date 18Oct00               *
      *                 CSE035             Date 22Apr02               *
      *                 CSE039             Date 16MAY03               *
      *                 CAP182             Date 19FEB03               *
      *                 CGL020             Date 12Dec02               *
      *                 206316             Date 19Jul02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 01Jul02               *
      *                 CSE031             Date 09Nov01               *
      *                 180707             Date 25Jul00               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 169622             Date 13Jun01               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CSE023             Date 14AUG00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 165636             Date 03May00               *
      *                 161657             Date 20Apr00                  *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSE017             Date 22Oct99               *
      *                 CAP051             DATE 16Nov99               *
      *                 CPB001             DATE 18Jun99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 130862             Date 18Oct98               *
      *                 151945             DATE 06Jan99               *
      *                 CAP003             Date 30Jul98               *
      *                 139104             Date 17Jul98               *
      *                 CEU017             Date 07Apr98               *
     F*                 CSE007             Date 18Mar98               *
     F*                 112898             DATE 23FEB98               *
     F*                 125968             DATE 05DEC97               *
     F*                 S01408             DATE 22JAN98               *
     F*                 CSE005             DATE 04FEB97               *
     F*                 109058             DATE 07APR97               *
     F*                 CAC002             Date 15Sep96               *
     F*                 090247             Date 13Aug96               *
     F*                 084704             Date 01Aug96               *
     F*                 083039             Date 01Aug96               *
     F*                 059110             Date 01Aug96               *
     F*                 088047             Date 26Jun96               *
     F*                 100228             Date 31May96               *
     F*                 037597             DATE 01MAY96               *
     F*                 100017             DATE 18APR96               *
     F*                 S01408             DATE 12FEB96               *
     F*                 092961             DATE 04OCT95               *
     F*                 091254             DATE 20OCT95               *
     F*                 086491             DATE 15JUN95               *
     F*                 080259             DATE 14DEC94               *
     F*                 S01486             DATE 31OCT94               *
     F*                 S01502             DATE 02DEC94               *
     F*                 070683             DATE 12OCT94               *
     F*                 066883             DATE 01FEB93               *
     F*                 052254             DATE 10JAN94               *
     F*                 S01446             DATE 18OCT93               *
     F*                 S01401             DATE 16JUN93               *
     F*                 S01397             DATE 10SEP92               *
     F*                 E39925             DATE 20MAY92               *
     F*                 E37633             DATE 30MAR92               *
     F*                 E37180             DATE 18MAR92               *
     F*                 E35978             DATE 21FEB92               *
     F*                 E35649             DATE 18FEB92               *
     F*                 E23874             DATE 05SEP91               *
     F*                 S01220             DATE 07AUG90               *
     F*                 S01117             DATE 02NOV90               *
     F*                 E23955             DATE 24OCT90               *
     F*                 S01269             DATE 16JUL90               *
     F*                 S01271             DATE 07JUN90               *
     F*                 E23716             DATE 02OCT90               *
     F*                 E22485             DATE 07AUG90               *
     F*                 E21538             DATE 09APR90               *
     F*                 E21606             DATE 02APR90               *
     F*                 E21433             DATE 12MAR90               *
     F*                 E21303             DATE 06MAR90               *
     F*                 E21244             DATE 26FEB90               *
     F*                 E21273             DATE 26FEB90               *
     F*                 E20602             DATE 15DEC89               *
     F*                 E20191             DATE 01DEC89               *
     F*                 E18209             DATE 27NOV89               *
     F*                 E19975             DATE 23NOV89               *
     F*                 E20235             DATE 20NOV89               *
     F*                 E19488             DATE 14NOV89               *
     F*                 E19832             DATE 16OCT89               *
     F*                 E19824             DATE 13OCT89               *
     F*                 E19332             DATE 29AUG89               *
     F*                 E18803             DATE 17AUG89               *
     F*                 E19284             DATE 15AUG89               *
     F*                 E16772             DATE 19/06/89              *
     F*                 E18335             DATE 13/06/89              *
     F*                 E17876             DATE 11/04/89              *
     F*                 E17704             DATE 31/03/89              *
     F*                 E17303             DATE 31/03/89              *
     F*                 E17179             DATE 09/03/89              *
     F*                 E16333             DATE 09/03/89              *
     F*                 E16800             DATE 09/03/89              *
     F*                 E16848             DATE 09/02/89              *
     F*                 E16830             DATE 09/02/89              *
     F*                 E16819             DATE 09/02/89              *
     F*                 S01176             DATE 09/11/88              *
     F*                 S01169             DATE 09/11/88              *
     F*                 E15996             DATE 03/11/88              *
     F*                 E15439             DATE 06/10/88              *
     F*                 E15549             DATE 05/10/88              *
     F*                 E15430             DATE 28/09/88              *
     F*                 E14550             DATE 28/09/88              *
     F*                 E14235             DATE 23/09/88              *
     F*                 E15222             DATE 20/09/88              *
     F*                 E14720             DATE 20/09/88              *
     F*                 E14513             DATE 31/08/88              *
     F*                 E14544             DATE 22/08/88              *
     F*                 S01175             DATE 01/07/88              *
     F*                 S01158             DATE 06/05/88              *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  258975 - The system generate wrong posting date events on    *
      *           the settlement for securities events. Use trade     *
      *           date as posting date when generating trade date     *
      *           account keys.                                       *
      *  253841 - Suppress trade action generation for a matured      *
      *           security to avoid duplicate record error in BKPHDD. *
      *           Partially applied fix 137339.                       *
      *  MD046248 - Finastra Rebranding                               *
      *  215959 - Truncation error on event amount in SE2450P3.       *
      *           Recompiled due to changes in PF/SEKEYD.             *
      *         - Applied for MD-37439.                               *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  250925 - Increase length of fields used to save settlement   *
      *           details to avoid overriding the data. Applied fix   *
      *           243302.                                             *
      *         - Applied for MD-34196.                               *
      *  CSW210 - SWIFT 2010 Changes                                  *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER054 - German Features - Church Tax (Recompile)            *
      *  BUG23123 - Report: Does not show Retail Account Number       *
      *                     Date is not Midas Standard Date           *
      *                     Period should be actual int. calc. period *
      *                     Secondary Tax amount is not printed       *
      *                     Added field TSSLID                        *
      *                     (Recompile)                               *
      *  CER048 - German Features - Taxes (Recompile)                 *
      *  BUG12826 - SEC0602C  00001 (Day 2 PT COB)                    *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  BUG9864 - Component SEC0606K failed due to duplicate records.*
      *            Applied fix 211879.                                *
      *  236063 - CONDITION GENERATION OF REVERSAL ACKEYS             *
      *  235615 - Correct postings generated for a Trade Reversal.    *
      *  235751 - If settlement ccy is different than nominal ccy     *
      *           Nominal amount must be different than settlement    *
      *           amount.
      *  235174 - Trade a/c keys do not consider Joint A/c country.   *
      *  234844 - Customer incomes not retrieved by the program       *
      *  234440 - Purchase Interest management in real time           *
      *  234300 - Recompiled over changed in PF/HSTTRD.               *
      *  233999 - Country code on ET account key must be the country  *
      *           of residence instead of the country of tax          *
      *  233566 - Add fields to CDEPPD                                *
      *  CGL031 - Taxation of Savings Income                          *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  223183 - Don't generate an automatic settlement (ASTACD) for *
      *           trades with the internal customer which are not     *
      *           book transfers.                                     *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CGP001 - Global Processing.                                  *
      *  194370 - Recompile after change on copy sources ZYLDZ2,      *
      *           For securities with divisor basis = '5' and first   *
      *           coupon date > valuation date (rundate + 1), set     *
      *           event control date to first coupon date before      *
      *           processing SR/ZDYYR. This is to ensure that the     *
      *           correct hypothetical last and next coupon dates are *
      *           used in deriving the price/yield rate.              *
      *  CAS006 - Hedge Accounting Phase B.                           *
      *  211407 - Recompile after change on copy sources ZYLDZ2,      *
      *           ZACCRZ1 and ZYCEZ1 for NX/NNX processing.           *
      *           The change was to call subroutine ZLCD1 instead     *
      *           of ZLCD in retrieving the PERIOD for NNX processing *
      *           and ZNCD1 is called instead of ZNCD in retrieving   *
      *           the WBENCD for NNX processing. Also rewrite tests   *
      *           for identifying if position is NX,NNX or CUM.       *
      *  180056 - Recompiled over changed in ZDYYRZ3.                 *
      *  CSE035 - NX/NNX Coupon Payment Processing.                   *
      *  CSE039 - Automatic Settlement of Trades                      *
      *  CAP182 - Auto Settlement of Trades                           *
      *           Recompile over changed SETLED                       *
      *  CGL020 - Compliance Watch - Additional A/C Postings          *
      *           Information                                         *
      *  206316 - Recompiled over changed ZLCDZ1.                     *
      *  CPK015 - Release 4.01 Packaging:                             *
      *           - A default timestamp string is required for WRITE. *
      *  CSE031 - Coupon Fixing for Floating Rate Notes.              *
      *           (recompilation due to change to ZNCD/ZLCD)          *
      *  180707 - No Position Settlements generated. Recompile over   *
      *           changes in /COPY ZNCDZ3.                            *
     F*  169622 - 090247 only applicable if security has a maturity   *
     F*           date (not for shares for example).                  *
      *  CSE023 - Treaty Withholding Tax                              *
     F*  165636 - Accounting problems regarding amended trades.       *
     F*           Fix is to correct reversals for amended trades.     *
     F*  161657 - Recompiled over changed SR/ZCONPRZ1.                *
      *  CSE017 - Cum/Ex Indicator on Depot Movements                 *
     F*  CAP051 - Automatic Authorisation (SE Trades Part)            *
     F*  CPB001 - 'Private Banking' Module                            *
     F*  130862 - Recompiled over ZLCDZ1 & ZDAYSZ2 changes.           *
     F*  151945 - Recompiled Over changed ZDYYRZ3 .                   *
      *  CAP003 - Conversion of Midas inputs to modular API structure *
      *           Phase 2.  Program recompiled over changed files.    *
     F*  139104 - Problem with S01486 which donot set up currency     *
     F*           decimal places before it is being used for          *
     F*           reallowance calculation and hence caused array index*
     F*           error if the trade is the first one being process.  *
     F*  CEU017 - Securities Redenomination Euro Changes              *
     F*           Same coding than CSE007                             *
     F*  CSE007 - Corporate Actions                                   *
     F*  112898 - THE SPOT RATE ON THE TRADE IS THE ONE IN SETTLEMENT *
     F*           CURRENCY.                                           *
     F*  125968 - REVERSAL PROCESSING NOT DONE FOR TRADE DATE.        *
     F*           DUE TO FIX 109058.                                  *
     F*  S01408 - Hook SE2290C033 moved to match the R10.6 source.    *
     F*  CSE005 - Effect of holidays on FRN Coupon Dates              *
     F*           (recompilation due to change to ZNCD/ZLCD)          *
     F*  109058 - TRADE DATE ACCOUNTING MISSED FOR AMENDED TRADE.     *
     F*  CAC002 - Profit Centre Accounting Development - Phase 2      *
     F*           If Analytical Accounting is available, generate a   *
     F*           new margin account key and define the profit centre *
     F*           for each posting.                                   *
     F*  090247 - A DATABASE ERROR OCCURS IN SE0945 IF A TRADE IS NOT *
     F*           FULLY SETTLED BUT THE SECURITY HAS BEEN DROPPED     *
     F*           SO MOVE TRADES TO HSTTRD IF SECURITY HAS MATURED.   *
     F*  084704 - RECOMPILE OVER CHANGED ZYLDZ2 SUB.                  *
     F*  083039 - RECOMPILE OVER CHANGED ZYLDZ2 SUB.                  *
     F*  059110 - RECOMPILE OVER CHANGED ZYLDZ2 SUB.                  *
     F*  088047 - RECOMPILE over change SR/ZYLDZ2.                    *
     F*  100228 - ADD STANDARD SR ZLCDZ1.                             *
     F*           RECOMPILE OVER CHANGED ZDYYRZ3, ZLCDZ1 & ZNCDZ3.    *
     F*  037597 - USE THE SPOT RATE EQUIVALENT OF THE TRADE INSTEAD   *
     F*           OF THE SPOT RATE EQUIVALENT OF TABTG10.             *
     F*  100017 - Position settlement unable to pick up day adjustment*
     F*           on SECTYD. Therefore subroutine ZDAYSZ2 changed to  *
     F*           use indicator DADJN to not apply interest rate      *
     F*           adjustment for amortisation if set to 'N'.          *
     F*  S01408 - Addition of core hook SE2290FFP1
     F*           Addition of core hook SE2290IIP1
     F*           Addition of core hook SE2290CCP1
     F*  092961 - Recompile over ZDAYSZ2 which was amended by 086491  *
     F*           (Wrong number of days calculated for day basis 1    *
     F*           when start or end day is last day of February)      *
     F*  091254 - RECOMPILE OVER CHANGED ZLCDZ1 & ZNCDZ3              *
     F*  086491 - Wrong nbr of days calculated for day basis 1        *
     F*           when start or end day is last day of February       *
     F*           Recompiled for ZSRSRC/ZDAYSZ2 changes.              *
     F*  080259 - Portfolio Ref missing on Trade Actions file         *
     F*           (lines missed by S01486)                            *
     F*  S01486 - Incorporation of PM Enhancements (S01235) and       *
     F*           apply fixes 42217, B05819, B05705, R05367, R05580,  *
     F*           R0166, R0124, S01313, R0710, S05776, and R0661.     *
     F*  S01502 - BLI TELEKURS PROCESSING, RECOMPILED DUE TO CHANGE   *
     F*           IN LENGTH OF SESTAT, 133 LONG.                      *
     F*  070683 - BASED CURRENCY EQUIVALENT IS BEING CLACULATED       *
     F*           INCORRECTLY. IT IS BEING MULTIPLIED INSTEAD OF      *
     F*           DIVIDED.                                            *
     F*  066883 - Generate Countervalue keys correctly as per ICD flag*
     F*           On Trade Date, generate CV keys if Cross Currency   *
     F*           Entries flag is 'T' or 'B'                          *
     F*           On Value Date, generate CV keys if Cross Currency   *
     F*           Entries flag is 'V' or 'B'                          *
     F*  052254 - CURRENT FACTOR amended from 9,8 to 10,9             *
     F*  S01446 - CUSTOMER COMMISSIONS (COURTAGE) ENHANCEMENT         *
     F*           Amended to use the charge code group when           *
     F*           generating the Charges Account Keys.                *
     F*  S01401 - MT5xx SWIFT Messages Feature:                       *
     F*         - Recompiled due to changes to files.                 *
     F*  S01397 - Rel 10 Incorporation of BNZ SARs A46008 and A46013. *
     F*         - Recompiled due to changes to files.                 *
     F*  E39925 - Attempt to update TRAUTD after fail on READE -      *
     F*           caused by DOUNTIL.                                  *
     F*  E37633 - Recompiled for changes to Audit Report. (Changed to *
     F*           stop page without header being printed).            *
     F*  E37180 - Trade entered previous month and reversed this      *
     F*           month indicator should only be 'Y' if action date   *
     F*           is in previous month too                            *
     F*  E35978 - W05 should use Start of Business trade and          *
     F*           not trade as it is now                              *
     F*  E35649 - Lengths of SREC and TREC need to be increased as    *
     F*           do not match current length of TRADSD               *
     F*  E23874 - Contingent liability keys should not  be produced   *
     F*           if the security details have specified 'N'          *
     F*  S01220 - STRATEGIC RISK MANAGEMENT                           *
     F*           Recompiled over changed PF/SECTYD, PF/SEDEVD        *
     F*  S01117 - Multibranching.                                     *
     F*  E23955 - E22485 incomplete on change of SREC to SREC1/2      *
     F*  S01269 - Trade authorization processing.                     *   S01269
     F*  S01271 - PAY/RECEIVE IN INPUT CYCLE - REMOVE TELEX EXTRACT   *   S01271
     F*           PROCESSING TO NEW PROGRAM SE3320. (NB SOME LINES IN *   S01271
     F*           SR/TRADED, SR/TRADEA, SR/TRADEC,                    *   S01271
     F*           WERE COMMENTED OUT ALREADY BUT HAD NO               *   S01271
     F*           ERROR REFERENCE NUMBER ATTACHED.)  ALSO INCREASE    *   S01271
     F*           LENGTH OF SREC AND TREC TO ACCOUNT FOR INCREASE TO  *   S01271
     F*           LENGTH OF TRADSD.                                   *   S01271
     F*  E23716 - Redundant code removed.                             *
     F*  E22485 - SOB Trades were not saved when read for Amends      *
     F*           resulting in ghost depot movements                  *
     F*         - Amendment to nominal did not action Cust/User Depot *
     F*           Movements, Nominal for reversal Equaled new Nominal *
     F*         - SECED replaced by SECEO and SOBSO for Reversals     *
     F*           all the diary event info it needs                   *
     F*  E21538 - Dropping trades entered in the current month messed *   E21538
     F*           up the Monthly Trading Reconciliation Report.       *   E21538
     F*  E21606 - Book Transfers with Value Date of Next Working Day  *   E21606
     F*           must Update I/C Settlement Nominals on Position     *   E21606
     F*           Files for Next Day's Enquiries.                     *   E21606
     F*  E21433 - Do not reverse the sign on the 'PI' Key if the      *   E21433
     F*           Trade is Ex-Coupon.                                 *   E21433
     F*  E21303 - Accrued Indicator should always be on Trade Action. *   E21303
     F*  E21244 - Incorrect Amounts on Base Currency Euiv. Postings.  *   E21244
     F*  E21273 - No Charge/Commission Keys for Purchases.            *   E21273
     F*  E20602 - Account Keys for Changes and Commissions are        *   E20602
     F*           generated with negative sign.                       *   E20602
     F*  E20191 - Charges are being added to Commissions Total and    *   E20191
     F*           vice-versa.                                         *   E20191
     F*  E18209 - Create an empty Trailer in SETLXA if no Trades exist*   E18209
     F*  E19975 - KCUST and ISSR shouldn't be zeroized before writing *   E19975
     F*           SEKEYD as  issuer and depot cust nos are needed for *   E19975
     F*           account keys with posting ref 4 and 5.              *   E19975
     F*  E20235 - Error E15222 is wrong. Should use TPDY into TRPR,   *   E20235
     F*           not PRIC into TRPR.                                 *   E20235
     F*  E19488 - Error in S01176:                                    *   E19488
     F*           Mishandling of TREC and SREC data structures        *   E19488
     F*           causes corruption of trade records.                 *   E19488
     F*  E19832 - Contingent Liability Keys should only be produced   *   E19832
     F*           if Counterparty is a Market Client.                 *   E19832
     F*  E19824 - Convertible Indicator must be 'Y' or ' ' on         *   E19824
     F*           Contingent Account Keys.                            *   E19824
     F*  E19332 - 1) On Trades amended after Trade Date, but prior to *   E19332
     F*              Value date, reverse out Value Date Keys.         *   E19332
     F*           2) Correct Date Next Working Day movements on       *   E19332
     F*              Trades amended today.                            *   E19332
     F*           3) Price on Depot Movements is zero.                *   E19332
     F*           4) Flag all Customer Depot Movements as Reversals   *   E19332
     F*              so that no Average Price reworking occurs in     *   E19332
     F*              SE2405/SE2410.                                   *   E19332
     F*  E18803 - Set Account Key Sequence Number to zero to allow    *   E18803
     F*           for Multi-Branch system.                            *   E18803
     F*  E19284 - Indicator 50 set off to prevent subsequent Trades   *   E19284
     F*           being flagged as fully Settled.                     *   E19284
     F*  E16772 - Recompiled for the Dividend Payment Amount field    *   E16772
     F*           changes.                                            *   E16772
     F*  E18335 - CONTINGENT LIABILITY KEY SHOULD NOT BE PRODUCED     *   E18335
     F*           FOR PROCESSING TYPES 2,4,7.                         *   E18335
     F*  E17876 - REMOVE E17704, CAUSES SE2100 LOOP IN ALL TEST SYS'S.*   E17876
     F*  E17704 - RECOMPILE PROGRAM OVER CHANGED ZNCDZ3 SR            *   E17704
     F*  E17303 - RECOMPILE PROGRAM OVER CHANGED ZDYYRZ3 ZYLDZ1 ZYLDZ2*   E17303
     F*  E17179 - CHANGE REC ID TO '*' ON DELETED INCOMPLETE TRADES   *   E17179
     F*  E16333 - ONLY WRITE RECORD TO HISTORIC TRADES FILE IF TRADE  *   E16333
     F*           HAS BEEN FULLY SETTLED.                             *   E16333
     F*  E16800 - DO NOT REVERSE SIGN ON ACCOUNT KEYS AS AMOUNT IS    *   E16800
     F*           HELD ON FILE WITH CORRECT SIGN. AND OUTPUT REVERSAL *   E16800
     F*           INDICATOR ON ALL ACCOUNT KEYS.                      *   E16800
     F*  E16848 - OUTPUT ALL CANCELLED TRADE RECORDS WITH RECI 'C'.   *   E16848
     F*  E16830 - INCORRECT SIGN ON PI KEY FOR EX-COUPON TRADE.       *   E16830
     F*  E16819 - WHEN CANCELLING A TRADE, USE START OF BUSINESS VALUE*   E16819
     F*           AS TRADE MAY HAVE SUBSEQUENTLY BEEN AMENDED.        *   E16819
     F*  S01176 - SECURITIES TRADING 3.1                              *   S01176
     F*  S01169 - SECURITIES TRADING 3.1 (BAER INCORPORATION).        *   S01169
     F*  E15996 - DESIGN OMISSIONS - various Julius Baer fixes        *   E14838
     F*  E15439 - IF NO RECORD FOUND FOR TRADE STOP READING SEDEVD,   *   E15439
     F*           PREVIOUSLY READ TO START OF FILE - LONG RUN TIME.   *   E15439
     F*  E15549 - FIX CONNECTED WITH REDELIVERY OF POSITION           *   E15549
     F*           SETTLEMENT PROGRAMS AND OTHER FIXES FROM CD.        *   E15549
     F*           - ACCRUED INDICATOR NOT SET FOR SHARES              *   E15549
     F*  E15430 - CONVERTIBLE INDICATOR MUST BE 'Y' OR ' ' ON         *   E15430
     F*           ACCOUNT KEYS                                        *   E15430
     F*  E14550 - PERFORM ACCOUNTING REVERSAL BASED ON TACI FROM      *   E14550
     F*           START OF BUSINESS RECORD FOR TRADE AMENDMENTS.      *   E14550
     F*  E14235 - ERROR IN SR/ZNCD TO FETCH NEXT COUPON DATE. PROGRAM *   E14235
     F*           RE-COMPILED TO ALLOW FOR NEW SUB-ROUTINE.           *   E14235
     F*  E15222 - UPDATE TRADE ACTION FILE WITH TRADE PRICE, NOT      *   E15222
     F*           THE PRICE/DISCOUNT/YIELD CONTENTS.                  *   E15222
     F*  E14720 - REVERSAL INDICATOR SET OFF ONLY OUTSIDE SR/W01      *   E14720
     F*           TO PREVENT INCORRECT ENTRY GENERATION.              *   E14720
     F*  E14513 - CROSS-CURRENCY ENTRIES SHOULD BE GENERATED          *   E14513
     F*           FOR 'VALUE' AS WELL AS FOR 'BOTH'.                  *   E14513
     F*  E14544 - ENSURE POSITIONS 11-12 ARE BLANK FOR                *   E14544
     F*           CONSIDERATION A/C KEYS.                             *   E14544
     F*  S01175 - EUCLID ENHANCEMENT                                  *   S01175
     F*  S01158 - POST INCORPORATION DEVELOPMENT FIXES                *   S01158
     F*                                                               *
     F*****************************************************************
      *
     FTRDBR   UP  E           K        DISK         KINFDS TRDDS
     F                                              KINFSR TRDSR
     F*TRADSA**UF**E                    DISK         KINFDS TRADS         S01269
     FTRADSA  UF  E                    DISK         KINFDS TRDSA          S01269
     F                                              KINFSR TRASR
     FSECTY   IF  E           K        DISK
     FTRADS   IF  E           K        DISK                               S01269
     F            TRADSDF                           KRENAMETRADSDX        S01269
     FTRADSDY2IF  E           K        DISK                                                   CGL020
     FCLINT   IF  E           K        DISK
     F            CLINTCAF                          KIGNORE
     F            CLINTCBF                          KIGNORE
     F            CLINTCCF                          KIGNORE
     F            CLINTC1F                          KIGNORE
     F*TABSE***IF**E***        K        DISK                              S01117
     F* ICD 1     TABTB10F                          KIGNORE
     F* ICD 2     TABTB11F                          KIGNORE
     F* ICD SE    TABTB36F                          KIGNORE
     F*********** TABTB40F                          KIGNORE               S01117
     F* CCY       TABTG10F                          KIGNORE
     F*********** TABTG20F                          KIGNORE               S01117
     F*********** TABLETAF                          KIGNORE               S01117
     F*********** TABLETHF                          KIGNORE               S01117
     F*********** TABLETJF                          KIGNORE               S01117
     F*********** TABLETLF                          KIGNORE               S01117
     F*********** TABLETRF                          KIGNORE               S01117
     F*********** TABLETXF                          KIGNORE               S01117
     F*********** TABLET2F                          KIGNORE               S01117
     F*********** TABLET3F                          KIGNORE               S01117
     F*********** TABLET5F                          KIGNORE               S01117
     F*********** TABTE10F                          KIGNORE               S01117
     F*********** TABTE20F                          KIGNORE               S01117
     F*********** TABLETNF                          KIGNORE               S01117
     F*********** TABLETKF                          KIGNORE               S01117
     F*********** TABLETPF                          KIGNORE               S01117
     FSOBTR   IF  E           K        DISK
     F            TRADSDF                           KRENAMESOBTRDF
     FINVTP   IF  E           K        DISK
     F***SECED   IF  E           K        DISK                            E22485
     F************SNDEVDF                           KIGNORE               E22485
     FSECEO   IF  E           K        DISK                               E22485
     FSOBSO   IF  E           K        DISK                               E22485
     F            SNDEVDF                           KRENAMESOBSNDF        E22485
     F            SEDEVDF                           KRENAMESOBSEDF        E22485
     FTRAUT   UF  E           K        DISK                               S01269
     FCLBTR   UF  E           K        DISK         KINFDS CLBDS A
     F                                              KINFSR CLBSR
     FCLIABA  UF  E                    DISK         KINFDS CLADS
     F                                              KINFSR CLASR
     FTRDACD  O   E                    DISK         KINFDS TACDS
     F                                              KINFSR TACSR
     FTRDACA  O   E                    DISK         KINFDS TAADS
     F                                              KINFSR TAASR
     FSEKEYD  O   E                    DISK         KINFDS SKYDS
     F                                              KINFSR SKYSR
     FSEKEYA  O   E                    DISK         KINFDS SKADS
     F                                              KINFSR SKASR
     F***SETLXD**O   E                    DISK         KINFDS SLXDS       S01271
     F***                                             KINFSR SLXSR        S01271
     F***SETLXA**O   E                    DISK         KINFDS SLADS       S01271
     F***                                             KINFSR SLASR        S01271
     FCNCTRD  O   E                    DISK         KINFDS CNCDS
     F                                              KINFSR CNCSR
     F            TRADSDF                           KRENAMECNCTRDF
     F***TRA  UF  E                    DISK         KINFDS CNADS
     FCNCTRA  O   E                    DISK         KINFDS CNADS
     F                                              KINFSR CNASR
     FHSTTRD  O   E                    DISK         KINFDS HSTDS
     F                                              KINFSR HSTSR
     F*********** TRADSDF                           KRENAMEHSTTRDF        S01176
     FHSTTRA  UF  E                    DISK         KINFDS HSADS
     F                                              KINFSR HSASR
     FASTACD  O   E                    DISK         KINFDS ASTDS
     F                                              KINFSR ASTSR
     FASTACA  O   E                    DISK         KINFDS ASADS
     F                                              KINFSR ASASR
     FUDPMVD  O   E                    DISK         KINFDS UDPDS
     F                                              KINFSR UDPSR
     FUDPMVA  O   E                    DISK         KINFDS UDADS
     F                                              KINFSR UDASR
     FCDPMVD  O   E                    DISK         KINFDS CDPDS
     F                                              KINFSR CDPSR
     FCDPMVA  O   E                    DISK         KINFDS CDADS
     F                                              KINFSR CDASR
     FSETLED  O   E                    DISK                               S01176
     FSETLEA  UF  E                    DISK                               S01176
     FTRATXD  O   E                    DISK                               S01269
     F            TRADSDF                           KRENAMETRATXDF        S01269
     FHSTAUD  O   E                    DISK                               S01269
     F            TRAUTDF                           KRENAMEHSTAUDF        S01269
      *                                                                                       CGL031
      ***Customer*Income*by Generation*Date/Module*ID/Transaction*no.                  CGL031 234844
     F***SDCSINL6IF  E           K        DISK                                         CGL031 234844
      ** Customer Income by Transaction no./Module ID                                         234844
     FSDCSINLDIF  E           K        DISK                                                   234844
      *                                                                                       CGL031
      ** Start of Business Customer Income by Transaction no./Module ID                       235615
     FSOBCINLDIF  E           K        DISK                                                   235615
     F            SDCSIND0                          KRENAMESOBCIND0                           235615
      *                                                                                       235615
     F/COPY WNCPYSRC,SE2290F001
     FSE2290AUO   E                    PRINTER
     FSEMVTSL1IF  E           K        DISK                               CSE039
     FSEMVTSL0O   E                    DISK                               CSE039
     F            SEMVTSD0                          KRENAMESEMVTSUP       CSE039
     F*
     F/COPY WNCPYSRC,SE2290FFP1
     F*
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*10-19 - CHAINING/READ INDICATORS                               *
     F*   20 - FIRST CYCLE INDICATOR                                  *
     F*   21 - TRADE DATE ACCOUNTING INDICATOR                        *
     F*   22 - VALUE DATE ACCOUNTING INDICATOR                        *
     F*   23 - TRADE DATE A/C IND FOR SOBTR                           *
     F*   24 - VALUE DATE A/C IND FOR SOBTR                           *
     F*   25 - ONLY CREATE COUNTERVALUE KEY FOR SOBTR                 *
     F****26*-*REVERSAL INDICATORFOR TELEX PROCESSING                 *   S01271
     F*   27 - COMMISSION TOTAL NEGATIVE                              *
     F*   28 - COMMISSION TOTAL POSITIVE                              *
     F*   29 - PERFORM TRADE DATE PROCESSING                          *
     F*   30 - PERFORM VALUE DATE PROCESSING                          *
     F*   31 - CHARGES TOTAL NEGATIVE                                 *
     F*   32 - CHARGES TOTAL POSITIVE                                 *
     F*   33 - SUPRESS TRADE DATE KEYS                                *
     F*   34 - SUPRESS VALUE DATE KEYS                                *
     F*   35 - REALLOWANCE AMOUNT NEGATIVE                            *
     F*   36 - MAKE ACTION SEQ NO. 11                                 *
     F*   37 - USE DATA FROM SECURITY EVENTS FILE                     *
     F*   38 - ARRAY INDEX LESS THAN 3 FOR C & C KEYS                 *
     F****39*-*NO*NOMINAL*CCY*OUTPUT*ON*REC*TO*SEKEYD***              *   S01176
     F*   40 - DIFFERENCE MESSAGE ON PRINTOUT                         *
     F*   41 - TRADE DATE A/C IND FOR TRADE CHANGES                   *
     F*   42 - NOMINAL CCY DEC PLACES 0                               *
     F*   43 - NOMINAL CCY DEC PLACES 1                               *
     F*   44 - NOMINAL CCY DEC PLACES 2                               *
     F*   45 - NOMINAL CCY DEC PLACES 3                               *
     F*   50 - AUTO-SETTLEMENT INDICATOR IS Y FOR THE CURRENT         *   S01176
     F*        TRADE                                                  *   S01176
     F*   60 - PROCESSING TYPE 2,4 OR 7.                              *   E18335
     F*                                                               *
     F****98*-*ZSYSTM*DATE*FORMAT*IND*                                *   S01117
     F****99*-*ZSYSTM*ICD*RECORD*ERROR*                               *   S01117
     F*   98 - DATE FORMAT IND                                        *   S01117
     F*   99 - RECORD ERROR                                           *   S01117
     F*                                                               *
     F*   U7 - DATABASE ERROR                                         *
     F*   U8 - DATABASE ERROR                                         *
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*   ACC    - PERFORM ACCOUNTING FOR COMPLETE TRADE              *
     F*   ACCREV - REVERSE TRADE ACCOUNTING FOR A COMPLETE TRADE      *
     F*   ACKEY  - GENERATE ACCOUNT KEYS                              *
     F*   ACTION - OUTPUT TRADE ACTION                                *
     F*   AUDIT  - PERFORM RUN CONTROL PROCESS                        *
     F*   CDEPOT - OUTPUT CUST. DEPOT MOVEMENTS FOR AMENDED DEPOT     *
     F*   DATARA - EXTRACT DATA AREA FROM RUNDAT                      *   S01117
     F*   NOMDEC - CALCULATE NOMINAL AMOUNT IN NOMINAL CCY DEC PLACES *
     F*   SRETXR - Retrieve Tax Amount for Reversal from SOB file     *                       235615
     F****TELEX**-*OUTPUT*TELEX*EXTRACT                               *   S01271
     F*   TITLE  - EXTRACT TITLE FROM AOBANKRO                        *   S01117
     F*   TRADEA - PROCESS FULLY AMENDED TRADE                        *
     F*   TRADEC - PROCESS CANCELLED TRADE                            *
     F*   TRADED - PROCESS TRADE-LIVE,NOT FULLY SETTLD, NOT FULLY     *
     F*            AMENDED                                            *
     F*   TRADEP - Process Trade: Changed but awaiting authorisation  *   S01269
     F*   UDEPOT - OUTPUT USER DEPOT MOVEMENTS FOR AMENDED DEPOT      *
     F*   W01    - WRITE GENERATED ACCOUNT KEYS TO SEKEYD             *
     F*   W04    - WRITE CONTINGENT LIABILITY ACCOUNT KEYS TO SEKEYD  *   S01176
     F*   W05    - Write to Trades Awaiting Telex file                *   S01269
     F**                                                              *
     F*   ZCONPR - TO CALCULATE CONTRACT PRICE                        *
     F*   ZCONV  - TO CONVERT AMT FROM ONE CURRENCY TO ANOTHER        *
     F*   ZDATE1 - TO CONVERT DATE TO DAYS                            *
     F*   ZDATE2 - TO CONVERT DAYS TO DATE                            *
     F*   ZDAYS  - TO CALC. NO. OF DAYS BETWEEN TWO DATES             *
     F*   ZDYYR  - TO CALC. NO. OF DAYS IN INTEREST YEAR              *
     F*   ZEVCD  - DETERMINE EVENT CONTROL DATE                       *
     F****ZICDSE*-*RETRIEVE*SECURITIES*TRADING*ICD*RECORD**************   S01117
     F****ZICD2**-*RETRIEVE*ICD*RECORD*2*******************************   S01117
     F*   ZNCD   - TO CALCULATE NEXT COUPON DATE                      *
     F****ZSYSTM*-*RETRIEVE*ICD*RECORD*1*                             *   S01117
     F*   *PSSR  - EXCEPTION ERROR ROUTINE                            *   S01117
     F*                                                               *
     F*****************************************************************
      /EJECT
     E                    NAR     1   1 15                                S01176
     E                    CPY@    1   1 80
     E/COPY ZSRSRC,ZPOWERZ1
     E                    POWER8  1   8  8 4             POWER8 ARRAY
     E/COPY ZSRSRC,ZHASHZ1
     E**********          CCDE        7  2                                S01169
     E**********          CAMT        7 13 0                              S01169
     E                    XCD        10  2                                S01169
     E                    XAM        10 13 0                              S01169
     E                    RAM         3 13 0                              S01176
     E                    RCD         3  2                                S01176
     E/COPY ZSRSRC,ZNCDZ1
     E/COPY ZSRSRC,ZDAYSZ1
     E/COPY ZSRSRC,ZDATE2Z1
     E                    STAMP   1   1 26                                                    CPK015
     E                    NARR    1   1 30               NARRATIVE        CSE039
     E                    TMMP    1   1 26               TIMESTAMP        CSE039
      ** Array containing dummy timestamp                                                     CPK015
      /EJECT
     I*
     I/COPY WNCPYSRC,SE2290IIP1
     i*
     I*
     I* RENAME PORTFOLIO REFERENCE FIELD                                  S01486
     ITRADSDF                                                             S01486
     I              PTFR                            XPTFR                 S01486
     I              COAF                            XCOAF                 CSE007
     I/COPY ZSRSRC,ZNCDZ2
     IRECIN     E DSTRDBR
     I              ZZ005                           ZZ005X                052254
     I                                        1 256 RECIN1                S01486
     I                                      257 512 RECIN2                S01486
     I***********                           513 528 RECIN3         S01486 CAC002
     I***********                           513 554 RECIN3         CAC002 CSE007
     I***********                           513 555 RECIN3         CSE007 CAP051
     I**********                            513 633 RECIN3                             CAP051 250925
     I                                      513 715 RECIN3                                    250925
     ITREC        DS                                                      S01176
     I***********                             1 250 TREC1           S01176E35649
     I************                          251 500 TREC2          S01176 S01271
     I***********                           251 503 TREC2           S01271E35649
     I*************************************   1 255 TREC1          E35649 S01486
     I************************************* 256 510 TREC2          E35649 S01486
     I                                        1 256 TREC1                 S01486
     I                                      257 512 TREC2                 S01486
     I***********                           513 528 TREC3          S01486 CAC002
     I***********                           513 554 TREC3          CAC002 CSE007
     I***********                           513 555 TREC3          CSE007 CAP051
     I**********                            513 633 TREC3                              CAP051 250925
     I                                      513 715 TREC3                                     250925
     ISREC        DS                                                      S01176
     I***********                             1 250 SREC1           S01176E35649
     I************                          251 500 SREC2          S01176 S01271
     I***********                           251 503 SREC2           S01271E35649
     I*************************************   1 255 SREC1          E35649 S01486
     I************************************* 256 510 SREC2          E35649 S01486
     I                                        1 256 SREC1                 S01486
     I                                      257 512 SREC2                 S01486
     I***********                           513 528 SREC3          S01486 CAC002
     I***********                           513 554 SREC3          CAC002 CSE007
     I/COPY WNCPYSRC,SE2290I006
     I***********                           513 555 SREC3          CSE007 CAP051
     I**********                            513 633 SREC3                              CAP051 250925
     I                                      513 715 SREC3                                     250925
     I            DS
     I                                        1  20 ACKY
     I                                        1   3 INTP
     I                                        4   4 EVCD
     I                                        5   5 TRDT
     I                                        6   6 PFIN
     I                                        7   8 BKCD
     I                                        9  10 TRSB
     I                                       11  12 CCCD
     I                                       13  13 MKT
     I                                       14  14 CNVI
     I/COPY WNCPYSRC,SE2290I001
     I**********                             15  18 FILL1                                     CGL031
     I                                       15  16 FILL1                                     CGL031
     I                                       17  18 CTTX                                      CGL031
     I/COPY WNCPYSRC,SE2290I002
     I                                       19  20 AMTC
     I/COPY WNCPYSRC,SE2290I007
     I            DS
     I************                            1  34 TRSIDS                E22485
     I**********                              1  40 TRSIDS                             E22485 CGL029
     I                                        1  76 TRSIDS                                    CGL029
     I                                        1   20TRSMTH
     I**********                              3  14 TRPYFM                                    CGL029
     I                                        3  14 TRQQFM                                    CGL029
     I************                           15  170TRPYFB                S01117
     I                                       15  17 TRPYFA                S01117
     I**********                             18  29 TRPAYT                                    CGL029
     I                                       18  29 TRQQYT                                    CGL029
     I************                           30  320TRPYTB                S01117
     I                                       30  32 TRPYTA                S01117
     I                                       33  340TRASNM
     I                                       35  400TRNOML                E22485
     I                                       41  58 TRPYFM                                    CGL029
     I                                       59  76 TRPAYT                                    CGL029
     I            DS
     I************                            1  34 SOSIDS                E22485
     I**********                              1  40 SOSIDS                             E22485 CGL029
     I                                        1  76 SOSIDS                                    CGL029
     I                                        1   20SOSMTH
     I**********                              3  14 SOPYFM                                    CGL029
     I                                        3  14 SOQQFM                                    CGL029
     I************                           15  170SOPYFB                S01117
     I                                       15  17 SOPYFA                S01117
     I**********                             18  29 SOPAYT                                    CGL029
     I                                       18  29 SOQQYT                                    CGL029
     I************                           30  320SOPYTB                S01117
     I                                       30  32 SOPYTA                S01117
     I                                       33  340SOASNM
     I                                       35  400SONOML                E22485
     I                                       41  58 SOPYFM                                    CGL029
     I                                       59  76 SOPAYT                                    CGL029
     I*                                                                   S01094
     I            DS                                                      S01094
     I*    Hash totalling fields                                          S01094
     I                                        1  153ZZAMT                 S01094
     I                                       16  300ZZAMTI                S01094
     I                                       31  330ZZAMTD                S01094
     I                                       34  360ZZTOTD                S01094
     I                                       37  510ZZTOTI                S01094
     I                                       52  520Z                     S01094
     I                                       53  530S                     S01094
     I*
     I* DATA STRUCTURES FOR ERROR HANDLING
     I*
     ITRDDS       DS
     I                                     *STATUS  STSTRD
     I*
     I*TRADS******DS                                                      S01269
     ITRDSA       DS                                                      S01269
     I                                     *STATUS  STSTRA
     I*
     ICLBDS       DS
     I                                     *STATUS  STSCLB
     I*
     ICLADS       DS
     I                                     *STATUS  STSCLA
     I*
     ITACDS       DS
     I                                     *STATUS  STSTAC
     I*
     ITAADS       DS
     I                                     *STATUS  STSTAA
     I*
     ISKYDS       DS
     I                                     *STATUS  STSSKY
     I*
     ISKADS       DS
     I                                     *STATUS  STSSKA
     I*
     I***SLXDS****DS                                                      S01271
     I************                         *STATUS  STSSLX                S01271
     I*
     I***SLADS****DS                                                      S01271
     I************                         *STATUS  STSSLA                S01271
     I*
     ICNCDS       DS
     I                                     *STATUS  STSCNC
     I*
     ICNADS       DS
     I                                     *STATUS  STSCNA
     I*
     IHSTDS       DS
     I                                     *STATUS  STSHST
     I*
     IHSADS       DS
     I                                     *STATUS  STSHSA
     I*
     IASTDS       DS
     I                                     *STATUS  STSAST
     I*
     IASADS       DS
     I                                     *STATUS  STSASA
     I*
     IUDPDS       DS
     I                                     *STATUS  STSUDP
     I*
     IUDADS       DS
     I                                     *STATUS  STSUDA
     I*
     ICDPDS       DS
     I                                     *STATUS  STSCDP
     I*
     ICDADS       DS
     I                                     *STATUS  STSCDA
     I*
     ISESTAT    E DS
     I              EUTX                            XEUTX                                     CGL031
     I/COPY WNCPYSRC,SE2290I004
     I*
     I***LDA*****   UDS                            256                    S01117
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 177 DBASE                 S01117
     ILDA         DS                            256                       S01117
     I                                      134 183 DBLOT                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     IRUNDT       DS                                                      S01117
      *                                                                   S01117
      ** RUNDAT data area                                                 S01117
      *                                                                   S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
      *                                                                   S01446
      ** External DS for Charges types details                            S01446
      *                                                                   S01446
     I@SECGT    E DSSECGT                                                 S01446
     I              RECI                            XRECI                 S01446
     I              LCD                             XLCD                  S01446
     I              CHTP                            XCHTP                 S01446
     I              TNLU                            XTNLU                 S01446
     I              PRFC                            XPRFC                 CAC002
     I/COPY WNCPYSRC,SE2290I003
      *                                                                   S01117
      ** External DS for bank details                                     S01117
     I*                                                                   S01117
     ISDBANK    E DSSDBANKPD                                              S01117
     I              BJURPT                          TITL                  S01117
     I*                                                                   S01117
     I**  EXTERNAL DS FOR SECURITIES TRADING DETAILS                      S01117
     ISDSTRD    E DSSDSTRDPD                                              S01117
     I*                                                                   S01117
     I**  EXTERNAL DS FOR GENERAL LEDGER ICD DETAILS                      S01117
     ISDGELR    E DSSDGELRPD                                              S01117
     I*                                                                   S01117
     I** Currency details                                                 S01117
     ISDCURR    E DSSDCURRPD                                              S01117
     I*                                                                   S01486
     I** Module details                                                   S01486
     ISDMMOD    E DSSDMMODPD                                              S01486
     I** Security Client Details                                          CSE039
     ISDSECS    E DSSDSECSPD                                              CSE039
     I              QQACCD                          QQACC1                                    CGL029
     I/COPY WNCPYSRC,SE2290I005
     I*                                                                   S01117
     ISCSARD    E DSSCSARDPD                                                                  CGL020
     I              LCD                             WLCD                                      CGL020
     I              ZONE                            WZONE                                     CGP001
     I** Switchable features file                                                             CGL020
     I*                                                                                       CGL020
     I** Data structure for access objects, short data structure          S01117
     I*                                                                   S01117
     IDSFDY     E DSDSFDY                                                 S01117
     I*                                                                   S01117
     I** LONG STRUCTURE FOR ACCESS OBJECTS, LONG DATA STRUCTURE           S01117
     IDSSDY     E DSDSSDY                                                 S01117
     I*                                                                   S01117
     ICPYR@#      DS
     I*
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     I*
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *                                                                                       CGL020
      ** Set constant field for ZAAMLSETSE routine's name                                     CGL020
      *                                                                                       CGL020
     I              'ZAAMLSETSE'          C         SETAML                                    CGL020
      *                                                                                       CGL020
     I**********                              1   60PTCNR                              CGL020 CSD027
     I                                        1   6 PTCNR                                     CSD027
     C/EJECT
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
     C/COPY WNCPYSRC,SE2290C001
      *                                                                   S01486
      *** Copyright Statement                                             S01486
     C                     MOVEACPY@      ACT@   80                       S01486
     C*
     C* KEYLISTS FOR FILE CHAINS
     C*
     C*   - CLIENT FILE
     C*
     C           CLNUM     KLIST
     C                     KFLD           TCNR
     C                     KFLD           CRCT    1
     C*
     C*  - INVESTMENT TYPE
     C*
     C           ITKEY     KLIST
     C                     KFLD           NMCY
     C                     KFLD           SITP
     C*
     C*  - SECURITY DIARY EVENTS
     C*
     C           SEKEY     KLIST
     C                     KFLD           TDSS
     C***********          KFLD           EVDT    50                      E22485
     C                     KFLD           EVTP    2
     C                     KFLD           EVDT    50                      E22485
     C*                                                                   CSE039
     C*  - MOVEMENTS STATUS FILE                                          CSE039
     C*                                                                   CSE039
     C           KSEMV     KLIST                                          CSE039
     C                     KFLD           KTDRF   6                       CSE039
     C                     KFLD           KTRTY   1                       CSE039
     C                     KFLD           KNTDT   50                      CSE039
     C*                                                                   CSE039
      *                                                                                       CGL031
      ** Customer Income Key List                                                             CGL031
      *                                                                                       CGL031
     C           KCSIN     KLIST                                                              CGL031
     C***********          KFLD           WGDAT   50                                   CGL031 234844
     C***********          KFLD           WMODI   1                                    CGL031 234844
     C                     KFLD           WTRNO   60                                          CGL031
     C                     KFLD           WMODI   1                                           234844
      *                                                                                       CGL031
     C/COPY WNCPYSRC,SE2290C002
     C*
     C           MAIN      TAG
     C*
     C** Initialise trade subroutine indicator                            165636
     C*                                                                   165636
     C                     MOVE ' '       @SUBR   1                       165636
     C*                                                                   165636
     C* If trade is incomplete, add to audit count and skip all further
     C* processing
     C*
     C           TINC      IFEQ 'I'
     C           RECI      IFEQ 'D'
     C                     ADD  1         DICNT
     C                     ELSE
     C           RECI      IFEQ 'A'
     C                     ADD  1         AICNT
     C                     ELSE                                           E17179
     C           RECI      IFEQ 'C'                                       E17179
     C                     MOVE '*'       RECI                            E17179
     C                     ADD  1         DAUCNT                          E17179
     C                     UPDATTRADSDF                                   E17179
     C/COPY WNCPYSRC,SE2290C046
     C                     END                                            E17179
     C                     END
     C                     END
     C                     ADD  1         LAUCNT
     C                     GOTO MEND
     C                     ELSE
     C*
     C* If trade is complete and deleted, ignore
     C*
     C           RECI      CABEQ'*'       MEND
     C                     END
     C*
     C* STORE INPUT RECORD FROM TRADSD
     C*
     C**********           MOVE RECIN     TREC                            S01169
     C**********           MOVELRECIN     TREC                     S01169 S01176
     C*
     C******************** MOVELRECIN     TREC1                    S01176 S01486
     C******************** MOVE RECIN     TREC2                    S01176 S01486
     C                     MOVE RECIN1    TREC1                           S01486
     C                     MOVE RECIN2    TREC2                           S01486
     C                     MOVE RECIN3    TREC3                           S01486
     C*                                                                   S01176
     C** STORE FIELD DETAILS FROM TRADSD                                  S01176
     C** DELIVER FROM                                                     S01176
     C** DELIVER TO                                                       S01176
     C** LAST CHANGE DATE                                                 S01176
     C** RECORD ID                                                        S01176
     C** ACCOUNTING INDICATOR                                             S01176
     C** CURRENT FACTOR                                                   S01176
     C** AUTO SETTLE INDICATOR                                            S01176
     C*                                                                   S01176
     C           *LIKE     DEFN DELF      TDELF                           S01176
     C                     MOVE DELF      TDELF                           S01176
     C           *LIKE     DEFN DELT      TDELT                           S01176
     C                     MOVE DELT      TDELT                           S01176
     C           *LIKE     DEFN LCD       TLCD                            S01176
     C                     Z-ADDLCD       TLCD                            S01176
     C           *LIKE     DEFN RECI      TRECI                           S01176
     C                     MOVE RECI      TRECI                           S01176
     C                     MOVE *BLANK    WKGNRV  1                                           236063
     C           *LIKE     DEFN RECI      WKRECI                                              236063
      *   NOTE TRADSD RECI.                                                                   236063
     C                     MOVE RECI      WKRECI                                              236063
     C           *LIKE     DEFN TACI      TTACI                           S01176
     C                     MOVE TACI      TTACI                           S01176
     C           *LIKE     DEFN TCFC      TTCFC                           S01176
     C                     Z-ADDTCFC      TTCFC                           S01176
     C           *LIKE     DEFN AUTS      TAUTS                           S01176
     C                     MOVE AUTS      TAUTS                           S01176
     C           *LIKE     DEFN TDBK      TTDBK                           S01176
     C                     MOVE TDBK      TTDBK                           S01176
     C************LIKE     DEFN TDBR      TTDBR                    S01176 S01117
     C***********          MOVE TDBR      TTDBR                    S01176 S01117
     C           *LIKE     DEFN TDBA      TTDBR                           S01117
     C                     MOVE TDBA      TTDBR                           S01117
     C           *LIKE     DEFN TDDT      TTDDT                           S01176
     C                     MOVE TDDT      TTDDT                           S01176
     C           *LIKE     DEFN TDMI      TTDMI                           S01176
     C                     MOVE TDMI      TTDMI                           S01176
     C           *LIKE     DEFN TDVD      TTDVD                           S01176
     C                     MOVE TDVD      TTDVD                           S01176
     C           *LIKE     DEFN PRIC      TPRIC                           E19332
     C                     MOVE PRIC      TPRIC                           E19332
     C           *LIKE     DEFN NOML      TNOML                           E22485
     C                     MOVE NOML      TNOML                           E22485
      *                                                                   S01269
     C           *LIKE     DEFN CHTP      TCHTP                           S01269
     C                     MOVE CHTP      TCHTP                           S01269
     C/COPY WNCPYSRC,SE2290C079
      *                                                                   S01269
     C*
     C* SET UP STANDARD ERROR FIELDS AND RETRIEVE TABLE RECORDS
     C*
     C           *IN20     IFEQ '0'
     C***********          MOVE *BLANKS   DBLOT                           S01117
     C***********          MOVEL'SE2290'  DBPGM                           S01117
     C***********          MOVE *BLANKS   SECSN  10                       S01117
     C                     EXSR TITLE                                     S01117
     C                     EXSR DATARA                                    S01117
     C***********          EXSR ZSYSTM                                    S01117
     C************IN99     IFEQ '1'                                       S01117
     C***********          SETON                     U7U8LR               S01117
     C***********          MOVE 'TABLE'   DBFILE                          S01117
     C***********          MOVELZTABKY    DBKEY            ***************S01117
     C***********          MOVE '01'      DBASE            **DB ERROR 01**S01117
     C***********          GOTO MEND                       ***************S01117
     C***********          END                                            S01117
     C********************************************************************S01117
     C*
     C**RETRIEVE*SECOND*TABLE*RECORD**************************************S01117
     C** RETRIEVE GENERAL LEDGER DETAIL
     C*
     C***********          EXSR ZICD2
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C********** SDGELR    PARM SDGELR    DSFDY                                        S01117 CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C*                                                                   S01117
     C************INU7     IFEQ '1'                                       S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE 'TABLE'   DBFILE
     C***********          MOVELZTABKY    DBKEY
     C***********          MOVE '02'      DBASE            ***************S01117
     C                     MOVEL'SDGELRPD'DBFILE                          S01117
     C                     MOVEL@OPTN     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7                       S01117
     C                     Z-ADD2         DBASE            * DB ERROR 02 *S01117
     C                     OUT  LDA                        ***************S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C                     END
     C*
     C**RETRIEVE*SE*TABLE*RECORD******************************************S01117
     C*
     C***********          EXSR ZICDSE
     C*                                                                   S01117
     C**   ACCESS SECURITIES TRADING DETAIL                               S01117
     C                     CALL 'AOSTRDR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDSTRD    PARM SDSTRD    DSSDY                           S01117
     C*                                                                   S01117
      *
     C************INU7     IFEQ '1'                                       S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDSTRDPD'DBFILE                          S01117
     C                     MOVEL@OPTN     DBKEY                           S01117
     C                     MOVEL@OPTN     DBOPTN  7                       S01117
     C***********          MOVE 'TABLE'   DBFILE                          S01117
     C***********          MOVELZTABKY    DBKEY            ***************S01117
     C***********          MOVE '03'      DBASE            * DB ERROR 03 *S01117
     C                     Z-ADD3         DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C                     END
      *                                                                   S01446
      ** Access switchable features file                                  S01446
      *                                                                   S01446
     C                     CALL 'AOSARDR0'                                S01446
     C                     PARM '       ' @RTCD                           S01446
     C                     PARM '*VERIFY' @OPTN                           S01446
     C                     PARM 'S01446'  @SARD   6                       S01446
     C*                                                                   S01446
      *                                                                   S01446
     C           @RTCD     IFEQ *BLANK                                    S01446
     C                     MOVE 'Y'       S01446  1                       S01446
     C                     END                                            S01446
      *                                                                   CSE017
      **  Determine if feature CSE017 is installed.                       CSE017
      *                                                                   CSE017
     C                     MOVE 'N'       CSE017  1                       CSE017
     C                     CALL 'AOSARDR0'                                CSE017
     C                     PARM '       ' @RTCD                           CSE017
     C                     PARM '*VERIFY' @OPTN                           CSE017
     C                     PARM 'CSE017'  @SARD                           CSE017
      *                                                                   CSE017
     C           @RTCD     IFEQ *BLANK                                    CSE017
     C                     MOVE 'Y'       CSE017                          CSE017
     C                     ELSE                                           CSE017
     C                     MOVE 'N'       CSE017                          CSE017
      *                                                                   CSE017
      ** Database Error (return code other than *NRF)                     CSE017
      *                                                                   CSE017
     C           @RTCD     IFNE '*NRF   '                                 CSE017
     C           *LOCK     IN   LDA                                       CSE017
     C                     MOVEL'SCSARDPD'DBFILE           ***************CSE017
     C                     MOVEL'CSE017'  DBKEY            * DB ERROR 39 *CSE017
     C                     Z-ADD39        DBASE            ***************CSE017
     C                     OUT  LDA                                       CSE017
     C                     MOVE *ON       *INU7                           CSE017
     C                     MOVE *ON       *INU8                           CSE017
     C                     MOVE *ON       *INLR                           CSE017
     C                     EXSR *PSSR                                     CSE017
     C                     ENDIF                                          CSE017
      *                                                                   CSE017
     C                     ENDIF                                          CSE017
      *                                                                                       CGL020
      ** Determine if Midas Compliance Watch is installed                                     CGL020
      *                                                                                       CGL020
     C                     MOVE 'N'       CGL020  1                                           CGL020
     C                     CALL 'AOSARDR0'                                                    CGL020
     C                     PARM '       ' PRTCD   7                                           CGL020
     C                     PARM '*VERIFY' POPTN   7                                           CGL020
     C                     PARM 'CGL020'  PSARD   6                                           CGL020
     C           SCSARD    PARM SCSARD    DSFDY                                               CGL020
      *                                                                                       CGL020
     C           PRTCD     IFNE *BLANK                                                        CGL020
     C           PRTCD     ANDNE'*NRF   '                                                     CGL020
     C           *LOCK     IN   LDA                                                           CGL020
     C                     MOVEL'SE2290'  DBPGM                                               CGL020
     C                     MOVEL'SCSARDPD'DBFILE                                              CGL020
     C                     MOVEL'100'     DBASE                                               CGL020
     C                     MOVELPSARD     DBKEY                                               CGL020
     C                     MOVE '1'       *INU7                                               CGL020
     C                     MOVE '1'       *INU8                                               CGL020
     C                     MOVE '1'       *INLR                                               CGL020
     C                     OUT  LDA                                                           CGL020
     C                     DUMP                                                               CGL020
     C                     RETRN                                                              CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C           PRTCD     IFEQ *BLANK                                                        CGL020
     C                     MOVE 'Y'       CGL020                                              CGL020
     C                     ENDIF                                                              CGL020
      ** Check if CSE039 is installed                                     CSE039
      *                                                                   CSE039
     C                     CALL 'AOSARDR0'                                CSE039
     C                     PARM *BLANKS   @RTCD                           CSE039
     C                     PARM '*VERIFY' @OPTN                           CSE039
     C                     PARM 'CSE039'  @SARD                           CSE039
      *                                                                   CSE039
     C           @RTCD     IFEQ *BLANKS                                   CSE039
     C                     MOVE 'Y'       CSE039  1                       CSE039
     C                     ELSE                                           CSE039
     C                     MOVE 'N'       CSE039                          CSE039
     C                     ENDIF                                          CSE039
      *                                                                                       CGL020
      *                                                                                       CGL031
      ** Check if Taxation of Savings Income (CGL031) is installed                            CGL031
      *                                                                                       CGL031
     C                     MOVE 'N'       CGL031  1                                           CGL031
     C                     CALL 'AOSARDR0'                                                    CGL031
     C                     PARM *BLANKS   PRTCD   7                                           CGL031
     C                     PARM '*VERIFY' POPTN   7                                           CGL031
     C                     PARM 'CGL031'  PSARD   6                                           CGL031
     C           SCSARD    PARM SCSARD    DSFDY                                               CGL031
      *                                                                                       CGL031
     C           PRTCD     IFEQ *BLANK                                                        CGL031
     C                     MOVE 'Y'       CGL031                                              CGL031
     C                     ELSE                                                               CGL031
     C                     MOVE 'N'       CGL031                                              CGL031
      *                                                                                       CGL031
      ** Database Error (return code other than *NRF)                                         CGL031
      *                                                                                       CGL031
     C           PRTCD     IFNE '*NRF   '                                                     CGL031
     C           *LOCK     IN   LDA                                                           CGL031
     C                     MOVEL'SCSARDPD'DBFILE                                              CGL031
     C                     MOVEL'CGL031'  DBKEY                                               CGL031
     C                     Z-ADD40        DBASE                                               CGL031
     C                     OUT  LDA                                                           CGL031
     C                     MOVE *ON       *INU7                                               CGL031
     C                     MOVE *ON       *INU8                                               CGL031
     C                     MOVE *ON       *INLR                                               CGL031
     C                     EXSR *PSSR                                                         CGL031
     C                     ENDIF                                                              CGL031
      *                                                                                       CGL031
     C                     ENDIF                                                              CGL031
      *                                                                                       CGL031
     C/COPY WNCPYSRC,SE2290C076
     C*                                                                   S01486
     C**  Get module details using access object                          S01486
     C*                                                                   S01486
     C                     CALL 'AOMMODR0'                                S01486
     C                     PARM *BLANKS   @RTCD                           S01486
     C                     PARM '*FIRST'  @OPTN                           S01486
     C           SDMMOD    PARM SDMMOD    DSFDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C           *LOCK     IN   LDA                                       S01486
     C                     Z-ADD25        DBASE            ***************S01486
     C                     MOVE 'SDMMODPD'DBFILE           * DB ERROR 25 *S01486
     C                     MOVEL@OPTN     DBKEY            ***************S01486
     C                     SETON                     U7U8                 S01486
     C                     OUT  LDA                                       S01486
     C                     DUMP                                           S01486
     C                     GOTO MEND                                      S01486
     C                     END                                            S01486
      *
      ** Access SAR details file to see if CSE035 is installed                                CSE035
      *                                                                                       CSE035
     C                     CALL 'AOSARDR0'                                                    CSE035
     C                     PARM '       ' @RTCD   7                                           CSE035
     C                     PARM '*VERIFY' @OPTN   7                                           CSE035
     C                     PARM 'CSE035'  WSARD   6                                           CSE035
      *                                                                                       CSE035
     C           @RTCD     IFEQ *BLANK                                                        CSE035
     C                     MOVE 'Y'       CSE035  1                                           CSE035
     C                     ELSE                                                               CSE035
     C                     MOVE 'N'       CSE035                                              CSE035
     C                     ENDIF                                                              CSE035
      *                                                                                       CAS006
     C                     CALL 'AOSARDR0'                                                    CAS006
     C                     PARM *BLANKS   PRTCD   7                                           CAS006
     C                     PARM '*VERIFY' POPTN   7                                           CAS006
     C                     PARM 'CAS006'  PSARD   6                                           CAS006
      *                                                                                       CAS006
     C           PRTCD     IFNE *BLANKS                                                       CAS006
     C           PRTCD     ANDNE'*NRF    '                                                    CAS006
     C           *LOCK     IN   LDA                                                           CAS006
     C                     MOVE 'SCSARDPD'DBFILE                                              CAS006
     C                     Z-ADD26        DBASE                                               CAS006
     C                     MOVEL'CAS006'  DBKEY                                               CAS006
     C                     MOVE '1'       *INU7                                               CAS006
     C                     MOVE '1'       *INU8                                               CAS006
     C                     MOVE '1'       *INLR                                               CAS006
     C                     OUT  LDA                                                           CAS006
     C                     EXSR *PSSR                                                         CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C           PRTCD     IFEQ *BLANKS                                                       CAS006
     C                     MOVE 'Y'       CAS006  1                                           CAS006
     C                     ELSE                                                               CAS006
     C                     MOVE 'N'       CAS006                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
      *
     C/COPY WNCPYSRC,SE2290C038
     C*
     C* DETERMINE EVENT CONTROL DATE AND CALCULATE BACK VALUE DATE
     C*
     C                     Z-ADDBJDNWD    ZZDNWD                          S01117
     C                     Z-ADDBKAPDT    ZZAPDT                          S01117
     C*
     C                     EXSR ZEVCD
     C***********ECD       SUB  BKVP      BKVD    50                      S01117
     C           ECD       SUB  BVBVP     BKVD    50                      S01117
     C           RUND      SUB  31        MTHAGO  50                      E21538
     C                     SETON                     20
     C                     END
     C*
     C* MOVE SETTLEMENT DETAILS INTO DATA STRUCTURE
     C*
     C                     MOVE SMTH      TRSMTH
     C                     MOVE PYFM      TRPYFM
     C***********          MOVE PYFB      TRPYFB                          S01117
     C                     MOVE PYFA      TRPYFA                          S01117
     C                     MOVE PAYT      TRPAYT
     C***********          MOVE PYTB      TRPYTB                          S01117
     C                     MOVE PYTA      TRPYTA                          S01117
     C                     MOVE ASNM      TRASNM
     C                     MOVE NOML      TRNOML                          E22485
     C/COPY WNCPYSRC,SE2290C071
     C*
     C* IF TRADE FOR NEW SECURITY RETRIEVE SECURITY RECORD
     C*
     C           TDSS      IFNE SECSN
     C           TDSS      CHAINSECTY                15
     C                     MOVE RECI      SRECI   1                                          BUG9864
     C*
     C* DATABASE ERROR IF RECORD NOT FOUND
     C*
     C  N15      RECI      COMP '*'                      15
     C           *IN15     IFEQ '1'
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'SECTY'   DBFILE           ***************
     C                     MOVELTDSS      DBKEY            * DB ERROR 04 *
     C***********          MOVE '04'      DBASE            ***************S01117
     C                     Z-ADD4         DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C                     END
     C*
     C* MOVE INFORMATION INTO WORK FIELDS
     C*
     C                     MOVE TDSS      SECSN  10
     C                     MOVE NMCY      SNMCY   3
     C*                                                                   139104
     C* Access Currency file to get the number of decimal point for the   139104
     C* nominal currency.                                                 139104
     C*                                                                   139104
     C                     CALL 'AOCURRR0'                                139104
     C                     PARM '*MSG   ' @RTCD   7                       139104
     C                     PARM '*KEY   ' @OPTN   7                       139104
     C                     PARM SNMCY     @AJCD   3                       139104
     C           SDCURR    PARM SDCURR    DSSDY                           139104
     C*                                                                   139104
     C           @RTCD     IFNE *BLANK                                    139104
     C                     SETON                     U7U8LR               139104
     C           *LOCK     IN   LDA                                       139104
     C                     MOVEL'SDCURRPD'DBFILE                          139104
     C                     MOVE @AJCD     DBKEY                           139104
     C                     MOVE @OPTN     DBOPTN                          139104
     C                     Z-ADD38        DBASE                           139104
     C                     OUT  LDA                                       139104
     C                     DUMP                                           139104
     C                     GOTO MEND                                      139104
     C                     END                                            139104
     C*
     C* RETRIEVE INVESTMENT TYPE RECORD - IF NOT THERE DATABASE ERROR
     C*
     C           ITKEY     CHAININVTPDF              18
     C  N18      RECI      COMP 'D'                  1818
     C           *IN18     IFEQ '1'
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'INVTP'   DBFILE           ***************
     C                     MOVELNMCY      KEY6    6        * DB ERROR 09 *
     C                     MOVE SITP      KEY6             ***************
     C                     MOVELKEY6      DBKEY
     C***********          MOVE '09'      DBASE                           S01117
     C                     Z-ADD9         DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C                     END
     C*
     C/COPY WNCPYSRC,SE2290C072
     C                     END
     C*
     C* SETOF WORK INDICATORS
     C*
     C                     SETOF                     212223
     C********             SETOF                     242526               S01271
     C                     SETOF                     2425                 S01271
     C/COPY WNCPYSRC,SE2290C003
     C*
     C* RETRIEVE CLIENT RECORD
     C*
     C                     MOVE '1'       CRCT
     C           CLNUM     CHAINCLINTSEF             16
     C*
     C* IF NOT FOUND DATABASE ERROR
     C*
     C  N16      RECI      COMP 'D'                  1616
     C           *IN16     IFEQ '1'
     C           RECI      ANDNE'C'                                                         BUG12826
     C           TOED      ANDNERUND                                                        BUG12826
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CLINT'   DBFILE           ***************
     C                     MOVELTCNR      KEY7    7        * DB ERROR 05 *
     C                     MOVE '1'       KEY7             ***************
     C                     MOVELKEY7      DBKEY
     C***********          MOVE '05'      DBASE                           S01117
     C                     Z-ADD5         DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C                     END
     C*                                                                   E19284
     C* SET OFF INDICATOR 50 - AUTO SETTLEMENT FOR TRADE                  E19284
     C*                                                                   E19284
     C                     SETOF                         50               E19284
     C*
     C* TEST THE ACCOUNT INDICATOR BITS BIT 0 - TRADE DATE ACCOUNTING
     C*                                 BIT 1 - VALUE DATE ACCOUNTING
     C/COPY WNCPYSRC,SE2290C004
     C*
     C                     TESTB'0'       TACI           21
     C                     TESTB'1'       TACI           22
     C/COPY WNCPYSRC,SE2290C005
     C                     MOVE TACI      WTACI   1
     C*
     C* CHECK RECORD ID OF TRADE RECORD AND PROCESS ACCORDINGLY
     C*
     C           TRECI     IFEQ 'D'
     C           TRECI     OREQ 'A'
     C           TOED      ANDEQRUND
     C                     EXSR TRADED
     C                     GOTO NXSR
     C                     END
     C*
     C           TRECI     IFEQ 'A'
     C           TOED      ANDNERUND
     C***********          EXSR TRADEA                                    S01269
     C***********          GOTO NXSR                                      S01269
     C***********          END                                            S01269
     C*                                                                   S01269
     C* RETRIEVE START OF BUSINESS TRADE RECORD - IF NOT THERE            S01269
     C*          DATABASE ERROR                                           S01269
     C*                                                                   S01269
     C           TDRF      CHAINSOBTRDF              17                   S01269
     C  N17      RECI      COMP '*'                      17               S01269
     C           *IN17     IFEQ '1'                                       S01269
     C                     SETON                     U7U8LR               S01269
     C                     MOVE 'SOBTR'   DBFILE           ***************S01269
     C                     MOVELTDRF      DBKEY            ** DB ERROR 24 S01269
     C***********          MOVE '24'      DBASE            ********S01269 S01117
     C                     Z-ADD24        DBASE                    S01269 S01117
     C                     GOTO MEND                                      S01269
     C                     END                                            S01269
     C                     TESTB'0'       TACI           23               S01269
     C                     TESTB'1'       TACI           24               S01269
     C           TDRF      CHAINTRADSDX              17                   S01269
      *                                                                   S01269
      *  IF ANY ACCOUNTING DONE BEFORE CHANGE                             S01269
      *                                                                   S01269
     C           *IN23     IFEQ '1'                                       S01269
     C           *IN24     OREQ '1'                                       S01269
     C                     EXSR TRADEA                                    S01269
     C                     ELSE                                           S01269
     C                     EXSR TRADED                                    S01269
     C                     END                                            S01269
      *                                                                   S01269
     C                     END                                            S01269
     C*
     C           TRECI     IFEQ 'C'
     C                     EXSR TRADEC
     C                     GOTO NXSR
     C                     END
     C*
     C           TRECI     IFEQ 'S'
     C                     ADD  1         SICNT   50
     C                     END
      *                                                                   S01269
     C           TRECI     IFEQ 'P'                                       S01269
     C                     EXSR TRADEP                                    S01269
      *                                                                   S01269
     C                     END                                            S01269
      *                                                                   S01269
     C           TRECI     IFEQ 'L'                                       S01269
     C                     ADD  1         LICNT   50                      S01269
     C                     SETON                     2936                 S01269
     C                     SETOF                     30                   S01269
     C                     EXSR ACTION                                    S01269
     C***********TDVD      IFLE DNWD                               S01269 S01117
     C           TDVD      IFLE BJDNWD                                    S01117
     C                     SETOF                     29                   S01269
     C                     SETON                     3036                 S01269
     C                     EXSR ACTION                                    S01269
     C                     END                                            S01269
     C                     END                                            S01269
      *                                                                   S01269
     C           TRECI     IFEQ 'R'                                       S01269
     C                     ADD  1         RICNT   50                      S01269
     C           TDRF      SETGTTRAUTDF                                   S01269
     C                     READPTRAUTDF                  17               S01269
      *                                                                   S01269
     C           TLCD      IFEQ RUND                                      S01269
     C*                                                                   S01269
     C* RETRIEVE START OF BUSINESS TRADE RECORD                           S01269
     C*                                                                   S01269
     C           TDRF      CHAINSOBTRDF              17                   S01269
     C           *IN17     IFEQ '1'                                       S01269
     C           TDRI      IFEQ 'D'                                       S01269
     C           TDRI      OREQ 'A'                                       S01269
     C                     EXSR TRADED                                    S01269
     C                     END                                            S01269
     C*                                                                   S01269
     C                     ELSE                                           S01269
     C                     TESTB'0'       TACI           23               S01269
     C                     TESTB'1'       TACI           24               S01269
     C*                                                                   S01269
     C           TDRI      IFEQ 'D'                                       S01269
     C           *IN23     IFEQ '0'                                       S01269
     C           *IN24     OREQ '0'                                       S01269
     C           TDRF      CHAINTRADSDX              17                   S01269
     C                     EXSR TRADED                                    S01269
     C                     END                                            S01269
     C                     END                                            S01269
     C*                                                                   S01269
     C           TDRI      IFEQ 'P'                                       S01269
     C           TDRF      CHAINTRADSDX              17                   S01269
     C                     EXSR TRADEP                                    S01269
     C                     END                                            S01269
     C*                                                                   S01269
     C           TDRI      IFEQ 'A'                                       S01269
     C           TDRF      CHAINTRADSDX              17                   S01269
     C           *IN23     IFEQ '1'                                       S01269
     C           *IN24     OREQ '1'                                       S01269
     C                     EXSR TRADEA                                    S01269
     C                     ELSE                                           S01269
     C                     EXSR TRADED                                    S01269
     C                     END                                            S01269
     C                     END                                            S01269
     C*                                                                   S01269
     C                     END                                            S01269
     C*                                                                   S01269
     C           TDRI      IFEQ 'D'                                       S01269
     C           TDRI      OREQ 'A'                                       S01269
     C           TDRI      OREQ 'S'                                       S01269
     C                     EXSR W05                                       S01269
     C                     END                                            S01269
     C*                                                                   S01269
     C                     ELSE                                           S01269
      *                                                                   S01269
     C           TDRI      IFEQ 'L'                                       S01269
     C                     MOVE ' '       RVLI                            S01269
     C                     SETOF                     30                   S01269
     C                     SETON                     2936                 S01269
     C                     EXSR ACTION                                    S01269
     C***********TDVD      IFLE DNWD                               S01269 S01117
     C           TDVD      IFLE BJDNWD                                    S01117
     C                     SETOF                     29                   S01269
     C                     SETON                     3036                 S01269
     C                     EXSR ACTION                                    S01269
     C                     END                                            S01269
     C                     END                                            S01269
      *                                                                   S01269
     C                     END                                            S01269
     C                     END                                            S01269
     C*                                                                   S01269
     C*
     C**  CHECK IF PAST BACK VALUE DATE
     C**  Do not delete if entered in the last 31 days.                   E21538
     C*
     C           NXSR      TAG
     C*
     C           TDVD      IFGE BKVD
     C/COPY WNCPYSRC,SE2290C067
     C           TOED      ORGT MTHAGO                                    E21538
     C/COPY WNCPYSRC,SE2290C068
     C*
     C                     MOVE 'N'       DROP    1                                          BUG9864
      *                                                                                      BUG9864
     C           SRECI     IFEQ 'D'                                                          BUG9864
      *                                                                                      BUG9864
     C           TRECI     IFNE '*'
     C                     ADD  1         LAUCNT  50
     C                     END
     C                     ELSE                                                              BUG9864
     C           TRECI     IFEQ 'D'                                                          BUG9864
     C           TRECI     OREQ 'L'                                                          BUG9864
     C           TRECI     OREQ 'R'                                                          BUG9864
     C           TRECI     OREQ 'P'                                                           253841
     C                     MOVE 'Y'       DROP                                               BUG9864
     C                     ENDIF                                                             BUG9864
     C                     ENDIF                                                             BUG9864
     C*
     C* IF PAST BACK VALUE DATE WRITE TO HISTORIC TRADE AND ADD TO
     C*    COUNT OF HISTORIC RECORDS
     C*    - ONLY IF TRADE FULLY SETTLED                                  E16333
     C/COPY WNCPYSRC,SE2290C069
     C*
     C                     ELSE
     C                     MOVE 'Y'       DROP                                               BUG9864
     C                     ENDIF                                                             BUG9864
     C/COPY WNCPYSRC,SE2290C077
     C********** TRECI     IFEQ 'S'                                                   E16333 BUG9864
     C/COPY WNCPYSRC,SE2290C070
     C********** RUND      ORGT MATY                                                  090247 BUG9864
     C********** MATY      ANDNE0                                                     169622 BUG9864
     C**********           MOVE TREC      RECIN                           S01169
      *                                                                   E19488
      ***  At this point, the last 67 characters of TREC1 and the         E19488
      ***  first 67 of TREC2 are redundant.                               E19488
      ***  Must move them into RECIN separately to overlay correctly.     E19488
      *                                                                   E19488
     C***********          MOVELTREC      RECIN                    S01176 E19488
     C******************** MOVE TREC2     RECIN                    E19488 S01486
     C******************** MOVELTREC1     RECIN                    E19488 S01486
     C           DROP      IFEQ 'Y'                                                          BUG9864
      *                                                                                      BUG9864
     C                     MOVE TREC3     RECIN3                          S01486
     C                     MOVE TREC2     RECIN2                          S01486
     C                     MOVE TREC1     RECIN1                          S01486
      *                                                                   E19488
     C                     MOVELTRECI     RECI                            S01169
     C                     MOVELTTACI     TACI                            S01169
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVE PTFR      S1PTFR  4                       S01486
     C                     MOVE XPTFR     PTFR                            S01486
     C                     END                                            S01486
     C                     WRITEHSTTRDF
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVE S1PTFR    PTFR                            S01486
     C                     END                                            S01486
     C                     ADD  1         HSTCNT  50
     C           TRECI     IFNE '*'
     C                     MOVE '*'       TRECI
     C                     SUB  1         LAUCNT
     C                     MOVE *BLANKS   PTFR                            080259
     C                     END
      *                                                                   S01269
     C           TDRF      SETLLTRAUTDF                                   S01269
     C                     SETOF                     09                   S01269
     C************IN09     DOUEQ'1'                               S01269  E39925
     C           TDRF      READETRAUTDF                  09               S01269
     C           *IN09     DOWEQ'0'                                       E39925
     C                     WRITEHSTAUDF                                   S01269
     C                     MOVE '*'       RECI                            S01269
     C                     UPDATTRAUTDF                                   S01269
     C                     ADD  1         THACNT  50                      S01269
     C           TDRF      READETRAUTDF                  09               E39925
     C                     END                                            S01269
      *                                                                   S01269
     C                     ELSE                                           E16333
     C                     ADD  1         LAUCNT                          E16333
     C                     END                                            E16333
     C/COPY WNCPYSRC,SE2290C078
     C**********           END                                                               BUG9864
     C*
     C* UPDATE TRADES RECORD
     C*
     C***********          MOVE TREC      RECIN                           S01169
      *                                                                   E19488
      ***  Move last 67 characters of TREC1 and the first 67 of TREC2     E19488
      ***  into RECIN separately to overlay correctly.                    E19488
      *                                                                   E19488
     C***********          MOVELTREC      RECIN                    S01176 E19488
     C******************** MOVE TREC2     RECIN                    E19488 S01486
     C******************** MOVELTREC1     RECIN                    E19488 S01486
     C                     MOVE TREC3     RECIN3                          S01486
     C                     MOVE TREC2     RECIN2                          S01486
     C                     MOVE TREC1     RECIN1                          S01486
      *                                                                   E19488
     C                     MOVELTRECI     RECI                            S01169
     C                     MOVELTTACI     TACI                            S01169
     C           TRECI     IFEQ '*'
     C                     ADD  1         DAUCNT  50
     C                     END
     C*                                                                   S01176
     C** IF AUTO-SETTLEMENT WAS DONE FOR THE CURRENT TRADE UPDATE THE     S01176
     C** FOLLOWING FIELDS ON TRADSD                                       S01176
     C*                                                                   S01176
     C           *IN50     IFEQ '1'                                       S01176
     C*                                                                   S01176
     C** SEQ. NO. TO SEQ NO. + 1                                          S01176
     C** DATE FULLY SETTLED TO TRADE VALUE DATE                           S01176
     C** NOMINAL SETTLED NP TO OUTSTANDING NOMINAL                        S01176
     C** VALUE SETTLED NP TO OUTSTANDING NOMINAL                          S01176
     C** OUTSTANDING NOMINAL TO ZERO                                      S01176
     C** OUTSTANDING VALUE TO ZERO                                        S01176
     C** AUTO-SETTLEMENT IND. SET TO 'N'                                  S01176
     C*                                                                   S01176
     C                     ADD  1         TSSQ                            S01176
     C                     Z-ADDTDVD      TDFS                            S01176
     C                     Z-ADDTOSN      TNSN                            S01176
     C                     Z-ADDTOSV      TVSN                            S01176
     C                     Z-ADD0         TOSN                            S01176
     C                     Z-ADD0         TOSV                            S01176
     C                     MOVE 'N'       AUTS                            S01176
     C*                                                                   S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C                     UPDATTRADSDF
     C/COPY WNCPYSRC,SE2290C047
     C*
     C           MEND      TAG
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *                                                               *
     CLR                   EXSR AUDIT
      *                                                               *
      *================================================================
      /EJECT
     C*****************************************************************
     C*                                                               *
     C**TRADED*-*PROCESS*TRADE*WITH*RED*ID*=*D*******                     S01269
     C* TRADED - Process trade with:                                      S01269
     C*                                                                   S01269
     C* REC ID = D - live and authorised                                  S01269
     C* REC ID = A - amended and authorised and entered today             S01269
     C*                                                                   S01269
     C*****************************************************************
     C*
     C           TRADED    BEGSR                           ** TRADED **
     C*
     C* ADD TO COUNT OF RECORD TYPE AND CHECK VALUE DATE ACCOUNTING
     C*
     C           TRECI     IFNE 'R'                                       S01269
     C                     ADD  1         DICNT   50
     C                     END                                            S01269
     C           *IN22     IFEQ '0'
     C*
     C***CHECK*INCOMPLETE*INDICATOR*******                                S01271
     C** (NOTE - INCOMPLETE TRADES ARE EXCLUDED IN CALLING PROCESS)       S01271
     C*
     C********** TINC      IFEQ 'I'
     C********** SMTH      IFEQ *ZEROS
     C******                                                              S01271
     C******     TINC      IFEQ 'I'                                       S01271
     C******                                                              S01271
     C**IF*LAST*CHANGE*DATE*=*RUN*DATE*OUTPUT*TELEX*EXTRACT****           S01271
     C******                                                              S01271
     C********** TLCD      ANDEQRUND
     C******     TLCD      IFEQ RUND                                      S01271
     C******               EXSR TELEX                                     S01271
     C******               END                                            S01271
     C******               ELSE                                           S01271
     C*
     C* PERFORM ACCOUNTING PROCESS FOR THIS TRADE
     C*
     C                     EXSR ACC
     C*
     C* UPDATE REC ID if processing fully amended trade entered today
     C*
     C           TRECI     IFEQ 'A'
     C                     MOVE 'D'       TRECI
     C                     END
     C*
     C***********          END                                            S01271
     C*
     C                     END
     C*
     C* CHECK DISCRECTIONARY IND = I AND VALUE DATE ACCOUNTING DONE
     C*       RESET REC ID AND ADD TO COUNT
     C*
     C           C1DI      IFEQ 'I'
     C           *IN22     ANDEQ'1'
     C                     MOVE 'S'       TRECI
     C                     ADD  1         FSCNT   50
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * TRADEA - PROCESS TRADE WITH RED ID = A                        *
      *                                                               *
      *****************************************************************
      *
     C           TRADEA    BEGSR                           ** TRADEA **
     C*
     C**ADD*TO*COUNT*FOR*THIS*RECORD*TYPE*AND*CHECK*INCOMPLETE*IND****    S01271
     C*********OUTPUT*TELEX*EXTRACT*IF*INCOMPLETE**********               S01271
     C*********                                                           S01271
     C*********            ADD  1         AICNT   50                      S01271
     C********** TINC      IFEQ 'I'
     C********** SMTH      IFEQ *ZEROS
     C*********  TINC      IFEQ 'I'                                       S01271
     C*********            EXSR TELEX                                     S01271
     C*********                                                           S01271
     C**ELSE*DO*ACCOUNTING*PROCESSING*FOR*THIS*TRADE*****                 S01271
     C*********                                                           S01271
     C*********            ELSE                                           S01271
     C*********            EXSR ACC                                       S01271
     C*********            END                                            S01271
     C*                                                                   S01271
     C* ADD TO COUNT FOR THIS RECORD TYPE                                 S01271
     C*                                                                   S01271
     C                     ADD  1         AICNT   50                      S01271
     C*                                                                   165636
     C** Flag TRADEA as the calling subr. for use in ACCREV               165636
     C*                                                                   165636
     C                     MOVE 'A'       @SUBR                           165636
     C*                                                                   S01271
     C* DO ACCOUNTING PROCESSING FOR THIS TRADE                           S01271
     C*                                                                   S01271
     C                     EXSR ACC                                       S01271
     C*
     C* UPDATE REC ID
     C*
     C           TRECI     IFEQ 'A'                                       S01269
     C                     MOVE 'D'       TRECI
     C                     END                                            S01269
      *                                                                   S01269
     C***********AUTT      IFNE '00'                               S01269 S01117
     C           BVAUTH    IFNE '00'                                      S01117
      *                                                                   S01269
     C           TDRF      SETGTTRAUT                                     S01269
      *                                                                   S01269
     C           TATYP     DOUEQ'AM'                                      S01269
     C           TATYP     OREQ 'CH'                                      S01269
     C                     READPTRAUTDF                  09               S01269
      *                                                                   S01269
     C           *IN09     IFEQ '1'                                       S01269
     C           TDRF      ORNE TRDRF                                     S01269
     C                     SETON                     U7U8LR               S01269
     C                     MOVE 'TRAUT'   DBFILE           ***************S01269
     C                     MOVELTDRF      DBKEY            * DB ERROR 21 *S01269
     C***********          MOVE '21'      DBASE            ********S01269 S01117
     C                     Z-ADD21        DBASE                    S01269 S01117
     C                     GOTO MEND                                      S01269
     C                     END                                            S01269
      *                                                                   S01269
     C                     END                                            S01269
      *                                                                   S01269
     C           TADT      IFLT RUND                                      S01269
     C                     GOTO ENDTA                                     S01269
     C                     END                                            S01269
      *                                                                   S01269
     C                     END                                            S01269
     C*
     C* RETRIEVE START OF BUSINESS TRADE RECORD - IF NOT THERE
     C*          DATABASE ERROR
     C*
     C           TDRF      CHAINSOBTRDF              17
     C  N17      RECI      COMP '*'                      17
     C           *IN17     IFEQ '1'
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'SOBTR'   DBFILE           ***************
     C                     MOVELTDRF      DBKEY            * DB ERROR 06 *
     C***********          MOVE '06'      DBASE            ***************S01117
     C                     Z-ADD6         DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C                     END
     C*
     C* MOVE RECORD INTO DATASTRUCTURE TO PRESERVE FIELDS
     C*      AND DO REVERSAL ACCOUNTING IF NECESSARY
     C*
     C***********          TESTB'0'       WTACI          41               E14550
     C************IN41     IFEQ '1'                                       E14550
     C*
     C**********           MOVE RECIN     SREC                            S01169
     C**********           MOVELRECIN     SREC                     S01169 S01176
     C******************** MOVELRECIN     SREC1                    S01176 S01486
     C******************** MOVE RECIN     SREC2                    S01176 S01486
     C                     MOVE RECIN1    SREC1                           S01486
     C                     MOVE RECIN2    SREC2                           S01486
     C                     MOVE RECIN3    SREC3                           S01486
     C*                                                                   S01176
     C** STORE FIELD DETAILS FROM SOBTRD                                  S01176
     C** DELIVER FROM                                                     S01176
     C** DELIVER TO                                                       S01176
     C*                                                                   S01176
     C           *LIKE     DEFN DELF      SDELF                           S01176
     C                     MOVE DELF      SDELF                           S01176
     C           *LIKE     DEFN DELT      SDELT                           S01176
     C                     MOVE DELT      SDELT                           S01176
     C           *LIKE     DEFN TDBK      STDBK                           S01176
     C                     MOVE TDBK      STDBK                           S01176
     C************LIKE     DEFN TDBR      STDBR                    S01176 S01117
     C***********          MOVE TDBR      STDBR                    S01176 S01117
     C           *LIKE     DEFN TDBA      STDBR                           S01117
     C                     MOVE TDBA      STDBR                           S01117
     C           *LIKE     DEFN TDDT      STDDT                           S01176
     C                     MOVE TDDT      STDDT                           S01176
     C           *LIKE     DEFN TDMI      STDMI                           S01176
     C                     MOVE TDMI      STDMI                           S01176
     C           *LIKE     DEFN TDVD      STDVD                           S01176
     C                     MOVE TDVD      STDVD                           S01176
     C           *LIKE     DEFN PRIC      SPRIC                           E19332
     C                     MOVE PRIC      SPRIC                           E19332
     C           *LIKE     DEFN NOML      SNOML                           E22485
     C                     MOVE NOML      SNOML                           E22485
     C*                                                                   S01176
     C                     TESTB'0'       TACI           23
     C                     TESTB'1'       TACI           24
     C/COPY WNCPYSRC,SE2290C006
     C           *IN23     IFEQ '1'
     C************IN29     ANDNE'1'                                109058 125968
     C***********          SETON                     26                   S01271
     C***********          EXSR TELEX                                     S01271
     C                     EXSR ACCREV
     C                     END
     C/COPY WNCPYSRC,SE2290C007
     C*
     C* OUTPUT RECORD TO CANCELLED TRADES FILE, ADD TO COUNT
     C*        RESTORE TRADE RECORD TO PROCESSING AREA
     C*
     C**********           MOVE SREC      RECIN                           S01169
      *                                                                   E19488
      ***  At this point, the last 67 characters of SREC1 and the         E19488
      ***  first 67 of SREC2 are redundant.                               E19488
      ***  Must move them into RECIN separately to overlay correctly.     E19488
      *                                                                   E19488
     C***********          MOVELSREC      RECIN                    S01176 E19488
     C******************** MOVE SREC2     RECIN                    E19488 S01486
     C******************** MOVELSREC1     RECIN                    E19488 S01486
     C                     MOVE SREC3     RECIN3                          S01486
     C                     MOVE SREC2     RECIN2                          S01486
     C                     MOVE SREC1     RECIN1                          S01486
      *                                                                   E19488
     C                     MOVE 'C'       RECI                            E16848
     C                     MOVEASTAMP,1   TMST             Default Timestamp                  CPK015
     C                     WRITECNCTRDF
     C/COPY WNCPYSRC,SE2290C008
     C                     ADD  1         CNCCNT  50
     C**********           MOVE TREC      RECIN                           S01169
      *                                                                   E19488
      ***  Move last 67 characters of TREC1 and the first 67 of TREC2     E19488
      ***  into RECIN separately to overlay correctly.                    E19488
      *                                                                   E19488
     C***********          MOVELTREC      RECIN                    S01176 E19488
     C******************** MOVE TREC2     RECIN                    E19488 S01486
     C******************** MOVELTREC1     RECIN                    E19488 S01486
     C                     MOVE TREC3     RECIN3                          S01486
     C                     MOVE TREC2     RECIN2                          S01486
     C                     MOVE TREC1     RECIN1                          S01486
      *                                                                   E19488
     C                     MOVELTRECI     RECI                            S01176
     C                     MOVELTTACI     TACI                            S01176
     C*
     C**********           END                                            E14550
     C*
     C*********            ENDSR                                          S01269
     C*                                                                   S01269
     C           ENDTA     ENDSR                                          S01269
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * TRADEC - PROCESS TRADE WITH RED ID = C                        *
      *                                                               *
      *****************************************************************
      *
     C           TRADEC    BEGSR                           ** TRADEC **
     C*
     C* ADD TO COUNT OF CANCELLED RECORDS
     C*
     C                     ADD  1         CICNT   50
     C*                                                                   E16819
     C* FETCH START OF BUSINESS DETAILS, BUT NO D/B ERROR IF NOT FOUND    E16819
     C* AS TRADE MAY HAVE BEEN ENTERED AND CANCELLED TODAY.               E16819
     C*
     C           TDRF      CHAINSOBTRDF              17                   E16819
     C*                                                                   E16819
     C* IF TRADE DATE PROCESSING DONE PERFORM REVERSAL ACCOUNTING
     C*
     C********** *IN21     IFEQ '1'                                       E16819
     C                     TESTB'0'       TACI           23               E16819
     C                     TESTB'1'       TACI           24               E16819
     C/COPY WNCPYSRC,SE2290C009
     C           *IN23     IFEQ '1'                                       E16819
     C*********            SETON                     26                   S01271
     C*********            EXSR TELEX                                     S01271
     C                     EXSR ACCREV
     C                     END
     C/COPY WNCPYSRC,SE2290C010
     C*
     C* OUTPUT TO CANCELLED TRADES AND ADD TO COUNT
     C*
     C**********           MOVE TREC      RECIN                           S01169
      *                                                                   E19488
      ***  Move last 67 characters of TREC1 and the first 67 of TREC2     E19488
      ***  into RECIN separately to overlay correctly.                    E19488
      *                                                                   E19488
     C***********          MOVELTREC      RECIN                    S01176 E19488
     C*                                                                   E22485
     C*** Cancelled record should be as at SOB if it exists               E22485
     C*                                                                   E22485
     C***********          MOVE TREC2     RECIN                    E19488 E22485
     C***********          MOVELTREC1     RECIN                    E19488 E22485
      *                                                                   E19488
     C                     MOVE 'C'       RECI                            E16848
     C                     MOVEASTAMP,1   TMST             Default Timestamp                  CPK015
     C                     WRITECNCTRDF
     C/COPY WNCPYSRC,SE2290C011
     C                     ADD  1         CNCCNT
     C******************** MOVE TREC2     RECIN                    E22485 S01486
     C******************** MOVELTREC1     RECIN                    E22485 S01486
     C                     MOVE TREC3     RECIN3                          S01486
     C                     MOVE TREC2     RECIN2                          S01486
     C                     MOVE TREC1     RECIN1                          S01486
      *
     C                     MOVE '*'       TRECI
     C*
     C*
     C/COPY WNCPYSRC,SE2290CCP1
     C*
     C                     ENDSR
      *                                                                   S01269
      *****************************************************************   S01269
      /EJECT                                                              S01269
      *****************************************************************   S01269
      *                                                                   S01269
      * TRADEP - PROCESS:  Trade, changed but awaiting authorisation      S01269
      *          FOR EACH: Trade with Record ID = P                       S01269
      *          WHEN:     Called from P/TRADE                            S01269
      *                                                                   S01269
      *****************************************************************   S01269
      *                                                                   S01269
     C           TRADEP    BEGSR                           ** TRADEP **   S01269
      *                                                                   S01269
      * Add 1 to count for this record ID                                 S01269
      *                                                                   S01269
     C                     ADD  1         PICNT   50                      S01269
      *                                                                   S01269
      *  produce trade actions sequence '11' for next days enquiries      S01269
      *                                                                   S01269
     C                     SETON                     2936                 S01269
     C                     SETOF                     30                   S01269
     C                     EXSR ACTION                                    S01269
     C***********TDVD      IFLE DNWD                               S01269 S01117
     C           TDVD      IFLE BJDNWD                                    S01117
     C                     SETOF                     29                   S01269
     C                     SETON                     3036                 S01269
     C                     EXSR ACTION                                    S01269
     C                     END                                            S01269
      *                                                                   S01269
     C           TLCD      IFEQ RUND                                      S01269
     C           TOED      ANDNERUND                                      S01269
      *                                                                   S01269
      * Access Start of Business version of this Trade (same trade ref)   S01269
      *    If not found - database error                                  S01269
      *                                                                   S01269
     C           TDRF      CHAINSOBTRDF              17                   S01269
      *                                                                   S01269
     C           *IN17     IFEQ '1'                                       S01269
     C                     SETON                     U7U8LR               S01269
     C                     MOVE 'SOBTR'   DBFILE           ***************S01269
     C                     MOVELTDRF      DBKEY            * DB ERROR 22 *S01269
     C***********          MOVE '22'      DBASE            ********S01269 S01117
     C                     Z-ADD22        DBASE                    S01269 S01117
     C                     GOTO MEND                                      S01269
     C                     END                                            S01269
      *                                                                   S01269
     C                     TESTB'0'       TACI           23               S01269
     C                     TESTB'1'       TACI           24               S01269
     C/COPY WNCPYSRC,SE2290C012
     C           *IN23     IFEQ '1'                                       S01269
      *                                                                   S01269
      * Move record into data structure to preserve fields                S01269
      *                                                                   S01269
     C******************** MOVELRECIN     SREC1                    S01269 S01486
     C******************** MOVE RECIN     SREC2                    S01269 S01486
     C                     MOVE RECIN1    SREC1                           S01486
     C                     MOVE RECIN2    SREC2                           S01486
     C                     MOVE RECIN3    SREC3                           S01486
      *                                                                   S01269
      * Store field details from SOBTRD                                   S01269
      * Deliver from                                                      S01269
      * Deliver to                                                        S01269
      *                                                                   S01269
     C                     MOVE DELF      SDELF                           S01269
     C                     MOVE DELT      SDELT                           S01269
     C                     MOVE TDBK      STDBK                           S01269
     C***********          MOVE TDBR      STDBR                    S01269 S01117
     C                     MOVE TDBA      STDBR                    S01269 S01117
     C                     MOVE TDDT      STDDT                           S01269
     C                     MOVE TDMI      STDMI                           S01269
     C                     MOVE TDVD      STDVD                           S01269
     C                     MOVE PRIC      SPRIC                           S01269
      *                                                                   S01269
      *   do reversal accounting                                          S01269
      *                                                                   S01269
     C                     EXSR ACCREV                                    S01269
     C/COPY WNCPYSRC,SE2290C013
      *                                                                   S01269
      * Copy SOB trade to CANCELLED TRADES FILE (all data unchanged)      S01269
      * ADD 1 to count of records transferred to cancelled trades         S01269
      * Restore trade record to processing area                           S01269
      *                                                                   S01269
     C******************** MOVE SREC2     RECIN                    S01269 S01486
     C******************** MOVELSREC1     RECIN                    S01269 S01486
     C                     MOVE SREC1     RECIN1                          S01486
     C                     MOVE SREC2     RECIN2                          S01486
     C                     MOVE SREC3     RECIN3                          S01486
     C                     MOVE 'C'       RECI                            S01269
     C                     MOVEASTAMP,1   TMST             Default Timestamp                  CPK015
     C                     WRITECNCTRDF                                   S01269
     C/COPY WNCPYSRC,SE2290C014
      *                                                                   S01269
     C                     ADD  1         CNCCNT                          S01269
      *                                                                   S01269
     C***********          MOVE TREC2     RECIN                     S01269E35978
     C***********          MOVELTREC1     RECIN                     S01269E35978
     C***********          MOVELTRECI     RECI                      S01269E35978
     C***********          MOVELTTACI     TACI                      S01269E35978
     C******************** MOVE SREC2     RECIN                    E35978 S01486
     C******************** MOVELSREC1     RECIN                    E35978 S01486
     C                     MOVE SREC1     RECIN1                          S01486
     C                     MOVE SREC2     RECIN2                          S01486
     C                     MOVE SREC3     RECIN3                          S01486
      *                                                                   S01269
      * Write record to PF/TRATXD as per W05                              S01269
      *                                                                   S01269
     C                     EXSR W05                                       S01269
      *                                                                   S01269
     C******************** MOVE TREC2     RECIN                    E35978 S01486
     C******************** MOVELTREC1     RECIN                    E35978 S01486
     C                     MOVE TREC1     RECIN1                          S01486
     C                     MOVE TREC2     RECIN2                          S01486
     C                     MOVE TREC3     RECIN3                          S01486
     C                     MOVELTRECI     RECI                            E35978
     C                     MOVELTTACI     TACI                            E35978
     C                     END                                            S01269
     C                     END                                            S01269
      *                                                                   S01269
     C                     ENDSR                                          S01269
      *                                                                   S01269
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * ACC - PERFORM ACCOUNTING FOR COMPLETE TRADES                  *
      *                                                               *
      *****************************************************************
      *
     C           ACC       BEGSR                           **  ACC **
     C*
     C/COPY WNCPYSRC,SE2290C015
     C**IF*TRADE*DATE*PROCESSING*NOT*DONE*PERFORM*TELEX*EXTRACT*AND***    S01271
     C*****TRADE*ACTIONS*AND*ACCOUNT*KEYS********                         S01271
     C*                                                                   S01271
     C* IF TRADE DATE PROCESSING NOT DONE DO TRADE ACTIONS AND ACCNT KEYS S01271
     C*
     C           *IN21     IFEQ '0'
     C                     SETON                     29
     C                     SETOF                     30
     C***********          EXSR TELEX                                     S01271
     C                     EXSR ACTION
     C                     MOVE '0'       RVRS                            E16800
     C                     EXSR ACKEY
     C                     BITON'0'       TTACI
     C/COPY WNCPYSRC,SE2290C016
     C                     END
     C/COPY WNCPYSRC,SE2290C017
     C*
     C* IF VALUE DATE ACCOUNTING NOT DONE OUTPUT TRADE ACTIONS AND
     C*    ACCOUNT KEY GENERATION
     C*
     C           *IN22     IFEQ '0'
     C           TDVD      ANDLEECD
     C                     SETON                     30
     C                     SETOF                     29
     C                     EXSR ACTION
     C                     MOVE '0'       RVRS                            E16800
     C                     EXSR ACKEY
     C                     BITON'1'       TTACI
     C           C1DI      IFEQ 'I'
     C           LKRF      ANDNE*BLANKS                                                       223183
     C                     MOVE 'D'       RECI
     C                     MOVE TOED      ORED
     C                     MOVE ' '       SRIN
     C                     WRITEASTACDF
     C                     ADD  1         ASTCNT  50
     C                     END
     C***********                                                         S01176
     C**IF*DISCRETIONARY*IND*=*M*AND*TS*TRADE*OUTPUT*CONTINGENT********   S01176
     C*****LIABILITIES*RECORD******************************************   S01176
     C***********                                                         S01176
     C***********C1DI      IFEQ 'M'                                       S01176
     C***********TDTP      ANDEQ'TS'                                      S01176
     C***********          MOVE 'D'       RECI                            S01176
     C***********          WRITECLIABDF                                   S01176
     C***********          ADD  1         CLBADD  50                      S01176
     C***********          END                                            S01176
     C*                                                                   S01176
     C* IF DISCRETIONARY IND = M AND THE CONTINGENT LIABILITY IND.        S01176
     C* (SECTYD) FOR SECURITY ='Y' OUTPUT CONTINGENT LIABILITY RECORD     S01176
     C*                                                                   S01176
     C           C1DI      IFEQ 'M'                                       S01176
     C           TDTP      ANDEQ'TS'                                      S01176
     C           CNLI      ANDEQ'Y'                                       S01176
     C           TCNR      ANDNEISSR                                      E19832
     C                     MOVE 'D'       RECI                            S01176
     C                     WRITECLIABDF                                   S01176
     C                     ADD  1         CLBADD  50                      S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C** RESET PROGRAM INDICATOR ,WHICH IS ONLY SETON IF THE     .        S01176
     C** AUTO SETTLEMENT INDICATOR IS 'Y' FOR THE CURRENT TRADE           S01176
     C*                                                                   S01176
     C                     SETOF                     50                   S01176
     C*                                                                   S01176
     C* IF THE AUTO- SETTLE INDICATOR ON THE TRADE IS 'Y'        .        S01176
     C* OUTPUT A TRADE SETTLEMENT DETAIL RECORD                           S01176
     C*                                                                   S01176
     C           TAUTS     IFEQ 'Y'                                       S01176
     C*                                                                   S01176
     C** SET PROGRAM INDICATOR, WHICH IS ONLY SETON IF THE     .          S01176
     C** AUTO SETTLEMENT INDICATOR IS 'Y' FOR THE CURRENT TRADE           S01176
     C*                                                                   S01176
     C                     SETON                     50                   S01176
     C*                                                                   S01176
     C** RESTORES ORIGINAL TRADE DETAILS FROM STORED COPY         .       S01176
      *                                                                   E19488
      ***  Move last 67 characters of TREC1 and the first 67 of TREC2     E19488
      ***  into RECIN separately to overlay correctly.                    E19488
      *                                                                   E19488
     C***********          MOVE TREC      RECIN                    S01176 E19488
     C*                                                                   E19488
     C******************** MOVE TREC2     RECIN                    E19488 S01486
     C******************** MOVELTREC1     RECIN                    E19488 S01486
     C                     MOVE TREC3     RECIN3                          S01486
     C                     MOVE TREC2     RECIN2                          S01486
     C                     MOVE TREC1     RECIN1                          S01486
     C*                                                                   S01176
     C** OUTPUT TRADE SETTLEMENT DETAIL RECORD                            S01176
     C*                                                                   S01176
     C                     MOVE 'D'       RECI                            S01176
     C                     MOVE TDRF      STDR                            S01176
     C                     Z-ADDTSSQ      SSQN                            S01176
     C                     ADD  1         SSQN                            S01176
     C***********          Z-ADDTDBR      SBCD                     S01176 S01117
     C                     MOVE TDBA      SBCA                            S01117
     C                     Z-ADDTDVD      SEDE                            S01176
     C                     MOVE 'Y'       SFSI                            S01176
     C                     MOVE *BLANK    SRIN                            S01176
     C                     Z-ADDTOSN      SNMS                            S01176
     C                     Z-ADDTOSV      SVLS                            S01176
     C                     MOVE *BLANK    SSRF                            S01176
     C                     MOVELNAR,1     SNTV                            S01176
     C                     MOVE *BLANK    SRSL                            S01176
     C                     MOVE 'F'       SFSL                            S01176
     C                     MOVE 'F'       SNFS                            S01176
     C                     MOVE *BLANK    SOSI                            S01176
     C                     MOVE *BLANK    SDSI                            S01176
     C                     Z-ADD0         SDAM                            S01176
     C                     MOVE TDSS      SSSN                            S01176
     C                     MOVE TCNR      SCPN                            S01176
     C                     MOVE TDMI      SMKI                            S01176
     C                     MOVE TDTP      STET                            S01176
     C                     MOVE SETC      SSCY                            S01176
     C                     MOVE TDBK      SBOC                            S01176
     C                     Z-ADDRUND      LCD                             S01176
     C                     MOVE 'I'       CHTP                            S01176
     C                     Z-ADD0         TNLU                            S01176
     C                     MOVE 'Y'       AUTS                            S01176
     C*                                                                   S01176
     C                     WRITESETLEDF                                   S01176
     C                     ADD  1         SETADD  50                      S01176
      **                                                                  CSE039
      ** Write a record to PF/SEMVTSPD                                    CSE039
     C           CSE039    IFEQ 'Y'                                       CSE039
     C                     EXSR SRSEMV                                    CSE039
     C                     ENDIF                                          CSE039
     C                     END                                            S01176
     C*
     C                     END
     C*
     C* IF TRADE CHANGED AFTER TRADE DATE PROCESSING DONE
     C*    PERFORM SOME ACCOUNTING AGAIN
     C*
     C           *IN21     IFEQ '1'
     C           TLCD      ANDEQRUND
     C           TOED      ANDNERUND
     C*
     C********   TDVD      IFGE ECD                                       S01271
     C********             EXSR TELEX                                     S01271
     C********             END                                            S01271
     C*
     C* RETRIEVE START OF BUSINESS TRADE RECORD
     C*
     C           TDRF      CHAINSOBTRDF              17
     C  N17      RECI      COMP '*'                      17
     C           *IN17     IFEQ '1'
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'SOBTR'   DBFILE           ***************
     C                     MOVELTDRF      DBKEY            * DB ERROR 07 *
     C***********          MOVE '07'      DBASE            ***************S01117
     C                     Z-ADD7         DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C                     END
     C*
     C* MOVE SETTLEMENT DETAILS INTO DATA AREA
     C*
     C**********           MOVE RECIN     SREC                            S01169
     C**********           MOVELRECIN     SREC                     S01169 E23955
     C******************** MOVE RECIN     SREC2                    E22485 S01486
     C******************** MOVELRECIN     SREC1                    E22485 S01486
     C                     MOVE RECIN3    SREC3                           S01486
     C                     MOVE RECIN2    SREC2                           S01486
     C                     MOVE RECIN1    SREC1                           S01486
     C*                                                                   E22485
     C                     MOVE SMTH      SOSMTH
     C                     MOVE PYFM      SOPYFM
     C***********          MOVE PYFB      SOPYFB                          S01117
     C                     MOVE PYFA      SOPYFA                          S01117
     C                     MOVE PAYT      SOPAYT
     C***********          MOVE PYTB      SOPYTB                          S01117
     C                     MOVE PYTA      SOPYTA                          S01117
     C                     MOVE ASNM      SOASNM
     C                     MOVE NOML      SONOML                          E22485
     C*                                                                   E22485
     C                     MOVE DELF      SDELF                           E22485
     C                     MOVE DELT      SDELT                           E22485
     C                     MOVE TDBK      STDBK                           E22485
     C*********************MOVE TDBR      STDBR                    E22485 S01117
     C                     MOVE TDBA      STDBR                           S01117
     C                     MOVE TDDT      STDDT                           E22485
     C                     MOVE TDMI      STDMI                           E22485
     C                     MOVE TDVD      STDVD                           E22485
     C                     MOVE PRIC      SPRIC                           E22485
     C                     MOVE NOML      SNOML                           E22485
     C*
     C* IF SETTLEMENT DETAILS DIFFER REVERSE OLD INFO AND OUTPUT NEW
     C*    COUNTERVALUE KEY ONLY
     C*
     C***********TRSIDS    IFNE SOSIDS                                    109058
     C***********CHTP      OREQ 'C'                                 E22485E23716
     C***********CHTP      IFNE 'C'                                 E22485E23716
     C                     SETON                     25
     C*********************END                                      E22485E23716
     C                     SETON                     29                   E19332
     C                     SETOF                     30                   E19332
     C/COPY WNCPYSRC,SE2290C018
     C                     MOVE '1'       RVRS
     C                     EXSR ACKEY
     C/COPY WNCPYSRC,SE2290C019
     C*
     C**  MOVE BACK TRADSDF DATA
     C*
     C**********           MOVE TREC      RECIN                           S01169
      *                                                                   E19488
      ***  Move last 67 characters of TREC1 and the first 67 of TREC2     E19488
      ***  into RECIN separately to overlay correctly.                    E19488
      *                                                                   E19488
     C***********          MOVELTREC      RECIN                    S01176 E19488
     C******************** MOVE TREC2     RECIN                    E19488 S01486
     C******************** MOVELTREC1     RECIN                    E19488 S01486
     C                     MOVE TREC3     RECIN3                          S01486
     C                     MOVE TREC2     RECIN2                          S01486
     C                     MOVE TREC1     RECIN1                          S01486
      *                                                                   E19488
     C                     MOVELTRECI     RECI                            S01169
     C/COPY WNCPYSRC,SE2290C020
     C                     MOVELTTACI     TACI                            S01169
     C                     MOVE '0'       RVRS
     C                     EXSR ACKEY
     C/COPY WNCPYSRC,SE2290C021
     C***********          END                                            109058
     C*
     C* IF TRADE TYPE = TP AND THE DEPOTS HAVE CHANGED OUTPUT TO
     C*    DEPOT MOVEMENTS FILE
     C*
     C           TDTP      IFEQ 'TP'
     C*
     C* USER DEPOT MOVEMENT
     C*
     C           TDELT     IFNE SDELT
     C           TTDBR     ORNE STDBR                                     E15996
     C           TTDBK     ORNE STDBK                                     E15996
     C           TTDMI     ORNE STDMI                                     E15996
     C           TTDDT     ORNE STDDT                                     E15996
     C           TTDVD     ORNE STDVD                                     E15996
     C           TNOML     ORNE SNOML                                     E22485
     C                     EXSR UDEPOT
     C                     END
     C*
     C* CUSTOMER DEPOT MOVEMENT
     C*
     C           C1DI      IFEQ 'S'
     C********** TDELF     ANDNESDELF                                     E15996
     C           C1DI      OREQ 'D'
     C********** TDELF     ANDNESDELF                                     E15996
     C           TDELF     IFNE SDELF                                     E15996
     C           TTDBR     ORNE STDBR                                     E15996
     C           TTDMI     ORNE STDMI                                     E15996
     C           TTDDT     ORNE STDDT                                     E15996
     C           TTDVD     ORNE STDVD                                     E15996
     C           TNOML     ORNE SNOML                                     E22485
     C                     EXSR CDEPOT
     C                     END                                            E15996
     C                     END
     C*
     C                     END
     C*
     C*
     C* IF TRADE TYPE = TS AND THE DEPOTS HAVE CHANGED OUTPUT TO
     C*    DEPOT MOVEMENTS FILE
     C*
     C           TDTP      IFEQ 'TS'
     C*
     C* USER DEPOT MOVEMENT
     C*
     C           TDELF     IFNE SDELF
     C           TTDBR     ORNE STDBR                                     E15996
     C           TTDBK     ORNE STDBK                                     E15996
     C           TTDMI     ORNE STDMI                                     E15996
     C           TTDDT     ORNE STDDT                                     E15996
     C           TTDVD     ORNE STDVD                                     E15996
     C           TNOML     ORNE SNOML                                     E22485
     C                     EXSR UDEPOT
     C                     END
     C*
     C* CUSTOMER DEPOT MOVEMENT
     C*
     C           C1DI      IFEQ 'S'
     C********** TDELT     ANDNESDELT                                     E15996
     C           C1DI      OREQ 'D'
     C********** TDELT     ANDNESDELT                                     E15996
     C           TDELT     IFNE SDELT                                     E15996
     C           TTDBR     ORNE STDBR                                     E15996
     C           TTDMI     ORNE STDMI                                     E15996
     C           TTDDT     ORNE STDDT                                     E15996
     C           TTDVD     ORNE STDVD                                     E15996
     C           TNOML     ORNE SNOML                                     E22485
     C                     EXSR CDEPOT
     C                     END                                            E15996
     C                     END
     C*
     C                     END
     C                     END
     C*
     C* IF VALUE DATE = DATE OF NEXT WORKING DAY OUTPUT TRADE ACTION
     C*    WITH SEQ NO = 11 TO PROJECT NEXT DAYS POSITION
     C*
     C***********TDVD      IFEQ DNWD                                      S01117
     C           TDVD      IFEQ BJDNWD                                    S01117
      *                                                                   E19488
      ***  Move last 67 characters of TREC1 and the first 67 of TREC2     E19488
      ***  into RECIN separately to overlay correctly.                    E19488
      *                                                                   E19488
     C***********          MOVE TREC      RECIN                    S01176 E19488
      *                                                                   E19488
     C******************** MOVE TREC2     RECIN                    E19488 S01486
     C******************** MOVELTREC1     RECIN                    E19488 S01486
     C                     MOVE TREC3     RECIN3                          S01486
     C                     MOVE TREC2     RECIN2                          S01486
     C                     MOVE TREC1     RECIN1                          S01486
     C                     SETON                     3036
     C                     SETOF                     29
     C*                                                                   E21606
     C* IF BOOK TRANSFER THEN TREAT AS AUTO-SETTLE FOR UPDATING OF        E21606
     C* I/C SETTLED NOMINAL ON POSITION FILES FOR NEXT DAYS ENQUIRIES     E21606
     C*                                                                   E21606
     C           C1DI      IFEQ 'I'                                       E21606
     C                     MOVE 'Y'       AUTS                            E21606
     C                     END                                            E21606
     C*                                                                   E21606
     C                     EXSR ACTION
     C                     SETOF                     36
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * ACCREV - PERFORM REVERSAL ACCOUNTING FOR COMPLETE TRADES      *
      *                                                               *
      *****************************************************************
      *
     C           ACCREV    BEGSR                           ** ACCREV **
     C*
     C* IF TRADE DATE ACCOUNTING DONE REVERSE TRADE ACTIONS AND
     C*    ACCOUNT KEYS
     C*
     C*                                                                   165636
     C** But not if this subr. called from TRADEA and processing          165636
     C** already done, to prevent unnecessary reversal.                   165636
     C*                                                                   165636
     C           @SUBR     IFEQ 'A'                                       165636
     C           *IN21     ANDEQ'0'                                       165636
     C           @SUBR     ORNE 'A'                                       165636
     C           *IN21     IFEQ '1'
     C           *IN23     OREQ '1'
     C                     MOVE 'Y'       RVLI
     C                     SETON                     29
     C                     SETOF                     30
     C                     EXSR ACTION
     C                     MOVE '1'       RVRS
     C                     EXSR ACKEY
     C                     END
     C*                                                                   165636
     C                     END                                            165636
     C*                                                                   165636
     C/COPY WNCPYSRC,SE2290C022
     C*
     C* IF VALUE DATE ACCOUNTING DONE REVERSE TRADE ACTIONS AND
     C*    ACCOUNT KEYS
     C*
     C*                                                                   165636
     C** But not if this subr. called from TRADEA and processing          165636
     C** already done, to prevent unnecessary reversal.                   165636
     C*                                                                   165636
     C           @SUBR     IFEQ 'A'                                       165636
     C           *IN22     ANDEQ'0'                                       165636
     C           @SUBR     ORNE 'A'                                       165636
     C           *IN22     IFEQ '1'
     C           *IN24     OREQ '1'
     C                     MOVE 'Y'       RVLI
     C                     SETON                     30
     C                     SETOF                     29
     C                     EXSR ACTION
     C                     MOVE '1'       RVRS
     C                     EXSR ACKEY
     C           C1DI      IFEQ 'I'
     C           LKRF      ANDNE*BLANKS                                                       223183
     C                     MOVE 'D'       RECI
     C                     MOVE TOED      ORED
     C                     MOVE 'Y'       SRIN
     C                     WRITEASTACDF
     C                     ADD  1         ASTCNT  50
     C                     END
     C*
     C* UPDATE CONTINGENT LIABILITIES RECORD
     C*
     C           C1DI      IFEQ 'M'
     C           TDTP      ANDEQ'TS'
     C           CNLI      ANDEQ'Y'                                       S01176
     C           TCNR      ANDNEISSR                                      E19832
     C           TDRF      CHAINCLIABDF              11
     C  N11      RECI      COMP 'D'                  1111
     C           *IN11     IFEQ '1'
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CLIAB'   DBFILE           ***************
     C                     MOVELTDRF      DBKEY            * DB ERROR 08 *
     C***********          MOVE '08'      DBASE            ***************S01117
     C                     Z-ADD8         DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C                     ELSE
     C                     MOVE '*'       RECI
     C                     UPDATCLIABDF
     C                     ADD  1         CLBDEL  50
     C                     END
     C                     END
     C                     END
     C*
     C                     END                                            165636
     C*                                                                   165636
     C                     MOVE ' '       RVLI
     C                     MOVE '0'       RVRS
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      **TELEX*-*OUTPUT*TELEX*EXTRACT**                                *   S01271
      *                                                               *
      *****************************************************************   S01271
     C***********TELEX     BEGSR                           ** TELEX **    S01271
     C********                                                            S01271
     C**IF*COUNTERPARTY*IS*A*DISCRETIONARY*CLIENT*IE*TRADE*IS*THE*RESULT* S01271
     C**OF*A*TRANSFER*NO*DETAILS*ARE*TO*BE*OUTPUT*TO*THE*TELEX*EXTRACT*** S01271
     C********                                                            S01271
     C********   C1DI      IFEQ 'I'                                       S01271
     C********             GOTO TELEXE                                    S01271
     C********             END                                            S01271
     C********                                                            S01271
     C**MOVE*INFORMATION*FROM*TRADE*RECORD*INTO*TELEX*EXTRACT***          S01271
     C********                                                            S01271
     C********             MOVE 'D'       RECI                            S01271
     C********             MOVE TDRF      TRDE                            S01271
     C********             MOVE TDBR      BCHT                            S01271
     C********   TDTP      IFEQ 'TP'                                      S01271
     C********             MOVE PYFB      BCHS                            S01271
     C********             END                                            S01271
     C********                                                            S01271
     C********   TDTP      IFEQ 'TS'                                      S01271
     C********             MOVE PYTB      BCHS                            S01271
     C********             END                                            S01271
     C********                                                            S01271
     C********   BCHS      IFEQ *ZERO                                     S01271
     C********             Z-ADDBCHT      BCHS                            S01271
     C********             END                                            S01271
     C*******                                                             S01271
     C*******              MOVE TDSS      SCSN                            S01271
     C*******              MOVE TDTP      TRAD                            S01271
     C*******              MOVE TCNR      CLNM                            S01271
     C*******              MOVE *BLANKS   TXIN                            S01271
     C*******                                                             S01271
     C*******    *IN26     IFEQ '1'                                       S01271
     C*******              MOVE 'C'       ACTO                            S01271
     C*******              ELSE                                           S01271
     C*******              MOVE '1'       ACTO                            S01158
     C*******              MOVE 'I'       ACTO                     S01158 S01271
     C*******              END                                            S01271
     C*******                                                             S01271
     C*******              ADD  1         TXCNT   50                      S01271
     C*******              WRITESETLXDF                                   S01271
     C*******                                                             S01271
     C*******    TELEXE    ENDSR                                          S01271
      *********                                                           S01271
      *****************************************************************   S01271
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * ACTION - OUTPUT TRADE ACTIONS FOR TRADE                       *
      *                                                               *
      *****************************************************************
      *
     C           ACTION    BEGSR                           ** ACTION **
     C*
     C* CALCULATE COMMISSION AND CHARGES TOTALS
     C*
     C                     Z-ADD0         CCCT                            S01169
     C                     Z-ADD0         CCTL                            S01169
     C***********TBCA      ADD  TCCA      CCTL                            E20191
     C***********TCA1      ADD  TCA2      CCCT                            E20191
     C***********          ADD  TCA3      CCCT                            E20191
     C***********          ADD  TLTA      CCCT                            S01176
     C***********          ADD  TOCA      CCCT                            S01176
     C***********          ADD  LTCA      CCCT             * LOCAL TFR    S01176
     C***********          ADD  TPCA      CCCT             * PMT CHARGE   S01176
     C***********          ADD  TVCA      CCCT             * VAT CHARGE   S01176
     C***********          ADD  TCA4      CCCT                     S01176 E20191
     C***********          ADD  TCA5      CCCT                     S01176 E20191
     C***********          ADD  TCA6      CCCT                     S01176 E20191
     C***********          ADD  TCA7      CCCT                     S01176 E20191
     C***********          ADD  TAXA      CCCT                     S01176 E20191
     C           TBCA      ADD  TCCA      CCCT                            E20191
     C           TCA1      ADD  TCA2      CCTL                            E20191
     C                     ADD  TCA3      CCTL                            E20191
     C                     ADD  TCA4      CCTL                            E20191
     C                     ADD  TCA5      CCTL                            E20191
     C                     ADD  TCA6      CCTL                            E20191
     C                     ADD  TCA7      CCTL                            E20191
     C                     ADD  TAXA      CCTL                            E20191
     C*
     C**OBTAIN*DETAILS*FROM*LATEST*SECURITY*EVENT*DIARY*RECORD*******     E22485
     C*************OTHERWISE*USE*SECURITIES*DETAILS******************     E22485
     C*
     C                     MOVE TDVD      EVDT
     C                     MOVE '  '      EVTP
     C                     Z-ADD*ZEROS    STCA                            E22485
     C                     MOVE CPDP      STCA                            E22485
     C                     Z-ADD0         SAVDT                           E22485
     C*                                                                   E22485
     C***  Defaults: The values on the Security File may have been        E22485
     C***  changed since the Start Date, so check the Security Non-Diary  E22485
     C***  Events File for each one.                                      E22485
     C*                                                                   E22485
     C                     MOVE 'CP'      EVTP                            E22485
     C           RVLI      IFNE 'Y'                                       E22485
     C           SEKEY     SETLLSNDEVDF                                   E22485
     C                     READ SNDEVDF                  19               E22485
     C                     ELSE                                           E22485
     C           SEKEY     SETLLSOBSNDF                                   E22485
     C                     READ SOBSNDF                  19               E22485
     C                     END                                            E22485
     C           *IN19     IFEQ '0'                                       E22485
     C           SNSN      ANDEQSESN                                      E22485
     C           SNET      ANDEQ'CP'                                      E22485
     C                     Z-ADDSNDT      SAVDT   50                      E22485
     C                     MOVE SNCP      STCA                            E22485
     C                     END                                            E22485
     C*                                                                   E22485
     C           PPDI      IFEQ 'Y'                                       E22485
     C                     MOVE 'PP'      EVTP                            E22485
     C           RVLI      IFNE 'Y'                                       E22485
     C           SEKEY     SETLLSEDEVDF                                   E22485
     C                     READ SEDEVDF                  19               E22485
     C                     ELSE                                           E22485
     C           SEKEY     SETLLSOBSEDF                                   E22485
     C                     READ SOBSEDF                  19               E22485
     C                     END                                            E22485
     C           *IN19     IFEQ '0'                                       E22485
     C           SDSN      ANDEQSESN                                      E22485
     C           SDET      ANDEQ'PP'                                      E22485
     C           SDDT      ANDGESAVDT                                     E22485
     C                     MOVE '1'       *IN37                           E22485
     C                     END                                            E22485
     C                     END                                            E22485
     C***********SEKEY     SETGTSEDEVDF                                   E22485
     C***********                                                         E22485
     C************IN19     DOUEQ'1'                                       E22485
     C***********          READPSEDEVDF                  19               E22485
     C***********                                                         E22485
     C************IN19     IFEQ '1'                                       E22485
     C***********SDSN      ORNE TDSS                                      E22485
     C***********          MOVE '0'       *IN37                           E22485
     C***********          MOVE '1'       *IN19                    E15439 E22485
     C***********          ELSE                                           E22485
     C***********                                                         E22485
     C***********SDET      IFEQ 'PP'                                      E22485
     C***********SDED      ANDEQTDVD                               S01176 E22485
     C***********          SETON                     3719                 E22485
     C***********          ELSE                                           E22485
     C***********                                                         E22485
     C***********SDED      IFLT TDVD                                      E22485
     C***********SDET      IFEQ 'IR'                                      E22485
     C***********SDET      OREQ 'MP'                                      E22485
     C***********SDET      OREQ 'CP'                                      E22485
     C***********          SETON                     3719                 E22485
     C***********          END                                            E22485
     C***********          END                                            E22485
     C***********                                                         E22485
     C***********          END                                            E22485
     C***********          END                                            E22485
     C***********          END                                            E22485
     C*
     C* MOVE INFO INTO TRADE ACTIONS FILE
     C*
     C                     MOVE 'D'       RECI
     C           TDTP      IFEQ 'TP'
     C                     MOVE 'P'       PRSL
     C                     MOVE DELT      OUDP
     C                     ELSE
     C                     MOVE 'S'       PRSL
     C                     MOVE DELF      OUDP
     C                     END
     C*
     C   36                MOVE 11        ACTS
     C  N36                MOVE 10        ACTS
     C************         MOVE TPDY      TRPR                            E15222
     C************         MOVE PRIC      TRPR                     E15222 E20235
     C******************** MOVE TPDY      TRPR                     E20235 S01486
     C                     MOVE PRIC      TRPR                            S01486
     C                     MOVE TSUB      TDTS
     C*
      *                                                                                       253841
     C           *IN36     IFEQ '1'                                                           253841
     C           SRECI     ANDNE'D'                                                           253841
      *                                                                                       253841
      ** Do not generate trade action for a matured security.                                 253841
      *                                                                                       253841
     C                     ELSE                                                               253841
     C* Trade Date Processing
     C*
     C           *IN29     IFEQ '1'
     C                     MOVE 'T'       TVDA
     C                     MOVE TDDT      EVTD
     C                     MOVE TDVD      OTRD
     C                     ADD  1         TACNT   50
     C                     END
     C*
     C* Value Date Processing
     C*
     C           *IN30     IFEQ '1'
     C                     MOVE 'V'       TVDA
     C                     MOVE TDVD      EVTD
     C                     MOVE TDDT      OTRD
     C                     ADD  1         VACNT   50
     C                     END
     C*
     C                     MOVE EOPM      PEMD    50
     C           RVLI      IFEQ 'Y'
     C           TOED      ANDLEPEMD
     C           EVTD      ANDLEPEMD                                      E37180
     C                     MOVE 'Y'       RMIP
     C                     ELSE
     C                     MOVE ' '       RMIP
     C                     END
     C*                                                                   S01486
     C**  If Portfolio Management is present                              S01486
     C*                                                                   S01486
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01486
     C**  Calculate the trade value in settlement currency                S01486
     C*                                                                   S01486
     C           TVSN      ADD  TVSP      CTVLSC 150                      S01486
     C                     ADD  TOSV      CTVLSC                          S01486
     C*                                                                   S01486
     C**  Calculate the exchange rate from nominal to settlement ccy      S01486
     C*                                                                   S01486
     C           TCTR      IFNE *ZERO                                     S01486
     C           CTVLSC    DIV  TCTR      ERNSC  158H                     S01486
     C                     ELSE                                           S01486
     C                     Z-ADD*ZERO     ERNSC                           S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** Convert purchased int, charges & commissions to settlement ccy   S01486
     C*                                                                   S01486
     C           ITRA      MULT ERNSC     ITRASC 150H                     S01486
     C           CCTL      MULT ERNSC     CCTLSC 150H                     S01486
     C           CCCT      MULT ERNSC     CCCTSC 150H                     S01486
     C*                                                                   S01486
     C**  Subtract purchased int, charges & commissions (if reqd) from    S01486
     C**  total value to get customer trade value in settlement ccy       S01486
     C*                                                                   S01486
     C           CTVLSC    SUB  ITRASC    SETAM                           S01486
     C           BVCCAP    IFNE 'Y'                                       S01486
     C                     SUB  CCTLSC    SETAM                           S01486
     C                     END                                            S01486
     C           BVCMCP    IFNE 'Y'                                       S01486
     C                     SUB  CCCTSC    SETAM                           S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C**  If reallowance is not to be included in average price           S01486
     C**  calculate amount and add to average price                       S01486
     C*                                                                   S01486
     C           BVRCAP    IFNE 'Y'                        B1             S01486
     C           RALL      ANDNE0                                         S01486
     C*                                                                   S01486
     C**  Format reallowance amount                                       S01486
     C                     Z-ADDRALL      WDRAL1                          S01486
     C**    If discount...                                                S01486
     C*                                                                   S01486
     C           STBS      IFEQ 'D'                        B2             S01486
     C                     Z-ADDTDVD      ZSDATE                          S01486
     C                     Z-ADDMATY      ZEDATE                          S01486
     C                     MOVE 'N'       DADJN                           100017
     C                     EXSR ZDAYS                                     S01486
     C                     MOVE ' '       DADJN                           100017
     C                     Z-ADDZDDAYS    #DDAYS  50                      S01486
     C                     EXSR ZDYYR                                     S01486
     C           ZINTDD    IFNE 0                          B3             S01486
     C           RALL      MULT #DDAYS    WPRICE 158                      S01486
     C           WPRICE    DIV  ZINTDD    WDRALL  95H                     S01486
     C*                                                                   S01486
     C           WDRALL    IFGE 0                          B4             S01486
     C           1         SUB  WDRALL    WDRAL1 158                      S01486
     C                     ELSE                            X4             S01486
     C                     Z-SUBWDRALL    WDRALL                          S01486
     C           1         SUB  WDRALL    WDRAL1                          S01486
     C                     Z-SUBWDRAL1    WDRAL1                          S01486
     C                     END                             E4             S01486
     C*                                                                   S01486
     C                     ELSE                            X3             S01486
     C                     Z-ADD*ZEROS    WDRAL1                          S01486
     C                     END                             E3             S01486
     C                     END                             E2             S01486
     C*                                                                   S01486
     C                     Z-ADD*ZEROS    ZRALL  150                      S01486
     C*                                                                   S01486
     C**  Percentage priced: Reallowance = reallowance % X nominal        S01486
     C           SPBS      IFEQ 'P'                        B2             S01486
     C                     Z-ADD*ZEROS    ZRALL0 150                      S01486
     C                     Z-ADD*ZEROS    ZRALL1 151                      S01486
     C                     Z-ADD*ZEROS    ZRALL2 152                      S01486
     C                     Z-ADD*ZEROS    ZRALL3 153                      S01486
     C                     MOVEA'0000'    *IN,42                          S01486
     C           42        ADD  A6NBDP    J       20                      S01486
     C                     MOVEA'1'       *IN,J                           S01486
     C*                                                                   S01486
     C**  Calculate consideration/reallowance/charges/commission          S01486
     C*                                                                   S01486
     C   42      NOML      MULT WDRAL1    ZRALL0    H                     S01486
     C   43      NOML      MULT WDRAL1    ZRALL1    H                     S01486
     C   44      NOML      MULT WDRAL1    ZRALL2    H                     S01486
     C   45      NOML      MULT WDRAL1    ZRALL3    H                     S01486
     C*                                                                   S01486
     C   42                DIV  100       ZRALL0                          S01486
     C   43                DIV  100       ZRALL1                          S01486
     C   44                DIV  100       ZRALL2                          S01486
     C   45                DIV  100       ZRALL3                          S01486
     C*                                                                   S01486
     C   42                MOVE ZRALL0    ZRALL                           S01486
     C   43                MOVE ZRALL1    ZRALL                           S01486
     C   44                MOVE ZRALL2    ZRALL                           S01486
     C   45                MOVE ZRALL3    ZRALL                           S01486
     C*                                                                   S01486
     C**  Allow for nominal decimal places                                S01486
     C*                                                                   S01486
     C           5         SUB  NMDP      DC      10                      S01486
     C           ZRALL     MULT POWER8,DC ZRALL                           S01486
      *                                                                   S01486
     C           ZRALL     MULT POWER8,DC ZRALL                           S01486
     C*                                                                   S01486
     C**  Unit priced: Reallowance = reallowance % X consideration        S01486
     C                     ELSE                            X2             S01486
     C           TCSR      MULT WDRAL1    ZRALL     H                     S01486
     C           ZRALL     DIV  100       ZRALL     H                     S01486
     C                     END                             E2             S01486
     C*                                                                   S01486
     C                     SUB  ZRALL     SETAM                           S01486
     C                     END                             E1             S01486
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVE SETC      SETCY                           S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C**  End of Portfolio Management present                             S01486
     C                     END                                            S01486
     C*
     C* CALCULATE CONTRACT PRICE USING ZCONPR
     C*
      * Access the Nom. Dec. Places for use in  SR - ZCONPR
      *
     C                     Z-ADDSET       #SET   130
     C                     EXSR NOMDEC
     C***********          Z-ADDCDP       ZCDP                            S01117
     C                     Z-ADDA6NBDP    ZCDP                            S01117
     C                     Z-ADD#SET      SET
      *
     C                     EXSR ZCONPR
     C                     MOVE ZCONP     CNTP
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADD0         PRICX                                               CAS006
     C                     Z-ADD0         TCSRX                                               CAS006
     C                     Z-ADD0         ZCONSX 150                                          CAS006
      *                                                                                       CAS006
     C                     Z-ADDPRIC      ZPRC   169                                          CAS006
     C                     Z-ADDNOML      ZNOMLX 150                                          CAS006
     C                     CALL 'ZCNSD'                                                       CAS006
     C                     PARM           ZNOMLX                                              CAS006
     C                     PARM           ZPRC                                                CAS006
     C                     PARM           SPBS                                                CAS006
     C                     PARM           NMDP                                                CAS006
     C                     PARM           ZCDP                                                CAS006
     C                     PARM           ZCONSX                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADDTCSR      TCSRX  150                                          CAS006
     C                     Z-ADDZCONSX    TCSR                                                CAS006
      *                                                                                       CAS006
     C                     Z-ADDPRIC      PRICX  158                                          CAS006
     C                     Z-ADDPRICN     PRIC                                                CAS006
     C                     EXSR ZCONPR                                                        CAS006
     C                     Z-ADDPRICX     PRIC                                                CAS006
     C                     Z-ADDTCSRX     TCSR                                                CAS006
     C                     MOVE ZCONP     CNTN                                                CAS006
      *                                                                                       CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C********** CGL031    IFEQ 'Y'                                                    CGL031 234440
     C********** TDTP      ANDEQ'TS'                                                   CGL031 233566
     C**********           Z-ADDFSPP      TFPR                                         CGL031 234440
     C                     Z-ADD0         TFPR                                                234440
     C**********           ENDIF                                                       CGL031 234440
      *                                                                                       CGL031
     C                     MOVE TCSR      CNSD
     C                     MOVE TINA      INAJ
     C                     MOVE ITRA      PCHI
     C***********          MOVE ACIN      ACRI                            E15549
     C           PROT      IFEQ '4'                                       E21303
     C                     MOVE EXDV      ACRI                            E21303
     C                     ELSE                                           E21303
     C                     MOVE ACIN      ACRI                            E21303
     C                     END                                            E21303
     C                     MOVE TCNR      TRCP
     C                     MOVE TCFC      SDCP                            E22485
     C                     MOVE TDCR      CPNR                            E22485
     C***********          MOVE CPDP      STCA                     E22485 E22485
     C*
     C           C1DI      IFEQ 'D'
     C           C1DI      OREQ 'S'
     C                     MOVE 'Y'       PTFI
     C*
     C           TDTP      IFEQ 'TP'
     C                     MOVE DELF      PTCD
     C                     ELSE
     C*
     C           TDTP      IFEQ 'TS'
     C                     MOVE DELT      PTCD
     C                     ELSE
     C                     MOVE *BLANKS   PTCD
     C                     END
     C*
     C                     END
     C*
     C                     ELSE
     C                     MOVE ' '       PTFI
     C                     MOVE *BLANKS   PTCD
     C                     END
     C*
     C           *IN37     IFEQ '1'
     C           PROT      IFEQ '4'                                       E22485
     C                     MOVE SDTA      STCA                            E22485
     C                     ELSE                                           E22485
     C                     Z-ADD*ZEROS    STCA                            E22485
     C                     MOVE SDTP      STCA                            E22485
     C                     END                                            E22485
     C                     MOVE '0'       *IN37                           E22485
     C                     END                                            E22485
     C*                                                                   E22485
     C************IN37     IFEQ '1'                                       E22485
     C***********          MOVE SDNC      CPNR                            E22485
     C***********          MOVE TTCFC     SDCP                            E22485
     C***********                                                         E22485
     C***********PROT      IFEQ '4'                                       E22485
     C***********          MOVE EXDV      ACRI                     E15549 E22485
     C***********          MOVE SDTA      STCA                            E22485
     C***********          ELSE                                           E22485
     C***********          MOVE ACIN      ACRI                     E15549 E22485
     C***********          MOVE SDTP      STCA                            E22485
     C***********          END                                            E22485
     C***********          ELSE                                           E22485
     C***********          MOVE CPNR      CPNR                            E22485
     C***********          MOVE TTCFC     SDCP                            E22485
     C***********          MOVE CPDP      STCA                            E22485
     C***********          END                                            E22485
     C*
     C           ACTS      IFEQ '11'                                      S01269
     C***********          Z-ADDDNWD      EVTD                     S01269 S01117
     C                     Z-ADDBJDNWD    EVTD                            S01117
     C                     END                                            S01269
     C*                                                                   080259
     C* Move Portfolio Reference before output                            080259
     C           BGPFMG    IFEQ 'Y'                                       080259
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVE XPTFR     PTFR                            080259
     C                     END                                            080259
     C*                                                                   080259
     C                     MOVE XCOAF     COAF                            CSE007
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDLQPR      LQPP                                                CAS006
     C                     Z-ADDCRSK      CRKP                                                CAS006
     C                     Z-ADDTINN      INAN                                                CAS006
     C                     Z-ADDITRN      PCHN                                                CAS006
     C                     ENDIF                                                              CAS006
     C*                                                                   CSE007
     C/COPY WNCPYSRC,SE2290C050
     C                     WRITETRDACDF
     C*                                                                   E21606
     C*
     C* IF BOOK TRANSFER WITH VALUE DATE OF DNWD THEN RESET AUTO-SETTLE   E21606
     C* INDICATOR                                                         E21606
     C                     ENDIF                                                              253841
      *                                                                                       253841
     C*                                                                   E21606
     C           C1DI      IFEQ 'I'                                       E21606
     C***********TDVD      ANDEQDNWD                               E21606 S01117
     C           TDVD      ANDEQBJDNWD                                    S01117
     C                     MOVE 'N'       AUTS                            E21606
     C                     END                                            E21606
     C*                                                                   E21606
     C*                                                                   S01269
     C                     SETOF                     36                   S01269
     C*                                                                   S01269
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * ACKEY - OUTPUT GENERATED ACCOUNT KEYS FOR TRADE               *
      *                                                               *
      *****************************************************************
      *
     C           ACKEY     BEGSR                           ** ACKEY **
     C*
     C* IF IND 25 IS ON CALCULATE COUNTERVALUE KEY ONLY
     C*
     C/COPY WNCPYSRC,SE2290C023
     C   25                GOTO CVALUE
     C*
     C* RETRIEVE INVESTMENT TYPE RECORD - IF NOT THERE DATABASE ERROR     S01169
     C*                                                                   S01169
     C                     MOVE TNMC      NMCY                            S01169
     C*                                                                   S01169
     C           ITKEY     CHAININVTPDF              18                   S01169
     C  N18      RECI      COMP 'D'                  1818                 S01169
     C           *IN18     IFEQ '1'                                       S01169
     C                     SETON                     U7U8LR               S01169
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'INVTP'   DBFILE           ***************S01169
     C                     MOVELTNMC      KEY6    6        * DB ERROR 12 *S01169
     C                     MOVE SITP      KEY6             ***************S01169
     C                     MOVELKEY6      DBKEY                           S01169
     C***********          MOVE '12'      DBASE                    S01169 S01117
     C                     Z-ADD12        DBASE                    S01169 S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND                                      S01169
     C                     END                                            S01169
     C*
     C* CHECK IF KEYS ARE TO BE SUPPRESSED
     C*
     C***********SKTD      COMP 'T'                      33               S01117
     C***********SKTD      COMP 'V'                      34               S01117
     C           BVSKTV    COMP 'T'                      33               S01117
     C           BVSKTV    COMP 'V'                      34               S01117
     C                     Z-ADDNOML      SET    130
     C                     EXSR NOMDEC
     C*
     C           *INU7     IFEQ '1'
     C                     GOTO MEND
     C                     END
     C*
     C**CALCULATE*FACE*VALUE**                                            E22485
     C***********                                                         E22485
     C***********          Z-ADDSET       FVAL                            E22485
     C***********PPDI      IFEQ 'Y'                                       E22485
     C***********          MOVE TDVD      EVDT                            E22485
     C***********          MOVE 'PP'      EVTP                            E22485
     C***********SEKEY     SETGTSEDEVDF                                   E22485
     C***********          READPSEDEVDF                  19               E22485
     C**N19******RECI      COMP 'D'                  1919                 E22485
     C***********                                                         E22485
     C**IF*SECURITY*DIARY*RECORD*NOT*FOUND*-*USE*CALL*%*FROM*SECURITY*FILEE22485
     C***********                                                         E22485
     C************IN19     IFEQ '0'                                       E22485
     C***********SDSN      ANDEQTDSS                                      E22485
     C***********SDET      ANDEQ'PP'                                      E22485
     C***********SET       MULT SDTP      FVAL   130H                     E22485
     C***********          ELSE                                           E22485
     C***********          MOVE CPDP      CPDP3   63                      E22485
     C***********SET       MULT CPDP3     FVAL      H                     E22485
     C***********          END                                            E22485
     C***********                                                         E22485
     C***********          END                                            E22485
     C***********                                                         E22485
     C***********PROT      IFEQ '8'                                       E22485
     C***********          MOVE SDCP      EVDT                            E22485
     C***********          MOVE 'MP'      EVTP                            E22485
     C***********SEKEY     SETGTSEDEVDF                                   E22485
     C***********          READPSEDEVDF                  19               E22485
     C**N19******RECI      COMP 'D'                  1919                 E22485
     C***********                                                         E22485
     C**IF*SECURITY DIARY RECORD NOT FOUND - USE FACTOR ROM SECURITY FILE E22485
     C***********                                                         E22485
     C************IN19     IFEQ '0'                                       E22485
     C***********SDSN      ANDEQTDSS                                      E22485
     C***********SDET      ANDEQ'MP'                                      E22485
     C***********SET       MULT SDCP      FVAL      H                     E22485
     C***********          ELSE                                           E22485
     C***********SET       MULT CFCT      FVAL      H                     E22485
     C***********          END                                            E22485
     C***********                                                         E22485
     C*
     C* REALLOWANCE KEYS
     C*
     C           *IN29     IFEQ '1'
     C           *IN33     ANDNE'1'
     C           *IN30     OREQ '1'
     C           *IN34     ANDNE'1'
     C*
     C* SET AMOUNT CODE DEPENDING ON REALLOWANCE VALUE AND
     C*     TRADE TYPE
     C*
     C           RALL      IFNE 0
     C*
     C           TDTP      IFEQ 'TP'
     C*
     C           RALL      IFLT 0
     C                     MOVE 'RR'      AMTC
     C                     ELSE
     C                     MOVE 'RE'      AMTC
     C                     END
     C*
     C                     ELSE
     C*
     C           RALL      IFLT 0
     C                     MOVE 'RE'      AMTC
     C                     ELSE
     C                     MOVE 'RR'      AMTC
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
      * FORMAT REALLOWANCE AMOUNT
     C*
     C                     Z-ADDRALL      WDRAL1
     C*
     C*     IF DISCOUNT ..
     C*
     C           STBS      IFEQ 'D'
     C           RALL      ANDNE0
     C                     Z-ADDTDVD      ZSDATE
     C                     Z-ADDMATY      ZEDATE
     C                     MOVE 'N'       DADJN                           100017
     C                     EXSR ZDAYS
     C                     MOVE ' '       DADJN                           100017
     C                     Z-ADDZDDAYS    #DDAYS  50
     C                     EXSR ZDYYR
     C           ZINTDD    IFNE 0
     C           RALL      MULT #DDAYS    WPRICE 158
     C           WPRICE    DIV  ZINTDD    WDRALL  95H
     C*
     C           WDRALL    IFGE 0
     C           1         SUB  WDRALL    WDRAL1 158
     C                     ELSE
     C                     Z-SUBWDRALL    WDRALL
     C           1         SUB  WDRALL    WDRAL1
     C                     Z-SUBWDRAL1    WDRAL1
     C                     END
     C*
     C                     ELSE
     C                     Z-ADD*ZEROS    WDRAL1
     C                     END
     C                     END
     C*
     C                     Z-ADD*ZEROS    ZRALL  150
     C                     Z-ADD*ZEROS    ZRALL0 150
     C                     Z-ADD*ZEROS    ZRALL1 151
     C                     Z-ADD*ZEROS    ZRALL2 152
     C                     Z-ADD*ZEROS    ZRALL3 153
     C                     MOVEA'0000'    *IN,42
     C***********42        ADD  CDP       J       20                      S01117
     C           42        ADD  A6NBDP    J       20                      S01117
     C                     MOVEA'1'       *IN,J
     C*
     C*  Calculate consideration/reallowance/charges/commission
     C*
     C   42      NOML      MULT WDRAL1    ZRALL0    H
     C   43      NOML      MULT WDRAL1    ZRALL1    H
     C   44      NOML      MULT WDRAL1    ZRALL2    H
     C   45      NOML      MULT WDRAL1    ZRALL3    H
     C*
     C* Price basis - divide by 100
     C*
     C           SPBS      IFEQ 'P'
     C   42                DIV  100       ZRALL0
     C   43                DIV  100       ZRALL1
     C   44                DIV  100       ZRALL2
     C   45                DIV  100       ZRALL3
     C                     END
     C*
     C   42                MOVE ZRALL0    ZRALL
     C   43                MOVE ZRALL1    ZRALL
     C   44                MOVE ZRALL2    ZRALL
     C   45                MOVE ZRALL3    ZRALL
     C*
     C*   Allow for nominal decimal places
     C*
     C           5         SUB  NMDP      DC      10
     C           ZRALL     MULT POWER8,DC ZRALL
     C*
     C                     MOVE TNMC      EVCY
     C           ZRALL     IFLT 0
     C                     Z-SUBZRALL     EVAM
     C                     ELSE
     C                     Z-ADDZRALL     EVAM
     C                     END
     C*
     C* WRITE RECORD OUT ONLY IF NE 0
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2290C045
     C                     END
     C*
     C                     END
     C*
     C* CHARGES AND COMMISSION KEYS
     C*
     C* MOVE CODES AND AMOUNTS INTO THE CODE AND AMT ARRAYS
     C*
     C           *IN29     IFEQ '1'
     C           *IN33     ANDNE'1'
     C           *IN30     OREQ '1'
     C           *IN34     ANDNE'1'
     C***********          MOVE TBCC      CCDE,1                          S01169
     C***********          MOVE TBCA      CAMT,1                          S01169
     C***********          MOVE TCCC      CCDE,2                          S01169
     C***********          MOVE TCCA      CAMT,2                          S01169
     C***********          MOVE TCC1      CCDE,3                          S01169
     C***********          MOVE TCA1      CAMT,3                          S01169
     C***********          MOVE TCC2      CCDE,4                          S01169
     C***********          MOVE TCA2      CAMT,4                          S01169
     C***********          MOVE TCC3      CCDE,5                          S01169
     C***********          MOVE TCA3      CAMT,5                          S01169
     C***********          MOVE TLTC      CCDE,6                          S01169
     C***********          MOVE TLTA      CAMT,6                          S01169
     C***********          MOVE TOCC      CCDE,7                          S01169
     C***********          MOVE TOCA      CAMT,7                          S01169
     C                     MOVE TBCC      XCD,1                           S01169
     C                     MOVE TBCA      XAM,1                           S01169
     C                     MOVE TCCC      XCD,2                           S01169
     C                     MOVE TCCA      XAM,2                           S01169
     C                     MOVE TCC1      XCD,3                           S01169
     C                     MOVE TCA1      XAM,3                           S01169
     C                     MOVE TCC2      XCD,4                           S01169
     C                     MOVE TCA2      XAM,4                           S01169
     C                     MOVE TCC3      XCD,5                           S01169
     C                     MOVE TCA3      XAM,5                           S01169
     C***********          MOVE TLTC      XCD,6                    S01169 S01176
     C***********          MOVE TLTA      XAM,6                    S01169 S01176
     C***********          MOVE TOCC      XCD,7                    S01169 S01176
     C***********          MOVE TOCA      XAM,7                    S01169 S01176
     C***********          MOVE TTCC      XCD,8                    S01169 S01176
     C***********          MOVE LTCA      XAM,8                    S01169 S01176
     C***********          MOVE TPCC      XCD,9                    S01169 S01176
     C***********          MOVE TPCA      XAM,9                    S01169 S01176
     C***********          MOVE TVCC      XCD,10                   S01169 S01176
     C***********          MOVE TVCA      XAM,10                   S01169 S01176
     C                     MOVE TCC4      XCD,6                           S01176
     C                     MOVE TCA4      XAM,6                           S01176
     C                     MOVE TCC5      XCD,7                           S01176
     C                     MOVE TCA5      XAM,7                           S01176
     C                     MOVE TCC6      XCD,8                           S01176
     C                     MOVE TCA6      XAM,8                           S01176
     C                     MOVE TCC7      XCD,9                           S01176
     C                     MOVE TCA7      XAM,9                           S01176
     C                     MOVE TAXC      XCD,10                          S01176
     C                     MOVE TAXA      XAM,10                          S01176
     C/COPY WNCPYSRC,SE2290C080
     C*                                                            S01169 E20602
     C**REVERSE*THE*SIGN*OF*CHARGE/COMMISSION*VALUES*FOR*A*TRADE** S01176 E20602
     C**PURCHASE*FOR*MARKET*OR*PORTFOLIO*CUSTOMERS**************** S01176 E20602
     C***********                                                  S01176 E20602
     C***********C1DI      IFEQ 'M'                                S01176 E20602
     C***********TDTP      ANDEQ'TP'                               S01176 E20602
     C***********C1DI      OREQ 'S'                                S01176 E20602
     C***********TDTP      ANDEQ'TP'                               S01176 E20602
     C***********C1DI      OREQ 'D'                                S01176 E20602
     C***********TDTP      ANDEQ'TP'                               S01176 E20602
     C***********                                                  S01176 E20602
     C***********          Z-SUBTBCA      XAM,1                    S01176 E20602
     C***********          Z-SUBTCCA      XAM,2                    S01176 E20602
     C***********          Z-SUBTCA1      XAM,3                    S01176 E20602
     C***********          Z-SUBTCA2      XAM,4                    S01176 E20602
     C***********          Z-SUBTCA3      XAM,5                    S01176 E20602
     C***********          Z-SUBTCA4      XAM,6                    S01176 E20602
     C***********          Z-SUBTCA5      XAM,7                    S01176 E20602
     C***********          Z-SUBTCA6      XAM,8                    S01176 E20602
     C***********          Z-SUBTCA7      XAM,9                    S01176 E20602
     C***********          Z-SUBTAXA      XAM,10                   S01176 E20602
     C***********                                                  S01176 E20602
     C***********          END                                     S01176 E20602
     C*                                                                   S01169
     C* DETERMINE AMOUNT CODE FOR EACH AMOUNT DEPENDING ON                S01169
     C* DISCRETIONARY IND AND SIGN OF CHARGES/COMMISSION AMOUNT
     C*
     C***********          DO   7         I       10                      S01169
     C                     DO   10        I       20                      S01169
     C*
     C***********CCDE,I    IFNE '  '                                      S01169
     C           XCD,I     IFNE '  '                                      S01169
     C           I         COMP 3                      38
     C*
     C           I         IFGE 8                                         S01169
     C                     SETOF                     38                   S01169
     C                     END                                            S01169
     C***********                                                         S01169
     C**Reverse*sign*for*Sale*to*market*client*or*purchase*from*portfolio S01176
     C**customer*for*charges/commissions*values************************   S01176
     C***********                                                         S01176
     C***********C1DI      IFEQ 'M'                                S01158 S01176
     C***********TDTP      ANDEQ'TS'                               S01158 S01176
     C***********C1DI      OREQ 'I'                                S01158 S01176
     C***********TDTP      ANDEQ'TS'                               S01158 S01176
     C***********C1DI      OREQ 'D'                                S01158 S01176
     C***********TDTP      ANDEQ'TP'                               S01158 S01176
     C***********C1DI      OREQ 'S'                                S01158 S01176
     C***********TDTP      ANDEQ'TP'                               S01158 S01176
     C***********          Z-SUBTBCA      CAMT,1                   S01158 S01176
     C***********          Z-SUBTCCA      CAMT,2                   S01158 S01176
     C***********          Z-SUBTCA1      CAMT,3                   S01158 S01176
     C***********          Z-SUBTCA2      CAMT,4                   S01158 S01176
     C***********          Z-SUBTCA3      CAMT,5                   S01158 S01176
     C***********          Z-SUBTLTA      CAMT,6                   S01158 S01176
     C***********          Z-SUBTOCA      CAMT,7                   S01158 S01176
     C***********          Z-SUBTBCA      XAM,1                    S01158 S01176
     C***********          Z-SUBTCCA      XAM,2                    S01158 S01176
     C***********          Z-SUBTCA1      XAM,3                    S01158 S01176
     C***********          Z-SUBTCA2      XAM,4                    S01158 S01176
     C***********          Z-SUBTCA3      XAM,5                    S01158 S01176
     C***********          Z-SUBTLTA      XAM,6                    S01158 S01176
     C***********          Z-SUBTOCA      XAM,7                    S01158 S01176
     C***********          Z-SUBLTCA      XAM,8                    S01169 S01176
     C***********          Z-SUBTPCA      XAM,9                    S01169 S01176
     C***********          Z-SUBTVCA      XAM,10                   S01169 S01176
     C***********          END                                     S01158 S01176
     C***********                                                  S01158 S01176
     C***********C1DI      IFEQ 'M'                                       S01176
     C***********C1DI      OREQ 'I'                                       S01176
     C***********                                                         S01176
     C***********CAMT,I    IFGT 0                                  S01169 S01176
     C***********XAM,I     IFGT 0                                  S01169 S01176
     C***38******          MOVE 'CP'      AMTC                            S01176
     C**N38******          MOVE 'FP'      AMTC                            S01176
     C***********          ELSE                                           S01176
     C***38******          MOVE 'CR'      AMTC                            S01176
     C**N38******          MOVE 'FR'      AMTC                            S01176
     C***********          END                                            S01176
     C***********                                                         S01176
     C***********          ELSE                                           S01176
     C***********CAMT,I    IFGT 0                                  S01169 S01176
     C***********XAM,I     IFGT 0                   *S5436         S01169 S01176
     C***38******          MOVE 'CR'      AMTC                            S01176
     C**N38******          MOVE 'FR'      AMTC                            S01176
     C***********          ELSE                                           S01176
     C***38******          MOVE 'CP'      AMTC                            S01176
     C**N38******          MOVE 'FP'      AMTC                            S01176
     C***********          END                                            S01176
     C***********                                                         S01176
     C***********          END                                            S01176
     C*                                                                   S01176
     C***********XAM,I     IFGT 0                                  S01176 E20602
     C*                                                                   E20602
     C* DETERMINE AMOUNT CODE ACCORDING TO TYPE OF TRADE AND SIGN OF      E20602
     C* CHARGE/COMMISSION AS READ FROM TRADSD FILE.                       E20602
     C*                                                                   E20602
     C           TDTP      IFEQ 'TP'                                      E20602
     C           XAM,I     ANDLT0                                         E20602
     C           TDTP      OREQ 'TS'                                      E20602
     C           XAM,I     ANDGT0                                         E20602
     C   38                MOVE 'CR'      AMTC                            S01176
     C  N38                MOVE 'FR'      AMTC                            S01176
     C                     ELSE                                           S01176
     C   38                MOVE 'CP'      AMTC                            S01176
     C  N38                MOVE 'FP'      AMTC                            S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C*
     C/COPY WNCPYSRC,SE2290C024
     C                     MOVE TNMC      EVCY
     C/COPY WNCPYSRC,SE2290C025
     C***********CAMT,I    IFLT 0                                         S01169
     C***********          Z-SUBCAMT,I    EVAM                            S01169
     C***********XAM,I     IFLT 0                                   S01169E16800
     C***********          Z-SUBXAM,I     EVAM                      S01169E16800
     C***********          ELSE                                           E16800
     C***********          Z-ADDCAMT,I    EVAM                            S01169
     C***********          Z-ADDXAM,I     EVAM                     S01169 E20602
     C***********          END                                            E16800
     C*
     C***********          MOVE CCDE,I    CCCD                            S01169
     C                     MOVE XCD,I     CCCD                            S01169
     C/COPY WNCPYSRC,SE2290C026
      *                                                                   S01446
      ** If Autocharges is switched on and S01446 is on then              S01446
      *  Or Analytical Accounting is installed,                           CAC002
      *                                                                   S01446
     C           BVACOP    IFEQ 'Y'                        B1             S01446
     C           S01446    ANDEQ'Y'                                       S01446
     C           BGN0ST    OREQ 'Y'                                       CAC002
      *                                                                   S01446
      ** Access Charges Codes file                                        S01446
      *                                                                   S01446
     C                     CALL 'AOCHGTR0'                                S01446
     C                     PARM '*MSG   ' @RTCD   7                       S01446
     C                     PARM '*KEY   ' @OPTN   7                       S01446
     C                     PARM SNMCY     @CCY    3                       S01446
     C                     PARM CCCD      @CHGC   2                       S01446
     C           @SECGT    PARM @SECGT    DSSDY                           S01446
     C*                                                                   S01446
     C           @RTCD     IFNE *BLANKS                    B*2            S01446
     C                     MOVE '1'       *INU7                           S01446
     C                     MOVE '1'       *INU8                           S01446
     C           *LOCK     IN   LDA                                       S01446
     C                     MOVEL'SECGT   'DBFILE            **************S01446
     C                     MOVELSNMCY     DBKEY             * DB ERROR 31*S01446
     C                     MOVE CCCD      DBKEY             **************S01446
     C                     MOVE @OPTN     DBOPTN                          S01446
     C                     Z-ADD31        DBASE                           S01446
     C                     OUT  LDA                                       S01446
     C                     DUMP                                           S01446
     C                     GOTO MEND                                      S01446
     C                     ELSE                            X*2            S01446
      *                                                                   CAC002
     C           BVACOP    IFEQ 'Y'                                       CAC002
     C           S01446    ANDEQ'Y'                                       CAC002
     C                     MOVE GCCO      CCCD                            S01446
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
      ** If Analytical Accounting is installed, define a Profit Centre.   CAC002
      *                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
      *                                                                   CAC002
     C           BVACOP    IFEQ 'Y'                                       CAC002
     C           S01446    ANDEQ'Y'                                       CAC002
      *                                                                   CAC002
      ** Access charges codes file for Group charge code.                 CAC002
      *                                                                   CAC002
     C                     CALL 'AOCHGTR0'                                CAC002
     C                     PARM '*MSG   ' @RTCD                           CAC002
     C                     PARM '*KEY   ' @OPTN                           CAC002
     C                     PARM SNMCY     @CCY                            CAC002
     C                     PARM CCCD      @CHGC                           CAC002
     C           @SECGT    PARM @SECGT    DSSDY                           CAC002
     C*                                                                   CAC002
     C           @RTCD     IFNE *BLANKS                                   CAC002
     C                     MOVE '1'       *INU7                           CAC002
     C                     MOVE '1'       *INU8                           CAC002
     C           *LOCK     IN   LDA                                       CAC002
     C                     MOVEL'SECGT   'DBFILE           ************   CAC002
     C                     MOVELSNMCY     DBKEY            * DBERR 33 *   CAC002
     C                     MOVE CCCD      DBKEY            ************   CAC002
     C                     MOVE @OPTN     DBOPTN                          CAC002
     C                     Z-ADD33        DBASE                           CAC002
     C                     OUT  LDA                                       CAC002
     C                     DUMP                                           CAC002
     C                     GOTO MEND                                      CAC002
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
     C           BOTR      IFEQ ' '                                       CAC002
     C                     MOVE XPRFC     WWPRFC  4                       CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C           BOTR      IFEQ 'T'                                       CAC002
     C                     MOVE TPRC      WWPRFC                          CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C           BOTR      IFEQ 'B'                                       CAC002
     C                     MOVE BPRC      WWPRFC                          CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
     C                     END                             E*2            S01446
     C                     END                             E1             S01446
     C*                                                                   S01446
     C                     Z-ADDXAM,I     EVAM                            E21273
     C*
     C* IF CHARGES/COMMISSIONS AS READ FROM TRADSD FILE ARE NEGATIVE      E20602
     C* THEN REVERSE THE SIGN, SO AS TO PRODUCE A POSITIVE EVENT AMOUNT   E20602
     C* FOR THE CHARGES/COMMISSIONS ACCOUNT KEY.                          E20602
     C*                                                                   E20602
     C           XAM,I     IFLT 0                                         E20602
     C                     Z-SUBXAM,I     EVAM                            E20602
     C                     END                                            E20602
     C/COPY WNCPYSRC,SE2290C039
     C*
     C* WRITE RECORD OUT ONLY IF NE 0
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C/COPY WNCPYSRC,SE2290C040
     C                     END
     C*
     C                     END
     C                     END
     C                     END
     C/COPY WNCPYSRC,SE2290C041
     C*                                                                   S01176
     C* REBATE KEYS                                                       S01176
     C*                                                                   S01176
     C* DETERMINE IF KEYS ARE BEING SUPPRESSED                            S01176
     C*                                                                   S01176
     C           *IN29     IFEQ '1'                                       S01176
     C           *IN33     ANDNE'1'                                       S01176
     C           *IN30     OREQ '1'                                       S01176
     C           *IN34     ANDNE'1'                                       S01176
     C*                                                                   S01176
     C* Reverse sign of the rebate amounts for a trade purchase           S01176
     C* with a market or portfolio customer                               S01176
     C*                                                                   S01176
     C           C1DI      IFEQ 'M'                                       S01176
     C           TDTP      ANDEQ'TP'                                      S01176
     C           C1DI      OREQ 'D'                                       S01176
     C           TDTP      ANDEQ'TP'                                      S01176
     C           C1DI      OREQ 'S'                                       S01176
     C           TDTP      ANDEQ'TP'                                      S01176
     C*                                                                   S01176
     C           BCMR      MULT -1        BCMR                            S01176
     C           CCMR      MULT -1        CCMR                            S01176
     C           TXRB      MULT -1        TXRB                            S01176
     C*                                                                   S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C                     MOVE TBCC      RCD,1                           S01176
     C                     MOVE BCMR      RAM,1                           S01176
     C                     MOVE TCCC      RCD,2                           S01176
     C                     MOVE CCMR      RAM,2                           S01176
     C                     MOVE TAXC      RCD,3                           S01176
     C                     MOVE TXRB      RAM,3                           S01176
     C*                                                                   S01176
     C* DETERMINE AMOUNT CODE FOR EACH AMOUNT DEPENDING ON                S01176
     C* DISCRETIONARY IND AND SIGN OF THE REBATE AMOUNT                   S01176
     C*                                                                   S01176
     C                     DO   3         I                               S01176
     C*                                                                   S01176
     C           RCD,I     IFNE '  '                                      S01176
     C*                                                                   S01176
     C           RAM,I     IFGT 0                                         S01176
     C                     MOVE 'ZR'      AMTC                            S01176
     C                     ELSE                                           S01176
     C                     MOVE 'ZP'      AMTC                            S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C                     MOVE TNMC      EVCY                            S01176
     C           RAM,I     IFLT 0                                         S01176
     C                     Z-SUBRAM,I     EVAM                            S01176
     C                     ELSE                                           S01176
     C                     Z-ADDRAM,I     EVAM                            S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C                     MOVE RCD,I     CCCD                            S01176
      *                                                                   S01446
      ** If Autocharges is switched on and S01446 is on then              S01446
      *  Or Analytical Accounting is installed,                           CAC002
      *                                                                   S01446
     C           BVACOP    IFEQ 'Y'                        B1             S01446
     C           S01446    ANDEQ'Y'                                       S01446
     C           EVAM      ANDNE0                                         S01176
     C           BGN0ST    OREQ 'Y'                                       CAC002
     C           EVAM      ANDNE0                                         CAC002
      *                                                                   S01446
      ** Access Charges Codes file for group charge code                  S01446
      *                                                                   S01446
     C                     CALL 'AOCHGTR0'                                S01446
     C                     PARM '*MSG   ' @RTCD   7                       S01446
     C                     PARM '*KEY   ' @OPTN   7                       S01446
     C                     PARM SNMCY     @CCY    3                       S01446
     C                     PARM CCCD      @CHGC   2                       S01446
     C           @SECGT    PARM @SECGT    DSSDY                           S01446
     C*                                                                   S01446
     C           @RTCD     IFNE *BLANKS                    B*2            S01446
     C                     MOVE '1'       *INU7                           S01446
     C                     MOVE '1'       *INU8                           S01446
     C           *LOCK     IN   LDA                                       S01446
     C                     MOVEL'SECGT   'DBFILE            **************S01446
     C                     MOVELSNMCY     DBKEY             * DB ERROR 32*S01446
     C                     MOVE CCCD      DBKEY             **************S01446
     C                     MOVE @OPTN     DBOPTN                          S01446
     C                     Z-ADD32        DBASE                           S01446
     C                     OUT  LDA                                       S01446
     C                     DUMP                                           S01446
     C                     GOTO MEND                                      S01446
     C                     ELSE                            X*2            S01446
      *                                                                   CAC002
     C           BVACOP    IFEQ 'Y'                                       CAC002
     C           S01446    ANDEQ'Y'                                       CAC002
     C                     MOVE GCCO      CCCD                            S01446
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
      ** If Analytical Accounting is installed, define a Profit Centre.   CAC002
      *                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
      *                                                                   CAC002
     C           BVACOP    IFEQ 'Y'                                       CAC002
     C           S01446    ANDEQ'Y'                                       CAC002
      *                                                                   CAC002
      ** Access charges codes file for Group charge code.                 CAC002
      *                                                                   CAC002
     C                     CALL 'AOCHGTR0'                                CAC002
     C                     PARM '*MSG   ' @RTCD                           CAC002
     C                     PARM '*KEY   ' @OPTN                           CAC002
     C                     PARM SNMCY     @CCY                            CAC002
     C                     PARM CCCD      @CHGC                           CAC002
     C           @SECGT    PARM @SECGT    DSSDY                           CAC002
     C*                                                                   CAC002
     C           @RTCD     IFNE *BLANKS                                   CAC002
     C                     MOVE '1'       *INU7                           CAC002
     C                     MOVE '1'       *INU8                           CAC002
     C           *LOCK     IN   LDA                                       CAC002
     C                     MOVEL'SECGT   'DBFILE           ************   CAC002
     C                     MOVELSNMCY     DBKEY            * DBERR 34 *   CAC002
     C                     MOVE CCCD      DBKEY            ************   CAC002
     C                     MOVE @OPTN     DBOPTN                          CAC002
     C                     Z-ADD34        DBASE                           CAC002
     C                     OUT  LDA                                       CAC002
     C                     DUMP                                           CAC002
     C                     GOTO MEND                                      CAC002
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
     C           BOTR      IFEQ ' '                                       CAC002
     C                     MOVE XPRFC     WWPRFC                          CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C           BOTR      IFEQ 'T'                                       CAC002
     C                     MOVE TPRC      WWPRFC                          CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C           BOTR      IFEQ 'B'                                       CAC002
     C                     MOVE BPRC      WWPRFC                          CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
     C                     END                             E*2            S01446
     C                     END                             E1             S01446
     C*                                                                   S01176
     C* WRITE RECORD OUT ONLY IF NE 0                                     S01176
     C*                                                                   S01176
     C           EVAM      IFNE 0                                         S01176
     C                     EXSR W01                                       S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C                     END                                            S01176
     C                     END                                            S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C* COUNTERVALUE KEY
     C*                                                                   S01176
     C           CVALUE    TAG
     C                     MOVE 'CN'      AMTC
     C                     MOVE TNMC      EVCY
     C                     Z-ADDTCTR      EVAM
     C                     MOVE '  '      CCCD                            E14544
     C                     MOVE *ZEROS    KNCA
     C***********          MOVE '   '     KCCY                            S01176
     C                     MOVE SNMCY     KCCY                            S01176
     C                     MOVE *ZEROS    KBCA
     C***********          SETON                     39                   S01176
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C                     END
     C*                                                                   CSE023
     C** If Backup Witholding Tax is applied then output A/C key          CSE023
     C*                                                                   CSE023
     C           WHTX      IFNE 0                                         CSE023
     C                     MOVE 'BW'      AMTC                            CSE023
     C                     MOVE TNMC      EVCY                            CSE023
     C                     MOVE '  '      CCCD                            CSE023
     C                     Z-ADDWHTX      EVAM                            CSE023
     C                     MOVE SNMCY     KCCY                            CSE023
     C                     MOVE *ZEROS    KBCA                            CSE023
     C                     EXSR W01                                       CSE023
     C                     END                                            CSE023
     C*                                                                   CSE023
     C           CGL031    IFEQ 'Y'                                                           CGL031
     C           *IN30     ANDEQ*ON                                                           CGL031
      *  DETERMINE WHETHER TO GENERATE REVERSALS FOR TAX AND NETT INTEREST.                   236063
     C                     EXSR SRGNRV                                                        236063
      *                                                                                       236063
      *                                                                                       CGL031
      ** Retrieve Tax Amounts as at Start of Business and generate reversals                  235615
      *                                                                                       235615
     C           WKGNRV    IFEQ 'Y'                                                           236063
     C                     EXSR SRETXR                                                        235615
      *                                                                                       235615
      ** Generate Net Interest Account Key to Reverse Start of Business Amount                235615
      *                                                                                       235615
     C           WIEVAM    IFGT 0                                                             235615
     C                     MOVE *BLANK    CCCD                                                235615
     C                     MOVE *BLANK    CTTX                                                235615
     C                     MOVE 'NI'      AMTC                                                235615
     C                     Z-ADDWIEVAM    EVAM                                                235615
     C                     MOVE WKCCY     EVCY                                                235615
     C                     Z-ADD*ZERO     KNCA                                                235615
     C                     MOVE WKCCY     KCCY                                                235615
     C                     Z-ADD*ZERO     KBCA                                                235615
     C                     MOVELRVRS      SVRVRS  1                                           235615
     C                     MOVEL'1'       RVRS                                                235615
     C                     EXSR W01                                                           235615
     C                     MOVELSVRVRS    RVRS                                                235615
     C                     ENDIF                                                              235615
      *                                                                                       236063
     C                     ENDIF                                                              236063
      *                                                                                       235615
      ** Retrieve Tax Amount                                                                  CGL031
      *                                                                                       CGL031
     C                     EXSR SRETAX                                                        CGL031
      *                                                                                       CGL031
      ***Generate*Tax*Amount*Account*Key*******************************                CGL031 235174
      *                                                                                       CGL031
     C********** WXEVAM    IFGT 0                                                      CGL031 235174
     C**********           MOVE *BLANK    CCCD                                         CGL031 235174
     C**********           MOVE TSCTRT    CTTX                                         CGL031 233999
     C**********           MOVE TSRCTR    CTTX                                         233999 235174
     C**********           MOVE 'ET'      AMTC                                         CGL031 235174
     C**********           Z-ADDWXEVAM    EVAM                                         CGL031 235174
     C**********           MOVE WEVCY     EVCY                                         CGL031 235174
     C**********           Z-ADDWXKNCA    KNCA                                         CGL031 235174
     C**********           MOVE WKCCY     KCCY                                         CGL031 235174
     C**********           Z-ADDWXKBCA    KBCA                                         CGL031 235174
     C**********           EXSR W01                                                    CGL031 235174
     C**********           ENDIF                                                       CGL031 235174
      *                                                                                       CGL031
      ** Generate Net Interest Account Key                                                    CGL031
      *                                                                                       CGL031
     C           WIEVAM    IFGT 0                                                             CGL031
     C                     MOVE *BLANK    CCCD                                                CGL031
     C                     MOVE *BLANK    CTTX                                                CGL031
     C                     MOVE 'NI'      AMTC                                                CGL031
     C                     Z-ADDWIEVAM    EVAM                                                CGL031
     C                     MOVE WKCCY     EVCY                                                CGL031
     C                     Z-ADD*ZERO     KNCA                                                CGL031
     C                     MOVE WKCCY     KCCY                                                CGL031
     C                     Z-ADD*ZERO     KBCA                                                CGL031
     C                     EXSR W01                                                           CGL031
     C                     ENDIF                                                              CGL031
      *                                                                                       CGL031
     C                     ENDIF                                                              CGL031
      *                                                                                       CGL031
     C/COPY WNCPYSRC,SE2290C027
     C*
     C***********          SETOF                     39                   S01176
     C*
     C* IF CROSS CURRENCY KEYS REQUIRED CHECK SETTLEMENT CURRENCY
     C*    AND BASE CURRENCY FOR ACCOUNTING
     C*
     C** On Trade Date, generate CV keys if Cross Currency Entries        066883
     C**  flag is 'T' or 'B'                                              066883
     C** On Value Date, generate CV keys if Cross Currency Entries        066883
     C**  flag is 'V' or 'B'                                              066883
     C*                                                                   066883
     C           *IN29     IFEQ '1'                                       066883
     C           BVCCYE    ANDEQ'T'                                       066883
     C           *IN29     OREQ '1'                                       066883
     C           BVCCYE    ANDEQ'B'                                       066883
     C           *IN30     OREQ '1'                                       066883
     C           BVCCYE    ANDEQ'V'                                       066883
     C           *IN30     OREQ '1'                                       066883
     C           BVCCYE    ANDEQ'B'                                       066883
     C************IN30     IFEQ '1'                                       066883
     C********** CCYE      ANDEQ'B'                                       E14513
     C************IN29     OREQ '1'                                       066883
     C***********CCYE      ANDEQ'B'                                       S01117
     C***********BVCCYE    ANDEQ'B'                                 S01117066883
     C/COPY WNCPYSRC,SE2290C028
     C*****************************************************************   S01117
     C**FIRST*ACCESS*TABTG10*FOR*NOMINAL*CCY'S*DEC*PLACES*AND*MULT/DIV*   S01117
     C*****************************************************************   S01117
     C***********          MOVEL'20      'TKEY
     C***********          MOVELSNMCY     ZWK4
     C***********          MOVE 1         ZWK4
     C***********          MOVE ZWK4      TKEY
     C***********TKEY      CHAINTABTG10F             10
     C*                                                                   S01117
     C*                                                                   S01117
     C* OBTAIN NOMINAL CURRENCY DECIMAL PALCES AND MULT/DIV INDICATOR     S01117
     C*                                                                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM SNMCY     @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C************IN10     IFEQ '1'                                       S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE 'TABLE'   DBFILE           ***************
     C***********          MOVELTKEY      DBKEY            * DB ERROR 10 *
     C**********           MOVE '10'      DBASE            ***************S01117
     C                     MOVEL'SDCURRPD'DBFILE                          S01194
     C                     MOVE @AJCD     DBKEY                           S01194
     C                     MOVE @OPTN     DBOPTN                          S01194
     C                     Z-ADD10        DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C                     ELSE
     C*
     C* SAVE NOM CCY CDP AND MULT/DIV IND TO AVOID A REPEAT ACCESS LATER
     C*
     C***********          Z-ADDCDP       NOMCDP  10                      S01117
     C***********          MOVE MDIN      NOMMDI  10                      S01117
     C***********          MOVE SPOT      NOMEXR 138                      S01117
     C                     Z-ADDA6NBDP    NOMCDP  10                      S01117
     C***********          MOVE A6MDIN    NOMMDI  10                      S01117
     C                     MOVE A6MDIN    NOMMDI  1                 S01117070683
     C                     MOVE A6SPRT    NOMEXR 138                      070683
     C                     END
     C*
     C* IF NOM CCY IS NOT EQUAL TP SETTLEMENT CCY CONVERT NOM TO SETT
     C*
     C           SNMCY     IFNE SETC
     C*
     C                     MOVE TCTR      ZAMTCI
     C*
     C* CONV. NOM TO SETT CCY USING EX.RATE AND M/D IND FROM TRADES FILE
     C*
     C                     MOVE TDER      ZEXCH
     C                     MOVE TMDI      ZMD
     C*
     C                     MOVE SNMCY     ZCCYI
     C                     MOVE SETC      ZCCYO
     C*
     C* CONVERT FROM ONE CURRENCY TO ANOTHER USING ZCONV
     C*                                                                   S01117
     C** FIND DECIMAL PLACES FOR (FROM) CURRENCY                          S01117
     C*                                                                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM ZCCYI     @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     MOVE '1'       *INU7                           S01117
     C                     MOVE '1'       *INU8                           S01117
     C                     ELSE                                           S01117
     C                     Z-ADDA6NBDP    ZCDPI                           S01117
     C*                                                                   S01117
     C** FIND DECIMAL PLACES FOR (TO) CURRENCY                            S01117
     C*                                                                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM ZCCYO     @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     MOVE '1'       *INU7                           S01117
     C                     MOVE '1'       *INU8                           S01117
     C                     ELSE                                           S01117
     C                     Z-ADDA6NBDP    ZCDPO                           S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C           *INU8     IFEQ '1'                                       S01117
     C                     MOVE '1'       *INLR                           S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDCURRPD'DBFILE           ***************S01117
     C                     MOVEL@AJCD     DBKEY            * DB ERROR 11 *S01117
     C                     Z-ADD11        DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND                                      S01117
     C                     END                                            S01117
     C*
     C                     EXSR ZCONV
     C************IN90     IFEQ '1'                                       S01117
     C***********          SETON                     U7U8LR               S01117
     C***********          MOVE 'TABLE'   DBFILE                          S01117
     C***********          MOVELTKEY      DBKEY            ***************S01117
     C***********          MOVE '11'      DBASE            * DB ERROR 11 *S01117
     C***********          GOTO MEND                                      S01117
     C***********          END                                            S01117
     C*
     C                     Z-ADDZAMTCO    EVAM
     C                     ELSE
     C                     Z-ADDTCTR      EVAM
     C                     END
     C*
     C* IF NOMINAL CURRENCY NE BASE CCY FOR ACCOUNTING CALC
     C*    COUNTERVALUE IN BASE CURRENCY USING ZCONV
     C*
     C***********SNMCY     IFNE BCCY                                      S01117
     C           SNMCY     IFNE BJCYCD                                    S01117
     C*                                                                   E21244
     C* IF SETTLEMENT CCY NOT EQUAL TO BASE CCY, CONVERT NOMINAL          E21244
     C* CCY TO BASE CCY EQUIVALENT                                        E21244
     C*                                                                   E21244
     C***********SETC      IFNE BCCY                               E21244 S01117
     C           SETC      IFNE BJCYCD                                    S01117
     C*
     C*  CONVERT COUNTERVALUE TO BASE CCY
     C*
     C                     MOVE TCTR      ZAMTCI
     C*********************MOVE NOMEXR    ZEXCH                           037597
     C************         MOVE TBCR      ZEXCH                    037597 112898
     C                     MOVE NOMEXR    ZEXCH                           112898
     C***********NOMMDI    IFEQ 0                                         070683
     C***********          MOVE 'D'       ZMD                             070683
     C***********          ELSE                                           070683
     C***********          MOVE 'M'       ZMD                             070683
     C***********          END                                            070683
     C                     MOVE NOMMDI    ZMD                             070683
     C***********          MOVE BCCY      ZCCYO                           S01117
     C                     MOVE BJCYCD    ZCCYO                           S01117
     C**********           MOVE NMCY      ZCCYI
     C                     MOVE SNMCY     ZCCYI
     C*                                                                   S01117
     C** FIND DECIMAL PLACES FOR (FROM) CURRENCY                          S01117
     C*                                                                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM ZCCYI     @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     MOVE '1'       *INU7                           S01117
     C                     MOVE '1'       *INU8                           S01117
     C                     MOVE '1'       *INLR                           S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDCURRPD'DBFILE           ***************S01117
     C                     MOVEL@AJCD     DBKEY            * DB ERROR 13 *S01117
     C                     Z-ADD13        DBASE            ***************S01117
     C                     MOVE @OPTN     DBOPTN                          S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND                                      S01117
     C                     ELSE                                           S01117
     C                     Z-ADDA6NBDP    ZCDPI                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C** FIND DECIMAL PLACES FOR (TO) CURRENCY                            S01117
     C*                                                                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM ZCCYO     @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     MOVE '1'       *INU7                           S01117
     C                     MOVE '1'       *INU8                           S01117
     C                     MOVE '1'       *INLR                           S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDCURRPD'DBFILE           ***************S01117
     C                     MOVEL@AJCD     DBKEY            * DB ERROR 13 *S01117
     C                     Z-ADD13        DBASE            ***************S01117
     C                     MOVE @OPTN     DBOPTN                          S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO MEND                                      S01117
     C                     ELSE                                           S01117
     C                     Z-ADDA6NBDP    ZCDPO                           S01117
     C                     END                                            S01117
     C*
     C                     EXSR ZCONV
     C************IN90     IFEQ '1'                                       S01117
     C***********          SETON                     U7U8LR               S01117
     C***********          MOVE 'TABLE'   DBFILE                          S01117
     C***********          MOVELTKEY      DBKEY            ***************S01117
     C************         MOVE '13'      DBASE            * DB ERROR 13 *S01117
     C***********          GOTO MEND                       ***************S01117
     C***********          END                                            S01117
     C*
     C                     Z-ADDZAMTCO    KBCA
     C*                                                                   E21244
     C* ELSE BASE CURRENCY EQUIVALENT IS COUNTERVALUE IN SETTLEMENT CCY   E21244
     C*                                                                   E21244
     C                     ELSE                                           E21244
     C                     Z-ADDEVAM      KBCA                            E21244
     C*                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
     C           TDTP      IFEQ 'TS'                                      CAC002
     C                     SUB  MAMT      KBCA                            CAC002
     C                     ELSE                                           CAC002
     C                     ADD  MAMT      KBCA                            CAC002
     C                     ENDIF                                          CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C                     END                                            E21244
     C                     ELSE
     C                     Z-ADDTCTR      KBCA
     C                     END
     C/COPY WNCPYSRC,SE2290C029
     C*
     C                     MOVE 'CV'      AMTC
     C/COPY WNCPYSRC,SE2290C030
     C                     MOVE SETC      EVCY
     C                     Z-ADDTCTR      KNCA
     C                     MOVE SNMCY     KCCY
     C*
     C* WRITE RECORD OUT ONLY IF EVENT AMOUNT NE ZERO
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C                     END
     C/COPY WNCPYSRC,SE2290C031
     C*
     C                     END
     C/COPY WNCPYSRC,SE2290C075
      *                                                                   CAC002
      ** If Analytical Accounting is installed and the Margin amount is   CAC002
      ** not zero, generate Margin Amount key.                            CAC002
      *                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
     C*                                                                   CAC002
     C           *IN29     IFEQ '1'                                       CAC002
     C           BVCCYE    ANDEQ'T'                                       CAC002
     C           *IN29     OREQ '1'                                       CAC002
     C           BVCCYE    ANDEQ'B'                                       CAC002
     C           *IN30     OREQ '1'                                       CAC002
     C           BVCCYE    ANDEQ'V'                                       CAC002
     C           *IN30     OREQ '1'                                       CAC002
     C           BVCCYE    ANDEQ'B'                                       CAC002
     C*                                                                   CAC002
     C           MAMT      IFNE 0                                         CAC002
     C                     MOVE 'MV'      AMTC                            CAC002
     C                     Z-ADDMAMT      EVAM                            CAC002
     C                     MOVE SETC      EVCY                            CAC002
     C                     EXSR W01                                       CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   CAC002
     C                     ENDIF                                          CAC002
     C/COPY WNCPYSRC,SE2290C032
     C*
     C   25                GOTO ENDKEY
     C/COPY WNCPYSRC,SE2290C073
     C*
     C* PURCHASED INTEREST KEYS
     C*
     C           *IN29     IFEQ '1'
     C           *IN33     ANDNE'1'
     C           ITRA      ANDNE*ZERO
     C           PROT      ANDNE'6'
     C                     MOVE 'PI'      AMTC
     C                     MOVE TNMC      EVCY
     C/COPY WNCPYSRC,SE2290C048
     C**********           Z-ADDITRA      EVAM
     C********** TDTP      IFEQ 'TS'                                      S01158
     C**********           Z-SUBITRA      EVAM                            S01158
     C**********           ELSE                                           S01158
     C                     Z-ADDITRA      EVAM
     C**********           END                                            S01158
     C*
     C**REVERSE*SIGN*IF*TRADE*IS*EX-COUPON************************ E16830 E21433
     C***********                                                  E16830 E21433
     C***********ACIN      IFEQ 'X'                                E16830 E21433
     C***********          Z-SUBEVAM      EVAM                     E16830 E21433
     C***********          END                                     E16830 E21433
     C*                                                                   E16830
     C           EVAM      IFNE 0
     C                     EXSR W01
     C                     END
     C*
     C                     END
     C*
     C* INTEREST DISCREPANCY KEYS
     C*
     C           TINA      IFNE *ZERO
     C           *IN29     ANDEQ'1'
     C           *IN33     ANDNE'1'
     C           TINA      ORNE *ZERO
     C           *IN30     ANDEQ'1'
     C           *IN34     ANDNE'1'
     C*
     C           TDTP      IFEQ 'TP'
     C           TINA      ANDGT*ZERO
     C           TDTP      OREQ 'TS'
     C           TINA      ANDLT*ZERO
     C                     MOVE 'DN'      AMTC
     C                     ELSE
     C                     MOVE 'DF'      AMTC
     C                     END
     C*
     C                     MOVE TNMC      EVCY
     C           TINA      IFLT *ZERO
     C                     Z-SUBTINA      EVAM
     C                     ELSE
     C                     Z-ADDTINA      EVAM
     C                     END
     C*
     C           EVAM      IFNE 0
     C                     EXSR W01
     C                     END
     C*
     C                     END
     C*                                                                   S01176
     C* CONTINGENT LIABILITY KEY                                          S01176
     C*                                                                   S01176
     C* DETERMINE IF KEYS ARE BEING SUPPRESSED                            S01176
     C*                                                                   S01176
     C           *IN29     IFEQ '1'                                       S01176
     C           *IN33     ANDNE'1'                                       S01176
     C           *IN30     OREQ '1'                                       S01176
     C           *IN34     ANDNE'1'                                       S01176
     C*                                                                   S01176
     C*  Produce Contingent Liability Key                                 S01176
     C*  if required                                                      E19832
     C*                                                                   E19832
     C           CNLI      IFEQ 'Y'                                       E19832
     C*                                                                   E19832
     C                     EXSR W04                                       S01176
     C*                                                                   S01176
     C                     END                                            E19832
     C                     END                                            S01176
     C*
     C           ENDKEY    ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * UDEPOT - OUTPUT USER DEPOT MOVEMENTS FOR AMENDED DEPOT        *
      *                                                               *
      *****************************************************************
      *
     C           UDEPOT    BEGSR                           ** UDEPOT **
     C*
     C* MOVE INFORMATION INTO RECORD FOR USER DEPOT MOVEMENT
     C*
     C                     MOVE 'D'       RECI
     C**********           MOVE TDBR      DPBC                            E15996
     C                     MOVE TDSS      DPSS
     C**********           MOVE TDBK      DPBK                            E15996
     C**********           MOVE TDMI      DMRT                            E15996
     C**********           MOVE RUND      DADA                            E15996
     C                     MOVE *BLANKS   DMRF
     C**********           MOVE 'T'       DDBA                            E15996
     C***********          MOVE NOML      DMNA                            E22485
     C**********           MOVE 'Y'       DRIN                            E15996
     C                     MOVE ' '       DRIN                            E15996
     C                     MOVELTDRF      DPNR
     C*
     C* OUTPUT MOVEMENT CODE DEPENDING ON TRADE TYPE
     C*
     C* If Trade Purchase -
     C*
     C           TDTP      IFEQ 'TP'
     C********** SDELT     ANDNE*ZEROS                                                        CSD027
     C           SDELT     ANDNE*BLANKS                                                       CSD027
     C***********          MOVE STDBR     DPBC                     E15996 S01117
     C                     MOVE STDBR     DPBA                            S01117
     C                     MOVE STDBK     DPBK                            E15996
     C                     MOVE STDMI     DMRT                            E15996
     C                     MOVE STDDT     DADA                            E15996
     C                     MOVE 'T'       DDBA                            E15996
     C                     MOVE 'UO'      DPMV
     C                     MOVE SDELT     DDEP
     C                     MOVE SNOML     DMNA                            E22485
     C                     WRITEUDPMVDF
     C/COPY WNCPYSRC,SE2290C051
     C***********          MOVE TTDBR     DPBC                     E15996 S01117
     C                     MOVE TTDBR     DPBA                            S01117
     C                     MOVE TTDBK     DPBK                            E15996
     C                     MOVE TTDMI     DMRT                            E15996
     C                     MOVE TTDDT     DADA                            E15996
     C                     MOVE 'UI'      DPMV
     C                     MOVE TDELT     DDEP
     C                     MOVE TNOML     DMNA                            E22485
     C**********           MOVE ' '       DRIN                            E15996
     C                     WRITEUDPMVDF
     C/COPY WNCPYSRC,SE2290C052
     C                     ADD  2         UDCNT   50
     C*                                                                   E15996
     C* Value date actions                                                E15996
     C*                                                                   E15996
     C           STDVD     IFLT ECD                                       E15996
     C***********          MOVE STDBR     DPBC                     E15996 S01117
     C                     MOVE STDBR     DPBA                            S01117
     C                     MOVE STDBK     DPBK                            E15996
     C                     MOVE STDMI     DMRT                            E15996
     C                     MOVE STDVD     DADA                            E15996
     C                     MOVE 'V'       DDBA                            E15996
     C                     MOVE 'UO'      DPMV                            E15996
     C                     MOVE SDELT     DDEP                            E15996
     C                     MOVE SNOML     DMNA                            E22485
     C                     WRITEUDPMVDF                                   E15996
     C/COPY WNCPYSRC,SE2290C053
     C                     ADD  1         UDCNT   50                      E15996
     C                     END                                            E15996
     C*                                                                   E15996
     C           TTDVD     IFLT ECD                                       E15996
     C***********          MOVE TTDBR     DPBC                     E15996 S01117
     C                     MOVE TTDBR     DPBA                            S01117
     C                     MOVE TTDBK     DPBK                            E15996
     C                     MOVE TTDMI     DMRT                            E15996
     C                     MOVE TTDVD     DADA                            E15996
     C                     MOVE 'V'       DDBA                            E15996
     C                     MOVE 'UO'      DPMV                            E15996
     C                     MOVE TDELT     DDEP                            E15996
     C                     MOVE TNOML     DMNA                            E22485
     C                     WRITEUDPMVDF                                   E15996
     C/COPY WNCPYSRC,SE2290C054
     C                     ADD  1         UDCNT   50                      E15996
     C                     END                                            E15996
     C*                                                                   E15996
     C                     END
     C*
     C* If Trade Sale -
     C*
     C           TDTP      IFEQ 'TS'
     C********** SDELF     ANDNE*ZEROS                                                        CSD027
     C           SDELF     ANDNE*BLANKS                                                       CSD027
     C***********          MOVE STDBR     DPBC                     E15996 S01117
     C                     MOVE STDBR     DPBA                            S01117
     C                     MOVE STDBK     DPBK                            E15996
     C                     MOVE STDMI     DMRT                            E15996
     C                     MOVE STDDT     DADA                            E15996
     C                     MOVE 'T'       DDBA                            E15996
     C                     MOVE 'UI'      DPMV
     C                     MOVE SDELF     DDEP
     C                     MOVE SNOML     DMNA                            E22485
     C                     WRITEUDPMVDF
     C/COPY WNCPYSRC,SE2290C055
     C************         MOVE TTDBR     DPBC                     E15996 S01117
     C                     MOVE TTDBR     DPBA                            S01117
     C                     MOVE TTDBK     DPBK                            E15996
     C                     MOVE TTDMI     DMRT                            E15996
     C                     MOVE TTDDT     DADA                            E15996
     C                     MOVE 'UO'      DPMV
     C                     MOVE TDELF     DDEP
     C                     MOVE TNOML     DMNA                            E22485
     C**********           MOVE ' '       DRIN                            E15996
     C                     WRITEUDPMVDF
     C/COPY WNCPYSRC,SE2290C056
     C                     ADD  2         UDCNT
     C*                                                                   E15996
     C* Value date actions                                                E15996
     C*                                                                   E15996
     C           STDVD     IFLT ECD                                       E15996
     C***********          MOVE STDBR     DPBC                     E15996 S01117
     C                     MOVE STDBR     DPBA                            S01117
     C                     MOVE STDBK     DPBK                            E15996
     C                     MOVE STDMI     DMRT                            E15996
     C                     MOVE STDVD     DADA                            E15996
     C                     MOVE 'V'       DDBA                            E15996
     C                     MOVE 'UO'      DPMV                            E15996
     C                     MOVE SDELF     DDEP                            E15996
     C                     MOVE SNOML     DMNA                            E22485
     C                     WRITEUDPMVDF                                   E15996
     C/COPY WNCPYSRC,SE2290C057
     C                     ADD  1         UDCNT   50                      E15996
     C                     END                                            E15996
     C*                                                                   E15996
     C           TTDVD     IFLT ECD                                       E15996
     C***********          MOVE TTDBR     DPBC                     E15996 S01117
     C                     MOVE TTDBR     DPBA                            S01117
     C                     MOVE TTDBK     DPBK                            E15996
     C                     MOVE TTDMI     DMRT                            E15996
     C                     MOVE TTDVD     DADA                            E15996
     C                     MOVE 'V'       DDBA                            E15996
     C                     MOVE 'UO'      DPMV                            E15996
     C                     MOVE TDELF     DDEP                            E15996
     C                     MOVE TNOML     DMNA                            E22485
     C                     WRITEUDPMVDF                                   E15996
     C/COPY WNCPYSRC,SE2290C058
     C                     ADD  1         UDCNT   50                      E15996
     C                     END                                            E15996
     C*                                                                   E15996
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CDEPOT - OUTPUT CUSTOMER DEPOT MOVEMENTS FOR AMENDED DEPOT    *
      *                                                               *
      *****************************************************************
      *
     C           CDEPOT    BEGSR                           ** CDEPOT **
     C*
     C* MOVE INFORMATION INTO RECORD FOR CUSTOMER MOVEMENT
     C*
     C                     MOVE 'D'       RECI
     C**********           MOVE TDBR      CPBC                            E15996
     C                     MOVE TDSS      CPSS
     C                     MOVE TCNR      CCRT
     C**********           MOVE TDMI      CMRT                            E15996
     C**********           MOVE RUND      CADA                            E15996
     C                     MOVE *BLANKS   CDMR
     C                     MOVE *ZEROS    CPRC
     C**********           MOVE 'T'       CDBA                            E15996
     C***********          MOVE NOML      CMNA                            E22485
     C**********           MOVE 'Y'       CRIN                            E15996
     C                     MOVE ' '       CRIN                            E15996
     C                     MOVELTDRF      DPNR
     C*
     C* MOVEMENT TYPE OUTPUT DEPENDS ON TRADE TYPE
     C*
     C* If Trade Purchase -
     C*
     C           TDTP      IFEQ 'TP'
     C********** SDELF     ANDNE*ZEROS                                                        CSD027
     C           SDELF     ANDNE*BLANKS                                                       CSD027
     C***********          MOVE STDBR     CPBC                     E15996 S01117
     C                     MOVE STDBR     CPBA                            S01117
     C                     MOVE STDMI     CMRT                            E15996
     C                     MOVE STDDT     CADA                            E15996
     C                     MOVE 'T'       CDBA                            E15996
     C***********          MOVE 'CI'      CPMV                            E19332
     C                     MOVE 'CO'      CPMV                            E19332
     C                     MOVE 'Y'       CRIN                            E19332
     C                     MOVE SDELF     CDEP
     C                     MOVE SPRIC     CPRC                            E19332
     C                     MOVE SNOML     CMNA                            E22485
      *                                                                   CSE017
     C           CSE017    IFEQ 'Y'                                       CSE017
     C                     MOVE *BLANK    CPIN                            CSE017
     C                     ENDIF                                          CSE017
      *                                                                   CSE017
     C                     WRITECDPMVDF
     C/COPY WNCPYSRC,SE2290C059
     C***********          MOVE TTDBR     CPBC                     E15996 S01117
     C                     MOVE TTDBR     CPBA                            S01117
     C                     MOVE TTDMI     CMRT                            E15996
     C                     MOVE TTDDT     CADA                            E15996
     C***********          MOVE 'CO'      CPMV
     C                     MOVE 'CI'      CPMV                            E19332
     C                     MOVE 'Y'       CRIN                            E19332
     C                     MOVE TDELF     CDEP
     C                     MOVE TPRIC     CPRC                            E19332
     C                     MOVE TNOML     CMNA                            E22485
     C**********           MOVE ' '       CRIN                            E15996
      *                                                                   CSE017
     C           CSE017    IFEQ 'Y'                                       CSE017
     C                     MOVE *BLANK    CPIN                            CSE017
     C                     ENDIF                                          CSE017
      *                                                                   CSE017
     C                     WRITECDPMVDF
     C/COPY WNCPYSRC,SE2290C060
     C                     ADD  2         CDCNT   50
     C*                                                                   E15996
     C* Value date action                                                 E15996
     C*                                                                   E15996
     C           STDVD     IFLT ECD                                       E15996
     C***********          MOVE STDBR     CPBC                     E15996 S01117
     C                     MOVE STDBR     CPBA                            S01117
     C                     MOVE STDMI     CMRT                            E15996
     C                     MOVE STDVD     CADA                            E15996
     C                     MOVE 'V'       CDBA                            E15996
     C***********          MOVE 'CI'      CPMV                     E15996 E19332
     C                     MOVE 'CO'      CPMV                            E19332
     C                     MOVE 'Y'       CRIN                            E19332
     C                     MOVE SDELF     CDEP                            E15996
     C                     MOVE SPRIC     CPRC                            E19332
     C                     MOVE SNOML     CMNA                            E22485
      *                                                                   CSE017
     C           CSE017    IFEQ 'Y'                                       CSE017
     C                     MOVE *BLANK    CPIN                            CSE017
     C                     ENDIF                                          CSE017
      *                                                                   CSE017
     C                     WRITECDPMVDF                                   E15996
     C/COPY WNCPYSRC,SE2290C061
     C                     ADD  1         CDCNT   50                      E15996
     C                     END                                            E15996
     C*                                                                   E15996
     C           TTDVD     IFLT ECD                                       E15996
     C***********          MOVE TTDBR     CPBC                     E15996 S01117
     C                     MOVE TTDBR     CPBA                            S01117
     C                     MOVE TTDMI     CMRT                            E15996
     C                     MOVE TTDVD     CADA                            E15996
     C                     MOVE 'V'       CDBA                            E15996
     C***********          MOVE 'CO'      CPMV                     E15996 E19332
     C                     MOVE 'CI'      CPMV                            E19332
     C                     MOVE 'Y'       CRIN                            E19332
     C                     MOVE TDELF     CDEP                            E15996
     C                     MOVE TPRIC     CPRC                            E19332
     C                     MOVE TNOML     CMNA                            E22485
      *                                                                   CSE017
     C           CSE017    IFEQ 'Y'                                       CSE017
     C                     MOVE *BLANK    CPIN                            CSE017
     C                     ENDIF                                          CSE017
      *                                                                   CSE017
     C                     WRITECDPMVDF                                   E15996
     C/COPY WNCPYSRC,SE2290C062
     C                     ADD  1         CDCNT   50                      E15996
     C                     END                                            E15996
     C*                                                                   E15996
     C                     END
     C*
     C* If Trade Sale -
     C*
     C           TDTP      IFEQ 'TS'
     C********** SDELT     ANDNE*ZEROS                                                        CSD027
     C           SDELT     ANDNE*BLANKS                                                       CSD027
     C***********          MOVE STDBR     CPBC                     E15996 S01117
     C                     MOVE STDBR     CPBA                            S01117
     C                     MOVE STDMI     CMRT                            E15996
     C                     MOVE STDDT     CADA                            E15996
     C                     MOVE 'T'       CDBA                            E15996
     C***********          MOVE 'CO'      CPMV                            E19332
     C                     MOVE 'CI'      CPMV                            E19332
     C                     MOVE 'Y'       CRIN                            E19332
     C                     MOVE SDELT     CDEP
     C                     MOVE SPRIC     CPRC                            E19332
     C                     MOVE SNOML     CMNA                            E22485
      *                                                                   CSE017
     C           CSE017    IFEQ 'Y'                                       CSE017
     C                     MOVE *BLANK    CPIN                            CSE017
     C                     ENDIF                                          CSE017
      *                                                                   CSE017
     C                     WRITECDPMVDF
     C/COPY WNCPYSRC,SE2290C063
     C***********          MOVE TTDBR     CPBC                     E15996 S01117
     C                     MOVE TTDBR     CPBA                            S01117
     C                     MOVE TTDMI     CMRT                            E15996
     C                     MOVE TTDDT     CADA                            E15996
     C***********          MOVE 'CI'      CPMV                            E19332
     C                     MOVE 'CO'      CPMV                            E19332
     C                     MOVE 'Y'       CRIN                            E19332
     C                     MOVE TDELT     CDEP
     C                     MOVE TPRIC     CPRC                            E19332
     C                     MOVE TNOML     CMNA                            E22485
     C**********           MOVE ' '       CRIN                            E15996
      *                                                                   CSE017
     C           CSE017    IFEQ 'Y'                                       CSE017
     C                     MOVE *BLANK    CPIN                            CSE017
     C                     ENDIF                                          CSE017
      *                                                                   CSE017
     C                     WRITECDPMVDF
     C/COPY WNCPYSRC,SE2290C064
     C                     ADD  2         CDCNT
     C*                                                                   E15996
     C* Value date action                                                 E15996
     C*                                                                   E15996
     C           STDVD     IFLT ECD                                       E15996
     C***********          MOVE STDBR     CPBC                     E15996 S01117
     C                     MOVE STDBR     CPBA                            S01117
     C                     MOVE STDMI     CMRT                            E15996
     C                     MOVE STDVD     CADA                            E15996
     C                     MOVE 'V'       CDBA                            E15996
     C***********          MOVE 'CI'      CPMV                            E15996
     C                     MOVE 'CO'      CPMV                            E19332
     C                     MOVE 'Y'       CRIN                            E19332
     C                     MOVE SDELT     CDEP                            E15996
     C                     MOVE SPRIC     CPRC                            E19332
     C                     MOVE SNOML     CMNA                            E22485
      *                                                                   CSE017
     C           CSE017    IFEQ 'Y'                                       CSE017
     C                     MOVE *BLANK    CPIN                            CSE017
     C                     ENDIF                                          CSE017
      *                                                                   CSE017
     C                     WRITECDPMVDF                                   E15996
     C/COPY WNCPYSRC,SE2290C065
     C                     ADD  1         CDCNT   50                      E15996
     C                     END                                            E15996
     C*                                                                   E15996
     C           TTDVD     IFLT ECD                                       E15996
     C***********          MOVE TTDBR     CPBC                     E15996 S01117
     C                     MOVE TTDBR     CPBA                            S01117
     C                     MOVE TTDMI     CMRT                            E15996
     C                     MOVE TTDVD     CADA                            E15996
     C                     MOVE 'V'       CDBA                            E15996
     C***********          MOVE 'CO'      CPMV                     E15996 E19332
     C                     MOVE 'CI'      CPMV                            E19332
     C                     MOVE 'Y'       CRIN                            E19332
     C                     MOVE TDELT     CDEP                            E15996
     C                     MOVE TPRIC     CPRC                            E19332
     C                     MOVE TNOML     CMNA                            E22485
      *                                                                   CSE017
     C           CSE017    IFEQ 'Y'                                       CSE017
     C                     MOVE *BLANK    CPIN                            CSE017
     C                     ENDIF                                          CSE017
      *                                                                   CSE017
     C                     WRITECDPMVDF                                   E15996
     C/COPY WNCPYSRC,SE2290C066
     C                     ADD  1         CDCNT   50                      E15996
     C                     END                                            E15996
     C*                                                                   E15996
     C                     END
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  W01 - WRITE OUT THE GENERATED ACCOUNT KEYS                   *
      *                                                               *
      *****************************************************************
      *
     C           W01       BEGSR                           ** W01 **
     C*
     C* ADD EVENT AMOUNT INTO HASH TOTALS
     C*
     C                     Z-ADD1         Z
     C                     Z-ADD1         S
     C                     Z-ADDEVAM      ZZAMT
     C                     EXSR ZHASH
     C*
     C* MOVE INFORMATION IN TO RECORD DEPENDING ON TRADE OR VALUE
     C*      DATE PROCESSING AND TRADE TYPES ETC.
     C*
     C                     MOVE 'D'       RECI
     C*                                                                   S01486
     C           *IN29     IFEQ '1'
     C                     MOVE 'T'       EVCD
     C*                                                                   S01486
     C****If*Portfolio*Management*is*present***************************                S01486 258975
     C*                                                                   S01486
     C********** BGPFMG    IFEQ 'Y'                                                    S01486 258975
     C********** BGN4ST    OREQ 'Y'                                                    CPB001 258975
     C*****************************************************************                S01486 258975
     C****For*safe*custody*or*discretionary*customers,*output*the*trade                S01486 258975
     C****value*date*to*LF/SEKEY*as*the*event*date,*if*amount*code*on**                S01486 258975
     C****account*key*is*either*'CN'*or*'CV'.**************************                S01486 258975
     C*****************************************************************                S01486 258975
     C********** C1DI      IFEQ 'D'                                                    S01486 258975
     C********** C1DI      OREQ 'S'                                                    S01486 258975
     C********** AMTC      IFEQ 'CV'                                                   S01486 258975
     C********** AMTC      OREQ 'CN'                                                   S01486 258975
     C********** AMTC      OREQ 'MV'                                                   CAC002 258975
     C**********           Z-ADDTDVD      EVDT                                         S01486 258975
     C**********           ELSE                                                        S01486 258975
     C**********           Z-ADDTDDT      EVDT                                         S01486 258975
     C**********           END                                                         S01486 258975
     C**********           ELSE                                                        S01486 258975
     C**********           MOVE TDDT      EVDT                                         S01486 258975
     C**********           END                                                         S01486 258975
     C*COPY*WNCPYSRC,SE2290C033****************************************   S01408
     C*                                                                   S01486
     C****Portfolio*Management*is*not*present**************************                S01486 258975
     C**********           ELSE                                                        S01486 258975
     C                     MOVE TDDT      EVDT
     C**********           END                                                         S01486 258975
     C/COPY WNCPYSRC,SE2290C033                                           S01408
     C*                                                                   S01486
     C                     END
     C*                                                                   S01486
     C           *IN30     IFEQ '1'
     C                     MOVE 'V'       EVCD
     C                     MOVE TDVD      EVDT
     C                     END
     C*                                                                   S01486
     C*
     C                     MOVE *BLANK    SEBR                            S01117
     C           TDTP      IFEQ 'TP'
     C                     MOVE 'P'       TRDT
     C                     MOVE PYFM      STLA
     C                     MOVE DELT      KCUST
     C                     MOVE PYFA      SEBR                            S01117
     C                     END
     C           TDTP      IFEQ 'TS'
     C                     MOVE 'S'       TRDT
     C                     MOVE PAYT      STLA
     C                     MOVE DELF      KCUST
     C                     MOVE PYTA      SEBR                            S01117
     C                     END
     C*
     C                     MOVE SITP      INTP
     C           AMTC      IFEQ 'CV'
     C           AMTC      OREQ 'CN'
     C           AMTC      OREQ 'DF'
     C           AMTC      OREQ 'DN'
     C           AMTC      OREQ 'MV'                                      CAC002
     C/COPY WNCPYSRC,SE2290C034
     C*
     C           C1DI      IFEQ 'M'
     C                     MOVE ' '       PFIN
     C                     ELSE
     C                     MOVE C1DI      PFIN
     C                     END
     C*
     C                     ELSE
     C                     MOVE ' '       PFIN
     C                     END
     C*
     C                     MOVE TDBK      BKCD
     C***********TSAK      IFEQ 'Y'                                       S01117
     C           BVTSAK    IFEQ 'Y'                                       S01117
     C                     MOVE TSUB      TRSB
     C                     ELSE
     C                     MOVE ' '       TRSB
     C                     END
     C*                                                                   CGL031
     C           AMTC      IFEQ 'ET'                                      CGL031
     C           AMTC      OREQ 'NI'                                      CGL031
     C                     MOVE 'E'       EVCD                            CGL031
     C                     MOVE *BLANK    TRDT                            CGL031
     C                     MOVE C1DI      PFIN                            CGL031
     C                     MOVE *BLANK    BKCD                            CGL031
     C                     END                                            CGL031
     C*
     C                     MOVE TDMI      MKT
     C*
     C***********CIAK      IFEQ 'Y'                                       S01117
     C           BVCIAK    IFEQ 'Y'                                       S01117
     C           SCVI      ANDEQ'Y'                                       E15430
     C                     MOVE SCVI      CNVI
     C                     ELSE
     C                     MOVE ' '       CNVI
     C                     END
     C*
     C                     MOVE TDRF      TRFR
     C                     MOVE TCNR      CSTN
     C***********          MOVE TDBR      BRCH                            S01117
     C                     MOVE TDBA      BRHA                            S01117
     C                     MOVE ASNM      ASQN
     C                     MOVE SMTH      STLT
     C**N39******          MOVE SNMCY     KCCY                            S01176
     C                     MOVE SNMCY     KCCY                            S01176
     C                     MOVE TDSS      SESH
     C                     ADD  1         KEYCNT  50
     C*                                                                   S01486
     C**  Check the amount code for countervalue                          S01486
     C*                                                                   S01486
     C**  Save portfolio reference                                        S01486
     C           BGPFMG    IFEQ 'Y'                                       S01486
     C           AMTC      ANDEQ'CV'                                      S01486
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C           AMTC      ANDEQ'CV'                                      CPB001
     C*                                                                   S01486
     C**  Move the portfolio reference from the trade into file           S01486
     C*                                                                   S01486
     C                     MOVE XPTFR     PTFR                            S01486
     C                     ELSE                                           S01486
     C*                                                                   S01486
     C**  Set the portfolio reference equal to blank                      S01486
     C*                                                                   S01486
     C                     MOVE *BLANKS   PTFR                            S01486
     C                     END                                            S01486
     C*                                                                   S01486
      *                                                                   S01117
      ** Set settlement branch to booking branch if settlement branch     S01117
      ** is blank                                                         S01117
      *                                                                   S01117
     C           SEBR      IFEQ *BLANKS                                   S01117
     C                     MOVE BRHA      SEBR                            S01117
     C                     END                                            S01117
      *                                                                   CAC002
      ** If Analytical Accounting is installed, define the profit         CAC002
      ** centre for each posting.                                         CAC002
      *                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
     C                     MOVE PRFC      WPRFC   4                       CAC002
     C           AMTC      IFEQ 'CR'                                      CAC002
     C           AMTC      OREQ 'FR'                                      CAC002
     C           AMTC      OREQ 'ZR'                                      CAC002
     C           AMTC      OREQ 'CP'                                      CAC002
     C           AMTC      OREQ 'FP'                                      CAC002
     C           AMTC      OREQ 'ZP'                                      CAC002
     C                     MOVE WWPRFC    PRFC                            CAC002
     C                     ELSE                                           CAC002
     C           AMTC      IFEQ 'CN'                                      CAC002
     C           AMTC      OREQ 'CV'                                      CAC002
     C           AMTC      OREQ 'MV'                                      CAC002
     C                     MOVE TPRC      PRFC                            CAC002
     C                     ELSE                                           CAC002
     C                     MOVE BPRC      PRFC                            CAC002
     C                     ENDIF                                          CAC002
     C                     ENDIF                                          CAC002
     C                     ENDIF                                          CAC002
     C*                                                                   S01117
      ** If Midas Compliance Watch (CGL020) is installed and Repayment,                       CGL020
      ** set Fee Flag = 'F', Fee Value = Charge Amount and Fee Percent = 100                  CGL020
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C           AMTC      IFEQ 'FR'                                                          CGL020
     C           AMTC      OREQ 'FP'                                                          CGL020
     C           AMTC      OREQ 'CR'                                                          CGL020
     C           AMTC      OREQ 'CP'                                                          CGL020
     C           AMTC      OREQ 'ZR'                                                          CGL020
     C           AMTC      OREQ 'ZP'                                                          CGL020
     C                     MOVE 'F'       F1FFLG                                              CGL020
     C                     Z-ADDEVAM      F1FVAL                                              CGL020
     C                     Z-ADD100       F1FPCT                                              CGL020
     C                     ELSE                                                               CGL020
     C                     MOVE *BLANK    F1FFLG                                              CGL020
     C                     Z-ADD0         F1FVAL                                              CGL020
     C                     Z-ADD0         F1FPCT                                              CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C           TDRF      CHAINTRADSDY2             17                                       CGL020
     C           *IN17     IFEQ '0'                                                           CGL020
     C                     MOVELT2IPYN    PIPYN  10                                           CGL020
     C                     MOVELT2IPYL    PIPYL  35                                           CGL020
     C                     MOVELT2AWIN    PAWIN  10                                           CGL020
     C                     MOVELT2AWIL    PAWIL  35                                           CGL020
     C                     MOVELT2BOFN    PBOFN  10                                           CGL020
     C                     MOVELT2BOF1    PBOF1  35                                           CGL020
     C                     MOVELT2DIDN    PDEBT  10                                           CSW210
     C                     MOVELT2DLIN    PDEBTA 35                                           CSW210
     C                     ELSE                                                               CGL020
     C                     MOVEL*BLANKS   PIPYN                                               CGL020
     C                     MOVEL*BLANKS   PIPYL                                               CGL020
     C                     MOVEL*BLANKS   PAWIN                                               CGL020
     C                     MOVEL*BLANKS   PAWIL                                               CGL020
     C                     MOVEL*BLANKS   PBOFN                                               CGL020
     C                     MOVEL*BLANKS   PBOF1                                               CGL020
     C                     MOVE *BLANKS   PDEBT                                               CSW210
     C                     MOVE *BLANKS   PDEBTA                                              CSW210
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C**********           Z-ADDTCNR      PTCNR                                        CGL020 CSD027
     C                     MOVE TCNR      PTCNR                                               CSD027
      *                                                                                       CGL020
      ** Setup AML Fields                                                                     CGL020
      *                                                                                       CGL020
     C                     CALL SETAML                                                        CGL020
     C                     PARM           PIPYN                                               CGL020
     C                     PARM           PIPYL                                               CGL020
     C                     PARM           PAWIN                                               CGL020
     C                     PARM           PAWIL                                               CGL020
     C                     PARM           PBOFN                                               CGL020
     C                     PARM           PBOF1                                               CGL020
     C                     PARM           PDEBT                                               CSW210
     C                     PARM           PDEBTA                                              CSW210
     C                     PARM           PTCNR                                               CGL020
     C                     PARM           TDFA                                                CGL020
     C                     PARM           STLA                                                CGL020
     C                     PARM           SEBR                                                CGL020
     C                     PARM           EVCY                                                CGL020
     C                     PARM           F1RACT                                              CGL020
     C                     PARM           F1RCTY                                              CGL020
     C                     PARM           F1RBNK                                              CGL020
     C                     PARM           F1RCDE                                              CGL020
     C                     PARM           F1PACT                                              CGL020
     C                     PARM           F1PCTY                                              CGL020
     C                     PARM           F1PBNK                                              CGL020
     C                     PARM           F1PCDE                                              CGL020
     C                     PARM           F1DACT                                              CGL020
     C                     PARM           F1DCTY                                              CGL020
     C                     PARM           F1DBNK                                              CGL020
      *                                                                                       CGL020
     C                     Z-ADDTDVD      F1SDAT                                              CGL020
     C                     MOVELTDSS      F1TICK                                              CGL020
     C                     MOVELTMKC      F1EXCH                                              CGL020
     C                     Z-ADDNOML      F1NOML                                              CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C/COPY WNCPYSRC,SE2290C049
     C                     WRITESEKEYDF
     C/COPY WNCPYSRC,SE2290C074
      *                                                                                       CGL020
      ** If Midas Compliance Watch (CGL020) is installed,                                     CGL020
      ** reset Fee Flag, Fee Value and Fee Percent.                                           CGL020
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
     C                     MOVE *BLANK    F1FFLG                                              CGL020
     C                     Z-ADD0         F1FVAL                                              CGL020
     C                     Z-ADD0         F1FPCT                                              CGL020
     C                     ENDIF                                                              CGL020
      *                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
     C                     MOVE WPRFC     PRFC                            CAC002
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
     C*  REPLACE PORTFOLIO REFERENCE                                      S01486
     C******************** MOVE XXPTFR    PTFR                            S01486
     C/COPY WNCPYSRC,SE2290C042
     C*
     C* RESET FIELDS THAT GET CHANGED IN ACC AND ACCREV
     C*
     C                     MOVE '  '      CCCD
     C                     MOVE '  '      AMTC
     C                     Z-ADD0         EVAM
     C                     MOVE '   '     EVCY
     C**********           MOVE '0'       RVRS                            E14720
     C                     Z-ADD0         KNCA
     C                     Z-ADD0         KBCA
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT                                                              S01176
      *****************************************************************   S01176
      *                                                               *   S01176
      * W04 - WRITE OUT CONTINGENT LIABILITY KEYS                     *   S01176
      *                                                               *   S01176
      *****************************************************************   S01176
      *                                                                   S01176
     C           W04       BEGSR                           ** W04 **      S01176
     C*                                                                   S01176
     C**    ONLY WRITE CONT LIAB KEYS IF TRADE IS A SALE                  S01176
     C**     AND COUNTERPARTY IS NOT EQUAL TO THE ISSUER                  S01176
     C**     AND PROCESSING TYPE NOT EQUAL TO 2,4 OR 7                    E18335
     C*                                                                   S01176
     C                     SETOF                     60                   E18335
     C           PROT      IFEQ '2'                                       E18335
     C           PROT      OREQ '4'                                       E18335
     C           PROT      OREQ '7'                                       E18335
     C           CNLI      ORNE 'Y'                                       E23874
     C                     SETON                     60                   E18335
     C                     END                                            E18335
     C*                                                                   E18335
     C           TDTP      IFEQ 'TS'                                      S01176
     C           TCNR      ANDNEISSR                                      S01176
     C           *IN60     ANDNE'1'                                       E18335
     C           C1DI      ANDEQ'M'                                       E19832
     C*                                                                   S01176
     C* MOVE INFORMATION IN TO RECORD DEPENDING ON TRADE OR VALUE         S01176
     C*      DATE PROCESSING AND TRADE TYPES ETC.                         S01176
     C*                                                                   S01176
     C                     MOVE 'D'       RECI                            S01176
     C           *IN29     IFEQ '1'                                       S01176
     C                     MOVE 'T'       EVCD                            S01176
     C                     MOVE TDDT      EVDT                            S01176
     C                     END                                            S01176
     C           *IN30     IFEQ '1'                                       S01176
     C                     MOVE 'V'       EVCD                            S01176
     C                     MOVE TDVD      EVDT                            S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C                     MOVE SITP      INTP                            S01176
     C                     MOVE ' '       TRDT                            S01176
     C                     MOVE ' '       PFIN                            S01176
     C                     MOVE '  '      BKCD                            S01176
     C                     MOVE '  '      TRSB                            S01176
     C                     MOVE '  '      CCCD                            S01176
     C                     MOVE ' '       MKT                             S01176
     C                     MOVE 'FV'      AMTC                            S01176
     C*                                                                   S01176
     C***********CIAK      IFEQ 'Y'                                S01176 S01117
     C           BVCIAK    IFEQ 'Y'                                       S01117
     C           SCVI      ANDEQ'Y'                                       E19824
     C                     MOVE SCVI      CNVI                            S01176
     C                     ELSE                                           S01176
     C                     MOVE ' '       CNVI                            S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C                     MOVE TDRF      TRFR                            S01176
     C                     MOVE TCNR      CSTN                            S01176
     C***********          MOVE TDBR      BRCH                     S01176 S01117
     C                     MOVE TDBA      BRHA                            S01117
     C*                                                                   E19975
     C** Set up depot                                                     E19975
     C*                                                                   E19975
     C           TDTP      IFEQ 'TP'                                      E19975
     C                     MOVE DELT      KCUST                           E19975
     C                     END                                            E19975
     C           TDTP      IFEQ 'TS'                                      E19975
     C                     MOVE DELF      KCUST                           E19975
     C                     END                                            E19975
     C*                                                                   E19975
     C***********          Z-ADD1         ASQN                     S01176 E18803
     C                     Z-ADD0         ASQN                            E18803
     C                     Z-ADDNOML      SET                             S01176
     C                     EXSR NOMDEC                                    S01176
     C                     Z-ADDSET       EVAM                            S01176
     C                     MOVE NMCY      EVCY                            S01176
     C                     MOVE TDSS      SESH                            S01176
     C*                                                                   S01176
     C* REMAINING FIELDS SET TO BLANK/ZERO                                S01176
     C*                                                                   S01176
     C                     Z-ADD0         STLT                            S01176
     C                     MOVE *BLANK    STLA                            S01176
     C***********          Z-ADD0         ISSR                     S01176 E19975
     C***********          Z-ADD0         KCUST                    S01176 E19975
     C                     Z-ADD0         KNCA                            S01176
     C                     MOVE SNMCY     KCCY                            S01176
     C                     Z-ADD0         KBCA                            S01176
     C*  SAVE PORTFOLIO REFERENCE                                         S01486
     C                     MOVE *BLANK    PTFR                            S01486
     C                     MOVE *BLANK    SEBR                            S01117
     C*                                                                   S01176
     C                     ADD  1         KEYCNT  50                      S01176
      *                                                                   CAC002
      ** If Analytical Accounting is installed, define profit centre.     CAC002
      *                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
     C                     MOVE PRFC      WPRFC                           CAC002
     C                     MOVE BVSEPC    PRFC                            CAC002
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
      *                                                                                       CGL020
      ** Setup AML Fields                                                                     CGL020
      *                                                                                       CGL020
     C           CGL020    IFEQ 'Y'                                                           CGL020
      *                                                                                       CGL020
     C                     MOVE *BLANKS   F1RACT                                              CGL020
     C                     MOVE *BLANKS   F1RCTY                                              CGL020
     C                     MOVE *BLANKS   F1RBNK                                              CGL020
     C                     MOVE *BLANKS   F1RCDE                                              CGL020
     C                     MOVE *BLANKS   F1PACT                                              CGL020
     C                     MOVE *BLANKS   F1PCTY                                              CGL020
     C                     MOVE *BLANKS   F1PBNK                                              CGL020
     C                     MOVE *BLANKS   F1PCDE                                              CGL020
     C                     MOVE *BLANKS   F1DACT                                              CGL020
     C                     MOVE *BLANKS   F1DCTY                                              CGL020
     C                     MOVE *BLANKS   F1DBNK                                              CGL020
     C                     Z-ADD0         F1SDAT                                              CGL020
     C                     MOVE *BLANKS   F1TICK                                              CGL020
     C                     MOVE *BLANKS   F1EXCH                                              CGL020
     C                     Z-ADD0         F1NOML                                              CGL020
      *                                                                                       CGL020
     C                     ENDIF                                                              CGL020
      *                                                                                       CGL020
     C                     WRITESEKEYDF                                   S01176
      *                                                                   CAC002
     C           BGN0ST    IFEQ 'Y'                                       CAC002
     C                     MOVE WPRFC     PRFC                            CAC002
     C                     ENDIF                                          CAC002
      *                                                                   CAC002
     C*  REPLACE PORTFOLIO REFERENCE                                      S01486
     C*                                                                   S01176
     C* ADD EVENT AMOUNT INTO HASH TOTALS                                 S01176
     C*                                                                   S01176
     C                     Z-ADD1         Z                               S01176
     C                     Z-ADD1         S                               S01176
     C                     Z-ADDEVAM      ZZAMT                           S01176
     C                     EXSR ZHASH                                     S01176
     C*                                                                   S01176
     C* RESET FIELDS THAT GET CHANGED IN ACC AND ACCREV                   S01176
     C*                                                                   S01176
     C                     MOVE '  '      AMTC                            S01176
     C                     Z-ADD0         EVAM                            S01176
     C                     MOVE '   '     EVCY                            S01176
     C                     MOVE '0'       RVRS                            S01176
     C*                                                                   S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C                     ENDSR                                          S01176
      *                                                                   S01176
      *****************************************************************   S01176
      /EJECT
     C/COPY WNCPYSRC,SE2290C043
      *****************************************************************   S01269
      *                                                                   S01269
      * W05 - PROCESS:  write to trades awaiting telex file PF/TRATXD     S01269
      *       FOR EACH: action for which the telex is deferred            S01269
      *       WHEN:     called from P/TRADEP & P/TRADE                    S01269
      *                                                                   S01269
      *****************************************************************   S01269
      *                                                                   S01269
     C           W05       BEGSR                           ** W05 **      S01269
      *                                                                   S01269
     C           TRECI     IFEQ 'R'                                       S01269
     C           TOED      ANDLTRUND                                      S01269
     C           TDRF      CHAINSOBTRDF              17                   S01269
      *                                                                   S01269
     C           *IN17     IFEQ '1'                                       S01269
     C                     SETON                     U7U8LR               S01269
     C                     MOVE 'SOBTR'   DBFILE           ***************S01269
     C                     MOVELTDRF      DBKEY            * DB ERROR 23 *S01269
     C***********          MOVE '23'      DBASE            ********S01269 S01117
     C                     Z-ADD23        DBASE                    S01269 S01117
     C                     GOTO MEND                                      S01269
     C                     END                                            S01269
      *                                                                   S01269
     C                     END                                            S01269
      *                                                                   S01269
     C                     MOVEASTAMP,1   TMST             Default Timestamp                  CPK015
     C                     WRITETRATXDF                                   S01269
      *                                                                   S01269
     C                     ENDSR                                          S01269
      *                                                                   S01269
      *****************************************************************   S01269
      /EJECT                                                              S01269
      *****************************************************************
      *                                                               *
      * AUDIT - PERFORM THE RUN CONTROL PROCESSES                     *
      *                                                               *
      *****************************************************************
      *
     C           AUDIT     BEGSR                           ** AUDIT **
     C*
     C* CHECK FOR DATABASE ERRORS
     C*
     C           *INU7     IFEQ '0'
     C*
     C* CHECK FOR NO RECORDS ON FILE
     C*
     C           *IN20     IFEQ '0'
     C                     EXSR TITLE                                     S01117
     C                     EXSR DATARA                                    S01117
     C************         MOVE *BLANKS   DBLOT                           S01117
     C************         MOVEL'SE2290'  DBPGM                           S01117
     C************         EXSR ZSYSTM                                    S01117
     C************IN99     IFEQ '1'                                       S01117
     C************         SETON                     U7U8                 S01117
     C************         MOVE 'TABLE'   DBFILE                          S01117
     C************         MOVELZTABKY    DBKEY            ***************S01117
     C***********          MOVE '14'      DBASE            **DB ERROR 14**S01117
     C***********          END                             ***************S01117
     C*
     C* Write out blank audit records
     C*
     C                     Z-ADD*ZEROS    NORE
     C                     Z-ADD*ZEROS    NORT
     C                     Z-ADD*ZEROS    NRDT
     C***********          WRITESETLXAF                            E18209 S01271
     C                     WRITETRDACAF
     C                     WRITEASTACAF
     C                     WRITECDPMVAF
     C                     WRITEUDPMVAF
     C***********          WRITESETLXAF                            S01176 S01271
     C                     GOTO WRTAU
     C                     END
     C*
     C* READ TRADES FILE AUDIT RECORD AND CHECK LIVE RECORDS
     C*
     C                     READ TRADSAF                  12
     C           *IN12     IFEQ '1'
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRADS'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 15 *
     C***********          MOVE '15'      DBASE            ***************S01117
     C                     Z-ADD15        DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     END
     C*
     C* IF COUNTS AGREE OUTPUT AND UPDATE OTHER AUDIT RECORDS
     C*
     C           *INU8     IFEQ '0'
     C           NORE      SUB  DAUCNT    NORE
     C           SLRB      SUB  DAUCNT    SLRB
     C                     UPDATTRADSAF
     C                     Z-ADDKEYCNT    NORE
     C                     Z-ADDINT,1     HRWN
     C                     Z-ADDDEC,1     HRDC
     C                     WRITESEKEYAF
     C********             Z-ADDTXCNT     NORE                            S01271
     C********             WRITESETLXAF                                   S01271
     C                     Z-ADDTACNT     NORT
     C                     Z-ADDVACNT     NRDT
     C                     WRITETRDACAF
     C*
     C                     Z-ADDASTCNT    NORE
     C                     WRITEASTACAF
     C                     Z-ADDUDCNT     NORE
     C                     WRITEUDPMVAF
     C                     Z-ADDCDCNT     NORE
     C                     WRITECDPMVAF
     C*
     C                     Z-ADDCNCCNT    SLRB
     C                     Z-ADD*ZEROS    SINS
     C                     Z-ADD*ZEROS    SAMD
     C                     Z-ADD*ZEROS    SDEL
     C                     Z-ADD*ZEROS    TRDA
     C                     Z-ADDCNCCNT    NORE
     C                     WRITECNCTRAF
     C*
     C                     READ HSTTRAF                  14
     C           *IN14     IFEQ '1'
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'HSTTR'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 17 *
     C***********          MOVE '17'      DBASE            ***************S01117
     C                     Z-ADD17        DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     ADD  HSTCNT    SINS
     C                     ADD  HSTCNT    NORE
     C                     UPDATHSTTRAF
     C*
     C                     READ CLIABAF                  11
     C           *IN11     IFEQ '1'
     C                     SETON                     U7U8LR
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CLIAB'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 18 *
     C***********          MOVE '18'      DBASE            ***************S01117
     C                     Z-ADD18        DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE
     C                     Z-ADDNORE      ONORE   50
     C           NORE      SUB  CLBDEL    NORE
     C           NORE      ADD  CLBADD    NORE
     C                     Z-ADDNORE      NNORE   50
     C                     UPDATCLIABAF
     C*
     C                     END
     C                     END
     C                     END
     C*                                                                   S01176
     C** UPDATE AUTO SETTLEMENT TRAILER IF NO DB ERROR HAS OCCURRED       S01176
     C*                                                                   S01176
     C           *INU8     IFEQ '0'                                       S01176
     C*                                                                   S01176
     C                     READ SETLEAF                  14               S01176
     C           *IN14     IFEQ '1'                                       S01176
     C                     SETON                     U7U8LR               S01176
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'SETLE'   DBFILE           ***************S01176
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 20 *S01176
      *                                                    ***************S01117
     C***********          MOVE '20'      DBASE                    S01176 S01117
     C                     Z-ADD20        DBASE                    S01176 S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     ELSE                                           S01176
     C                     ADD  SETADD    NORE                            S01176
     C                     Z-ADDSETADD    SLRB                            S01176
     C                     UPDATSETLEAF                                   S01176
     C                     END                                            S01176
     C                     END                                            S01176
     C*                                                                   S01176
     C                     END
     C*
     C* WRITE OUT CONTROL REPORT
     C*
     C           WRTAU     TAG
     C*
     C                     WRITEHEADAU
     C**N20NU7***          WRITENONE                                      S01117
     C**NU7*20***          WRITECONTROL                                   S01117
     C**NU7*20***          WRITEHEADAU                                    S01117
     C**NU7*20***          WRITECONTRL2                                   S01117
     C  NU7                WRITECONTROL                                   S01117
     C  NU7                WRITEHEADAU                                    S01117
     C  NU7                WRITECONTRL2                                   S01117
     C   U7 U8             WRITEERRORAU
     C***********          WRITETRAILAU                                   S01117
     C   U7 U8             DUMP                                           S01117
     C/COPY WNCPYSRC,SE2290C035
     C*
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  NOMDEC- SUBROUTINE TO CONVERT AN AMOUNT FROM NOMINAL DEC PLS *
      *              TO NOMINAL CCY DEC PLS.                          *
      *                                                               *
      *****************************************************************
      *
     C           NOMDEC    BEGSR                           ** NOMDEC**
     C*
     C* OBTAIN DECIMAL PLACES FOR NOMINAL CURRENCY
     C*
     C***********          MOVEL'20      'TKEY   12                       S01117
     C***********          MOVELTNMC      ZWK4    4                       S01117
     C***********          MOVE 1         ZWK4                            S01117
     C***********          MOVE ZWK4      TKEY                            S01117
     C***********TKEY      CHAINTABTG10F             90                   S01117
     C                     CALL 'AOCURRR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM TNMC      @AJCD   3                       S01117
     C           SDCURR    PARM SDCURR    DSSDY                           S01117
     C*                                                                   S01117
     C**N90******RECI      COMP 'D'                  9090                 S01117
     C************IN90     IFEQ '1'                                       S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C                     SETON                     U7U8LR
     C***********          MOVE 'TABLE'   DBFILE           ***************S01117
     C***********          MOVELTKEY      DBKEY            * DB ERROR 19 *S01117
     C************         MOVE '19'      DBASE            ***************S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDCURRPD'DBFILE           ***************S01117
     C                     MOVE @AJCD     DBKEY            * DB ERROR 19 *S01117
     C                     MOVE @OPTN     DBOPTN           ***************S01117
     C                     Z-ADD19        DBASE                           S01117
     C                     OUT  LDA                                       S01117
     C                     DUMP                                           S01117
     C                     GOTO ENOMDC
     C                     END
     C*
     C***********CDP       SUB  TNMD      ZI      10                      S01117
     C           A6NBDP    SUB  TNMD      ZI      10                      S01117
     C           ZI        ADD  5         ZI
     C           SET       MULT POWER8,ZI SET       H
     C*
     C           ENOMDC    ENDSR
      *
      *****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   TRDSR  - SUBROUTINE FOR ERROR HANDLING OF TRADES FILE       *
     C*                                                               *
     C*****************************************************************
     C*
     C           TRDSR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRDBR'   DBFILE           ***************
     C                     MOVELTDRF      DBKEY            * DB ERROR 80 *
     C***********          MOVE '80'      DBASE            ***************S01117
     C                     Z-ADD80        DBASE                           S01117
     C                     MOVE STSTRD    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   CLBSR  - SUBROUTINE FOR ERROR HANDLING OF CONTINGENT        *
     C*            LIABILITIES FILE                                   *
     C*                                                               *
     C*****************************************************************
     C*
     C           CLBSR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CLBTR'   DBFILE           ***************
     C                     MOVELTDRF      DBKEY            * DB ERROR 81 *
     C***********          MOVE '81'      DBASE            ***************S01117
     C                     Z-ADD81        DBASE                           S01117
     C                     MOVE STSCLB    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   CLASR  - SUBROUTINE FOR ERROR HANDLING OF CONTINGENT        *
     C*            LIABILITIES AUDIT RECORD                           *
     C*                                                               *
     C*****************************************************************
     C*
     C           CLASR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CLIAB'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 82 *
     C***********          MOVE '82'      DBASE            ***************S01117
     C                     Z-ADD82        DBASE                           S01117
     C                     MOVE STSCLA    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   TACSR  - SUBROUTINE FOR ERROR HANDLING OF TRADE ACTIONS FILE*
     C*                                                               *
     C*****************************************************************
     C*
     C           TACSR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRDAC'   DBFILE           ***************
     C                     MOVELTDRF      DBKEY            * DB ERROR 83 *
     C***********          MOVE '83'      DBASE            ***************S01117
     C                     Z-ADD83        DBASE                           S01117
     C                     MOVE STSTAC    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   TAASR  - SUBROUTINE FOR ERROR HANDLING OF TRADE ACTIONS     *
     C*               AUDIT RECORD                                    *
     C*                                                               *
     C*****************************************************************
     C*
     C           TAASR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRDAC'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 84 *
     C***********          MOVE '84'      DBASE            ***************S01117
     C                     Z-ADD84        DBASE                           S01117
     C                     MOVE STSTAA    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   SKYSR  - SUBROUTINE FOR ERROR HANDLING OF ACCOUNT KEYS FILE *
     C*                                                               *
     C*****************************************************************
     C*
     C           SKYSR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'SEKEY'   DBFILE           ***************
     C                     MOVELACKY      DBKEY            * DB ERROR 85 *
     C***********          MOVE '85'      DBASE            ***************S01117
     C                     Z-ADD85        DBASE                           S01117
     C                     MOVE STSSKY    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   SKASR  - SUBROUTINE FOR ERROR HANDLING OF ACCOUNT KEYS      *
     C*                AUDIT RECORD                                   *
     C*                                                               *
     C*****************************************************************
     C*
     C           SKASR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'SEKEY'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 86 *
     C***********          MOVE '86'      DBASE            ***************S01117
     C                     Z-ADD86        DBASE                           S01117
     C                     MOVE STSSKA    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                                   S01271
     C****SLXSR**-*SUBROUTINE*FOR*ERROR*HANDLING*OF*TELEX*EXTRACT*FILE**  S01271
     C**********                                                          S01271
     C********** SLXSR     BEGSR                                          S01271
     C**********                                                          S01271
     C**********           MOVE 'SETLX'   DBFILE                          S01271
     C**********           MOVELTDRF      DBKEY                           S01271
     C**********           MOVE '87'      DBASE                           S01271
     C**********           MOVE STSSLX    DBSTAT                          S01271
     C**********           MOVE '1'       *IN87                           S01271
     C**********           SETON                     LRU7U8               S01271
     C**********           GOTO MEND                                      S01271
     C**********                                                          S01271
     C**********           ENDSR                                          S01271
     C**********                                                          S01271
     C*****************************************************************   S01271
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*********                                                           S01271
     C****SLASR**-*SUBROUTINE*FOR*ERROR*HANDLING*OF*TELEX*EXTRACT****  R  S01271
     C****************AUDIT*RECORD****                                    S01271
     C*********                                                           S01271
     C*********  SLASR     BEGSR                                          S01271
     C*********                                                           S01271
     C*********            MOVE 'SETLX'   DBFILE                          S01271
     C*********            MOVEL'AUDIT'   DBKEY                           S01271
     C*********            MOVE '88'      DBASE                           S01271
     C*********            MOVE STSSLA    DBSTAT                          S01271
     C*********            MOVE '1'       *IN87                           S01271
     C*********            SETON                     LRU7U8               S01271
     C*********            GOTO MEND                                      S01271
     C*********                                                           S01271
     C*********            ENDSR                                          S01271
     C*********                                                           S01271
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   CNCSR  - SUBROUTINE FOR ERROR HANDLING OF CANCELLED TRADES  *
     C*                FILE                                           *
     C*                                                               *
     C*****************************************************************
     C*
     C           CNCSR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CNCTR'   DBFILE           ***************
     C                     MOVELTDRF      DBKEY            * DB ERROR 89 *
     C***********          MOVE '89'      DBASE            ***************S01117
     C                     Z-ADD89        DBASE                           S01117
     C                     MOVE STSCNC    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   CNASR  - SUBROUTINE FOR ERROR HANDLING OF CANCELLED TRADES  *
     C*               AUDIT RECORD                                    *
     C*                                                               *
     C*****************************************************************
     C*
     C           CNASR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CNCTR'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 90 *
     C***********          MOVE '90'      DBASE            ***************S01117
     C                     Z-ADD90        DBASE                           S01117
     C                     MOVE STSCNA    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   HSTSR  - SUBROUTINE FOR ERROR HANDLING OF HISTORIC TRADES   *
     C*               FILE                                            *
     C*                                                               *
     C*****************************************************************
     C*
     C           HSTSR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'HSTTR'   DBFILE           ***************
     C                     MOVELTDRF      DBKEY            * DB ERROR 91 *
     C***********          MOVE '91'      DBASE            ***************S01117
     C                     Z-ADD91        DBASE                           S01117
     C                     MOVE STSHST    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   HSASR  - SUBROUTINE FOR ERROR HANDLING OF HISTORIC TRADES   *
     C*               AUDIT RECORD                                    *
     C*                                                               *
     C*****************************************************************
     C*
     C           HSASR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'HSTTR'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 92 *
     C***********          MOVE '92'      DBASE            ***************S01117
     C                     Z-ADD92        DBASE                           S01117
     C                     MOVE STSHSA    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   ASTSR  - SUBROUTINE FOR ERROR HANDLING OF AUTOMATIC SETTLE -*
     C*               MENT ACTIONS FILE                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           ASTSR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'ASTAC'   DBFILE           ***************
     C                     MOVELTDRF      DBKEY            * DB ERROR 93 *
     C***********          MOVE '93'      DBASE            ***************S01117
     C                     Z-ADD93        DBASE                           S01117
     C                     MOVE STSAST    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   ASASR  - SUBROUTINE FOR ERROR HANDLING OF AUTOMATIC SETTLE -*
     C*               MENT ACTIONS AUDIT RECORD                       *
     C*                                                               *
     C*****************************************************************
     C*
     C           ASASR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'ASTAC'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 94 *
     C***********          MOVE '94'      DBASE            ***************S01117
     C                     Z-ADD94        DBASE                           S01117
     C                     MOVE STSASA    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   UDPSR  - SUBROUTINE FOR ERROR HANDLING OF USER DEPOT        *
     C*            MOVEMENT FILE                                      *
     C*                                                               *
     C*****************************************************************
     C*
     C           UDPSR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'UDPMV'   DBFILE           ***************
     C                     MOVELTDSS      DBKEY            * DB ERROR 95 *
     C***********          MOVE '95'      DBASE            ***************S01117
     C                     Z-ADD95        DBASE                           S01117
     C                     MOVE STSUDP    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   UDASR  - SUBROUTINE FOR ERROR HANDLING OF USER DEPOT        *
     C*            MOVEMENT AUDIT RECORD                              *
     C*                                                               *
     C*****************************************************************
     C*
     C           UDASR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'UDPMV'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 96 *
     C***********          MOVE '96'      DBASE            ***************S01117
     C                     Z-ADD96        DBASE                           S01117
     C                     MOVE STSUDA    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   CDPSR  - SUBROUTINE FOR ERROR HANDLING OF CUSTOMER DEPOT    *
     C*               MOVEMENTS FILE                                  *
     C*                                                               *
     C*****************************************************************
     C*
     C           CDPSR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CDPMV'   DBFILE           ***************
     C                     MOVELTDSS      DBKEY            * DB ERROR 97 *
     C**********           MOVE '97'      DBASE            ***************S01117
     C                     Z-ADD97        DBASE                           S01117
     C                     MOVE STSCDP    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   CDASR  - SUBROUTINE FOR ERROR HANDLING OF CUSTOMER DEPOT    *
     C*               MOVEMENTS AUDIT RECORD                          *
     C*                                                               *
     C*****************************************************************
     C*
     C           CDASR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'CDPMV'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 98 *
     C***********          MOVE '98'      DBASE            ***************S01117
     C                     Z-ADD98        DBASE                           S01117
     C                     MOVE STSCDA    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*   TRASR  - SUBROUTINE FOR ERROR HANDLING OF TRADES FILE AUDIT *
     C*                                                               *
     C*****************************************************************
     C*
     C           TRASR     BEGSR
     C*
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE 'TRADS'   DBFILE           ***************
     C                     MOVEL'AUDIT'   DBKEY            * DB ERROR 99 *
     C***********          MOVE '99'      DBASE            ***************S01117
     C                     Z-ADD99        DBASE                           S01117
     C                     MOVE STSTRA    DBSTAT
     C                     OUT  LDA                                       S01117
     C                     MOVE '1'       *IN87
     C                     SETON                     LRU7U8
     C                     DUMP                                           S01117
     C                     GOTO MEND
     C*
     C                     ENDSR
     C*
      *****************************************************************                       CGL031
      /SPACE 3                                                                                CGL031
      *****************************************************************                       CGL031
      *                                                               *                       CGL031
      * SRETAX - Retrieve Tax Amount                                  *                       CGL031
      *                                                               *                       CGL031
      *****************************************************************                       CGL031
     C           SRETAX    BEGSR                                                              CGL031
      *                                                                                       CGL031
     C**********           Z-ADDRUND      WGDAT                                        CGL031 234844
     C                     MOVE 'S'       WMODI                                               CGL031
     C                     MOVE TDRF      WTRNO                                               CGL031
      *                                                                                       CGL031
     C                     Z-ADD*ZEROS    WXEVAM 150                                          CGL031
     C                     Z-ADD*ZEROS    WIEVAM 150                                          CGL031
     C                     Z-ADD*ZEROS    WKEVAM 150                                          235174
     C                     Z-ADD*ZEROS    WXKNCA 150                                          CGL031
     C                     Z-ADD*ZEROS    WIKNCA 150                                          CGL031
     C                     Z-ADD*ZEROS    WXKBCA 150                                          CGL031
     C                     Z-ADD*ZEROS    WIKBCA 150                                          CGL031
      *                                                                                       CGL031
     C********** KCSIN     SETLLSDCSINL6                                               CGL031 234844
     C********** KCSIN     READESDCSINL6                 27                            CGL031 234844
     C           KCSIN     SETLLSDCSINLD                                                      234844
     C           KCSIN     READESDCSINLD                 27                                   234844
      *                                                                                       CGL031
     C           *IN27     DOWEQ*OFF                                                          CGL031
      *                                                                                       CGL031
     C           TSSTAT    IFEQ 'T'                                                           CGL031
      *                                                                                       CGL031
     C           TSSCCY    IFEQ TSTXCY                                                        CGL031
     C                     ADD  TSTXSS    WXEVAM                                              CGL031
     C                     ADD  TSNINS    WIEVAM                                              CGL031
     C                     Z-ADDTSTXSS    WKEVAM                                              235174
     C                     ELSE                                                               CGL031
     C                     ADD  TSTXSC    WXEVAM                                              CGL031
     C                     ADD  TSNINC    WIEVAM                                              CGL031
     C                     Z-ADDTSTXSC    WKEVAM                                              235174
     C                     ENDIF                                                              CGL031
      *                                                                                       CGL031
     C                     MOVE TSTXCY    WEVCY   3                                           CGL031
     C                     ADD  TSTXSS    WXKNCA                                              CGL031
     C                     ADD  TSNINS    WIKNCA                                              CGL031
      *                                                                                       CGL031
     C                     MOVE TSSCCY    WKCCY   3                                           CGL031
     C                     ADD  TSTXSB    WXKBCA                                              CGL031
     C                     ADD  TSNINB    WIKBCA                                              CGL031
      *                                                                                       235174
      ** Generate EU a/c keys for tax amount.                                                 235174
      *                                                                                       235174
     C                     EXSR SREAET                                                        235174
      *                                                                                       CGL031
     C                     ENDIF                                                              CGL031
      *                                                                                       CGL031
     C********** KCSIN     READESDCSINL6                 27                            CGL031 234844
     C           KCSIN     READESDCSINLD                 27                                   234844
     C                     ENDDO                                                              CGL031
      *                                                                                       CGL031
     C                     ENDSR                                                              CGL031
      *****************************************************************                       236063
      /EJECT                                                                                  236063
      *****************************************************************                       236063
      *                                                               *                       236063
      * SRGNRV - DETERMINE WHETHER TO GENERATE REVERSALS.             *                       236063
      *                                                               *                       236063
      *****************************************************************                       236063
     C           SRGNRV    BEGSR                                                              236063
      *                                                                                       236063
      *  SETUP KEY FOR SDCSINLD.                                                              236063
     C                     MOVE 'S'       WMODI                                               236063
     C                     MOVE TDRF      WTRNO                                               236063
      *                                                                                       236063
     C           KCSIN     SETLLSDCSINLD                 27                                   236063
      *  IF RECORD FOUND ON SDCSINLD OR TRADSD.WKRECI<>'C' THEN DO NOT GENERATE REVERSALS.    236063
      *                                                                                       236063
     C                     SELEC                                                              236063
     C           *IN27     WHEQ *ON                                                           236063
     C                     MOVE 'N'       WKGNRV                                              236063
      *                                                                                       236063
     C           *IN27     WHEQ *OFF                                                          236063
     C           WKRECI    ANDNE'C'                                                           236063
     C                     MOVE 'N'       WKGNRV                                              236063
      *                                                                                       236063
     C                     OTHER                                                              236063
     C                     MOVE 'Y'       WKGNRV                                              236063
     C                     ENDSL                                                              236063
      *                                                                                       236063
     C                     ENDSR                                                              236063
      *                                                                                       236063
      *                                                                                       236063
      *****************************************************************                       235615
      /EJECT                                                                                  235615
      *****************************************************************                       235615
      *                                                               *                       235615
      * SRETXR - Retrieve Tax Amount for Reversal from SOB file       *                       235615
      *                                                               *                       235615
      *****************************************************************                       235615
     C           SRETXR    BEGSR                                                              235615
      *                                                                                       235615
     C                     MOVE 'S'       WMODI                                               235615
     C                     MOVE TDRF      WTRNO                                               235615
      *                                                                                       235615
     C                     Z-ADD*ZEROS    WXEVAM                                              235615
     C                     Z-ADD*ZEROS    WIEVAM                                              235615
     C                     Z-ADD*ZEROS    WKEVAM                                              235615
     C                     Z-ADD*ZEROS    WXKNCA                                              235615
     C                     Z-ADD*ZEROS    WIKNCA                                              235615
     C                     Z-ADD*ZEROS    WXKBCA                                              235615
     C                     Z-ADD*ZEROS    WIKBCA                                              235615
      *                                                                                       235615
     C           KCSIN     SETLLSOBCINLD                                                      235615
     C           KCSIN     READESOBCINLD                 27                                   235615
      *                                                                                       235615
     C           *IN27     DOWEQ*OFF                                                          235615
      *                                                                                       235615
     C           TSSTAT    IFEQ 'T'                                                           235615
      *                                                                                       235615
     C           TSSCCY    IFEQ TSTXCY                                                        235615
     C                     ADD  TSTXSS    WXEVAM                                              235615
     C                     ADD  TSNINS    WIEVAM                                              235615
     C                     Z-ADDTSTXSS    WKEVAM                                              235615
     C                     ELSE                                                               235615
     C                     ADD  TSTXSC    WXEVAM                                              235615
     C                     ADD  TSNINC    WIEVAM                                              235615
     C                     Z-ADDTSTXSC    WKEVAM                                              235615
     C                     ENDIF                                                              235615
      *                                                                                       235615
     C                     MOVE TSTXCY    WEVCY                                               235615
     C                     ADD  TSTXSS    WXKNCA                                              235615
     C                     ADD  TSNINS    WIKNCA                                              235615
      *                                                                                       235615
     C                     MOVE TSSCCY    WKCCY                                               235615
     C                     ADD  TSTXSB    WXKBCA                                              235615
     C                     ADD  TSNINB    WIKBCA                                              235615
      *                                                                                       235615
      ** Generate EU a/c keys for tax amount reversal.                                        235615
      *                                                                                       235615
     C                     MOVELRVRS      SVRVRS                                              235615
     C                     MOVEL'1'       RVRS                                                235615
     C                     EXSR SREAET                                                        235615
     C                     MOVELSVRVRS    RVRS                                                235615
      *                                                                                       235615
     C                     ENDIF                                                              235615
      *                                                                                       235615
     C           KCSIN     READESOBCINLD                 27                                   235615
     C                     ENDDO                                                              235615
      *                                                                                       235615
     C                     ENDSR                                                              235615
      *****************************************************************                       235174
      /EJECT                                                                                  235174
      *****************************************************************                       235174
      *                                                               *                       235174
      *  SREAET - EU a/c key generation for tax amount.               *                       235174
      *                                                               *                       235174
      *****************************************************************                       235174
     C           SREAET    BEGSR                                                              235174
      *                                                                                       235174
     C           WKEVAM    IFGT *ZERO                                                         235174
     C                     MOVE *BLANK    CCCD                                                235174
     C                     MOVE TSRCTR    CTTX                                                235174
     C                     MOVE 'ET'      AMTC                                                235174
     C                     Z-ADDWKEVAM    EVAM                                                235174
     C                     MOVE TSTXCY    EVCY                                                235174
     C********** TSSCCY    IFEQ TSTXCY                                                 235751 235615
     C**********           Z-ADDTSTXSS    KNCA                                         235174 235615
     C                     Z-ADDTSTXSR    KNCA                                                235615
     C**********           ELSE                                                        235751 235615
     C**********           Z-ADDTSTXSC    KNCA                                         235751 235615
     C**********           ENDIF                                                       235751 235615
     C                     MOVE TSSCCY    KCCY                                                235174
     C                     Z-ADDTSTXSB    KBCA                                                235174
     C                     EXSR W01                                                           235174
     C                     ENDIF                                                              235174
      *                                                                                       235174
     C                     ENDSR                                                              235174
     C*****************************************************************
      /EJECT
      *****************************************************************   S01117
      *                                                               *   S01117
      *  TITLE - Subroutine to extract title from AOBANKR0            *   S01117
      *                                                               *   S01117
      *  Called by: Main program                                      *   S01117
      *             AUDIT                                             *   S01117
      *                                                               *   S01117
      *  Calls: None                                                  *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
      *                                                                   S01117
     C           TITLE     BEGSR                                          S01117
     C                     CALL 'AOBANKR0'                                S01117
     C                     PARM '*MSG   ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDBANK    PARM SDBANK    DSFDY                           S01117
      *                                                                   S01117
     C           @RTCD     IFNE *BLANK                                    S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL'SDBANKPD'DBFILE                          S01117
     C                     MOVEL@OPTN     DBKEY            ***************S01117
     C                     MOVEL@OPTN     DBOPTN  7        * DB ERROR 11 *S01117
     C                     Z-ADD77        DBASE            ***************S01117
     C                     OUT  LDA                                       S01117
     C                     SETON                     U7U8LR               S01117
     C                     WRITEHEADAU                                    S01117
     C                     WRITEERRORAU                                   S01117
     C                     DUMP                                           S01117
     C                     RETRN                                          S01117
     C                     END                                            S01117
     C/COPY WNCPYSRC,SE2290C036
     C                     ENDSR                                          S01117
      *                                                                   S01117
      *****************************************************************   S01117
      /EJECT                                                              S01117
      *****************************************************************   S01117
      *                                                               *   S01117
      *  DATARA - Subroutine to input data area                       *   S01117
      *                                                               *   S01117
      *  Called by: Main program                                      *   S01117
      *             AUDIT                                             *   S01117
      *                                                               *   S01117
      *  Calls: None                                                  *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
     C           DATARA    BEGSR                                          S01117
      *                                                                   S01117
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVEL*BLANK    DBLOT                           S01117
     C                     MOVEL'SE2290'  DBPGM                           S01117
     C                     OUT  LDA                                       S01117
      *                                                                   S01117
      ** Read in the data area RUNDAT                                     S01117
      *                                                                   S01117
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
     C                     IN   RUNDT                                     S01117
      *                                                                   S01117
      ** Check data format                                                S01117
      *                                                                   S01117
     C           DATF      IFEQ 'M'                                       S01117
     C                     MOVE '1'       *IN98                           S01117
     C                     ELSE                                           S01117
     C                     MOVE '0'       *IN98                           S01117
     C                     END                                            S01117
     C/COPY WNCPYSRC,SE2290C081
      *                                                                   S01117
     C                     ENDSR                                          S01117
      *****************************************************************   CSE039
      /EJECT                                                              CSE039
      *****************************************************************   CSE039
      *                                                               *   CSE039
      *  SRSEMV - SUBROUTINE TO WRITE RECORD TO PF/SEMVTSPD           *   CSE039
      *                                                               *   CSE039
      *****************************************************************   CSE039
      *                                                                   CSE039
     C           SRSEMV    BEGSR                                          CSE039
      *                                                                   CSE039
      ** Check if record exists (Reference, Type, Notification)           CSE039
     C                     MOVELTDRF      KTDRF                           CSE039
     C                     MOVEL'T'       KTRTY                           CSE039
     C                     Z-ADDRUND      KNTDT                           CSE039
     C                     Z-ADD0         USQNR   30                      CSE039
      *                                                                   CSE039
      ** Get Sequence Number                                              CSE039
     C           KSEMV     SETLLSEMVTSL1                                  CSE039
     C                     READ SEMVTSL1                 65               CSE039
     C           *IN65     IFEQ *OFF                                      CSE039
     C           KTDRF     ANDEQTMTRRF                                    CSE039
     C           KTRTY     ANDEQTMTRTY                                    CSE039
     C           KNTDT     ANDEQTMNTDT                                    CSE039
     C                     Z-ADDTMSQNR    USQNR                           CSE039
     C                     ENDIF                                          CSE039
      *                                                                   CSE039
      ** Write details to PF/SEMVTSPD                                     CSE039
     C                     MOVELTDRF      TMTRRF                          CSE039
     C                     MOVEL'T'       TMTRTY                          CSE039
     C                     Z-ADDRUND      TMNTDT                          CSE039
     C           USQNR     ADD  1         TMSQNR                          CSE039
     C                     MOVEL'SET'     TMSWSC                          CSE039
     C                     MOVEL*BLANKS   TMSWRC                          CSE039
     C                     MOVEL*BLANKS   TMNTMT                          CSE039
     C                     MOVEL*BLANKS   TMLCUS                          CSE039
     C                     MOVEL'MIDAS'   TMINOR                          CSE039
     C                     MOVEL*BLANKS   TMMSGK                          CSE039
      *                                                                   CSE039
      ** Set "Settlement Message Generated" as follow:                    CSE039
      ** Check "Settlement Advice Required" in SDSECSPD using TCNR        CSE039
      ** and if = 'Y', set TMSTMG to 'Y', if not set TMSTMG to 'N'        CSE039
     C                     MOVE TCNR      @AENB                           CSE039
     C                     CALL 'AOSECSR0'                                CSE039
     C                     PARM *BLANKS   @RTCD                           CSE039
     C                     PARM '*KEY   ' @OPTN                           CSE039
     C                     PARM           @AENB   6                       CSE039
     C           SDSECS    PARM SDSECS    DSSDY                           CSE039
     C           @RTCD     IFNE *BLANKS                                   CSE039
      *                                                                   CSE039
     C           BFSARQ    IFEQ 'Y'                                       CSE039
     C                     MOVEL'Y'       TMSTMG                          CSE039
     C                     ELSE                                           CSE039
     C                     MOVEL'N'       TMSTMG                          CSE039
     C                     ENDIF                                          CSE039
      *                                                                   CSE039
     C                     ELSE                                           CSE039
     C                     MOVEL'N'       TMSTMG                          CSE039
     C                     ENDIF                                          CSE039
      *                                                                   CSE039
     C                     MOVELNARR,1    TMNARR                          CSE039
     C                     MOVEL'I'       TMLCTP                          CSE039
     C                     Z-ADDRUND      TMLCDT                          CSE039
     C                     MOVELTMMP,1    TMTMST                          CSE039
     C                     MOVELTDBA      TMTRBB                          CSE039
      *                                                                   CSE039
     C                     WRITESEMVTSUP                                  CSE039
      *                                                                   CSE039
     C                     ENDSR                                          CSE039
      *                                                                   CSE039
      *****************************************************************   S01117
      /EJECT                                                              S01117
      *****************************************************************   S01117
      *                                                               *   S01117
      *  *PSSR  - Error control subroutine                            *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
      *                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR **    S01117
     C**                                                                  S01117
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
     C**                                                                  S01117
     C                     ENDSR                                          S01117
      *                                                                   S01117
     C*****************************************************************
     C/COPY WNCPYSRC,SE2290C037
      /EJECT
     C/COPY ZSRSRC,ZCONPRZ1
      /EJECT
     C/COPY ZSRSRC,ZCONVZ1
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z4
      /EJECT
     C/COPY ZSRSRC,ZDAYSZ2
      /EJECT
     C/COPY ZSRSRC,ZDYYRZ3
      /EJECT
     C/COPY ZSRSRC,ZEVCDZ1
      /EJECT
     C/COPY ZSRSRC,ZHASHZ3
     C*EJECT******************                                            S01117
     C*COPY*ZSRSRC,ZICD2Z1****                                            S01117
     C*EJECT******************                                            S01117
     C*COPY*ZSRSRC,ZICDSEZ1***                                            S01117
      /EJECT
     C/COPY ZSRSRC,ZNCDZ3
      /EJECT
     C/COPY ZSRSRC,ZLCDZ1                                                 100228
      /EJECT                                                              100228
     C***/COPY*ZSRSRC*ZSYSTMZ1                                            S01117
     C/COPY WNCPYSRC,SE2290C044
      /EJECT
      ***
**  NAR                                                                   S01176
AUTO-SETTLEMENT                                                           S01176
**  CPY@
(c) Finastra International Limited 2001
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  POWER8 - ARRAY OF POWERS FOR NOMINAL CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** STAMP - Dummy timestamp                                                                    CPK015
0001-01-01-00.00.00.000000                                                                    CPK015
**  NARR  - Array of Narratives
Automatic Settlement by Midas
**  TMMP  - Array of TIMESTAMP
0001-01-01-00.00.00.000000
