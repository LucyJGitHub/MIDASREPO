000100200529     H        1
000200200529      *****************************************************************
000300200529/*STD *  RPGBASE                                                      *
000400200529/*EXI *  TEXT('Midas SE Update customer average prices')
000500200529     F*****************************************************************
000600200529     F*                                                               *
000700200529     F*  Midas - Securities Trading Module
000800200529     F*                                                               *
000900200529     F*  SE2410  - UPDATE CUSTOMER AVERAGE PRICES                     *
001000200529     F*                                                               *
001100200529     F*  Function: PF/CAPRHD records are read.  For each customer     *
001200200529     F*   (COB)    position, the nominal and average price from the   *
001300200529     F*            position record on PF/CPOSND with a position date  *
001400200529     F*            immediately prior to the earliest PF/CAPRHD record *
001500200529     F*            for re-actioning are recovered to be used as       *
001600200529     F*            starting point for all average price calculations. *
001700200529     F*            As the PF/CAPRHD records are read in, the          *
001800200529     F*            average price on each position date is determined. *
001900200529     F*            This average price is then put onto the appropriate*
002000200529     F*            position record on PF/CPOSND. (The average price   *
002100200529     F*            numerator for trade and value date basis is        *
002200200529     F*            written to PF/CPOSND.)                             *
002300200529     F*            Once each record on PF/CAPRHD has been dealt with  *
002400200529     F*            the record ID is set to 'H'.  PF/CAPRHD is a       *
002500200529     F*            permanent file.                                    *
002600200529     F*                                                               *
002700200529     F*  Called by: SEC0606H - Update Customer Average Prices         *
002800200529     F*                                                               *
002900200529      *  (c) Finastra International Limited 2001                      *
003000200529     F*                                                               *
003100200604     F*  Last Amend No. MD051140           Date 22May20               *
003200200604     F*  PREV Amend No. MD051140           Date 22May20               *
003300200604     F*                 262503             Date 22May20               *
003400200604     F*                 252945             Date 22May20               *
003500200604      *                 MD046248           Date 27Oct17               *
003600200529      * Bank Fusion Midas 1.4 Base -----------------------------------*
003700200529      * Midas Plus 1.4 Base 04 ---------------------------------------*
003800200529      *                 BUG13389           Date 19Feb07               *
003900200529      * Midas Plus 1.3 ----------- Base ------------------------------*
004000200529      *                 207777             Date 13Oct06               *
004100200529      *                 CSD027             Date 09Dec05               *
004200200529      *                 234440             Date 26Jun05               *
004300200529      *                 233705             Date 25May05               *
004400200529      *                 233615             Date 16May05               *
004500200529      *                 CSE071             Date 19Jul05               *
004600200529      *                 222727             Date 05Nov03               *
004700200529      * Midas Release 4 --------------- Base -------------------------*
004800200529      *                 186555             Date 15May01               *
004900200529      * Midas DBA 3.02 -----------------------------------------------*
005000200529      *                 CSE015             Date 06Dec99               *
005100200529      *                 CSE017             Date 20Oct99               *
005200200529      *                 CSE012             Date 16Aug99               *
005300200529     F*                 CPB001             DATE 12Aug99               *
005400200529      * Midas DBA 3.00 ---------------- Base -------------------------*
005500200529     F*                 S01486 RS          DATE 28OCT94               *
005600200529     F*                 S01445             DATE 04NOV93               *
005700200529     F*                 052254             DATE 10JAN94               *
005800200529     F*                 S01401             DATE 16JUN93               *
005900200529     F*                 S01397             DATE 10SEP92               *
006000200529     F*                 E36711             DATE 04MAR92               *
006100200529     F*                 E36685             DATE 04MAR92               *
006200200529     F*                 E32674             DATE 03DEC91               *
006300200529     F*                 E24337             DATE 01OCT91               *
006400200529     F*                 S01220             DATE 12NOV90               *
006500200529     F*                 S01117             DATE 02NOV90               *
006600200529     F*                 S01271             DATE 19OCT90               *
006700200529     F*                 E20651             DATE 30JAN90               *
006800200529     F*                 E16849             DATE 08/02/89              *
006900200529     F*                 E15996             DATE 03/11/88              *
007000200529     F*                 E14838             DATE 02/11/88              *
007100200529     F*                 E15509             DATE 06/10/88              *
007200200529     F*                 E15508             DATE 05/10/88              *
007300200529     F*                 E14010             DATE 22/09/88              *
007400200529     F*                 E13561             DATE 21/06/88              *
007500200529     F*                 S01158             DATE 18/05/88              *
007600200529     F*                                                               *
007700200529     F*---------------------------------------------------------------*
007800200529     F*                                                               *
007900200529      *  MD051140 - Average Price Discrepancy on Client Statement     *
008000200529      *             Fix is to add half-adjust extender on the work    *
008100200529      *             fields after recalculation of average price       *
008200200529      *             numerator under SR/TRADE.                         *
008300200529      *  262503 - Incorrect update on AP numerator during COB causing *
008400200529      *           incorrect average price to be displayed on enquiry. *
008500200529      *  252945 - Average Price is inconsistent between TOF and Midas.*
008600200529      *           Check if there is an extra position record between  *
008700200529      *           the trade and value date of a trade and update the  *
008800200529      *           AP numerator if there is.                           *
008900200529      *  MD046248 - Finastra Rebranding                               *
009000200529      *  BUG13389 - File controls imbalance. AppliEd fix for 235134.  *
009100200529      *  207777 - Records changed with RECI ='C' are not considered.  *
009200200529      *  CSD027 - Conversion Of Customer Number to Alpha              *
009300200529      *  234440 - Purchase Interest management in real time           *
009400200529      *  233705 - Update of RECI on CAPRHD                            *
009500200529      *  233615 - Takeon programs for CGL031 (Recompile)              *
009600200529      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
009700200529      *  222727 - Release 5.0 errors  (Recompile)                     *
009800200529      *  186555   Incorrect rounding of countervalue during a Name    *
009900200529      *           Change of Security. Average Price computed without  *
010000200529      *           half adjust. Add H for half adjust in computation.  *
010100200529      *  CSE015 - Forward Valued Depot Movements (Recompile)          *
010200200529      *  CSE017 - Cum/Ex Indicator on Depot Movements (Recompile)     *
010300200529      *  CSE012 - SE Depot Movement Narratives (Recompiled).          *
010400200529     F*  CPB001 - 'Private Banking' Module                            *
010500200529     F*  S01486 - PORTFOLIO MANAGEMENT ENHANCEMENT                    *  *
010600200529     F*  S01445 - DEPOT MOVEMENT CHARGES ENHANCEMENT.                 *
010700200529     F*           Recompiled due to changes in PF/DPTMVD.             *
010800200529     F*  052254 - RECOMPILED as CURRENT FACTOR amended from 9,8       *
010900200529     F*           to 10,9                                             *
011000200529     F*  S01401 - MT5xx SWIFT Messages Feature:                       *
011100200529     F*          - Recompiled due to changes to files.                *
011200200529     F*  S01397 - Rel 10 Incorporation of BNZ SARs A46008 and A46013. *
011300200529     F*          - Recompiled due to changes to files.                *
011400200529     F*  E36771 - Value date average price is 100 times too much      *
011500200529     F*  E36685 - Average price is zero due to change of value date of*
011600200529     F*           a trade newly entered today on a new position.      *
011700200529     F*  E32674 - Recompiled due to error in DPTMVD                   *
011800200529     F*  E24337 - Set average price to zero if nominal positon is zero*
011900200529     F*  S01220 - STRATEGIC RISK MANAGEMENT                           *
012000200529     F*           Recompiled over changed PF/SECTYD, PF/SEDEVD        *
012100200529     F*  S01117 - Multi-Branching                                     *
012200200529     F*  S01271 - Recompiled for Pay/Receive in Input Cycle changes   *
012300200529     F*           to TRADSD and/or DPTMVD                             *
012400200529     F*  E20651 - DB ERROR NUMBERS USED IN MORE THAN ONE PLACE.       *   E20651
012500200529     F*           NEW ERROR NUMBERS AS FOLLOWS:                       *   E20651
012600200529     F*           DB ERROR 02 -> 09                                   *   E20651
012700200529     F*           DB ERROR 02 -> 10                                   *   E20651
012800200529     F*  E16849 - Process Cancellations/Reversals and always update   *   E16849
012900200529     F*           CPOSH record.                                       *   E16849
013000200529     F*  E15996 - Design Omissions - various Julius Baer fixes        *   E15596
013100200529     F*           1.  Average Price Numerator must be calculated      *   E15596
013200200529     F*           in absolute value and no longer any need to         *   E15596
013300200529     F*           multiply by 100 and then divide by 100 for Price    *   E15596
013400200529     F*           Basis = 'P' because of loss of figures.             *   E15596
013500200529     F*           2.  Remove Price File access.                       *   E14838
013600200529     F*  E14838 - Average Price = 0 problem - check for Depot         *   E14838
013700200529     F*           Movements as 'CI/CO'.                               *   E14838
013800200529     F*  E15509 - Do not zero average price if no previous CPOSH      *   E15509
013900200529     F*           record found, use date in key to fetch CPOSH        *   E15509
014000200529     F*           record, and use new nominal to calculate APNUM      *   E15509
014100200529     F*           for CT/CV price instead of previous nominal         *   E15509
014200200529     F*  E15508 - Write out new CPOSND record if a price action is    *   E15508
014300200529     F*           read in for a new date.                             *   E15508
014400200529     F*  E14010 - Read only new and re-actioned Customer average      *   E14010
014500200529     F*           price records.                                      *   E14010
014600200529     F*  E13561 - CALCULATE AP NUMERATOR CORRECTLY & UPDATE AP        *   E13561
014700200529     F*           NUMERATORS IF ANY ACTION RECORD READ.               *   E13561
014800200529     F*  S01158 - POST INCORPORATION DEVELOPMENT FIXES INCLUDING      *
014900200529     F*         -  Allow for Nominal/Nominal Currency decimal places  *.
015000200529     F*            Calculate price for every record.                  *
015100200529     F*                                                               *
015200200529     F*****************************************************************
015300200529     F*
015400200529     FCAPRHA  IF  E                    DISK         KINFDS CAPRDS
015500200529     F                                              KINFSR CAPRSR
015600200529     F***CPOSNA  IF  E                    DISK                            E15508
015700200529     FCPOSNA  UF  E                    DISK                               E15508
015800200529     FTABSE   IF  E           K        DISK
015900200529     F* ICD 1     TABTB10F                          KIGNORE
016000200529     F            TABTB10F                          KIGNORE               S01117
016100200529     F            TABTB11F                          KIGNORE
016200200529     F            TABTB36F                          KIGNORE
016300200529     F            TABTB40F                          KIGNORE
016400200529     F* CCY       TABTG10F                          KIGNORE               S01158
016500200529     F            TABTG20F                          KIGNORE
016600200529     F            TABLETHF                          KIGNORE
016700200529     F*********** TABLETJF                          KIGNORE               S01117
016800200529     F            TABLETLF                          KIGNORE
016900200529     F            TABLETRF                          KIGNORE
017000200529     F            TABLETXF                          KIGNORE
017100200529     F            TABLET2F                          KIGNORE
017200200529     F            TABLET3F                          KIGNORE
017300200529     F            TABLET5F                          KIGNORE
017400200529     F            TABTE10F                          KIGNORE
017500200529     F            TABLETNF                          KIGNORE
017600200529     F            TABLETKF                          KIGNORE
017700200529     F            TABLETPF                          KIGNORE
017800200529     F            TABLETAF                          KIGNORE
017900200529     F            TABTE20F                          KIGNORE
018000200529     FSE2410AUO   E                    PRINTER
018100200529     FSEDEV   IF  E           K        DISK
018200200529     FTRADS   IF  E           K        DISK
018300200529     FDPTMV   IF  E           K        DISK
018400200529     F***PRICE   IF  E           K        DISK                            E15996
018500200529     FSECTY   IF  E           K        DISK                               S01158
018600200529     F*****CAPRH   UF  E           K        DISK         KINFDS CAPHDS    E14010
018700200529     FCAPRA   UF  E           K        DISK         KINFDS CAPHDS         E14010
018800200529     F                                              KINFSR CAPHSR
018900200529     F***CPOSH   UF  E           K        DISK         KINFDS CPOSDS      E15508
019000200529     FCPOSH   UF  E           K        DISK         KINFDS CPOSDSA        E15508
019100200529     F                                              KINFSR CPOSSR
019200200529      /EJECT
019300200529     F*****************************************************************
019400200529     F*                                                               *
019500200529     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
019600200529     F*                                                               *
019700200529     F*   21 - NOMINAL CURRENCY DEC. PLACES 0                         *   S01158
019800200529     F*   22 - NOMINAL CURRENCY DEC. PLACES 1                         *   S01158
019900200529     F*   23 - NOMINAL CURRENCY DEC. PLACES 2                         *   S01158
020000200529     F*   24 - NOMINAL CURRENCY DEC. PLACES 3                         *   S01158
020100200529     F*   33 - GENERAL WORK INDICATOR                                 *   S01158
020200200529     F*   77 - A/P NUMERATOT TO BE WRITTEN TO FILE IS NEGATIVE (RVRS  *
020300200529     F*   79 - END OF CUSTOMER DEPOT POSITIONS FOR THIS SECURITY      *
020400200529     F*   89 - END OF AVERAGE PRICE FILE - STD REPORT AND END         *
020500200529     F*   87 - EXCEPTION ERROR ON UPDATED FILE - PRINTS STATUS/AUDIT  *
020600200529     F*   29 - DIFFERENCE MESSAGE IS PRINTED                          *
020700200529     F*90-99 - USED IN Z SUBROUTINES                                  *
020800200529     F*   U7 - DATABASE ERROR                                         *
020900200529     F*   U8 - DATABASE ERROR                                         *
021000200529     F*                                                               *
021100200529     F*****************************************************************
021200200529      /EJECT
021300200529     F*****************************************************************
021400200529     F*                                                               *
021500200529     F*  I N D E X   T O   S U B R O U T I N E S                      *
021600200529     F*                                                               *
021700200529     F*  FIRST  - ACCESSES ICD INFORMATION                            *
021800200529     F*  CALL   - UPDATE AVERAGE PRICE NUMERATOR FOR                  *
021900200529     F*           A CALL ON A PARTLY PAID SECURITY                    *
022000200529     F*  TRADE  - UPDATE AVERAGE PRICE NUMERATOR FOR                  *
022100200529     F*           A TRADE ACTION                                      *
022200200529     F*  DMVT   - UPDATE AVERAGE PRICE NUMERATOR FOR                  *
022300200529     F*           A DEPOT MOVEMENT                                    *
022400200529     F*  PRICEU - UPDATE AVERAGE PRICE NUMERATOR FOR                  *
022500200529     F*           A PRICE ACTION                                      *
022600200529     F*  CH01   - CHANGE OF POSITION OR DATE WITHIN A POSITION -      *
022700200529     F*           UPDATE POSITION FOR LAST DATE ACTION                *
022800200529     F***ZSYSTM*-*GET*TABTB10*ICD*****************************************S01117
022900200529     F*  AUDIT  - OUTPUTS AUDIT RECORD UDEPPA AND CONTROL REPORT      *
023000200529     F*  CAPRSR - ERROR HANDLING FOR CAPRHA                           *
023100200529     F***CAPHSR - ERROR HANDLING FOR CAPRH*****************           *   E14010
023200200529     F*  CAPHSR - ERROR HANDLING FOR CAPRA                            *   E14010
023300200529     F*  CPOSSR - ERROR HANDLING FOR CPOSH                            *
023400200529     F*  *PSSR  - Error handling                                      *   S01117
023500200529     F*                                                               *
023600200529     F*****************************************************************
023700200529      /EJECT
023800200529     E**    TABLES AND ARRAYS    **
023900200529     E/COPY ZSRSRC,ZPOWER8Z1                                              S01158
024000200529     E                    CPY@    1   1 80
024100200529     E*
024200200529      /EJECT
024300200529     I*
024400200529     ICAPRHDF
024500200529     I              CSCN                            CACN
024600200529     I************  CSBR                            CABR                  S01117
024700200529     I              CSBA                            CABR                  S01117
024800200529     I              CSSC                            CASC
024900200529     I              CSDA                            CADA
025000200529     I*
025100200529     ITABLKY      DS
025200200529     I*
025300200529     I*  TABTB11 TABLE KEY FIELD DATA STRUCTURE FOR DB ERROR
025400200529     I*
025500200529     I                                        1  12 TABKEY
025600200529     I                                        1   20RECT
025700200529     I                                        3  10 ZZ008
025800200529     I                                       11  120RCDE
025900200529     I*
026000200529     ICPOSDS      DS                            366
026100200529     I*
026200200529     I*  CUSTOMER POSITIONS FILE ERROR EXCEPTION  DATA STRUCT.
026300200529     I*
026400200529     I                                     *STATUS  STSPOS
026500200529     I*
026600200529     ICAPHDS      DS                            366
026700200529     I*
026800200529     I*  CUSTOMER AVERAGE PRICE ACTIONS ERROR EXCEPTION  DATA STRUCT.
026900200529     I*
027000200529     I                                     *STATUS  STSCAP
027100200529     I*
027200200529     ICAPRDS      DS                            366
027300200529     I*
027400200529     I*  CUST.AVG. PRICE AUDIT FILE ERROR EXCEPTION  DATA STRUCT.
027500200529     I*
027600200529     I                                     *STATUS  STSCPR
027700200529     IWPRVKY      DS
027800200529     I*
027900200529     I* PREVIOUS POSITION KEYS - CUSTOMER/BRANCH/SECURITY
028000200529     I*
028100200529     I**********                              1   60WPCST                                     CSD027
028200200529     I                                        1   6 WPCST                                     CSD027
028300200529     I***********                             7   90WPBR                  S01117
028400200529     I                                        7   9 WPBR                  S01117
028500200529     I                                       10  19 WPSEC
028600200529     I                                        1  19 CPKEYD
028700200529     I                                       20  240WPCSDA
028800200529     I*
028900200529     IWCURKY      DS
029000200529     I*
029100200529     I* CURRENT POSITION KEYS - CUSTOMER/BRANCH/SECURITY
029200200529     I*
029300200529     I**********                              1   60CACN                                      CSD027
029400200529     I                                        1   6 CACN                                      CSD027
029500200529     I***********                             7   90CABR                  S01117
029600200529     I                                        7   9 CABR                  S01117
029700200529     I                                       10  19 CASC
029800200529     I                                        1  19 CURKEY
029900200529     I                                       20  240CADA
030000200529     I*
030100200529     ICPYR@#      DS
030200200529     I*
030300200529     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
030400200529     I*
030500200529     I                                        1  80 CPY@
030600200529     I                                        1  20 CPY@##
030700200529     I*
030800200529     I*LDA********UDS                            256                      S01117
030900200529     I***********                           134 177 DBLOT                 S01117
031000200529     I***********                           134 138 DBFILE                S01117
031100200529     I***********                           139 167 DBKEY                 S01117
031200200529     I***********                           168 175 DBPGM                 S01117
031300200529     I***********                           176 1770DBASE                 S01117
031400200529     I*
031500200529     ILDA         DS                            256                       S01117
031600200529     I                                      134 183 DBLOT                 S01117
031700200529     I                                      134 141 DBFILE                S01117
031800200529     I                                      142 170 DBKEY                 S01117
031900200529     I                                      171 180 DBPGM                 S01117
032000200529     I                                      181 1830DBASE                 S01117
032100200529     IRUNDT       DS                                                      S01117
032200200529      ** DATA AREA RUNDAT                                                 S01117
032300200529     I                                        1   7 RUNA                  S01117
032400200529     I                                    P   8  100RUND                  S01117
032500200529     I                                       11  11 SSF                   S01117
032600200529     I                                       12  12 DATF                  S01117
032700200529     I                                       13  13 MBIN                  S01117
032800200529     I**  EXTERNAL DS FOR BANK DETAILS                                    S01117
032900200529     ISDBANK    E DSSDBANKPD                                              S01117
033000200529     I              BJURPT                          TITL                  S01117
033100200529     I*                                                                   S01486
033200200529     ISDMMOD    E DSSDMMODPD                                              S01486
033300200529     I** Data structure for module details                                S01486
033400200529      *****************************************************************                233705 234440
033500200529     I****SCSARD*    E DSSCSARDPD                                                      233705 234440
033600200529      ***External*Data*Structure*for*SAR*Details***********************                233705 234440
033700200529     I*                                                                   S01486
033800200529     I** DATA STRUCTURE FOR ACCESS OBJECTS, SHORT DATA STRUCTURE          S01117
033900200529     IDSFDY     E DSDSFDY                                                 S01117
034000200529     I*
034100200529      /EJECT
034200200529     C*================================================================
034300200529     C*  P R O G R A M     S T A R T
034400200529     C*================================================================
034500200529     C*
034600200529     C* KEYLISTS FOR CHAINING TO FILES
034700200529     C*
034800200529     C* CUSTOMER DEPOT POSITIONS - RETRIEVE EARLIER DATE  LF/CPOSH
034900200529     C*
035000200529     C           CPKEY     KLIST
035100200529     C                     KFLD           WPBR
035200200529     C                     KFLD           WPSEC
035300200529     C                     KFLD           WPCST
035400200529     C                     KFLD           WPCSDA
035500200529     C*                                                                   E15996
035600200529     C           CPKEY2    KLIST                                          E15996
035700200529     C                     KFLD           WPBR                            E15996
035800200529     C                     KFLD           WPSEC                           E15996
035900200529     C                     KFLD           WPCST                           E15996
036000200529     C*
036100200529     C* SECURITY EVENTS - LF/SEDEV
036200200529     C*
036300200529     C           SECDKY    KLIST
036400200529     C                     KFLD           CASC
036500200529     C                     KFLD           CADA
036600200529     C                     KFLD           SDET
036700200529     C*
036800200529     C* TRADE ACTIONS   - LF/TRADE
036900200529     C*
037000200529     C           TRADKY    KLIST
037100200529     C                     KFLD           CSRF
037200200529     C*
037300200529     C* DEPOT MOVEMENTS - LF/DPTMV
037400200529     C*
037500200529     C           DEPTKY    KLIST
037600200529     C                     KFLD           CASC
037700200529     C                     KFLD           CSRF
037800200529     C*
037900200529     C* PRICE ACTIONS   - LF/PRICE
038000200529     C*
038100200529     C***********PRICEK    KLIST                                          E15996
038200200529     C***********          KFLD           CASC                            E15996
038300200529     C***********          KFLD           CACN                            E15996
038400200529     C***********          KFLD           WMKT    1                       E15996
038500200529     C***********          KFLD           CABR                            E15996
038600200529     C***********          KFLD           WBOOK   2                       E15996
038700200529     C***********          KFLD           WPPRT   2                       E15996
038800200529     C*
038900200529     C**ACCESS*ICD*INFORMATION*IN*SUBROUTINE*FIRST************************S01117
039000200529     C*
039100200529      **  PREPARE LDA                                                     S01117
039200200529     C           *NAMVAR   DEFN           LDA                             S01117
039300200529     C           *LOCK     IN   LDA                                       S01117
039400200529     C                     MOVE *BLANK    DBLOT
039500200529     C                     Z-ADD0         DBASE
039600200529     C                     MOVE 'SE2410  'DBPGM
039700200529     C***********          EXSR FIRST                                     S01117
039800200529     C                     OUT  LDA                                       S01117
039900200529     C**                                                                  S01117
040000200529     C** IN THE DATA AREA RUNDAT                                          S01117
040100200529     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
040200200529     C                     IN   RUNDT                                     S01117
040300200529     C*
040400200529     C**   ACCESS BANK DETAILS, FOR TITLE                                 S01117
040500200529     C                     CALL 'AOBANKR0'                                S01117
040600200529     C                     PARM '*MSG   ' @RTCD   7                       S01117
040700200529     C                     PARM '*FIRST ' @OPTN   7                       S01117
040800200529     C           SDBANK    PARM SDBANK    DSFDY                           S01117
040900200529     C*                                                                   S01117
041000200529     C           @RTCD     IFNE *BLANK                                    S01117
041100200529     C           *LOCK     IN   LDA                                       S01117
041200200529     C                     MOVEL'SDBANKPD'DBFILE                          S01117
041300200529     C                     MOVEL@OPTN     DBKEY            ***************S01117
041400200529     C                     MOVEL@OPTN     DBOPTN  7        * DBERROR 011 *S01117
041500200529     C                     Z-ADD11        DBASE            ***************S01117
041600200529     C                     OUT  LDA                                       S01117
041700200529     C                     EXSR *PSSR                                     S01117
041800200529     C                     SETON                     U7U889               S01117
041900200529     C                     GOTO EAUDIT                                    S01117
042000200529     C                     END                                            S01117
042100200529     C*                                                                   S01486
042200200529     C**  Get module details using access object                          S01486
042300200529     C*                                                                   S01486
042400200529     C                     CALL 'AOMMODR0'                                S01486
042500200529     C                     PARM *BLANKS   @RTCD                           S01486
042600200529     C                     PARM '*FIRST'  @OPTN                           S01486
042700200529     C           SDMMOD    PARM SDMMOD    DSFDY                           S01486
042800200529     C*                                                                   S01486
042900200529     C           @RTCD     IFNE *BLANKS                                   S01486
043000200529     C           *LOCK     IN   LDA                                       S01486
043100200529     C                     Z-ADD15        DBASE            ***************S01486
043200200529     C                     MOVE 'SDMMODPD'DBFILE           * DB ERROR 15 *S01486
043300200529     C                     MOVEL@OPTN     DBKEY            ***************S01486
043400200529     C                     OUT  LDA                                       S01486
043500200529     C                     EXSR *PSSR                                     S01486
043600200529     C                     SETON                     U7U889               S01486
043700200529     C                     GOTO EAUDIT                                    S01486
043800200529     C                     END                                            S01486
043900200529      *****************************************************************                233705 234440
044000200529      ****Access*SAR*details*file*to*see*if*CGL031*is*installed.*******                233705 234440
044100200529      *****************************************************************                233705 234440
044200200529     C**********           CALL 'AOSARDR0'                                             233705 234440
044300200529     C**********           PARM *BLANKS   PRTCD   7                                    233705 234440
044400200529     C**********           PARM '*VERIFY' POPTN   7                                    233705 234440
044500200529     C**********           PARM 'CGL031'  PSARD   6                                    233705 234440
044600200529     C********** SCSARD    PARM SCSARD    DSFDY                                        233705 234440
044700200529      *****************************************************************                233705 234440
044800200529     C********** PRTCD     IFNE *BLANKS                                                233705 234440
044900200529     C********** PRTCD     ANDNE'*NRF    '                                             233705 234440
045000200529     C********** *LOCK     IN   LDA                                                    233705 234440
045100200529     C**********           MOVE 'SCSARDPD'DBFILE                                       233705 234440
045200200529     C**********           Z-ADD16        DBASE                                        233705 234440
045300200529     C**********           MOVEL'CGL031'  DBKEY                                        233705 234440
045400200529     C**********           MOVE *ON       *IN89                                        233705 234440
045500200529     C**********           MOVE *ON       *INU7                                        233705 234440
045600200529     C**********           MOVE *ON       *INU8                                        233705 234440
045700200529     C**********           OUT  LDA                                                    233705 234440
045800200529     C**********           EXSR *PSSR                                                  233705 234440
045900200529     C**********           ENDIF                                                       233705 234440
046000200529      *****************************************************************                233705 234440
046100200529     C********** PRTCD     IFEQ *BLANKS                                                233705 234440
046200200529     C**********           MOVE 'Y'       CGL031  1                                    233705 234440
046300200529     C**********           ELSE                                                        233705 234440
046400200529     C**********           MOVE 'N'       CGL031                                       233705 234440
046500200529     C**********           ENDIF                                                       233705 234440
046600200529     C*                                                                   S01486
046700200529     C**CHECK*FOR*DATABASE*ERRORS*****************************************S01117
046800200529     C***********                                                         S01117
046900200529     C************IN99     IFEQ '1'                                       S01117
047000200529     C***********          GOTO EAUDIT                                    S01117
047100200529     C***********          END                                            S01117
047200200529     C*
047300200529     C* DEFINE AND CLEAR WORK FIELDS
047400200529     C*
047500200529     C           *LIKE     DEFN CSCP      WNAPT
047600200529     C           *LIKE     DEFN CSCP      WNAPV
047700200529     C           *LIKE     DEFN CSPT      WAPNMT
047800200529     C           *LIKE     DEFN CSPV      WAPNMV
047900200529     C           *LIKE     DEFN CSNV      WPCSNV
048000200529     C           *LIKE     DEFN CSNT      WPCSNT
048100200529     C           *LIKE     DEFN CSNV      WNCSNV
048200200529     C           *LIKE     DEFN CSNT      WNCSNT
048300200529     C********** *LIKE     DEFN CSAP      WCAPT                                               262503
048400200529     C********** *LIKE     DEFN CSAP      WCAPV                                               262503
048500200529     C           *LIKE     DEFN CSOA      WPCSOA
048600200529     C           *LIKE     DEFN CSSE      WPCSSE                          E13561
048700200529     C***********          MOVE '  '      WBOOK                           E15996
048800200529     C           *LIKE     DEFN CSNS      WPCSNS                          E15508
048900200529     C           *LIKE     DEFN CSEX      WPCSEX                          E15508
049000200529     C           *LIKE     DEFN CSCT      WPCSCT                          E15508
049100200529     C           *LIKE     DEFN CSCV      WPCSCV                          E15508
049200200529     C************LIKE     DEFN CSBR      WPCSBR                   E15508 S01117
049300200529     C           *LIKE     DEFN CSBA      WPCSBR                          S01117
049400200529     C           *LIKE     DEFN CSCN      WPCSCN                          E15508
049500200529     C           *LIKE     DEFN CSSC      WPCSSC                          E15508
049600200529      *                                                                                       262503
049700200529      ** Increase the length from 15,8 to 23,8 to avoid truncation                            262503
049800200529      *                                                                                       262503
049900200529     C                     Z-ADD0         WCAPT  238                                          262503
050000200529     C                     Z-ADD0         WCAPV  238                                          262503
050100200529     C*
050200200529     C**LOOP*ROUND*PROCESSING*FOR*EACH*ACTION*RECORD*READ*LF/CAPRH****    E14010
050300200529     C* LOOP ROUND PROCESSING FOR EACH ACTION RECORD READ LF/CAPRA        E14010
050400200529     C*
050500200529     C           *IN89     DOWEQ'0'
050600200529     C*
050700200529     C* READ ACTION FILE OF CUSTOMER AVERAGE PRICE ACTIONS
050800200529     C*
050900200529     C***********          READ CAPRH                    89               E14101
051000200529     C                     READ CAPRA                    89               E14101
051100200529     C*
051200200529     C* IF ACTION RECORD DELETED GOTO END OF LOOP FOR NEXT ACTION
051300200529     C*
051400200529     C  N89      RECI      CABEQ'*'       ENDLP
051500200529     C*
051600200529     C* AT END OF FILE -
051700200529     C*
051800200529     C           *IN89     CABEQ'1'       ENDLP
051900200529     C*
052000200529     C                     MOVE RECI      WREC    1
052100200529     C*
052200200529     C** ADD TO COUNTER FOR EACH RECORD READ FOR TYPE A AND TYPE D
052300200529     C*
052400200529     C           WREC      IFEQ 'A'
052500200529     C********** WREC      OREQ 'C'                                                  207777 BUG13389
052600200529     C                     ADD  1         WTYPEA  50
052700200529     C                     END
052800200529     C           WREC      IFEQ 'D'
052900200529     C                     ADD  1         WTYPED  50
053000200529     C                     END
053100200529     C*
053200200529     C** FOR A REVERSAL, SET SORT SEQUENCE TO 0.                          E16849
053300200529     C*                                                                   E16849
053400200529     C           WREC      IFEQ 'C'                                       E16849
053500200529     C                     MOVE '0'       CSSE                            E16849
053600200529     C                     END                                            E16849
053700200529     C*                                                                   S01486
053800200529     C**  If Portfolio Management is present                              S01486
053900200529     C**  Or Private Banking is present                                   CPB001
054000200529     C*                                                                   S01486
054100200529     C           BGPFMG    IFEQ 'Y'                                       S01486
054200200529     C           BGN4ST    OREQ 'Y'                                       CPB001
054300200529     C*                                                                   S01486
054400200529     C** IF ACTION IS A PORTFOLIO POSITION PRICE CHANGE SET RECORD ID     S01486
054500200529     C** TO 'H' AND TERMINATE LOOP                                        S01486
054600200529     C*                                                                   S01486
054700200529     C           CSOA      IFEQ 'XT'                                      S01486
054800200529     C           CSOA      OREQ 'XV'                                      S01486
054900200529     C                     MOVE 'H'       RECI                            S01486
055000200529     C                     GOTO ENTAG                                     S01486
055100200529     C                     END                                            S01486
055200200529     C*                                                                   S01486
055300200529     C                     END                                            S01486
055400200529     C*                                                                   E16849
055500200529     C** ACTION IS FOR A NEW POSITION
055600200529     C*
055700200529     C           CPKEYD    IFNE CURKEY
055800200529     C*
055900200529     C** NEW POSITION - UPDATE LAST ONE IF NOT FIRST TIME
056000200529     C*
056100200529     C           WPSEC     IFNE *BLANK
056200200529     C                     EXSR CH01
056300200529     C                     END
056400200529     C*                                                                   S01158
056500200529     C* Fetch new position details                                        S01158
056600200529     C*                                                                   S01158
056700200529     C           CASC      CHAINSECTYDF              33                   S01158
056800200529     C           *IN33     IFEQ '1'                                       S01158
056900200529     C           *LOCK     IN   LDA                                       S01117
057000200529     C                     MOVE 'SECTY'   DBFILE                          S01158
057100200529     C                     MOVELCACN      DBKEY                           S01158
057200200529     C                     Z-ADD07        DBASE                           S01158
057300200529     C                     OUT  LDA                                       S01117
057400200529     C                     EXSR *PSSR                                     S01117
057500200529     C                     SETON                     U7U889               S01158
057600200529     C                     GOTO ENDLP                                     S01158
057700200529     C                     END                                            S01158
057800200529     C*                                                                   S01158
057900200529     C                     MOVEL'20      'TKEY   12                       S01158
058000200529     C                     MOVELNMCY      ZWK4    4                       S01158
058100200529     C                     MOVE 1         ZWK4                            S01158
058200200529     C                     MOVE ZWK4      TKEY                            S01158
058300200529     C           TKEY      CHAINTABTG10F             33                   S01158
058400200529     C  N33      RECI      COMP '*'                      33               S01158
058500200529     C           *IN33     IFEQ '1'                                       S01158
058600200529     C           *LOCK     IN   LDA                                       S01117
058700200529     C                     MOVE 'TABLE'   DBFILE                          S01158
058800200529     C                     MOVELTKEY      DBKEY                           S01158
058900200529     C                     Z-ADD08        DBASE                           S01158
059000200529     C                     OUT  LDA                                       S01117
059100200529     C                     EXSR *PSSR                                     S01117
059200200529     C                     SETON                     U7U889               S01158
059300200529     C                     GOTO ENDLP                                     S01158
059400200529     C                     END                                            S01158
059500200529     C*                                                                   S01158
059600200529     C                     MOVEA'0000'    *IN,21                          S01158
059700200529     C********** 21        ADD  CDP       J       10                      E13561
059800200529     C           21        ADD  CDP       J       20                      E13561
059900200529     C                     MOVEA'1'       *IN,J                           S01158
060000200529     C*
060100200529     C** GET LATEST EARLIER POSITION FROM LF/CPOSH
060200200529     C*
060300200529     C                     MOVE WCURKY    WPRVKY
060400200529     C                     MOVE CSOA      WPCSOA
060500200529     C                     MOVE CADA      WPCSDA                          E15509
060600200529     C*
060700200529     C           CPKEY     SETLLCPOSH                    77
060800200529     C                     READPCPOSH                    79
060900200529     C           *IN79     IFEQ '1'
061000200529     C***********CSBR      ORNE CABR                                      S01117
061100200529     C           CSBA      ORNE CABR                                      S01117
061200200529     C           CSCN      ORNE CACN
061300200529     C           CSSC      ORNE CASC
061400200529     C**********           MOVE *LOVAL    WPCSDA
061500200529     C                     Z-ADD0         CSNT
061600200529     C                     Z-ADD0         CSNV
061700200529     C**********           Z-ADD0         CSAP                            E15509
061800200529     C                     Z-ADD0         CSPT
061900200529     C                     Z-ADD0         CSPV
062000200529     C                     Z-ADD0         WNCSNT
062100200529     C                     Z-ADD0         WPCSNT
062200200529     C                     Z-ADD0         WNCSNV
062300200529     C                     Z-ADD0         WPCSNV
062400200529     C                     Z-ADD0         WPCSNS                          E15508
062500200529     C                     Z-ADD0         WPCSEX                          E15508
062600200529     C                     Z-ADD0         WPCSCT                          E15508
062700200529     C                     Z-ADD0         WPCSCV                          E15508
062800200529     C                     END
062900200529     C*
063000200529     C** SAVE NOMINAL POSITIONS INTO 'PREVIOUS' & 'NEW' VALUE FIELDS
063100200529     C*
063200200529     C                     Z-ADDCSNT      WPCSNT
063300200529     C                     Z-ADDCSNV      WPCSNV
063400200529     C                     Z-ADDCSNT      WNCSNT
063500200529     C                     Z-ADDCSNV      WNCSNV
063600200529     C                     Z-ADDCSPT      WAPNMT
063700200529     C                     Z-ADDCSPV      WAPNMV
063800200529     C                     Z-ADDCSNS      WPCSNS                          E15508
063900200529     C                     Z-ADDCSEX      WPCSEX                          E15508
064000200529     C                     Z-ADDCSCT      WPCSCT                          E15508
064100200529     C                     Z-ADDCSCV      WPCSCV                          E15508
064200200529     C*
064300200529     C** CHECK IF A CALL IS DUE FOR SECURITY
064400200529     C*
064500200529     C                     MOVE 'PP'      SDET
064600200529     C           SECDKY    CHAINSEDEV                79
064700200529     C           *IN79     IFNE '1'
064800200529     C                     EXSR CALL
064900200529     C                     END
065000200529     C*
065100200529     C                     ELSE
065200200529     C*
065300200529     C** ELSE... NOT CHG OF POSITION, BUT CHANGE OF DATE FOR THIS POSN.
065400200529     C*
065500200529     C           WPCSDA    IFNE CADA
065600200529     C*
065700200529     C** NEW POSITION - UPDATE LAST
065800200529     C*
065900200529     C                     EXSR CH01
066000200529     C                     MOVE CADA      WPCSDA
066100200529     C*
066200200529     C** GET LATEST EARLIER POSITION FROM LF/CPOSH
066300200529     C*
066400200529     C                     MOVE CSOA      WPCSOA
066500200529     C*
066600200529     C           CPKEY     SETLLCPOSH                    77
066700200529     C                     READPCPOSH                    79
066800200529     C           *IN79     IFEQ '1'
066900200529     C***********CSBR      ORNE CABR                                      S01117
067000200529     C           CSBA      ORNE CABR                                      S01117
067100200529     C           CSCN      ORNE CACN
067200200529     C           CSSC      ORNE CASC
067300200529     C**********           MOVE *LOVAL    WPCSDA
067400200529     C                     Z-ADD0         CSNT
067500200529     C                     Z-ADD0         CSNV
067600200529     C**********           Z-ADD0         CSAP                            E15509
067700200529     C                     Z-ADD0         CSPT
067800200529     C                     Z-ADD0         CSPV
067900200529     C                     Z-ADD0         WNCSNT
068000200529     C                     Z-ADD0         WPCSNT
068100200529     C                     Z-ADD0         WNCSNV
068200200529     C                     Z-ADD0         WPCSNV
068300200529     C                     END
068400200529     C*
068500200529     C** SAVE NOMINAL POSITIONS INTO 'PREVIOUS' & 'NEW' VALUE FIELDS
068600200529     C*
068700200529     C                     Z-ADDCSNT      WPCSNT
068800200529     C                     Z-ADDCSNV      WPCSNV
068900200529     C                     Z-ADDCSNT      WNCSNT
069000200529     C                     Z-ADDCSNV      WNCSNV
069100200529     C                     Z-ADDCSPT      WAPNMT
069200200529     C                     Z-ADDCSPV      WAPNMV
069300200529     C                     Z-ADDCSNS      WPCSNS                          E15508
069400200529     C                     Z-ADDCSEX      WPCSEX                          E15508
069500200529     C                     Z-ADDCSCT      WPCSCT                          E15508
069600200529     C                     Z-ADDCSCV      WPCSCV                          E15508
069700200529     C*
069800200529     C** CHECK IF A CALL IS DUE FOR SECURITY
069900200529     C*
070000200529     C                     MOVE 'PP'      SDET
070100200529     C           SECDKY    CHAINSEDEV                79
070200200529     C           *IN79     IFNE '1'
070300200529     C                     EXSR CALL
070400200529     C                     END
070500200529     C                     END
070600200529     C                     END
070700200529     C*
070800200529     C* IF TRADE ACTION, IF TYPE 'A' ACCESS LF/TRADS AND IF FOUND OR
070900200529     C*                  IF TYPE 'D' EXECUTE P/TRADE
071000200529     C*
071100200529     C           CSOA      IFEQ 'TP'
071200200529     C           CSOA      OREQ 'TS'
071300200529     C           WREC      IFEQ 'D'
071400200529     C                     EXSR TRADE
071500200529     C                     ELSE
071600200529     C           WREC      IFEQ 'A'
071700200529     C           TRADKY    CHAINTRADS                79
071800200529     C  N79                EXSR TRADE
071900200529     C                     END
072000200529     C                     END
072100200529     C                     END
072200200529     C*
072300200529     C* IF DEPOT MVMNT, IF TYPE 'A' ACCESS LF/DPTMV AND IF FOUND OR
072400200529     C*                 IF TYPE 'D' EXECUTE P/DMVT
072500200529     C*
072600200529     C***********CSOA      IFEQ 'WI'                                      E14838
072700200529     C***********CSOA      OREQ 'WO'                                      E14838
072800200529     C           CSOA      IFEQ 'CI'                                      E14838
072900200529     C           CSOA      OREQ 'CO'                                      E14838
073000200529     C           WREC      IFEQ 'D'
073100200529     C                     EXSR DMVT
073200200529     C                     ELSE
073300200529     C           WREC      IFEQ 'A'
073400200529     C           DEPTKY    CHAINDPTMV                79
073500200529     C  N79                EXSR DMVT
073600200529     C                     END
073700200529     C                     END
073800200529     C                     END
073900200529     C*
074000200529     C                     MOVE CSSE      WPCSSE                          E13561
074100200529     C*
074200200529     C*****IF*PRICE*ACTION,IF*TYPE*'A'*ACCESS*LF/PRICE*AND*IF*FOUND*OR    E15996
074300200529     C*******************IF*TYPE*'D'*EXECUTE*P/PRICEU********             E15996
074400200529     C*******************                                                 E15996
074500200529     C*  IF PRICE ACTION,EXECUTE P/PRICEU                                 E15996
074600200529     C*
074700200529     C           CSOA      IFEQ 'CT'
074800200529     C           CSOA      OREQ 'CV'
074900200529     C           WREC      IFEQ 'D'
075000200529     C           WREC      OREQ 'A'                                       E15996
075100200529     C                     EXSR PRICEU
075200200529     C                     END
075300200529     C***********WREC      IFEQ 'A'                                       E15996
075400200529     C***********          MOVE 'S'       WMKT                            E15996
075500200529     C***********          MOVE CSOA      WPPRT                           E15996
075600200529     C***********PRICEK    CHAINPRICE                79                   E15996
075700200529     C************IN79     IFEQ '1'                                       E15996
075800200529     C***********RECI      OREQ '*'                                       E15996
075900200529     C***********          MOVE 'P'       WMKT                            E15996
076000200529     C***********PRICEK    CHAINPRICE                79                   E15996
076100200529     C************IN79     IFEQ '1'                              E15996   E15996
076200200529     C***********RECI      OREQ '*'                              E15996   E15996
076300200529     C***********          MOVE 'G'       WMKT                            E15996
076400200529     C***********PRICEK    CHAINPRICE                79                   E15996
076500200529     C************IN79     IFEQ '1'                              E15509   E15996
076600200529     C***********RECI      OREQ '*'                              E15509   E15996
076700200529     C***********          MOVE ' '       WMKT                   E15509   E15996
076800200529     C***********PRICEK    CHAINPRICE                79          E15509   E15996
076900200529     C***********          END                                            E15996
077000200529     C***********          END                                            E15996
077100200529     C***********          END                                   E15509   E15996
077200200529     C************IN79     IFNE '1'                                       E15996
077300200529     C***********RECI      ANDNE'*'                                       E15996
077400200529     C***********          EXSR PRICEU                                    E15996
077500200529     C***********          END                                            E15996
077600200529     C***********          END                                            E15996
077700200529     C                     END
077800200529     C*
077900200529     C***PDATE*RECORD*ID*TO*H*FOR*ALL*TYPES*********                      E16849
078000200529     C* UPDATE RECORD ID TO H FOR ACTIONED OR * FOR DELETED               E16849
078100200529      ***only*when*CGL031*is*off,*otherwise*the*RECI*is*updated*in*SE2410A             233705 234440
078200200529     C*
078300200529     C********** CGL031    IFEQ 'N'                                                    233705 234440
078400200529     C           WREC      IFEQ 'C'                                       E16849
078500200529     C                     MOVE '*'       RECI                            E16849
078600200529     C                     ELSE                                           E16849
078700200529     C                     MOVE 'H'       RECI
078800200529     C                     END                                            E16849
078900200529     C***********          ENDIF                                                       233705 234440
079000200529     C*********************UPDATCAPRHDF                                   E15996
079100200529     C           ENTAG     TAG                             ** ENTAG **    S01486
079200200529     C                     EXCPTCAPRID                                    E15996
079300200529     C*
079400200529     C           ENDLP     TAG                             ** ENDLP **
079500200529     C*
079600200529     C                     END
079700200529     C*
079800200529     C** END OF ACTIONS - UPDATE LAST GROUP IF NOT FIRST TIME
079900200529     C*
080000200529     C           WPSEC     IFNE *BLANK
080100200529     C                     EXSR CH01
080200200529     C                     END
080300200529     C           EAUDIT    TAG                             ** EAUDIT **
080400200529     C*
080500200529     C* OUTPUT RUN CONTROL REPORT
080600200529     C*
080700200529     C                     EXSR AUDIT
080800200529     C*
080900200529     C                     SETON                     LR
081000200529     C*
081100200529     C*****************************************************************
081200200529      /EJECT
081300200529     C*****************************************************************
081400200529     C*                                                               *
081500200529     C* CH01     - CHANGE OF POSITION OR DATE - UPDATE CHANGES FOR    *
081600200529     C*            LAST POSITION/DATE READ IN.                        *
081700200529     C*                                                               *
081800200529     C*****************************************************************
081900200529     C*
082000200529     C           CH01      BEGSR                           ** CH01   **
082100200529     C*
082200200529     C***DO*NOT*UPDATE*NUMERATOR*IF*UNCHANGED*SO*CHECK*FOR*A*CHANGE***    E16849
082300200529     C***BEFORE*ACCESING*THIS*DATES*POSITION*RECORD*******                E16849
082400200529     C*
082500200529     C********** CSPT      IFEQ WAPNMT                                    E16849
082600200529     C**********           MOVE '1'       TSAME   1                       E16849
082700200529     C**********           ELSE                                           E16849
082800200529     C**********           MOVE '0'       TSAME                           E16849
082900200529     C**********           END                                            E16849
083000200529     C********** CSPV      IFEQ WAPNMV                                    E16849
083100200529     C**********           MOVE '1'       VSAME   1                       E16849
083200200529     C**********           ELSE                                           E16849
083300200529     C**********           MOVE '0'       VSAME                           E16849
083400200529     C**********           END                                            E16849
083500200529     C*
083600200529     C           CPKEY     CHAINCPOSH                79
083700200529     C           *IN79     IFEQ '0'
083800200529     C********** TSAME     IFNE '1'                                       S01158
083900200529     C********** TSAME     IFNE '1'                                 E13561E16849
084000200529     C********** VSAME     ORNE '1'                                 E13561E16849
084100200529     C********** WPCSSE    OREQ '0'                                 E13561E16849
084200200529     C                     Z-ADDWAPNMT    CSPT         77
084300200529     C   77                Z-SUBCSPT      CSPT
084400200529     C**********           END                                            S01158
084500200529     C********** VSAME     IFNE '1'                                       S01158
084600200529     C                     Z-ADDWAPNMV    CSPV         77
084700200529     C   77                Z-SUBCSPV      CSPV
084800200529     C**********           END                                            S01158
084900200529     C**********           END                                      E13561E16849
085000200529     C*
085100200529     C**  Update Customer Positions
085200200529     C*
085300200529     C                     UPDATCPOSNDF
085400200529     C*
085500200529     C* INCREMENT COUNT FOR AUDIT REPORT
085600200529     C***UT*ONLY*IF*AN*ACTUAL*CHANGE*WAS*MADE*******                      E16849
085700200529     C*
085800200529     C********** TSAME     IFNE '1'                                       E16849
085900200529     C********** VSAME     ORNE '1'                                       E16849
086000200529     C                     ADD  1         WCUPDT  50
086100200529     C**********           END                                            E16849
086200200529     C*                                                                   E36685
086300200529     C* If change of position check if there is future date position rec. E36685
086400200529     C* and update ap numerators.  This is only for v. odd circumstances  E36685
086500200529     C* (See header box)                                                  E36685
086600200529     C*                                                                   E36685
086700200529     C           CPKEYD    IFNE CURKEY                                    E36685
086800200529     C           RECI      ANDEQ'H'                                       E36685
086900200529     C           CPKEY2    READECPOSH                    79               E36685
087000200529     C           *IN79     IFEQ '0'                                       E36685
087100200529     C                     Z-ADDWAPNMT    CSPT         77                 E36685
087200200529     C   77                Z-SUBCSPT      CSPT                            E36685
087300200529     C                     Z-ADDWAPNMV    CSPV         77                 E36685
087400200529     C   77                Z-SUBCSPV      CSPV                            E36685
087500200529     C                     UPDATCPOSNDF                                   E36685
087600200529     C                     ADD  1         WCUPDT  50                      E36685
087700200529     C                     END                                            E36685
087800200529     C                     END                                            E36685
087900200529     C*
088000200529      *                                                                                       252945
088100200529     C           CPKEYD    IFEQ CURKEY                                                        252945
088200200529     C           WPCSDA    ANDNECADA                                                          252945
088300200529     C           CPKEY2    READECPOSH                    79                                   252945
088400200529     C           *IN79     IFEQ '0'                                                           252945
088500200529     C           CSDA      ANDNECADA                                                          252945
088600200529     C                     Z-ADDWAPNMT    CSPT         77                                     252945
088700200529     C   77                Z-SUBCSPT      CSPT                                                252945
088800200529     C                     Z-ADDWAPNMV    CSPV         77                                     252945
088900200529     C   77                Z-SUBCSPV      CSPV                                                252945
089000200529     C                     UPDATCPOSNDF                                                       252945
089100200529     C                     ADD  1         WCUPDT                                              252945
089200200529     C                     ENDIF                                                              252945
089300200529     C                     ENDIF                                                              252945
089400200529     C*
089500200529     C                     ELSE
089600200529     C*
089700200529     C** Else *IN79 is on but if action is price record, write out        E15508
089800200529     C** new customer Position record                                     E15508
089900200529     C*
090000200529     C           WPCSOA    IFEQ 'CT'                                      E15508
090100200529     C           WPCSOA    OREQ 'CV'                                      E15508
090200200529     C*                                                                   E15508
090300200529     C***********          Z-ADDCSBR      WPCSBR                    E15508S01117
090400200529     C                     MOVELCSBA      WPCSBR                          S01117
090500200529     C**********           Z-ADDCSCN      WPCSCN                          E15508       E15508 CSD027
090600200529     C                     MOVE CSCN      WPCSCN                                              CSD027
090700200529     C                     MOVE CSSC      WPCSSC                          E15508
090800200529     C           CPKEY     SETGTCPOSNDF                                   E15508
090900200529     C                     READPCPOSNDF                  79               E15508
091000200529     C           *IN79     IFEQ '0'                                       E15508
091100200529     C***********CSBR      ANDEQWPCSBR                              E15508S01117
091200200529     C           CSBA      ANDEQWPCSBR                                    S01117
091300200529     C           CSCN      ANDEQWPCSCN                                    E15508
091400200529     C           CSSC      ANDEQWPCSSC                                    E15508
091500200529     C                     MOVE 'H'       RECI                            E15508
091600200529     C                     EXCPTCPRECI                                    E15508
091700200529     C                     END                                            E15508
091800200529     C*                                                                   E15508
091900200529     C           CPKEY2    READECPOSNDF                  78               E15996
092000200529     C           *IN78     IFEQ '1'                                       E15996
092100200529     C                     MOVE 'D'       RECI                            E15508
092200200529     C                     ELSE                                           E15996
092300200529     C                     MOVE 'H'       RECI                            E15996
092400200529     C                     END                                            E15996
092500200529     C                     Z-ADDWPCSNT    CSNT                            E15508
092600200529     C                     Z-ADDWPCSNV    CSNV                            E15508
092700200529     C                     Z-ADDWPCSNS    CSNS                            E15508
092800200529     C                     Z-ADDWPCSEX    CSEX                            E15508
092900200529     C                     Z-ADDWPCSDA    CSDA                            E15508
093000200529     C                     Z-ADDWAPNMT    CSPT                            E15508
093100200529     C                     Z-ADDWAPNMV    CSPV                            E15508
093200200529     C                     Z-ADDWPCSCT    CSCT                            E15508
093300200529     C                     Z-ADDWPCSCV    CSCV                            E15508
093400200529     C                     Z-ADD*ZEROS    CSPI                                                233705
093500200529     C                     Z-ADD*ZEROS    CSAT                                                233705
093600200529     C                     Z-ADD*ZEROS    CSAV                                                233705
093700200529     C                     Z-ADD*ZEROS    AVFP                                                234440
093800200529     C                     Z-ADD*ZEROS    APDT                                                234440
093900200529     C                     WRITECPOSNDF                                   E15508
094000200529     C*                                                                   E15508
094100200529     C                     ADD  1         ADDREC  50                      E15508
094200200529     C                     ELSE                                           E15508
094300200529     C*                                                                   E15508
094400200529     C** No matching date to transaction, so db error
094500200529     C*
094600200529     C           *LOCK     IN   LDA                                       S01117
094700200529     C                     MOVEL'CPOSH  ' DBFILE
094800200529     C                     MOVELWPRVKY    DBKEY            ***************E20651
094900200529     C***********          Z-ADD2         DBASE            * DB ERROR 09 *E20651
095000200529     C                     Z-ADD09        DBASE            ***************E20651
095100200529     C                     OUT  LDA                                       S01117
095200200529     C                     EXSR *PSSR                                     S01117
095300200529     C                     SETON                     U7U8
095400200529     C                     GOTO EAUDIT
095500200529     C                     END
095600200529     C                     END                                            E15508
095700200529     C*
095800200529     C                     Z-ADD0         WAPNMT
095900200529     C                     Z-ADD0         WAPNMV
096000200529     C           ENDCH1    ENDSR                            **ENDCH1**
096100200529     C*
096200200529     C*****************************************************************
096300200529      /EJECT
096400200529     C*****************************************************************
096500200529     C*                                                               *
096600200529     C* CALL  - CALCULATE CHANGE TO AVERAGE PRICE NUMERATOR ATR A CALL*
096700200529     C*         FOR EACH CALL DUE AFTER A CHANGE IN PRICE             *
096800200529     C**                                                              *
096900200529     C*****************************************************************
097000200529     C*
097100200529     C           CALL      BEGSR                           ** CALL   **
097200200529     C*
097300200529     C                     Z-ADD*ZEROS    WAPNM0 150                      S01158
097400200529     C                     Z-ADD*ZEROS    WAPNM1 151                      S01158
097500200529     C                     Z-ADD*ZEROS    WAPNM2 152                      S01158
097600200529     C                     Z-ADD*ZEROS    WAPNM3 153                      S01158
097700200529     C*
097800200529     C** CALCULATE VALUES FOR A CALL PERCENTAGE I.E. NOT AN AMOUNT
097900200529     C*
098000200529     C           SDPC      IFNE 0
098100200529     C*
098200200529     C** CALCULATE AVERAGE PRICE PRIOR TO THE CALL
098300200529     C*
098400200529     C           CSPT      IFNE *ZEROS
098500200529     C           CSNT      ANDNE*ZEROS                                    E24337
098600200529     C           CSPT      DIV  CSNT      WNAPTT 158H
098700200529     C*                                                                   S01158
098800200529     C* Allow for nominal and nominal currency decimal places             S01158
098900200529     C*                                                                   S01158
099000200529     C           5         SUB  NMDP      DEC     10                      S01158
099100200529     C                     ADD  CDP       DEC                             S01158
099200200529     C                     DIV  POWER8,DECWNAPTT                          S01158
099300200529     C*                                                                   S01158
099400200529     C* Price basis security                                              S01158
099500200529     C*                                                                   S01158
099600200529     C           SPBS      IFEQ 'P'                                       S01158
099700200529     C                     MULT 100       WNAPTT                          S01158
099800200529     C                     END                                            S01158
099900200529     C                     ELSE
100000200529     C                     Z-ADD*ZEROS    WNAPTT
100100200529     C                     END
100200200529     C*
100300200529     C           CSPV      IFNE *ZEROS
100400200529     C           CSNV      ANDNE*ZEROS                                    E24337
100500200529     C           CSPV      DIV  CSNV      WNAPVV 158H
100600200529     C*                                                                   S01158
100700200529     C* Allow for nominal and nominal currency decimal places             S01158
100800200529     C*                                                                   S01158
100900200529     C           5         SUB  NMDP      DEC     10                      S01158
101000200529     C                     ADD  CDP       DEC                             S01158
101100200529     C                     DIV  POWER8,DECWNAPVV                          S01158
101200200529     C*                                                                   S01158
101300200529     C* Price basis security                                              S01158
101400200529     C*                                                                   S01158
101500200529     C           SPBS      IFEQ 'P'                                       S01158
101600200529     C                     MULT 100       WNAPVV                          S01158
101700200529     C                     END                                            S01158
101800200529     C*
101900200529     C                     ELSE
102000200529     C                     Z-ADD*ZEROS    WNAPVV
102100200529     C                     END
102200200529     C*
102300200529     C** CALCULATE NEW AVERAGE PRICE AFTER THE CALL
102400200529     C*
102500200529     C           WNAPTT    MULT SDPC      WNAPT
102600200529     C           WNAPVV    MULT SDPC      WNAPV
102700200529     C           WNAPT     DIV  100       WNAPT     H
102800200529     C           WNAPV     DIV  100       WNAPV     H
102900200529     C           WNAPV     ADD  WNAPVV    WNAPV
103000200529     C           WNAPT     ADD  WNAPTT    WNAPT
103100200529     C*
103200200529     C** CALCULATE NEW AP NUMERATOR
103300200529     C*
103400200529     C********** CSNT      MULT WNAPT     WAPNMT                          S01158
103500200529     C********** CSNV      MULT WNAPV     WAPNMV                          S01158
103600200529     C   21      CSNT      MULT WNAPT     WAPNM0                          S01158
103700200529     C   22      CSNT      MULT WNAPT     WAPNM1                          S01158
103800200529     C   23      CSNT      MULT WNAPT     WAPNM2                          S01158
103900200529     C   24      CSNT      MULT WNAPT     WAPNM3                          S01158
104000200529     C*                                                                   S01158
104100200529     C   21                MOVE WAPNM0    WAPNMT                          S01158
104200200529     C   22                MOVE WAPNM1    WAPNMT                          S01158
104300200529     C   23                MOVE WAPNM2    WAPNMT                          S01158
104400200529     C   24                MOVE WAPNM3    WAPNMT                          S01158
104500200529     C*                                                                   S01158
104600200529     C   21      CSNV      MULT WNAPV     WAPNM0                          S01158
104700200529     C   22      CSNV      MULT WNAPV     WAPNM1                          S01158
104800200529     C   23      CSNV      MULT WNAPV     WAPNM2                          S01158
104900200529     C   24      CSNV      MULT WNAPV     WAPNM3                          S01158
105000200529     C*                                                                   S01158
105100200529     C   21                MOVE WAPNM0    WAPNMV                          S01158
105200200529     C   22                MOVE WAPNM1    WAPNMV                          S01158
105300200529     C   23                MOVE WAPNM2    WAPNMV                          S01158
105400200529     C   24                MOVE WAPNM3    WAPNMV                          S01158
105500200529     C*                                                                   S01158
105600200529     C* Price basis security                                              S01158
105700200529     C*                                                                   S01158
105800200529     C           SPBS      IFEQ 'P'                                       S01158
105900200529     C                     DIV  100       WAPNMT                          S01158
106000200529     C                     DIV  100       WAPNMV                          S01158
106100200529     C                     END                                            S01158
106200200529     C*                                                                   S01158
106300200529     C* Allow for nominal decimal places                                  S01158
106400200529     C*                                                                   S01158
106500200529     C           5         SUB  NMDP      DEC                             S01158
106600200529     C                     MULT POWER8,DECWAPNMT                          S01158
106700200529     C                     MULT POWER8,DECWAPNMV                          S01158
106800200529     C*
106900200529     C                     END
107000200529     C*
107100200529     C** CALCULATE VALUES FOR CALL AMOUNT I.E. NOT A PERCENTAGE
107200200529     C*
107300200529     C           SDPP      IFNE 0
107400200529     C*
107500200529     C** CALCULATE AVERAGE PRICE PRIOR TO THE CALL
107600200529     C*
107700200529     C           CSPT      IFNE *ZEROS
107800200529     C           CSNT      ANDNE*ZEROS                                    E24337
107900200529     C           CSPT      DIV  CSNT      WNAPT     H
108000200529     C*                                                                   S01158
108100200529     C* Allow for nominal and nominal currency decimal places             S01158
108200200529     C*                                                                   S01158
108300200529     C           5         SUB  NMDP      DEC     10                      S01158
108400200529     C                     ADD  CDP       DEC                             S01158
108500200529     C                     DIV  POWER8,DECWNAPT                           S01158
108600200529     C*                                                                   S01158
108700200529     C* Price basis security                                              S01158
108800200529     C*                                                                   S01158
108900200529     C           SPBS      IFEQ 'P'                                       S01158
109000200529     C                     MULT 100       WNAPT                           S01158
109100200529     C                     END                                            S01158
109200200529     C*                                                                   S01158
109300200529     C                     ELSE
109400200529     C                     Z-ADD*ZEROS    WNAPT
109500200529     C                     END
109600200529     C*
109700200529     C           CSPV      IFNE *ZEROS
109800200529     C           CSNV      ANDNE*ZEROS                                    E24337
109900200529     C           CSPV      DIV  CSNV      WNAPV     H
110000200529     C*                                                                   S01158
110100200529     C* Allow for nominal and nominal currency decimal places             S01158
110200200529     C*                                                                   S01158
110300200529     C           5         SUB  NMDP      DEC     10                      S01158
110400200529     C                     ADD  CDP       DEC                             S01158
110500200529     C                     DIV  POWER8,DECWNAPV                           S01158
110600200529     C*                                                                   S01158
110700200529     C* Price basis security                                              S01158
110800200529     C*                                                                   S01158
110900200529     C           SPBS      IFEQ 'P'                                       S01158
111000200529     C                     MULT 100       WNAPV                           S01158
111100200529     C                     END                                            S01158
111200200529     C*                                                                   S01158
111300200529     C                     ELSE
111400200529     C                     Z-ADD*ZEROS    WNAPV
111500200529     C                     END
111600200529     C*
111700200529     C** CALCULATE NEW AVERAGE PRICE AFTER THE CALL FOR CALL AMOUNT
111800200529     C*
111900200529     C           WNAPT     ADD  SDPP      WNAPT
112000200529     C           WNAPV     ADD  SDPP      WNAPV
112100200529     C*
112200200529     C** CALCULATE NEW AP NUMERATOR
112300200529     C*
112400200529     C********** CSNT      MULT WNAPT     WAPNMT                          S01158
112500200529     C********** CSNV      MULT WNAPV     WAPNMV                          S01158
112600200529     C   21      CSNT      MULT WNAPT     WAPNM0                          S01158
112700200529     C   22      CSNT      MULT WNAPT     WAPNM1                          S01158
112800200529     C   23      CSNT      MULT WNAPT     WAPNM2                          S01158
112900200529     C   24      CSNT      MULT WNAPT     WAPNM3                          S01158
113000200529     C*                                                                   S01158
113100200529     C   21                MOVE WAPNM0    WAPNMT                          S01158
113200200529     C   22                MOVE WAPNM1    WAPNMT                          S01158
113300200529     C   23                MOVE WAPNM2    WAPNMT                          S01158
113400200529     C   24                MOVE WAPNM3    WAPNMT                          S01158
113500200529     C*                                                                   S01158
113600200529     C   21      CSNV      MULT WNAPV     WAPNM0                          S01158
113700200529     C   22      CSNV      MULT WNAPV     WAPNM1                          S01158
113800200529     C   23      CSNV      MULT WNAPV     WAPNM2                          S01158
113900200529     C   24      CSNV      MULT WNAPV     WAPNM3                          S01158
114000200529     C*                                                                   S01158
114100200529     C   21                MOVE WAPNM0    WAPNMV                          S01158
114200200529     C   22                MOVE WAPNM1    WAPNMV                          S01158
114300200529     C   23                MOVE WAPNM2    WAPNMV                          S01158
114400200529     C   24                MOVE WAPNM3    WAPNMV                          S01158
114500200529     C*                                                                   S01158
114600200529     C* Price basis security                                              S01158
114700200529     C*                                                                   S01158
114800200529     C           SPBS      IFEQ 'P'                                       S01158
114900200529     C                     DIV  100       WAPNMT                          S01158
115000200529     C                     DIV  100       WAPNMV                          S01158
115100200529     C                     END                                            S01158
115200200529     C*                                                                   S01158
115300200529     C* Allow for nominal decimal places                                  S01158
115400200529     C*                                                                   S01158
115500200529     C           5         SUB  NMDP      DEC                             S01158
115600200529     C                     MULT POWER8,DECWAPNMT                          S01158
115700200529     C                     MULT POWER8,DECWAPNMV                          S01158
115800200529     C*                                                                   S01158
115900200529     C                     END
116000200529     C*
116100200529     C                     ENDSR
116200200529     C*
116300200529     C*****************************************************************
116400200529      /EJECT
116500200529     C*****************************************************************
116600200529     C*                                                               *
116700200529     C* TRADE -CALCULATE NEW AVERAGE PRICE NUMERATOR FOR A TRADE      *
116800200529     C*        ACTION FOR EACH ACTION ON A CUSTOMER POSITION          *
116900200529     C**                                                              *
117000200529     C*****************************************************************
117100200529     C*
117200200529     C           TRADE     BEGSR                           ** TRADE  **
117300200529     C*
117400200529     C**  CALCULATE NOMINAL AFTER TRADE ACTION
117500200529     C*
117600200529     C           CSTB      IFNE 0
117700200529     C           WREC      ANDNE'C'                                       E16849
117800200529     C*
117900200529     C* TRADE ACTION IS TRADE DATE BASIS IF CSTB IS NOT 0
118000200529     C*
118100200529     C           CSOA      IFEQ 'TS'
118200200529     C           WNCSNT    ADD  CSNL      WNCSNT
118300200529     C                     END
118400200529     C           CSOA      IFEQ 'TP'
118500200529     C           WNCSNT    SUB  CSNL      WNCSNT
118600200529     C                     END
118700200529     C*
118800200529     C** IF SALE AND NOW LONG, OR PURCHASE AND NOW SHORT
118900200529     C*
119000200529     C           CSOA      IFEQ 'TS'
119100200529     C           WNCSNT    ANDGT0
119200200529     C           CSOA      OREQ 'TP'
119300200529     C           WNCSNT    ANDLT0
119400200529     C*
119500200529     C** IF POSITION HAS CHANGED FROM LONG TO SHORT OR SHORT TO LONG
119600200529     C*
119700200529     C           CSOA      IFEQ 'TS'
119800200529     C           WPCSNT    ANDLT0
119900200529     C           CSOA      OREQ 'TP'
120000200529     C           WPCSNT    ANDGT0
120100200529     C*
120200200529     C** CALCULATE NEW AVERAGE PRICE AS CONTRACT PRICE
120300200529     C** AND NEW AP NUMERATOR AS CONTRACT PRICE TIMES NEW NOMINAL
120400200529     C*
120500200529     C                     Z-ADDCSCP      WNAPT
120600200529     C           SPBS      IFEQ 'P'                                       E15996
120700200529     C                     DIV  100       WNAPT                           E15996
120800200529     C                     END                                            E15996
120900200529     C********** WNAPT     MULT WNCSNT    WAPNMT                          S01158
121000200529     C********** WNAPT     MULT WNCSNT    WAPNMT                          S01158
121100200529     C***21***** WNCSNT    MULT WNAPT     WAPNM0                                     S01158 MD051140
121200200529     C***22***** WNCSNT    MULT WNAPT     WAPNM1                                     S01158 MD051140
121300200529     C***23***** WNCSNT    MULT WNAPT     WAPNM2                                     S01158 MD051140
121400200529     C***24***** WNCSNT    MULT WNAPT     WAPNM3                                     S01158 MD051140
121500200529     C   21      WNCSNT    MULT WNAPT     WAPNM0    H                                       MD051140
121600200529     C   22      WNCSNT    MULT WNAPT     WAPNM1    H                                       MD051140
121700200529     C   23      WNCSNT    MULT WNAPT     WAPNM2    H                                       MD051140
121800200529     C   24      WNCSNT    MULT WNAPT     WAPNM3    H                                       MD051140
121900200529     C*                                                                   S01158
122000200529     C   21                MOVE WAPNM0    WAPNMT                          S01158
122100200529     C   22                MOVE WAPNM1    WAPNMT                          S01158
122200200529     C   23                MOVE WAPNM2    WAPNMT                          S01158
122300200529     C   24                MOVE WAPNM3    WAPNMT                          S01158
122400200529     C*                                                                   S01158
122500200529     C* Price basis security                                              S01158
122600200529     C*                                                                   S01158
122700200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
122800200529     C***********          DIV  100       WAPNMT                 S01158   E15996
122900200529     C***********          END                                   S01158   E15996
123000200529     C*                                                                   S01158
123100200529     C* Allow for nominal decimal places                                  S01158
123200200529     C*                                                                   S01158
123300200529     C           5         SUB  NMDP      DEC                             S01158
123400200529     C                     MULT POWER8,DECWAPNMT                          S01158
123500200529     C*                                                                   S01158
123600200529     C                     ELSE
123700200529     C*
123800200529     C**I.E. ELSE IT IS NOT CHANGE FROM SHORT TO LONG NOR LONG TO SHORT
123900200529     C* SO CALCULATE NEW AP NUMERATOR AS CURRENT VALUE PLUS CHANGE VALU
124000200529     C*
124100200529     C           CSTB      IFLT *ZEROS                                    E15996
124200200529     C           WAPNMT    SUB  CSTB      WAPNMT                          E15996
124300200529     C                     ELSE                                           E15996
124400200529     C           WAPNMT    ADD  CSTB      WAPNMT
124500200529     C                     END                                            E15996
124600200529     C*                                                                   E15996
124700200529     C                     END
124800200529     C*
124900200529     C**  ELSE ... NOT (TS AND NOW LONG) NOR (TP AND NOW SHORT)
125000200529     C*
125100200529     C                     ELSE
125200200529     C*
125300200529     C** CALCULATE CURRENT AP AP NUMERATOR/PREVIOUS NOMINAL
125400200529     C*
125500200529     C           WAPNMT    IFNE *ZERO                                     E24337
125600200529     C           WPCSNT    ANDNE*ZERO                                     E24337
125700200529     C           WAPNMT    DIV  WPCSNT    WCAPT     H
125800200529     C*                                                                   S01158
125900200529     C* Allow for nominal and nominal currency decimal places             S01158
126000200529     C*                                                                   S01158
126100200529     C           5         SUB  NMDP      DEC     10                      S01158
126200200529     C                     ADD  CDP       DEC                             S01158
126300200529     C                     DIV  POWER8,DECWCAPT                           S01158
126400200529      *                                                                   E24337
126500200529     C                     ELSE                                           E24337
126600200529     C                     Z-ADD*ZEROS    WCAPT                           E24337
126700200529     C                     END                                            E24337
126800200529     C*                                                                   S01158
126900200529     C* Price basis security                                              S01158
127000200529     C*                                                                   S01158
127100200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
127200200529     C***********          MULT 100       WCAPT                  S01158   E15996
127300200529     C***********          END                                   S01158   E15996
127400200529     C*
127500200529     C**  AND CALCULATE NEW AP NUMERATOR AS CURRENT AP TIMES NEW NOMNL.
127600200529     C*
127700200529     C********** WCAPT     MULT WNCSNT    WAPNMT                          S01158
127800200529     C***21***** WNCSNT    MULT WCAPT     WAPNM0                                     S01158 MD051140
127900200529     C***22***** WNCSNT    MULT WCAPT     WAPNM1                                     S01158 MD051140
128000200529     C***23***** WNCSNT    MULT WCAPT     WAPNM2                                     S01158 MD051140
128100200529     C***24***** WNCSNT    MULT WCAPT     WAPNM3                                     S01158 MD051140
128200200529     C   21      WNCSNT    MULT WCAPT     WAPNM0    H                                       MD051140
128300200529     C   22      WNCSNT    MULT WCAPT     WAPNM1    H                                       MD051140
128400200529     C   23      WNCSNT    MULT WCAPT     WAPNM2    H                                       MD051140
128500200529     C   24      WNCSNT    MULT WCAPT     WAPNM3    H                                       MD051140
128600200529     C*                                                                   S01158
128700200529     C   21                MOVE WAPNM0    WAPNMT                          S01158
128800200529     C   22                MOVE WAPNM1    WAPNMT                          S01158
128900200529     C   23                MOVE WAPNM2    WAPNMT                          S01158
129000200529     C   24                MOVE WAPNM3    WAPNMT                          S01158
129100200529     C*                                                                   S01158
129200200529     C* Price basis security                                              S01158
129300200529     C*                                                                   S01158
129400200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
129500200529     C***********          DIV  100       WAPNMT                 S01158   E15996
129600200529     C***********          END                                   S01158   E15996
129700200529     C*                                                                   S01158
129800200529     C* Allow for nominal decimal places                                  S01158
129900200529     C*                                                                   S01158
130000200529     C           5         SUB  NMDP      DEC                             S01158
130100200529     C                     MULT POWER8,DECWAPNMT                          S01158
130200200529     C*                                                                   S01158
130300200529     C                     END
130400200529     C                     Z-ADDWNCSNT    WPCSNT
130500200529     C*
130600200529     C                     END
130700200529     C*
130800200529     C           CSVB      IFNE 0
130900200529     C           WREC      ANDNE'C'                                       E16849
131000200529     C*
131100200529     C* TRADE ACTION IS VALUE DATE BASIS IF CSVB IS NOT 0
131200200529     C*
131300200529     C           CSOA      IFEQ 'TS'
131400200529     C           WNCSNV    ADD  CSNL      WNCSNV
131500200529     C                     END
131600200529     C           CSOA      IFEQ 'TP'
131700200529     C           WNCSNV    SUB  CSNL      WNCSNV
131800200529     C                     END
131900200529     C*
132000200529     C** IF SALE AND NOW LONG, OR PURCHASE AND NOW SHORT
132100200529     C*
132200200529     C           CSOA      IFEQ 'TS'
132300200529     C           WNCSNV    ANDGT0
132400200529     C           CSOA      OREQ 'TP'
132500200529     C           WNCSNV    ANDLT0
132600200529     C*
132700200529     C** IF POSITION HAS CHANGED FROM LONG TO SHORT OR SHORT TO LONG
132800200529     C*
132900200529     C           CSOA      IFEQ 'TS'
133000200529     C           WPCSNV    ANDLT0
133100200529     C           CSOA      OREQ 'TP'
133200200529     C           WPCSNV    ANDGT0
133300200529     C*
133400200529     C** CALCULATE NEW AVERAGE PRICE AS CONTRACT PRICE
133500200529     C** AND NEW AP NUMERATOR AS CONTRACT PRICE TIMES NEW NOMINAL
133600200529     C*
133700200529     C                     Z-ADDCSCP      WNAPV
133800200529     C*                                                                   S01158
133900200529     C* Price basis security                                     S01158   E15996
134000200529     C*                                                          S01158   E15996
134100200529     C           SPBS      IFEQ 'P'                              S01158   E15996
134200200529     C***********          DIV  100       WAPNMV                   E15996 E36711
134300200529     C                     DIV  100       WNAPV                           E36711
134400200529     C                     END                                   S01158   E15996
134500200529     C********** WNAPV     MULT WNCSNV    WAPNMV                          S01158
134600200529     C***21***** WNCSNV    MULT WNAPV     WAPNM0                                     S01158 MD051140
134700200529     C***22***** WNCSNV    MULT WNAPV     WAPNM1                                     S01158 MD051140
134800200529     C***23***** WNCSNV    MULT WNAPV     WAPNM2                                     S01158 MD051140
134900200529     C***24***** WNCSNV    MULT WNAPV     WAPNM3                                     S01158 MD051140
135000200529     C   21      WNCSNV    MULT WNAPV     WAPNM0    H                                       MD051140
135100200529     C   22      WNCSNV    MULT WNAPV     WAPNM1    H                                       MD051140
135200200529     C   23      WNCSNV    MULT WNAPV     WAPNM2    H                                       MD051140
135300200529     C   24      WNCSNV    MULT WNAPV     WAPNM3    H                                       MD051140
135400200529     C*                                                                   S01158
135500200529     C   21                MOVE WAPNM0    WAPNMV                          S01158
135600200529     C   22                MOVE WAPNM1    WAPNMV                          S01158
135700200529     C   23                MOVE WAPNM2    WAPNMV                          S01158
135800200529     C   24                MOVE WAPNM3    WAPNMV                          S01158
135900200529     C*                                                                   S01158
136000200529     C* Price basis security                                              S01158
136100200529     C*                                                                   S01158
136200200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
136300200529     C***********          DIV  100       WAPNMV                 S01158   E15996
136400200529     C***********          END                                   S01158   E15996
136500200529     C*                                                                   S01158
136600200529     C* Allow for nominal decimal places                                  S01158
136700200529     C*                                                                   S01158
136800200529     C           5         SUB  NMDP      DEC                             S01158
136900200529     C                     MULT POWER8,DECWAPNMV                          S01158
137000200529     C*                                                                   S01158
137100200529     C                     ELSE
137200200529     C*
137300200529     C**I.E. ELSE IT IS NOT CHANGE FROM SHORT TO LONG NOR LONG TO SHORT
137400200529     C* SO CALCULATE NEW AP NUMERATOR AS CURRENT VALUE PLUS CHANGE VALU
137500200529     C*
137600200529     C           CSVB      IFLT *ZEROS                                    E15996
137700200529     C           WAPNMV    SUB  CSVB      WAPNMV                          E15996
137800200529     C                     ELSE                                           E15996
137900200529     C           WAPNMV    ADD  CSVB      WAPNMV
138000200529     C                     END                                            E15996
138100200529     C*                                                                   E15996
138200200529     C                     END
138300200529     C*
138400200529     C**  ELSE ... NOT (TS AND NOW LONG) NOR (TP AND NOW SHORT)
138500200529     C*
138600200529     C                     ELSE
138700200529     C*
138800200529     C** CALCULATE CURRENT AP AP NUMERATOR/PREVIOUS NOMINAL
138900200529     C*
139000200529     C           WAPNMV    DIV  WPCSNV    WCAPV     H
139100200529     C*                                                                   S01158
139200200529     C* Allow for nominal and nominal currency decimal places             S01158
139300200529     C*                                                                   S01158
139400200529     C           5         SUB  NMDP      DEC     10                      S01158
139500200529     C                     ADD  CDP       DEC                             S01158
139600200529     C                     DIV  POWER8,DECWCAPV                           S01158
139700200529     C*                                                                   S01158
139800200529     C* Price basis security                                              S01158
139900200529     C*                                                                   S01158
140000200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
140100200529     C***********          MULT 100       WCAPV                  S01158   E15996
140200200529     C***********          END                                   S01158   E15996
140300200529     C*
140400200529     C**  AND CALCULATE NEW AP NUMERATOR AS CURRENT AP TIMES NEW NOMNL.
140500200529     C*
140600200529     C********** WCAPV     MULT WNCSNV    WAPNMV                          S01158
140700200529     C***21***** WNCSNV    MULT WCAPV     WAPNM0                                     S01158 MD051140
140800200529     C***22***** WNCSNV    MULT WCAPV     WAPNM1                                     S01158 MD051140
140900200529     C***23***** WNCSNV    MULT WCAPV     WAPNM2                                     S01158 MD051140
141000200529     C***24***** WNCSNV    MULT WCAPV     WAPNM3                                     S01158 MD051140
141100200529     C   21      WNCSNV    MULT WCAPV     WAPNM0    H                                       MD051140
141200200529     C   22      WNCSNV    MULT WCAPV     WAPNM1    H                                       MD051140
141300200529     C   23      WNCSNV    MULT WCAPV     WAPNM2    H                                       MD051140
141400200529     C   24      WNCSNV    MULT WCAPV     WAPNM3    H                                       MD051140
141500200529     C*                                                                   S01158
141600200529     C   21                MOVE WAPNM0    WAPNMV                          S01158
141700200529     C   22                MOVE WAPNM1    WAPNMV                          S01158
141800200529     C   23                MOVE WAPNM2    WAPNMV                          S01158
141900200529     C   24                MOVE WAPNM3    WAPNMV                          S01158
142000200529     C*                                                                   S01158
142100200529     C* Price basis security                                              S01158
142200200529     C*                                                                   S01158
142300200529     C***********SPBS      IFEQ 'P'                                S01158 E15996
142400200529     C***********          DIV  100       WAPNMV                   S01158 E15996
142500200529     C***********          END                                     S01158 E15996
142600200529     C*                                                                   S01158
142700200529     C* Allow for nominal decimal places                                  S01158
142800200529     C*                                                                   S01158
142900200529     C           5         SUB  NMDP      DEC                             S01158
143000200529     C                     MULT POWER8,DECWAPNMV                          S01158
143100200529     C*                                                                   S01158
143200200529     C                     END
143300200529     C*
143400200529     C                     Z-ADDWNCSNV    WPCSNV
143500200529     C                     END
143600200529     C*                                                                   E15996
143700200529     C           WAPNMT    IFLT *ZEROS                                    E15996
143800200529     C                     Z-SUBWAPNMT    WAPNMT                          E15996
143900200529     C                     END                                            E15996
144000200529     C*                                                                   E15996
144100200529     C           WAPNMV    IFLT *ZEROS                                    E15996
144200200529     C                     Z-SUBWAPNMV    WAPNMV                          E15996
144300200529     C                     END                                            E15996
144400200529     C*
144500200529     C                     ENDSR
144600200529     C*****************************************************************
144700200529      /EJECT
144800200529     C*****************************************************************
144900200529     C*                                                               *
145000200529     C* CALL  - CALCULATE NEW AV. PRICE NUMERATOR FOR A DEPOT MOVT.   *
145100200529     C*         FOR EACH PORTFOLIO CUSTOMER WALK-IN / WALK-OUT.       *
145200200529     C**                                                              *
145300200529     C*****************************************************************
145400200529     C*
145500200529     C           DMVT      BEGSR                           ** DMVT   **
145600200529     C*
145700200529     C**  CALCULATE NOMINAL AFTER DEPOT MOVEMENT
145800200529     C*
145900200529     C           CSVB      IFNE 0
146000200529     C           WREC      ANDNE'C'                                       E16849
146100200529     C*
146200200529     C* DEPOT MOVT. IS VALUE DATE BASIS IF IF CSVB IS NOT 0
146300200529     C*
146400200529     C***********CSOA      IFEQ 'WI'                                      E14838
146500200529     C           CSOA      IFEQ 'CI'                                      E14838
146600200529     C           WNCSNV    ADD  CSNL      WNCSNV
146700200529     C                     END
146800200529     C***********CSOA      IFEQ 'WO'                                      E14838
146900200529     C           CSOA      IFEQ 'CO'                                      E14838
147000200529     C           WNCSNV    SUB  CSNL      WNCSNV
147100200529     C                     END
147200200529     C*
147300200529     C** IF SALE AND NOW LONG, OR PURCHASE AND NOW SHORT
147400200529     C*
147500200529     C***********CSOA      IFEQ 'WI'                                      E14838
147600200529     C           CSOA      IFEQ 'CI'                                      E14838
147700200529     C           WNCSNV    ANDGT0
147800200529     C***********CSOA      OREQ 'WO'                                      E14838
147900200529     C           CSOA      OREQ 'CO'                                      E14838
148000200529     C           WNCSNV    ANDLT0
148100200529     C*
148200200529     C** IF POSITION HAS CHANGED FROM LONG TO SHORT OR SHORT TO LONG
148300200529     C*
148400200529     C***********CSOA      IFEQ 'WI'                                      E14838
148500200529     C           CSOA      IFEQ 'CI'                                      E14838
148600200529     C           WPCSNV    ANDLT0
148700200529     C***********CSOA      OREQ 'WO'                                      E14838
148800200529     C           CSOA      OREQ 'CO'                                      E14838
148900200529     C           WPCSNV    ANDGT0
149000200529     C*
149100200529     C** CALCULATE NEW AVERAGE PRICE AS MARKET PRICE
149200200529     C** AND NEW AP NUMERATOR AS MARKET PRICE TIMES NEW NOMINAL
149300200529     C*
149400200529     C* MARKET PRICE IS CHANGE TO AP NUM (VALUE) DIV. BY ACTION NOMINAL
149500200529     C*
149600200529     C           CSVB      IFNE *ZEROS                                    E24337
149700200529     C           CSNL      ANDNE*ZEROS                                    E24337
149800200529     C           CSVB      DIV  CSNL      WNAPV     H
149900200529     C*                                                                   S01158
150000200529     C* Allow for nominal and nominal currency decimal places             S01158
150100200529     C*                                                                   S01158
150200200529     C           5         SUB  NMDP      DEC     10                      S01158
150300200529     C                     ADD  CDP       DEC                             S01158
150400200529     C                     DIV  POWER8,DECWNAPV                           S01158
150500200529      *                                                                   E24337
150600200529     C                     ELSE                                           E24337
150700200529     C                     Z-ADD*ZEROS    WNAPV                           E24337
150800200529     C                     END                                            E24337
150900200529     C*                                                                   S01158
151000200529     C* Price basis security                                              S01158
151100200529     C*                                                                   S01158
151200200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
151300200529     C***********          MULT 100       WNAPV                  S01158   E15996
151400200529     C***********          END                                   S01158   E15996
151500200529     C*                                                                   S01158
151600200529     C********** WNAPV     MULT WNCSNV    WAPNMV                          S01158
151700200529     C   21      WNCSNV    MULT WNAPV     WAPNM0                          S01158
151800200529     C   22      WNCSNV    MULT WNAPV     WAPNM1                          S01158
151900200529     C   23      WNCSNV    MULT WNAPV     WAPNM2                          S01158
152000200529     C   24      WNCSNV    MULT WNAPV     WAPNM3                          S01158
152100200529     C*                                                                   S01158
152200200529     C   21                MOVE WAPNM0    WAPNMV                          S01158
152300200529     C   22                MOVE WAPNM1    WAPNMV                          S01158
152400200529     C   23                MOVE WAPNM2    WAPNMV                          S01158
152500200529     C   24                MOVE WAPNM3    WAPNMV                          S01158
152600200529     C*                                                                   S01158
152700200529     C* Price basis security                                              S01158
152800200529     C*                                                                   S01158
152900200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
153000200529     C***********          DIV  100       WAPNMV                 S01158   E15996
153100200529     C***********          END                                   S01158   E15996
153200200529     C*                                                                   S01158
153300200529     C* Allow for nominal decimal places                                  S01158
153400200529     C*                                                                   S01158
153500200529     C           5         SUB  NMDP      DEC                             S01158
153600200529     C                     MULT POWER8,DECWAPNMV                          S01158
153700200529     C                     ELSE
153800200529     C*
153900200529     C**I.E. ELSE IT IS NOT CHANGE FROM SHORT TO LONG NOR LONG TO SHORT
154000200529     C* SO CALCULATE NEW AP NUMERATOR AS CURRENT VALUE PLUS CHANGE VALU
154100200529     C*
154200200529     C           CSVB      IFLT *ZEROS                                    E15996
154300200529     C           WAPNMV    SUB  CSVB      WAPNMV                          E15996
154400200529     C                     ELSE                                           E15996
154500200529     C           WAPNMV    ADD  CSVB      WAPNMV
154600200529     C                     END                                            E15996
154700200529     C                     END
154800200529     C*
154900200529     C**  ELSE ... NOT (TS AND NOW LONG) NOR (TP AND NOW SHORT)
155000200529     C*
155100200529     C                     ELSE
155200200529     C*
155300200529     C** CALCULATE CURRENT AP AS AP NUMERATOR/PREVIOUS NOMINAL
155400200529     C*
155500200529     C           WAPNMV    IFNE *ZEROS                                    E24337
155600200529     C           WPCSNV    ANDNE*ZEROS                                    E24337
155700200529     C           WAPNMV    DIV  WPCSNV    WCAPV     H
155800200529     C*                                                                   S01158
155900200529     C* Allow for nominal and nominal currency decimal places             S01158
156000200529     C*                                                                   S01158
156100200529     C           5         SUB  NMDP      DEC     10                      S01158
156200200529     C                     ADD  CDP       DEC                             S01158
156300200529     C                     DIV  POWER8,DECWCAPV                           S01158
156400200529      *                                                                   E24337
156500200529     C                     ELSE                                           E24337
156600200529     C                     Z-ADD*ZEROS    WCAPV                           E24337
156700200529     C                     END                                            E24337
156800200529     C*                                                                   S01158
156900200529     C* Price basis security                                              S01158
157000200529     C*                                                                   S01158
157100200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
157200200529     C***********          MULT 100       WCAPV                  S01158   E15996
157300200529     C***********          END                                   S01158   E15996
157400200529     C*
157500200529     C**  AND CALCULATE NEW AP NUMERATOR AS CURRENT AP TIMES NEW NOMNL.
157600200529     C*
157700200529     C********** WCAPV     MULT WNCSNV    WAPNMV                          S01158
157800200529     C   21      WNCSNV    MULT WCAPV     WAPNM0                          S01158
157900200529     C   22      WNCSNV    MULT WCAPV     WAPNM1                          S01158
158000200529     C   23      WNCSNV    MULT WCAPV     WAPNM2                          S01158
158100200529     C   24      WNCSNV    MULT WCAPV     WAPNM3                          S01158
158200200529     C*                                                                   S01158
158300200529     C   21                MOVE WAPNM0    WAPNMV                          S01158
158400200529     C   22                MOVE WAPNM1    WAPNMV                          S01158
158500200529     C   23                MOVE WAPNM2    WAPNMV                          S01158
158600200529     C   24                MOVE WAPNM3    WAPNMV                          S01158
158700200529     C*                                                                   S01158
158800200529     C* Price basis security                                              S01158
158900200529     C*                                                                   S01158
159000200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
159100200529     C***********          DIV  100       WAPNMV                 S01158   E15996
159200200529     C***********          END                                   S01158   E15996
159300200529     C*                                                                   S01158
159400200529     C* Allow for nominal decimal places                                  S01158
159500200529     C*                                                                   S01158
159600200529     C           5         SUB  NMDP      DEC                             S01158
159700200529     C                     MULT POWER8,DECWAPNMV                          S01158
159800200529     C                     END
159900200529     C*
160000200529     C                     Z-ADDWNCSNV    WPCSNV
160100200529     C                     END
160200200529     C*
160300200529     C           CSTB      IFNE 0
160400200529     C           WREC      ANDNE'C'                                       E16849
160500200529     C*
160600200529     C* DEPOT MOVT. IS TRADE DATE BASIS IF CSTB IS NOT 0
160700200529     C*
160800200529     C***********CSOA      IFEQ 'WI'                                      E14838
160900200529     C           CSOA      IFEQ 'CI'                                      E14838
161000200529     C           WNCSNT    ADD  CSNL      WNCSNT
161100200529     C                     END
161200200529     C***********CSOA      IFEQ 'WO'                                      E14838
161300200529     C           CSOA      IFEQ 'CO'                                      E14838
161400200529     C           WNCSNT    SUB  CSNL      WNCSNT
161500200529     C                     END
161600200529     C*
161700200529     C** IF SALE AND NOW LONG, OR PURCHASE AND NOW SHORT
161800200529     C*
161900200529     C***********CSOA      IFEQ 'WI'                                      E14838
162000200529     C           CSOA      IFEQ 'CI'                                      E14838
162100200529     C           WNCSNT    ANDGT0
162200200529     C***********CSOA      OREQ 'WO'                                      E14838
162300200529     C           CSOA      OREQ 'CO'                                      E14838
162400200529     C           WNCSNT    ANDLT0
162500200529     C*
162600200529     C** IF POSITION HAS CHANGED FROM LONG TO SHORT OR SHORT TO LONG
162700200529     C*
162800200529     C***********CSOA      IFEQ 'WI'                                      E14838
162900200529     C           CSOA      IFEQ 'CI'                                      E14838
163000200529     C           WPCSNT    ANDLT0
163100200529     C***********CSOA      OREQ 'WO'                                      E14838
163200200529     C           CSOA      OREQ 'CO'                                      E14838
163300200529     C           WPCSNT    ANDGT0
163400200529     C*
163500200529     C** CALCULATE NEW AVERAGE PRICE AS MARKET PRICE
163600200529     C** AND NEW AP NUMERATOR AS MARKET PRICE TIMES NEW NOMINAL
163700200529     C*
163800200529     C* MARKET PRICE IS CHANGE TO AP NUM (TRADE) DIV. BY ACTION NOMINAL
163900200529     C*
164000200529     C           CSTB      IFNE *ZEROS                                    E24337
164100200529     C           CSNL      ANDNE*ZEROS                                    E24337
164200200529     C           CSTB      DIV  CSNL      WNAPT     H
164300200529     C*                                                                   S01158
164400200529     C* Allow for nominal and nominal currency decimal places             S01158
164500200529     C*                                                                   S01158
164600200529     C           5         SUB  NMDP      DEC     10                      S01158
164700200529     C                     ADD  CDP       DEC                             S01158
164800200529     C                     DIV  POWER8,DECWNAPT                           S01158
164900200529      *                                                                   E24337
165000200529     C                     ELSE                                           E24337
165100200529     C                     Z-ADD*ZEROS    WNAPT                           E24337
165200200529     C                     END                                            E24337
165300200529     C*                                                                   S01158
165400200529     C* Price basis security                                              S01158
165500200529     C*                                                                   S01158
165600200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
165700200529     C***********          MULT 100       WNAPT                  S01158   E15996
165800200529     C***********          END                                   S01158   E15996
165900200529     C*                                                                   S01158
166000200529     C********** WNAPT     MULT WNCSNT    WAPNMT                          S01158
166100200529     C   21      WNCSNT    MULT WNAPT     WAPNM0                          S01158
166200200529     C   22      WNCSNT    MULT WNAPT     WAPNM1                          S01158
166300200529     C   23      WNCSNT    MULT WNAPT     WAPNM2                          S01158
166400200529     C   24      WNCSNT    MULT WNAPT     WAPNM3                          S01158
166500200529     C*                                                                   S01158
166600200529     C   21                MOVE WAPNM0    WAPNMT                          S01158
166700200529     C   22                MOVE WAPNM1    WAPNMT                          S01158
166800200529     C   23                MOVE WAPNM2    WAPNMT                          S01158
166900200529     C   24                MOVE WAPNM3    WAPNMT                          S01158
167000200529     C*                                                                   S01158
167100200529     C* Price basis security                                              S01158
167200200529     C*                                                                   S01158
167300200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
167400200529     C***********          DIV  100       WAPNMT                 S01158   E15996
167500200529     C***********          END                                   S01158   E15996
167600200529     C*                                                                   S01158
167700200529     C* Allow for nominal decimal places                                  S01158
167800200529     C*                                                                   S01158
167900200529     C           5         SUB  NMDP      DEC                             S01158
168000200529     C                     MULT POWER8,DECWAPNMT                          S01158
168100200529     C                     ELSE
168200200529     C*
168300200529     C**I.E. ELSE IT IS NOT CHANGE FROM SHORT TO LONG NOR LONG TO SHORT
168400200529     C* SO CALCULATE NEW AP NUMERATOR AS CURRENT VALUE PLUS CHANGE VALU
168500200529     C*
168600200529     C           CSTB      IFLT *ZEROS                                    E15996
168700200529     C           WAPNMT    SUB  CSTB      WAPNMT                          E15996
168800200529     C                     ELSE                                           E15996
168900200529     C           WAPNMT    ADD  CSTB      WAPNMT
169000200529     C                     END                                            E15996
169100200529     C                     END
169200200529     C*
169300200529     C**  ELSE ... NOT (TS AND NOW LONG) NOR (TP AND NOW SHORT)
169400200529     C*
169500200529     C                     ELSE
169600200529     C*
169700200529     C** CALCULATE CURRENT AP AS AP NUMERATOR/PREVIOUS NOMINAL
169800200529     C*
169900200529     C           WAPNMT    IFNE *ZEROS                                    E24337
170000200529     C           WPCSNT    ANDNE*ZEROS                                    E24337
170100200529     C           WAPNMT    DIV  WPCSNT    WCAPT     H
170200200529     C*                                                                   S01158
170300200529     C* Allow for nominal and nominal currency decimal places             S01158
170400200529     C*                                                                   S01158
170500200529     C           5         SUB  NMDP      DEC     10                      S01158
170600200529     C                     ADD  CDP       DEC                             S01158
170700200529     C                     DIV  POWER8,DECWCAPT                           S01158
170800200529      *                                                                   E24337
170900200529     C                     ELSE                                           E24337
171000200529     C                     Z-ADD*ZEROS    WCAPT                           E24337
171100200529     C                     END                                            E24337
171200200529     C*                                                                   S01158
171300200529     C* Price basis security                                              S01158
171400200529     C*                                                                   S01158
171500200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
171600200529     C***********          MULT 100       WCAPT                  S01158   E15996
171700200529     C***********          END                                   S01158   E15996
171800200529     C*
171900200529     C**  AND CALCULATE NEW AP NUMERATOR AS CURRENT AP TIMES NEW NOMNL.
172000200529     C*
172100200529     C********** WCAPT     MULT WNCSNT    WAPNMT                          S01158
172200200529     C   21      WNCSNT    MULT WCAPT     WAPNM0                          S01158
172300200529     C   22      WNCSNT    MULT WCAPT     WAPNM1                          S01158
172400200529     C   23      WNCSNT    MULT WCAPT     WAPNM2                          S01158
172500200529     C   24      WNCSNT    MULT WCAPT     WAPNM3                          S01158
172600200529     C*                                                                   S01158
172700200529     C   21                MOVE WAPNM0    WAPNMT                          S01158
172800200529     C   22                MOVE WAPNM1    WAPNMT                          S01158
172900200529     C   23                MOVE WAPNM2    WAPNMT                          S01158
173000200529     C   24                MOVE WAPNM3    WAPNMT                          S01158
173100200529     C*                                                                   S01158
173200200529     C* Price basis security                                              S01158
173300200529     C*                                                                   S01158
173400200529     C***********SPBS      IFEQ 'P'                              S01158   E15996
173500200529     C***********          DIV  100       WAPNMT                 S01158   E15996
173600200529     C***********          END                                   S01158   E15996
173700200529     C*                                                                   S01158
173800200529     C* Allow for nominal decimal places                                  S01158
173900200529     C*                                                                   S01158
174000200529     C           5         SUB  NMDP      DEC                             S01158
174100200529     C                     MULT POWER8,DECWAPNMT                          S01158
174200200529     C                     END
174300200529     C*
174400200529     C                     Z-ADDWNCSNT    WPCSNT
174500200529     C                     END
174600200529     C                     ENDSR
174700200529     C*****************************************************************
174800200529      /EJECT
174900200529     C*****************************************************************
175000200529     C*                                                               *
175100200529     C* CALL - CALCULATE NEW AV. PRICE NUMERATOR FOR A PRICE CHANGE   *
175200200529     C*         FOR EACH CUSTOMER AVERAGE PRICE CHANGE INPUT          *
175300200529     C**                                                              *
175400200529     C*****************************************************************
175500200529     C*
175600200529     C           PRICEU    BEGSR                           ** PRICEU **
175700200529     C*
175800200529     C** SET NEW AP NUMERATOR TO NEW AVERAGE PRICE TIMES NOMINAL POSN
175900200529     C*  CALCULATE ON EITHER TRADE AND VALUE DATE BASIS.
176000200529     C*
176100200529     C           CSOA      IFEQ 'CT'
176200200529     C********** CSAP      MULT WPCSNT    WAPNMT                          S01158
176300200529     C***21***** WPCSNT    MULT CSAP      WAPNM0                    E15509S01158
176400200529     C***22***** WPCSNT    MULT CSAP      WAPNM1                    E15509S01158
176500200529     C***23***** WPCSNT    MULT CSAP      WAPNM2                    E15509S01158
176600200529     C***24***** WPCSNT    MULT CSAP      WAPNM3                    E15509S01158
176700200529     C   21      WNCSNT    MULT CSAP      WAPNM0                          E15509
176800200529     C   22      WNCSNT    MULT CSAP      WAPNM1                          E15509
176900200529     C   23      WNCSNT    MULT CSAP      WAPNM2                          E15509
177000200529     C   24      WNCSNT    MULT CSAP      WAPNM3                          E15509
177100200529     C*                                                                   S01158
177200200529     C   21                MOVE WAPNM0    WAPNMT                          S01158
177300200529     C   22                MOVE WAPNM1    WAPNMT                          S01158
177400200529     C   23                MOVE WAPNM2    WAPNMT                          S01158
177500200529     C   24                MOVE WAPNM3    WAPNMT                          S01158
177600200529     C*                                                                   S01158
177700200529     C* Price basis security                                              S01158
177800200529     C*                                                                   S01158
177900200529     C           SPBS      IFEQ 'P'                                       S01158
178000200529     C**********           DIV  100       WAPNMT                   S01158 186555
178100200529     C                     DIV  100       WAPNMT    H                     186555
178200200529     C                     END                                            S01158
178300200529     C*                                                                   S01158
178400200529     C* Allow for nominal decimal places                                  S01158
178500200529     C*                                                                   S01158
178600200529     C           5         SUB  NMDP      DEC                             S01158
178700200529     C**********           MULT POWER8,DECWAPNMT                   S01158 186555
178800200529     C                     MULT POWER8,DECWAPNMT    H                     186555
178900200529     C                     END
179000200529     C*
179100200529     C           CSOA      IFEQ 'CV'
179200200529     C********** CSAP      MULT WPCSNV    WAPNMV                          S01158
179300200529     C***21***** WPCSNV    MULT CSAP      WAPNM0                    S01158E15509
179400200529     C***22***** WPCSNV    MULT CSAP      WAPNM1                    S01158E15509
179500200529     C***23***** WPCSNV    MULT CSAP      WAPNM2                    S01158E15509
179600200529     C***24***** WPCSNV    MULT CSAP      WAPNM3                    S01158E15509
179700200529     C   21      WNCSNV    MULT CSAP      WAPNM0                          E15509
179800200529     C   22      WNCSNV    MULT CSAP      WAPNM1                          E15509
179900200529     C   23      WNCSNV    MULT CSAP      WAPNM2                          E15509
180000200529     C   24      WNCSNV    MULT CSAP      WAPNM3                          E15509
180100200529     C*                                                                   S01158
180200200529     C   21                MOVE WAPNM0    WAPNMV                          S01158
180300200529     C   22                MOVE WAPNM1    WAPNMV                          S01158
180400200529     C   23                MOVE WAPNM2    WAPNMV                          S01158
180500200529     C   24                MOVE WAPNM3    WAPNMV                          S01158
180600200529     C*                                                                   S01158
180700200529     C* Price basis security                                              S01158
180800200529     C*                                                                   S01158
180900200529     C           SPBS      IFEQ 'P'                                       S01158
181000200529     C**********           DIV  100       WAPNMV                   S01158 186555
181100200529     C                     DIV  100       WAPNMV    H                     186555
181200200529     C                     END                                            S01158
181300200529     C*                                                                   S01158
181400200529     C* Allow for nominal decimal places                                  S01158
181500200529     C*                                                                   S01158
181600200529     C           5         SUB  NMDP      DEC                             S01158
181700200529     C**********           MULT POWER8,DECWAPNMV                   S01158 186555
181800200529     C                     MULT POWER8,DECWAPNMV    H                     186555
181900200529     C                     END
182000200529     C*
182100200529     C                     Z-ADDWNCSNT    WPCSNT
182200200529     C                     Z-ADDWNCSNV    WPCSNV
182300200529     C                     ENDSR
182400200529     C*
182500200529     C*****************************************************************
182600200529     C/EJECT
182700200529     C*****************************************************************
182800200529     C*                                                               *
182900200529     C*  AUDIT                                                        *
183000200529     C*                                                               *
183100200529     C*****************************************************************
183200200529     C*
183300200529     C           AUDIT     BEGSR                           ** AUDIT **
183400200529     C*
183500200529     C** COMPARE COUNT OF ACTIONS TO AUDIT FILE ACTIONS
183600200529     C*
183700200529     C           *INU8     IFNE '1'
183800200529     C                     READ CAPRHA                   79
183900200529     C*
184000200529     C* DATA BASE ERROR
184100200529     C*
184200200529     C           *IN79     IFEQ '1'
184300200529     C           *LOCK     IN   LDA                                       S01117
184400200529     C                     MOVEL'CAPRHA'  DBFILE           *****************
184500200529     C***********          MOVEL'AUDIT'   DBKEY            ***DB*ERROR*02*E20651
184600200529     C***********          Z-ADD2         DBASE            ***************E20651
184700200529     C                     MOVEL'AUDIT'   DBKEY            ** DB ERROR 10 E20651
184800200529     C                     Z-ADD10        DBASE            ***************E20651
184900200529     C                     OUT  LDA                                       S01117
185000200529     C                     EXSR *PSSR                                     S01117
185100200529     C                     SETON                       U7U8
185200200529     C                     ELSE
185300200529     C                     Z-ADDNORE      SANORE  50
185400200529     C                     Z-ADDSINS      SSINS
185500200529     C                     Z-ADDSAMD      SSAMD
185600200529     C                     END
185700200529     C*
185800200529     C** READ CPOSNA AUDIT RECORD
185900200529     C*
186000200529     C           *INU8     IFNE '1'
186100200529     C                     READ CPOSNA                   79
186200200529     C*
186300200529     C* DATA BASE ERROR
186400200529     C*
186500200529     C           *IN79     IFEQ '1'
186600200529     C           *LOCK     IN   LDA                                       S01117
186700200529     C                     MOVEL'CPOSNA'  DBFILE           *****************
186800200529     C                     MOVEL'AUDIT'   DBKEY            ** DB ERROR 03 **
186900200529     C                     Z-ADD03        DBASE            *****************
187000200529     C                     OUT  LDA                                       S01117
187100200529     C                     EXSR *PSSR                                     S01117
187200200529     C                     SETON                       U7U8
187300200529     C                     ELSE
187400200529     C           ADDREC    IFGT 0                                         E15508
187500200529     C                     ADD  ADDREC    NORE                            E15508
187600200529     C                     UPDATCPOSNAF                                   E15508
187700200529     C                     END                                            E15508
187800200529     C                     Z-ADDNORE      CPNORE  50
187900200529     C                     END
188000200529     C                     END
188100200529     C*
188200200529     C           *INU8     IFNE '1'
188300200529     C*
188400200529     C           SSINS     IFNE WTYPED
188500200529     C                     MOVE '1'       *INU8
188600200529     C                     MOVE '1'       *IN29
188700200529     C                     END
188800200529     C*
188900200529     C           *INU8     IFEQ '0'
189000200529     C           SSAMD     IFNE WTYPEA
189100200529     C                     SETON                     U830
189200200529     C                     END
189300200529     C                     END
189400200529     C                     END
189500200529     C                     END
189600200529     C*
189700200529     C* OUTPUT CONTROL REPORT
189800200529     C*
189900200529     C                     WRITEHEADAU
190000200529     C           *INU7     IFEQ '1'
190100200529     C                     WRITEERROR
190200200529     C                     ELSE
190300200529     C***********WTYPEA    IFEQ 0                                         S01117
190400200529     C***********WTYPED    ANDEQ0                                         S01117
190500200529     C************INU8     ANDEQ'0'                                       S01117
190600200529     C***********          WRITENONE                                      S01117
190700200529     C***********          ELSE                                           S01117
190800200529     C                     WRITECONTROL
190900200529     C*
191000200529     C***********          END                                            S01117
191100200529     C                     END
191200200529     C*
191300200529     C***********          WRITETRAILAU                                   S01117
191400200529     C*
191500200529     C           *INU7     IFEQ '1'                                       S01117
191600200529     C           *INU8     OREQ '1'                                       S01117
191700200529     C                     DUMP                                           S01117
191800200529     C                     END                                            S01117
191900200529     C                     ENDSR
192000200529     C*****************************************************************
192100200529      /EJECT
192200200529     C*****************************************************************
192300200529     C*                                                               *
192400200529     C********R**-*SUBROUTINE*FOR*ERROR*HANDLING*OF*LF/CAPRH****      *   E14010
192500200529     C*  CAPHSR  - SUBROUTINE FOR ERROR HANDLING OF LF/CAPRA          *   E14010
192600200529     C*                                                               *
192700200529     C*****************************************************************
192800200529     C*
192900200529     C           CAPHSR    BEGSR                            ** CAPHSR **
193000200529     C*
193100200529     C           *LOCK     IN   LDA                                       S01117
193200200529     C***********          MOVEL'CAPRH '  DBFILE           ***************E14010
193300200529     C                     MOVEL'CAPRA '  DBFILE           ***************E14010
193400200529     C                     MOVELWCURKY    DBKEY            ** DB ERROR 04 **
193500200529     C                     Z-ADD004       DBASE            *****************
193600200529     C                     OUT  LDA                                       S01117
193700200529     C                     EXSR *PSSR                                     S01117
193800200529     C                     MOVE STSCAP    DBSTAT
193900200529     C                     MOVE '1'       *IN87
194000200529     C                     SETON                     99U7U8
194100200529     C                     GOTO EAUDIT
194200200529     C*
194300200529     C                     ENDSR
194400200529     C*
194500200529     C*****************************************************************
194600200529      /SPACE 3
194700200529     C*****************************************************************
194800200529     C*                                                               *
194900200529     C*  CAPRSR  - SUBROUTINE FOR ERROR HANDLING OF PF/CAPRHA AUDIT   *
195000200529     C*                                                               *
195100200529     C*****************************************************************
195200200529     C*
195300200529     C           CAPRSR    BEGSR                            **CAPRSR**
195400200529     C*
195500200529     C           *LOCK     IN   LDA                                       S01117
195600200529     C                     MOVE 'CAPRHA'  DBFILE           *****************
195700200529     C                     MOVEL'AUDIT'   DBKEY            ** DB ERROR 05 **
195800200529     C                     Z-ADD005       DBASE            *****************
195900200529     C                     OUT  LDA                                       S01117
196000200529     C                     EXSR *PSSR                                     S01117
196100200529     C                     MOVE STSCPR    DBSTAT
196200200529     C                     MOVE '1'       *IN87
196300200529     C                     SETON                     99U7U8
196400200529     C                     GOTO EAUDIT
196500200529     C*
196600200529     C                     ENDSR
196700200529     C*
196800200529     C*****************************************************************
196900200529      /SPACE 3
197000200529     C*****************************************************************
197100200529     C*                                                               *
197200200529     C*  CPOSSR  - SUBROUTINE FOR ERROR HANDLING OF LF/CPOSH          *
197300200529     C*                                                               *
197400200529     C*****************************************************************
197500200529     C*
197600200529     C           CPOSSR    BEGSR                              **CPOSSR**
197700200529     C*
197800200529     C           *LOCK     IN   LDA                                       S01117
197900200529     C                     MOVEL'CPOSH '  DBFILE           *****************
198000200529     C                     MOVELCPKEYD    DBKEY            ** DB ERROR 06 **
198100200529     C                     Z-ADD06        DBASE            *****************
198200200529     C                     OUT  LDA                                       S01117
198300200529     C                     EXSR *PSSR                                     S01117
198400200529     C                     MOVE STSPOS    DBSTAT
198500200529     C                     MOVE '1'       *IN87
198600200529     C                     SETON                     99U7U8
198700200529     C                     GOTO EAUDIT
198800200529     C*
198900200529     C                     ENDSR
199000200529     C*
199100200529     C*****************************************************************
199200200529      /SPACE 3
199300200529     C*****************************************************************
199400200529     C***********                                                         S01117
199500200529     C**FIRST*-*SUBROUTINE*TO*ACCESS*ICD*INFORMATION**********************S01117
199600200529     C***********                                                         S01117
199700200529     C*****************************************************************
199800200529     C***********                                                         S01117
199900200529     C***********FIRST     BEGSR                           ** FIRST **    S01117
200000200529     C***********                                                         S01117
200100200529     C***********                                                         S01117
200200200529     C**ACCESS*ICD****TABTB10                                             S01117
200300200529     C***********                                                         S01117
200400200529     C***********          EXSR ZSYSTM                                    S01117
200500200529     C************IN99     IFEQ '1'                                       S01117
200600200529     C***********          MOVE '1'       *INU7                           S01117
200700200529     C***********          MOVE '1'       *INU8                           S01117
200800200529     C***********          MOVE 'TABLE'   DBFILE           ***************S01117
200900200529     C***********          MOVELZTABKY    DBKEY            ** DB ERROR 01 S01117
201000200529     C***********          Z-ADD1         DBASE            ***************S01117
201100200529     C***********          END                                            S01117
201200200529     C***********                                                         S01117
201300200529     C***********          ENDSR                                          S01117
201400200529      *****************************************************************   S01117
201500200529      /EJECT                                                              S01117
201600200529      *****************************************************************   S01117
201700200529      *                                                               *   S01117
201800200529      *  *PSSR  - Error control subroutine                            *   S01117
201900200529      *                                                               *   S01117
202000200529      *****************************************************************   S01117
202100200529      *                                                                   S01117
202200200529     C           *PSSR     BEGSR                           ** *PSSR **    S01117
202300200529     C**                                                                  S01117
202400200529     C           @RUN      IFEQ *BLANKS                                   S01117
202500200529     C                     MOVE 'Y'       @RUN    1                       S01117
202600200529     C                     DUMP                                           S01117
202700200529     C                     END                                            S01117
202800200529     C**                                                                  S01117
202900200529     C                     ENDSR                                          S01117
203000200529      *                                                                   S01117
203100200529     C*****************************************************************
203200200529      /EJECT
203300200529     C*COPY*ZSRSRC*ZSYSTMZ1**                                             S01117
203400200529     O/EJECT
203500200529     OCPOSNDF E                CPRECI                                     E15508
203600200529     O                         RECI                                       E15508
203700200529     OCAPRHDF E                CAPRID                                     E15996
203800200529     O                         RECI                                       E15996
203900200529      /EJECT
204000200529      ***
204100200529**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION                      S01158
20420020052900000001                                                                  S01158
20430020052900000010                                                                  S01158
20440020052900000100                                                                  S01158
20450020052900001000                                                                  S01158
20460020052900010000                                                                  S01158
20470020052900100000                                                                  S01158
20480020052901000000                                                                  S01158
20490020052910000000                                                                  S01158
205000200529**  CPY@
205100200529(c) Finastra International Limited 2001
