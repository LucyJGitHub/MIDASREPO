     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Bulk trade input')                            *
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  SE3000 - BULK TRADES INPUT                                   *
      *                                                               *
      *  Function: This input allows rapid entry of minimum details   *
      *   (I/C)    required to enter many similar trades for the same *
      *            security or to enter details of agency trades in a *
      *            security.  Subsequent update of trades can also be *
      *            carried out.  If the bulk transaction is NOT       *
      *            agency based, then all trades entered must be of   *
      *            the same trade type, else the two-sided deal is    *
      *            acceptable and is entered in two section, the      *
      *            first half always being the deal with the broker.  *
      *            However the latter restriction is removed if Allow *
      *            Agency Trades Between Portfolio clients is 'Y' on  *
      *            the SE ICD and S01448 is also on.                  *
      *                                                               *
      *  Calls    : SE3002 - Review Trades for Bulk Trade Input       *
      *             SE3003 - Bulk Trades Batch Update                 *
      *                      (Batch Job Submitted by QCMDEXC)         *
      *             SE5200 - Pool Trade Maintenance                   *   S01486
      *             SE7570 - Corporate Actions Retrieve Block         *   CSE007
      *                      Position                                 *   CSE007
      *             SE7572 - Corporate Action - Retrieve General      *   CSE007
      *                      Block Security Indicators                *   CSE007
      *             SE7574 - Corporate Action - Retrieve General      *   CSE007
      *                      Block Customer Indicators                *   CSE007
      *                                                               *
      *  Called by: SEC3000 - Bulk Input                              *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *                                                               *
      *  Last Amend No. AR1075401          Date 01Jun20               *      
      *  Prev Amend No. MD046248           Date 27Oct17               *
      *                 CLE148             Date 23Jul12               *
      *                 AR888911           Date 26Jan12               *
      *                 AR879983           Date 21Dec11               *
      *                 AR871625           Date 12Dec11               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      *                 CSD079             Date 05Feb07               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 234300             Date 29Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE075             Date 17Nov05               *
      *                 BUG7991            Date 27Jul05               *
      *                 CGL035             Date 01Mar05               *
      *                 234440             Date 29Jun05               *
      *                 235546             Date 27Jul05               *
      *                 234691             Date 04Jul05               *
      *                 234552             Date 29Jun05               *
      *                 233607             Date 19May05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 227267             Date 10Jun04               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 CAAA03             Date 03May04               *
      *                 CSC023             Date 28Jan04               *
      *                 CGL029             Date 01Sep03               *
      *                 CAAA02             Date 16Jul03               *
      *                 CAS006             Date 21Jan03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 205667             Date 11Apr02               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CPK014             Date 14Nov01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 188410             Date 08Jan01               *
      *                 187727             Date 15Dec00               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 186102             Date 03Nov00               *
      *                 185278             Date 20Oct00               *
      *                 CSE023             Date 12Jul00               *
      *                 135344             Date 19Sep00               *
      * Midas DBA 3.03 -----------------------------------------------*
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSE006             Date 02Jun99               *
      *                 CPB001             Date 13Sep99               *
      *                 CGL011             Date 20Sep99               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 CSE010             Date 21Jun99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CAC005             Date 27Nov98               *
      *                 149517             Date 01Dec98               *
      *                 136766             Date 27May98               *
      *                 CEU017             Date 03Mar98               *
      *                 CSE007             Date 05Jan98               *
      *                 CEU005             Date 03Feb98               *
      *                 111459             Date 23Feb97
      *                 111458             Date 23APR97
      *                 CAC003             Date 25Feb97               *
      *                 112563             Date 15Apr97               *
      *                 CSE003             Date 11Oct96               *
      *                 CAC002             Date 15Sep96               *
      *                 CPM005             Date 29Jul96               *
      *                 CFF004             Date 02Oct96               *
      *                 S01408             Date 19Aug96               *
      *                 103478             Date 21May96               *
      *                 101086             Date 22Feb96               *
      *                 100239             Date 22Feb96               *
      *                 093516             Date 25SEP95               *
      *                 083878             Date 23Feb95               *
      *                 092518             Date 17Aug95               *
      *                 091209             Date 31Jul95               *
      *                 088307             Date 15Jun95               *
      *                 085334             Date 15Jun95               *
      *                 085801             Date 09Mar95               *
      *                 077620             Date 03APR95               *
      *                 077621             Date 03APR95               *
      *                 081490             Date 13Jan95               *
      *                 080046             Date 19Dec94               *
      *                 S01496             Date 02Nov94               *
      *                 S01486             Date 27Oct94               *
      *                 S01511             Date 10Aug94               *
      *                 069175             Date 12Oct94               *
      *                 067627             Date 20Jun94               *
      *                 067527             Date 20Jun94               *
      *                 S01448             Date 21Feb94               *
      *                 064529             Date 07Jan94               *
      *                 052254             Date 06Jan94               *
      *                 065394             Date 06Jan94               *
      *                 063535             Date 20Dec93               *
      *                 048483             Date 20Dec93               *
      *                 032056             Date 20Dec93               *
      *                 030834             Date 20Dec93               *
      *                 050690             Date 05Nov93               *
      *                 S01401             Date 16Jun93               *
      *                 S01397             Date 10SEP92               *
      *                 E37015             Date 12Mar92               *
      *                 E24723             Date 15APR91               *
      *                 S01117             Date 23Jan91               *
      *                 S01269             Date 13Aug90               *
      *                 S01220             Date 07Aug90               *
      *                 S01271             Date 19Jun90               *
      *                 E21146             Date 13Mar90               *
      *                 E21353             Date 08Mar90               *
      *                 E21045             Date 06Feb90               *
      *                 E21046             Date 06Feb90               *
      *                 E21047             Date 06Feb90               *
      *                 E21049             Date 06Feb90               *
      *                 E21048             Date 06Feb90               *
      *                 E20517             Date 17Jan90               *
      *                 E20718             Date 16Jan90               *
      *                 E18010             Date 26/05/89              *
      *                 E18101             Date 16/05/89              *
      *                 S01199             Date 03/08/89              *
      *                 S01175             Date 07/11/88              *
      *                 S01176             Date 21/07/88              *
      *                 S01169             Date 15/07/88              *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  AR1075401 - Increase QFOAMT length in PMHOLDPD. Adjust para- *
      *              meter field when calling SE7570/SE6710.          *
      *              (Child: AR1075402)                               *      
      *  MD046248 - Finastra Rebranding                               *
      *  CLE148 - Alpha Loan Reference                                *
      *  AR888911 - In reversing a deal, REV column in Stamp Tax      *
      *             Movements Enquiry is not changing from N to Y     *
      *             (Recompile)                                       *
      *           - Applied for AR944923                              *
      *  AR879983 - Add stamp tax exchange rate (Recompile)           *
      *  AR871625 - New Stamp Tax fields are missing in Bulk Input    *
      *  CSD079 - Enhanced Customer Maintenance API (Recompile)       *
      *  234300 - Recompiled over changed in PF/HSTTRD.               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE075 - US Enhanced Treasury Upgrade to MidasPlus           *
      *           (Recompile)                                         *
      *  BUG7991- CAS006 fields not initialised properly.             *
      *  CGL035 - EUSD Upgrade to Midasplus                           *
      *  234440 - Purchase Interest management                        *
      *  235546 - EU Tax backvaluations                               *
      *  234691 - Remove temporary changes for 234552 and code error  *
      *           messages but keep restriction on deletion           *
      *  234552 - TEMPORARY CHANGE - block delete and force review    *
      *           to stop corruption of EU Position file              *
      *  233607 - Fiscal Price doesn't appear on SE Trade screen      *
      *           of Bulk Input                                       *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  227267 - POSITION BLOCKED ALTHOUGH NO BLOCK FOR ALLOCATION   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CAAA03 - Webfacing Changes (recompile)                       *
      *  CSC023 - SBMJOB output queue must be *JOBD.                  *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CAAA02 - Remove use of LOCK keyword to enable WebFacing to   *
      *           process screens.                                    *
      *           Change order of WRITEs to stop non-display / errors *
      *  CAS006 - Hedge Accounting Phase B                            *
      *  205667 - Fix 191878 in SE3002 expect a new parameter.        *
      *           Add this parameter.                                 *
      *  CPK014 - Submit jobs with user *JOBD                         *
      *  188410 - DB Error in bulk input because SE3002 is called     *
      *           but there are still outstanding errors              *
      *  187727 - WHTX amount should be shown in nominal ccy          *
      *  186102 - Program issuing W37 message on the market side      *
      *  185278 - Incomplete parameter list being used when calling   *
      *           SE3002 caused program dump being produced by SE3002.*
      *  CSE023 - Treaty Withholding Tax                              *
      *  135344 - W11 appears incorrectly                             *
      *  CSE006 - Repurchase Agreements (REPOs) enhancement           *
      *  CPB001 - 'Private Banking' Module                            *
      *  CGL011 - Collateral Processing for Midas                     *
      *  CSE010 - SE Transactions Enhancements                        *
      *  CAC005 - PCA-SE Enhancement                                  *
      *  149517 - OLD SECURITIES ARE NOT BLOCKED AFTER REDENOMINATION *
      *  136766 - For yield securities (STBS='Y'), the value of       *
      *           @WK15 will always be greater than WK100 because     *
      *           instead of multiplying 1000 by 10000000 to obtain   *
      *           WK100, it was multiplied by 1000.0000 (POWER8,8).   *
      *           Fix is to reinstate the previous coding.            *
      *  CEU017 - Securities Redenomination Euro Changes              *
      *  CSE007 - Corporate Actions                                   *
      *  CEU005 - EMU SE Settlement Ccy Conversion.                   *
      *  111459 - Database error occurring whilst enquiring on existing bulk
      *  111458 - Applied fix CBLFIX from BLI-LUX and last PTF (from M106MRGXXS)
      *           (Retrieve correct value of nomimal to be reported on 2nd scrn)
      *  112563 - Header and footer changes required for GUI          *
      *           Multilanguage support.                              *
      *  CSE003 - '?' processing for security shortname.              *
      *  CAC002 - Profit Centre Accounting Development Phase 2:       *
      *           If Analytical Accounting is installed, replace      *
      *           Profit Centre field with 2 new fields 'Book Profit  *
      *           Centre' and 'Transaction Profit Centre'.  A new     *
      *           'Margin' field will also be added.                  *
      *  CPM005 - Private Banking Phase II                            *
      *           Focus Group Changes Upgraded to DBA                 *
      *           PBFG/5 - INSTRUMENT ASSET / LIABILITY SPLIT         *
      *           PBFG/6 - ADDITIONAL CUSTOMER DETAILS                *
      *           PBFG/7 - NET COMMITMENT BY CURRENCY                 *
      *           PBFG/8 - DISPLAY POSITIONS SPLIT BY CURRENCY        *
      *  CFF004 - Increase in size of Price Fields,(Recompiled Only)  *
      *  S01408 - Core Hook SE3000CCP5 Added
      *         - Core Hook SE3000CCP4 Added
      *         - Core Hook SE3000CCP3 Added
      *         - Core Hook SE3000CCP2 Added
      *         - Core Hook SE3000CCP1 Added
      *         - Core Hook SE3000FFP1 Added
      *         - Core Hook SE3000IIP1 Added
      *  103478 - Change Bulk to Trades format (Recompile)            *
      *  101086 - Customer '?' processing skips validation            *
      *  100239 - Bulk Trades changed to Trades format                *
      *  093516 - Do not send error message '021' when enquiry is     *
      *           processed - this is only available for deletion and *
      *           when a pool trade is already being processed by     *
      *           another job                                         *
      *  083878 - Prevent record locks on BULKTD during initial       *
      *           validation - these can produce 'Record already      *
      *           locked to this job' errors later on.                *
      *  092518 - Action code A is valid when Portfolio Management    *
      *           and pool portfolios are on                          *
      *  091209 - PMPLTRPD is opened under User Control in this pgm   *
      *           (for update only). But when SE3000 calls SE5200 to  *
      *           insert a record, the WRITE operation in that pgm    *
      *           fails because the file control options in SE3000    *
      *           take priority.                                      *
      *  088307 - Do not allow insertion over deleted trades          *
      *  085334 - Total nominal is calculated at the wrong time, thus *
      *           showing a difference between total TP and TS        *
      *  085801 - Field @WW15 as been renamed @WK15                   *
      *  077620 - Output available nominal on second part             *
      *  077621 - If total TS amount and TP amount are not equal for  *
      *           agency trade, send error message before review      *
      *  081490 - PB SE enhancement missing (S10978 - Early Redemp.)  *
      *  080046 - Blank Pool Portfolio not accepted and error codes   *
      *           013 & 014 reused                                    *
      *  S01496 - Jyske Enhancements upgrade to Release 10            *
      *  S01486 - Private Banking upgrade to Release 10               *
      *  S01511 - Market Migration.                                   *
      *  069175 - Broker Commission not defaulted at R10 in the same  *
      *           way as on Midas/38.                                 *
      *  067627 - Key not being initialised caused AOCUSTR0 fall over *
      *           with DB Error.                                      *
      *  067527 - Rounding error on average price if the price is     *
      *           small. (JB1800)                                     *
      *  S01448 - Bulk Input Enhancements:                            *
      *        1) 'Agency trade' value taken from the SE ICD. If this *
      *           is then blanked out it should now be an error.      *
      *        2) Agency Trade first side header is 'BROKER/CLIENT'   *
      *           if client Agency Trades (Agency Cross) are allowed. *
      *        3) Fields on the first screen should be amendable if   *
      *           returning from the second screen.                   *
      *        4) If 'Allow Trades between Portfolio Clients on both  *
      *           sides' is on then do not require customers on the   *
      *           first screen to be market clients. For transfer to  *
      *           other pgms, set-up flag to indicate agency cross.   *
      *        5) Default value of 'Review Trades' field from ICD fld *
      *           'Review Bulk Trades Default'.                       *
      *        6) When reviewing a trade pass defaults of user depot, *
      *           trade and value date and clearance type. Ensure     *
      *           that these values used on return to SE3002          *
      *        7) Allow agency trades in non-agency books             *
      *        8) Correct validation of Agency Trade indicator.       *
      *        9) Correct text for fix E24723                         *
      *  064529 - Truncation in calculated average price              *
      *  052254 - CURRENT FACTOR amended from 9,8 to 10,9             *
      *  065394 - SBMJOB parameters are not being picked up           *
      *  063535 - Deletion is not being processed                     *
      *  048483 - When trade ref is amended on the subfile for insert *
      *           delete previous record off BULKTD                   *
      *  032056 - Nominal not being formatted properly with dec. place*
      *  030834 - First number of bulk is '000000'                    *
      *  050690 - Stop reuse of historic trade numbers. Added a lookup*
      *           to the historic trades file to check if it exists.  *
      *  S01401 - The generation of MT5xx SWIFT Messages if the       *
      *           option is available.                                *
      *  S01397 - Rel 10 Incorporation of BNZ SARs A46008 and A46013. *
      *          - Recompiled due to changes to files.                *
      *  E37015 - Should be able to carry on past just warning errors *
      *  E24723 - Unvalidated data may be passed from SE3002 if F3 is *
      *           taken in that pgm                                   *
      *  S01117 - Release 10 Multibranching etc                       *
      *  S01220 - STRATEGIC RISK MANAGEMENT                           *
      *           Recompiled over changed PF/SECTYD                   *
      *  S01269 - Trade Authorisation                                 *
      *  S01271 - Recompiled for Pay/Receive in Input Cycle changes   *
      *           to TRADSD and/or DPTMVD                             *
      *  E21146 - Replace QCAEXEC with QCMDEXC                        *
      *  E21353 - Defaults on SMBJOB command should be USER(*CURRENT) *
      *           RTGDTA(*NONE)                                       *
      *  E21045 - If book left blank in initial screen then use book  *
      *           from related trade, for trade being input.          *
      *  E21046 - For agency trades book must be agency book from icd.*
      *           On an insert, if no book entered for an agency trade*
      *           display book from icd as default.                   *
      *  E21047 - When in enquiry mode too many fields are highlighted*
      *           for failed validation of the initial screen.        *
      *  E21049 - If discount security and value date of trade=maturit*
      *           date of security then price must be zero.           *
      *           For yield security price should be less than 100%   *
      *  E21048 - No validation of subfile if enter pressed without   *
      *           any field entry having been made.                   *
      *  E20517 - Add error 012 to prevent a trade on an amortising   *
      *           book if the day basis of the security is '4'        *
      *           (as SE2220 cannot amortise with DYBS = '4')         *
      *  E20718 - ADD EXTRA PARMS, RTGDTA(*JOBD),                     *
      *           INLLIBL(*JOBD) TO SBMJOB COMMAND.                   *
      *           *** REQUIRED FOR AS400 ONLY, DEFAULTS OK FOR S/38.  *
      *  E18010 - ADJUSTMENTS FOR AS400 COMMAND KEYS                  *
      *  E18101 - RECOMPILE OF PROGRAM OVER LATEST VERSIONS OF FILES  *
      *  S01199 -  HELP SYSTEM.                                    *
      *  S01175 - BAER INCORPORATION                                  *
      *  S01176 - SECURITIES TRADING 3.1                              *
      *  S01169 - SECURITIES TRADING (BAER INCORPORATION)             *
      *                                                               *
      *****************************************************************
     F*
     FSE3000DFCF  E                    WORKSTN
     F                                        @SFK  KSFILE SE3000F0
     F                                        @SFK  KSFILE SE3000F3
     FPRICM   IF  E           K        DISK                           UC  S01496
     FCPOSC   IF  E           K        DISK                           UC  S01496
     FTRADS   IF  E           K        DISK
     FHSTTTR  IF  E           K        DISK                               050690
     FSECTY   IF  E           K        DISK
     FINVTP   IF  E           K        DISK
     F*BOOKD***IF**E           K        DISK                              S01117
     F*TABSE***IF**E           K        DISK                              S01117
     F*********** TABLETAF                          KIGNORE               S01117
     F*********** TABTE10F                          KIGNORE               S01117
     F*********** TABTE20F                          KIGNORE               S01117
     F*********** TABLETHF                          KIGNORE               S01117
     F*********** TABLETKF                          KIGNORE               S01117
     F*********** TABLETNF                          KIGNORE               S01117
     F*********** TABLETPF                          KIGNORE               S01117
     F*********** TABLETXF                          KIGNORE               S01117
     F*********** TABLET3F                          KIGNORE               S01117
     FTRADBK  IF  E           K        DISK                               S01169
     F            TRADSDF                           KRENAMETRADBKF
     F*CLINT***IF**E           K        DISK                              S01117
     F*********** CLINTCAF                          KIGNORE               S01117
     F*********** CLINTCCF                          KIGNORE               S01117
     F*********** CLINTC1F                          KIGNORE               S01117
     F*SNAME***IF**E           K        DISK                              S01117
     F*********** CLINTCBF                          KRENAMESNAMEF         S01117
     FBULKR   UF  E           K        DISK         KCOMIT       A
     FBULKTD  UF  E           K        DISK         KCOMIT
     F            BULKTDF                           KRENAMEBULKPF
     FBLKRFD  UF  E                    DISK
     F*                                                                   S01408
     F/COPY WNCPYSRC,SE3000FFP1                                           S01408
     F*                                                                   S01408
     F*PMPLTRPDUF*E***        K        DISK         KCOMIT      UC  S01486091209
     FPMPLTRPDUF  E           K        DISK         KCOMIT       A    UC  091209
     FPMSBPDPDIF  E           K        DISK                           UC  S01486
     FTNRAN   IF  E           K        DISK                           UC  S01486
     FBKPSO   IF  E           K        DISK                           UC  S01486
     FPMHOLDL4IF  E           K        DISK                           UC  S01486
     F***PMHOLDL5IF  E           K        DISK                 UC  S01486 CPM005
     F*********** PMHOLDP0                          KRENAMEPMHOLDP1S01486 CPM005
     FPMDSPGPDIF  E           K        DISK                           UC  S01486
     FSDWTCSL0IF  E           K        DISK                               CSE023
     F            SDWTCSD0                          KRENAME@WTCSL0        CSE023
     FTRADSQL0UF  E           K        DISK                      A                          AR871625
      *                                                                                     AR871625
     FSDSTMDL0UF  E           K        DISK                      A                          AR871625
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   01 - CHAIN or READ failure                                  *
     F*   02 - End of file on subfile                                 *
     F*   03 - LOKUP operation successful                             *
     F*   04 - Customer/broker defaults found - set default codes     *
     F*   05 - File update has been performed                         *
     F*   06 - S/file record has been read on this cycle              *
     F*   07 - Confirmation of input required                         *
     F*   08 - Records are still to be reviewed (retrn code 7 receivd)*
     F*   09 - Batch update submitted                                 *
     F*   10 - Trade record not valid for display (delete only)       *
     F*   11 - Not authorised to the branch of a trade for enquiry    *   S01117
     F*   12 - Not authorised to the branch of this trade for enquiry *   S01117
     F*   20 - Enable F10                                             *
     F*   21 - Enable F9                                              *
     F****22*-*HELP*requested******************************************   S01199
     F*   23 - SFLCLR                                                 *
     F*   24 - SFLDSP (and SFLDSPCTL on s/file 2)                     *
     F*   25 - SFLEND                                                 *
     F*   26 - SFLNXTCHG                                              *
     F*   27 - DSPATR(PR) on all s/file fields except Review trade    *
     F*   28 - DSPATR(PR) on s/file field Review trade                *
     F*   29 - ROLLUP requested                                       *
     F*   30 - SFLDSPCTL on s/file 1                                  *
     F*   31 - DSPATR(ND) on screen 1 header price/yield/discount     *
     F*   32 - Multibranching environment                             *   S01117
     F*   40 - S/file validation error - Reference                    *
     F*   41 - S/file validation error - Client                       *
     F*   42 - S/file validation error - Nominal                      *
     F*   43 - S/file validation error - Price/yield/discount         *
     F*   44 - S/file validation error - Review trade                 *
     F*   45 - '?' selected for customer                              *   S01117
     F*   50 - A validation error has occurred                        *
     F*   51 - Make initial screen header fields input-capable        *
     F*   52 - Initial screen validation error - Action code          *
     F*   54 - Initial screen validation error - Trade ref            *
      *  55 - Initial screen validation error - Profit centre         *   CAC005
     F*   56 - Initial screen validation error - Agency trade         *
     F*   58 - Initial screen validation error - Security shortname   *
     F*   60 - Initial screen validation error - Trade type           *
     F*   61 - Initial screen validation error - Booking Branch       *   S01117
     F*   62 - Initial screen validation error - Book                 *
     F*   64 - Initial screen validation error - Bulk ref             *
     F*   66 - Pool Portfolio are being managed                       *   S01486
     F*   68 - Initial screen validation error - Pool Customer        *   S01486
     F*   69 - Initial screen validation error - Pool Portfolio       *   S01486
     F*   70 - S/file 2 being processed                               *
      *  71 - CAC005 is on, display profit centre in the display file.*   CAC005
     F*90-99 - Used in validation/conversion routines (Z s/r's)       *
     F*                                                               *
     F*   U7 - Data base error                                        *
     F*   U8 - Data base error                                        *
      *   LR - Last Record Indicator                                  *   CSE010
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  I N D E X   T O   S U B R O U T I N E S                      *
     F*                                                               *
     F*   SUB001 - Initialization                                     *
     F*   SUB002 - Main processing controller                         *
     F*   SUB101 - Control display/validation of initial screen       *
     F*   SUB102 - Initialize s/file 1 for input                      *
     F*   SUB103 - Initialize s/file 1 for enquiry/delete             *
     F*   SUB104 - Control display of s/file 1                        *
     F*   SUB105 - Calculate average price for s/file 1               *
     F*   SUB106 - Initialize s/file 2                                *
     F*   SUB107 - Display/validate s/file 2                          *
     F*   SUB108 - Submit defaults update                             *
     F*   SUB200 - Display initial screen or s/file 1                 *
     F*   SUB201 - Validate initial screen                            *
     F*   SUB202 - Validate s/file                                    *
     F*   WBLOCK - Validate blocks (called from validation subroutine)*   081490
     F*   SUB203 - Create page of s/file 1 records                    *
     F*   SUB204 - Create page of s/file 2 records                    *
     F*   SUB300 - Initialize numeric fields in parameter             *
     F*   SUB303 - Write to bulk input file when delete & F10 selected*
     F*   SUB304 - Delete all inserted trades if F3 or F12            *
     F*   SUB401 - Issue a COMIT                                      *
     F*   SUB501 - Calculate nominal (for initial screen)             *   S01486
     F*   SUB502 - Set up parameters to pass to SE5200                *   S01486
     F*   SUB52A - FORMAT PARAMETERS TO BE PASSED TO SE5200           *   S01486
     F*   SUB52B - CALCULATE TOTAL CHARGES INCURRED ON MARKET SIDE    *   S01486
     F*   SUB503 - Receive command key returned from SE5200           *   S01486
     F*   SR50X  - Price within 10% of Market Price testing           *   S01496
     F*   SR50Y  - Trade making Short Position testing                *   S01496
     F*   SUB800 - Close files opened by SE3002                       *
     F****SUB999*-*Error*handling**************************************   S01117
     F*                                                               *
     F*   ZALIGN - Validate and right-align numeric fields            *
     F****ZICD2**-*Chain*to*ICD2***************************************   S01117
     F****ZICDSE*-*Chain*to*SE*ICD*************************************   S01117
     F*   ZSEDIT - Insert a decimal point and sign into a numeric fld *
     F*            and to blank out leading zeros (optionally         *
     F*                                             inserting commas) *
     F****ZSYSTM*-*Chain*to*ICD1*and*set*date*format*flag**************   S01117
     F*   ZTNLU1 - Determine next available transaction number        *
     F*   *PSSR  - Error handling                                     *   S01117
     F*                                                               *
     F*****************************************************************
      /EJECT
      *
     E                    CPY@    1   1 80
     E************        @TX     1  10 80               Text strings     S01401
     E************        @TX     1  11 80              Text stringS01401 S01511
     E                    @TX     1  12 80               Text strings     S01511
     E                    @FNXA      40 10                                                    233607
     E                    @MIXA      40  7                                                    233607
     E                    @MDXA      40 45                                                    233607
     E                    @WFNXA     40 10                                                    233607
     E                    @WMIXA     40  7                                                    233607
     E                    @WMDXA     40 45                                                    233607
      /COPY ZSRSRC,ZALIGNZ1
      /COPY ZSRSRC,ZSEDITZ1
     E                    @EA        40  4               Error codes
     E********************POWER8  1   8  8 0             mult array E21049064529
     E***/COPY*ZSRSRC,ZPOWER8Z1****                                064529 136766
     E/COPY ZSRSRC,ZDATE2Z1                                               S01486
      *
      /EJECT
     ISECTYDF
     I*
     I*  Rename nominal currency field
     I*
     I              NMCY                            NMCYA
     IBULKTDF                                                             CSE023
     I              WHTX                            WHTXA                 CSE023
     I/COPY WNCPYSRC,SE3000I001
     I*
     I            DS
     I*
     I* Data structure for compilation - Copyright insertion
     I*
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I*
     I*  Externally defined data structure to transfer bulk details
     I*@BLKDS***E*DSBULKTD***                                             100239
     I@BLKDS    E DSTRADSD                                                100239
     I*
     ILDA         DS                            256
     I*
     I*  Error reporting data structure
     I*
     I** *LOCK IN LDA immediately before and OUT LDA immediately          S01117
     I** after each database error handling.                              S01117
     I                                      134 183 @DBALL                S01117
     I                                      134 141 @DBFIL                S01117
     I                                      142 170 @DBKEY                S01117
     I                                      171 180 @DBPGM                S01117
     I                                      181 1830@DBASE                S01117
     I***********                           134 138 @DBFIL                S01117
     I***********                           139 167 @DBKEY                S01117
     I***********                           168 175 @DBPGM                S01117
     I***********                           176 1770@DBASE                S01117
     I***********                           134 177 @DBALL                S01117
     I*                                                                   S01117
     I** Data area RUNDAT                                                 S01117
     I*                                                                   S01117
     IRUNDT       DS                                                      S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
     I*                                                                   S01117
     I** Data area ZMUSER                                                 S01117
     I*                                                                   S01117
     IZMUSER      DS                             17                       S01117
     I                                       11  13 USRBCH                S01117
     I/COPY WNCPYSRC,SE3000I002
     ISDBANK    E DSSDBANKPD                                              S01117
     I** Bank details                                                     S01117
     ISDBOOK    E DSSDBOOKPD                                              S01117
     I** Book details                                                     S01117
     ISDBRCH    E DSSDBRCHPD                                              S01117
     I** Branch details                                                   S01117
     ISDCUST    E DSSDCUSTPD                                              S01117
     I              QQDFAC                          QQDFA1                                    CGL029
     I** Customer details                                                 S01117
     ISDGELR    E DSSDGELRPD                                              S01117
     I** General Ledger details                                           S01117
     ISDMMOD    E DSSDMMODPD                                              S01486
     I** MIDAS MODULES DETAILS                                            S01486
     ISDPLCS    E DSSDPLCSPD                                              S01486
     I** PORTFOLIO MANAGEMENT CUSTOMER DETAILS                            S01486
     ISDPLIN    E DSSDPLINPD                                              S01486
     I** PORTFOLIO INSTRUMENT TYPE DETAILS                                S01486
     ISDPORT    E DSSDPORTPD                                              S01486
     I** PORTFOLIO MANAGEMENT ICD DETAILS                                 S01486
     ISDSECS    E DSSDSECSPD                                              S01117
     I              QQACCD                          QQACC1                                    CGL029
     I              SEZONE                          BFZONE                                    CGL035
     I** Security Customer details                                        S01117
     ISDSTRD    E DSSDSTRDPD                                              S01117
     I** Securities Trading ICD                                           S01117
     ISDPRFC    E DSSDPRFCPD                                              CAC005
      ** Profit Centre Accounting                                         CAC005
      *                                                                   CAC005
     IDSFDY     E DSDSFDY                                                 S01117
     I**  Short DS for access programs                                    S01117
     IDSSDY     E DSDSSDY                                                 S01117
     I**  Long  DS for access programs                                    S01117
     I*
     IDSLDY     E DSDSLDY                                                 CPB001
     I**  Very Long  DS for access programs                               CPB001
      ** Security Details Data Structure                                                      233607
     I@SECTY    E DSSECTYD                                                                    233607
     I              RECI                            RECIA                                     233607
     I              NMCY                            NMCYA                                     233607
     I              ZZ005                           ZZ005A                                    233607
     I              CHTP                            CHTPA                                     233607
     I              TNLU                            TNLUA                                     233607
     I              REPI                            REPIA                                     233607
     I              REPA                            REPAA                                     233607
     I              LCD                             LCDTA                                     233607
     I              FRNT                            FRNTA                                     233607
     I              TMST                            TMSTA                                     233607
     I              CD01                            CD01A                                     233607
     I              CD02                            CD02A                                     233607
     I              CD03                            CD03A                                     233607
     I              CD04                            CD04A                                     233607
     I              CD05                            CD05A                                     233607
     I              CD06                            CD06A                                     233607
     I              CD07                            CD07A                                     233607
     I              CD08                            CD08A                                     233607
     I              CD09                            CD09A                                     233607
     I              CD10                            CD10A                                     233607
     I              CD11                            CD11A                                     233607
     I              CD12                            CD12A                                     233607
     I              CR01                            CR01A                                     233607
     I              CR02                            CR02A                                     233607
     I              CR03                            CR03A                                     233607
     I              CR04                            CR04A                                     233607
     I              CR05                            CR05A                                     233607
     I              CR06                            CR06A                                     233607
     I              CR07                            CR07A                                     233607
     I              CR08                            CR08A                                     233607
     I              CR09                            CR09A                                     233607
     I              CR10                            CR10A                                     233607
     I              CR11                            CR11A                                     233607
     I              CR12                            CR12A                                     233607
     I*                                                                   CPB001
     IPSDS       SDS
     I*
      *  Program status data structure
     I*
     I                                      244 253 @JOB
     I                                      254 263 @USR
     I*
     I@CMTXT      DS
     I*
      *  Data structure to provide text on COMIT
     I*
     I                                        1   50@NTN
     I                                        6   7 @MID
     I                                        8  15 @PGM
     I                                       16  18 @WID
     I                                       19  240@TIME
     I                                       25  25 @ACTN
     I                                       26  35 @USER
     I*
     I***@CMD********DS                            160                    S01401
     I@CMD        DS                            240                       S01401
     I*
      ***Data*structure*for*command*string*for*QCAEXEC                    E21146
      *  Data structure for command string for QCMDEXC                    E21146
     I*
     I                                        1  80 CCMD1                 S01401
     I                                       81 160 CCMD2                 S01401
     I                                      161 240 CCMD3                 S01401
     I                                       12  20 @CJOB
     I                                       14  19 @CBREF
     I                                       20  20 @CACTN
     I                                       84  93 @CMWI
     I                                       99 104 @CMBR
     I                                      110 115 CCTRDF                S01401
     I                                      121 121 @CCAGT                S01401
     I*
     I@ERR        DS                             76
     I*
      *  Data structure to insert variables into error message
     I*
     I                                        6  14 @SJOB
      *************                                                       S01176
      ***Data*structure to hold trade details                             S01176
      *************                                                S01176 S01176
     I*@PARMT****  DS                            464               S01176 S01175
     I*@PARMT******DS                                              S01176 S01175
     I*************                           1   1 @PRECI                S01175
     I*************                           2   7 @PTDRF                S01175
     I*************                           9  18 @PTDSS                S01175
     I*************                          19  240@PTCNR                S01175
     I*************                          25  26 @PTDTP                S01175
     I*************                       P  27  320@PNOML                S01175
     I*************                          33  35 @PTNMC                S01175
     I*************                       P  36  360@PTNMD                S01175
     I*************                       P  37  448@PTPDY                S01175
     I*************                       P  45  470@PTDVD                S01175
     I*************                          48  500@PTDBR                S01175
     I*************                          51  52 @PTDBK                S01175
     I*************                       P  53  550@PTDDT                S01175
     I*************                         106 1060@PTCAP                S01175
     I*************                       P 107 1118@PTCFC                S01175
     I*************                       P 113 1140@PDADJ                S01175
     I*************                       P 116 1220@PITRA                S01175
     I*************                       P 123 1290@PTINA                S01175
     I*************                       P 130 1357@PTDCR                S01175
     I*************                       P 136 1438@PPRIC                S01175
     I*************                       P 145 1495@PRALL                S01175
     I*************                       P 153 1598@PTDER                S01175
     I*************                       P 161 1678@PTBCR                S01175
     I*************                         168 1690@PSMTH                S01175
     I*************                         182 1840@PPYFB                S01175
     I*************                         197 1990@PPYTB                S01175
     I*************                         208 2090@PASNM                S01175
     I*************                         211 2160@PDELT                S01175
     I*************                         226 2310@PDELF                S01175
     I*************                       P 271 2770@PTBCA                S01175
     I*************                       P 280 2860@PTCCA                S01175
     I*************                       P 289 2950@PTCA1                S01175
     I*************                       P 298 3040@PTCA2                S01175
     I*************                       P 307 3130@PTCA3                S01175
     I*************                       P 316 3220@PTCA4         S01176 S01175
     I*************                       P 325 3310@PTCA5         S01176 S01175
     I*************                       P 334 3400@PTCA6         S01176 S01175
     I*************                       P 343 3490@PTCA7         S01176 S01175
     I*************                       P 350 3560@PTAXA         S01176 S01175
     I*************                       P 357 3630@PBCMR         S01176 S01175
     I*************                       P 364 3700@PCCMR         S01176 S01175
     I*************                       P 371 3770@PTXRB         S01176 S01175
     I*************                         378 383 @PBLKR         S01176 S01175
     I*************                         384 389 @PRTRF         S01176 S01175
     I*************                         390 390 @PATRD         S01176 S01175
     I*************                         392 3970@PTIME         S01176 S01175
     I*************                       P 316 3220@PTLTA         S01176 S01175
     I*************                       P 325 3310@PTOCA         S01176 S01175
     I*************                         332 332 @PTACI         S01176 S01175
     I*************                         333 333 @PTMSI         S01176 S01175
     I*************                       P 335 3400@PTOSN         S01176 S01175
     I*************                       P 341 3460@PTNSN         S01176 S01175
     I*************                       P 347 3520@PTNSP         S01176 S01175
     I*************                       P 353 3600@PTOSV         S01176 S01175
     I*************                       P 361 3680@PTVSN         S01176 S01175
     I*************                       P 369 3760@PTVSP         S01176 S01175
     I*************                       P 377 3840@PTDSN         S01176 S01175
     I*************                       P 385 3920@PTDSP         S01176 S01175
     I*************                       P 393 3950@PTDFS         S01176 S01175
     I*************                       P 396 3970@PTSSQ         S01176 S01175
     I*************                       P 398 4050@PTCSR         S01176 S01175
     I*************                       P 406 4130@PTCTR         S01176 S01175
     I*************                       P 414 4160@PTDMC         S01176 S01175
     I*************                       P 417 4190@PTOED         S01176 S01175
     I*************                       P 420 4220@PLCD          S01176 S01175
     I*************                         423 423 @PCHTP         S01176 S01175
     I*************                       P 424 4260@PTNLU         S01176 S01175
     I*************                         399 399 @PTACI         S01176 S01175
     I*************                         400 400 @PTMSI         S01176 S01175
     I*************                       P 402 4070@PTOSN         S01176 S01175
     I*************                       P 408 4130@PTNSN         S01176 S01175
     I*************                       P 414 4190@PTNSP         S01176 S01175
     I*************                       P 420 4270@PTOSV         S01176 S01175
     I*************                       P 428 4350@PTVSN         S01176 S01175
     I*************                       P 436 4430@PTVSP         S01176 S01175
     I*************                       P 444 4510@PTDSN         S01176 S01175
     I*************                       P 452 4590@PTDSP         S01176 S01175
     I*************                       P 460 4620@PTDFS         S01176 S01175
     I*************                       P 463 4640@PTSSQ         S01176 S01175
     I*************                       P 465 4720@PTCSR         S01176 S01175
     I*************                       P 473 4800@PTCTR         S01176 S01175
     I*************                       P 481 4830@PTDMC         S01176 S01175
     I*************                       P 484 4860@PTOED         S01176 S01175
     I*************                       P 487 4890@PLCD          S01176 S01175
     I*************                         490 490 @PCHTP         S01176 S01175
     I*************                       P 491 4930@PTNLU         S01176 S01175
     I***********                         P 429 4350@PLTCA         S01176 S01175
     I***********                         P 438 4440@PTPCA         S01176 S01175
     I***********                         P 445 4510@PTVCA         S01176 S01175
     I***********                           452 457 @PBLKR         S01176 S01175
     I***********                           458 463 @PRTRF         S01176 S01175
     I***********                           464 464 @PATRD         S01176 S01175
      *
     I@PARMT      DS
      *
      *  Data structure to hold trade details
      *
     I                                        1   1 @PRECI                S01175
     I                                        2   7 @PTDRF                S01175
     I                                        8   8 @PTINC                S01175
     I                                        9  18 @PTDSS                S01175
     I**********                             19  240@PTCNR                             S01175 CSD027
     I                                       19  24 @PTCNR                                    CSD027
     I                                       25  26 @PTDTP                S01175
     I                                    P  27  320@PNOML                S01175
     I                                       33  35 @PTNMC                S01175
     I                                    P  36  360@PTNMD                S01175
     I                                    P  37  448@PTPDY                S01175
     I                                    P  45  470@PTDVD                S01175
     I***********                            48  500@PTDBR         S01175 S01117
     I***********                            51  52 @PTDBK         S01175 S01117
     I***********                         P  53  550@PTDDT         S01175 S01117
     I***********                            56  57 @PTSUB         S01175 S01117
     I***********                            58  63 @PLKRF         S01175 S01117
     I***********                            64  64 @PTDMI         S01175 S01117
     I***********                            65  99 @PTDNR         S01175 S01117
     I***********                           100 102 @PTDID         S01175 S01117
     I***********                           103 103 @PAIIP         S01175 S01117
     I***********                           104 105 @PTMKC         S01175 S01117
     I***********                           106 1060@PTCAP         S01175 S01117
     I***********                         P 107 1118@PTCFC         S01175 S01117
     I***********                           112 112 @PACIN         S01175 S01117
     I***********                         P 113 1140@PDADJ         S01175 S01117
     I***********                           115 115 @PADIN         S01175 S01117
     I***********                         P 116 1220@PITRA         S01175 S01117
     I***********                         P 123 1290@PTINA         S01175 S01117
     I***********                         P 130 1357@PTDCR         S01175 S01117
     I***********                         P 136 1438@PPRIC         S01175 S01117
     I***********                           144 144 @PEXDV         S01175 S01117
     I***********                         P 145 1495@PRALL         S01175 S01117
     I***********                           150 152 @PSETC         S01175 S01117
     I***********                         P 153 1598@PTDER         S01175 S01117
     I***********                           160 160 @PTMDI         S01175 S01117
     I***********                         P 161 1678@PTBCR         S01175 S01117
     I***********                           168 1690@PSMTH         S01175 S01117
     I***********                           170 181 @PPYFM         S01175 S01117
     I***********                           182 1840@PPYFB         S01175 S01117
     I***********                           185 196 @PPAYT         S01175 S01117
     I***********                           197 1990@PPYTB         S01175 S01117
     I***********                           200 207 @PTDFA         S01175 S01117
     I***********                           208 2090@PASNM         S01175 S01117
     I***********                           210 210 @PCLTY         S01175 S01117
     I***********                           211 2160@PDELT         S01175 S01117
     I***********                           217 224 @PDTFA         S01175 S01117
     I***********                           225 2300@PDELF         S01175 S01117
     I***********                           231 238 @PDFFA         S01175 S01117
     I***********                           239 273 @PTDSI         S01175 S01117
     I***********                           274 274 @PPRYC         S01175 S01117
     I***********                           275 275 @PPCOD         S01175 S01117
     I***********                           276 277 @PTBCC         S01175 S01117
     I***********                         P 278 2840@PTBCA         S01175 S01117
     I***********                           285 286 @PTCCC         S01175 S01117
     I***********                         P 287 2930@PTCCA         S01175 S01117
     I***********                           294 295 @PTCC1         S01175 S01117
     I***********                         P 296 3020@PTCA1         S01175 S01117
     I***********                           303 304 @PTCC2         S01175 S01117
     I***********                         P 305 3110@PTCA2         S01175 S01117
     I***********                           312 313 @PTCC3         S01175 S01117
     I***********                         P 314 3200@PTCA3         S01175 S01117
     I***********                           321 322 @PTCC4         S01175 S01117
     I***********                         P 323 3290@PTCA4         S01175 S01117
     I***********                           330 331 @PTCC5         S01175 S01117
     I***********                         P 332 3380@PTCA5         S01175 S01117
     I***********                           339 340 @PTCC6         S01175 S01117
     I***********                         P 341 3470@PTCA6         S01175 S01117
     I***********                           348 349 @PTCC7         S01175 S01117
     I***********                         P 350 3560@PTCA7         S01175 S01117
     I***********                         P 357 3630@PTAXA         S01175 S01117
     I***********                         P 364 3700@PBCMR         S01175 S01117
     I***********                         P 371 3770@PCCMR         S01175 S01117
     I***********                         P 378 3840@PTXRB         S01175 S01117
     I***********                           385 390 @PBLKR         S01175 S01117
     I***********                           391 396 @PRTRF         S01175 S01117
     I***********                           397 397 @PATRD         S01175 S01117
     I***********                           398 398 @PBCON         S01175 S01117
     I***********                           399 4040@PTIME         S01175 S01117
     I***********                           405 405 @PAUTS         S01175 S01117
     I***********                           406 406 @PTACI         S01175 S01117
     I***********                           407 407 @PTMSI         S01175 S01117
     I***********                           408 408 @PTCFR         S01175 S01117
     I***********                         P 409 4140@PTOSN         S01175 S01117
     I***********                         P 415 4200@PTNSN         S01175 S01117
     I***********                         P 421 4260@PTNSP         S01175 S01117
     I***********                         P 427 4340@PTOSV         S01175 S01117
     I***********                         P 435 4420@PTVSN         S01175 S01117
     I***********                         P 443 4500@PTVSP         S01175 S01117
     I***********                         P 451 4580@PTDSN         S01175 S01117
     I***********                         P 459 4660@PTDSP         S01175 S01117
     I***********                         P 467 4690@PTDFS         S01175 S01117
     I***********                         P 470 4710@PTSSQ         S01175 S01117
     I***********                         P 472 4790@PTCSR         S01175 S01117
     I***********                         P 480 4870@PTCTR         S01175 S01117
     I***********                         P 488 4900@PTDMC         S01175 S01117
     I***********                         P 491 4930@PTOED         S01175 S01117
     I***********                         P 494 4960@PLCD          S01175 S01117
     I***********                           497 497 @PCHTP         S01175 S01117
     I***********                         P 498 5000@PTNLU         S01175 S01117
     I                                       48  50 @PTDBA                S01117
     I                                       51  53 @PORBR                S01117
     I                                       54  55 @PTDBK                S01117
     I                                    P  56  580@PTDDT                S01117
     I                                       59  60 @PTSUB                S01117
     I                                       61  66 @PLKRF                S01117
     I                                       67  67 @PTDMI                S01117
     I                                       68 102 @PTDNR                S01117
     I                                      103 105 @PTDID                S01117
     I                                      106 106 @PAIIP                S01117
     I                                      107 108 @PTMKC                S01117
     I                                      109 1090@PTCAP                S01117
     I**********                          P 110 1148@PTCFC         S01117 052254
     I                                      110 114 @ZZ005                052254
     I                                      115 115 @PACIN                S01117
     I                                    P 116 1170@PDADJ                S01117
     I                                      118 118 @PADIN                S01117
     I                                    P 119 1250@PITRA                S01117
     I                                    P 126 1320@PTINA                S01117
     I                                    P 133 1387@PTDCR                S01117
     I                                    P 139 1468@PPRIC                S01117
     I                                      147 147 @PEXDV                S01117
     I                                    P 148 1525@PRALL                S01117
     I                                      153 155 @PSETC                S01117
     I                                    P 156 1628@PTDER                S01117
     I                                      163 163 @PTMDI                S01117
     I                                    P 164 1708@PTBCR                S01117
     I                                      171 1720@PSMTH                S01117
     I**********                            173 184 @PPYFM                             S01117 CGL029
     I                                      173 184 QQPYFM                                    CGL029
     I                                      185 187 @PPYFA                S01117
     I**********                            188 199 @PPAYT                             S01117 CGL029
     I                                      188 199 QQPAYT                                    CGL029
     I                                      200 202 @PPYTA                S01117
     I                                      203 210 @PTDFA                S01117
     I                                      211 2120@PASNM                S01117
     I                                      213 213 @PCLTY                S01117
     I**********                            214 2190@PDELT                             S01117 CSD027
     I                                      214 219 @PDELT                                    CSD027
     I                                      220 227 @PDTFA                S01117
     I**********                            228 2330@PDELF                             S01117 CSD027
     I                                      228 233 @PDELF                                    CSD027
     I                                      234 241 @PDFFA                S01117
     I                                      242 276 @PTDSI                S01117
     I                                      277 277 @PPRYC                S01117
     I                                      278 278 @PPCOD                S01117
     I                                      279 280 @PTBCC                S01117
     I                                    P 281 2870@PTBCA                S01117
     I                                      288 289 @PTCCC                S01117
     I                                    P 290 2960@PTCCA                S01117
     I                                      297 298 @PTCC1                S01117
     I                                    P 299 3050@PTCA1                S01117
     I                                      306 307 @PTCC2                S01117
     I                                    P 308 3140@PTCA2                S01117
     I                                      315 316 @PTCC3                S01117
     I                                    P 317 3230@PTCA3                S01117
     I                                      324 325 @PTCC4                S01117
     I                                    P 326 3320@PTCA4                S01117
     I                                      333 334 @PTCC5                S01117
     I                                    P 335 3410@PTCA5                S01117
     I                                      342 343 @PTCC6                S01117
     I                                    P 344 3500@PTCA6                S01117
     I                                      351 352 @PTCC7                S01117
     I                                    P 353 3590@PTCA7                S01117
     I                                    P 360 3660@PTAXA                S01117
     I                                    P 367 3730@PBCMR                S01117
     I                                    P 374 3800@PCCMR                S01117
     I                                    P 381 3870@PTXRB                S01117
     I                                      388 393 @PBLKR                S01117
     I                                      394 399 @PRTRF                S01117
     I                                      400 400 @PATRD                S01117
     I                                      401 401 @PBCON                S01117
     I                                      402 4070@PTIME                S01117
     I                                      408 408 @PAUTS                S01117
     I                                      409 409 @PTACI                S01117
     I                                      410 410 @PTMSI                S01117
     I                                      411 411 @PTCFR                S01117
     I                                    P 412 4170@PTOSN                S01117
     I                                    P 418 4230@PTNSN                S01117
     I                                    P 424 4290@PTNSP                S01117
     I                                    P 430 4370@PTOSV                S01117
     I                                    P 438 4450@PTVSN                S01117
     I                                    P 446 4530@PTVSP                S01117
     I                                    P 454 4610@PTDSN                S01117
     I                                    P 462 4690@PTDSP                S01117
     I                                    P 470 4720@PTDFS                S01117
     I                                    P 473 4740@PTSSQ                S01117
     I                                    P 475 4820@PTCSR                S01117
     I                                    P 483 4900@PTCTR                S01117
     I                                    P 491 4930@PTDMC                S01117
     I                                    P 494 4960@PTOED                S01117
     I                                      497 500 @PPRFC                S01117
     I                                      501 501 @PPRPC                S01117
     I                                    P 502 5040@PLCD                 S01117
     I                                      505 505 @PCHTP                S01117
     I                                    P 506 5080@PTNLU                S01117
     I                                    P 509 5100@PLSWS                S01117
     I                                    P 511 5169@PTCFC                052254
     I************                          518 521 @PPTFR         S01486 100239
     I************                        P 522 5280@PSPXR         S01486 100239
     I************                          529 529 @PSPMD         S01486 100239
     I                                      517 520 @PPTFR                100239
     I                                    P 521 5270@PSPXR                100239
     I                                      528 528 @PSPMD                100239
     I                                      529 532 @PBPRC                CAC002
     I                                      533 536 @PTPRC                CAC002
     I                                    P 537 5402@PFXMP                CAC002
     I                                    P 541 5478@PFXMR                CAC002
     I                                    P 548 5540@PMAMT                CAC002
     I                                      555 557 @PICCY                CEU005
     I                                    P 634 6400@PWHTX                187727
     I                                      641 641 @PBWDI                187727
     I                                    P 642 6498@PCRSK                                    CAS006
     I                                    P 650 6578@PLQPR                                    CAS006
     I                                    P 658 6640@PTINN                                    CAS006
     I                                    P 665 6710@PITRN                                    CAS006
     I                                    P 672 6798@PPRCN                                    CAS006
     I                                      680 697 @PPYFM                                    CGL029
     I                                      698 715 @PPAYT                                    CGL029
     I                                    P 716 7238@PFSPR                                    233607
     I                                    P 724 7318@PFSPP                                    233607
     I                                    P 732 7380@PEUTX                                    233607
     I                                    P 739 7450@PEUTS                                    233607
     I@PRMT2      DS                                                                        AR871625
     I                                        1   1 @PTLIA                                  AR871625
     I                                    P   2   80@PTAMT                                  AR871625
     I                                    P   9  150@PCAMT                                  AR871625
      *
      *  Data structures to send and receive from SE3002
      *                                                                   S01176
     I*@PARMS****  DS                            464                      S01176
     I*@PARMR****  DS                            464                      S01176
     I*@PARMS******DS                            493               S01176 S01175
     I*@PARMR******DS                            493               S01176 S01175
     I*@PARMS******DS                            500               S01175 S01117
     I*@PARMR******DS                            500               S01175 S01117
     I*@PARMS******DS                            510               S01117 052254
     I*@PARMR******DS                            510               S01117 052254
     I***@PARMS******DS                            516              052254S01486
     I***@PARMR******DS                            516              052254S01486
     I*@PARMS******DS                           529                S01486 100239
     I*@PARMR******DS                           529                S01486 100239
     I*@PARMS******DS                           528                100239 CAC002
     I*@PARMR******DS                           528                100239 CAC002
     I*@PARMS******DS                            554                CAC002CEU005
     I*@PARMR******DS                            554                CAC002CEU005
     I*@PARMS******DS                            557               CEU005 187727
     I*@PARMR******DS                            557               CEU005 187727
     I**********@PARMS      DS                            641                          187727 CAS006
     I***@PARMS*     DS                            679                                 CAS006 CGL029
     I***@PARMS*     DS                            715                                 CGL029 233607
     I**********@PARMR      DS                            641                          187727 CAS006
     I***@PARMR*     DS                            679                                 CAS006 CGL029
     I***@PARMR*     DS                            715                                 CGL029 233607
     I@PARMS      DS                            747                                           233607
     I@PARMR      DS                            747                                           233607
     I*                                                                   S01486
     I** Data structure to send and receive SE5200                        S01486
     I*                                                                   S01486
     IPARMBI      DS                                                      S01486
     I                                        1   1 PACCD                 S01486
     I                                        2   7 PBURE                 S01486
     I                                        8   8 PAGTD                 S01486
     I                                        9  18 PSESN                 S01486
     I                                       19  19 PDEPA                 S01486
     I                                       20  21 PTRTY                 S01486
     I                                       22  23 PBOCO                 S01486
     I                                       24  29 PPOCU                 S01486
     I                                       30  33 PPOPO                 S01486
     I                                       34  49 PBONO                 S01486
     I                                       50  65 PMANO                 S01486
     I                                       66  81 PPONO                 S01486
     I                                       82  97 PPDYP                 S01486
     I                                       98 100 PBRCO                 S01486
     I                                      101 101 PCLTY                 S01486
     I                                      102 107 PTRDA                 S01486
     I                                      108 113 PVADA                 S01486
     I                                      114 114 PACRIN                S01486
     I                                      115 118 PDAAS                 S01486
     I                                      119 119 PACDI                 S01486
     I                                      120 125 PDEFR                 S01486
     I                                      126 131 PDETO                 S01486
     I                                      132 133 PCMDK                 S01486
     I                                      134 134 PTPTIF                S01486
     I                                    P 135 1410PCHRG                 S01486
     I                                    P 142 1480PNTOT                 S01486
     I                                      149 149 PCAGT                 S01486
      /COPY ZSRSRC,ZTNLU1Z1
      /COPY ZSRSRC,ZSEDITZ2
      *
     I            DS
      *
      *  Data structure to strip last character from ZSEDIT output
      *
     I                                        1  21 ZOUT21
     I                                        1  20 ZOUT20
      *
     I*@KEY12      DS                             12
      *
      *  Data structure used as key to TABTG10
      *
     I*                                       9  11 @KCCY
      *                                                                   S01448
     I@IND        DS                              5                       S01448
      *                                                                   S01448
      *  Data structure used to store indicator values                    S01448
      *                                                                   S01448
     I                                        1   1 @IN40                 S01448
     I                                        2   2 @IN41                 S01448
     I                                        3   3 @IN42                 S01448
     I                                        4   4 @IN43                 S01448
     I                                        5   5 @IN44                 S01448
      *                                                                   CSE003
     ISESDS     E DS                                                      CSE003
      *                                                                   CSE003
     I              'SEVTVALDT'           C         SEVDAL                                    234440
     I              'SEVTAXDATE'          C         SEVDAT                                    234552
     I@CUSDT      DS                                                                          234552
      ** Customer (Counterparty) Details                                                      234552
     I                                        1   6 WCUSNU                                    234552
     I                                        7  10 WCUSAC                                    234552
     I                                       11  13 WCUSCU                                    234552
     I                                       14  150WCUSSQ                                    234552
     I                                       16  16 WCUSCL                                    234552
     I                                       17  22 WCUSD1                                    234552
     I                                       23  28 WCUSD2                                    234552
     I                                       29  30 WCUSP1                                    234552
     I                                       31  32 WCUSP2                                    234552
     I                                       33  34 WCUSTA                                    234552
     I                                       35  35 WCUSAU                                    234552
     I                                       36  37 WCUSTD                                    234552
     I                                       38  38 WLPCUS                                    234552
     I                                       39  41 WCUSBY                                    234552
     I                                       42  420WCUSDP                                    234552
     I                                       43  46 WCUSPO                                    234552
     I                                       47  47 WPBCUS                                    234552
     I                                       48  49 WCUSCO                                    234552
     I*                                                                   S01408
     I/COPY WNCPYSRC,SE3000IIP1                                           S01408
     I*                                                                   S01408
     C/EJECT
      ********************************************************************S01176
      *                                                                  *S01176
      *    M A I N   P R O C E S S I N G                                 *S01176
      *                                                                  *S01176
      *    Calls : SUB001                                                *S01176
      *            SUB002                                                *S01176
      *            SUB800                                                *S01176
      *                                                                  *S01176
      ********************************************************************S01176
      *
      * Initialize program
      *
     C                     EXSR SUB001
      *
      * Repeat main processing until F3 pressed
      *
     C           *INKC     DOUEQ'1'                        B001
     C                     EXSR SUB002
     C                     END                             E001
      *
      * If SE3002 has been called, then close files
      *
     C           @S3002    CASEQ'Y'       SUB800           B001
     C                     END                             E001
      *
      * Terminate program
      *
     C                     SETON                     LR
     C                     RETRN
      /SPACE 3
      *****************************************************************
      *  PLIST's, KLIST's, DEFN's etc....                             *
      *****************************************************************
      *
     C           *NAMVAR   DEFN           LDA
     C           *NAMVAR   DEFN           SESDS                           CSE003
     C           *LIKE     DEFN @DBALL    @DBSAV
     C           *LIKE     DEFN BFCLAS    WCLSAV                          S01448
     C           *LIKE     DEFN @PTBCC    @OTBCC                          069175
      *
      * KLIST for LF/INVTP
      *
     C           @KEY1     KLIST
     C                     KFLD           NMCYA
     C                     KFLD           SITP
     C*                                                                   S01486
     C** KLIST FOR PMSBPDPD                                               S01486
     C           KEY2      KLIST                                          S01486
     C                     KFLD           KPCUST                          S01486
     C                     KFLD           KPREF                           S01486
     C*                                                                   S01486
     C** KLIST FOR PMPLTRPD                                               S01486
     C           KEY3      KLIST                                          S01486
     C                     KFLD           KBLKR                           S01486
     C                     KFLD           KPCUST                          S01486
     C                     KFLD           KPREF                           S01486
     C*                                                                   S01486
     C** KLIST FOR READ EQUAL ON PMPLTRPD                                 S01486
     C           KEY3A     KLIST                                          S01486
     C                     KFLD           KBLKR                           S01486
     C*                                                                   S01486
     C** KLIST FOR TRADBK                                                 S01486
     C           KEY4      KLIST                                          S01486
     C                     KFLD           KBLKR                           S01486
     C                     KFLD           KAGTR                           S01486
     C*                                                                   S01486
     C** KLIST FOR READ EQUAL ON TRADBK                                   S01486
     C           KEY4A     KLIST                                          S01486
     C                     KFLD           KBLKR                           S01486
     C*                                                                   S01486
     C** KLIST FOR BKPSO                                                  S01486
     C           KEY5      KLIST                                          S01486
     C                     KFLD           KSECT                           S01486
     C                     KFLD           KBRCH                           S01486
     C                     KFLD           KBOOK                           S01486
     C                     KFLD           KMKID                           S01486
     C                     KFLD           KTDVA                           S01486
     C                     KFLD           KDATE                           S01486
     C*                                                                   S01486
     C** KLIST FOR READ EQUAL ON BKPSO                                    S01486
     C           KEY5A     KLIST                                          S01486
     C                     KFLD           KSECT                           S01486
     C                     KFLD           KBRCH                           S01486
     C                     KFLD           KBOOK                           S01486
     C                     KFLD           KMKID                           S01486
     C                     KFLD           KTDVA                           S01486
     C*                                                                   S01486
     C** KLIST FOR PMHOLDL4                                               S01486
     C           KEY6      KLIST                                          S01486
     C                     KFLD           KPCUST                          S01486
     C                     KFLD           KPREF                           S01486
     C                     KFLD           KPADSP  20                      S01486
     C                     KFLD           KPDDSP  3                       S01486
     C                     KFLD           KPDITD  20                      S01486
     C                     KFLD           KINNR   3                       S01486
     C***********          KFLD           KDLSQ   30               S01486 CPM005
     C***********          KFLD           KCCY1   3                S01486 CPM005
     C                     KFLD           KPOSQ  11                       CPM005
     C                     KFLD           KSECT                           S01486
     C**********           KFLD           KTRNB   60                                   S01486 CLE148
     C                     KFLD           KTRNB   6                                           CLE148
     C**********           KFLD           KTXT   20                                    S01486 CGL029
     C                     KFLD           KTXT   26                                           CGL029
     C*                                                                   S01486
     C** KLIST FOR READ EQUAL ON PMHOLDL4                                 S01486
     C           KEY6A     KLIST                                          S01486
     C                     KFLD           KPCUST                          S01486
     C                     KFLD           KPREF                           S01486
     C                     KFLD           KPADSP                          S01486
     C                     KFLD           KPDDSP                          S01486
     C                     KFLD           KPDITD                          S01486
     C                     KFLD           KINNR                           S01486
     C***********          KFLD           KDLSQ                    S01486 CPM005
     C***********          KFLD           KCCY1                    S01486 CPM005
     C                     KFLD           KPOSQ                           CPM005
     C                     KFLD           KSECT                           S01486
     C*                                                                   S01486
     C** KLIST FOR TNRAN                                                  S01486
     C           KEY7      KLIST                                          S01486
     C                     KFLD           K1      20                      S01486
     C                     KFLD           K2      8                       S01486
     C                     KFLD           K3      20                      S01486
      *                                                                   CSE023
      ** Key list for SDWTCSL0                                            CSE023
      *                                                                   CSE023
     C           KEY8      KLIST                                          CSE023
     C                     KFLD           KCNUM   6                       CSE023
     C                     KFLD           KCRTT   2                       CSE023
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB001 - Program initialization                              *
      *                                                               *
      *****************************************************************
      *
     C           SUB001    BEGSR
      *
      * Set up fixed values
      *
     C                     MOVEL'L'       ZECODE
     C                     MOVEL'N'       @S3002  1
     C                     MOVEL'SE'      @MID
     C                     MOVEL'SE3000'  @PGM
     C                     MOVEL@JOB      @WID
     C                     MOVEL@USR      @USER
     C                     SETOF                     05
      *
      **Get*ICD1**************************                                S01117
      *
     C***********          EXSR ZSYSTM                                    S01117
     C************IN99     IFEQ '1'                        B001           S01117
     C***********          Z-ADD1         @DBASE           ***************S01117
     C***********          MOVEL'ICD1'    @DBFIL           * DB ERROR 01 *S01117
     C***********          MOVELZTABKY    @DBKEY           ***************S01117
     C***********          EXSR SUB999                                    S01117
     C***********          END                             E001           S01117
      *
      **Get*ICD2**************************                                S01117
      *
     C***********          EXSR ZICD2                                     S01117
     C************INU7     IFEQ '1'                        B001           S01117
     C***********          Z-ADD2         @DBASE           ***************S01117
     C***********          MOVEL'ICD2'    @DBFIL           * DB ERROR 02 *S01117
     C***********          MOVELZTABKY    @DBKEY           ***************S01117
     C***********          EXSR SUB999                                    S01117
     C***********          END                             E001           S01117
      *
      **Get*SE*ICD***********************                                 S01117
      *
     C***********          EXSR ZICDSE                                    S01117
     C************INU7     IFEQ '1'                        B001           S01117
     C***********          Z-ADD3         @DBASE           ***************S01117
     C***********          MOVEL'ICDSE'   @DBFIL           * DB ERROR 03 *S01117
     C***********          MOVELZTABKY    @DBKEY           ***************S01117
     C***********          EXSR SUB999                                    S01117
     C***********          END                             E001           S01117
     C*                                                                   S01117
     C**   Read in ZMUSER                                                 S01117
     C*                                                                   S01117
     C           *NAMVAR   DEFN           ZMUSER                          S01117
     C                     IN   ZMUSER                                    S01117
     C*                                                                   S01117
     C**   Read in RUNDAT                                                 S01117
     C*                                                                   S01117
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
     C                     IN   RUNDT                                     S01117
     C*                                                                   S01117
     C**   Check Multibranching                                           S01117
     C*                                                                   S01117
     C           MBIN      IFEQ 'Y'                                       S01117
     C                     SETON                     32                   S01117
     C                     END                                            S01117
     C**                                                                  S01117
     C**   Check System Date Format, DDMMYY or MMDDYY.                    S01117
     C**                                                                  S01117
     C           DATF      COMP 'M'                      98               S01117
     C*                                                                   S01117
     C**   Access Bank Details                                            S01117
     C*                                                                   S01117
     C                     CALL 'AOBANKR0'                                S01117
     C                     PARM '*DBERR ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDBANK    PARM SDBANK    DSFDY                           S01117
     C*                                                                   S01117
     C**   Access General Ledger details                                  S01117
     C*                                                                   S01117
     C**********           CALL 'AOGELRR0'                                             S01117 CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*DBERR ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C********** SDGELR    PARM SDGELR    DSFDY                                        S01117 CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
     C*                                                                   S01117
     C**   Access Securities Trading ICD                                  S01117
     C*                                                                   S01117
     C                     CALL 'AOSTRDR0'                                S01117
     C                     PARM '*DBERR ' @RTCD   7                       S01117
     C                     PARM '*FIRST ' @OPTN   7                       S01117
     C           SDSTRD    PARM SDSTRD    DSSDY                           S01117
     C/COPY WNCPYSRC,SE3000C020
      *                                                                   S01401
      **  Access Switchable features file for MT5xx processing -          S01401
      *                                                                   S01401
     C                     MOVE 'N'       S01401                          S01401
     C                     CALL 'AOSARDR0'                                S01401
     C                     PARM '       ' @RTCD                           S01401
     C                     PARM '*VERIFY' @OPTN                           S01401
     C                     PARM 'S01401'  @SARD   6                       S01401
      *                                                                   S01401
     C           @RTCD     IFEQ *BLANK                                    S01401
     C                     MOVE 'Y'       S01401  1                       S01401
     C                     ENDIF                                          S01401
      *                                                                   S01448
      **  Access Switchable features file for Bulk Input enhancements     S01448
      *                                                                   S01448
     C                     MOVE 'N'       S01448                          S01448
     C                     CALL 'AOSARDR0'                                S01448
     C                     PARM '       ' @RTCD                           S01448
     C                     PARM '*VERIFY' @OPTN                           S01448
     C                     PARM 'S01448'  @SARD                           S01448
      *                                                                   S01448
     C           @RTCD     IFEQ *BLANK                                    S01448
     C                     MOVE 'Y'       S01448  1                       S01448
     C                     END                                            S01448
     C*
      **  Access Switchable features file for Market Migration            S01511
      *                                                                   S01511
     C                     CALL 'AOSARDR0'                                S01511
     C                     PARM *BLANKS   @RTCD                           S01511
     C                     PARM '*VERIFY' @OPTN                           S01511
     C                     PARM 'S01511'  @SARD                           S01511
      *                                                                   S01511
     C           @RTCD     IFEQ *BLANK                                    S01511
     C                     MOVE 'Y'       S01511  1                       S01511
     C                     ELSE                                           S01511
     C                     MOVE 'N'       S01511                          S01511
     C                     END                                            S01511
     C*                                                                   S01496
     C**  Access Switchable features file for Jyske SE Enhancements       S01496
     C*                                                                   S01496
     C                     MOVE 'N'       S01496                          S01496
     C                     CALL 'AOSARDR0'                                S01496
     C                     PARM '       ' @RTCD                           S01496
     C                     PARM '*VERIFY' @OPTN                           S01496
     C                     PARM 'S01496'  @SARD                           S01496
     C*                                                                   S01496
     C           @RTCD     IFEQ *BLANKS                                   S01496
     C                     MOVE 'Y'       S01496  1                       S01496
     C                     OPEN PRICM                                     S01496
     C                     OPEN CPOSC                                     S01496
     C                     END                                            S01496
     C*                                                                   CSE003
     C**  Check if ? processing available for security shortname.         CSE003
     C*                                                                   CSE003
     C                     MOVE 'N'       CSE003                          CSE003
     C                     CALL 'AOSARDR0'                                CSE003
     C                     PARM *BLANKS   @RTCD                           CSE003
     C                     PARM '*VERIFY' @OPTN                           CSE003
     C                     PARM 'CSE003'  @SARD                           CSE003
     C*                                                                   CSE003
     C           @RTCD     IFEQ *BLANKS                                   CSE003
     C                     MOVE 'Y'       CSE003  1                       CSE003
     C                     END                                            CSE003
      *                                                                   CSE007
      ***  Access Switchable features file for Corporate Actions.         CSE007
      *                                                                   CSE007
     C                     MOVE 'N'       CSE007  1                       CSE007
     C                     CALL 'AOSARDR0'                                CSE007
     C                     PARM '       ' @RTCD                           CSE007
     C                     PARM '*VERIFY' @OPTN                           CSE007
     C                     PARM 'CSE007'  @SARD                           CSE007
      *                                                                   CSE007
     C           @RTCD     IFEQ *BLANKS                                   CSE007
      *                                                                   CSE007
      ***  If Corporate Actions feature is installed.                     CSE007
      *                                                                   CSE007
     C                     MOVE 'Y'       CSE007                          CSE007
     C                     ELSE                                           CSE007
      *                                                                   CSE007
      ***  Setup work field to call SE6710, SE6712 and SE6714.            CSE007
      *                                                                   CSE007
     C                     MOVE 'Y'       SE6710  1                       CSE007
     C                     MOVE 'Y'       SE6712  1                       CSE007
     C                     MOVE 'Y'       SE6714  1                       CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CSE007
      *                                                                   CEU017
      ***  Access Switchable features file for Securities Redenomination  CEU017
      *                                                                   CEU017
     C                     MOVE 'N'       CEU017  1                       CEU017
     C                     CALL 'AOSARDR0'                                CEU017
     C                     PARM '       ' @RTCD                           CEU017
     C                     PARM '*VERIFY' @OPTN                           CEU017
     C                     PARM 'CEU017'  @SARD                           CEU017
      *                                                                   CEU017
     C           @RTCD     IFEQ *BLANKS                                   CEU017
      *                                                                   CEU017
      ***  If Corporate Actions feature is installed.                     CEU017
      *                                                                   CEU017
     C                     MOVE 'Y'       CEU017                          CEU017
     C                     ELSE                                           CEU017
      *                                                                   CEU017
      ***  Setup work field to call SE6710, SE6712 and SE6714.            CEU017
      *                                                                   CEU017
     C                     MOVE 'Y'       SE6710  1                       CEU017
     C                     MOVE 'Y'       SE6712  1                       CEU017
     C                     MOVE 'Y'       SE6714  1                       CEU017
     C                     ENDIF                                          CEU017
      *                                                                   CAC005
      ***  Check if CAC005 - PCA-SE Enhancement is on.                    CAC005
      *                                                                   CAC005
     C                     MOVE 'N'       CAC005  1                       CAC005
     C                     MOVE *OFF      *IN71                           CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   @RTCD                           CAC005
     C                     PARM '*VERIFY' @OPTN                           CAC005
     C                     PARM 'CAC005'  @SARD                           CAC005
      *                                                                   CAC005
     C           @RTCD     IFEQ *BLANK                                    CAC005
     C                     MOVE 'Y'       CAC005                          CAC005
     C                     MOVE *ON       *IN71                           CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
      *                                                                   CEU017
     C/COPY WNCPYSRC,SE3000C001
      *                                                                   CSE010
      ** Check if CSE010 (Transaction Enhancements) is active             CSE010
      *                                                                   CSE010
     C                     CALL 'AOSARDR0'                                CSE010
     C                     PARM '       ' @RTCD                           CSE010
     C                     PARM '*VERIFY' @OPTN   7                       CSE010
     C                     PARM 'CSE010'  @SARD   6                       CSE010
      *                                                                   CSE010
     C           @RTCD     IFEQ *BLANK                                    CSE010
     C                     MOVE 'Y'       CSE010  1                       CSE010
     C                     ELSE                                           CSE010
     C                     MOVE 'N'       CSE010                          CSE010
      *                                                                   CSE010
      ** Database Error (return code other than *NRF)                     CSE010
      *                                                                   CSE010
     C           @RTCD     IFNE '*NRF   '                                 CSE010
     C           *LOCK     IN   LDA                                       CSE010
     C                     MOVEL'SCSARDPD'@DBFIL           ***************CSE010
     C                     MOVEL'CSE010'  @DBKEY           * DB ERROR 20 *CSE010
     C                     Z-ADD20        @DBASE           ***************CSE010
     C                     OUT  LDA                                       CSE010
     C                     MOVE *ON       *INU7                           CSE010
     C                     MOVE *ON       *INU8                           CSE010
     C                     MOVE *ON       *INLR                           CSE010
     C                     EXSR *PSSR                                     CSE010
     C                     ENDIF                                          CSE010
     C                     ENDIF                                          CSE010
      *                                                                   CGL011
      ** Access Switchable Features file to check if CGL011               CGL011
      ** is installed.                                                    CGL011
      *                                                                   CGL011
     C                     MOVE 'N'       @COLF   1                       CGL011
      *                                                                   CGL011
     C                     CALL 'AOSARDR0'                                CGL011
     C                     PARM *BLANKS   @RTCD                           CGL011
     C                     PARM '*VERIFY' @OPTN                           CGL011
     C                     PARM 'CGL011'  @SARD                           CGL011
      *                                                                   CGL011
     C           @RTCD     IFNE *BLANKS                                   CGL011
     C           @RTCD     ANDNE'*NRF   '                                 CGL011
     C                     Z-ADD21        @DBASE                          CGL011
     C                     MOVEL'SCSARDPD'@DBFIL                          CGL011
     C                     MOVEL'CGL011'  @DBKEY                          CGL011
     C                     EXSR *PSSR                                     CGL011
     C                     ENDIF                                          CGL011
      *                                                                   CGL011
     C           @RTCD     IFEQ *BLANKS                                   CGL011
     C                     MOVE 'Y'       @COLF                           CGL011
     C                     ENDIF                                          CGL011
      *                                                                   CSE023
      ** Access Switchable Features file and check if CSE023 is           CSE023
      ** installed                                                        CSE023
      *                                                                   CSE023
     C                     MOVE 'N'       CSE023  1                       CSE023
     C                     CALL 'AOSARDR0'                                CSE023
     C                     PARM *BLANKS   @RTCD                           CSE023
     C                     PARM '*VERIFY' @OPTN                           CSE023
     C                     PARM 'CSE023'  @SARD                           CSE023
      *                                                                   CSE023
     C           @RTCD     IFEQ *BLANK                                    CSE023
     C                     MOVE 'Y'       CSE023                          CSE023
     C                     ENDIF                                          CSE023
      *                                                                                       CAS006
      ** Access Switchable Features file and check if CAS006 is                               CAS006
      ** installed                                                                            CAS006
      *                                                                                       CAS006
     C                     MOVE 'N'       CAS006  1                                           CAS006
     C                     CALL 'AOSARDR0'                                                    CAS006
     C                     PARM *BLANKS   @RTCD                                               CAS006
     C                     PARM '*VERIFY' @OPTN                                               CAS006
     C                     PARM 'CAS006'  @SARD                                               CAS006
      *                                                                                       CAS006
     C           @RTCD     IFNE *BLANKS                                                       CAS006
     C           @RTCD     ANDNE'*NRF   '                                                     CAS006
     C                     Z-ADD55        @DBASE                                              CAS006
     C                     MOVEL'SCSARDPD'@DBFIL                                              CAS006
     C                     MOVEL'CAS006'  @DBKEY                                              CAS006
     C                     EXSR *PSSR                                                         CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C           @RTCD     IFEQ *BLANKS                                                       CAS006
     C                     MOVE 'Y'       CAS006                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       234691
     C                     CALL 'AOSARDR0'                                                    234691
     C                     PARM '       ' @RTCD                                               234691
     C                     PARM '*VERIFY' @OPTN                                               234691
     C                     PARM 'S01509'  @SARD   6                                           234691
      *                                                                                       234691
     C           @RTCD     IFEQ *BLANK                                                        234691
     C                     MOVE 'Y'       S01509  1                                           234691
     C                     ENDIF                                                              234691
      *                                                                                       234691
     C                     CALL 'AOSARDR0'                                                    234691
     C                     PARM '       ' @RTCD                                               234691
     C                     PARM '*VERIFY' @OPTN                                               234691
     C                     PARM 'CGL031'  @SARD   6                                           234691
      *                                                                                       234691
     C           @RTCD     IFEQ *BLANK                                                        234691
     C                     MOVE 'Y'       CGL031  1                                           234691
     C                     ENDIF                                                              234691
      *                                                                                     AR871625
     C                     CALL 'AOSARDR0'                                                  AR871625
     C                     PARM '       ' @RTCD                                             AR871625
     C                     PARM '*VERIFY' @OPTN                                             AR871625
     C                     PARM 'CER049'  @SARD                                             AR871625
      *                                                                                     AR871625
     C                     MOVE 'N'       CER049  1                                         AR871625
     C           @RTCD     IFEQ *BLANK                                                      AR871625
     C                     MOVE 'Y'       CER049                                            AR871625
     C                     ENDIF                                                            AR871625
     C*                                                                   S01486
     C**   Access MIDAS MODULES Details                                   S01486
     C*                                                                   S01486
     C                     CALL 'AOMMODR0'                                S01486
     C                     PARM '*DBERR ' @RTCD   7                       S01486
     C                     PARM '*FIRST ' @OPTN   7                       S01486
     C           SDMMOD    PARM SDMMOD    DSFDY                           S01486
     C*                                                                   S01486
     C** Check whether Portfolio Management is switched on                S01486
     C*                                                                   S01486
     C           BGPFMG    IFEQ 'N'                                       S01486
     C                     MOVE 'N'       FCPPPR                          S01486
     C                     ELSE                                           S01486
     C*                                                                   S01486
     C** Open necessary files                                             S01486
     C*                                                                   S01486
     C                     OPEN PMPLTRPD                                  S01486
     C                     OPEN PMSBPDPD                                  S01486
     C                     OPEN TNRAN                                     S01486
     C                     OPEN BKPSO                                     S01486
     C                     OPEN PMHOLDL4                                  S01486
     C**********           OPEN PMHOLDL5                            S01486CPM005
     C                     OPEN PMDSPGPD                                  S01486
     C*                                                                   S01486
     C**   Access PORTFOLIO MANAGEMENT ICD Details                        S01486
     C*                                                                   S01486
     C                     CALL 'AOPORTR0'                                S01486
     C                     PARM '*DBERR ' @RTCD   7                       S01486
     C                     PARM '*FIRST ' @OPTN   7                       S01486
     C           SDPORT    PARM SDPORT    DSFDY                           S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** Setup indicator for display or non-display on screen             S01486
     C*                                                                   S01486
     C           FCPPPR    IFEQ 'N'                                       S01486
     C                     MOVE '1'       *IN66                           S01486
     C                     ELSE                                           S01486
     C                     MOVE '0'       *IN66                           S01486
     C                     END                                            S01486
     C*                                                                   S01408
     C** Set 'Called from Buy-Sell Maintenance' indicator to 'N'          CSE006
     C*                                                                   CSE006
     C                     MOVE 'N'       P@BYSL                          CSE006
     C*                                                                   CSE006
     C/COPY WNCPYSRC,SE3000CCP1                                           S01408
     C*                                                                   S01408
      *                                                                   S01486
      *
     C                     ENDSR                           SUB001 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB002 - Main processing                                     *
      *                                                               *
      *****************************************************************
      *
     C           SUB002    BEGSR
      *
      * Repeat until F12 is not on
      *
     C           *INKL     DOUEQ'0'                        B001
      *
      * Display/validate initial screen
      *
     C                     EXSR SUB101
      *
      * If action code is I, then initialize s/file1 with 100 records,
      * else action is E or D so fill subfile with existing bulk trades
      *
     C           @ACTC     IFEQ 'I'                        B002
      *                                                                   S01486
     C           @AGTR     IFEQ 'Y'                        B003           S01486
     C           FCPPPR    ANDEQ'Y'                                       S01486
     C           @AGTR     OREQ 'N'                                       S01486
     C           @POPO     ANDEQ*BLANKS                                   S01486
     C           FCPPPR    ANDEQ'Y'                                       S01486
     C                     EXSR SUB501                                    S01486
     C                     EXSR SUB102
     C                     END                             E003           S01486
     C           FCPPPR    IFNE 'Y'                                       S01486
     C                     EXSR SUB102                                    S01486
     C                     END                                            S01486
     C                     END                             E002           S01486
     C***********          ELSE                            X002           S01486
      *                                                                   S01486
     C           @ACTC     IFEQ 'D'                        B002           S01486
     C           @ACTC     OREQ 'E'                                       S01486
     C           FCPPPR    IFEQ 'Y'                                       S01486
     C                     EXSR SUB501                                    S01486
     C                     END                                            S01486
     C                     EXSR SUB103
     C                     END                             E002
      *
      * Repeat until F9 is not on
      *
     C           *INKI     DOUEQ'0'                        B002
     C           FCPPPR    IFNE 'Y'                        B003           S01486
     C           @ACTC     ORNE 'I'                                       S01486
     C           @ACTC     ANDNE'A'                                       092518
     C           @AGTR     OREQ 'Y'                                       S01486
     C           @POPO     OREQ *BLANKS                                   S01486
      *
      * Display/validate s/file1
      *
     C                     EXSR SUB104
      *                                                                   S01486
     C                     ELSE                            X003           S01486
      *                                                                   S01486
     C           @ACTC     IFEQ 'I'                        B004           S01486
     C                     EXSR SUB102                                    S01486
     C                     END                             E004           S01486
     C                     EXSR SUB502                                    S01486
     C           S01448    IFEQ 'Y'                                       S01486
     C                     MOVE @CAGT     PCAGT                           S01486
     C                     END                                            S01486
     C                     CALL 'SE5200'                                  S01486
     C           PARMBI    PARM PARMBI    PARMBI                          S01486
     C                     EXSR SUB503                                    S01486
      *                                                                   S01486
      * Reset job parameter on PF/PMPLTRPD to blanks                      S01486
      * If F3 or F12 pressed                                              S01486
     C           @ACTC     IFEQ 'A'                        B004           S01486
     C           *INKC     ANDEQ'1'                                       S01486
     C           @ACTC     OREQ 'A'                                       S01486
     C           *INKL     ANDEQ'1'                                       S01486
     C                     MOVE @BLKR     KBLKR                           S01486
     C                     MOVE *LOVAL    KPCUST                          S01486
     C                     MOVE *LOVAL    KPREF                           S01486
     C           KEY3      SETLLPMPLTRPD                                  S01486
     C           KEY3A     READEPMPLTRPD                 01               S01486
     C                     MOVE *BLANKS   OUJOB                           S01486
     C                     UPDATPMPLTRP0                                  S01486
      *                                                                   S01486
      * COMIT updates                                                     S01486
     C                     EXSR SUB401                                    S01486
     C                     END                             E004           S01486
     C                     END                             E003           S01486
      *
      * If F12 not pressed, and this is an agency trade, and action
      * is insert, then:
      *     Calculate average price                        (105)
      *     Initialize screen 2                            (106)
      *     Display/validate subfile 2                     (107)
      *
     C           *INKL     IFEQ '0'                        B003
     C           @ACTC     ANDEQ'I'
     C           @AGTR     ANDEQ'Y'
      *
     C                     EXSR SUB105
     C           @POPO     IFEQ *BLANKS                                   S01486
     C           FCPPPR    OREQ 'N'                                       S01486
      *
      * Do not re-initialize if F9 pressed
      *
     C           @INKI     IFEQ '0'                        B004
     C                     EXSR SUB106
     C                     END                             E004
      *
     C                     EXSR SUB107
      *                                                                   S01486
     C                     ELSE                                           S01486
      *                                                                   S01486
     C                     EXSR SUB502                                    S01486
     C           S01448    IFEQ 'Y'                                       S01486
     C                     MOVE @CAGT     PCAGT                           S01486
     C                     END                                            S01486
     C                     CALL 'SE5200'                                  S01486
     C           PARMBI    PARM PARMBI    PARMBI                          S01486
     C                     EXSR SUB503                                    S01486
     C                     END                                            S01486
      *                                                                   S01486
     C                     END                             E003
      *
      * If F12 And F9 not pressed, and an update has been made,
      * submit the default validation/update process to batch
      *
     C           *INKL     IFEQ '0'                        B003
     C           *INKI     ANDEQ'0'
     C           @UPD      ANDEQ'Y'
     C                     EXSR SUB108
     C                     END                             E003
      *
     C                     END                             E002
     C                     END                             E001
      *
     C                     ENDSR                           SUB002 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB101 - Control display/validation of initial screen        *
      *                                                               *
      *****************************************************************
      *
     C           SUB101    BEGSR
      *
      * Reset update flag
      *
     C                     MOVEL'N'       @UPD    1
      *
      * Reset F9 flag
      *
     C                     MOVEL'0'       @INKI   1
      *
      * Repeat until F12 not on
      *
     C           *INKL     DOUEQ'0'                        B001
      *
      * Reset indicators and fields
      *
     C                     SETOF                     202124
     C                     SETOF                     505254
     C                     SETOF                     565860
     C                     MOVE *OFF      *IN55                           CAC005
     C                     SETOF                     623164
     C                     SETOF                     1112                 S01117
     C                     SETOF                       6869               S01486
     C                     SETON                     30  51
     C                     MOVEL*BLANKS   @ACTC
     C                     MOVEL*BLANKS   @TDRF
     C                     MOVEL*BLANKS   @SEC
     C                     MOVEL*BLANKS   @TDTY
     C                     MOVEL*BLANKS   @BOOK
     C                     MOVEL*BLANKS   @BLKR
     C                     MOVEL*BLANKS   @BRCA                           S01117
     C                     MOVEL*BLANKS   @CAGT                           S01448
     C                     MOVEL*BLANKS   @POCU                           S01486
     C                     MOVEL*BLANKS   @POPO                           S01486
     C                     MOVEL*BLANKS   @PONO                           S01486
     C                     MOVEL*BLANKS   @BONO                           S01486
     C                     MOVEL*BLANKS   @PRFC                           CAC005
      *
      * Clear error code field unless job has been submitted, in which
      * case display a message
      *
     C           *IN09     IFEQ '0'                        B002
     C           S01511    IFEQ 'Y'                                       S01511
     C           @ERR      ANDEQ@TX,12                                    S01511
     C                     SETON                     50                   S01511
     C                     ELSE                                           S01511
     C                     MOVEL*BLANKS   @ERR
     C                     END                                            S01511
     C                     ELSE                            X002
     C                     SETOF                     09
     C                     SETON                     50
     C                     MOVEL@TX,7     @ERR
     C                     MOVEL@CJOB     @SJOB
     C                     END                             E002
      *
     C                     MOVEL'N'       @AGTR
      *                                                                   S01448
      * If Bulk enhancements feature is on then default the Agency        S01448
      * Trade indicator from the SE ICD file                              S01448
      *                                                                   S01448
     C           S01448    IFEQ 'Y'                        B002           S01448
     C                     MOVELBVDEAT    @AGTR                           S01448
     C*                                                                   S01448
     C* Clear common value date for agency trades                         S01448
     C                     Z-ADD0         ATDVD                           S01448
     C                     Z-ADD0         ATDVDS                          S01448
     C                     END                             E002           S01448
      *
      * Loop until valid
      *
     C           *IN50     DOUEQ'0'                        B002
      *
      * Display initial screen
      *
     C                     EXSR SUB200
      *
      * Validate if F12 not pressed
      *
     C           *INKL     CASEQ'0'       SUB201           B003
     C                     END                             E003
      *
     C                     END                             E002
     C                     END                             E001
      *
     C                     ENDSR                           SUB101 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB102 - Set up s/file 1 for input                           *
      *                                                               *
      *****************************************************************
      *
     C           SUB102    BEGSR
      *
      * Get next available bulf ref. number
      *
     C           1         SETLLBLKRFDF
     C                     READ BLKRFDF                  01
     C           *IN01     IFEQ '1'                        B001
     C                     Z-ADD4         @DBASE           ***************
     C                     MOVEL'BLKRF'   @DBFIL           * DB ERROR 04 *
     C                     MOVEL*BLANKS   @DBKEY           ***************
     C***********          EXSR SUB999                                    S01117
     C                     EXSR *PSSR                                     S01117
     C                     END                             E001
     C*                                                                   030834
     C           NABLKR    IFEQ *ZERO                                     030834
     C                     Z-ADD1         NABLKR                          030834
     C                     END                                            030834
     C*                                                                   030834
     C                     MOVELNABLKR    @BLKR
     C                     ADD  1         NABLKR
     C                     UPDATBLKRFDF
      *
      * Get next available transaction number
      *
     C                     EXSR ZTNLU1
     C                     MOVELNATN      @NTN
      *
      * If a trade ref. has been entered on init. screen, display one
      * price/yield/discount in the s/file header, else allow input of
      * price/yield/discount on each s/file line.
      *
     C                     SETOF                     31
     C                     MOVEL*BLANKS   @PYD
     C           @TDRF     IFNE *BLANKS                    B001
     C                     MOVELTPDY      ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @PYD
     C                     SETON                     31
     C                     END                             E001
      *
      **Get*product*of*stock*denom.***ten*to*the*power*of*the*nominal*dec.S01176
      **places*for*nominal*validation*************************************S01176
      *                                                                   S01176
      ***  Calculate the product of (trade denomination) and (ten to the  S01176
      ***  power of the nominal decimal places) for nominal validation.   S01176
      *                                                                   S01176
     C                     Z-ADDSDNM      @SDNM2 110
     C           NMDP      IFEQ 1                          B001
     C                     MULT 10        @SDNM2
     C                     END                             E001
     C           NMDP      IFEQ 2                          B001
     C                     MULT 100       @SDNM2
     C                     END                             E001
     C           NMDP      IFEQ 3                          B001
     C                     MULT 1000      @SDNM2
     C                     END                             E001
      *
      * Protect initial screen fields, initialise s/file
      *
     C                     SETOF                     24  25
     C                     SETOF                     30  51
     C                     SETON                         23
     C                     WRITESE3000F1
      *
      * Initialize s/f 1 record count, nominal total and total cost
      *
     C                     Z-ADD0         @SF1R   50
     C                     Z-ADD0         @NTOT1 150
     C*********************Z-ADD0         @TCOST 150                      S01176
     C***********          Z-ADD0         @TCOST 154               S01176 064529
     C***********          Z-ADD0         @TCOST 150               064529 067527
     C                     Z-ADD0         @TCOST 248                      067527
      *
      * Initialize cumulated market charge and nominal fields
      *
     C                     Z-ADD0         @CUMMC 150
     C                     Z-ADD0         @CUMMN 150
      *
      * Write a page of s/file 1 records
      *
     C                     EXSR SUB203
      *
     C                     SETON                     24  30
     C                     SETOF                     23
      *
     C                     ENDSR                           SUB102 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB103 - Set up s/file 1 for enquire/delete                  *
      *                                                               *
      *****************************************************************
      *
     C           SUB103    BEGSR
      *
      * Protect initial screen fields, clear s/file
      *
     C                     SETOF                     512430
     C                     SETOF                     262940
     C                     SETOF                     414243
     C                     SETOF                     442028
     C                     SETOF                     11                   S01117
     C                     SETON                     232527
      *
     C           @ACTC     IFEQ 'D'                        B001
     C                     SETON                     20  28
     C                     EXSR ZTNLU1
     C                     MOVELNATN      @NTN
     C                     END                             E001
      *
     C                     Z-ADD1         @SFREC
     C                     Z-ADD0         @SFK    50
     C                     WRITESE3000F1
      *
      * Fill the s/file from the trades by bulk reference file
      *
     C           @BLKR     SETLLTRADBKF                                   CFE001
      *
     C           *IN01     DOUEQ'1'                        B001
     C           @BLKR     READETRADBKF                  01               CFE001
      *
      * Display active trades for delete
      *
     C                     SETOF                         10
     C           @ACTC     IFEQ 'D'                        B002
     C           RECI      ANDNE'D'
     C           RECI      ANDNE'S'
     C           RECI      ANDNE'A'
     C           RECI      ANDNE'L'                                       S01269
     C           RECI      ANDNE'P'                                       S01269
     C                     SETON                         10
     C                     END                             E002
      *
     C           *IN01     IFEQ '0'                        B002
     C           *IN10     ANDEQ'0'
      *
     C                     ADD  1         @SFK
     C                     MOVEL@BLKDS    @PARMT
      *
     C                     MOVEL*BLANKS   @DLFG
      *
      * Update parameter fields if delete
      *
     C           @ACTC     IFEQ 'D'                        B003
     C                     Z-ADDNATN      @PTNLU
     C                     MOVEL'D'       @PCHTP
      *
      * Mark deleted records with a '*' if enquiry
      *
     C                     ELSE                            X003
     C           RECI      IFEQ '*'                        B004
     C           RECI      OREQ 'C'
     C***********          MOVEL'*'       @DLFG                           S01117
     C                     MOVE '*'       @DLFG                           S01117
     C                     END                             E004
     C                     END                             E003
      *                                                                   S01117
      * On enquiry check whether user is authorised to branch of          S01117
      * individual trades                                                 S01117
      *                                                                   S01117
     C           @ACTC     IFEQ 'E'                                       S01117
     C           MBIN      ANDEQ'Y'                                       S01117
     C                     SETOF                     1228                 S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM           @ACTC                           S01117
     C                     PARM           TDBA                            S01117
     C                     PARM           @ER     10                      S01117
     C*                                                                   S01117
     C**   If action invalid for user, mark this with flashing '**'       S01117
     C*                                                                   S01117
     C           @ER       IFNE 0                                         S01117
     C                     SETON                     111228               S01117
     C                     MOVEL'**'      @DLFG                           S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *
      * Reference
      *
     C                     MOVELTDRF      @REF
      *
      * Get client shortname (use client number if shortname is blank)
      *
     C***********TCNR      CHAINCLINTCBF             01                   S01117
     C************IN01     IFEQ '1'                        B003           S01117
     C***********RECI      OREQ '*'                                       S01117
     C***********          Z-ADD6         @DBASE           ***************S01117
     C***********          MOVEL'CLINT'   @DBFIL           * DB ERROR 06 *S01117
     C***********          MOVELTCNR      @DBKEY           ***************S01117
     C***********          EXSR SUB999                                    S01117
     C***********          END                             E003           S01117
      *
     C***********          MOVELCSNM      @CLI                            S01117
     C                     MOVE *BLANKS   @CSNM                           067627
     C                     MOVELTCNR      @CSNM                           S01117
     C                     CALL 'AOCUSTR0'                                S01117
     C                     PARM '*DBERR ' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM           @CSNM  10                       S01117
     C                     PARM           @KYST   7                       S01117
     C           SDCUST    PARM SDCUST    DSSDY                           S01117
     C                     MOVELBBCSSN    @CLI                            S01117
     C           @CLI      IFEQ *BLANKS                    B003
     C***********          MOVELCNUM      @CLI                            S01117
     C                     MOVELBBCUST    @CLI                            S01117
     C                     END                             E003
      *
      * Edit nominal for output
      *
     C                     MOVEL*BLANKS   ZFIELD
     C                     MOVE NOML      ZFIELD
     C                     Z-ADDTNMD      ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    @NOM
      *
      * Edit price/yield/discount for output
      *
     C                     MOVEL*BLANKS   ZFLD15
     C                     MOVE TPDY      ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @PYDS
      *
      * Trade type and review trade flag
      *
     C                     MOVELTDTP      @TT
     C                     MOVEL*BLANKS   @RVT
      *****************************************************************                234552 234691
      **TEMPORARY*CHANGE*TO*FORCE*REVIEW*******************************                234552 234691
     C********** @ACTC     IFNE 'D'                                                    234552 234691
     C********** @ACTC     ANDNE'E'                                                    234552 234691
     C**********           MOVE 'Y'       @RVT                                         234552 234691
     C**********           SETON                     2875                              234552 234691
     C**********           ENDIF                                                       234552 234691
      *
      * Write a new subfile record
      *
     C                     WRITESE3000F0
      *
     C                     END                             E002
     C                     END                             E001
      *
      * Subfile now full
      *
     C                     SETOF                     23
     C                     SETON                     30
      *
      * If at least 1 s/file record written enable SFLDSP
      * Display appropriate message
      *
     C           @SFK      IFGT 0                          B001
     C                     SETON                     24
     C           @ACTC     IFEQ 'D'                        B002
     C                     SETON                         50
     C                     MOVEL@TX,4     @ERR
     C                     END                             E002
     C                     ELSE                            X001
     C                     SETON                     28  50
     C                     MOVEL@TX,1     @ERR
     C                     END                             E001
      *
     C                     ENDSR                           SUB103 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB104 - Control display/validation of s/file 1              *
      *                                                               *
      *****************************************************************
      *
     C           SUB104    BEGSR
      *
     C                     SETOF                     07
      *
      * Loop until valid
      *
     C           *IN50     DOUEQ'0'                        B001
     C           *IN45     ANDEQ'0'                        B001           S01117
      *
      * Display s/file 1
      *
     C                     EXSR SUB200
      *
      * Validate if F12 not pressed and s/file displayed
      *
     C           *INKL     IFEQ '0'                        B002
     C           *IN24     ANDEQ'1'
      *
      * Validation for action code I or E
      *
     C           @ACTC     IFNE 'D'                        B003
     C                     MOVEA*BLANKS   @EA,1
     C                     EXSR SUB202
     C                     MOVEA@EA,1     @ERR
      *
      * If '?' not selected do the following                              S01117
     C           *IN45     IFEQ '0'                                       S01117
      *                                                                   S01117
      * If no errors and review outstanding, display message
      *
     C           *IN50     IFEQ '0'                        B004
     C           *IN08     ANDEQ'1'
     C                     SETON                         50
     C                     MOVEL@TX,6     @ERR
     C                     END                             E004
      *
     C   06                SETOF                     07
      *
      * If no errors, then display confirmation message
      *
     C           *IN50     IFEQ '0'                        B004
     C           @AGTR     ANDNE'Y'
     C           @ACTC     ANDEQ'I'
     C           *IN07     ANDEQ'0'
     C                     SETON                     07  50
     C                     MOVEL@TX,5     @ERR
     C                     END                             E004
     C                     END                                            063535
      *
     C                     ELSE                            X003
      *
      * Delete records if action D and F10
      *
     C           *INKJ     IFEQ '1'                        B004
     C                     EXSR SUB303
     C                     END                             E004
     C                     END                             E003
     C***********          END                                      S01117063535
     C                     END                             E002
      *
     C                     END                             E001
      *
     C                     ENDSR                           SUB104 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB105 - Calculate average price for s/file 1                *
      *                                                               *
      *****************************************************************
      *
     C           SUB105    BEGSR
      *
      * Total nominals into @WK15
      *
     C                     Z-ADD@NTOT1    @WK15
      *
      * Allow for divide by zero
      *
     C           @WK15     IFEQ 0                          B001
     C                     Z-ADD1         @WK15
     C                     END                             E001
      *
      * Divide total cost by total nominals to get av. price
      *
     C           @TCOST    DIV  @WK15     @AVPR  158
      *
      * Set up screen field
      *
     C                     MOVEL@AVPR     ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @PYD2
      *                                                                   077620
     C                     MOVEL@NTOT1    ZFLD15                          077620
     C                     Z-ADD0         ZDECS                           077620
     C           PROT      IFEQ '7'                                       077620
     C                     Z-ADD4         ZDECS                           077620
     C                     END                                            077620
     C                     EXSR ZSEDIT                                    077620
     C                     MOVE ZOUT20    @NOM2                           077620
      *
     C                     ENDSR                           SUB105 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB106 - Initialize s/file 2                                 *
      *                                                               *
      *****************************************************************
      *
     C           SUB106    BEGSR
      *
      * Trade type is reverse of that on screen 1
      *
     C           @TDTY     IFEQ 'TP'                       B001
     C                     MOVEL'TS'      @TDTY2
     C                     ELSE                            X001
     C                     MOVEL'TP'      @TDTY2
     C                     END                             E001
      *
      * Initialize s/file 2
      *
     C                     SETOF                     24
     C                     WRITESE3000F4
     C                     SETON                     24
      *
      * Reset s/file 2 record count and nominal total
      *
     C                     Z-ADD0         @SF2R   50
     C***********          Z-ADD0         @NTOT2 150                      085334
      *
      * Write a page of s/file 2 records
      *
     C                     EXSR SUB204
      *
     C                     ENDSR                           SUB106 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB107 - Display/validate s/file 2                           *
      *                                                               *
      *****************************************************************
      *
     C           SUB107    BEGSR
      *
     C                     SETOF                         07
      *
     C* INITIALIZE VARIABLE HOLDING F9 VALUE
      *
     C                     MOVE *BLANKS   @INKI
      *
      * Repeat until no validation errors
      *
     C           *IN50     DOUEQ'0'                        B001
      *
     C                     SETON                         21
      *
      * Display screen (if ROLLUP then add a new page and repeat)
      *
     C           *IN29     DOUEQ'0'                        B002
     C**********           WRITESE3000F4                                                     CAAA02
     C                     WRITESE3000F2
     C                     WRITESE3000F4                                                     CAAA02
     C/COPY WNCPYSRC,SE3000C014
     C********** *IN22     DOUEQ'0'                        B003           S01199
     C                     READ SE3000F4                 01
     C**********                                                          S01199
     C********** *IN22     IFEQ '1'                        B004           S01199
     C**********           CALL 'MHELP'                01                 S01199
     C**********           PARM 'SE3000  '@ERPGM                          S01199
     C**********           PARM           @EA                             S01199
     C**********                                                          S01199
     C********** *IN01     IFEQ '1'                        B005           S01199
     C**********           Z-ADD7         @DBASE           ***************S01199
     C**********           MOVEL*BLANKS   @DBFIL           * DB ERROR 07 *S01199
     C**********           MOVEL'MHELP'   @DBKEY           ***************S01199
     C**********           EXSR SUB999                                    S01199
     C**********           END                             E005           S01199
     C**********                                                          S01199
     C**********           END                             E004           S01199
     C**********           END                             E003           S01199
     C   29                EXSR SUB204
     C                     END                             E002
      *
      * Delete all inserted trades if F3 OR F12
      *
     C           *INKC     IFEQ '1'                        B002
     C           *INKL     OREQ '1'
     C                     EXSR SUB304
     C                     END                             E002
      *
      * Exit if F3 pressed
      *
     C           *INKC     IFEQ '1'                        B002
     C                     SETON                     LR
     C                     RETRN
     C                     END                             E002
      *
     C                     SETOF                     50
      *
      * Validate if not F12 or F9
      *
     C           *INKL     IFEQ '0'                        B002
     C           *INKI     ANDEQ'0'
     C                     SETON                     70
     C                     MOVEA*BLANKS   @EA,1
     C                     SETOF                     02                   077621
     C                     EXSR SUB202
     C*                                                                   085334
     C** Determine if total TP = total TS                                 085334
     C*                                                                   085334
     C           *IN07     IFEQ '0'                                       085334
     C           *IN06     OREQ '1'                                       085334
     C           @NTOT1    IFNE @NTOT2                                    085334
     C                     SETON                     50                   085334
     C           ' 200'    LOKUP@EA                      03               085334
     C           *IN03     IFEQ '0'                                       085334
     C                     MOVEL' 200'    @EA,I                           085334
     C                     ADD  1         I                               085334
     C                     END                                            085334
     C                     Z-ADD1         @SFK                            085334
     C                     READCSE3000F3                 02               085334
     C           *IN02     DOWEQ'0'                                       085334
     C                     SETON                     2642                 085334
     C                     UPDATSE3000F3                                  085334
     C                     READCSE3000F3                 02               085334
     C                     ENDDO                                          085334
     C                     END                                            085334
     C*                                                                   085334
     C** Display total TS nominal                                         085334
     C*                                                                   085334
     C                     MOVEL@NTOT2    ZFLD15                          085334
     C                     Z-ADD0         ZDECS                           085334
     C           PROT      IFEQ '7'                                       085334
     C                     Z-ADD4         ZDECS                           085334
     C                     END                                            085334
     C                     EXSR ZSEDIT                                    085334
     C                     MOVE ZOUT20    @NOM5                           085334
     C                     END                                            085334
     C*                                                                   085334
     C                     MOVEA@EA,1     @ERR
     C*                                                                   085334
     C** If there are no errors (specifically no difference in total TP & 085334
     C** TS), execute SUB202 again, to process the valid subfile records  085334
     C*                                                                   085334
     C           *IN07     IFEQ '0'                                       085334
     C           *IN50     ANDEQ'0'                                       085334
     C           *IN06     OREQ '1'                                       085334
     C           *IN50     ANDEQ'0'                                       085334
     C           @NTOT1    IFEQ @NTOT2                                    085334
     C                     Z-ADD1         @SFK                            085334
     C                     MOVE 'Y'       WVREC   1                       085334
     C                     EXSR SUB202                                    085334
     C                     MOVE *BLANK    WVREC                           085334
     C                     ENDIF                                          085334
     C                     MOVEA@EA,1     @ERR                            085334
     C                     ENDIF                                          085334
      *
      * If no errors and review outstanding, display message
      *
     C           *IN50     IFEQ '0'                        B003
     C           *IN08     ANDEQ'1'
     C                     SETON                         50
     C                     MOVEL@TX,6     @ERR
     C                     END                             E003
      *
     C   06                SETOF                     07
      *
      * If no errors, then display confirmation message
      *
     C           *IN50     IFEQ '0'                        B003
     C           *IN07     ANDEQ'0'
     C                     SETON                     07  50
     C                     MOVEL@TX,5     @ERR
     C                     END                             E003
     C                     END                             E002
      *
      * Store F9 value
      *
     C                     MOVEL*INKI     @INKI
      *
     C                     END                             E001
      *
     C                     ENDSR                           SUB107 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB108 - Submit defaults update                              *
      *                                                               *
      *****************************************************************
      *
     C           SUB108    BEGSR
      *
      * Send MIDAS message to MSTATUS
      *
     C                     MOVEL*BLANKS   @CMD
     C                     MOVEL@TX,8     @CMD
     C******************** CALL 'QCAEXEC'              01                 E21146
     C                     CALL 'QCMDEXC'              01                 E21146
     C                     PARM           @CMD
     C***********          PARM 160       @CMLEN 155                      065394
     C                     PARM 240       @CMLEN 155                      065394
      *
     C           *IN01     IFEQ '1'                        B001
     C                     Z-ADD8         @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 08 *
     C*********************MOVEL'QCAEXEC' @DBKEY           ***************E21146
     C                     MOVEL'QCMDEXC' @DBKEY           ***************E21146
     C***********          EXSR SUB999                                    S01117
     C                     EXSR *PSSR                                     S01117
     C                     END                             E001
      *
      * Set up command string to submit batch update
      *
     C***********          MOVEL@TX,2     @CMD                            S01401
     C***********          MOVE @TX,3     @CMD                            S01401
     C*
     C           S01511    IFEQ 'Y'                                       S01511
     C           @SEC      CHAINSECTY                01                   S01511
     C           *IN01     IFEQ '0'                                       S01511
     C           SMAI      IFEQ 'Y'                                       S01511
     C           SMKTI     ORNE MKTI                                      S01511
     C           @ACTC     IFEQ 'I'                                       S01511
     C                     EXSR SUB304                                    S01511
     C                     ELSE                                           S01511
      **  If deletion, just update deletion records created in            S01511
      **  BULKTD (RECI=D) to have its RECI = '*' in order to              S01511
      **  prevent delete.                                                 S01511
      *                                                                   S01511
     C           @BLKR     SETLLBULKPF                                    S01511
     C           *IN01     DOUEQ'1'                                       S01511
     C           @BLKR     READEBULKPF                   01               S01511
     C           *IN01     IFEQ '0'                                       S01511
     C           RECI      ANDEQ'D'                                       S01511
     C                     MOVEL'*'       RECI                            S01511
     C                     UPDATBULKPF                                    S01511
     C                     SETON                     05                   S01511
     C/COPY WNCPYSRC,SE3000C023
     C                     END                                            S01511
     C                     END                                            S01511
     C*                                                                   S01511
     C                     END                                            S01511
     C                     MOVEL@TX,12    @ERR                            S01511
     C                     GOTO END108                                    S01511
     C                     END                                            S01511
     C                     END                                            S01511
     C                     END                                            S01511
     C*
     C                     MOVEL@TX,2     CCMD1                           S01401
     C                     MOVEL@TX,3     CCMD2                           S01401
     C                     MOVEL@TX,11    CCMD3                           S01401
     C                     MOVEL@BLKR     @CBREF
     C                     MOVEL@ACTC     @CACTN
     C                     MOVEL@JOB      @CMWI
     C                     MOVEL@BLKR     @CMBR
     C                     MOVEL@CAGT     @CCAGT                          S01448
      *                                                                   S01401
     C           S01401    IFEQ 'Y'                                       S01401
     C           @TDRF     ANDNE*BLANKS                                   S01401
     C                     MOVEL@TDRF     CCTRDF                          S01401
     C                     ENDIF                                          S01401
      *
      **Use*QCAEXEC*to*submit*job                                         E21146
      * Use QCMDEXC to submit job                                         E21146
      *
     C******************** CALL 'QCAEXEC'              01                 E21146
     C                     CALL 'QCMDEXC'              01                 E21146
     C                     PARM           @CMD
     C***********          PARM 160       @CMLEN 155                      065394
     C                     PARM 240       @CMLEN 155                      065394
      *
     C           *IN01     IFEQ '1'                        B001
     C                     Z-ADD9         @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 09 *
     C******************** MOVEL'QCAEXEC' @DBKEY           ***************E21146
     C                     MOVEL'QCMDEXC' @DBKEY           ***************E21146
     C***********          EXSR SUB999                                    S01117
     C                     EXSR *PSSR                                     S01117
     C                     END                             E001
      *
     C                     SETON                       09
      *
     C           END108    TAG                                            S01511
     C                     ENDSR                           SUB108 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB200 - Display initial screen and s/file 1                 *
      *                                                               *
      *****************************************************************
      *
     C           SUB200    BEGSR
      *
     C                     SETOF                     202170
     C                     Z-ADD0         WWCHRG 150                      S01486
     C           @ACTC     COMP 'D'                      20
      *
      *  IF F9 ON INSERTION OF AGENCY TRADE THEN DISPLAY 1ST
      ***SUBFILE*AS*PROTECTED                                             S01448
      *  SUBFILE AND PERMIT AMENDMENT                                     S01448
      *
     C           @INKI     IFEQ '1'                        B001
     C                     Z-ADD0         @SFK
      *                                                                   S01448
      * Ensure the subfile record number is reset to 1 to cater for       S01448
      * F9 taken from the second subfile after rollup has been used.      S01448
      *                                                                   S01448
     C                     Z-ADD1         @SFREC                          S01448
      *                                                                   S01448
      * Clear agency trade value date so program will reset common        S01448
      * values after review of first trade.                               S01448
      * Conditioned on switchable feature S01448                          S01448
      *                                                                   S01448
     C           S01448    IFEQ 'Y'                                       S01448
     C                     Z-ADD0         ATDVD                           S01448
     C                     END                                            S01448
      *
     C                     SETOF                     02                   077621
     C           *IN02     DOUEQ'1'                        B002
     C                     ADD  1         @SFK
     C           @SFK      CHAINSE3000F0             02
      *
     C           *IN02     IFEQ '0'                        B003
      *
     C* Amendment of Subfile 1 should be possible via F9.                 S01448
     C*******              SETON                     27                   S01448
      *
      *  PROTECT REVIEW TRADE AS WELL IF RECORD IS BLANK
      *
     C*******    @REF      IFEQ *BLANKS                    B004           S01448
     C*******              SETON                     2875                 S01448
     C*******              ELSE                                           S01448
     C                     SETOF                     2875
     C*******              END                             E004           S01448
     C*                                                                   S01448
     C* Set on SFLNXTCHG for all non-blank subfile records so that        S01448
     C* cross validation of customer classification will be done.         S01448
     C*                                                                   S01448
     C           @REF      IFNE *BLANKS                    B004           S01448
     C           @CLI      ORNE *BLANKS                                   S01448
     C           @NOM      ORNE *BLANKS                                   S01448
     C           @PYDS     ORNE *BLANKS                                   S01448
     C           @RVT      ORNE *BLANKS                                   S01448
     C                     MOVE '1'       *IN26                           S01448
     C*                                                                   S01448
     C*  Reset indicators when updating record for validation error       S01448
     C*  highlighting                                                     S01448
     C*                                                                   S01448
     C                     MOVE @INDS     @IND                            S01448
     C                     MOVE @IN40     *IN40                           S01448
     C                     MOVE @IN41     *IN41                           S01448
     C                     MOVE @IN42     *IN42                           S01448
     C                     MOVE @IN43     *IN43                           S01448
     C                     MOVE @IN44     *IN44                           S01448
     C*                                                                   S01448
     C                     UPDATSE3000F0
     C                     MOVEA'00000'   *IN,40                          S01448
     C                     END                             E004           S01448
      *
     C                     END                             E003
     C                     END                             E002
     C******               SETON                     25                   S01448
     C                     END                             E001
      *
      * Set up screen header literal
      * If Agency Trades can have Portfolio clients on first side then    S01448
      * output the Broker/Client heading on the first side.               S01448
      *
     C           @ACTC     IFEQ 'E'                        B001
     C           @ACTC     OREQ 'D'
     C           @AGTR     OREQ 'N'
     C           @AGTR     OREQ 'Y'                                       S01448
     C           BVATPC    ANDEQ'Y'                                       S01448
     C                     MOVEL@TX,10    @HDR
     C                     ELSE                            X001
     C                     MOVEL@TX,9     @HDR
     C                     END                             E001
      *
      * Display screen (if ROLLUP then add a page and repeat)
      *
     C           *IN29     DOUEQ'0'                        B001
      *                                                                   S01117
      * If '?' in Book field call access object and redisplay screen      S01117
      *                                                                   S01117
     C           RDSPLY    DOUEQ'N'                                       S01117
     C                     MOVE 'N'       RDSPLY  1                       S01117
     C**********           WRITESE3000F1                                                      CAAA02
     C                     WRITESE3000F2
     C                     WRITESE3000F1                                                      CAAA02
     C/COPY WNCPYSRC,SE3000C015
     C********** *IN22     DOUEQ'0'                        B002           S01199
     C                     READ SE3000F1                 01
     C/COPY WNCPYSRC,SE3000C009
      *                                                                   CSE010
      ** Check Security Shortname and call Securities Selection           CSE010
      *                                                                   CSE010
     C           CSE010    IFEQ 'Y'                                       CSE010
     C                     MOVEL@SEC      @QMK    1                       CSE010
     C           @QMK      IFEQ '?'                                       CSE010
     C                     MOVE 'Y'       RDSPLY                          CSE010
     C                     MOVEL@SEC      @SESN                           CSE010
     C                     CALL 'SE0043'                                  CSE010
     C                     PARM           @ACDE   1                       CSE010
     C                     PARM           @SESN  10                       CSE010
     C           @SESN     IFNE *BLANKS                                   CSE010
     C                     MOVE @SESN     @SEC                            CSE010
     C                     ELSE                                           CSE010
     C                     MOVE *BLANKS   @SEC                            CSE010
     C                     ENDIF                                          CSE010
     C                     ENDIF                                          CSE010
     C                     ENDIF                                          CSE010
      *                                                                   CSE010
     C                     MOVEL@BOOK     @QRY    1                       S01117
     C           @QRY      IFEQ '?'                                       S01117
     C                     MOVE 'Y'       RDSPLY                          S01117
     C                     CALL 'AOBOOKR0'                                S01117
     C                     PARM           @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM           @BOOK                           S01117
     C           SDBOOK    PARM SDBOOK    DSFDY                           S01117
     C           @RTCD     IFEQ '*NOSEL '                                 S01117
     C                     MOVE *BLANKS   @BOOK                           S01117
     C                     ELSE                                           S01117
     C                     MOVE BDBKCD    @BOOK                           S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *                                                                   CAC005
      ** Process '?' for book-profit centre if CAC005 is installed.       CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     MOVEL@PRFC     @QRY                            CAC005
      *                                                                   CAC005
     C           @QRY      IFEQ '?'                                       CAC005
     C                     MOVE 'Y'       RDSPLY                          CAC005
     C                     CALL 'AOPRFCR0'                                CAC005
     C                     PARM           @RTCD                           CAC005
     C                     PARM '*KEY   ' @OPTN                           CAC005
     C           @PCCD     PARM @PRFC     @PCCD   4                       CAC005
     C           SDPRFC    PARM SDPRFC    DSFDY                           CAC005
      *                                                                   CAC005
     C           @RTCD     IFEQ '*NOSEL '                                 CAC005
     C                     MOVE *BLANKS   @PRFC                           CAC005
     C                     ELSE                                           CAC005
     C                     MOVE DSPCCD    @PRFC                           CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C                     ENDIF                                          CAC005
      *                                                                   S01117
      * If '?' in Booking Branch call access obj &  redisplay screen      S01117
      *                                                                   S01117
     C                     MOVEL@BRCA     @QRY                            S01117
     C           @QRY      IFEQ '?'                                       S01117
     C                     MOVE 'Y'       RDSPLY                          S01117
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM           @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM           @BRCA                           S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C           @RTCD     IFEQ '*NOSEL '                                 S01117
     C                     MOVE *BLANKS   @BRCA                           S01117
     C                     ELSE                                           S01117
     C                     MOVE A8BRCD    @BRCA                           S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C**********                                                          S01199
     C********** *IN22     IFEQ '1'                        B003           S01199
     C**********           CALL 'MHELP'                01                 S01199
     C**********           PARM 'SE3000  '@ERPGM  8                       S01199
     C**********           PARM           @EA                             S01199
     C**********                                                          S01199
     C********** *IN01     IFEQ '1'                        B004           S01199
     C**********           Z-ADD11        @DBASE           ***************S01199
     C**********           MOVEL*BLANKS   @DBFIL           * DB ERROR 11 *S01199
     C**********           MOVEL'MHELP'   @DBKEY           ***************S01199
     C**********           EXSR SUB999                                    S01199
     C**********           END                             E004           S01199
     C**********                                                          S01199
     C**********           END                             E003           S01199
     C**********           END                             E002           S01199
     C   29                EXSR SUB203
     C                     END                             E001
      *
      * Delete all inserted trades if F3 or F12
      *
     C           *INKC     IFEQ '1'                        B001
     C           *INKL     OREQ '1'
     C                     EXSR SUB304
     C                     END                             E001
      *
      * Exit if F3 pressed
      *
     C           *INKC     IFEQ '1'                        B001
     C                     SETON                     LR
     C                     RETRN
     C                     END                             E001
      *
     C                     SETOF                     50
      *
      ***IF*F9*ON*INSERTION*OF*AGENCY*TRADE*THEN*SETOF*PROTECT            S01448
      ***INDICATOR*AND*CHANGE*ACTION*BACK*TO*'I'                          S01448
      *
     C*******    @INKI     IFEQ '1'                        B001           S01448
     C*******              SETOF                     27                   S01448
     C*******              END                             E001           S01448
      *
     C                     ENDSR                           SUB200 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB201 - Validate initial screen                             *
      *                                                               *
      *****************************************************************
      *
     C           SUB201    BEGSR
      *
      * Reset indicators and fields
      *
     C                     SETOF                     525456
     C                     SETOF                     586062
     C                     SETOF                     64  50
     C                     SETOF                     61                   S01117
     C                     SETOF                     676869               S01486
     C                     MOVE *OFF      *IN55                           CAC005
     C*                                                                   S01486
     C** If only warning error output last time routine performed         S01486
     C** Set on indicator stating warning message already output          S01486
     C*                                                                   S01486
     C           @EA,1     IFEQ ' W02'                                    S01486
     C           @EA,2     ANDEQ*BLANKS                                   S01486
     C                     MOVE 'Y'       WWOUTP  1                       S01486
     C                     ELSE                                           S01486
     C                     MOVE 'N'       WWOUTP                          S01486
     C                     END                                            S01486
      *                                                                   S01486
     C                     Z-ADD1         I       30
     C                     MOVEA*BLANKS   @EA
      *
      * Action code must be I,E or D
      * or A when Portfolio Management and Pool Portfolios are on         092518
      *
     C           @ACTC     IFNE 'I'                        B001
     C           @ACTC     ANDNE'E'
     C********** @ACTC     ANDNE'D'                                                           234552
     C           @ACTC     ANDNE'D'                                                           234691
     C           @ACTC     IFNE 'A'                                       092518
     C           FCPPPR    ORNE 'Y'                                       092518
     C                     SETON                     50  52
     C                     MOVEL' 001'    @EA,I
     C                     ADD  1         I
     C                     END                                            092518
     C                     END                             E001
     C********** @ACTC     IFEQ 'D'                                                    234691 235546
     C********** CGL031    ANDEQ'Y'                                                    234691 235546
     C**********           SETON                     50  52                            234691 235546
     C**********           MOVEL' 001'    @EA,I                                        234691 235546
     C**********           ADD  1         I                                            234691 235546
     C**********           END                                                         234691 235546
      *
      * Bulk ref. must be blank if action is insert
      *
     C           @BLKR     IFNE *BLANKS                    B001
     C           @ACTC     ANDEQ'I'
     C                     SETON                     50  64
     C                     MOVEL' 002'    @EA,I
     C                     ADD  1         I
     C                     END                             E001
      *
      * Bulk ref. must be entered for enquire or delete
      *
     C           @BLKR     IFEQ *BLANKS                    B001
     C           @ACTC     IFEQ 'E'                        B002
     C           @ACTC     OREQ 'D'
     C           @ACTC     OREQ 'A'                                       092518
     C                     SETON                     50  64
     C                     MOVEL' 003'    @EA,I
     C                     ADD  1         I
     C                     END                             E002
     C                     END                             E001
      *
      * Most of validation is for action = insert
      *
     C           @ACTC     IFEQ 'I'                        B001
      *
      * Trade ref. cannot be entered if this is an agency trade.
      * If trade ref. entered it must exist on the trades file with a
      **record*ID*of*D,A,*or*S********************************************S01269
      * record ID of D,A,S,L or P.                                        S01269
      *
     C           @TDRF     IFNE *BLANKS                    B002
      *
     C           @AGTR     IFEQ 'Y'                        B003
     C                     SETON                     50  54
     C                     MOVEL' 005'    @EA,I
     C                     ADD  1         I
     C                     ELSE                            X003
      *
     C           @TDRF     CHAINTRADS                01
     C           *IN01     IFEQ '1'                        B004
     C           RECI      ORNE 'D'
     C           RECI      ANDNE'A'
     C           RECI      ANDNE'S'
     C           RECI      ANDNE'L'                                       S01269
     C           RECI      ANDNE'P'                                       S01269
     C                     SETON                     50  54
     C                     MOVEL' 005'    @EA,I
     C                     ADD  1         I
     C                     ELSE                            X004
      *
      * If shortname is blank use name from trade
      *
     C           @SEC      IFEQ *BLANKS                    B005
     C                     MOVELTDSS      @SEC
     C                     END                             E005
      *
      * If trade type is blank use type from trade
      *
     C           @TDTY     IFEQ *BLANKS                    B005
     C                     MOVELTDTP      @TDTY
     C                     END                             E005
      *
      * If book is blank use book from trade                              E21045
      *
     C           @BOOK     IFEQ *BLANKS                    B005           E21045
     C                     MOVELTDBK      @BOOK                           E21045
      *                                                                   CAC005
      ** If CAC005 is on, retrieve user book from AOBKPCR0.               CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C           PMBKCD    PARM *BLANKS   PMBKCD  2                       CAC005
     C           PMPRFC    PARM *BLANKS   PMPRFC  4                       CAC005
     C                     PARM TDBK      PMPSBK  2                       CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMBKCD    @BOOK                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
     C                     END                             E005           E21045
      *                                                                   CAC005
      ** If CAC005 is on and screen field book-profit centre is blank,    CAC005
      ** use book-profit centre from trades file.                         CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C           @PRFC     ANDEQ*BLANK                                    CAC005
     C                     MOVELBPRC      @PRFC                           CAC005
     C                     ENDIF                                          CAC005
      *                                                                   S01117
      * If Booking Branch is blanks use B. Branch from trade              S01117
      *                                                                   S01117
     C           @BRCA     IFEQ *BLANKS                                   S01117
     C                     MOVELTDBA      @BRCA                           S01117
     C                     END                                            S01117
      *
     C                     END                             E004
     C                     END                             E003
     C                     END                             E002
      *
      * If trade type entered it must be TP or TS
      *
     C           @TDTY     IFNE *BLANKS                    B002
     C           @TDTY     ANDNE'TP'
     C           @TDTY     ANDNE'TS'
     C                     SETON                     50  60
     C                     MOVEL' 004'    @EA,I
     C                     ADD  1         I
     C                     END                             E002
      *
      **If*agency*trade*field*not*entered,*default*to*N*******            S01448
      * *********                                                         S01448
     C***********@AGTR     IFEQ *BLANKS                    B002           S01448
     C***********          MOVEL'N'       @AGTR                           S01448
     C***********          END                             E002           S01448
      *
      * Agency trade must be either Y or N
      *
     C           @AGTR     IFNE 'Y'                        B002
     C           @AGTR     ANDNE'N'
     C                     SETON                     50  56
     C                     MOVEL' 006'    @EA,I
     C                     ADD  1         I
     C                     END                             E002
      *
      * Either a trade ref. or a security shortname must be entered
      *
     C           @TDRF     IFEQ *BLANKS                    B002
     C           @SEC      ANDEQ*BLANKS
     C                     SETON                     50  58
     C                     MOVEL' 007'    @EA,I
     C                     ADD  1         I
     C                     END                             E002
      *
     C           *IN58     IFEQ '0'                        B002
      *
      * If a security shortname, must exist on the
      * securities file with a record ID of D
      *
      *                                                                   CSE010
      ** Process only if CSE010 is OFF                                    CSE010
      * If ? processing available and ? entered                           CSE003
      *                                                                   CSE010
     C           CSE010    IFEQ 'N'                                       CSE010
     C           CSE003    IFEQ 'Y'                                       CSE003
     C           @SEC      ANDEQ'?'                                       CSE003
     C           *LOCK     IN   SESDS                                     CSE003
     C                     MOVE '6'       RTNC                            CSE003
     C                     MOVE *BLANKS   RQSESN                          CSE003
     C                     OUT  SESDS                                     CSE003
     C                     CALL 'SE0240'                                  CSE003
     C                     IN   SESDS                                     CSE003
     C           RTNC      IFNE '0'                                       CSE003
     C           RTNC      ANDNE'1'                                       CSE003
     C                     MOVE RQSESN    @SEC                            CSE003
     C                     ENDIF                                          CSE003
     C                     ENDIF                                          CSE003
     C                     ENDIF                                          CSE010
      *                                                                   CSE003
     C           @SEC      CHAINSECTY                01
     C           *IN01     IFEQ '1'                        B003
     C           RECI      ORNE 'D'
     C                     SETON                     50  58
     C                     MOVEL' 007'    @EA,I
     C                     ADD  1         I
     C                     ELSE                            X003
     C***********          MOVE NMCYA     KCCY1                    S01486 CPM005
      *
      * Reset stored value if security found
      *
     C                     MOVELSITP      @SITP   3
     C*
     C           S01511    IFEQ 'Y'                                       S01511
     C           SMAI      IFEQ 'Y'                                       S01511
     C                     SETON                     50  58               S01511
     C                     MOVEL' 016'    @EA,I                           S01511
     C                     ADD  1         I                               S01511
     C                     ELSE                                           S01511
     C                     MOVE MKTI      SMKTI   1                       S01511
     C                     END                                            S01511
     C                     END                                            S01511
      *
      * If a related trade has been entered, shortname must match
      * that on the trade
      *
     C           @TDRF     IFNE *BLANKS                    B004
     C           @SEC      ANDNETDSS
     C                     SETON                     50  58
     C                     MOVEL' 007'    @EA,I
     C                     ADD  1         I
     C                     END                             E004
      *
      * The investment type of the security must exist on LF/INVTP
      *
     C           @KEY1     CHAININVTP                01
     C           *IN01     IFEQ '1'                        B004
     C           RECI      ORNE 'D'
     C                     SETON                     50  58
     C                     MOVEL' 008'    @EA,I
     C                     ADD  1         I
     C                     END                             E004
     C                     END                             E003
     C                     END                             E002
      *
      **If*book*entered*it*must*exist*on*LF/BOOKD*with*a*record*ID*of*****S01117
      **D*or*A************************************************************S01117
      * If book entered it must exist on SDBOOKPD                         S01117
     C*  & can't trade on amortising book if day basis '4' on SECTY       E20517
     C*  For agency trades book must be agency book from ICD.             E21046
      *
     C           @BOOK     IFNE *BLANKS                    B002
     C***********@BOOK     CHAINBOOKD                01                   S01117
     C************IN01     IFEQ '1'                        B003           S01117
     C***********RECI      ORNE 'D'                                       S01117
     C***********RECI      ANDNE'A'                                       S01117
     C                     CALL 'AOBOOKR0'                                S01117
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM           @BOOK   2                       S01117
     C           SDBOOK    PARM SDBOOK    DSFDY                           S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     SETON                     50  62
     C                     MOVEL' 009'    @EA,I
     C                     ADD  1         I
     C                     ELSE                            X003           E20517
     C*                                                                   S01448
     C*  The Buy-Sell Book indicator must not be 'Y'                      CSE006
     C           BDBYSL    IFEQ 'Y'                                       CSE006
     C                     MOVE *ON       *IN62                           CSE006
     C                     MOVE *ON       *IN50                           CSE006
     C                     MOVEL' 619'    @EA,I                           CSE006
     C                     ADD  1         I                               CSE006
     C                     ENDIF                                          CSE006
     C*                                                                   CSE006
     C*  Accept agency trades in non-agency books if the Bulk             S01448
     C*  Input enhancements feature is on                                 S01448
     C*                                                                   S01448
     C           @AGTR     IFEQ 'Y'                        B005           E21046
     C***********@BOOK     ANDNEATBK                               E21046 S01117
     C           @BOOK     ANDNEBVATBK                                    S01117
     C           S01448    ANDNE'Y'                                       S01448
     C                     MOVE ' 013'    @EA,I                           E21046
     C                     ADD  1         I                               E21046
     C                     SETON                     50  62               E21046
     C                     END                             E005           E21046
     C***********STAD      IFEQ 'Y'                        B004    E20517 S01117
     C           BDSTAM    IFEQ 'Y'                        B004           S01117
     C           DYBS      ANDEQ'4'                                       E20517
     C                     MOVE ' 012'    @EA,I                           E20517
     C                     ADD  1         I                               E20517
     C                     SETON                     50  62               E20517
     C                     END                             E004           E20517
     C                     END                             E003
     C                     ELSE                                           E21046
     C           @AGTR     IFEQ 'Y'                                       E21046
     C***********          MOVELATBK      @BOOK                    E21046 S01117
     C                     MOVELBVATBK    @BOOK                           S01117
     C                     END                                            E21046
     C                     END                             E002
      *                                                                   CAC005
      ** If CAC005 is on, validate screen fields book and profit centre.  CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
      *                                                                   CAC005
     C           @BOOK     IFEQ *BLANKS                                   CAC005
     C           @PRFC     ANDNE*BLANKS                                   CAC005
     C                     MOVE *ON       *IN50                           CAC005
     C                     MOVE *ON       *IN55                           CAC005
     C                     MOVEL' 614'    @EA,I                           CAC005
     C                     ADD  1         I                               CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C           @BOOK     IFNE *BLANKS                                   CAC005
     C           @PRFC     ANDEQ*BLANKS                                   CAC005
     C                     MOVE *ON       *IN50                           CAC005
     C                     MOVE *ON       *IN55                           CAC005
     C                     MOVEL' 615'    @EA,I                           CAC005
     C                     ADD  1         I                               CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C           @PRFC     IFNE *BLANKS                                   CAC005
     C           *IN55     ANDEQ*OFF                                      CAC005
     C                     CALL 'AOPRFCR0'                                CAC005
     C                     PARM           @RTCD                           CAC005
     C                     PARM '*KEY   ' @OPTN                           CAC005
     C                     PARM           @PRFC                           CAC005
     C           SDPRFC    PARM SDPRFC    DSFDY                           CAC005
      *                                                                   CAC005
     C           @RTCD     IFNE *BLANK                                    CAC005
     C                     MOVE *ON       *IN50                           CAC005
     C                     MOVE *ON       *IN55                           CAC005
     C                     MOVEL' 617'    @EA,I                           CAC005
     C                     ADD  1         I                               CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C           @BOOK     IFNE *BLANKS                                   CAC005
     C           @PRFC     ANDNE*BLANKS                                   CAC005
     C           *IN62     ANDEQ*OFF                                      CAC005
     C           *IN55     ANDEQ*OFF                                      CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD                           CAC005
     C                     PARM '*PSEUDO' POPTN                           CAC005
     C                     PARM @BOOK     PMBKCD                          CAC005
     C                     PARM @PRFC     PMPRFC                          CAC005
     C           PMPSBK    PARM *BLANKS   PMPSBK                          CAC005
     C           PRTCD     IFNE *BLANKS                                   CAC005
     C                     MOVE *ON       *IN50                           CAC005
     C                     MOVE *ON       *IN55                           CAC005
     C                     MOVEL' 616'    @EA,I                           CAC005
     C                     ADD  1         I                               CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C                     ENDIF                                          CAC005
      *
      * Either a trade ref. or a trade type must be entered
      *
     C           @TDRF     IFEQ *BLANKS                    B002
     C           @TDTY     ANDEQ*BLANKS
     C                     SETON                     505460
     C                     MOVEL' 010'    @EA,I
     C                     ADD  1         I
     C                     END                             E002
     C*                                                                   S01117
     C* If Booking Branch entered then it must exist on SDBRCHPD          S01117
     C*                                                                   S01117
     C           @BRCA     IFNE *BLANKS                                   S01117
     C**********           CALL 'AOBRCHR0'                                             S01117 CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM           @BRCA                           S01117
     C********** SDBRCH    PARM SDBRCH    DSFDY                                        S01117 CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     SETON                     50  61               S01117
     C                     MOVEL' 014'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     ELSE                                           S01117
     C*                                                                   S01117
     C* Set branch code to default for the user                           S01117
     C*                                                                   S01117
     C                     MOVE USRBCH    @BRCA                           S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C* If Multibranching environment                                     S01117
     C* User must be authorised to Action Code/Booking Branch             S01117
     C*                                                                   S01117
     C           MBIN      IFEQ 'Y'                                       S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM           @ACTC                           S01117
     C                     PARM           @BRCA                           S01117
     C                     PARM           @ER     10                      S01117
     C*                                                                   S01117
     C**   If action invalid for user                                     S01117
     C*                                                                   S01117
     C           @ER       IFEQ 1                                         S01117
     C                     SETON                     505261               S01117
     C                     MOVEL' 303'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     ELSE                                           S01117
     C           @ER       IFEQ 2                                         S01117
     C                     SETON                     505261               S01117
     C                     MOVEL' 304'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *
     C                     END                             E001
      *
      * If action is E or D, then only the bulk ref. should be entered
      *
     C           @ACTC     IFEQ 'E'                        B001
     C           @ACTC     OREQ 'D'
      *
     C*******    @AGTR     IFEQ *BLANKS                    B002           S01448
     C*******              MOVEL'N'       @AGTR                           S01448
     C*******              END                             E002           S01448
      *
     C***********@TDRF     IFNE *BLANKS                    B002           E21047
     C***********@AGTR     ORNE 'N'                                       E21047
     C***********@SEC      ORNE *BLANKS                                   E21047
     C***********@TDTY     ORNE *BLANKS                                   E21047
     C***********@BOOK     ORNE *BLANKS                                   E21047
     C*********************SETON                     505456               E21047
     C*********************SETON                     586062               E21047
     C           @TDRF     IFNE *BLANKS                    B002           E21047
     C                     SETON                     5054                 E21047
     C                     MOVEL' 011'    @EA,I
     C                     ADD  1         I
     C                     END                             E002
      *                                                                   S01448
      * Agency trade value now can be blank, 'Y' or 'N'                   S01448
      * It will default later on to the value on file                     S01448
      *                                                                   S01448
     C*******    @AGTR     IFNE 'N'                        B002     E21047S01448
     C           @AGTR     IFNE *BLANK                     B002           S01448
     C           @AGTR     ANDNE'Y'                                       S01448
     C           @AGTR     ANDNE'N'                                       S01448
     C                     SETON                     5056                 S01448
     C           ' 011'    LOKUP@EA                      03               S01448
     C           *IN03     IFEQ '0'                        B003           S01448
     C                     MOVEL' 011'    @EA,I                           S01448
     C                     ADD  1         I                               S01448
     C                     END                             E003           S01448
     C                     END                             E002           S01448
     C           @SEC      IFNE *BLANKS                    B002           E21047
     C                     SETON                     5058                 E21047
     C           ' 011'    LOKUP@EA                      03               E21047
     C           *IN03     IFEQ '0'                        B003           E21047
     C                     MOVEL' 011'    @EA,I                           E21047
     C                     ADD  1         I                               E21047
     C                     END                             E003           E21047
     C                     END                             E002           E21047
     C           @TDTY     IFNE *BLANKS                    B002           E21047
     C                     SETON                     5060                 E21047
     C           ' 011'    LOKUP@EA                      03               E21047
     C           *IN03     IFEQ '0'                        B003           E21047
     C                     MOVEL' 011'    @EA,I                           E21047
     C                     ADD  1         I                               E21047
     C                     END                             E003           E21047
     C                     END                             E002           E21047
     C           @BOOK     IFNE *BLANKS                    B002           E21047
     C                     SETON                     5062                 E21047
     C           ' 011'    LOKUP@EA                      03               E21047
     C           *IN03     IFEQ '0'                        B003           E21047
     C                     MOVEL' 011'    @EA,I                           E21047
     C                     ADD  1         I                               E21047
     C                     END                             E003           E21047
     C                     END                             E002           E21047
      *                                                                   CAC005
      ** If CAC005 is on, screen field book-profit centre should be blank CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C           @PRFC     ANDNE*BLANK                                    CAC005
     C                     MOVE *ON       *IN50                           CAC005
     C                     MOVE *ON       *IN55                           CAC005
     C                     MOVEL' 618'    @EA,I                           CAC005
     C                     ADD  1         I                               CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C           @BRCA     IFNE *BLANKS                                   S01117
     C                     SETON                     5061                 S01117
     C           ' 011'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                                       S01117
     C                     MOVEL' 011'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *
      * Bulk ref. must be on file if not blank
      *
     C           @BLKR     IFNE *BLANKS                    B002
     C           @BLKR     CHAINTRADBK               01                   CFE001
     C           *IN01     IFEQ '1'                        B003
     C                     SETON                     50  64
     C                     MOVEL' 003'    @EA,I
     C                     ADD  1         I
     C                     ELSE                            X003
     C           FCPPPR    IFNE 'Y'                                       S01486
     C                     MOVE TDSS      @SEC
     C                     MOVE RTRF      @TDRF
     C*
     C**  Check security of trade if market update is active              S01511
     C*                                                                   S01511
     C           S01511    IFEQ 'Y'                                       S01511
     C*                                                                   S01511
     C           @SEC      CHAINSECTY                01                   S01511
     C           *IN01     IFEQ '0'                                       S01511
     C           SMAI      IFEQ 'Y'                                       S01511
     C                     SETON                     50  58               S01511
     C                     MOVEL' 016'    @EA,I                           S01511
     C                     ADD  1         I                               S01511
     C                     ELSE                                           S01511
     C                     MOVE MKTI      SMKTI   1                       S01511
     C                     END                                            S01511
     C                     END                                            S01511
     C                     END                                            S01511
     C*
     C           ATRD      IFNE *BLANKS                    B004
     C                     MOVE 'Y'       @AGTR
     C                     ELSE                                           S01448
     C                     MOVE 'N'       @AGTR                           S01448
     C                     END                             E004
     C                     END                                            S01486
     C                     END                             E003
     C                     END                             E002
     C*                                                                   S01117
     C* If Multibranching environment                                     S01117
     C* User must be authorised to Action Code/Booking Branch             S01117
     C*                                                                   S01117
     C           @ACTC     IFEQ 'D'                                       S01117
     C           MBIN      ANDEQ'Y'                                       S01117
      *                                                                   S01117
     C           @BLKR     CHAINTRADBKF              01                   S01117
     C                     MOVE TDBA      SAVBR   3                       S01117
     C                     CALL 'ZVACTBU'                                 S01117
     C                     PARM           @ACTC                           S01117
     C                     PARM           SAVBR                           S01117
     C                     PARM           @ER     10                      S01117
     C*                                                                   S01117
     C**   If action invalid for user                                     S01117
     C*                                                                   S01117
     C           @ER       IFEQ 1                                         S01117
     C                     SETON                     505264               S01117
     C                     MOVEL' 303'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     ELSE                                           S01117
     C           @ER       IFEQ 2                                         S01117
     C                     SETON                     505264               S01117
     C                     MOVEL' 304'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C**   Check whether all trades in the bulk reference have the same   S01117
     C*     Booking Branch and that user is authorised to the Originating S01117
     C*     Branch if this is required                                    S01117
     C*                                                                   S01117
     C           *IN01     DOWEQ'0'                                       S01117
     C*                                                                   S01117
     C           BKOBUV    IFEQ 'Y'                                       S01117
     C                     Z-ADD*ZERO     @ER                             S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM           ORBR                            S01117
     C                     PARM           @ER                             S01117
     C*                                                                   S01117
     C           @ER       IFEQ 1                                         S01117
     C           ' 305'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                                       S01117
     C                     MOVEL' 305'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     SETON                     505264               S01117
     C                     END                                            S01117
     C                     ELSE                                           S01117
     C           @ER       IFEQ 2                                         S01117
     C           ' 306'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                                       S01117
     C                     MOVEL' 306'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     SETON                     505264               S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C           @BLKR     READETRADBKF                  01               S01117
     C           *IN01     IFEQ '0'                                       S01117
     C           TDBA      IFNE SAVBR                                     S01117
     C                     SETON                     505264               S01117
     C                     MOVEL' 015'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C*                                                                   S01117
     C                     END                                            S01117
      *
     C                     END                             E001
     C*                                                                   S01486
     C** New validations for Pool Portfolio                               S01486
     C*                                                                   S01486
     C           FCPPPR    IFEQ 'Y'                                       S01486
     C           @ACTC     IFEQ 'I'                        B001           S01486
     C                     MOVE 'Y'       WWPLPT  1                       S01486
     C*                                                                   S01486
     C** Pool Customer Number must be numeric                             S01486
     C*                                                                   S01486
     C           @POCU     IFNE *BLANKS                                   080046
     C                     MOVEL*BLANKS   ZFIELD                          S01486
     C                     MOVE @POCU     ZFIELD                          S01486
     C                     Z-ADD6         ZADIG                           S01486
     C                     Z-ADD0         ZADEC                           S01486
     C                     EXSR ZALIGN                                    S01486
     C           *IN99     IFEQ '1'                        B002           S01486
     C                     SETON                     50  68               S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C***********' 013'    LOKUP@EA                      03        S01486 080046
     C           ' 024'    LOKUP@EA                      03               080046
     C           *IN03     IFEQ '0'                        B003           S01486
     C***********          MOVEL' 013'    @EA,I                    S01486 080046
     C                     MOVEL' 024'    @EA,I                           080046
     C                     ADD  1         I                               S01486
     C                     END                             E003           S01486
     C                     END                             E002           S01486
     C*                                                                   S01486
     C** Access Portfolio Management Client details to validate           S01486
     C** input and cope with '?' processing                               S01486
     C*                                                                   S01486
     C                     CALL 'AOPLCSR0'                                S01486
     C                     PARM *BLANKS   @RTCD                           S01486
     C                     PARM '*KEY   ' @OPTN                           S01486
     C                     PARM @POCU     @PLKY  10                       S01486
     C           SDPLCS    PARM SDPLCS    DSFDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C                     SETON                     50  68               S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C***********' 013'    LOKUP@EA                      03        S01486 080046
     C           ' 024'    LOKUP@EA                      03               080046
     C           *IN03     IFEQ '0'                        B003           S01486
     C***********          MOVEL' 013'    @EA,I                    S01486 080046
     C                     MOVEL' 024'    @EA,I                           080046
     C                     ADD  1         I                               S01486
     C                     END                             E003           S01486
     C                     ELSE                                           S01486
     C                     MOVEL@PLKY     @POCU                           S01486
     C                     END                                            S01486
     C                     END                                            080046
     C*                                                                   S01486
     C* Pool Customer or Pool Portfolio validation different than blank   S01486
     C*                                                                   S01486
     C           @POCU     IFNE *BLANKS                    B002           S01486
     C           @POPO     ORNE *BLANKS                                   S01486
     C*                                                                   S01486
     C**********           MOVE @POCU     KPCUST  60                                   S01486 CSD027
     C                     MOVE @POCU     KPCUST  6                                           CSD027
     C                     MOVE @POPO     KPREF   4                       S01486
     C           KEY2      CHAINPMSBPDPD             01                   S01486
     C           *IN01     IFEQ '1'                        B003           S01486
     C           ORRECI    ORNE 'D'                                       S01486
     C           ORNOUN    OREQ 0                                         S01486
     C                     SETON                     506869               S01486
     C                     MOVE 'N'       WWPLPT                          S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C***********' 014'    LOKUP@EA                      03        S01486 080046
     C           ' 025'    LOKUP@EA                      03               080046
     C           *IN03     IFEQ '0'                        B004           S01486
     C***********          MOVEL' 014'    @EA,I                    S01486 080046
     C                     MOVEL' 025'    @EA,I                           080046
     C                     ADD  1         I                               S01486
     C                     END                             E004           S01486
     C                     ELSE                            X003           S01486
     C*                                                                   S01486
     C** For a live record found Trade Range Number Code is blank         S01486
     C*                                                                   S01486
     C           ORRANG    IFEQ *ZEROS                     B004           S01486
     C                     SETON                     506869               S01486
     C                     MOVE 'N'       WWPLPT                          S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' 015'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B005           S01486
     C                     MOVEL' 015'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E005           S01486
     C                     END                             E004           S01486
     C                     END                             E003           S01486
     C*                                                                   S01486
     C** Access TNRAN                                                     S01486
     C*                                                                   S01486
     C           WWPLPT    IFEQ 'Y'                        B003           S01486
     C                     MOVE *ZEROS    K1                              S01486
     C                     MOVE *BLANKS   K2                              S01486
     C                     Z-ADDORRANG    K3                              S01486
     C           KEY7      CHAINTNRAN                01                   S01486
     C           *IN01     IFEQ '1'                        B004           S01486
     C           RECI      ORNE 'D'                                       S01486
     C                     MOVE 'N'       WWPLPT                          S01486
     C                     SETON                     506869               S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' 016'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B005           S01486
     C                     MOVEL' 016'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E005           S01486
     C                     END                             E004           S01486
     C                     END                             E003           S01486
     C*                                                                   S01486
     C** Check that enough trade references remain within defined range   S01486
     C*                                                                   S01486
     C           WWPLPT    IFEQ 'Y'                        B003           S01486
     C           LTIR      SUB  NTRN      WWTRN   70                      S01486
     C           ORNMMB    IFGT WWTRN                      B004           S01486
     C                     SETON                     506869               S01486
     C*                                                                   S01486
     C**Check that error code is not already in error array               S01486
     C*                                                                   S01486
     C           ' 017'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B005           S01486
     C                     MOVEL' 017'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E005           S01486
     C                     END                             E004           S01486
     C                     END                             E003           S01486
     C*                                                                   S01486
     C                     END                             E002           S01486
     C                     END                             E001           S01486
     C*                                                                   S01486
     C** If action code 'A' Bulk reference must be input                  S01486
     C*                                                                   S01486
     C           @ACTC     IFEQ 'A'                        B001           S01486
     C*                                                                   S01486
     C           @TDRF     IFNE *BLANKS                    B002           S01486
     C           @AGTR     ORNE *BLANKS                                   S01486
     C           @SEC      ORNE *BLANKS                                   S01486
     C           @TDTY     ORNE *BLANKS                                   S01486
     C           @BOOK     ORNE *BLANKS                                   S01486
     C           @BRCA     ORNE *BLANKS                                   S01486
     C           @POCU     ORNE *BLANKS                                   S01486
     C           @POPO     ORNE *BLANKS                                   S01486
     C           CAC005    OREQ 'Y'                                       CAC005
     C           @PRFC     ANDNE*BLANKS                                   CAC005
     C                     SETON                     505458               S01486
     C                     SETON                     605662               S01486
     C                     SETON                     616869               S01486
     C                     MOVE *ON       *IN55                           CAC005
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' 018'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B003           S01486
     C                     MOVEL' 018'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E003           S01486
     C                     END                             E002           S01486
     C*                                                                   S01486
     C                     END                             E001           S01486
     C*                                                                   S01486
     C** Bulk reference must be input and numeric                         S01486
     C*                                                                   S01486
     C           @ACTC     IFEQ 'A'                        B001           S01486
     C                     MOVEL*BLANKS   ZFIELD                          S01486
     C                     MOVE @BLKR     ZFIELD                          S01486
     C                     Z-ADD6         ZADIG                           S01486
     C                     Z-ADD0         ZADEC                           S01486
     C                     EXSR ZALIGN                                    S01486
     C           *IN99     IFEQ '1'                        B002           S01486
     C           @BLKR     OREQ *BLANKS                                   S01486
     C                     SETON                     50  64               S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' 019'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B003           S01486
     C                     MOVEL' 019'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E003           S01486
     C                     END                             E002           S01486
     C*                                                                   S01486
     C** Bulk reference refer to a Pool Trade                             S01486
     C*                                                                   S01486
     C           *IN64     IFEQ '0'                        B002           S01486
     C*                                                                   S01486
     C                     MOVE @BLKR     KBLKR   6                       S01486
     C                     MOVE *LOVAL    KPCUST                          S01486
     C                     MOVE *LOVAL    KPREF                           S01486
     C           KEY3      SETLLPMPLTRPD                                  S01486
     C           KEY3A     READEPMPLTRPD                 01               S01486
     C           *IN01     IFEQ '1'                        B003           S01486
     C                     SETON                     50  64               S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' 020'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B004           S01486
     C                     MOVEL' 020'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E004           S01486
     C*                                                                   S01486
     C** ...Otherwise release record lock on PMPLTRPD                     S01486
     C*                                                                   S01486
     C                     ELSE                            X003           S01486
     C                     UPDATPMPLTRP0                                  S01486
     C*                                                                   S01486
     C** COMIT updates                                                    S01486
     C*                                                                   S01486
     C                     EXSR SUB401                                    S01486
     C                     END                             E003           S01486
     C                     END                             E002           S01486
     C*                                                                   S01486
     C** Check that pool trade is not already being processed by          S01486
     C** another job                                                      S01486
     C*                                                                   S01486
     C           OUJOB     IFNE *BLANKS                    B002           S01486
     C                     SETON                     50  64               S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' 023'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B003           S01486
     C                     MOVEL' 023'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E003           S01486
     C                     END                             E002           S01486
     C*                                                                   S01486
     C** Check first set of details on TRADBK                             S01486
     C*                                                                   S01486
     C           *IN64     IFEQ '0'                        B002           S01486
     C                     MOVE @BLKR     KBLKR                           S01486
     C                     MOVE *BLANKS   KAGTR   1                       S01486
     C           KEY4      SETLLTRADBK                                    S01486
     C           KEY4A     READETRADBK                   01               S01486
     C           *IN01     IFEQ '0'                        B003           S01486
     C                     Z-ADD0         WWTN   150                      S01486
     C           TNSN      ADD  TNSP      WWTN                            S01486
     C           TVSN      ADD  WWTN      WWTN                            S01486
     C           TVSP      ADD  WWTN      WWTN                            S01486
     C*                                                                   S01486
     C           RECI      IFNE 'A'                        B004           S01486
     C           RECI      ANDNE'D'                                       S01486
     C           TOSN      ORNE NOML                                      S01486
     C           WWTN      ORNE *ZEROS                                    S01486
     C           WWOUTP    IFNE 'Y'                        B005           S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' W02'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B006           S01486
     C                     SETON                     50  64               S01486
     C                     MOVEL' W02'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E006           S01486
     C                     END                             E005           S01486
     C                     END                             E004           S01486
     C*                                                                   S01486
     C                     END                             E003           S01486
     C                     END                             E002           S01486
     C                     END                             E001           S01486
     C*                                                                   S01486
     C** For action code 'D' if a pool trade exists check that the pool   S01486
     C** trade is not being processed by another job                      S01486
     C*                                                                   S01486
     C           @ACTC     IFEQ 'D'                        B001           S01486
     C***********@ACTC     OREQ 'E'                                 S01486093516
     C                     MOVE @BLKR     KBLKR   6                       S01486
     C                     MOVE *LOVAL    KPCUST                          S01486
     C                     MOVE *LOVAL    KPREF                           S01486
     C           KEY3      SETLLPMPLTRPD                                  S01486
     C           KEY3A     READEPMPLTRPD                 01               S01486
     C           *IN01     IFEQ '1'                        B002           S01486
     C                     SETON                     50  64               S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' 021'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B003           S01486
     C                     MOVEL' 021'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E003           S01486
     C*                                                                   S01486
     C** ...Otherwise release record lock on PMPLTRPD                     S01486
     C*                                                                   S01486
     C                     ELSE                            X002           S01486
     C                     UPDATPMPLTRP0                                  S01486
     C*                                                                   S01486
     C** COMIT updates                                                    S01486
     C*                                                                   S01486
     C                     EXSR SUB401                                    S01486
     C                     END                             E002           S01486
     C*                                                                   S01486
     C** Check that pool trade is not already being processed by          S01486
     C** another job                                                      S01486
     C*                                                                   S01486
     C           OUJOB     IFNE *BLANKS                    B002           S01486
     C           @ACTC     ANDEQ'D'                                       S01486
     C                     SETON                     50  64               S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' 022'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B003           S01486
     C                     MOVEL' 022'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E003           S01486
     C                     END                             E002           S01486
     C                     END                             E001           092518
     C*                                                                   S01486
     C           *IN50     IFEQ '0'                        B002           S01486
     C           @ACTC     ANDNE'I'                                       092518
     C                     MOVE OULKRF    @TDRF                           S01486
     C           OUTDSS    IFNE *BLANKS                                   111459
     C                     MOVE OUTDSS    @SEC                            S01486
     C                     ELSE                                           111459
     C                     MOVE TDSS      @SEC                            111459
     C                     END                                            111459
     C                     MOVE OUTDTP    @TDTY                           S01486
     C                     MOVE OUATRD    @AGTR                           S01486
     C                     MOVE OUTDBK    @BOOK                           S01486
     C                     MOVE OUTDBR    @BRCA                           S01486
     C                     MOVE OUPCNU    @POCU                           S01486
     C                     MOVE OUPPTF    @POPO                           S01486
      *                                                                   CAC005
      ** If CAC005 is on, retrieve the user book represented by OUTDBK.   CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C           PMBKCD    PARM *BLANKS   PMBKCD  2                       CAC005
     C           PMPRFC    PARM *BLANKS   PMPRFC  4                       CAC005
     C                     PARM OUTDBK    PMPSBK  2                       CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMBKCD    @BOOK                           CAC005
     C                     MOVELPMPRFC    @PRFC                           CAC005
     C                     ELSE                                           CAC005
     C                     MOVEL*BLANKS   @PRFC                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
     C*                                                                   S01486
     C** Obtain pool security details used in SR/SUB501                   S01486
     C*                                                                   S01486
     C***********OUTDSS    CHAINSECTY                01            S01486 111459
     C           @SEC      CHAINSECTY                01            S01486 111459
     C           *IN01     IFEQ '1'                        B003           S01486
     C                     Z-ADD53        @DBASE           ***************S01486
     C                     MOVEL'SECTY'   @DBFIL           * DB ERROR 53 *S01486
     C                     MOVELOUTDSS    @DBKEY           ***************S01486
     C                     EXSR *PSSR                                     S01486
     C                     END                             E003           S01486
     C***********          MOVE NMCYA     KCCY1                    S01486 CPM005
     C*                                                                   S01486
     C** The investment type of the security must exist on LF/INVTP       S01486
     C*                                                                   S01486
     C           @KEY1     CHAININVTP                01                   S01486
     C           *IN01     IFEQ '1'                        B003           S01486
     C                     Z-ADD54        @DBASE           ***************S01486
     C                     MOVEL'INVTP'   @DBFIL           * DB ERROR 54 *S01486
     C                     MOVELNMCYA     @DBKEY           ***************S01486
     C                     MOVE SITP      @DBKEY                          S01486
     C                     EXSR *PSSR                                     S01486
     C                     END                             E003           S01486
     C                     END                             E002           S01486
     C***********          END                             E001     S01486092518
     C                     END                                            S01486
     C*                                                                   S01117
     C* If Single Branch  environment                                     S01117
     C* User must be authorised to Action Code                            S01117
     C*                                                                   S01117
     C           MBIN      IFEQ 'N'                                       S01117
     C                     CALL 'ZVACTU'                                  S01117
     C                     PARM           @ACTC                           S01117
     C                     PARM           @ER     10                      S01117
     C*                                                                   S01117
     C**   If action invalid for user                                     S01117
     C*                                                                   S01117
     C           @ER       IFNE *ZERO                                     S01117
     C                     SETON                     5052                 S01117
     C                     MOVEL' 302'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *
      * Move the error array to the screen error field
      *
     C                     MOVEA@EA,1     @ERR
      *
     C                     ENDSR                           SUB201 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB202 - Validate s/file                                     *
      *                                                               *
      *****************************************************************
      *
     C           SUB202    BEGSR
      *
      * Reset fields
      *
     C                     Z-ADD-1        @SFREC
     C                     Z-ADD-1        @SFRC2  40
     C                     Z-ADD*ZEROS    WRCTR   40                      085334
     C                     Z-ADD1         I
     C                     MOVEL*BLANKS   @RETC
     C                     MOVEA*BLANKS   @EA
     C                     SETOF                     06  08
     C                     MOVEL'N'       WARNIN  1                       E37015
     C/COPY WNCPYSRC,SE3000C016
      *
      * Read all changed records in the subfile
      *
     C           *IN02     DOUEQ'1'                        B001
     C/COPY WNCPYSRC,SE3000C017
     C           *IN70     IFEQ '0'                        B002
     C                     READCSE3000F0                 02
     C                     ELSE                            X002
     C                     READCSE3000F3                 02
     C                     END                             E002
     C*                                                                   S01496
     C** SAVE CURRENT PRICE AND NOMINAL                                   S01496
     C*                                                                   S01496
     C                     MOVE @PNOML    WSNOML 110                      S01496
     C                     MOVE @PTPDY    WSTPDY 158                      S01496
     C**********           MOVE @PTCNR    WSCNUM  60                                   CSE023 CSD027
     C                     MOVE @PTCNR    WSCNUM  6                                           CSD027
     C*                                                                   S01496
     C/COPY WNCPYSRC,SE3000C010
     C           *IN02     IFEQ '0'                        B002
      *
      * Reset indicators
      *
     C                     SETON                     06
     C                     SETOF                     404142
     C                     SETOF                     434426
     C                     SETOF                     45                   S01117
     C                     MOVE 'N'       RDSPLY                          S01117
     C                     ADD  1         WRCTR                           085334
     C           WRCTR     IFEQ 1                                         085334
     C           *IN70     ANDEQ'1'                                       085334
     C           @PNOML    ANDEQ0                                         085334
     C                     Z-ADD*ZEROS    @NTOT2 150                      085334
     C                     ENDIF                                          085334
      *
      * Subtract nominal from nominal total
      *
     C           *IN70     IFEQ '0'                        B003
     C                     SUB  @PNOML    @NTOT1
      *
      * Subtract cost for this record from total cost
      *
     C                     SUB  @COST     @TCOST
      *
     C                     ELSE                            X003
     C                     SUB  @PNOML    @NTOT2
     C                     END                             E003
      *
      * Validate record if there are non-blank fields
      *
     C           @REF      IFNE *BLANKS                    B003
     C           @CLI      ORNE *BLANKS
     C           @NOM      ORNE *BLANKS
     C           @PYDS     ORNE *BLANKS
     C           @RVT      ORNE *BLANKS
      *
      * Check for '?' on input
      *
     C                     MOVEL@CLI      @QRY                            S01117
     C           @QRY      IFEQ '?'                                       S01117
     C                     MOVE 'Y'       RDSPLY                          S01117
     C                     SETON                     45                   S01117
     C                     MOVEL@CLI      @SCKY                           S01117
     C                     CALL 'AOSECSR0'                                S01117
     C                     PARM           @RTCD                           S01117
     C                     PARM '*KEY   ' @OPTN                           S01117
     C                     PARM           @SCKY                           S01117
     C           SDSECS    PARM SDSECS    DSSDY                           S01117
     C           @RTCD     IFEQ '*NOSEL '                                 S01117
     C                     MOVE *BLANKS   @CLI                            S01117
     C                     ELSE                                           S01117
     C                     MOVE *BLANKS   @CLI                            S01117
     C                     MOVELBFCUST    @CLI                            S01117
     C                     END                                            S01117
     C***********          ELSE                                    S01117 101086
     C                     END                                            101086
      *
      * Some validation checks need only be made for action = Insert
      *
     C           @ACTC     IFEQ 'I'                        B004
      *
      * Validate trade ref. if changed from value in parameter
      * or blank
      *
     C           @REF      IFNE @PTDRF                     B005
     C           @REF      OREQ *BLANKS
      *
      * Check that reference entered is numeric and between 1 and 999999
      *
     C                     MOVEL@REF      @WK7N   70
     C                     MOVEL@WK7N     @WK6    6
     C           @WK6      IFNE @REF                       B006
     C           @REF      OREQ '000000'
     C                     SETON                     50  40
      *
      * Check that error code is not already in error array
      *
     C           ' 100'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B007
     C                     MOVEL' 100'    @EA,I
     C                     ADD  1         I
     C                     END                             E007
     C                     END                             E006
     C*                                                                   050690
     C** If valid so far, reference must not refer to a record on         050690
     C** historic trade file.                                             050690
     C*                                                                   050690
     C           *IN40     IFEQ '0'                        B006           050690
     C           @REF      CHAINHSTTRDF              01                   050690
     C           *IN01     IFEQ '0'                        B007           050690
     C           RECI      IFEQ 'A'                        B008           050690
     C           RECI      OREQ 'D'                                       050690
     C           RECI      OREQ 'C'                                       050690
     C           RECI      OREQ 'S'                                       050690
     C                     SETON                     50  40               050690
     C*                                                                   050690
     C** Check that error code is not already in error array              050690
     C*                                                                   050690
     C           ' 101'    LOKUP@EA                      03               050690
     C           *IN03     IFEQ '0'                        B009           050690
     C           @ACTC     OREQ 'D'                                       050690
     C                     MOVEL' 101'    @EA,I                           050690
     C                     ADD  1         I                               050690
     C                     END                             E009           050690
     C                     END                             E008           050690
     C                     END                             E007           050690
     C                     END                             E006           050690
      *
      * If valid so far, reference must not refer to a record on
      **with*a*record*ID*of*A,D,C*or*S************************************S01269
      **with*a*record*ID*of*A,D,C,S,L,R*or*P***********************S01269 088307
      * with a record ID of A,D,C,S,L,R,P or *                            088307
      *
     C           *IN40     IFEQ '0'                        B006
     C           @REF      CHAINTRADS                01
     C           *IN01     IFEQ '0'                        B007
     C           RECI      IFEQ 'A'                        B008
     C           RECI      OREQ 'D'
     C           RECI      OREQ 'C'
     C           RECI      OREQ 'S'
     C           RECI      OREQ 'L'                                       S01269
     C           RECI      OREQ 'R'                                       S01269
     C           RECI      OREQ 'P'                                       S01269
     C           RECI      OREQ '*'                                       088307
     C                     SETON                     50  40
      *
      * Check that error code is not already in error array
      *
     C           ' 101'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B009
     C           @ACTC     OREQ 'D'
     C                     MOVEL' 101'    @EA,I
     C                     ADD  1         I
     C                     END                             E009
     C                     END                             E008
     C                     END                             E007
     C                     END                             E006
      *
      * If valid so far, reference must not refer to a record on LF/BULKR
      * with a record ID of D or blank
      *
     C           *IN40     IFEQ '0'                        B006
     C*                                                                   083878
     C* Chain to reference without locking record (N in pos 53)           083878
     C***********@REF      CHAINBULKR                01                   083878
     C           @REF      CHAINBULKR               N01                   083878
     C           *IN01     IFEQ '0'                        B007
     C           RECI      IFEQ 'D'                        B008
     C           RECI      OREQ *BLANKS
     C                     SETON                     50  40
      *
      * Check that error code is not already in error array
      *
     C           ' 101'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B009
     C           @ACTC     OREQ 'D'
     C                     MOVEL' 101'    @EA,I
     C                     ADD  1         I
     C                     END                             E009
     C                     END                             E008
     C                     END                             E007
     C                     END                             E006
      *
     C                     END                             E005
      *
      * Client number/shortname must reference an active customer on
      **PF/CLINTSE.*If*first*char.*of*field*is*not*numeric,*validate*as*a*S01117
      * SDSECSPD.   If first char. of field is not numeric, validate as a S01117
      * shortname, else validate as a customer number
      *
     C                     MOVEL@CLI      @WK1    1
     C           @WK1      IFLT '0'                        B005
     C           @WK1      ORGT '9'
     C***********@CLI      CHAINSNAMEF               01                   S01117
     C************IN01     IFEQ '1'                        B006           S01117
     C***********RECI      ORNE 'D'                                       S01117
     C                     CALL 'AOCUSTR0'                                S01117
     C                     PARM '*BLANKS' @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM @CLI      @CSNM  10                       S01117
     C                     PARM           @KYST   7                       S01117
     C           SDCUST    PARM SDCUST    DSSDY                           S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
     C                     SETON                     50  41
      *
      * Check that error code is not already in error array
      *
     C           ' 103'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B007
     C                     MOVEL' 103'    @EA,I
     C                     ADD  1         I
     C                     END                             E007
     C                     END                             E006
     C                     ELSE                            X005
     C***********          MOVEL@CLI      CNUM                            S01117
     C                     MOVEL@CLI      BBCUST                          S01117
     C                     END                             E005
      *
     C           *IN41     IFEQ '0'                        B005
     C***********CNUM      CHAINCLINTSEF             01                   S01117
     C************IN01     IFEQ '1'                        B006           S01117
     C***********RECI      ORNE 'D'                                       S01117
     C                     CALL 'AOSECSR0'                                S01117
     C                     PARM *BLANKS   @RTCD   7                       S01117
     C                     PARM '*KEY   ' @OPTN   7                       S01117
     C                     PARM BBCUST    @SCKY   6                       S01117
     C           SDSECS    PARM SDSECS    DSSDY                           S01117
     C           @RTCD     IFNE *BLANKS                                   S01117
      *
      * Must be a market or portfolio client                              S01176
      *
     C***********RECI      OREQ 'D'                                S01176 S01117
     C***********C1DI      ANDNE'M'                                S01176 S01117
     C***********C1DI      ANDNE'D'                                S01176 S01117
     C***********C1DI      ANDNE'S'                                S01176 S01117
     C           BFCLAS    ORNE 'M'                                       S01117
     C           BFCLAS    ANDNE'D'                                       S01117
     C           BFCLAS    ANDNE'S'                                       S01117
      *
     C**ALSO*CUSTOMER*NUMBER*MUST*NOT*EQUAL*BRANCH*CUSTOMER*NO*****       S01117
      *
     C***********CNUM      OREQ BICN                                      S01117
     C***********C1DI      ANDEQ'I'                                       S01117
     C                     SETON                     50  41
      *
      * Check that error code is not already in error array
      *
     C           ' 103'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B007
     C                     MOVEL' 103'    @EA,I
     C                     ADD  1         I
     C                     END                             E007
     C                     ELSE                            X006
     C***********          Z-ADDCNUM      @PTCNR
     C                     MOVE BFCUST    @PTCNR
     C                     END                             E006
     C                     END                             E005
      *
      * Discretionary indicator must be M for a market agency trade and
      * either S or D for a client agency trade
      *
     C           *IN41     IFEQ '0'                        B005
     C           @AGTR     ANDEQ'Y'
      *
     C           *IN70     IFEQ '0'                        B006
     C***********C1DI      IFNE 'M'                        B007           S01117
     C*******    BFCLAS    IFNE 'M'                        B007     S01117S01448
     C           S01448    IFEQ 'N'                        B007           S01448
     C           BVATPC    OREQ 'N'                                       S01448
     C           BFCLAS    IFNE 'M'                        B008           S01448
     C                     SETON                     50  41
     C                     END                             E008           S01448
     C                     ELSE                            X007           S01448
     C*                                                                   S01448
     C*  If Bulk Input Enhancements is on and Allow Trades between        S01448
     C*  Portfolio Clients is 'Y' then ensure that the all customers      S01448
     C*  for trades entered on the first side have the same               S01448
     C*  classsification (i.e. all market clients or all portfolio        S01448
     C*  clients).                                                        S01448
     C*                                                                   S01448
     C           @SFK      IFEQ 1                          B008           S01448
     C                     MOVE BFCLAS    WCLSAV                          S01448
     C                     ELSE                            X008           S01448
     C           BFCLAS    IFEQ 'M'                        B009           S01448
     C           WCLSAV    ANDNE'M'                                       S01448
     C           BFCLAS    OREQ 'S'                                       S01448
     C           WCLSAV    ANDEQ'M'                                       S01448
     C           BFCLAS    OREQ 'D'                                       S01448
     C           WCLSAV    ANDEQ'M'                                       S01448
     C                     MOVE '1'       *IN50                           S01448
     C                     MOVE '1'       *IN41                           S01448
     C                     END                             E009           S01448
     C                     END                             E008           S01448
     C                     END                             E007
     C*                                                                   S01448
     C*  If the Bulk Enhancements feature is on, there are no errors      S01448
     C*  and the customer is portfolio then set indicator for cross       S01448
     C*  agency trade. Only use the classification of the customer        S01448
     C*  on the first record being processed.                             S01448
     C*                                                                   S01448
     C           S01448    IFEQ 'Y'                        B007           S01448
     C           *IN41     ANDEQ'0'                                       S01448
     C           BFCLAS    ANDNE'M'                                       S01448
     C           @SFK      ANDEQ1                                         S01448
     C                     MOVE 'Y'       @CAGT                           S01448
     C                     END                             E007           S01448
     C*                                                                   S01448
     C                     ELSE                            X006
     C***********C1DI      IFNE 'S'                        B007           S01117
     C***********C1DI      ANDNE'D'                                       S01117
     C/COPY WNCPYSRC,SE3000C021
     C           BFCLAS    IFNE 'S'                        B007           S01117
     C           BFCLAS    ANDNE'D'                                       S01117
     C                     SETON                     50  41
     C                     END                             E007
     C/COPY WNCPYSRC,SE3000C022
     C                     END                             E006
      *
      * Update error code array
      *
     C           *IN41     IFEQ '1'                        B006
      *
      * Check that error code is not already in error array
      *
     C           ' 102'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B007
     C                     MOVEL' 102'    @EA,I
     C                     ADD  1         I
     C                     END                             E007
     C                     END                             E006
      *
     C                     END                             E005
      *                                                                   CSE023
      ** If CSE023 is on, check for backup withholding                    CSE023
      *                                                                   CSE023
     C           CSE023    IFEQ 'Y'                                       CSE023
     C           BFCLAS    ANDEQ'S'                                       186102
     C           CSE023    OREQ 'Y'                                       186102
     C           BFCLAS    ANDEQ'D'                                       186102
     C***********          MOVE 'N'       WWCNUM                   CSE023 188410
     C           @SEC      CHAINSECTYDF              72                   CSE023
      *                                                                   CSE023
      ** If country of tax treaty is not blank, check if backup           CSE023
      ** withholding is applicable                                        CSE023
      *                                                                   CSE023
     C           CRTT      IFNE *BLANKS                                   CSE023
     C                     MOVE CRTT      KCRTT                           CSE023
     C                     MOVE BBCUST    KCNUM                           CSE023
     C           KEY8      CHAIN@WTCSL0              73                   CSE023
     C           *IN73     IFEQ *OFF                                      CSE023
     C           WHBCWA    ANDEQ'Y'                                       CSE023
      *                                                                   CSE023
      ** For Trade Purchase, issue warning that this is a sale for        CSE023
      ** a customer for whom backup withholding applies                   CSE023
      *                                                                   CSE023
     C           @TDTY     IFEQ 'TP'                                      CSE023
     C***********          MOVE *ON       *IN41                    CSE023 188410
     C***********          MOVE 'Y'       WWCNUM  1                CSE023 188410
     C           ' W35'    LOKUP@EA                      03               CSE023
     C           *IN03     IFEQ *OFF                                      CSE023
     C                     MOVE ' W35'    @EA,I                           CSE023
     C                     ADD  1         I                               CSE023
     C                     ENDIF                                          CSE023
      *                                                                   CSE023
     C                     ELSE                                           CSE023
      *                                                                   CSE023
      ** For Trade Sale, issue warning this is a purchase for             CSE023
      ** a customer for whom backup withholding applies                   CSE023
      *                                                                   CSE023
     C           ' W36'    LOKUP@EA                      03               CSE023
     C***********          MOVE *ON       *IN41                    CSE023 188410
     C***********          MOVE 'Y'       WWCNUM                   CSE023 188410
     C           *IN03     IFEQ *OFF                                      CSE023
     C                     MOVE ' W36'    @EA,I                           CSE023
     C                     ADD  1         I                               CSE023
     C                     ENDIF                                          CSE023
      *                                                                   CSE023
      ** If Documentation received fields is 'N', issue warning           CSE023
      ** that a purchase is being made for a customer without the         CSE023
      ** necessary documentation                                          CSE023
      *                                                                   CSE023
     C           WHDCRC    IFEQ 'N'                                       CSE023
     C***********          MOVE *ON       *IN41                    CSE023 188410
     C***********          MOVE 'Y'       WWCNUM                   CSE023 188410
     C           ' W37'    LOKUP@EA                      03               CSE023
     C           *IN03     IFEQ *OFF                                      CSE023
     C                     MOVE ' W37'    @EA,I                           CSE023
     C                     ADD  1         I                               CSE023
     C                     ENDIF                                          CSE023
     C                     ENDIF                                          CSE023
     C                     ENDIF                                          CSE023
     C                     ENDIF                                          CSE023
      *                                                                   CSE023
      ** If country of treaty does not exist on SDWTCSL0 and trade        CSE023
      ** type is sale, issue warning that a purchase is being made        CSE023
      ** for a customer without the necessary documentation               CSE023
      *                                                                   CSE023
     C           TDTP      IFEQ 'TS'                                      CSE023
     C           *IN73     ANDEQ*ON                                       CSE023
     C***********          MOVE *ON       *IN41                    CSE023 188410
     C***********          MOVE 'Y'       WWCNUM                   CSE023 188410
     C           ' W37'    LOKUP@EA                      03               CSE023
     C           *IN03     IFEQ *OFF                                      CSE023
     C                     MOVE ' W37'    @EA,I                           CSE023
     C                     ADD  1         I                               CSE023
     C                     ENDIF                                          CSE023
     C                     ENDIF                                          CSE023
      *                                                                   CSE023
     C                     ENDIF                                          CSE023
     C                     ENDIF                                          CSE023
      *                                                                   S01176
      * Subtract old nominal from total broker trades nominal             S01176
      *                                                                   S01176
     C           *IN70     IFEQ '0'                                       S01176
     C           @AGTR     ANDEQ'Y'                                       S01176
     C                     SUB  @PNOML    @CUMMN                          S01176
     C                     END                                            S01176
      *
      * Validate nominal
      *
     C                     MOVE 'N'       WWRLNM  1                       S01496
     C                     MOVEL*BLANKS   ZFIELD
     C***********          MOVE @NOM      ZFIELD                          032056
     C***********          Z-ADD11        ZADIG                           032056
     C                     MOVEL@NOM      ZFIELD                          032056
     C           11        SUB  NMDP      ZADIG                           032056
     C                     Z-ADDNMDP      ZADEC
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @WK15  150
     C                     MOVE ZFIELD    @WW15  150                      081490
     C           *IN99     IFEQ '1'                        B005
     C           @NOM      OREQ *BLANKS
     C           @WK15     OREQ 0
     C                     SETON                     50  42
     C                     MOVE 'Y'       WWRLNM                          S01496
      *
      * Check that error code is not already in error array
      *
     C           ' 104'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B006
     C                     MOVEL' 104'    @EA,I
     C                     ADD  1         I
     C                     END                             E006
      *
      * If invalid, then zeroise parameter value
      *
     C                     Z-ADD0         @PNOML
      *
     C                     ELSE                            X005
      *
      * Valid - add new value to total nominal
      *
     C           *IN70     IFEQ '0'                        B006
     C                     ADD  @WK15     @NTOT1
     C                     ELSE                            X006
     C                     ADD  @WK15     @NTOT2
     C           WVREC     IFEQ *BLANK                                    085334
     C                     MOVE 'Y'       RDSPLY                          085334
     C                     END                                            085334
     C                     END                             E006
      *
      **Subtract*old*nominal*amount*and*add*new*amount                    S01176
      *
     C***********@WK15     IFNE @PNOML                     B006           S01176
     C***********@AGTR     ANDEQ'Y'                                       S01176
     C***********C1DI      ANDEQ'M'                                       S01176
     C***********          SUB  @PNOML    @CUMMN                          S01176
     C***********          ADD  @WK15     @CUMMN                          S01176
     C***********          END                                            S01176
      *                                                                   S01176
      * Add new nominal to total broker trades nominal                    S01176
      *                                                                   S01176
     C           *IN70     IFEQ '0'                                       S01176
     C           @AGTR     ANDEQ'Y'                                       S01176
     C                     ADD  @WK15     @CUMMN                          S01176
     C                     END                                            S01176
      *
      * If valid, then format for the screen
      *
     C           *IN70     IFEQ '0'                                       085334
     C           WVREC     OREQ 'Y'                                       085334
     C                     Z-ADD@WK15     @PNOML
     C                     Z-ADD@WK15     @PTOSN
     C                     ENDIF                                          085334
     C                     MOVEL*BLANKS   ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADDNMDP      ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @NOM
     C                     Z-ADD@WK15     @PNOML                          111458
     C                     END                             E005
      *
      **If*valid,*then*nominal*must*be*a*multiple*of*stock*denomination***S01176
      * If valid, then nominal must be a multiple of trade denomination   S01176
      *                                                                   S01176
     C           @SDNM2    IFNE 0                          B005
     C           *IN42     ANDEQ'0'
     C           @WK15     DIV  @SDNM2    @WK15
     C                     MVR            @WK15
     C           @WK15     IFNE 0                          B006
     C                     SETON                     50  42
     C/COPY WNCPYSRC,SE3000C006
     C           CSE007    IFEQ 'N'                                       CSE007
     C           CEU017    ANDEQ'N'                                       CEU017
     C                     MOVE 'Y'       WWRLNM                          S01496
      *
      * Check that error code is not already in error array
      *
     C           ' 105'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B007
     C                     MOVEL' 105'    @EA,I
     C                     ADD  1         I
     C                     END                             E007
     C/COPY WNCPYSRC,SE3000C007
     C                     ELSE                                           CSE007
      *                                                                   CSE007
     C           ' W18'    LOKUP@EA                      03               CSE007
     C           *IN03     IFEQ '0'                                       CSE007
     C                     MOVEL' W18'    @EA,I                           CSE007
     C                     ADD  1         I                               CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CSE007
     C                     ENDIF                                          CSE007
     C                     END                             E006
     C                     END                             E005
     C*                                                                   081490
     C           S01496    IFEQ 'Y'                                       081490
     C           CSE007    OREQ 'Y'                                       CSE007
     C           CEU017    OREQ 'Y'                                       CEU017
     C           BFCLAS    IFEQ 'S'                                       081490
     C           BFCLAS    OREQ 'D'                                       081490
     C           CEU017    OREQ 'Y'                                       149517
     C*                                                                   081490
     C                     MOVE BFCUST    @CNUM   6                       081490
     C                     MOVE 'Y'       @OBPO   1                       081490
     C*                                                                   081490
     C**  Subfile 1 being processed                                       081490
     C*                                                                   081490
     C           *IN70     IFEQ '0'                                       081490
     C                     MOVE @TDTY     WTDTY   2                       081490
     C                     ELSE                                           081490
     C                     MOVE @TDTY2    WTDTY                           081490
     C                     ENDIF                                          081490
     C*                                                                   081490
     C           WTDTY     IFEQ 'TP'                                      081490
     C                     MOVE 'P'       @BLTY   1                       081490
     C                     ELSE                                           081490
     C                     MOVE 'S'       @BLTY   1                       081490
     C                     ENDIF                                          081490
      *                                                                   CSE007
      ***  If Corporate Actions feature is installed.                     CSE007
      ***  or if Securities Redenomination feature is installed.          CEU017
      *                                                                   CSE007
     C           CSE007    IFEQ 'Y'                                       CSE007
     C           CEU017    OREQ 'Y'                                       CEU017
      *                                                                   CSE007
     C           ' CO1'    LOKUP@EA                      03               CSE007
     C           *IN03     IFEQ '0'                                       CSE007
      *                                                                   CSE007
      ***  Search if there is Corporate Actions General Block for         CSE007
      ***  Security.                                                      CSE007
      *                                                                   CSE007
     C                     MOVE 'Y'       SE6712                          CSE007
     C**********           MOVELBFCUST    @@CNUM  60                                   227267 CSD027
     C                     MOVELBFCUST    @@CNUM  6                                           CSD027
     C                     CALL 'SE7572'                                  CSE007
     C                     PARM           @BRCA                           CSE007
     C                     PARM           @SEC                            CSE007
     C                     PARM           @@CNUM                                              227267
     C                     PARM           @PPGB   1                       CSE007
     C                     PARM           @PSGB   1                       CSE007
      *                                                                   CSE007
      ***  If block found, send error message and setup work field to     CSE007
      ***  not call SE6712.                                               CSE007
      *                                                                   CSE007
     C           @PPGB     IFEQ 'Y'                                       CSE007
     C           WTDTY     ANDEQ'TP'                                      CSE007
     C           @PSGB     OREQ 'Y'                                       CSE007
     C           WTDTY     ANDEQ'TS'                                      CSE007
     C                     SETON                     50  42               CSE007
     C                     MOVEL' CO1'    @EA,I                           CSE007
     C                     ADD  1         I                               CSE007
     C                     MOVE 'N'       SE6712                          CSE007
     C                     MOVE 'Y'       WWRLNM                          CSE007
     C                     ENDIF                                          CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CSE007
     C                     ENDIF                                          CSE007
     C*                                                                   081490
     C           ' WR1'    LOKUP@EA                      03               081490
     C           *IN03     IFEQ '0'                                       081490
      *                                                                   CSE007
      ***  If Corporate Actions feature is switched OFF or Corporate      CSE007
      ***  Actions General Block for Security not found.                  CSE007
      *                                                                   CSE007
     C           SE6712    IFEQ 'Y'                                       CSE007
     C*                                                                   081490
     C**   .. search if there is General Block for Security               081490
     C*                                                                   081490
     C                     CALL 'SE6712'                                  081490
     C******               PARM           @BRCD                    081490 CSE007
     C                     PARM           @BRCA                           CSE007
     C                     PARM           @SEC                            081490
     C                     PARM           @PPGB   1                       081490
     C                     PARM           @PSGB   1                       081490
     C*                                                                   081490
     C           @PPGB     IFEQ 'Y'                                       081490
     C           WTDTY     ANDEQ'TP'                                      081490
     C           @PSGB     OREQ 'Y'                                       081490
     C           WTDTY     ANDEQ'TS'                                      081490
     C                     SETON                     50  42               081490
     C                     MOVEL' WR1'    @EA,I                           081490
     C                     ADD  1         I                               081490
     C                     ENDIF                                          081490
      *                                                                   CSE007
     C                     ENDIF                                          CSE007
     C                     ENDIF                                          081490
     C*                                                                   081490
     C**  If PM not installed or Customer non portfolio (not found)       081490
     C*                                                                   081490
     C           BGPFMG    IFEQ 'Y'                                       081490
     C                     CALL 'AOPLCSR0'                                081490
     C                     PARM *BLANKS   @RTCD                           081490
     C                     PARM '*KEY   ' @OPTN                           081490
     C                     PARM @CNUM     @PLKY  10                       081490
     C           SDPLCS    PARM SDPLCS    DSFDY                           081490
     C           @RTCD     IFEQ *BLANKS                                                       234691
     C                     MOVEL'Y'       WLPCUS  1                                           234691
     C                     ELSE                                                               234691
     C                     MOVE 'N'       WLPCUS                                              234691
     C                     END                                                                234691
     C                     END                                            081490
      *                                                                   CPB001
     C           BGN4ST    IFEQ 'Y'                                       CPB001
     C                     MOVEL@CNUM     @CSNM                           CPB001
     C                     CALL 'AOCUSTR1'                                CPB001
     C                     PARM *BLANKS   WRTCD   7                       CPB001
     C                     PARM '*KEY   ' @OPTN   7                       CPB001
     C                     PARM           @CSNM  10                       CPB001
     C                     PARM           @KYST   7                       CPB001
     C           SDCUST    PARM SDCUST    DSLDY                           CPB001
     C           @RTCD     IFEQ *BLANKS                                                       234691
     C           BBPRBA    ANDEQ'Y'                                                           234691
     C                     MOVEL'Y'       WPBCUS  1                                           234691
     C                     ELSE                                                               234691
     C                     MOVE 'N'       WPBCUS                                              234691
     C                     ENDIF                                                              234691
     C                     ENDIF                                          CPB001
      *                                                                   CPB001
     C           BGPFMG    IFNE 'Y'                                       081490
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C           @RTCD     ORNE *BLANKS                                   081490
     C           BGPFMG    ANDEQ'Y'                                       081490
     C           BBPRBA    ANDNE'Y'                                       CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C           @RTCD     ORNE *BLANKS                                   CPB001
     C           BGPFMG    ANDEQ'Y'                                       CPB001
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C           BGPFMG    ORNE 'Y'                                       CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C           BBPRBA    ANDNE'Y'                                       CPB001
     C                     MOVE *BLANKS   @PTFR   4                       081490
     C                     EXSR WBLOCK                                    081490
     C                     ENDIF                                          081490
     C*                                                                   081490
     C                     ENDIF                                          081490
     C                     ENDIF                                          081490
      *                                                                                       234691
      * Check if there are trades after the value date                                        234691
      *                                                                                       234691
     C           CGL031    IFEQ 'Y'                                                           234691
     C           @RVT      ANDEQ'N'                                                           234691
     C           CGL031    OREQ 'Y'                                                           234691
     C           @RVT      ANDEQ' '                                                           234691
     C           BVRVBT    ANDEQ'N'                                                           234691
     C           BFCLAS    IFEQ 'S'                                                           234691
     C           BFCLAS    OREQ 'D'                                                           234691
      *                                                                                       234691
      * default value date                                                                    234691
      *                                                                                       234691
     C                     CALL SEVDAL                                                        234691
      *                                                                                       234691
      * INPUTS                                                                                234691
      *                                                                                       234691
      ** Return Code                                                                          234691
     C                     PARM *BLANKS   PRETC  10                                           234691
     C                     PARM 'Y'       WDFLT   1                                           234691
     C                     PARM 'N'       WVALD   1                                           234691
     C                     PARM *BLANKS   WTDVD   7                                           234691
     C                     PARM *BLANKS   WCLTY   1                                           234691
     C                     PARM *BLANKS   WSETC   3                                           234691
     C                     PARM           @SECTY                                              234691
     C                     PARM PROT      WPROT   1                                           234691
     C                     PARM           S01509                                              234691
     C                     PARM           BJRDNB                                              234691
     C                     PARM           BJDFIN                                              234691
     C                     PARM           BVBVP                                               234691
     C                     PARM           BVEUCY                                              234691
     C                     PARM           BVCCCY                                              234691
     C                     PARM *BLANKS   WBYSL   1                                           234691
     C                     PARM *ZEROS    WPDVD   50                                          234691
      *                                                                                       234691
      * OUTPUTS                                                                               234691
      *                                                                                       234691
      * Error fields/message IDs/message data (arrays) from/to caller                         234691
     C                     PARM           @FNXA                                               234691
     C                     PARM           @MIXA                                               234691
     C                     PARM           @MDXA                                               234691
      ** Warning Fields/Message IDs/Message Data (arrays) From/To Caller                      234691
     C                     PARM           @WFNXA                                              234691
     C                     PARM           @WMIXA                                              234691
     C                     PARM           @WMDXA                                              234691
      *                                                                                       234691
      ** Value Date - OK                                                                      234691
     C                     PARM           WVDTOK  1                                           234691
     C                     PARM           WRTDVD  50                                          234691
     C                     PARM           WTDCR  117                                          234691
     C                     PARM           WTCFC  109                                          234691
     C                     PARM           WCPNR  13                                           234691
     C                     PARM           WCFCT  12                                           234691
      *                                                                                       234691
     C           WVDTOK    IFEQ 'N'                                                           234691
     C                     Z-ADDBJRDNB    WRTDVD                                              234691
     C                     ENDIF                                                              234691
      *                                                                                       234691
      ** Validate whether account is blocked due to EU Tax by calling                         234691
      ** SEVTAXDATE                                                                           234691
      *                                                                                       234691
     C                     MOVEL'*NK '    WPTFR                                               234691
     C                     MOVEL'Y'       WDFLT                                               234691
     C                     CALL SEVDAT                                                        234691
      *                                                                                       234691
      * INPUTS                                                                                234691
      *                                                                                       234691
      ** Return Code                                                                          234691
     C                     PARM *BLANKS   PRETC                                               234691
     C                     PARM           WDFLT   1                                           234691
     C                     PARM 'I'       WACTN   1                                           234691
     C                     PARM           @PTDBA                                              234691
     C                     PARM           @PTCNR                                              234691
     C                     PARM           @PTDSS                                              234691
     C                     PARM           WPTFR   4                                           234691
     C                     PARM MKTI      @PTDMI                                              234691
     C                     PARM 'T'       WTYPE   1                                           234691
     C                     PARM           @PTDRF                                              234691
     C                     PARM           WRTDVD                                              234691
     C                     PARM '@STDVD'  WFIELD 10                                           234691
     C                     PARM           @SECTY                                              234691
     C                     PARM           @CUSDT                                              234691
      *                                                                                       234691
      * OUTPUTS                                                                               234691
      *                                                                                       234691
      * Error fields/message IDs/message data (arrays) from/to caller                         234691
     C                     PARM           @FNXA                                               234691
     C                     PARM           @MIXA                                               234691
     C                     PARM           @MDXA                                               234691
      ** Warning Fields/Message IDs/Message Data (arrays) From/To Caller                      234691
     C                     PARM           @WFNXA                                              234691
     C                     PARM           @WMIXA                                              234691
     C                     PARM           @WMDXA                                              234691
      *                                                                                       234691
      ** Value Date - OK                                                                      234691
     C                     PARM           WVDTOK  1                                           234691
     C           WVDTOK    IFEQ 'N'                                                           234691
     C                     SETON                     50  40                                   234691
      *                                                                                       234691
      * Check that error code is not already in error array                                   234691
      *                                                                                       234691
     C********** ' 999'    LOKUP@EA                      03                            234691 235546
     C           ' W99'    LOKUP@EA                      03                                   235546
     C           *IN03     IFEQ '0'                                                           234691
     C**********           MOVEL' 999'    @EA,I                                        234691 235546
     C                     MOVEL' W99'    @EA,I                                               235546
     C                     ADD  1         I                                                   234691
     C                     ENDIF                                                              234691
     C                     ENDIF                                                              234691
     C                     ENDIF                                                              234691
     C                     ENDIF                                                              234691
     C/COPY WNCPYSRC,SE3000C011
      *
      * Validate price/yield/discount (default if blank)
      *
     C                     MOVE 'N'       WWRLPY  1                       S01496
     C           @PYDS     IFEQ *BLANKS                    B005
     C           @REF      IFNE *BLANKS                    B006
     C           @CLI      ORNE *BLANKS
     C           @NOM      ORNE *BLANKS
     C           @RVT      ORNE *BLANKS
     C           *IN70     IFEQ '0'                        B007
     C                     MOVEL@PYD      @PYDS
     C                     ELSE                            X007
     C                     MOVEL@PYD2     @PYDS
     C                     END                             E007
     C                     END                             E006
     C                     END                             E005
      *
     C                     MOVEL*BLANKS   ZFIELD
     C                     MOVE @PYDS     ZFIELD
     C                     Z-ADD7         ZADIG
     C                     Z-ADD8         ZADEC
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    @WK15
     C*                                                                   S01496
     C** Warning, if price is not within 10% of market price              S01496
     C*                                                                   S01496
     C           S01496    IFEQ 'Y'                                       S01496
     C                     MOVEL' '       SPRIC  17                       S01496
     C                     MOVE @PYDS     SPRIC                           S01496
     C                     MOVEL@SEC      WWPSSN                          S01496
     C                     EXSR SR50X                                     S01496
     C*                                                                   S01496
     C           RC50X     IFEQ 'Y'                                       S01496
     C                     SETON                     5043                 S01496
     C           ' W10'    LOKUP@EA                      03               S01496
     C           *IN03     IFEQ '0'                                       S01496
     C                     MOVEL' W10'    @EA,I                           S01496
     C                     ADD  1         I                               S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C*
     C*    .. if Discount and trade value date = maturity date            E21049
     C*                     price must be 0.                              E21049
     C*                                                                   E21049
     C           STBS      IFEQ 'D'                        B005           E21049
     C***********TDVD      ANDEQMATY                                E21049E37015
     C           RUND      ANDEQMATY                                      E37015
     C           @WK15     ANDNE0                                         E21049
     C***********          SETON                     5043           E21049E37015
     C                     SETON                     43                   E37015
     C           ' W01'    LOKUP@EA                      03               E37015
     C           *IN03     IFEQ '0'                                       E37015
     C                     MOVEL' W01'    @EA,I                           E21049
     C                     ADD  1         I                               E21049
     C                     END                                            E37015
     C           WARNIN    IFEQ 'N'                                       E37015
     C                     SETON                     49                   E37015
     C                     ELSE                                           E37015
     C                     SETOF                     49                   E37015
     C                     END                                            E37015
     C                     MOVEL'Y'       WARNIN                          E37015
     C                     END                             E005           E21049
      *                                                                   E21049
     C***********1000      MULT POWER8,8  WK100  150               E21049 064529
     C***********1000      MULT 10000000  WK100  150               064529 067527
     C***********1000      MULT POWER8,8  WK100  150               067527 136766
     C           1000      MULT 10000000  WK100  150                      136766
     C           *IN99     IFEQ '1'                        B005
     C           @PYDS     OREQ *BLANKS
     C           @WK15     OREQ 0
     C           STBS      ANDNE'D'                                       E21049
      *                                                                   E21049
      * For yield securities price should be less than, equal to 100%     E21049
      *                                                                   E21049
     C           STBS      OREQ 'Y'                                       E21049
     C           @WK15     ANDGTWK100                                     E21049
     C                     SETON                     50  43
     C                     SETON                     49                   E37015
     C                     MOVE 'Y'       WWRLPY                          S01496
      *
      * Check that error code is not already in error array
      *
     C           ' 106'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B006
     C                     MOVEL' 106'    @EA,I
     C                     ADD  1         I
     C                     END                             E006
     C                     ELSE                            X005
      *
      * If valid, then format for the screen
      *
     C                     MOVE ZFIELD    @PTPDY
     C                     MOVEL*BLANKS   ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @PYDS
      *
      * Calculate cost as price * nominal
      *
     C           *IN70     IFEQ '0'                        B006
     C***********@PNOML    MULT @PTPDY    @COST     H                     064529
     C           @PNOML    MULT @PTPDY    @COST     H                     067527
     C***********          Z-ADD@PNOML    ZNOML                    064529 067527
     C***********          Z-ADD@PTPDY    ZPRC                     064529 067527
     C***********          Z-ADD2         ZCDP                     064529 067527
     C***********          EXSR ZCNSD                              064529 067527
     C***********ZCONS     DIV  POWER8,DC @COST                    064529 067527
     C***********SPBS      IFEQ 'P'                                064529 067527
     C***********@COST     MULT 100       @COST                    064529 067527
     C***********          END                                     064529 067527
     C                     ADD  @COST     @TCOST
     C                     END                             E006
      *
     C                     END                             E005
     C*
     C** .. Warning, if the customer position would be short              S01496
     C*                                                                   S01496
     C           S01496    IFEQ 'Y'                                       S01496
     C           @TDTY     IFEQ 'TP'                                      S01496
     C           @PATRD    ANDEQ' '                                       S01496
     C           @TDTY     OREQ 'TP'                                      S01496
     C           @PATRD    ANDEQ'M'                                       S01496
     C           @TDTY2    OREQ 'TP'                                      S01496
     C           @PATRD    ANDEQ'C'                                       S01496
     C           BFCLAS    IFEQ 'S'                                       S01496
     C           BFCLAS    OREQ 'D'                                       S01496
     C*********            MOVELTDBA      WXTDBR  3                S01496 135344
     C                     MOVEL@BRCA     WXTDBR  3                       135344
     C                     MOVEL@SEC      SECUR                           S01496
     C*********            MOVEL@PNOML    WWNOML 150               S01496 135344
     C                     MOVEL@PNOML    XXNOML 110                      135344
     C                     Z-ADDXXNOML    WWNOML 150                      135344
     C                     EXSR SR50Y                                     S01496
     C           ERR50Y    IFEQ 'Y'                                       S01496
     C                     SETON                     5042                 S01496
     C           ' W11'    LOKUP@EA                      03               S01496
     C           *IN03     IFEQ '0'                                       S01496
     C                     MOVEL' W11'    @EA,I                           S01496
     C                     ADD  1         I                               S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C                     END                                            S01496
      *
      * Reset default values in parameter field if customer, nominal or
      * price has changed, and default values have been set up by
      * SE3002 (@PRECI <> blank)
      *
     C           @PRECI    IFNE *BLANKS                    B005
     C           @PTCNR    IFNE @OTCNR                     B006
     C           @PNOML    ORNE @ONOML
     C           @PTPDY    ORNE @OTPDY
      *
      * Save existing values
      *
     C                     MOVEL@PTBCC    @OTBCC                          069175
     C**********           Z-ADD@PTCNR    @OTCNR                                              CSD027
     C                     MOVE @PTCNR    @OTCNR                                              CSD027
     C                     Z-ADD@PNOML    @ONOML
     C                     Z-ADD@PTPDY    @OTPDY
     C                     Z-ADD@PTOSN    @OTOSN 110
     C                     MOVEL@PTDRF    @OREF   6
     C                     MOVE @PTDTP    @OTDTP  2
     C                     MOVE @PATRD    @OATRD  1
     C*
     C*  If its a market agency trade then subtract existing charges
     C*  from the accumulated amount
     C*
     C           @AGTR     IFEQ 'Y'                        B007
     C***********C1DI      ANDEQ'M'                                       S01117
     C           BFCLAS    ANDEQ'M'                                       S01117
     C*
     C                     SUB  @PTBCA    @CUMMC
     C***********          SUB  @PLTCA    @CUMMC                          S01176
     C***********          SUB  @PTPCA    @CUMMC                          S01176
     C                     SUB  @PTCA1    @CUMMC                          S01176
     C                     SUB  @PTCA2    @CUMMC                          S01176
     C                     END                             E007
      *
      * Reset parameter values
      *
     C                     EXSR SUB300
      *
      * Reset saved values
      *
     C**********           Z-ADD@OTCNR    @PTCNR                                              CSD027
     C                     MOVE @OTCNR    @PTCNR                                              CSD027
     C                     Z-ADD@ONOML    @PNOML
     C                     Z-ADD@OTPDY    @PTPDY
     C                     Z-ADD@OTOSN    @PTOSN
     C                     MOVEL@OREF     @PTDRF
     C                     MOVEL@OTDTP    @PTDTP
     C                     MOVEL@OATRD    @PATRD
     C                     MOVEL@OTBCC    @PTBCC                          069175
      *
     C                     END                             E006
     C                     END                             E005
      *
      * Save existing values for change comparison
      *
     C**********           Z-ADD@PTCNR    @OTCNR                                              CSD027
     C                     MOVE @PTCNR    @OTCNR                                              CSD027
     C                     Z-ADD@PNOML    @ONOML
     C                     Z-ADD@PTPDY    @OTPDY
      *
     C                     END                             E004
      *                                                                   S01448
      *  Set Review Bulk Trades to 'Review Bulk Trades Default'           S01448
      *  from SE ICD                                                      S01448
      *                                                                   S01448
     C           @RVT      IFEQ *BLANK                     B004           S01448
     C                     MOVE BVRVBT    @RVT                            S01448
     C                     END                             E004           S01448
     C**********           MOVE 'Y'       @RVT                                         234552 234691
     C/COPY WNCPYSRC,SE3000C002
      *
      **Review*trade*flag*must*be*Y*if*entered                            S01448
      * Review trade flag must be Y or N if entered                       S01448
      *
     C           @RVT      IFNE *BLANKS                    B004
     C           @RVT      ANDNE'Y'
     C           @RVT      ANDNE'N'                                       S01448
     C                     SETON                     50  44
      *
      * Check that error code is not already in error array
      *
     C           ' 107'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B005
     C                     MOVEL' 107'    @EA,I
     C                     ADD  1         I
     C                     END                             E005
      *                                                                   S01117
      * If blank and Originating Branch/user validation required and      S01117
      * review option has not been taken, check user's validation         S01117
      *                                                                   S01117
     C                     ELSE                                           S01117
     C           BKOBUV    IFEQ 'Y'                                       S01117
     C           @PORBR    ANDEQ*BLANKS                                   S01117
     C           @RVT      ANDNE'Y'                                       S01117
     C                     Z-ADD*ZERO     @ER                             S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM           @BRCA                           S01117
     C                     PARM           @ER                             S01117
     C*                                                                   S01117
     C           @ER       IFEQ 1                                         S01117
     C                     SETON                     5044                 S01117
     C           ' 305'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                                       S01117
     C                     MOVEL' 305'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     ELSE                                           S01117
     C           @ER       IFEQ 2                                         S01117
     C                     SETON                     5044                 S01117
     C           ' 306'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                                       S01117
     C                     MOVEL' 306'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C                     END                             E004
     C*                                                                   S01486
     C** Review trade must be 'Y' in insert mode                          S01486
     C*                                                                   S01486
     C           @ACTC     IFEQ 'I'                        B004           S01486
     C           @RVT      ANDNE'Y'                                       S01486
     C           FCPPPR    ANDEQ'Y'                                       S01486
     C           @POPO     ANDNE*BLANKS                                   092518
     C                     SETON                     50  44               S01486
     C*                                                                   S01486
     C** Check that error code is not already in error array              S01486
     C*                                                                   S01486
     C           ' 107'    LOKUP@EA                      03               S01486
     C           *IN03     IFEQ '0'                        B005           S01486
     C                     MOVEL' 107'    @EA,I                           S01486
     C                     ADD  1         I                               S01486
     C                     END                             E005           S01486
     C                     END                             E004           S01486
     C                     END                             E003
     C***********          END                                     S01117 101086
     C*                                                                   077621
     C** Do this validation after every changed record has been read from 111458
     C** the subfile to determine the real total TS & TP                  111458
     C*                                                                   111458
     C***********@AGTR     IFEQ 'Y'                                077621 111458
     C***********@NTOT2    ANDNE@NTOT1                     B003    077621 111458
     C************IN70     ANDEQ'1'                                077621 111458
     C***********          SETON                     50  42        077621 111458
     C***********                                                  077621 111458
     C***********          MOVEL'9'       @RETC                    077621 111458
     C***********          MOVEL@NTOT2    ZFLD15                   077621 111458
     C***********          Z-ADD0         ZDECS                    077620 111458
     C***********PROT      IFEQ '7'                                077620 111458
     C***********          Z-ADD4         ZDECS                    077620 111458
     C***********          END                                     077620 111458
     C***********          EXSR ZSEDIT                             077620 111458
     C***********          MOVE ZOUT20    @NOM5                    077620 111458
     C***********                                                  077621 111458
      * Check*that*error*code*is*not*already*in*error*array******  077621 111458
      ***********                                                  077621 111458
     C***********' 200'    LOKUP@EA                      03        077621 111458
     C************IN03     IFEQ '0'                        B005    077621 111458
     C***********          MOVEL' 200'    @EA,I                    077621 111458
     C***********          ADD  1         I                        077621 111458
     C***********          END                             E005    077621 111458
     C***********          END                             E003    077621 111458
      *
      * If error in record set SFLNXTCHG and return code so that SE3002
      * is not called on this cycle
      *
     C           *IN40     IFEQ '1'                        B003
     C           *IN41     OREQ '1'
     C           *IN42     OREQ '1'
     C           *IN43     OREQ '1'
     C           WARNIN    ANDEQ'N'                                       E37015
     C           *IN44     OREQ '1'
     C           RDSPLY    OREQ 'Y'                                       S01117
     C                     SETON                     26
     C*********************MOVEL'7'       @RETC                           E18010
     C                     MOVEL'9'       @RETC                           E18010
     C                     END                             E003
     C*                                                                   E37015
     C           *IN43     IFEQ '1'                                       E37015
     C           WARNIN    ANDEQ'Y'                                       E37015
     C           *IN49     ANDEQ'1'                                       E37015
     C           *IN26     IFEQ '1'                                       E37015
     C                     MOVEL'N'       WARNIN                          E37015
     C                     ELSE                                           E37015
     C                     SETON                     2650                 E37015
     C                     MOVEL'N'       WARNIN                          E37015
     C                     END                                            E37015
     C                     END                                            E37015
     C*                                                                   S01496
     C** If only warning errors exist and no change in nominal and        S01496
     C** price entered set error indicators off                           S01496
     C*                                                                   S01496
     C           *IN40     IFEQ '0'                        B003           S01496
     C           *IN41     ANDEQ'0'                                       S01496
     C           *IN44     ANDEQ'0'                                       S01496
     C***********CSE023    ANDEQ'N'                                CSE023 188410
     C***********CSE023    OREQ 'Y'                                CSE023 188410
     C************IN40     ANDEQ*OFF                               CSE023 188410
     C************IN44     ANDEQ*OFF                               CSE023 188410
     C*                                                                   S01496
     C           *IN42     IFEQ '0'                        B4             S01496
     C           *IN42     OREQ '1'                                       S01496
     C           WWRLNM    ANDEQ'N'                                       S01496
     C           @PNOML    ANDEQWSNOML                                    S01496
     C/COPY WNCPYSRC,SE3000C012
     C*                                                                   S01496
     C           *IN43     IFEQ '0'                        B5             S01496
     C           *IN43     OREQ '1'                                       S01496
     C           WWRLPY    ANDEQ'N'                                       S01496
     C           @PTPDY    ANDEQWSTPDY                                    S01496
     C                     SETOF                     265042               S01496
     C                     SETOF                     43                   S01496
     C                     MOVE *BLANKS   @RETC                           S01496
      ***********                                                  CSE023 188410
     C************IN41     IFEQ *ON                                CSE023 188410
     C***********WWCNUM    ANDEQ'Y'                                CSE023 188410
     C***********@PTCNR    ANDEQWSCNUM                             CSE023 188410
     C***********          MOVE *OFF      *IN41                    CSE023 188410
     C***********          ENDIF                                   CSE023 188410
      ***********                                                  CSE023 188410
     C                     END                             E5             S01496
     C                     END                             E4             S01496
     C                     END                             E3             S01496
      *
      * If this record is in error, and the SFLRCDNBR field has not yet
      * been set, set it to the record number of this record
      *
     C           @SFREC    IFEQ -1                         B003
     C           *IN50     ANDEQ'1'
     C                     Z-ADD@SFK      @SFREC
     C                     END                             E003
      *
      * If this record is valid, then perform processing for a valid
      * s/file record
      *
     C           *IN26     IFEQ '0'                        B003
      *
      * Store old trade ref and reset value in parameter
      *
     C                     MOVEL@PTDRF    @OTDRF  6
     C                     MOVEL@REF      @PTDRF
      *
      * If previous return code of 7, and review trade selected, and record
      * number not set, then set record number
      *
     C***********@RETC     IFEQ '7'                        B004           E18010
     C           @RETC     IFEQ '9'                        B004           E18010
     C           @RVT      ANDEQ'Y'                        B004
     C           @SFRC2    ANDEQ-1
     C                     Z-ADD@SFK      @SFRC2
     C                     END                             E004
      *
      * If review selected, and previous return code is not 7, then call
      * review program SE3002
      * If market agency trade call SE3002 to set up defaults
      * when trade has not been selected for review , and F9 has
      * not been pressed
      * If market trade has not been selected for review set up
      * action code parameter with 'N' for don't display defaults
      *
     C           *IN70     IFEQ '0'                        B004
     C           @AGTR     ANDEQ'Y'
     C           @RVT      ANDNE'Y'
     C           @INKI     ANDEQ'0'
      *
      * Check that it is not a changed subfile record                     S01176
      * which has been made completely blank                              S01176
      *
     C           @REF      ANDNE*BLANK                                    S01176
     C           @CLI      ANDNE*BLANK                                    S01176
     C           @NOM      ANDNE*BLANK                                    S01176
     C           @PYDS     ANDNE*BLANK                                    S01176
     C                     MOVEL@ACTC     @SVAC   1
     C                     MOVEL'N'       @ACTC
     C                     END                             E004
      *
     C           @ACTC     IFEQ 'N'                        B004
     C           @RVT      OREQ 'Y'
     C***********@RETC     ANDNE'7'                                       E18010
     C           @RETC     ANDNE'9'                                       E18010
      *
     C*  Amendment of first side of agency trade should be permitted.     S01448
     C*******   *@INKI     IFEQ '1'                        B005           S01448
     C***To*have*the*trade*displayed*as*protected*pass*an*action***       S01448
     C***code*of*'E'*to*se3002***                                         S01448
     C*******              MOVE @ACTC     @SVAC                           S01448
     C*******              MOVE 'E'       @ACTC                           S01448
     C*******              END                             E005           S01448
      *
      * If ret. code is 5 (F12 pressed), then recall
      *
     C           @RETC     DOUNE'5'                        B005
      *                                                                   S01448
      * For agency trade, pass common values from first trade if they     S01448
      * have been set up                                                  S01448
      * If value date cleared via F/9 and not reset, restore prior value. S01448
      * Conditioned on switchable feature S01448                       e. S01448
      *                                                                   S01448
     C           S01448    IFEQ 'Y'                        B006           S01448
     C           @PATRD    ANDEQ'C'                                       S01448
     C           ATDVD     IFEQ *ZERO                      B007           S01448
     C                     Z-ADDATDVDS    ATDVD                           S01448
     C                     END                             E007           S01448
     C           ATDDT     IFNE *ZERO                      B007           S01448
     C                     Z-ADDATDVD     @PTDVD                          S01448
     C                     Z-ADDATDDT     @PTDDT                          S01448
      * Second side always settles within Bank's depository, so:          S01448
     C**********           Z-ADDADEPOT    @PDELT                                       S01448 CSD027
     C**********           Z-ADDADEPOT    @PDELF                                       S01448 CSD027
     C                     MOVE ADEPOT    @PDELT                                              CSD027
     C                     MOVE ADEPOT    @PDELF                                              CSD027
     C                     MOVE ACLTY     @PCLTY                          S01448
     C                     END                             E007           S01448
     C                     END                             E006           S01448
     C/COPY WNCPYSRC,SE3000C003
     C                     MOVE *BLANKS   @PTLIA                                            AR871625
     C                     MOVE *ZERO     @PTAMT                                            AR871625
     C                     MOVE *ZERO     @PCAMT                                            AR871625
      *                                                                   S01448
     C                     CALL 'SE3002'               01
     C           @PARMR    PARM @PARMT    @PARMS
     C                     PARM @PRMT2    @PRMT2                                            AR871625
     C                     PARM @ACTC     @RETC   1
     C                     PARM           @CUMMC
     C                     PARM           @CUMMN
      *                                                                   S01401
      **  Extra parameter needed for MT5xx. This passes the trade ref     S01401
      **  & bulk ref to SE3002. The trade ref will be used as a key to    S01401
      **  pass the details from TRADSDX1 to SE1805. If associated         S01401
      **  details exist on TRADSDX2 then the details will be passed       S01401
      **  from SE3002 via SE1805 to SE1806. Bulk ref will be used to      S01401
      **  set up the Bulk ref field.                                      S01401
      *                                                                   S01401
     C                     PARM @TDRF     TRDRF   6                       S01401
     C                     PARM @BLKR     @BKRF   6                       S01401
     C*                                                                   S01448
     C*   Extra parameter for Bulk Input Enhancements to identify         S01448
     C*   a Cross Agency trade                                            S01448
     C*                                                                   S01448
     C                     PARM @CAGT     @CAGT   1                       S01448
      *                                                                   CSE006
      *   Extra parameter - Buy-Sell Back indicator                       CSE006
     C                     PARM           P@BYSL  1                       CSE006
      *                                                                   CSE006
      ** New parameter - Set up clearance type flag.                                          205667
      *                                                                                       205667
     C                     PARM           CLRTYP  1                                           205667
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE3000CCP2                                           S01408
     C*                                                                   S01408
      *
      *  Reset value of @ACTC field if market trade not requested
      *  for review                                                       S01448
      ***for*review*or*review*is*following*F9***                          S01448
     C***********@INKI     IFEQ '1'                        B006           S01448
     C***********@ACTC     OREQ 'N'                        B006           S01448
     C           @ACTC     IFEQ 'N'                        B006           S01448
     C                     MOVEL@SVAC     @ACTC
     C                     END                             E006
      *
     C           *IN01     IFEQ '1'                        B006
     C                     Z-ADD12        @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 12 *
     C                     MOVEL'SE3002'  @DBKEY           ***************
     C***********          EXSR SUB999                                    S01117
     C                     EXSR *PSSR                                     S01117
     C                     END                             E006
      *
     C                     END                             E005
      *
      * Set 'SE3002 called' flag
      *
     C                     MOVEL'Y'       @S3002
      *
      * If error return code, terminate program
      *
     C           @RETC     IFEQ '*'                        B005
     C                     DUMP
     C/COPY WNCPYSRC,SE3000C004
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END                             E005
      *
      **If*return*code*is*not*1,*update*parameter                         S01448
      * If return code is not 3, update parameter                         S01448
      *
     C***********@RETC     IFNE '1'                        B005           E24723
     C           @RETC     IFNE '3'                        B005           E24723
     C                     MOVEL@PARMR    @PARMT
     C                     ELSE                                           S01486
     C           FCPPPR    IFEQ 'Y'                                       S01486
     C                     MOVE '1'       *INKC                           S01486
     C                     EXSR SUB304                                    S01486
     C                     EXSR SUB800                                    S01486
     C/COPY WNCPYSRC,SE3000C005
     C                     SETON                     LR                   S01486
     C                     RETRN                                          S01486
     C                     END                                            S01486
     C                     END                                            S01117
      *                                                                   S01448
      * Save common agency trade values, if market trade and defaults  .  S01448
      * have not already been set up                                   .  S01448
      *                                                                   S01448
     C           @PATRD    IFEQ 'M'                        B005           S01448
     C           ATDVD     ANDEQ*ZERO                                     S01448
     C                     Z-ADD@PTDVD    ATDVD   50                      S01448
     C                     Z-ADD@PTDVD    ATDVDS  50                      S01448
     C                     Z-ADD@PTDDT    ATDDT   50                      S01448
      * Second side always settles within Bank's depository, so:          S01448
     C           @PTDTP    IFEQ 'TP'                       B006           S01448
     C**********           Z-ADD@PDELT    ADEPOT  60                                   S01448 CSD027
     C                     MOVE @PDELT    ADEPOT  6                                           CSD027
     C                     ELSE                                           S01448
     C**********           Z-ADD@PDELF    ADEPOT  60                                   S01448 CSD027
     C                     MOVE @PDELF    ADEPOT  6                                           CSD027
     C                     END                             E006           S01448
     C           @PCLTY    IFEQ '2'                        B006           S01448
     C                     MOVE '1'       ACLTY   1                       S01448
     C                     ELSE                            X006           S01448
     C           @PCLTY    IFEQ '4'                        B007           S01448
     C                     MOVE '3'       ACLTY                           S01448
     C                     ELSE                            X007           S01448
     C                     MOVE @PCLTY    ACLTY                           S01448
     C                     END                             E007           S01448
     C                     END                             E006           S01448
     C/COPY WNCPYSRC,SE3000C008
     C                     END                             E005           S01448
      *                                                                   S01117
      * Check whether user is authorised to the Originating Branch if     S01117
      * required, as it may not have been checked in SE3002               S01117
      *                                                                   S01117
     C           BKOBUV    IFEQ 'Y'                                       S01117
     C           @PORBR    IFEQ *BLANKS                                   S01117
     C                     MOVE @BRCA     BRCH                            S01117
     C                     ELSE                                           S01117
     C                     MOVE @PORBR    BRCH                            S01117
     C                     END                                            S01117
     C                     Z-ADD*ZERO     @ER                             S01117
     C                     CALL 'ZVOBU'                                   S01117
     C                     PARM           BRCH    3                       S01117
     C                     PARM           @ER                             S01117
     C*                                                                   S01117
     C           @ER       IFEQ 1                                         S01117
     C                     SETON                     504426               S01117
     C                     MOVE *BLANKS   @PORBR                          S01117
     C           ' 305'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                                       S01117
     C                     MOVEL' 305'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     ELSE                                           S01117
     C           @ER       IFEQ 2                                         S01117
     C                     MOVE *BLANKS   @PORBR                          S01117
     C                     SETON                     504426               S01117
     C           ' 306'    LOKUP@EA                      03               S01117
     C           *IN03     IFEQ '0'                                       S01117
     C                     MOVEL' 306'    @EA,I                           S01117
     C                     ADD  1         I                               S01117
     C                     END                                            S01117
     C                     END                                            S01117
     C                     END                                            S01117
      *
     C                     END                             E005
      *
      * Reset review flag
      *
     C                     MOVEL*BLANKS   @RVT
      *
     C                     END                             E004
      *
      * If action is I then update file and s/file
      *
     C           @ACTC     IFEQ 'I'                        B004
     C           *IN26     ANDEQ'0'                                       S01117
      *
      * Delete entered records if ref has changed
      *
     C           @OTDRF    IFNE *BLANKS                    B005
     C           @OTDRF    ANDNE@REF
     C           @OTDRF    CHAINBULKR                01
     C           *IN01     IFEQ '1'                        B006
     C                     Z-ADD13        @DBASE           ***************
     C                     MOVEL'BULKR'   @DBFIL           * DB ERROR 13 *
     C                     MOVEL@PTDRF    @DBKEY           ***************
     C***********          EXSR SUB999                                    S01117
     C                     EXSR *PSSR                                     S01117
     C                     END                             E006
     C***********          MOVEL'*'       RECI                            048483
     C***********          UPDATBULKTDF                                   048483
     C                     DELETBULKTDF                                   048483
     C/COPY WNCPYSRC,SE3000C024
     C                     EXSR SUB401                     Commit
     C                     END                             E005
      *
      * If reference entered, insert/update record
      *
     C           @REF      IFNE *BLANKS                    B005
     C           @REF      CHAINBULKR                01
     C                     MOVEL@PARMT    @BLKDS
     C                     Z-ADD@PWHTX    WHTXA                           187727
     C                     MOVE @PBWDI    BWDI                            187727
     C                     Z-ADD@PFSPR    FSPR                                                233607
     C                     Z-ADD@PFSPP    FSPP                                                233607
     C           *IN01     IFEQ '0'                        B006
     C                     UPDATBULKTDF
     C                     ELSE                            X006
     C/COPY WNCPYSRC,SE3000C025
     C                     WRITEBULKTDF
     C                     END                             E006
     C           CER049    IFEQ 'Y'                                                         AR871625
     C                     MOVE @PTDRF    TQTDRF                                            AR871625
     C                     MOVE @PTDBA    TQTDBA                                            AR871625
     C                     MOVE *BLANKS   TQFRID                                            AR871625
     C                     MOVE @PTLIA    TQTAX                                             AR871625
     C                     Z-ADD@PTAMT    TQSTAF                                            AR871625
     C                     Z-ADDBJRDNB    TQCDTE                                            AR871625
     C           TQTDRF    CHAINTRADSQL0             01                                     AR871625
     C           *IN01     IFEQ '0'                                                         AR871625
     C                     UPDATTRADSQD0                                                    AR871625
     C                     ELSE                                                             AR871625
     C                     WRITETRADSQD0                                                    AR871625
     C                     ENDIF                                                            AR871625
      *                                                                                     AR871625
     C                     MOVEL'SECURITY'U#ORGN 10                                         AR871625
     C                     MOVE *BLANKS   U#TYPE  4                                         AR871625
     C**********           MOVE *BLANKS   U#LNRF  60                                 AR871625 CLE148
     C                     MOVE *BLANKS   U#LNRF  6                                           CLE148
     C                     MOVE *BLANKS   U#FCNM  6                                         AR871625
     C                     MOVE *BLANKS   U#FACT  30                                        AR871625
     C                     MOVE *BLANKS   U#FCNO  20                                        AR871625
     C                     MOVE *BLANKS   U#FSEQ  20                                        AR871625
     C                     MOVE *BLANKS   U#ORED  50                                        AR871625
     C                     MOVE *BLANKS   U#DLNO  60                                        AR871625
     C                     MOVE TQTDRF    U#TDRF  6                                         AR871625
     C                     MOVE *BLANKS   U#BRCA  3                                         AR871625
     C                     MOVE *BLANKS   U#CNUM  6                                         AR871625
     C                     MOVE *BLANKS   U#CCY   3                                         AR871625
     C                     MOVE *BLANKS   U#ACOD 100                                        AR871625
     C                     MOVE *BLANKS   U#ACSQ  20                                        AR871625
     C                     MOVE *BLANKS   U#PREF 15                                         AR871625
     C                     MOVE *BLANKS   U#CQSQ  20                                        AR871625
     C                     MOVE *BLANKS   U#PBRC  3                                         AR871625
     C                     MOVE *BLANKS   U#PSSH 10                                         AR871625
     C                     MOVE *BLANKS   U#PCPT  6                                         AR871625
     C                     MOVE *BLANKS   U#PDUD  50                                        AR871625
     C                     MOVE *BLANKS   U#PEVT  2                                         AR871625
      *                                                                                     AR871625
     C           KLSTXD    KLIST                                                            AR871625
     C                     KFLD           U#ORGN                                            AR871625
     C                     KFLD           U#TYPE                                            AR871625
     C                     KFLD           U#LNRF                                            AR871625
     C                     KFLD           U#FCNM                                            AR871625
     C                     KFLD           U#FACT                                            AR871625
     C                     KFLD           U#FCNO                                            AR871625
     C                     KFLD           U#FSEQ                                            AR871625
     C                     KFLD           U#ORED                                            AR871625
     C                     KFLD           U#DLNO                                            AR871625
     C                     KFLD           U#TDRF                                            AR871625
     C                     KFLD           U#BRCA                                            AR871625
     C                     KFLD           U#CNUM                                            AR871625
     C                     KFLD           U#CCY                                             AR871625
     C                     KFLD           U#ACOD                                            AR871625
     C                     KFLD           U#ACSQ                                            AR871625
     C                     KFLD           U#PREF                                            AR871625
     C                     KFLD           U#CQSQ                                            AR871625
     C                     KFLD           U#PBRC                                            AR871625
     C                     KFLD           U#PSSH                                            AR871625
     C                     KFLD           U#PCPT                                            AR871625
     C                     KFLD           U#PDUD                                            AR871625
     C                     KFLD           U#PEVT                                            AR871625
      *                                                                                     AR871625
     C                     MOVEL'SECURITY'T2KEY                                             AR871625
     C                     MOVE TQTDRF    T2TDRF                                            AR871625
     C                     MOVE 'T'       T2RCTP                                            AR871625
     C                     MOVE TQCDTE    T2CDTE                                            AR871625
     C                     Z-ADD@PCAMT    T2GROS                                            AR871625
     C                     MOVE TQTAX     T2TCAL                                            AR871625
     C                     MOVE TQSTAF    T2TATC                                            AR871625
     C                     MOVE 'Y'       T2STFC                                            AR871625
     C                     Z-ADDBJRDNB    T2LCD                                             AR871625
      *                                                                                     AR871625
     C           KLSTXD    CHAINSDSTMDL0             01                                     AR871625
     C           *IN01     IFEQ '0'                                                         AR871625
     C                     MOVE 'A'       T2TYLC                                            AR871625
     C                     UPDAT@STMDV0                                                     AR871625
     C                     ELSE                                                             AR871625
     C                     MOVE 'I'       T2TYLC                                            AR871625
     C                     WRITE@STMDV0                                                     AR871625
     C                     ENDIF                                                            AR871625
     C                     ENDIF                                                            AR871625
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE3000CCP3                                           S01408
     C*                                                                   S01408
     C                     EXSR SUB401                     Commit
     C                     MOVEL'Y'       @UPD
     C                     END                             E005
     C                     END                             E004
      *
     C                     END                             E003
     C/COPY WNCPYSRC,SE3000C018
      *
      * If review trade selected but return code of 7, set SFLNXTCHG so
      * that record is processed on the next call
      *
     C           @RVT      IFEQ 'Y'                        B003
     C***********@RETC     ANDEQ'7'                                       E18010
     C           @RETC     ANDEQ'9'                                       E18010
     C                     SETON                     26  08
     C                     END                             E003
      *
      * Update s/file record
      *
     C           *IN70     IFEQ '0'                        B003
     C*                                                                   S01448
     C* Save validation error indicators to be restored in SUB200         S01448
     C*                                                                   S01448
     C                     MOVE *IN40     @IN40                           S01448
     C                     MOVE *IN41     @IN41                           S01448
     C                     MOVE *IN42     @IN42                           S01448
     C                     MOVE *IN43     @IN43                           S01448
     C                     MOVE *IN44     @IN44                           S01448
     C                     MOVE @IND      @INDS                           S01448
     C*                                                                   S01448
     C                     UPDATSE3000F0
     C                     ELSE                            X003
     C*                                                                   111458
     C** Do this validation after every changed record has been read from 111458
     C** the subfile to determine the real total TS & TP                  111458
     C*                                                                   111458
     C***********@NTOT1    IFNE @NTOT2                     B003           111458
     C***********          MOVEL@NTOT2    ZFLD15                   077620 111458
     C***********          Z-ADD0         ZDECS                    077620 111458
     C***********PROT      IFEQ '7'                                077620 111458
     C***********          Z-ADD4         ZDECS                    077620 111458
     C***********          END                                     077620 111458
     C***********          EXSR ZSEDIT                             077620 111458
     C***********          MOVE ZOUT20    @NOM5                    077620 111458
     C***********                                                  077621 111458
     C***********          SETON                     50            077621 111458
     C***********' 200'    LOKUP@EA                      03        077621 111458
     C************IN03     IFEQ '0'                        B005    077621 111458
     C***********          MOVEL' 200'    @EA,I                    077621 111458
     C***********          ADD  1         I                        077621 111458
     C***********          END                             E005    077621 111458
     C***********          SETON                     26  08        077621 111458
     C***********          MOVE 'Y'       RDSPLY                   077621 111458
     C***********          MOVEL'9'       @RETC                    077621 111458
     C***********          END                             E003    077621 111458
     C                     UPDATSE3000F3
     C                     END                             E003
      *
     C                     END                             E002
     C                     END                             E001
      *
      **Error*codes*if*blank************************************   E21048 S01117
      ***********                                                         S01117
     C***********@REF      IFEQ *BLANKS                            E21048 S01117
     C***********@CLI      ANDEQ*BLANKS                            E21048 S01117
     C***********@NOM      ANDEQ*BLANKS                            E21048 S01117
     C***********@PYDS     ANDEQ*BLANKS                            E21048 S01117
     C***********          SETON                     504041        E21048 S01117
     C***********          SETON                     424326        E21048 S01117
     C***********          MOVEL' 100'    @EA,I                    E21048 S01117
     C***********          ADD  1         I                        E21048 S01117
     C***********          MOVEL' 103'    @EA,I                    E21048 S01117
     C***********          ADD  1         I                        E21048 S01117
     C***********          MOVEL' 104'    @EA,I                    E21048 S01117
     C***********          ADD  1         I                        E21048 S01117
     C***********          MOVEL' 106'    @EA,I                    E21048 S01117
     C***********          ADD  1         I                        E21048 S01117
     C***********          END                                     E21048 S01117
      *
      * If at the end of validation the SFLRCDNBR field has not been set,
      * set it value in @SFRC2 (first review outstanding) or 1 if that
      * field has not been set
      *
     C           @SFREC    IFEQ -1                         B001
     C           @SFRC2    IFNE -1                         B002
     C                     Z-ADD@SFRC2    @SFREC
     C                     ELSE                            X002
     C                     Z-ADD1         @SFREC
     C                     END                             E002
      *
      * If s/file 2 is being processed, check that total of nominals
      * entered agrees with total on s/file 1
      *
     C           RDSPLY    IFEQ 'N'                                       S01117
     C           *IN70     IFEQ '1'                        B002
     C           @NTOT1    IFNE @NTOT2                     B003
     C                     MOVEL@NTOT2    ZFLD15                          077620
     C                     Z-ADD0         ZDECS                           077620
     C           PROT      IFEQ '7'                                       077620
     C                     Z-ADD4         ZDECS                           077620
     C                     END                                            077620
     C                     EXSR ZSEDIT                                    077620
     C                     MOVE ZOUT20    @NOM5                           077620
     C*                                                                   077620
     C                     SETON                     50
     C           ' 200'    LOKUP@EA                      03               077621
     C           *IN03     IFEQ '0'                        B005           077621
     C                     MOVEL' 200'    @EA,I
     C                     ADD  1         I
     C                     END                             E005           077621
     C                     END                             E003
     C                     ELSE                            X002
      *
      * Total of nominals for s/file 1 must be non-zero if action is
      * insert
      *
     C           @NTOT1    IFEQ 0                          B003
     C           @ACTC     ANDEQ'I'
     C                     SETON                     50
     C                     MOVEL' 201'    @EA,I
     C                     ADD  1         I
     C                     END                             E003
     C                     END                             E002
     C                     END                             E001
     C                     END                                            S01117
      *
     C                     ENDSR                           SUB202 ends
      *****************************************************************
      /EJECT
     C*****************************************************************   081490
     C*                                                               *   081490
     C*  WBLOCK - Subroutine to check blocks in validation            *   081490
     C*                                                               *   081490
     C*****************************************************************   081490
     C*                                                                   081490
     C           WBLOCK    BEGSR                                          081490
      *                                                                   CSE007
      ***  If Corporate Actions feature is installed.                     CSE007
      ***  or if Securities Redenomination feature is installed.          CEU017
      *                                                                   CSE007
     C           CSE007    IFEQ 'Y'                                       CSE007
     C           CEU017    OREQ 'Y'                                       CEU017
      *                                                                   CSE007
      ***  Search if there is Corporate Actions General Block for         CSE007
      ***  Customer.                                                      CSE007
      *                                                                   CSE007
     C                     MOVE 'Y'       SE6714                          CSE007
     C                     CALL 'SE7574'                                  CSE007
     C                     PARM           @BRCA                           CSE007
     C                     PARM           @CNUM   6                       CSE007
     C                     PARM           @PTFR   4                       CSE007
     C                     PARM           @PPGB   1                       CSE007
     C                     PARM           @PSGB   1                       CSE007
      *                                                                   CSE007
      ***  If block found, send error message and setup work field to     CSE007
      ***  not call SE6714.                                               CSE007
      *                                                                   CSE007
     C           @PPGB     IFEQ 'Y'                                       CSE007
     C           WTDTY     ANDEQ'TP'                                      CSE007
     C           @PSGB     OREQ 'Y'                                       CSE007
     C           WTDTY     ANDEQ'TS'                                      CSE007
     C                     SETON                     50  42               CSE007
     C                     MOVEL' CO2'    @EA,I                           CSE007
     C                     ADD  1         I                               CSE007
     C                     MOVE 'N'       SE6714                          CSE007
     C                     MOVE 'Y'       WWRLNM                          CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CSE007
      ***  If Corporate Actions feature is switched OFF or Corporate      CSE007
      ***  Actions General Block for Customer not found.                  CSE007
      *                                                                   CSE007
     C           SE6714    IFEQ 'Y'                                       CSE007
     C*                                                                   081490
     C**   .... search if there is General Block for Customer             081490
     C*                                                                   081490
     C                     CALL 'SE6714'                                  081490
     C******               PARM           @BRCD   3                081490 CSE007
     C                     PARM           @BRCA                           CSE007
     C                     PARM           @CNUM   6                       081490
     C                     PARM           @PTFR   4                       081490
     C                     PARM           @PPGB   1                       081490
     C                     PARM           @PSGB   1                       081490
     C*                                                                   081490
     C           @PPGB     IFEQ 'Y'                                       081490
     C           WTDTY     ANDEQ'TP'                                      081490
     C           @PSGB     OREQ 'Y'                                       081490
     C           WTDTY     ANDEQ'TS'                                      081490
     C                     SETON                     50  42               081490
     C                     MOVEL' WR2'    @EA,I                           081490
     C                     ADD  1         I                               081490
     C                     ENDIF                                          081490
      *                                                                   CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CSE007
      ***  If Corporate Actions feature is installed.                     CSE007
      ***  or if Securities Redenomination feature is installed.          CEU017
      *                                                                   CSE007
     C           CSE007    IFEQ 'Y'                                       CSE007
     C           CEU017    OREQ 'Y'                                       CEU017
      *                                                                   CSE007
      ***  Search if there is Corporate Actions Specific Block for        CSE007
      ***  Customer and Security.                                         CSE007
      *                                                                   CSE007
     C                     MOVE 'Y'       SE6710                          CSE007
     C                     MOVE RUND      @RDNB   5                       CSE007
     C                     CALL 'SE7570'                                  CSE007
     C                     PARM           @RDNB                           CSE007
     C                     PARM           @OBPO                           CSE007
     C                     PARM           @BRCA                           CSE007
     C                     PARM           @SEC                            CSE007
     C                     PARM           @CNUM                           CSE007
     C                     PARM           @PTFR                           CSE007
     C                     PARM           @BLTY                           CSE007
     C                     PARM           @NOBL  13                       CSE007
     C**********           PARM           @NOPO  13                                 CSE007 AR1075401
     C                     PARM           @NOPO  15                                        AR1075401
      *                                                                   CSE007
     C                     MOVE @NOBL     WWNOBL 130                      CSE007
     C**********           MOVE @NOPO     WWNOPO 130                                CSE007 AR1075401
     C                     MOVE @NOPO     WWNOPO 150                                       AR1075401
      *                                                                   CSE007
      ***  If block found, send error message and setup work field to     CSE007
      ***  not call SE6710.                                               CSE007
      *                                                                   CSE007
     C           WWNOBL    IFEQ *HIVAL                                    CSE007
     C                     SETON                     50  42               CSE007
     C                     MOVEL' CO3'    @EA,I                           CSE007
     C                     ADD  1         I                               CSE007
     C                     MOVE 'N'       SE6710                          CSE007
     C                     MOVE 'Y'       WWRLNM                          CSE007
     C                     ELSE                                           CSE007
      *                                                                   CSE007
     C           WWNOBL    IFNE *ZEROS                                    CSE007
     C           WTDTY     IFEQ 'TP'                                      CSE007
     C           WWNOPO    SUB  @WK15     WWFONO 130                      CSE007
     C           WWFONO    IFLT WWNOBL                                    CSE007
     C                     SETON                     50  42               CSE007
     C                     MOVEL' CO4'    @EA,I                           CSE007
     C                     ADD  1         I                               CSE007
     C                     MOVE 'N'       SE6710                          CSE007
     C                     MOVE 'Y'       WWRLNM                          CSE007
     C                     ENDIF                                          CSE007
     C                     ELSE                                           CSE007
      *                                                                   CSE007
     C           WWNOPO    ADD  @WK15     WWFONO                          CSE007
     C           WWFONO    IFGT WWNOBL                                    CSE007
     C                     SETON                     50  42               CSE007
     C                     MOVEL' CO4'    @EA,I                           CSE007
     C                     ADD  1         I                               CSE007
     C                     MOVE 'N'       SE6710                          CSE007
     C                     MOVE 'Y'       WWRLNM                          CSE007
     C                     ENDIF                                          CSE007
     C                     ENDIF                                          CSE007
     C                     ENDIF                                          CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CSE007
      ***  If Corporate Actions feature is switched OFF or Corporate      CSE007
      ***  Actions Specific Block for Customer and Security not found.    CSE007
      *                                                                   CSE007
     C           SE6710    IFEQ 'Y'                                       CSE007
     C*                                                                   081490
     C**   ... search if there is Specific Block for Customer and Secty   081490
     C*                                                                   081490
     C                     MOVE RUND      @RDNB   5                       081490
     C                     CALL 'SE6710'                                  081490
     C                     PARM           @RDNB                           081490
     C                     PARM           @OBPO                           081490
     C******               PARM           @BRCD                    081490 CSE007
     C                     PARM           @BRCA                           CSE007
     C                     PARM           @SEC                            081490
     C                     PARM           @CNUM                           081490
     C                     PARM           @PTFR                           081490
     C                     PARM           @BLTY                           081490
     C                     PARM           @NOBL  13                       081490
     C**********           PARM           @NOPO  13                                 081490 AR1075401
     C                     PARM           @NOPO  15                                        AR1075401
     C                     PARM           @COLF                           CGL011
     C                     PARM *BLANKS   @COLA  15                       CGL011
     C*                                                                   081490
     C                     MOVE @NOBL     WWNOBL 130                      081490
     C**********           MOVE @NOPO     WWNOPO 130                                081490 AR1075401
     C                     MOVE @NOPO     WWNOPO 150                                       AR1075401
      *                                                                   CGL011
     C           @COLF     IFEQ 'Y'                                       CGL011
     C           @PTDTP    ANDEQ'TP'                                      CGL011
     C           @COLA     ANDNE*ZEROS                                    CGL011
     C                     MOVE @COLA     WWCOLL 150                      CGL011
     C           WWNOPO    SUB  @WW15     WCOLLA 150                      CGL011
     C           WCOLLA    IFLT WWCOLL                                    CGL011
     C           ' W30'    LOKUP@EA                      03               CGL011
     C           *IN03     IFEQ *OFF                                      CGL011
     C                     MOVE *ON       *IN50                           CGL011
     C                     MOVEL' W30'    @EA,I                           CGL011
     C                     ADD  1         I                               CGL011
     C                     ENDIF                                          CGL011
     C                     ENDIF                                          CGL011
     C                     ENDIF                                          CGL011
     C*                                                                   081490
     C           WWNOBL    IFEQ *HIVAL                                    081490
     C                     SETON                     50  42               081490
     C                     MOVEL' WR3'    @EA,I                           081490
     C                     ADD  1         I                               081490
     C                     ELSE                                           081490
     C*                                                                   081490
     C           WWNOBL    IFNE *ZEROS                                    081490
     C           WTDTY     IFEQ 'TP'                                      081490
     C***********WWNOPO    SUB  @WW15     WWFONO 130                081490085801
     C           WWNOPO    SUB  @WK15     WWFONO 130                      085801
     C           WWFONO    IFLT WWNOBL                                    081490
     C                     SETON                     50  42               081490
     C                     MOVEL' WR4'    @EA,I                           081490
     C                     ADD  1         I                               081490
     C                     ENDIF                                          081490
     C                     ELSE                                           081490
     C*                                                                   081490
     C***********WWNOPO    ADD  @WW15     WWFONO                    081490085801
     C           WWNOPO    ADD  @WK15     WWFONO                          085801
     C           WWFONO    IFGT WWNOBL                                    081490
     C                     SETON                     50  42               081490
     C                     MOVEL' WR4'    @EA,I                           081490
     C                     ADD  1         I                               081490
     C                     ENDIF                                          081490
     C                     ENDIF                                          081490
     C                     ENDIF                                          081490
     C                     ENDIF                                          081490
      *                                                                   CSE007
     C                     ENDIF                                          CSE007
     C*                                                                   081490
     C           WBEND     ENDSR                                          081490
     C*                                                                   081490
     C/EJECT                                                              081490
      *****************************************************************
      *                                                               *
      *  SUB203 - Add a page of records to s/file 1                   *
      *                                                               *
      *****************************************************************
      *
     C           SUB203    BEGSR
      *
      * Set s/file key to current record count, set record to display
      * to record count + 1
      *
     C                     Z-ADD@SF1R     @SFK
     C           @SF1R     ADD  1         @SFREC
      *
      * Reset s/file fields and indicators
      *
     C                     Z-ADD0         @COST
     C                     MOVEL*BLANKS   @DLFG
     C                     MOVEL*BLANKS   @REF
     C                     MOVEL*BLANKS   @CLI
     C                     MOVEL*BLANKS   @NOM
     C                     MOVEL*BLANKS   @PYDS
     C                     MOVEL*BLANKS   @TT
     C                     MOVEL*BLANKS   @RVT
     C                     SETOF                     262728
     C                     SETOF                     404142
     C                     SETOF                     43  44
      *                                                                   069175
      * Save Broker Commission Code                                       069175
     C                     MOVEL@PTBCC    @OTBCC                          069175
      *
      * Reset parameter fields
      *
     C                     EXSR SUB300
     C                     MOVEL@TDTY     @PTDTP
      *                                                                   069175
      * Reset Broker Commission Code                                      069175
     C                     MOVEL@OTBCC    @PTBCC                          069175
      *                                                                   069175
     C           @AGTR     IFEQ 'Y'                        B001
     C                     MOVEL'M'       @PATRD
     C                     END                             E001
      *
      * Write a page of records
      *
     C                     DO   14                         B001
     C                     ADD  1         @SFK
     C                     WRITESE3000F0
     C                     END                             E001
      *
      * Reset record count
      *
     C                     Z-ADD@SFK      @SF1R
      *
     C                     ENDSR                           SUB203 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB204 - Add a page of records to s/file 2                   *
      *                                                               *
      *****************************************************************
      *
     C           SUB204    BEGSR
      *
      * Set s/file key to current record count, set record to display
      * to record count + 1
      *
     C                     Z-ADD@SF2R     @SFK
     C           @SF2R     ADD  1         @SFREC
      *
      * Reset s/file fields and indicators
      *
     C                     MOVEL*BLANKS   @REF
     C                     MOVEL*BLANKS   @CLI
     C                     MOVEL*BLANKS   @NOM
     C                     MOVEL*BLANKS   @PYDS
     C                     MOVEL*BLANKS   @RVT
     C                     SETOF                     264041
     C                     SETOF                     424344
      *                                                                   069175
      * Save Broker Commission Code                                       069175
     C                     MOVEL@PTBCC    @OTBCC                          069175
      *
      * Reset parameter fields
      *
     C                     EXSR SUB300
     C                     MOVEL@TDTY2    @PTDTP
     C                     MOVEL'C'       @PATRD
      *                                                                   069175
      * Reset Broker Commission Code                                      069175
     C                     MOVEL@OTBCC    @PTBCC                          069175
      *
      * Write a page of records
      *
     C                     DO   14                         B001
     C                     ADD  1         @SFK
     C                     WRITESE3000F3
     C                     END                             E001
      *
      * Reset record count
      *
     C                     Z-ADD@SFK      @SF2R
      *
     C                     ENDSR                           SUB204 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB300 - Initialize fields in parameter                      *
      *                                                               *
      *****************************************************************
      *
     C           SUB300    BEGSR
      *
     C                     MOVEL*BLANKS   @PARMT
      *
     C**********           Z-ADD0         @PTCNR                                              CSD027
     C                     MOVE *BLANKS   @PTCNR                                              CSD027
     C                     Z-ADD0         @PNOML
     C                     Z-ADD0         @PTPDY
     C                     Z-ADD0         @PTDVD
     C***********          Z-ADD0         @PTDBR                          S01117
     C                     Z-ADD0         @PTDDT
     C                     Z-ADD0         @PTCAP
     C                     Z-ADD0         @PTCFC
     C                     Z-ADD0         @PDADJ
     C                     Z-ADD0         @PITRA
     C                     Z-ADD0         @PTINA
     C                     Z-ADD0         @PTDCR
     C                     Z-ADD0         @PPRIC
     C                     Z-ADD0         @PRALL
     C                     Z-ADD0         @PTDER
     C                     Z-ADD0         @PTBCR
     C                     Z-ADD0         @PSMTH
     C***********          Z-ADD0         @PPYFB                          S01117
     C***********          Z-ADD0         @PPYTB                          S01117
     C                     Z-ADD0         @PASNM
     C**********           Z-ADD0         @PDELT                                              CSD027
     C**********           Z-ADD0         @PDELF                                              CSD027
     C                     MOVE *BLANKS   @PDELT                                              CSD027
     C                     MOVE *BLANKS   @PDELF                                              CSD027
     C                     Z-ADD0         @PTBCA
     C                     Z-ADD0         @PTCCA
     C                     Z-ADD0         @PTCA1
     C                     Z-ADD0         @PTCA2
     C                     Z-ADD0         @PTCA3
     C                     Z-ADD0         @PTCA4                          S01176
     C                     Z-ADD0         @PTCA5                          S01176
     C                     Z-ADD0         @PTCA6                          S01176
     C                     Z-ADD0         @PTCA7                          S01176
     C                     Z-ADD0         @PTAXA                          S01176
     C                     Z-ADD0         @PBCMR                          S01176
     C                     Z-ADD0         @PCCMR                          S01176
     C                     Z-ADD0         @PTXRB                          S01176
     C                     Z-ADD0         @PTIME                          S01176
     C***********          Z-ADD0         @PTLTA                          S01176
     C***********          Z-ADD0         @PTOCA                          S01176
     C                     Z-ADD0         @PTOSN
     C                     Z-ADD0         @PTNSN
     C                     Z-ADD0         @PTNSP
     C                     Z-ADD0         @PTOSV
     C                     Z-ADD0         @PTVSN
     C                     Z-ADD0         @PTVSP
     C                     Z-ADD0         @PTDSN
     C                     Z-ADD0         @PTDSP
     C                     Z-ADD0         @PTDFS
     C                     Z-ADD0         @PTSSQ
     C                     Z-ADD0         @PTCSR
     C                     Z-ADD0         @PTCTR
     C                     Z-ADD0         @PTDMC
     C                     Z-ADD0         @PLSWS                          S01117
     C***********          Z-ADD0         @PLTCA                          S01176
     C***********          Z-ADD0         @PTPCA                          S01176
     C***********          Z-ADD0         @PTVCA                          S01176
     C                     Z-ADD0         @PSPXR                          S01486
     C                     Z-ADD0         @PFXMP                          CAC002
     C                     Z-ADD0         @PFXMR                          CAC002
     C                     Z-ADD0         @PMAMT                          CAC002
     C                     Z-ADD0         @PFSPR                                              233607
     C                     Z-ADD0         @PFSPP                                              233607
     C                     Z-ADD0         @PEUTX                                              233607
     C                     Z-ADD0         @PEUTS                                              233607
      *
     C                     MOVEL@SEC      @PTDSS
     C                     MOVELNMCYA     @PTNMC
     C                     Z-ADDNMDP      @PTNMD
     C                     MOVEL@BOOK     @PTDBK
     C                     MOVEL@BRCA     @PTDBA                          S01117
     C                     MOVEL@BLKR     @PBLKR
     C                     MOVEL@TDRF     @PRTRF
     C                     BITOF'01234567'@PTACI
     C                     BITOF'01234567'@PTMSI
     C                     Z-ADDRUND      @PTOED
     C                     Z-ADDRUND      @PLCD
     C                     MOVEL'I'       @PCHTP
     C                     Z-ADDNATN      @PTNLU
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE3000CCP4                                           S01408
     C*                                                                   S01408
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD                           CAC005
     C                     PARM '*PSEUDO' POPTN                           CAC005
     C                     PARM @BOOK     PMBKCD                          CAC005
     C                     PARM @PRFC     PMPRFC                          CAC005
     C           PMPSBK    PARM *BLANKS   PMPSBK                          CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMPSBK    @PTDBK                          CAC005
     C                     ENDIF                                          CAC005
     C                     MOVEL@PRFC     @PBPRC                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                                      BUG7991
     C                     Z-ADD*ZERO     @PCRSK                                             BUG7991
     C                     Z-ADD*ZERO     @PLQPR                                             BUG7991
     C                     Z-ADD*ZERO     @PPRCN                                             BUG7991
     C                     Z-ADD*ZERO     @PTINN                                             BUG7991
     C                     Z-ADD*ZERO     @PITRN                                             BUG7991
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
      *                                                                                       CAS006
     C           @TDRF     IFNE *BLANKS                                                       CAS006
      *                                                                                       CAS006
     C                     Z-ADDCRSK      @PCRSK                                              CAS006
     C                     Z-ADDLQPR      @PLQPR                                              CAS006
     C                     Z-ADDPRICN     @PPRCN                                              CAS006
      *                                                                                       CAS006
     C                     ELSE                                                               CAS006
      *                                                                                       CAS006
     C                     Z-ADD*ZERO     @PCRSK                                              CAS006
     C                     Z-ADD*ZERO     @PLQPR                                              CAS006
     C                     Z-ADD*ZERO     @PPRCN                                              CAS006
      *                                                                                       CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADD*ZERO     @PTINN                                              CAS006
     C                     Z-ADD*ZERO     @PITRN                                              CAS006
      *                                                                                       CAS006
     C                     ENDIF                                                              CAS006
      *
     C                     ENDSR                           SUB300 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB303 - Write to bulk input file for delete                 *
      *                                                               *
      *****************************************************************
      *
     C           SUB303    BEGSR
      *
      **  Check market indicator if active first before update
     C           S01511    IFEQ 'Y'                                       S01511
     C           @SEC      CHAINSECTY                01                   S01511
     C           *IN01     IFEQ '0'                                       S01511
     C           SMAI      IFEQ 'Y'                                       S01511
     C           SMKTI     ORNE MKTI                                      S01511
     C                     MOVEL@TX,12    @ERR                            S01511
     C                     GOTO END303                                    S01511
     C                     END                                            S01511
     C                     END                                            S01511
     C                     END                                            S01511
      *
      * Write trades for deletion
      *
     C                     SETOF                     05
     C                     Z-ADD0         @SFK
     C           *IN02     DOUEQ'1'                        B001
     C                     ADD  1         @SFK
     C           @SFK      CHAINSE3000F0             02
      *
      * Record found - Write 'deletion' record
      *
     C           *IN02     IFEQ '0'                        B002
     C                     MOVEL'D'       @PRECI
     C                     MOVEL'D'       @PCHTP
     C                     Z-ADDNATN      @PTNLU
     C                     Z-ADDRUND      @PLCD
     C                     MOVEL@PARMT    @BLKDS
     C                     Z-ADD@PWHTX    WHTXA                           187727
     C                     MOVE @PBWDI    BWDI                            187727
     C                     Z-ADD@PFSPR    FSPR                                                233607
     C                     Z-ADD@PFSPP    FSPP                                                233607
     C                     WRITEBULKTDF
     C                     SETON                     05
     C/COPY WNCPYSRC,SE3000C026
     C                     END                             E002
     C                     END                             E001
     C*                                                                   S01486
     C** Additional processing for Pool Portfolio                         S01486
     C*                                                                   S01486
     C           FCPPPR    IFEQ 'Y'                                       S01486
     C                     MOVE @BLKR     KBLKR                           S01486
     C                     MOVE *LOVAL    KPCUST                          S01486
     C                     MOVE *LOVAL    KPREF                           S01486
     C           KEY3      SETLLPMPLTRPD                                  S01486
     C           KEY3A     READEPMPLTRPD                 01               S01486
     C           *IN01     IFEQ '0'                        B001           S01486
     C                     DELETPMPLTRP0                                  S01486
     C                     ELSE                            X001           S01486
     C                     Z-ADD16        @DBASE           ***************S01486
     C                     MOVEL'PMPLTRPD'@DBFIL           * DB ERROR 01 *S01486
     C                     MOVELKBLKR     @DBKEY           ***************S01486
     C                     EXSR *PSSR                                     S01486
     C                     END                             E001           S01486
     C                     END                                            S01486
      *
      * If at least one record written, set update flag and commit file
      * changes
      *
     C           *IN05     IFEQ '1'                        B001
     C                     MOVEL'Y'       @UPD
     C                     EXSR SUB401
     C                     END                             E001
      *
     C           END303    TAG                                            S01511
     C                     ENDSR                           SUB303 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB304 - Flag all entered records as deleted                 *
      *                                                               *
      *****************************************************************
      *
     C           SUB304    BEGSR
     C*                                                                   S01486
     C** If SE5200 has been called, and F3 pressed                        S01486
     C*                                                                   S01486
     C           *INKC     IFEQ '1'                        B001           S01486
     C           PACCD     ANDNE*BLANKS                                   S01486
     C           PCMDK     ANDNE' *'                                      S01486
     C           FCPPPR    ANDEQ'Y'                                       S01486
     C                     MOVE 'Y'       PTPTIF                          S01486
     C           S01448    IFEQ 'Y'                                       S01486
     C                     MOVE @CAGT     PCAGT                           S01486
     C                     END                                            S01486
     C*                                                                   091209
     C** Include a WRITE operation to allow file to be opened             091209
     C**      with option ADD.   NB. This line of code will NEVER run.    091209
     C*                                                                   091209
     C           *IN99     IFEQ '1'                        B001           091209
     C           *IN99     ANDEQ'1'                                       091209
     C                     WRITEPMPLTRP0                                  091209
     C                     END                             E001           091209
     C*                                                                   091209
     C                     CALL 'SE5200'                                  S01486
     C           PARMBI    PARM PARMBI    PARMBI                          S01486
     C                     END                             E001           S01486
      *
      * If SE3002 has been called, and F3 pressed, then close files
      *
     C           *INKC     IFEQ '1'                        B001
     C           @S3002    ANDEQ'Y'
     C                     EXSR SUB800
     C                     END                             E001
      *
      * Only perform processing if action is I
      *
     C                     SETOF                     05
     C           @ACTC     IFEQ 'I'                        B001
      *
      * Update all records with the current bulk ref.
      *
     C           @BLKR     SETLLBULKPF
     C           *IN01     DOUEQ'1'                        B002
     C           @BLKR     READEBULKPF                   01
     C           *IN01     IFEQ '0'                        B003
     C                     MOVEL'*'       RECI
     C                     UPDATBULKPF
     C                     SETON                     05
     C/COPY WNCPYSRC,SE3000C019
     C                     END                             E003
     C                     END                             E002
      *
      * COMIT updates
      *
     C   05                EXSR SUB401
      *
      * Reset update flag
      *
     C                     MOVEL'N'       @UPD
     C                     END                             E001
      *
     C                     ENDSR                           SUB304 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB401 - COMIT file updates                                  *
      *                                                               *
      *****************************************************************
      *
     C           SUB401    BEGSR
      *
     C                     TIME           @TIME
     C                     MOVEL@ACTC     @ACTN
     C           @CMTXT    COMIT
      *
     C                     ENDSR                           SUB401 ends
      *****************************************************************
     C/EJECT                                                              S01486
     C******************************************************************* S01486
     C*  SUB501 - Calculate nominal (for initial screen)                * S01486
     C******************************************************************* S01486
     C           SUB501    BEGSR                                          S01486
     C*                                                                   S01486
     C                     Z-ADD0         BNOML  150                      S01486
     C                     MOVE *BLANKS   @BONO                           S01486
     C*                                                                   S01486
      * Setup key for BKPSO                                               S01486
     C                     MOVE @SEC      KSECT  10                       S01486
     C                     MOVE @BRCA     KBRCH   3                       S01486
     C                     MOVE @BOOK     KBOOK   2                       S01486
     C                     MOVE MKTI      KMKID   1                       S01486
     C                     MOVE 'T'       KTDVA   1                       S01486
     C                     MOVE *HIVAL    KDATE   50                      S01486
      *                                                                   CAC005
      ** Convert screen fields book & book profit centre into pseudo book.CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD   7                       CAC005
     C                     PARM '*PSEUDO' POPTN   7                       CAC005
     C                     PARM @BOOK     PMBKCD  2                       CAC005
     C                     PARM @PRFC     PMPRFC  4                       CAC005
     C           PMPSBK    PARM *BLANKS   PMPSBK  2                       CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMPSBK    KBOOK                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
     C*                                                                   S01486
     C           KEY5      SETLLBKPSO                                     S01486
     C           KEY5A     READEBKPSO                    01               S01486
     C*                                                                   S01486
     C** If same security, branch, book, market indicator, T/V date       S01486
     C*                                                                   S01486
     C           *IN01     IFEQ '0'                        B001           S01486
     C                     MOVE NPSN      BNOML                           S01486
     C                     END                             E001           S01486
     C*                                                                   S01486
     C** Edit amount                                                      S01486
     C*                                                                   S01486
     C                     MOVE *BLANKS   ZFLD15                          S01486
     C                     MOVE BNOML     ZFLD15                          S01486
     C                     Z-ADDNMDP      ZDECS                           S01486
     C                     MOVE 'L'       ZECODE                          S01486
     C                     EXSR ZSEDIT                                    S01486
     C                     MOVE ZOUT21    @BONO                           S01486
     C*                                                                   S01486
     C                     MOVE *BLANKS   @PONO                           S01486
     C*                                                                   S01486
     C           @POCU     IFNE *BLANKS                    B001           S01486
     C           @POPO     ANDNE*BLANKS                                   S01486
     C                     CALL 'AOPLINR0'                                S01486
     C                     PARM *BLANKS   @RTCD                           S01486
     C                     PARM '*KEY   ' @OPTN                           S01486
     C                     PARM INNR      KINNR   3                       S01486
     C           SDPLIN    PARM SDPLIN    DSFDY                           S01486
     C           @RTCD     IFNE *BLANKS                                   S01486
     C                     Z-ADD17        @DBASE           ***************S01486
     C                     MOVEL'SDPLINPD'@DBFIL           * DB ERROR 17 *S01486
     C                     MOVELINNR      @DBKEY           ***************S01486
     C                     EXSR *PSSR                                     S01486
     C                     END                             E002           S01486
     C*                                                                   S01486
     C           PDDSPG    CHAINPMDSPGPD             01                   S01486
     C           *IN01     IFEQ '1'                        B002           S01486
     C                     Z-ADD18        @DBASE           ***************S01486
     C                     MOVEL'PMDSPGPD'@DBFIL           * DB ERROR 18 *S01486
     C                     MOVELPDDSPG    @DBKEY           ***************S01486
     C                     EXSR *PSSR                                     S01486
     C                     END                             E002           S01486
     C*                                                                   S01486
     C                     Z-ADD0         PNOML  150                      S01486
     C*                                                                   S01486
     C                     MOVE 'SE'      KMODI   2                       S01486
     C                     MOVE 'D'       KRECI   1                       S01486
     C                     MOVE @POCU     KPCUST                          S01486
     C                     MOVE @POPO     KPREF                           S01486
     C                     Z-ADDPADSPS    KPADSP                          S01486
     C                     MOVE PDDSPG    KPDDSP                          S01486
     C                     Z-ADDPDITDS    KPDITD                          S01486
     C                     MOVE INNR      KINNR                           S01486
     C                     MOVE @SEC      KSECT                           S01486
     C***********          Z-ADD0         KDLSQ                    S01486 CPM005
     C                     MOVE *LOVAL    KPOSQ                           CPM005
     C                     MOVE *LOVAL    KTRNB                           S01486
     C                     MOVE *LOVAL    KTXT                            S01486
     C*                                                                   S01486
     C***Depending*upon*whether*trade*or*value*date*positions*are**S01486 CPM005
     C***required*access*PMHOLDL4*or*PMHOLDL5**********************S01486 CPM005
     C*                                                                   S01486
     C***********FCTVPS    IFEQ 'T'                                S01486 CPM005
     C           KEY6      SETLLPMHOLDL4                                  S01486
     C           KEY6A     READEPMHOLDL4                 01               S01486
     C***********          ELSE                                    S01486 CPM005
     C***********KEY6      SETLLPMHOLDL5                           S01486 CPM005
     C***********KEY6A     READEPMHOLDL5                 01        S01486 CPM005
     C***********          END                                     S01486 CPM005
     C*                                                                   S01486
     C** If record found set pool nominal to amount from PMHOLDPD         S01486
     C*                                                                   S01486
     C           *IN01     IFEQ '0'                        B002           S01486
     C                     Z-ADDQFAMT1    PNOML                           S01486
     C                     END                             E002           S01486
     C*                                                                   S01486
     C                     MOVE *BLANKS   ZFLD15                          S01486
     C                     MOVE PNOML     ZFLD15                          S01486
     C                     Z-ADDNMDP      ZDECS                           S01486
     C                     MOVE 'L'       ZECODE                          S01486
     C                     EXSR ZSEDIT                                    S01486
     C                     MOVE ZOUT21    @PONO                           S01486
     C*                                                                   S01486
     C                     END                             E001           S01486
     C*                                                                   S01486
     C                     ENDSR                           SUB501 ends    S01486
     C/EJECT                                                              S01486
     C******************************************************************* S01486
     C* SUB502 - Set up parameters to pass to SE5200                    * S01486
     C******************************************************************* S01486
     C           SUB502    BEGSR                                          S01486
     C*                                                                   S01486
     C                     MOVE *BLANKS   PARMBI                          S01486
     C                     MOVE *ZEROS    PCHRG                           S01486
     C                     MOVE *ZEROS    PNTOT                           S01486
     C                     MOVE *BLANKS   PPDYP                           S01486
     C                     MOVE *ZEROS    PNTOT                           S01486
     C*                                                                   S01486
     C** If agency trade set to 'Y' take nominal details from screen      S01486
     C*                                                                   S01486
     C           @AGTR     IFEQ 'Y'                        B1             S01486
     C                     MOVE @BONO     PBONO                           S01486
     C                     MOVE @PONO     PPONO                           S01486
     C*                                                                   S01486
     C** ...Otherwise perform SR/SUB501 to set up nominal details         S01486
     C*                                                                   S01486
     C                     ELSE                            X1             S01486
     C                     EXSR SUB501                                    S01486
     C                     MOVE @BONO     PBONO                           S01486
     C                     MOVE @PONO     PPONO                           S01486
     C                     END                             E1             S01486
     C*                                                                   S01486
     C** Set up parameters for Insert mode                                S01486
     C*                                                                   S01486
     C           @ACTC     IFEQ 'I'                        B1             S01486
     C                     MOVE @ACTC     PACCD                           S01486
     C                     MOVE @BLKR     PBURE                           S01486
     C                     MOVE @AGTR     PAGTD                           S01486
     C                     MOVE @SEC      PSESN                           S01486
     C                     MOVE @TDTY     PTRTY                           S01486
     C                     MOVE @BOOK     PBOCO                           S01486
     C                     MOVE @BRCA     PBRCO                           S01486
     C                     MOVE @POCU     PPOCU                           S01486
     C                     MOVE @POPO     PPOPO                           S01486
     C                     MOVE *BLANKS   PMANO                           S01486
      *                                                                   CAC005
      ** Convert screen fields book & book profit centre into pseudo book.CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD                           CAC005
     C                     PARM '*PSEUDO' POPTN                           CAC005
     C                     PARM @BOOK     PMBKCD                          CAC005
     C                     PARM @PRFC     PMPRFC                          CAC005
     C           PMPSBK    PARM *BLANKS   PMPSBK                          CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMPSBK    PBOCO                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C*                                                                   S01486
     C** If agency trade edit market side nominal for output              S01486
     C*                                                                   S01486
     C           @AGTR     IFEQ 'Y'                        B2             S01486
     C*                                                                   S01486
     C** Sign should be negative for trade sale                           S01486
     C*                                                                   S01486
     C           @TDTY     IFEQ 'TS'                       B3             S01486
     C                     Z-SUB@NTOT1    @NTOT1                          S01486
     C                     Z-SUBWWCHRG    WWCHRG                          S01486
     C                     END                             E3             S01486
     C*                                                                   S01486
     C                     ELSE                            X2             S01486
     C                     Z-ADD0         @NTOT1                          S01486
     C                     Z-ADD0         WWCHRG                          S01486
     C                     END                             E2             S01486
     C*                                                                   S01486
     C** Format parameter for output                                      S01486
     C*                                                                   S01486
     C                     MOVE *BLANKS   ZFLD15                          S01486
     C                     MOVE @NTOT1    ZFLD15                          S01486
     C                     Z-ADDNMDP      ZDECS                           S01486
     C                     EXSR ZSEDIT                                    S01486
     C                     MOVE ZOUT21    PMANO                           S01486
     C*                                                                   S01486
     C** If agency trade edit PRICE / DISCOUNT / YIELD for output         S01486
     C*                                                                   S01486
     C           @AVPR     IFNE 0                          B2             S01486
     C           @AGTR     ANDEQ'Y'                                       S01486
     C                     MOVEL*BLANKS   ZFIELD                          S01486
     C                     MOVE @AVPR     ZFIELD                          S01486
     C                     Z-ADD8         ZADEC                           S01486
     C                     EXSR ZEDIT                                     S01486
     C                     MOVE ZFIELD    PPDYP                           S01486
     C                     END                             E2             S01486
     C*                                                                   S01486
     C** If agency trade set up total market nominal and charges          S01486
     C*                                                                   S01486
     C                     Z-ADDWWCHRG    PCHRG                           S01486
     C                     Z-ADD@NTOT1    PNTOT                           S01486
     C*                                                                   S01486
     C                     MOVE 'N'       PDEPA                           S01486
     C                     MOVE 'N'       WWTDDF  1                       S01486
     C           @TDRF     IFNE *BLANKS                    B2             S01486
     C                     MOVE 'Y'       WWTDDF  1                       S01486
     C                     MOVE 'Y'       PDEPA                           S01486
     C           @TDRF     CHAINTRADS                01                   S01486
     C           *IN01     IFEQ '0'                        B3             S01486
     C                     MOVE ACIN      PACRIN                          S01486
     C                     MOVE ADIN      PACDI                           S01486
     C                     MOVE CLTY      PCLTY                           S01486
     C                     EXSR SUB52A                                    S01486
     C                     END                             E3             S01486
     C                     END                             E2             S01486
     C                     MOVE 'N'       WWTDDF  1                       S01486
     C*                                                                   S01486
     C           @TDRF     IFEQ *BLANKS                    B2             S01486
     C           @AGTR     ANDEQ'Y'                                       S01486
     C                     MOVE 'Y'       PDEPA                           S01486
     C*                                                                   S01486
     C** Access first Trade on market side                                S01486
     C*                                                                   S01486
     C                     Z-ADD1         @SFK                            S01486
     C           @SFK      CHAINSE3000F0             02                   S01486
     C*                                                                   S01486
     C           *IN02     IFEQ '0'                        B3             S01486
     C           @REF      CHAINBULKR                01                   S01486
     C                     UPDATBULKTDF                                   S01486
     C                     EXSR SUB401                                    S01486
     C                     MOVE ACIN      PACRIN                          S01486
     C                     MOVE ADIN      PACDI                           S01486
     C                     MOVE CLTY      PCLTY                           S01486
     C                     EXSR SUB52A                                    S01486
     C                     END                             E3             S01486
     C                     END                             E2             S01486
     C*                                                                   S01486
     C                     MOVE *BLANKS   PCMDK                           S01486
     C                     MOVE 'N'       PTPTIF                          S01486
     C*                                                                   S01486
     C                     END                             E1             S01486
     C*                                                                   S01486
     C** Set up parameters for Amend mode                                 S01486
     C*                                                                   S01486
     C           @ACTC     IFEQ 'A'                        B1             S01486
     C*                                                                   S01486
     C** Obtain pool security details                                     S01486
     C*                                                                   S01486
     C           OUTDSS    CHAINSECTY                01                   S01486
     C           *IN01     IFEQ '1'                        B2             S01486
     C                     Z-ADD51        @DBASE           ***************S01486
     C                     MOVEL'SECTY'   @DBFIL           * DB ERROR 01 *S01486
     C                     MOVELOUTDSS    @DBKEY           ***************S01486
     C                     EXSR *PSSR                                     S01486
     C                     END                             E2             S01486
     C***********          MOVE NMCYA     KCCY1                    S01486 CPM005
     C*                                                                   S01486
     C** The investment type of the security must exist on LF/INVTP       S01486
     C*                                                                   S01486
     C           @KEY1     CHAININVTP                01                   S01486
     C           *IN01     IFEQ '1'                        B2             S01486
     C                     Z-ADD52        @DBASE           ***************S01486
     C                     MOVEL'INVTP'   @DBFIL           * DB ERROR 01 *S01486
     C                     MOVELNMCYA     @DBKEY           ***************S01486
     C                     MOVE SITP      @DBKEY                          S01486
     C                     EXSR *PSSR                                     S01486
     C                     END                             E2             S01486
     C*                                                                   S01486
     C** Set up remaining fields to be used in SUB501                     S01486
     C*                                                                   S01486
     C                     MOVE OUTDSS    @SEC                            S01486
     C                     MOVE OUATRD    @AGTR                           S01486
     C                     MOVE OUTDBR    @BRCA                           S01486
     C                     MOVE OUTDBK    @BOOK                           S01486
     C                     MOVE OUPCNU    @POCU                           S01486
     C                     MOVE OUPPTF    @POPO                           S01486
      *                                                                   CAC005
      ** If CAC005 is on, retrieve user book from AOBKPCR0.               CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD                           CAC005
     C                     PARM '*USER  ' POPTN                           CAC005
     C           PMBKCD    PARM *BLANKS   PMBKCD                          CAC005
     C           PMPRFC    PARM *BLANKS   PMPRFC                          CAC005
     C                     PARM OUTDBK    PMPSBK                          CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMBKCD    @BOOK                           CAC005
     C                     MOVELPMPRFC    @PRFC                           CAC005
     C                     ELSE                                           CAC005
     C                     MOVEL*BLANKS   @PRFC                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C                     EXSR SUB501                                    S01486
     C                     MOVE @BONO     PBONO                           S01486
     C                     MOVE @PONO     PPONO                           S01486
     C*                                                                   S01486
     C** Format market nominal for display                                S01486
     C*                                                                   S01486
     C                     MOVE *BLANKS   PMANO                           S01486
     C                     MOVE *BLANKS   ZFLD15                          S01486
     C                     MOVE OUMTNO    ZFLD15                          S01486
     C                     Z-ADDNMDP      ZDECS                           S01486
     C                     EXSR ZSEDIT                                    S01486
     C                     MOVE ZOUT21    PMANO                           S01486
     C*                                                                   S01486
     C                     Z-ADDOUMTNO    PNTOT                           S01486
     C                     Z-ADDOUMCHG    PCHRG                           S01486
     C*                                                                   S01486
     C                     MOVE @ACTC     PACCD                           S01486
     C                     MOVE @BLKR     PBURE                           S01486
     C                     MOVE OUPCNU    PPOCU                           S01486
     C                     MOVE OUPPTF    PPOPO                           S01486
     C                     MOVE 'N'       PDEPA                           S01486
     C                     MOVE *BLANKS   PCMDK                           S01486
     C                     MOVE 'N'       PTPTIF                          S01486
     C                     MOVE @AGTR     PAGTD                           S01486
     C                     MOVE @BOOK     PBOCO                           S01486
     C                     MOVE @BRCA     PBRCO                           S01486
      *                                                                   CAC005
      ** Convert screen fields book & book profit centre into pseudo book.CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD                           CAC005
     C                     PARM '*PSEUDO' POPTN                           CAC005
     C                     PARM @BOOK     PMBKCD                          CAC005
     C                     PARM @PRFC     PMPRFC                          CAC005
     C           PMPSBK    PARM *BLANKS   PMPSBK                          CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMPSBK    PBOCO                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
     C*                                                                   S01486
     C** Update job parameter on PF/PMPLTRPD                              S01486
     C*                                                                   S01486
     C                     MOVE @BLKR     KBLKR   6                       S01486
     C                     MOVE *LOVAL    KPCUST                          S01486
     C                     MOVE *LOVAL    KPREF                           S01486
     C           KEY3      SETLLPMPLTRPD                                  S01486
     C           KEY3A     READEPMPLTRPD                 01               S01486
     C                     MOVE @JOB      OUJOB                           S01486
     C                     UPDATPMPLTRP0                                  S01486
     C*                                                                   S01486
     C** COMIT updates                                                    S01486
     C*                                                                   S01486
     C                     EXSR SUB401                                    S01486
     C                     END                             - E1           S01486
     C*                                                                   S01486
     C                     ENDSR                           SUB502 ends    S01486
     C/EJECT                                                              S01486
     C******************************************************************* S01486
     C* SUB52A - FORMAT PARAMETERS TO BE PASSED TO SE5200               * S01486
     C******************************************************************* S01486
     C           SUB52A    BEGSR                                          S01486
     C*                                                                   S01486
     C** Convert trade date from day number to DDMMYY format              S01486
     C*                                                                   S01486
     C                     Z-ADDTDDT      ZDAYNO                          S01486
     C                     EXSR ZDATE2                                    S01486
     C                     MOVE ZDATE     PTRDA                           S01486
     C*                                                                   S01486
     C** Convert value date from day number to DDMMYY format              S01486
     C*                                                                   S01486
     C                     Z-ADDTDVD      ZDAYNO                          S01486
     C                     EXSR ZDATE2                                    S01486
     C                     MOVE ZDATE     PVADA                           S01486
     C*                                                                   S01486
     C** Format days adjustment for output                                S01486
     C*                                                                   S01486
     C           DADJ      IFEQ 0                          B1             S01486
     C                     MOVE *BLANKS   PDAAS                           S01486
     C                     ELSE                            X1             S01486
     C*                                                                   S01486
     C           DADJ      IFLT 0                          B2             S01486
     C                     MOVE '-'       PDAAS                           S01486
     C                     Z-SUBDADJ      WWDADJ  30                      S01486
     C                     ELSE                                           S01486
     C                     Z-ADDDADJ      WWDADJ                          S01486
     C                     MOVE '+'       PDAAS                           S01486
     C                     END                             E2             S01486
     C*                                                                   S01486
     C                     MOVELWWDADJ    PDAAS                           S01486
     C                     END                             E1             S01486
     C*                                                                   S01486
     C** Edit PRICE / DISCOUNT / YIELD for output                         S01486
     C*                                                                   S01486
     C           WWTDDF    IFEQ 'Y'                        B1             S01486
     C                     MOVEL*BLANKS   ZFIELD                          S01486
     C                     MOVE PRIC      ZFIELD                          S01486
     C                     Z-ADD8         ZADEC                           S01486
     C                     EXSR ZEDIT                                     S01486
     C                     MOVE ZFIELD    PPDYP                           S01486
     C                     END                             E1             S01486
     C*                                                                   S01486
     C** Obtain deliver from shortname to be passed as parameter          S01486
     C*                                                                   S01486
     C                     MOVE *BLANKS   PDEFR                           S01486
     C                     MOVE *BLANKS   PDETO                           S01486
     C           TDTP      IFEQ 'TP'                       B1             S01486
     C********** DELT      IFNE 0                          B2                          S01486 CSD027
     C           DELT      IFNE *BLANKS                    B2                                 CSD027
     C                     MOVE DELT      PDEFR                           S01486
     C                     MOVE DELT      PDETO                           S01486
     C                     END                             E2             S01486
     C                     ELSE                            X1             S01486
     C********** DELF      IFNE 0                          B2                          S01486 CSD027
     C           DELF      IFNE *BLANKS                    B2                                 CSD027
     C                     MOVE DELF      PDEFR                           S01486
     C                     MOVE DELF      PDETO                           S01486
     C                     END                             E2             S01486
     C                     END                             E1             S01486
     C*                                                                   S01486
     C                     ENDSR                                          S01486
     C*                                                                   S01486
     C/EJECT                                                              S01486
     C******************************************************************* S01486
     C* SUB52B - CALCULATE TOTAL CHARGES INCURRED ON MARKET SIDE        * S01486
     C******************************************************************* S01486
     C           SUB52B    BEGSR                                          S01486
     C*                                                                   S01486
     C** Calculate total charges for last trade entered                   S01486
     C*                                                                   S01486
     C                     Z-ADD0         WWTTCH 150                      S01486
     C                     ADD  @PTBCA    WWTTCH                          S01486
     C                     ADD  @PTCCA    WWTTCH                          S01486
     C                     ADD  @PTCA1    WWTTCH                          S01486
     C                     ADD  @PTCA2    WWTTCH                          S01486
     C                     ADD  @PTCA3    WWTTCH                          S01486
     C                     ADD  @PTCA4    WWTTCH                          S01486
     C                     ADD  @PTCA5    WWTTCH                          S01486
     C                     ADD  @PTCA6    WWTTCH                          S01486
     C                     ADD  @PTCA7    WWTTCH                          S01486
     C                     ADD  @PTAXA    WWTTCH                          S01486
     C                     SUB  @PBCMR    WWTTCH                          S01486
     C                     SUB  @PCCMR    WWTTCH                          S01486
     C                     SUB  @PTXRB    WWTTCH                          S01486
     C*                                                                   S01486
     C** Calculate total amount                                           S01486
     C*                                                                   S01486
     C                     ADD  WWTTCH    WWCHRG                          S01486
     C                     ENDSR                                          S01486
     C/EJECT                                                              S01486
     C******************************************************************* S01486
     C* SUB503 - Receive command key returned from SE5200               * S01486
     C******************************************************************* S01486
     C           SUB503    BEGSR                                          S01486
     C*                                                                   S01486
     C** ENTER pressed                                                    S01486
     C*                                                                   S01486
     C           PCMDK     IFEQ 'RA'                       - B1           S01486
     C                     MOVE 'Y'       @UPD                            S01486
     C                     END                             - E1           S01486
     C*                                                                   S01486
     C** F3 pressed                                                       S01486
     C*                                                                   S01486
     C           PCMDK     IFEQ ' 3'                       - B1           S01486
     C           PCMDK     OREQ ' *'                       - B1           S01486
     C                     MOVE '1'       *INKC                           S01486
     C                     EXSR SUB304                                    S01486
     C                     END                             - E1           S01486
     C*                                                                   S01486
     C** F9 pressed                                                       S01486
     C*                                                                   S01486
     C           PCMDK     IFEQ ' 9'                       - B1           S01486
     C                     MOVE '1'       *INKI                           S01486
     C                     END                             - E1           S01486
     C*                                                                   S01486
     C** F12 pressed                                                      S01486
     C*                                                                   S01486
     C           PCMDK     IFEQ '12'                       - B1           S01486
     C                     MOVE '1'       *INKL                           S01486
     C                     EXSR SUB304                                    S01486
     C                     END                             - E1           S01486
     C*                                                                   S01486
     C           PCMDK     IFEQ 'RY'                       - B1           S01486
     C                     MOVE 'N'       @UPD                            S01486
     C                     MOVE '1'       *INKL                           S01486
     C                     END                             - E1           S01486
     C*                                                                   S01486
     C                     ENDSR                           SUB503 ends    S01486
     C*****************************************************************   S01486
     C/EJECT                                                              S01496
     C*****************************************************************   S01496
     C* SR50X - Price within 10% of Market Price testing              *   S01496
     C*****************************************************************   S01496
     C           SR50X     BEGSR                                          S01496
     C*                                                                   S01496
     C                     MOVELWWPSSN    WWPSSN 10                       S01496
     C                     MOVELRC50X     RC50X   1                       S01496
     C*                                                                   S01496
     C** KLIST for Prices file                                            S01496
     C*                                                                   S01496
     C           KPRICM    KLIST                                          S01496
     C                     KFLD           WWPSSN                          S01496
     C*                                                                   S01496
     C** Convert SPRIC to numeric price                                   S01496
     C*                                                                   S01496
     C                     MOVE SPRIC     ZFIELD                          S01496
     C                     Z-ADD8         ZADEC                           S01496
     C                     Z-ADD7         ZADIG                           S01496
     C                     EXSR ZALIGN                                    S01496
     C                     MOVE ZFIELD    PRICE  158                      S01496
     C*                                                                   S01496
     C** Find Market Price, if not found, use default                     S01496
     C*                                                                   S01496
     C           KPRICM    CHAINPRICM                01                   S01496
     C           *IN01     IFEQ '1'                                       S01496
     C           RECI      ORNE 'D'                                       S01496
     C           PPRT      ORNE 'V '                                      S01496
     C                     Z-ADDMKPR      PPRC                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C** Test 10% Interval                                                S01496
     C*                                                                   S01496
     C                     MOVE 'N'       RC50X                           S01496
     C           PPRC      DIV  10        APWRK1 158       10%            S01496
     C           PPRC      ADD  APWRK1    APWRK2 158       110%           S01496
     C           PRICE     IFGT APWRK2                                    S01496
     C                     MOVE 'Y'       RC50X                           S01496
     C                     ELSE                                           S01496
     C*                                                                   S01496
     C           PPRC      SUB  APWRK1    APWRK2           90%            S01496
     C           PRICE     IFLT APWRK2                                    S01496
     C                     MOVE 'Y'       RC50X                           S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     ENDSR                           SR50X ends     S01496
     C*****************************************************************   S01496
     C/EJECT                                                              S01496
     C*****************************************************************   S01496
     C* SR50Y - Trade making Short Position testing                   *   S01496
     C*****************************************************************   S01496
     C           SR50Y     BEGSR                                          S01496
     C*                                                                   S01496
     C** Initialisation                                                   S01496
     C*                                                                   S01496
     C                     MOVELSECUR     SECUR  10                       S01496
     C**********           MOVELBFCUST    CUST    60                                   S01496 CSD027
     C                     MOVELBFCUST    CUST    6                                           CSD027
     C           *LIKE     DEFN WWNOML    WWPOS                           S01496
     C                     MOVE 'N'       ERR50Y  1                       S01496
     C*                                                                   S01496
     C** KLIST for CPOSC                                                  S01496
     C*                                                                   S01496
     C           KCPOSC    KLIST                                          S01496
     C                     KFLD           WXTDBR                          S01496
     C                     KFLD           CUST                            S01496
     C                     KFLD           SECUR                           S01496
     C*                                                                   S01496
     C** Find Customer Position Prev. Day                                 S01496
     C*                                                                   S01496
     C           KCPOSC    CHAINCPOSNDF              01                   S01496
     C           *IN01     IFEQ '1'                                       S01496
     C                     MOVE 'Y'       ERR50Y                          S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C** Test Nominal Vs. Current Position                                S01496
     C*                                                                   S01496
     C           CSNT      IFGT 0                                         S01496
     C           WWNOML    IFGT CSNT                                      S01496
     C                     MOVE 'Y'       ERR50Y                          S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C** ...Otherwise if position already short output error showing      S01496
     C** that position will go even shorter                               S01496
     C*                                                                   S01496
     C                     ELSE                                           S01496
     C                     MOVE 'Y'       ERR50Y                          S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     ENDSR                           SR50Y ends     S01496
     C*****************************************************************   S01496
      /EJECT
      *****************************************************************
      *                                                               *
      *  SUB800 - Close files opened by SE3002                        *
      *                                                               *
      *****************************************************************
      *
     C           SUB800    BEGSR
      *
     C                     CALL 'SE3002'               01
     C                     PARM *BLANKS   @PARMS
     C                     PARM 'T'       @RETC
     C                     PARM           @CUMMC
     C                     PARM           @CUMMN
      *                                                                   185278
      **  Extra parameter needed for MT5xx. This passes the trade ref     185278
      **  & bulk ref to SE3002. The trade ref will be used as a key to    185278
      **  pass the details from TRADSDX1 to SE1805. If associated         185278
      **  details exist on TRADSDX2 then the details will be passed       185278
      **  from SE3002 via SE1805 to SE1806. Bulk ref will be used to      185278
      **  set up the Bulk ref field.                                      185278
      *                                                                   185278
     C                     PARM @TDRF     TRDRF   6                       185278
     C                     PARM @BLKR     @BKRF   6                       185278
     C*                                                                   185278
     C*   Extra parameter for Bulk Input Enhancements to identify         185278
     C*   a Cross Agency trade                                            185278
     C*                                                                   185278
     C                     PARM @CAGT     @CAGT   1                       185278
     C*                                                                   S01408
     C/COPY WNCPYSRC,SE3000CCP5                                           S01408
     C*                                                                   S01408
     C                     PARM           P@BYSL                          CSE006
      *                                                                                       205667
      ** New parameter - Set up clearance type flag.                                          205667
      *                                                                                       205667
     C                     PARM           CLRTYP  1                                           205667
      *
     C           *IN01     IFEQ '1'                        B001
     C                     Z-ADD14        @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 14 *
     C                     MOVEL'SE3002'  @DBKEY           ***************
     C***********          EXSR SUB999                                    S01117
     C                     EXSR *PSSR                                     S01117
     C                     END                             E001
      *
     C                     ENDSR                           SUB800 ends
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      ***SUB999*-*Error*handling***************************************   S01117
      *  *PSSR  - Error handling                                      *   S01117
      *                                                               *
      *****************************************************************
      *
     C***********SUB999    BEGSR                                          S01117
     C           *PSSR     BEGSR                                          S01117
      *
     C           @RUN      IFEQ *BLANKS                                   S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP
     C                     MOVEL@DBALL    @DBSAV
     C           *LOCK     IN   LDA
     C                     MOVEL@DBSAV    @DBALL
     C                     MOVEL'SE3000'  @DBPGM
     C                     OUT  LDA
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END                                            S01117
      *
     C***********          ENDSR                           SUB999 ends    S01117
     C                     ENDSR                                          S01117
      *
     C*****************************************************************
      /EJECT
     C/COPY WNCPYSRC,SE3000C013
     C/COPY ZSRSRC,ZALIGNZ2
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZDATE2Z2                                               S01486
      /EJECT
     C/COPY ZSRSRC,ZEDITZ2
      */EJECT***********************************                          S01117
     C*/COPY*ZSRSRC,ZICD2Z1*********************                          S01117
      */EJECT***********************************                          S01117
     C*/COPY*ZSRSRC,ZICDSEZ1********************                          S01117
      /EJECT
     C/COPY ZSRSRC,ZSEDITZ3
      */EJECT***********************************                          S01117
     C*/COPY*ZSRSRC,ZSYSTMZ1********************                          S01117
      /EJECT
     C/COPY ZSRSRC,ZTNLU1Z2
      /EJECT
     C***/COPY*ZSRSRC,ZCNSDZ1                                      064529 067527
      ***/EJECT**                                                  064529 067527
      ***
      *                                                                   S01401
      ** S01401 - Replaces @TX,3 below with current line & adds new       S01401
      ** line @TX,11                                                      S01401
      *(''xxxxxxxxxx'' ''xxxxxx'')')   MSGQ(MOPERQ) RTGDTA(*JOBD) INLLIBL(*JOBD)
      ** S01511 - Added @TX,12
      * /112563/ Change
      * @TX,4  Press F10 to delete trades (old array line)
      * @TX,3 was:  (''xxxxxxxxxx'' ''xxxxxx'' ''S01401'' ''X'')'      )  CSE006
** CPY@
(c) Finastra International Limited 2001
**  @TX - Large text strings ..SBMJOB AMENDED BY E20718 & by E21353       E20718
 No active trades exist for this bulk reference
SBMJOB JOB(BTnnnnnnx) JOBD(BULKTJOBD) USER(*JOBD) RQSDTA('CALL PGM(SEC3003) PARM              CPK014
(''xxxxxxxxxx'' ''xxxxxx'' ''S01401'' ''X'' '' '')')
 F10=Delete Trades
 Press ENTER to confirm
 Trade review(s) outstanding
 Job BTnnnnnnx submitted
SNDMSG MSG(MIDAS) TOMSGQ(MSTATUS)
REFERENCE     BROKER        NOMINAL
REFERENCE  BROKER/CLIENT    NOMINAL
  MSGQ(MOPERQ) RTGDTA(*JOBD) INLLIBL(*JOBD) OUTQ(*JOBD)                                       CSC023
File not updated - Market update is active.
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN                      S01486
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR                        S01486
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES                                            S01486
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
