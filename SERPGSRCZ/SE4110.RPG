     H        1
      *****************************************************************
/*S*D****RPGBASE*******************************************************                       CSD053
/*STD *  RPGBNOCVT                                                    *                       CSD053
/*EXS *  RPGCVTOPT1                                                   *                       CSD053
/*EXI *  TEXT('Midas SE Buy-sell backs confirmations')                *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Securities Trading Module                            *
     F*                                                               *
     F*  SE4110 - BUY-SELL BACKS CONFIRMATIONS                        *
     F*                                                               *
     F*  Function: To print a Buy-Sell Back confirmation which will   *
     F*   (I/C)    combine both trades in one confirmation report.    *
     F*                                                               *
     F*  Called by: SEC0304 - Input Cycle Confirmation Print          *
     F*             SEC0309 - Input Cycle Confirmation Reprint        *
     F*             Frequency:                                        *
     F*             - automatically after exiting Trades Input        *
     F*             - on request during I/C                           *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046998A          Date 15Apr21               *           
      *  Prev Amend No. CSD103             Date 10Aug20               *
      *                 MD057247           Date 01Feb21               *
      *                 260909             Date 04Apr19               *
      *                 MD046248           Date 27Oct17               *
      *                 MD035214           Date 25May16               *
      *                 226449             Date 24Jun15               *
      *                 AR761582           Date 24May11               *
      *                 AR736004           Date 23Mar11               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      *                 CRE026             Date 24May06               *
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD053             Date 01JUN06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 BUG10702           Date 24Feb06               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 CAS006             Date 21Jan03               *
      *                 208241             Date 21Aug02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CAP067             Date 24Sep01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CPK014             Date 04Oct01               *
      *                 127566             Date 09May01               *
      *                 CSE022             Date 29Mar01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 CSD006             Date 16May01               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CSE023             Date 12Jul00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 176443             Date 18Apr00               *
      * Midas DBA 3.02 -----------------------------------------------*
     F*                 CSE006  *CREATE    Date 29Jun99               *
     F*                                                               *
     F*---------------------------------------------------------------*
      *                                                               *
      *  MD046998A - Recompiled due to changes in /COPY ZDYYRZ3       *
      *            - Applied fix for MD057480                         * 
      *  CSD103 - LIBOR Deregulation - Common Layer/Standing Data     *
      *           (Recompile)                                         *
      *  MD057247 - Multiple calls of UTCHOBJEX for several COB com-  *
      *             ponents - Securities module.                      *
      *           - Moved the call of AOSARDR0 from /copy ZLCDZ1.     *
     F*  260909 - Security Trade calculates wrong consideration on MBS*
      *         - Applied for MD-51447                                *
      *  MD046248 - Finastra Rebranding                               *
      *  MD035214 - Component SEC05 failed on program SE4110 due to   *
      *             empty SDRETLPD.                                   *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  AR761582 - SEC0304 DBERR                                     *
      *  AR736004 - DB error on file FDRETALL (Child: AR736005)       *
      *  CRE026 - Consumer Banking (Recompile)                        *
      *  CSD053   - Correspondence Manager Multilanguage Upgrade      *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  BUG10702 - Rename new fields added to TRADSD                 *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CAS006 - Hedge Accounting Phase B                            *
      *  208241 - Recompiled over changed /CPY ZSDESCZ3.              *
      *  CAP067 - Repurchase Agreements API.                          *
      *  CPK014 - Release 4 packaging.  Timestamp field needs to be   *
     F*           renamed.                                            *
      *  127566 - Recompiled over changed ZSDESCZ3                    *
      *  CSE022 - Depository Definition Enhancement                   *
      *  CSD006 - Use DSSDY to call AOCURRR0.                         *
      *  CSE023 - Treaty Withholding Tax                              *
      *  176443 - Avoid MCH3601 to be sent.                           *
      *           Pass correct parameter to AOCUSTR0.                 *
     F*  CSE006 - Repurchase Agreements (REPOs) enhancement           *
     F*                                                               *
     F*****************************************************************
      *
     FSE4110P1O   E                    PRINTER                        UC
     F                                              KINFDS SPOOL
     FSE4110AUO   E                    PRINTER
     F                                              KINFDS SPOOLU
     FSECTY   IF  E           K        DISK
     FINVTP   IF  E           K        DISK
     FTRDCONF UF  E           K        DISK         KINFDS TRDDS
     F                                              KINFSR TRDSR
     F                                              KCOMIT
     FTRADSDY1IF  E           K        DISK
     FFDRETALLIF  E           K        DISK
      *
     F*
     FSDBKPCL3IF  E           K        DISK
      ** Core hook for externalisation.
     F/COPY WNCPYSRC,SE4110FPG
      *
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   01     CONTROL FOR 'AUTO TRANSMISSION - DO NOT SEND'        *
     F*   09     TEST CONDITION FOR TESTN COMMAND                     *
     F*   10     TEST CONDITION FOR TESTN COMMAND                     *
     F*   20     NON-DISPLAY VALUE DATE INTEREST DETAILS              *
     F*   21     NON-DISPLAY MATURITY DATE INTEREST DETAILS           *
     F*   29     USED IN LOOK-UP OF ARRAY ARR36                       *
     F*   31     END OF FILE FOR TRDCONF                              *
     F*   33     PROCESSING TYPE '4'                                  *
     F*   37     MULTIBRANCHING ON                                    *
     F*   41     RECORD NOT FOUND WHEN CHAINING                       *
     F*   61     FIRST TIME INDICATOR FOR OPENING PRINT FILE SE4110P1 *
     F*   71     USED IN STAR SUBROUTINE IN COMPARE OF *BLANKS        *
     F*                                                               *
     F*   97     USED IN CONDITIONING IF UPDATE FAILS.                *
     F*   99     USED IN THE Z-SUBROUTINES                            *
     F*                                                               *
     F*   U7-U8  DATABASE    OR                                       *
     F*   U8     DIFFERENCE BETWEEN CALC AND FILE TOTALS OF RECORDS   *
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  FIRST   -  OBTAINS ICD INFO                                  *
     F*  INITPR  -  INITIALISATION                                    *
     F*  PRINTX  -  FORMATS FIRST 17 LINES AND SPECIAL INSTRUCTIONS   *
     F*  PRINTA  -  CONTROLS PRINTING OF FIRST TRADE DETAILS          *
     F*  PRINTB  -  CONTROLS PRINTING OF SECOND TRADE DETAILS         *
     F*  AUDIT   -  PRINTS ANY DB ERRORS                              *
     F*  INST1   -  DETERMINES THE CONTENTS OF FIELDS 20-23 & 32-33   *
     F*  INST2   -  DETERMINES THE CONTENTS OF FIELDS 20-23 & 32-33   *
     F*  ACCPA1  -  DETERMINES THE CONTENTS OF FIELDS 26-27  (VALUE)  *
     F*  ACCPA2  -  DETERMINES THE CONTENTS OF FIELDS 26-27  (MAT.)   *
     F*  ACCTO1  -  DETERMINES THE CONTENTS OF FIELDS 35-36  (VALUE)  *
     F*  ACCTO2  -  DETERMINES THE CONTENTS OF FIELDS 35-36  (MAT.)   *
     F*  DAYSAC  -  CALLED WHEN NO. OF DAYS OF ACCRUED INTEREST CALC'D*
     F*  UPDATE  -  UPDATE SR TO UPDATE TRDCONF                       *
     F*  STAR    -  ASTERISK FILL NUMERIC FIELDS                      *
     F*  *PSSR   -  ERROR HANDLING                                    *
     F*  RCFP1   -  SUBROUTINE TO REGISTER P1 PRINTER FILE VIA RCF    *
     F*  RCFAU   -  SUBROUTINE TO REGISTER AU PRINTER FILE VIA RCF    *
     F*                                                               *
     F*  ZCONV   -  CONVERTS AMOUNT FROM ONE CCY TO ANOTHER CCY       *
     F*  ZDATE2  -  DAYNO - DATE CONVERSION                           *
     F*  ZDAYS   -  CALCS NUMBER OF DAYS OF ACCRUED INTEREST.         *
     F*  ZDYYR   -  CALCS NUMBER OF DAYS IN INTEREST YEAR.            *
     F*  ZLCD    -  CALCULATES THE LAST COUPON DATE                   *
     F*  ZNCD    -  CALCULATES THE NEXT COUPON DATE                   *
     F*  ZSEDIT  -  PUTS COMMAS, DEC.PL AND SIGN IN NUMERIC FIELDS    *
     F*                                                               *
     F*****************************************************************
      /EJECT
     E                    CPY@    1   1 80
     E                    ARRB       21  1
     E                    ARR36      10  6
     E                    ARRSE      10  6
     E/COPY ZSRSRC,ZNCDZ1
     E/COPY ZSRSRC,ZSEDITZ1
     E/COPY ZSRSRC,ZDAYSZ1
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZSDESCZ1
     E                    ARRA    1  43 58
     E/COPY ZSRSRC,ZPOWERZ1
     E/COPY WNCPYSRC,SE4110E001
      /EJECT
     E/COPY WNCPYSRC,SE4110E002
      *                                                                                       CAP067
      ** Rename fields                                                                        CAP067
     ITRADSDF                                                                                 CAP067
     I              RECI                            TRRECI                                    CAP067
     I              LCD                             TRLCD                                     CAP067
     I              CHTP                            TRCHTP                                    CAP067
     I              TNLU                            TRTNLU                                    CAP067
     I              FRNT                            TRFRNT                                    CAP067
     I              AFRT                            TRAFRT                                    CAP067
     ICPYR@#      DS
      *
      *  Data Structure for compilation  - Copyright insertion
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *
      *  Local Data-Area data structure used for DB errors
     ILDA         DS                            256
     I                                      134 183 DBLOT
     I                                      134 141 DBFILE
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
      *
      **  DS for P1 spool file name
     ISPOOL       DS
     I                                       83  92 SFILE
     I                                    B 123 1240SFNUM
      *
      **  DS for AU spool file name
     ISPOOLU      DS
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
      *
      ** Data structure for RUNDAT
     IRUNDT       DS
     I                                       12  12 DFF
     I                                       13  13 MBIN
      *
      *  Define a work field for 'Pay To'
     IW#PAYT      DS                             12
     I                                        1   2 NOSTR
     I                                        1   6 CUSTNO
     I                                        1   8 COUSNM
      *
      *  Define a work field for 'Pay From'
     IW#PYFM      DS                             12
     I                                        1   2 NOSTR2
     I                                        1   6 CUSTN2
     I                                        1   8 COSNM2
      *
      *  Define a work field for 'For the Account of - Pay To'
     IW#TDFA      DS                              8
     I                                        3   6 TDFAN1
      *
      *  Define a work field for 'For the Account of - Deliver To'
     IW#DTFA      DS                              8
     I                                        3   6 DTFAN1
      *
      *  Define a work field for 'For the Account of - Deliver From'
     IW#DFFA      DS                              8
     I                                        3   6 DFFAN1
      *
      *  Define a work field to set up key for CHAIN to LF/FDRETALL
     I            DS
     I                                        1  120W#ACNO
     I                                        1  100K#ACNO
      *
     I            DS
      *  DS used occasionally for output and holds information from
      *  several fields which are output in one field
     I**********                              1  22 CUSTAC                                    CGL029
     I                                        1  28 CUSTAC                                    CGL029
     I                                        1   4 BRANCH
     I                                        5  10 CUST
     I                                       11  14 CURRCY
     I**********                             15  19 ACCODE                                    CGL029
     I**********                             20  22 ACSEQ                                     CGL029
     I                                       15  25 ACCODE                                    CGL029
     I                                       26  28 ACSEQ                                     CGL029
      *
     ITRDDS       DS
     I                                     *STATUS  TRDSTS
      *
      ** DS holding current trade
     ICURTRD    E DSTRADSD
      *                                                                   CSE023
      ** RENAME DUPLICATE FIELDS                                          CSE023
     I              WHTX                            TRWHTX                CSE023
     I              BWDI                            TRBWDI                CSE023
      *
      ** DS holding trade with earlier value date
     ITRADEA    E DSTRADSD
     I              RECI                            A#RECI
     I              TDRF                            A#TDRF
     I              TINC                            A#TINC
     I              TDSS                            A#TDSS
     I              TCNR                            A#TCNR
     I              TDTP                            A#TDTP
     I              NOML                            A#NOML
     I              TNMC                            A#TNMC
     I              TNMD                            A#TNMD
     I              TPDY                            A#TPDY
     I              TDVD                            A#TDVD
     I              TDBA                            A#TDBA
     I              ORBR                            A#ORBR
     I              TDBK                            A#TDBK
     I              TDDT                            A#TDDT
     I              TSUB                            A#TSUB
     I              LKRF                            A#LKRF
     I              TDMI                            A#TDMI
     I              TDNR                            A#TDNR
     I              TDID                            A#TDID
     I              AIIP                            A#AIIP
     I              TMKC                            A#TMKC
     I              TCAP                            A#TCAP
     I              ZZ005                           A#Z005
     I              ACIN                            A#ACIN
     I              DADJ                            A#DADJ
     I              ADIN                            A#ADIN
     I              ITRA                            A#ITRA
     I              TINA                            A#TINA
     I              TDCR                            A#TDCR
     I              PRIC                            A#PRIC
     I              EXDV                            A#EXDV
     I              RALL                            A#RALL
     I              SETC                            A#SETC
     I              TDER                            A#TDER
     I              TMDI                            A#TMDI
     I              TBCR                            A#TBCR
     I              SMTH                            A#SMTH
     I              PYFM                            A#PYFM
     I              PYFA                            A#PYFA
     I              PAYT                            A#PAYT
     I              PYTA                            A#PYTA
     I              TDFA                            A#TDFA
     I              ASNM                            A#ASNM
     I              CLTY                            A#CLTY
     I              DELT                            A#DELT
     I              DTFA                            A#DTFA
     I              DELF                            A#DELF
     I              DFFA                            A#DFFA
     I              TDSI                            A#TDSI
     I              PRYC                            A#PRYC
     I              PCOD                            A#PCOD
     I              TBCC                            A#TBCC
     I              TBCA                            A#TBCA
     I              TCCC                            A#TCCC
     I              TCCA                            A#TCCA
     I              TCC1                            A#TCC1
     I              TCA1                            A#TCA1
     I              TCC2                            A#TCC2
     I              TCA2                            A#TCA2
     I              TCC3                            A#TCC3
     I              TCA3                            A#TCA3
     I              TCC4                            A#TCC4
     I              TCA4                            A#TCA4
     I              TCC5                            A#TCC5
     I              TCA5                            A#TCA5
     I              TCC6                            A#TCC6
     I              TCA6                            A#TCA6
     I              TCC7                            A#TCC7
     I              TCA7                            A#TCA7
     I              TAXA                            A#TAXA
     I              BCMR                            A#BCMR
     I              CCMR                            A#CCMR
     I              TXRB                            A#TXRB
     I              BLKR                            A#BLKR
     I              RTRF                            A#RTRF
     I              ATRD                            A#ATRD
     I              BCON                            A#BCON
     I              TIME                            A#TIME
     I              AUTS                            A#AUTS
     I              TACI                            A#TACI
     I              TMSI                            A#TMSI
     I              TCFR                            A#TCFR
     I              TOSN                            A#TOSN
     I              TNSN                            A#TNSN
     I              TNSP                            A#TNSP
     I              TOSV                            A#TOSV
     I              TVSN                            A#TVSN
     I              TVSP                            A#TVSP
     I              TDSN                            A#TDSN
     I              TDSP                            A#TDSP
     I              TDFS                            A#TDFS
     I              TSSQ                            A#TSSQ
     I              TCSR                            A#TCSR
     I              TCTR                            A#TCTR
     I              TDMC                            A#TDMC
     I              TOED                            A#TOED
     I              PRFC                            A#PRFC
     I              PRPC                            A#PRPC
     I              LCD                             A#LCD
     I              CHTP                            A#CHTP
     I              TNLU                            A#TNLU
     I              LSWS                            A#LSWS
     I              TCFC                            A#TCFC
     I              PTFR                            A#PTFR
     I              SPXR                            A#SPXR
     I              SPMD                            A#SPMD
     I              BPRC                            A#BPRC
     I              TPRC                            A#TPRC
     I              FXMP                            A#FXMP
     I              FXMR                            A#FXMR
     I              MAMT                            A#MAMT
     I              ICCY                            A#ICCY
     I              COAF                            A#COAF
     I              FRNT                            A#FRNT
     I              AFRT                            A#AFRT
     I              REPA                            A#REPA
     I              ORDE                            A#ORDE
     I              REPI                            A#REPI
     I              AUTH                            A#AUTH
     I              CRSK                            A#CRSK                                    CAS006
     I              LQPR                            A#LQPR                                    CAS006
     I              TINN                            A#TINN                                    CAS006
     I              ITRN                            A#ITRN                                    CAS006
     I              PRICN                           A#PRCN                                    CAS006
      *                                                                   CSE023
      ** RENAME DUPLICATE FIELDS                                          CSE023
     I              WHTX                            A#WHTX                CSE023
     I              BWDI                            A#BWDI                CSE023
     I              TMST                            A#TMST                                    CPK014
     I              PYFMQQ                          QQPYF1                                    CGL029
     I              PAYTQQ                          QQPAY1                                    CGL029
     I              FSPR                            A#FSPR                                  BUG10702
     I              FSPP                            A#FSPP                                  BUG10702
     I              EUTX                            A#EUTX                                  BUG10702
     I              EUTS                            A#EUTS                                  BUG10702
      *
      ** DS holding trade with later value date
     ITRADEB    E DSTRADSD
     I              RECI                            B#RECI
     I              TDRF                            B#TDRF
     I              TINC                            B#TINC
     I              TDSS                            B#TDSS
     I              TCNR                            B#TCNR
     I              TDTP                            B#TDTP
     I              NOML                            B#NOML
     I              TNMC                            B#TNMC
     I              TNMD                            B#TNMD
     I              TPDY                            B#TPDY
     I              TDVD                            B#TDVD
     I              TDBA                            B#TDBA
     I              ORBR                            B#ORBR
     I              TDBK                            B#TDBK
     I              TDDT                            B#TDDT
     I              TSUB                            B#TSUB
     I              LKRF                            B#LKRF
     I              TDMI                            B#TDMI
     I              TDNR                            B#TDNR
     I              TDID                            B#TDID
     I              AIIP                            B#AIIP
     I              TMKC                            B#TMKC
     I              TCAP                            B#TCAP
     I              ZZ005                           B#Z005
     I              ACIN                            B#ACIN
     I              DADJ                            B#DADJ
     I              ADIN                            B#ADIN
     I              ITRA                            B#ITRA
     I              TINA                            B#TINA
     I              TDCR                            B#TDCR
     I              PRIC                            B#PRIC
     I              EXDV                            B#EXDV
     I              RALL                            B#RALL
     I              SETC                            B#SETC
     I              TDER                            B#TDER
     I              TMDI                            B#TMDI
     I              TBCR                            B#TBCR
     I              SMTH                            B#SMTH
     I              PYFM                            B#PYFM
     I              PYFA                            B#PYFA
     I              PAYT                            B#PAYT
     I              PYTA                            B#PYTA
     I              TDFA                            B#TDFA
     I              ASNM                            B#ASNM
     I              CLTY                            B#CLTY
     I              DELT                            B#DELT
     I              DTFA                            B#DTFA
     I              DELF                            B#DELF
     I              DFFA                            B#DFFA
     I              TDSI                            B#TDSI
     I              PRYC                            B#PRYC
     I              PCOD                            B#PCOD
     I              TBCC                            B#TBCC
     I              TBCA                            B#TBCA
     I              TCCC                            B#TCCC
     I              TCCA                            B#TCCA
     I              TCC1                            B#TCC1
     I              TCA1                            B#TCA1
     I              TCC2                            B#TCC2
     I              TCA2                            B#TCA2
     I              TCC3                            B#TCC3
     I              TCA3                            B#TCA3
     I              TCC4                            B#TCC4
     I              TCA4                            B#TCA4
     I              TCC5                            B#TCC5
     I              TCA5                            B#TCA5
     I              TCC6                            B#TCC6
     I              TCA6                            B#TCA6
     I              TCC7                            B#TCC7
     I              TCA7                            B#TCA7
     I              TAXA                            B#TAXA
     I              BCMR                            B#BCMR
     I              CCMR                            B#CCMR
     I              TXRB                            B#TXRB
     I              BLKR                            B#BLKR
     I              RTRF                            B#RTRF
     I              ATRD                            B#ATRD
     I              BCON                            B#BCON
     I              TIME                            B#TIME
     I              AUTS                            B#AUTS
     I              TACI                            B#TACI
     I              TMSI                            B#TMSI
     I              TCFR                            B#TCFR
     I              TOSN                            B#TOSN
     I              TNSN                            B#TNSN
     I              TNSP                            B#TNSP
     I              TOSV                            B#TOSV
     I              TVSN                            B#TVSN
     I              TVSP                            B#TVSP
     I              TDSN                            B#TDSN
     I              TDSP                            B#TDSP
     I              TDFS                            B#TDFS
     I              TSSQ                            B#TSSQ
     I              TCSR                            B#TCSR
     I              TCTR                            B#TCTR
     I              TDMC                            B#TDMC
     I              TOED                            B#TOED
     I              PRFC                            B#PRFC
     I              PRPC                            B#PRPC
     I              LCD                             B#LCD
     I              CHTP                            B#CHTP                R0686
     I              TNLU                            B#TNLU
     I              LSWS                            B#LSWS                R0686
     I              TCFC                            B#TCFC
     I              PTFR                            B#PTFR
     I              SPXR                            B#SPXR
     I              SPMD                            B#SPMD
     I              BPRC                            B#BPRC
     I              TPRC                            B#TPRC
     I              FXMP                            B#FXMP
     I              FXMR                            B#FXMR
     I              MAMT                            B#MAMT
     I              ICCY                            B#ICCY
     I              COAF                            B#COAF
     I              FRNT                            B#FRNT
     I              AFRT                            B#AFRT
     I              REPA                            B#REPA
     I              ORDE                            B#ORDE
     I              REPI                            B#REPI
     I              AUTH                            B#AUTH
     I              CRSK                            B#CRSK                                    CAS006
     I              LQPR                            B#LQPR                                    CAS006
     I              TINN                            B#TINN                                    CAS006
     I              ITRN                            B#ITRN                                    CAS006
     I              PRICN                           B#PRCN                                    CAS006
      *                                                                   CSE023
      ** RENAME DUPLICATE FIELDS                                          CSE023
     I              WHTX                            B#WHTX                CSE023
     I              BWDI                            B#BWDI                CSE023
     I              TMST                            B#TMST                                    CPK014
     I              PYFMQQ                          QQPYF2                                    CGL029
     I              PAYTQQ                          QQPAY2                                    CGL029
     I              FSPR                            B#FSPR                                  BUG10702
     I              FSPP                            B#FSPP                                  BUG10702
     I              EUTX                            B#EUTX                                  BUG10702
     I              EUTS                            B#EUTS                                  BUG10702
      *
     ISDSECS    E DSSDSECSPD
     I** DS for access to Midas Securities Customers ICD
     I                                       25  84 ARRSE
     I*
     ISDCUST    E DSSDCUSTPD
     I** DS for access to Midas Customers ICD
     I*
     ISDALTN    E DSSDALTNPD
     I** DS for access to Midas Customers Additional Details table
     I*
     ISDBRCH    E DSSDBRCHPD
     I              QQDFAC                          QQDFA1                                    CGL029
     I** DS for access to Midas Branch Details Table
     I*
     ISDCURR    E DSSDCURRPD
     I** DS for access to Midas Currency ICD
     I*
     ISDNOST    E DSSDNOSTPD
     I              QQACCD                          QQACC1                                    CGL029
     I** DS for access to Midas Nostros ICD
     I*
     ISDSTRD    E DSSDSTRDPD
     I** DS for access to Midas Securities Trading ICD
     I                                       32  91 ARR36
     I*
     ISDBANK    E DSSDBANKPD
     I** DS for access to Midas Bank details ICD
     I*
     ISDBOOK    E DSSDBOOKPD
     I** DS for access to Midas Book details ICD
     I*
     ISDGELR    E DSSDGELRPD
     I              QQACCD                          QQACC2                                    CGL029
     I** DS for access to Midas General Ledger ICD
     I*
     ISDRETL    E DSSDRETLPD
     I              QQACCD                          QQACC3                                    CGL029
     I** DS for access to Midas Retail ICD
     I*
     ISDMMOD    E DSSDMMODPD
     I** Dummy record format for access to Modules File
     I*
     ISDPORT    E DSSDPORTPD
     I** Dummy record format for access to Portfolio Management ICD
     I*
     IDSFDY     E DSDSFDY
     I** First DS for access programs, short data structure
      *                                                                   176443
     IDSSDY     E DSDSSDY                                                 176443
      ** Long Data Structure                                              176443
     I*
     I/COPY WNCPYSRC,SE4110I001
     I/COPY ZSRSRC,ZSEDITZ2
     I/COPY ZSRSRC,ZNCDZ2
     I/COPY ZSRSRC,ZSDESCZ2
     C/EJECT
      *================================================================
      *  M A I N    P R O C E S S I N G                               *
      *================================================================
      *
      * Initialisation
     C                     EXSR INITPR
      *
      * Obtain ICD information
     C                     EXSR FIRST
      *
      * Check for database errors
     C           *INU7     IFEQ '1'
     C                     GOTO EAUDIT
     C                     ENDIF
      *
      *  Read first record from the Trades file TRDCONF
      *
     C                     READ TRDCONF                  31
      *
      ***  If the system is in Multibranched Mode,
      *
     C           MBIN      IFEQ 'Y'
      *
      ** Only process record if branch is requested.  If so, get name.
      *
     C           *IN31     IFEQ '0'
     C           ENT       IFNE 'ALL'
     C           ENT       ANDNETDBA
     C                     SETON                     31
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
     C           *IN31     DOWEQ'0'
      *
      * If Buy-Sell Back, check to see if book is a Buy-Sell book
     C           LKRF      IFNE *BLANKS
     C                     EXSR SRBOOK
      *
      * If so, save details of trade read & access linked trade details
     C           BDBYSL    IFEQ 'Y'
     C                     EXSR LINKTR
      *
      * Clear all output fields
     C                     EXSR CLROUT
      *
      * Store the value date of the 1st trade as the Event Control Date
     C                     Z-ADDA#TDVD    ECD     50
      *
      *  Execute subroutine PRINTX in order to format lines 1-18 of the
      *  confirmation report and the Special Instructions.
     C                     EXSR PRINTX
      *
      *  Execute subroutine PRINTA in order to format 'Payment at Value
      *  Date' fields.
     C                     EXSR PRINTA
      *
      *  Execute subroutine PRINTB in order to format 'Payment at
      *  Maturity Date' fields.
     C                     EXSR PRINTB
      *
     C           ERRTAG    TAG
      *
      *  If any DB errors when CHAINing to a file in subroutines,
      *  perform error audit report routine.
     C           *INU7     IFEQ '1'
     C                     GOTO EAUDIT
      *
      *  Else write out the data to the printer file.
     C                     ELSE
     C                     WRITETRADCON
      *
     C                     ENDIF
      *
      *  Perform SR/UPDATE to update the confirmation required and
      *  message indicator fields on the Trades file.
     C                     EXSR UPDATE
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      *  Read next trades record.
     C                     READ TRDCONF                  31
      *
      ***  If the system is in Multibranched Mode,
      *
     C           MBIN      IFEQ 'Y'
      *
      ** Only process record if branch is requested
      *
     C           *IN31     IFEQ '0'
     C           ENT       IFNE 'ALL'
     C           ENT       ANDNETDBA
     C                     SETON                     31
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      *
     C                     ENDDO
      *
      ** If reach end of details and detail printer file not opened
      ** then print 'NO DETAILS TO REPORT' on audit report
     C           *IN61     IFEQ '0'
     C           *IN31     ANDEQ'1'
     C                     WRITEHEADAU
     C                     WRITENONE
      *
      ** RCF Processing for Audit File
     C                     EXSR RCFAU
     C                     ENDIF
      *
     C                     GOTO END
      *
     C           EAUDIT    TAG
     C                     EXSR AUDIT
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *                                                               *
     C           END       TAG
      *
     C                     SETON                     LR
      *                                                               *
      *================================================================
      /EJECT
      *****************************************************************
      *                                                               *
      * INITPR - INITIAL PROCESSING                                   *
      *                                                               *
      *****************************************************************
      *
     C           INITPR    BEGSR
      *
      * Parameter list
      *
     C           *ENTRY    PLIST
     C                     PARM           SEQ     5
     C                     PARM           ENT     3
      *
      * Clear LDA
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVE *BLANK    DBLOT
     C                     MOVE 'SE4110  'DBPGM
     C                     OUT  LDA
      *
      * Access DTAARA/RUNDAT
     C           *NAMVAR   DEFN RUNDAT    RUNDT
     C                     IN   RUNDT
      *
      *  Set date format indicator
     C           DFF       IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ENDIF
      *
      *  Initialise subscripts
      *
     C                     Z-ADD1         A       20
     C                     Z-ADD1         B       20
     C                     Z-ADD1         Y       20
     C                     Z-ADD1         V       20
      *
      *  Set up key to access TRDCONF
     C           K#TRAD    KLIST
     C                     KFLD           W#TDBA  3
     C                     KFLD           W#TDRF  6
      *
      *  Set up key to access INVTPD for processing type field
     C           KEYFLD    KLIST
     C                     KFLD           NMCY
     C                     KFLD           SITP
      *
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * FIRST - SUBROUTINE TO ACCESS ICD INFORMATION                  *
      *                                                               *
      *****************************************************************
      *
     C           FIRST     BEGSR                           ** FIRST **
      *
      ** Test whether multibranching is on
      *
     C           MBIN      IFEQ 'Y'
     C                     SETON                     37
     C                     ENDIF
      *
     C/COPY WNCPYSRC,SE4110C001
      *
      **  Access Switchable features file for MT5xx processing - S01401
     C                     CALL 'AOSARDR0'
     C                     PARM *BLANKS   PRTCD   7
     C                     PARM '*VERIFY' POPTN   7
     C                     PARM 'S01401'  PSARD   6
      *
     C           PRTCD     IFNE *BLANK
     C                     MOVE 'Y'       S01401  1
     C                     ENDIF
      *
      ***  Check if CAC005 Feature is switched on.
      *
     C                     MOVE 'N'       CAC005
     C                     CALL 'AOSARDR0'
     C                     PARM '       ' WRTCD   7
     C                     PARM '*VERIFY' WOPTN   7
     C                     PARM 'CAC005'  WSARD   6
      *
     C           WRTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       CAC005  1
     C                     ENDIF
      *
      ** Access Switchable Features file to determine if CSE031 is                          MD057247
      ** installed in the system.                                                           MD057247
      *                                                                                     MD057247
     C                     CALL 'AOSARDR0'                                                  MD057247
     C                     PARM           URTNCD  7                                         MD057247
     C                     PARM '*VERIFY' UOPTN   7                                         MD057247
     C                     PARM 'CSE031'  UUKEY   6                                         MD057247
     C                     PARM           UDSFDY 76                                         MD057247
      *                                                                                     MD057247
     C                     MOVE 'N'       CSE031  1                                         MD057247
     C           URTNCD    IFEQ *BLANKS                                                     MD057247
     C                     MOVE 'Y'       CSE031                                            MD057247
     C                     ENDIF                                                            MD057247
      *                                                                                     MD057247
      ** Access Switchable Features file to determine if CSE071 is                          MD057247
      ** installed in the system.                                                           MD057247
      *                                                                                     MD057247
     C                     CALL 'AOSARDR0'                                                  MD057247
     C                     PARM           URTNCD                                            MD057247
     C                     PARM '*VERIFY' UOPTN                                             MD057247
     C                     PARM 'CSE071'  UUKEY                                             MD057247
     C                     PARM           UDSFDY                                            MD057247
      *                                                                                     MD057247
     C                     MOVE 'N'       CSE071  1                                         MD057247
     C           URTNCD    IFEQ *BLANKS                                                     MD057247
     C                     MOVE 'Y'       CSE071                                            MD057247
     C                     ENDIF                                                            MD057247
      *
      **  Access SDBANKPD for Bank details.
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*MSG    'PRTCD   7
     C                     PARM '*FIRST  'POPTN   7
     C           SDBANK    PARM SDBANK    DSFDY
      *
     C           PRTCD     IFNE *BLANK
     C                     Z-ADD60        DBASE             ************
     C                     MOVE 'SDBANKPD'DBFILE            * DATABASE *
     C                     MOVEL*BLANKS   DBKEY             * ERROR 60 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR                                  *
     C                     OPEN SE4110AU
     C                     WRITEHEADAU
     C                     WRITEERROR
     C                     CLOSESE4110AU
     C                     ENDIF
      *
      **  Access SDGELRPD for General Ledger details.
      *
     C**********           CALL 'AOGELRR0'                                                    CGL029
     C                     CALL 'AOGELRR1'                                                    CGL029
     C                     PARM '*MSG    'PRTCD
     C                     PARM '*FIRST  'POPTN
     C********** SDGELR    PARM SDGELR    DSFDY                                               CGL029
     C           SDGELR    PARM SDGELR    DSSDY                                               CGL029
      *
     C           PRTCD     IFNE *BLANK
     C                     Z-ADD61        DBASE             ************
     C                     MOVE 'SDGELRPD'DBFILE            * DATABASE *
     C                     MOVEL*BLANKS   DBKEY             * ERROR 61 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR                                  *
     C                     OPEN SE4110AU
     C                     WRITEHEADAU
     C                     WRITEERROR
     C                     CLOSESE4110AU
     C                     ENDIF
      *
      **  Access SDSTRDPD for Securities Trading details.
      *
     C                     CALL 'AOSTRDR0'
     C                     PARM '*MSG    'PRTCD
     C                     PARM '*FIRST  'POPTN
     C           SDSTRD    PARM SDSTRD    DSFDY
      *
     C           PRTCD     IFNE *BLANK
     C                     Z-ADD62        DBASE             ************
     C                     MOVE 'SDSTRDPD'DBFILE            * DATABASE *
     C                     MOVEL*BLANKS   DBKEY             * ERROR 62 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR                                  *
     C                     OPEN SE4110AU
     C                     WRITEHEADAU
     C                     WRITEERROR
     C                     CLOSESE4110AU
     C                     ENDIF
      *
      **  Access SDMMODPD for Portfolio Management Indicator.
      *
     C                     CALL 'AOMMODR0'
     C                     PARM '*MSG    'PRTCD   7
     C                     PARM '*FIRST  'POPTN   7
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
     C           PRTCD     IFNE *BLANK
     C           BGTYLC    OREQ 'D'
     C                     Z-ADD54        DBASE             ************
     C                     MOVE 'SDMMODPD'DBFILE            * DATABASE *
     C                     MOVEL*BLANKS   DBKEY             * ERROR 54 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR                                  *
     C                     OPEN SE4110AU
     C                     WRITEHEADAU
     C                     WRITEERROR
     C                     CLOSESE4110AU
     C                     END
      *
     C**  Access SDPORTPD for Portfolio Reference.
      *
     C           BGPFMG    IFEQ 'Y'
      *
     C                     CALL 'AOPORTR0'
     C                     PARM '*MSG    'PRTCD
     C                     PARM '*FIRST  'POPTN
     C           SDPORT    PARM SDPORT    DSFDY
      *
     C           PRTCD     IFNE *BLANK
     C                     Z-ADD55        DBASE             ************
     C                     MOVE 'SDPORTPD'DBFILE            * DATABASE *
     C                     MOVEL*BLANKS   DBKEY             * ERROR 55 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR                                  *
     C                     OPEN SE4110AU
     C                     WRITEHEADAU
     C                     WRITEERROR
     C                     CLOSESE4110AU
     C                     ENDIF
     C                     ENDIF
      *
      **  Access SDRETLPD for Retail Banking ICD.
      *
     C           BGRTBN    IFEQ 'Y'                                                         MD035214
     C                     CALL 'AORETLR0'
     C                     PARM '*MSG    'PRTCD   7
     C                     PARM '*FIRST  'POPTN   7
     C           SDRETL    PARM SDRETL    DSFDY
      *
     C           PRTCD     IFNE *BLANK
     C                     Z-ADD56        DBASE             ************
     C                     MOVE 'SDRETLPD'DBFILE            * DATABASE *
     C                     MOVEL*BLANKS   DBKEY             * ERROR 56 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR                                  *
     C                     OPEN SE4110AU
     C                     WRITEHEADAU
     C                     WRITEERROR
     C                     CLOSESE4110AU
     C                     ENDIF
     C                     ENDIF                                                            MD035214
      *
     C/COPY WNCPYSRC,SE4110C022
      *
     C                     ENDSR
     C*****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  PRINTX -  FORMAT OUTPUT FIELDS ON LINES 1 - 17 AND SPECIAL   *
      *            INSTRUCTIONS AND ISMA RULES MESSAGE.               *
      *                                                               *
      *****************************************************************
      *
     C           PRINTX    BEGSR
      *
      *  Check that the new branch number of the trade = current branch
     C           A#TDBA    IFNE CHKBR
      *
      *  If first time ind. (*IN61) is on, close the existing SE4110P1
      *  file. If not on, set it on.
     C           *IN61     IFEQ '1'
     C                     CLOSESE4110P1
     C                     ELSE
     C                     MOVE *ON       *IN61
     C                     ENDIF
      *
      *  Open new SE4110P1 file for each new branch and move the branch
      *  code to the temp field for checking with next trade.
     C                     OPEN SE4110P1
     C                     MOVE A#TDBA    CHKBR   3
     C                     Z-ADD0         PAGE
      *
      ** Detemine and move new branch name to output field
     C                     EXSR SRBRCH
     C                     MOVELA8BRNM    O#BRNM
      *
      ** RCF Processing for Detail Printer File
     C                     EXSR RCFP1
      *
     C                     ENDIF
      *
      * Use the Counterparty number to CHAIN to SDCUSTPD file for the
      * Customer name and address lines.
     C********** A#TCNR    IFNE *ZEROS                                                        CSD027
     C           A#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVELA#TCNR    PSECS
     C                     EXSR SRSECS
     C                     MOVELA#TCNR    PCUST
      *
     C           BFADCD    IFEQ ' '
     C           BFADCD    OREQ 'B'
     C                     EXSR SRCUST
     C                     ELSE
     C                     EXSR SRALTN
     C                     ENDIF
      *
      *  If error do error routine.
     C           *INU7     IFEQ '1'
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR    *
     C                     ENDIF                           ***************
      *
     C**********           MOVE BBCNA1    LIN01                                               CSD053
     C**********           MOVE BBCNA2    LIN02                                               CSD053
     C**********           MOVE BBCNA3    LIN03                                               CSD053
     C**********           MOVE BBCNA4    LIN04                                               CSD053
     C                     MOVELBBCNA1    LIN01                                               CSD053
     C                     MOVELBBCNA2    LIN02                                               CSD053
     C                     MOVELBBCNA3    LIN03                                               CSD053
     C                     MOVELBBCNA4    LIN04                                               CSD053
     C                     ELSE
     C                     MOVE *BLANKS   LIN01
     C                     MOVE *BLANKS   LIN02
     C                     MOVE *BLANKS   LIN03
     C                     MOVE *BLANKS   LIN04
     C                     ENDIF
      *
      *  If the trade is incomplete output an incomplete message on the
      *  trade confirmation.
     C           A#TINC    IFEQ 'I'
     C                     MOVEAARRA,21   O#INCO
     C                     ELSE
     C                     MOVE *BLANKS   O#INCO
     C                     ENDIF
      *
      *  Load line 6 of confirmation (i.e. 'We confirm ...')
     C                     MOVEAARRA,1    LIN06
      *
      *  Convert Trade Date for output
     C                     MOVE A#TDDT    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    O#TDDT  7
      *
      *  Output the Currency field
     C                     MOVE A#TNMC    O#CCY   3
      *
      *  CHAIN to the Securities file using security shortname on the
      *  trade so that the security descrpitions can be obtained using
      *  the SR/ZSDESC (security full name = ZFNM1).
     C           A#TDSS    CHAINSECTYDF              41
      *
     C           *IN41     IFEQ '1'
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C           *LOCK     IN   LDA
     C                     MOVE 'SECTY'   DBFILE
     C                     MOVELA#TDSS    DBKEY            **************
     C                     Z-ADD7         DBASE            * DB ERROR 7 *
     C                     OUT  LDA                        **************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG                                 ***
     C                     ENDIF
      *
     C                     MOVE *BLANKS   ZSRPN
     C                     MOVE SFN1      ZSFN1
     C                     MOVE BVRIDF    ZRSFD
      *
      * Save security coupon rate and move in value of trade coupon
      * rate for use in ZSDESC
     C                     Z-ADDCPNR      CPNRSV 117
     C                     Z-ADDTDCR      CPNR
     C                     EXSR ZSDESC
      *
      * Restore value of CPNR
     C                     Z-ADDCPNRSV    CPNR
      *
      *  CHAIN to the investment types file for the processing type of
      *  the current security.
     C           KEYFLD    CHAININVTPDF              41
      *
     C           *IN41     IFEQ '1'
     C           RECI      ORNE 'D'
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C           *LOCK     IN   LDA
     C                     MOVE 'INVTP'   DBFILE
     C                     MOVELNMCY      ERRKEY  6
     C                     MOVE SITP      ERRKEY
     C                     MOVELERRKEY    DBKEY            ***************
     C                     Z-ADD9         DBASE            * DB ERROR 9  *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C/COPY WNCPYSRC,SE4110CCP2
      *
      *  Edit the Nominal field on the Trades file using the SR/ZSEDIT
      *  and the Nominal decimal places on the trades.
      *  Move the output field to a smaller field to drop the sign.
     C                     Z-ADDA#NOML    ZFLD15
     C           PROT      IFEQ '8'
     C                     MULT A#TCFC    ZFLD15    H
     C                     ENDIF
      *
     C                     MOVE 'J'       ZECODE
     C                     Z-ADDTNMD      ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    TEMP   17
     C                     MOVE *BLANKS   ARRB
     C                     MOVEATEMP      ARRB
      *
      * Execute the SR/STAR so that "*" fills all unused parts of a
      * numeric field.
     C                     EXSR STAR
     C                     MOVEAARRB      O#NOML 16
      *
      *  Obtain Value Date in the format DdMmmYy
     C                     MOVE A#TDVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    O#VALD
      *
      *  Obtain Maturity Date in the format DdMmmYy
     C                     MOVE B#TDVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    O#MATD
      *
      ** Set up 'Trade Purchased' and 'Trade Sold' narratives.
     C           A#TDTP    IFEQ 'TP'
     C                     MOVEAARRA,42   O#VNAR
     C                     MOVEAARRA,43   O#MNAR
     C                     ELSE
     C                     MOVEAARRA,42   O#MNAR
     C                     MOVEAARRA,43   O#VNAR
     C                     ENDIF
      *
      *  If the initial date is GT 0 get the Next Coupon Date for the
      *  security using ZNCD.
     C           ITLD      IFGT 0
     C           CPNR      ANDGT0
      *
     C                     MOVEAARRA,36   LIN10
     C                     EXSR ZNCD
     C                     MOVE NCD       ZDAYNO
      *
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    O#NCD
      *
     C                     ELSE
     C                     MOVE *BLANKS   LIN10
     C                     MOVE *BLANKS   O#NCD
     C                     ENDIF
      *
      *---------- Format Value Date details (lines 11-13)-----------
      *
      *  Get the Price/Discount/Yield field in edited from using ZSEDIT
      *  Put output field into smaller field to drop sign then use
      *  SR/STAR to asterisk fill the field.
     C                     Z-ADD*ZEROS    ZFLD15
     C                     MOVE A#TPDY    ZFLD15
     C                     MOVE 'L'       ZECODE
     C                     Z-ADD8         ZDECS
      *
     C                     EXSR ZSEDIT
      *
     C                     MOVE ZOUT21    TEMP
     C                     MOVE *BLANKS   ARRB
     C                     MOVEATEMP      ARRB
      *
     C                     EXSR STAR
     C                     MOVEAARRB      O#VPDY 16
      *
      *  Find currency decimal places for nominal currency
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG    'PRTCD
     C                     PARM '*KEY    'POPTN
     C                     PARM A#TNMC    PCCY    3
     C***********SDCURR    PARM SDCURR    DSFDY                           CSD006
     C           SDCURR    PARM SDCURR    DSSDY                           CSD006
      *
     C           PRTCD     IFNE *BLANK
     C                     MOVE '63'      DBASE             ************
     C                     MOVE 'SDCURRPD'DBFILE            * DATABASE *
     C                     MOVELA#TNMC    DBKEY             * ERROR 63 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR                                  *
     C                     OPEN SE4110AU
     C                     WRITEHEADAU
     C                     WRITEERROR
     C                     CLOSESE4110AU
     C                     ENDIF
      *
      *  Use Consideration from trade
     C                     Z-ADDA#TCSR    W#TCSR 152
      *
      *  If mortgage backed security (PROT='8') multiply the Consider-
      *  ation by the Current Factor.
     C********** PROT      IFEQ '8'                                                           260909
     C********** W#TCSR    MULT A#TCFC    W#TCSR    H                                         260909
     C**********           ENDIF                                                              260909
      *
     C                     Z-ADDW#TCSR    W#CON  130H
      *
      *  Move the result of the calculation to ZFLD15 ready to be
      *  edited using SR/ZSEDIT. Move the ouptut field from ZSEDIT to
      *  ARRB so that SR/STAR can be used to asterisk fill field.
     C                     Z-ADDW#CON     ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
      *
     C                     EXSR ZSEDIT
      *
     C                     MOVE ZOUT21    TEMP2  18
     C                     MOVE *BLANKS   ARRB
     C                     MOVEATEMP2     ARRB
      *
     C                     EXSR STAR
     C                     MOVEAARRB      O#VCON 17
      *
      *  Calculate the number of days of accrued interest and interest e.
      *  type, if any interest...
     C           A#ITRA    IFNE *ZEROS
     C           PROT      ANDNE'6'
      *
     C           A#ACIN    IFEQ 'C'
     C           A#ACIN    OREQ 'X'
     C                     EXSR DAYSAC
     C                     ENDIF
      *
     C           A#ACIN    IFEQ 'C'
     C                     MOVE '(CUM )'  O#VCPN
     C                     ENDIF
     C           A#ACIN    IFEQ 'X'
     C                     MOVE '(EX  )'  O#VCPN
     C                     ENDIF
     C           A#ACIN    IFEQ 'F'
     C                     MOVE '(FLAT)'  O#VCPN
     C                     ENDIF
      *
      *  If Interest Adjustment field is zero and no days adjustment,
      *  use interest amount as accrued interest.
     C                     MOVE A#ITRA    ZFLD15
      *
      *  If Interest Adjustment and Days Adjustment (diff), add Days
      *  Adjust. to Days Interest.  Interest amount is Accrued Interest.
     C           A#TINA    IFNE 0
     C           A#DADJ    IFNE 0
      *
     C           A#ADIN    IFEQ 'D'
     C           ZDDAYS    ADD  A#DADJ    ZDDAYS
     C                     ENDIF
      *
      *  Days Adjustment (actual) is actual days interest
     C           A#ADIN    IFEQ 'A'
     C                     MOVE A#DADJ    ZDDAYS
     C                     ENDIF
      *
     C                     ELSE
      *
      *  ...Interest Adjustment but no Days Adjustment.
     C                     Z-ADDA#TINA    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
      *
     C                     MOVE *BLANKS   ARRB
     C                     MOVEAZOUT21    ARRB
     C                     EXSR STAR
      *
     C                     MOVEAARRB      INTADJ 21
     C           A#ITRA    SUB  A#TINA    ZFLD15
     C                     ENDIF
      *
     C                     ENDIF
      *
      *  Edit Interest amount
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
      *
     C                     MOVE *BLANKS   ARRB
     C                     MOVEAZOUT21    ARRB
      *
     C                     EXSR STAR
     C                     MOVEAARRB      O#VINT
      *
      * ...else no interest, non-display interest fields.
     C                     ELSE
     C                     MOVE *ON       *IN20
      *
     C                     ENDIF
      *
      *  Output the Total Value in edited form (with asterisk fill).
     C                     Z-ADDA#TCTR    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
      *
     C                     MOVE *BLANKS   ARRB
     C                     MOVEAZOUT21    ARRB
     C                     EXSR STAR
      *
     C                     MOVEAARRB      O#VVAL 21
      *
      *
      *--------- Format Maturity Date details (lines 15-17)----------
      *
      *  Get the Price/Discount/Yield field in edited from using ZSEDIT
      *  Put output field into smaller field to drop sign then use
      *  SR/STAR to asterisk fill the field.
     C                     Z-ADD*ZEROS    ZFLD15
     C                     MOVE B#TPDY    ZFLD15
     C                     MOVE 'L'       ZECODE
     C                     Z-ADD8         ZDECS
      *
     C                     EXSR ZSEDIT
      *
     C                     MOVE ZOUT21    TEMP
     C                     MOVE *BLANKS   ARRB
     C                     MOVEATEMP      ARRB
      *
     C                     EXSR STAR
     C                     MOVEAARRB      O#MPDY 16
      *
      *  Find currency decimal places for nominal currency
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG    'PRTCD
     C                     PARM '*KEY    'POPTN
     C                     PARM B#TNMC    PCCY    3
     C***********SDCURR    PARM SDCURR    DSFDY                           CSD006
     C           SDCURR    PARM SDCURR    DSSDY                           CSD006
      *
     C           PRTCD     IFNE *BLANK
     C                     MOVE '63'      DBASE             ************
     C                     MOVE 'SDCURRPD'DBFILE            * DATABASE *
     C                     MOVELB#TNMC    DBKEY             * ERROR 63 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR                                  *
     C                     OPEN SE4110AU
     C                     WRITEHEADAU
     C                     WRITEERROR
     C                     CLOSESE4110AU
     C                     ENDIF
      *
      *  Use Consideration from trade
     C                     Z-ADDB#TCSR    W#TCSR 152
      *
      *  If mortgage backed security (PROT='8') multiply the Consider-
      *  ation by the Current Factor.
     C********** PROT      IFEQ '8'                                                           260909
     C********** W#TCSR    MULT B#TCFC    W#TCSR    H                                         260909
     C**********           ENDIF                                                              260909
      *
     C                     Z-ADDW#TCSR    W#CON  130H
      *
      *  Move the result of the calculation to ZFLD15 ready to be
      *  edited using SR/ZSEDIT. Move the ouptut field from ZSEDIT to
      *  ARRB so that SR/STAR can be used to asterisk fill field.
     C                     Z-ADDW#CON     ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
      *
     C                     EXSR ZSEDIT
      *
     C                     MOVE ZOUT21    TEMP2  18
     C                     MOVE *BLANKS   ARRB
     C                     MOVEATEMP2     ARRB
      *
     C                     EXSR STAR
     C                     MOVEAARRB      O#MCON 17
      *
      *  Calculate the number of days of accrued interest and interest e.
      *  type, if any interest...
     C           B#ITRA    IFNE *ZEROS
     C           PROT      ANDNE'6'
      *
     C           B#ACIN    IFEQ 'C'
     C           B#ACIN    OREQ 'X'
     C                     EXSR DAYSAC
     C                     ENDIF
      *
     C           B#ACIN    IFEQ 'C'
     C                     MOVE '(CUM )'  O#MCPN
     C                     ENDIF
     C           B#ACIN    IFEQ 'X'
     C                     MOVE '(EX  )'  O#MCPN
     C                     ENDIF
     C           B#ACIN    IFEQ 'F'
     C                     MOVE '(FLAT)'  O#MCPN
     C                     ENDIF
      *
      *  If Interest Adjustment field is zero and no days adjustment,
      *  use interest amount as accrued interest.
     C                     MOVE B#ITRA    ZFLD15
      *
      *  If Interest Adjustment and Days Adjustment (diff), add Days
      *  Adjust. to Days Interest.  Interest amount is Accrued Interest.
     C           B#TINA    IFNE 0
     C           B#DADJ    IFNE 0
      *
     C           B#ADIN    IFEQ 'D'
     C           ZDDAYS    ADD  B#DADJ    ZDDAYS
     C                     ENDIF
      *
      *  Days Adjustment (actual) is actual days interest
     C           B#ADIN    IFEQ 'A'
     C                     MOVE B#DADJ    ZDDAYS
     C                     ENDIF
      *
     C                     ELSE
      *
      *  ...Interest Adjustment but no Days Adjustment.
     C                     Z-ADDB#TINA    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
      *
     C                     MOVE *BLANKS   ARRB
     C                     MOVEAZOUT21    ARRB
     C                     EXSR STAR
      *
     C                     MOVEAARRB      INTADJ 21
     C           B#ITRA    SUB  B#TINA    ZFLD15
     C                     ENDIF
      *
     C                     ENDIF
      *
      *  Edit Interest amount
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
      *
     C                     MOVE *BLANKS   ARRB
     C                     MOVEAZOUT21    ARRB
      *
     C                     EXSR STAR
     C                     MOVEAARRB      O#MINT
      *
      * ...else no interest, non-display fields.
     C                     ELSE
     C                     MOVE *ON       *IN21
      *
     C                     ENDIF
      *
      *  Output the Total Value in edited form (with asterisk fill).
     C                     Z-ADDB#TCTR    ZFLD15
     C                     Z-ADDA6NBDP    ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
      *
     C                     MOVE *BLANKS   ARRB
     C                     MOVEAZOUT21    ARRB
     C                     EXSR STAR
      *
     C                     MOVEAARRB      O#MVAL 21
      *
      *
      *  If the Special Instructions field is not blank, print those
     C*  instructions, else print nothing.
     C           A#TDSI    IFNE *BLANKS
     C           B#TDSI    ORNE *BLANKS
     C                     MOVEAARRA,30   LIN38A
     C                     MOVE A#TDSI    LIN39A
     C                     MOVE B#TDSI    LIN39C
     C                     ELSE
     C                     MOVE *BLANKS   LIN38A
     C                     MOVE *BLANKS   LIN39A
     C                     MOVE *BLANKS   LIN39C
     C                     ENDIF
      *
      ***  If Trade is in accordance with the ISMA rules, print out
      ***  a message but only if the trade is not a share.
     C           PROT      IFNE '4'
     C           A#AIIP    ANDEQ'Y'
      *
     C           TDMI      IFEQ 'S'
     C                     MOVEAARRA,31   O#ISM1
     C                     MOVEAARRA,32   O#ISM2
     C                     ELSE
     C           TDMI      IFEQ 'P'
     C                     MOVEAARRA,31   O#ISM1
     C                     MOVEAARRA,39   O#ISM2
     C                     ELSE
     C                     MOVE *BLANKS   O#ISM1
     C                     MOVE *BLANKS   O#ISM2
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      ***  If S.W.I.F.T. confirmation message generated = 'Y' then
      ***  Output 'AUTO TRANSMISSION - DO NOT SEND'.
      *
     C                     MOVE *OFF      *IN01
     C           S01401    IFEQ 'Y'
     C           TDRF      CHAINTRADSDY1             41
     C           *IN41     IFEQ *OFF
     C           T1GMEC    ANDEQ'Y'
     C                     MOVE *ON       *IN01
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  PRINTA -  GETS ALL INFORMATION FOR CONFIRMATIONS FOR THE     *
      *            FIRST (VALUE DATE) TRADE.                          *
      *                                                               *
      *****************************************************************
      *
     C           PRINTA    BEGSR
      *
      *  Set up work fields for use with TESTN in later subroutines.
     C                     MOVE A#PYFM    W#PYFM
     C                     MOVE A#PAYT    W#PAYT
     C                     MOVE A#TDFA    W#TDFA
     C                     MOVE A#DTFA    W#DTFA
     C                     MOVE A#DFFA    W#DFFA
     C                     MOVELA#DFFA    X#DFFA  6
     C                     MOVELA#DTFA    X#DTFA  6
      *
      *  For lines 20 - 24 of the confirmation, execute the SR/INSTR1.
     C                     EXSR INSTR1
      *
      *  Process 'For A/C Of - Pay To' fields (Lines 26A, 26B & 27B).
     C                     EXSR ACCPA1
      *
      *  Process 'For A/C Of - Deliver To' fields (35B, 35E, 35F, 36B
      *  & 35A for trade sold).
     C                     EXSR ACCTO1
      *
      *  Process 'For A/C Of - Deliver From' fields (35B, 35E, 35F,
      *  35A & 36B for trade purchased).
     C                     EXSR ACCFR1
      *
      *
      *  End subroutine
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  PRINTB -  GETS ALL INFORMATION FOR CONFIRMATIONS FOR THE     *
      *            SECOND (MATURITY DATE) TRADE.  TRADE CONFIRMATION  *
      *            PRINTED AT THE END.                                *
      *                                                               *
      *****************************************************************
      *
     C           PRINTB    BEGSR
      *
      *  Set up work fields for use with TESTN in later subroutines.
     C                     MOVE *BLANKS   W#PYFM
     C                     MOVE *BLANKS   W#PAYT
     C                     MOVE *BLANKS   W#TDFA
     C                     MOVE *BLANKS   W#DTFA
     C                     MOVE *BLANKS   W#DFFA
     C                     MOVE *BLANKS   X#DFFA
     C                     MOVE *BLANKS   X#DTFA
      *
     C                     MOVE B#PYFM    W#PYFM
     C                     MOVE B#PAYT    W#PAYT
     C                     MOVE B#TDFA    W#TDFA
     C                     MOVE B#DTFA    W#DTFA
     C                     MOVE B#DFFA    W#DFFA
     C                     MOVELB#DFFA    X#DFFA
     C                     MOVELB#DTFA    X#DTFA
      *
      *  For lines 29 - 34 on the confirmation, execute the SR/INSTR2.
     C                     EXSR INSTR2
      *
      *  Process 'For A/C Of - Pay To' fields (Lines 26C, 26D & 27D).
     C                     EXSR ACCPA2
      *
      *  Process 'For A/C Of - Deliver To' fields (35C, 35D, 36D, 35G
      *  & 35H for trade sold).
     C                     EXSR ACCTO2
      *
      *  Process 'For A/C Of - Deliver From' fields (35C, 35D, 36D,
      *  35G & 35H for trade purchased).
     C                     EXSR ACCFR1
      *
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  ACCPA1 - PROCESSES 'FOR A/C OF - PAY' FIELDS (VALUE DATE     *
      *           SIDE)                                               *
      *                                                               *
      *****************************************************************
      *
     C           ACCPA1    BEGSR
      *
      * If 'For a/c of (pay)' field NE *BLANKS put out message to
      * LIN26A.  If A#TDFA only contains 2 digits, access Nostro table
      * (using settlement ccy) and obtain Customer No.  Use this to get
      * customer name and town from Customer Details table.  Else
      * A#TDFA contains 6 digit customer no.  Access SDCUSTPD as
      * before for name and town.
     C           A#TDFA    IFNE *BLANKS
     C                     MOVEAARRA,29   LIN26A
      *
      *  See if field contains 2 (Nostro) or 6 (Customer no.) digits.
     C           TDFAN1    IFNE *BLANKS
      *
      *  If 6 digits use the number to CHAIN to the Customer Details
      *  file to get the customer name and town.
     C                     MOVELA#TDFA    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD11        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 11 *
     C                     ENDIF                           ***************
      *
     C                     MOVELBBCRNM    LIN26B
     C                     MOVELBBCRTN    LIN27B
      *
     C                     ELSE
      *
      *  If A#TDFA 2 digits, combine them with Settlement Currency to  N
      *  produce Nostro code.  Find Customer Number from SDNOSTPD.
      *  Use this to CHAIN to SDCUSTPD as before for name and town.
     C                     MOVELA#SETC    PCYCD   3
     C                     MOVELA#TDFA    PNONB   2
     C                     EXSR SRNOST
      *
      *  If error GOTO end and perform error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD12        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 12 *
      *                                                    ***************
     C                     ELSE
      *
      *  If no error, use customer no. from SDNOSTPD to get name & town
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD68        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 68 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
     C                     MOVE BBCRNM    LIN26B
     C                     MOVE BBCRTN    LIN27B
      *
     C                     ENDIF
      *
     C                     ELSE
      *
      *  ...else A#TDFA = *BLANKS and move blanks to output fields.
     C                     MOVE *BLANKS   LIN26A
     C                     MOVE *BLANKS   LIN26B
     C                     MOVE *BLANKS   LIN27B
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  ACCPA2 - PROCESSES 'FOR A/C OF - PAY' FIELDS (MATURITY DATE  *
      *           SIDE)                                               *
      *                                                               *
      *****************************************************************
      *
     C           ACCPA2    BEGSR
      *
      * If 'For a/c of (pay)' field NE *BLANKS put out message to
      * LIN26C.  If B#TDFA only contains 2 digits, access Nostro table
      * (using settlement ccy) and obtain Customer No.  Use this to get
      * customer name and town from Customer Details table.  Else
      * B#TDFA contains 6 digit customer no.  Access SDCUSTPD as
      * before for name and town.
     C           B#TDFA    IFNE *BLANKS
     C                     MOVEAARRA,29   LIN26C
      *
      *  See if field contains 2 (Nostro) or 6 (Customer no.) digits.
     C           TDFAN1    IFNE *BLANKS
      *
      *  If 6 digits use the number to CHAIN to the Customer Details
      *  file to get the customer name and town.
     C                     MOVELB#TDFA    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD22        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 22 *
     C                     ENDIF                           ***************
      *
     C                     MOVELBBCRNM    LIN26D
     C                     MOVELBBCRTN    LIN27D
      *
     C                     ELSE
      *
      *  If B#TDFA 2 digits, combine them with Settlement Currency to
      *  produce Nostro code.  Find Customer Number from SDNOSTPD.
      *  Use this to CHAIN to SDCUSTPD as before for name and town.
     C                     MOVELB#SETC    PCYCD   3
     C                     MOVELB#TDFA    PNONB   2
     C                     EXSR SRNOST
      *
      *  If error GOTO end and perform error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD23        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 23 *
      *                                                    ***************
     C                     ELSE
      *
      *  If no error, use customer no. from SDNOSTPD to get name & town
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD24        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 24 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
     C                     MOVE BBCRNM    LIN26D
     C                     MOVE BBCRTN    LIN27D
      *
     C                     ENDIF
      *
     C                     ELSE
      *
      *  ...else C#TDFA = *BLANKS and move blanks to output fields.
     C                     MOVE *BLANKS   LIN26C
     C                     MOVE *BLANKS   LIN26D
     C                     MOVE *BLANKS   LIN27D
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  ACCFR1 - PROCESSES 'FOR A/C OF - DELIVER FROM' FIELDS        *
      *                                                               *
      *****************************************************************
      *
     C           ACCFR1    BEGSR
      *
      *  If "For a/c Of-Deliver from" field NE *Blanks, put out lines
      *  35B, 36B & 37B.
      *  If A#DFFA only contains 2 digits, access Nostro table
      *  (using settlement ccy) and obtain Customer No.  Use this to
      *  get customer name and town from Customer Details table.  Else
      *  A#DFFA caontains 6 digit customer no.  Access SDCUSTPD as
      *  before for name and town.
     C           A#TDTP    IFEQ 'TP'
     C           A#DFFA    IFNE *BLANKS
     C                     MOVEAARRA,40   LIN35A
      *
      *  See if digits 3-6 of A#DFFA are empty (i.e. find out if
      *  A#DFFA consists of 2 or 6 digits).
     C           DFFAN1    IFNE *BLANKS
      *
      *  If 6 digits use the number to CHAIN to the Customer Details
      *  file to get the customer name and town.
     C                     MOVELA#DFFA    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD48        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 48 *
     C                     ENDIF                           ***************
      *
     C                     MOVELBBCRNM    LIN35B
     C                     MOVELBBCRTN    LIN36B
      *
     C                     ELSE
      *
      *  If A#DFFA 2 digits, combine them with Settlement Currency to  N
      *  produce Nostro code.  Find Customer Number from SDNOSTPD.
      *  Use this to CHAIN to SDCUSTPD as before for name and town.
     C                     MOVELA#SETC    PCYCD   3
     C                     MOVELA#DFFA    PNONB   2
     C                     EXSR SRNOST
      *
      *  If error GOTO end and perform error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD45        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 45 *
      *                                                    ***************
     C                     ELSE
      *
      *  If no error, use customer no. from SDNOSTPD to get name & town
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD69        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 69 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
     C                     MOVE BBCRNM    LIN35B
     C                     MOVE BBCRTN    LIN36B
      *
     C                     ENDIF
      *
      *  Reference 3, use Counterparty number to CHAIN to the SE file
     C********** A#TCNR    IFNE *ZEROS                                                        CSD027
     C           A#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE A#TCNR    PSECS
     C                     EXSR SRSECS
      *
      *  If error, perform standard processing.
     C           *INU7     IFEQ '1'
     C                     Z-ADD50        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 50 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
      * Use the "For a/c of-Delivery From" field on trades to check that
      * Depot Reference is on SDSTRDPD. If it is, use the corresponding
      * Depot Reference on SDSECSPD for output.
     C                     Z-ADD1         B
     C           X#DFFA    LOKUPARR36,B                  29
     C           BFCLAS    IFEQ 'M'
     C           *IN29     ANDEQ'1'
     C           A#TDMI    ANDNE'G'
     C                     MOVEAARRSE,B   LIN35F
     C                     MOVE 'VIA'     LIN35E
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If A#DFFA = Blanks then move *Blanks to output fields.
     C                     MOVE *BLANKS   LIN35A
     C                     MOVE *BLANKS   LIN35B
     C                     MOVE *BLANKS   LIN35E
     C                     MOVE *BLANKS   LIN36B
     C                     MOVE *BLANKS   LIN35F
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  ACCFR2 - PROCESSES 'FOR A/C OF - DELIVER FROM' FIELDS        *
      *           (MATURITY DATE SIDE)                                *
      *                                                               *
      *****************************************************************
      *
     C           ACCFR2    BEGSR
      *
      *  If "For a/c Of-Deliver from" field NE *Blanks, put out lines
      *  35D, 36D & 35C.
      *  If B#DFFA only contains 2 digits, access Nostro table
      *  (using settlement ccy) and obtain Customer No.  Use this to
      *  get customer name and town from Customer Details table.  Else
      *  B#DFFA caontains 6 digit customer no.  Access SDCUSTPD as
      *  before for name and town.
     C           B#TDTP    IFEQ 'TP'
     C           B#DFFA    IFNE *BLANKS
     C                     MOVEAARRA,40   LIN35C
      *
      *  See if digits 3-6 of B#DFFA are empty (i.e. find out if
      *  B#DFFA consists of 2 or 6 digits).
     C           DFFAN1    IFNE *BLANKS
      *
      *  If 6 digits use the number to CHAIN to the Customer Details
      *  file to get the customer name and town.
     C                     MOVELB#DFFA    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD44        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 44 *
     C                     ENDIF                           ***************
      *
     C                     MOVELBBCRNM    LIN35D
     C                     MOVELBBCRTN    LIN36D
      *
     C                     ELSE
      *
      *  If B#DFFA 2 digits, combine them with Settlement Currency to  N
      *  produce Nostro code.  Find Customer Number from SDNOSTPD.
      *  Use this to CHAIN to SDCUSTPD as before for name and town.
     C                     MOVELB#SETC    PCYCD   3
     C                     MOVELB#DFFA    PNONB   2
     C                     EXSR SRNOST
      *
      *  If error GOTO end and perform error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD46        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 46 *
      *                                                    ***************
     C                     ELSE
      *
      *  If no error, use customer no. from SDNOSTPD to get name & town
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD54        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 54 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
     C                     MOVE BBCRNM    LIN35D
     C                     MOVE BBCRTN    LIN36D
      *
     C                     ENDIF
      *
      *  Reference 3, use Counterparty number to CHAIN to the SE file
     C********** B#TCNR    IFNE *ZEROS                                                        CSD027
     C           B#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE B#TCNR    PSECS
     C                     EXSR SRSECS
      *
      *  If error, perform standard processing.
     C           *INU7     IFEQ '1'
     C                     Z-ADD54        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 54 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
      * Use the "For a/c of-Delivery From" field on trades to check that
      * Depot Reference is on SDSTRDPD. If it is, use the corresponding
      * Depot Reference on SDSECSPD for output.
     C                     Z-ADD1         B
     C           X#DFFA    LOKUPARR36,B                  29
     C           BFCLAS    IFEQ 'M'
     C           *IN29     ANDEQ'1'
     C           B#TDMI    ANDNE'G'
     C                     MOVEAARRSE,B   LIN35H
     C                     MOVE 'VIA'     LIN35G
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If B#DFFA = Blanks then move *Blanks to output fields.
     C                     MOVE *BLANKS   LIN35C
     C                     MOVE *BLANKS   LIN35D
     C                     MOVE *BLANKS   LIN35G
     C                     MOVE *BLANKS   LIN35H
     C                     MOVE *BLANKS   LIN36D
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  ACCTO1 - PROCESSES 'FOR A/C OF - DELIVER TO' FIELDS          *
      *           (VALUE DATE SIDE)                                   *
      *                                                               *
      *****************************************************************
      *
     C           ACCTO1    BEGSR
      *
      *  If "For a/c Of-Deliver to" field NE *Blanks, put out lines 35B
      *  & 36B.
      *  If A#DTFA only contains 2 digits, access Nostro table
      *  (using settlement ccy) and obtain Customer No.  Use this to
      *  get customer name and town from Customer Details table.  Else
      *  A#DTFA contains 6 digit customer no.  Access SDCUSTPD as
      *  before for name and town.
     C           A#TDTP    IFEQ 'TS'
     C           A#DTFA    IFNE *BLANKS
     C                     MOVEAARRA,29   LIN35A
      *
      *  See if field contains 2 (Nostro) or 6 (Customer no.) digits.
     C           DTFAN1    IFNE *BLANKS
      *
      *  If 6 digits use the number to CHAIN to the Customer Details
      *  file to get the customer name and town.
     C                     MOVELA#DTFA    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD13        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 13 *
     C                     ENDIF                           ***************
      *
     C                     MOVELBBCRNM    LIN35B
     C                     MOVELBBCRTN    LIN36B
      *
     C                     ELSE
      *
      *  If A#DTFA 2 digits, combine them with Settlement Currency to  N
      *  produce Nostro code.  Find Customer Number from SDNOSTPD.
      *  Use this to CHAIN to SDCUSTPD as before for name and town.
     C                     MOVELA#SETC    PCYCD   3
     C                     MOVELA#DTFA    PNONB   2
     C                     EXSR SRNOST
      *
      *  If error GOTO end and perform error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD14        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 14 *
      *                                                    ***************
     C                     ELSE
      *
      *  If no error, use customer no. from SDNOSTPD to get name & town
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD15        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 15 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
     C                     MOVE BBCRNM    LIN35B
     C                     MOVE BBCRTN    LIN36B
      *
     C                     ENDIF
      *
      *  Reference 3, use Counterparty number to CHAIN to the SE file
     C********** A#TCNR    IFNE *ZEROS                                                        CSD027
     C           A#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE A#TCNR    PSECS
     C                     EXSR SRSECS
      *
      *  If error, perform standard processing.
     C           *INU7     IFEQ '1'
     C                     Z-ADD70        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 70 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
      * Use the "For a/c of-Delivery To" field on trades to check that
      * Depot Reference is on SDSTRDPD. If it is, use the corresponding
      * Depot Reference on SDSECSPD for output.
     C                     Z-ADD1         B
     C           X#DTFA    LOKUPARR36,B                  29
     C           BFCLAS    IFEQ 'M'
     C           *IN29     ANDEQ'1'
     C           A#TDMI    ANDNE'G'
     C                     MOVEAARRSE,B   LIN35F
     C                     MOVE 'VIA'     LIN35E
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If A#DTFA = Blanks then move *Blanks to output fields.
     C                     MOVE *BLANKS   LIN26A
     C                     MOVE *BLANKS   LIN35A
     C                     MOVE *BLANKS   LIN35E
     C                     MOVE *BLANKS   LIN35F
     C                     MOVE *BLANKS   LIN35B
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  ACCTO2 - PROCESSES 'FOR A/C OF - DELIVER TO' FIELDS          *
      *           (MATURITY DATE SIDE)                                *
      *                                                               *
      *****************************************************************
      *
     C           ACCTO2    BEGSR
      *
      *  If "For a/c Of-Deliver to" field NE *Blanks, put out lines 35D
      *  36D & 37D.
      *  If D#DTFA only contains 2 digits, access Nostro table
      *  (using settlement ccy) and obtain Customer No.  Use this to
      *  get customer name and town from Customer Details table.  Else
      *  B#DTFA contains 6 digit customer no.  Access SDCUSTPD as
      *  before for name and town.
     C           B#TDTP    IFEQ 'TS'
     C           B#DTFA    IFNE *BLANKS
     C                     MOVEAARRA,29   LIN35C
      *
      *  See if field contains 2 (Nostro) or 6 (Customer no.) digits.
     C           DTFAN1    IFNE *BLANKS
      *
      *  If 6 digits use the number to CHAIN to the Customer Details
      *  file to get the customer name and town.
     C                     MOVELB#DTFA    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD33        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 33 *
     C                     ENDIF                           ***************
      *
     C                     MOVELBBCRNM    LIN35D
     C                     MOVELBBCRTN    LIN36D
      *
     C                     ELSE
      *
      *  If B#DTFA 2 digits, combine them with Settlement Currency to  N
      *  produce Nostro code.  Find Customer Number from SDNOSTPD.
      *  Use this to CHAIN to SDCUSTPD as before for name and town.
     C                     MOVELB#SETC    PCYCD   3
     C                     MOVELB#DTFA    PNONB   2
     C                     EXSR SRNOST
      *
      *  If error GOTO end and perform error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD34        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 34 *
      *                                                    ***************
     C                     ELSE
      *
      *  If no error, use customer no. from SDNOSTPD to get name & town
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      * If error GOTO end of subroutine and perform DB error routine.
     C           *INU7     IFEQ '1'
     C                     Z-ADD16        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 16 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
     C                     MOVE BBCRNM    LIN35D
     C                     MOVE BBCRTN    LIN36D
      *
     C                     ENDIF
      *
      *  Reference 3, use Counterparty number to CHAIN to the SE file
     C********** B#TCNR    IFNE *ZEROS                                                        CSD027
     C           B#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE B#TCNR    PSECS
     C                     EXSR SRSECS
      *
      *  If error, perform standard processing.
     C           *INU7     IFEQ '1'
     C                     Z-ADD10        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 10 *
     C                     ENDIF                           ***************
      *
     C                     ENDIF
      *
      * Use the "For a/c of-Delivery To" field on trades to check that
      * Depot Reference is on SDSTRDPD. If it is, use the corresponding
      * Depot Reference on SDSECSPD for output.
     C                     Z-ADD1         B
     C           X#DTFA    LOKUPARR36,B                  29
     C           BFCLAS    IFEQ 'M'
     C           *IN29     ANDEQ'1'
     C           B#TDMI    ANDNE'G'
     C                     MOVEAARRSE,B   LIN35H
     C                     MOVE 'VIA'     LIN35G
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If B#DTFA = Blanks then move *Blanks to output fields.
     C                     MOVE *BLANKS   LIN26C
     C                     MOVE *BLANKS   LIN35C
     C                     MOVE *BLANKS   LIN35G
     C                     MOVE *BLANKS   LIN35H
     C                     MOVE *BLANKS   LIN35D
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  INSTR1 - SUBROUTINE FOR PRINTING THE INSRUCTIONS THAT GO ON  *
      *           LINES 20 - 24 AND LINES 29 -33 OF THE TRADE         *
      *           CONFIRMATIONS (PAYMENT AT VALUE DATE SIDE).         *
      *                                                               *
      *****************************************************************
      *
     C           INSTR1    BEGSR
      *
      **  CHAIN to the SE file using Counterparty number and save the
      **  discretionary Indicator if successful.
      *
     C                     MOVE *BLANKS   @DISC   1
     C********** A#TCNR    IFNE *ZEROS                                                        CSD027
     C           A#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE A#TCNR    PSECS
     C                     EXSR SRSECS
     C                     ENDIF
      *
      ** If TCNR = 0, or error on READ, perform standard DB error proc.
     C********** A#TCNR    IFEQ *ZEROS                                                        CSD027
     C           A#TCNR    IFEQ *BLANKS                                                       CSD027
     C           *INU7     OREQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD49        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 49 *
      *                                                    ***************
     C                     ELSE
     C                     MOVE BFCLAS    @DISC
     C                     ENDIF
      *
      * ************* Processing for Trades Purchased **************
      *
      *  If the Trade Type field is 'TP', execute the following code.
      *  All literals that are output are placed in corresponding line
      *  number associated with the printout and what is on the spec.
     C           A#TDTP    IFEQ 'TP'
      *
      *  If the settlement method is any of the following codes, access
      *  array ARRA at the bottom of the program and place in LIN20A
      *  the value associated with entry 22.
     C           A#SMTH    IFEQ 01
     C           A#SMTH    OREQ 05
     C           A#SMTH    OREQ 06
     C           A#SMTH    OREQ 07
     C           A#SMTH    OREQ 08
     C           A#SMTH    OREQ 15
     C                     MOVEAARRA,22   LIN20A
     C                     ELSE
      *
      * If the settlement method is either 04 or 14 place ARRA entry 13
      * in LIN20A, otherwise place ARRA entry 23 in LIN20A.
     C           A#SMTH    IFEQ 04
     C           A#SMTH    OREQ 14
     C                     MOVEAARRA,13   LIN20A
     C                     ELSE
     C                     MOVEAARRA,23   LIN20A
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Place 'DELIVER FROM' in LIN29A (NOT for Discretionary
      **  Customers or Grey Market trades)
     C           @DISC     IFNE 'D'
     C           @DISC     ANDNE'S'
     C           A#TDMI    ANDNE'G'
     C                     MOVEAARRA,25   LIN29A
     C                     ENDIF
      *
      *  If Settlement Method = 2, move ARRA,11 to LIN20B and blanks to
      *  LIN21B.
     C           A#SMTH    IFEQ 02
     C                     MOVEAARRA,11   LIN20B
     C                     ELSE
      *
      *  If Settlement Method = 12, move ARRA,16 to LIN20B and blanks
      *  to LIN21B.
     C           A#SMTH    IFEQ 12
     C                     MOVEAARRA,16   LIN20B
     C                     ELSE
      *
      *  If Settlem. Method = 00 or blanks or Pay From field = blanks,
      *  move ARRA,18 to LIN20B and blanks to LIN21B.
     C           A#SMTH    IFEQ *ZEROS
     C           A#PYFM    OREQ *BLANKS
     C           A#SMTH    ANDNE04
     C                     MOVEAARRA,18   LIN20B
     C                     ELSE
      *
      *  If Settlem.Meth. = 14, move Pay From field (trades) to LIN20B
      *  and blanks to LIN21B.
     C           A#SMTH    IFEQ 14
      *
     C           A#PYFM    IFNE *BLANKS
     C**********           MOVE A#PYFM    W#ACNO                                            AR761582
     C                     MOVELA#PYFM    W#ACNO                                            AR761582
     C           K#ACNO    CHAINFDRETALL             41
      *
     C           *IN41     IFEQ '1'
     C                     Z-ADD66        DBASE             ************
     C                     MOVEL'FDRETALL'DBFILE            * DATABASE *
     C                     MOVE K#ACNO    DBKEY             * ERROR 66 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBRCA      BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELCNUM      CUST
     C                     MOVE CCY       CURRCY
     C                     MOVEL'-'       CURRCY
     C                     MOVE ACOD      ACCODE
     C                     MOVEL'-'       ACCODE
     C                     MOVE ACSQ      ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20B
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If the Settlem. Meth. = 01 or 07 or 08 then CHAIN to the
      *  Nostro file and pick up the Customer Number for reference
      *  to the Customer Master file (SDCUSTPD).
     C           A#SMTH    IFEQ 01
     C           A#SMTH    OREQ 07
     C           A#SMTH    OREQ 08
      *
      *  Setup parameters for call to AONOSTR0.
     C                     MOVELA#SETC    PCYCD
     C                     MOVELA#PYFM    PNONB
     C                     EXSR SRNOST
      *
     C           *INU7     IFEQ '1'                        ****************
     C                     Z-ADD17        DBASE            * DB ERROR 17  *
     C                     OUT  LDA                        ****************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      * If no errors, use A7CUST to access SDCUSTPD file for customer
      * name and town. Move to output fields.
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD18        DBASE            * DB ERROR 18 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN20B
     C                     MOVELBBCRTN    LIN21B
      *
      *  In the next few lines, calculate the detail output on lines
      *  23 and 24.
      *
      *  Move literal at ARRA,27 to LIN23A for output.
      *
     C                     MOVEAARRA,27   LIN23A
      *
      * Test the sub-fields of 'Pay To'.  If first 2 digits of A#PAYT  E
      * are numeric but the following 4 are blank - Nostro number.  If
      * all the first 6 digits are numeric - Customer number.
      * Use the appropriate access objects to get the Customer Name and
      * Town.
     C           A#PAYT    IFNE *BLANKS
      *
     C                     TESTN          NOSTR      10
     C**********           TESTN          CUSTNO     09                                       CSD027
     C           *IN10     IFEQ '1'
     C********** *IN09     ANDEQ'0'                                                           CSD027
      *
      *  Set up parameters for AONOSTR0.
     C                     MOVELA#SETC    PCYCD
     C                     MOVELNOSTR     PNONB
     C                     EXSR SRNOST
      *
      *  If error perform standard processing.
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD19        DBASE            * DB ERROR 19 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ELSE
      *
      *  If no error, set up parameters for AOCUSTR0.
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      *  DB error,
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD20        DBASE            * DB ERROR 20 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ELSE
      *
      *  Move Customer Name and Town to fields for output.
     C                     MOVELBBCRNM    LIN23B
     C                     MOVELBBCRTN    LIN24B
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ELSE
      *
      * If first 6 chars are all numeric, access SDCUSTPD directly.
     C           *IN10     IFEQ '1'
     C********** *IN09     ANDEQ'1'                                                           CSD027
     C                     MOVELCUSTNO    PCUST
     C                     EXSR SRCUST
      *
      * Database error.
     C           *INU7     IFEQ '1'
     C                     Z-ADD21        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 21 *
     C                     ELSE                            ***************
      *
      *  Move Customer Name and Town to fields for output
     C                     MOVELBBCRNM    LIN23B
     C                     MOVELBBCRTN    LIN24B
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      *  If the Pay To field contains all blanks, put out a message on
      *  the report (namely ARRA,19).
     C                     ELSE
     C                     MOVEAARRA,19   LIN23B
      *
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If Settlement Method = 04, make up the 4 parts of the complete
      *  account number.
     C           A#SMTH    IFEQ 04
     C                     MOVELA#PYFA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVE A#TCNR    CUST    6
     C                     MOVE A#SETC    CURRCY  4
     C                     MOVEL'-'       CURRCY
     C**********           MOVE BMACCD    ACCODE  5                                           CGL029
     C                     MOVE BMACCD    ACCODE                                              CGL029
     C                     MOVEL'-'       ACCODE
     C                     MOVE '01'      ACSEQ   3
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20B
     C                     ELSE
      *
      *  Concerned with Name Town 1, if Settlem. Meth.= 05, set up the
      *  4 parts of the account number from the data in 'Pay From'.
     C           A#SMTH    IFEQ 05
     C                     MOVELA#PYFA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELA#PYFM    CUST
     C                     MOVE A#SETC    CURRCY  4
     C                     MOVEL'-'       CURRCY
     C**********           MOVE A#PYFM    TEMP4   7                                           CGL029
     C                     MOVE A#PYFM    TEMP4  13                                           CGL029
     C                     MOVEL'-'       TEMP4
     C                     MOVELTEMP4     ACCODE
     C                     MOVE TEMP4     ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20B
     C                     ELSE
      *
      ** If Settlem. Meth. = 15 use some data from the 'Pay From' field
     C           A#SMTH    IFEQ 15
     C                     MOVELA#PYFA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELA#PYFM    CUST
     C                     MOVE A#SETC    CURRCY
     C                     MOVEL'-'       CURRCY
      *
     C********** CUST      IFNE *ZEROS                                                        CSD027
     C           CUST      IFNE *BLANKS                                                       CSD027
     C**********           MOVE A#PYFM    WORK6   6                                           CGL029
     C**********           MOVELWORK6     WORK4   4                                           CGL029
     C                     MOVE A#PYFM    WORK6  12                                           CGL029
     C                     MOVELWORK6     WORK4  10                                           CGL029
     C                     MOVE WORK4     ACCODE
     C                     MOVEL'-'       ACCODE
     C                     MOVE WORK6     ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20B
     C                     ENDIF
      *
     C                     ELSE
     C                     MOVE *BLANKS   ACCODE
     C                     MOVE *BLANKS   ACSEQ
     C                     MOVE *BLANKS   LIN20B
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      * Do not process Names and Towns 2 & 4, Literal 5 and reference
      * for Discretionary customers and Grey Market Trades.
      *
     C           @DISC     IFNE 'D'
     C           @DISC     ANDNE'S'
     C           A#TDMI    ANDNE'G'
      *
      *  Use the 'Deliver From' field to find Customer name and Town
      *  for lines 30B and 29B (Name and Town 2).
     C********** A#DELF    IFNE 0                                                             CSD027
     C           A#DELF    IFNE *BLANKS                                                       CSD027
     C                     MOVELA#DELF    PCUST
     C                     EXSR SRCUST
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD25        DBASE            * DB ERROR 25 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN29B
     C                     MOVELBBCRTN    LIN30B
      *
     C                     MOVE A#DELF    PSECS
     C                     EXSR SRSECS
     C           *INU7     IFEQ '1'
     C                     Z-ADD52        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 52 *
     C                     ENDIF                           ***************
      *
     C                     MOVE BFCLAS    DEPTYP  1
      *
      * ... else 'Deliver From' is blank - do not fill fields
     C                     ELSE
     C                     MOVE *BLANKS   LIN29A
     C                     MOVE *BLANKS   LIN29B
     C                     MOVE *BLANKS   LIN30B
     C                     MOVE ' '       DEPTYP
     C                     ENDIF
      *
      *  Use the 'Deliver To' field to find Customer name and Town for
      *  lines 33B and 32B (Name and Town 4).
     C********** A#DELT    IFNE 0                                                             CSD027
     C           A#DELT    IFNE *BLANKS                                                       CSD027
     C                     MOVELA#DELT    PCUST
     C                     EXSR SRCUST
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD26        DBASE            * DB ERROR 26 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN32B
     C                     MOVELBBCRTN    LIN33B
      *
      *  Load line 32A (Literal 5) from ARRA,26.
     C                     MOVEAARRA,26   LIN32A
      *
      *  ... else 'Deliver To' is blank - do not print fields
     C                     ELSE
     C                     MOVE *BLANKS   LIN32B
     C                     MOVE *BLANKS   LIN33B
     C                     MOVE *BLANKS   LIN32A
     C                     ENDIF
      *
      *  Reference 2, use 'For a/c Of - Deliver From' (if present)...
     C           A#DFFA    IFNE *BLANKS
      *
     C                     MOVELA#DFFA    PSECS
     C                     EXSR SRSECS
     C                     ELSE
      *
      *  ... if not present, get details using Counterparty Number
     C********** A#TCNR    IFNE *ZEROS                                                        CSD027
     C           A#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE A#TCNR    PSECS
     C                     EXSR SRSECS
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD27        DBASE            * DB ERROR 27 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      **If*the*Deliver*From*is*a*Euroclear,*Cedel,*or*Kassenverein*depot  CSE022
      **the*depot*reference*is*in*a*fixed*position.********************   CSE022
      ** If the "Deliver From" is a Euroclear or Cedel depot, the depot   CSE022
      ** reference is in a fixed position.                                CSE022
     C           DEPTYP    IFEQ 'E'
     C                     Z-ADD1         A
     C                     MOVE *ON       *IN29
     C                     ELSE
     C           DEPTYP    IFEQ 'C'
     C                     Z-ADD2         A
     C                     MOVE *ON       *IN29
     C                     ELSE
     C********** DEPTYP    IFEQ 'K'                                       CSE022
     C**********           Z-ADD3         A                               CSE022
     C**********           MOVE *ON       *IN29                           CSE022
     C**********           ELSE                                           CSE022
      *
      * Use the Deliver From field to check that there is an equivalentT
      * Depot Ref. on the Securities ICD (SDSTRDPD).  If so and the
      * Discretionary Indicator = 'M', move the corresponding Depot Ref
      * from SDSECSPD to the output field (LIN29F).
      *
      ** NOTE ** On a Trade Purchase deliver from the counterparty and
      *          deliver to the user.
      *
     C                     MOVE A#DELF    DELFA   6
     C                     Z-ADD1         A
     C           DELFA     LOKUPARR36,A                  29
     C**********           ENDIF                                          CSE022
     C                     ENDIF
     C                     ENDIF
      *
     C           BFCLAS    IFEQ 'M'
     C           *IN29     ANDEQ'1'
     C           ARRSE,A   ANDNE*BLANKS
     C           A#TDMI    ANDNE'G'
     C                     MOVEAARRSE,A   LIN29F
     C                     MOVE 'VIA'     LIN29E
     C                     ENDIF
      *
      *
      *  Use 'Deliver To' field to access SDSECSPD.  This will fill the
      *  elements of array ARRSE for later use.
     C********** A#DELT    IFNE *ZEROS                                                        CSD027
     C           A#DELT    IFNE *BLANKS                                                       CSD027
     C                     MOVE A#DELT    PSECS
     C                     EXSR SRSECS
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD51        DBASE            * DB ERROR 51 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     ENDIF
      *
      **If*the*Deliver*From*is*a*Euroclear,*Cedel,*or*Kassenverein*depot  CSE022
      **the*depot*reference*is*in*a*fixed*position*********************   CSE022
      ** If the "Deliver From" is a Euroclear or Cedel depot, the depot   CSE022
      ** reference is in a fixed position.                                CSE022
     C           BFCLAS    IFEQ 'E'
     C                     Z-ADD1         A
     C                     MOVE *ON       *IN29
     C                     ELSE
     C           BFCLAS    IFEQ 'C'
     C                     Z-ADD2         A
     C                     MOVE *ON       *IN29
     C                     ELSE
     C********** BFCLAS    IFEQ 'K'                                       CSE022
     C**********           Z-ADD3         A                               CSE022
     C**********           MOVE *ON       *IN29                           CSE022
     C**********           ELSE                                           CSE022
      *
      * Use the Deliver To field to check that there is an equivalent  T
      * Depot Ref. on the Securities ICD (SDSTRDPD).  If so and the
      * Discretionary Indicator = 'M', move the corresponding Depot Ref
      * from SDSECSPD to the output field (LIN32F).
     C                     MOVE A#DELT    DELTA   6
     C                     Z-ADD1         A
     C           DELTA     LOKUPARR36,A                  29
     C**********           ENDIF                                          CSE022
     C                     ENDIF
     C                     ENDIF
      *
     C           *IN29     IFEQ '1'
     C           A#TDMI    ANDNE'G'
     C                     MOVEAARRSE,A   LIN32F
     C                     MOVE 'VIA'     LIN32E
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      * *************** Processing for Trades Sold *****************
      *
      *  If Trade Sold, execute the following code.
     C           A#TDTP    IFEQ 'TS'
      *
      *  If the Settlement Method is any of the following codes, load
      *  LIN20A with element 24 of array ARRA.
     C           A#SMTH    IFEQ 01
     C           A#SMTH    OREQ 07
     C           A#SMTH    OREQ 08
     C                     MOVEAARRA,24   LIN20A
     C                     ELSE
      *
      *  If the Settlement Method is 05 or 06 or 15 load LIN20A with
      *  element 41.
     C           A#SMTH    IFEQ 05
     C           A#SMTH    OREQ 06
     C           A#SMTH    OREQ 15
     C                     MOVEAARRA,41   LIN20A
     C                     ELSE
      *
      * If the Settlement Method is either 04 or 14, load LIN20A with    IN
      * element 24.  Else load it with element 23.
     C           A#SMTH    IFEQ 04
     C           A#SMTH    OREQ 14
     C                     MOVEAARRA,12   LIN20A
     C                     ELSE
     C                     MOVEAARRA,23   LIN20A
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      *  Literal 2 - Fill LIN29A with 'DELIVER TO' unless this is a
      *  Discretionary Customer or a Grey Market Trade.
     C           @DISC     IFNE 'D'
     C           @DISC     ANDNE'S'
     C           A#TDMI    ANDNE'G'
     C                     MOVEAARRA,26   LIN29A
     C                     ENDIF
      *
      *  If Settlem. Method = 02, move literal to LIN20B and blanks to
      *  LIN21B.
     C           A#SMTH    IFEQ 02
     C                     MOVEAARRA,10   LIN20B
     C                     ELSE
      *
      *  If Settlem. Method = 12, move ARRA,16 to LIN20B and blanks to
      *  LIN21B.
     C           A#SMTH    IFEQ 12
     C                     MOVEAARRA,16   LIN20B
     C                     ELSE
      *
      *  If Settlem. Method = 00 or blanks or Pay To field = blanks move
      *  'INSTRUCTIONS TO BE ADVISED' to LIN20B and blanks to LIN21B.
     C           A#SMTH    IFEQ *ZEROS
     C           A#PAYT    OREQ *BLANKS
     C           A#SMTH    ANDNE04
     C                     MOVEAARRA,18   LIN20B
     C                     ELSE
      *
      *  If Settlem. Method = 14 move Pay To field to LIN20B and blanks
      *  to LIN21B.
     C           A#SMTH    IFEQ 14
     C           A#PAYT    IFNE *BLANKS
     C**********           MOVE A#PAYT    W#ACNO                                            AR761582
     C                     MOVELA#PAYT    W#ACNO                                            AR761582
     C           K#ACNO    CHAINFDRETALL             41
      *
     C           *IN41     IFEQ '1'
     C                     Z-ADD74        DBASE             ************
     C                     MOVEL'FDRETALL'DBFILE            * DATABASE *
     C                     MOVE K#ACNO    DBKEY             * ERROR 66 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBRCA      BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELCNUM      CUST
     C                     MOVE CCY       CURRCY
     C                     MOVEL'-'       CURRCY
     C                     MOVE ACOD      ACCODE
     C                     MOVEL'-'       ACCODE
     C                     MOVE ACSQ      ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20B
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If the Settlement Method = 01, 07 or 08 access the Nostro file,
      *  pick up customer number and use it to access SDCUSTPD.
     C           A#SMTH    IFEQ 01
     C           A#SMTH    OREQ 07
     C           A#SMTH    OREQ 08
      *
      *  Set up parameters for call to AONOSTR0.
     C                     MOVELA#SETC    PCYCD
     C                     MOVELA#PAYT    PNONB
     C                     EXSR SRNOST
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD28        DBASE            * DB ERROR 28 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      *  If no errors, use A7CUST to get Customer Name and Town from
      *  SDCUSTPD.
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD29        DBASE            * DB ERROR 29 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN20B
     C                     MOVELBBCRTN    LIN21B
      *
      *  In the next few lines calculate the detail output on lines
      *  23, and 24.
      *
      *  Move element 28 of ARRA to LIN23A.
     C                     MOVEAARRA,28   LIN23A
      *
      * Test the sub-fields of 'Pay From'.  If first 2 digits of A#PYFME
      * are numeric but the following 4 are blank - Nostro number.  If
      * all the first 6 digits are numeric - Customer number.
      * Use the appropriate access objects to get the Customer Name and
      * Town.
      *
     C           A#PYFM    IFNE *BLANKS
      *
     C                     TESTN          NOSTR2     10
     C**********           TESTN          CUSTN2     09                                       CSD027
      *
     C           *IN10     IFEQ '1'
     C********** *IN09     ANDEQ'0'                                                           CSD027
      *
      *  Set up parameters for call to AONOSTR0.
     C                     MOVELA#SETC    PCYCD
     C                     MOVELA#PYFM    PNONB
     C                     EXSR SRNOST
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD30        DBASE            * DB ERROR 30 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      *  Set up key for call to AOCUSTR0.
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD31        DBASE            * DB ERROR 31 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      *  Move Customer Name and Town to fields for output.
     C                     MOVELBBCRNM    LIN23B
     C                     MOVELBBCRTN    LIN24B
     C                     ELSE
      *
      *  If all 6 characters are numeric, access SDCUSTPD directly.
     C           *IN10     IFEQ '1'
     C********** *IN09     ANDEQ'1'                                                           CSD027
     C                     MOVELCUSTN2    PCUST
     C                     EXSR SRCUST
      *
      * Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD32        DBASE            * DB ERROR 32 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      *  Move Customer Name and Town to fields for output.
     C                     MOVELBBCRNM    LIN23B
     C                     MOVELBBCRTN    LIN24B
      *
     C                     ENDIF
     C                     ENDIF
      *
      *  If A#PYFM neither 2 numeric or 6 numeric output a 'WE WAIT
      *  YOUR ADVICE' message.
     C                     ELSE
     C                     MOVEAARRA,19   LIN23B
     C                     ENDIF
      *
     C                     ELSE
      *
      *  Set up 'Pay To' output field.  If Settlement Method = 05, set
      *  up the 4 parts of the account number.  (Name & Town 1)
     C           A#SMTH    IFEQ 04
     C                     MOVELA#PYTA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVE A#TCNR    CUST    6
     C                     MOVE A#SETC    CURRCY  4
     C                     MOVEL'-'       CURRCY
     C**********           MOVE BMACCD    ACCODE  5                                           CGL029
     C                     MOVE BMACCD    ACCODE                                              CGL029
     C                     MOVEL'-'       ACCODE
     C                     MOVE '01'      ACSEQ   3
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20B
     C                     ELSE
      *
      *  Concerned with Name Town 1, if Settlem. Meth.= 05, set up the
      *  4 parts of the account number frome the data in 'Pay To'.
     C           A#SMTH    IFEQ 05
     C                     MOVELA#PYTA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELA#PAYT    CUST
     C                     MOVE A#SETC    CURRCY  4
     C                     MOVEL'-'       CURRCY
     C**********           MOVE A#PAYT    TEMP4   7                                           CGL029
     C                     MOVE A#PAYT    TEMP4                                               CGL029
     C                     MOVEL'-'       TEMP4
     C                     MOVELTEMP4     ACCODE
     C                     MOVE TEMP4     ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20B
     C                     ELSE
      *
      ** If Settlem. Meth. = 15 use some data from the 'Pay To' field
     C           A#SMTH    IFEQ 15
     C                     MOVELA#PAYT    CUST
     C                     MOVE A#SETC    CURRCY
     C                     MOVEL'-'       CURRCY
      *
     C********** CUST      IFNE *ZEROS                                                        CSD027
     C           CUST      IFNE *BLANKS                                                       CSD027
     C                     MOVELCUST      PCUST
     C                     EXSR SRCUST
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD35        DBASE            * DB ERROR 35 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELA#PYTA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVE BFACCD    ACCODE
     C                     MOVEL'-'       ACCODE
     C                     MOVE BFACSN    ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20B
      *
     C                     ELSE
     C                     MOVE *BLANKS   ACCODE
     C                     MOVE *BLANKS   ACSEQ
     C                     MOVE *BLANKS   LIN20B
      *
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      * Do not process Names and Towns 2 & 4, Literal 5 and reference
      * for Discretionary customers and Grey Market Trades.
     C           @DISC     IFNE 'D'
     C           @DISC     ANDNE'S'
     C           A#TDMI    ANDNE'G'
      *
      *  Use the 'Deliver To' field to find Customer name and Town
      *  for lines 30B and 31B (Name and Town 2).
     C********** A#DELT    IFNE 0                                                             CSD027
     C           A#DELT    IFNE *BLANKS                                                       CSD027
     C                     MOVELA#DELT    PCUST
     C                     EXSR SRCUST
      *
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD36        DBASE            * DB ERROR 36 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVE BBCRNM    LIN29B
     C                     MOVE BBCRTN    LIN30B
      *
     C                     MOVE A#DELT    PSECS
     C                     EXSR SRSECS
      *
     C           *INU7     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD53        DBASE            ***************
     C                     GOTO ERRTAG                     ** DB ERROR 53
     C                     ENDIF                           ***************
      *
     C                     MOVE BFCLAS    DEPTYP
     C                     ELSE
     C                     MOVE ' '       DEPTYP
     C                     ENDIF
      *
      *  Use the 'Deliver Fr' field to find Customer name and Town for
      *  lines 32B and 33B.
     C********** A#DELF    IFNE 0                                      ***                    CSD027
     C           A#DELF    IFNE *BLANKS                                ***                    CSD027
     C                     MOVELA#DELF    PCUST
     C                     EXSR SRCUST
      *
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD37        DBASE            * DB ERROR 37 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVE BBCRNM    LIN32B
     C                     MOVE BBCRTN    LIN33B
      *
      *  Load line 32A from ARRA,25.
     C                     MOVEAARRA,25   LIN32A
      *
      *  ... else 'Deliver From' is blank, do not fill output fields
     C                     ELSE
     C                     MOVE *BLANKS   LIN32A
     C                     MOVE *BLANKS   LIN32B
     C                     MOVE *BLANKS   LIN33B
     C                     ENDIF
      *
      *  Reference 2, use 'For a/c Of - Deliver To' (if present)...
     C           A#DTFA    IFNE *BLANKS
     C                     MOVELA#DTFA    PSECS
     C                     EXSR SRSECS
     C                     ELSE
      *
      *  ... if not present, get details using Counterparty Number
     C********** A#TCNR    IFNE *ZEROS                                                        CSD027
     C           A#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE A#TCNR    PSECS
     C                     EXSR SRSECS
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD38        DBASE            * DB ERROR 38 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      **If*the*Deliver*To*is*a*Euroclear,*Cedel,*or*Kassenverein*depot*   CSE022
      **the*depot*reference*is*in*a*fixed*position*********************   CSE022
      ** If the "Deliver To" is a Euroclear or Cedel depot, the depot     CSE022
      ** reference is in a fixed position.                                CSE022
      *                                                                   CSE022
     C           DEPTYP    IFEQ 'E'
     C                     Z-ADD1         V
     C                     MOVE *ON       *IN29
     C                     ELSE
     C           DEPTYP    IFEQ 'C'
     C                     Z-ADD2         V
     C                     MOVE *ON       *IN29
     C                     ELSE
     C********** DEPTYP    IFEQ 'K'                                       CSE022
     C**********           Z-ADD3         V                               CSE022
     C**********           MOVE *ON       *IN29                           CSE022
     C**********           ELSE                                           CSE022
      *
      * Use the Deliver To field to check that there is an equivalent  T
      * Depot Ref. on the Securities ICD (SDSTRDPD).  If so and the
      * Discretionary Indicator = 'M', move the corresponding Depot Ref
      * from SDSECSPD to the output field (LIN29F).
      *
     C                     MOVE A#DELT    DELTA   6
     C                     Z-ADD1         V
     C           DELTA     LOKUPARR36,V                  29
     C**********           ENDIF                                          CSE022
     C                     ENDIF
     C                     ENDIF
      *
     C           BFCLAS    IFEQ 'M'
     C           *IN29     ANDEQ'1'
     C           A#TDMI    ANDNE'G'
     C                     MOVEAARRSE,V   LIN29F
     C                     MOVE 'VIA'     LIN29E
     C                     ENDIF
      *
      *
      *  Use 'Deliver To' field to access SDSECSPD.  This will fill the
      *  elements of array ARRSE for later use.
     C********** A#DELF    IFNE *ZEROS                                                        CSD027
     C           A#DELF    IFNE *BLANKS                                                       CSD027
     C                     MOVE A#DELF    PSECS
     C                     EXSR SRSECS
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD47        DBASE            * DB ERROR 47 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     ENDIF
      *
      **If*the*Deliver*To*is*a*Euroclear,*Cedel,*or*Kassenverein*depot*   CSE022
      **the*depot*reference*is*in*a*fixed*position*********************   CSE022
      ** If the "Deliver To" is a Euroclear or Cedel depot, the depot     CSE022
      ** reference is in a fixed position.                                CSE022
     C           BFCLAS    IFEQ 'E'
     C                     Z-ADD1         V
     C                     MOVE *ON       *IN29
     C                     ELSE
     C           BFCLAS    IFEQ 'C'
     C                     Z-ADD2         V
     C                     MOVE *ON       *IN29
     C                     ELSE
     C********** BFCLAS    IFEQ 'K'                                       CSE022
     C**********           Z-ADD3         V                               CSE022
     C**********           MOVE *ON       *IN29                           CSE022
     C**********           ELSE                                           CSE022
      *
      * Use the Deliver From field to check that there is an equivalentT
      * Depot Ref. on the Securities ICD (SDSTRDPD).  If so and the
      * Discretionary Indicator = 'M', move the corresponding Depot Ref
      * from SDSECSPD to the output field (LIN32F).
     C                     MOVE A#DELF    DELFA
     C                     Z-ADD1         V
     C           DELFA     LOKUPARR36,V                  29
     C**********           ENDIF                                          CSE022
     C                     ENDIF
     C                     ENDIF
      *
     C           *IN29     IFEQ '1'
     C           A#TDMI    ANDNE'G'
     C                     MOVEAARRSE,V   LIN32F
     C                     MOVE 'VIA'     LIN32E
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      *
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  INSTR2 - SUBROUTINE FOR PRINTING THE INSRUCTIONS THAT GO ON  *
      *           LINES 20 - 24 AND LINES 29 -33 OF THE TRADE         *
      *           CONFIRMATIONS (PAYMENT AT MATURITY DATE SIDE).      *
      *                                                               *
      *****************************************************************
      *
     C           INSTR2    BEGSR
      *
     C                     MOVE '0'       *IN29
      *
      **  CHAIN to the SE file using Counterparty number and save the       3911
      **  discretionary Indicator if successful.                            3911
      *
     C                     MOVE *BLANKS   @DISC   1
     C********** B#TCNR    IFNE *ZEROS                                                        CSD027
     C           B#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE B#TCNR    PSECS
     C                     EXSR SRSECS
     C                     ENDIF
      *
      ** If TCNR = 0, or error on READ, perform standard DB error proc.
     C********** B#TCNR    IFEQ *ZEROS                                                        CSD027
     C           B#TCNR    IFEQ *BLANKS                                                       CSD027
     C           *INU7     OREQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD89        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 89 *
      *                                                    ***************
     C                     ELSE
     C                     MOVE BFCLAS    @DISC
     C                     ENDIF
      *
      * ************* Processing for Trades Purchased **************
      *
      *  If the Trade Type field is 'TP', execute the following code.
      *  All literals that are output are placed in corresponding line
      *  number associated with the printout and what is on the spec.
     C           B#TDTP    IFEQ 'TP'
      *
      *  If the settlement method is any of the following codes, access
      *  array ARRA at the bottom of the program and place in LIN20C
      *  the value associated with entry 22.
     C           B#SMTH    IFEQ 01
     C           B#SMTH    OREQ 05
     C           B#SMTH    OREQ 06
     C           B#SMTH    OREQ 07
     C           B#SMTH    OREQ 08
     C           B#SMTH    OREQ 15
     C                     MOVEAARRA,22   LIN20C
     C                     ELSE
      *
      * If the settlement method is either 04 or 14 place ARRA entry 13
      * in LIN20C, otherwise place ARRA entry 23 in LIN20C.
     C           B#SMTH    IFEQ 04
     C           B#SMTH    OREQ 14
     C                     MOVEAARRA,13   LIN20C
     C                     ELSE
     C                     MOVEAARRA,23   LIN20C
     C                     ENDIF
      *
     C                     ENDIF
      *
      **  Place 'DELIVER FROM' in LIN29C (NOT for Discretionary
      **  Customers or Grey Market trades)
     C           @DISC     IFNE 'D'
     C           @DISC     ANDNE'S'
     C           B#TDMI    ANDNE'G'
     C                     MOVEAARRA,25   LIN29C
     C                     ENDIF
      *
      *  If Settlement Method = 2, move ARRA,11 to LIN20D and blanks to
      *  LIN21D.
     C           B#SMTH    IFEQ 02
     C                     MOVEAARRA,11   LIN20D
     C                     ELSE
      *
      *  If Settlement Method = 12, move ARRA,16 to LIN20D and blanks
      *  to LIN21D.
     C           B#SMTH    IFEQ 12
     C                     MOVEAARRA,16   LIN20D
     C                     ELSE
      *
      *  If Settlem. Method = 00 or blanks or Pay From field = blanks,
      *  move ARRA,18 to LIN20D and blanks to LIN21D.
     C           B#SMTH    IFEQ *ZEROS
     C           B#PYFM    OREQ *BLANKS
     C           B#SMTH    ANDNE04
     C                     MOVEAARRA,18   LIN20D
     C                     ELSE
      *
      *  If Settlem.Meth. = 14, Pay From field will be on file as a
      *  10 digit retail account no.  Find the full account number.
     C           B#SMTH    IFEQ 14
      *
     C           B#PYFM    IFNE *BLANKS
     C**********           MOVE B#PYFM    W#ACNO                                            AR761582
     C                     MOVELB#PYFM    W#ACNO                                            AR761582
     C           K#ACNO    CHAINFDRETALL             41
      *
     C           *IN41     IFEQ '1'
     C                     Z-ADD80        DBASE             ************
     C                     MOVEL'FDRETALL'DBFILE            * DATABASE *
     C                     MOVE K#ACNO    DBKEY             * ERROR 80 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBRCA      BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELCNUM      CUST
     C                     MOVE CCY       CURRCY
     C                     MOVEL'-'       CURRCY
     C                     MOVE ACOD      ACCODE
     C                     MOVEL'-'       ACCODE
     C                     MOVE ACSQ      ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20D
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If the Settlem. Meth. = 01 or 07 or 08 then CHAIN to the
      *  Nostro file and pick up the Customer Number for reference
      *  to the Customer Master file (SDCUSTPD).
     C           B#SMTH    IFEQ 01
     C           B#SMTH    OREQ 07
     C           B#SMTH    OREQ 08
      *
      *  Setup parameters for call to AONOSTR0.
     C                     MOVELB#SETC    PCYCD
     C                     MOVELB#PYFM    PNONB
     C                     EXSR SRNOST
      *
     C           *INU7     IFEQ '1'                        ****************
     C                     Z-ADD57        DBASE            * DB ERROR 57  *
     C                     OUT  LDA                        ****************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      * If no errors, use A7CUST to access SDCUSTPD file for customer
      * name and town. Move to output fields.
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD58        DBASE            * DB ERROR 58 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN20D
     C                     MOVELBBCRTN    LIN21D
      *
      *  In the next few lines, calculate the detail output on lines
      *  23 and 24.
      *
      *  Move literal at ARRA,27 to LIN23C for output.
      *
     C                     MOVEAARRA,27   LIN23C
      *
      * Test the sub-fields of 'Pay To'.  If first 2 digits of B#PAYT  E
      * are numeric but the following 4 are blank - Nostro number.  If
      * all the first 6 digits are numeric - Customer number.
      * Use the appropriate access objects to get the Customer Name and
      * Town (Name and Town 3).
     C           B#PAYT    IFNE *BLANKS
      *
     C                     TESTN          NOSTR      10
     C**********           TESTN          CUSTNO     09                                       CSD027
     C           *IN10     IFEQ '1'
     C********** *IN09     ANDEQ'0'                                                           CSD027
      *
      *  Set up parameters for AONOSTR0.
     C                     MOVELB#SETC    PCYCD
     C                     MOVELNOSTR     PNONB
     C                     EXSR SRNOST
      *
      *  If error perform standard processing.
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD59        DBASE            * DB ERROR 59 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ELSE
      *
      *  If no error, set up parameters for AOCUSTR0.
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      *  DB error,
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD63        DBASE            * DB ERROR 63 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ELSE
      *
      *  Move Customer Name and Town to fields for output.
     C                     MOVELBBCRNM    LIN23D
     C                     MOVELBBCRTN    LIN24D
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ELSE
      *
      * If first 6 chars are all numeric, access SDCUSTPD directly.
     C           *IN10     IFEQ '1'
     C********** *IN09     ANDEQ'1'                                                           CSD027
     C                     MOVELCUSTNO    PCUST
     C                     EXSR SRCUST
      *
      * Database error.
     C           *INU7     IFEQ '1'
     C                     Z-ADD64        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 64 *
     C                     ELSE                            ***************
      *
      *  Move Customer Name and Town to fields for output
     C                     MOVELBBCRNM    LIN23D
     C                     MOVELBBCRTN    LIN24D
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      *  If the Pay To field contains all blanks, put out a message on
      *  the report (namely ARRA,19).
     C                     ELSE
     C                     MOVEAARRA,19   LIN23D
      *
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If Settlement Method = 04, make up the 4 parts of the complete
      *  account number.
     C           B#SMTH    IFEQ 04
     C                     MOVELB#PYFA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVE B#TCNR    CUST    6
     C                     MOVE B#SETC    CURRCY  4
     C                     MOVEL'-'       CURRCY
     C**********           MOVE BMACCD    ACCODE  5                                           CGL029
     C                     MOVE BMACCD    ACCODE                                              CGL029
     C                     MOVEL'-'       ACCODE
     C                     MOVE '01'      ACSEQ   3
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20D
     C                     ELSE
      *
      *  Concerned with Name Town 1, if Settlem. Meth.= 05, set up the
      *  4 parts of the account number frome the data in 'Pay From'.
     C           B#SMTH    IFEQ 05
     C                     MOVELB#PYFA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELB#PYFM    CUST
     C                     MOVE B#SETC    CURRCY  4
     C                     MOVEL'-'       CURRCY
     C**********           MOVE B#PYFM    TEMP4   7                                           CGL029
     C                     MOVE B#PYFM    TEMP4                                               CGL029
     C                     MOVEL'-'       TEMP4
     C                     MOVELTEMP4     ACCODE
     C                     MOVE TEMP4     ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20D
     C                     ELSE
      *
      ** If Settlem. Meth. = 15 use some data from the 'Pay From' field
     C           B#SMTH    IFEQ 15
     C                     MOVELB#PYFA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELB#PYFM    CUST
     C                     MOVE B#SETC    CURRCY
     C                     MOVEL'-'       CURRCY
      *
     C********** CUST      IFNE *ZEROS                                                        CSD027
     C           CUST      IFNE *BLANKS                                                       CSD027
     C**********           MOVE B#PYFM    WORK6   6                                           CGL029
     C**********           MOVELWORK6     WORK4   4                                           CGL029
     C                     MOVE B#PYFM    WORK6                                               CGL029
     C                     MOVELWORK6     WORK4                                               CGL029
     C                     MOVE WORK4     ACCODE
     C                     MOVEL'-'       ACCODE
     C                     MOVE WORK6     ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20D
     C                     ENDIF
      *
     C                     ELSE
     C                     MOVE *BLANKS   ACCODE
     C                     MOVE *BLANKS   ACSEQ
     C                     MOVE *BLANKS   LIN20D
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      * Do not process Names and Towns 2 & 4, Literal 5 and reference
      * for Discretionary customers and Grey Market Trades.
      *
     C           @DISC     IFNE 'D'
     C           @DISC     ANDNE'S'
     C           B#TDMI    ANDNE'G'
      *
      *  Use the 'Deliver From' field to find Customer name and Town
      *  for lines 30D and 29D.
     C********** B#DELF    IFNE 0                                                             CSD027
     C           B#DELF    IFNE *BLANKS                                                       CSD027
     C                     MOVELB#DELF    PCUST
     C                     EXSR SRCUST
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD65        DBASE            * DB ERROR 65 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN29D
     C                     MOVELBBCRTN    LIN30D
      *
     C                     MOVE B#DELF    PSECS
     C                     EXSR SRSECS
     C           *INU7     IFEQ '1'
     C                     Z-ADD92        DBASE
     C                     OUT  LDA
     C                     EXSR *PSSR                      ***************
     C                     GOTO ERRTAG                     * DB ERROR 92 *
     C                     ENDIF                           ***************
      *
     C                     MOVE BFCLAS    DEPTYP  1
      *
      * ... else 'Deliver From' is blank - do not fill fields
     C                     ELSE
     C                     MOVE *BLANKS   LIN29C
     C                     MOVE *BLANKS   LIN29D
     C                     MOVE *BLANKS   LIN30D
     C                     MOVE ' '       DEPTYP
     C                     ENDIF
      *
      *  Use the 'Deliver To' field to find Customer name and Town for
      *  lines 32D and 33D.
     C********** B#DELT    IFNE 0                                                             CSD027
     C           B#DELT    IFNE *BLANKS                                                       CSD027
     C                     MOVELB#DELT    PCUST
     C                     EXSR SRCUST
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD86        DBASE            * DB ERROR 86 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN32D
     C                     MOVELBBCRTN    LIN33D
      *
      *  Load line 32B (Literal 5) from ARRA,26.
     C                     MOVEAARRA,26   LIN32C
      *
      * ... else 'Deliver To' is blank - do not fill fields
     C                     ELSE
     C                     MOVE *BLANKS   LIN32C
     C                     MOVE *BLANKS   LIN32D
     C                     MOVE *BLANKS   LIN33D
     C                     ENDIF
      *
      *  Reference 2, use 'For a/c Of - Deliver From' (if present)...
     C           B#DFFA    IFNE *BLANKS
      *
     C                     MOVELB#DFFA    PSECS
     C                     EXSR SRSECS
     C                     ELSE
      *
      *  ... if not present, get details using Counterparty Number
     C********** B#TCNR    IFNE *ZEROS                                                        CSD027
     C           B#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE B#TCNR    PSECS
     C                     EXSR SRSECS
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD67        DBASE            * DB ERROR 67 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      **If*the*Deliver*From*is*a*Euroclear,*Cedel,*or*Kassenverein*depot  CSE022
      **the*depot*reference*is*in*a*fixed*position.********************   CSE022
      ** If the "Deliver From" is a Euroclear or Cedel depot, the depot   CSE022
      ** reference is in a fixed position.                                CSE022
      *                                                                   CSE022
     C           DEPTYP    IFEQ 'E'
     C                     Z-ADD1         A
     C                     MOVE *ON       *IN29
     C                     ELSE
     C           DEPTYP    IFEQ 'C'
     C                     Z-ADD2         A
     C                     MOVE *ON       *IN29
     C                     ELSE
     C********** DEPTYP    IFEQ 'K'                                       CSE022
     C**********           Z-ADD3         A                               CSE022
     C**********           MOVE *ON       *IN29                           CSE022
     C**********           ELSE                                           CSE022
      *
      * Use the Deliver From field to check that there is an equivalentT
      * Depot Ref. on the Securities ICD (SDSTRDPD).  If so and the
      * Discretionary Indicator = 'M', move the corresponding Depot Ref
      * from SDSECSPD to the output field (LIN29H).
      *
      ** NOTE ** On a Trade Purchase deliver from the counterparty and
      *          deliver to the user.
      *
     C                     MOVE B#DELF    DELFA   6
     C                     Z-ADD1         A
     C           DELFA     LOKUPARR36,A                  29
     C**********           ENDIF                                          CSE022
     C                     ENDIF
     C                     ENDIF
      *
     C           BFCLAS    IFEQ 'M'
     C           *IN29     ANDEQ'1'
     C           ARRSE,A   ANDNE*BLANKS
     C           B#TDMI    ANDNE'G'
     C                     MOVEAARRSE,A   LIN29H
     C                     MOVE 'VIA'     LIN29G
     C                     ENDIF
      *
      *
      *  Use 'Deliver To' field to access SDSECSPD.  This will fill the
      *  elements of array ARRSE for later use.
     C********** B#DELT    IFNE *ZEROS                                                        CSD027
     C           B#DELT    IFNE *BLANKS                                                       CSD027
     C                     MOVE B#DELT    PSECS
     C                     EXSR SRSECS
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD91        DBASE            * DB ERROR 91 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     ENDIF
      *
      **If*the*Deliver*From*is*a*Euroclear,*Cedel,*or*Kassenverein*depot  CSE022
      **the*depot*reference*is*in*a*fixed*position*********************   CSE022
      ** If the "Deliver From" is a Euroclear or Cedel depot, the depot   CSE022
      ** reference is in a fixed position.                                CSE022
      *                                                                   CSE022
     C           BFCLAS    IFEQ 'E'
     C                     Z-ADD1         A
     C                     MOVE *ON       *IN29
     C                     ELSE
     C           BFCLAS    IFEQ 'C'
     C                     Z-ADD2         A
     C                     MOVE *ON       *IN29
     C                     ELSE
     C********** BFCLAS    IFEQ 'K'                                       CSE022
     C**********           Z-ADD3         A                               CSE022
     C**********           MOVE *ON       *IN29                           CSE022
     C**********           ELSE                                           CSE022
      *
      * Use the Deliver To field to check that there is an equivalent  T
      * Depot Ref. on the Securities ICD (SDSTRDPD).  If so and the
      * Discretionary Indicator = 'M', move the corresponding Depot Ref
      * from SDSECSPD to the output field (LIN32F).
     C                     MOVE B#DELT    DELTA   6
     C                     Z-ADD1         A
     C           DELTA     LOKUPARR36,A                  29
     C**********           ENDIF                                          CSE022
     C                     ENDIF
     C                     ENDIF
      *
     C           *IN29     IFEQ '1'
     C           B#TDMI    ANDNE'G'
     C                     MOVEAARRSE,A   LIN32H
     C                     MOVE 'VIA'     LIN32G
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      * *************** Processing for Trades Sold *****************
      *
      *  If Trade Sold, execute the following code.
     C           B#TDTP    IFEQ 'TS'
      *
      *  If the Settlement Method is any of the following codes, load
      *  LIN20A with 'FROM YOUR ACCOUNT WITH'.
     C           B#SMTH    IFEQ 01
     C           B#SMTH    OREQ 07
     C           B#SMTH    OREQ 08
     C                     MOVEAARRA,24   LIN20C
     C                     ELSE
      *
      *  If the Settlement Method is 05 or 06 or 15 load LIN20C with
      *  'FROM YOUR ACCOUNT'.
     C           B#SMTH    IFEQ 05
     C           B#SMTH    OREQ 06
     C           B#SMTH    OREQ 15
     C                     MOVEAARRA,41   LIN20C
     C                     ELSE
      *
      * If the Settlement Method is either 04 or 14, load LIN20C with    IN
      * element 12.  Else load it with element 23.
     C           B#SMTH    IFEQ 04
     C           B#SMTH    OREQ 14
     C                     MOVEAARRA,12   LIN20C
     C                     ELSE
     C                     MOVEAARRA,23   LIN20C
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      *  Fill LIN29C with 'DELIVER TO' unless this is a
      *  Discretionary Customer or a Grey Market Trade.
     C           @DISC     IFNE 'D'
     C           @DISC     ANDNE'S'
     C           B#TDMI    ANDNE'G'
     C                     MOVEAARRA,26   LIN29C
     C                     ENDIF
      *
      *  If Settlem. Method = 02, move literal to LIN20D and blanks to
      *  LIN21B.
     C           B#SMTH    IFEQ 02
     C                     MOVEAARRA,10   LIN20D
     C                     ELSE
      *
      *  If Settlem. Method = 12, move ARRA,16 to LIN20D and blanks to
      *  LIN21D.
     C           B#SMTH    IFEQ 12
     C                     MOVEAARRA,16   LIN20D
     C                     ELSE
      *
      *  If Settlem. Method = 00 or blanks or Pay To field = blanks move
      *  'INSTRUCTIONS TO BE ADVISED' to LIN20D and blanks to LIN21D.
     C           B#SMTH    IFEQ *ZEROS
     C           B#PAYT    OREQ *BLANKS
     C           B#SMTH    ANDNE04
     C                     MOVEAARRA,18   LIN20D
     C                     ELSE
      *
      *  If Settlem. Method = 14 move Pay To field to LIN20D and blanks
      *  to LIN21D.
     C           B#SMTH    IFEQ 14
      *
     C           B#PAYT    IFNE *BLANKS
     C**********           MOVE B#PAYT    W#ACNO                                            AR736004
     C                     MOVELB#PAYT    W#ACNO                                            AR736004
     C           K#ACNO    CHAINFDRETALL             41
      *
     C           *IN41     IFEQ '1'
     C                     Z-ADD79        DBASE             ************
     C                     MOVEL'FDRETALL'DBFILE            * DATABASE *
     C                     MOVE K#ACNO    DBKEY             * ERROR 79 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBRCA      BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELCNUM      CUST
     C                     MOVE CCY       CURRCY
     C                     MOVEL'-'       CURRCY
     C                     MOVE ACOD      ACCODE
     C                     MOVEL'-'       ACCODE
     C                     MOVE ACSQ      ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20D
     C                     ENDIF
      *
     C                     ELSE
      *
      *  If the Settlement Method = 01, 07 or 08 access the Nostro file,
      *  pick up customer number and use it to access SDCUSTPD.
     C           B#SMTH    IFEQ 01
     C           B#SMTH    OREQ 07
     C           B#SMTH    OREQ 08
      *
      *  Set up parameters for call to AONOSTR0.
     C                     MOVELB#SETC    PCYCD
     C                     MOVELB#PAYT    PNONB
     C                     EXSR SRNOST
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD68        DBASE            * DB ERROR 68 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      *  If no errors, use A7CUST to get Customer Name and Town from
      *  SDCUSTPD.
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD69        DBASE            * DB ERROR 69 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN20D
     C                     MOVELBBCRTN    LIN21D
      *
      *  In the next few lines calculate the detail output on lines
      *  23, and 24 ('PAYMENT TO').
      *
      *  Move element 28 of ARRA to LIN23C.
     C                     MOVEAARRA,28   LIN23C
      *
      * Test the sub-fields of 'Pay From'.  If first 2 digits of B#PYFME
      * are numeric but the following 4 are blank - Nostro number.  If
      * all the first 6 digits are numeric - Customer number.
      * Use the appropriate access objects to get the Customer Name and
      * Town.
      *
     C           B#PYFM    IFNE *BLANKS
      *
     C                     TESTN          NOSTR2     10
     C**********           TESTN          CUSTN2     09                                       CSD027
      *
     C           *IN10     IFEQ '1'
     C********** *IN09     ANDEQ'0'                                                           CSD027
      *
      *  Set up parameters for call to AONOSTR0.
     C                     MOVELB#SETC    PCYCD
     C                     MOVELB#PYFM    PNONB
     C                     EXSR SRNOST
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD70        DBASE            * DB ERROR 70 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      *  Set up key for call to AOCUSTR0.
     C                     MOVELA7CUST    PCUST
     C                     EXSR SRCUST
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD71        DBASE            * DB ERROR 71 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      *  Move Customer Name and Town to fields for output.
     C                     MOVELBBCRNM    LIN23D
     C                     MOVELBBCRTN    LIN24D
     C                     ELSE
      *
      *  If all 6 characters are numeric, access SDCUSTPD directly.
     C           *IN10     IFEQ '1'
     C********** *IN09     ANDEQ'1'                                                           CSD027
     C                     MOVELCUSTN2    PCUST
     C                     EXSR SRCUST
      *
      * Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD72        DBASE            * DB ERROR 72 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
      *  Move Customer Name and Town to fields for output.
     C                     MOVELBBCRNM    LIN23D
     C                     MOVELBBCRTN    LIN24D
      *
     C                     ENDIF
     C                     ENDIF
      *
      *  If B#PYFM neither 2 numeric or 6 numeric output a 'WE WAIT
      *  YOUR ADVICE' message.
     C                     ELSE
     C                     MOVEAARRA,19   LIN23D
     C                     ENDIF
      *
     C                     ELSE
      *
      *  Set up 'Pay To' output field.  If Settlement Method = 05, set
      *  up the 4 parts of the account number.  (Name & Town 1)
     C           B#SMTH    IFEQ 04
     C                     MOVELB#PYTA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVE B#TCNR    CUST    6
     C                     MOVE B#SETC    CURRCY  4
     C                     MOVEL'-'       CURRCY
     C**********           MOVE BMACCD    ACCODE  5                                           CGL029
     C                     MOVE BMACCD    ACCODE                                              CGL029
     C                     MOVEL'-'       ACCODE
     C                     MOVE '01'      ACSEQ   3
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20D
     C                     ELSE
      *
      *  Concerned with Name Town 1, if Settlem. Meth.= 05, set up the
      *  4 parts of the account number frome the data in 'Pay To'.
     C           B#SMTH    IFEQ 05
     C                     MOVELB#PYTA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVELB#PAYT    CUST
     C                     MOVE B#SETC    CURRCY  4
     C                     MOVEL'-'       CURRCY
     C**********           MOVE B#PAYT    TEMP4   7                                           CGL029
     C                     MOVE B#PAYT    TEMP4                                               CGL029
     C                     MOVEL'-'       TEMP4
     C                     MOVELTEMP4     ACCODE
     C                     MOVE TEMP4     ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20D
     C                     ELSE
      *
      ** If Settlem. Meth. = 15 use some data from the 'Pay To' field
     C           B#SMTH    IFEQ 15
     C                     MOVELB#PAYT    CUST
     C                     MOVE B#SETC    CURRCY
     C                     MOVEL'-'       CURRCY
      *
     C********** CUST      IFNE *ZEROS                                                        CSD027
     C           CUST      IFNE *BLANKS                                                       CSD027
     C                     MOVELCUST      PCUST
     C                     EXSR SRCUST
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD75        DBASE            * DB ERROR 75 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELB#PYTA    BRANCH
     C                     MOVE '-'       BRANCH
     C                     MOVE BFACCD    ACCODE
     C                     MOVEL'-'       ACCODE
     C                     MOVE BFACSN    ACSEQ
     C                     MOVEL'-'       ACSEQ
     C                     MOVELCUSTAC    LIN20D
      *
     C                     ELSE
     C                     MOVE *BLANKS   ACCODE
     C                     MOVE *BLANKS   ACSEQ
     C                     MOVE *BLANKS   LIN20D
      *
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      * Do not process Names and Towns 2 & 4, Literal 5 and reference
      * for Discretionary customers and Grey Market Trades.
     C           @DISC     IFNE 'D'
     C           @DISC     ANDNE'S'
     C           B#TDMI    ANDNE'G'
      *
      *  Use the 'Deliver To' field to find Customer name and Town
      *  for lines 29D and 30D.
     C********** B#DELT    IFNE 0                                                             CSD027
     C           B#DELT    IFNE *BLANKS                                                       CSD027
     C                     MOVELB#DELT    PCUST
     C                     EXSR SRCUST
      *
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD76        DBASE            * DB ERROR 76 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN29D
     C                     MOVELBBCRTN    LIN30D
      *
     C                     MOVE B#DELT    PSECS
     C                     EXSR SRSECS
      *
     C           *INU7     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD93        DBASE            ***************
     C                     GOTO ERRTAG                     ** DB ERROR 93
     C                     ENDIF                           ***************
      *
     C                     MOVE BFCLAS    DEPTYP
     C                     ELSE
      *
      *  ... else B#DELT is blank, do not fill output fields or DEPTYP
     C                     MOVE *BLANKS   LIN29C
     C                     MOVE *BLANKS   LIN29D
     C                     MOVE *BLANKS   LIN30D
     C                     MOVE ' '       DEPTYP
     C                     ENDIF
      *
      *  Use the 'Deliver To' field to find Customer name and Town for
      *  lines 32D and 33D.
     C********** B#DELF    IFNE 0                                                             CSD027
     C           B#DELF    IFNE *BLANKS                                                       CSD027
     C                     MOVELB#DELF    PCUST
     C                     EXSR SRCUST
      *
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD77        DBASE            * DB ERROR 77 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     MOVELBBCRNM    LIN32D
     C                     MOVELBBCRTN    LIN33D
      *
      *  Load line 32C (Literal 5) from ARRA,25.
     C                     MOVEAARRA,25   LIN32C
      *
      *  ... else 'Deliver From' is blank, do not fill fields
     C                     ELSE
     C                     MOVE *BLANKS   LIN32C
     C                     MOVE *BLANKS   LIN32D
     C                     MOVE *BLANKS   LIN33D
     C                     ENDIF
      *
      *  Reference 2, use 'For a/c Of - Deliver To' (if present)...
     C           B#DTFA    IFNE *BLANKS
     C                     MOVELB#DTFA    PSECS
     C                     EXSR SRSECS
     C                     ELSE
      *
      *  ... if not present, get details using Counterparty Number
     C********** B#TCNR    IFNE *ZEROS                                                        CSD027
     C           B#TCNR    IFNE *BLANKS                                                       CSD027
     C                     MOVE B#TCNR    PSECS
     C                     EXSR SRSECS
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD78        DBASE            * DB ERROR 78 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     ENDIF
      *
     C                     ENDIF
      *
      **If*the*Deliver*To*is*a*Euroclear,*Cedel,*or*Kassenverein*depot*   CSE022
      **the*depot*reference*is*in*a*fixed*position*********************   CSE022
      ** If the "Deliver To" is a Euroclear or Cedel depot, the depot     CSE022
      ** reference is in a fixed position.                                CSE022
      *                                                                   CSE022
     C           DEPTYP    IFEQ 'E'
     C                     Z-ADD1         V
     C                     MOVE *ON       *IN29
     C                     ELSE
     C           DEPTYP    IFEQ 'C'
     C                     Z-ADD2         V
     C                     MOVE *ON       *IN29
     C                     ELSE
     C********** DEPTYP    IFEQ 'K'                                       CSE022
     C**********           Z-ADD3         V                               CSE022
     C**********           MOVE *ON       *IN29                           CSE022
     C**********           ELSE                                           CSE022
      *
      * Use the Deliver To field to check that there is an equivalent  T
      * Depot Ref. on the Securities ICD (SDSTRDPD).  If so and the
      * Discretionary Indicator = 'M', move the corresponding Depot Ref
      * from SDSECSPD to the output field (LIN29H).
      *
     C                     MOVE B#DELT    DELTA   6
     C                     Z-ADD1         V
     C           DELTA     LOKUPARR36,V                  29
     C**********           ENDIF                                          CSE022
     C                     ENDIF
     C                     ENDIF
      *
     C           BFCLAS    IFEQ 'M'
     C           *IN29     ANDEQ'1'
     C           B#TDMI    ANDNE'G'
     C                     MOVEAARRSE,V   LIN29H
     C                     MOVE 'VIA'     LIN29G
     C                     ENDIF
      *
      *
      *  Use 'Deliver To' field to access SDSECSPD.  This will fill the
      *  elements of array ARRSE for later use.
     C********** B#DELF    IFNE *ZEROS                                                        CSD027
     C           B#DELF    IFNE *BLANKS                                                       CSD027
     C                     MOVE B#DELF    PSECS
     C                     EXSR SRSECS
      *
      *  Database error
     C           *INU7     IFEQ '1'                        ***************
     C                     Z-ADD97        DBASE            * DB ERROR 97 *
     C                     OUT  LDA                        ***************
     C                     EXSR *PSSR
     C                     GOTO ERRTAG
     C                     ENDIF
      *
     C                     ENDIF
     C*
     C**If*the*Deliver*To*is*a*Euroclear,*Cedel,*or*Kassenverein*depot*   CSE022
     C**the*depot*reference*is*in*a*fixed*position*********************   CSE022
      ** If the "Deliver To" is a Euroclear or Cedel depot, the depot     CSE022
      ** reference is in a fixed position.                                CSE022
      *                                                                   CSE022
     C           BFCLAS    IFEQ 'E'
     C                     Z-ADD1         V
     C                     MOVE *ON       *IN29
     C                     ELSE
     C           BFCLAS    IFEQ 'C'
     C                     Z-ADD2         V
     C                     MOVE *ON       *IN29
     C                     ELSE
     C********** BFCLAS    IFEQ 'K'                                       CSE022
     C**********           Z-ADD3         V                               CSE022
     C**********           MOVE *ON       *IN29                           CSE022
     C**********           ELSE                                           CSE022
      *
      * Use the Deliver From field to check that there is an equivalentT
      * Depot Ref. on the Securities ICD (SDSTRDPD).  If so and the
      * Discretionary Indicator = 'M', move the corresponding Depot Ref
      * from SDSECSPD to the output field (LIN32H).
     C                     MOVE B#DELF    DELFA
     C                     Z-ADD1         V
     C           DELFA     LOKUPARR36,V                  29
     C**********           ENDIF                                          CSE022
     C                     ENDIF
     C                     ENDIF
      *
     C           *IN29     IFEQ '1'
     C           B#TDMI    ANDNE'G'
     C                     MOVEAARRSE,V   LIN32H
     C                     MOVE 'VIA'     LIN32G
     C                     ENDIF
      *
     C                     ENDIF
     C                     ENDIF
      *
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  DAYSAC - SUBROUTINE TO CALCULATE THE NUMBER OF DAYS OF       *
      *           ACCRUED INTEREST                                    *
      *                                                               *
      *****************************************************************
      *
     C           DAYSAC    BEGSR
      *
      * IF TRADE IS A CUM-COUPON TRADE,DETERMINE THE START AND END DATES FOR
      * CALCULATING THE NUMBER OF DAYS.
      *
     C           ACIN      IFEQ 'C'
      *
      *    GET START DATE OF INTEREST BY OBTAINING THE LAST COUPON
      *    DATE BEFORE THE VALUE DATE OF THE TRADE
     C                     Z-ADDECD       ZECD
     C                     EXSR ZLCD
     C                     Z-ADDZZLCD     ZSDATE
      *
     C                     Z-ADDTDVD      ZEDATE
     C                     ENDIF
      *
      * IF TRADE IS AN EX-COUPON TRADE, SET THE START DATE TO VALUE DATE OF
      * TRADE AND END DATE TO NEXT COUPON DATE.
      *
     C           ACIN      IFEQ 'X'
     C                     Z-ADDTDVD      ZSDATE
     C                     Z-ADDNCD       ZEDATE
     C                     ENDIF
      *
      * CALCULATE THE NUMBER OF DAYS OF ACCRUED INTEREST.
      *
     C                     EXSR ZDAYS
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * UPDATE - SUBROUTINE TO UPDATE CONFIRMATION REQUIRED FIELD AND *
      *          MESSAGE INDICATOR OF THE RECORDS ON THE TRADES FILE  *
      *                                                               *
      *****************************************************************
      *
     C           UPDATE    BEGSR
      *
      *  Update trade already in buffer
     C                     MOVE 'N'       TCFR
     C                     BITON'0'       TMSI
     C                     UPDATTRADSDF
      *
      *  Access linked trade
     C                     MOVELTDBA      W#TDBA
     C                     MOVELLKRF      W#TDRF
     C           K#TRAD    CHAINTRADSDF              41
     C                     MOVE 'N'       TCFR
     C                     BITON'0'       TMSI
     C                     UPDATTRADSDF
      *
     C                     COMIT
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  AUDIT  - SUBROUTINE TO OUTPUT AUDIT REPORT ONLY WHEN A DB    *
      *           ERROR HAS OCCURRED IN THE PROCESSING OF A RECORD    *
      *                                                               *
      *****************************************************************
      *
     C           AUDIT     BEGSR
      *
     C                     WRITEHEADAU
      *
     C                     WRITEERROR
      *
     C** RCF Processing for Audit File
      *
     C                     EXSR RCFAU
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *   STAR  - PUTS AN ASTERISK IN EVERY ZERO SUPRESSED POSITION   *
      *           OF THE OUTPUT NUMERIC FIELDS AFTER EDITTING BY      *
      *           ZSEDIT.                                             *
      *                                                               *
      *****************************************************************
      *
     C           STAR      BEGSR
      *
     C                     Z-ADD1         Y       20
     C                     MOVE *ON       *IN71
      *
     C           *IN71     DOUEQ'0'
     C           Y         OREQ 21
     C           ARRB,Y    COMP *BLANK                   71
     C   71                MOVEA'*'       ARRB,Y
     C                     ADD  1         Y
     C                     ENDDO
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * TRDSR  - SUBROUTINE FOR ERROR HANDLING OF TRADE CONFIRMATIONS *
      *                                                               *
      *****************************************************************
      *
     C           TRDSR     BEGSR
      *
     C           *LOCK     IN   LDA
     C                     MOVEL'TRDCONF' DBFILE
     C                     MOVELTDBA      DBKEY
     C                     MOVE TDRF      DBKEY            ***************
     C                     Z-ADD43        DBASE            * DB ERROR 43 *
     C                     MOVELTRDSTS    DBSTAT  5        ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     MOVE '1'       *IN97
     C                     SETON                     99U7U8
     C                     GOTO EAUDIT
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  LINKTR - OBTAIN OTHER TRADE OF BUY-SELL AND DETRMINE WHICH   *
      *           TRADE HAS EARLIER VALUE DATE                        *
      *                                                               *
      *****************************************************************
      *
     C           LINKTR    BEGSR
      *
      ** Clear data structures and move current record to TRADEA
     C                     CLEARTRADEA
     C                     CLEARTRADEB
     C                     MOVE CURTRD    TRADEA
     C                     CLEARCURTRD
      *
      ** Access other trade of Buy-Sell Back
     C                     MOVELA#TDBA    W#TDBA
     C                     MOVELA#LKRF    W#TDRF
     C           K#TRAD    CHAINTRADSDF              41
      *
      ** Database error
     C           *IN41     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD66        DBASE             ************
     C                     MOVE 'TRDCONF' DBFILE            * DATABASE *
     C                     MOVELW#TDRF    DBKEY             * ERROR 66 *
     C                     SETON                     U7U8   ************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ** Move trade with later value date into data structure TRADEB
      ** and trade with earlier value date into data structure TRADEA.
     C           TDVD      IFGT A#TDVD
     C                     MOVE CURTRD    TRADEB
     C                     ELSE
     C                     MOVE TRADEA    TRADEB
     C                     CLEARTRADEA
     C                     MOVE CURTRD    TRADEA
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  CLROUT - CLEAR ALL FIELDS                                    *
      *                                                               *
      *****************************************************************
      *
     C           CLROUT    BEGSR
      *
     C                     MOVEL*BLANKS   LIN01
     C                     MOVEL*BLANKS   LIN02
     C                     MOVEL*BLANKS   LIN03
     C                     MOVEL*BLANKS   LIN04
     C                     MOVEL*BLANKS   O#INCO
     C                     MOVEL*BLANKS   O#ISM1
     C                     MOVEL*BLANKS   O#ISM2
     C                     MOVEL*BLANKS   LIN06
     C                     MOVEL*BLANKS   O#TDDT
     C                     MOVEL*BLANKS   ZFNM1
     C                     MOVEL*BLANKS   O#CCY
     C                     MOVEL*BLANKS   O#NOML
     C                     MOVEL*BLANKS   LIN10
     C                     MOVEL*BLANKS   O#NCD
     C                     MOVEL*BLANKS   O#VALD
     C                     MOVEL*BLANKS   O#VPDY
     C                     MOVEL*BLANKS   O#VCON
     C                     MOVEL*BLANKS   O#VNAR
     C                     MOVEL*BLANKS   O#VCPN
     C                     MOVEL*BLANKS   O#VINT
     C                     MOVEL*BLANKS   O#VVAL
     C                     MOVEL*BLANKS   O#MATD
     C                     MOVEL*BLANKS   O#MPDY
     C                     MOVEL*BLANKS   O#MCON
     C                     MOVEL*BLANKS   O#MNAR
     C                     MOVEL*BLANKS   O#MCPN
     C                     MOVEL*BLANKS   O#MINT
     C                     MOVEL*BLANKS   O#MVAL
      *
     C                     MOVEL*BLANKS   LIN20A
     C                     MOVEL*BLANKS   LIN20B
     C                     MOVEL*BLANKS   LIN20C
     C                     MOVEL*BLANKS   LIN20D
     C                     MOVEL*BLANKS   LIN21B
     C                     MOVEL*BLANKS   LIN21D
     C                     MOVEL*BLANKS   LIN23A
     C                     MOVEL*BLANKS   LIN23B
     C                     MOVEL*BLANKS   LIN23C
     C                     MOVEL*BLANKS   LIN23D
     C                     MOVEL*BLANKS   LIN24B
     C                     MOVEL*BLANKS   LIN24D
     C                     MOVEL*BLANKS   LIN26A
     C                     MOVEL*BLANKS   LIN26B
     C                     MOVEL*BLANKS   LIN26C
     C                     MOVEL*BLANKS   LIN26D
     C                     MOVEL*BLANKS   LIN29A
     C                     MOVEL*BLANKS   LIN29B
     C                     MOVEL*BLANKS   LIN29C
     C                     MOVEL*BLANKS   LIN29D
     C                     MOVEL*BLANKS   LIN29E
     C                     MOVEL*BLANKS   LIN29F
     C                     MOVEL*BLANKS   LIN29G
     C                     MOVEL*BLANKS   LIN29H
     C                     MOVEL*BLANKS   LIN30B
     C                     MOVEL*BLANKS   LIN30D
     C                     MOVEL*BLANKS   LIN32A
     C                     MOVEL*BLANKS   LIN32B
     C                     MOVEL*BLANKS   LIN32C
     C                     MOVEL*BLANKS   LIN32D
     C                     MOVEL*BLANKS   LIN32E
     C                     MOVEL*BLANKS   LIN32F
     C                     MOVEL*BLANKS   LIN32G
     C                     MOVEL*BLANKS   LIN32H
     C                     MOVEL*BLANKS   LIN33B
     C                     MOVEL*BLANKS   LIN33D
     C                     MOVEL*BLANKS   LIN35A
     C                     MOVEL*BLANKS   LIN35B
     C                     MOVEL*BLANKS   LIN35C
     C                     MOVEL*BLANKS   LIN35D
     C                     MOVEL*BLANKS   LIN35E
     C                     MOVEL*BLANKS   LIN35F
     C                     MOVEL*BLANKS   LIN35G
     C                     MOVEL*BLANKS   LIN35H
     C                     MOVEL*BLANKS   LIN36B
     C                     MOVEL*BLANKS   LIN36D
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  SRCUST - THIS SUBROUTINE CALLS ACCESS OBJECT AOCUSTR0 TO     *
      *           EXTRACT CUSTOMER DETAILS.                           *
      *                                                               *
      *****************************************************************
      *
     C           SRCUST    BEGSR
      *
      **  Access SDCUSTPD for Customer details.
      *
     C                     CALL 'AOCUSTR0'
     C                     PARM '*MSG    'PRTCD
     C                     PARM '*KEY    'POPTN
     C                     PARM           PCUST  10
     C                     PARM *BLANKS   PKYST   7
     C***********SDCUST    PARM SDCUST    DSFDY                           176443
     C           SDCUST    PARM SDCUST    DSSDY                           176443
      *
     C           PRTCD     IFNE *BLANK
     C           *LOCK     IN   LDA                         ************
     C                     MOVE 'SDCUSTPD'DBFILE            * DATABASE *
     C                     MOVELPCUST     DBKEY             * ERROR    *
     C                     SETON                     U7U8   ************
     C                     ENDIF
      *
     C                     MOVE *BLANKS   PCUST
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRALTN - THIS SUBROUTINE ACCESSES THE ALTERNATIVE NAME AND   *
      *           ADDRESS TABLE, SDALTNPD.                            *
      *                                                               *
      *****************************************************************
      *
     C           SRALTN    BEGSR
      *
     C                     CALL 'AOALTNR0'
     C                     PARM '*MSG    'PRTCD
     C                     PARM '*KEY    'POPTN
     C                     PARM           PCUST
     C                     PARM BFADCD    PADCD   1
     C           SDALTN    PARM SDALTN    DSFDY
      *
      **  If not found or deleted use 'B' address
     C           PRTCD     IFNE *BLANK
     C           RECI      ORNE 'D'
     C                     EXSR SRCUST
      *
      **  Otherwise, load Alternative Name and Address to normal Name
      **  and adddress fields.
     C                     ELSE
     C                     MOVELBCCNA1    BBCNA1
     C                     MOVELBCCNA2    BBCNA2
     C                     MOVELBCCNA3    BBCNA3
     C                     MOVELBCCNA4    BBCNA4
      *
     C                     ENDIF
      *
     C                     MOVE *BLANKS   PCUST
      *
     C                     ENDSR
      *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  SRSECS - THIS SUBROUTINE USES ACCESS OBJECT AOSECSR0 TO      *
      *           OBTAIN CUSTOMER SECURITY DETAILS.                   *
      *                                                               *
      *****************************************************************
      *
     C           SRSECS    BEGSR
      *
      **  Access SDSECSPD for Customer Security details.
      *
     C                     CALL 'AOSECSR0'
     C                     PARM '*MSG    'PRTCD
     C                     PARM '*KEY    'POPTN
     C                     PARM           PSECS   6
     C           SDSECS    PARM SDSECS    DSFDY
      *
     C           PRTCD     IFNE *BLANK
     C           *LOCK     IN   LDA                         ************
     C                     MOVE 'SDSECSPD'DBFILE            * DATABASE *
     C                     MOVELPSECS     DBKEY             * ERROR    *
     C                     SETON                     U7U8   ************
     C                     ENDIF
      *
     C                     MOVE *BLANKS   PSECS
      *
     C                     ENDSR
     C*
     C*****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  SRNOST - THIS SUBROUTINE USES ACCESS OBJECT AONOSTR0 TO      *
      *           OBTAIN NOSTRO STANDING DATA.                        *
      *                                                               *
      *****************************************************************
      *
     C           SRNOST    BEGSR
      *
      **  Access SDNOSTPD for Nostro details.
      *
     C                     CALL 'AONOSTR0'
     C                     PARM '*MSG    'PRTCD
     C                     PARM '*KEY    'POPTN
     C                     PARM *BLANKS   PNCST   6
     C                     PARM           PCYCD   3
     C**********           PARM *BLANKS   PACCD   4                                           CGL029
     C                     PARM *BLANKS   PACCD  10                                           CGL029
     C                     PARM *BLANKS   PACSN   2
     C                     PARM           PNONB   2
     C                     PARM *BLANKS   PBRCD   3
     C                     PARM *BLANKS   PCSSN  10
     C                     PARM *BLANKS   PPNOI   1
     C           SDNOST    PARM SDNOST    DSFDY
      *
     C           PRTCD     IFNE *BLANK
     C           *LOCK     IN   LDA                         ************
     C                     MOVE 'SDNOSTPD'DBFILE            * DATABASE *
     C                     MOVELPCYCD     W#DB5   5         * ERROR    *
     C                     MOVE PNONB     W#DB5   5         ************
     C                     MOVELW#DB5     DBKEY
     C                     SETON                     U7U8
     C                     ENDIF
      *
     C                     MOVE *BLANKS   PNONB
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * SRBOOK - ACCESS BOOK DETAILS FOR A TRADE                      *
      *                                                               *
      *****************************************************************
     C           SRBOOK    BEGSR
      *
      ** If CAC005 is installed need to convert pseudo book to user
      ** book prior to call to AOBOOKR0.
     C           CAC005    IFEQ 'Y'
      *
     C           TDBK      CHAINSDBKPCL3             89
      *
      ** Handle Database Error
     C           *IN89     IFNE *OFF
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C           *LOCK     IN   LDA
     C                     MOVE 'SDBKPCL3'DBFILE           ***************
     C                     MOVELTDBK      DBKEY            * DB ERROR 68 *
     C                     Z-ADD68        DBASE            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
      *
     C                     ELSE
     C                     MOVE PSBKCD    PBKCD
     C                     ENDIF
      *
     C                     ELSE
     C                     MOVE TDBK      PBKCD
     C                     ENDIF
      *
      **  Access Midas book details ICD
      *
     C                     CALL 'AOBOOKR0'
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM           PBKCD   2
     C           SDBOOK    PARM SDBOOK    DSFDY
      *
     C           PRTCD     IFNE *BLANKS
     C                     MOVE '56'      DBASE             ************
     C                     MOVE 'SDBOOKPD'DBFILE            * DATABASE *
     C                     MOVELTDBK      DBKEY             * ERROR 56 *
     C                     SETON                     U7U8   ************
      *
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * SRBRCH - ACCESS BRANCH DETAILS                                *
      *                                                               *
      *****************************************************************
     C           SRBRCH    BEGSR
      *
      **  Access Midas book details ICD
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   PRTCD
     C                     PARM '*KEY   ' POPTN
     C                     PARM A#TDBA    PBRCD   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
     C           PRTCD     IFNE *BLANKS
     C                     MOVE '73'      DBASE             ************
     C                     MOVE 'SDBRCHPD'DBFILE            * DATABASE *
     C                     MOVELTDBA      DBKEY             * ERROR 73 *
     C                     SETON                     U7U8   ************
      *
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  *PSSR  - Error control subroutine                            *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
      * Check to see that *PSSR has not already been called.
     C           @RUN      IFEQ *BLANKS
     C                     MOVE 'Y'       @RUN    1
      *
     C                     DUMP
     C                     ROLBK
     C                     MOVE *ON       *INLR
     C                     GOTO EAUDIT
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
     C/EJECT
      ********************************************************************
      *
      *  RCFP1 -- SUBROUTINE TO REGISTER P1 PRINTER FILE VIA RCF
      *
      ********************************************************************
      *
     C           RCFP1     BEGSR
      *
      **      Ensure report spool file recorded by RCF
     C                     Z-ADDSFNUM     ZSNUM   60
      **
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ     5
     C                     PARM A#TDBA    SENTY   3
     C                     PARM           SFILE
     C                     PARM           ZSNUM
     C                     PARM           ZSERR   1
      *
     C           ZSERR     IFEQ 'Y'
      *
      **  Error during ZSFILE processing, return to calling program
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     ENDIF
      *
     C                     ENDSR
      *
      ********************************************************************
     C/EJECT
      ********************************************************************
      *
      *  RCFAU -- SUBROUTINE TO REGISTER AU PRINTER FILE VIA RCF
      *
      ********************************************************************
      *
     C           RCFAU     BEGSR
      *
      **      Ensure audit spool file recorded by RCF
     C                     Z-ADDSFNUMU    ZSNUMU  60
      **
     C                     CALL 'ZSFILE'
     C                     PARM           SEQ
     C                     PARM *BLANKS   SENTY
     C                     PARM           SFILEU
     C                     PARM           ZSNUMU
     C                     PARM *BLANK    ZSERR
      *
     C           ZSERR     IFEQ 'Y'
      *
      **  Error during ZSFILE processing, return to calling program
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
     C/COPY WNCPYSRC,SE4110C029
      /EJECT
     C/COPY ZSRSRC,ZCONVZ1
     C/COPY WNCPYSRC,SE4110C030
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z2
      /EJECT
     C/COPY ZSRSRC,ZDAYSZ2
      /EJECT
     C/COPY ZSRSRC,ZDYYRZ3
      /EJECT
     C/COPY ZSRSRC,ZLCDZ1                                                                   MD057247
      /EJECT
     C/COPY ZSRSRC,ZNCDZ3
      /EJECT
     C/COPY ZSRSRC,ZSDESCZ3
      /EJECT
     C/COPY ZSRSRC,ZSEDITZ3
      /EJECT
      ***
      ***  ARRA Array entry A.I.B.D. changed to I.S.M.A.
**  CPY@
(c) Finastra International Limited 2001
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
** ARRA
WE CONFIRM OUR BUY/SELL BACK AGREEMENT AS FOLLOWS:








WE AWAIT YOUR REMITTANCE
WE WILL SEND REMITTANCE
DEBIT TO A/C NUMBER:
CREDIT TO A/C NUMBER:
AS PER OUR INSTRUCTIONS
AS PER YOUR INSTRUCTIONS
WE WILL COLLECT REMITTANCE
YOU WILL COLLECT REMITTANCE
INSTRUCTIONS TO BE ADVISED
WE AWAIT YOUR ADVICE
OURSELVES
**INCOMPLETE**
PAYMENT FROM:
PAYMENT:
TO OUR A/C WITH:
DELIVER FROM:
DELIVER TO:
PAYMENT TO:
PAYMENT BY:
FOR A/C OF:
SPECIAL INSTRUCTIONS:
THIS TRADE IS IN ACCORDANCE
WITH I.S.M.A. RULES
INTEREST DUE TO
THE ABOVE INTEREST AT NEXT INTEREST DATE TO OUR ACCOUNT AT
PLEASE CREDIT ALL FUTURE PAYMENTS TO THE NEW OWNER:
NEXT COUPON :
FOR DELIVERY AGAINST PAYMENT G'TEED
THIS TRADE IS IN ACCORDANCE
WITH I.P.M.A. RULES
FOR A/C OF:
FROM YOUR A/C:
(TRADE PURCHASED)                                                      174
(TRADE SOLD)                                                           174
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
     X/COPY WNCPYSRC,SE4110X001
>>>>>>> branch 'develop' of http://blrvslalm0006:7990/scm/md/midasrpg.git
