     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Pool trades maintenance')                     *
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  SE5200 - Pool Trade Detail Maintenance.                      *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      *  Last Amend No. MD036157           Date 26Jan16               *
      *  Prev Amend No. 226449             Date 24Jun15               *
      *                 MD034776           Date 09Jul15               *
      *                 AR1067108          Date 11Dec12               *
      *                 AR1001183A         Date 20Nov12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 229857             Date 07Oct04               *
      *                 226570             Date 27Jun04               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 TDA035             Date 02Apr04               *
      *                 CSC023             Date 28Jan04               *
      *                 211407             Date 07Jan03               *
      *                 207543             Date 17JUL02               *
      *                 194370             Date 12Jul01               *
      *                 180056             Date 18Oct00               *
      *                 CSE035             Date 22Apr02               *
      *                 206316             Date 19Jul02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun01               *
      *                 CSE031             Date 09Nov01               *
      *                 180707             Date 25Jul00               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CPK014             Date 14Nov01               *
      *                 CSE022             Date 29Mar01               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CGL008             Date 03Mar99               *
      *                 CAC005             Date 01Dec98               *
      *                 130862             Date 18Oct98               *
      *                 151945             Date 06Jan99               *
      *                 CSE005             Date 04Feb97               *
      *                 118852             Date 04Jun97
      *                 CAC003             Date 25Feb97               *
      *                 084704             DATE 01AUG96               *
      *                 083039             DATE 01AUG96               *
      *                 059110             DATE 25JUL96               *
      *                 088047             DATE 27JUN96               *
      *                 099886             DATE 18APR96               *
      *                 100017             DATE 18APR96               *
      *                 092961             DATE 04OCT95               *
      *                 091221             DATE 31JUL95               *
      *                 086491             DATE 15JUN95               *
      *                 087588             DATE 15MAY95               *
      *                 S01496             DATE 12DEC94               *
      *                 S01486 RS          DATE 04NOV94               *
      *                 049421             DATE 22JAN93               *
      *                 062275             DATE 19OCT93               *
      *                 58886              DATE 20JUL93               *
      *                 S01313             DATE 19MAY92               *
      *                                                               *
      *****************************************************************
      *                                                               *
      *  MD036157 - Coupon entries are missing from Position settle-  *
      *             ments maintenance screen. Recompiled due to       *
      *             /COPY ZACCZZ1 changes.                            *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  MD034776 - Reverse AR1001183A to allow negative interest     *
      *             rate. (Recompile)                                 *
      *  AR1067108 - PMC1140 Component failed during Clean COB        *
      *              Applied fix AR1001183A                           *
      *  AR1001183A - Coupon rate was still used in computation of    *
      *              interest instead of using the details in FRN tab *
      *              (Reopen) (Recompile)                             *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  229857 - Recompiled due to change in ZYLDZ2.                 *
      *  226570 - Recompiled due to change in ZYLDZ2.                 *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  TDA035 - RTS Signon changes for MidasPlus. (Recompile)       *
      *  CSC023 - SBMJOB output queue must be *JOBD.                  *
      *  211407 - Recompile after change on copy sources ZYLDZ2,      *
      *           ZACCRZ1 and ZYCEZ1 for NX/NNX processing.           *
      *           The change was to call subroutine ZLCD1 instead     *
      *           of ZLCD in retrieving the PERIOD for NNX processing *
      *           and ZNCD1 is called instead of ZNCD in retrieving   *
      *           the WBENCD for NNX processing. Also rewrite tests   *
      *           for identifying if position is NX,NNX or CUM.       *
      *  207543 - CEU018 not working on a price basis.                *
      *           Recompile over changed ZYLDZ2.                      *
      *  194370 - Recompile after change on copy sources ZYLDZ2,      *
      *           For securities with divisor basis = '5' and first   *
      *           coupon date > valuation date (rundate + 1), set     *
      *           event control date to first coupon date before      *
      *           processing SR/ZDYYR. This is to ensure that the     *
      *           correct hypothetical last and next coupon dates are *
      *           used in deriving the price/yield rate.              *
      *  180056 - Recompiled over changed in ZDYYRZ3.                 *
      *  CSE035 - NX/NNX Coupon Payment Processing.                   *
      *           Recompile over changed ZACCRZ1/ZYLDZ2
      *  206316 - Recompiled over changed ZLCDZ1.                     *
      *  CPK015 - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed ZYLDZ2.                      *
      *  CSE031 - Coupon Fixing for Floating Rate Notes.              *
      *           (recompilation due to change to ZNCD/ZLCD)          *
      *  180707 - No Position Settlements generated. Recompile over   *
      *           changes in /COPY ZNCDZ3.                            *
      *  CPK014 - Submit jobs with user *JOBD                         *
      *  CSE022 - Depository Definition Enhancement                   *
      *  CGL008 - Security on Journal Entry. Recompile.               *
      *  CAC005 - PCA-SE Enhancement.                                 *
      *  130862 - Recompiled over ZLCDZ1 & ZDAYSZ2 changes.           *
      *  151945 - Recompiled Over changed ZDYYRZ3 .                   *
      *  CSE005 - Effect of holidays on FRN Coupon Dates              *
      *           (recompilation due to change to ZNCD/ZLCD)          *
      *  118852 - Reallowance is being zeroised in writing to file    *
      *  CAC003 - Profit Centre Accounting Development Phase 3.       *
      *  084704 - RECOMPILE OVER CHANGED ZYLDZ2 SUB.                  *
      *  083039 - RECOMPILE OVER CHANGED ZYLDZ2 SUB.                  *
      *  059110 - Recompile over changed ZYLDZ2 sub.                  *
      *  088047 - RECOMPILE over change SR/ZYLDZ2.                    *
      *  099886 - Rounding problem for partly paid securities.        *
      *           Recompile over amended standard subroutine ZACCZ.   *
      *  100017 - Position settlement unable to pick up day adj. on   *
      *           SECTYD. Change subroutine to use DADJN to stop      *
      *           interest day adjustment being used for amortisation.*
      *           Recompile over amended subroutine ZDAYS.            *
      *  092961 - Recompile over ZDAYSZ2 which was amended by 086491  *
      *           (Wrong number of days calculated for day basis 1    *
      *           when start or end day is last day of February)      *
      *  091221 - Correct call to SEC5210                             *
      *  086491 - Wrong nbr of days calculated for day basis 1        *
      *           when start or end day is last day of February       *
      *           Recompiled for ZSRSRC/ZDAYSZ2 changes.              *
      *  087588  -  ACOF field is redefined as ACFA on MUSERDD        *
      *  S01496  -  Incorporation of Jyske Enhancements (S10984)      *
      *  S01486  -  Private Banking Upgrade to Release 10.            *
      *  049421  -  HEADER BOX STANDARDISATION                        *
      *  062275  -  CORRECT VALIDATION OF CLEAR HOLDING IND           *
      *  58886   -  OBJECT PM5100 RENAMED TO SE5200                   *
      *  S01313  -  RECOMPILED FOR PORTFOLIO PERFORMANCE              *
      *                                                               *
      *****************************************************************
      /EJECT
      ********************************************************************
     F*PM5100DDCF**E                    WORKSTN                           58886
     F**********SE5200DDCF  E                    WORKSTN            58886 S01486
     FSE5200DFCF  E                    WORKSTN                            S01486
     F**********SDBANKL1IF  E           K        DISK                     S01486
     F**********                                    KINFSR *PSSR          S01486
     F**********SDSTRDL0IF  E           K        DISK                     S01486
     F**********                                    KINFSR *PSSR          S01486
     F**********TABLETJ IF  E           K        DISK                     S01486
     F**********                                    KINFSR *PSSR          S01486
     F**********TABSE   IF  E           K        DISK                     S01486
     F**********  TABLETAF                          KIGNORE        B05784 S01486
     F**********  TABTB10F                          KIGNORE        B05784 S01486
     F**********  TABTB11F                          KIGNORE        B05784 S01486
     F**********  TABTB36F                          KIGNORE        B05784 S01486
     F**********  TABTB40F                          KIGNORE        B05784 S01486
     F**********  TABTE10F                          KIGNORE        B05784 S01486
     F**********  TABTE20F                          KIGNORE        B05784 S01486
     F**********  TABTG10F                          KIGNORE        B05784 S01486
     F**********  TABTG20F                          KIGNORE        B05784 S01486
     F**********  TABLETHF                          KIGNORE        B05784 S01486
     F**********  TABLETJF                          KRENAMETABLET1FB05784 S01486
     F**********  TABLETKF                          KIGNORE        B05784 S01486
     F**********  TABLETLF                          KIGNORE        B05784 S01486
     F**********  TABLETNF                          KIGNORE        B05784 S01486
     F**********  TABLETPF                          KIGNORE        B05784 S01486
     F**********  TABLETRF                          KIGNORE        B05784 S01486
     F**********  TABLETXF                          KIGNORE        B05784 S01486
     F**********  TABLET2F                          KIGNORE        B05784 S01486
     F**********  TABLET3F                          KIGNORE        B05784 S01486
     F**********  TABLET5F                          KIGNORE        B05784 S01486
     F**********                                    KINFSR *PSSR          S01486
     F**********SDCURRL0IF  E           K        DISK                     S01486
     F**********                                    KINFSR *PSSR          S01486
     FSEMKC   IF  E           K        DISK
     F                                              KINFSR *PSSR
     FSEDEV   IF  E           K        DISK                               S01235
     F                                              KINFSR *PSSR
     FSECEO   IF  E           K        DISK                               S01486
     F            SNDEVDF                           KRENAMESNDEVDO        S01486
     F            SEDEVDF                           KRENAMESEDEVDO        S01486
     F                                              KINFSR *PSSR
     FSECTY   IF  E           K        DISK
     F                                              KINFSR *PSSR
     FSECGT   IF  E           K        DISK
     F                                              KINFSR *PSSR
     FFDDIV   IF  E           K        DISK                               B05784
     F            SEDEVDF                           KRENAMESEDEVD2        B05784
     F                                              KINFSR *PSSR
     F************SECET   IF  E           K        DISK            B05784 S01486
     F************SEDEVDF                           KRENAMESEDEVD3 B05784 S01486
     F************                                  KINFSR *PSSR          S01486
     FINVTP   IF  E           K        DISK
     F                                              KINFSR *PSSR
     FCUBRD   IF  E           K        DISK
     F                                              KINFSR *PSSR
     FSECUBRL0IF  E           K        DISK                           UC  S01496
     F            CUBRDDF                           KRENAMECUBRDDFX       S01496
     F                                              KINFSR *PSSR          S01496
     F**********SDCUSTL6IF  E           K        DISK                     S01486
     F**********                                    KINFSR *PSSR          S01486
     F**********SDSECSL1IF  E           K        DISK                     S01486
     F**********                                    KINFSR *PSSR          S01486
     F**********SDDLSTL1IF  E           K        DISK                     S01486
     F**********                                    KINFSR *PSSR          S01486
     F**********PMPORTPPIF  E           K        DISK                     S01486
     FPMPORTPDIF  E           K        DISK                               S01486
     F                                              KINFSR *PSSR
     FPMPLTRPDUF  E           K        DISK         KCOMIT       A
     F                                              KINFSR *PSSR
     F********************************************************************
      /EJECT
     F********************************************************************
     F*
     F*   INDICATOR USAGE
     F*   ---------------
     F*
     F*   01      ERROR ON FILE CHAIN
     F*   02      ENABLE COMMAND KEY F9 FOR AGENCY TRADE
     F*
     F*   30      Analytical Accounting Module and CAC003 is installed    CAC003
     F*   31      ERROR - Margin Points                                   CAC003
     F*   36      INCORECT USER DEPARTMENT                                S01486
     F*   37      Working indicator
     F*   38      Working indicator
     F*   39      Working indicator
     F*
     F*   41      Protect fields
     F*   42      Protect fields
      *  45 - CAC005 is on, display profit centre in the display file.*   CAC005
     F*
     F*   04      DISPLAY INTEREST DETAILS FOR AMENDMENT
     F*   47      Display price
     F*   48      Display ex-dividend
     F*
     F*   46      ERROR - Clear holding
     F*   49      ERROR - Total nominal
     F*   50      ERROR - Price/Discount/Yield
     F*   51      ERROR - Incomplete ind.
     F*   52      ERROR - Price
     F*   53      ERROR - Ex dividend
     F*   53      ERROR - Branch code
     F*   54      ERROR - Value date
     F*   55      ERROR - Capacity
     F*   56      ERROR - Market centre
     F*   57      ERROR - Reallowance/sign
     F*   58      ERROR - Trader I.D
     F*   59      ERROR - Trade date
     F*   60      ERROR - Trade subtype
     F*   61      ERROR - Link reference
     F*   62      ERROR - Market ind.
     F*   63      ERROR - AIDB/IPPA
     F*   65      ERROR - Accrued ind.
     F*   66      ERROR - Days adj./sign
     F*   67      ERROR - Act./diff. ind.
     F*   68      ERROR - Settlement curr.
     F*   69      ERROR - Rate
     F*   70      ERROR - Mult/Div. ind.
     F*   71      ERROR - Base currency rate
     F*   72      ERROR - Deliver from
     F*   73      ERROR - Deliver to
     F*   74      ERROR - Clearance type
     F*   75      ERROR - Auto-settle indicator
     F*   76      ERROR - Broker commission
     F*   77      ERROR - Customer commission
     F*   78      ERROR - Charge 1 Code
     F*   79      ERROR - Charge 2 Code
     F*   80      ERROR - Charge 3 Code
     F*   81      ERROR - Charge 4 Code
     F*   82      ERROR - Charge 5 Code
     F*   83      ERROR - Charge 6 Code
     F*   84      ERROR - Charge 7 Code
     F*   85      ERROR - Brooker commission rebate
     F*   86      ERROR - Customer commission rebate
     F*   87      ERROR - Tax commission rebate
     F*   88      ERROR - Confirm pool trade
     F*   89      ERROR - Error messages
     F*
     F*   90 - 99 Used in validation/conversion routines (Z s/r's)
     F*
     F*   U1      Retail module in system
     F*   U7      Data base error
     F*   U8      Data base error
     F*
     F********************************************************************
      /EJECT
     E********************************************************************
     E                    XCCY       25  3
     E**
     E** FOR COMMAND KEYS ON SCREEN
     E***********         @TX     1   6 80               Text strings     091221
     E                    @TX     1   7 80               Text strings     091221
     E                    @F         16  1
     E**
     E** USED FOR COPYRIGHT
     E                    CPY@    1   1 80
     E**
     E** FOR ERROR MESSAGE
     E                    @EA        19  4               Error codes
     E************/COPY ZSRSRC,ZDATE5Z1                                   S01486
     E/COPY ZSRSRC,ZPOWER8Z1
     E                    AP      1  10 10 0             POWER ARRAY      CAC003
     E/COPY ZSRSRC,ZPOWERZ1
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZDAYSZ1
     E/COPY ZSRSRC,ZASIGNZ1
     E************/COPY ZSRSRC,ZDATE3Z1                                   S01486
     E/COPY ZSRSRC,ZNCDZ1
     E/COPY ZSRSRC,ZSEDITZ1
     E/COPY ZSRSRC,ZALIGNZ1
     E/COPY ZSRSRC,ZHOLE                                                  S01486
     E/COPY ZSRSRC,ZACCRZ0                                                S01486
     E**
     E** USED FOR VALIDATION OF PAY FROM
     E**
     E                    APF        16  1               VALID PAY FROM
     E********************************************************************
      /EJECT
     I********************************************************************
     I*********/COPY ZSRSRC,ZDATE3Z2                                      S01486
     I*********TABLET1F                                                   S01486
     I*********     HCCY                            HOLC                  S01486
     I* Rename of holiday currencies array on Holidays file
     I*
     I*  Rename nominal currency field
     I*
     ISECTYDF
     I              NMCY                            NMCYA
     I/COPY WNCPYSRC,SE5200I001
     I            DS
     I* Data structure for compilation - Copyright insertion
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I*  Error reporting data structure
     I***LDA*****    DS                            256                    S01486
     I***********                           132 141 @DBFIL                S01486
     ILDA         DS                            256                       S01486
     I                                      134 141 @DBFIL                S01486
     I                                      142 170 @DBKEY
     I                                      171 180 @DBPGM
     I                                      181 1830@DBASE
     I                                      134 183 @DBALL                S01486
     I***********                           132 183 @DBALL                S01486
     I*
     I** DATA AREA ZMUSER                                                 S01486
     IWUSER       DS                             17                       S01486
     I                                        1  10 WWNAME                S01486
     I*                                                                   S01486
     I* FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE                S01486
     IDSFDY     E DSDSFDY                                                 S01486
     I*                                                                   S01486
     I** EXTERNAL DS FOR BANK DETAILS                                     S01486
     ISDBANK    E DSSDBANKPD                                              S01486
     I*                                                                   S01486
     I** EXTERNAL DS FOR SECURITIES TRADING                               S01486
     ISDSTRD    E DSSDSTRDPD                                              S01486
     I*                                                                   S01486
     I** EXTERNAL DS FOR CURRENCY DETAIL                                  S01486
     ISDCURR    E DSSDCURRPD                                              S01486
     I*                                                                   S01486
     I** EXTERNAL DS FOR CUSTOMER DETAIL                                  S01486
     ISDCUST    E DSSDCUSTPD                                              S01486
     I*                                                                   S01486
     I** EXTERNAL DS FOR SECURITIES CUSTOMERS                             S01486
     ISDSECS    E DSSDSECSPD                                              S01486
     I*                                                                   S01486
     I** EXTERNAL DS FOR DEAL SYB-TYPES                                   S01486
     ISDDLST    E DSSDDLSTPD                                              S01486
     I*                                                                   CAC003
     I** External DS for Modules File                                     CAC003
     ISDMMOD    E DSSDMMODPD                                              CAC003
     I*                                                                   CAC003
     I** External DS for Profit Center Accounting ICD                     CAC003
     ISDPCAC    E DSSDPCACPD                                              CAC003
     I*                                                                   S01486
     I** DATA STRUCTURE FOR USER DETAILS                                  S01486
     ID@USER    E DSMUSERDD                                               S01486
     I*                                                                   S01486
     I** DATA STRUCTURE FOR ACCOUNT OFFICER                               S01486
     ISDACOF    E DSSDACOFPD                                              S01486
     I*                                                                   S01486
     I** DATA STRUCTURE FOR PM                                            S01486
     ISDPORT    E DSSDPORTPD                                              S01486
     I*  Program status data structure
     IPSDS       SDS
     I                                      244 253 @JOB
     I                                      254 263 @USR
     I                                      254 263 SUSER                 S01486
     I*
     I*  Data structure to hold trade details
     I*
     I@PARMT      DS
     I                                        1   1 @PACTN
     I                                        2   7 @PBLKR
     I                                        8   8 @PAGTR
     I                                        9  18 @PSESN
     I                                       19  19 @PDFPA
     I                                       20  21 @PTDTP
     I                                       22  23 @PPBBK
     I                                       24  29 @PPOCU
     I                                       30  33 @PPOFO
     I                                       34  49 @PBONO
     I                                       50  65 @PMANO
     I                                       66  81 @PPONO
     I                                       82  97 @PTPDY
     I                                       98 100 @PBRCD
     I                                      101 101 @PCLTY
     I                                      102 107 @PTDDT
     I                                      108 113 @PTDVD
     I                                      114 114 @PACIN
     I                                      115 118 @PDADJ
     I                                      119 119 @PACTD
     I                                      120 125 @PDELF
     I                                      126 131 @PDELT
     I                                      132 133 @PCMDK
     I                                      134 134 @PTPLT
     I                                    P 135 1410PCHRG
     I                                    P 142 1480PNTOT
     I*
     I* DATA STRUCTURE FOR BJMRDT
     I************DS                                                      S01486
     IWWMRDT      DS                                                      S01486
     I                                        1   20XXDAY
     I                                        3   5 XXMNT
     I                                        6   70XXYEAR
     I************                            1   7 BJMRDT                S01486
     I*                                                                  *
     I* DATA STRUCTURE FOR DATABASE ERROR ON LF/INVTP
     I@DS1        DS
     I                                        1   3 NMCYA
     I                                        4   6 SITP
     I*                                                                  *
     I* DATA STRUCTURE FOR DATABASE ERROR ON PF/PMPORTPD                  S01486
     I**DATA*STRUCTURE*FOR*DATABASE*ERROR*ON*PF/PMPORTPP******************S01486
     I@DS2        DS
     I**********                              1   60PPPOCU                                    CSD027
     I                                        1   6 PPPOCU                                    CSD027
     I                                        7  10 PPPOFO
     I*                                                                  *
     I* DATA STRUCTURE FOR DATABASE ERROR ON LF/SECGT
     I@DS7        DS
     I                                        1   3 @XCCY
     I                                        4   5 @XCODE
      *  Data structure for command string for QCMDEXC
     I***@CMD********DS                            160                    091221
     I@CMD        DS                            175                       091221
     I                                       12  20 @CJOB
     I                                       14  19 @CBREF
     I                                       20  20 @CACTN
     I                                       81 133 @CMD1                 091221
     I                                       84  93 @CMWI
     I                                       99 104 @CMBR
     I                                      135 175 @CMD2                 091221
     I************************               83  92 @CMWI
     I************************               96 101 @CMBR
     I*
     I*  Data structure to strip last character from ZSEDIT output
     I            DS
     I                                        1  21 ZOUT21
     I                                        1  20 ZOUT20
     I/COPY ZSRSRC,ZSEDITZ2
     I/COPY ZSRSRC,ZNCDZ2
     I/COPY ZSRSRC,ZYLDZ1
     I/COPY ZSRSRC,ZTNLU1Z1
     I/COPY ZSRSRC,ZHOLI                                                  S01486
     I/COPY ZSRSRC,ZHOLDS                                                 S01486
     I*********/COPY ZSRSRC,ZDATE3Z3                                      S01486
     I/COPY WNCPYSRC,SE5200I002
     I********************************************************************
      /EJECT
     C*****************************************************************
     C*  PLIST's, KLIST's, DEFN's etc....                             *
     C*****************************************************************
     C*
     C           *ENTRY    PLIST
     C           @PARMT    PARM @PARMT    @PARMT
     C*
     C/COPY WNCPYSRC,SE5200C001
      *                                                                                       CSE035
      *  Access SAR details file to see if CSE035 is installed                                CSE035
      *                                                                                       CSE035
     C                     CALL 'AOSARDR0'                                                    CSE035
     C                     PARM *BLANKS   @RTCD                                               CSE035
     C                     PARM '*VERIFY' @OPTN                                               CSE035
     C                     PARM 'CSE035'  WSARD   6                                           CSE035
      *                                                                                       CSE035
     C           @RTCD     IFEQ *BLANK                                                        CSE035
     C                     MOVE 'Y'       CSE035  1                                           CSE035
     C                     ELSE                                                               CSE035
     C                     MOVE 'N'       CSE035                                              CSE035
     C                     ENDIF                                                              CSE035
      *                                                                                       207543
      ** Access SAR details file to see if CEU018 is installed                                207543
      *                                                                                       207543
     C                     CALL 'AOSARDR0'                                                    207543
     C                     PARM *BLANKS   @RTCD                                               207543
     C                     PARM '*VERIFY' @OPTN                                               207543
     C                     PARM 'CEU018'  WSARD                                               207543
      *                                                                                       207543
     C           @RTCD     IFEQ *BLANK                                                        207543
     C                     MOVE 'Y'       CEU018  1                                           207543
     C                     ELSE                                                               207543
     C                     MOVE 'N'       CEU018                                              207543
     C                     END                                                                207543
      *                                                                                       CSE035
     C           *NAMVAR   DEFN           LDA
     C           *LIKE     DEFN @DBALL    @DBSAV
     C           *LIKE     DEFN BJRDNB    ECD
     C           *LIKE     DEFN A6NQDP    ZNQDPX                          CAC003
     C           *LIKE     DEFN A6NQDP    ZNQDP1                          CAC003
     C           *LIKE     DEFN A6NQDP    ZNQDP2                          CAC003
     C*
     C* Key list for LF/INVTP
     C*
     C           @KEY1     KLIST
     C                     KFLD           NMCYA
     C                     KFLD           SITP
     C*
     C**Key*list*for*PF/PMPORTPP******************************************S01486
     C* Key list for PF/PMPORTPD                                          S01486
     C*
     C           @KEY2     KLIST
     C                     KFLD           PPPOCU
     C                     KFLD           PPPOFO
     C*
     C* Key list for PF/PMPLTRPD
     C*
     C           @KEY3     KLIST
     C                     KFLD           @PBLKR
     C                     KFLD           WPPOCU
     C                     KFLD           @PPOFO
     C***********                                                         S01486
     C**Key*list*for LF/SECET                                             S01486
     C***********                                                         S01486
     C***********@KEY4     KLIST                                          S01486
     C***********          KFLD           WWSDSN                          S01486
     C***********          KFLD           WWSDET                          S01486
     C***********          KFLD           WWSDED                          S01486
     C*
     C* Key list for LF/SECGT
     C*
     C           @KEY7     KLIST
     C                     KFLD           @XCCY   3
     C                     KFLD           @XCODE  2
     C*
     C* Key list for LF/CUBRD
     C*
     C           @KEY9     KLIST
     C                     KFLD           @KC1D1  1
     C                     KFLD           @KSITP  3
     C                     KFLD           @KMRKT  2
     C**********           KFLD           @KCNUM  60                                          CSD027
     C                     KFLD           @KCNUM  6                                           CSD027
     C*                                                                   S01496
     C**  Key list for LF/SECUBRL0                                        S01496
     C*                                                                   S01496
     C           @KEY9A    KLIST                                          S01496
     C                     KFLD           @KCLGR  2                       S01496
     C                     KFLD           @KSITP  3                       S01496
     C                     KFLD           @KMRKT  2                       S01496
     C**********           KFLD           @KCNUM  60                                   S01496 CSD027
     C                     KFLD           @KCNUM  6                                           CSD027
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C*                                                                 **
     C*    M A I N   P R O C E S S I N G                                 *
     C*                                                                  *
     C********************************************************************
      *
     C* Process according to action code received and to 'Terminate
     C* pool trade'
     C*
     C           @PTPLT    IFEQ 'Y'
     C                     SETON                     LR
     C                     RETRN
     C                     END
     C*
     C           @PACTN    IFEQ 'I'
     C           @PACTN    OREQ 'A'
     C                     EXSR P001
     C                     END
      *
     C* Terminate program without setting on LR
     C*
     C                     RETRN
     C*
     C********************************************************************
      /EJECT
     C*******************************************************************
     C*  P001 - Main processing for action code I or A                  *
     C*******************************************************************
     C*
     C           P001      BEGSR
     C*
     C*
     C* Initialise command keys text
     C*
     C           @PBLKR    IFNE @SBLKR                     B1
     C*
     C           @PACTN    IFEQ 'I'                        B2
     C           @PAGTR    ANDEQ'N'
     C           @PACTN    OREQ 'A'
     C                     MOVEL@TX,1     @SCMKT
     C                     MOVE '0'       *IN02
     C                     ELSE                            X2
     C*
     C                     MOVEL@TX,2     @SCMKT
     C                     MOVE '1'       *IN02
     C                     END                             E2
     C*
     C* Initialize program. If recall flag has been set then this is a
     C* recall of a program that did not set on LR, so just reset fields,
     C* else perform full initialization.
     C*
     C           @RECAL    IFEQ 'Y'                        B2
     C                     EXSR P100
     C                     ELSE                            X2
     C                     EXSR P101
     C                     END                             E2
     C*
     C* If insert, amend, fill screen
     C*
     C           @PACTN    CASEQ'I'       P200
     C           @PACTN    CASEQ'A'       P201
     C                     END                             E2
     C                     END                             E1
     C*
     C* Display/validate screen
     C*
     C                     EXSR P202
     C*
     C* Fill command key parameter
     C*
     C                     EXSR P203
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C*******************************************************************
     C*  P100 - Initialization - not first call of program              *
     C*******************************************************************
     C*
     C           P100      BEGSR
     C*
     C* Reset fields and indicators
     C*
     C                     MOVEA'00000000'*IN,20
     C                     MOVEA'0'       *IN,31                          CAC003
     C                     MOVEA'0000'    *IN,39
     C                     MOVEA'00000000'*IN,47
     C                     MOVEA'00000000'*IN,55
     C                     MOVEA'00000000'*IN,63
     C                     MOVEA'00000000'*IN,71
     C                     MOVEA'00000000'*IN,79
     C                     MOVEA'000'     *IN,87
     C*
     C                     MOVEA*BLANKS   @EA
     C                     MOVEL*BLANKS   @SERR
     C                     MOVE *BLANKS   @SPOTR
     C                     MOVE *BLANKS   @STOTN
     C                     MOVE *BLANKS   @STPDY
     C                     MOVE *BLANKS   @SPRIC
     C                     MOVE *BLANKS   @SMRKT
     C                     MOVE *BLANKS   @SRALL
     C                     MOVE *BLANKS   @STDID
     C                     MOVE *BLANKS   @SLKRF
     C                     MOVE *BLANKS   @STDMI
     C                     MOVE *BLANKS   @SAIIP
     C                     MOVE *BLANKS   @STDNR
     C                     MOVE *BLANKS   @SACIN
     C                     MOVE *BLANKS   @SDADJ
     C                     MOVE *BLANKS   @SACTD
     C                     MOVE *BLANKS   @SDELF
     C                     MOVE *BLANKS   @SDELT
     C                     MOVE *BLANKS   @SCLTY
     C                     MOVE *BLANKS   @SDELT
     C                     MOVE *BLANKS   @SDELF
     C                     MOVE *BLANKS   @STBCC
     C                     MOVE *BLANKS   @STCCC
     C                     MOVE *BLANKS   @STCC1
     C                     MOVE *BLANKS   @STCC2
     C                     MOVE *BLANKS   @STCC3
     C                     MOVE *BLANKS   @STCC4
     C                     MOVE *BLANKS   @STCC5
     C                     MOVE *BLANKS   @STCC6
     C                     MOVE *BLANKS   @STCC7
     C                     MOVE *BLANKS   @SBCMR
     C                     MOVE *BLANKS   @SCCMR
     C                     MOVE *BLANKS   @STAXA
     C                     MOVE *BLANKS   @SACIN
     C                     MOVE *BLANKS   @SEXDV
     C                     MOVE *BLANKS   @STPDY
     C                     Z-ADD1         E
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C*******************************************************************
     C*  P101 - Initialization - first call of program                  *
     C*******************************************************************
     C*
     C           P101      BEGSR
     C*
     C* Set recall flag
     C                     MOVEL'Y'       @RECAL  1
     C*
     C* Set code for ZSEDIT
     C                     MOVEL'L'       ZECODE
     C*
     C* Access LF/SDBANKL1
     C*
     C***********          READ SDBANKL1                 01               S01486
     C*
     C                     CALL 'AOBANKR0'                                S01486
     C                     PARM *BLANKS   P@RTCD  7                       S01486
     C                     PARM '*FIRST ' P@OPTN  7                       S01486
     C           SDBANK    PARM SDBANK    DSFDY                           S01486
     C*                                                                   S01486
     C************IN01     IFEQ '1'                        - B1           S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     Z-ADD1         @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 01 *
     C                     MOVEL'SDBANKL1'@DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             - E1
     C*
     C** SET DATE FORMAT INDICATOR
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     END
     C*
     C                     MOVE BJMRDT    WWMRDT                          S01486
     C                     Z-ADDBJRDNB    WWEVCD  50
     C                     MOVE BJMRDT    SRUNA                           S01486
     C***********          MOVE BJMRDT    @SRUNA                          S01486
     C***********          MOVE @JOB      @SJOB                           S01486
     C*
     C* Access PF/SDSTRDL0
     C*
     C***********          READ SDSTRDL0                 01               S01486
     C*
     C                     CALL 'AOSTRDR0'                                S01486
     C                     PARM *BLANKS   P@RTCD  7                       S01486
     C                     PARM '*FIRST ' P@OPTN  7                       S01486
     C           SDSTRD    PARM SDSTRD    DSSDY                           S01486
     C*                                                                   S01486
     C************IN01     IFEQ '1'                        - B1           S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     Z-ADD2         @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 02 *
     C                     MOVEL'SDSTRDL0'@DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             - E1
     C                     Z-ADD1         E
     C*                                                                   CAC003
     C**  Access MIDAS Modules.                                           CAC003
     C                     CALL 'AOMMODR0'                                CAC003
     C                     PARM *BLANKS   P@RTCD                          CAC003
     C                     PARM '*FIRST'  P@OPTN                          CAC003
     C           SDMMOD    PARM SDMMOD    DSSDY                           CAC003
     C*                                                                   CAC003
     C           P@RTCD    IFNE *BLANKS                                   CAC003
     C                     Z-ADD13        @DBASE           ***************CAC003
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 13 *CAC003
     C                     MOVEL'SDMMODPD'@DBKEY           ***************CAC003
     C                     EXSR *PSSR                                     CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C** Access PCA ICD File if Analytical Accounting Module is installed CAC003
     C           BGN0ST    IFEQ 'Y'                                       CAC003
     C                     CALL 'AOPCACR0'                                CAC003
     C                     PARM *BLANKS   P@RTCD                          CAC003
     C                     PARM '*FIRST ' P@OPTN                          CAC003
     C           SDPCAC    PARM SDPCAC    DSSDY                           CAC003
     C*                                                                   CAC003
     C           P@RTCD    IFNE *BLANKS                                   CAC003
     C                     Z-ADD14        @DBASE           ***************CAC003
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 14 *CAC003
     C                     MOVEL'SDPCACPD'@DBKEY           ***************CAC003
     C                     EXSR *PSSR                                     CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C** Check if SAR CAC003 is installed                                 CAC003
     C*                                                                   CAC003
     C                     CALL 'AOSARDR0'                                CAC003
     C                     PARM *BLANKS   P@RTCD                          CAC003
     C                     PARM '*VERIFY' P@OPTN                          CAC003
     C                     PARM 'CAC003'  P@SARD  6                       CAC003
     C*                                                                   CAC003
     C** Set on *IN30 if Analytical Accounting Module and                 CAC003
     C** SAR CAC003 is installed                                          CAC003
     C           P@RTCD    IFEQ *BLANKS                                   CAC003
     C           BGN0ST    ANDEQ'Y'                                       CAC003
     C                     MOVE '1'       *IN30                           CAC003
     C                     ENDIF                                          CAC003
     C*
     C** CALCULATE BACKVALUE DATE
     C           BJRDNB    SUB  BVBVP     @WBKVP  50
     C                     Z-ADD0         ZECD    50
     C                     Z-ADD0         ZZCCD   50
      *                                                                   CAC005
      ***  Check if CAC005 - PCA-SE Enhancement is on.                    CAC005
      *                                                                   CAC005
     C                     MOVE 'N'       CAC005  1                       CAC005
     C                     MOVE *OFF      *IN45                           CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   @RTCD   7                       CAC005
     C                     PARM '*VERIFY' @OPTN   7                       CAC005
     C                     PARM 'CAC005'  @SARD   6                       CAC005
      *                                                                   CAC005
     C           @RTCD     IFEQ *BLANK                                    CAC005
     C                     MOVE 'Y'       CAC005                          CAC005
     C                     MOVE *ON       *IN45                           CAC005
     C                     ENDIF                                          CAC005
     C*                                                                   S01496
     C**  Check if Jyske Enhancements feature is on                       S01496
     C*                                                                   S01496
     C                     CALL 'AOSARDR0'                                S01496
     C                     PARM *BLANKS   P@RTCD                          S01496
     C                     PARM '*VERIFY' P@OPTN                          S01496
     C                     PARM 'S01496'  P@SARD  6                       S01496
     C*                                                                   S01496
     C           P@RTCD    IFEQ *BLANKS                                   S01496
     C                     MOVE 'Y'       S01496  1                       S01496
     C                     ELSE                                           S01496
     C                     MOVE 'N'       S01496                          S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C**  If Jyske Enhancements is installed and Charges by Customer      S01496
     C**  Group is on, then seton indicator WWCUGR                        S01496
     C*                                                                   S01496
     C           S01496    IFEQ 'Y'                                       S01496
     C           BVACOP    ANDEQ'Y'                                       S01496
     C                     MOVE '1'       WWCUGR  1                       S01496
     C                     ELSE                                           S01496
     C                     MOVE 'N'       WWCUGR                          S01496
     C                     END                                            S01496
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C*******************************************************************
     C*  P200 - Fill screen for insert                                  *
     C*******************************************************************
     C*
     C           P200      BEGSR
     C*
     C                     MOVE '0'       *IN42
     C*
     C** PERFORM STANDARD ROUTINE P204 TO SET UP STANDARD DETAILS
     C                     MOVE @PSESN    WWTDSS 10
     C                     EXSR P204
     C*
     C*    Access on LF/SDSECSL1
     C*
     C***********@PPOCU    CHAINSDSECSL1             01                   S01486
     C                     CALL 'AOSECSR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM @PPOCU    P@KEY6  6                       S01486
     C           SDSECS    PARM SDSECS    DSFDY                           S01486
     C*
     C************IN01     IFEQ '1'                        B1             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     Z-ADD3         @DBASE           ***************
     C                     MOVEL'SDSECSL1'@DBFIL           * DB ERROR 03 *
     C                     MOVEL@PPOCU    @WK6    6        ***************
     C                     EXSR *PSSR
     C                     END                             E1
     C*
     C*  Auto-settle indicator
     C*
     C                     MOVE BFASIN    @SAUTS
     C*
     C** SET UP TRADE TYPE. IF TRADE IS AN AGENCY TRADE REVERSE TRADE TYPE
     C                     MOVE @PTDTP    @STDTP
     C           @PAGTR    IFEQ 'Y'                        B1
     C*
     C           @PTDTP    IFEQ 'TP'                       B2
     C                     MOVE 'TS'      @STDTP
     C                     ELSE                            X2
     C                     MOVE 'TP'      @STDTP
     C                     END                             E2
     C*
     C                     END                             E1
     C*                                                                   S01486
     C** IF THE 'HIGH LEVEL SECURITY' FIELD ON LF/SDPORTL1                S01486
     C** IS EQUAL TO 'Y'. ACCESS LF/MUSER WITH THE USER PROFILE           S01486
     C** TO OBTAIN THE ACCOUNT OFFICER OR DEPARTMENT ASSIGNED             S01486
     C** TO THAT PROFILE.                                                 S01486
     C*                                                                   S01486
     C                     CALL 'AOPORTR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*FIRST'  P@OPTN                          S01486
     C           SDPORT    PARM SDPORT    DSFDY                           S01486
     C*                                                                   S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     Z-ADD12        @DBASE           ***************S01486
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 12 *S01486
     C                     MOVEL'SDBANKL1'@DBKEY           ***************S01486
     C                     EXSR *PSSR                                     S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C           FCHLVS    IFEQ 'Y'                                       S01486
     C*                                                                   S01486
     C** GET USER DEPARTMENT AND ACCOUNT OFFICER                          S01486
     C           *NAMVAR   DEFN ZMUSER    WUSER                           S01486
     C                     IN   WUSER                                     S01486
     C                     CALL 'AOUSERR0'                                S01486
     C                     PARM           WUAPRC  7        B:Return Cde   S01486
     C                     PARM '*KEY'    UUAPOP  7        I:Option       S01486
     C                     PARM WWNAME    UUUSID 10        I:User ProfiancS01486
     C           D@USER    PARM D@USER    DSSDY            O:MUSER fmt    S01486
     C*                                                                   S01486
     C** IF ACCOUNT OFFICER CODE NOT BLANK                                S01486
     C** TEST IF ACCOUNT OFFICER CODE NOT EQUAL *ALL                      S01486
     C** AND NOT EQUAL TO CUSTOMER ACCOUNT OFFICER                        S01486
     C*                                                                   S01486
     C                     MOVE *OFF      *IN36                           S01486
     C***********ACOF      IFNE *BLANKS                             S01486087588
     C           ACFA      IFNE *BLANKS                                   087588
     C*                                                                   S01486
     C***********ACOF      IFNE 'ALL'                               S01486087588
     C***********ACOF      ANDNEBBACOC                              S01486087588
     C           ACFA      IFNE 'ALL'                                     087588
     C           ACFA      ANDNEBBACOC                                    087588
     C                     MOVE *ON       *IN36                           S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** IF ACCOUNT OFFICER CODE BLANK                                    S01486
     C** ACCESS SDACOFL1 TO OBTAIN DEPARTMENT OF ACCOUNT                  S01486
     C** OFFICER ASSIGNED TO CUSTOMER                                     S01486
     C*                                                                   S01486
     C                     ELSE                                           S01486
     C*                                                                   S01486
     C                     CALL 'AOACOFR0'                                S01486
     C                     PARM '*MSG   ' P@RTCD                          S01486
     C                     PARM '*KEY   ' P@OPTN                          S01486
     C                     PARM BBACOC    P@KEY2  2                       S01486
     C           SDACOF    PARM SDACOF    DSFDY                           S01486
     C*                                                                   S01486
     C           AZDPCD    IFNE DPPT                                      S01486
     C                     MOVE *ON       *IN36                           S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C** IF ERROR SKIP OTHER SETTINGS                                     S01486
     C           *IN36     IFEQ *ON                                       S01486
     C                     GOTO FIN200                                    S01486
     C                     ENDIF                                          S01486
     C*
     C*  Settlement currency
     C*
     C***...**Access*on*PF/PMPORTPP***************************************S01486
     C*  ...  Access on PF/PMPORTPD                                       S01486
     C*
     C                     MOVE @PPOCU    PPPOCU
     C                     MOVE @PPOFO    PPPOFO
     C*
     C***********@KEY2     CHAINPMPORTPP             01                   S01486
     C           @KEY2     CHAINPMPORTPD             01                   S01486
     C*
     C           *IN01     IFEQ '1'                        B1
     C           PNRECI    OREQ '*'
     C                     Z-ADD4         @DBASE           ***************
     C***********          MOVEL'PMPORTPP'@DBFIL           * DB ERROR 04 *S01486
     C                     MOVEL'PMPORTPD'@DBFIL           *             *S01486
     C                     MOVEL@DS2      @DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             E1
     C*
     C                     MOVE PNPTCY    @SSETC
     C*
     C** CALCULATE FX CROSS RATE FROM NOMINAL TO SETTLEMENT CURRENCY
     C                     MOVE NMCYA     ZCCYF
     C                     Z-ADDWWNMSP    ZRATEF
     C                     Z-ADDWWNMDP    ZCDPF
     C                     MOVE WWNMMD    ZMDINF
     C*
     C** Access on file LF/SDCURRL0 with portfolio currency
     C***********PNPTCY    CHAINSDCURRL0             01                   S01486
     C*
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM PNPTCY    P@KEY3  3                       S01486
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C*                                                                   S01486
     C************IN01     IFEQ '1'                        B1             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     Z-ADD6         @DBASE           ***************
     C                     MOVEL'SDCURRL0'@DBFIL           * DB ERROR 06 *
     C                     MOVELPNPTCY    @DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             E1
     C*
     C                     MOVE PNPTCY    ZCCYT
     C                     Z-ADDA6SPRT    ZRATET
     C                     Z-ADDA6NBDP    ZCDPT
     C                     MOVE A6MDIN    ZMDINT
     C                     Z-ADD1         ZAMTF
     C*
     C** CALCULATE CROSS RATE VIA SR/ZCCYCN
     C                     EXSR ZCCYCN
     C*
     C** FORMAT RATE FOR OUTPUT
     C                     Z-ADD0         ZFLD15
     C                     MOVE ZCRSRT    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SRATE
     C*
     C                     MOVE ZCRSMD    @SSMDI
     C*                                                                   CAC003
     C** Initialize margin points                                         CAC003
     C                     MOVE *BLANKS   @SSPTS                          CAC003
     C*
     C** FORMAT BASE CURRENCY RATE FOR OUTPUT
     C                     Z-ADD0         ZFLD15
     C                     MOVE ZRATEF    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SBRTE
     C*
     C* ...check for
     C*    and access on file LF/SDSECSL1
     C*
     C           @PAGTR    IFEQ 'Y'                        B1
     C           @SINCS    ANDEQ'C'
     C           @PDELF    ANDNE*BLANKS
     C*
     C           MKTI      IFEQ 'P'                        B2
     C           MKTI      OREQ 'S'
     C*
     C***********@PDELF    CHAINSDSECSL1             01                   S01486
     C                     CALL 'AOSECSR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM @PDELF    P@KEY6  6                       S01486
     C           SDSECS    PARM SDSECS    DSFDY                           S01486
     C*
     C************IN01     IFEQ '1'                        B3             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     Z-ADD7         @DBASE           ***************
     C                     MOVEL'SDSECSL1'@DBFIL           * DB ERROR 07 *
     C                     MOVEL@PDELF    @DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             E3
     C*
     C* ...check for 'classification'
     C*
     C           BFCLAS    IFEQ 'E'                        B3
     C                     MOVE '1'       @SCLTY
     C                     END                             E3
     C*
     C           BFCLAS    IFEQ 'C'                        B3
     C                     MOVE '3'       @SCLTY
     C                     END                             E3
     C*
     C           BFCLAS    IFNE 'E'                        B3
     C           BFCLAS    ANDNE'C'
     C                     MOVE '5'       @SCLTY
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** IF DEFAULTS PASSED SET VALUE DATE TO DEFAULT VALUE
     C           @PDFPA    IFEQ 'Y'                        B1
     C                     MOVE @PTDVD    @STDVD
     C*
     C                     ELSE                            X1
     C*
     C** ....OTHERWISE CALCULATE DEFAULT VALUE DATE
     C                     MOVELVDFT      WWVDFT  20
     C                     MOVE VDFT      WWY     1
     C*
     C** IF VALUE DATE DEFAULT IS A NUMBER OF WORKING DAYS FORWARD
     C** PERFROM SR/ZDATE3
     C                     Z-ADDBJRDNB    WWTDVD
     C           WWY       IFEQ 'W'                        B2
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     Z-ADDWWVDFT    ZNRDYS
     C                     MOVE NMCYA     ZCCY
     C***********          EXSR ZDATE3                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZFWDT                                     S01486
     C                     Z-ADDZDYNBR    WWTDVD
     C                     END                             E2
     C*
     C** ...OTHERWISE IF AN ACTUAL NUMBER OF DAYS EXISTS ON FILE ADD
     C** THIS NUMBER OF DAYS TO THE RUN DATE
     C           WWY       IFEQ 'A'                        B2
     C           BJRDNB    ADD  WWVDFT    WWTDVD
     C                     END                             E2
     C*
     C** FOR PARTLY PAID SECURITY SET DEFAULT VALUE DATE TO LAST CALL DATE
     C           PPDI      IFEQ 'Y'                        B2
     C           WWTDVD    ANDLESLCA
     C                     Z-ADDSLCA      WWTDVD
     C                     END                             E2
     C*
     C** USING VALUE DATE CALCULATED ABOVE DETERMINE NEXT WORKING DAY
     C** IN CLEARANCE CURRENCY
     C           @PCLTY    IFEQ '1'                        B2
     C           @PCLTY    OREQ '2'
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     MOVE BVEUCY    ZCCY
     C***********          MOVE 'Y'       ZOPT                            S01486
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     Z-ADDZDAYNO    ZDYNBR                          S01486
     C                     ELSE                                           S01486
     C                     Z-ADD1         ZNRDYS                          S01486
     C                     EXSR ZFWDT                                     S01486
     C                     ENDIF                                          S01486
     C                     Z-ADDZDYNBR    WWTDVD
     C                     END                             E2
     C*
     C           @PCLTY    IFEQ '3'                        B2
     C           @PCLTY    OREQ '4'
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     MOVE BVCCCY    ZCCY                            S01486
     C***********          MOVE BVCYCD    ZCCY                            S01486
     C***********          MOVE 'Y'       ZOPT                            S01486
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     Z-ADDZDAYNO    ZDYNBR                          S01486
     C                     ELSE                                           S01486
     C                     Z-ADD1         ZNRDYS                          S01486
     C                     EXSR ZFWDT                                     S01486
     C                     ENDIF                                          S01486
     C                     Z-ADDZDYNBR    WWTDVD
     C                     END                             E2
     C*
     C           @PCLTY    IFEQ '2'                        B2
     C           @PCLTY    OREQ '4'
     C           @PCLTY    OREQ '5'
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     MOVE @SSETC    ZCCY
     C***********          MOVE 'Y'       ZOPT                            S01486
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     Z-ADDZDAYNO    ZDYNBR                          S01486
     C                     ELSE                                           S01486
     C                     Z-ADD1         ZNRDYS                          S01486
     C                     EXSR ZFWDT                                     S01486
     C                     ENDIF                                          S01486
     C                     Z-ADDZDYNBR    WWTDVD
     C                     END                             E2
     C*
     C* ...value currency from SECTY
     C*
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     MOVE VLCY      ZCCY
     C***********          MOVE 'Y'       ZOPT                            S01486
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     Z-ADDZDAYNO    ZDYNBR                          S01486
     C                     ELSE                                           S01486
     C                     Z-ADD1         ZNRDYS                          S01486
     C                     EXSR ZFWDT                                     S01486
     C                     ENDIF                                          S01486
     C                     Z-ADDZDYNBR    WWTDVD
     C*
     C** IF VALUE DATE *LT ISSUE DATE SET THE VALUE DATE TO ISSUE DATE
     C           WWTDVD    IFLT ISSD                       B2
     C                     Z-ADDISSD      WWTDVD
     C                     END                             E2
     C*
     C** ...is value date superior to maturity date ?
     C           MATY      IFGT 0                          B2
     C           WWTDVD    ANDGTMATY
     C                     Z-ADDMATY      WWTDVD
     C                     END                             E2
     C*
     C** FORMAT VALUE DATE FOR OUTPUT ON SCREEN
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     @STDVD
     C*
     C                     END                             E1
     C*
     C** CONVERT VALUE DATE INTO MIDAS DAY NUMBER FOR USE LATER
     C                     MOVE @STDVD    ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    WWTDVD
     C*
     C                     MOVE @STDVD    W1TDVD  6
     C*
     C** CALCULATE DEFAULT TRADE DATE
     C           @PDFPA    IFEQ 'Y'                        B1
     C                     MOVE @PTDDT    @STDDT
     C                     ELSE                            X1
     C*
     C                     Z-ADDBJRDNB    ZDAYNO
     C           WWTDVD    IFLT BJRDNB                     B2
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     END                             E2
     C*
     C** FORMAT TRADE DATE FOR OUTPUT
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     @STDDT
     C                     END                             E1
     C                     MOVE @STDDT    W1TDDT  6
     C*
     C** CALCULATE DEFAULT INTEREST DETAILS FOR CERTAIN SECURITIES
     C                     MOVE *BLANKS   @SACIN
     C                     MOVE *BLANKS   @SDADJ
     C                     MOVE *BLANKS   @SACTD
     C*
     C           *IN04     IFEQ '1'                        B1
     C*
     C** SET UP DEFAULT ACCRUED INTEREST INDICATOR
     C           @PDFPA    IFEQ 'Y'                        B2
     C                     MOVE @PACIN    @SACIN
     C                     ELSE                            X2
     C*
     C** CALCULATE COUPON DATE AS PER SR/ZNCD
     C                     Z-ADDWWEVCD    ECD
     C                     EXSR ZNCD
     C*
     C** CALCULATE THE EX-DATE BASED ON THE NEXT COUPON DATE
     C                     Z-ADDNCD       WWEXDT
     C                     MOVE EDFT      WWL     1
     C                     MOVELEDFT      WWNBR   20
     C*
     C           WWL       IFEQ 'A'                        B3
     C           NCD       SUB  WWNBR     WWEXDT  50
     C                     END                             E3
     C*
     C           WWL       IFEQ 'W'                        B3
     C                     Z-ADDNCD       ZDAYNO
     C                     MOVE VLCY      ZCCY
     C                     Z-ADDWWNBR     ZNRDYS
     C***********          EXSR XDAT3A                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZBKDT                                     S01486
     C                     Z-ADDZDYNBR    WWEXDT
     C                     END                             E3
     C*
     C** SET UP ACCRUED INDICATOR
     C                     MOVE 'C'       @SACIN
     C*
     C** SET ACCRUED INDICATOR TO 'F' IF VALUE DATE *EQ NEXT COUPON DATE
     C           WWTDVD    IFEQ NCD                        B3
     C                     MOVE 'F'       @SACIN
     C                     END                             E3
     C*
     C** SET TO 'X' IF EX DATE <= VALUE DATE < NEXT COUPON DATE
     C           WWEXDT    IFLE WWTDVD                     B3
     C           WWTDVD    ANDLTNCD
     C                     MOVE 'X'       @SACIN
     C                     END                             E3
     C*
     C** IF PROCESSING TYPE '6' (IE SCHULDSCHEIN)  SET INDICATOR TO 'F'
     C           PROT      IFEQ '6'                        B3
     C                     MOVE 'F'       @SACIN
     C                     END                             E3
     C*
     C                     END                             E2
     C*
     C** DETERMINE DAYS ADJUSTMENT
     C           @PDFPA    IFEQ 'Y'                        B2
     C                     MOVE @PDADJ    @SDADJ
     C                     MOVE @PACTD    @SACTD
     C                     ELSE                            X2
     C*
     C** .... OTHERWISE CALCULATE DEFAULT DAYS ADJUSTMENT & SIGN
     C           IADJ      IFNE 0                          B3
     C                     Z-ADD0         ZFLD15
     C                     MOVE IADJ      ZFLD15
     C                     Z-ADD0         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @SDADJ
     C*
     C                     MOVE 'D'       @SACTD
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C                     MOVE @SACIN    W1ACIN  1
     C*
     C* Deliver from
     C*
     C* ...check for 'default passed'
     C*
     C           @PDFPA    IFEQ 'Y'                        B1
     C*********************MOVE @PDELF    @SDELF
     C                     MOVEL@PDELF    @SDELF
     C                     ELSE                            X1
     C                     MOVE *BLANKS   @SDELF
     C                     END                             E1
     C*
     C* Deliver to
     C*
     C* ...check for 'default passed'
     C*
     C           @PDFPA    IFEQ 'Y'                        B1
     C*********************MOVE @PDELT    @SDELT
     C                     MOVEL@PDELT    @SDELT
     C                     ELSE                            X1
     C                     MOVE *BLANKS   @SDELT
     C                     END                             E1
     C*
     C* Clearance type
     C*
     C** OBTAIN DEFAULT CHARGES AND COMMISSIONS FROM LF/CUBRD
     C                     MOVE 'D'       @KC1D1
     C                     MOVE SITP      @KSITP
     C                     MOVE DMKT      @KMRKT
     C                     MOVE @PPOCU    @KCNUM
     C*                                                                   S01496
     C           S01496    IFEQ 'Y'                                       S01496
     C*                                                                   S01496
     C**  If charges by customer group is on                              S01496
     C           WWCUGR    IFEQ '1'                                       S01496
     C                     MOVELBFTDCG    @KCLGR                          S01496
     C                     ELSE                                           S01496
     C                     MOVEL*BLANKS   @KCLGR                          S01496
     C                     MOVEL'D '      @KCLGR                          S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C           S01496    IFNE 'Y'                        B0             S01496
     C*
     C           @KEY9     CHAINCUBRD                01
     C*
     C** IF NO DEFAULT CHARGES OR COMMISSIONS FOUND FOR POOL CUSTOMER
     C** SET POOL CUSTOMER TO BLANK AND TRY AGAIN
     C           *IN01     IFEQ '1'                        B1
     C           RECI      OREQ '*'
     C**********           MOVE *ZEROS    @KCNUM                                              CSD027
     C                     MOVE *BLANKS   @KCNUM                                              CSD027
     C           @KEY9     CHAINCUBRD                01
     C*
     C** IF NO DEFAULT CHARGES OR COMMISSIONS FOUND SET MARKET BLANK
     C** AND TRY AGAIN
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     MOVE *BLANKS   @KMRKT
     C           @KEY9     CHAINCUBRD                01
     C*
     C** IF NO DEFAULT CHARGES OR COMMISSIONS FOUND SET INVESTMENT TYPE
     C** BLANK AND TRY AGAIN
     C           *IN01     IFEQ '1'                        B3
     C           RECI      OREQ '*'
     C                     MOVE *BLANKS   @KSITP
     C           @KEY9     CHAINCUBRD                01
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*                                                                   S01496
     C**  Else, if Jyske Enhancements is on use customer group as key     S01496
     C                     ELSE                            X0             S01496
     C                     OPEN SECUBRL0                                  S01496
     C*                                                                   S01496
     C           @KEY9A    CHAINSECUBRL0             44                   S01496
     C*                                                                   S01496
     C           *IN44     IFEQ '1'                        B1             S01496
     C           RECI      ORNE 'D'                                       S01496
     C*                                                                   S01496
     C**  Record not found on LF/SECUBRL0, chain to LF/SECUBRL0           S01496
     C**  again with only first three priorities.                         S01496
     C                     MOVELBVPCSD    PCSD    10                      S01496
     C                     MOVELBVPIDF    PIDF    10                      S01496
     C                     MOVELBVPMDF    PMDF    10                      S01496
     C                     MOVELBVPOCD    POCD    10                      S01496
     C*                                                                   S01496
     C                     EXSR SUB4A                                     S01496
     C           @KEY9A    CHAINSECUBRL0             44                   S01496
     C           *IN44     IFEQ '1'                        B2             S01496
     C           RECI      ORNE 'D'                                       S01496
     C*                                                                   S01496
     C**  If record not found, chain to LF/SECUBRL0 again with            S01496
     C**  only the first two priorities.                                  S01496
     C*                                                                   S01496
     C                     EXSR SUB4A                                     S01496
     C           @KEY9A    CHAINSECUBRL0             44                   S01496
     C           *IN44     IFEQ '1'                        B3             S01496
     C           RECI      ORNE 'D'                                       S01496
     C*                                                                   S01496
     C**  If record not found, chain to LF/SECUBRL0 again with            S01496
     C**  only first priority                                             S01496
     C*                                                                   S01496
     C                     EXSR SUB4A                                     S01496
     C           @KEY9A    CHAINSECUBRL0             44                   S01496
     C           *IN44     IFEQ '1'                        B4             S01496
     C           RECI      ORNE 'D'                                       S01496
     C                     END                             E4             S01496
     C*                                                                   S01496
     C                     END                             E3             S01496
     C                     END                             E2             S01496
     C                     END                             E1             S01496
     C*                                                                   S01496
     C                     CLOSESECUBRL0                                  S01496
     C*                                                                   S01496
     C**  End of if S01496 not equal to 'Y'                               S01496
     C                     END                             E0             S01496
     C*
     C** SET SCREEN FIELDS TP BLANK
     C                     MOVE *BLANKS   @STBCC
     C                     MOVE *BLANKS   @STCCC
     C                     MOVE *BLANKS   @STCC1
     C                     MOVE *BLANKS   @STCC2
     C                     MOVE *BLANKS   @SBCMR
     C*
     C** IF DEFAULT CHARGES FOUND FORMAT SCREEN FIELDS FOR OUTPUT
     C           *IN01     IFEQ '0'                        B1
     C           RECI      ANDEQ'D'
     C                     MOVE TBCC      @STBCC
     C                     MOVE TCCC      @STCCC
     C                     MOVE DCC1      @STCC1
     C                     MOVE DCC2      @STCC2
     C*
     C           CMRP      IFNE 0                          B2
     C                     Z-ADD0         ZFLD15
     C                     MOVE CMRP      ZFLD15
     C                     Z-ADD3         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SBCMR
     C                     END                             E2
     C                     END                             E1
     C*
     C* Price & ex dividend
     C*
     C           PROT      IFEQ '4'                        B1
     C           PROT      OREQ '7'
     C*
     C** CONVERT TRADE DATE FROM DAY NUMBER TO DATE FORMAT
     C                     MOVE @STDDT    ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    WWTDDT  50
     C*
     C** PERFORM SR/P300 TO CALCULATE EX-DIVIDEND INDICATOR
     C                     EXSR SUB300
     C                     MOVE @WEXDV    @SEXDV
     C*
     C                     END                             E1
     C*
     C** CALCULATE THE SECURITY PRICE FROM THE PRICE/DISCOUNT/YIELD
     C** DETAILS PASSED FROM CALLING PROGRAM
     C                     MOVE *BLANKS   @SPRIC
     C           *IN47     IFEQ '1'                        B1
     C           @PTPDY    ANDNE*BLANKS
     C*
     C** CONVERT DISCOUNT/YIELD PASSED INTO NUMERIC FIELD
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE @PTPDY    ZFIELD
     C                     Z-ADD7         ZADIG
     C                     Z-ADD8         ZADEC
     C                     EXSR ZALIGN
     C*
     C** PERFORM SR/ZPRCI TO CONVERT DISCOUNT/YIELD TO PRICE
     C                     MOVE ZFIELD    WWTPDY 158
     C                     MOVE ZFIELD    ZPRCIN
     C                     Z-ADDWWTDVD    ZFDATE
     C                     EXSR ZPRCI
     C                     Z-ADD8         ZDECS
     C*
     C** EDIT PRICE CALCULATED FOR OUTPUT
     C                     Z-ADD0         ZFLD15
     C                     MOVE ZPRCOT    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @SPRIC
     C                     END                             E1
     C                     MOVE @SPRIC    W1PRIC 16
     C*
     C** FOR AGENCY TRADE SET DEFAULT TO '3' OR '6'
     C           @PAGTR    IFEQ 'Y'                        B1
     C*
     C           @STDTP    IFEQ 'TS'                       B2
     C                     MOVE 3         @SCPCY
     C                     ELSE                            X2
     C                     MOVE 6         @SCPCY
     C                     END                             E2
     C*
     C                     ELSE                            X1
     C*
     C** ...OTHERWISE FOR NON-AGENCY TRADE SET TO '5' OR '2'
     C           @STDTP    IFEQ 'TS'                       B2
     C                     MOVE 2         @SCPCY
     C                     ELSE                            X2
     C                     MOVE 5         @SCPCY
     C                     END                             E2
     C*
     C                     END                             E1
     C*
     C** MOVE PARAMETERS PASSED FROM SE3000 TO SCREEN FIELDS
     C                     MOVE MKTI      @STDMI
     C***********          MOVE BVDPDS    @STSUB                          S01486
     C                     MOVE BVDPFS    @STSUB                          S01486
     C                     MOVE DMKT      @SMRKT
     C                     MOVE 'Y'       @SAIIP
     C                     MOVE @PTPDY    @STPDY
     C*
     C** SET UP DEFAULT TOTAL NOMINAL FOR AGENCY TRADE
     C           @PAGTR    IFEQ 'Y'                        B1
     C           @STDTP    IFEQ 'TS'                       B2
     C                     MOVE @PMANO    @STOTN
     C                     ELSE                            X2
     C                     MOVE @PPONO    @STOTN
     C                     END                             E2
     C*
     C** SET UP DEFAULT TOTAL NOMINAL FOR NON AGENCY TRADE
     C                     ELSE                            X1
     C           @STDTP    IFEQ 'TS'                       B2
     C                     MOVE @PBONO    @STOTN
     C                     ELSE                            X2
     C                     MOVE @PPONO    @STOTN
     C                     END                             E2
     C*
     C                     END                             E1
     C*
     C           FIN200    TAG                                            S01486
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C*******************************************************************
     C*  P201 - Fill screen for amend                                   *
     C*******************************************************************
     C*
     C           P201      BEGSR
     C*
     C                     MOVE '1'       *IN42
     C*
     C* Move of parameters in working fields
     C*
     C                     MOVEL@PBLKR    WPBLKR  6
     C**********           MOVEL@PPOCU    WPPOCU  60                                          CSD027
     C                     MOVEL@PPOCU    WPPOCU  6                                           CSD027
     C                     MOVEL@PPOFO    WPPOFO  4
     C*
     C* OBTAIN TRADE DETAILS FROM LF/PMPLTRPD                          )
     C           @KEY3     CHAINPMPLTRPD             01
     C                     UPDATPMPLTRP0
     C*
     C** PERFORM STANDARD ROUTINE P204 TO SET UP STANDARD DETAILS
     C                     MOVE OUTDSS    WWTDSS 10
     C                     EXSR P204
     C*
     C                     MOVELOUTINC    @SINCS
     C*
     C                     MOVELOUCLRH    @SCLRH
     C*
     C                     MOVELOUTDTP    @STDTP
     C*
     C                     Z-ADDNMDP      ZDECS
     C                     Z-ADD0         ZFLD15
     C                     MOVE OUTNOM    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @STOTN
     C*
     C** EDIT MARKET NOMINAL FOR AGENCY TRADE
     C                     Z-ADDNMDP      ZDECS
     C                     Z-ADD0         ZFLD15
     C                     MOVE OUMTNO    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SPOOL
     C*
     C* ...Obtain Price/discount/yield after executing ZSEDIT
     C*
     C                     Z-ADDOUTPDY    WWTPDY
     C                     Z-ADD8         ZDECS
     C                     Z-ADD0         ZFLD15
     C                     MOVE OUTPDY    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @STPDY
     C*
     C* ...Obtain Price after executing ZSEDIT or Ex-dividend
     C*
     C                     MOVE *BLANKS   @SPRIC
     C           OUPRIC    IFNE *ZEROS                     B1
     C                     Z-ADD8         ZDECS
     C                     Z-ADD0         ZFLD15
     C                     MOVE OUPRIC    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SPRIC
     C                     END                             E1
     C                     MOVE @SPRIC    W1PRIC 16
     C*
     C* ...Obtain Value date
     C*
     C           OUTDVD    IFNE *ZEROS                     B1
     C                     MOVE OUTDVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     @STDVD
     C                     END                             E1
     C                     MOVE @STDVD    W1TDVD
     C*
     C* ...Obtain Trade date
     C*
     C           OUTDDT    IFNE *ZEROS                     B1
     C                     MOVE OUTDDT    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     @STDDT
     C                     END                             E1
     C                     MOVE @STDDT    W1TDDT
     C*
     C* ... Obtain rellowance
     C*
     C                     MOVE *BLANKS   @SRALL
     C           OURALL    IFNE 0
     C                     Z-ADD0         ZFLD15
     C                     MOVE OURALL    ZFLD15
     C                     Z-ADD5         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @SRALL
     C                     END
     C*
     C* ... Obtain days adjustment
     C*
     C                     MOVE *BLANKS   @SDADJ
     C           OUDADJ    IFNE 0
     C                     Z-ADD0         ZFLD15
     C                     MOVE OUDADJ    ZFLD15
     C                     Z-ADD0         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @SDADJ
     C                     END
     C*
     C* ... Obtain base currency rate
     C*
     C                     Z-ADD0         ZFLD15
     C                     MOVE OUTBCR    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SBRTE
     C*
     C** Obtain The Exchange Rate                                         CAC003
     C*                                                                   CAC003
     C                     Z-ADD0         ZFLD15
     C*                                                                   CAC003
     C           *IN30     IFEQ '0'                                       CAC003
     C           OUSETC    OREQ NMCYA                                     CAC003
     C                     MOVE OUTDER    ZFLD15
     C                     ELSE                                           CAC003
     C           OUTDTP    IFEQ 'TP'                                      CAC003
     C           OUTMDI    ANDEQ'M'                                       CAC003
     C           OUTDTP    OREQ 'TS'                                      CAC003
     C           OUTMDI    ANDEQ'D'                                       CAC003
     C           OUTDER    ADD  OUFXMR    WATDER 138                      CAC003
     C                     ELSE                                           CAC003
     C           OUTDER    SUB  OUFXMR    WATDER                          CAC003
     C                     ENDIF                                          CAC003
     C                     MOVE WATDER    ZFLD15                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SRATE
     C*                                                                   CAC003
     C           *IN30     IFEQ '1'                                       CAC003
     C           OUSETC    ANDNENMCYA                                     CAC003
     C                     Z-ADD0         ZFLD15                          CAC003
     C                     MOVE OUFXMP    ZFLD15                          CAC003
     C                     Z-ADD2         ZDECS                           CAC003
     C                     EXSR ZSEDIT                                    CAC003
     C                     MOVE ZOUT20    @SSPTS                          CAC003
     C                     ELSE                                           CAC003
     C                     MOVE *BLANKS   @SSPTS                          CAC003
     C                     ENDIF                                          CAC003
     C*
     C* ...Obtain all others fields
     C*
     C                     MOVELOUDELF    @SDELF
     C                     MOVELOUDELT    @SDELT
     C                     MOVE OUTBCC    @STBCC
     C                     MOVE OUTCCC    @STCCC
     C                     MOVE OUTCC1    @STCC1
     C                     MOVE OUTCC2    @STCC2
     C                     MOVE OUTCC3    @STCC3
     C                     MOVE OUTCC4    @STCC4
     C                     MOVE OUTCC5    @STCC5
     C                     MOVE OUTCC6    @STCC6
     C                     MOVE OUTCC7    @STCC7
     C                     MOVE OUTINC    @SINCS
     C                     MOVE OUTCAP    @SCPCY
     C                     MOVE OUTMKC    @SMRKT
     C                     MOVE OUTDID    @STDID
     C                     MOVE OUTSUB    @STSUB
     C                     MOVE OULKRF    @SLKRF
     C                     MOVE OUTDMI    @STDMI
     C                     MOVE OUTMDI    @SSMDI
     C                     MOVE OUAIIP    @SAIIP
     C                     MOVE OUTDNR    @STDNR
     C                     MOVE OUACIN    @SACIN
     C                     MOVE OUADIN    @SACTD
     C                     MOVE OUSETC    @SSETC
     C                     MOVE OUCLTY    @SCLTY
     C                     MOVE OUAUTS    @SAUTS
     C                     MOVE OUEXDV    @SEXDV
     C                     MOVE OUCLRH    @SCLRH
     C                     MOVE @SACIN    W1ACIN  1
     C*
     C*
     C* ...Obtain Broker commission rebate
     C*
     C                     MOVE *BLANKS   @SBCMR
     C           OUBCMR    IFNE 0
     C                     Z-ADD3         ZDECS
     C                     Z-ADD0         ZFLD15
     C                     MOVE OUBCMR    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SBCMR
     C                     END
     C*
     C* ...Obtain Customer commission rebate
     C*
     C                     MOVE *BLANKS   @SCCMR
     C           OUCCMR    IFNE 0
     C                     Z-ADD3         ZDECS
     C                     Z-ADD0         ZFLD15
     C                     MOVE OUCCMR    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SCCMR
     C                     END
     C*
     C* ...Obtain Tax rebate
     C*
     C                     MOVE *BLANKS   @STAXA
     C           OUTXRB    IFNE 0
     C                     Z-ADD3         ZDECS
     C                     Z-ADD0         ZFLD15
     C                     MOVE OUTXRB    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @STAXA
     C                     END
     C*
     C                     ENDSR                           SUB102 ends
     C*
     C********************************************************************
      /EJECT
     C*******************************************************************
     C*  P202 - Display/validate screen                                 *
     C*******************************************************************
     C*
     C           P202      BEGSR
     C*
     C                     MOVE *IN41     WWIN41  1
     C                     MOVE *IN42     WWIN42  1
     C*
     C* Do until F3,F9,F12 or screen has been confirmed '              )
     C*
     C           *INKC     DOUEQ'1'                        B1
     C           *INKI     OREQ '1'
     C           *INKL     OREQ '1'
     C           @SPOTR    OREQ 'Y'
     C           *IN36     OREQ *ON                                       S01486
     C*
     C           *IN36     IFEQ *ON                                       S01486
     C                     MOVE *ON       *IN89                           S01486
     C                     MOVEA@TX,3     @SERR                           S01486
     C                     ELSE                                           S01486
     C                     MOVEA@EA,1     @SERR
     C                     ENDIF                                          S01486
     C                     MOVE 'N'       @SPOTR
     C*
     C                     WRITEPM5100F1
     C                     READ PM5100F1                 13
     C*
     C** VALIDATE SCREEN DETAILS ENTERED
     C           *INKC     IFEQ '0'                        B2
     C           *INKI     ANDEQ'0'
     C           *INKL     ANDEQ'0'
     C           *IN36     ANDEQ*OFF                                      S01486
     C*
     C** RESET ALL ERROR INDICATORS
     C                     MOVEA'00000000'*IN,20
     C                     MOVEA'0'       *IN,31                          CAC003
     C                     MOVEA'0'       *IN,46
     C                     MOVEA'000000'  *IN,49
     C                     MOVEA'00000000'*IN,55
     C                     MOVEA'00000000'*IN,63
     C                     MOVEA'00000000'*IN,71
     C                     MOVEA'00000000'*IN,79
     C                     MOVEA'000'     *IN,87
     C                     MOVE *BLANKS   @SERR
     C                     MOVEA*BLANKS   @EA
     C                     Z-ADD1         E
     C*
     C                     EXSR V001
     C*
     C** CHECK WHETHER ALL DETAILS ENTERED CORRECT OR IF ONLY WARNING
     C** ERRORS EXIST
     C                     MOVE 'Y'       WWVALD
     C           E         SUB  1         E
     C           *IN89     IFEQ '1'                        B3
     C*
     C           1         DO   E         J       30       B4
     C                     MOVEL@EA,J     WWORK2  2
     C                     MOVE WWORK2    WWORK1  1
     C*
     C** IF ERROR NOT WARNING ERROR SET VALID FLAG OFF
     C           WWORK1    IFNE 'W'                        B5
     C                     MOVE 'N'       WWVALD
     C                     END                             E5
     C*
     C                     END                             E4
     C*
     C                     END                             E3
     C*
     C** IF NO ERROR PROMPT USER TO CONFIRM DETAILS
     C           WWVALD    IFEQ 'Y'                        B3
     C                     MOVE '1'       *IN41
     C                     MOVE '1'       *IN42
     C                     MOVEA'00000000'*IN,20
     C*
     C                     MOVEA@EA,1     @SERR
     C                     MOVE 'N'       @SPOTR
     C*
     C                     WRITEPM5100F1
     C                     READ PM5100F1                 13
     C*
     C** IF USER TAKES CONFIRM 'YES' PERFORM FILE UPDATING
     C           @SPOTR    IFEQ 'Y'                        B4
     C           *INKC     ANDEQ'0'
     C           *INKI     ANDEQ'0'
     C           *INKL     ANDEQ'0'
     C*
     C                     EXSR P500
     C*
     C** COMMIT FILE UPDATES
     C                     COMIT
     C*
     C* SUBMIT BATCH JOB TO DO FILE UPDATING FOR A COMPLETE TRADE
     C           @SINCS    IFEQ 'C'                        B5
      *
      * Send MIDAS message to MSTATUS
     C                     MOVEL*BLANKS   @CMD
     C***********          MOVEL@TX,6     @CMD                            091221
     C                     MOVEL@TX,7     @CMD                            091221
     C                     CALL 'QCMDEXC'              01
     C                     PARM           @CMD
     C***********          PARM 160       @CMLEN 155                      091221
     C                     PARM 175       @CMLEN 155                      091221
      *
     C           *IN01     IFEQ '1'                        B6
     C                     Z-ADD8         @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 08 *
     C                     MOVEL'QCMDEXC' @DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             E6
     C*
     C** SUBMIT JOB TO GENERATE POOL TRADE DETAILS
     C                     MOVEL@TX,4     @CMD
     C***********          MOVE @TX,5     @CMD                            091221
     C                     MOVEL@TX,5     @CMD1                           091221
     C                     MOVEL@TX,6     @CMD2                           091221
     C                     MOVEL@SBLKR    @CBREF
     C                     MOVEL@SACTN    @CACTN
     C                     MOVEL@USR      @CMWI
     C                     MOVEL@SBLKR    @CMBR
     C*
     C* Use QCMDEXC to submit job
     C*
     C                     CALL 'QCMDEXC'              01
     C                     PARM           @CMD
     C***********          PARM 160       @CMLEN 155                      091221
     C**********           PARM 175       @CMLEN 155                                   091221 CSC023
     C                     PARM 240       @CMLEN 155                                          CSC023
     C*
     C           *IN01     IFEQ '1'                        B6
     C                     Z-ADD8         @DBASE           ***************
     C                     MOVEL*BLANKS   @DBFIL           * DB ERROR 08 *
     C                     MOVEL'QCMDEXC' @DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             E6
     C*
     C                     END                             E5
     C*
     C                     ELSE                            X4
     C                     MOVE WWIN41    *IN41
     C                     MOVE WWIN42    *IN42
     C                     END                             E4
     C*
     C                     END                             E3
     C*
     C                     END                             E2
     C*
     C                     END                             E1
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C*******************************************************************
     C*  P203 - PREPARE COMMAND KEYS TO BE RETURNED TO SE3000           *
     C*******************************************************************
     C*
     C           P203      BEGSR
     C*
     C*
     C* ... If F3 pressed
     C*
     C           *INKC     IFEQ '1'
     C                     MOVE ' 3'      @PCMDK
     C                     RETRN
     C                     END
     C*
     C* ... If action code is 'I' and F9 pressed
     C*
     C           @SACTN    IFEQ 'I'
     C           *INKI     ANDEQ'1'
     C           *IN36     ANDEQ'0'                                       S01486
     C                     MOVE ' 9'      @PCMDK
     C                     RETRN
     C                     END
     C*
     C* ... If F12 pressed
     C*
     C           *INKL     IFEQ '1'
     C           *IN36     OREQ '1'                                       S01486
     C                     MOVE '12'      @PCMDK
     C                     RETRN
     C                     END
     C*
     C* ... If Confirm is 'Y'
     C* ... If Action code is 'I' , ...if action code is'A'
     C*
     C           @SPOTR    IFEQ 'Y'
     C           @SACTN    IFEQ 'I'
     C                     MOVE 'RA'      @PCMDK
     C                     END
     C           @SACTN    IFEQ 'A'
     C                     MOVE 'RY'      @PCMDK
     C                     END
     C                     END
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C*******************************************************************
     C*  P204 - OBTAIN STANDARD DETAILS FOR INSERT AND AMEND SCREEN     *
     C*         AND SETON SCREEN INDICATORS
     C*******************************************************************
     C*
     C           P204      BEGSR
     C*
     C* obtain header of the screen
     C*
     C                     MOVE @PACTN    @SACTN
     C                     MOVE @PBLKR    @SBLKR
     C                     MOVE WWTDSS    @SEREF
     C                     MOVE @PAGTR    @SAGET
     C                     MOVE @PPBBK    @SDPBK
      *                                                                   CAC005
      ** If CAC005 is on, retrieve user book from AOBKPCR0.               CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C           PMBKCD    PARM *BLANKS   PMBKCD  2                       CAC005
     C           PMPRFC    PARM *BLANKS   PMPRFC  4                       CAC005
     C                     PARM @PPBBK    PMPSBK  2                       CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMBKCD    @SDPBK                          CAC005
     C                     MOVELPMPRFC    @SPRFC                          CAC005
     C                     ELSE                                           CAC005
     C                     MOVEL*BLANKS   @SPRFC                          CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
      ** Continue assigning values to screen variables.                   CAC005
      *                                                                   CAC005
     C                     MOVE @PBRCD    @SBRCD
     C                     MOVE @PPOCU    @SPOCU
     C                     MOVE @PPOFO    @SPOFO
     C                     MOVE @PBONO    @SNOMI
     C                     MOVE @PPONO    @SPOOL
     C                     MOVE @PMANO    @SMARK
     C*
     C* Access LF/SECTY                                                )
     C           WWTDSS    CHAINSECTYDF              01
     C*
     C           *IN01     IFEQ '1'                        B1
     C           RECI      OREQ '*'
     C                     Z-ADD9         @DBASE           ***************
     C                     MOVEL'SECTY'   @DBFIL           * DB ERROR 09 *
     C                     MOVEL@PSESN    @DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             E1
     C*
     C***  Store fields for charge calculations
     C*
     C                     MOVELNMCYA     @XCCY
     C                     MOVE INCS      @SINCS
     C*
     C** OBTAIN NOMINAL CURRENCY INFORMATION
     C***********NMCYA     CHAINSDCURRL0             01                   S01486
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM NMCYA     P@KEY3  3                       S01486
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C*
     C************IN01     IFEQ '1'                        B1             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     Z-ADD5         @DBASE           ***************
     C                     MOVEL'SDCURRL0'@DBFIL           * DB ERROR 05 *
     C                     MOVELNMCYA     @DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             E1
     C*
     C                     Z-ADDA6SPRT    WWNMSP 138
     C                     Z-ADDA6NBDP    WWNMDP  10
     C                     MOVE A6MDIN    WWNMMD  1
     C                     MOVE A6NQDP    ZNQDP1                          CAC003
      *                                                                   S01176
      ***  Calculate the product of (trade denomination) and (ten to the  S01176
      ***  power of the nominal decimal places) for nominal validation.   S01176
      *                                                                   S01176
     C                     Z-ADDSDNM      @SDNM2 110
     C           NMDP      IFEQ 1                          B1
     C                     MULT 10        @SDNM2
     C                     END                             E1
     C           NMDP      IFEQ 2                          B1
     C                     MULT 100       @SDNM2
     C                     END                             E1
     C           NMDP      IFEQ 3                          B1
     C                     MULT 1000      @SDNM2
     C                     END                             E1
     C*                                                                   IMPR01
     C*    Convert pool nominal to a numeric value to be compared         IMPR01
     C*    with the total nominal entered                                 IMPR01
     C*                                                                   IMPR01
     C                     MOVE *BLANKS   ZFIELD                          IMPR01
     C                     MOVE @SPOOL    ZFIELD                          IMPR01
     C           15        SUB  NMDP      ZADIG                           IMPR01
     C                     Z-ADDNMDP      ZADEC                           IMPR01
     C                     EXSR ZALIGN                                    IMPR01
     C                     MOVE ZFIELD    WWPOOL 110                      IMPR01
     C*
     C*    Get Processing type
     C*
     C           @KEY1     CHAININVTPDF              01
     C*
     C           *IN01     IFEQ '1'                        B1
     C           RECI      OREQ '*'
     C                     Z-ADD10        @DBASE           ***************
     C                     MOVEL'INVTP'   @DBFIL           * DB ERROR 10 *
     C                     MOVE @DS1      @DBKEY           ***************
     C                     EXSR *PSSR
     C                     END                             E1
     C*
     C** SETON INDICATORS CONDITIONING DISPLAY OF SCREEN DETAILS
     C*
     C** SETON INDICATOR TO PROTECT/ALLOW ENTRY OF INTEREST DETAILS
     C                     SETOF                     04
     C           PROT      IFEQ '1'
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '6'
     C           PROT      OREQ '8'
     C           PROT      OREQ '9'
     C           STBS      IFEQ 'Y'
     C           STBS      OREQ 'P'
     C                     SETON                     04
     C                     END
     C                     END
     C*
     C** PRICE TO BE INPUT CAPABLE
     C           STBS      IFEQ 'Y'                        B1
     C           STBS      OREQ 'D'
     C                     MOVE '1'       *IN47
     C                     END                             E1
     C*
     C* Price & ex dividend INPUT CAPABLE
     C*
     C                     SETOF                     48
     C           PROT      IFEQ '4'                        B1
     C           PROT      OREQ '7'
     C                     MOVE '1'       *IN48
     C                     END                             E1
     C*
     C                     ENDSR
     C********************************************************************
      /EJECT
     C*******************************************************************
     C*  P500 - Update files                                            *
     C*******************************************************************
     C*
     C           P500      BEGSR
     C*
     C* Get next available transaction number using SR/ZTNLU
     C                     EXSR ZTNLU1
     C*
     C** IN INSERT MODE FORMAT DETAILS AND WRITE RECORD
     C           @SACTN    IFEQ 'I'                        B1
     C                     EXSR W001
     C                     WRITEPMPLTRP0
     C                     ELSE
     C*
     C** ....OTHERWISE IN AMEND MODE ACCESS LF/PMPLTRPD AND UPDATE     )
     C** DETAILS
     C                     MOVE @PBLKR    WPBLKR
     C                     MOVE @PPOCU    WPPOCU
     C                     MOVE @PPOFO    WPPOFO
     C*
     C           @KEY3     CHAINPMPLTRPD             07
     C*
     C                     EXSR W002
     C                     UPDATPMPLTRP0
     C                     END                             E1
     C*
     C                     ENDSR
     C*
     C********************************************************************
      /EJECT
     C********************************************************************
     C*  V001  - VALIDATE TRADE DETAILS INPUT                           *
     C*******************************************************************
     C*
     C           V001      BEGSR
     C*
     C* Total nominal
     C*
     C           @STOTN    IFNE *BLANKS                    B1             062275
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE @STOTN    ZFIELD
     C           11        SUB  NMDP      ZADIG
     C                     Z-ADDNMDP      ZADEC
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    WWNOMI 110
     C*
     C           *IN99     IFEQ '1'                        B2
     C****       @STOTN    OREQ *BLANKS                                   062275
     C****       WWNOMI    OREQ 0                                         062275
     C                     SETON                     498920
     C           E         IFLT 20                         B3
     C                     MOVEL' 175'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C*
     C** ....OTHERWISE IF VALID FORMAT FOR OUTPUT TO SCREEN
     C                     ELSE                            X2
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADDNMDP      ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @STOTN
     C                     END                             E2
      * If valid, then nominal must be a multiple of trade denomination   S01176
      *                                                                   S01176
     C           @SDNM2    IFNE 0                          B2
     C           *IN49     ANDEQ'0'
     C           WWNOMI    DIV  @SDNM2    @WK15  150
     C                     MVR            @WK15
     C           @WK15     IFNE 0                          B3
     C           E         IFLT 20                         B4
     C                     SETON                     204989
     C                     MOVEL' W11'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
      * If valid, then nominal must be less than or equal to the pool     IMPR01
      * nominal                                                           IMPR01
      *                                                                   IMPR01
     C           *IN49     IFEQ '0'                        B2             IMPR01
     C           WWNOMI    ANDGTWWPOOL                                    IMPR01
     C           @PTDTP    ANDEQ'TP'
     C           E         ANDLT20                                        IMPR01
     C                     SETON                     204989               IMPR01
     C                     MOVEL' W14'    @EA,E                           IMPR01
     C                     ADD  1         E                               IMPR01
     C                     END                             E2             IMPR01
     C                     END                             E1             IMPR01
     C*
     C* Clear holding indicator
     C*
     C           @SCLRH    IFNE *BLANKS                    B1
     C           @SCLRH    ANDNE'Y'
     C                     SETON                       4689
     C           E         IFLT 20                         B2
     C                     MOVEL' 176'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     ELSE                            X1
     C*
     C* ... can not be entered if trade purchased and pool nominal
     C*     negative or trade sell and pool nominal positive, or
     C*     if total nominal entered
     C*
     C           @SCLRH    IFEQ 'Y'                        B2
     C           @PTDTP    IFEQ 'TP'                       B3
     C           WWPOOL    ANDLT*ZEROS
     C           @PTDTP    OREQ 'TS'
     C           WWPOOL    ANDGT*ZEROS
     C           @STOTN    ORNE *BLANKS
     C                     SETON                       4689
     C           E         IFLT 20                         B4
     C                     MOVEL' 177'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*                                                                   062275
     C** Error if nominal blank and clear holding not set to "Y"          062275
     C           @STOTN    IFEQ *BLANKS                    B1             062275
     C           @SCLRH    ANDNE'Y'                                       062275
     C                     SETON                     494689               062275
     C           E         IFLT 20                         B2             062275
     C                     MOVEL' 178'    @EA,E                           062275
     C                     ADD  1         E                               062275
     C                     END                             E2             062275
     C                     END                             E1             062275
     C*
     C* Incomplete indicator
     C*
     C           @SINCS    IFNE 'I'                        B1
     C           @SINCS    ANDNE'C'
     C                     SETON                       5189
     C           ' 001'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         IFLT 20
     C                     MOVEL' 001'    @EA,E
     C                     ADD  1         E       30
     C                     END                             E2
     C                     END                             E2
     C                     ELSE                            X1
     C*
     C*    .. cannot be C if value on PF/SECTYD is I
     C*
     C           @SINCS    IFEQ 'C'                        B2
     C           INCS      ANDEQ'I'
     C                     SETON                       5189
     C           ' 002'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 002'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** INCOMPLETE INDICATOR MAY NOT BE CHANGED FROM 'C' TO 'I'
     C           @PACTN    IFEQ 'A'                        B1
     C           @SINCS    IFEQ 'I'                        B2
     C           OUTINC    ANDEQ'C'
     C                     SETON                       5189
     C           ' 002'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 002'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** VALIDATE NEW VALUE DATE INPUT
     C                     MOVE 'Y'       WWVALD  1
     C                     MOVEL@STDVD    @WK7N   70
     C                     MOVEL@WK7N     @WK6A   6
     C*
     C           @STDVD    IFNE @WK6A                      B1
     C*
     C                     MOVE 'N'       WWVALD  1
     C                     SETON                     215489
     C           ' 008'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 008'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C** CHECK THAT A VALID DATE HAS BEEN INPUT
     C           *IN54     IFEQ '0'                        B1
     C                     MOVE @STDVD    ZDATE
     C                     EXSR ZDATE1
     C*
     C*    .. if amended, must be a valid date
     C*
     C           *IN99     IFEQ '1'                        B2
     C                     MOVE 'N'       WWVALD  1
     C                     SETON                     215489
     C           ' 009'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 009'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C*    .. if amended must not be after maturity date or before
     C*                                    issue date of the security
     C           *IN54     IFEQ '0'                        B1
     C                     Z-ADDZDAYNO    WWTDVD  50
     C           MATY      IFNE *ZEROS                     B2
     C           WWTDVD    ANDGTMATY
     C           WWTDVD    ORLT ISSD
     C                     MOVE 'N'       WWVALD  1
     C                     SETON                     215489
     C           ' 010'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 010'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C*    .. if amended and less than run date, must fall within back
     C*                                     value period
     C           *IN54     IFEQ '0'                        B1
     C           WWTDVD    IFLT BJRDNB                     B2
     C           WWTDVD    ANDLT@WBKVP
     C                     SETON                     215489
     C                     MOVE 'N'       WWVALD  1
     C           ' 011'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 011'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C*    .. if amended and security is partly paid, must be later
     C*                                  than the most recent call date
     C           *IN54     IFEQ '0'                        B1
     C           PPDI      IFEQ 'Y'                        B2
     C           WWTDVD    ANDLTSLCA
     C                     MOVE 'N'       WWVALD  1
     C                     SETON                     215489
     C           ' 012'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 012'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** CLEARANCE TYPE MUST NOT BE 0 IF TRADE IS COMPLETE
     C           @SINCS    IFEQ 'C'                        B1
     C           @SCLTY    ANDEQ'0'
     C           @SINCS    OREQ 'C'
     C           @SCLTY    ANDEQ' '
     C                     SETON                     7489
     C           ' 013'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 013'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C*    .. if amended and Clearance Type '1' or '2', must not be
     C*                              holiday in Euroclear currency
     C           *IN54     IFEQ '0'                        B1
     C           @SCLTY    IFEQ '1'                        B2
     C           @SCLTY    OREQ '2'
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     MOVE BVEUCY    ZCCY
     C***********          MOVE 'N'       ZOPT                            S01486
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     MOVE *OFF      *IN99                           S01486
     C                     ELSE                                           S01486
     C                     MOVE *ON       *IN99                           S01486
     C                     ENDIF                                          S01486
     C           *IN99     IFEQ '1'                        B3
     C                     SETON                     215489
     C           ' W01'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B4
     C           E         ANDLT20
     C                     MOVEL' W01'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C*
     C*    .. if amended and Clearance Type '3' or '4', must not be
     C*                                 holiday in Cedel currency
     C           @SCLTY    IFEQ '3'                        B2
     C           @SCLTY    OREQ '4'
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     MOVE BVCCCY    ZCCY                            S01486
     C***********          MOVE BVCYCD    ZCCY                            S01486
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     MOVE *OFF      *IN99                           S01486
     C                     ELSE                                           S01486
     C                     MOVE *ON       *IN99                           S01486
     C                     ENDIF                                          S01486
     C           *IN99     IFEQ '1'                        B3
     C                     SETON                     215489
     C           ' W02'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B4
     C           E         ANDLT20
     C                     MOVEL' W02'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C*
     C*    .. if amended and Clearance Type '2','4' or '5', must not
     C*                           be holiday in settlement currency
     C           @SCLTY    IFEQ '2'                        B2
     C           @SCLTY    OREQ '4'
     C           @SCLTY    OREQ '5'
     C           @SSETC    IFNE *BLANKS                    B3
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     MOVE @SSETC    ZCCY
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     MOVE *OFF      *IN99                           S01486
     C                     ELSE                                           S01486
     C                     MOVE *ON       *IN99                           S01486
     C                     ENDIF                                          S01486
     C           *IN99     IFEQ '1'                        B4
     C                     SETON                     215489
     C           ' W03'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B5
     C           E         ANDLT20
     C                     MOVEL' W03'    @EA,E
     C                     ADD  1         E
     C                     END                             E5
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C*
     C*    .. if amended must not be a holiday in value currency
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     MOVE VLCY      ZCCY
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     MOVE *OFF      *IN99                           S01486
     C                     ELSE                                           S01486
     C                     MOVE *ON       *IN99                           S01486
     C                     ENDIF                                          S01486
     C           *IN99     IFEQ '1'                        B2
     C                     SETON                     215489
     C           ' W04'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' W04'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C*
     C*    .. if amended must not be a holiday in payment currency
     C                     Z-ADDWWTDVD    ZDAYNO
     C                     MOVE SPYC      ZCCY
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     MOVE *OFF      *IN99                           S01486
     C                     ELSE                                           S01486
     C                     MOVE *ON       *IN99                           S01486
     C                     ENDIF                                          S01486
     C           *IN99     IFEQ '1'                        B2
     C                     SETON                     215489
     C           ' W05'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' W05'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* IF VALUE DATE CHANGED AND VALID OUTPUT VALUE DATE CHANGED IND
     C                     MOVE 'N'       WWVCHG  1
     C           WWVALD    IFEQ 'Y'                        B1
     C           @STDVD    ANDNEW1TDVD
     C                     MOVE 'Y'       WWVCHG  1
     C                     MOVE @STDVD    W1TDVD
     C                     END                             E1
     C*
     C*    Update Event Control Date with Value Date
     C*
     C                     MOVE WWTDVD    ECD
     C*
     C* Price/yield/discount
     C*
     C                     MOVE 'Y'       WWVALD
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE @STPDY    ZFIELD
     C                     Z-ADD7         ZADIG
     C                     Z-ADD8         ZADEC
     C                     EXSR ZALIGN
     C           *IN99     IFEQ '1'                        B1
     C                     MOVE 'N'       WWVALD
     C                     SETON                     508922
     C           ' 181'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         IFLT 20
     C                     MOVEL' 181'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E2
     C                     ELSE                            X1
     C*
     C                     MOVE ZFIELD    WWTPD1 158
     C           WWTPD1    IFNE 0                          B2
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @STPDY
     C                     END                             E2
     C                     END                             E1
     C*
     C** FOR DISCOUNT TRADED SECURITIES THE PRICE/DISCOUNT/YIELD SHOULD
     C** BE ZERO IF VALUE DATE *EQ TRADE MATURITY DATE
     C           *IN71     IFEQ '0'                        B1
     C           STBS      IFEQ 'D'                        B2
     C           WWTDVD    ANDEQMATY
     C           WWTPDY    ANDNE0
     C                     SETON                     225089
     C           ' W08'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' W08'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** IF THE PRICE/DISCOUNT/YIELD IS BLANK
     C** OR ZERO FOR NON-DISCOUNT SECURITIES
     C** OR PRICE *GT 100 FOR YIELD TRADED SECURITIES ERROR
     C           WWVALD    IFEQ 'Y'                        B1
     C           1000      MULT POWER8,8  WK100  150
     C           @STPDY    IFEQ *BLANKS                    B2
     C           WWTPD1    OREQ 0
     C           STBS      ANDNE'D'
     C           STBS      OREQ 'Y'
     C           WWTPDY    ANDGTWK100
     C                     SETON                     225089
     C           ' 228'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 228'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** SET ON INDICATOR FOR PRICR/DISCOUNT/YIELD CHANGED
     C                     MOVE 'N'       WWTPFL  1
     C           WWTPDY    IFNE WWTPD1
     C                     Z-ADDWWTPD1    WWTPDY
     C                     MOVE 'Y'       WWTPFL  1
     C                     END
     C*
     C* Reallowance
     C*
     C           @SRALL    IFNE *BLANKS                    B1
     C           STBS      IFEQ 'Y'                        B2
     C                     SETON                     57  89
     C           ' 043'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 043'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C                     ELSE                            X2
     C*
     C** CHECK THAT VALID SIGNED AMOUNT ENTERED
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVEL@SRALL    ZFLD17
     C                     Z-ADD4         ZSDIG
     C                     Z-ADD5         ZSDEC
     C                     EXSR ZASIGN
     C           *IN99     IFEQ '0'                        B3
     C                     MOVE ZOUT15    WWRALL 100
     C           ZFSIGN    IFEQ '-'                        B4
     C                     Z-SUBWWRALL    WWRALL
     C                     END                             E4
     C                     Z-ADD0         ZFLD15
     C                     MOVE WWRALL    ZFLD15
     C                     Z-ADD5         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @SRALL
     C                     ELSE                            X3
     C                     SETON                     57  89
     C           ' 044'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B4
     C           E         ANDLT20
     C                     MOVEL' 044'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Price
     C*
     C           *IN47     IFEQ '1'                        B1
     C*
     C*  If value date has changed then recalculate and redisplay
     C*      the price overwriting any manual amendments to it
     C           WWVCHG    IFEQ 'Y'                        B2
     C           @SPRIC    ANDEQW1PRIC
     C           WWTPFL    OREQ 'Y'
     C           @SPRIC    ANDEQW1PRIC
     C*
     C           *IN50     IFEQ '0'                        B3
     C           *IN54     ANDEQ'0'
     C                     Z-ADDWWTDVD    ECD
     C                     EXSR ZNCD
     C                     MOVE WWTPDY    ZPRCIN
     C                     Z-ADDWWTDVD    ZFDATE
     C                     EXSR ZPRCI
     C*
     C** FORMAT NEW PRICE FOR OUTPUT
     C                     Z-ADD0         ZFLD15
     C                     MOVE ZPRCOT    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @SPRIC
     C                     MOVE @SPRIC    W1PRIC 16
     C                     END                             E2
     C                     END                             E3
     C*
     C** VALIDATE THAT NUMERIC PRICE INPUT
     C                     Z-ADD0         ZFLD15
     C                     MOVE @SPRIC    ZFIELD
     C                     Z-ADD7         ZADIG
     C                     Z-ADD8         ZADEC
     C                     EXSR ZALIGN
     C*
     C           *IN99     IFEQ '1'                        B2
     C                     SETON                     52  89
     C           ' 063'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 063'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C                     ELSE                            X2
     C*
     C                     MOVE ZFIELD    WWTEST 158
     C           WWTEST    IFNE 0                          B3
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @SPRIC
     C                     MOVE @SPRIC    W1PRIC 16
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Capacity
     C*    .. if entered, must be in the range 0 - 6
     C           @SCPCY    IFNE *BLANKS                    B1
     C           @SCPCY    IFLT '0'                        B2
     C           @SCPCY    ORGT '6'
     C                     SETON                     5589
     C           ' 056'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 056'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C                     ELSE                            X2
     C*
     C           @PAGTR    IFEQ 'Y'                        B3
     C           @SCPCY    ANDNE'3'
     C           @SCPCY    ANDNE'6'
     C                     SETON                     5589
     C           ' 056'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B4
     C           E         ANDLT20
     C                     MOVEL' 056'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C*  Check Capacity against Trade Type
     C*
     C           @STDTP    IFEQ 'TP'                       B1
     C           @SCPCY    ANDEQ'2'
     C           @STDTP    OREQ 'TP'
     C           @SCPCY    ANDEQ'3'
     C           @STDTP    OREQ 'TS'
     C           @SCPCY    ANDEQ'5'
     C           @STDTP    OREQ 'TS'
     C           @SCPCY    ANDEQ'6'
     C                     SETON                     5589
     C           ' 057'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 057'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C* Market center
     C*
     C*    .. if entered, must be a valid code
     C*
     C           @SMRKT    IFNE *BLANKS                    B1
     C           @SMRKT    CHAINSEMKC                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     5689
     C           ' 050'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 050'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* VALIDATE TRADE DATE - MUST BE NUMERIC FIELD
     C                     MOVE 'Y'       WWVALD
     C                     MOVEL@STDDT    @WK7N
     C                     MOVEL@WK7N     @WK6A
     C           @STDDT    IFNE @WK6A                      B1
     C                     MOVE 'N'       WWVALD
     C                     SETON                     592389
     C           ' 069'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         IFLT 20
     C                     MOVEL' 069'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E2
     C                     ELSE                            X1
     C*
     C** MUST BE A VALID DATE
     C                     MOVE @STDDT    ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    WWTDDT
     C*
     C           *IN99     IFEQ '1'                        B2
     C                     MOVE 'N'       WWVALD
     C                     SETON                     592389
     C           ' 069'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 069'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C*
     C                     ELSE                            X2
     C                     Z-ADDZDAYNO    WWTDDT
     C                     END                             E2
     C*
     C** MAY NOT BE GREATER THAN RUN DATE
     C           *IN59     IFEQ '0'                        B2
     C           WWTDDT    IFGT BJRDNB                     B3
     C                     MOVE 'N'       WWVALD
     C                     SETON                     592389
     C           ' 070'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B4
     C           E         ANDLT20
     C                     MOVEL' 070'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C*
     C*    .. if amended, must not be earlier than back value period
     C           *IN59     IFEQ '0'                        B2
     C*
     C           WWTDDT    IFLT @WBKVP                     B3
     C                     MOVE 'N'       WWVALD
     C                     SETON                     592389
     C           ' 071'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B4
     C           E         ANDLT20
     C                     MOVEL' 071'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C*
     C*    .. if amended, must not be a holiday in local currency
     C           *IN59     IFEQ '0'                        B2
     C                     Z-ADDWWTDDT    ZDAYNO
     C                     MOVE BJLCCY    ZCCY
     C***********          EXSR ZDATE5                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZCHKH                                     S01486
     C           ZIND      IFEQ 'W'                                       S01486
     C                     MOVE *OFF      *IN99                           S01486
     C                     ELSE                                           S01486
     C                     MOVE *ON       *IN99                           S01486
     C                     ENDIF                                          S01486
     C           *IN99     IFEQ '1'                        B3
     C                     SETON                     592389
     C           ' W10'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B4
     C           E         ANDLT20
     C                     MOVEL' W10'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C*
     C*  Trade date should never be greater than value date.
     C*
     C           *IN59     IFEQ '0'                        B3
     C           WWTDDT    IFGT WWTDVD                     B4
     C                     MOVE 'N'       WWVALD
     C                     SETON                     592389
     C           ' 073'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B5
     C           E         ANDLT20
     C                     MOVEL' 073'    @EA,E
     C                     ADD  1         E
     C                     END                             E5
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* IF TRADE DATE CHANGED AND VALID OUTPUT TRADE DATE CHANGED IND
     C                     MOVE 'N'       WWTCHG  1
     C           WWVALD    IFEQ 'Y'                        B1
     C           @STDDT    ANDNEW1TDDT
     C                     MOVE 'Y'       WWTCHG  1
     C                     END                             E1
     C                     MOVE @STDDT    W1TDDT
     C*
     C* VALIDATE EX DIVIDEND IF FIELD INPUT CAPABLE
     C           *IN48     IFEQ '1'                        B1
     C*
     C** IF TRADE DATE HAS BEEN AMENDED RECALCULATE EX-DIVIDEND
     C           WWTCHG    IFEQ 'Y'
     C                     EXSR SUB300
     C                     MOVE @WEXDV    @SEXDV
     C                     END
      *
     C* If indicator has been amended, must be 'C' or 'X'.
     C*
     C           @SEXDV    IFNE 'C'                        B2
     C           @SEXDV    ANDNE'X'
     C                     SETON                     53  89
     C           ' 079'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 079'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Trade sub-type
     C*
     C*    .. if amended, must be a valid code on SDDLSTL1
     C***********@STSUB    CHAINSDDLSTL1             01                   S01486
     C                     CALL 'AODLSTR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM @STSUB    P@KEY2  2                       S01486
     C           SDDLST    PARM SDDLST    DSFDY                           S01486
     C************IN01     IFEQ '1'                        B1             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     SETON                     60  89
     C           ' 085'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 085'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
      *                                                                   S01486
      ** Check for '?' processing.                                        S01486
      *                                                                   S01486
     C           P@RTCD    IFEQ *BLANKS                                   S01486
     C           @STSUB    ANDEQ'?'                                       S01486
     C                     MOVELASDSTC    @STSUB                          S01486
     C                     END                                            S01486
     C*
     C** MARKET INDICATOR MUST BE ONE OF 'P' 'S' OR 'G'
     C           @STDMI    IFNE 'P'                        B1
     C           @STDMI    ANDNE'G'
     C           @STDMI    ANDNE'S'
     C                     SETON                     62  89
     C           ' 092'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 092'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C** VALIDATE AIBD/IPMA INDICATOR
     C           @SAIIP    IFNE 'Y'                        B1
     C           @SAIIP    ANDNE'N'
     C                     SETON                     6389
     C           ' 098'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 098'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C** VALIDATE ACCRUED INDICATOR IF INPUT CAPABLE
     C           *IN04     IFEQ '1'                        B1
     C*
     C*    .. if amended, must be 'C' 'F' or 'X'
     C*
     C           @SACIN    IFNE 'C'                        B2
     C           @SACIN    ANDNE'F'
     C           @SACIN    ANDNE'X'
     C*
     C                     SETON                     65  89
     C           ' 105'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 105'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C*
     C** IF SECURITY IS A SCHULDSCHEIN (IE PROCESSING TYPE 6) THE
     C** ACCRUED INDICATOR MUST BE 'F'
     C           *IN65     IFEQ '0'                        B2
     C           @SACIN    IFNE 'F'                        B3
     C           PROT      ANDEQ'6'
     C           @SACIN    ANDNE'X'
     C*
     C                     SETON                     65  89
     C           ' 106'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B4
     C           E         ANDLT20
     C                     MOVEL' 106'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C*
     C* Reset if value date changed
     C* (but only if indicator has not been set by user on this cycle)
     C           *IN65     IFEQ '0'                        B2
     C           WWVCHG    IFEQ 'Y'                        B3
     C           @SACIN    ANDEQW1ACIN
     C                     MOVEL'C'       @SACIN
     C                     Z-ADDWWTDVD    ECD
     C                     EXSR ZNCD
     C           WWTDVD    IFEQ NCD                        B4
     C                     MOVEL'F'       @SACIN
     C                     ELSE                            X4
     C                     MOVELEDFT      ZNRDYS
     C           ZNRDYS    IFNE 0                          B5
     C                     MOVE EDFT      @WEDFT  1
     C           @WEDFT    IFEQ 'W'                        B6
     C                     Z-ADDNCD       ZDAYNO
     C                     MOVE VLCY      ZCCY
     C***********          EXSR XDAT3A                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZBKDT                                     S01486
     C                     ELSE                            X6
     C           NCD       SUB  ZNRDYS    ZDYNBR
     C                     END                             E6
     C           WWTDVD    IFLT NCD                        B6
     C           WWTDVD    ANDGEZDYNBR
     C                     MOVEL'X'       @SACIN
     C                     END                             E6
     C*
     C           PROT      IFEQ '6'                        B6
     C                     MOVE 'F'       @SACIN
     C                     END                             E6
     C                     END                             E5
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C                     MOVE @SACIN    W1ACIN  1
     C*
     C* VALIDATE DAYS ADJUSTMENT
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVEL@SDADJ    ZFLD17
     C                     Z-ADD3         ZSDIG
     C                     Z-ADD0         ZSDEC
     C                     EXSR ZASIGN
     C*
     C           *IN99     IFEQ '0'                        B2
     C                     MOVE ZOUT15    WADADJ  30
     C           ZFSIGN    IFEQ '-'                        B3
     C                     Z-SUBWADADJ    WADADJ
     C                     END                             E3
     C*
     C                     MOVE *BLANKS   @SDADJ
     C           WADADJ    IFNE 0                          B3
     C                     Z-ADD0         ZFLD15
     C                     MOVE WADADJ    ZFLD15
     C                     Z-ADD0         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @SDADJ
     C                     END                             E3
     C*
     C                     ELSE                            X2
     C                     SETON                     66  89
     C           ' 111'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 111'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C*
     C** VALIDATE DAYS ADJUSTMENT INDICATOR
     C           @SDADJ    IFEQ *BLANKS                    B2
     C           @SACTD    ANDNE*BLANKS
     C           WADADJ    OREQ 0
     C           @SACTD    ANDNE*BLANKS
     C           @SACTD    ORNE *BLANKS
     C           @SACTD    ANDNE'A'
     C           @SACTD    ANDNE'D'
     C                     SETON                     67  89
     C           ' 112'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 112'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C*
     C                     END                             E1
     C*
     C*  Multiply/Divide factor must be M or D if changed
     C*
     C           @SSMDI    IFNE 'M'                        B1
     C           @SSMDI    ANDNE'D'
     C                     SETON                     7089
     C           ' 130'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 130'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C** CHECK THAT SETTLEMENT CURRENCY EXISTS
     C***********@SSETC    CHAINSDCURRL0             01                   S01486
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM @SSETC    P@KEY3  3                       S01486
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C*
     C************IN01     IFEQ '1'                        B1             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     SETON                     6889
     C           ' 037'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 037'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
      *                                                                   S01486
      ** Check for '?' processing.                                        S01486
      *                                                                   S01486
     C           P@RTCD    IFEQ *BLANKS                                   S01486
     C           @SSETC    ANDEQ'?'                                       S01486
     C                     MOVELA6CYCD    @SSETC                          S01486
     C                     END                                            S01486
     C*
     C** VALIDATE EXCHANGE RATE - MANDATORY INPUT FIELD
     C           @SRATE    IFEQ *BLANKS                    B1
     C                     SETON                     698924
     C           ' 124'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 124'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C** VALIDATE THAT EXCHANGE RATE IS VALID AMOUNT
     C           @SRATE    IFNE *BLANKS                    B1
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@SRATE    ZFIELD
     C                     Z-ADD5         ZADIG
     C                     Z-ADD8         ZADEC
     C                     EXSR ZALIGN
     C*
     C           *IN99     IFEQ '1'                        B2
     C                     SETON                     698924
     C           ' 122'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 122'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C                     ELSE                            X2
     C                     Z-ADD0         ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SRATE
     C                     MOVE ZFIELD    WWRATE 138
     C                     END                             E2
     C                     END                             E1
     C*                                                                   CAC003
     C                     MOVE 'Y'       WERATE  1                       CAC003
     C*
     C** VALIDATE THAT EXCHANGE RATE IS WITHIN 10% OF SPOT RATE
     C** BETWEEN NOMINAL AND SETTLEMENT CURRENCY
     C           *IN68     IFEQ '0'                        B1
     C           *IN69     ANDEQ'0'
     C*                                                                   CAC003
     C                     MOVE 'N'       WERATE                          CAC003
     C*
     C** OBTAIN SETTLEMENT CURRENCY DETAILS
     C***********@SSETC    CHAINSDCURRL0             01                   S01486
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM @SSETC    P@KEY3  3                       S01486
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C*
     C                     MOVE NMCYA     ZCCYF
     C                     MOVE @SSETC    ZCCYT
     C                     Z-ADDWWNMSP    ZRATEF
     C                     Z-ADDA6SPRT    ZRATET
     C                     Z-ADDWWNMDP    ZCDPF
     C                     Z-ADDA6NBDP    ZCDPT
     C                     MOVE WWNMMD    ZMDINF
     C                     MOVE A6MDIN    ZMDINT
     C                     EXSR ZCCYCN
     C*
     C                     Z-ADDZCRSRT    @WTDER 138H
     C           @SSMDI    IFNE ZCRSMD                     B2
     C           1         DIV  ZCRSRT    @WTDER 138H
     C                     END                             E2
     C*
     C** SET UP UPPER AND LOWER RANGE LIMITS
     C           @WTDER    DIV  10        WWPWK1 158H
     C           @WTDER    SUB  WWPWK1    @APWK1 158H
     C           @WTDER    ADD  WWPWK1    @APWK2 158
     C*
     C** CHECK UPPER AND LOWER RANGE LIMITS
     C           WWRATE    IFGT @APWK2                     B2
     C           WWRATE    ORLT @APWK1
     C                     SETON                     698924
     C           ' W06'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' W06'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*                                                                   CAC003
     C                     Z-ADD0         WWFXMP  72                      CAC003
     C                     Z-ADD0         WWFXMR 138                      CAC003
     C*                                                                   CAC003
     C           *IN30     IFEQ '1'                                       CAC003
     C           *IN68     ANDEQ'0'                                       CAC003
     C           @SSPTS    ANDNE*BLANKS                                   CAC003
     C*                                                                   CAC003
     C           NMCYA     IFEQ @SSETC                                    CAC003
     C                     MOVE '1'       *IN31                           CAC003
     C                     MOVE '1'       *IN89                           CAC003
     C           ' 401'    LOKUP@EA                      03               CAC003
     C           *IN03     IFEQ '0'                                       CAC003
     C           E         ANDLT20                                        CAC003
     C                     MOVE ' 401'    @EA,E                           CAC003
     C                     ADD  1         E                               CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ELSE                                           CAC003
     C*                                                                   CAC003
     C                     MOVE *BLANKS   ZFIELD                          CAC003
     C                     MOVEL@SSPTS    ZFIELD                          CAC003
     C                     Z-ADD2         ZADEC                           CAC003
     C                     Z-ADD5         ZADIG                           CAC003
     C                     EXSR ZALIGN                                    CAC003
     C*                                                                   CAC003
     C           *IN99     IFEQ *ON                                       CAC003
     C                     MOVE '1'       *IN31                           CAC003
     C                     MOVE '1'       *IN89                           CAC003
     C           ' 402'    LOKUP@EA                      03               CAC003
     C           *IN03     IFEQ '0'                                       CAC003
     C           E         ANDLT20                                        CAC003
     C                     MOVE ' 402'    @EA,E                           CAC003
     C                     ADD  1         E                               CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ELSE                                           CAC003
     C                     MOVE ZFIELD    WWFXMP                          CAC003
     C                     Z-ADD0         ZFLD15                          CAC003
     C                     MOVE ZFIELD    ZFLD15                          CAC003
     C                     Z-ADD2         ZDECS                           CAC003
     C                     EXSR ZSEDIT                                    CAC003
     C                     MOVE ZOUT20    @SSPTS                          CAC003
     C                     ENDIF                                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C           *IN31     IFEQ '0'                                       CAC003
     C           WERATE    ANDEQ'N'                                       CAC003
     C                     MOVE A6NQDP    ZNQDP2                          CAC003
     C*                                                                   CAC003
     C**  Get Normally-Quoted Decimal Places.                             CAC003
     C                     EXSR SRNQDP                                    CAC003
     C           ZNQDPX    ADD  1         ZA      10                      CAC003
     C*                                                                   CAC003
     C**  Compute the maximum margin points allowed.                      CAC003
     C**  Maximum Marg Pts = Xccy rate * Tolerance * 10**Quoted DP        CAC003
     C*                                                                   CAC003
     C           FTTMRT    DIV  100       W1      32                      CAC003
     C           W1        MULT WWRATE    W2     138H                     CAC003
     C           W2        MULT AP,ZA     WMAXPT  72H                     CAC003
     C*                                                                   CAC003
     C**  If the entered margin points is greater than the maximum        CAC003
     C**  allowed, display warning error code.                            CAC003
     C*                                                                   CAC003
     C           WWFXMP    IFGT WMAXPT                                    CAC003
     C                     MOVE '1'       *IN31                           CAC003
     C                     MOVE '1'       *IN89                           CAC003
     C           ' W15'    LOKUP@EA                      03               CAC003
     C           *IN03     IFEQ '0'                                       CAC003
     C           E         ANDLT20                                        CAC003
     C                     MOVE ' W15'    @EA,E                           CAC003
     C                     ADD  1         E                               CAC003
     C                     ENDIF                                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C**  Calculate Margin rate                                           CAC003
     C           WWFXMP    DIV  AP,ZA     WWFXMR    H                     CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*
     C** BASE CURRENCY RATE IS A MANDATORY INPUT FIELD
     C           @SBRTE    IFEQ *BLANKS                    B1
     C                     SETON                     718925
     C           ' 137'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 137'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C** CHECK THAT BASE CURRENCY RATE IS A VALID NUMERIC RATE
     C           *IN71     IFEQ '0'                        B1
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@SBRTE    ZFIELD
     C                     Z-ADD5         ZADIG
     C                     Z-ADD8         ZADEC
     C                     EXSR ZALIGN
     C           *IN99     IFEQ '1'                        B2
     C                     SETON                     718925
     C           ' 136'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 136'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C                     ELSE                            X2
     C                     Z-ADD0         ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SBRTE
     C                     MOVE ZFIELD    WWRATE 138
     C                     END                             E2
     C                     END                             E1
     C*
     C** CHECK THAT BASE RATE IS WITHIN 10% of spot rate
     C           *IN71     IFEQ '0'                        B1
     C           WWNMSP    DIV  10        WWPWK1    H
     C           WWNMSP    ADD  WWPWK1    @APWK1
     C           WWNMSP    SUB  WWPWK1    @APWK2
     C           WWRATE    IFGT @APWK1                     B2
     C           WWRATE    ORLT @APWK2
     C           ' W07'    LOKUP@EA                      03
     C                     SETON                     718925
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' W07'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** VALIDATE CLEARANCE TYPE
     C           @SCLTY    IFLT '0'                        B1
     C           @SCLTY    ORGT '5'
     C                     SETON                     7489
     C           ' 030'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 030'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C*    .. if Market indicator is 'G', must be '0'
     C           @STDMI    IFEQ 'G'                        B1
     C           @SCLTY    ANDNE'0'
     C                     SETON                     7489
     C           ' 031'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 031'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C* Deliver from
     C*
     C                     MOVE *BLANKS   @WDELF  6
     C           @SINCS    IFEQ 'C'                        B1
     C           @STDMI    ANDNE'G'
     C           @SDELF    IFEQ *BLANKS                    B2
     C                     SETON                     728926
     C           ' 143'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 143'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** CHECK THAT A VALID SECURITIES TRADING CUSTOMER NUMBER OR
     C** SHORTNAME HAS BEEN ENTERED
     C           @SDELF    IFNE *BLANKS                    B1
     C                     MOVEL@SDELF    @WK1    1
     C*
     C** IF A CUSTOMER SHORTNAME HAS BEEN ENTERED OBTAIN CUSTOMER NO
     C           @WK1      IFLT '0'                        B2
     C           @WK1      ORGT '9'
     C***********@SDELF    CHAINSDCUSTL6             01                   S01486
     C                     CALL 'AOCUSTR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM @SDELF    P@KEY0 10                       S01486
     C                     PARM           P@KEY7  7                       S01486
     C           SDCUST    PARM SDCUST    DSSDY                           S01486
     C************IN01     IFEQ '1'                        B3             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C           P@KEY7    ORNE '*SHNAME'                                 S01486
     C                     MOVE *BLANKS   WWCNUA  6
     C**********           MOVE *ZEROS    WWCNUN  60                                          CSD027
     C                     MOVE *BLANKS   WWCNUN  6                                           CSD027
     C                     ELSE                            X3
     C                     MOVE BBCUST    WWCNUA
     C                     MOVE BBCUST    WWCNUN
     C                     END                             E3
      *                                                                   S01486
      ** Check for '?' processing.                                        S01486
      *                                                                   S01486
     C           P@RTCD    IFEQ *BLANKS                                   S01486
     C           @SDELF    ANDEQ'?'                                       S01486
     C                     MOVELBBCUST    @SDELF                          S01486
     C                     END                                            S01486
     C*
     C** ...OTHERWISE SET CUSTOMER NUMBER TO SCREEN VALUE
     C                     ELSE                            X2
     C                     MOVEL@SDELF    WWCNUA
     C                     MOVEL@SDELF    WWCNUN
     C                     END                             E2
     C*
     C** CHECK THAT CUSTOMER IS A VALID SECURITIES TRADING CUSTOMER
     C***********WWCNUA    CHAINSDSECSL1             01                   S01486
     C                     CALL 'AOSECSR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM WWCNUA    P@KEY6  6                       S01486
     C           SDSECS    PARM SDSECS    DSFDY                           S01486
     C************IN01     IFEQ '1'                        B2             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     SETON                     728926
     C           ' 143'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 143'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C                     ELSE                            X2
     C                     MOVE BFCUST    @WDELF
     C                     END                             E2
     C                     END                             E1
     C*
     C** ERROR IF DELIVER FROM IS SAFE CUSTODY OR DISCRETIOARY CUSTOMER
     C           *IN72     IFEQ '0'                        B1
     C           BFCLAS    IFEQ 'S'                        B2
     C           BFCLAS    OREQ 'D'
     C                     SETON                     728926
     C           ' 144'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 144'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C*   ..  Check combinations of clearance type/classification.
     C           @SCLTY    IFEQ '0'
     C           @SDELF    ANDNE*BLANKS
     C           E         IFLT 20
     C                     MOVE ' 339'    @EA,E
     C                     ADD  1         E
     C                     SETON                     267289
     C                     END
     C                     END
      *
     C           @SCLTY    IFEQ '1'
     C           BFCLAS    ANDNE'E'
     C           E         IFLT 20
     C                     MOVE ' 339'    @EA,E
     C                     ADD  1         E
     C                     SETON                     267289
     C                     END
     C                     END
      *
     C           @SCLTY    IFEQ '2'
     C           @STDTP    IFEQ 'TS'
     C           BFCLAS    ANDNE'E'
     C           E         IFLT 20
     C                     MOVE ' 339'    @EA,E
     C                     ADD  1         E
     C                     SETON                     267289
     C                     END
     C                     END
     C                     END
      *
     C           @SCLTY    IFEQ '2'
     C           @STDTP    IFEQ 'TP'
     C           BFCLAS    ANDEQ'E'
     C           E         IFLT 20
     C                     MOVE ' 339'    @EA,E
     C                     ADD  1         E
     C                     SETON                     267289
     C                     END
     C                     END
     C                     END
      *
     C           @SCLTY    IFEQ '3'
     C           BFCLAS    ANDNE'C'
     C           E         IFLT 20
     C                     MOVE ' 339'    @EA,E
     C                     ADD  1         E
     C                     SETON                     267289
     C                     END
     C                     END
      *
     C           @SCLTY    IFEQ '4'
     C           @STDTP    IFEQ 'TS'
     C           BFCLAS    ANDNE'C'
     C           E         IFLT 20
     C                     MOVE ' 339'    @EA,E
     C                     ADD  1         E
     C                     SETON                     267289
     C                     END
     C                     END
     C                     END
      *
     C           @SCLTY    IFEQ '5'
     C           BFCLAS    IFEQ 'E'
     C           BFCLAS    OREQ 'C'
     C           E         IFLT 20
     C                     MOVE ' 339'    @EA,E
     C                     ADD  1         E
     C                     SETON                     267289
     C                     END
     C                     END
     C                     END
     C*
     C** OUTPUT A WARNING ERROR IF THE DEPOT REFERENCE IS NOT DEFINED
     C** FOR THE INVESTMENT TYPE OR THERE IS NO SECURITY REFERENCE FOR
     C** THE DEPOT
     C           WWCNUN    IFEQ SDC1                       B1
     C           DASR      ANDNE*BLANKS
     C           WWCNUN    OREQ SDC2
     C           DCSR      ANDNE*BLANKS
     C           WWCNUN    OREQ SDC3
     C           DDSR      ANDNE*BLANKS
     C                     MOVE 'Y'       WWAOK   1
     C                     ELSE                            X1
     C                     SETON                     267289
     C           E         IFLT 20                         B2
     C                     MOVE ' W12'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C***ERROR*IF*DELIVER*FROM*IS*KASSENVEREIN*AND*SETTLEMENT*CURRENCY*   CSE022
     C***IS*NOT*DEM****************************************************   CSE022
     C********** BFCLAS    IFEQ 'K'                        B1             CSE022
     C********** @SSETC    ANDNE'DEM'                                     CSE022
     C**********           SETON                     267289               CSE022
     C********** E         IFLT 20                         B2             CSE022
     C**********           MOVE ' 340'    @EA,E                           CSE022
     C**********           ADD  1         E                               CSE022
     C**********           END                             E2             CSE022
     C**********           END                             E1             CSE022
     C*
     C* Deliver to
     C*
     C           @SINCS    IFEQ 'C'                        B1
     C           @STDMI    ANDNE'G'
     C           @SDELT    IFEQ *BLANKS                    B2
     C                     SETON                     738927
     C           ' 156'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 156'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C* Deliver to if entered, must be a valid Customer or Shortname
     C                     MOVE *BLANKS   @WDELT  6
     C*
     C           @SDELT    IFNE *BLANKS                    B1
     C                     MOVEL@SDELT    @WK1
     C           @WK1      IFLT '0'                        B2
     C           @WK1      ORGT '9'
     C***********@SDELT    CHAINSDCUSTL6             01                   S01486
     C                     CALL 'AOCUSTR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM @SDELT    P@KEY0 10                       S01486
     C                     PARM           P@KEY7  7                       S01486
     C           SDCUST    PARM SDCUST    DSSDY                           S01486
     C************IN01     IFEQ '1'                        B3             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C           P@KEY7    ORNE '*SHNAME'                                 S01486
     C                     MOVE *BLANKS   WWCNUA
     C**********           MOVE *ZEROS    WWCNUN                                              CSD027
     C                     MOVE *BLANKS   WWCNUN                                              CSD027
     C                     ELSE                            X3
     C                     MOVE BBCUST    WWCNUA
     C                     MOVE BBCUST    WWCNUN
     C                     END                             E3
      *                                                                   S01486
      ** Check for '?' processing.                                        S01486
      *                                                                   S01486
     C           P@RTCD    IFEQ *BLANKS                                   S01486
     C           @SDELT    ANDEQ'?'                                       S01486
     C                     MOVELBBCUST    @SDELT                          S01486
     C                     END                                            S01486
      *                                                                   S01486
     C                     ELSE                            X2
     C                     MOVEL@SDELT    WWCNUA
     C                     MOVEL@SDELT    WWCNUN
     C                     END                             E2
     C*
     C***********WWCNUA    CHAINSDSECSL1             01                   S01486
     C                     CALL 'AOSECSR0'                                S01486
     C                     PARM *BLANKS   P@RTCD                          S01486
     C                     PARM '*KEY'    P@OPTN                          S01486
     C                     PARM WWCNUA    P@KEY6  6                       S01486
     C           SDSECS    PARM SDSECS    DSFDY                           S01486
     C************IN01     IFEQ '1'                        B2             S01486
     C           P@RTCD    IFNE *BLANKS                                   S01486
     C                     SETON                     738927
     C           ' 156'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20                         B4
     C                     MOVEL' 156'    @EA,E
     C                     ADD  1         E
     C                     END                             E4
     C                     END                             E3
     C                     ELSE                            X2
     C                     MOVE BFCUST    @WDELT  6
     C                     END                             E2
     C                     END                             E1
     C*
     C** ERROR IF DELIVER TO IS SAFE CUSTODY OR DISCRETIONARY CUSTOMER
     C           *IN73     IFEQ '0'                        B1
     C           BFCLAS    IFEQ 'S'                        B2
     C           BFCLAS    OREQ 'D'
     C                     SETON                     738927
     C           ' 155'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 155'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C*   ..  Check combinations of clearance type/classification.
     C*
     C           @SCLTY    IFEQ '0'                        B1
     C           @SDELT    ANDNE*BLANKS
     C                     SETON                     738927
     C           ' 157'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 157'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C           @SCLTY    IFEQ '1'                        B1
     C           BFCLAS    ANDNE'E'
     C                     SETON                     738927
     C           ' 158'    LOKUP@EA                      03
     C           E         IFLT 19
     C           *IN03     IFEQ '0'                        B2
     C                     MOVEL' 158'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     MOVE ' 341'    @EA,E
     C                     ADD  1         E
     C                     SETON                     6289
     C                     END                             E1
     C                     END                             E1
     C*
     C           @SCLTY    IFEQ '2'                        B1
     C           @STDTP    IFEQ 'TP'                       B2
     C           BFCLAS    ANDNE'E'
     C                     SETON                     738927
     C           ' 159'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 159'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C           @SCLTY    IFEQ '3'                        B1
     C           BFCLAS    ANDNE'C'
     C                     SETON                     738927
     C           ' 160'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 160'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C           @SCLTY    IFEQ '4'                        B1
     C           @STDTP    IFEQ 'TP'                       B2
     C           BFCLAS    ANDNE'C'
     C                     SETON                     738927
     C           ' 161'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 161'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C           @SCLTY    IFEQ '5'                        B1
     C           BFCLAS    IFEQ 'E'                        B2
     C           BFCLAS    OREQ 'C'
     C                     SETON                     738927
     C           ' 162'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 162'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** OUTPUT A WARNING ERROR IF THE DEPOT REFERENCE IS NOT DEFINED
     C** FOR THE INVESTMENT TYPE OR THERE IS NO SECURITY REFERENCE FOR
     C** THE DEPOT
     C           WWCNUN    IFEQ SDC1                       B1
     C           DASR      ANDNE*BLANKS
     C           WWCNUN    OREQ SDC2
     C           DCSR      ANDNE*BLANKS
     C           WWCNUN    OREQ SDC3
     C           DDSR      ANDNE*BLANKS
     C                     MOVE 'Y'       WWAOK   1
     C                     ELSE                            X1
     C                     SETON                     277389
     C           E         IFLT 20                         B2
     C                     MOVE ' W13'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C***ERROR*IF*DELIVER*FROM*IS*KASSENVEREIN*AND*SETTLEMENT*CURRENCY*   CSE022
     C***IS*NOT*DEM****************************************************   CSE022
     C********** BFCLAS    IFEQ 'K'                        B1             CSE022
     C********** @SSETC    ANDNE'DEM'                                     CSE022
     C**********           SETON                     277389               CSE022
     C********** E         IFLT 20                         B2             CSE022
     C**********           MOVE ' 342'    @EA,E                           CSE022
     C**********           ADD  1         E                               CSE022
     C**********           END                             E2             CSE022
     C**********           END                             E1             CSE022
     C*
     C***  Auto-Settle Indicator
     C***  .. must be 'Y' or'N'
     C*
     C           @SAUTS    IFNE 'Y'                        B1
     C           @SAUTS    ANDNE'N'
     C                     SETON                     7589
     C           ' 168'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 168'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C           @SAUTS    IFEQ 'Y'                        B1
     C           @STDMI    ANDEQ'G'
     C                     SETON                     7589
     C           ' 169'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B2
     C           E         ANDLT20
     C                     MOVEL' 169'    @EA,E
     C                     ADD  1         E
     C                     END                             E2
     C                     END                             E1
     C*
     C* Broker commission
     C*
     C           @STBCC    IFNE *BLANKS                    B1
     C                     MOVE @STBCC    @XCODE
     C                     MOVE NMCYA     @XCCY
     C*
     C           @KEY7     CHAINSECGT                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     7689
     C           ' 193'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 193'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Customer commission
     C*
     C           @STCCC    IFNE *BLANKS                    B1
     C                     MOVE @STCCC    @XCODE
     C                     MOVE NMCYA     @XCCY
     C*
     C           @KEY7     CHAINSECGT                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     7789
     C           ' 193'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 193'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Charge code 1
     C*
     C           @STCC1    IFNE *BLANKS                    B1
     C                     MOVE @STCC1    @XCODE
     C                     MOVE NMCYA     @XCCY
     C*
     C           @KEY7     CHAINSECGT                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     7889
     C           ' 193'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 193'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Charge code 2
     C*
     C           @STCC2    IFNE *BLANKS                    B1
     C                     MOVE @STCC2    @XCODE
     C                     MOVE NMCYA     @XCCY
     C*
     C           @KEY7     CHAINSECGT                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     7989
     C           ' 193'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 193'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Charge code 3
     C*
     C           @STCC3    IFNE *BLANKS                    B1
     C                     MOVE @STCC3    @XCODE
     C                     MOVE NMCYA     @XCCY
     C*
     C           @KEY7     CHAINSECGT                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     8089
     C           ' 193'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 193'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Charge code 4
     C*
     C           @STCC4    IFNE *BLANKS                    B1
     C                     MOVE @STCC4    @XCODE
     C                     MOVE NMCYA     @XCCY
     C*
     C           @KEY7     CHAINSECGT                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     8189
     C           ' 193'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 193'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Charge code 5
     C*
     C           @STCC5    IFNE *BLANKS                    B1
     C                     MOVE @STCC5    @XCODE
     C                     MOVE NMCYA     @XCCY
     C*
     C           @KEY7     CHAINSECGT                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     8289
     C           ' 193'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 193'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Charge code 6
     C*
     C           @STCC6    IFNE *BLANKS                    B1
     C                     MOVE @STCC6    @XCODE
     C                     MOVE NMCYA     @XCCY
     C*
     C           @KEY7     CHAINSECGT                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     8389
     C           ' 193'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 193'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Charge code 7
     C*
     C           @STCC7    IFNE *BLANKS                    B1
     C                     MOVE @STCC7    @XCODE
     C                     MOVE NMCYA     @XCCY
     C*
     C           @KEY7     CHAINSECGT                01
     C           *IN01     IFEQ '1'                        B2
     C           RECI      OREQ '*'
     C                     SETON                     8489
     C           ' 193'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 193'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* BROKER REBATE MUST BE BLANK IF NO BROKER CODE HAS BEEN ENTERED
     C* AND THE TOTAL CHARGES ON THE MARKET SIDE ARE ZERO
     C*
     C           @STBCC    IFEQ *BLANKS                    B1
     C           PCHRG     ANDEQ0
     C*
     C           @SBCMR    IFNE *BLANKS                    B2
     C                     SETON                     8589
     C           ' 200'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 200'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** CUSTOMER REBATE MUST BE BLANK IF NO CUSTOMER COMMISSION CODE
     C** ENTERED
     C           @STCCC    IFEQ *BLANKS                    B1
     C           @SCCMR    ANDNE*BLANKS
     C                     SETON                     8689
     C           ' 201'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 201'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E1
     C*
     C** TAX REBATE MUST BE BLANK IF NO CUSTOMER COMMISSIONS OR CHARGES
     C** ENTERED
     C           @STCCC    IFEQ *BLANKS                    B1
     C           @STCC1    ANDEQ*BLANKS
     C           @STCC2    ANDEQ*BLANKS
     C           @STCC3    ANDEQ*BLANKS
     C           @STCC4    ANDEQ*BLANKS
     C           @STCC5    ANDEQ*BLANKS
     C           @STCC6    ANDEQ*BLANKS
     C           @STCC7    ANDEQ*BLANKS
     C           @STAXA    ANDNE*BLANKS
     C                     SETON                     8789
     C           ' 202'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         ANDLT20
     C                     MOVEL' 202'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E1
     C*
     C* Broker, Customer and Tax rebates must be valid NUMERIC FIELD
     C           *IN85     IFEQ '0'                        B1
     C           @SBCMR    ANDNE*BLANKS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE @SBCMR    ZFIELD
     C                     Z-ADD2         ZADIG
     C                     Z-ADD3         ZADEC
     C                     EXSR ZALIGN
     C           *IN99     IFEQ '1'                        B2
     C                     SETON                     8589
     C           ' 203'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 203'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C*
     C                     ELSE                            X2
     C                     Z-ADD0         ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADD3         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SBCMR
     C                     END                             E2
     C                     END                             E1
     C*
     C           *IN86     IFEQ '0'                        B1
     C           @SCCMR    ANDNE*BLANKS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE @SCCMR    ZFIELD
     C                     Z-ADD2         ZADIG
     C                     Z-ADD3         ZADEC
     C                     EXSR ZALIGN
     C           *IN99     IFEQ '1'                        B2
     C                     SETON                     8689
     C           ' 203'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 204'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C*
     C                     ELSE                            X2
     C                     Z-ADD0         ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADD3         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @SCCMR
     C                     END                             E2
     C                     END                             E2
     C                     END                             E1
     C*
     C           *IN87     IFEQ '0'                        B1
     C           @STAXA    ANDNE*BLANKS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE @STAXA    ZFIELD
     C                     Z-ADD2         ZADIG
     C                     Z-ADD3         ZADEC
     C                     EXSR ZALIGN
     C           *IN99     IFEQ '1'                        B2
     C                     SETON                     8789
     C           ' 203'    LOKUP@EA                      03
     C           *IN03     IFEQ '0'                        B3
     C           E         IFLT 20
     C                     MOVEL' 205'    @EA,E
     C                     ADD  1         E
     C                     END                             E3
     C                     END                             E3
     C*
     C                     ELSE                            X2
     C                     Z-ADD0         ZFLD15
     C                     MOVE ZFIELD    ZFLD15
     C                     Z-ADD3         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @STAXA
     C                     END                             E2
     C                     END                             E1
     C*
     C                     ENDSR
     C*
      ********************************************************************
      /EJECT
     C*******************************************************************
     C*  W001 - Write a record on PMPLTRPD                            *
     C*******************************************************************
     C*
     C           W001      BEGSR
     C*
     C** SET UP UPDATE CONTROL INFORMATION
     C                     MOVE 'D'       OURECI
     C                     Z-ADDXXDAY     OUDLUP
     C                     MOVE XXMNT     OUMLUP
     C                     Z-ADDXXYEAR    OUYLUP
     C                     TIME           OUTLUP
     C                     MOVE @SACTN    OUCHTP
     C                     Z-ADDBJRDNB    OULCD
     C                     Z-ADDNATN      OUTNLU
     C*
     C** MOVE SCREEN FIELDS INTO FILE FIELDS
     C                     MOVE @SBLKR    OUBLKR
     C                     MOVE @SPOCU    OUPCNU
     C                     MOVE @SPOFO    OUPPTF
     C                     MOVE @SINCS    OUTINC
     C                     MOVE @SEREF    OUTDSS
     C                     MOVE @STDTP    OUTDTP
     C                     MOVE @SCLRH    OUCLRH
     C*
     C** FORMAT NOMINAL FOR OUTPUT
     C           @SCLRH    IFEQ *BLANK
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@STOTN    ZFIELD
     C                     Z-ADDNMDP      ZADEC
     C           11        SUB  NMDP      ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUTNOM
     C                     ELSE
     C                     MOVE WWPOOL    OUTNOM
     C                     END
     C*
     C** FORMAT PRICE/DISCOUNT/YIELD FOR OUTPUT
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@STPDY    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     Z-ADD7         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUTPDY
     C*
     C** CONVERT DATE TO A DAY NUMBER
     C                     MOVE @STDVD    ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    OUTDVD
     C*
     C                     MOVE @SBRCD    OUTDBR
     C                     MOVE @SDPBK    OUTDBK
      *                                                                   CAC005
      ** Convert screen fields book & book profit centre into pseudo book.CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD                           CAC005
     C                     PARM '*PSEUDO' POPTN                           CAC005
     C                     PARM @SDPBK    PMBKCD                          CAC005
     C                     PARM @SPRFC    PMPRFC                          CAC005
     C           PMPSBK    PARM *BLANKS   PMPSBK                          CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMPSBK    OUTDBK                          CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
     C*
     C** CONVERT DATE TO A DAY NUMBER
     C                     MOVE @STDDT    ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    OUTDDT
     C*
     C                     MOVE @STSUB    OUTSUB
     C                     MOVE @SLKRF    OULKRF
     C                     MOVE @STDMI    OUTDMI
     C                     MOVE @STDNR    OUTDNR
     C                     MOVE @STDID    OUTDID
     C                     MOVE @SAIIP    OUAIIP
     C                     MOVE @SMRKT    OUTMKC
     C                     MOVE @SCPCY    OUTCAP
     C                     MOVE @SACIN    OUACIN
     C*
     C** FORMAT NUMBER OF DAYS ADJUSTMENT FOR OUTPUT
     C           @SDADJ    IFNE *BLANKS                    B1
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVEL@SDADJ    ZFLD17
     C                     Z-ADD3         ZSDIG
     C                     Z-ADD0         ZSDEC
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    OUDADJ
     C           ZFSIGN    IFEQ '-'                        B2
     C                     Z-SUBOUDADJ    OUDADJ
     C                     END                             E2
     C                     ELSE                            X1
     C                     Z-ADD*ZEROS    OUDADJ
     C                     END                             E1
     C*
     C                     MOVE @SACTD    OUADIN
     C*
     C** FORMAT PRICE/DISCOUNT/YIELD FOR OUTPUT
     C                     Z-ADD0         OUTPDY
     C           @STPDY    IFNE *BLANKS                    B1
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@STPDY    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     Z-ADD7         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUTPDY
     C                     END                             E1
     C*
     C** FORMAT PRICE/DISCOUNT/YIELD FOR OUTPUT
     C                     Z-ADD0         OUPRIC
     C           @SPRIC    IFNE *BLANKS                    B1
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@SPRIC    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     Z-ADD7         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUPRIC
     C                     ELSE                            X1
     C*
     C** CALCULATE THE SECURITY PRICE FROM THE PRICE/DISCOUNT/YIELD
     C** DETAILS PASSED FROM CALLING PROGRAM
     C           STBS      IFEQ 'Y'                        B2
     C           STBS      OREQ 'D'
     C                     Z-ADDOUTPDY    ZPRCIN
     C                     MOVE OUTDVD    ZFDATE
     C                     EXSR ZPRCI
     C                     Z-ADDZPRCOT    OUPRIC
     C                     ELSE                            X2
     C                     Z-ADDOUTPDY    OUPRIC
     C                     END                             E2
     C                     END                             E1
     C*
     C                     MOVE @SEXDV    OUEXDV
     C*
     C** FORMAT REALLOWANCE FOR OUTPUT
     C                     Z-ADD0         OURALL
     C           @SRALL    IFNE *BLANKS                    B1
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVEL@SRALL    ZFLD17
     C                     Z-ADD5         ZSDEC
     C                     Z-ADD4         ZSDIG
     C                     EXSR ZASIGN
     C***********          MOVE ZFIELD    OURALL                          118852
     C                     MOVE ZOUT15    OURALL                          118852
     C*
     C           ZFSIGN    IFEQ '-'                        B2
     C                     Z-SUBOURALL    OURALL
     C                     END                             E2
     C*
     C                     END                             E1
     C*
     C                     MOVE @SSETC    OUSETC
     C*
     C** FORMAT SETTLEMENT EXCHANGE RATE FOR OUTPUT
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@SRATE    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     Z-ADD5         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUTDER
     C*
     C                     MOVE @SSMDI    OUTMDI
     C*
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@SBRTE    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     Z-ADD5         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUTBCR
     C*
     C                     MOVE @SCLTY    OUCLTY
     C                     MOVE @WDELT    OUDELT
     C                     MOVE @WDELF    OUDELF
     C                     MOVE @STBCC    OUTBCC
     C                     MOVE @STCCC    OUTCCC
     C                     MOVE @STCC1    OUTCC1
     C                     MOVE @STCC2    OUTCC2
     C                     MOVE @STCC3    OUTCC3
     C                     MOVE @STCC4    OUTCC4
     C                     MOVE @STCC5    OUTCC5
     C                     MOVE @STCC6    OUTCC6
     C                     MOVE @STCC7    OUTCC7
     C*
     C** SET UP REBATE PERCENTAGES
     C                     Z-ADD0         OUBCMR
     C           @SBCMR    IFNE *BLANKS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@SBCMR    ZFIELD
     C                     Z-ADD3         ZADEC
     C                     Z-ADD2         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUBCMR
     C                     END
     C*
     C                     Z-ADD0         OUCCMR
     C           @SCCMR    IFNE *BLANKS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@SCCMR    ZFIELD
     C                     Z-ADD3         ZADEC
     C                     Z-ADD2         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUCCMR
     C                     END
     C*
     C                     Z-ADD0         OUTXRB
     C           @STAXA    IFNE *BLANKS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@STAXA    ZFIELD
     C                     Z-ADD3         ZADEC
     C                     Z-ADD2         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUTXRB
     C                     END
     C*
     C                     MOVE @SAUTS    OUAUTS
     C                     MOVE @SAGET    OUATRD
     C                     Z-ADDPCHRG     OUMCHG
     C                     MOVE PNTOT     OUMTNO
     C*
     C** IF DEAL IS COMPLETE ALLOCATE RECORD
     C           OUTINC    IFEQ 'C'
     C                     MOVE @JOB      OUJOB
     C                     ELSE
     C                     MOVE *BLANKS   OUJOB
     C                     END
     C*
     C** SET BEFORE UPDATE DETAILS TO BLANK/ZERO
     C                     MOVE *BLANKS   OBLKRF
     C                     MOVE *BLANKS   OBTDNR
     C                     MOVE *BLANKS   OBTDID
     C                     MOVE *BLANKS   OBAIIP
     C                     MOVE *BLANKS   OBTMKC
     C                     Z-ADD0         OBTCAP
     C                     MOVE *BLANKS   OBSETC
     C                     Z-ADD0         OBTDER
     C                     MOVE *BLANKS   OBTMDI
     C                     Z-ADD0         OBTBCR
     C**********           Z-ADD0         OBDELT                                              CSD027
     C**********           Z-ADD0         OBDELF                                              CSD027
     C                     MOVE *BLANKS   OBDELT                                              CSD027
     C                     MOVE *BLANKS   OBDELF                                              CSD027
     C                     MOVE *BLANKS   OBAUTS
     C*                                                                   CAC003
     C** Initialise fields                                                CAC003
     C                     Z-ADD0         OUFXMP                          CAC003
     C                     Z-ADD0         OUFXMR                          CAC003
     C                     Z-ADD0         OBFXMP                          CAC003
     C                     Z-ADD0         OBFXMR                          CAC003
     C*                                                                   CAC003
     C           *IN30     IFEQ '1'                                       CAC003
     C           @SSETC    ANDNENMCYA                                     CAC003
     C                     MOVE *BLANKS   ZFIELD                          CAC003
     C                     MOVEL@SSPTS    ZFIELD                          CAC003
     C                     Z-ADD2         ZADEC                           CAC003
     C                     Z-ADD5         ZADIG                           CAC003
     C                     EXSR ZALIGN                                    CAC003
     C                     MOVE ZFIELD    OUFXMP                          CAC003
     C                     MOVE WWFXMR    OUFXMR                          CAC003
     C*                                                                   CAC003
     C           OUTDTP    IFEQ 'TP'                                      CAC003
     C           OUTMDI    ANDEQ'M'                                       CAC003
     C           OUTDTP    OREQ 'TS'                                      CAC003
     C           OUTMDI    ANDEQ'D'                                       CAC003
     C                     SUB  OUFXMR    OUTDER                          CAC003
     C                     ELSE                                           CAC003
     C                     ADD  OUFXMR    OUTDER                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
     C*******************************************************************
     C*  W002 - UPDATE AMENDED RECORD DETAILS ON PMPLTRPD             *
     C*******************************************************************
     C*
     C           W002      BEGSR
     C*
     C** SET UP UPDATE CONTROL INFORMATION
     C                     Z-ADDXXDAY     OUDLUP
     C                     MOVE XXMNT     OUMLUP
     C                     Z-ADDXXYEAR    OUYLUP
     C                     TIME           OUTLUP
     C                     Z-ADDBJRDNB    OULCD
     C                     Z-ADDNATN      OUTNLU
     C*
     C** IF INCOMPLETE INDICATOR CHANGED 'I' TO 'C' TREAT AS INSERT
     C           OUTINC    IFEQ @SINCS
     C                     MOVE 'A'       OUCHTP
     C                     ELSE
     C                     MOVE 'I'       OUCHTP
     C                     END
     C*
     C** SETUP BEFORE UPDATE DETAIL FIELDS
     C                     MOVE OULKRF    OBLKRF
     C                     MOVE OUTDNR    OBTDNR
     C                     MOVE OUTDID    OBTDID
     C                     MOVE OUAIIP    OBAIIP
     C                     MOVE OUTMKC    OBTMKC
     C                     MOVE OUTCAP    OBTCAP
     C                     MOVE OUSETC    OBSETC
     C                     Z-ADDOUTDER    OBTDER
     C                     MOVE OUTMDI    OBTMDI
     C                     MOVE OUTBCR    OBTBCR
     C                     MOVE OUDELT    OBDELT
     C                     MOVE OUDELF    OBDELF
     C                     MOVE OUAUTS    OBAUTS
     C*
     C** UPDATE AMENDED SCREEN FIELDS
     C                     MOVE @SLKRF    OULKRF
     C                     MOVE @STDNR    OUTDNR
     C                     MOVE @STDID    OUTDID
     C                     MOVE @SAIIP    OUAIIP
     C                     MOVE @SMRKT    OUTMKC
     C                     MOVE @SCPCY    OUTCAP
     C                     MOVE @SINCS    OUTINC
     C                     MOVE @SSETC    OUSETC
     C*
     C** FORMAT SETTLEMENT EXCHANGE RATE FOR OUTPUT
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@SRATE    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     Z-ADD5         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUTDER
     C*
     C                     MOVE @SSMDI    OUTMDI
     C*
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVEL@SBRTE    ZFIELD
     C                     Z-ADD8         ZADEC
     C                     Z-ADD5         ZADIG
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    OUTBCR
     C*
     C                     MOVE @SCLTY    OUCLTY
     C                     MOVE @WDELT    OUDELT
     C                     MOVE @WDELF    OUDELF
     C*
     C** IF DEAL IS COMPLETE ALLOCATE RECORD
     C           OUTINC    IFEQ 'C'
     C                     MOVE @JOB      OUJOB
     C                     ELSE
     C                     MOVE *BLANKS   OUJOB
     C                     END
     C*                                                                   CAC003
     C** Update Margin Points and Margin Rate                             CAC003
     C*                                                                   CAC003
     C                     MOVE OUFXMP    OBFXMP                          CAC003
     C                     MOVE OUFXMR    OBFXMR                          CAC003
     C*                                                                   CAC003
     C** Initialize fields                                                CAC003
     C*                                                                   CAC003
     C                     Z-ADD0         OUFXMP                          CAC003
     C                     Z-ADD0         OUFXMR                          CAC003
     C*                                                                   CAC003
     C** Determine value of OUTDER                                        CAC003
     C*                                                                   CAC003
     C           *IN30     IFEQ '1'                                       CAC003
     C           @SSETC    ANDNENMCYA                                     CAC003
     C*                                                                   CAC003
     C                     MOVE *BLANKS   ZFIELD                          CAC003
     C                     MOVE @SSPTS    ZFIELD                          CAC003
     C                     Z-ADD2         ZADEC                           CAC003
     C                     Z-ADD5         ZADIG                           CAC003
     C                     EXSR ZALIGN                                    CAC003
     C                     MOVE ZFIELD    OUFXMP                          CAC003
     C                     MOVE WWFXMR    OUFXMR                          CAC003
     C*                                                                   CAC003
     C           OUTDTP    IFEQ 'TP'                                      CAC003
     C           OUTMDI    ANDEQ'M'                                       CAC003
     C           OUTDTP    OREQ 'TS'                                      CAC003
     C           OUTMDI    ANDEQ'D'                                       CAC003
     C                     SUB  OUFXMR    OUTDER                          CAC003
     C                     ELSE                                           CAC003
     C                     ADD  OUFXMR    OUTDER                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*
     C                     ENDSR
     C*
      ********************************************************************
      /EJECT
     C*******************************************************************
     C*  SUB300 - CALCULATE NEW EX-DIVIDEND INDICATOR                 *
     C*******************************************************************
     C*
     C           SUB300    BEGSR
     C*
     C* Must access diary events via ZNDD, then use ex-date from diary.
     C                     MOVEL'C'       @WEXDV  1
     C                     Z-ADDWWTDDT    ECD
     C                     EXSR ZNDD
     C*
     C           NDD       IFNE *ZEROS                     B1
     C                     Z-ADD0         ZDYNBR
     C******************************************************************  S01486
     C**CHECK*WHETHER*THIS*CORRESPONDS*TO*A*DIARY*EVENT*AND*IF*SO*USE***  S01486
     C**EX-DATE*FROM*EVENT*********************************************). S01486
     C***********          MOVE @PSESN    WWSDSN 10                       S01486
     C***********          MOVE 'DV'      WWSDET  2                       S01486
     C***********          Z-ADDNDD       WWSDED  50                      S01486
     C***********                                                         S01486
     C***********@KEY4     CHAINSECET                01                   S01486
     C***********                                                         S01486
     C************IN01     IFEQ '0'                        B2             S01486
     C***********RECI      ANDEQ'D'                                       S01486
     C***********          Z-ADDSDXD      ZDYNBR                          S01486
     C***********          ELSE                            X2             S01486
     C* Otherwise, calculate ex-date using default days from security.
     C                     MOVELEDFT      ZNRDYS
     C           ZNRDYS    IFNE *ZEROS                     B3
     C                     MOVE EDFT      @WEDFT  1
     C           @WEDFT    IFEQ 'W'                        B4
     C                     Z-ADDNDD       ZDAYNO
     C                     MOVE VLCY      ZCCY
     C***********          EXSR XDAT3A                                    S01486
     C                     MOVE *BLANKS   ZLOC                            S01486
     C                     EXSR ZBKDT                                     S01486
     C                     ELSE                            X4
     C           NDD       SUB  ZNRDYS    ZDYNBR
     C                     END                             E4
     C                     END                             E3
     C***********          END                             E2             S01486
     C* Note: Swiss dividends are based on TRADE DATE positions.
     C           WWTDDT    IFLT NDD                        B2
     C           WWTDDT    ANDGEZDYNBR
     C           ZDYNBR    ANDNE0
     C                     MOVEL'X'       @WEXDV
     C                     END                             E2
     C*
     C                     END                             E1
     C*
     C                     ENDSR
1107 C********************************************************************S01486
     C/EJECT                                                              S01496
     C*****************************************************************   S01496
     C*                                                               *   S01496
     C*  SUB4A - Determine Highest priority for customer charges      *   S01496
     C*                                                               *   S01496
     C*  Called By : P002                                             *   S01496
     C*  Calls     : NONE                                             *   S01496
     C*                                                               *   S01496
     C*****************************************************************   S01496
     C*                                                                   S01496
     C           SUB4A     BEGSR                           *** SUB4A   ***S01496
     C*                                                                   S01496
     C                     MOVEL'N'       CHANGE  1                       S01496
     C           PCSD      IFGT PIDF                                      S01496
     C           PCSD      ANDGTPMDF                                      S01496
     C           PCSD      ANDGTPOCD                                      S01496
     C                     MOVE *BLANKS   @KCLGR                          S01496
     C                     Z-ADD0         PCSD                            S01496
     C                     MOVEL'Y'       CHANGE  1                       S01496
     C                     ELSE                                           S01496
     C*                                                                   S01496
     C           PIDF      IFGT PCSD                                      S01496
     C           PIDF      ANDGTPMDF                                      S01496
     C           PIDF      ANDGTPOCD                                      S01496
     C                     MOVE *BLANKS   @KSITP                          S01496
     C                     Z-ADD0         PIDF                            S01496
     C                     MOVEL'Y'       CHANGE  1                       S01496
     C                     ELSE                                           S01496
     C*                                                                   S01496
     C           PMDF      IFGT PIDF                                      S01496
     C           PMDF      ANDGTPCSD                                      S01496
     C           PMDF      ANDGTPOCD                                      S01496
     C                     MOVE *BLANKS   @KMRKT                          S01496
     C                     Z-ADD0         PMDF                            S01496
     C                     MOVEL'Y'       CHANGE  1                       S01496
     C                     ELSE                                           S01496
     C*                                                                   S01496
     C           POCD      IFGT PCSD                                      S01496
     C           POCD      ANDGTPMDF                                      S01496
     C           POCD      ANDGTPIDF                                      S01496
     C                     MOVE *BLANKS   @KCNUM                          S01496
     C                     Z-ADD0         POCD                            S01496
     C                     MOVEL'Y'       CHANGE  1                       S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C           CHANGE    IFNE 'Y'                                       S01496
     C*                                                                   S01496
     C           PCSD      IFEQ PIDF                                      S01496
     C           PCSD      OREQ PMDF                                      S01496
     C           PCSD      OREQ POCD                                      S01496
     C*                                                                   S01496
     C           PCSD      IFEQ PIDF                                      S01496
     C                     MOVE *BLANKS   @KSITP                          S01496
     C                     Z-ADD0         PIDF                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C           PCSD      IFEQ PMDF                                      S01496
     C                     MOVE *BLANKS   @KMRKT                          S01496
     C                     Z-ADD0         PMDF                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C           PCSD      IFEQ POCD                                      S01496
     C                     MOVE *BLANKS   @KCNUM                          S01496
     C                     Z-ADD0         POCD                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     MOVE *BLANKS   @KCLGR                          S01496
     C                     Z-ADD0         PCSD                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C           PIDF      IFEQ PMDF                                      S01496
     C           PIDF      OREQ POCD                                      S01496
     C*                                                                   S01496
     C           PIDF      IFEQ PMDF                                      S01496
     C                     MOVE *BLANKS   @KMRKT                          S01496
     C                     Z-ADD0         PMDF                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C           PIDF      IFEQ POCD                                      S01496
     C                     MOVE *BLANKS   @KCNUM                          S01496
     C                     Z-ADD0         POCD                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     MOVE *BLANKS   @KSITP                          S01496
     C                     Z-ADD0         PIDF                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C           PMDF      IFEQ POCD                                      S01496
     C                     MOVE *BLANKS   @KCNUM                          S01496
     C                     Z-ADD0         POCD                            S01496
     C                     MOVE *BLANKS   @KMRKT                          S01496
     C                     Z-ADD0         PMDF                            S01496
     C                     END                                            S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     ENDSR                                          S01496
     C*                                                                   S01496
     C*****************************************************************   S01496
     C/EJECT                                                              S01496
1108 C***********                                                         S01486
1109 C*****XDAT3A SR. TO CALCULATE ANY NUMBER OF WORKING                  S01486
1110 C***********     DAYS BACK IN ANY CURRENCY.                          S01486
1111 C***********                                                         S01486
1112 C*********THIS SR. CAN BE USED WHEN THE INPUT CYCLE IS RUNNING AS    S01486
1113 C*********HOLIDAY RECORDS ARE ACCESSED BY CHAIN. THEREFORE NEWLY     S01486
1114 C*********ADDED RECORDS IN THE OVERFLOW AREA CAN ALSO BE ACCESSED.   S01486
1115 C***********                                                         S01486
1116 C***********XDAT3A    BEGSR                           *** ZDATE3 *** S01486
1117 C***********                                                         S01486
1118 C*****CALCULATIONS TO DEFINE INPUT FIELDS.                           S01486
1119 C***********          Z-ADDZDAYNO    ZDAYNO  50       STARTING DATE  S01486
1120 C***********          MOVE ZCCY      ZCCY    3        DATE CURRENCY  S01486
1121 C***********          Z-ADDZNRDYS    ZNRDYS  20       NBR OF WORKING S01486
1122 C***********                                          DAYS BACK      S01486
1123 C*****CLEAR*COUNT OF NBR OF DAYS SUBTRACTED, & DEFINE ZDYNBR.        S01486
1124 C***********          Z-ADD0         ZDCNT   20                      S01486
1125 C***********          Z-ADDZDAYNO    ZDYNBR  50                      S01486
1126 C***********                                                         S01486
1127 C*****LOOP*TO DECREMENT DAY NUMBER AND CHECK FOR HOLIDAY.            S01486
1128 C***********XDLOP1    TAG                             ** ZDLOP1 TAG *S01486
1129 C***********                                                         S01486
1130 C***********          SETOF                     9596                 S01486
1131 C***********ZDYNBR    SUB  1         ZDYNBR                          S01486
1132 C***********                                                         S01486
1133 C*****SET*KEY FOR FIRST HOLIDAY RECORD.                              S01486
1134 C***********          MOVEL'22    '  ZDHKEY 12                       S01486
1135 C***********          MOVELZDYNBR    ZWRK6   6                       S01486
1136 C***********          MOVE '1'       ZWRK6                           S01486
1137 C***********          MOVE ZWRK6     ZDHKEY                          S01486
1138 C***********                                                         S01486
1139 C*****CHAIN*FOR HOLIDAY RECORD, RECORD 1 OR 2                        S01486
1140 C***********XDHCHN    TAG                             ** ZDHCHN TAG *S01486
1141 C***********                                                         S01486
     C***********          MOVEA*BLANKS   XCCY                            S01486
1142 C***********ZDHKEY    CHAINTABSE                90    ON NOT THERE   S01486
     C**N90******          MOVEAHCCY      XCCY                            S01486
1143 C**N90******RECI      COMP 'D'                  9090  DELETED        S01486
1144 C***********                                                         S01486
1145 C*****NO*RECORD 1 FOUND, IS NOT A HOLIDAY                            S01486
1146 C***90N95***          GOTO XDOAGN                                    S01486
1147 C***********                                                         S01486
1148 C*****NO*RECORD 2 FOUND                                              S01486
1149 C***90*95*96          GOTO XDLOP1                     EXC. NOT FOUND S01486
1150 C***90*95N96          GOTO XDOAGN                     INC. NOT FOUND S01486
1151 C***********                                                         S01486
1152 C*****DETERMINE TYPE FOUND, INCLUDE OR EXCLUDE                       S01486
1153 C***********INEX      COMP 'E'                  92  91               S01486
1154 C***********                                                         S01486
1155 C*****CHECK*IF DAY IS HOLIDAY FOR CURRENCY.                          S01486
1156 C***********ZCCY      LOKUPXCCY                     93               S01486
1157 C***91*93***          GOTO XDOAGN                     EXCLUDE FOUND  S01486
1158 C***92*93***          GOTO XDLOP1                     INCLUDE FOUND  S01486
1159 C***********                                                         S01486
1160 C*****IF*EXCLUDE OR INCLUDE NOT FOUND CHECK                          S01486
1161 C*****FOR*SECOND HOLIDAY RECORD, IF REQUIRED.                        S01486
1162 C***********'   '     LOKUPXCCY                     94ON IF NO RCD.2 S01486
1163 C***********          MOVE ZDHKEY    ZWRK1   1                       S01486
1164 C***********ZWRK1     COMP '1'                      95               S01486
1165 C***91*95***          SETON                     96                   S01486
1166 C***95N94***          MOVE '2'       ZDHKEY                          S01486
1167 C***95N94***          GOTO XDHCHN                     GET SECOND REC S01486
1168 C***********                                                         S01486
1169 C***91******          GOTO XDLOP1                     EXC. NOT FOUND S01486
1170 C***92******          GOTO XDOAGN                     INC. NOT FOUND S01486
1171 C***********                                                         S01486
1172 C*****INCREMENT COUNT AND CHECK IF REQUIRED NUMBER OF DAYS           S01486
1173 C*****HAS*BEEN SUBTRACTED. IF NOT, GO THROUGH LOOP1 AGAIN.           S01486
1174 C***********XDOAGN    TAG                             ** ZDOAGN TAG *S01486
1175 C***********                                                         S01486
1176 C***********ZDCNT     ADD  1         ZDCNT                           S01486
1177 C***********ZDCNT     COMP ZNRDYS                 97                 S01486
1178 C***97******          GOTO XDLOP1                                    S01486
1179 C***********                                                         S01486
1180 C***********          ENDSR                                          S01486
1181 C***********                                                         S01486
1182 C***********                                                         S01486
1183 C********************************************************************S01486
      ********************************************************************
      /EJECT
     C*******************************************************************
     C*****************************************************************   CAC003
     C*                                                               *   CAC003
     C*  Subroutine  :  SRNQDP                                        *   CAC003
     C*  Function    :  Get Normally-Quoted Decimal Places            *   CAC003
     C*                                                               *   CAC003
     C*  Called by   :  D3VALD - Validate Screen 3 Data Entry         *   CAC003
     C*  Calls       :  -                                             *   CAC003
     C*                                                               *   CAC003
     C*****************************************************************   CAC003
     C*                                                                   CAC003
     C           SRNQDP    BEGSR                           ** SRNQDP **   CAC003
     C*                                                                   CAC003
     C** --------------------------------------------------------------   CAC003
     C**  If either the nominal or settlement currency is the base        CAC003
     C**  currency obtain the number of normally-quoted decimal places    CAC003
     C**  for the other currency. Otherwise:                              CAC003
     C**      A)  If ZNQDP1 =  ZNQDP2 =  5       :   ZNQDPX = 5           CAC003
     C**      B)  If ZNQDP1 =  ZNQDP2 <> 5  or                            CAC003
     C**             ZNQDP1 <> ZNQDP2                                     CAC003
     C**             1)  If Rate >= 100          :   ZNQDPX = 2           CAC003
     C**             2)  If 100 > Rate >= 20     :   ZNQDPX = 3           CAC003
     C**             3)  If 20  > Rate >= 1      :   ZNQDPX = 4           CAC003
     C**             4)  If 1   > Rate           :   ZNQDPX = 5           CAC003
     C**---------------------------------------------------------------   CAC003
     C*                                                                   CAC003
     C                     SELEC                                          CAC003
     C*                                                                   CAC003
     C           NMCYA     WHEQ BJCYCD                                    CAC003
     C                     Z-ADDZNQDP2    ZNQDPX                          CAC003
     C*                                                                   CAC003
     C           @SSETC    WHEQ BJCYCD                                    CAC003
     C                     Z-ADDZNQDP1    ZNQDPX                          CAC003
     C*                                                                   CAC003
     C           ZNQDP1    WHEQ ZNQDP2                                    CAC003
     C           ZNQDP1    ANDEQ5                                         CAC003
     C                     Z-ADD5         ZNQDPX                          CAC003
     C*                                                                   CAC003
     C           WWRATE    WHGE 100                                       CAC003
     C                     Z-ADD2         ZNQDPX                          CAC003
     C*                                                                   CAC003
     C           WWRATE    WHLT 100                                       CAC003
     C           WWRATE    ANDGE20                                        CAC003
     C                     Z-ADD3         ZNQDPX                          CAC003
     C*                                                                   CAC003
     C           WWRATE    WHLT 20                                        CAC003
     C           WWRATE    ANDGE1                                         CAC003
     C                     Z-ADD4         ZNQDPX                          CAC003
     C*                                                                   CAC003
     C           WWRATE    WHLT 1                                         CAC003
     C                     Z-ADD5         ZNQDPX                          CAC003
     C*                                                                   CAC003
     C                     ENDSL                                          CAC003
     C*                                                                   CAC003
     C                     ENDSR                                          CAC003
     C*                                                                   CAC003
     C*****************************************************************   CAC003
     C/EJECT                                                              CAC003
     C*****************************************************************   CAC003
     C*  *PSSR - HANDLE ABNORMAL TERMINATION                            *
     C*******************************************************************
     C*
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C                     MOVEL@DBALL    @DBSAV
     C           *LOCK     IN   LDA
     C                     MOVEL@DBSAV    @DBALL
     C****                 MOVEL'PM5100'  @DBPGM                          58886
     C                     MOVEL'SE5200'  @DBPGM                          58886
     C                     OUT  LDA
     C                     SETON                     U7U8LR
     C                     MOVE ' *'      @PCMDK
     C                     RETRN
     C*
     C                     ENDSR
     C*
      /EJECT
     C/COPY ZSRSRC,ZCCYCN
      /EJECT
     C/COPY ZSRSRC,ZCCYXR
      /EJECT
     C/COPY ZSRSRC,ZSEDITZ3
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z2
      /EJECT
     C**********/COPY ZSRSRC,ZDATE3Z4                                     S01486
      /EJECT
     C***********/COPY ZSRSRC,ZDATE5Z2                                    S01486
      /EJECT
     C/COPY ZSRSRC,ZNCDZ3
      /EJECT
     C/COPY ZSRSRC,ZALIGNZ2
      /EJECT
     C/COPY ZSRSRC,ZPRCIZ1
      /EJECT
     C/COPY ZSRSRC,ZASIGNZ2
      /EJECT
     C/COPY ZSRSRC,ZTNLU1Z2
      /EJECT
     C/COPY ZSRSRC,ZDAYSZ2
      /EJECT
     C/COPY ZSRSRC,ZDYYRZ3
      /EJECT
     C/COPY ZSRSRC,ZNDDZ1
      /EJECT
     C/COPY ZSRSRC,ZYLDIZ1
      /EJECT
     C/COPY ZSRSRC,ZYLDZ2
      /EJECT
     C/COPY ZSRSRC,ZLCDZ1
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZACCH                                                  S01486
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZBKDT                                                  S01486
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZCHKH                                                  S01486
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZFWDT                                                  S01486
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZACCZZ1                                                S01486
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZCNSDZ1                                                S01486
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZCALCD                                                 S01486
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZACCRZ1                                                S01486
      /EJECT                                                              S01486
     C/COPY ZSRSRC,ZRATEZ1                                                S01486
      /EJECT                                                              S01486
     O********** LINE CHANGED IN @TX                                      091221
     O********** (''xxxxxxxxxx'' ''xxxxxx'')')   MSGQ(MOPERQ)             091221
     O********** RTGDTA(*NONE) INLLIBL(*JOBD)                             091221
**  @TX - Large text strings
F3=End   F12=Initial Screen   Enter   Help
F3=End   F9=Market Trade   F12=Initial Screen   Enter   Help
Not authorised for this trade
SBMJOB JOB(BTnnnnnnx) JOBD(BULKTJOBD) USER(*JOBD) RQSDTA('CALL PGM(SEC5210) PARM              CPK014
(''xxxxxxxxxx'' ''xxxxxx'' ''     '' ''S'' ''   '')')
MSGQ(MOPERQ) RTGDTA(*NONE) INLLIBL(*JOBD) OUTQ(*JOBD)                                         CSC023
SNDMSG MSG(MIDAS) TOMSGQ(MSTATUS)
** CPY@
(c) Misys International Banking Systems Ltd. 2001
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  AP - Array of Powers of Ten for Currency Conversion                   CAC003
0000000001                                                                CAC003
0000000010                                                                CAC003
0000000100                                                                CAC003
0000001000                                                                CAC003
0000010000                                                                CAC003
0000100000                                                                CAC003
0001000000                                                                CAC003
0010000000                                                                CAC003
0100000000                                                                CAC003
1000000000                                                                CAC003
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
