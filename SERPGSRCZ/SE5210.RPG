     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Pool trades generation flow summary')         *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Securities Trading Module.                           *
     F*                                                               *
     F*  SE5210 - Generate Pool Portfolio Trades                      *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. AR1075401          Date 01Jun20               *
      *  Prev Amend No. 248698             Date 01Jun20               *            
      *                 MD046248           Date 27Oct17               *
      *                 226449             Date 24Jun15               *
      *                 CER059             Date 19Jul10               *
      *                 BUG23967           Date 13May09               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      *                 CAP205             Date 16Mar10               *
      *                 CAP204             Date 09Feb10               *
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 234300             Date 29Sep06               *
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE065             Date 08Nov04               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 194370             Date 12Jul01               *
      *                 CAS006             Date 21Jan03               *
      *                 211407             Date 07Jan03               *
      *                 180056             Date 18Oct00               *
      *                 CSE035             Date 22Apr02               *
      *                 206316             Date 19Jul02               *
      *                 CRE009             Date 05Sep02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CSE031             Date 09Nov01               *
      *                 180707             Date 25Jul00               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 171874             Date 26Jun01               *
      *                 CSE022             Date 29Mar01               *
      * Midas DBA 3.04 -----------------------------------------------*
      *                 CSE023             Date 12Jul00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 179732             Date 21Jun00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CAC005             Date 02Dec98               *
      *                 130862             Date 18Oct98               *
      *                 151945             Date 06Jan99               *
      *                 CSE005             Date 04Feb97               *
      *                 119556             Date 20Jun97               *
     F*                 118892             Date 05Jun97               *
     F*                 CAC003             Date 25Feb97               *
     F*                 119374             Date 17Jun97               *
     F*                 CCB002             DATE 22AUG96               *
     F*                 100017             DATE 18APR96               *
     F*                 092961             DATE 04OCT95               *
     F*                 091222             DATE 31JUL95               *
     F*                 086491             DATE 15JUN95               *
     F*                 087591             DATE 15MAY95               *
     F*                 S01486 MD          DATE 28OCT94               *
     F*                 054694             DATE 09AUG93               *
     F*                 058886             DATE 19JUL93               *
     F*                 S01313             DATE 19MAY92               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  AR1075401 - Increase QANOML and QAOTNM length in PMCPOSPD.   *
      *              Recompiled. (Child: AR1075402)                   *
      *  248698 - Rounding discrepancies on some SE reports. Applied  *
      *           fix 228682.                                         *
      *  228682 - Recompiled due to ZCNSDZ1 changes. Applied 176594.  *           
      *  MD046248 - Finastra Rebranding                               *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  BUG23967 - Add Local Industry Code Field. (Recompile)        *
      *  CAP205 - Teller Related APIs - Account Balance Check         *
      *  CAP204 - Teller Related APIs - Account Transfer (Recompile)  *
      *  234300 - Recompiled over changed in PF/HSTTRD.               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE065 - Const. Yield Amort. on Mortgage backed assets       *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  194370 - Recompile after change on copy sources ZYLDZ2,      *
      *           For securities with divisor basis = '5' and first   *
      *           coupon date > valuation date (rundate + 1), set     *
      *           event control date to first coupon date before      *
      *           processing SR/ZDYYR. This is to ensure that the     *
      *           correct hypothetical last and next coupon dates are *
      *           used in deriving the price/yield rate.              *
      *  CAS006 - Hedge Accounting Phase B                            *
      *  211407 - Recompile after change on copy sources ZYLDZ2,      *
      *           ZACCRZ1 and ZYCEZ1 for NX/NNX processing.           *
      *           The change was to call subroutine ZLCD1 instead     *
      *           of ZLCD in retrieving the PERIOD for NNX processing *
      *           and ZNCD1 is called instead of ZNCD in retrieving   *
      *           the WBENCD for NNX processing. Also rewrite tests   *
      *           for identifying if position is NX,NNX or CUM.       *
      *  180056 - Recompiled over changed in ZDYYRZ3.                 *
      *  CSE035 - NX/NNX Coupon Payment Processing.                   *
      *           Recompile over changed ZACCRZ1
     F*  206316 - Recompiled over changed ZLCDZ1.                     *
     F*  CRE009 - Projected Account Movements for Retail Accounts     *
     F*  CSE031 - Coupon Fixing for Floating Rate Notes.              *
     F*           (recompilation due to change to ZNCD/ZLCD)          *
     F*  180707 - No Position Settlements generated. Recompile over   *
     F*           changes in /COPY ZNCDZ3.                            *
      *  171874 - ZAINSH changes - only recompile                     *
      *  CSE022 - Depository Definition Enhancement (Recompile)       *
      *  CSE023 - Treaty Withholding Tax (Recompiled)                 *
      *  179732 - Addition of Account Officer to AOPRFMR0 call.       *
      *  CAC005 - PCA-SE Enhancement.                                 *
     F*  130862 - Recompiled over ZLCDZ1 & ZDAYSZ2 changes.           *
     F*  151945 - Recompiled Over changed ZDYYRZ3 .                   *
     F*  CSE005 - Effect of holidays on FRN Coupon Dates              *
     F*           (recompilation due to change to ZNCD/ZLCD)          *
     F*  119556 - Originating Branch is blank for Pool Trades.        *
     F*  118892 - Countervalue is short by two decimal places in      *
     F*           Pool trades.                                        *
     F*  CAC003 - Profit Centre Accounting Development Phase 3.       *
     F*  119374 - Book/Transaction profit centres are not setup for   *
     F*           Pool Portfolio trades.                              *
     F*  CCB002 - COB Performance Enhancements                        *
     F*           Access now via access object                        *
     F*           Change MEMOS processing to use access objects.      *
     F*  100017 - Position settlement unable to pick up day adj. on   *
     F*           SECTYD. Change subroutine to use DADJN to stop      *
     F*           interest day adjustment being used for amortisation.*
     F*           Recompile over amended subroutine ZDAYS.            *
     F*  092961 - Recompile over ZDAYSZ2 which was amended by 086491  *
     F*           (Wrong number of days calculated for day basis 1    *
     F*           when start or end day is last day of February)      *
     F*  091222 - Correct access object calls                         *
     F*  086491 - Wrong nbr of days calculated for day basis 1        *
     F*           when start or end day is last day of February       *
     F*           Recompiled for ZSRSRC/ZDAYSZ2 changes.              *
     F*  087591 - Narrative code is defined as alphanumeric           *
     F*  S01486 - Private Banking Upgrade to Release 10.              *
     F*  054694 - WRONG SETUP OF CHARGES AND COMMISSIONS CHARGES SIGN *  *
     F*  058886 - OBJECT PM5110 RENAMED TO SE5210                     *
     F*  S01313 - RECOMPILED FOR PORTFOLIO PERFORMANCE                *
     F*                                                               *
     F*****************************************************************
     F*
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
     FPMPLTRPDUF  E           K        DISK
     F                                              KINFSR *PSSR
     FTNRAN   UF  E           K        DISK
     F                                              KINFSR *PSSR
     FACCNT   IF  E           K        DISK
     F                                              KINFSR *PSSR
     F*ACCNTPT IF**E           K        DISK                              S01486
     FPMACCNL1IF  E           K        DISK                               S01486
     F            ACCNTABF                          KRENAMEACCNTPTF
     F                                              KINFSR *PSSR
     FACNUM   IF  E           K        DISK
     F            ACCNTABF                          KRENAMEACNUMF
     F                                              KINFSR *PSSR
     FPMSBPDPDIF  E           K        DISK
     F                                              KINFSR *PSSR
     FPMSBPMPDIF  E           K        DISK
     F                                              KINFSR *PSSR
     FPMCPOSLLIF  E           K        DISK
     F                                              KINFSR *PSSR
     F*PMPORTPPIF**E           K        DISK                              S01486
     FPMPORTPDIF  E           K        DISK                               S01486
     F                                              KINFSR *PSSR
     F*PMHSEXPPIF**E           K        DISK                              S01486
     FPMHSEXPDIF  E           K        DISK                               S01486
     F                                              KINFSR *PSSR
     FSECGT   IF  E           K        DISK
     F                                              KINFSR *PSSR
     FSECTY   IF  E           K        DISK
     F                                              KINFSR *PSSR
     F*SDSECSL0IF**E           K        DISK                              S01486
     F*************                                 KINFSR *PSSR          S01486
     F*SDCUSTL0IF**E           K        DISK                              S01486
     F*************                                 KINFSR *PSSR          S01486
     FCLINT   UF  E           K        DISK         KCOMIT
     F            CLINTCAF                          KIGNORE
     F            CLINTCCF                          KIGNORE
     F            CLINTC1F                          KIGNORE
     F                                              KINFSR *PSSR
     FINVTP   IF  E           K        DISK
     F                                              KINFSR *PSSR
     FSECET   IF  E           K        DISK
     F                                              KINFSR *PSSR
     F*MEMOS***UF  E                    DISK         KCOMIT               CCB002
     F*************                                 KINFSR *PSSR          CCB002
     FOLPOS   UF  E           K        DISK         KCOMIT
     F            OLPOSHHF                          KIGNORE
     F            OLPOSOBF                          KIGNORE
     F                                              KINFSR *PSSR
     FTRADHS  IF  E           K        DISK         KCOMIT
     F            TRADSDF                           KRENAMETRADSHF
     F                                              KINFSR *PSSR
     FTRADBK  UF  E           K        DISK                      A
     F            TRADSDF                           KRENAMETRADBKF
     F                                              KINFSR *PSSR
     FTRADSA  UF  E                    DISK         KCOMIT
     F                                              KINFSR *PSSR
     FBKPOS   UF  E           K        DISK         KCOMIT       A
     F                                              KINFSR *PSSR
     FBKPOSA  UF  E                    DISK         KCOMIT
     F                                              KINFSR *PSSR
     FBKPHD   UF  E           K        DISK         KCOMIT       A
     F                                              KINFSR *PSSR
     FBKPHDA  UF  E                    DISK         KCOMIT
     F                                              KINFSR *PSSR
     FCPOSN   UF  E           K        DISK         KCOMIT       A
     F                                              KINFSR *PSSR
     FCPOSNA  UF  E                    DISK         KCOMIT
     F                                              KINFSR *PSSR
     FUDEPP   UF  E           K        DISK         KCOMIT       A
     F                                              KINFSR *PSSR
     FUDEPPA  UF  E                    DISK         KCOMIT
     F                                              KINFSR *PSSR
     FCDEPP   UF  E           K        DISK         KCOMIT       A
     F                                              KINFSR *PSSR
     FCDEPPA  UF  E                    DISK         KCOMIT
     F                                              KINFSR *PSSR
     FSETLE   UF  E           K        DISK         KCOMIT
     F                                              KINFSR *PSSR
     FSETLEA  UF  E                    DISK         KCOMIT
     F                                              KINFSR *PSSR
     F*SDBANKL0IF  E           K        DISK                              S01486
     F**                                            KINFSR *PSSR          S01486
     F*SDSTRDL0IF**E           K        DISK                              S01486
     F*************                                 KINFSR *PSSR          S01486
     F*SDPORTL0IF**E           K        DISK                              S01486
     F*************                                 KINFSR *PSSR          S01486
     F*SDCURRL0IF**E           K        DISK                              S01486
     F*************                                 KINFSR *PSSR          S01486
     F*FDTG10LLIF**E           K        DISK                              S01486
     F*************                                 KINFSR *PSSR          S01486
     FRSACMTPDO   E                    DISK
     F                                              KCOMIT
     F                                              KINFSR *PSSR
     F*PM5110P1O***E                    PRINTER                           58886
     F*SE5210P1O***E                    PRINTER                           S01486
     FSE5210AUO   E                    PRINTER                            S01486
     F*************                                 KINFSR *PSSR          S01486
     F                                              KINFDS SPOOLU         S01486
     F*PM5110P2O***E                    PRINTER                           58886
     F*SE5210P2O***E                    PRINTER                           S01486
     FSE5210P1O   E                    PRINTER                        UC  S01486
     F*************                                 KINFSR *PSSR          S01486
     F                                              KINFDS SPOOL          S01486
     FSEPCBD  IF  E           K        DISK                               119374
     FSEPCCD  IF  E           K        DISK                               119374
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*****************************************************************
     F*                                                               *
     F* ID F  C  H  L    FUNCTION OF INDICATORS                       *
     F*                                                               *
     F*       30         PRTF SE5210 IS OPEN                          *   S01486
     F*       31         Multibranching is ON.                        *   S01486
     F*       40         Analytical Accounting Module and SAR CAC003  *   CAC003
     F*       41         Settlement Curr. not equal to Nominal Curr.  *   CAC003
     F*       60         FILE READ INDICATOR ON SDPLCSPD              *
     F*       61         FILE READ INDICATOR FOR PMCPLTLL             *
     F*       62         Access PF/SEPCBD and PF/SEPCCD               *   119374
     F*                                                               *
     F*       U7         DATABASE ERROR                               *
     F*       U8         PROGRAM  ERROR                               *
     F*                                                               *
     F*                Unused indicators                              *
     F*                -----------------                              *
     F*       01  02  03  04  05  06  07  08  09  10                  *
     F*       11  12  13  14  15  16  17  18  19  20                  *
     F*       21  22  23  24  25  26  27  28  29  ..                  *
     F*       ..  32  33  34  35  36  37  38  39  40                  *
     F*       41  42  43  44  45  46  47  48  49  50                  *
     F*       51  52  53  54  55  56  57  58  59  ..                  *
     F*       ..  62  63  64  65  66  67  68  69  70                  *
     F*       71  72  73  74  75  76  77  78  79  80                  *
     F*       81  82  83  84  85  86  87  88  89  90                  *
     F*       91  92  93  94  95  96  97  98  99                      *
     F*                                                               *
     F*****************************************************************
     F/SPACE 3
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  SUB001 - Program initialization                              *
     F*  SUB002 - ACCESS STANDING DATA FOR POOL SECURITY              *
     F*  SUB003 - PERFORM FILE UPDATING IN INSERT MODE                *
     F*  SUB004 - PERFORM FILE UPDATING IN AMEND MODE                 *
     F*  SUB005 - PERFORM TERMINATION PROCESSING                      *
     F*  SUB006 - CALCULATE CHARGES AND PURCHASED INTEREST FOR POOL   *
     F*           NOMINAL                                             *
     F*  SUB007 - PERFORM SUBROUTINE TO SET UP COMMON DETAILS         *
     F*  SUB008 - GENERATE DETAILS UNIQUE TO EACH TRADE               *
     F*  SUB009 - GET SECURITY CUSTOMER AND TAX DETAILS               *
     F*  SUB010 -                                                     *
     F*  SUB401 - Sub routine to calculate the interest accrued       *
     F*         adjustment on a Trade                                 *
     F*  SUB700 - Determine default charge/commission                 *
     F*  ZCCALA - CALCULATE CHARGES/COMMISSIONS                       *
     F*  CALTAX - Calculate the tax associated with a charge or       *
     F*         - commission amount.                                  *
     F*  SUB300 - Update trades file                                  *
     F*  SUB500 - Sub-routine to update Client details                *
     F*  SUB501 - Subroutine to update Client Depot positions         *
     F*  SUB502 - Subroutine to update Memos                          *
     F*  UPMEMS - Update MEMOS                                        *
     F*  ACCMOV - TO GENERATE REAL TIME ACCOUNT MOVEMENTS             *
     F*  SUB503 - Subroutine to update on-line positions details      *
     F*  SUB504 - Subroutine to update Book positions                 *
     F*  SUB505 - Subroutine to update Client positions               *
     F*  SUB506 - Subroutine to update User depot positions           *
     F*  SUB507 - Subroutine to update trade settlements file         *
     F*  SUB600 - Subroutine to calculate the latest Book positions   *
     F*  SUB601 - Subroutine to calculate the latest Client positions *
     F*  AMDSTS -                                                     *
     F*  SUB200 - Output error report                                 *
     F*  SUB999 - Database error handling                             *
     F*  *PSSR  - Program error handling                              *
     F*  RCFAU  - RCF PROCESSING FOR AUDIT REPORT                     *   S01486
     F*  RCFP1  - RCF PROCESSING FOR P1 REPORT                        *   S01486
     F*                                                               *
     F*****************************************************************
     E*
     E** ARRAY FOR COPYRIGHT
     E*
     E                    CPY@    1   1 80
     E                    @RA        15 15 0             Charge Range U.L.
     E                    @PC        15  7 4             Percentage Levels
     E                    @CG        15 15 0             Flat Charges
     E                    @TRA       15 15 0             Counterparty Tax
     E                    @TPC       15  7 4             Counterparty Tax
     E                    @TCG       15 15 0             Counterparty Tax
     E                    ADT        16  3               Online pos date
     E                    AFI        16  8               Online pos FX in
     E                    AFO        16  8               Online pos FX out
     E                    NDT        16  5 0             Online pos date
     E                    NFI        16 15 0             Online pos FX in
     E                    NFO        16 15 0             Online pos FX out
     E********************@MS1    1  10 60               Pool Trade Generation
     E********************@MS2    1  10 60               Action required
     E***********         @MS1    1  11 60               Pool Trade GeneraCAC003
     E***********         @MS2    1  11 60               Action required  CAC003
      *                                                                                       CGL029
      ** Compile-time data for arrays @MS1 and @MS2 changed to                                CGL029
      ** reflect extended account numbers.                                                    CGL029
      *                                                                                       CGL029
     E                    @MS1    1  12 60               Pool Trade Gen.  CAC003
     E                    @MS2    1  12 60               Action required  CAC003
     E/COPY ZSRSRC,ZPOWERZ1
     E/COPY ZSRSRC,ZCCAL1Z1
     E/COPY ZSRSRC,ZPOWER8Z1
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZDAYSZ1
     E/COPY ZSRSRC,ZNCDZ1
     E/COPY ZSRSRC,ZACCRZ0
     E/COPY ZSRSRC,ZSEDITZ1
     E/COPY ZSRSRC,ZEDITZ1
      *
      *******************************************************************
      /EJECT
     ISECTYDF
     I              NMCY                            NMCYA
     ITNRANABF
     I              RECI                            TNRECI
     I              CHTP                            TNCHTP
     I              LCD                             TNLCD
     I            DS
      * Data structure for compilation - Copyright insertion
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I*                                                                   S01486
     ISDBANK    E DSSDBANKPD                                              S01486
     I*                                                                   S01486
     I** Bank Details                                                     S01486
     I*                                                                   S01486
     ISDSTRD    E DSSDSTRDPD                                              S01486
     I*                                                                   S01486
     I** Securities Trading ICD                                           S01486
     I*                                                                   S01486
     ISDCUST    E DSSDCUSTPD                                              S01486
     I*                                                                   S01486
     I** Customer details                                                 S01486
     I*                                                                   S01486
     ISDCURR    E DSSDCURRPD                                              S01486
     I*                                                                   S01486
     I** Currency details                                                 S01486
     I*                                                                   S01401
     ISDSECS    E DSSDSECSPD                                              S01401
     I*                                                                   S01401
     I** Securities Customer Details                                      S01401
     I*                                                                   S01486
     IRUNDAT    E DS                                                      S01486
     I**  Standard Data Area Layout for System flags and Run Date         S01486
     I*                                                                   S01486
     IDSFDY     E DSDSFDY                                                 S01486
     I*                                                                   S01486
     I** DS for access programs, short data structure                     S01486
     I*                                                                   S01486
     IDSSDY     E DSDSSDY                                                 S01486
     I*                                                                   S01486
     I** Portfolio Definition Via Access Program                          S01486
     I*                                                                   S01486
     ISDPORT    E DSSDPORTPD                                              S01486
     I*                                                                   S01486
     I**  EXTERNAL DS FOR MMOD acces object                               S01486
     I*                                                                   S01486
     ISDMMOD    E DSSDMMODPD                                              S01486
     I*                                                                   S01486
     I** DS for access programs, long data structure                      S01486
     IUMEMER      DS                                                      CCB002
      ** Data structure for database error on call to AOMEMSR0.           CCB002
     I**********                              1   60U0CNUM                             CCB002 CSD027
     I                                        1   6 U0CNUM                                    CSD027
     I                                        7   9 U0CUCD                CCB002
     I**********                             10  130U0ACCD                             CCB002 CGL029
     I**********                             14  150U0ACSQ                             CCB002 CGL029
     I**********                             16  18 U0BRCA                             CCB002 CGL029
     I                                       10  190U0ACCD                                    CGL029
     I                                       20  210U0ACSQ                                    CGL029
     I                                       22  24 U0BRCA                                    CGL029
     I*                                                                   S01486
     I            DS
      * Data for insert currency in error message
     I                                        1  60 SRMES1
     I                                       23  25 SRCCY
     I            DS
      * DATA STRUCTURE FOR INSERT OF ACCOUNT CODE IN ERROR MESSAGE
     I                                        1  60 SRMES2
     I**********                             14  19 SRCNUM                                    CGL029
     I**********                             21  23 SRCCY1                                    CGL029
     I**********                             25  28 SRACOD                                    CGL029
     I**********                             30  31 SRACSQ                                    CGL029
     I                                       12  17 SRCNUM                                    CGL029
     I                                       19  21 SRCCY1                                    CGL029
     I                                       23  32 SRACOD                                    CGL029
     I                                       34  35 SRACSQ                                    CGL029
      * DATA STRUCTURE FOR INSERT OF ACCOUNT CODE IN ERROR MESSAGE
     I                                        1  60 SRMES3
     I                                       16  21 S1CNUM
     I                                       23  25 S1CCY1
     I**********                             27  30 S1ACOD                                    CGL029
     I**********                             32  33 S1ACSQ                                    CGL029
     I                                       27  36 S1ACOD                                    CGL029
     I                                       38  39 S1ACSQ                                    CGL029
      * DATA STRUCTURE FOR INSERT OF ACCOUNT CODE IN ERROR MESSAGE 11
     I                                        1  60 SRMES4
     I                                       24  29 S2CNUM
     I                                       31  33 S2CCY1
     I**********                             35  38 S2ACOD                                    CGL029
     I**********                             40  41 S2ACSQ                                    CGL029
     I                                       35  44 S2ACOD                                    CGL029
     I                                       46  47 S2ACSQ                                    CGL029
      *
      *  D.S. to make up KLIST for file ACCNT
     I@DSACC      DS
     I**********                              1   60CNUM                                      CSD027
     I                                        1   6 CNUM                                      CSD027
     I**********                              7  100ACOD                                      CGL029
     I**********                             11  120ACSQ                                      CGL029
     I                                        7  160ACOD                                      CGL029
     I                                       17  180ACSQ                                      CGL029
     I/COPY ZSRSRC,ZNCDZ2
     I/COPY ZSRSRC,ZTNLU1Z1
     I/COPY ZSRSRC,ZSEDITZ2
      *  Data structure to provide text on COMIT
     I@CMTXT      DS
     I                                        1   50@NTN
     I                                        6   7 @MID
     I                                        8  15 @PGM
     I                                       16  18 @WID
     I                                       19  240@TIME
     I                                       25  25 @ACTN
     I                                       26  35 @USER
      *  Error reporting data structure
     ILDA         DS                            256                       S01486
     I***********                           132 183 @DBALL                S01486
     I                                      134 183 @DBALL                S01486
     I***********                           132 141 @DBFIL                S01486
     I                                      134 141 @DBFIL                S01486
     I                                      142 170 @DBKEY                S01486
     I                                      171 180 @DBPGM                S01486
     I                                      181 1830@DBASE                S01486
     I*                                                                   S01486
     IRUNDT       DS                                                      S01486
     I*                                                                   S01486
     I**  DATA STRUCTURE FOR RUN DATE DETAILS                             S01486
     I*                                                                   S01486
     I                                        1   7 RUNA                  S01486
     I                                    P   8  100RUND                  S01486
     I                                       11  11 SSF                   S01486
     I                                       12  12 DATF                  S01486
     I                                       13  13 MBIN                  S01486
     I*                                                                   S01486
     ISPOOL       DS                                                      S01486
     I*                                                                   S01486
     I**  DS FOR P1 SPOOL FILE NAME                                       S01486
     I*                                                                   S01486
     I                                       83  92 SFILE                 S01486
     I                                    B 123 1240SFNUM                 S01486
     I*                                                                   S01486
     ISPOOLU      DS                                                      S01486
     I*                                                                   S01486
     I**  DS FOR AU SPOOL FILE NAME                                       S01486
     I*                                                                   S01486
     I                                       83  92 SFILEU                S01486
     I                                    B 123 1240SFNUMU                S01486
     I*                                                                   S01486
     I** Program status data structure
     IPSDS       SDS
     I                                      244 253 @JOB
     I                                      254 263 @USR
      *  For transfer of bulk details to trade
     I@TRDDS    E DSTRADSD
      *  For transfer of bulk details to trade
     I@BLKDS      DS
     I                                        1   1 @BRECI
     I                                        2   7 @BTDRF
     I                                        8   8 @BTINC
     I                                        9  18 @BTDSS
     I**********                             19  240@BTCNR                                    CSD027
     I                                       19  24 @BTCNR                                    CSD027
     I                                       25  26 @BTDTP
     I                                    P  27  320@BNOML
     I                                       33  35 @BTNMC
     I                                    P  36  360@BTNMD
     I                                    P  37  448@BTPDY
     I                                    P  45  470@BTDVD
     I***********                            48  500@BTDBR                S01486
     I***********                            51  52 @BTDBK                S01486
     I***********                         P  53  550@BTDDT                S01486
     I***********                            56  57 @BTSUB                S01486
     I***********                            58  63 @BLKRF                S01486
     I***********                            64  64 @BTDMI                S01486
     I***********                            65  99 @BTDNR                S01486
     I***********                           100 102 @BTDID                S01486
     I***********                           103 103 @BAIIP                S01486
     I***********                           104 105 @BTMKC                S01486
     I***********                           106 1060@BTCAP                S01486
     I***********                         P 107 1118@BTCFC                S01486
     I***********                           112 112 @BACIN                S01486
     I***********                         P 113 1140@BDADJ                S01486
     I***********                           115 115 @BADIN                S01486
     I***********                         P 116 1220@BITRA                S01486
     I***********                         P 123 1290@BTINA                S01486
     I***********                         P 130 1357@BTDCR                S01486
     I***********                         P 136 1438@BPRIC                S01486
     I***********                           144 144 @BEXDV                S01486
     I***********                         P 145 1495@BRALL                S01486
     I***********                           150 152 @BSETC                S01486
     I***********                         P 153 1598@BTDER                S01486
     I***********                           160 160 @BTMDI                S01486
     I***********                         P 161 1678@BTBCR                S01486
     I***********                           168 1690@BSMTH                S01486
     I***********                           170 181 @BPYFM                S01486
     I***********                           170 175 @BCNUM                S01486
     I***********                           176 179 @BCACD                S01486
     I***********                           180 181 @BSACS                S01486
     I***********                           182 1840@BPYFB                S01486
     I***********                           185 196 @BPAYT                S01486
     I***********                           197 1990@BPYTB                S01486
     I***********                           200 207 @BTDFA                S01486
     I***********                           208 2090@BASNM                S01486
     I***********                           210 210 @BCLTY                S01486
     I***********                           211 2160@BDELT                S01486
     I***********                           217 224 @BDTFA                S01486
     I***********                           225 2300@BDELF                S01486
     I***********                           231 238 @BDFFA                S01486
     I***********                           239 273 @BTDSI                S01486
     I***********                           274 274 @BPRYC                S01486
     I***********                           275 275 @BPCOD                S01486
     I***********                           276 277 @BTBCC                S01486
     I***********                         P 278 2840@BTBCA                S01486
     I***********                           285 286 @BTCCC                S01486
     I***********                         P 287 2930@BTCCA                S01486
     I***********                           294 295 @BTCC1                S01486
     I***********                         P 296 3020@BTCA1                S01486
     I***********                           303 304 @BTCC2                S01486
     I***********                         P 305 3110@BTCA2                S01486
     I***********                           312 313 @BTCC3                S01486
     I***********                         P 314 3200@BTCA3                S01486
     I***********                           321 322 @BTCC4                S01486
     I***********                         P 323 3290@BTCA4                S01486
     I***********                           330 331 @BTCC5                S01486
     I***********                         P 332 3380@BTCA5                S01486
     I***********                           339 340 @BTCC6                S01486
     I***********                         P 341 3470@BTCA6                S01486
     I***********                           348 349 @BTCC7                S01486
     I***********                         P 350 3560@BTCA7                S01486
     I***********                         P 357 3630@BTAXA                S01486
     I***********                         P 364 3700@BBCMR                S01486
     I***********                         P 371 3770@BCCMR                S01486
     I***********                         P 378 3840@BTXRB                S01486
     I***********                           385 390 @BBLKR                S01486
     I***********                           391 396 @BRTRF                S01486
     I***********                           397 397 @BATRD                S01486
     I***********                           398 398 @BBCON                S01486
     I***********                           399 4040@BTIME                S01486
     I***********                           405 405 @BAUTS                S01486
     I***********                           406 406 @BTACI                S01486
     I***********                           407 407 @BTMSI                S01486
     I***********                           408 408 @BTCFR                S01486
     I***********                         P 409 4140@BTOSN                S01486
     I***********                         P 415 4200@BTNSN                S01486
     I***********                         P 421 4260@BTNSP                S01486
     I***********                         P 427 4340@BTOSV                S01486
     I***********                         P 435 4420@BTVSN                S01486
     I***********                         P 443 4500@BTVSP                S01486
     I***********                         P 451 4580@BTDSN                S01486
     I***********                         P 459 4660@BTDSP                S01486
     I***********                         P 467 4690@BTDFS                S01486
     I***********                         P 470 4710@BTSSQ                S01486
     I***********                         P 472 4790@BTCSR                S01486
     I***********                         P 480 4870@BTCTR                S01486
     I***********                         P 488 4900@BTDMC                S01486
     I***********                         P 491 4930@BTOED                S01486
     I***********                         P 494 4960@BLCD                 S01486
     I***********                           497 497 @BCHTP                S01486
     I***********                         P 498 5000@BTNLU                S01486
     I***********                         P 501 5020@BLSWS                S01486
     I***********                           503 506 @BPTFR                S01486
     I***********                         P 507 5138@BSPXR                S01486
     I***********                           514 514 @BSPMD                S01486
     I                                       48  50 @BTDBR                S01486
     I                                       51  53 @BORBR                S01486
     I                                       54  55 @BTDBK                S01486
     I                                    P  56  580@BTDDT                S01486
     I                                       59  60 @BTSUB                S01486
     I                                       61  66 @BLKRF                S01486
     I                                       67  67 @BTDMI                S01486
     I                                       68 102 @BTDNR                S01486
     I                                      103 105 @BTDID                S01486
     I                                      106 106 @BAIIP                S01486
     I                                      107 108 @BTMKC                S01486
     I                                      109 1090@BTCAP                S01486
     I                                      110 114 @BZ005                S01486
     I                                      115 115 @BACIN                S01486
     I                                    P 116 1170@BDADJ                S01486
     I                                      118 118 @BADIN                S01486
     I                                    P 119 1250@BITRA                S01486
     I                                    P 126 1320@BTINA                S01486
     I                                    P 133 1387@BTDCR                S01486
     I                                    P 139 1468@BPRIC                S01486
     I                                      147 147 @BEXDV                S01486
     I                                    P 148 1525@BRALL                S01486
     I                                      153 155 @BSETC                S01486
     I                                    P 156 1628@BTDER                S01486
     I                                      163 163 @BTMDI                S01486
     I                                    P 164 1708@BTBCR                S01486
     I                                      171 1720@BSMTH                S01486
     I**********                            173 184 @BPYFM                             S01486 CGL029
     I                                      173 184 QQPYFM                                    CGL029
     I                                      185 187 @BPYFA                S01486
     I**********                            188 199 @BPAYT                             S01486 CGL029
     I                                      188 199 QQPAYT                                    CGL029
     I                                      200 202 @BPYTA                S01486
     I                                      203 210 @BTDFA                S01486
     I                                      211 2120@BASNM                S01486
     I                                      213 213 @BCLTY                S01486
     I**********                            214 2190@BDELT                             S01486 CSD027
     I                                      214 219 @BDELT                                    CSD027
     I                                      220 227 @BDTFA                S01486
     I**********                            228 2330@BDELF                             S01486 CSD027
     I                                      228 233 @BDELF                                    CSD027
     I                                      234 241 @BDFFA                S01486
     I                                      242 276 @BTDSI                S01486
     I                                      277 277 @BPRYC                S01486
     I                                      278 278 @BPCOD                S01486
     I                                      279 280 @BTBCC                S01486
     I                                    P 281 2870@BTBCA                S01486
     I                                      288 289 @BTCCC                S01486
     I                                    P 290 2960@BTCCA                S01486
     I                                      297 298 @BTCC1                S01486
     I                                    P 299 3050@BTCA1                S01486
     I                                      306 307 @BTCC2                S01486
     I                                    P 308 3140@BTCA2                S01486
     I                                      315 316 @BTCC3                S01486
     I                                    P 317 3230@BTCA3                S01486
     I                                      324 325 @BTCC4                S01486
     I                                    P 326 3320@BTCA4                S01486
     I                                      333 334 @BTCC5                S01486
     I                                    P 335 3410@BTCA5                S01486
     I                                      342 343 @BTCC6                S01486
     I                                    P 344 3500@BTCA6                S01486
     I                                      351 352 @BTCC7                S01486
     I                                    P 353 3590@BTCA7                S01486
     I                                    P 360 3660@BTAXA                S01486
     I                                    P 367 3730@BBCMR                S01486
     I                                    P 374 3800@BCCMR                S01486
     I                                    P 381 3870@BTXRB                S01486
     I                                      388 393 @BBLKR                S01486
     I                                      394 399 @BRTRF                S01486
     I                                      400 400 @BATRD                S01486
     I                                      401 401 @BBCON                S01486
     I                                      402 4070@BTIME                S01486
     I                                      408 408 @BAUTS                S01486
     I                                      409 409 @BTACI                S01486
     I                                      410 410 @BTMSI                S01486
     I                                      411 411 @BTCFR                S01486
     I                                    P 412 4170@BTOSN                S01486
     I                                    P 418 4230@BTNSN                S01486
     I                                    P 424 4290@BTNSP                S01486
     I                                    P 430 4370@BTOSV                S01486
     I                                    P 438 4450@BTVSN                S01486
     I                                    P 446 4530@BTVSP                S01486
     I                                    P 454 4610@BTDSN                S01486
     I                                    P 462 4690@BTDSP                S01486
     I                                    P 470 4720@BTDFS                S01486
     I                                    P 473 4740@BTSSQ                S01486
     I                                    P 475 4820@BTCSR                S01486
     I                                    P 483 4900@BTCTR                S01486
     I                                    P 491 4930@BTDMC                S01486
     I                                    P 494 4960@BTOED                S01486
     I                                      497 500 @PRFC                 S01486
     I                                      501 501 @PRPC                 S01486
     I                                    P 502 5040@BLCD                 S01486
     I                                      505 505 @BCHTP                S01486
     I                                    P 506 5080@BTNLU                S01486
     I                                    P 509 5100@BLSWS                S01486
     I                                    P 511 5169@BTCFC                S01486
     I                                      517 520 @BPTFR                S01486
     I                                    P 521 5278@BSPXR                S01486
     I                                      528 528 @BSPMD                S01486
     I                                      529 532 @BBPRC                119374
     I                                      533 536 @BTPRC                119374
     I                                    P 537 5402@BFXMP                CAC003
     I                                    P 541 5478@BFXMR                CAC003
     I                                    P 548 5540@BMAMT                CAC003
     I                                    P 642 6498@BCRSK                                    CAS006
     I                                    P 650 6578@BLQPR                                    CAS006
     I                                    P 658 6640@BTINN                                    CAS006
     I                                    P 665 6710@BITRN                                    CAS006
     I                                    P 672 6798@BPRIN                                    CAS006
     I                                      680 697 @BPYFM                                    CGL029
     I                                      698 715 @BPAYT                                    CGL029
      *                                                                   S01486
      *  Data structure to fill upper range limit array
     I            DS
     I                                    P   1 120 @RA
     I                                    P   1   80STU1
     I                                    P   9  160STU2
     I                                    P  17  240STU3
     I                                    P  25  320STU4
     I                                    P  33  400STU5
     I                                    P  41  480STU6
     I                                    P  49  560STU7
     I                                    P  57  640STU8
     I                                    P  65  720STU9
     I                                    P  73  800ST10
     I                                    P  81  880ST11
     I                                    P  89  960ST12
     I                                    P  97 1040ST13
     I                                    P 105 1120ST14
     I                                    P 113 1200@DUMMY
      *
      *  Data structure to fill percentage array
     I            DS
     I                                    P   1  60 @PC
     I                                    P   1   44PL01
     I                                    P   5   84PL02
     I                                    P   9  124PL03
     I                                    P  13  164PL04
     I                                    P  17  204PL05
     I                                    P  21  244PL06
     I                                    P  25  284PL07
     I                                    P  29  324PL08
     I                                    P  33  364PL09
     I                                    P  37  404PL10
     I                                    P  41  444PL11
     I                                    P  45  484PL12
     I                                    P  49  524PL13
     I                                    P  53  564PL14
     I                                    P  57  604PL15
      *
      *  Data structure to fill flat charge array
     I            DS
     I                                    P   1 120 @CG
     I                                    P   1   80FC01
     I                                    P   9  160FC02
     I                                    P  17  240FC03
     I                                    P  25  320FC04
     I                                    P  33  400FC05
     I                                    P  41  480FC06
     I                                    P  49  560FC07
     I                                    P  57  640FC08
     I                                    P  65  720FC09
     I                                    P  73  800FC10
     I                                    P  81  880FC11
     I                                    P  89  960FC12
     I                                    P  97 1040FC13
     I                                    P 105 1120FC14
     I                                    P 113 1200FC15
      *
      ***  Data structure for storing Tax Charge fields (obtained from
      ***  LF/SECGT using the Tax Code from the Counterparty).
      ***  (Used for moving fields into standard subroutine)
      *
     I@TXDS       DS
     I                                        1   1 @TCHGB
     I                                        2   2 @TTHRI
     I                                    P   3 122 @TRA
     I                                    P 123 182 @TPC
     I                                    P 183 302 @TCG
     I                                    P 303 3100@TMNCH
     I                                    P 311 3180@TMXCH
     I                                      319 319 @TTXAP
     I                                      320 320 @TREBA
     I                                      321 321 @TLPSI
      *
      ***  Data structure for the charge fields from LF/SECGT
      ***  that are used in standard subroutines.
      *
     I@ZCHDS      DS
     I                                        1   1 ZCHGB
     I                                        2   2 ZTHRI
     I                                    P   3 122 ZRA
     I                                    P 123 182 ZPC
     I                                    P 183 302 ZCG
     I                                    P 303 3100ZMNCH
     I                                    P 311 3180ZMXCH
      *
     I            DS
     I                                    P   1  48 NDT
     I                                    P  49 176 NFI
     I                                    P 177 304 NFO
     I                                        1  48 ADT
     I                                       49 176 AFI
     I                                      177 304 AFO
     I            DS
     I                                        1  21 ZOUT21
     I                                        1  20 ZOUT20
     I/COPY WNCPYSRC,SE5210I001
      ********************************************************************
      /EJECT
      *****************************************************************
      *  PLIST's, KLIST's, DEFN's etc....                             *
      *****************************************************************
      *
     C           *NAMVAR   DEFN           LDA
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01486
     C                     IN   RUNDT                                     S01486
      *                                                                   S01486
      ** Multibranching is switched ON.                                   S01486
     C           MBIN      IFEQ 'Y'                                       S01486
     C                     MOVE *ON       *IN31                           S01486
     C                     END                                            S01486
      *                                                                   S01486
     C           *LIKE     DEFN @DBALL    @DBSAV
      *
      * Initial parameter
     C           *ENTRY    PLIST
     C                     PARM           @XTNUM  6
     C                     PARM           @XUSER 10
     C                     PARM           @RSEQ   5                       S01486
     C                     PARM           @RLEV   1                       S01486
     C                     PARM           @RENT   3                       S01486
     C/COPY WNCPYSRC,SE5210C001
      *
      *                                                                                       CSE035
      *  Access SAR details file to see if CSE035 is installed                                CSE035
      *                                                                                       CSE035
     C                     CALL 'AOSARDR0'                                                    CSE035
     C                     PARM *BLANKS   @RTCD                                               CSE035
     C                     PARM '*VERIFY' @OPTN                                               CSE035
     C                     PARM 'CSE035'  WSARD   6                                           CSE035
      *                                                                                       CSE035
     C           @RTCD     IFEQ *BLANK                                                        CSE035
     C                     MOVE 'Y'       CSE035  1                                           CSE035
     C                     ELSE                                                               CSE035
     C                     MOVE 'N'       CSE035                                              CSE035
     C                     ENDIF                                                              CSE035
      *                                                                                       CSE035
      * KLIST for Customer /pool  file
     C           @KYPOL    KLIST
     C                     KFLD           OUPCNU
     C                     KFLD           OUPPTF
      *
      * KLIST for Customer /pool  file
     C           @KYMEM    KLIST
     C**********           KFLD           WWPCNU  60                                          CSD027
     C                     KFLD           WWPCNU  6                                           CSD027
     C                     KFLD           WWPPTF  4
     C**********           KFLD           WWCNUM  60                                          CSD027
     C                     KFLD           WWCNUM  6                                           CSD027
     C                     KFLD           WWPTFR  4
      *
      * KLIST for LF/INVTP
     C           @KEY1     KLIST
     C                     KFLD           NMCYA
     C                     KFLD           SITP
      *
      * KLIST for LF/SECGT
     C           @KEY4     KLIST
     C                     KFLD           @XCCY   3
     C                     KFLD           @XCODE  2
      *
      * KLIST for file BKPHD
     C           @KEYB     KLIST
     C                     KFLD           BHSC
     C***********          KFLD           BHBR                            S01486
     C                     KFLD           BHBA                            S01486
     C                     KFLD           BHBK
     C                     KFLD           BHMK
     C                     KFLD           BHTV
      *
      * KLIST for file BKPOS
     C           @KEYC     KLIST
     C                     KFLD           BPSC
     C***********          KFLD           BPBR                            S01486
     C                     KFLD           BPBA                            S01486
     C                     KFLD           BPBK
     C                     KFLD           BPMK
     C                     KFLD           BPTV
     C                     KFLD           BPPD
      *
      * KLIST for file CPOSN
     C           @KEYE     KLIST
     C                     KFLD           @BTDBR
     C                     KFLD           @BTDSS
     C                     KFLD           @BTCNR
      *
      * KLIST for file CDEPP
     C           @KEYF     KLIST
     C                     KFLD           @BTDBR
     C                     KFLD           @BTCNR
     C                     KFLD           @BTDSS
     C                     KFLD           CDPT
     C                     KFLD           @BTDMI
      *
      * KLIST for file UDEPP
     C           @KEYG     KLIST
     C                     KFLD           @BTDBR
     C                     KFLD           @BTDSS
     C                     KFLD           UDPT
     C                     KFLD           @BTDBK
     C                     KFLD           @BTDMI
      *
      * KLIST for file ACCNT
     C           @KACCN    KLIST
     C                     KFLD           CNUM
     C                     KFLD           CCY
     C                     KFLD           ACOD
     C                     KFLD           ACSQ
      *
      * KLIST for file OLPOS
     C           @KEYI     KLIST
     C                     KFLD           BRCA                            S01486
     C                     KFLD           CCY
     C                     KFLD           RECN
      *
      * KLIST for file SETLE
     C           @KEYJ     KLIST
     C                     KFLD           @BTDBR
     C                     KFLD           @BTDRF
     C                     KFLD           @BTSSQ                          S01486
      *
      ** Key to account portfolio file
     C           KEYACN    KLIST
     C                     KFLD           @BTCNR
     C                     KFLD           @BPTFR
     C                     KFLD           OUSETC
      *
      ** Key to Trade number file
     C           TRAKEY    KLIST
     C                     KFLD           WWRECT
     C                     KFLD           ZZ008
     C                     KFLD           WWRANG
     C*                                                                   119374
     C** KLIST for file SEPCBD                                            119374
     C           KLPCBD    KLIST                                          119374
     C                     KFLD           OUTDBK                          119374
     C                     KFLD           OUTDBR                          119374
     C                     KFLD           OUTDSS                          119374
     C                     KFLD           OUTDMI                          119374
     C*                                                                   119374
     C** KLIST for file SEPCCD                                            119374
     C           KLPCCD    KLIST                                          119374
     C                     KFLD           @BTCNR                          119374
     C                     KFLD           OUTDBR                          119374
     C                     KFLD           OUTDSS                          119374
      *
      * KLIST for file PMCPOSLL
     C           @PMCPO    KLIST
     C                     KFLD           OSCNUM
     C                     KFLD           OSPTFR
     C                     KFLD           OUTDSS
     C***********          KFLD           P9TVPS                          S01486
     C                     KFLD           FCTVPS                          S01486
     C*                                                                   S01486
     C** REGISTER SPOOL ENTRY FOR AU                                      S01486
     C*                                                                   S01486
     C                     EXSR RCFAU                                     S01486
     C                     Z-ADD0         PAGE1                           S01486
      ********************************************************************
      /EJECT
      ********************************************************************
     C*
     C* MAIN PROCESSING ROUTINE
     C*
      ********************************************************************
     C*
     C** PERFORM INITIALISATION PROCESSING
     C                     EXSR SUB001
     C*
     C** OBTAIN POOL TRADE DETAILS FROM PF/PMPLTRPD
     C           @XTNUM    CHAINPMPLTRPD             01
     C           *IN01     IFEQ '1'                        B1
     C           OURECI    ORNE 'D'
     C                     Z-ADD1         @DBASE           ***************
     C                     MOVEL'PMPLTRPD'@DBFIL           * DB ERROR 01 *
     C                     MOVEL@XTNUM    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C*
     C** UNLOCK RECORD ON PMPLTRPD
     C                     UPDATPMPLTRP0
     C*
     C** ACCESS FILES TO OBTAIN DETAILS OF SECURITY
     C                     EXSR SUB002
     C*
     C** IF INSERTION OF NEW POOL TRADE PERFORM SR/SUB003
     C           OUCHTP    IFEQ 'I'
     C                     EXSR SUB003
     C*
     C** ...OTHERWISE PERFORM ROUTINE SUB004 TO PROCESS AMENDMENT
     C                     ELSE
     C                     EXSR SUB004
     C                     END
      *
      * Terminate program
     C                     EXSR SUB005
      *
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB001 - Program initialization                                *
      *******************************************************************
     C           SUB001    BEGSR
      *
      * Set up fixed values
     C                     MOVEL'L'       ZECODE
     C                     MOVEL'PM'      @MID
     C****                 MOVEL'PM5110'  @PGM
     C****                 MOVEL'PM5110'  @DBPGM
     C                     MOVEL'SE5210'  @PGM
     C                     MOVEL'SE5210'  @DBPGM
     C                     MOVEL@JOB      @WID
     C                     MOVEL@USR      @USER
      *
      * Get ICD1
     C***********          READ SDBANKL0                 01               S01486
     C                     CALL 'AOBANKR0'                                S01486
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*FIRST ' @OPTN   7                       S01486
     C           SDBANK    PARM SDBANK    DSFDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANK                                    S01486
     C************IN01     IFEQ '1'                                       S01486
     C                     Z-ADD2         @DBASE           ***************
     C***********          MOVEL'SDBANKL0'@DBFIL           * DB ERROR 02 *S01486
     C                     MOVEL'SDBANKPD'@DBFIL           * DB ERROR 02 *S01486
     C                     MOVE *BLANKS   @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END
      *
      * Set up print file fields
     C                     MOVEL@XUSER    @PUSER
     C                     MOVEL@XTNUM    @BBLKR
     C*
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     END
      *
      * GET SECURITIES TRADING ICD
     C***********          READ SDSTRDL0                 01               S01486
     C                     CALL 'AOSTRDR0'                                S01486
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*FIRST ' @OPTN   7                       S01486
     C           SDSTRD    PARM SDSTRD    DSSDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANK                                    S01486
     C************IN01     IFEQ '1'                                       S01486
     C                     Z-ADD3         @DBASE           ***************
     C***********          MOVEL'SDSTRDL0'@DBFIL           * DB ERROR 03 *S01486
     C                     MOVEL'SDSTRDPD'@DBFIL           * DB ERROR 03 *S01486
     C                     MOVE *BLANKS   @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END
      *
      * GET PORTFOLIO MANAGEMENT ICD
     C***********          READ SDPORTL0                 01               S01486
     C                     CALL 'AOPORTR0'                                S01486
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*FIRST ' @OPTN   7                       S01486
     C           SDPORT    PARM SDPORT    DSFDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANK                                    S01486
     C************IN01     IFEQ '1'                                       S01486
     C                     Z-ADD3         @DBASE           ***************
     C***********          MOVEL'SDPORTL0'@DBFIL           * DB ERROR 03 *S01486
     C                     MOVEL'SDPORTPD'@DBFIL           * DB ERROR 03 *S01486
     C                     MOVE *BLANKS   @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END
      *
     C*                                                                   119374
     C** Access Module Details File                                       119374
     C                     CALL 'AOMMODR0'                                119374
     C                     PARM '*MSG   ' @RTCD                           119374
     C                     PARM '*FIRST'  @OPTN                           119374
     C           SDMMOD    PARM SDMMOD    DSFDY                           119374
     C*                                                                   119374
     C           @RTCD     IFNE *BLANK                                    119374
     C                     Z-ADD26        @DBASE           ***************119374
     C                     MOVEL'SDMMODPD'@DBFIL           * DB ERROR 26 *119374
     C                     MOVE *BLANKS   @DBKEY           ***************119374
     C                     Z-ADD3         WWERR                           119374
     C                     EXSR SUB200                                    119374
     C                     END                                            119374
     C*                                                                   CAC003
     C** Check if SAR CAC003 is installed                                 CAC003
     C                     CALL 'AOSARDR0'                                CAC003
     C                     PARM '       ' @RTCD                           CAC003
     C                     PARM '*VERIFY' @OPTN                           CAC003
     C                     PARM 'CAC003'  @SARD   6                       CAC003
     C*                                                                   CAC003
     C           @RTCD     IFEQ *BLANK                                    CAC003
     C           BGN0ST    ANDEQ'Y'                                       CAC003
     C                     MOVE '1'       *IN40                           CAC003
     C                     ENDIF                                          CAC003
      *                                                                   CAC005
      ***  Check if CAC005 - PCA-SE Enhancement is on.                    CAC005
      *                                                                   CAC005
     C                     MOVE 'N'       CAC005  1                       CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   @RTCD                           CAC005
     C                     PARM '*VERIFY' @OPTN                           CAC005
     C                     PARM 'CAC005'  @SARD                           CAC005
      *                                                                   CAC005
     C           @RTCD     IFEQ *BLANK                                    CAC005
     C                     MOVE 'Y'       CAC005                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CRE009
      ***  Check if CRE009 - Generated A/c movements for RE a/c is ON     CRE009
      *                                                                   CRE009
     C                     MOVE 'N'       CRE009  1                       CRE009
     C                     CALL 'AOSARDR0'                                CRE009
     C                     PARM *BLANKS   @RTCD                           CRE009
     C                     PARM '*VERIFY' @OPTN                           CRE009
     C                     PARM 'CRE009'  @SARD                           CRE009
      *                                                                   CRE009
     C           @RTCD     IFEQ *BLANK                                    CRE009
     C                     MOVE 'Y'       CRE009                          CRE009
     C                     ENDIF                                          CRE009
     C*                                                                   CRE009
      *                                                                                       CAS006
      ** Access SAR Details to see if CAS006 is installed                                     CAS006
      *                                                                                       CAS006
     C                     MOVE 'N'       CAS006  1                                           CAS006
     C                     CALL 'AOSARDR0'                                                    CAS006
     C                     PARM *BLANKS   PRTCD   7                                           CAS006
     C                     PARM '*VERIFY 'POPTN   7                                           CAS006
     C                     PARM 'CAS006'  PSARD   6                                           CAS006
      *                                                                                       CAS006
     C           PRTCD     IFNE *BLANKS                                                       CAS006
     C           PRTCD     ANDNE'*NRF   '                                                     CAS006
     C                     MOVEL'CAS006'  @DBKEY                                              CAS006
     C                     MOVEL'SCSARDPD'@DBFIL                                              CAS006
     C                     Z-ADD8         @DBASE                                              CAS006
     C                     EXSR *PSSR                                                         CAS006
     C                     ELSE                                                               CAS006
      *                                                                                       CAS006
     C           PRTCD     IFEQ *BLANKS                                                       CAS006
     C                     MOVE 'Y'       CAS006                                              CAS006
     C                     ENDIF                                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
      ** Access SAR Details to see if CAP205 is installed                                     CAP205
      *                                                                                       CAP205
     C                     MOVE 'N'       CAP205  1                                           CAP205
     C                     CALL 'AOSARDR0'                                                    CAP205
     C                     PARM *BLANKS   PRTCD   7                                           CAP205
     C                     PARM '*VERIFY 'POPTN   7                                           CAP205
     C                     PARM 'CAP205'  PSARD   6                                           CAP205
      *                                                                                       CAP205
     C           PRTCD     IFNE *BLANKS                                                       CAP205
     C           PRTCD     ANDNE'*NRF   '                                                     CAP205
     C                     MOVEL'CAP205'  @DBKEY                                              CAP205
     C                     MOVEL'SCSARDPD'@DBFIL                                              CAP205
     C                     Z-ADD32        @DBASE                                              CAP205
     C                     EXSR *PSSR                                                         CAP205
     C                     ELSE                                                               CAP205
      *                                                                                       CAP205
     C           PRTCD     IFEQ *BLANKS                                                       CAP205
     C                     MOVE 'Y'       CAP205                                              CAP205
     C                     ENDIF                                                              CAP205
     C                     ENDIF                                                              CAP205
      *                                                                                       CAP205
     C/COPY WNCPYSRC,SE5210C002
     C                     ENDSR                           SUB001 ends
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB002 - ACCESS STANDING DATA FOR POOL SECURITY                *
      *******************************************************************
     C           SUB002    BEGSR
     C*
     C** ACCESS SECURITY DETAILS
     C           OUTDSS    CHAINSECTYDF              01
     C           *IN01     IFEQ '1'                        B1
     C           RECI      ORNE 'D'
     C                     Z-ADD4         @DBASE           ***************
     C                     MOVEL'SECTY   '@DBFIL           * DB ERROR 04 *
     C                     MOVELOUTDSS    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C                     Z-ADDSFPP      ZSFPP
     C                     MOVE SINP      ZSINP
     C                     MOVE NMCYA     @BTNMC
     C                     Z-ADDNMDP      @BTNMD
     C                     MOVELNMCYA     @XCCY
     C                     Z-ADDNMDP      ZNMDP
     C                     MOVE SPBS      ZSPBS
     C*
     C** ACCESS INVETMENT TYPE DETAILS
     C           @KEY1     CHAININVTP                01
     C           *IN01     IFEQ '1'                        B1
     C           RECI      ORNE 'D'
     C                     Z-ADD5         @DBASE           ***************
     C                     MOVEL'INVTP   '@DBFIL           * DB ERROR 05 *
     C                     MOVELNMCYA     @DBKEY           ***************
     C                     MOVELSITP      @DBKEY
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C*
     C                     MOVE PROT      ZPROT
     C*
     C** ACCESS NOMINAL CURRENCY DETAILS
     C***********NMCYA     CHAINSDCURRL0             01                   S01486
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*KEY   ' @OPTN   7                       S01486
     C                     PARM NMCYA     @CYCD   3                       S01486
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANK                                    S01486
     C************IN01     IFEQ '1'                        B1             S01486
     C                     Z-ADD7         @DBASE           ***************
     C***********          MOVEL'SDCURRL0'@DBFIL           * DB ERROR 07 *S01486
     C                     MOVEL'SDCURRPD'@DBFIL           * DB ERROR 07 *S01486
     C                     MOVELNMCYA     @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                              E1
     C*
     C                     Z-ADDA6SPRT    WWNMSP 138
     C                     Z-ADDA6NBDP    WWNMDP  10
     C                     Z-ADDA6NBDP    NOMDP   10
     C                     MOVE A6MDIN    WWNMMD  1
     C*
     C** ACCESS SETTLEMENT CURRENCY DETAILS
     C***********OUSETC    CHAINSDCURRL0             01                   S01486
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*KEY   ' @OPTN   7                       S01486
     C                     PARM OUSETC    @CYCD   3                       S01486
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANK                                    S01486
     C************IN01     IFEQ '1'                                B001   S01486
     C                     Z-ADD14        @DBASE           ***************
     C***********          MOVEL'SDCURRL0'@DBFIL           * DB ERROR 14 *S01486
     C                     MOVEL'SDCURRPD'@DBFIL           * DB ERROR 14 *S01486
     C                     MOVELOUSETC    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                                     E001
     C*
     C** SAVE SETTLEMENT INFORMATION FOR USE IN SR/SUB008
     C                     Z-ADDA6SPRT    WWSTSP 138
     C                     Z-ADDA6NBDP    WWSTDP  10
     C                     MOVE A6MDIN    WWSTMD  1
      *
     C                     ENDSR                           SUB002 ends
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB003 - PERFORM FILE UPDATING IN INSERT MODE                  *
      *******************************************************************
     C           SUB003    BEGSR
     C*
     C           @KYPOL    CHAINPMSBPDPD             01
     C*
     C           *IN01     IFEQ '1'                        B1
     C           ORRECI    ORNE 'D'
     C                     Z-ADD8         @DBASE           ***************
     C                     MOVEL'PMSBPDPD'@DBFIL           * DB ERROR 08 *
     C                     MOVELORPCNU    @DBKEY           ***************
     C                     MOVE ORPPTF    @DBKEY
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C*
     C** OBTAIN CUSTOMER AND TAX DETAILS
     C                     MOVE OUPCNU    @BTCNR
     C                     EXSR SUB009
     C*
     C** PERFROM SUB006 TO CALCULATE PURCHASED INTEREST, AND CHARGES
     C** FOR POOL TRADE. THE TOTAL AMOUNT CALCULATED IN SUB006 WILL
     C** THEN BE APPORTIONED BETWEEN THE POOL TRADES GENERATED
     C                     EXSR SUB006
     C*
     C** PERFORM SR/SUB007 TO SET UP FIELDS COMMON TO ALL TRADES
     C                     EXSR SUB007
     C*
     C** NOW READ THROUGH ALL MEMBERS OF THE POOL AND GENERATE TRADES
     C** FOR ALL POOL MEMBERS
     C**********           Z-ADDOUPCNU    WWPCNU                                              CSD027
     C                     MOVE OUPCNU    WWPCNU                                              CSD027
     C                     MOVE OUPPTF    WWPPTF
     C**********           Z-ADD*LOVAL    WWCNUM                                              CSD027
     C                     MOVE *BLANKS   WWCNUM                                              CSD027
     C                     MOVE *LOVAL    WWPTFR
     C*
     C           @KYMEM    SETLLPMSBPMPD
     C           @KYPOL    READEPMSBPMPD                 02
     C           *IN02     DOWEQ'0'                        B1
     C*
     C** PERFORM SR/SUB008 TO CALCULATE DETAILS UNIQUE FOR EACH TRADE
     C                     EXSR SUB008
     C*
     C** GET NEXT TRANSACTION NUMBER
     C                     EXSR ZTNLU1
     C                     Z-ADDNATN      @BTNLU
     C*
     C** PERFORM SR/SUB300 TO UPDATE TRADE DETAILS
     C                     EXSR SUB300
     C*
     C** UPDATE SE DATABASE IF TRADE GENERATED IS COMPLETE
     C           @BTINC    IFEQ 'C'                        B2
     C*
     C** PERFORM SR/SUB500 TO UPDATE COUNT OF CLIENT POSITIONS
     C                     EXSR SUB500
     C*
     C** PERFORM SR/SUB501 TO UPDATE CLIENT DEPOT POSITIONS
     C                     MOVE 'I'       WWCHTP  1
     C**********           MOVE @BDELF    W1DELF  60                                          CSD027
     C**********           MOVE @BDELT    W1DELT  60                                          CSD027
     C                     MOVE @BDELF    W1DELF  6                                           CSD027
     C                     MOVE @BDELT    W1DELT  6                                           CSD027
     C                     EXSR SUB501
     C*
     C** PERFORM SR/SUB502 TO UPDATE MEMOS
     C   U1                EXSR SUB502
     C*
     C** PERFORM SR/SUB503 TO UPDATE OLPOS
     C                     MOVE @BSETC    W1SETC
     C                     EXSR SUB503
     C*
     C** PERFORM SR/SUB504 TO UPDATE BOOK POSITIONS
     C                     EXSR SUB504
     C*
     C** PERFORM SR/SUB505 TO UPDATE CUSTOMER DEPOT POSITIONS
     C                     EXSR SUB505
     C*
     C** PERFORM SR/SUB506 TO UPDATE USER POSITIONS
     C                     MOVE 'I'       WWCHTP  1
     C                     MOVE @BDELF    W1DELF
     C                     MOVE @BDELT    W1DELT
     C                     EXSR SUB506
     C*
     C** OTHERWISE AND INCOMPLETE TRADE HAS BEEN GENERATED FOR MANUAL
     C** - WRITE TRADE DETAILS TO ERROR REPORT
     C                     ELSE                            X2
     C                     EXSR SUB200
     C                     END                             E2
     C*
     C** COMMIT FILE UPDATES
     C                     MOVEL@BCHTP    @ACTN
     C                     Z-ADDNATN      @NTN
     C                     TIME           @TIME
     C           @CMTXT    COMIT
     C*
     C** OBTAIN DETAILS OF NEXT MEMBER PORTFOLIO
     C           @KYPOL    READEPMSBPMPD                 02
     C                     END                             E1
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB004 - PERFORM FILE UPDATING IN AMEND MODE                   *
      *******************************************************************
     C           SUB004    BEGSR
     C*
     C** READ THROUGH ALL TRADES GENERATED FOR POOL TRADE
     C           OUBLKR    SETLLTRADBK
     C           OUBLKR    READETRADBK                   01
     C*
     C           *IN01     DOWEQ'0'                        B1
     C*
     C** ONLY PERFORM FOLLOWING PROCESSING FOR POOL TRADE SIDE
     C           PTFR      IFNE *BLANKS                    B2
     C*
     C** MOVE TRADE DETAILS INTO WORKFIELDS
     C                     MOVE @TRDDS    @BLKDS
     C*
     C** CHECK WHETHER TRADE CAN BE AMENDED
     C                     EXSR AMDSTS
     C*
     C** SAVE BEFORE UPDATE STATUS OF FIELDS TO BE USED IN UPDATE
     C** PROCEDURES
     C                     Z-ADDTOSV      WWTOSV 150
     C**********           MOVE PYFM      WWPYFM 12                                           CGL029
     C**********           MOVE PAYT      WWPAYT 12                                           CGL029
     C                     MOVE PYFM      WWPYFM 18                                           CGL029
     C                     MOVE PAYT      WWPAYT 18                                           CGL029
     C                     MOVE SETC      WWSETC  3
     C**********           MOVE DELF      WWDELF  60                                          CSD027
     C**********           MOVE DELT      WWDELT  60                                          CSD027
     C                     MOVE DELF      WWDELF  6                                           CSD027
     C                     MOVE DELT      WWDELT  6                                           CSD027
     C                     Z-ADDSMTH      WWSMTH  20
     C*
     C                     MOVE 'Y'       WWACCF
     C*
     C** MOVE FIELDS WHICH MAY BE AMENDED FROM PF/PMPLTRPD FIELDS TO
     C** UPDATE FIELDS
     C                     MOVE OULKRF    @BLKRF
     C                     MOVE OUTDNR    @BTDNR
     C                     MOVE OUTDID    @BTDID
     C                     MOVE OUAIIP    @BAIIP
     C                     MOVE OUTMKC    @BTMKC
     C                     Z-ADDOUTCAP    @BTCAP
     C**********           Z-ADDOUDELT    @BDELT                                              CSD027
     C**********           Z-ADDOUDELF    @BDELF                                              CSD027
     C                     MOVE OUDELT    @BDELT                                              CSD027
     C                     MOVE OUDELF    @BDELF                                              CSD027
     C                     MOVE OUAUTS    @BAUTS
     C                     MOVE OUSETC    @BSETC
     C                     MOVE OUTDER    @BTDER
     C                     MOVE OUTMDI    @BTMDI
     C                     MOVE OUTBCR    @BTBCR
     C                     MOVE OUCHTP    @BCHTP
     C*
     C** CALCULATE NEW TOTAL AMOUNT TO BE SETTLED
     C           @BTDER    IFNE 0                          B3
     C                     Z-ADD@BTCTR    ZAMTF
     C                     Z-ADD@BTDER    ZCRSRT
     C                     MOVE @BTMDI    ZCRSMD
     C                     MOVE WWNMDP    ZCDPF
     C                     MOVE WWSTDP    ZCDPT
     C                     EXSR ZCCYXR
     C                     Z-ADDZAMTT     @BTOSV
     C                     ELSE                            X3
     C                     Z-ADD@BTCTR    @BTOSV
     C                     END                             E3
     C*                                                                   CAC003
     C** Calculate the Margin Rate                                        CAC003
     C                     MOVE OUFXMP    @BFXMP                          CAC003
     C                     MOVE OUFXMR    @BFXMR                          CAC003
     C                     Z-ADD0         @BMAMT                          CAC003
     C*                                                                   CAC003
     C           *IN40     IFEQ '1'                                       CAC003
     C           OUSETC    ANDNENMCYA                                     CAC003
     C           @BFXMR    ANDNE0                                         CAC003
     C*                                                                   CAC003
     C           @BTDTP    IFEQ 'TP'                                      CAC003
     C           @BTMDI    ANDEQ'M'                                       CAC003
     C           @BTDTP    OREQ 'TS'                                      CAC003
     C           @BTMDI    ANDEQ'D'                                       CAC003
     C           @BTDER    ADD  @BFXMR    ZCRSRT                          CAC003
     C                     ELSE                                           CAC003
     C           @BTDER    SUB  @BFXMR    ZCRSRT                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     Z-ADD@BTCTR    ZAMTF                           CAC003
     C                     EXSR ZCCYXR                                    CAC003
     C                     Z-ADDZAMTT     WTOSV1 150                      CAC003
     C*                                                                   CAC003
     C           @BTDTP    IFEQ 'TP'                                      CAC003
     C           WTOSV1    SUB  @BTOSV    @BMAMT                          CAC003
     C                     ELSE                                           CAC003
     C           @BTOSV    SUB  WTOSV1    @BMAMT                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*
     C** IF SETTLEMENT CURRENCY HAS CHANGED DETERMINE SETTLEMENT ACCOUNT
     C** NOTE: SAVE ANY EXISTING ERROR CODES BEFORE PERFORMING ROUTINE
     C                     MOVE 'N'       WWEXST  1
     C           WWERR     IFNE 0
     C                     MOVE 'Y'       WWEXST  1
     C                     Z-ADDWWERR     WWERRS  30
     C                     END
     C*
     C           OUSETC    IFNE OBSETC                     B3
     C                     EXSR SUB010
     C                     END                             E3
     C*
     C           WWEXST    IFEQ 'Y'
     C                     Z-ADDWWERRS    WWERR
     C                     END
     C*
     C** IF TRADE CAN BE AMENDED AND ACCOUNT DETAILS FOUND UPDATE SE
     C** DATABASE
     C           WWACCF    IFEQ 'Y'                        B3
     C           WWAMND    ANDEQ'Y'
     C*
     C** GET NEXT TRANSACTION NUMBER
     C                     EXSR ZTNLU1
     C                     Z-ADDNATN      @BTNLU
     C*
     C** UPDATE TRADE DETAILS
     C                     EXSR SUB300
     C*
     C** PERFORM SR/SUB501 TO DELETE BEFORE UPDATE DETAILS
     C                     MOVE 'D'       WWCHTP  1
     C                     MOVE WWDELF    W1DELF
     C                     MOVE WWDELT    W1DELT
     C                     EXSR SUB501
     C*
     C** PERFORM SR/SUB501 TO UPDATE CLIENT POSITIONS
     C                     MOVE 'I'       WWCHTP  1
     C                     MOVE @BDELF    W1DELF
     C                     MOVE @BDELT    W1DELT
     C                     EXSR SUB501
     C*
     C** PERFORM SR/SUB502 TO UPDATE MEMOS
     C   U1                EXSR SUB502
     C*
     C** PERFORM SR/SUB506 TO DELETE BEFORE UPDATE DETAILS
     C                     MOVE 'D'       WWCHTP  1
     C                     MOVE WWSETC    W1SETC
     C                     Z-ADDWWTOSV    WCVAL
     C                     EXSR SUB503
     C*
     C** PERFORM SR/SUB506 TO UPDATE USER POSITIONS
     C                     MOVE 'I'       WWCHTP  1
     C                     MOVE OUSETC    W1SETC
     C                     Z-ADD@BTOSV    WCVAL
     C                     EXSR SUB503
     C*
     C** PERFORM SR/SUB506 TO DELETE BEFORE UPDATE DETAILS
     C                     MOVE 'D'       WWCHTP  1
     C                     MOVE WWDELF    W1DELF
     C                     MOVE WWDELT    W1DELT
     C                     EXSR SUB506
     C*
     C** PERFORM SR/SUB506 TO UPDATE USER POSITIONS
     C                     MOVE 'I'       WWCHTP  1
     C                     MOVE @BDELF    W1DELF
     C                     MOVE @BDELT    W1DELT
     C                     EXSR SUB506
     C*
     C** PERFORM SR/SUB507 TO UPDATE SETTLEMENT DETAILS
     C                     EXSR SUB507
     C*
     C** COMMIT FILE UPDATES
     C                     MOVEL@BCHTP    @ACTN
     C                     Z-ADDNATN      @NTN
     C                     TIME           @TIME
     C           @CMTXT    COMIT
     C*
     C** OTHERWISE (TRADE MAY NOT BE AMENDED OR SETTLEMENT ACCOUNT NOT
     C** FOUND) OUTPUT DETAILS TO ERROR REPORT
     C                     ELSE                            X3
     C                     MOVE @BLKDS    @TRDDS
     C                     EXSR SUB200
     C                     END                             E3
     C*
     C                     END                             E2
     C*
     C           OUBLKR    READETRADBK                   01
     C                     END                             E1
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB005 - PERFORM TERMINATION PROCESSING                        *
      *******************************************************************
     C           SUB005    BEGSR
     C*
     C** CONDITION OUTPUT OF REPORT HEADING
     C           WWFRST    IFNE 'Y'
     C                     MOVE '1'       *IN60
     C                     ELSE
     C                     MOVE '0'       *IN60
     C                     END
     C*
     C** WRITE DETAILS TO OVERALL STATUS REPORT
     C*
     C                     MOVE 'N'       @PAGTR
     C           OUATRD    IFEQ 'Y'
     C                     MOVE 'Y'       @PAGTR
     C                     END
     C                     MOVE 'OVERALL' @PTDRF
     C*
     C** SET UP ERROR MESSAGE AND ACTION TEXT
     C           WWERR     IFEQ 0
     C                     Z-ADD1         I
     C                     MOVE @MS1,I    ERMES1
     C                     MOVE @MS2,I    ERMES2
     C                     ELSE
     C                     Z-ADD2         I
     C                     MOVE @MS1,I    ERMES1
     C                     MOVE @MS2,I    ERMES2
     C                     END
     C*
     C** IF FIRST TIME OR OVERFLOW OCCURRED OUTPUT REPORT TITLE
     C           *IN30     IFEQ '0'                                       S01486
     C                     OPEN SE5210P1                                  S01486
     C                     Z-ADD0         PAGE2                           S01486
     C                     EXSR RCFP1                                     S01486
     C                     MOVE '1'       *IN30                           S01486
     C                     ENDIF                                          S01486
     C           *IN60     IFEQ '1'                        B1
     C                     WRITEPM5110HD
     C                     WRITEPM5110D1
     C                     ELSE                            X1
     C                     WRITEPM5110D2               60
     C                     END                             E1
     C*
     C** WRITE REPORT TRAILER
     C                     WRITEPM5110TL               60
     C*
     C** IF ANY TRADE DETAILS WRITTEN TO TRADE ERROR REPORT WRITE
     C** TRAILER TO FILE
     C           WWGENE    IFEQ 'Y'
     C***********          WRITEPM5110R3                                  S01486
     C                     WRITENONE                                      S01486
     C                     END
     C*
     C** ACCESS POOL TRADE DETAILS AND RESET ALLOCATING JOB TO BLANK
     C           @XTNUM    CHAINPMPLTRPD             01
     C           *IN01     IFEQ '1'                        B1
     C           OURECI    ORNE 'D'
     C                     Z-ADD1         @DBASE           ***************
     C                     MOVEL'PMPLTRPD'@DBFIL           * DB ERROR 01 *
     C                     MOVEL@XTNUM    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C*
     C** UNLOCK RECORD ON PMPLTRPD
     C                     MOVE *BLANKS   OUJOB
     C                     UPDATPMPLTRP0
     C*
     C                     SETON                     LR
     C                     RETRN
     C*
     C                     ENDSR                                       B003
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB006 - CALCULATE CHARGES AND PURCHASED INTEREST FOR POOL     *
      *           NOMINAL                                               *
      *******************************************************************
     C           SUB006    BEGSR
     C*
     C** SET ALL POOL CHARGE DETAILS TO ZERO
     C                     Z-ADD0         @CTBCA 150
     C                     Z-ADD0         @CTCCA 150
     C                     Z-ADD0         @CTCA1 150
     C                     Z-ADD0         @CTCA2 150
     C                     Z-ADD0         @CTCA3 150
     C                     Z-ADD0         @CTCA4 150
     C                     Z-ADD0         @CTCA5 150
     C                     Z-ADD0         @CTCA6 150
     C                     Z-ADD0         @CTCA7 150
     C                     Z-ADD0         @CTAXA 150
     C                     Z-ADD0         @CBCMR 150
     C                     Z-ADD0         @CCCMR 150
     C                     Z-ADD0         @CTXRB 150
     C*                                                                 **
     C** DETERMINE CHARGES FOR POOL CUSTOMER                             *
     C*                                                                 **
     C** IF BROKER COMMISSION CODE BLANK SET BROKER COMMISSION TO        *
     C** CHARGES INCURRED ON MARKET SIDE OF TRADE                        *
     C           OUTBCC    IFEQ *BLANKS
     C                     Z-ADDOUMCHG    @CTBCA
     C                     ELSE
     C                     MOVE OUTBCC    @XCODE
     C                     EXSR SUB700
     C                     Z-ADD@XAMTN    @CTBCA
     C*
     C                     EXSR CALTAX
     C                     ADD  @WTAX     @CTAXA
     C                     END
     C*
     C** IF THE CUSTOMER COMMISSION CODE IS NON-BLANK CALCULATE THE
     C** CUSTOMER COMMISSION
     C           OUTCCC    IFNE *BLANKS
     C                     MOVE OUTCCC    @XCODE
     C                     EXSR SUB700
     C                     Z-ADD@XAMTN    @CTCCA
     C*
     C                     Z-ADD@XAMTN    @WCHGA
     C                     EXSR CALTAX
     C                     ADD  @WTAX     @CTAXA
     C                     END
     C*
     C** IF THE CUSTOMER CHARGE CODE 1 IS NON-BLANK CALCULATE THE
     C** CUSTOMER CHARGE
     C           OUTCC1    IFNE *BLANKS
     C                     MOVE OUTCC1    @XCODE
     C                     EXSR SUB700
     C                     Z-ADD@XAMTN    @CTCA1
     C*
     C                     Z-ADD@XAMTN    @WCHGA
     C                     EXSR CALTAX
     C                     ADD  @WTAX     @CTAXA
     C                     END
     C*
     C** IF THE CUSTOMER CHARGE CODE 2 IS NON-BLANK CALCULATE THE
     C** CUSTOMER CHARGE
     C           OUTCC2    IFNE *BLANKS
     C                     MOVE OUTCC2    @XCODE
     C                     EXSR SUB700
     C                     Z-ADD@XAMTN    @CTCA2
     C*
     C                     Z-ADD@XAMTN    @WCHGA
     C                     EXSR CALTAX
     C                     ADD  @WTAX     @CTAXA
     C                     END
     C*
     C** IF THE CUSTOMER CHARGE CODE 3 IS NON-BLANK CALCULATE THE
     C** CUSTOMER CHARGE
     C           OUTCC3    IFNE *BLANKS
     C                     MOVE OUTCC3    @XCODE
     C                     EXSR SUB700
     C                     Z-ADD@XAMTN    @CTCA3
     C*
     C                     Z-ADD@XAMTN    @WCHGA
     C                     EXSR CALTAX
     C                     ADD  @WTAX     @CTAXA
     C                     END
     C*
     C** IF THE CUSTOMER CHARGE CODE 4 IS NON-BLANK CALCULATE THE
     C** CUSTOMER CHARGE
     C           OUTCC4    IFNE *BLANKS
     C                     MOVE OUTCC4    @XCODE
     C                     EXSR SUB700
     C                     Z-ADD@XAMTN    @CTCA4
     C*
     C                     Z-ADD@XAMTN    @WCHGA
     C                     EXSR CALTAX
     C                     ADD  @WTAX     @CTAXA
     C                     END
     C*
     C** IF THE CUSTOMER CHARGE CODE 5 IS NON-BLANK CALCULATE THE
     C** CUSTOMER CHARGE
     C           OUTCC5    IFNE *BLANKS
     C                     MOVE OUTCC5    @XCODE
     C                     EXSR SUB700
     C                     Z-ADD@XAMTN    @CTCA5
     C*
     C                     Z-ADD@XAMTN    @WCHGA
     C                     EXSR CALTAX
     C                     ADD  @WTAX     @CTAXA
     C                     END
     C*
     C** IF THE CUSTOMER CHARGE CODE 6 IS NON-BLANK CALCULATE THE
     C** CUSTOMER CHARGE
     C           OUTCC6    IFNE *BLANKS
     C                     MOVE OUTCC6    @XCODE
     C                     EXSR SUB700
     C                     Z-ADD@XAMTN    @CTCA6
     C*
     C                     Z-ADD@XAMTN    @WCHGA
     C                     EXSR CALTAX
     C                     ADD  @WTAX     @CTAXA
     C                     END
     C*
     C** IF THE CUSTOMER CHARGE CODE 6 IS NON-BLANK CALCULATE THE
     C** CUSTOMER CHARGE
     C           OUTCC7    IFNE *BLANKS
     C                     MOVE OUTCC7    @XCODE
     C                     EXSR SUB700
     C                     Z-ADD@XAMTN    @CTCA7
     C*
     C                     Z-ADD@XAMTN    @WCHGA
     C                     EXSR CALTAX
     C                     ADD  @WTAX     @CTAXA
     C                     END
     C*
     C** CALCULATE TOTAL BROKER COMMISSION REBATE
     C           @CTBCA    IFNE *ZERO
     C           OUBCMR    ANDNE*ZERO
     C*
     C**  MULTIPLY THE BROKER COMMISSION BY THE REBATE PERCENTAGE
     C           @CTBCA    MULT OUBCMR    @CBCMR
     C                     END
     C*
     C** CALCULATE TOTAL CUSTOMER COMMISSION REBATE
     C           OUTCCC    IFNE *BLANKS
     C           @CTCCA    ANDNE*ZERO
     C           OUCCMR    ANDNE*ZERO
     C*
     C**  MULTIPLY THE CUSTOMER COMMISSION BY THE REBATE PERCENTAGE
     C           @CTCCA    MULT OUCCMR    @CCCMR
     C                     END
     C*
     C** CALCULATE TOTAL TAX REBATE
     C           @CTAXA    IFNE *ZERO
     C           OUTXRB    ANDNE*ZERO
     C*
     C**  MULTIPLY THE CUSTOMER COMMISSION BY THE REBATE PERCENTAGE
     C           @CTBCA    MULT OUTXRB    @CTXRB
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
      /EJECT
      *******************************************************************
      *  SUB007 - PERFORM SUBROUTINE TO SET UP COMMON DETAILS           *
      *******************************************************************
     C*
     C           SUB007    BEGSR
     C*
     C** SET UP FIELDS
     C                     MOVE OURECI    @BRECI
     C                     MOVE OUTDSS    @BTDSS
     C                     MOVE OUTDTP    @BTDTP
     C                     MOVE OUTPDY    @BTPDY
     C                     Z-ADDOUTDVD    @BTDVD
     C***********          Z-ADDOUTDBR    @BTDBR                          S01486
     C                     MOVELOUTDBR    @BTDBR                          S01486
     C                     MOVELOUTDBR    @BORBR                          119556
     C                     MOVE OUTDBK    @BTDBK
     C                     Z-ADDOUTDDT    @BTDDT
     C                     MOVE OUTSUB    @BTSUB
     C                     MOVE OULKRF    @BLKRF
     C                     MOVE OUTDMI    @BTDMI
     C                     MOVE OUTDNR    @BTDNR
     C                     MOVE OUTDID    @BTDID
     C                     MOVE OUAIIP    @BAIIP
     C                     MOVE OUTMKC    @BTMKC
     C                     Z-ADD0         @BTCFC
     C                     MOVE OUACIN    @BACIN
     C                     Z-ADDOUDADJ    @BDADJ
     C                     MOVE OUADIN    @BADIN
     C                     Z-ADDCPNR      @BTDCR
     C                     Z-ADDOUPRIC    @BPRIC
     C                     MOVE OUEXDV    @BEXDV
     C                     Z-ADDOUTCAP    @BTCAP
     C                     Z-ADDOURALL    @BRALL
     C                     MOVE *BLANKS   @BTDFA
     C                     Z-ADD0         @BASNM
     C                     MOVE OUCLTY    @BCLTY
     C                     MOVE 'R'       @BPRYC
     C**********           Z-ADDOUDELF    @BDELF                                              CSD027
     C**********           Z-ADDOUDELT    @BDELT                                              CSD027
     C                     MOVE OUDELF    @BDELF                                              CSD027
     C                     MOVE OUDELT    @BDELT                                              CSD027
     C                     MOVE *BLANKS   @BDTFA
     C                     MOVE *BLANKS   @BDFFA
     C                     MOVE *BLANKS   @BTDSI
     C                     MOVE '0'       @BPCOD
     C                     MOVE OUTBCC    @BTBCC
     C                     MOVE OUTCCC    @BTCCC
     C                     MOVE OUTCC1    @BTCC1
     C                     MOVE OUTCC2    @BTCC2
     C                     MOVE OUTCC3    @BTCC3
     C                     MOVE OUTCC4    @BTCC4
     C                     MOVE OUTCC5    @BTCC5
     C                     MOVE OUTCC6    @BTCC6
     C                     MOVE OUTCC7    @BTCC7
     C                     MOVE OUBLKR    @BBLKR
     C                     MOVE *BLANKS   @BRTRF
     C                     Z-ADDOUFXMP    @BFXMP                          CAC003
     C                     Z-ADDOUFXMR    @BFXMR                          CAC003
     C*
     C           OUATRD    IFEQ 'Y'
     C                     MOVE 'C'       @BATRD
     C                     ELSE
     C                     MOVE *BLANKS   @BATRD
     C                     END
     C*
     C                     MOVE ' '       @BBCON
     C                     TIME           @BTIME
     C                     MOVE OUAUTS    @BAUTS
     C**********           Z-ADDOUDELF    @BDELF                                              CSD027
     C                     MOVE OUDELF    @BDELF                                              CSD027
     C                     MOVE OUAUTS    @BAUTS
     C                     BITOF'01234567'@BTACI
     C                     BITOF'01234567'@BTMSI
     C                     MOVE 'Y'       @BTCFR
     C                     Z-ADD0         @BTNSN
     C                     Z-ADD0         @BTNSP
     C                     Z-ADD0         @BTVSP
     C                     Z-ADD0         @BTVSN
     C                     Z-ADD0         @BTDSN
     C                     Z-ADD0         @BTDSP
     C                     Z-ADD0         @BTDFS
     C                     Z-ADD0         @BTSSQ
     C                     Z-ADDBJRDNB    @BTOED
     C                     Z-ADDBJRDNB    @BLCD
     C                     MOVE OUCHTP    @BCHTP
     C                     Z-ADD0         @BLSWS
     C*
     C                     ENDSR
     C********************************************************************
      /EJECT
      *******************************************************************
      *  SUB008 - GENERATE DETAILS UNIQUE TO EACH TRADE                 *
      *******************************************************************
     C*
     C           SUB008    BEGSR
     C*
     C** CALCULATE TRADE REFERENCE
     C*
     C** GET NEXT TRADE NUMBER AVAILABLE
     C                     MOVE '00'      WWRECT  20
     C                     MOVE *BLANKS   ZZ008   8
     C                     MOVE ORRANG    WWRANG  20
     C*
     C           TRAKEY    CHAINTNRAN                01
      *
     C           *IN01     IFEQ '1'                        B1
     C           RECI      OREQ '*'
     C                     Z-ADD13        @DBASE           ***************
     C                     MOVEL'TNRAN'   @DBFIL           * DB ERROR 13 *
     C                     MOVELNTRN      @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C*
     C** IF TRADE ALREADY EXISTS WITH THIS TRADE NUMBER LOOP THROUGH TO
     C** FIND NEXT UNUSED TRADE REFERENCE
     C                     MOVE NTRN      NTRNA   6
     C           NTRNA     CHAINTRADHS               01
     C           *IN01     DOWEQ'0'                        B1
     C           NTRN      ANDLELTIR
     C                     ADD  1         NTRN
     C                     MOVE NTRN      NTRNA   6
     C           NTRNA     CHAINTRADHS               01
     C                     END                             E1
     C*
     C** ERROR IF TRADE NUMBER *GT TO UPPER TRADE NUMBER LIMIT
     C           NTRN      IFGT LTIR                       B1
     C                     Z-ADD4         WWERR   30
     C                     EXSR SUB200
     C*
     C** ...OTHERWISE UPDATE LF/TNRAN WITH NEXT AVAILABLE TRADE REFERENCE
     C                     ELSE                            X1
     C                     MOVE NTRN      @BTDRF
     C                     ADD  1         NTRN
     C                     UPDATTNRANABF
     C                     END                             E1          2
     C*
     C** MEMBER CUSTOMER AND PORTFOLIO REFERENCE
     C                     MOVE OSCNUM    @BTCNR
     C                     MOVE OSPTFR    @BPTFR
     C*
     C** CALCULATE PROPORTION OF NOMINAL, CHARGES AND PURCHASED
     C** INTEREST TO BE ASSIGNED TO TRADE
     C*
     C           OUCLRH    IFEQ 'Y'                        B1
     C           @PMCPO    CHAINPMCPOSLL             01
     C*
     C           *IN01     IFEQ '1'                        B2
     C                     Z-ADD*ZEROS    WWFACT
     C                     Z-ADD*ZEROS    @BNOML
     C*
     C                     ELSE                            X2
     C           QANOML    DIV  OUTNOM    WWFACT    H
     C                     Z-ADDQANOML    @BNOML
     C                     END                             E2
     C*
     C                     ELSE                            X1
     C           OSNOUN    DIV  ORNOUN    WWFACT 158H
     C           OUTNOM    MULT WWFACT    @BNOML    H
     C                     END                             E1
     C*
     C** SET PURCHASED INTEREST AND INTEREST ADJUSTMENT AMOUNT TO ZERO
     C                     MOVE *ZEROS    @BITRA
     C                     MOVE *ZEROS    @BTINA
      *                                                                                       CAS006
      ** Set ITRN and TINN using Net-Treasury Rate to zero.                                   CAS006
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     MOVE *ZEROS    @BITRN                                              CAS006
     C                     MOVE *ZEROS    @BTINN                                              CAS006
     C                     ENDIF                                                              CAS006
     C*
     C** CALCULATE PURCHASED INTEREST FOR INTEREST BEARING SECURITIES
     C           PROT      IFEQ '1'                        B1
     C           PROT      OREQ '3'
     C           PROT      OREQ '5'
     C           PROT      OREQ '8'
     C           PROT      OREQ '9'
     C*
     C           STBS      IFEQ 'P'                        B2
     C           STBS      OREQ 'Y'
     C*
     C** ONLY CALCULATE INTEREST IF TRADE NOT FLAT AND VALUE DATE *GE
     C** INITIAL DATE
     C           OUACIN    IFNE 'F'                        B3
     C           OUTDVD    ANDGEITLD
     C*
     C** IF TRADE IS CUM COUPON CALCULATE LAST COUPON DATE
     C           OUACIN    IFEQ 'C'                        B4
     C                     Z-ADDOUTDVD    ZECD
     C                     EXSR ZLCD
     C*
     C** PERFORM SR/ZAINSH TO CALCULATE INTEREST ACCRUED FROM COUPON
     C** DATE TO TRADE VALUE DATE
     C                     Z-ADD@BNOML    ZAMTP
     C                     Z-ADDZZLCD     ZFMDAT
     C                     Z-ADDOUTDVD    ZTODAT
     C                     MOVELOUTDSS    ZSSNM
     C                     Z-ADDWWNMDP    A6NBDP
     C                     Z-ADD0         CDP     10
     C                     EXSR ZAINSH
     C                     Z-ADDZTOAI     @BITRA
     C                     END                             E4
     C*
     C** IF TRADE IS EX-COUPON CALCULATE NEXT COUPON DATE
     C           OUACIN    IFEQ 'X'                        B4
     C                     Z-ADDOUTDVD    ECD     50
     C                     EXSR ZNCD
     C*
     C** PERFORM SR/ZAINSH TO CALCULATE INTEREST ACCRUED FROM VALUE
     C** DATE TO NEXT COUPON DATE
     C                     Z-ADD@BNOML    ZAMTP
     C                     Z-ADDOUTDVD    ZFMDAT
     C                     Z-ADDNCD       ZTODAT
     C                     MOVELOUTDSS    ZSSNM
     C                     Z-ADDWWNMDP    A6NBDP
     C                     EXSR ZAINSH
     C                     Z-SUBZTOAI     @BITRA
     C                     END                             E4
      *                                                                                       CAS006
      ** If CAS006 is on, calculate for ITRN and TINN                                         CAS006
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADDOUTDVD    ECD                                                 CAS006
     C                     EXSR ZNCD                                                          CAS006
     C*                                                                                       CAS006
     C** Perform SR/ZAINSNTR to calculate interest accrued from value                         CAS006
     C** date to next coupon date                                                             CAS006
     C                     Z-ADD@BNOML    ZAMTP                                               CAS006
     C                     Z-ADDOUTDVD    ZFMDAT                                              CAS006
     C                     Z-ADDNCD       ZTODAT                                              CAS006
     C                     MOVELOUTDSS    ZSSNM                                               CAS006
     C                     Z-ADDWWNMDP    A6NBDP                                              CAS006
     C*                                                                                       CAS006
     C                     CALL 'ZAINSNTR'                                                    CAS006
     C                     PARM *ZEROS    ZAMTP  150                                          CAS006
     C                     PARM *ZEROS    ZFMDAT  50                                          CAS006
     C                     PARM *ZEROS    ZTODAT  50                                          CAS006
     C                     PARM *BLANKS   ZSSNM  10                                           CAS006
     C                     PARM *ZEROS    ZTOAI  150                                          CAS006
     C                     PARM *ZEROS    ZTOND   50                                          CAS006
     C*                                                                                       CAS006
     C                     Z-SUBZTOAI     @BITRN                                              CAS006
     C                     ENDIF                                                              CAS006
     C*
     C** IF DAYS INTEREST ADJUSTMENT NON-ZERO CALCULATE INTEREST
     C** ADJUSTMENT AMOUNT
     C                     Z-ADD0         WPADJ
     C           OUDADJ    IFNE 0                          B4
     C                     EXSR ZDYYR
     C                     EXSR SUB401
     C***********OUADIN    IFEQ 'D'                        B5
     C                     ADD  WPADJ     @BTINA
     C***********          ELSE                            X5
     C***********          ADD  WPADJ     @BTINA
     C***********          END                             E5
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C           @CTBCA    MULT WWFACT    @BTBCA    H
     C*
     C           @CTCCA    MULT WWFACT    @BTCCA    H
     C*
     C           @CTCA1    MULT WWFACT    @BTCA1    H
     C*
     C           @CTCA2    MULT WWFACT    @BTCA2    H
     C*
     C           @CTCA3    MULT WWFACT    @BTCA3    H
     C*
     C           @CTCA4    MULT WWFACT    @BTCA4    H
     C*
     C           @CTCA5    MULT WWFACT    @BTCA5    H
     C*
     C           @CTCA6    MULT WWFACT    @BTCA6    H
     C*
     C           @CTCA7    MULT WWFACT    @BTCA7    H
     C*
     C           @CTAXA    MULT WWFACT    @BTAXA    H
     C*
     C           @CBCMR    MULT WWFACT    @BBCMR    H
     C*
     C           @CCCMR    MULT WWFACT    @BCCMR    H
     C*
     C           @CTXRB    MULT WWFACT    @BTXRB    H
     C*
     C** DETERMINE SETTLEMENT INSTRUCTIONS
     C                     EXSR SUB010
     C*
     C** CALCULATE REALLOWANCE RATE FOR DISCOUNT SECURITY
     C                     Z-ADDOURALL    WDRALL
     C*
     C           STBS      IFEQ 'D'                        B1
     C           OURALL    ANDNE0
     C                     Z-ADDOUTDVD    ZSDATE
     C                     Z-ADDMATY      ZEDATE
     C                     MOVE 'N'       DADJN                           100017
     C                     EXSR ZDAYS
     C                     MOVE ' '       DADJN                           100017
     C                     Z-ADDZDDAYS    #DDAYS  50
     C                     EXSR ZDYYR
     C           ZINTDD    IFNE 0                          B2
     C           OURALL    MULT #DDAYS    WPRICE 155
     C           WPRICE    DIV  ZINTDD    WCRALL    H
     C*
     C           WCRALL    IFGE 0                          B3
     C           1         SUB  WCRALL    WDRALL 158
     C                     ELSE                            X3
     C                     Z-SUBWCRALL    WCRALL 158
     C           1         SUB  WCRALL    WDRALL
     C                     Z-SUBWDRALL    WDRALL
     C                     END                             E3
     C*
     C                     ELSE
     C                     Z-ADD0         WDRALL
     C                     END                             E2
     C*
     C                     END                             E1
     C*
     C** SET UP SIGN OF CHARGES AND COMMISSIONS
     C           @BTDTP    IFEQ 'TP'                       B1
     C                     Z-SUB@BTBCA    TBCA
     C                     Z-SUB@BTCCA    TCCA
     C                     Z-SUB@BTCA1    TCA1
     C                     Z-SUB@BTCA2    TCA2
     C                     Z-SUB@BTCA3    TCA3
     C                     Z-SUB@BTCA4    TCA4
     C                     Z-SUB@BTCA5    TCA5
     C                     Z-SUB@BTCA6    TCA6
     C                     Z-SUB@BTCA7    TCA7
     C                     Z-SUB@BTAXA    TAXA
     C                     Z-SUB@BBCMR    BCMR
     C                     Z-SUB@BCCMR    CCMR
     C                     Z-SUB@BTXRB    TXRB
     C                     Z-SUB@BTBCA    @BTBCA                          54694
     C                     Z-SUB@BTCCA    @BTCCA                          54694
     C                     Z-SUB@BTCA1    @BTCA1                          54964
     C                     Z-SUB@BTCA2    @BTCA2                          54964
     C                     Z-SUB@BTCA3    @BTCA3                          54964
     C                     Z-SUB@BTCA4    @BTCA4                          54964
     C                     Z-SUB@BTCA5    @BTCA5                          54964
     C                     Z-SUB@BTCA6    @BTCA6                          54964
     C                     Z-SUB@BTCA7    @BTCA7                          54964
     C                     Z-SUB@BTAXA    @BTAXA                          54964
     C                     Z-SUB@BBCMR    @BBCMR                          54964
     C                     Z-SUB@BCCMR    @BCCMR                          54964
     C                     Z-SUB@BTXRB    @BTXRB                          54964
     C                     ELSE                            X1
     C                     Z-ADD@BTBCA    TBCA
     C                     Z-ADD@BTCCA    TCCA
     C                     Z-ADD@BTCA1    TCA1
     C                     Z-ADD@BTCA2    TCA2
     C                     Z-ADD@BTCA3    TCA3
     C                     Z-ADD@BTCA4    TCA4
     C                     Z-ADD@BTCA5    TCA5
     C                     Z-ADD@BTCA6    TCA6
     C                     Z-ADD@BTCA7    TCA7
     C                     Z-ADD@BTAXA    TAXA
     C                     Z-ADD@BBCMR    BCMR
     C                     Z-ADD@BCCMR    CCMR
     C                     Z-ADD@BTXRB    TXRB
     C                     END                             E1
     C*
     C** CALCULATE CONSIDERATION AND COUNTERVALUE VIA SR/ZCOTR
     C                     MOVE @C1DI     C1DI
     C                     MOVE NMCY      NMCYX   3
     C                     MOVE NMCYA     NMCY
     C                     Z-ADDWDRALL    ZWRALL
     C                     Z-ADD@BPRIC    PRIC
     C                     Z-ADD@BNOML    NOML
     C                     Z-ADD@BRALL    RALL
     C******###  @BITRA    ADD  @BTINA    ITRA
     C                     Z-ADD@BITRA    ITRA
     C                     MOVE @BTDTP    TDTP
     C***********          Z-ADD0         ZPRC   158                      S01486
     C                     Z-ADD0         ZPRC   169                      S01486
     C                     Z-ADDWWNMDP    ZCDP                            118892
     C                     EXSR ZCOTR                                   E21065
     C                     MOVE NMCYX     NMCY
     C                     Z-ADDZCTRVL    WCVAL  150
     C                     Z-ADDZCTRVL    @BTCTR
     C                     Z-ADDZCONS     @BTCSR
     C*
     C                     Z-ADD@BNOML    @BTOSN
     C*
     C** SET UP OUTSTANDING VALUE IN SETTLEMENT CURRENCY
     C           @BTDER    IFNE 0
     C                     Z-ADD@BTCTR    ZAMTF
     C                     Z-ADD@BTDER    ZCRSRT
     C                     MOVE @BTMDI    ZCRSMD
     C                     MOVE WWNMDP    ZCDPF
     C                     MOVE WWSTDP    ZCDPT
     C                     EXSR ZCCYXR
     C                     Z-ADDZAMTT     @BTOSV
     C                     ELSE
     C                     Z-ADD@BTCTR    @BTOSV
     C                     END
     C*                                                                   CAC003
     C** Calculate the Margin Amount                                      CAC003
     C                     Z-ADD0         @BMAMT                          CAC003
     C*                                                                   CAC003
     C           *IN40     IFEQ '1'                                       CAC003
     C*                                                                   CAC003
     C           @BSETC    IFNE NMCYA                                     CAC003
     C           @BFXMR    ANDNE0                                         CAC003
     C*                                                                   CAC003
     C           @BTDTP    IFEQ 'TP'                                      CAC003
     C           @BTMDI    ANDEQ'M'                                       CAC003
     C           @BTDTP    OREQ 'TS'                                      CAC003
     C           @BTMDI    ANDEQ'D'                                       CAC003
     C           @BTDER    ADD  @BFXMR    ZCRSRT                          CAC003
     C                     ELSE                                           CAC003
     C           @BTDER    SUB  @BFXMR    ZCRSRT                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     Z-ADD@BTCTR    ZAMTF                           CAC003
     C                     EXSR ZCCYXR                                    CAC003
     C*                                                                   CAC003
     C                     Z-ADDZAMTT     WTOSV1 150                      CAC003
     C*                                                                   CAC003
     C           @BTDTP    IFEQ 'TP'                                      CAC003
     C           WTOSV1    SUB  @BTOSV    @BMAMT                          CAC003
     C                     ELSE                                           CAC003
     C           @BTOSV    SUB  WTOSV1    @BMAMT                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   119374
     C           BGN0ST    IFEQ 'Y'                                       119374
     C*                                                                   119374
     C** Determine the Book Profit Centre                                 119374
     C*                                                                   119374
      *                                                                   CAC005
      ** Perform this only if CAC005 is off.                              CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'N'                                       CAC005
      *                                                                   CAC005
     C           KLPCBD    CHAINSEPCBD               62                   119374
     C           *IN62     IFEQ '0'                                       119374
     C                     MOVE PCBK      @BBPRC                          119374
     C                     ELSE                                           119374
     C           *IN40     IFEQ '1'                                       CAC003
     C                     MOVE PNPRFC    @BBPRC                          CAC003
     C                     MOVE 'I'       @BTINC                          CAC003
     C                     Z-ADD12        WWERR                           CAC003
     C                     MOVE '0'       *IN62                           CAC003
     C                     ELSE                                           CAC003
     C                     MOVELOSCNUM    WWCUST 10                       179732
     C                     CALL 'AOCUSTR0'                                179732
     C                     PARM *BLANKS   @RTCD   7                       179732
     C                     PARM '*KEY   ' @OPTN   7                       179732
     C                     PARM WWCUST    @CKEY  10                       179732
     C                     PARM *BLANKS   @KYST   7                       179732
     C           SDCUST    PARM SDCUST    DSSDY                           179732
     C*                                                                   179732
     C           @RTCD     IFNE *BLANK                                    179732
     C                     Z-ADD27        @DBASE           ***************179732
     C                     MOVEL'SDCUSTPD'@DBFIL           * DB ERROR 27 *179732
     C                     MOVELWWCUST    @DBKEY           ***************179732
     C                     Z-ADD3         WWERR                           179732
     C                     EXSR SUB999                                    179732
     C                     END                             E2             179732
     C*                                                                   179732
     C                     MOVELBBACOC    @ACOC                           179732
     C                     MOVELOUTDTP    @TRTY                           119374
     C                     MOVELOSCNUM    @CUST                           119374
     C                     CALL 'AOPRFMR0'                                119374
     C                     PARM *BLANKS   #RTCD   1                       119374
     C                     PARM OUTDBK    @BKCD   2                       119374
     C                     PARM           @TRTY   5                       119374
     C                     PARM OUTSUB    @SBTY   2                       119374
     C                     PARM OUTDBR    @BRCD   3                       119374
     C                     PARM *BLANKS   @DPCD   3                       119374
     C                     PARM @USR      @USID  10                       119374
     C*******************  PARM *BLANKS   @ACOC   2                119374 179732
     C                     PARM           @ACOC   2                       179732
     C                     PARM           @CUST   6                       119374
     C                     PARM           @PRFC   4                       119374
     C           #RTCD     IFEQ '0'                                       119374
     C                     MOVE @PRFC     @BBPRC                          119374
     C                     ELSE                                           119374
     C                     MOVE *BLANKS   @BBPRC                          119374
     C                     ENDIF                                          119374
     C                     ENDIF                                          CAC003
     C                     ENDIF                                          119374
      *                                                                   CAC005
     C                     ELSE                                           CAC005
      *                                                                   CAC005
      ** If CAC005 is on, retrieve user book from AOBKPCR0.               CAC005
      *                                                                   CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C           PMBKCD    PARM *BLANKS   PMBKCD  2                       CAC005
     C           PMPRFC    PARM *BLANKS   PMPRFC  4                       CAC005
     C                     PARM @BTDBK    PMPSBK  2                       CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMPRFC    @BBPRC                          CAC005
     C                     ELSE                                           CAC005
     C                     MOVEL*BLANKS   @BBPRC                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C                     ENDIF                                          CAC005
     C*                                                                   119374
     C** Determine the Transaction Profit Centre                          119374
     C*                                                                   119374
     C           KLPCCD    CHAINSEPCCD               62                   119374
     C           *IN62     IFEQ '0'                                       119374
     C                     MOVE PCCU      @BTPRC                          119374
     C                     ELSE                                           119374
     C           *IN40     IFEQ '1'                                       CAC003
     C                     MOVE PNPRFC    @BTPRC                          CAC003
     C                     ELSE                                           CAC003
     C                     MOVELOSCNUM    WWCUST 10                       179732
     C                     CALL 'AOCUSTR0'                                179732
     C                     PARM *BLANKS   @RTCD   7                       179732
     C                     PARM '*KEY   ' @OPTN   7                       179732
     C                     PARM WWCUST    @CKEY  10                       179732
     C                     PARM *BLANKS   @KYST   7                       179732
     C           SDCUST    PARM SDCUST    DSSDY                           179732
     C*                                                                   179732
     C           @RTCD     IFNE *BLANK                                    179732
     C                     Z-ADD28        @DBASE           ***************179732
     C                     MOVEL'SDCUSTPD'@DBFIL           * DB ERROR 28 *179732
     C                     MOVELWWCUST    @DBKEY           ***************179732
     C                     Z-ADD3         WWERR                           179732
     C                     EXSR SUB999                                    179732
     C                     END                             E2             179732
     C*                                                                   179732
     C                     MOVELBBACOC    @ACOC                           179732
     C                     MOVELOUTDTP    @TRTY                           119374
     C                     MOVELOSCNUM    @CUST                           119374
     C                     CALL 'AOPRFMR0'                                119374
     C                     PARM *BLANKS   #RTCD   1                       119374
     C                     PARM OUTDBK    @BKCD   2                       119374
     C                     PARM           @TRTY   5                       119374
     C                     PARM OUTSUB    @SBTY   2                       119374
     C                     PARM OUTDBR    @BRCD   3                       119374
     C                     PARM *BLANKS   @DPCD   3                       119374
     C                     PARM @USR      @USID  10                       119374
     C******************** PARM *BLANKS   @ACOC   2                119374 179732
     C                     PARM           @ACOC   2                       179732
     C                     PARM           @CUST   6                       119374
     C                     PARM           @PRFC   4                       119374
     C           #RTCD     IFEQ '0'                                       119374
     C                     MOVE @PRFC     @BTPRC                          119374
     C                     ELSE                                           119374
     C                     MOVE *BLANKS   @BTPRC                          119374
     C                     ENDIF                                          119374
     C                     ENDIF                                          CAC003
     C                     ENDIF                                          119374
     C*                                                                   119374
     C                     ENDIF                                          119374
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB009 - GET SECURITY CUSTOMER AND TAX DETAILS                 *
      *******************************************************************
     C           SUB009    BEGSR
      * Get client trade details
     C                     MOVE @BTCNR    WWCNUA  6
     C***********WWCNUA    CHAINSDSECSL0             01
     C                     CALL 'AOSECSR0'                                S01486
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*KEY   ' @OPTN   7                       S01486
     C                     PARM WWCNUA    @CUST   6                       S01486
     C           SDSECS    PARM SDSECS    DSSDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANK                                    S01486
     C************IN01     IFEQ '1'                        B1
     C                     Z-ADD9         @DBASE           ***************
     C***********          MOVEL'SDSECSL0'@DBFIL           * DB ERROR 09 *S01486
     C                     MOVEL'SDSECSPD'@DBFIL           * DB ERROR 09 *S01486
     C                     MOVEL@BTCNR    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C*
     C** SAVE CUSTOMER DETAILS AS WORKFIELDS
     C                     MOVE BFTCD     @TAXC   2
     C                     MOVE BFCLAS    @C1DI   1
     C                     MOVE OUAUTS    @AUTS   1
     C*
     C**  Chain to LF/SECGT for counterparty's standard tax details
     C                     MOVE NMCYA     @XCCY
     C                     MOVE @TAXC     @XCODE
     C           @KEY4     CHAINSECGT                01
     C*
     C** RECORD NOT FOUND BLANK OUT TAX DETAILS
     C           *IN01     IFEQ '1'                        B1
     C           RECI      ORNE 'D'
     C                     MOVE *BLANKS   @TAXC
     C*
     C** ...OTHERWISE SAVE TAX DETAILS
     C                     ELSE                            X1
     C                     MOVE CHGB      @TCHGB
     C                     MOVE THRI      @TTHRI
     C                     Z-ADD@RA       @TRA
     C                     Z-ADD@PC       @TPC
     C                     Z-ADD@CG       @TCG
     C                     Z-ADDMNCH      @TMNCH
     C                     Z-ADDMXCH      @TMXCH
     C                     MOVE TXAP      @TTXAP
     C                     MOVE REBA      @TREBA
     C                     MOVE LPSI      @TLPSI
     C                     END                             E1
     C*
     C                     ENDSR
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C           SUB010    BEGSR
     C*
     C                     MOVE 'Y'       WWACCF
     C                     MOVE 'N'       WWACCL
     C                     MOVE 'N'       WWBLCK  1
     C*
     C** IF TRADE DONE ON GREY MARKET SET SETTLEMENT METHOD TO 00 AND
     C** ACCOUNT DETAILS TO BLANK
     C           OUTDMI    IFEQ 'G'
     C                     Z-ADD*ZEROS    @BSMTH
     C                     MOVE *BLANKS   @BPYFM
     C***********          Z-ADD*ZEROS    @BPYFB                          S01486
     C                     MOVE *BLANKS   @BPYFA                          S01486
     C                     MOVE *BLANKS   @BPAYT
     C***********          Z-ADD*ZEROS    @BPYTB                          S01486
     C                     MOVE *BLANKS   @BPYTA                          S01486
     C                     MOVE 'Y'       WWACCF
     C                     GOTO TAG010
     C                     END
     C*
     C** CHECK WHETHER A RETAIL ACCOUNT EXISTS IN THE MEMBER PORTFOLIO
     C** WITH DATE ACCOUNT OPENED *LT TRADE VALUE DATE
     C           KEYACN    SETLLPMACCNL1                                  S01486
     C                     READ PMACCNL1                 01               S01486
     C*
     C           *IN01     DOWEQ'0'                        B1
     C           CNUM      ANDEQ@BTCNR
     C           PTFR      ANDEQ@BPTFR
     C           CCY       ANDEQOUSETC
     C*
     C                     MOVE 'N'       WWACCL
     C                     MOVE 'N'       WWBLCK
     C*
     C** CHECK FOR BLOCKED RETAIL ACCOUNT
     C                     TESTB'2'       RETB           03
     C                     TESTB'3'       RETB           04
     C           OUTDTP    IFEQ 'TP'                       B2
     C           *IN03     ANDEQ'1'
     C           OUTDTP    OREQ 'TS'
     C           *IN04     ANDEQ'1'
     C                     MOVE 'Y'       WWBLCK
     C                     MOVE CNUM      WSCNUM  6
     C                     MOVE CCY       WSCCY   3
     C**********           MOVE ACOD      WSACOD  4                                           CGL029
     C                     MOVE ACOD      WSACOD 10                                           CGL029
     C                     MOVE ACSQ      WSACSQ  2
     C                     END                             E2
     C*
     C** CHECK FOR DATE ACCOUNT OPENED BEFORE SETTLEMENT DATE
     C***********@BTDVD    IFLE DACO                       B2
     C           @BTDVD    IFLT DACO                       B2
     C                     MOVE 'Y'       WWACCL  1
     C                     MOVE CNUM      WSCNUM  6
     C                     MOVE CCY       WSCCY   3
     C**********           MOVE ACOD      WSACOD  4                                           CGL029
     C                     MOVE ACOD      WSACOD                                              CGL029
     C                     MOVE ACSQ      WSACSQ  2
     C                     END                             E2
     C*
     C** IF VALID ACCOUNT NOT FOUND READ NEXT ACCOUNT RECORD
     C           WWACCL    IFEQ 'Y'                        B2
     C           WWBLCK    OREQ 'Y'
     C                     READ PMACCNL1                 01               S01486
     C*
     C** ...OTHERWISE IF VALID ACCOUNT FOUND TEMINATE LOOP
     C                     ELSE                            X2
     C                     MOVE '1'       *IN01
     C                     END                             E2
     C                     END                             E1
     C*
     C                     MOVE OUTINC    @BTINC
     C*
     C** IF ACCOUNT NOT FOUND IN SETTLEMENT CURRENCY REPORT ERROR
     C           CNUM      IFNE @BTCNR                     B1
     C           PTFR      ORNE @BPTFR
     C           CCY       ORNE OUSETC
     C*
     C                     MOVE 'N'       WWACCF  1
     C*
     C**  SET COMPLETE INDICATOR TO 'I' ONLY IN INSERT MODE
     C           OUCHTP    IFEQ 'I'                        B2
     C                     MOVE 'I'       @BTINC
     C                     END                             E2
     C*
     C** SET UP INDICATOR TO BE USED IN ERROR REPORTING
     C           WWACCL    IFEQ 'Y'                        B2
     C                     Z-ADD6         WWERR
     C                     ELSE                            X2
     C           WWBLCK    IFEQ 'Y'                        B3
     C                     Z-ADD10        WWERR
     C                     ELSE                            X3
     C                     Z-ADD5         WWERR
     C                     END                             E3
     C                     END                             E2
     C*
     C** SET SETTLEMENT FIELDS TO BLANK/ZERO
     C                     Z-ADD*ZEROS    @BSMTH
     C                     MOVE *BLANKS   @BPYFM
     C***********          MOVE *ZEROS    @BPYFB                          S01486
     C                     MOVE *BLANKS   @BPYFA                          S01486
     C                     MOVE *BLANKS   @BPAYT
     C***********          MOVE *ZEROS    @BPYTB                          S01486
     C                     MOVE *BLANKS   @BPYTA                          S01486
     C*
     C                     ELSE                            X1
     C*
     C** ...OTHERWISE SET UP SETTLEMENT DETAILS
     C*
     C**  SET COMPLETE INDICATOR TO 'I' ONLY IN INSERT MODE
     C**         OUCHTP    IFEQ 'I'                        B2
     C**                   MOVE 'C'       @BTINC
     C**                   END                             E2
     C           OUCHTP    IFEQ 'I'                        B2
     C                     Z-SUB@BTOSV    WWTCTR 150
     C                     SUB  TVSN      WWTCTR
     C                     SUB  TVSP      WWTCTR
     C           WWTCTR    IFLT LDBL                       B3
     C           OUTDTP    ANDEQ'TS'
     C                     Z-ADD11        WWERR
     C                     MOVE 'I'       @BTINC
     C                     ELSE                            X3
     C                     MOVE 'C'       @BTINC
     C                     END                             E3
     C                     END                             E2
     C*
     C** IF ACCOUNT HAS RETAIL ACCOUNT NUMBER OUTPUT THIS NUMBER
     C           ACNO      IFNE 0                          B2
     C                     Z-ADD14        @BSMTH
     C           @BTDTP    IFEQ 'TP'                       B3
     C                     MOVELACNO      @BPYFM
     C***********          MOVELBRCD      @BPYFB                          S01486
     C                     MOVELBRCA      @BPYFA                          S01486
     C                     ELSE                            X3
     C                     MOVELACNO      @BPAYT
     C***********          MOVELBRCD      @BPYTB                          S01486
     C                     MOVELBRCA      @BPYTA                          S01486
     C                     END                             E3
     C*
     C                     ELSE                            X2
     C*
     C** ...OTHERWISE OUTPUT GENERAL LEDGER ACCOUNT DETAILS
     C                     Z-ADD05        @BSMTH
     C           @BTDTP    IFEQ 'TP'                       B3
     C                     MOVEL@DSACC    @BPYFM
     C***********          MOVELBRCD      @BPYFB                          S01486
     C                     MOVELBRCA      @BPYFA                          S01486
     C                     ELSE                            X3
     C                     MOVEL@DSACC    @BPAYT
     C***********          MOVELBRCD      @BPYTB                          S01486
     C                     MOVELBRCA      @BPYTA                          S01486
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C** OBTAIN PORTFOLIO DETAILS
     C           TAG010    TAG
     C           @KYPOL    CHAINPMPORTPD             01                   S01486
     C           *IN01     IFEQ '1'                                    B00
     C                     Z-ADD10        @DBASE           ***************
     C                     MOVEL'PMPORTPD'@DBFIL           * DB ERROR 10 *S01486
     C                     MOVELOUPCNU    @DBKEY           ***************
     C                     MOVE OUPPTF    @DBKEY
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                                     E001
     C*
     C** OBTAIN EXCHANGE RATE SETTLEMENT TO PORTFOLIO CURRENCY
     C** IF TRADE DATE IS BEFORE TODAY OBTAIN HISTORIC RATE FROM PMHSEXPD S01486
     C           OUTDDT    IFLT BJRDNB                     B1
     C                     MOVE OUSETC    ZCCYF
     C                     MOVE PNPTCY    ZCCYT
     C                     Z-ADDOUTDDT    ZSDATE
     C                     EXSR ZBAKRT
     C*
     C           ZERROR    IFEQ 'Y'                        B2
     C                     Z-ADD11        @DBASE           ***************
     C                     MOVEL'ZBAKRT1 '@DBFIL           * DB ERROR 11 *
     C                     MOVE *BLANKS   @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C*
     C** OUTPUT MULTIPLY RATE TO TRADES FILE
     C                     ELSE                            X2
     C                     Z-ADDZCRSRT    @BSPXR
     C                     MOVELZCRSMD    @BSPMD
     C                     END                             E2
     C*
     C** ...OTHERWISE CROSS RATE SHOULD BE CURRENT FX RATE
     C                     ELSE                            X1
     C*
     C** SET FROM DETAILS TO SETTLEMENT CURRENCY INFORMATION
     C                     MOVE OUSETC    ZCCYF
     C                     Z-ADDWWSTSP    ZRATEF
     C                     Z-ADDWWSTDP    ZCDPF
     C                     MOVE WWSTMD    ZMDINF
     C*
     C** ACCESS SETTLEMENT CURRENCY DETAILS
     C***********PNPTCY    CHAINSDCURRL0             01                   S01486
     C                     CALL 'AOCURRR0'                                S01486
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*KEY   ' @OPTN   7                       S01486
     C***********          PARM WWCNUA    @CYCD   3                 S01486091222
     C                     PARM PNPTCY    @CYCD   3                       091222
     C           SDCURR    PARM SDCURR    DSSDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANK                                    S01486
     C************IN01     IFEQ '1'                        B2             S01486
     C                     Z-ADD24        @DBASE           ***************
     C***********          MOVEL'SDCURRL0'@DBFIL           * DB ERROR 14 *S01486
     C                     MOVEL'SDCURRPD'@DBFIL           * DB ERROR 14 *S01486
     C                     MOVELPNPTCY    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E2
     C*
     C                     MOVE PNPTCY    ZCCYT
     C                     Z-ADDA6SPRT    ZRATET
     C                     Z-ADDA6NBDP    ZCDPT
     C                     MOVE A6MDIN    ZMDINT
     C*
     C                     EXSR ZCCYCN
     C*
     C                     Z-ADDZCRSRT    @BSPXR
     C                     MOVELZCRSMD    @BSPMD
     C                     END                             E1
     C*
     C** SET UP DETAILS OF SETTLEMENT CURRENCY
     C                     MOVE OUSETC    @BSETC
     C                     Z-ADDOUTDER    @BTDER
     C                     MOVE OUTMDI    @BTMDI
     C                     Z-ADDOUTBCR    @BTBCR
     C*
     C                     ENDSR
     C*
      *
      ********************************************************************
      /EJECT
      ********************************************************************
      *  SUB401 - Sub routine to calculate the interest accrued          *
      *         adjustment on a Trade                                    *
      ********************************************************************
     C           SUB401    BEGSR
      *
      * Calculate interest adjustment :-
      *    Nominal amount * Current coupon * Days adjustment
      *    -------------------------------------------------
      *                Days in interest year * 100
     C           WWNMDP    SUB  NMDP      DEP     10
     C                     ADD  5         DEP
     C           @BNOML    MULT POWER8,DEPWNOML  150
     C           WNOML     DIV  100       ZWMLT2 150
     C                     MULT @BDADJ    ZWMLT2
      *
     C                     MULT CPNR      ZWMLT2    H
     C           ZINTDD    IFEQ 0
     C                     Z-ADD0         WPADJ
     C                     ELSE
     C           ZWMLT2    DIV  ZINTDD    WPADJ  150H
     C                     END
      *
      *
     C                     ENDSR                           SUB401 ends
      ********************************************************************
      /EJECT
      ********************************************************************
      *  SUB700 - Determine default charge/commission                    *
      ********************************************************************
     C           SUB700    BEGSR
      *
     C                     Z-ADD0         @XAMTN 150
     C           @KEY4     CHAINSECGT                01
      *
      * If record found, calculate amount if trade type matches levied on
      * indicator
     C           *IN01     IFEQ '0'                        B1
     C           RECI      ANDEQ'D'
      *
     C           OUTDTP    IFEQ 'TP'                       B2
      *
     C           LPSI      IFEQ 'P'                        B3
     C           LPSI      OREQ *BLANKS
     C                     MOVE CHGB      ZCHGB
     C                     MOVE THRI      ZTHRI
     C                     Z-ADD@RA       ZRA
     C                     Z-ADD@PC       ZPC
     C                     Z-ADD@CG       ZCG
     C                     Z-ADDMNCH      ZMNCH
     C                     Z-ADDMXCH      ZMXCH
     C                     Z-ADDWWNMDP    ZDECS
     C                     Z-ADDNMDP      ZNMDP
     C                     MOVE *BLANKS   ZFIELD
     C*
     C** SET UP PRICE TO BE USED IN CALCULATIONS                       ..
     C                     Z-ADDOUPRIC    ZPRICE
     C*
     C** SET NOMINAL TO TOTAL POOL NOMINAL
     C                     Z-ADDOUTNOM    ZNOML
     C*
     C** SECURITY DETAILS
     C                     Z-ADDCFCT      ZTCFC
     C                     MOVE SPBS      ZSPBS
     C                     Z-ADD@BITRA    ZPINT  150
     C*
     C                     EXSR ZCCALA
     C                     Z-ADDZCHGA     @XAMTN
     C                     END                             E3
     C*
     C** OTHERWISE CALCULATE CHARGES FOR TRADE TYPE 'TS'
     C                     ELSE                            X2
     C           LPSI      IFEQ 'S'                        B3
     C           LPSI      OREQ *BLANKS
     C                     MOVE CHGB      ZCHGB
     C                     MOVE THRI      ZTHRI
     C                     Z-ADD@RA       ZRA
     C                     Z-ADD@PC       ZPC
     C                     Z-ADD@CG       ZCG
     C                     Z-ADDMNCH      ZMNCH
     C                     Z-ADDMXCH      ZMXCH
     C                     Z-ADDWWNMDP    ZDECS
     C                     Z-ADDNMDP      ZNMDP
     C                     MOVE *BLANKS   ZFIELD
     C*
     C** SET PRICE TO PRICE OR DISCOUNT/YIELD AS APPROPRIATE           ..
     C           STBS      IFEQ 'D'                        B4
     C           STBS      OREQ 'Y'
     C                     Z-ADDOUPRIC    ZPRICE
     C                     ELSE                            X4
     C                     MOVE OUTPDY    ZPRICE
     C                     END                             E4
     C*
     C** NOMINAL SET TO TOTAL POOL NOMINAL
     C                     Z-ADDOUTNOM    ZNOML
     C                     Z-ADDCFCT      ZTCFC
     C*
     C                     MOVE SPBS      ZSPBS
     C                     EXSR ZCCALA
     C                     Z-ADDZCHGA     @XAMTN
     C                     END                             E3
      *
     C                     END                             E2
     C                     END                             E1
      *
     C                     ENDSR                           SUB700 ends
      *
     C********************************************************************
     C**
     C**   ZCCALA SR. TO CALCULATE CHARGES/COMMISSIONS
     C**
     C********************************************************************
     C*                                                                  *
     C*  LAST AMEND NO. E20232             DATE 11DEC89                  *
     C*                                                                  *
     C*------------------------------------------------------------------*
     C*                                                                  *
     C*  E20232 - Countervalue truncation error.                         *
     C*                                                                  *
     C********************************************************************
     C*
     C           ZCCALA    BEGSR
     C*
     C*  WORK FIELDS
     C*
     C                     Z-ADD*ZERO     ZZ      20
     C                     Z-ADD*ZERO     ZAM0   150
     C                     Z-ADD*ZERO     ZAM1   151
     C                     Z-ADD*ZERO     ZAM2   152
     C                     Z-ADD*ZERO     ZAM3   153
     C                     Z-ADD*ZERO     ZCON0  150
     C                     Z-ADD*ZERO     ZCON1  151
     C                     Z-ADD*ZERO     ZCON2  152
     C                     Z-ADD*ZERO     ZCON3  153
     C                     Z-ADD*ZERO     ZCONS  150
     C                     Z-ADD*ZERO     ZCG0   150
     C                     Z-ADD*ZERO     ZCG1   151
     C                     Z-ADD*ZERO     ZCG2   152
     C                     Z-ADD*ZERO     ZCG3   153
     C                     Z-ADD*ZERO     ZPRICX 150
     C                     Z-ADD*ZEROS    ZNOMLX 150
     C                     MOVEL*BLANK    ZFLAG   1
     C/COPY WNCPYSRC,SE5210C003
     C*
     C*  INPUT PARAMETERS
     C*
     C* FROM THE CHARGE TYPES FILE
     C*
     C                     MOVE ZCHGB     ZCHGB   1
     C                     MOVE ZTHRI     ZTHRI   1
     C                     Z-ADDZRA       ZRA
     C                     Z-ADDZPC       ZPC
     C                     Z-ADDZCG       ZCG
     C                     Z-ADDZMNCH     ZMNCH  150
     C                     Z-ADDZMXCH     ZMXCH  150
     C*
     C* FROM THE TRADE/SECURITY
     C*
     C                     Z-ADDZNOML     ZNOML  150
     C                     Z-ADDZPRICE    ZPRICE 158
     C                     Z-ADDZDECS     ZDECS   10
     C                     Z-ADDZNMDP     ZNMDP   10
     C                     MOVE ZPROT     ZPROT   1
     C                     Z-ADDZTCFC     ZTCFC   98
     C                     MOVE ZSPBS     ZSPBS   1
     C*
     C*  OUTPUT PARAMETERS - CHARGE/COMMISSION AMOUNT CALCULATED
     C*
     C                     Z-ADD*ZERO     ZCHGA  150
      *
      ** Calculate CONSIDERATION
      *
      *
     C           ZDECS     IFEQ 0
     C           ZNOML     MULT ZPRICE    ZCON0     H
      *
     C** If mortgage backed security then multiply by current factor
      *
     C           ZPROT     IFEQ '8'
     C                     MULT ZTCFC     ZCON0
     C                     END
      *
     C** If price is % basis divide by 100
      *
     C           ZSPBS     IFEQ 'P'
     C                     DIV  100       ZCON0     H
     C                     END
      *
     C*  allow for nominal decimal places of security
      *
     C           5         SUB  ZNMDP     ZZ
     C                     MULT POWER8,ZZ ZCON0
     C                     MOVE ZCON0     ZCONS
     C                     END
      *
     C           ZDECS     IFEQ 1
     C           ZNOML     MULT ZPRICE    ZCON1     H
     C           ZPROT     IFEQ '8'
     C                     MULT ZTCFC     ZCON1
     C                     END
     C           ZSPBS     IFEQ 'P'
     C                     DIV  100       ZCON1     H
     C                     END
     C           5         SUB  ZNMDP     ZZ
     C                     MULT POWER8,ZZ ZCON1
     C                     MOVE ZCON1     ZCONS
     C                     END
      *
     C           ZDECS     IFEQ 2
     C           ZNOML     MULT ZPRICE    ZCON2     H
     C           ZPROT     IFEQ '8'
     C                     MULT ZTCFC     ZCON2
     C                     END
     C           ZSPBS     IFEQ 'P'
     C                     DIV  100       ZCON2     H
     C                     END
     C           5         SUB  ZNMDP     ZZ
     C                     MULT POWER8,ZZ ZCON2
     C                     MOVE ZCON2     ZCONS
     C                     END
      *
     C           ZDECS     IFEQ 3
     C           ZNOML     MULT ZPRICE    ZCON3     H
     C           ZPROT     IFEQ '8'
     C                     MULT ZTCFC     ZCON3
     C                     END
     C           ZSPBS     IFEQ 'P'
     C                     DIV  100       ZCON3     H
     C                     END
     C           5         SUB  ZNMDP     ZZ
     C                     MULT POWER8,ZZ ZCON3
     C                     MOVE ZCON3     ZCONS
     C                     END
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C*
     C*  CALCULATE FLAT CHARGES
     C*
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C           ZCHGB     IFEQ 'F'
     C                     Z-ADD*ZEROS    ZZ
     C*
     C*  LOOP UNTIL LIMIT FOUND
     C*
     C                     MOVE *BLANK    ZFLAG
     C           ZFLAG     DOUEQ'Y'
     C                     ADD  1         ZZ
     C*
     C*  RANGE NUMBER REACHES THE LIMIT
     C*
     C           ZZ        IFEQ 15
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  CONSIDERATION LESS THAN RANGE LIMIT
     C*
     C           ZCONS     IFLE ZRA,ZZ
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  RANGE LIMIT IS ZERO
     C*
     C           ZRA,ZZ    IFEQ *ZERO
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C                     END
     C*
     C*  ADD FLAT RATE TO WORK FIELD
     C*
     C                     Z-ADDZCG,ZZ    ZCHGA
     C                     END
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C*
     C*  CALCULATE PRICE CHARGE RATE
     C*
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C           ZCHGB     IFEQ 'P'
     C                     Z-ADD*ZEROS    ZZ
     C                     MOVE ZPRICE    ZPRICX
     C*
     C*  LOOP UNTIL LIMIT FOUND
     C*
     C                     MOVE *BLANK    ZFLAG
     C           ZFLAG     DOUEQ'Y'
     C                     ADD  1         ZZ
     C*
     C*  RANGE NUMBER REACHES THE LIMIT
     C*
     C           ZZ        IFEQ 15
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  PRICE LESS THAN RANGE LIMIT
     C*
     C           ZPRICX    IFLE ZRA,ZZ
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  RANGE LIMIT IS ZERO
     C*
     C           ZRA,ZZ    IFEQ *ZEROS
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C                     END
     C*
     C*  CALCULATE AMOUNT
     C*
     C           ZDECS     IFEQ 0
     C           ZCON0     MULT ZPC,ZZ    ZAM0
     C                     DIV  100       ZAM0      H
     C                     MOVE ZCG,ZZ    ZCG0
     C                     ADD  ZCG0      ZAM0
     C                     MOVE ZAM0      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 1
     C           ZCON1     MULT ZPC,ZZ    ZAM1
     C                     DIV  100       ZAM1      H
     C                     MOVE ZCG,ZZ    ZCG1
     C                     ADD  ZCG1      ZAM1
     C                     MOVE ZAM1      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 2
     C           ZCON2     MULT ZPC,ZZ    ZAM2
     C                     DIV  100       ZAM2      H
     C                     MOVE ZCG,ZZ    ZCG2
     C                     ADD  ZCG2      ZAM2
     C                     MOVE ZAM2      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 3
     C           ZCON3     MULT ZPC,ZZ    ZAM3
     C                     DIV  100       ZAM3      H
     C                     MOVE ZCG,ZZ    ZCG3
     C                     ADD  ZCG3      ZAM3
     C                     MOVE ZAM3      ZCHGA
     C                     END
     C*
     C                     END
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C*
     C*  CALCULATE CONSIDERATION/Threshold BASED CHARGES
     C*
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C           ZCHGB     IFEQ 'C'
     C           ZTHRI     ANDEQ'Y'
     C                     Z-ADD*ZEROS    ZZ
     C*
     C*  LOOP UNTIL LIMIT FOUND
     C*
     C                     MOVE *BLANK    ZFLAG
     C           ZFLAG     DOUEQ'Y'
     C                     ADD  1         ZZ
     C*
     C*  RANGE NUMBER REACHES THE LIMIT
     C*
     C           ZZ        IFEQ 15
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  CONSIDERATION LESS THAN RANGE LIMIT
     C*
     C           ZCONS     IFLE ZRA,ZZ
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  RANGE LIMIT IS ZERO
     C*
     C           ZRA,ZZ    IFEQ *ZEROS
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C                     END
     C*
     C*  CALCULATE AMOUNT
     C*
     C           ZDECS     IFEQ 0
     C           ZCON0     MULT ZPC,ZZ    ZAM0
     C                     DIV  100       ZAM0      H
     C                     MOVE ZCG,ZZ    ZCG0
     C                     ADD  ZCG0      ZAM0
     C                     MOVE ZAM0      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 1
     C           ZCON1     MULT ZPC,ZZ    ZAM1
     C                     DIV  100       ZAM1      H
     C                     MOVE ZCG,ZZ    ZCG1
     C                     ADD  ZCG1      ZAM1
     C                     MOVE ZAM1      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 2
     C           ZCON2     MULT ZPC,ZZ    ZAM2
     C                     DIV  100       ZAM2      H
     C                     MOVE ZCG,ZZ    ZCG2
     C                     ADD  ZCG2      ZAM2
     C                     MOVE ZAM2      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 3
     C           ZCON3     MULT ZPC,ZZ    ZAM3
     C                     DIV  100       ZAM3      H
     C                     MOVE ZCG,ZZ    ZCG3
     C                     ADD  ZCG3      ZAM3
     C                     MOVE ZAM3      ZCHGA
     C                     END
     C                     END
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C*
     C*  CALCULATE CONSIDERATION/Tiered BASED CHARGES
     C*
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C           ZCHGB     IFEQ 'C'
     C           ZTHRI     ANDEQ'N'
     C                     Z-ADD*ZEROS    ZZ
     C*
     C*  LOOP UNTIL LIMIT FOUND
     C*
     C                     MOVE *BLANK    ZFLAG
     C           ZFLAG     DOUEQ'Y'
     C                     ADD  1         ZZ
     C*
     C*  RANGE NUMBER REACHES THE LIMIT
     C*
     C           ZZ        IFEQ 15
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  CONSIDERATION LESS THAN RANGE LIMIT
     C*
     C           ZCONS     IFLE ZRA,ZZ
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  RANGE LIMIT IS ZERO
     C*
     C           ZRA,ZZ    IFEQ *ZEROS
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C                     END
     C*
     C*  CALCULATE AMOUNT
     C*
     C                     EXSR ZCCAL2
     C*
     C           ZDECS     IFEQ 0
     C                     MOVE ZCG,ZZ    ZCG0
     C                     ADD  ZCG0      ZAM0
     C                     MOVE ZAM0      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 1
     C                     MOVE ZCG,ZZ    ZCG1
     C                     ADD  ZCG1      ZAM1
     C                     MOVE ZAM1      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 2
     C                     MOVE ZCG,ZZ    ZCG2
     C                     ADD  ZCG2      ZAM2
     C                     MOVE ZAM2      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 3
     C                     MOVE ZCG,ZZ    ZCG3
     C                     ADD  ZCG3      ZAM3
     C                     MOVE ZAM3      ZCHGA
     C                     END
     C*
     C                     END
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C*
     C*  CALCULATE NOMINAL/Threshold BASED CHARGES
     C*
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C           ZCHGB     IFEQ 'N'
     C           ZTHRI     ANDEQ'Y'
     C*
     C** ADJUST FOR NOMINAL DEC.PLACES (IMPLICIT 4 D.P.s ON LF/SECGT)
     C*
     C           8         SUB  ZNMDP     ZZ
     C           ZNOML     MULT POWER8,ZZ ZNOMLX
     C                     MULT 10        ZNOMLX
     C/COPY WNCPYSRC,SE5210C004
     C                     Z-ADD*ZEROS    ZZ
     C*
     C*  LOOP UNTIL LIMIT FOUND
     C*
     C                     MOVE *BLANK    ZFLAG
     C           ZFLAG     DOUEQ'Y'
     C                     ADD  1         ZZ
     C*
     C*  RANGE NUMBER REACHES THE LIMIT
     C*
     C           ZZ        IFEQ 15
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  NOMINAL LESS THAN RANGE LIMIT
     C*
     C           ZNOMLX    IFLE ZRA,ZZ
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  RANGE LIMIT IS ZERO
     C*
     C           ZRA,ZZ    IFEQ *ZEROS
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C                     END
     C*
     C*  CALCULATE AMOUNT
     C*
     C           ZDECS     IFEQ 0
     C/COPY WNCPYSRC,SE5210C005
     C           ZCON0     MULT ZPC,ZZ    ZAM0
     C/COPY WNCPYSRC,SE5210C006
     C                     DIV  100       ZAM0      H
     C                     MOVE ZCG,ZZ    ZCG0
     C                     ADD  ZCG0      ZAM0
     C                     MOVE ZAM0      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 1
     C/COPY WNCPYSRC,SE5210C007
     C           ZCON1     MULT ZPC,ZZ    ZAM1
     C/COPY WNCPYSRC,SE5210C008
     C                     DIV  100       ZAM1      H
     C                     MOVE ZCG,ZZ    ZCG1
     C                     ADD  ZCG1      ZAM1
     C                     MOVE ZAM1      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 2
     C/COPY WNCPYSRC,SE5210C009
     C           ZCON2     MULT ZPC,ZZ    ZAM2
     C/COPY WNCPYSRC,SE5210C010
     C                     DIV  100       ZAM2      H
     C                     MOVE ZCG,ZZ    ZCG2
     C                     ADD  ZCG2      ZAM2
     C                     MOVE ZAM2      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 3
     C/COPY WNCPYSRC,SE5210C011
     C           ZCON3     MULT ZPC,ZZ    ZAM3
     C/COPY WNCPYSRC,SE5210C012
     C                     DIV  100       ZAM3      H
     C                     MOVE ZCG,ZZ    ZCG3
     C                     ADD  ZCG3      ZAM3
     C                     MOVE ZAM3      ZCHGA
     C                     END
     C*
     C                     END
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C*
     C*  CALCULATE NOMINAL/Tiered BASED CHARGES
     C*
     C*------------------------------------------------------------------*
     C*------------------------------------------------------------------*
     C           ZCHGB     IFEQ 'N'
     C           ZTHRI     ANDEQ'N'
     C*
     C** ADJUST FOR NOMINAL DEC.PLACES (IMPLICIT 4 D.P.s ON LF/SECGT)
     C*
     C           8         SUB  ZNMDP     ZZ
     C           ZNOML     MULT POWER8,ZZ ZNOMLX
     C                     MULT 10        ZNOMLX
     C/COPY WNCPYSRC,SE5210C013
     C                     Z-ADD*ZEROS    ZZ
     C*
     C*  LOOP UNTIL LIMIT FOUND
     C*
     C                     MOVE *BLANK    ZFLAG
     C           ZFLAG     DOUEQ'Y'
     C                     ADD  1         ZZ
     C*
     C*  RANGE NUMBER REACHES THE LIMIT
     C*
     C           ZZ        IFEQ 15
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  NOMINAL LESS THAN RANGE LIMIT
     C*
     C           ZNOMLX    IFLE ZRA,ZZ
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C*  RANGE LIMIT IS ZERO
     C*
     C           ZRA,ZZ    IFEQ *ZEROS
     C                     MOVE 'Y'       ZFLAG
     C                     END
     C*
     C                     END
     C*
     C*  CALCULATE AMOUNT
     C*
     C                     EXSR ZCCAL2
     C*
     C           ZDECS     IFEQ 0
     C                     MOVE ZCG,ZZ    ZCG0
     C                     ADD  ZCG0      ZAM0
     C                     MOVE ZAM0      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 1
     C                     MOVE ZCG,ZZ    ZCG1
     C                     ADD  ZCG1      ZAM1
     C                     MOVE ZAM1      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 2
     C                     MOVE ZCG,ZZ    ZCG2
     C                     ADD  ZCG2      ZAM2
     C                     MOVE ZAM2      ZCHGA
     C                     END
     C*
     C           ZDECS     IFEQ 3
     C                     MOVE ZCG,ZZ    ZCG3
     C                     ADD  ZCG3      ZAM3
     C                     MOVE ZAM3      ZCHGA
     C                     END
     C*
     C                     END
     C*
     C*  SET MINIMUM AMOUNT
     C*
     C           ZCHGA     IFLT ZMNCH
     C                     Z-ADDZMNCH     ZCHGA
     C                     END
     C*
     C*  SET MAXIMUM AMOUNT
     C*
     C           ZMXCH     IFNE *ZERO
     C           ZCHGA     ANDGTZMXCH
     C                     Z-ADDZMXCH     ZCHGA
     C                     END
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      ********************************************************************
      **                                                                **
      *    CALTAX - Calculate the tax associated with a charge or        *
      *           - commission amount.                                   *
      *                                                                  *
      ********************************************************************
      *
     C           CALTAX    BEGSR
      *
     C           *LIKE     DEFN TAXA      @WTAX
     C           *LIKE     DEFN TBCA      @WCHGA
      *
      ***  If the tax applicable for the customer commission
      ***  code =' Y' , the tax code for the c/party <> ' '
      ***  and the customer commission amount<> 0 then
      ***  cal. the tax due on the customer commission amount.
      *
     C           TXAP      IFEQ 'Y'
     C           @TAXC     ANDNE*BLANKS
     C           @WCHGA    ANDNE*ZERO
      *
     C           @XAMTN    IFLT 0
     C                     Z-SUB@XAMTN    @WCHGA
     C                     MOVE 'Y'       WWNEG   1
     C                     ELSE
     C                     Z-ADD@XAMTN    @WCHGA
     C                     MOVE 'N'       WWNEG
     C                     END
      *
      ***  Restore details of the tax code obtained from the c/party
      *
     C                     MOVEL@TXDS     @ZCHDS
      *
      ***  If the trade type is 'TP' and the levied on ind. for the    .
      ***  default tax code is 'S' or the trade type is 'TS' and
      ***  the levied on indicator for the default tax code is 'P'
      ***  set the tax amount to 0.
      *
     C           OUTDTP    IFEQ 'TP'
     C           LPSI      ANDEQ'S'
     C           OUTDTP    OREQ 'TS'
     C           LPSI      ANDEQ'P'
     C*
     C                     Z-ADD0         @WTAX
     C*
     C                     ELSE
      *
      ***  Calculate tax amount.
      *
     C                     Z-ADD@WCHGA    ZCHGA
     C                     EXSR ZTCAL1
     C*
     C           WWNEG     IFEQ 'Y'
     C                     Z-SUBZTAXA     @WTAX
     C                     ELSE
     C                     Z-ADDZTAXA     @WTAX
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB300 - Update trades file                                    *
      *******************************************************************
     C           SUB300    BEGSR
     C*
     C** IF POOL TRADE HAS BEEN AMENDED UPDATE TRADE WITH NEW DETAILS
     C           OUCHTP    IFEQ 'A'                        B1
     C                     MOVEL@BLKDS    @TRDDS
     C                     TESTB'0'       TMSI           99
     C           *IN99     IFEQ '0'                        B2
     C                     MOVE 'N'       TCFR
     C                     ELSE                            X2
     C                     MOVE 'Y'       TCFR
     C                     END                             E2
     C                     MOVEL'A'       RECI
     C                     MOVEL' '       BCON
     C                     MOVEL'A'       CHTP
     C                     Z-ADDBJRDNB    LCD
     C                     TIME           TIME
     C                     UPDATTRADBKF
     C*
     C** FOR INSERT WRITE NEW RECORD TO TRADSD
     C                     ELSE                            X1
      *
     C                     MOVEL@BLKDS    @TRDDS
      *
      * Set date made complete if trade is complete
     C                     MOVE *ZEROS    TDMC
     C           @BTINC    IFEQ 'C'
     C                     Z-ADDBJRDNB    TDMC
     C                     END
     C                     WRITETRADBKF
     C                     END                             E1
     C*
     C** INCREMENT COUNT OF NUMBER OF RECORDS MAINTAINED
     C           1         CHAINTRADSAF              01
     C           *IN01     IFEQ '0'                        B1
     C           @BCHTP    IFEQ 'I'                        B2
     C                     ADD  1         SINS
     C                     ADD  1         NORE
     C                     ELSE                            X2
     C                     ADD  1         SAMD
     C                     END                             E2
     C                     UPDATTRADSAF
     C*
     C                     ELSE                            X1
     C*
     C** IF NO TRAILER FOUND TERMINATE WITH DATABASE ERROR
     C                     Z-ADD16        @DBASE           ***************
     C                     MOVEL'TRADSA  '@DBFIL           * DB ERROR 16 *
     C                     MOVE '1       '@DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
      *
     C                     ENDSR                           SUB300 ends
      *
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB500 - Sub-routine to update Client details                  *
      *******************************************************************
     C           SUB500    BEGSR
      *
     C           @BTCNR    CHAINCLINTSEF             01
     C           *IN01     IFEQ '1'                        B1
     C           RECI      ORNE 'D'
     C                     Z-ADD31        @DBASE           ***************
     C                     MOVEL'CLINTSE '@DBFIL           * DB ERROR 01 *
     C                     MOVE @BTCNR    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C*
     C                     ADD  1         C1CN
     C*
     C                     UPDATCLINTSEF
      *
     C                     ENDSR                           SUB500 ends
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB501 - Subroutine to update Client Depot positions           *
      *******************************************************************
     C           SUB501    BEGSR
      *
     C           *IN01     IFEQ '0'
      *
      *  Access CDEPP client depot positions
     C           @BTDTP    IFEQ 'TP'
     C                     MOVELW1DELF    CDPT
     C                     ELSE
     C                     MOVELW1DELT    CDPT
     C                     END
     C*
     C***********          MOVEL@BTDBR    CDBR                            S01486
     C                     MOVEL@BTDBR    CDPA                            S01486
     C                     MOVEL@BTCNR    CDCN
     C                     MOVEL@BTDSS    CDSN
     C                     MOVEL@BTDMI    CDMK
     C*
     C           @KEYF     CHAINCDEPPDF              01
     C                     Z-ADDNATN      TNLU
      *
      *  Update CDEPP client depot positions
     C           *IN01     IFEQ '1'
     C                     MOVE 'D'       RECI
     C           @BTDVD    IFLE BJRDNB
     C                     Z-ADD@BTDVD    DDTE
     C                     ELSE
     C                     Z-ADD@BTDDT    DDTE
     C                     END
     C                     Z-ADD0         CECN
     C                     Z-ADD0         CDNT
     C                     Z-ADD0         CDNV
     C                     Z-ADD0         CDNS
     C                     Z-ADD0         SNPT
     C                     Z-ADD0         SAPP
     C                     Z-ADD0         CDST
     C                     Z-ADD0         SAPS
     C                     Z-ADD0         CNPV
     C                     Z-ADD0         SAPV
     C                     Z-ADD0         CNSV
     C                     Z-ADD0         SPSV
     C                     EXSR SUB601
     C                     WRITECDEPPDF
      *
      * Update trailer
     C           1         CHAINCDEPPAF              01
     C           *IN01     IFEQ '0'
     C                     ADD  1         NORE
     C                     Z-ADDNATN      TNLU
     C                     UPDATCDEPPAF
     C                     ELSE
     C                     Z-ADD17        @DBASE           ***************
     C                     MOVEL'CDEPPA  '@DBFIL           * DB ERROR 17 *
     C                     MOVEL'1       '@DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END
      *
     C                     ELSE
      *
     C                     EXSR SUB601
     C                     UPDATCDEPPDF
      *
     C                     END
      *
     C                     END
      *
     C                     ENDSR                           SUB501 ends
      *
      *
     C********************************************************************
      /EJECT
     C*
     C********************************************************************
     C*
     C*  SUB502 - Subroutine to update Memos
     C*
     C*                                                                ***
     C*
     C           SUB502    BEGSR
     C*
     C** UPDATE MEMOS BALANCES FOR INSERTION WITH AUTO-SETTLE 'Y' AND
     C** VALUE DATE LESS THEN RUN DATE
     C           @BCHTP    IFEQ 'I'
     C           @BAUTS    ANDEQ'Y'
     C           @BTDVD    ANDLEBJRDNB
     C*
     C** ALSO PERFORM INSERTION IF AMENMENT AND AUTO-SETTLE INDICATOR
     C** CHANGED FROM 'N' TO 'Y'
     C           @BCHTP    OREQ 'A'
     C           @BTDVD    ANDLEBJRDNB
     C           OUAUTS    ANDEQ'Y'
     C           OBAUTS    ANDEQ'N'
     C                     MOVE 'N'       REVERS  1
     C**********           MOVE @BPYFM    W1PYFM 12                                           CGL029
     C**********           MOVE @BPAYT    W1PAYT 12                                           CGL029
     C                     MOVE @BPYFM    W1PYFM 18                                           CGL029
     C                     MOVE @BPAYT    W1PAYT 18                                           CGL029
     C                     MOVE @BSETC    W1SETC  3
     C                     Z-ADD@BTOSV    W1TOSV 150
     C                     EXSR UPMEMS
     C                     END
     C*
     C** PROCESS AMENDMENT OF A TRADE IF ANY OF DETAILS AFFECTING
     C** UPDATE OF MEMOS HAVE CHANGED
     C           @BCHTP    IFEQ 'A'
     C           OUAUTS    ANDEQ'Y'
     C           OBAUTS    ANDEQ'Y'
     C           @BTDVD    ANDLEBJRDNB
     C*
     C           OUSETC    IFNE OBSETC
     C           OUTDER    ORNE OBTDER
     C           OUTMDI    ORNE OBTMDI
     C           OUFXMP    ORNE OBFXMP                                    CAC003
     C*
     C** REVERSE OUT BEFORE UPDATE INFORMATION
     C                     MOVE 'Y'       REVERS
     C**********           MOVE WWPYFM    W1PYFM 12                                           CGL029
     C**********           MOVE WWPAYT    W1PAYT 12                                           CGL029
     C                     MOVE WWPYFM    W1PYFM                                              CGL029
     C                     MOVE WWPAYT    W1PAYT                                              CGL029
     C                     MOVE WWSETC    W1SETC  3
     C                     Z-ADDWWTOSV    W1TOSV 150
     C                     Z-ADDWWSMTH    W1SMTH  20
     C                     EXSR UPMEMS
     C*
     C** INSERT AFTER UPDATE INFORMATION
     C                     MOVE 'N'       REVERS
     C**********           MOVE @BPYFM    W1PYFM 12                                           CGL029
     C**********           MOVE @BPAYT    W1PAYT 12                                           CGL029
     C                     MOVE @BPYFM    W1PYFM                                              CGL029
     C                     MOVE @BPAYT    W1PAYT                                              CGL029
     C                     MOVE @BSETC    W1SETC  3
     C                     Z-ADD@BTOSV    W1TOSV 150
     C                     Z-ADD@BSMTH    W1SMTH  20
     C                     EXSR UPMEMS
     C                     END
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
      /EJECT
     C********************************************************************
     C*
     C*  UPMEMS Update MEMOS
     C*
     C********************************************************************
     C*
     C           UPMEMS    BEGSR
     C*
     C** DETERMINE WHETHER PAY FROM OR PAY TO ACCOUNT TO BE USED TO
     C** ACCESS ACCNTAB
     C           @BTDTP    IFEQ 'TP'                       B1
     C**********           MOVE W1PYFM    WWACCN 12                                           CGL029
     C                     MOVE W1PYFM    WWACCN 18                                           CGL029
     C                     ELSE                            X1
     C                     MOVE W1PAYT    WWACCN
     C                     END                             E1
     C*
     C** ACCESS RETAIL ACCOUNT WITH KEY OF RETAILS ACCOUNT NUMBER IF
     C** SETTLEMENT METHOD 14
     C           W1SMTH    IFEQ 14                         B1
     C                     MOVELWWACCN    WWACNO 100
     C*
     C           WWACNO    CHAINACNUM                01
     C           *IN01     IFEQ '1'                        B2
     C                     Z-ADD18        @DBASE           ***************
     C                     MOVEL'ACNUM   '@DBFIL           * DB ERROR 18 *
     C                     MOVELWWACNO    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E2
     C                     END                             E1
     C*
     C** OBTAIN FULL ACCOUNT DETAILS FROM ACCNT
     C                     MOVE W1SETC    CCY
     C*
     C           @KACCN    CHAINACCNT                01
     C           *IN01     IFEQ '1'                        B1
     C                     Z-ADD19        @DBASE           ***************
     C                     MOVEL'ACCNT   '@DBFIL           * DB ERROR 19 *
     C                     MOVEL@DSACC    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C***********                                                         CCB002
     C***Access*MEMOS by RRN  (RRNM is off ACCNT accessed in DETSAC)      CCB002
     C***********                                                         CCB002
     C***********RRNM      CHAINMEMOSMDF             01                   CCB002
      *                                                                   CCB002
     C************IN01     IFEQ '1'                                       CCB002
     C***********W0RTCD    IFNE '       '                                 CCB002
     C***********          Z-ADD20        @DBASE           ***************CCB002
     C***********          MOVEL'ACCNT   '@DBFIL           * DB ERROR 20 *CCB002
     C***********          MOVEL@DSACC    @DBKEY           ***************CCB002
     C***********          Z-ADD3         WWERR                           CCB002
     C***********          EXSR SUB200                                    CCB002
     C***********          END                                            CCB002
      *                                                                   CCB002
     C           *LIKE     DEFN W0AMT     U#AMT                           CCB002
     C                     Z-ADD*ZEROS    U#AMT                           CCB002
     C*
     C* Purchase - update ledger & cleared balances with settled amount
     C*
     C           @BTDTP    IFEQ 'TP'
     C           REVERS    IFNE 'Y'
     C***********          SUB  W1TOSV    LDBLN                           CCB002
     C***********          SUB  W1TOSV    CLBLN                           CCB002
     C                     SUB  W1TOSV    U#AMT                           CCB002
     C                     Z-ADD1         DORC
     C                     ELSE
     C***********          ADD  W1TOSV    LDBLN                           CCB002
     C***********          ADD  W1TOSV    CLBLN                           CCB002
     C                     ADD  W1TOSV    U#AMT                           CCB002
     C                     Z-ADD0         DORC
     C                     END
     C                     END
     C*
     C* Sale     - update ledger & cleared balances with settled amount
     C*
     C           @BTDTP    IFEQ 'TS'
     C           REVERS    IFNE 'Y'
     C***********          ADD  W1TOSV    LDBLN                           CCB002
     C***********          ADD  W1TOSV    CLBLN                           CCB002
     C                     ADD  W1TOSV    U#AMT                           CCB002
     C                     Z-ADD0         DORC
     C                     ELSE
     C***********          SUB  W1TOSV    LDBLN                           CCB002
     C***********          SUB  W1TOSV    CLBLN                           CCB002
     C                     SUB  W1TOSV    U#AMT                           CCB002
     C                     Z-ADD1         DORC
     C                     END
     C                     END
     C*
     C*    ..save movement amount for PF/RSACMTPD
     C*
     C                     Z-ADDW1TOSV    MVAM
     C*
     C*  Update MEMOS
     C*
     C***********          UPDATMEMOSMDF                                  CCB002
      *                                                                   CCB002
      ** Call Access Object AOMEMSU0                                      CCB002
     C                     CALL 'AOMEMSU0'                                CCB002
     C                     PARM *BLANKS   W0RTCD  7        I:Return code  CCB002
     C                     PARM 0         W0RETL 100       O:Retail A/C NoCCB002
     C**********           PARM CNUM      W0CNUM  60       O:Customer No.              CCB002 CSD027
     C                     PARM CNUM      W0CNUM  6        O:Customer No.                     CSD027
     C                     PARM CCY       W0CUCD  3        O:Currency     CCB002
     C**********           PARM ACOD      W0ACCD  40       O:Account Code              CCB002 CGL029
     C                     PARM ACOD      W0ACCD 100                                          CGL029
     C                     PARM ACSQ      W0ACSQ  20       O:Account Seq. CCB002
     C                     PARM BRCA      W0BRCA  3        O:Branch       CCB002
     C                     PARM BJRDNB    W0PSTD  50       O:Posting date CCB002
     C                     PARM OUTDVD    W0VDAT  50       O:Value date   CCB002
     C                     PARM U#AMT     W0AMT  150       O:Movement amt CCB002
     C                     PARM 'N'       W0FTOV  1        O:FT override  CCB002
      *                                                                   CCB002
     C           W0RTCD    IFNE '       '                                 CCB002
     C                     Z-ADD12        @DBASE           * DB ERROR 12 *CCB002
     C                     MOVE 'MEMOS'   @DBFIL                          CCB002
     C**********           Z-ADDW0CNUM    U0CNUM                                       CCB002 CSD027
     C                     MOVE W0CNUM    U0CNUM                                              CSD027
     C                     MOVE W0CUCD    U0CUCD                          CCB002
     C                     Z-ADDW0ACCD    U0ACCD                          CCB002
     C                     Z-ADDW0ACSQ    U0ACSQ                          CCB002
     C                     MOVE W0BRCA    U0BRCA                          CCB002
     C                     MOVELUMEMER    @DBKEY                          CCB002
     C                     EXSR SUB200                                    CCB002
     C                     END                                            CCB002
     C*
     C*   WRITE A RECORD TO THE ACCOUNT MOVEMENT FILE
     C                     EXSR ACCMOV
     C*
     C           EUPMEM    ENDSR
      *
      ********************************************************************
      /EJECT
      *******************************************************************
      *  ACCMOV - TO GENERATE REAL TIME ACCOUNT MOVEMENTS               *
      *******************************************************************
     C           ACCMOV    BEGSR
     C*
     C*   ..If Movement Amount Is Zero No Record Is Written
     C*
     C           MVAM      IFGT 0
     C*
     C*   ..Write Account Movement Record
     C*
     C                     Z-ADD*ZEROS    CQNR
     C                     MOVE TDRF      TNMR
     C*********************Z-ADD*ZEROS    NRTC                            087591
     C                     MOVE *BLANKS   NRTC                            087591
     C                     MOVE TDTP      TRYP
     C                     Z-ADDTDVD      VUDT
     C                     Z-ADDBJRDNB    PTDT
     C**********           Z-ADDCNUM      CUSN                                                CSD027
     C                     MOVE CNUM      CUSN                                                CSD027
     C                     Z-ADDACOD      ACDE
     C                     Z-ADDACSQ      ASNC
     C                     MOVE SETC      CCYD
     C                     MOVELTDSS      NRTD
      *
      ** If CRE009 is ON and the account is Retail, set the posting date as        CRE009
      ** the value date when the latter is not less than the run date.             CRE009
      *                                                                            CRE009
     C           CRE009    IFEQ 'Y'                                                CRE009
     C           ATYP      IFEQ 'R'                                                CRE009
     C           VUDT      IFGE BJRDNB                                             CRE009
     C                     Z-ADDVUDT      PTDT                                     CRE009
     C                     ENDIF                                                   CRE009
     C                     ENDIF                                                   CRE009
     C                     ENDIF                                                   CRE009
      *                                                                            CRE009
     C           CAP205    IFEQ 'Y'                                                           CAP205
     C                     MOVEL'SE'      CMOD                                                CAP205
     C                     MOVEL'S'       MTYP                                                CAP205
     C                     ENDIF                                                              CAP205
      *                                                                                       CAP205
     C                     WRITERSACMTPO
     C*
     C                     END
     C*
     CSR                   ENDSR
     C*
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB503 - Subroutine to update on-line positions details        *
      *******************************************************************
     C           SUB503    BEGSR
      *
      *  Access OLPOS file for settlement and nominal currency
     C                     Z-ADD1         RECN
      *
     C           1         DO   2         @Z      10       B1
      *
     C           @Z        IFEQ 1                          B2
     C                     MOVELW1SETC    CCY
     C                     ELSE                            X2
     C                     MOVEL@BTNMC    CCY
     C                     END                             E2
      *
     C           @KEYI     CHAINOLPOSOAF             01
     C           *IN01     IFEQ '0'                        B2
     C           RECI      ANDNE'*'
     C                     MOVEAODT       ADT
     C                     MOVEAOFI       AFI
     C                     MOVEAOFO       AFO
      *
     C                     DO   16        @Y      30       B3
     C           @BTDVD    IFGE NDT,@Y                     B4
     C                     Z-ADD@Y        @X      30
     C                     END                             E4
     C                     END                             E3
      *
     C           @BTDVD    IFLT NDT,1                      B3
     C                     Z-ADD1         @X
     C                     END                             E3
      *
     C           WWCHTP    IFEQ 'I'                        B3
     C           @BTDTP    IFEQ 'TP'                       B4
     C           @Z        IFEQ 1                          B5
     C*  IF UPDATING SETTLEMENT CURRENCY RECORD ADD TO OUTGOING AMOUNT
     C*  ELSE UPDATE INCOMING POSITION
     C                     ADD  WCVAL     NFO,@X
     C                     ELSE                            X5
     C                     ADD  WCVAL     NFI,@X
     C                     END                             E5
     C                     ELSE                            X4
     C           @Z        IFEQ 1                          B5
     C*  IF UPDATING SETTLEMENT CURRENCY RECORD ADD TO INCOMING AMOUNT
     C*  ELSE UPDATE OUTGOING POSITION
     C                     ADD  WCVAL     NFI,@X
     C                     ELSE                            X5
     C                     ADD  WCVAL     NFO,@X
     C                     END                             E5
     C                     END                             E4
     C                     END                             E3
      *
     C                     MOVEAAFI       OFI
     C                     MOVEAAFO       OFO
     C                     Z-ADDNATN      TNLU
      *
     C                     UPDATOLPOSOAF
     C                     END                             E2
      *
     C                     END                             E1
      *
     C                     ENDSR                           SUB503 ends
      *
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB504 - Subroutine to update Book positions                   *
      *******************************************************************
     C           SUB504    BEGSR
      *
     C                     Z-ADD0         @CNT    50
      *
      *  If insertion
     C           @BCHTP    IFEQ 'I'
      *
      *  Access BKPHD trade date position
     C                     MOVEL@BTDSS    BHSC
     C***********          MOVEL@BTDBR    BHBR                            S01486
     C                     MOVEL@BTDBR    BHBA                            S01486
     C                     MOVEL@BTDBK    BHBK
     C                     MOVEL@BTDMI    BHMK
     C                     MOVEL'T'       BHTV
     C           @KEYB     CHAINBKPHDDF              01
      *
      *  Update BKPHD trade date position
     C           *IN01     IFEQ '1'
     C                     MOVE 'D'       RECI
     C                     Z-ADDTDDT      FPSD
     C                     Z-ADDTDDT      LPSD
     C                     Z-ADD0         LPCD
     C                     Z-ADD0         LAVP
     C                     Z-ADD0         LATD
     C                     Z-ADD0         ARPC
     C                     Z-ADDTDVD      ICLD
     C                     Z-ADD0         IACR
     C                     Z-ADD0         IACP
     C                     Z-ADD0         INDO
     C                     Z-ADD0         UPPT
     C                     Z-ADD0         DPAP
     C                     Z-ADD0         BUDU
     C                     MOVE SITP      INVT
     C                     MOVE @BTNMC    NCRY
     C                     Z-ADD0         LPRC
     C                     Z-ADD0         BHDP
     C                     Z-ADD0         BHCP
     C                     Z-ADD0         BHPP
     C                     Z-ADDNATN      TNLU
      *                                                                                       CAS006
      ** Initialise the new fields before writing to BKPHDD                                   CAS006
      ** if CAS006 is intalled.                                                               CAS006
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADD*ZERO     LAVN                                                CAS006
     C                     Z-ADD*ZERO     DPAN                                                CAS006
     C                     Z-ADD*ZERO     BUDN                                                CAS006
     C                     Z-ADD*ZERO     INDN                                                CAS006
     C                     Z-ADD*ZERO     FSEFUP                                              CAS006
     C                     Z-ADD*ZERO     FSECUP                                              CAS006
     C                     Z-ADD*ZERO     FSXFUP                                              CAS006
     C                     Z-ADD*ZERO     FSXCUP                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADD0         NAVP                                                CSE065
     C                     Z-ADD0         BKVAMT                                              CSE065
     C                     Z-ADD0         EQTAMT                                              CSE065
      *                                                                                       CSE065
     C                     WRITEBKPHDDF
     C                     ADD  1         @CNT
     C                     END
     C*
     C* Remember latest position date
     C*
     C                     Z-ADDLPSD      TLPSD   50
      *
      *  If value date LE run date :-
      *  Access BKPHD value date position
      *
     C                     MOVEL@BTDSS    BHSC
     C***********          MOVEL@BTDBR    BHBR                            S01486
     C                     MOVEL@BTDBR    BHBA                            S01486
     C                     MOVEL@BTDBK    BHBK
     C                     MOVEL@BTDMI    BHMK
     C                     MOVEL'V'       BHTV
     C           @KEYB     CHAINBKPHDDF              01
      *
      *  Update BKPHD value date position
     C           *IN01     IFEQ '1'
     C                     MOVE 'D'       RECI
     C                     Z-ADDTDVD      FPSD
     C                     Z-ADDTDVD      LPSD
     C                     Z-ADD0         LPCD
     C                     Z-ADD0         LAVP
     C                     Z-ADD0         LATD
     C                     Z-ADD0         ARPC
     C                     Z-ADDTDVD      ICLD
     C                     Z-ADD0         IACR
     C                     Z-ADD0         IACP
     C                     Z-ADD0         INDO
     C                     Z-ADD0         UPPT
     C                     Z-ADD0         DPAP
     C                     Z-ADD0         BUDU
     C                     MOVE SITP      INVT
     C                     MOVE @BTNMC    NCRY
     C                     Z-ADD0         LPRC
     C                     Z-ADD0         BHDP
     C                     Z-ADD0         BHCP
     C                     Z-ADD0         BHPP
     C                     Z-ADDNATN      TNLU
      *                                                                                       CAS006
      ** Initialise the new fields before writing to BKPHDD                                   CAS006
      ** if CAS006 is intalled.                                                               CAS006
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADD*ZERO     LAVN                                                CAS006
     C                     Z-ADD*ZERO     DPAN                                                CAS006
     C                     Z-ADD*ZERO     BUDN                                                CAS006
     C                     Z-ADD*ZERO     INDN                                                CAS006
     C                     Z-ADD*ZERO     FSEFUP                                              CAS006
     C                     Z-ADD*ZERO     FSECUP                                              CAS006
     C                     Z-ADD*ZERO     FSXFUP                                              CAS006
     C                     Z-ADD*ZERO     FSXCUP                                              CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CAS006
     C                     Z-ADD0         NAVP                                                CSE065
     C                     Z-ADD0         BKVAMT                                              CSE065
     C                     Z-ADD0         EQTAMT                                              CSE065
      *                                                                                       CSE065
     C                     WRITEBKPHDDF
     C                     ADD  1         @CNT
     C                     END
     C*
     C* Remember latest position date
     C*
     C                     Z-ADDLPSD      VLPSD   50
      *
     C                     END
      *
      *  Update trailer
     C           @CNT      IFNE 0
     C           1         CHAINBKPHDAF              01
     C           *IN01     IFEQ '0'
     C                     ADD  @CNT      NORE
     C                     Z-ADDNATN      TNLU
     C                     UPDATBKPHDAF
     C                     Z-ADD0         @CNT
     C                     ELSE
     C                     Z-ADD21        @DBASE           ***************
     C                     MOVEL'BKPHDA  '@DBFIL           * DB ERROR 21 *
     C                     MOVEL'1       '@DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END
     C                     END
      *
     C           *IN01     IFEQ '0'
      *
      *  Access BKPOS trade date position
     C                     MOVEL@BTDSS    BPSC
     C***********          MOVEL@BTDBR    BPBR                            S01486
     C                     MOVEL@BTDBR    BPBA                            S01486
     C                     MOVEL@BTDBK    BPBK
     C                     MOVEL@BTDMI    BPMK
     C                     MOVEL'T'       BPTV
     C                     Z-ADDTDDT      BPPD
      *
     C                     Z-ADD0         SNPI
     C                     Z-ADD0         SANP
     C                     Z-ADD0         SNSI
     C                     Z-ADD0         SANS
      *
     C           @KEYC     CHAINBKPOSDF              01
      *
      *  Update trade date positions :-
     C                     Z-ADDNATN      TNLU
     C           *IN01     IFEQ '1'
     C                     Z-ADD0         NPSN
     C                     MOVE 'D'       RECI
     C                     MOVEL@BTDSS    BPSC
     C***********          MOVEL@BTDBR    BPBR                            S01486
     C                     MOVEL@BTDBR    BPBA                            S01486
     C                     MOVEL@BTDBK    BPBK
     C                     MOVEL@BTDMI    BPMK
     C                     MOVEL'T'       BPTV
     C                     Z-ADDTDDT      BPPD
     C                     Z-ADD0         ECNP
     C                     Z-ADD0         APPB
     C                     Z-ADD0         RPTP
     C                     Z-ADD0         PILP
     C                     Z-ADD0         APNC
     C                     Z-ADD0         ANMP
     C                     Z-ADD0         AAPR
     C                     Z-ADD0         SANP
     C                     Z-ADD0         SNPI
     C                     Z-ADD0         SANS
     C                     Z-ADD0         SNSI
     C                     MOVE *BLANK    ADJI
     C                     Z-ADDNATN      TNLU
      *                                                                                       CAS006
      ** Initialise the new fields before writing to BKPOSD                                   CAS006
      ** if CAS006 is intalled.                                                               CAS006
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADD*ZERO     APPN                                                CAS006
     C                     Z-ADD*ZERO     APNN                                                CAS006
     C                     Z-ADD*ZERO     PILN                                                CAS006
     C                     ENDIF                                                              CAS006
      *                                                                                       CSE065
     C                     Z-ADD0         BKCOST                                              CSE065
      *
      *  Calculate trade date positions
     C                     EXSR SUB600
     C                     WRITEBKPOSDF
     C                     ADD  1         @CNT
      *
     C                     ELSE
      *
      *  Calculate trade date positions
     C                     EXSR SUB600
      *
     C                     UPDATBKPOSDF
      *
     C                     END
      *
      *  If value date LE run date
      *  Access BKPOS value date position
      *
     C                     MOVEL@BTDSS    BPSC
     C***********          MOVEL@BTDBR    BPBR                            S01486
     C                     MOVEL@BTDBR    BPBA                            S01486
     C                     MOVEL@BTDBK    BPBK
     C                     MOVEL@BTDMI    BPMK
     C                     MOVEL'V'       BPTV
     C                     Z-ADDTDVD      BPPD
      *
     C                     Z-ADD0         SNPI
     C                     Z-ADD0         SANP
     C                     Z-ADD0         SNSI
     C                     Z-ADD0         SANS
      *
     C           @KEYC     CHAINBKPOSDF              01
      *
      *  Update BKPOS value date positions :-
     C                     Z-ADDNATN      TNLU
     C           *IN01     IFEQ '1'
     C                     Z-ADD0         NPSN
     C                     MOVE 'D'       RECI
     C                     MOVEL@BTDSS    BPSC
     C***********          MOVEL@BTDBR    BPBR                            S01486
     C                     MOVEL@BTDBR    BPBA                            S01486
     C                     MOVEL@BTDBK    BPBK
     C                     MOVEL@BTDMI    BPMK
     C                     MOVEL'V'       BPTV
     C                     Z-ADDTDVD      BPPD
     C                     Z-ADD0         ECNP
     C                     Z-ADD0         APPB
     C                     Z-ADD0         RPTP
     C                     Z-ADD0         PILP
     C                     Z-ADD0         APNC
     C                     Z-ADD0         ANMP
     C                     Z-ADD0         AAPR
     C                     Z-ADD0         SANP
     C                     Z-ADD0         SNPI
     C                     Z-ADD0         SANS
     C                     Z-ADD0         SNSI
     C                     MOVE *BLANK    ADJI
     C                     Z-ADDNATN      TNLU
      *                                                                                       CAS006
      ** Initialise the new fields before writing to BKPOSD                                   CAS006
      ** if CAS006 is intalled.                                                               CAS006
      *                                                                                       CAS006
     C           CAS006    IFEQ 'Y'                                                           CAS006
     C                     Z-ADD*ZERO     APPN                                                CAS006
     C                     Z-ADD*ZERO     APNN                                                CAS006
     C                     Z-ADD*ZERO     PILN                                                CAS006
     C                     ENDIF                                                              CAS006
     C                     Z-ADD0         BKCOST                                              CSE065
      *                                                                                       CSE065
      *
      *  Calculate BKPOS value date positions
     C                     EXSR SUB600
     C                     WRITEBKPOSDF
     C                     ADD  1         @CNT
      *
     C                     ELSE
      *
      *  Calculate BKPOS value date positions
     C                     EXSR SUB600
      *
     C                     UPDATBKPOSDF
      *
     C                     END
      *
      *  Update trailer
     C           @CNT      IFNE 0
     C           1         CHAINBKPOSAF              01
     C           *IN01     IFEQ '0'
     C                     ADD  @CNT      NORE
     C                     Z-ADDNATN      TNLU
     C                     UPDATBKPOSAF
     C                     ELSE
     C                     Z-ADD22        @DBASE           ***************
     C                     MOVEL'BKPOSA  '@DBFIL           * DB ERROR 22 *
     C                     MOVEL'1       '@DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END
     C                     END
      *
     C                     END
      *
     C                     ENDSR                           SUB504 ends
      *
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB505 - Subroutine to update Client positions                 *
      *******************************************************************
     C           SUB505    BEGSR
      *
      *  If insertion :-
     C           @BCHTP    IFEQ 'I'
     C*
     C***********          MOVEL@BTDBR    CSBR                            S01486
     C                     MOVEL@BTDBR    CSBA                            S01486
     C                     MOVEL@BTDSS    CSSC
     C                     MOVEL@BTCNR    CSCN
      *
      *  Access CPOSN client position
     C           @KEYE     CHAINCPOSNDF              01
      *
      *  Update CPOSN client position
     C                     Z-ADDNATN      TNLU
      *
     C           *IN01     IFEQ '1'
     C                     MOVE 'D'       RECI
     C           @BTDVD    IFLE BJRDNB
     C                     Z-ADD@BTDVD    CSDA
     C                     ELSE
     C                     Z-ADD@BTDDT    CSDA
     C                     END
     C                     Z-ADD0         CSNT
     C                     Z-ADD0         CSNV
     C                     Z-ADD0         CSNS
     C                     Z-ADD0         CSEX
     C                     Z-ADD0         CSPT
     C                     Z-ADD0         CSPV
     C                     Z-ADD0         CSCT
     C                     Z-ADD0         CSCV
     C                     MOVE 'N'       CSBT
     C                     MOVE 'N'       CSBV
     C                     WRITECPOSNDF
      *
      * Update trailer
     C           1         CHAINCPOSNAF              01
     C           *IN01     IFEQ '0'
     C                     ADD  1         NORE
     C                     Z-ADDNATN      TNLU
     C                     UPDATCPOSNAF
     C                     ELSE
     C                     Z-ADD23        @DBASE           ***************
     C                     MOVEL'CPOSNA  '@DBFIL           * DB ERROR 23 *
     C                     MOVEL'1       '@DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END
      *
     C                     ELSE
      *
     C           @BTDDT    IFLE CSCT
     C                     MOVE 'Y'       CSBT
     C                     END
     C           @BTDVD    IFLE CSCV
     C                     MOVE 'Y'       CSBV
     C                     END
      *
     C                     UPDATCPOSNDF
     C                     END
      *
     C                     END
      *
     C                     ENDSR
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB506 - Subroutine to update User depot positions             *
      *******************************************************************
     C           SUB506    BEGSR
      *
     C                     Z-ADD0         UDTP
     C                     Z-ADD0         UDPV
     C                     Z-ADD0         UDTS
     C                     Z-ADD0         UDSV
      *
     C           @BTDTP    IFEQ 'TP'
     C                     MOVELW1DELT    UDPT
     C                     ELSE
     C                     MOVELW1DELF    UDPT
     C                     END
     C*
     C***********          MOVEL@BTDBR    UDBR                            S01486
     C                     MOVEL@BTDBR    UDBA                            S01486
     C                     MOVEL@BTDSS    UDSN
     C                     MOVEL@BTDBK    UDBK
     C                     MOVEL@BTDMI    UDMK
      *
      *  Access UDEPP user depot positions
     C           @KEYG     CHAINUDEPPDF              01
      *
      *  Update UDEPP user depot positions
     C                     Z-ADDNATN      TNLU
      *
      *  Trade date basis :-
     C           @BTDTP    IFEQ 'TP'
     C           WWCHTP    IFEQ 'I'
     C                     ADD  @BNOML    UDTP
     C                     ELSE
     C                     SUB  @BNOML    UDTP
     C                     END
     C                     ELSE
     C           WWCHTP    IFEQ 'I'
     C                     SUB  @BNOML    UDTS
     C                     ELSE
     C                     ADD  @BNOML    UDTS
     C                     END
     C                     END
      *
      *  Value date basis :-
     C           @BTDVD    IFLE BJRDNB
     C           @BTDTP    IFEQ 'TP'
     C           WWCHTP    IFEQ 'I'
     C                     ADD  @BNOML    UDPV
     C                     ELSE
     C                     SUB  @BNOML    UDPV
     C                     END
     C                     ELSE
     C           WWCHTP    IFEQ 'I'
     C                     SUB  @BNOML    UDSV
     C                     ELSE
     C                     ADD  @BNOML    UDSV
     C                     END
     C                     END
     C                     END
      *
      ***  Nominal Settled, Input Cycle
      *
     C           @BTDVD    IFLE BJRDNB
     C           @BAUTS    ANDEQ'Y'
      *
     C           @BTDTP    IFEQ 'TP'
      *
     C           WWCHTP    IFEQ 'I'
     C                     ADD  @BNOML    UNSI
     C                     ELSE
     C                     SUB  @BNOML    UNSI
     C                     END
      *
     C                     ELSE
      *
     C           WWCHTP    IFEQ 'I'
     C                     SUB  @BNOML    UNSI
     C                     ELSE
     C                     ADD  @BNOML    UNSI
     C                     END
      *
     C                     END
     C                     END
      *
     C           WWCHTP    IFEQ 'D'
     C           @BTDVD    ANDLEBJRDNB
     C           @BAUTS    ANDEQ'N'
      *
     C           TNSN      IFNE 0
     C           TNSP      ORNE 0
     C           TNSN      ADD  TNSP      WORK
      *
     C           @BTDTP    IFEQ 'TP'
     C                     SUB  WORK      UNSI
     C                     ELSE
     C                     ADD  WORK      UNSI
     C                     END
      *
     C                     END
     C                     END
      *
     C           *IN01     IFEQ '1'
     C                     MOVE 'D'       RECI
     C           @BTDVD    IFLE BJRDNB
     C                     Z-ADD@BTDVD    UDDT
     C                     ELSE
     C                     Z-ADD@BTDDT    UDDT
     C                     END
     C                     Z-ADD0         UECN
     C                     Z-ADD0         UDNT
     C                     Z-ADD0         UDNV
     C                     Z-ADD0         UDNS
     C                     Z-ADD0         UDTS
     C                     Z-ADD0         UDSV
     C                     Z-ADD0         UNRT
     C                     Z-ADD0         UNRV
     C                     Z-ADD0         USNT
     C                     Z-ADD0         USNR
     C                     Z-ADD0         USNV
     C                     Z-ADD0         USRV
     C                     WRITEUDEPPDF
      *
      * Update trailer
     C           1         CHAINUDEPPAF              01
     C           *IN01     IFEQ '0'
     C                     ADD  1         NORE
     C                     Z-ADDNATN      TNLU
     C                     UPDATUDEPPAF
     C                     ELSE
     C                     Z-ADD24        @DBASE           ***************
     C                     MOVEL'UDEPPA  '@DBFIL           * DB ERROR 24 *
     C                     MOVEL'1       '@DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END
      *
     C                     ELSE
      *
     C                     UPDATUDEPPDF
     C                     END
      *
     C                     ENDSR                           SUB506 ends
      *
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB507 - Subroutine to update trade settlements file           *
      *******************************************************************
     C           SUB507    BEGSR
      *
     C                     Z-ADD0         @CNT
      *
      * Update all records for this trade ref. to record ID of C
     C           @KEYJ     SETLLSETLEDF
      *
     C           *IN01     DOUEQ'1'
     C           @KEYJ     READESETLEDF                  01
      *
     C           *IN01     IFNE '1'
     C           RECI      ANDNE'C'
     C           RECI      IFEQ 'H'
     C                     MOVE 'X'       CHTP
     C                     ELSE
     C                     MOVE 'D'       CHTP
     C                     END
     C                     MOVEL'C'       RECI
     C                     Z-ADDBJRDNB    LCD
     C                     ADD  1         @CNT
     C                     UPDATSETLEDF
     C                     END
      *
     C                     END
      *
      * Update trailer
     C           @CNT      IFNE 0
     C           1         CHAINSETLEAF              01
     C           *IN01     IFEQ '0'
     C                     ADD  @CNT      SDEL
     C                     UPDATSETLEAF
     C                     ELSE
     C                     Z-ADD25        @DBASE           ***************
     C                     MOVEL'SETLEA  '@DBFIL           * DB ERROR 25 *
     C                     MOVEL'1       '@DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END
     C                     END
      *
     C                     ENDSR                           SUB507 ends
      *
      ********************************************************************
      /EJECT
      ********************************************************************
      *  SUB600 - Subroutine to calculate the latest Book positions      *
      ********************************************************************
     C           SUB600    BEGSR
      *
      * Initialise and fetch correct work field for result
     C                     Z-ADD0         WCONS  150
     C                     Z-ADD0         WCONS0 150
     C                     Z-ADD0         WCONS1 151
     C                     Z-ADD0         WCONS2 152
     C                     Z-ADD0         WCONS3 153
     C                     MOVEA'0000'    *IN,25
     C           25        ADD  NOMDP     J       20
     C                     MOVEA'1'       *IN,J
      *
      *  Calculate consideration/reallowance/charges/commission
     C   25      @BPRIC    MULT @BNOML    WCONS0    H
     C   26      @BPRIC    MULT @BNOML    WCONS1    H
     C   27      @BPRIC    MULT @BNOML    WCONS2    H
     C   28      @BPRIC    MULT @BNOML    WCONS3    H
      *
     C           SPBS      IFEQ 'P'
     C   25                DIV  100       WCONS0
     C   26                DIV  100       WCONS1
     C   27                DIV  100       WCONS2
     C   28                DIV  100       WCONS3
     C                     END
      *
     C           PROT      IFEQ '8'
     C   25                MULT @BTCFC    WCONS0    H
     C   26                MULT @BTCFC    WCONS1    H
     C   27                MULT @BTCFC    WCONS2    H
     C   28                MULT @BTCFC    WCONS3    H
     C                     END
      *
     C   25                MOVE WCONS0    WCONS
     C   26                MOVE WCONS1    WCONS
     C   27                MOVE WCONS2    WCONS
     C   28                MOVE WCONS3    WCONS
      *
      *   Allow for nominal decimal places
     C           5         SUB  @BTNMD    DC
     C           WCONS     MULT POWER8,DC WCONS
      *
     C                     Z-ADD0         WRALL  150
     C                     Z-ADD0         WRALL0 150
     C                     Z-ADD0         WRALL1 151
     C                     Z-ADD0         WRALL2 152
     C                     Z-ADD0         WRALL3 153
     C           BVRBAP    IFEQ 'Y'
     C* Percentage priced: reallowance is based on nominal
     C           SPBS      IFEQ 'P'
     C   25      WDRALL    MULT @BNOML    WRALL0    H
     C   26      WDRALL    MULT @BNOML    WRALL1    H
     C   27      WDRALL    MULT @BNOML    WRALL2    H
     C   28      WDRALL    MULT @BNOML    WRALL3    H
      *
     C   25                DIV  100       WRALL0
     C   26                DIV  100       WRALL1
     C   27                DIV  100       WRALL2
     C   28                DIV  100       WRALL3
      *
     C   25                MOVE WRALL0    WRALL
     C   26                MOVE WRALL1    WRALL
     C   27                MOVE WRALL2    WRALL
     C   28                MOVE WRALL3    WRALL
      *
      *   Allow for nominal decimal places
     C           5         SUB  @BTNMD    DC
     C           WRALL     MULT POWER8,DC WRALL
     C                     ELSE
     C* Unit priced: reallowance is based on consideration
     C           WDRALL    MULT WCONS     WRALL     H
     C           WRALL     DIV  100       WRALL     H
     C                     END
     C                     END
      *
     C                     Z-ADD0         WCHRG  150
     C           BVCBAP    IFEQ 'Y'
     C           @BTCA1    ADD  @BTCA2    WCHRG
     C                     ADD  @BTCA3    WCHRG
     C                     ADD  @BTCA4    WCHRG
     C                     ADD  @BTCA5    WCHRG
     C                     ADD  @BTCA6    WCHRG
     C                     ADD  @BTCA7    WCHRG
     C                     ADD  @BTAXA    WCHRG
     C                     ADD  @BBCMR    WCHRG
     C                     ADD  @BCCMR    WCHRG
     C                     ADD  @BTXRB    WCHRG
     C                     END
      *
     C                     Z-ADD0         WCOMM  150
     C           BVCMBP    IFEQ 'Y'
     C           @BTBCA    ADD  @BTCCA    WCOMM
     C                     END
      *
      *   Insert (purchase)
     C           @BTDTP    IFEQ 'TP'
     C           @BCHTP    IFEQ 'I'
      *
     C                     ADD  @BNOML    SNPI
      *
     C                     ADD  WCONS     SANP
     C                     ADD  WRALL     SANP
      *
     C           @C1DI     IFEQ 'M'
     C                     ADD  WCHRG     SANP
     C                     ADD  WCOMM     SANP
     C                     ELSE
     C                     SUB  WCHRG     SANP
     C                     SUB  WCOMM     SANP
     C                     END
      *
     C                     ELSE
      *
      *  Deletion (purchase)
     C                     SUB  @BNOML    SNPI
      *
     C                     SUB  WCONS     SANP
     C                     SUB  WRALL     SANP
     C           @C1DI     IFEQ 'M'
     C                     SUB  WCHRG     SANP
     C                     SUB  WCOMM     SANP
     C                     ELSE
     C                     ADD  WCHRG     SANP
     C                     ADD  WCOMM     SANP
     C                     END
      *
     C                     END
      *
     C                     ELSE
      *
      *   Insert (sale)
     C           @BCHTP    IFEQ 'I'
      *
     C                     SUB  @BNOML    SNSI
      *
     C                     SUB  WCONS     SANS
     C                     SUB  WRALL     SANS
     C           @C1DI     IFEQ 'M'
     C                     SUB  WCHRG     SANS
     C                     SUB  WCOMM     SANS
     C                     ELSE
     C                     ADD  WCHRG     SANS
     C                     ADD  WCOMM     SANS
     C                     END
      *
     C                     ELSE
      *
      *  Deletion(sale)
     C                     ADD  @BNOML    SNSI
      *
     C                     SUB  WCONS     SANS
     C                     SUB  WRALL     SANS
     C           @C1DI     IFEQ 'M'
     C                     ADD  WCHRG     SANS
     C                     ADD  WCOMM     SANS
     C                     ELSE
     C                     SUB  WCHRG     SANS
     C                     SUB  WCOMM     SANS
     C                     END
      *
     C                     END
     C                     END
      *
     C                     ENDSR                           SUB600 ends
      *
      ********************************************************************
      /EJECT
      ********************************************************************
      *  SUB601 - Subroutine to calculate the latest Client positions    *
      ********************************************************************
     C           SUB601    BEGSR
      *
      * Fetch correct work field for result
     C                     MOVEA'0000'    *IN,25
     C           25        ADD  NOMDP     J       20
     C                     MOVEA'1'       *IN,J
      *
      *  Calculate consideration/reallowance/charges/commission
     C   25      @BPRIC    MULT @BNOML    WCONS0    H
     C   26      @BPRIC    MULT @BNOML    WCONS1    H
     C   27      @BPRIC    MULT @BNOML    WCONS2    H
     C   28      @BPRIC    MULT @BNOML    WCONS3    H
      *
     C           SPBS      IFEQ 'P'
     C   25                DIV  100       WCONS0
     C   26                DIV  100       WCONS1
     C   27                DIV  100       WCONS2
     C   28                DIV  100       WCONS3
     C                     END
      *
     C           PROT      IFEQ '8'
     C   25                MULT @BTCFC    WCONS0    H
     C   26                MULT @BTCFC    WCONS1    H
     C   27                MULT @BTCFC    WCONS2    H
     C   28                MULT @BTCFC    WCONS3    H
     C                     END
      *
     C   25                MOVE WCONS0    WCONS
     C   26                MOVE WCONS1    WCONS
     C   27                MOVE WCONS2    WCONS
     C   28                MOVE WCONS3    WCONS
      *
      *  Allow for nominal decimal places
     C           5         SUB  @BTNMD    DC
     C           WCONS     MULT POWER8,DC WCONS
      *
     C                     Z-ADD0         WRALL
     C           BVRCAP    IFEQ 'Y'
     C* Percentage priced: reallowance is based on nominal
     C           SPBS      IFEQ 'P'
     C   25      @BRALL    MULT @BNOML    WRALL0    H
     C   26      @BRALL    MULT @BNOML    WRALL1    H
     C   27      @BRALL    MULT @BNOML    WRALL2    H
     C   28      @BRALL    MULT @BNOML    WRALL3    H
      *
     C   25                DIV  100       WRALL0
     C   26                DIV  100       WRALL1
     C   27                DIV  100       WRALL2
     C   28                DIV  100       WRALL3
      *
     C   25                MOVE WRALL0    WRALL
     C   26                MOVE WRALL1    WRALL
     C   27                MOVE WRALL2    WRALL
     C   28                MOVE WRALL3    WRALL
      *
      *  Allow for nominal decimal places
     C           5         SUB  @BTNMD    DC
     C           WRALL     MULT POWER8,DC WRALL
     C                     ELSE
     C* Unit priced: reallowance is based on consideration
     C           @BRALL    MULT WCONS     WRALL     H
     C           WRALL     DIV  100       WRALL     H
     C                     END
     C                     END
      *
     C                     Z-ADD0         WCHRG
     C           BVCCAP    IFEQ 'Y'
     C           @BTCA1    ADD  @BTCA2    WCHRG
     C                     ADD  @BTCA3    WCHRG
     C                     ADD  @BTCA4    WCHRG
     C                     ADD  @BTCA5    WCHRG
     C                     ADD  @BTCA6    WCHRG
     C                     ADD  @BTCA7    WCHRG
     C                     ADD  @BTAXA    WCHRG
     C                     ADD  @BBCMR    WCHRG
     C                     ADD  @BCCMR    WCHRG
     C                     ADD  @BTXRB    WCHRG
     C                     END
      *
     C                     Z-ADD0         WCOMM
     C           BVCMCP    IFEQ 'Y'
     C           @BTBCA    ADD  @BTCCA    WCOMM
     C                     END
      *
      *   Trade date basis :-
      *
      *   Insert (purchase)
     C           @BTDTP    IFEQ 'TP'
     C           WWCHTP    IFEQ 'I'
      *
     C                     SUB  @BNOML    SNPT
      *
     C                     ADD  WCONS     SAPP
     C                     ADD  WRALL     SAPP
     C                     SUB  WCHRG     SAPP
     C                     SUB  WCOMM     SAPP
      *
     C                     ELSE
      *
      *  Deletion (purchase)
     C                     ADD  @BNOML    SNPT
      *
     C                     SUB  WCONS     SAPP
     C                     SUB  WRALL     SAPP
     C                     ADD  WCHRG     SAPP
     C                     ADD  WCOMM     SAPP
      *
     C                     END
      *
     C                     ELSE
      *
      *   Insert/amend(sale)
     C           WWCHTP    IFEQ 'I'
      *
     C                     ADD  @BNOML    CDST
      *
     C                     ADD  WCONS     SAPS
     C                     ADD  WRALL     SAPS
     C                     ADD  WCHRG     SAPS
     C                     ADD  WCOMM     SAPS
      *
     C                     ELSE
      *
      *  Deletion (sale)
     C                     SUB  @BNOML    CDST
      *
     C                     SUB  WCONS     SAPS
     C                     SUB  WRALL     SAPS
     C                     SUB  WCHRG     SAPS
     C                     SUB  WCOMM     SAPS
      *
     C                     END
     C                     END
      *
      *   Value date basis :-
     C           @BTDVD    IFLE BJRDNB
      *
      *   Insert (purchase)
     C           @BTDTP    IFEQ 'TP'
     C           WWCHTP    IFEQ 'I'
      *
     C                     SUB  @BNOML    CNPV
      *
     C                     ADD  WCONS     SAPV
     C                     ADD  WRALL     SAPV
     C                     SUB  WCHRG     SAPV
     C                     SUB  WCOMM     SAPV
      *
     C                     ELSE
      *
      *  Deletion (purchase)
     C                     ADD  @BNOML    CNPV
      *
     C                     SUB  WCONS     SAPV
     C                     SUB  WRALL     SAPV
     C                     ADD  WCHRG     SAPV
     C                     ADD  WCOMM     SAPV
      *
     C                     END
      *
     C                     ELSE
      *
      *   Insert/amend(sale)
     C           WWCHTP    IFEQ 'I'
      *
     C                     ADD  @BNOML    CNSV
      *
     C                     ADD  WCONS     SPSV
     C                     ADD  WRALL     SPSV
     C                     ADD  WCHRG     SPSV
     C                     ADD  WCOMM     SPSV
      *
     C                     ELSE
      *
      *  Deletion (sale)
     C                     SUB  @BNOML    CNSV
      *
     C                     SUB  WCONS     SPSV
     C                     SUB  WRALL     SPSV
     C                     SUB  WCHRG     SPSV
     C                     SUB  WCOMM     SPSV
      *
     C                     END
     C                     END
     C                     END
      *
      ***  Nominal Settled, Input Cycle
      *
     C           @BTDVD    IFLE BJRDNB
     C           @BAUTS    ANDEQ'Y'
      *
     C           @BTDTP    IFEQ 'TP'
      *
     C           WWCHTP    IFEQ 'I'
     C                     SUB  @BNOML    CNSI
     C                     ELSE
     C                     ADD  @BNOML    CNSI
     C                     END
      *
     C                     ELSE
      *
     C           WWCHTP    IFEQ 'I'
     C                     ADD  @BNOML    CNSI
     C                     ELSE
     C                     SUB  @BNOML    CNSI
     C                     END
      *
     C                     END
     C                     END
      *
     C           WWCHTP    IFEQ 'D'
     C           @BTDVD    ANDLEBJRDNB
     C           @BAUTS    ANDEQ'N'
      *
     C           TNSN      IFNE 0
     C           TNSP      ORNE 0
     C           TNSN      ADD  TNSP      WORK   150
      *
     C           @BTDTP    IFEQ 'TP'
     C                     ADD  WORK      CNSI
     C                     ELSE
     C                     SUB  WORK      CNSI
     C                     END
      *
     C                     END
     C                     END
      *
     C                     ENDSR                           SUB601 ends
      *
     C**************************************************************************
      /EJECT
     C**************************************************************************
     C**
     C           AMDSTS    BEGSR
     C*
     C                     MOVE 'Y'       WWAMND  1
     C*
     C                     MOVE *BLANKS   ERMES1
     C                     MOVE *BLANKS   ERMES2
     C                     MOVE *BLANKS   @PTDRF
     C                     MOVE TDRF      @PTDRF
     C*
     C** CALCULATE TOTAL VALUE OF NOMINAL THAT HAS BEEN SETTLED
     C                     Z-ADDTNSN      WWTEST 130
     C                     ADD  TNSP      WWTEST
     C                     ADD  TVSN      WWTEST
     C                     ADD  TVSP      WWTEST
     C*
     C** ANY INCOMPLETE TRADES WHICH EXIST MAY NOT BE AMENDED
     C           TINC      IFEQ 'I'
     C                     Z-ADD9         WWERR
     C                     MOVE 'N'       WWAMND
     C                     END
     C*
     C** MAY NOT AMEND TRADE AS TRADE HAS ALRAEDY BEEN SETTLED OR
     C** DELETED
     C           WWAMND    IFEQ 'Y'
     C           RECI      IFNE 'A'
     C           RECI      ANDNE'D'
     C           NOML      ORNE TOSN
     C           WWTEST    ORNE 0
     C                     Z-ADD7         WWERR
     C                     MOVE 'N'       WWAMND
     C                     END
     C                     END
     C*
     C** INDIVIDUAL TRADES MAY NOT BE AMENDED IF DETAILS ON THE TRADE
     C** DIFFER TO POOL TRADE DETAILS
     C           WWAMND    IFEQ 'Y'
     C           OBLKRF    IFNE LKRF
     C           OBTDNR    ORNE TDNR
     C           OBTDID    ORNE TDID
     C           OBAIIP    ORNE AIIP
     C           OBTMKC    ORNE TMKC
     C           OBTCAP    ORNE TCAP
     C           OBSETC    ORNE SETC
     C           OBTDER    ORNE TDER
     C           OBTMDI    ORNE TMDI
     C           OBTBCR    ORNE TBCR
     C           OBDELT    ORNE DELT
     C           OBDELF    ORNE DELF
     C           OBAUTS    ORNE AUTS
     C           OBFXMP    ORNE FXMP                                      CAC003
     C                     Z-ADD8         WWERR
     C                     MOVE 'Y'       WWAMND
     C                     END
     C                     END
      *
     C                     ENDSR
      *
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB200 - Output error report                                   *
      *******************************************************************
     C           SUB200    BEGSR
     C*
     C** WRITE DETAILS TO OVERALL STATUS REPORT
     C           WWFRST    IFNE 'Y'                        B1
     C                     MOVE 'Y'       WWFRST  1
     C                     MOVE '1'       *IN60
     C*
     C                     MOVE 'N'       @PAGTR
     C           OUATRD    IFEQ 'Y'                        B2
     C                     MOVE 'Y'       @PAGTR
     C                     END                             E2
     C                     END                             E1
     C*
     C** IF OVERALL MESSAG STATUS OUTPUT TEXT 'OVERALL' TO
     C           WWERR     IFEQ 1                          B1
     C           WWERR     OREQ 2
     C           WWERR     OREQ 3
     C           WWERR     OREQ 4
     C                     MOVE 'OVERALL' @PTDRF
     C                     ELSE                            X1
     C                     MOVE *BLANKS   @PTDRF
     C                     MOVE @BTDRF    @PTDRF
     C                     END                             E1
     C*
     C** SET UP ERROR MESSAGE AND ACTION TEXT
     C                     Z-ADDWWERR     I       30
     C                     MOVE @MS1,I    ERMES1
     C                     MOVE @MS2,I    ERMES2
     C*
     C** FORMAT TEXT FOR ERROR MESSAGES
     C           WWERR     IFEQ 5                          B1
     C                     MOVE @MS1,I    SRMES1
     C                     MOVE OUSETC    SRCCY
     C                     MOVE SRMES1    ERMES1
     C                     END                             E1
     C*
     C           WWERR     IFEQ 6                          B1
     C                     MOVE @MS1,I    SRMES2
     C                     MOVE WSCNUM    SRCNUM
     C                     MOVE WSCCY     SRCCY1
     C                     MOVE WSACOD    SRACOD
     C                     MOVE WSACSQ    SRACSQ
     C                     MOVE SRMES2    ERMES1
     C                     END                             E1
     C*
     C           WWERR     IFEQ 10                         B1
     C                     MOVE @MS1,I    SRMES2
     C                     MOVE WSCNUM    S1CNUM
     C                     MOVE WSCCY     S1CCY1
     C                     MOVE WSACOD    S1ACOD
     C                     MOVE WSACSQ    S1ACSQ
     C                     MOVE SRMES3    ERMES1
     C                     END                             E1
     C*
     C           WWERR     IFEQ 11                         B1
     C                     MOVE @MS2,I    SRMES4
     C                     MOVE WSCNUM    S2CNUM
     C                     MOVE WSCCY     S2CCY1
     C                     MOVE WSACOD    S2ACOD
     C                     MOVE WSACSQ    S2ACSQ
     C                     MOVE SRMES4    ERMES2
     C                     END                             E1
     C*
     C** IF FIRST TIME OR OVERFLOW OCCURRED OUTPUT REPORT TITLE
     C           *IN30     IFEQ '0'                                       S01486
     C                     OPEN SE5210P1                                  S01486
     C                     Z-ADD0         PAGE2                           S01486
     C                     EXSR RCFP1                                     S01486
     C                     MOVE '1'       *IN30                           S01486
     C                     ENDIF                                          S01486
     C           *IN60     IFEQ '1'                        B1
     C                     WRITEPM5110HD
     C                     WRITEPM5110D1
     C                     MOVE '0'       *IN60
     C                     ELSE                            X1
     C                     WRITEPM5110D2               60
     C                     END                             E1
     C*
     C** IF PROGRAM ENDING ABNORMALLY OUTPUT 'END OF REPORT' TEXT
     C           WWERR     IFEQ 3                          B1
     C           WWERR     OREQ 4
     C                     WRITEPM5110TL               60
     C                     END                             E1
     C*
     C** OUTPUT DETAILS OF TRADE IF REQUIRED
     C           WWERR     IFEQ 5                          B1
     C           WWERR     OREQ 6
     C           WWERR     OREQ 7
     C           WWERR     OREQ 8
     C           WWERR     OREQ 9
     C           WWERR     OREQ 10
     C           WWERR     OREQ 11
     C           WWERR     OREQ 12                                        CAC003
      *
     C                     MOVE 'Y'       WWGENE  1
      *
      * Get client details
     C***********          MOVE TCNR      WWCNUA  6                       091222
     C                     MOVELTCNR      WWCUST 10                       091222
     C***********WWCNUA    CHAINSDCUSTL0             01                   S01486
     C                     CALL 'AOCUSTR0'                                S01486
     C                     PARM *BLANKS   @RTCD   7                       S01486
     C                     PARM '*KEY   ' @OPTN   7                       S01486
     C***********          PARM WWCNUA    @CYCD   3                 S01486091222
     C                     PARM WWCUST    @CKEY  10                       091222
     C                     PARM *BLANKS   @KYST   7                       091222
     C           SDCUST    PARM SDCUST    DSSDY                           S01486
     C*                                                                   S01486
     C           @RTCD     IFNE *BLANK                                    S01486
     C************IN01     IFEQ '1'                        B2             S01486
     C                     Z-ADD15        @DBASE           ***************
     C***********          MOVEL'SDCUSTL0'@DBFIL           * DB ERROR 15 *S01486
     C                     MOVEL'SDCUSTPD'@DBFIL           * DB ERROR 15 *S01486
     C***********          MOVELWWCNUA    @DBKEY           ***************091222
     C                     MOVELWWCUST    @DBKEY           ***************091222
     C                     Z-ADD3         WWERR
     C                     EXSR SUB999
     C                     END                             E2
      *
      * Set up fixed fields
     C                     MOVELCHTP      @PATCD
     C                     MOVE *BLANKS   @PTDRF
     C                     MOVE TDRF      @PTDRF
     C                     MOVELBLKR      @BBLKR
     C                     MOVELTDSS      @PSESN
     C                     MOVELSRPN      @PSERN
     C                     MOVELBBCSSN    @PCLNN
     C                     MOVELBBCRNM    @PCLRN
     C                     MOVE TCNR      @PCLNO
     C                     MOVE TINC      @PICIN
     C                     MOVE TDTP      @PTDTY
      *
      *  Nominal
     C                     MOVE NOML      ZFIELD
     C                     Z-ADDTNMD      ZADEC
     C                     EXSR ZEDIT
     C                     MOVE ZFIELD    @PNOML
      *
      *  Price/Discount/Yield
     C                     Z-ADD0         ZFLD15
     C                     MOVE TPDY      ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @PPDCY
      *
      *  Value date
     C           @BTDVD    IFNE 0
     C                     Z-ADDTDVD      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVELZDATE     @PVALD
     C                     ELSE
     C                     MOVEL*BLANKS   @PVALD
     C                     END
      *
      *  Branch code
     C***********@BTDBR    IFNE 0                                         S01486
     C           @BTDBR    IFNE *BLANKS                                   S01486
     C***********          MOVELTDBR      @PBRCH                          S01486
     C                     MOVELTDBA      @PBRCH                          S01486
     C                     ELSE
     C                     MOVEL*BLANKS   @PBRCH
     C                     END
      *
      *  Book
     C                     MOVELTDBK      @PBOOK
      *                                                                   CAC005
      ** If CAC005 is on, retrieve user book from AOBKPCR0.               CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C           PMBKCD    PARM *BLANKS   PMBKCD  2                       CAC005
     C           PMPRFC    PARM *BLANKS   PMPRFC  4                       CAC005
     C                     PARM TDBK      PMPSBK  2                       CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMBKCD    @PBOOK                          CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *
      *  Clearance type
     C                     MOVELCLTY      @PCLTY
      *
      *  Settlement currency
     C                     MOVELSETC      @PSLCY
      *
      *  Reallowance
     C                     Z-ADD0         ZFLD15
     C                     MOVE RALL      ZFLD15
     C                     Z-ADD5         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PRASN
      *
      *  Market centre
     C                     MOVELTMKC      @PMRKT
      *
      *  Trade date
     C           TDDT      IFNE 0
     C                     Z-ADDTDDT      ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVELZDATE     @PTRDD
     C                     ELSE
     C                     MOVEL*BLANKS   @PTRDD
     C                     END
      *
      *  Trade sub-type
     C                     MOVELTSUB      @PTDST
      *
      *  Market indicator
     C                     MOVELTDMI      @PMKTI
      *
      *  AIBD/IPPA
     C                     MOVELAIIP      @PAIIP
      *
      *  Capacity
     C                     MOVELTCAP      @PCPCY
      *
      *  Trader I.D.
     C                     MOVELTDID      @PTRID
      *
      *  Link reference
     C                     MOVELLKRF      @PLKRF
      *
      *  Narrative
     C                     MOVELTDNR      @PNARR
      *
      *  Price
     C                     Z-ADD0         ZFLD15
     C                     MOVE PRIC      ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @PPRIC
      *
      *  Accrued Indicator
     C                     MOVE TACI      @PACIN
      *
      *  Days adjustment
     C                     Z-ADDDADJ      ZFLD15
     C                     Z-ADD0         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PDAYS
      *
      *  Actual Difference indicator
     C                     MOVE ADIN      @PACDF
      *
      *  Coupon rate
     C                     Z-ADD0         ZFLD15
     C                     MOVE TDCR      ZFLD15
     C                     Z-ADD7         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @PCPRT
      *
      *  Interest amount
     C                     Z-ADDITRA      ZFLD15
     C                     Z-ADDWWNMDP    ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PIASG
      *
      *  Exchange Rate
     C                     Z-ADD0         ZFLD15
     C*                                                                   CAC003
     C           *IN40     IFEQ '0'                                       CAC003
     C           SETC      OREQ NMCYA                                     CAC003
     C                     MOVE TDER      ZFLD15
     C                     ELSE                                           CAC003
     C*                                                                   CAC003
     C           TDTP      IFEQ 'TP'                                      CAC003
     C           TMDI      ANDEQ'M'                                       CAC003
     C           TDTP      OREQ 'TS'                                      CAC003
     C           TMDI      ANDEQ'D'                                       CAC003
     C           TDER      ADD  FXMR      WATDER 138                      CAC003
     C                     ELSE                                           CAC003
     C           TDER      SUB  FXMR      WATDER                          CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     MOVE WATDER    ZFLD15                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @PEXCH
      *  M/D indicator
     C                     MOVE TMDI      @PERMD
      *
      *  Base currency rate
     C                     Z-ADD0         ZFLD15
     C                     MOVE TBCR      ZFLD15
     C                     Z-ADD8         ZDECS
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT20    @PBCCR
      *
      *  Settlement method
     C                     MOVELSMTH      @PSMTH
      *
      *  Pay from
     C                     MOVELPYFM      @PPYFM
      *
      *  Pay from branch
     C***********@BPYFB    IFNE 0                                         S01486
     C           @BPYFA    IFNE *BLANKS                                   S01486
     C***********          MOVELPYFB      @PPYFB                          S01486
     C                     MOVELPYFA      @PPYFB                          S01486
     C                     ELSE
     C                     MOVEL*BLANKS   @PPYFB
     C                     END
      *
      *  Pay to
     C                     MOVELPAYT      @PPYTO
      *
      *  Pay to branch
     C***********@BPYTB    IFNE 0                                         S01486
     C           @BPYTA    IFNE *BLANKS                                   S01486
     C***********          MOVELPYTB      @PPYTB                          S01486
     C                     MOVELPYTA      @PPYTB                          S01486
     C                     ELSE
     C                     MOVEL*BLANKS   @PPYTB
     C                     END
      *
      *  For a/c of
     C                     MOVELTDFA      @PFAO1
      *
      *  A/c sequence
     C           @BASNM    IFNE 0
     C                     MOVELASNM      @PACSQ
     C                     ELSE
     C                     MOVEL*BLANKS   @PACSQ
     C                     END
      *
      *  Special instructions
     C                     MOVELTDSI      @PSPIN
      *
      *  Priority code
     C                     MOVELPRYC      @PPTYC
      *
      *  Pay code
     C                     MOVELPCOD      @PPAYC
      *
      *  Deliver from
     C********** @BDELF    IFNE 0                                                             CSD027
     C           @BDELF    IFNE *BLANKS                                                       CSD027
     C                     MOVELDELF      @PDELF
     C                     ELSE
     C                     MOVEL*BLANKS   @PDELF
     C                     END
      *
      *  Deliver to
     C********** @BDELT    IFNE 0                                                             CSD027
     C           @BDELT    IFNE *BLANKS                                                       CSD027
     C                     MOVELDELT      @PDELT
     C                     ELSE
     C                     MOVEL*BLANKS   @PDELT
     C                     END
      *
      ***  Autocharges Indicator
      *
     C                     MOVE AUTS      @PAUTS
      *
      ***  Set up ZDECS for charges standard subroutine
      *
     C                     Z-ADDWWNMDP    ZDECS
      *
      *  Broker commission code
     C                     MOVELTBCC      @PBKCC
      *
      *  Broker commission amount
     C                     Z-ADDTBCA      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PBKCA
      *
      *  Customer commission code
     C                     MOVEL@BTCCC    @PCSCC
      *
      *  Customer commission amount
     C                     Z-ADDTCCA      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCSCA
      *
      *  Charges 1 code
     C                     MOVELTCC1      @PCG1C
      *
      *  Charges 1 amount
     C                     Z-ADDTCA1      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCG1A
      *
      *  Charges 2 code
     C                     MOVELTCC2      @PCG2C
      *
      *  Charges 2 amount
     C                     Z-ADDTCA2      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCG2A
      *
      *  Charges 3 code
     C                     MOVELTCC3      @PCG3C
      *
      *  Charges 3 amount
     C                     Z-ADDTCA3      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCG3A
      *
      ***  Charges 4 Code
      *
     C                     MOVE TCC4      @PCG4C
      *
      ***  Charges 4 Amount
      *
     C                     Z-ADDTCA4      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCG4A
      *
      ***  Charges 5 Code
      *
     C                     MOVE TCC5      @PCG5C
      *
      ***  Charges 5 Amount
      *
     C                     Z-ADDTCA5      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCG5A
      *
      ***  Charges 6 Code
      *
     C                     MOVE TCC6      @PCG6C
      *
      ***  Charges 6 Amount
      *
     C                     Z-ADDTCA6      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCG6A
      *
      ***  Charges 7 Code
      *
     C                     MOVE TCC7      @PCG7C
      *
      ***  Charges 7 Amount
      *
     C                     Z-ADDTCA7      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCG7A
      *
      ***  Tax Amount
      *
     C                     Z-ADDTAXA      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCGTX
      *
      ***  Broker Commission Rebate Amount
      *
     C                     Z-ADDBCMR      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PBCMR
      *
      ***  Customer Commission Rebate Amount
      *
     C                     Z-ADDCCMR      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PCCMR
      *
      ***  Tax Rebate Amount
      *
     C                     Z-ADDTXRB      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PTXRB
      *
      ***  Countervalue
      *
     C                     Z-ADDTCTR      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PTCTR
     C*
     C** PORTFOLIO REFERENCE
     C                     MOVE PTFR      @PPTFR
      *
      ***  FX RATE
      *
     C                     Z-ADD0         ZFLD15
     C                     Z-ADD8         ZDECS
     C                     MOVE SPXR      ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    @PSPXR
      *
      ***  MULTIPLY/DIVIDE IND
      *
     C                     MOVE SPMD      @PSPMD
     C*
     C** SWIFT SEQUENCE
     C                     MOVE LSWS      @PLSWS
     C*                                                                   CAC003
     C** Margin Points and Margin Amount                                  CAC003
     C           *IN40     IFEQ '1'                                       CAC003
     C                     MOVE BPRC      @PBPRC                          CAC003
     C                     MOVE TPRC      @PTPRC                          CAC003
     C*                                                                   CAC003
     C** Format FXMP to the Margin Points Printer Field                   CAC003
     C                     Z-ADD0         ZFLD15                          CAC003
     C                     MOVE FXMP      ZFLD15                          CAC003
     C                     Z-ADD2         ZDECS                           CAC003
     C                     EXSR ZSEDIT                                    CAC003
     C                     MOVE ZOUT20    @PMARP                          CAC003
     C*                                                                   CAC003
     C** Format MAMT to the Margin Amount Printer Field                   CAC003
     C                     Z-ADDMAMT      ZFLD15                          CAC003
     C                     Z-ADDWWSTDP    ZDECS                           CAC003
     C                     EXSR ZSEDIT                                    CAC003
     C                     MOVE ZOUT21    @PMARA                          CAC003
     C*                                                                   CAC003
     C                     ENDIF                                          CAC003
     C*                                                                   CAC003
     C** Set on *IN41 if Settlement Currency is not equal to              CAC003
     C** to Nominal Currency                                              CAC003
     C           SETC      IFNE NMCYA                                     CAC003
     C                     MOVE '1'       *IN41                           CAC003
     C                     ELSE                                           CAC003
     C                     MOVE '0'       *IN41                           CAC003
     C                     ENDIF                                          CAC003
      *
      *  Write record
     C                     WRITEPM5110R1
      *
     C                     END                             E1
     C*
     C** IF DATABASE ERROR OR NO MORE TRADE REFERENCES TEMINATE PGM
     C           WWERR     IFEQ 3                          B1
     C           WWERR     OREQ 4
     C                     EXSR SUB999
     C                     ELSE                                           S01486
     C           *IN30     IFEQ '0'                                       S01486
     C                     WRITENONE                                      S01486
     C                     ENDIF                                          S01486
     C                     END                             E1
      *
     C                     ENDSR                           SUB200 ends
      ********************************************************************
      /EJECT
      *******************************************************************
      *  SUB999 - Database error handling                               *
      *******************************************************************
     C           SUB999    BEGSR
     C*
     C** IF DATABASE ERROR HAS OCCURRED REPORT ERROR DETAILS
     C           @DBASE    IFNE 0
     C                     MOVEL@DBALL    @DBSAV
     C           *LOCK     IN   LDA
     C                     MOVEL@DBSAV    @DBALL
     C                     OUT  LDA
     C                     WRITEPM5110R2
     C           *IN30     IFEQ '0'                                       S01486
     C                     WRITENONE                                      S01486
     C                     ENDIF                                          S01486
     C                     END
     C*
     C** TERMINATE PROGRAM
     C           WWERR     IFNE 4
     C                     END
     C*
     C                     ROLBK
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR                           SUB999 ends
      *
      ********************************************************************
      /EJECT
      *******************************************************************
      *  *PSSR - Program error handling                                 *
      *******************************************************************
     C           *PSSR     BEGSR
     C                     DUMP
      *
      * If flag is set, then this is a loop, so exit immediately
     C           @SW       IFEQ '*'
     C                     SETON                     LR
     C                     RETRN
     C                     END
      *
      * Set loop flag
     C                     MOVEL'*'       @SW     1
     C*
     C** ACCESS POOL TRADE DETAILS AND RESET ALLOCATING JOB TO BLANK
     C           @XTNUM    CHAINPMPLTRPD             01
     C           *IN01     IFEQ '1'                        B1
     C           OURECI    ORNE 'D'
     C                     Z-ADD1         @DBASE           ***************
     C                     MOVEL'PMPLTRPD'@DBFIL           * DB ERROR 01 *
     C                     MOVEL@XTNUM    @DBKEY           ***************
     C                     Z-ADD3         WWERR
     C                     EXSR SUB200
     C                     END                             E1
     C*
     C** UNLOCK RECORD ON PMPLTRPD
     C                     MOVE *BLANKS   OUJOB
     C                     UPDATPMPLTRP0
      *
     C                     ROLBK
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR                           *PSSR ends
      *
      ********************************************************************
     C/EJECT                                                              S01486
     C********************************************************************S01486
     C*                                                                   S01486
     C*  RCFP1 -- SUBROUTINE TO REGISTER P1 PRINTER FILE VIA RCF          S01486
     C*                                                                   S01486
     C********************************************************************S01486
     C*                                                                   S01486
     C           RCFP1     BEGSR                            ** RCFP1 **   S01486
     C*                                                                   S01486
     C**      ENSURE REPORT SPOOL FILE RECORDED BY RCF                    S01486
     C*                                                                   S01486
     C                     Z-ADDSFNUM     ZSNUM   60                      S01486
     C**                                                                  S01486
     C                     CALL 'ZSFILE'                                  S01486
     C                     PARM           @RSEQ   5                       S01486
     C                     PARM *BLANKS   SENTY   3                       S01486
     C                     PARM           SFILE                           S01486
     C                     PARM           ZSNUM                           S01486
     C                     PARM           ZSERR   1                       S01486
     C*                                                                   S01486
     C           ZSERR     IFEQ 'Y'                                       S01486
     C*                                                                   S01486
     C**  ERROR DURING ZSFILE PROCESSING, RETURN TO CALLING PROGRAM       S01486
     C*                                                                   S01486
     C                     SETON                     U7U8LR               S01486
     C                     RETRN                                          S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     ENDSR                                          S01486
     C*                                                                   S01486
     C********************************************************************S01486
     C/EJECT                                                              S01486
     C********************************************************************S01486
     C*                                                                   S01486
     C*  RCFAU -- SUBROUTINE TO REGISTER AU PRINTER FILE VIA RCF          S01486
     C*                                                                   S01486
     C********************************************************************S01486
     C*                                                                   S01486
     C           RCFAU     BEGSR                            ** RCFAU **   S01486
     C*                                                                   S01486
     C**      ENSURE AUDIT SPOOL FILE RECORDED BY RCF                     S01486
     C*                                                                   S01486
     C                     Z-ADDSFNUMU    ZSNUMU  60                      S01486
     C**                                                                  S01486
     C                     CALL 'ZSFILE'                                  S01486
     C                     PARM           @RSEQ   5                       S01486
     C                     PARM *BLANKS   SENTY   3                       S01486
     C                     PARM           SFILEU                          S01486
     C                     PARM           ZSNUMU                          S01486
     C                     PARM           ZSERR   1                       S01486
     C*                                                                   S01486
     C           ZSERR     IFEQ 'Y'                                       S01486
     C*                                                                   S01486
     C**  ERROR DURING ZSFILE PROCESSING, RETURN TO CALLING PROGRAM       S01486
     C*                                                                   S01486
     C                     SETON                     U7U8LR               S01486
     C                     RETRN                                          S01486
     C                     END                                            S01486
     C*                                                                   S01486
     C                     ENDSR                                          S01486
     C*                                                                   S01486
      *****************************************************************   S01486
      /EJECT
     C/COPY ZSRSRC,ZLCDZ1
      /EJECT
     C/COPY ZSRSRC,ZAINSH
      /EJECT
     C/COPY ZSRSRC,ZNCDZ3
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z2
      /EJECT
     C/COPY ZSRSRC,ZRATEZ1
      /EJECT
     C/COPY ZSRSRC,ZDYYRZ3
      /EJECT
     C/COPY ZSRSRC,ZCCAL2Z1
      /EJECT
     C/COPY ZSRSRC,ZCNSDZ1
      /EJECT
     C/COPY ZSRSRC,ZCOTRZ1
      /EJECT
     C/COPY ZSRSRC,ZACCRZ1
      /EJECT
     C/COPY ZSRSRC,ZCCYCN
      /EJECT
     C/COPY ZSRSRC,ZCCYXR
      /EJECT
     C/COPY ZSRSRC,ZCONVZ1
      /EJECT
     C/COPY ZSRSRC,ZDAYSZ2
      /EJECT
     C/COPY ZSRSRC,ZBAKRT
      /EJECT
     C/COPY ZSRSRC,ZEDITZ2
      /EJECT
     C/COPY ZSRSRC,ZSEDITZ3
      /EJECT
     C/COPY ZSRSRC,ZTNLU1Z2
      /EJECT
     C/COPY ZSRSRC,ZTCAL1Z1
      /EJECT
     C/COPY ZSRSRC,ZTCAL2Z1
      /EJECT
** CPY@
(c) Finastra International Limited 2001
** ARRAY POOL TRADE GENERATION STATUS  @MES1 **
COMPLETED NORMALLY
COMPLETED NORMALLY BUT TRADES TO BE MAINTAINED MANUALLY
ENDED ABNORMALLY
ENDED ABNORMALLY AS NO MORE TRADES REFERNCES AVAILABLE
SETTLEMENT ACCOUNT IN XXX NOT FOUND
DATE ACCNT XXXXXX-XXX-XXXXXXXXXX-XX OPENED AFTER TRADE DATE                                   CGL029
TRADE DETAILS MAY NOT BE AMENDED
TRADE DETAILS DIFFER TO POOL TRADE DETAILS
INCOMPLETE TRADE NOT MAINTAINED
RETAIL ACCOUNT XXXXXX-XXX-XXXXXXXXXX-XX BLOCKED                                               CGL029
ACCOUNT BALANCE LESS THAN TRADE COUNTERVALUE
BOOK POSITION PROFIT CENTRE NOT FOUND                                     CAC003
** ARRAY POOL TRADE GENERATION STATUS  @MES2 **
 
MANUALLY MAINTAIN TRADE DETAILS DEFINED ON SE5210P1
DELETE BULK REFERENCE, CORRECT PROBLEM AND REENTER
DELETE BULK REFERENCE, ALTER TRADE NUMBER RANGE AND REENTER
OPEN RETAIL ACCOUNT AND MANUALLY MAINTAIN TRADE
ALTER DATE ACCOUNT OPENED AND MANUALLY MAINTAIN TRADE
MANUALLY MAINTAIN TRADE DETAILS DEFINED ON SE5210P1
MANUALLY MAINTAIN TRADE DETAILS DEFINED ON SE5210P1
MANUALLY MAINTAIN TRADE DETAILS DEFINED ON SE5210P1
OPEN RETAIL ACCOUNT AND MANUALLY MAINTAIN TRADE
PAY FONDS INTO ACCOUNT XXXXXX-XXX-XXXXXXXXXX-XX                                               CGL029
MANUALLY MAINTAIN TRADE DETAILS DEFINED ON SE5210P1                       CAC003
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
