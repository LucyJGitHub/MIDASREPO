     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Securities switch report')                    *
     F*****************************************************************
     F*                                                               *
     F*  Midas - Securities Trading Module                            *
     F*                                                               *
     F*  SE5990 - SECURITIES SWITCH REPORT                            *
     F*                                                               *
     F*  Function: To produce the Securities Switch Report showing:   *
     F*  ((I/C))   - the securities involved in the switch            *
     F*   (COB)    - the collateral value before the switch           *
     F*            - the collateral value after the switch in the     *
     F*              sequence                                         *
     F*                                                               *
     F*  Called by:(SEC0307 - Pledge Security Switch Report - Mode L) *
     F*             SEC0709 - Pledge Security Switch Report - Mode A  *
     F*                                                               *
     F*             Frequency:                                        *
     F*            (- I/C Full List - NOT CURRENTLY USED)             *
     F*             - Audit report during COB                         *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD036157           Date 26Jan16               *   
      *  Prev Amend No. MD058285           Date 22Jun21               *
      *                 MD046998A          Date 15Apr21               *
      *                 248698             Date 01Jun20               *
      *                 MD057247           Date 01Feb21               *
      *                 MD050604           Date 21Feb20               *
      *                 MD046248           Date 27Oct17               *
      *                 CDL099             Date 06Oct17               *
      *                 226449             Date 24Jun15               *
      *                 MD034776           Date 09Jul15               *
      *                 CGL165             Date 15Feb17               *
      *                 CDL096             Date 22Sep14               *
      *                 CDL094             Date 11Jun14               *
      *                 AR1067108          Date 11Dec12               *
      *                 AR1001183          Date 20Nov12               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CDL049             Date 11May06               *
      *                 CSD027             Date 09Dec05               *
      *                 CDL038             Date 10May05               *
      *                 CSE071             Date 19Jul05               *
      *                 CDL028             Date 07Feb05               *
      *                 229857             Date 07Oct04               *
      *                 226570             Date 27Jun04               *
      *                 222727             Date 05Nov03               *
      *                 211407             Date 07Jan03               *
      *                 207543             Date 17JUL02               *
      *                 194370             Date 12Jul01               *
      *                 180056             Date 18Oct00               *
      *                 CSE037             Date 29Apr02               *
      *                 CSE035             Date 22Apr02               *
      *                 206316             Date 19Jul02               *
      * Midas Release 4.01.01 ----------------------------------------*
      *                 207006             Date 18Jun02               *
      * Midas Release 4.01 -------------------------------------------*
      *                 CPK015             Date 17Jun01               *
      *                 CSE031             Date 09Nov01               *
      *                 180707             Date 25Jul00               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CSE015             Date 06Dec99               *
      *                 CSE017             Date 20Oct99               *
      *                 CSE012             Date 16Aug99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 130862             Date 18Oct98               *
      *                 151945             Date 06Jan99               *
     F*                 100033             Date 04Feb98               *
     F*                 CSE005             Date 04Feb97               *
     F*                 084704             DATE 01AUG96               *
     F*                 083039             DATE 01AUG96               *
     F*                 059110             DATE 25JUL96               *
     F*                 088047             DATE 26JUN96               *
     F*                 100228             DATE 31MAY96               *
     F*                 098897             DATE 29JAN96               *
     F*                 099886             DATE 18APR96               *
     F*                 100017             DATE 18APR96               *
     F*                 097558             DATE 21DEC95               *
     F*                 091254             DATE 20OCT95               *
     F*                 086491             DATE 15JUN95               *
     F*                 064575             DATE 15AUG94               *
     F*                 065301             DATE 06MAY94               *
     F*                 S01445             DATE 04NOV93               *
     F*                 052254             DATE 10JAN94               *
     F*                 S01401             DATE 16JUN93               *
     F*                 054763             DATE 04MAY93               *
     F*                 047922             DATE 01FEB93               *
     F*                 S01397             DATE 10SEP92               *
     F*                 E37680             DATE 26MAR92               *
     F*                 E32674             DATE 03DEC91               *
     F*                 E29170             DATE 15NOV91               *
     F*                 E27934             DATE 22OCT91               *
     F*                 E27092             DATE 04SEP91               *
     F*                 S01195             DATE 23JUL91               *
     F*                 S01117             DATE 23JUL91               *
     F*                 S01269             DATE 31JUL90               *
     F*                 S01271             DATE 19JUN90               *
     F*                 E21668             DATE 01MAY90               *
     F*                 E21616             DATE 03APR90               *
     F*                 S01232             DATE 23NOV89               *
     F*                 E20380             DATE 04DEC89               *
     F*                 E18789             DATE 03JUL89               *
     F*                 E16772             DATE 19/06/89              *
     F*                 E17704             DATE 31/03/89              *
     F*                 E17303             DATE 31/03/89              *
     F*                                                               *
     F*---------------------------------------------------------------*
      *                                                               *
      *  MD036157 - Coupon entries are missing from Position settle-  *
      *             ments maintenance screen. Recompiled due to       *
      *             /COPY ZACCZZ1 changes.                            *
      *  MD058285 - Change base rate code to alphanumeric (Recompile) *
      *  MD046998A - Recompiled due to changes in /COPY ZDYYRZ3       *
      *            - Applied fix for MD057480                         *
      *  248698 - Rounding discrepancies on some SE reports. Applied  *
      *           fix 228682.                                         *
      *  228682 - Recompiled due to ZCNSDZ1 changes. Applied 176594.  *
      *  MD057247 - Multiple calls of UTCHOBJEX for several COB com-  *
      *             ponents - Securities module.                      *
      *           - Moved the call of AOSARDR0 from /copy ZLCDZ1.     *
      *  MD050604 - Average price of position changed incorrectly.    *
      *           - Recompiled due to changes in copy source ZCNSDZ1. *
      *  MD046248 - Finastra Rebranding                               *
      *  CDL099 - Split Value Date (Recompile)                        *
      *  226449 - Recompiled over changes made in /COPY ZDYYRZ3.      *
      *         - Applied for MD034387.                               *
      *  MD034776 - Reverse AR1001183A to allow negative interest     *
      *             rate. (Recompile)                                 *
      *  CGL165 - Dual Withholding Tax (Recompile)                    *
      *  CDL096 - Business Day Conventions on MM Deals                *
      *           (Recompile)                                         *
      *  CDL094 - Enhance  Receive Settlement Instructions            *
      *           (Recompiled)                                        *
      *  AR1067108 - PMC1140 Component failed during Clean COB        *
      *              Applied fix AR1001183A                           *
      *  AR1001183A - Coupon rate was still used in computation of    *
      *              interest instead of using the details in FRN tab *
      *              (Reopen) (Recompile)                             *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CDL049 - Addition of a Reference Rate field (recompile)      *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CDL038 - Extended Deal Sub Type (Recompile)                  *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CDL028 - Automatic Rate Interpolations (Recompile)           *
      *  229857 - Recompiled due to change in ZYLDZ2.                 *
      *  226570 - Recompiled due to change in ZYLDZ2.                 *
      *  222727 - Release 5.0 errors  (Recompile)                     *
      *  211407 - Recompile after change on copy sources ZYLDZ2,      *
      *           ZACCRZ1 and ZYCEZ1 for NX/NNX processing.           *
      *           The change was to call subroutine ZLCD1 instead     *
      *           of ZLCD in retrieving the PERIOD for NNX processing *
      *           and ZNCD1 is called instead of ZNCD in retrieving   *
      *           the WBENCD for NNX processing. Also rewrite tests   *
      *           for identifying if position is NX,NNX or CUM.       *
      *  207543 - CEU018 not working on a price basis.                *
      *           Recompile over changed ZYLDZ2.                      *
      *  194370 - Recompile after change on copy sources ZYLDZ2,      *
      *           For securities with divisor basis = '5' and first   *
      *           coupon date > valuation date (rundate + 1), set     *
      *           event control date to first coupon date before      *
      *           processing SR/ZDYYR. This is to ensure that the     *
      *           correct hypothetical last and next coupon dates are *
      *           used in deriving the price/yield rate.              *
      *  180056 - Recompiled over changed in ZDYYRZ3.                 *
      *  CSE037 - Bond Pricing - 3 Decimal Places in Trades Input     *
      *  CSE035 - NX/NNX Coupon Payment Processing.                   *
      *           Recompile over changed ZACCRZ1/ZYLDZ2/ZYCEZ1
      *  206316 - Recompiled over changed ZLCDZ1.                     *
      *  207006 - Add Counterparty & Market Centre to SSI (Recompile) *
      *  CPK015 - Conversion of ZYIELD from PLI to RPG.               *
      *           Recompile over changed ZYLDZ2.                      *
      *  CSE031 - Coupon Fixing for Floating Rate Notes.              *
      *           (recompilation due to change to ZNCD/ZLCD)          *
      *  180707 - No Position Settlements generated. Recompile over   *
      *           changes in /COPY ZNCDZ3.                            *
      *  CSE015 - Forward Valued Depot Movements (Recompile)          *
      *  CSE017 - Cum/Ex Indicator on Depot Movements (Recompile)     *
      *  CSE012 - SE Depot Movement Narratives (Recompiled).          *
     F*  130862 - Recompiled over ZLCDZ1 & ZDAYSZ2 changes.           *
     F*  151945 - Recompiled Over changed ZDYYRZ3 .                   *
     F*  100033 - DPTSWB amended to allow Settled records. Also no    *
     F*           DB Error if Deal is not found, just ignore Depot    *
     F*           Movement in this case. Also output if movement date *
     F*           is today.                                           *
     F*  CSE005 - Effect of holidays on FRN Coupon Dates              *
     F*           (recompilation due to change to ZNCD/ZLCD)          *
     F*  084704 - RECOMPILE OVER CHANGED ZYLDZ2 SUB.                  *
     F*  083039 - RECOMPILE OVER CHANGED ZYLDZ2 SUB.                  *
     F*  059110 - Recompile over changed ZYLDZ2 sub.                  *
     F*  088047 - RECOMPILE over change SR/ZYLDZ2.                    *
     F*  100228 - RECOMPILE OVER CHANGED ZDYYRZ3, ZLCDZ1 & ZNCDZ3.    *
     F*  098897 - Recompile for change to DPTSWA/B - files amended to *
     F*           exclude deleted records, since these records are    *
     F*           not required and cause a database error.            *
     F*  099886 - Rounding problem for partly paid securities.        *
     F*           Recompile over amended standard subroutine ZACCZ.   *
     F*  100017 - Position settlement unable to pick up day adj. on   *
     F*           SECTYD. Change subroutine to use DADJN to stop      *
     F*           interest day adjustment being used for amortisation.*
     F*           Recompile over amended subroutine ZDAYS.            *
     F*  097558 - Access type 'A' not 'B' record from CLINTCB and     *
     F*           clear ZTABKY before branch chain.                   *
     F*  091254 - RECOMPILE OVER CHANGED ZLCDZ1 & ZNCDZ3              *
     F*  086491 - Wrong nbr of days calculated for day basis 1        *
     F*           when start or end day is last day of February       *
     F*           Recompiled for ZSRSRC/ZDAYSZ2 changes.              *
     F*  064575 - Recompiled over amended ZYLDZ2 subroutine.          *
     F*  065301 - Recompiled over changed copy source ZACCR subr.     *
     F*           with ZAMT increased to 15,0.                        *
     F*  S01445 - DEPOT MOVEMENT CHARGES ENHANCEMENT.                 *
     F*           Recompiled due to changes in PF/DPTMVD.             *
     F*  052254 - RECOMPILED as CURRENT FACTOR amended from 9,8       *
     F*           to 10,9                                             *
     F*  S01401 - MT5xx SWIFT Messages Feature:                       *
     F*           - Recompiled due to changes to files.               *
     F*  054763 - E47922 should have added SR/ZCNSD and ZCALCD to     *
     F*           enable recompilation !                              *
     F*  047922 - Recompiled over changed SR/ZYLDZ2                   *
     F*  S01397 - Rel 10 Incorporation of BNZ SARs A46008 and A46013. *
     F*           - Recompiled due to changes to files and SR/ZYLD.   *
     F*  E37680 - Conditioning of MBIN is '1' instead of 'Y'          *
     F*  E32674 - Recompiled due to error in DPTMVD                   *
     F*  E29170 - Report Control Facility changes                     *
     F*  E27934 - Recompiled over the changed version of ZACCRZ1      *
     F*  E27092 - Recompiled over changed SR/ZLCD                     *
     F*  S01195 - Holiday Processing.                                 *
     F*  S01117 - Multibranching.                                     *
     F*  S01269 - Trade authorisation: recompiled for change to       *
     F*           file TABSE                                          *
     F*  S01271 - Recompiled for Pay/Receive in Input Cycle changes   *
     F*           to TRADSD and/or DPTMVD                             *
     F*  E21668 - Recompiled over changed SR/ZYLDZ2                   *
     F*  E21616 - Recompiled over changed SR/ZLCD.                    *
     F*  S01232 - Australian Yield Modifications.                     *
     F*  E20380 - Add ZLCD for new version of ZYLD for Div Basis 5.   *
     F*  E18789 - Audit was trying to compare Count of records read   *
     F*           from DPTSWA and DPTSWB (which contain ONLY the      *
     F*           Switched Security records from DPTMVD) with NORE    *
     F*           from DPTMVA (which is the TOTAL Number of records   *
     F*           on DPTMVD).  Changed program so that Audit Report   *
     F*           prints only the Total Number of records read.       *
     F*           N.B. This fix corresponds to S01186 in SE5990AU.    *
     F*  E16772 - Recompiled for the Dividend Payment Amount field    *
     F*           changes.                                            *
     F*  E17704 - RECOMPILE PROGRAM OVER CHANGED ZNCDZ3 SR.           *
     F*  E17303 - RECOMPILE PROGRAM OVER CHANGED ZDYYRZ3 ZYLDZ1 ZYLDZ2*
     F*                                                               *
     F*****************************************************************
      *
     FDPTSWB  IF  E           K        DISK
     F            DPTMVDF                           KRENAMEDPTSWBF
     FDPTSWA  IF  E           K        DISK
     F            DPTMVDF                           KRENAMEDPTSWAF
     FTABSE   IF  E           K        DISK
     F            TABLETAF                          KIGNORE
     F* ICD 1     TABTB10F                          KIGNORE
     F* ICD 2     TABTB11F                          KIGNORE
     F* ICD SE    TABTB36F                          KIGNORE
     F            TABTE10F                          KIGNORE
     F            TABTE20F                          KIGNORE
     F* CCY       TABTG10F                          KIGNORE
     F            TABTG20F                          KIGNORE
     F            TABLETHF                          KIGNORE
     F********    TABLETJF                          KIGNORE               S01232
     F            TABLETKF                          KIGNORE
     F            TABLETLF                          KIGNORE
     F            TABLETNF                          KIGNORE
     F            TABLETPF                          KIGNORE
     F* BRANCH    TABLETRF                          KIGNORE
     F            TABLETXF                          KIGNORE
     F            TABLET2F                          KIGNORE
     F            TABLET3F                          KIGNORE
     F            TABLET5F                          KIGNORE
     F            TABTB40F                          KIGNORE
     FCLINT   IF  E           K        DISK
     F            CLINTCAF                          KIGNORE
     F            CLINTCCF                          KIGNORE
     F            CLINTC1F                          KIGNORE
     F            CLINTSEF                          KIGNORE
     FDEALS   IF  E           K        DISK
     F            DEALSDAF                          KIGNORE
     F            DEALSDBF                          KIGNORE
     F            DEALSDDF                          KIGNORE
     F            DEALSDEF                          KIGNORE
     F            DEALSDFF                          KIGNORE
     F            DEALSDGF                          KIGNORE
     F*DPTMVA  IF  E                    DISK                              E18789
     FINVTP   IF  E           K        DISK
     FSECTY   IF  E           K        DISK
     FSEDEV   IF  E           K        DISK
     FSECEO   IF  E           K        DISK                               S01232
     F            SEDEVDF                           KRENAMESEDEVDO        S01232
     F            SNDEVDF                           KRENAMESNDEVDO        S01232
     FSE5990AUO   E                    PRINTER
     F                                              KINFDS SPOOLU         E29170
     F***SE5990P1O***E                    PRINTER                         E29170
     FSE5990P1O   E                    PRINTER                        UC  E29170
     F                                              KINFDS SPOOL          E29170
     F/COPY WNCPYSRC,SE5990F001
      /EJECT
     F*****************************************************************
     F*                                                               *
     F*  F U N C T I O N   O F   I N D I C A T O R S                  *
     F*                                                               *
     F*   01       End-of-file reached for Depot Switch Before file   *
     F*   02       End-of-file reached for Depot Switch After file    *
     F*   03       No records to report                               *
     F*   04       After total not equal to either before total or    *
     F*                deal amount                                    *
     F****05*******Diff*between*no*of*records*read*and*on*trailer***  *   E18789
     F*   20       Multibranching set on                              *   S01117
     F*   89       Overflow indicator                                 *
     F*   98-99    Used in standard sub-routines                      *
     F*   U7       Database error                                     *
     F*   U8       Database / Control error                           *
     F*                                                               *
     F*****************************************************************
      /SPACE 3
     F*****************************************************************
     F*                                                               *
     F*  S U B R O U T I N E   I N D E X                              *
     F*                                                               *
     F*  *PSSR  - DUMP program on error                               *   S01117
     F*  SWITCH - Control procedure for program                       *
     F*  SWPROC - Do processing for switches                          *
     F*  SRPR01 - Print switch headings                               *
     F*  SRPR02 - Print 'before' details                              *
     F*  SRPR03 - Print 'after' headings                              *
     F*  SRPR04 - Print switch totals                                 *
     F*  READB  - Read the next record on LF/DPTSWB                   *
     F*  READA  - Read the next reocrd on LF/DPTSWA                   *
     F*  CVALUE - Calculate security collateral value (in Deal CCY)   *
     F*  CHBRA  - Chain to Branch record on Table file                *
     F*  CHCCY  - Chain to Currency record on Table file              *
     F*  CHCLI  - Chain to Client record on Clint file                *
     F*  CHDEA  - Chain to Deals record on Deals file                 *
     F*  CHINV  - Chain to Investment record on Invtp file            *
     F*  CHSEC  - Chain to Security record on Secty file              *
     F*  AUDIT  - Audit process                                       *
     F*  RCFP1  - SUBROUTINE TO REGISTER P1 PRINTER FILE VIA RCF      *   E29170
     F*  RCFAU  - SUBROUTINE TO REGISTER AU PRINTER FILE VIA RCF      *   E29170
     F***XDATE3*-*Calculate*working*days*backwards******************S01232S01195
     F*  ZACCR  - Calculate interest accrued between dates            *   S01232
     F*  ZACCZ  - Calculate interest accrued between certain dates    *   S01232
     F*  ZCOLLV - Calculate collateral value                          *
     F*  ZCONV  - Convert an amount form one ccy to another           *
     F*  ZDATE1 - Convert date to no of days                          *
     F*  ZDATE2 - Convert day no to date format                       *
     F*  ZDAYS  - Calc no of days between two dates                   *
     F*  ZDYYR  - Calc no of days in interest year                    *
     F*  ZEVCD  - Determine Event Control date                        *
     F*  ZHASH  - Calculate hash value for run control                *
     F*  ZICD2  - Access ICD record 2                                 *
     F*  ZICDSE - Access ICD record for Securities Trading            *
     F*  ZLCD   - Determine previous coupon date                      *   E20380
     F*  ZNCD   - Determine next coupon date                          *
     F*  ZPRCI  - Output price as %price                              *
     F*  ZRATE  - Obtain effective interest rate for a period         *   S01232
     F*  ZSEDIT - Edit amounts for output purposes                    *
     F*  ZSYSTM - Access ICD record                                   *
     F*  ZXRATE - Obtain cross rate and M?D ind between 2 ccys        *
     F*  ZYLD   - Set up parms and call ZYIELD PL1 subroutine         *
     F*  ZYLDI  - Output yield as %price                              *
     F*  ZYCE   - Set up Australian yield Cum/Ex parameters           *   S01232
     F*  #DEFN  - Define keys                                         *
     F*                                                               *
     F*****************************************************************
      /EJECT
      /COPY ZSRSRC,ZDATE2Z1
      ***/COPY*ZSRSRC,ZDATE6Z1                                      S01232S01195
     E/COPY ZSRSRC,ZHOLE                                                  S01195
      /COPY ZSRSRC,ZDAYSZ1
      /COPY ZSRSRC,ZHASHZ1
      /COPY ZSRSRC,ZNCDZ1
      /COPY ZSRSRC,ZPOWERZ1
      /COPY ZSRSRC,ZPOWER8Z1
      /COPY ZSRSRC,ZSEDITZ1
     E                    CPY@    1   1 80
      /EJECT
     IDPTSWBF
     I              RECI                            BRECI
     I              DPSS                            BDPSS
     I              DPRN                            BDPRN
     I              DPMV                            BDPMV
     I              DPID                            BDPID
     I              DPMD                            BDPMD
     I              DPOD                            BDPOD
     I              DPDO                            BDPDO
     I***********   DPBC                            BDPBC                 S01117
     I              DPBA                            BDPBA                 S01117
     I              DPBK                            BDPBK
     I              DPMK                            BDPMK
     I              DPBN                            BDPBN
     I              DPNA                            BDPNA
     I              DPNR                            BDPNR
     I              MKTP                            BMKTP
     I              DPAD                            BDPAD
     I              DPMS                            BDPMS
     I              DCFR                            BDCFR
     I              TACI                            BTACI
     I              ORED                            BORED
     I              LCD                             BLCD
     I              CHTP                            BCHTP
     I              TNLU                            BTNLU
     I              SWRF                            BSWRF
     I              SIOI                            BSIOI
     IDPTSWAF
     I              RECI                            ARECI
     I              DPSS                            ADPSS
     I              DPRN                            ADPRN
     I              DPMV                            ADPMV
     I              DPID                            ADPID
     I              DPMD                            ADPMD
     I              DPOD                            ADPOD
     I              DPDO                            ADPDO
     I***********   DPBC                            ADPBC                 S01117
     I              DPBA                            ADPBA                 S01117
     I              DPBK                            ADPBK
     I              DPMK                            ADPMK
     I              DPBN                            ADPBN
     I              DPNA                            ADPNA
     I              DPNR                            ADPNR
     I              MKTP                            AMKTP
     I              DPAD                            ADPAD
     I              DPMS                            ADPMS
     I              DCFR                            ADCFR
     I              TACI                            ATACI
     I              ORED                            AORED
     I              LCD                             ALCD
     I              CHTP                            ACHTP
     I              TNLU                            ATNLU
     I              SWRF                            ASWRF
     I              SIOI                            ASIOI
     ICLINTCBF
     I              CNUM                            CCNUM
     I              RCDT                            CRCDT
      *                                                                   CSE037
     IINVTPDF                                                             CSE037
     I              SFLG                            ISFLG                 CSE037
     I*
     I***LDA*****   UDS                            256                    S01117
     I*
     I* DATA STRUCTURE FOR THE LOCAL DATA AREA
     I*
     I***********                           134 177 DBLOT                 S01117
     I***********                           134 138 DBFILE                S01117
     I***********                           139 167 DBKEY                 S01117
     I***********                           168 175 DBPGM                 S01117
     I***********                           176 177 DBASE                 S01117
      *                                                                   S01117
     ILDA         DS                            256                       S01117
      *                                                                   S01117
      ** *LOCK IN LDA immediately before and OUT LDA immediately          S01117
      ** after each database error handling.                              S01117
      *                                                                   S01117
     I                                      134 183 DBLOT                 S01117
     I                                      134 141 DBFILE                S01117
     I                                      142 170 DBKEY                 S01117
     I                                      171 180 DBPGM                 S01117
     I                                      181 1830DBASE                 S01117
     I*
     I            DS
     I*
     I* DS FOR THE COMBINED KEY FOR THE DEPOT SWITCH BEFORE FILE
     I*
     I                                        1  20 KEYB
     I                                        1  14 KEYB4
     I***********                             1   30BDPBC                 S01117
     I                                        1   3 BDPBA                 S01117
     I                                        4   5 BDPMV
     I                                        6  110BDPAD
     I                                       12  14 BSWRF
     I                                       15  20 BDPRN
     I*
     I            DS
     I*
     I* DS FOR THE COMBINED KEY FOR THE DEPOT SWITCH AFTER FILE
     I*
     I                                        1  20 KEYA
     I                                        1  14 KEYA4
     I***********                             1   30ADPBC                 S01117
     I                                        1   3 ADPBA                 S01117
     I                                        4   5 ADPMV
     I                                        6  110ADPAD
     I                                       12  14 ASWRF
     I                                       15  20 ADPRN
     I*
     I            DS
     I                                        1   7 DSKCLI
     I**********                              1   60CCNUM                                     CSD027
     I                                        1   6 CCNUM                                     CSD027
     I                                        7   7 CRCDT
     I*
     I            DS
     I                                        1   6 DSKINV
     I                                        1   3 CCYI
     I                                        4   6 INVT
     I*
      /COPY ZSRSRC,ZHASHZ2
      /COPY ZSRSRC,ZNCDZ2
      /COPY ZSRSRC,ZSEDITZ2
      /COPY ZSRSRC,ZYLDZ1
     ICPYR@#      DS
     I*
     I*  DATA STRUCTURE FOR COMPILATION  - COPYRIGHT INSERTION
     I*
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
      *                                                                   S01195
      ** Data structures for holiday processing.                          S01195
      *                                                                   S01195
     I/COPY ZSRSRC,ZHOLI                                                  S01195
      *                                                                   S01195
     I/COPY ZSRSRC,ZHOLDS                                                 S01195
      *                                                                   S01117
     IRUNDT       DS                                                      S01117
      *                                                                   S01117
      ** RUNDAT data area                                                 S01117
      *                                                                   S01117
     I                                        1   7 RUNA                  S01117
     I                                    P   8  100RUND                  S01117
     I                                       11  11 SSF                   S01117
     I                                       12  12 DATF                  S01117
     I                                       13  13 MBIN                  S01117
     I*                                                                   E29170
     ISPOOL       DS                                                      E29170
     I*                                                                   E29170
     I**  DS FOR P1 SPOOL FILE NAME                                       E29170
     I*                                                                   E29170
     I                                       83  92 SFILE                 E29170
     I                                    B 123 1240SFNUM                 E29170
     I**                                                                  E29170
     ISPOOLU      DS                                                      E29170
     I                                       83  92 SFILEU                E29170
     I                                    B 123 1240SFNUMU                E29170
      *                                                                   S01117
     ISDCURR    E DSSDCURRPD                                              S01117
      *                                                                   S01117
      ** Currency Details                                                 S01117
      *                                                                   S01117
     I/COPY WNCPYSRC,SE5990I001
      /EJECT
     C*================================================================
     C*  P R O G R A M     S T A R T                                  *
     C*================================================================
     C*
     C* First Cycle Processing
     C*
     C           *ENTRY    PLIST
     C                     PARM           PMLIST  1
     C                     PARM           SEQ     5                       S01117
     C*
     C* Prepare LDA
     C*
     C           *NAMVAR   DEFN           LDA                             S01117
     C           *LOCK     IN   LDA                                       S01117
     C                     MOVE *BLANKS   DBLOT
     C                     MOVE 'SEXC90  'DBPGM
     C                     OUT  LDA                                       S01117
      *                                                                   S01117
      ** Read in RUNDAT data area                                         S01117
      *                                                                   S01117
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01117
     C                     IN   RUNDT                                     S01117
      *                                                                   S01117
     C           MBIN      IFEQ 'Y'                                       S01117
     C                     SETON                         20               S01117
     C                     END                                            S01117
     C*                                                                   E29170
     C** RCF Processing for Audit File                                    E29170
     C*                                                                   E29170
     C                     EXSR RCFAU                                     E29170
     C*
     C* Get Installation Control Data record 1
     C*
     C                     EXSR ZSYSTM
     C*
     C* If error in ZSYSTM, abend program
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '01'      DBASE            ***************S01117
     C                     Z-ADD1         DBASE            * DB ERROR 01 *S01117
     C                     MOVEL'TABLE'   DBFILE           ***************
     C                     MOVELZTABKY    DBKEY
     C                     WRITEHEADAU
     C                     WRITEERROR
     C***********          WRITETRAILAU                                   S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C* Get Installation Control Data 2
     C*
     C                     EXSR ZICD2
     C*
     C* If error in ZICD2, abend program
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '02'      DBASE            ***************S01117
     C                     Z-ADD2         DBASE            * DB ERROR 02 *S01117
     C                     MOVEL'TABLE'   DBFILE           ***************
     C                     MOVELZTABKY    DBKEY
     C                     WRITEHEADAU
     C                     WRITEERROR
     C***********          WRITETRAILAU                                   S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C* Calculate Event Control Date
     C*
     C/COPY WNCPYSRC,SE5990C001
      *                                                                                       CSE035
      *  Access SAR details file to see if CSE035 is installed                                CSE035
      *                                                                                       CSE035
     C                     CALL 'AOSARDR0'                                                    CSE035
     C                     PARM *BLANKS   @RTCD                                               CSE035
     C                     PARM '*VERIFY' @OPTN                                               CSE035
     C                     PARM 'CSE035'  @SARD   6                                           CSE035
      *                                                                                       CSE035
     C           @RTCD     IFEQ *BLANK                                                        CSE035
     C                     MOVE 'Y'       CSE035  1                                           CSE035
     C                     ELSE                                                               CSE035
     C                     MOVE 'N'       CSE035                                              CSE035
     C                     ENDIF                                                              CSE035
      *                                                                                       207543
      ** Access SAR details file to see if CEU018 is installed                                207543
      *                                                                                       207543
     C                     CALL 'AOSARDR0'                                                    207543
     C                     PARM *BLANKS   @RTCD                                               207543
     C                     PARM '*VERIFY' @OPTN                                               207543
     C                     PARM 'CEU018'  @SARD                                               207543
      *                                                                                       207543
     C           @RTCD     IFEQ *BLANK                                                        207543
     C                     MOVE 'Y'       CEU018  1                                           207543
     C                     ELSE                                                               207543
     C                     MOVE 'N'       CEU018                                              207543
     C                     ENDIF                                                              207543
      *                                                                                       CSE035
      ** Access Switchable Features file to determine if CSE031 is                          MD057247
      ** installed in the system.                                                           MD057247
      *                                                                                     MD057247
     C                     CALL 'AOSARDR0'                                                  MD057247
     C                     PARM           URTNCD  7                                         MD057247
     C                     PARM '*VERIFY' UOPTN   7                                         MD057247
     C                     PARM 'CSE031'  UUKEY   6                                         MD057247
     C                     PARM           UDSFDY 76                                         MD057247
      *                                                                                     MD057247
     C                     MOVE 'N'       CSE031  1                                         MD057247
     C           URTNCD    IFEQ *BLANKS                                                     MD057247
     C                     MOVE 'Y'       CSE031                                            MD057247
     C                     ENDIF                                                            MD057247
      *                                                                                     MD057247
      ** Access Switchable Features file to determine if CSE071 is                          MD057247
      ** installed in the system.                                                           MD057247
      *                                                                                     MD057247
     C                     CALL 'AOSARDR0'                                                  MD057247
     C                     PARM           URTNCD                                            MD057247
     C                     PARM '*VERIFY' UOPTN                                             MD057247
     C                     PARM 'CSE071'  UUKEY                                             MD057247
     C                     PARM           UDSFDY                                            MD057247
      *                                                                                     MD057247
     C                     MOVE 'N'       CSE071  1                                         MD057247
     C           URTNCD    IFEQ *BLANKS                                                     MD057247
     C                     MOVE 'Y'       CSE071                                            MD057247
     C                     ENDIF                                                            MD057247
      *                                                                                     MD057247
     C                     Z-ADDDNWD      ZZDNWD                          S01117
     C                     Z-ADDAPDA      ZZAPDT                          S01117
     C                     EXSR ZEVCD
     C*
     C* Get Installation Control Data record for Securities trading
     C*
     C                     EXSR ZICDSE
     C*
     C* If error in ZICDSE, abend program
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '03'      DBASE            ***************S01117
     C                     Z-ADD3         DBASE            * DB ERROR 03 *S01117
     C                     MOVEL'TABLE'   DBFILE           ***************
     C                     MOVELZTABKY    DBKEY
     C                     WRITEHEADAU
     C                     WRITEERROR
     C***********          WRITETRAILAU                                   S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C* Setup keys etc
     C*
     C                     MOVE '1'       CCY4    4
     C***********          MOVE 'B'       CRCDT                           097558
     C                     MOVE 'A'       CRCDT                           097558
     C                     MOVEL'N'       FILOPN                          E29170
     C*
     C                     SETON                     03
     C                     Z-ADD0         NOREAD  50
     C                     Z-ADD0         BTOT   150
     C                     Z-ADD0         ATOT   150
     C***********          Z-ADD0         ODPBC   30                      S01117
     C                     MOVE *BLANKS   ODPBA   3                       S01117
     C                     MOVE ' '       ODPMVS  1
     C*
      /EJECT
     C*
     C* Main Cycle processing
     C*
     C                     EXSR SWITCH
     C*
     C                     EXSR AUDIT
     C*
     C**If*no*records*have*been*found,*this*will*be*shown*on*trailer******E29170
     C**page,*but*also*need*to*output*headers*****************************E29170
     C** Only output trailer if P1 printer file is open                   E29170
     C** if no records then put this on audit file                        E29170
     C*
     C***03******          WRITEHEAD1                                     E29170
     C***03******          WRITEHEAD2                                     E29170
     C           *IN03     IFEQ '1'                                       E29170
     C                     WRITENODETL
     C                     END                                            E29170
     C           FILOPN    IFEQ 'Y'                                       E29170
     C                     WRITETRAIL
     C                     END                                            E29170
     C*
     C                     SETON                     LR
     C*
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- SWITCH                                         *
     C*    PROCESS SWITCHES                                           *
     C*                                                               *
     C*    CALLS - READB  READA  SWPROC                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           SWITCH    BEGSR
     C*
     C                     EXSR READB
     C*
     C                     EXSR READA
     C*
     C* Do SWITCH Processing until all records have been read on
     C* both the before and after files
     C*
     C           *IN01     DOWEQ'0'
     C           *IN02     OREQ '0'
     C                     EXSR SWPROC
     C                     END
     C*
     C                     ENDSR
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- SWPROC                                         *
     C*    PROCESS SWITCHES                                           *
     C*                                                               *
     C*    CALLS - CHDEA  CHCLI  CHCCY  CHSEC  CHINV  CVALUE          *
     C*            READA  READB  SRPR01 SRPR02 SRPR03 SRPR04          *
     C*                                                               *
     C*****************************************************************
     C*
     C           SWPROC    BEGSR
     C*
     C* If a new record has been read with a new Branch code,
     C* Movement type, Deal No. or Switch Reference, get the
     C* lesser of the two keys to access deal, client and
     C* currency details
     C*
     C           KEYB4     IFNE KEYB4O
     C           KEYA4     ORNE KEYA4O
     C*
     C           KEYB4     IFLE KEYA4
     C                     MOVE BDPAD     DLNO
     C***********          MOVE BDPBC     DPBC    30                      S01117
     C                     MOVE BDPBA     DPBA    3                       S01117
     C                     MOVELBDPMV     DPMVS   1
     C                     MOVE BSWRF     SWRF    3
     C                     MOVE KEYB4     KEYCUR 14
     C                     END
     C*
     C           KEYA4     IFLT KEYB4
     C                     MOVE ADPAD     DLNO
     C***********          MOVE ADPBC     DPBC    30                      S01117
     C                     MOVE ADPBA     DPBA    3                       S01117
     C                     MOVELADPMV     DPMVS   1
     C                     MOVE ASWRF     SWRF    3
     C                     MOVE KEYA4     KEYCUR 14
     C                     END
     C*
     C* Get details needed for header lines and then print them out
     C*
     C* Get Deal details
     C*
     C                     Z-ADDDLNO      KEYDEA  60
     C                     EXSR CHDEA
     C           *IN99     IFEQ '0'                                       100033
     C*
     C* Get Customer Name and Town
     C*
     C                     MOVELCNUM      CCNUM
     C                     EXSR CHCLI
     C*
     C* Get Currency details
     C*
     C                     MOVEL'20      'ZTABKY
     C                     MOVELCCY       CCY4
     C                     MOVE CCY4      ZTABKY
     C                     EXSR CHCCY
     C*
     C* Output header line
     C*
     C                     EXSR SRPR01
     C*
     C                     END                                            100033
     C                     END
     C*
     C* If overflow has occured, write out headings
     C*
     C           *IN89     IFEQ '1'
     C           *IN99     ANDEQ'0'                                       100033
     C                     EXSR SRPR01
     C                     END
     C*
     C* If the record last read from the Before file has the same
     C* Branch, Movement type, Deal No. and Switch Reference as the
     C* record currently being processed, get the necessary
     C* details and output before details
     C*
     C           KEYB4     IFEQ KEYCUR
     C           *IN99     IFEQ '0'                                       100033
     C*
     C* Access Security details
     C*
     C                     MOVE BDPSS     KEYSEC 10
     C                     EXSR CHSEC
     C*
     C* Access Investment Type details
     C*
     C                     MOVE NMCY      CCYI
     C                     MOVE SITP      INVT
     C                     EXSR CHINV
     C*
     C* Calculate collateral value and output before details
     C*
     C                     Z-ADDBDPNA     ZNOML
     C                     Z-ADDBMKTP     ZPRCE
     C                     EXSR CVALUE
     C                     Z-ADDZCLVL     BCLVL  130
     C                     ADD  BCLVL     BTOT
     C                     EXSR SRPR02
     C                     END                                            100033
     C*
     C* Get next before record
     C*
     C                     EXSR READB
     C                     END
     C*
     C* If the record last read from the After file has the same
     C* Branch, Movement type, Deal No. and Switch Reference as the
     C* record currently being processed, get the necessary
     C* details and output after details
     C*
     C           KEYA4     IFEQ KEYCUR
     C           *IN99     IFEQ '0'                                       100033
     C*
     C* Access security details
     C*
     C                     MOVE ADPSS     KEYSEC 10
     C                     EXSR CHSEC
     C*
     C* Access investment type details
     C*
     C                     MOVE NMCY      CCYI
     C                     MOVE SITP      INVT
     C                     EXSR CHINV
     C*
     C* Calculate collateral value and output before details
     C*
     C                     Z-ADDADPNA     ZNOML
     C                     Z-ADDAMKTP     ZPRCE
     C                     EXSR CVALUE
     C                     Z-ADDZCLVL     ACLVL  130
     C                     ADD  ACLVL     ATOT
     C                     EXSR SRPR03
     C*
     C* Get next before record
     C*
     C                     END                                            100033
     C                     EXSR READA
     C                     END
     C*
     C* Throw a line as that key has been completed
     C*
     C           *IN99     IFEQ '0'                                       100033
     C                     WRITELINE                   89
     C*
     C*
     C* If the Branch, Movement type, Deal No. or Switch Reference
     C* have changed due to the last read from the before or after
     C* files, output the totals line
     C*
     C           KEYB4     IFNE KEYB4O
     C           KEYA4     ORNE KEYA4O
     C                     EXSR SRPR04
     C                     END
     C                     ELSE                                           100033
     C                     SETOF                     99                   100033
     C                     END                                            100033
     C*
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- SRPR01                                         *
     C*    PRINT SWITCH HEADINGS                                      *
     C*                                                               *
     C*    CALLS - CHBRA  ZSEDIT                                      *
     C*                                                               *
     C*****************************************************************
     C*
     C           SRPR01    BEGSR
     C*                                                                   E29170
     C** Open printer file if new branch code                             E29170
     C*                                                                   E29170
     C           DPBA      IFNE ODPBA                                     E29170
     C*                                                                   E29170
     C           FILOPN    IFEQ 'Y'                                       E29170
     C                     WRITETRAIL                                     E29170
     C                     CLOSESE5990P1                                  E29170
     C                     END                                            E29170
     C*                                                                   E29170
     C                     OPEN SE5990P1                                  E29170
     C*                                                                   E29170
     C** RCF Processing for Detail Printer File                           E29170
     C*                                                                   E29170
     C                     EXSR RCFP1                                     E29170
     C                     Z-ADD0         PAGE                            E29170
     C                     MOVEL'Y'       FILOPN  1                       E29170
     C                     END                                            E29170
     C*
     C* Output new page if new branch code or movement
     C* subtype or overflow with title, date and page no
     C*
     C***********DPBC      IFNE ODPBC                                     S01117
     C           DPBA      IFNE ODPBA                                     S01117
     C           DPMVS     ORNE ODPMVS
     C           *IN89     OREQ '1'
     C*
     C                     WRITEHEAD1
     C*
     C**Get*Branch*Name*and*output*report*heading*************************E29170
     C* Get Branch Name and output report heading if Multibranching on    E29170
     C*
     C***********DPBC      IFNE ODPBC                                     S01117
     C           DPBA      IFNE ODPBA                                     S01117
     C***********MBIN      ANDEQ'1'                               E29170  E37680
     C           MBIN      ANDEQ'Y'                                       E37680
     C                     MOVE *BLANKS   ZTABKY                          097558
     C                     MOVEL'10      'ZTABKY
     C***********          MOVE DPBC      ZTABKY                          S01117
     C                     MOVE DPBA      ZTABKY                          S01117
     C                     EXSR CHBRA
     C                     END
     C*
     C                     WRITEHEAD2
     C*
     C* Write out movement subtype heading
     C*
     C           DPMVS     IFEQ 'R'
     C                     WRITEHEAD3R
     C                     END
     C*
     C           DPMVS     IFEQ 'P'
     C                     WRITEHEAD3P
     C                     END
     C*
     C* Write out column headings
     C*
     C                     WRITEHEAD4
     C*
     C***********          Z-ADDDPBC      ODPBC                           S01117
     C                     MOVE DPBA      ODPBA                           S01117
     C                     MOVE DPMVS     ODPMVS
     C                     MOVE '0'       *IN89
     C                     END
     C*
     C* Write out counterparty and dealing information
     C*
     C                     Z-ADDPCPL      ZFLD15
     C                     Z-ADDCDP       ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    ODTOT  20
     C*
     C                     WRITEPR01
     C*
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- SRPR02                                         *
     C*    PRINT 'BEFORE' DETAILS                                     *
     C*                                                               *
     C*    CALLS - ZDATE2  ZSEDIT                                     *
     C*                                                               *
     C*****************************************************************
     C*
     C           SRPR02    BEGSR
     C*
     C* Get greater of 'Depot In' date and 'Depot Out' date and convert
     C* into DDMMMYY format
     C*
     C           BDPMD     IFGT BDPDO
     C                     Z-ADDBDPMD     GDPDT   50
     C                     ELSE
     C                     Z-ADDBDPDO     GDPDT
     C                     END
     C*
     C                     Z-ADDGDPDT     ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    BADATE  7
     C*
     C                     Z-ADDBCLVL     ZFLD15
     C                     Z-ADDCDP       ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    BAMT   17
     C*
     C                     WRITEPR02
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- SRPR03                                         *
     C*    PRINT 'AFTER' DETAILS                                      *
     C*                                                               *
     C*    CALLS - ZDATE2  ZSEDIT                                     *
     C*                                                               *
     C*****************************************************************
     C*
     C           SRPR03    BEGSR
     C*
     C* Get greater of 'Depot In' date and 'Depot Out' date and convert
     C* into DDMMMYY format
     C*
     C           ADPMD     IFLT ADPDO
     C                     Z-ADDADPMD     GDPDT   50
     C                     ELSE
     C                     Z-ADDADPDO     GDPDT
     C                     END
     C*
     C                     Z-ADDGDPDT     ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    AADATE  7
     C*
     C                     Z-ADDACLVL     ZFLD15
     C                     Z-ADDCDP       ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    AAMT   17
     C*
     C                     WRITEPR03
     C*
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- SRPR04                                         *
     C*    PRINT SWITCH TOTALS                                        *
     C*                                                               *
     C*    CALLS - ZSEDIT                                             *
     C*                                                               *
     C*****************************************************************
     C*
     C           SRPR04    BEGSR
     C*
     C* Convert before total and after total to
     C* edited versions for output
     C*
     C                     Z-ADDBTOT      ZFLD15
     C                     Z-ADDCDP       ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    OBTOT  17
     C*
     C                     Z-ADDATOT      ZFLD15
     C                     Z-ADDCDP       ZDECS
     C                     MOVE 'J'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    OATOT  17
     C*
     C* If after total not equal to before total or deal amount,
     C* then output '****'
     C*
     C                     MOVE '1'       *IN04
     C           ATOT      IFEQ PCPL
     C           ATOT      OREQ BTOT
     C                     MOVE '0'       *IN04
     C                     END
     C*
     C                     WRITEPR04                   89
     C*
     C                     Z-ADD0         BTOT
     C                     Z-ADD0         ATOT
     C*
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- READB                                          *
     C*    READ THE NEXT RECORD ON LF/DPTSWB                          *
     C*                                                               *
     C*    CALLS - NONE                                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           READB     BEGSR
     C*
     C           BREADB    TAG
     C                     MOVE KEYB4     KEYB4O 14
     C                     READ DPTSWB                   01
     C*
     C* If a record is read
     C*
     C           *IN01     IFEQ '0'
     C                     ADD  1         NOREAD  50
     C*
     C* If input paramater is 'A' (switches to be actioned today),
     C* and the greater of the In date and Out date is less than
     C* the Event Control Date, finish, else read next record
     C*
     C           PMLIST    IFEQ 'A'
     C*
     C           BDPMD     IFGT BDPDO
     C                     Z-ADDBDPMD     GDPDT   50
     C                     ELSE
     C                     Z-ADDBDPDO     GDPDT   50
     C                     END
     C*
     C***********GDPDT     IFLT ECD                                       100033
     C           GDPDT     IFLE ECD                                       100033
     C                     SETOF                     03
     C                     GOTO EREADB
     C                     ELSE
     C                     GOTO BREADB
     C                     END
     C*
     C                     ELSE
     C                     SETOF                     03
     C*
     C                     END
     C*
     C* else, if no record found set key to *hival
     C*
     C                     ELSE
     C                     MOVE *HIVAL    KEYB4
     C                     END
     C*
     C           EREADB    ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- READA                                          *
     C*    READ THE NEXT RECORD ON LF/DPTSWA                          *
     C*                                                               *
     C*    CALLS - NONE                                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           READA     BEGSR
     C*
     C           BREADA    TAG
     C                     MOVE KEYA4     KEYA4O 14
     C                     READ DPTSWA                   02
     C*
     C* If a record is read
     C*
     C           *IN02     IFEQ '0'
     C                     ADD  1         NOREAD  50
     C*
     C* If input paramater is 'A' (switches to be actioned today),
     C**and*the*greater*of*the*'In*date'*and*'Out*Date'*is*less*than***   100033
     C* and the lesser of the 'In date' and 'Out Date' is less than       100033
     C* the Event Control Date, finish, else read next record
     C*
     C           PMLIST    IFEQ 'A'
     C*
     C***********ADPMD     IFGT ADPDO                                     100033
     C           ADPMD     IFLT ADPDO                                     100033
     C                     Z-ADDADPMD     GDPDT   50
     C                     ELSE
     C                     Z-ADDADPDO     GDPDT   50
     C                     END
     C*
     C***********GDPDT     IFLT ECD                                       100033
     C           GDPDT     IFLE ECD                                       100033
     C                     SETOF                     03
     C                     GOTO EREADA
     C                     ELSE
     C                     GOTO BREADA
     C                     END
     C*
     C                     ELSE
     C                     SETOF                     03
     C*
     C                     END
     C*
     C* else, if no record found set key to *hival
     C*
     C                     ELSE
     C                     MOVE *HIVAL    KEYA4
     C                     END
     C*
     C           EREADA    ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- CVALUE                                         *
     C*    CALCULATE SECURITY COLLATERAL VALUE (IN DEAL CURRENCY)     *
     C*                                                               *
     C*    CALLS - ZCOLLV                                             *
     C*                                                               *
     C*****************************************************************
     C*
     C           CVALUE    BEGSR
     C*
     C                     Z-ADDNMDP      ZNMDP
     C                     MOVE SPBS      ZPRCB
     C                     MOVE STBS      ZTRDB
     C                     Z-ADDCMGN      ZCLMG
     C                     Z-ADDCCCV      ZCLCC
     C                     MOVE NMCY      ZNMCY
     C*
     C           NMCY      IFEQ CCY
     C                     MOVE '   '     ZCLCY
     C                     ELSE
     C                     MOVE CCY       ZCLCY
     C                     END
     C*
     C                     Z-ADDCFCT      ZCFCT
     C                     Z-ADDDNWD      ZZDNWD                          S01117
     C                     Z-ADDAPDA      ZZAPDT                          S01117
     C                     Z-ADDCDP       ZCDP                            S01117
     C*
     C                     EXSR ZCOLLV
     C           *INU7     IFEQ '1'
     C           *INU8     OREQ '1'
     C                     WRITEHEADAU
     C                     WRITEERROR
     C           FILOPN    IFEQ 'Y'                                       E29170
     C                     WRITEERRORP1                                   E29170
     C                     END                                            E29170
     C***********          WRITETRAILAU                                   S01117
     C                     EXSR *PSSR                                     S01117
     C                     SETON                     LR
     C                     RETRN
     C                     END
     C*
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C* CHBRA - Get Table Branch details                              *
     C*                                                               *
     C*****************************************************************
     C*
     C           CHBRA     BEGSR
     C*
     C           ZTABKY    CHAINTABLETRF             99
     C  N99      RECI      COMP 'D'                  9999
     C*
     C* If error in CHAIN, abend program
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '04'      DBASE            ***************S01117
     C                     Z-ADD4         DBASE            * DB ERROR 04 *S01117
     C                     MOVEL'TABLE'   DBFILE           ***************
     C                     MOVELZTABKY    DBKEY
     C                     WRITEHEADAU
     C                     WRITEERROR
     C           FILOPN    IFEQ 'Y'                                       E29170
     C                     WRITEERRORP1                                   E29170
     C                     END                                            E29170
     C***********          WRITETRAILAU                                   S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C                     ENDSR
     C*****************************************************************
      /SPACE 3
     C*****************************************************************
     C*                                                               *
     C* CHCCY - Get Table Currency details                            *
     C*                                                               *
     C*****************************************************************
     C*
     C           CHCCY     BEGSR
     C*
     C           ZTABKY    CHAINTABTG10F             99
     C  N99      RECI      COMP 'D'                  9999
     C*
     C* If error in CHAIN, abend program
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '05'      DBASE            ***************S01117
     C                     Z-ADD5         DBASE            * DB ERROR 05 *S01117
     C                     MOVEL'TABLE'   DBFILE           ***************
     C                     MOVELZTABKY    DBKEY
     C                     WRITEHEADAU
     C                     WRITEERROR
     C           FILOPN    IFEQ 'Y'                                       E29170
     C                     WRITEERRORP1                                   E29170
     C                     END                                            E29170
     C***********          WRITETRAILAU                                   S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C* CHCLI - Get Customer Name and Town                            *
     C*                                                               *
     C*****************************************************************
     C*
     C           CHCLI     BEGSR
     C*
     C           KEYCLI    CHAINCLINTCBF             99
     C  N99      RECI      COMP 'D'                  9999
     C*
     C* If error in CHAIN, abend program
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '06'      DBASE            ***************S01117
     C                     Z-ADD6         DBASE            * DB ERROR 06 *S01117
     C                     MOVEL'CLINT'   DBFILE           ***************
     C                     MOVELDSKCLI    DBKEY
     C                     WRITEHEADAU
     C                     WRITEERROR
     C           FILOPN    IFEQ 'Y'                                       E29170
     C                     WRITEERRORP1                                   E29170
     C                     END                                            E29170
     C***********          WRITETRAILAU                                   S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C* CHDEA - Access Deal details                                   *
     C*                                                               *
     C*****************************************************************
     C*
     C           CHDEA     BEGSR
     C*
     C/COPY WNCPYSRC,SE5990C002
     C           KEYDEA    CHAINDEALSDCF             99
     C  N99      RECI      COMP 'D'                  9999
     C/COPY WNCPYSRC,SE5990C003
     C*
     C**If*error*in*CHAIN,*abend*program****                              100033
     C* If error in CHAIN, depot movement will be ignored.                100033
     C*
     C************IN99     IFEQ '1'                                       100033
     C************LOCK     IN   LDA                                S01117 100033
     C***********          MOVE '07'      DBASE     **********************S01117
     C***********          Z-ADD7         DBASE     * DB ERROR 07 *S01117 100033
     C***********          MOVEL'DEALS'   DBFILE    **********************100033
     C***********          MOVELKEYDEA    DBKEY                           100033
     C***********          WRITEHEADAU                                    100033
     C***********          WRITEERROR                                     100033
     C***********FILOPN    IFEQ 'Y'                                E29170 100033
     C***********          WRITEERRORP1                            E29170 100033
     C***********          END                                     E29170 100033
     C***********          WRITETRAILAU                            S01117 100033
     C***********          OUT  LDA                                S01117 100033
     C***********          EXSR *PSSR                              S01117 100033
     C***********          SETON                     U7U8LR               100033
     C***********          RETRN                                          100033
     C***********          END                                            100033
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C* CHINV - Access investment type details                        *
     C*                                                               *
     C*****************************************************************
     C*
     C           CHINV     BEGSR
     C*
     C           KEYINV    CHAININVTPDF              99
     C  N99      RECI      COMP 'D'                  9999
     C*
     C* If error in CHAIN, abend program
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '08'      DBASE            ***************S01117
     C                     Z-ADD8         DBASE            * DB ERROR 08 *S01117
     C                     MOVEL'INVTP'   DBFILE           ***************
     C                     MOVELDSKINV    DBKEY
     C                     WRITEHEADAU
     C                     WRITEERROR
     C           FILOPN    IFEQ 'Y'                                       E29170
     C                     WRITEERRORP1                                   E29170
     C                     END                                            E29170
     C***********          WRITETRAILAU                                   S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C* CHSEC - Access security details                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           CHSEC     BEGSR
     C*
     C           KEYSEC    CHAINSECTYDF              99
     C  N99      RECI      COMP 'D'                  9999
     C*
     C* If error in CHAIN, abend program
     C*
     C           *IN99     IFEQ '1'
     C           *LOCK     IN   LDA                                       S01117
     C***********          MOVE '09'      DBASE            ***************S01117
     C                     Z-ADD9         DBASE            * DB ERROR 09 *S01117
     C                     MOVEL'SECTY'   DBFILE           ***************
     C                     MOVELKEYSEC    DBKEY
     C                     WRITEHEADAU
     C                     WRITEERROR
     C           FILOPN    IFEQ 'Y'                                       E29170
     C                     WRITEERRORP1                                   E29170
     C                     END                                            E29170
     C***********          WRITETRAILAU                                   S01117
     C                     OUT  LDA                                       S01117
     C                     EXSR *PSSR                                     S01117
     C                     SETON                     U7U8LR
     C                     RETRN
     C                     END
     C*
     C                     ENDSR
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    SUBROUTINE- AUDIT                                          *
     C*    AUDIT PROCESS                                              *
     C*                                                               *
     C*    CALLS - NONE                                               *
     C*                                                               *
     C*****************************************************************
     C*
     C           AUDIT     BEGSR
     C*
     C***********1         CHAINDPTMVAF              99                   E18789
     C*
     C********** *IN99     IFEQ '1'                        *********S01169E18789
     C*********************MOVEL'10'      DBASE            **DB ERR S01169E18789
     C*********************MOVEL'DPMTVA'  DBFILE           *********S01169E18789
     C*********************MOVEL'1'       ZTABKY                    S01169E18789
     C*********************MOVELZTABKY    DBKEY                     S01169E18789
     C*********************SETON                     LRU7U8         S01169E18789
     C*********************ELSE                                     S01169E18789
     C***********NORE      COMP NOREAD               0505                 E18789
     C***05                SETON                     U8                   E18789
     C*********************END                                            E18789
     C*
     C                     WRITEHEADAU
     C                     WRITEDETLAU
     C***********          WRITETRAILAU                                   S01117
     C*
     C                     ENDSR
     C*
     C*****************************************************************
      /EJECT
     C*****************************************************************
     C*                                                               *
     C*    #DEFN SR - DEFINES KEYS                                    *
     C*                                                               *
     C*****************************************************************
     C*
     C           #DEFN     BEGSR
     C*
     C           KEYCLI    KLIST
     C                     KFLD           CCNUM
     C                     KFLD           CRCDT
     C*
     C           KEYINV    KLIST
     C                     KFLD           CCYI
     C                     KFLD           INVT
     C*
     C                     ENDSR
     C********************************************************************
      /EJECT                                                              S01117
      *****************************************************************   S01117
      *                                                               *   S01117
      * *PSSR  - Database error subroutine.                           *   S01117
      *          This subroutine DUMPs the program just once.         *   S01117
      *                                                               *   S01117
      * Called by: DB ERROR PROCESSING                                *   S01117
      *                                                               *   S01117
      * Calls: None                                                   *   S01117
      *                                                               *   S01117
      *****************************************************************   S01117
      *                                                                   S01117
     C           *PSSR     BEGSR                           ** *PSSR SR ** S01117
      *                                                                   S01117
     C           @RUN      IFEQ *BLANK                                    S01117
     C                     MOVE 'Y'       @RUN    1                       S01117
     C                     DUMP                                           S01117
     C                     END                                            S01117
      *                                                                   S01117
     C                     ENDSR                                          S01117
      *                                                                   S01117
      ********************************************************************S01117
     C/EJECT                                                              E29170
     C********************************************************************E29170
     C*                                                                   E29170
     C*  RCFP1 -- SUBROUTINE TO REGISTER P1 PRINTER FILE VIA RCF          E29170
     C*                                                                   E29170
     C********************************************************************E29170
     C*                                                                   E29170
     C           RCFP1     BEGSR                            ** RCFP1 **   E29170
     C*                                                                   E29170
     C**      ENSURE REPORT SPOOL FILE RECORDED BY RCF                    E29170
     C*                                                                   E29170
     C                     Z-ADDSFNUM     ZSNUM   60                      E29170
     C**                                                                  E29170
     C                     CALL 'ZSFILE'                                  E29170
     C                     PARM           SEQ     5                       E29170
     C                     PARM DPBA      SENTY   3                       E29170
     C                     PARM           SFILE                           E29170
     C                     PARM           ZSNUM                           E29170
     C                     PARM           ZSERR   1                       E29170
     C*                                                                   E29170
     C           ZSERR     IFEQ 'Y'                                       E29170
     C*                                                                   E29170
     C**  ERROR DURING ZSFILE PROCESSING, RETURN TO CALLING PROGRAM       E29170
     C*                                                                   E29170
     C                     SETON                     U7U8LR               E29170
     C                     RETRN                                          E29170
     C                     END                                            E29170
     C*                                                                   E29170
     C                     ENDSR                                          E29170
     C*                                                                   E29170
     C********************************************************************E29170
     C/EJECT                                                              E29170
     C********************************************************************E29170
     C*                                                                   E29170
     C*  RCFAU -- SUBROUTINE TO REGISTER AU PRINTER FILE VIA RCF          E29170
     C*                                                                   E29170
     C********************************************************************E29170
     C*                                                                   E29170
     C           RCFAU     BEGSR                            ** RCFAU **   E29170
     C*                                                                   E29170
     C**      ENSURE AUDIT SPOOL FILE RECORDED BY RCF                     E29170
     C*                                                                   E29170
     C                     Z-ADDSFNUMU    ZSNUMU  60                      E29170
     C**                                                                  E29170
     C                     CALL 'ZSFILE'                                  E29170
     C                     PARM           SEQ                             E29170
     C                     PARM *BLANKS   SENTY                           E29170
     C                     PARM           SFILEU                          E29170
     C                     PARM           ZSNUMU                          E29170
     C                     PARM *BLANK    ZSERR                           E29170
     C*                                                                   E29170
     C           ZSERR     IFEQ 'Y'                                       E29170
     C*                                                                   E29170
     C**  ERROR DURING ZSFILE PROCESSING, RETURN TO CALLING PROGRAM       E29170
     C*                                                                   E29170
     C                     SETON                     U7U8LR               E29170
     C                     RETRN                                          E29170
     C                     END                                            E29170
     C*                                                                   E29170
     C                     ENDSR                                          E29170
     C*                                                                   E29170
     C*****************************************************************   E29170
      ***/EJECT**                                                   S01232S01195
     C***/COPY*ZSRSRC,XDATE3Z1                                      S01232S01195
      /EJECT                                                              S01195
     C/COPY ZSRSRC,ZACCH                                                  S01195
      /EJECT                                                              S01232
     C/COPY ZSRSRC,ZACCRZ1                                                S01232
      /EJECT                                                              S01232
     C/COPY ZSRSRC,ZACCZZ1                                                S01232
      /EJECT                                                              S01195
     C/COPY ZSRSRC,ZBKDT                                                  S01195
      /EJECT                                                              054763
     C/COPY ZSRSRC,ZCALCD                                                 054763
      /EJECT                                                              054763
     C/COPY ZSRSRC,ZCNSDZ1                                                054763
      /EJECT
     C/COPY ZSRSRC,ZCOLLVZ1
      /EJECT
     C/COPY ZSRSRC,ZCONVZ1
      /EJECT
     C/COPY ZSRSRC,ZDATE1Z2
      /EJECT
     C/COPY ZSRSRC,ZDATE2Z2
      /EJECT
     C/COPY ZSRSRC,ZDAYSZ2
      /EJECT
     C/COPY ZSRSRC,ZDYYRZ3
      /EJECT
     C/COPY ZSRSRC,ZEVCDZ1
      /EJECT
     C/COPY ZSRSRC,ZHASHZ3
      /EJECT
     C/COPY ZSRSRC,ZICD2Z1
      /EJECT
     C/COPY ZSRSRC,ZICDSEZ1
      /EJECT                                                              E20380
     C/COPY ZSRSRC,ZLCDZ1                                                            E20380 MD057247
      /EJECT
     C/COPY ZSRSRC,ZNCDZ3
      /EJECT
     C/COPY ZSRSRC,ZPRCIZ1
      /EJECT                                                              S01232
     C/COPY ZSRSRC,ZRATEZ1                                                S01232
      /EJECT
     C/COPY ZSRSRC,ZSEDITZ3
      /EJECT
     C/COPY ZSRSRC,ZSYSTMZ1
      /EJECT
     C/COPY ZSRSRC,ZXRATEZ1
      /EJECT                                                              S01232
     C/COPY ZSRSRC,ZYCEZ1                                                 S01232
      /EJECT
     C/COPY ZSRSRC,ZYLDIZ1
      /EJECT
     C/COPY ZSRSRC,ZYLDZ2
      /EJECT
      ***
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**   ZF29 DAY NOS OF FEB 29 TO 2096 (INCLUDING 2000)
0006001521029820444305904073650882610287117481320914670161311759219053
2051421975234362489726358278192928030741322023366335124365853804639507
40968424294389045351
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  CPY@
(c) Finastra International Limited 2001
