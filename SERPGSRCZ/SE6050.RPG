     H
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Settlement authorisation')                    *
/*OVRF*: OVRDBF FILE(SEOCFSXX) TOFILE(SEOCFSPD) SHARE(*NO)             : *S01464
/*OVRF*: OVRDBF FILE(SESCFAXX) TOFILE(SESCFAPD) SHARE(*NO)             : *S01464
     F********************************************************************
     F*                                                                  *
     F*       Midas  SAFE CUSTODY FEES MODULE                            *
     F*                                                                  *
     F*       SE6050 - SC FEE SETTLEMENT AUTHORIZATION                   *
     F*                                                                  *
     F**      FUNCTION:  This program, in amend mode, displays a list of *
     F**      I/C        outstanding custody fee settlements and allows  *
     F**                 the user to authorise, amend, delete as re-     *
     F**                 quired.  In insert mode, settlements are genera-*
     F**                 ted out of any accrued fees for a customer.     *
     F**                                                                 *
     F**      CALLED BY: SEC02 - Input Cycle Processing                  *
     F**                                                                 *
      *  (c) Finastra International Limited 2001                      *
     F*                                                                  *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CER059             Date 19Jul10               *
      *                 CER043             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.03 -----------------------------------------------*
      *                 174057             Date 03May00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CPB001             Date 13Aug99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
     F*                 065025             DATE 02MAY96                  *
     F*                 049067             DATE 01MAY96                  *
     F*                 045532             DATE 01MAY96                  *
     F*                 096749             DATE 22APR96                  *
     F*                 092108             DATE 22AUG95                  *
     F*                 091522             DATE 14AUG95                  *
     F*                 S01464             DATE 04APR94                  *
     F*                 44139              DATE 23SEP92                  *
     F*                    S01355             DATE 14DEC92               *
     F*                    48202              DATE 07DEC92               *
     F*                    48200      GB      DATE 07DEC92               *
     F*                    47719              DATE 24NOV92               *
     F*                    R0192              DATE 20FEB91               *
     F*                                                                  *
     F*------------------------------------------------------------------*
     F*                                                                  *
      *  MD046248 - Finastra Rebranding                               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER043 - German Features LF041-00 New Fields and Defaulting  *
      *           (Recompile)                                            *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  174057 - Program exits from enquiry when roll-up is pressed for *
      *           more screens. Should not limit loading to one screen.  *
     F*  CPB001 - 'Private Banking' Module                               *
     F*  065025 - SETTLEMENT DATE MUST BE AMENDABLE.                     *
     F*           (REMOVE PART OF 049067).                               *
     F*  049067 - NEED TO KEY SETTLEMENTS FILE WITH DATE AS POSSIBLE     *
     F*           TO HAVE TWO SETTLEMENTS FOR A CUSTOMER/PORTFOLIO       *
     F*           BUT WITH DIFFERENT VALUE DATES - THEREFORE R0192       *
     F*           REMOVED AND CORRECTED.                                 *
     F*  045532 - ERROR MESSAGE 'SE05015' DISPLAYED ON INSERTIONS        *
     F*           EVENT THOUGH SETTLEMENT HAS BEEN DELETED.              *
     F*           RE-USE DELETED SETTLEMEMT IF INSERTING NEW             *
     F*           SETTLEMENT FOR CUSTOMER/PORTFOLIO.                     *
     F*  096749 - AFTER ROLLUP, ONLY ONE RECORD WAS DISPLAYED DUE TO     *
     F*           END OF SUBFILE INDICATOR NOT RESET TO 0 WHEN RECORDS   *
     F*           FOUND AND WRONG COUNTER CONSIDERATION (7 RECORDS BY    *
     F*           SCREEN)                                                *
     F*  092108 - When a retail account number is used as settlement  *
     F*           account, settlement ccy and settlement branch must  *
     F*           be the same as the ccy and branch of the account.   *
     F*  091522 - Safe Custody Fees - Private Banking (CSE001)        *
     F*    S01464 - SAFE CUSTODY FEES                                    *
     F*    44139  - Fixes to ensure that manual insert of                *
     F*             settlements work                                     *
     F*    S01355 - RELEASE 3 INCORPORATION
     F*    48202  - IN INSERT MODE IF 'FEE ACCRUED' + 'OUTSTANDING
     F*        ADJUSTMENTS' *LT MINIMUM COMMISSION FOR PERIOD SET        *
     F*        ACTUAL FEE TO MINIMUM COMMISSION                          *
     F*     48200   -  SUPPRESS SUBR FOR CONVERSION OF AN AMOUNT      *
     F*                IN ANOTHER CURRENCY USING THE KONVENTIONKURSE  *
     F*                EXCHANGE RATE (SWISS)                         *
     F*    47719  - CORRECT CONVERSION OF AMOUNTS BETWEEN CURRENCIES
     F*       R0192  - Missing portfolio when you press roll up.         *
     F*              - Do not show the deleted portfolio customer.       *
     F*                                                                  *
     F********************************************************************
     F*  C R E A T I O N     P A R A M E T E R S                         *
     F*                                                                  *
     F***OVRDBF*FILE(SCOCFSXX)*TOFILE(SCOCFSPD)*SHARE(*NO)             : *S01464
     F***OVRDBF*FILE(SCSCFAXX)*TOFILE(SCSCFAPD)*SHARE(*NO)             : *S01464
     F*                                                                  *
     F********************************************************************
     F/EJECT
     F********************************************************************
     F*
     F*       FILE DEFINITIONS
     F*      ------------------
     F*
     F* Bank Details File (PREFIX - BJ).
     F*
     F***SDBANKPDIF**E********************DISK*********KINFSR**PSSR       S01464
     F********                                                            S01464
     F**Portfolio*Customer*Definitions*File.                              S01464
     F********                                                            S01464
     F***SDPLCSPDIF**E***********K********DISK*********KINFSR**PSSR       S01464
     FSDPLCSL0IF  E           K        DISK         KINFSR *PSSR          091522
     F** Portfolio Customer Definitions File.                             091522
     F*
     F* Safe Custody ICD.
     F*
     F***SCICDPPDIF**E***********K********DISK*********KINFSR**PSSR       S01464
     F********                                                            S01464
     F**Portfolio*Management*ICD.                                         S01464
     F********                                                            S01464
     F***SDPORTPDIF**E***********K********DISK*********KINFSR**PSSR       S01464
     F*
     F* Outstanding Custody Fee Settlements.
     F*
     F***SCOCFSXXIF**E***********K********DISK*********KINFSR**PSSR       S01464
     FSEOCFSXXIF  E           K        DISK         KINFSR *PSSR          S01464
     F*
     F* Safe Custody Fees Accrued File.
     F*
     F***SCSCFAXXIF**E***********K********DISK*********KINFSR**PSSR       S01464
     FSESCFAXXIF  E           K        DISK         KINFSR *PSSR          S01464
     F***********                                                         S01464
     F**Customer*master*File*(number*sequence).                           S01464
     F***********                                                         S01464
     F***SDCUSTL5IF**E***********K********DISK*********KINFSR**PSSR       S01464
     F***********                                                         S01464
     F**Customer*master*File*(shortname*sequence).                        S01464
     F***********                                                         S01464
     F***SDCUSTL6IF**E***********K********DISK*********KINFSR**PSSR       S01464
     F*
     F**Currency*Details*extension*File.                                  S01464
     F*******                                                             S01464
     F***SDCURRJ0IF**E***********K********DISK*********KINFSR**PSSR       S01464
     F*
     FSDCURRL0IF  E           K        DISK                                48200
     F                                              KINFSR *PSSR           48200
     F* Customer Account Details.
     F*
     FACCNT   IF  E           K        DISK         KINFSR *PSSR
     F*
     F* Customer Account Number details.
     F*
     FACNUM   IF  E           K        DISK         KINFSR *PSSR
     F            ACCNTABF                          KRENAMEACCNTAB2
     F*                                                                   S01464
     F* SD customer fees detail                                           S01464
     F*                                                                   S01464
     FSDCFCDL0IF  E           K        DISK         KINFSR *PSSR          S01464
     F*
     F**Portfolio*Definitions*File.                                       S01464
     F*********                                                           S01464
     F*PMPORTLLIF**E           K        DISK         KINFSR *PSSR         48202
     F***PMPORTPPIF**E***********K********DISK*********KINFSR**PSSR  48202S01464
     FPMPORTPDIF  E           K        DISK         KINFSR *PSSR          091522
     F** Portfolio Definitions File.                                      091522
     F*                                                                   48202
     F**   CUSTODY FEE GROUPS DEFINITION          PREFIX - SB             48202
     F***SCCFGRPDIF**E***********K********DISK*********KINFSR**PSSR  48202
     FSECFGRPDIF  E           K        DISK         KINFSR *PSSR          S01464
     F*
     F* Security Trading Clients File.
     F*
     FSDSECSL1IF  E           K        DISK         KINFSR *PSSR
     F*
     F* Safe Custody Fees Accrued.
     F*
     F***SCSCFAPDUF**E***********K********DISK*********KINFSR**PSSR       S01464
     FSESCFAPDUF  E           K        DISK         KINFSR *PSSR          S01464
     F                                              KCOMIT
     F************SCSCFAP0                          KRENAMESCSCFAP1       S01464
     F            SESCFAP0                          KRENAMESESCFAP1       S01464
     F*
     F* Outstanding Custody Fee Settlements.
     F*
     F***SCOCFSPDUF**E***********K********DISK*********KINFSR**PSSR A     S01464
     FSEOCFSPDUF  E           K        DISK         KINFSR *PSSR A        S01464
     F                                              KCOMIT
     F************SCOCFSP0                          KRENAMESCOCFSP1       S01464
     F            SEOCFSP0                          KRENAMESEOCFSP1       S01464
     F*
     F* Screen Format.
     F*
     F***SE6050DDCF**E********************WORKSTN******KINFSR**PSSR       S01464
     FSE6050DFCF  E                    WORKSTN      KINFSR *PSSR          S01464
     F                                        S1RRN KSFILE SE6050S1
     F*
     F/COPY WNCPYSRC,SE6050F001
     F********************************************************************
     F/EJECT
     F********************************************************************
     F*                                                                  *
     F*  ID F  C  H  L    FUNCTION OF INDICATORS                         *
     F*                  ------------------------                        *
     F*                                                                  *
     F*        03 - EXIT                                                 *
     F*                                                                  *
     F*        26 - SFLEND    }- MESSAGE SUBFILE                         *
     F*                                                                  *
     F*        27 - ROLLUP    }                                          *
     F*        31 - SFLCLR    }- REVIEW FROM SUBFILE                     *
     F*        32 - SFLDSP    }                                          *
     F*        34 - SFLDSPCTL }                                          *
     F*        35 - SFLEND    }                                          *
     F*        36 - SFLNXTCHG }                                          *
     F*                                                                  *
     F*        38 - DISPLAY OF (X,D) OR (D) ON ACTION FIELD              *
     F*                                                                  *
     F*********40 - READ SCICDPPD                                        *S01464
     F*        41 - READ SCPORTPD                                        *
     F*        42 - ENABLE CMD 9                                         *
     F*        43 - ENABLE CMD 12                                        *
     F*        45 - INSERT MODE                                          *
     F*        47 - CHAINING TO ACNUM                                    *
     F*        48 - CHAINING TO ACCNT                                    *
     F*        49 - REVERSE IMAGE CUSTOMER FIELD                         *
     F*                                                                  *
     F*        50 - MULTI-BRANCHING INDICATOR                            *S01464
     F*        58 - CONTROL OUTPUT OF PORTFOLIO DETAILS                  *
     F*        59 - READING SUBFILE                                      *
     F*                                                                  *
     F*        60 - 62 CONTROL OUTPUT OF CORRECT FOOTINGS                *
     F*        63 - PROTECT REVIEW FROM FIELDS                           *
     F*        64 - PROTECT SUBFILE FIELDS                               *
     F*        65 - UPDATE SUCCESSFUL                                    *
     F*        66 - RECORD CHANGED AND VALID ON SUBFILE                  *
     F*        67 - CONTROL OUTPUT OF CORRECT FOOTINGS                   *
     F*        68 - NON-DISPLAY OF CONFIRM OPTION                        *
     F*                                                                  *
     F*        70 - READING SDBANKPD                                     *
     F*        71 - READING SEOCFSXX                                     *
     F*        75 - READING SUBFILE                                      *
     F*        73 - CHAINING TO SDCURRJ0                                 *
     F*        77 - GENERAL ERROR INDICATOR                              *
     F*        78 - READ CHANGED RECORD ON SUBFILE                       *
     F*                                                                  *
     F*        81 - 88 REVERSE IMAGE INDICATORS                          *
     F*                                                                  *
     F********************************************************************
     F/EJECT
     E********************************************************************
     E*
     E*    ARRAY FOR COPYRIGHT
     E                    CPY@    1   1 80
     E*
     E                    POWER   1   7  7 3             POWER ARRAY
     E*
     E                    ZA1        16  1               ZALIGN SR. ARRAY
     E                    ZA2        16  1               ZALIGN SR. ARRAY
     E*
     E                    ZS1        15  1 0             ZSEDIT SR. ARRAY
     E                    ZS2        21  1               ZSEDIT SR. ARRAY
     E*
     E                    ZYDY    4   4  4 0             ZDATE1 YEAR
     E                    ZMDY   13  13  3 0             ZDATE1 MONTH
     E*
     E                    ZMNM   12  12  3               ZDATE2 SR. ARRAY
     E/COPY WNCPYSRC,SE6050E001
     E********************************************************************
     E*
     E/EJECT
     I********************************************************************
     I*
     I* DATA STRUCTURE FOR COMPILATION - COPYRIGHT INSERTION
     I*
     ICPYR@$      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@$$
     I*
     I* PROGRAM STATUS DATA STRUCTURE
     I*
     IPSDS       SDS
     I                                      244 253 DDWID
     I                                      254 263 USER
     I*
     I* FILE INFORMATION DATA STRUCTURE
     I*
     I**FIL1DS      DS
     I**                                   *STATUS  STATUS
     I*
     I* FILE INFORMATION DATA STRUCTURE
     I*
     IFIL2DS      DS
     I                                    B 397 4000WWHRRN
     I*                                                                   S01464
     IRUNDT       DS                             13                       S01464
     I** Rundate data area                                                S01464
     I                                       13  13 MBIN                  S01464
     I*
     I* LOCAL DATA AREA FOR DATA BASE ERRORS
     I*
     I*LDA        UDS                            256                      S01464
     ILDA         DS                            256                       S01464
     I***                                   132 141 DBFILE                S01464
     I                                      134 141 DBFILE                S01464
     I                                      142 170 DBKEY
     I                                      171 180 DBPGM
     I                                      181 1830DBASE
     I*                                                                   S01464
     I** Data Area of menu user                                           S01464
     IZMUSER      DS                             17                       S01464
     I                                       11  13 USRBCH                S01464
     I*
     I* DATA AREA FOR UPDATE PROCESSING
     I*
     IDNATN       DS                              5
     I                                        1   50FNATN
     I*
     I**   DATA STRUCTURE TO PROVIDE TEXT ON COMIT ENTRY IN JOURNAL
     I*
     ICMTTXT      DS                             56
     I                                        1   50WWNATN
     I                                        6   7 MDID
     I                                        8  17 PGMN
     I                                       18  27 WSIDX
     I                                       28  330MTIME
     I                                       34  34 ACTCDX
     I                                       35  42 USIDX
     I**********                             43  480SECNUM                                    CSD027
     I                                       43  48 SECNUM                                    CSD027
     I                                       49  52 S1PORT
     I*
     I            DS
     I                                        1  150WORK15
     I                                        1  150ZS1
     I*
     I* DAY, MONTH & YEAR OF LAST UPDATE
     I*
     I            DS
     I                                        1   7 WKDAT
     I                                        1   20WKDAY
     I                                        3   5 WKMTH
     I                                        6   70WKYR
     I*
     I* Customer number Shortname data Structure.
     I*
     I            DS
     I                                        1  10 S1CUST
     I                                        1   6 WKCUSA
     I                                        7  10 WKCUSB
     I*
     I* Settlement Account data Structure.
     I*
     I            DS
     I**********                              1  12 S1ACCV                                    CGL029
     I**********                              1  10 WKACC1                                    CGL029
     I**********                             11  12 WKACC2                                    CGL029
     I                                        1  18 S1ACCV                                    CGL029
     I                                        1  16 WKACC1                                    CGL029
     I                                       17  18 WKACC2                                    CGL029
     I**********                              1   60WKAKCU                                    CSD027
     I                                        1   6 WKAKCU                                    CSD027
     I**********                              7  100WKAKCD                                    CGL029
     I**********                             11  120WKAKSQ                                    CGL029
     I                                        7  160WKAKCD                                    CGL029
     I                                       17  180WKAKSQ                                    CGL029
     I/COPY WNCPYSRC,SE6050I001
     I*                                                                   S01464
     ISDBANK    E DSSDBANKPD                                              S01464
     I** Bank details                                                     S01464
     ISDCURR    E DSSDCURRPD                                              S01464
     I** Currency Details                                                 S01464
     ISDCUST    E DSSDCUSTPD                                              S01464
     I** Customer Details                                                 S01464
     ISDBRCH    E DSSDBRCHPD                                              S01464
     I              QQDFAC                          QQDFA1                                    CGL029
     I** Customer Branch Details                                          S01464
     ISDSTRD    E DSSDSTRDPD                                              S01464
     I** Securities Trading ICD                                           S01464
     ISDSCFE    E DSSDSCFEPD                                              S01464
     I** Safe Custody ICD                                                 S01464
     I**                                                                  S01194
     ISDMMOD    E DSSDMMODPD                                              091522
     I** Midas Modules File                                               091522
     I*                                                                   091522
     ISDPORT    E DSSDPORTPD                                              091522
     I** Portfolio Management ICD                                         091522
     I*                                                                   091522
     IDSFDY     E DSDSFDY                                                 S01194
     I*  FIRST DS FOR ACCESS PROGRAMS, SHORT DATA STRUCTURE               S01194
     I**                                                                  S01464
     IDSSDY     E DSDSSDY                                                 S01464
     I*  SECOND DS FOR ACCESS PROGRAMS, LONG DATA STRUCTURE               S01464
     I*
     I********************************************************************
     C*
     C* KEY LISTS AND PARAMETER LISTS.
     C* ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
     C*
     C* Key List for File SEOCFSPD.
     C*
     C           FSPDKY    KLIST
     C                     KFLD           SEBRCA                          S01464
     C                     KFLD           SECNUM
     C                     KFLD           SEPTFR
     C                     KFLD           SESEVD                          049067
     C*
     C* Key List for File SEOCFSXX.
     C*
     C           FAXKEY    KLIST
     C***********          KFLD           WKBRCA  3                S01464 091522
     C                     KFLD           S1BRCH                          091522
     C**********           KFLD           WKCNUM  60                                          CSD027
     C                     KFLD           WKCNUM  6                                           CSD027
     C                     KFLD           WKPTFR  4
     C***********                                                         S01464
     C**Key*List*for*File*PMPORTLL.                                       S01464
     C***********                                                         S01464
     C***********PORTKY    KLIST                                          S01464
     C***********          KFLD           PNCNUM                          S01464
     C***********          KFLD           PNPTFR                          S01464
     C*                                                                   091522
     C** Key List for File PMPORTPD.                                      091522
     C*                                                                   091522
     C           PORTKY    KLIST                                          091522
     C                     KFLD           PNCNUM                          091522
     C                     KFLD           PNPTFR                          091522
     C*
     C* Key List for File ACCNT
     C*
     C           ACNTKY    KLIST
     C                     KFLD           WKAKCU
     C                     KFLD           S1CURR
     C                     KFLD           WKAKCD
     C                     KFLD           WKAKSQ
     C*                                                                   S01464
     C           ACNTK2    KLIST                                          S01464
     C                     KFLD           WKAKCU                          S01464
     C                     KFLD           S1CURR                          S01464
     C                     KFLD           WKAKCD                          S01464
     C                     KFLD           WKAKSQ                          S01464
     C                     KFLD           S1BRCA                          S01464
     C/EJECT
     C********************************************************************
     C*
     C*               START MAINLINE
     C*              ----------------
     C*
     C* Initial Processing.
     C*
     C                     EXSR #A
     C*
     C* Initialize Subfile.
     C*
     C                     EXSR #B
     C*
     C* Load first page of subfile.
     C*
     C                     EXSR #YA
     C*
     C* Output Screen.
     C*
     C                     EXSR #YB
     C*
     C* Process Screen while not CMD 3 selected.
     C*
     C           *INKC     DOWEQ'0'
     C*
     C* Process according to Command Key selected.
     C*
     C           *IN27     CASEQ'1'       #YA              Roll-up
     C                     CAS            #C               Enter
     C                     END
     C*
     C* If Confirm screen required allow confirm option to be          .
     C* displayed and Subfile protected.                               .
     C*
     C           *IN45     IFEQ '1'
     C*
     C           WKINSA    IFNE 'Y'
     C           WKINER    ANDEQ'N'
     C                     EXSR #G
     C                     END
     C*
     C           WKLDCF    IFEQ 'Y'
     C                     EXSR #D
     C                     END
     C*
     C                     EXSR #YB
     C*
     C                     ELSE
     C*
     C           WKLDCF    IFEQ 'Y'
     C                     EXSR #D
     C                     END
     C*
     C                     EXSR #YB
     C                     END
     C*
     C                     END
     C*
     C* End program.
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C********************************************************************
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*           INDEX TO SUBROUTINES                                   *
     C*          ----------------------                                  *
     C*                                                                  *
     C*    1.  #A     - INITIALISATION                                   *
     C*    2.  #B     - INITIALISATION OF SUBFILE                        *
     C*    3.  #C     - CONTROL OF VALIDATION                            *
     C*    4.  #CA    - VALIDATION OF CONFIRM SCREEN                     *
     C*    5.  #CB    - VALIDATION OF MAIN CHANGE SUBFILE SCREEN         *
     C*    6.  #CBA   - FIELD VALIDATION OF SUBFILE.                     *
     C*    7.  #CBB   - VALIDATION OF REVIEW FROM FIELDS                 *
     C*    8.  #D     - SETUP CONFIRM SCREEN                             *
     C*    9.  #E     - UPDATE IN CHANGE MODE                            *
     C*   10.  #F     - SETUP UNPROTECTED SUBFILE AFTER CONFIRM          *
     C*   11.  #G     - SETUP INSERT SCREEN - INSERT MODE                *
     C*   12.  #CE    - VALIDATION OF INSERT SCREEN - INSERT MODE        *
     C*   13.  #CD    - VALIDATION OF INSERT SCREEN - AMEND MODE         *
     C*   14.  #CC    - VALIDATION OF INSERT SCREEN - CONFIRM MODE       *
     C*   15.  #K     - UPDATE IN INSERT MODE                            *
     C*   16.  #H     - CREATE SUBFILE IN INSERT MODE                    *
     C*   17.  #I     - CREATE SUBFILE RECORD IN INSERT MODE             *
     C*   18.  #YA    - CREATE SUBFILE                                   *
     C*   19.  #YAA   - CREATE SUBFILE RECORD                            *
     C*   20.  #YB    - DISPLAY SCREENS                                  *
     C*   22.  #PSSR  - PROGRAM ERROR HANDLING ROUTINE                   *
     C*                                                                  *
     C********************************************************************
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #A        - INITIALISATION                                      *
     C*                                                                  *
     C*  CALLS     - NONE                                                *
     C*                                                                  *
     C*  CALLED BY - MAINLINE                                            *
     C*                                                                  *
     C********************************************************************
     C           #A        BEGSR
     C*
     C* INITIALISE DB ERROR FIELDS ETC, AND STORE PROGRAM NAME FOR
     C* DB ERROR FIELD.
     C*
     C** Prepare LDA                                                      S01464
     C*                                                                   S01464
     C           *NAMVAR   DEFN           LDA                             S01464
     C                     MOVE *BLANKS   DBFILE
     C                     MOVE *BLANKS   DBKEY
     C                     MOVE *BLANKS   DBASE
     C                     MOVEL'SE6050'  DBPGM
     C*
     C                     MOVE *BLANKS   WWTPGQ 10
     C                     MOVEL'*'       WWTPGQ
     C                     MOVE *BLANKS   WWPGQR  5
     C                     MOVEL'*PRV'    WWPGQR
     C*
     C                     MOVE *BLANKS   ZAMSGF
     C                     MOVEL'SEUSRMSG'ZAMSGF
     C*
     C* Initialise indicator responsible for controlling validation of
     C* Confirm screen.
     C*
     C                     MOVE 'N'       WKFSRN  1
     C*
     C* Initialise error indicator.
     C*
     C                     MOVE *BLANKS   WKEROR  1
     C                     MOVE *BLANKS   WWEROR  1                       S01464
     C*
     C* Initialise indicators.
     C*
     C                     SETOF                     2749
     C*
     C* Set off insert mode indicator.
     C*
     C                     SETOF                     45
     C*
     C* Set off 'non-display of subfile header fields' indicator.
     C*
     C                     SETOF                     46
     C*
     C                     SETOF                     28
     C*
     C* Set up Screen initial screen Review from fields.
     C*
     C                     MOVE *BLANKS   S1CUST
     C                     MOVE *BLANKS   S1PORT
     C                     MOVE *BLANKS   S1BRCH                          S01464
     C*
     C* Initialize Confirm field.
     C*
     C                     MOVE *BLANKS   S1CNFM
     C*
     C* Initialize 'Load Confirm Screen' work indicator.
     C*
     C                     MOVE 'N'       WKLDCF  1
     C*
     C* Initialize 'Error on Insert screen -insert mode' indicator.
     C*
     C                     MOVE 'N'       WKINER  1
     C*
     C* Initialize 'Insert screen Amend' work indicator.
     C*
     C                     MOVE 'N'       WKINSA  1
     C*
     C* Access ICD File SDBANKPD.
     C*
     C***********1         SETLLSDBANKPD                                  S01464
     C***********          READ SDBANKPD                 70               S01464
     C                     CALL 'AOBANKR0'                                S01464
     C                     PARM '*DBERR ' @RTCD   7                       S01464
     C                     PARM '*FIRST ' @OPTN   7                       S01464
     C           SDBANK    PARM SDBANK    DSSDY                           S01464
     C*                                                                   S01464
     C**If*Record*not*found*or*deleted*-*Database*Error.                  S01464
     C***********                                                         S01464
     C************IN70     IFEQ '1'                                       S01464
     C***********BJTYLC    OREQ 'D'                                       S01464
     C***********          Z-ADD1         DBASE
     C***********          MOVE *BLANKS   DBFILE           ***************
     C***********          MOVEL'SDBANKPD'DBFILE           * DBERROR 001 *
     C***********          MOVE *BLANKS   DBKEY            ***************
     C***********          MOVE '1'       *INU7
     C***********          MOVE '1'       *INU8
     C***********          MOVE '1'       *INLR
     C***********          RETRN
     C***********          END
     C*
     C**   SET UP DATE FORMAT INDICATOR
     C*
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98            ON-98
     C                     ELSE
     C                     MOVE '0'       *IN98            0FF-98
     C                     END
     C*                                                                   091522
     C** Check if Portfolio Management is ON using access object.         091522
     C*                                                                   091522
     C                     CALL 'AOMMODR0'                                091522
     C                     PARM '*DBERR ' @RTCD                           091522
     C                     PARM '*FIRST ' @OPTN                           091522
     C           SDMMOD    PARM SDMMOD    DSFDY                           091522
     C*                                                                   091522
     C** If Portfolio Management is ON, access Portfolio Management       091522
     C** ICD.                                                             091522
     C*                                                                   091522
     C           BGPFMG    IFEQ 'Y'                                       091522
     C*                                                                   091522
     C                     CALL 'AOPORTR0'                                091522
     C                     PARM '*DBERR ' @RTCD                           091522
     C                     PARM '*FIRST ' @OPTN                           091522
     C           SDPORT    PARM SDPORT    DSFDY                           091522
     C*                                                                   091522
     C                     END                                            091522
     C*                                                                   S01464
     C**Access*File*SCICDPPD*-*Safe*Custody*ICD*File.                     S01464
     C* Access File SDSCFEPD - Safe Custody ICD File.                     S01464
     C*                                                                   S01464
     C***********          READ SCICDPPD                 40               S01464
     C                     CALL 'AOSCFER0'                                S01464
     C                     PARM '*DBERR ' @RTCD   7                       S01464
     C                     PARM '*FIRST ' @OPTN   7                       S01464
     C           SDSCFE    PARM SDSCFE    DSSDY                           S01464
     C*                                                                   S01464
     C**If*Record*not*found*or*deleted*-*Database*Error.                  S01464
     C***********                                                         S01464
     C************IN40     IFEQ '1'                                       S01464
     C***********          Z-ADD2         DBASE                           S01464
     C***********          MOVE *BLANKS   DBFILE                          S01464
     C***********          MOVEL'SCICDPPD'DBFILE           ***************S01464
     C***********          MOVE *BLANKS   DBKEY            ***************S01464
     C***********          MOVE '1'       *INU7                           S01464
     C***********          MOVE '1'       *INU8                           S01464
     C***********          MOVE '1'       *INLR                           S01464
     C***********          RETRN                                          S01464
     C***********          END                                            S01464
     C*
     C***********          MOVE SABCGC    S1FCUR                          S01464
     C                     MOVE FBBCGC    S1FCUR                          S01464
     C***********                                                         S01464
     C**Access*File*SDPORTPD*-*Portfolio*Management*File.                 S01464
     C***********                                                         S01464
     C***********          READ SDPORTPD                 41               S01464
     C***********                                                         S01464
     C**If*Record*not*found*or*deleted*-*Database*Error.                  S01464
     C***********                                                         S01464
     C************IN41     IFEQ '1'                                       S01464
     C***********          Z-ADD3         DBASE                           S01464
     C***********          MOVE *BLANKS   DBFILE           ***************S01464
     C***********          MOVEL'SDPORTPD'DBFILE           * DBERROR 003 *S01464
     C***********          MOVE *BLANKS   DBKEY            ***************S01464
     C***********          MOVE '1'       *INU7                           S01464
     C***********          MOVE '1'       *INU8                           S01464
     C***********          MOVE '1'       *INLR                           S01464
     C***********          RETRN                                          S01464
     C***********          END                                            S01464
     C*                                                                   S01464
     C* If Fees Per Customer positions Indicator equals 'P' then
     C* output Portfolio Headings and details and Review from field
     C* else suppress all the above.
     C*
     C***********SACFCP    IFEQ 'P'                                       S01464
     C           FBCFCP    IFEQ 'P'                                       S01464
     C                     SETOF                     58
     C                     ELSE
     C                     SETON                     58
     C                     END
     C*
     C* If Automatic posting indicator = 'Y' only display 'D' on          S01464
     C* action column heading.                                            S01464
     C*                                                                   S01464
     C***********SAAUPI    IFEQ 'Y'                                       S01464
     C           FBAUPI    IFEQ 'Y'                                       S01464
     C                     SETOF                     38
     C                     ELSE
     C                     SETON                     38
     C                     END
     C*                                                                   S01464
     C** In the data area RUNDAT                                          S01464
     C*                                                                   S01464
     C           *NAMVAR   DEFN RUNDAT    RUNDT                           S01464
     C                     IN   RUNDT                                     S01464
     C*                                                                   S01464
     C**   Read in ZMUSER                                                 S01464
     C*                                                                   S01464
     C           *NAMVAR   DEFN           ZMUSER                          S01464
     C                     IN   ZMUSER                                    S01464
     C*                                                                   S01464
     C** Test for multibranching                                          S01464
     C*                                                                   S01464
     C           MBIN      IFEQ 'Y'                                       S01464
     C                     MOVE '1'       *IN50                           S01464
     C                     ELSE                                           S01464
     C                     MOVE '0'       *IN50                           S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** SET UP CURRENCY DECIMAL PLACES FROM BANK CHARGING CCY            S01464
     C*                                                                   S01464
     C           FBBCGC    CHAINSDCURRL0             80                   S01464
     C*                                                                   S01464
     C           *IN80     IFEQ '0'                                       S01464
     C                     Z-ADDA6NBDP    WWNBDP  10                      S01464
     C                     END                                            S01464
     C*
     C* Set up Work Station ID and Date for screen.
     C*
     C                     MOVE BJMRDT    S1DATE
     C                     MOVE DDWID     S1WSID
     C*
     C**   SET UP COMMITMENT TEXT
     C*
     C                     MOVEL'SE'      MDID
     C                     MOVEL'SE6050'  PGMN
     C                     MOVELDDWID     WSIDX
     C                     MOVELUSER      USIDX
     C*
     C                     MOVE *BLANKS   S1CUST
     C                     MOVE *BLANKS   S1PORT
     C                     MOVE *BLANKS   S1BRCH                          S01464
     C*
     C* Initialize screen message queue.
     C*
     C                     MOVEL'*'       DDPGMQ
     C                     SETON                     26
     C*                                                                   S01464
     C**   ACCESS SECURITIES TRADING ICD.                                 S01464
     C*                                                                   S01464
     C                     CALL 'AOSTRDR0'                                S01464
     C                     PARM '*DBERR ' @RTCD   7                       S01464
     C                     PARM '*FIRST ' @OPTN   7                       S01464
     C           SDSTRD    PARM SDSTRD    DSSDY                           S01464
     C*                                                                   S01464
     C**   CHECK IF SAFE CUSTODY FEES IS NOT SET ON                       S01464
     C*                                                                   S01464
     C           BVCUIN    IFNE 'Y'                                       S01464
     C*                                                                   S01464
     C**   SEND MESSAGE TO SCREEN                                         S01464
     C*                                                                   S01464
     C                     MOVEL'SE02100' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     EXFMTSE6050C4                                  S01464
     C                     MOVE '1'       *INLR                           S01464
     C                     RETRN                                          S01464
      *                                                                   S01464
     C                     END                                            S01464
     C*
     C/COPY WNCPYSRC,SE6050C001
     C                     ENDSR
     C*
     C********************************************************************
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #B        - INITIALISATION OF SUBFILE                           *
     C*                                                                  *
     C*  CALLS     - NONE                                                *
     C*                                                                  *
     C*  CALLED BY - MAINLINE                                            *
     C*                                                                  *
     C********************************************************************
     C*
     C           #B        BEGSR
     C*
     C* Set of Subfile Next Change and Subfile End indicators.
     C*
     C                     SETOF                     3536
     C*
     C* Set on subfile display indicators.
     C*
     C                     SETON                     3234
     C*
     C* Set of Protect indicators and error indicator.
     C*
     C                     SETOF                     636477
     C                     SETON                     68
     C*
     C* Enable CMD 9.
     C*
     C                     SETON                     42
     C                     SETOF                     43
     C*
     C* Display correct footings.
     C*
     C                     SETON                     61
     C                     SETOF                     606267
     C* Clear Subfile.
     C                     SETON                     31
     C                     WRITESE6050C2
     C                     SETOF                     31
     C*
     C* Define and initialize relative record numbers.
     C*
     C                     Z-ADD*ZEROS    S1RRN
     C                     Z-ADD*ZEROS    WKFRRN  30       First RRN
     C                     Z-ADD*ZEROS    WKLRRN  30       Last RRN
     C*                                                                   S01464
     C** Check if authorise to default branch                             S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                                       S01464
     C*                                                                   S01464
     C           S1BRCH    IFEQ *BLANKS                                   S01464
     C                     MOVE USRBCH    S1BRCH                          S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C                     CALL 'ZVACTBU'                                 S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM S1BRCH    @BRNCH  3                       S01464
     C                     PARM           @ERR    10                      S01464
     C*                                                                   S01464
     C                     ELSE                                           S01464
     C                     CALL 'ZVACTU'                                  S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** If action invalid for user                                       S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C           @ERR      OREQ 2                                         S01464
     C                     MOVEL'1'       WKEROR                          S01464
     C                     MOVEL'1'       WWEROR  1                       S01464
     C                     MOVE '1'       *IN51                           S01464
     C                     MOVEL'SE05024' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     END                                            S01464
     C*
     C                     ENDSR
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #YA       - LOAD PAGE OF SUBFILE4                               *
     C*                                                                  *
     C*  CALLS     - #YAA                                                *
     C*                                                                  *
     C*  CALLED BY - MAINLINE                                            *
     C*                                                                  *
     C********************************************************************
     C*
     C           #YA       BEGSR
     C*
     C* Initialize Counter.
     C*
     C***********          Z-ADD1         WCOUNT  20                      S01464
     C                     Z-ADD0         WCOUNT  20                      S01464
     C                     MOVE *BLANKS   WKPTFR                          091522
     C*
     C* Read First/Next 'non-deleted' Record from File SEOCFSXX.
     C*
     C*                                                                   S01464
     C***********S1BRCH    IFNE *BLANKS                            S01464 091522
     C***********S1CUST    ANDEQ*BLANKS                            S01464 091522
     C************IN27     ANDEQ'0'                                S01464 091522
     C***********          Z-ADD0         WKLRRN                   S01464 091522
     C***********          Z-ADD0         S1RRN                    S01464 091522
     C***********S1RRN     ADD  1         WKFRRN                   S01464 091522
     C***********          MOVE S1BRCH    WKBRCA                   S01464 091522
     C***********          MOVE *LOVAL    WKCNUM                   S01464 091522
     C***********          MOVE *LOVAL    WKPTFR                   S01464 091522
     C***********FAXKEY    SETLLSEOCFSXX                           S01464 091522
     C***********          READ SEOCFSXX                 71        S01464 091522
     C***********          END                                     S01464 091522
     C*                                                                   S01464
     C           S1CUST    IFNE *BLANKS                    B1
     C***********S1BRCH    ANDEQ*BLANKS                            S01464 091522
     C           S1PORT    ANDEQ*BLANKS
     C           *IN27     ANDEQ'0'
     C                     Z-ADD0         WKLRRN
     C                     Z-ADD0         S1RRN
     C           S1RRN     ADD  1         WKFRRN
     C*
     C** MOVE CUSTOMER NUMBER FORM SCREEN OR FROM LF/SDCUSTL6 INTO KEY
     C                     MOVE S1CUST    WWCHK4  4
     C           WWCHK4    IFEQ *BLANKS                    B2
     C                     MOVELS1CUST    WKCNUM
     C                     ELSE                            X2
     C                     MOVE BBCUST    WKCNUM
     C                     END                             E2
     C                     MOVEL*LOVAL    WKPTFR
     C***********          MOVE *LOVAL    WKBRCA                   S01464 091522
     C*
     C***********FAXKEY    SETLLSCOCFSXX                                  S01464
     C           FAXKEY    SETLLSEOCFSXX                                  S01464
     C***********          READ SCOCFSXX                 71               S01464
     C                     READ SEOCFSXX                 71               S01464
     C*
     C***********          END                             E1             091522
     C                     ELSE                                           091522
     C*
     C           S1CUST    IFNE *BLANKS                    B1             S01464
     C***********S1BRCH    ANDNE*BLANKS                            S01464 091522
     C***********S1PORT    ANDNE*BLANKS                                   S01464
     C           S1PORT    ANDNE*BLANKS                                   091522
     C           *IN27     ANDEQ'0'                                       S01464
     C                     Z-ADD0         WKLRRN                          S01464
     C                     Z-ADD0         S1RRN                           S01464
     C           S1RRN     ADD  1         WKFRRN                          S01464
     C*                                                                   S01464
     C** MOVE CUSTOMER NUMBER FORM SCREEN OR FROM LF/SDCUSTL6 INTO KEY    S01464
     C                     MOVE S1CUST    WWCHK4  4                       S01464
     C           WWCHK4    IFEQ *BLANKS                    B2             S01464
     C                     MOVELS1CUST    WKCNUM                          S01464
     C                     ELSE                            X2             S01464
     C                     MOVE BBCUST    WKCNUM                          S01464
     C                     END                             E2             S01464
     C***********          MOVE S1BRCH    WKBRCA                   S01464 091522
     C*                                                                   S01464
     C***********S1PORT    IFEQ P9R997                     B2             S01464
     C***********          MOVE '9997'    WKPTFR                          S01464
     C***********          END                             E2             S01464
     C***********                                                         S01464
     C***********S1PORT    IFEQ P9R999                     B2             S01464
     C***********          MOVE '9999'    WKPTFR                          S01464
     C***********          END                             E2             S01464
     C***********                                                         S01464
     C***********S1PORT    IFEQ *BLANKS                    B2             S01464
     C***********          MOVE *LOVAL    WKPTFR                   S01464 091522
     C***********          END                             E2             S01464
     C***********                                                         S01464
     C***********S1PORT    IFNE P9R997                     B2             S01464
     C***********S1PORT    ANDNEP9R999                                    S01464
     C***********S1PORT    ANDNE*BLANKS                                   S01464
     C***********          MOVE S1PORT    WKPTFR                          S01464
     C***********          END                             E2             S01464
     C*                                                                   091522
     C           S1PORT    IFEQ FCR997                     B2             091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9997'    WKPTFR                          091522
     C                     END                             E2             091522
     C*                                                                   091522
     C           S1PORT    IFEQ FCR999                     B2             091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9999'    WKPTFR                          091522
     C                     END                             E2             091522
     C*                                                                   091522
     C           S1PORT    IFEQ *BLANKS                    B2             091522
     C                     MOVE *LOVAL    WKPTFR                          091522
     C                     END                             E2             091522
     C*                                                                   091522
     C           S1PORT    IFNE FCR997                     B2             091522
     C           S1PORT    ANDNEFCR999                                    091522
     C           S1PORT    ANDNE*BLANKS                                   091522
     C           S1PORT    OREQ FCR997                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C           S1PORT    OREQ FCR999                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C                     MOVE S1PORT    WKPTFR                          091522
     C                     END                             E2             091522
     C*                                                                   S01464
     C***********FAXKEY    SETLLSCOCFSXX                                  S01464
     C           FAXKEY    SETLLSEOCFSXX                                  S01464
     C***********          READ SCOCFSXX                 71               S01464
     C                     READ SEOCFSXX                 71               S01464
     C*                                                                   S01464
     C***********          END                             E1      S01464 091522
     C                     ELSE                                           091522
     C*
     C***********S1CUST    IFEQ *BLANKS                    B1             091522
     C***********S1PORT    ANDEQ*BLANKS                                   091522
     C***********S1BRCH    ANDEQ*BLANKS                            S01464 091522
     C*                                                                   091522
     C           S1BRCH    IFNE WKBRCH                                    091522
     C           *IN27     ANDEQ'0'
     C           WKCUST    ORNE WKCNUM                                    091522
     C           *IN27     ANDEQ'0'                                       091522
     C                     MOVE *BLANKS   WKCNUM                          091928
     C                     Z-ADD0         WKLRRN
     C                     Z-ADD0         S1RRN
     C           S1RRN     ADD  1         WKFRRN
     C*
     C***********          MOVE *LOVAL    WKCNUM                                              CSD027
     C                     MOVE *BLANKS   WKCNUM                                              CSD027
     C                     MOVE *LOVAL    WKPTFR
     C*
     C***********FAXKEY    SETLLSCOCFSXX                                  S01464
     C           FAXKEY    SETLLSEOCFSXX                                  S01464
     C***********          READ SCOCFSXX                 71               S01464
     C                     READ SEOCFSXX                 71               S01464
     C*                                                                   091522
     C                     ELSE                                           091522
     C                     Z-ADDWKLRRN    S1RRN                           091522
     C           S1RRN     ADD  1         WKFRRN                          091522
     C                     READ SEOCFSXX                 71               091522
     C                     END                                            091522
     C*                                                                   091522
     C                     END                                            091522
     C*
     C                     END                             E1
     C*
     C* Blank out Review from fields.
     C*
     C                     MOVE *BLANKS   S1CUST
     C                     MOVE *BLANKS   S1PORT
     C*
     C** ROLLUP WAS PRESSED
     C*
     C* Set of reverse Image indicators.
     C*
     C           *IN27     IFEQ '1'                        B1
     C                     SETOF                     818289
     C                     SETOF                     858687
     C                     SETOF                     52                   S01464
     C*
     C                     Z-ADDWKLRRN    S1RRN
     C           S1RRN     ADD  1         WKFRRN
     C*
     C* This line not reinststed as otherwise every 8th record is not     049067
     C* displayed on the screen.                                          049067
     C**                   READ SCOCFSXX                 71               R0192
     C*
     C                     END                             E1
     C*
     C* Write records to subfile until page is full or there are no
     C* more records on file.
     C*
     C           WWEROR    IFNE '1'                                       S01464
     C           *IN71     DOWEQ'0'
     C***********WCOUNT    ANDLE7                                         096749
     C***********WCOUNT    ANDLT7                                  096749 174057
     C*
     C**Do*not*show*the*deleted*customer*************************** R0192 049067
     C* Show the deleted customer                                         049067
     C*                                                                   R0192
     C***********SERECI    IFNE '*'                                 R0192 049067
     C***********SEBRCA    ANDEQS1BRCH                              S01464049607
      *
     C           SEBRCA    IFEQ S1BRCH                                    049067
      *                                                                   R0192
     C                     SETOF                     36
     C                     ADD  1         S1RRN
     C*
     C* Move values from file to screen fields.
     C*
     C                     EXSR #YAA
     C*
     C* Write record to subfile.
     C*
     C                     WRITESE6050S1
     C***********          ADD  1         WCOUNT                    R0192 049067
     C                     END                                            R0192
     C*
     C* Read next 'non-deleted' Record from File SEOCFSXX.
     C*
     C***********          READ SCOCFSXX                 71               S01464
     C                     READ SEOCFSXX                 71               S01464
     C*
     C************         ADD  1         WCOUNT                          R0192
     C                     ADD  1         WCOUNT                          049067
     C                     END
     C                     END                                            S01464
     C*
     C           *IN71     IFEQ '1'
     C                     SETON                     35
     C                     ELSE                                           096749
     C                     SETOF                     35                   096749
     C                     END
     C*
     C* Store RRN's.
     C                     Z-ADDS1RRN     WKLRRN
     C                     Z-ADDWKFRRN    S1RRN
     C*
     C**   IF NO RECORDS WRITTEN TO SUBFILE
     C*
     C           WKLRRN    IFEQ 0
     C                     MOVEL'SE03018' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       WKEROR
     C                     MOVE '0'       *IN32
     C                     ELSE
     C                     MOVE '1'       *IN32
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #YAA      - SETUP SUBFILE RECORD                                *
     C*                                                                  *
     C*  CALLS     - NONE                                                *
     C*                                                                  *
     C*  CALLED BY - #YA                                                 *
     C*                                                                  *
     C********************************************************************
     C*
     C           #YAA      BEGSR
     C*
     C* Move values to screen fields.
     C*
     C                     SETOF                     36
     C*
     C* Initially move 'N' to hidden subfile field 'S1UPDT' (i.e.) We
     C* do not want to update file unless record changed and valid.
     C*
     C                     MOVE 'N'       S1UPDT
     C                     MOVE *BLANKS   S1ACTN
     C*
     C* If record is deleted set status field to 'D'.
     C*
     C           SERECI    IFEQ '*'
     C                     MOVE 'D'       S1STAT
     C                     SETON                     64
     C*
     C                     ELSE
     C                     SETOF                     64
     C*
     C* If record is authorized set status field to 'X'.
     C*
     C           SEAUIN    IFEQ 'Y'
     C                     MOVE 'X'       S1STAT
     C*******    SAAUPI    IFEQ 'N'
     C*******              SETON                     64
     C*******              END
     C                     ELSE
     C                     MOVE *BLANKS   S1STAT
     C                     END
     C*
     C                     END
     C*
     C* Customer.
     C                     MOVE SECNUM    S1CUSS
     C**Folio.                                                            S01464
     C***********SACFCP    IFEQ 'C'                                       S01464
     C***********          MOVE *BLANKS   S1FOLI                          091522
     C***********                                                         S01464
     C***********          ELSE                                           S01464
     C***********SEPTFR    IFEQ '9997'                                    S01464
     C***********          MOVE P9R997    S1FOLI                          S01464
     C***********                                                         S01464
     C***********          ELSE                                           S01464
     C***********SEPTFR    IFEQ '9999'                                    S01464
     C***********          MOVE P9R999    S1FOLI                          S01464
     C***********                                                         S01464
     C***********          ELSE                                           S01464
     C***********          MOVE SEPTFR    S1FOLI                          S01464
     C***********          END                                            S01464
     C***********          END                                            S01464
     C***********          END                                            S01464
     C*                                                                   091522
     C** Folio.                                                           091522
     C*                                                                   091522
     C           FBCFCP    IFEQ 'C'                                       091522
     C                     MOVE *BLANKS   S1FOLI                          091522
     C*                                                                   091522
     C                     ELSE                                           091522
     C           SEPTFR    IFEQ '9997'                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE FCR997    S1FOLI                          091522
     C*                                                                   091522
     C                     ELSE                                           091522
     C           SEPTFR    IFEQ '9999'                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE FCR999    S1FOLI                          091522
     C*                                                                   091522
     C                     ELSE                                           091522
     C                     MOVE SEPTFR    S1FOLI                          091522
     C                     END                                            091522
     C                     END                                            091522
     C                     END                                            091522
     C*
     C* Initialize ZSEDIT Parameters.
     C*
     C***********          Z-ADDSABCGD    ZDECS                           S01464
     C           SECSCY    IFNE *BLANKS                                   S01464
     C*                                                                   S01464
     C           SECSCY    CHAINSDCURRL0             80                   S01464
     C*                                                                   S01464
     C           *IN80     IFEQ '0'                                       S01464
     C                     Z-ADDA6NBDP    ZDECS                           S01464
     C                     ELSE                                           S01464
     C                     Z-ADDWWNBDP    ZDECS                           S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C                     ELSE                                           S01464
     C                     Z-ADDWWNBDP    ZDECS                           S01464
     C                     END                                            S01464
     C                     MOVE 'L'       ZECODE
     C*
     C* Edit Fee Accrued to Date.
     C*
     C                     Z-ADDSECFAC    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15 15
     C                     MOVELWWFL15    S1ACRU
     C*
     C* Actual Fee.
     C*
     C                     Z-ADDSEAFTS    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15
     C                     MOVELWWFL15    S1ACTF
     C                     MOVELWWFL15    S1HACT
     C*
     C* Currency.
     C                     MOVE SECSCY    S1CURR
     C*                                                                   S01464
     C* If multi-branch environment, display settle branch                S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                                       S01464
     C                     MOVE SECUSB    S1BRCA                          S01464
     C                     END                                            S01464
     C* Settle Account.
     C                     MOVE SECUSA    S1ACCV
     C* Settle Value Date.
     C                     MOVE SESEVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     S1CDTE
     C*
     C* Store values in hidden fields.
     C*
     C                     MOVE SECSCY    S1HCCY
     C                     MOVE SECUSA    S1HACC
     C                     MOVE S1CDTE    S1HDAT
     C                     MOVE S1BRCA    S1HBRC                          S01464
     C                     MOVE SECUSB    S1HCUS
     C                     MOVE SETNLU    S1HTRN
     C*
     C                     MOVE 'N'       S1UPDT
     C*
     C* Convert projected Settlement Amount to Settlement Currency.
     C*
     C           SECSCY    IFNE *BLANKS
     C                     Z-ADDSEAFTS    ZAMTF
     C***********          MOVE SABCGC    ZCCYF                           S01464
     C                     MOVE FBBCGC    ZCCYF                           S01464
     C                     MOVE SECSCY    ZCCYT
     C                     MOVE BJCYCD    ZCCYB
     C******************** EXSR ZCCYKK                                    48200
     C/COPY WNCPYSRC,SE6050C002
     C                     EXSR ZCCYGB                                    48200
     C/COPY WNCPYSRC,SE6050C003
     C*
     C                     Z-ADDZSCYDP    ZDECS
     C                     Z-ADDZAMTT     ZFLD15
     C                     ELSE
     C***********          Z-ADDSABCGD    ZDECS                           S01464
     C                     Z-ADDWWNBDP    ZDECS                           S01464
     C                     Z-ADD0         ZFLD15
     C                     END
     C*
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15
     C*
     C* Move Value to screen field.
     C*
     C                     MOVELWWFL15    S1SETA
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #C        - VALIDATION OF SCREENS                               *
     C*                                                                  *
     C*  CALLS     - #CA #CB                                             *
     C*                                                                  *
     C*  CALLED BY - MAINLINE                                            *
     C*                                                                  *
     C********************************************************************
     C           #C        BEGSR
     C*
     C* If Insert screen - validate it.
     C*
     C           *IN45     IFEQ '1'                        B1
     C*
     C           WKINSA    IFEQ 'Y'                        B2
     C*
     C* Amend Mode.
     C           WKFSRN    IFEQ 'Y'                        B3
     C                     EXSR #CC
     C                     ELSE                            X3
     C                     EXSR #CD
     C                     END                             E3
     C*
     C                     ELSE                            X2
     C* Insert Mode.
     C                     EXSR #CE
     C                     END                             E2
     C*
     C                     ELSE                            X1
     C*
     C* If Confirm Screen then execute subroutine '#CA' else Subfile
     C* screen so validate it by executing subroutine '#CB'.
     C*
     C           WKFSRN    IFEQ 'Y'                        B2
     C                     EXSR #CA
     C                     ELSE                            X2
     C                     EXSR #CB
     C                     END                             E2
     C*
     C                     END                             E1
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #CA       - VALIDATION OF CONFIRM SCREEN                        *
     C*                                                                  *
     C*  CALLS     - #E #F #YA                                           *
     C*                                                                  *
     C*  CALLED BY - #C                                                  *
     C*                                                                  *
     C********************************************************************
     C           #CA       BEGSR
     C*
     C* Clear screen message queue.
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C* Set of error indicators.
     C*
     C                     SETOF                     887765
     C                     MOVE *BLANKS   WKEROR
     C*
     C* Only validate Confirm field.
     C*
     C           S1CNFM    IFNE 'Y'
     C           S1CNFM    ANDNE'N'
     C***                  MOVEL'SE04007' ZAMSID                          S01355
     C                     MOVEL'SE05009' ZAMSID                          S01355
     C                     EXSR ZASNMS
     C                     SETON                     8877
     C                     MOVE '1'       WKEROR
     C                     ELSE
     C*
     C* Re-set Subfile End indicator.
     C*
     C           WKSEND    IFEQ 'Y'
     C                     SETON                     35
     C                     ELSE
     C                     SETOF                     35
     C                     END
     C*
     C* Confirm field Valid.
     C*
     C           S1CNFM    IFEQ 'Y'
     C*
     C* Process Update.
     C                     EXSR #E
     C*
     C* If update successful and Review from fields not blank then
     C* clear Subfile and re-load subfile from those values on.
     C*
     C           *IN65     IFEQ '0'
     C*
     C           WKIN09    IFEQ 'N'
     C*
     C           S1CUST    IFNE *BLANKS
     C           S1BRCH    ORNE *BLANKS                                   S01464
     C*
     C* Clear Subfile.
     C                     SETON                     31
     C                     WRITESE6050C2
     C                     SETOF                     31
     C                     SETOF                     6364
     C                     SETON                     68
     C*                                                                   S01464
     C           S1BRCH    IFEQ *BLANKS                                   S01464
     C                     MOVE USRBCH    S1BRCH                          S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** Check if authorise to default branch                             S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                                       S01464
     C                     CALL 'ZVACTBU'                                 S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM S1BRCH    @BRNCH  3                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     MOVE *BLANKS   WWEROR                          S01464
     C*                                                                   S01464
     C                     ELSE                                           S01464
     C                     CALL 'ZVACTU'                                  S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** If action invalid for user                                       S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C           @ERR      OREQ 2                                         S01464
     C                     MOVEL'1'       WWEROR                          S01464
     C                     MOVEL'1'       WKEROR                          S01464
     C                     MOVE '1'       *IN51                           S01464
     C                     MOVEL'SE05024' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     END                                            S01464
     C*
     C                     EXSR #YA
     C                     Z-ADD1         S1RRN
     C                     MOVE *BLANKS   S1CUST
     C                     MOVE *BLANKS   S1PORT
     C                     MOVE 'N'       WKFSRN
     C*
     C                     ELSE
     C                     EXSR #F
     C                     MOVE 'N'       WKFSRN
     C                     END
     C*
     C* Enable CMD 9.
     C                     SETON                     42
     C*
     C* Display Correct footings.
     C*
     C                     SETON                     61
     C                     SETOF                     606267
     C*
     C                     ELSE
     C*
     C           WKIN09    IFEQ 'Y'
     C*
     C* Insert Screen next.
     C                     SETON                     45
     C                     MOVE 'N'       WKFSRN
     C                     END
     C                     END
     C*
     C                     ELSE
     C*
     C                     EXSR #F
     C* Enable CMD 9.
     C                     SETON                     42
     C*
     C* Display Correct footings.
     C*
     C                     SETON                     61
     C                     SETOF                     606267
     C*
     C                     Z-ADDWKFRRN    S1RRN
     C                     END
     C*
     C                     ELSE
     C*
     C* Prepare to output original unprotected subfile again.
     C*
     C                     EXSR #F
     C*
     C* Enable CMD 9.
     C                     SETON                     42
     C*
     C* Display Correct footings.
     C*
     C                     SETON                     61
     C                     SETOF                     606267
     C                     MOVE 'N'       WKFSRN
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #CB       - VALIDATION OF SUBFILE SCREEN                        *
     C*                                                                  *
     C*  CALLS     - #YA                                                 *
     C*                                                                  *
     C*  CALLED BY - #C                                                  *
     C*                                                                  *
     C********************************************************************
     C           #CB       BEGSR
     C*
     C* Clear screen message queue.
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C* Set of error indicators.
     C*
     C                     SETOF                     838466
     C                     SETOF                     51                   S01464
     C                     SETOF                     7977
     C                     MOVE *BLANKS   WKEROR
     C*
     C* Store 'CMD 9 or ENTER taken' in workfield.
     C*
     C           *IN09     IFEQ '1'                        B1
     C                     MOVE 'Y'       WKIN09  1
     C                     ELSE                            X1
     C                     MOVE 'N'       WKIN09
     C                     END                             E1
     C*
     C* IF NO RECORDS ON SUBFILE - DO NOT VALIDATE
     C*
     C           WKLRRN    IFGT 0                          B1
     C*
     C* Read First Changed Record on Subfile.
     C*
     C                     READCSE6050S1                 75
     C*
     C           *IN75     DOWEQ'0'                        B2
     C*
     C* Set off Reverse Image indicators.
     C*
     C***********          SETOF                     8182                 S01464
     C                     SETOF                     818252               S01464
     C                     SETOF                     868789
     C*
     C* Set off SFLNXTCHG and general error indicator (for this record)
     C*
     C                     SETOF                     3678
     C*
     C* Validate fields.
     C                     EXSR #CBA
     C*
     C           *IN78     IFEQ '0'                        B3
     C*
     C* Save Relative Record number of first changed record so that
     C* correct confirm screen will be displayed.
     C*
     C           *IN79     IFEQ '0'                        B4
     C                     Z-ADDS1RRN     WKSRRN  30
     C                     SETON                     79
     C                     END                             E4
     C                     END                             E3
     C*
     C                     UPDATSE6050S1
     C*
     C                     READCSE6050S1                 75
     C                     END                             E2
     C*
     C* If Errors in Subfile, Re-Display screen with messages, at
     C* first field in error.
     C*
     C           *IN77     IFEQ '1'                        B2
     C                     Z-ADDWKFRRN    S1RRN
     C                     MOVE '1'       WKEROR
     C                     END                             E2
     C*
     C                     END                             E1
     C* If not Insert.
     C*
     C           WKINSA    IFNE 'Y'                        B1
     C*
     C* Validate review from fields.
     C*
     C                     EXSR #CBB
     C*
     C* If a record has changed and there are no errors on screen
     C* then set flag to ensure Confirm screen is displayed.
     C*
     C           *IN77     IFEQ '0'                        B2
     C           *IN66     IFEQ '1'                        B3
     C                     MOVE 'Y'       WKLDCF
     C                     SETOF                     66
     C*
     C                     ELSE                            X3
     C*                                                                   091522
     C** Set up customer number field.                                    091522
     C*                                                                   091522
     C           WWCHK4    IFEQ *BLANKS                                   091522
     C**********           MOVELS1CUST    WKCUST  60                                   091522 CSD027
     C                     MOVELS1CUST    WKCUST  6                                           CSD027
     C                     ELSE                                           091522
     C                     MOVELBBCUST    WKCUST                          091522
     C                     END                                            091522
     C*                                                                   091522
     C* Re-build Subfile if review from fields not blank and no
     C* changed records.
     C*
     C           WKIN09    IFEQ 'N'                        B4
     C           S1CUST    ANDNE*BLANKS
     C           WKIN09    OREQ 'N'                                      S01464
     C           S1BRCH    ANDNE*BLANKS
     C           WKIN09    OREQ 'N'                                       091522
     C           WKCUST    ANDNEWKCNUM                                    091522
     C*
     C* Clear Subfile before re-building.
     C*
     C                     SETON                     31
     C                     WRITESE6050C2
     C                     SETOF                     31
     C*                                                                   S01464
     C           S1BRCH    IFEQ *BLANKS                                   S01464
     C                     MOVE USRBCH    S1BRCH                          S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** Check if authorise to default branch                             S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                                       S01464
     C                     CALL 'ZVACTBU'                                 S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM S1BRCH    @BRNCH  3                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     MOVE *BLANKS   WWEROR                          S01464
     C*                                                                   S01464
     C                     ELSE                                           S01464
     C                     CALL 'ZVACTU'                                  S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** If action invalid for user                                       S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C           @ERR      OREQ 2                                         S01464
     C                     MOVEL'1'       WWEROR                          S01464
     C                     MOVEL'1'       WKEROR                          S01464
     C                     MOVE '1'       *IN51                           S01464
     C                     MOVEL'SE05024' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     END                                            S01464
     C                     EXSR #YA
     C*
     C                     ELSE                            X4
     C*
     C           WKIN09    IFEQ 'Y'                        B5
     C                     SETON                     45
     C                     END                             E5
     C*
     C                     END                             E4
     C                     END                             E3
     C                     END                             E2
     C*
     C* Set off SFLNXTCHG and Error Indicator.
     C*
     C                     SETOF                     3677
     C                     END                             E1
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #CF       - VALIDATION OF SUBFILE SCREEN - INSERT MODE          *
     C*                                                                  *
     C*  CALLS     - #YA                                                 *
     C*                                                                  *
     C*  CALLED BY - #C                                                  *
     C*                                                                  *
     C********************************************************************
     C           #CF       BEGSR
     C*
     C* Clear screen message queue.
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C* Set of error indicators.
     C*
     C                     SETOF                     838466
     C                     SETOF                     51                   S01464
     C                     SETOF                     7977
     C                     MOVE *BLANKS   WKEROR
     C                     Z-ADD1         S1RRN
     C*
     C* Store 'CMD 9 or ENTER taken' in workfield.
     C*
     C           *IN09     IFEQ '1'
     C                     MOVE 'Y'       WKIN09  1
     C                     ELSE
     C                     MOVE 'N'       WKIN09
     C                     END
     C*
     C* IF NO RECORDS ON SUBFILE - DO NOT VALIDATE
     C*
     C           WKLRRN    IFGT 0
     C*
     C* Read First Changed Record on Subfile.
     C*
     C           S1RRN     CHAINSE6050S1             75
     C*
     C           *IN75     DOWEQ'0'
     C*
     C* Set off Reverse Image indicators.
     C*
     C***********          SETOF                     8182                 S01464
     C                     SETOF                     818252
     C                     SETOF                     868789
     C*
     C* Set off SFLNXTCHG and general error indicator (for this record)
     C*
     C                     SETOF                     3678
     C*
     C* Validate fields.
     C                     EXSR #CBA
     C*
     C           *IN78     IFEQ '0'
     C*
     C* Save Relative Record number of first changed record so that
     C* correct confirm screen will be displayed.
     C*
     C           *IN79     IFEQ '0'
     C                     Z-ADDS1RRN     WKSRRN  30
     C                     SETON                     79
     C                     END
     C                     END
     C*
     C                     UPDATSE6050S1
     C*
     C                     ADD  1         S1RRN
     C           S1RRN     CHAINSE6050S1             75
     C                     END
     C*
     C* If Errors in Subfile, Re-Display screen with messages, at
     C* first field in error.
     C*
     C           *IN77     IFEQ '1'
     C                     Z-ADDWKFRRN    S1RRN
     C                     MOVE '1'       WKEROR
     C                     ELSE
     C                     Z-ADD1         S1RRN
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #CBA      - VALIDATE FIELDS                                     *
     C*                                                                  *
     C*  CALLS     - NONE                                                *
     C*                                                                  *
     C*  CALLED BY - #CB                                                 *
     C*                                                                  *
     C********************************************************************
     C           #CBA      BEGSR
     C*                                                                  *
     C********************************************************************
     C**   VALIDATE ACTION CODE                                          *
     C********************************************************************
     C*
     C           S1ACTN    IFNE *BLANKS                    B1
     C*
     C* Action Code must be 'D' if FBAUPI = 'Y' else it must be 'X'
     C* or 'D' if FBAUPI = 'N'.
     C*
     C***********SAAUPI    IFEQ 'Y'                        B2             S01464
     C           FBAUPI    IFEQ 'Y'                        B2             S01464
     C           S1ACTN    IFNE 'D'                        B3
     C*
     C* ACTION entered is invalid.
     C*
     C                     MOVEL'SE05004' ZAMSID
     C                     EXSR ZASNMS
     C*
     C* If first error save RRN to position Subfile at first field in
     C* error.
     C*
     C           *IN77     IFEQ '0'                        B4
     C                     Z-ADDS1RRN     WKFRRN
     C                     END                             E4
     C*
     C                     SETON                     817736
     C                     SETON                     78
     C*
     C                     END                             E3
     C*
     C                     ELSE                            X2
     C*
     C           S1ACTN    IFNE 'D'                        B3
     C           S1ACTN    ANDNE'X'
     C*
     C* ACTION entered is invalid.
     C*
     C                     MOVEL'SE05003' ZAMSID
     C                     EXSR ZASNMS
     C*
     C* If first error save RRN to position Subfile at first field in
     C* error.
     C*
     C           *IN77     IFEQ '0'                        B4
     C                     Z-ADDS1RRN     WKFRRN
     C                     END                             E4
     C*
     C                     SETON                     817736
     C                     SETON                     78
     C*
     C                     END                             E3
     C                     END                             E2
     C*                                                                   S01464
     C** Check if authorise to action code                                S01464
     C*                                                                   S01464
     C           *IN81     IFEQ '0'
     C           *IN50     IFNE '1'                                       S01464
     C                     CALL 'ZVACTU'                                  S01464
     C                     PARM S1ACTN    @ZACTN  1                       S01464
     C                     PARM           @ERR    10                      S01464
     C*                                                                   S01464
     C** If action invalid for user                                       S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C                     MOVEL'SEM1019' ZAMSID                          S01464
     C                     MOVE '1'       WKEROR
     C                     EXSR ZASNMS                                    S01464
     C           *IN77     IFEQ '0'
     C                     Z-ADDS1RRN     WKFRRN
     C                     END
     C                     SETON                     817736
     C                     SETON                     78
     C                     END                                            S01464
     C*                                                                   S01464
     C                     ELSE                                           S01464
     C*                                                                   S01464
     C           S1BRCH    IFEQ *BLANKS                                   S01464
     C                     MOVE USRBCH    S1BRCH                          S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C                     CALL 'ZVACTBU'                                 S01464
     C                     PARM S1ACTN    @ZACTN  1                       S01464
     C                     PARM S1BRCH    @BRNCH  3                       S01464
     C                     PARM           @ERR    10                      S01464
     C*                                                                   S01464
     C** If action invalid for user (multientity)                         S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C                     MOVEL'SEM1020' ZAMSID                          S01464
     C                     MOVE '1'       WKEROR
     C                     MOVE '1'       *IN51                           S01464
     C                     EXSR ZASNMS                                    S01464
     C           *IN77     IFEQ '0'
     C                     Z-ADDS1RRN     WKFRRN
     C                     END
     C                     SETON                     817736
     C                     SETON                     78
     C                     END                                            S01464
     C*                                                                   S01464
     C** If action invalid for user for branch                            S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 2                                         S01464
     C                     MOVEL'SEM1021' ZAMSID                          S01464
     C                     MOVE '1'       WKEROR
     C                     MOVE '1'       *IN51                           S01464
     C                     EXSR ZASNMS                                    S01464
     C           *IN77     IFEQ '0'
     C                     Z-ADDS1RRN     WKFRRN
     C                     END
     C                     SETON                     817736
     C                     SETON                     78
     C                     END                                            S01464
     C                     END                                            S01464
     C                     END                                            S01464
     C                     END                             E1
     C*                                                                  *
     C********************************************************************
     C**   VALIDATE ACTUAL FEE                                           *
     C********************************************************************
     C*
     C                     MOVE 'N'       WWSTLV  1
     C*
     C* Call ZALIGN to validate amount.
     C*
     C***********          Z-ADDSABCGD    ZADEC                           S01464
     C                     Z-ADDWWNBDP    ZADEC                           S01464
     C                     Z-ADD0         ZADIG
     C***********13        SUB  SABCGD    ZADIG                           S01464
     C           13        SUB  WWNBDP    ZADIG                           S01464
     C                     MOVE '0'       *IN99
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE S1ACTF    ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    S1HACF
     C*
     C           *IN99     IFEQ '1'
     C*
     C* Amount entered is invalid.
     C*
     C                     MOVEL'SE05005' ZAMSID
     C                     EXSR ZASNMS
     C*
     C* If first error save RRN to position Subfile at first field in
     C* error.
     C*
     C           *IN77     IFEQ '0'
     C                     Z-ADDS1RRN     WKFRRN
     C                     END
     C*
     C                     SETON                     827736
     C                     SETON                     78
     C*
     C                     ELSE
     C*
     C**   Valid amount, call ZSEDIT to redisplay
     C*
     C                     MOVE 'Y'       WWSTLV
     C                     MOVE ZFIELD    WWSTLA 150
     C                     MOVE ZFIELD    ZFLD15
     C***********          Z-ADDSABCGD    ZDECS                           S01464
     C                     Z-ADDWWNBDP    ZDECS                           S01464
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15
     C                     MOVELWWFL15    S1ACTF
     C*
     C                     END
     C*                                                                  *
     C********************************************************************
     C**   VALIDATE SETTLEMENT CURRENCY                                  *
     C********************************************************************
     C*
     C* Settlement Currency must be a valid currency.
     C*
     C           WWSTLV    IFEQ 'Y'                        B1
     C           WWSTLA    ANDEQ0
     C           S1CURR    ANDEQ*BLANKS
     C                     GOTO VLCCY
     C                     ELSE                            X1
     C*                                                                   092108
     C** If retail account number is used as settlement account and       092108
     C** settlement ccy not entered, use retail account ccy.              092108
     C*                                                                   092108
     C           WKACC2    IFNE *BLANKS                                   092108
     C           S1CURR    ORNE *BLANKS                                   092108
     C*
     C* Settlement Currency must be a valid currency.
     C*
     C***********S1CURR    CHAINSDCURRJ0             76                   S01464
     C                     CALL 'AOCURRR0'                                S01464
     C                     PARM '*BLANKS' @RTCD   7                       S01464
     C                     PARM '*KEY   ' @OPTN   7                       S01464
     C                     PARM S1CURR    @AJCD   3                       S01464
     C           SDCURR    PARM SDCURR    DSSDY                           S01464
     C************IN76     IFEQ '1'                                       S01464
     C           @RTCD     IFNE *BLANKS                                   S01464
     C           @RTCD     ANDNE'*NOSEL '                                 S01464
     C*
     C                     MOVEL'SE05006' ZAMSID
     C                     EXSR ZASNMS
     C*
     C* If first error save RRN to position Subfile at first field in
     C* error.
     C*
     C           *IN77     IFEQ '0'
     C                     Z-ADDS1RRN     WKFRRN
     C                     END
     C*
     C                     SETON                     867736
     C                     SETON                     78
     C                     ELSE                                           S01464
     C*                                                                   S01464
     C                     MOVE A6CYCD    S1CURR                          S01464
     C           @RTCD     IFEQ '*NOSEL '                                 S01464
     C                     MOVE *BLANKS   S1CURR                          S01464
     C                     END                                            S01464
     C                     END                                            S01464
     C                     END                                            092108
     C                     END
     C*
     C           VLCCY     TAG
     C*
     C**   IF ACTUAL FEE AND CURRENCY WERE VALID, RECALCULATE SETTLEMENT
     C**   AMOUNT
     C*
     C           *IN82     IFEQ '0'
     C           *IN86     ANDEQ'0'
     C*
     C* Convert projected Settlement Amount to Settlement Currency.
     C*
     C           S1CURR    IFNE *BLANKS
     C                     MOVE S1HACF    ZAMTF
     C***********          MOVE SABCGC    ZCCYF                           S01464
     C                     MOVE FBBCGC    ZCCYF                           S01464
     C                     MOVE S1CURR    ZCCYT
     C                     MOVE BJCYCD    ZCCYB
     C******************** EXSR ZCCYKK                                    48200
     C/COPY WNCPYSRC,SE6050C004
     C                     EXSR ZCCYGB                                    48200
     C/COPY WNCPYSRC,SE6050C005
     C*
     C                     Z-ADDZSCYDP    ZDECS
     C                     Z-ADDZAMTT     ZFLD15
     C                     ELSE
     C***********          Z-ADDSABCGD    ZDECS                           S01464
     C                     Z-ADDWWNBDP    ZDECS                           S01464
     C                     Z-ADD0         ZFLD15
     C                     END
     C*
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15
     C*
     C* Move Value to screen field.
     C*
     C                     MOVELWWFL15    S1SETA
     C                     END
     C*                                                                  *
     C********************************************************************
     C**   VALIDATE SETTLEMENT ACCOUNT                                   *
     C********************************************************************
     C*
     C** DO NOT VALIDATE SETTLEMENT ACCOUNT IF ACTION CODE OF 'D'
     C           S1ACTN    IFEQ 'D'
     C                     GOTO VLACC
     C                     END
     C*
     C           WWSTLV    IFEQ 'Y'                        B1
     C           WWSTLA    ANDEQ0
     C           S1ACCV    ANDEQ*BLANKS
     C                     GOTO VLACC
     C                     ELSE                            X1
     C*
     C* Settlement Account must be a valid account for this customer.
     C*
     C           WKACC2    IFEQ *BLANKS
     C*
     C* Call ZALIGN to validate account code (check numeric)
     C*
     C                     Z-ADD0         ZADEC
     C                     Z-ADD10        ZADIG
     C                     MOVE '0'       *IN99
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE WKACC1    ZFIELD
     C                     EXSR ZALIGN
     C*
     C           *IN99     IFEQ '0'
     C                     MOVE ZFIELD    ACNO
     C           ACNO      CHAINACNUM                47
     C                     END
     C*
     C           *IN47     IFEQ '1'
     C           RECI      OREQ '*'
     C           *IN99     OREQ '1'
     C*
     C                     MOVEL'SE05007' ZAMSID
     C                     EXSR ZASNMS
     C*
     C* If first error save RRN to position Subfile at first field in
     C* error.
     C*
     C           *IN77     IFEQ '0'
     C                     Z-ADDS1RRN     WKFRRN
     C                     END
     C*
     C                     SETON                     877736
     C                     SETON                     78
     C                     END
     C*                                                                   092108
     C** Check that the currency code of the retail account matches       092108
     C** the settlement ccy entered on screen.  If the screen value       092108
     C** is blank, use the ccy from the retail account.                   092108
     C*                                                                   092108
     C           *IN87     IFEQ '0'                                       092108
     C*                                                                   092108
     C           S1CURR    IFEQ *BLANKS                                   092108
     C                     MOVE CCY       S1CURR                          092108
     C                     ELSE                                           092108
     C*                                                                   092108
     C           S1CURR    IFNE CCY                                       092108
     C*                                                                   092108
     C                     MOVEL'SE05025' ZAMSID                          092108
     C                     EXSR ZASNMS                                    092108
     C*                                                                   092108
     C** If first error save RRN to position Subfile at first field in    092108
     C** error.                                                           092108
     C*                                                                   092108
     C           *IN77     IFEQ '0'                                       092108
     C                     Z-ADDS1RRN     WKFRRN                          092108
     C                     END                                            092108
     C*                                                                   092108
     C                     SETON                     877736               092108
     C                     SETON                     7886                 092108
     C                     END                                            092108
     C*                                                                   092108
     C                     END                                            092108
     C*                                                                   092108
     C                     END                                            092108
     C*
     C                     ELSE
     C*
     C* Call ZALIGN to validate account code (check numeric)
     C*
     C                     Z-ADD0         ZADEC
     C                     Z-ADD12        ZADIG
     C                     MOVE '0'       *IN99
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE S1ACCV    ZFIELD
     C                     EXSR ZALIGN
     C*
     C           *IN99     IFEQ '0'
     C           ACNTKY    CHAINACCNT                48
     C                     END
     C*
     C           *IN48     IFEQ '1'
     C           RECI      OREQ '*'
     C           *IN99     OREQ '1'
     C*
     C****                 MOVEL'SE05007' ZAMSID                          S01355
     C                     MOVEL'SE05019' ZAMSID                          S01355
     C                     EXSR ZASNMS
     C*
     C* If first error save RRN to position Subfile at first field in
     C* error.
     C*
     C           *IN77     IFEQ '0'
     C                     Z-ADDS1RRN     WKFRRN
     C                     END
     C*
     C                     SETON                     877736
     C                     SETON                     78
     C                     END
     C*
     C                     END
     C*
     C                     END
     C*
     C           VLACC     TAG
     C********************************************************************
     C**   VALIDATE ACTION CODE FURTHER                                  *
     C********************************************************************
     C*
     C** IF ACTION CODE OF 'D' ENTERED NO DETAILS MAY HAVE CHANGED
     C           S1ACTN    IFEQ 'D'                        B1
     C*
     C           S1ACTF    IFNE S1HACT                     B2
     C           S1CURR    ORNE S1HCCY
     C           S1ACCV    ORNE S1HACC
     C           S1CDTE    ORNE S1HDAT
     C           S1BRCA    ORNE S1HBRC                                    S01464
     C           *IN50     ANDEQ'1'                                       S01464
     C                     MOVEL'SE05017' ZAMSID
     C                     EXSR ZASNMS
     C*
     C* If first error save RRN to position Subfile at first field in
     C* error.
     C*
     C           *IN77     IFEQ '0'                        B3
     C                     Z-ADDS1RRN     WKFRRN
     C                     END                             E3
     C*
     C                     SETON                     817736
     C                     SETON                     78
     C*
     C                     END                             E2
     C*
     C                     END                             E1
     C*                                                                   S01464
     C********************************************************************S01464
     C**   VALIDATE SETTLEMENT BRANCH                                    *S01464
     C********************************************************************S01464
     C*                                                                   S01464
     C*                                                                   S01464
     C* Entry is mandatory unless account entered is a retail account     S01464
     C*                                                                   S01464
     C* This is done only for multi-branch environment                    S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                        B1             S01464
     C***********S1ACTN    ANDEQ*BLANKS                            S01464 092108
     C           S1BRCA    IFNE *BLANKS                    B2             S01464
     C**********           CALL 'AOBRCHR0'                                S01464              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*BLANKS' @RTCD   7                       S01464
     C                     PARM '*KEY   ' @OPTN   7                       S01464
     C                     PARM S1BRCA    @DSNB   3                       S01464
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01464              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01464
     C           @RTCD     IFNE *BLANKS                    B3             S01464
     C           @RTCD     ANDNE'*NOSEL '                                 S01464
     C                     MOVEL'SE05020' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C*                                                                   S01464
     C* If first error save RRN to position Subfile at first field in     S01464
     C* error.                                                            S01464
     C*                                                                   S01464
     C           *IN77     IFEQ '0'                        B4             S01464
     C                     Z-ADDS1RRN     WKFRRN                          S01464
     C                     END                             E4             S01464
     C                     SETON                     527736               S01464
     C                     SETON                     78                   S01464
     C                     MOVE '1'       WKEROR                          S01464
     C*                                                                   S01464
     C                     ELSE                            X3             S01464
     C                     MOVE A8BRCD    S1BRCA                          S01464
     C           @RTCD     IFEQ '*NOSEL '                  B4             S01464
     C                     MOVE *BLANKS   S1BRCA                          S01464
     C                     END                             E4             S01464
     C                     END                             E3             S01464
     C                     END                             E2             S01464
     C*                                                                   S01464
     C           S1BRCA    IFEQ *BLANKS                    B2             S01464
     C           WKACC2    ANDNE*BLANKS                                   092108
     C***********ATYP      ANDNE'R'                                S01464 092108
     C                     MOVEL'SE05021' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C*                                                                   S01464
     C* If first error save RRN to position Subfile at first field in     S01464
     C* error.                                                            S01464
     C*                                                                   S01464
     C           *IN77     IFEQ '0'                        B3             S01464
     C                     Z-ADDS1RRN     WKFRRN                          S01464
     C                     END                             E3             S01464
     C                     SETON                     527736               S01464
     C                     SETON                     78                   S01464
     C                     MOVE '1'       WKEROR                          S01464
     C                     END                             E2             S01464
     C*                                                                   S01464
     C           S1BRCA    IFNE *BLANKS                    B2             S01464
     C           @RTCD     ANDEQ*BLANKS                                   S01464
     C           WKACC2    ANDNE*BLANKS                                   092108
     C           ACNTK2    CHAINACCNT                48                   S01464
     C*                                                                   S01464
     C           *IN48     IFEQ '1'                        B3             S01464
     C           RECI      OREQ '*'                                       S01464
     C                     MOVEL'SE05022' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C*                                                                   S01464
     C* If first error save RRN to position Subfile at first field in     S01464
     C* error.                                                            S01464
     C*                                                                   S01464
     C           *IN77     IFEQ '0'                        B4             S01464
     C                     Z-ADDS1RRN     WKFRRN                          S01464
     C                     END                             E4             S01464
     C                     SETON                     527736               S01464
     C                     SETON                     788687               S01464
     C                     END                             E3             S01464
     C                     END                             E2             S01464
     C*                                                                   092108
     C** Check that the branch code of the retail account matches         092108
     C** the settlement branch entered on screen.  If the screen value    092108
     C** is blank, use the branch field from the retail account.          092108
     C*                                                                   092108
     C           WKACC2    IFEQ *BLANKS                                   092108
     C           *IN52     ANDEQ'0'                                       092108
     C*                                                                   092108
     C           S1BRCA    IFEQ *BLANKS                                   092108
     C                     MOVE BRCA      S1BRCA                          092108
     C                     ELSE                                           092108
     C*                                                                   092108
     C           S1BRCA    IFNE BRCA                                      092108
     C*                                                                   092108
     C                     MOVEL'SE05026' ZAMSID                          092108
     C                     EXSR ZASNMS                                    092108
     C*                                                                   092108
     C** If first error save RRN to position Subfile at first field in    092108
     C** error.                                                           092108
     C*                                                                   092108
     C           *IN77     IFEQ '0'                                       092108
     C                     Z-ADDS1RRN     WKFRRN                          092108
     C                     END                                            092108
     C*                                                                   092108
     C                     SETON                     527736               092108
     C                     SETON                     7887                 092108
     C                     END                                            092108
     C*                                                                   092108
     C                     END                                            092108
     C*                                                                   092108
     C                     END                                            092108
     C*                                                                   S01464
     C                     END                             E1             S01464
     C*                                                                  *
     C********************************************************************
     C**   VALIDATE SETTLEMENT DATE                                      *
     C********************************************************************
     C*
     C*
     C* Settlement Date must be a valid date.
     C*
     C* Call ZALIGN to validate if numeric or not.
     C*
     C                     Z-ADD0         ZADEC
     C                     Z-ADD6         ZADIG
     C                     MOVE '0'       *IN99
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE S1CDTE    ZFIELD
     C                     EXSR ZALIGN
     C*
     C           *IN99     IFEQ '0'                        B2
     C                     MOVE S1CDTE    ZDATE
     C                     EXSR ZDATE1
     C                     END                             E2
     C*
     C           *IN99     IFEQ '1'                        B2
     C*
     C                     MOVEL'SE05008' ZAMSID
     C                     EXSR ZASNMS
     C*
     C* If first error save RRN to position Subfile at first field in
     C* error.
     C*
     C           *IN77     IFEQ '0'                        B3
     C                     Z-ADDS1RRN     WKFRRN
     C                     END                             E3
     C*
     C                     SETON                     897736
     C                     SETON                     78
     C                     END                             E2
     C*                                                                   049067
     C** VALIDATE UNIQUENESS OF RECORD & DATE NOT AMENDED :               049067
     C** VALIDATE WHETHER CUSTOMER/PORTFOLIO/DATE ALREADY ON SEOCFSPD     049067
     C*                                                                   049067
     C           *IN45     IFEQ '1'                        B1             049067
     C* If insert                                                         049067
     C                     MOVELWKCNUM    SECNUM                          049067
     C                     MOVELWKPTFR    SEPTFR                          049067
     C                     MOVE S1CDTE    ZDATE                           049067
     C                     EXSR ZDATE1                                    049067
     C                     Z-ADDZDAYNO    SESEVD                          049067
     C           FSPDKY    CHAINSEOCFSP0             71                   049067
     C           *IN71     IFEQ '0'                        B2             049067
     C                     MOVEL'SE05019' ZAMSID                          049067
     C                     EXSR ZASNMS                                    049067
     C*                                                                   049067
     C* If first error save RRN to position Subfile at first field in     049067
     C* error.                                                            049067
     C*                                                                   049067
     C           *IN77     IFEQ '0'                        B3             049067
     C                     Z-ADDS1RRN     WKFRRN                          049067
     C                     END                             E3             049067
     C*                                                                   049067
     C                     SETON                     897736               049067
     C                     SETON                     78                   049067
     C                     END                             E2             049067
      *                                                                   049067
     C***********          ELSE                            X1      049067 065025
     C**VALIDATE*WHETHER DATE HAS BEEN AMENDED                     049067 065025
     C***********S1CDTE    IFNE S1HDAT                     B2      049067 065025
     C***********          MOVEL'SE05018' ZAMSID                   049067 065025
     C***********          EXSR ZASNMS                             049067 065025
     C***********                                                  049067 065025
     C**If*first*error save RRN to position Subfile at first field in 049 065025
     C**error.***                                                  049067 065025
     C***********                                                  049067 065025
     C************IN77     IFEQ '0'                        B3      049067 065025
     C***********          Z-ADDS1RRN     WKFRRN                   049067 065025
     C***********          END                             E3      049067 065025
     C***********                                                  049067 065025
     C***********          SETON                     897736        049067 065025
     C***********          SETON                     78            049067 065025
     C***********          END                             E2      049067 065025
     C                     END                             E1             049067
     C*
     C           VLDAT     TAG
     C*
     C**   IF VALIDATION SUCCESSFUL
     C*
     C           *IN78     IFEQ '0'                        B1
     C*
     C**   IF NO FIELDS CHANGED
     C*
     C           S1ACTF    IFEQ S1HACT                     B2
     C           S1CURR    ANDEQS1HCCY
     C           S1ACCV    ANDEQS1HACC
     C           S1CDTE    ANDEQS1HDAT
     C           S1BRCA    ANDEQS1HBRC                                    S01464
     C                     MOVE 'N'       S1UPDT
     C                     MOVE '0'       *IN36
     C                     ELSE                            X2
     C                     MOVE 'Y'       S1UPDT
     C                     MOVE '1'       *IN36
     C                     MOVE '1'       *IN66
     C                     END                             E2
     C*
     C           S1ACTN    IFNE *BLANKS                    B2
     C                     MOVE 'Y'       S1UPDT
     C                     MOVE '1'       *IN36
     C                     MOVE '1'       *IN66
     C                     END                             E2
     C*
     C                     ELSE                            X1
     C                     MOVE 'N'       S1UPDT
     C                     MOVE '1'       *IN36
     C                     END                             E1
     C*
     C*
     C                     ENDSR
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #CBB      - VALIDATE REVIEW FROM FIELDS                         *
     C*                                                                  *
     C*  CALLS     - #CB                                                 *
     C*                                                                  *
     C*  CALLED BY - MAINLINE                                            *
     C*                                                                  *
     C********************************************************************
     C           #CBB      BEGSR
     C*
     C***********S1PORT    IFNE *BLANKS                                   S01464
     C***********S1CUST    ORNE *BLANKS                                   S01464
     C***********                                                         S01464
     C**Portfolio*may*not*be*entered*without*Customer.                    S01464
     C***********                                                         S01464
     C***********S1PORT    IFNE *BLANKS                                   S01464
     C***********S1CUST    ANDEQ*BLANKS                                   S01464
     C***********                                                         S01464
     C***********          MOVEL'SE05001' ZAMSID                          S01464
     C***********          EXSR ZASNMS                                    S01464
     C***********          MOVE '1'       WKEROR                          S01464
     C***********          SETON                     8477                 S01464
     C***********                                                         S01464
     C***********          ELSE                                           S01464
     C*                                                                   091522
     C           S1PORT    IFNE *BLANKS                                   091522
     C           S1CUST    ORNE *BLANKS                                   091522
     C*                                                                   091522
     C** Portfolio may not be entered without Customer.                   091522
     C*                                                                   091522
     C           S1PORT    IFNE *BLANKS                                   091522
     C           S1CUST    ANDEQ*BLANKS                                   091522
     C*                                                                   091522
     C                     MOVEL'SE05001' ZAMSID                          091522
     C                     EXSR ZASNMS                                    091522
     C                     MOVE '1'       WKEROR                          091522
     C                     SETON                     8477                 091522
     C*                                                                   091522
     C                     ELSE                                           091522
     C*
     C* A valid customer number or Shortname must be entered.
     C***********                                                         S01464
     C**Call*ZALIGN*to*validate*CUSTOMER                                  S01464
     C***********                                                         S01464
     C***********          MOVE '0'       *IN99                           S01464
     C***********WKCUSB    IFEQ *BLANKS                                   S01464
     C***********          Z-ADD0         ZADEC                           S01464
     C***********          Z-ADD6         ZADIG                           S01464
     C***********          MOVE *BLANKS   ZFIELD                          S01464
     C***********          MOVE WKCUSA    ZFIELD                          S01464
     C***********          EXSR ZALIGN                                    S01464
     C***********          END                                            S01464
     C***********                                                         S01464
     C************IN99     IFEQ '1'                                       S01464
     C***********WKCUSB    ORNE *BLANKS                                   S01464
     C***********                                                         S01464
     C***********S1CUST    CHAINSDCUSTL6             74                   S01464
     C           S1CUST    IFNE *BLANKS                                   S01464
     C                     CALL 'AOCUSTR0'                                S01464
     C                     PARM *BLANKS   @RTCD   7                       S01464
     C                     PARM '*KEY   ' @OPTN   7                       S01464
     C                     PARM S1CUST    @KEY1  10                       S01464
     C                     PARM *BLANKS   @KYST   7                       S01464
     C           SDCUST    PARM SDCUST    DSSDY                           S01464
     C*                                                                   S01464
     C************IN74     IFEQ '1'                                       S01464
     C           @RTCD     IFNE *BLANKS                                   S01464
     C           @RTCD     ANDNE'*NOSEL '                                 S01464
     C           @KYST     OREQ 'ERROR  '                                 S01464
     C                     MOVEL'SE05002' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     8377
     C                     MOVE '1'       WKEROR
     C                     ELSE                                           S01464
     C                     MOVELBBCUST    S1CUST                          S01464
     C           @RTCD     IFEQ '*NOSEL '                                 S01464
     C                     MOVE *BLANKS   S1CUST                          S01464
     C                     END                                            S01464
     C                     END                                            S01464
     C                     END
     C*                                                                   S01464
     C** Validate Branch of Customer                                      S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                        B1             S01464
     C           S1BRCH    IFNE *BLANKS                    B2             S01464
     C**********           CALL 'AOBRCHR0'                                S01464              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*BLANKS' @RTCD   7                       S01464
     C                     PARM '*KEY   ' @OPTN   7                       S01464
     C                     PARM S1BRCH    @DSNB   3                       S01464
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01464              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01464
     C           @RTCD     IFNE *BLANKS                    B3             S01464
     C           @RTCD     ANDNE'*NOSEL '                                 S01464
     C                     MOVEL'SE05020' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     SETON                     5177                 S01464
     C                     MOVE '1'       WKEROR                          S01464
     C*                                                                   S01464
     C                     ELSE                            X3             S01464
     C                     MOVE A8BRCD    S1BRCH                          S01464
     C           @RTCD     IFEQ '*NOSEL '                  B4             S01464
     C                     MOVE *BLANKS   S1BRCH                          S01464
     C                     END                             E4             S01464
     C                     END                             E3             S01464
     C*                                                                   S01464
     C                     ELSE                            X2             S01464
     C                     MOVE USRBCH    S1BRCH                          S01464
     C                     END                             E2             S01464
     C                     END                             E1             S01464
     C*
     C***********          END
     C***********          END                                            S01464
     C***********          END                                            S01464
     C                     END                                            091522
     C                     END                                            091522
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #D        - DISPLAY CONFIRM SCREEN                              *
     C*                                                                  *
     C*  CALLS     - #YB                                                 *
     C*                                                                  *
     C*  CALLED BY - MAINLINE                                            *
     C*                                                                  *
     C********************************************************************
     C           #D        BEGSR
     C*
     C* Clear screen message queue.
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C* Display protected screen with option to Confirm.
     C*
     C                     SETOF                     68
     C                     Z-ADD1         S1RRN
     C*
     C* Display Correct Footings.
     C*
     C                     SETON                     60
     C                     SETOF                     616267
     C*
     C* Disable CMD 9 and CMD 12.
     C*
     C                     SETOF                     4243
     C*
     C* Protect fields.
     C                     SETON                     63
     C*
     C* Save Subfile End indicator to previous value.
     C*
     C           *IN35     IFEQ '1'
     C                     MOVE 'Y'       WKSEND  1
     C                     ELSE
     C                     MOVE 'N'       WKSEND
     C                     END
     C*
     C* Read First Record on Subfile.
     C*
     C           S1RRN     CHAINSE6050S1             75
     C*
     C           *IN75     DOWEQ'0'
     C*
     C* Reverse Image any changed records to alert user that they
     C* are going to be update in file.
     C*
     C           S1UPDT    IFEQ 'Y'
     C                     SETON                     49
     C                     ELSE
     C                     SETOF                     49
     C                     END
     C*
     C* Protect fields.
     C                     SETON                     64
     C*
     C                     UPDATSE6050S1
     C*
     C                     ADD  1         S1RRN
     C           S1RRN     CHAINSE6050S1             75
     C                     END
     C*
     C           *IN45     IFEQ '1'
     C                     Z-ADD1         S1RRN
     C                     ELSE
     C                     Z-ADDWKSRRN    S1RRN
     C                     END
     C*
     C                     MOVE 'Y'       WKFSRN
     C                     MOVE 'N'       WKLDCF
     C                     SETOF                     49
     C                     SETON                     35
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #G        - DISPLAY INSERT SCREEN - Insert Mode                 *
     C*                                                                  *
     C*  CALLS     - #YB                                                 *
     C*                                                                  *
     C*  CALLED BY - MAINLINE                                            *
     C*                                                                  *
     C********************************************************************
     C           #G        BEGSR
     C*
     C           *IN28     IFEQ '0'
     C*
     C* Clear screen message queue.
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C                     ELSE
     C                     SETOF                     28
     C                     END
     C*
     C* Clear Subfile.
     C                     SETON                     31
     C                     WRITESE6050C2
     C                     SETOF                     31
     C*
     C                     MOVE 'N'       WKFSRN
     C                     MOVE 'N'       WKLDCF
     C*
     C* Allow customer and portfolio fields to be input capable.
     C*
     C***********          SETOF                     6358
     C                     SETOF                     63                   S01464
     C*
     C* Set on 'non-display of subfile header fields' indicator.
     C*
     C                     SETON                     46
     C*
     C* Don't display confirm.
     C*
     C                     SETON                     68
     C*
     C* Not Amend Mode Yet.
     C*
     C                     MOVE 'N'       WKINSA
     C*
     C* Enable CMD 9, and not CMD 12.
     C*
     C                     SETON                     42
     C                     SETOF                     43
     C*
     C                     MOVE *BLANKS   S1CUST
     C                     MOVE *BLANKS   S1PORT
     C                     MOVE *BLANKS   S1BRCH                          S01464
     C*
     C* Display correct footings.
     C*
     C                     SETON                     62
     C                     SETOF                     606167
     C*
     C* Don't display subfile.
     C*
     C                     SETOF                     32
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #F        - RE-DISPLAY UN-PROTECTED SUBFILE                     *
     C*                                                                  *
     C*  CALLS     - NONE                                                *
     C*                                                                  *
     C*  CALLED BY - #CA                                                 *
     C*                                                                  *
     C********************************************************************
     C           #F        BEGSR
     C*
     C* Prepare Display of un-protected screen without Confirm option.
     C*
     C                     SETON                     68
     C                     Z-ADD1         S1RRN
     C                     MOVE *BLANKS   S1CNFM
     C*
     C           *IN45     IFEQ '0'
     C                     SETOF                     63
     C                     END
     C*
     C* DONT ACCESS SUBFILE IF EMPTY.
     C*
     C           WKLRRN    IFGT 0
     C*
     C* Read First Record on Subfile.
     C*
     C           S1RRN     CHAINSE6050S1             75
     C*
     C           *IN75     DOWEQ'0'
     C*
     C           S1UPDT    IFEQ 'Y'
     C                     SETON                     36
     C                     ELSE
     C                     SETOF                     36
     C                     END
     C*
     C* Un-Protect fields.
     C****       S1STAT    IFEQ *BLANKS
     C****                 SETOF                     64
     C****                 ELSE
     C****                 SETON                     64
     C****                 END
     C*
     C           S1STAT    IFEQ 'D'
     C                     SETON                     64
     C                     ELSE
     C                     SETOF                     64
     C                     END
     C*
     C                     UPDATSE6050S1
     C*
     C                     ADD  1         S1RRN
     C           S1RRN     CHAINSE6050S1             75
     C                     END
     C*
     C                     Z-ADD1         S1RRN
     C                     SETOF                     64
     C*
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #CE       - VALIDATE INSERT SCREEN -Insert Mode                 *
     C*                                                                  *
     C*  CALLS     -                                                     *
     C*                                                                  *
     C*  CALLED BY -                                                     *
     C*                                                                  *
     C********************************************************************
     C           #CE       BEGSR
     C*
     C* Clear screen message queue.
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C                     SETOF                     778384
     C                     SETOF                     51                   S01464
     C                     MOVE *BLANKS   WKEROR
     C                     MOVE 'N'       WKSNER  1
     C*
     C* A Safe Custody Fees customer number or shortname must be
     C* entered.
     C           S1CUST    IFNE *BLANKS                                   S01464
     C                     CALL 'AOCUSTR0'                                S01464
     C                     PARM *BLANKS   @RTCD   7                       S01464
     C                     PARM '*KEY   ' @OPTN   7                       S01464
     C                     PARM S1CUST    @KEY1  10                       S01464
     C                     PARM *BLANKS   @KYST   7                       S01464
     C           SDCUST    PARM SDCUST    DSSDY                           S01464
     C*                                                                   S01464
     C           @RTCD     IFNE *BLANKS                                   S01464
     C           @RTCD     ANDNE'*NOSEL '                                 S01464
     C           @KYST     OREQ 'ERROR  '                                 S01464
     C                     MOVE 'Y'       WKSNER                          S01464
     C                     ELSE                                           S01464
     C                     MOVELBBCUST    S1CUST                          S01464
     C           @RTCD     IFEQ '*NOSEL '                                 S01464
     C                     MOVE *BLANKS   S1CUST                          S01464
     C                     END                                            S01464
     C                     END                                            S01464
     C***********                                                         S01464
     C**Call*ZALIGN*to*validate*amount.                                   S01464
     C***********                                                         S01464
     C***********          MOVE '0'       *IN99                           S01464
     C***********WKCUSB    IFEQ *BLANKS                    B1             S01464
     C***********          Z-ADD0         ZADEC                           S01464
     C***********          Z-ADD6         ZADIG                           S01464
     C***********          MOVE *BLANKS   ZFIELD                          S01464
     C***********          MOVE WKCUSA    ZFIELD                          S01464
     C***********          EXSR ZALIGN                                    S01464
     C***********          END                             E1             S01464
     C***********                                                         S01464
     C**VALUE*entered*is*NUMERIC                                          S01464
     C***********                                                         S01464
     C************IN99     IFEQ '0'                        B1             S01464
     C***********WKCUSB    ANDEQ*BLANKS                                   S01464
     C***********                                                         S01464
     C**First*check*for*SC*Fee*Customer*('BFSBJF must = 'Y').             S01464
     C***********                                                         S01464
     C************IN09     IFEQ '0'                        B2             S01464
     C***********WKCUSA    CHAINSDSECSL1             37                   S01464
     C***********                                                         S01464
     C************IN37     IFEQ '0'                        B3             S01464
     C***********WKCUSA    CHAINSDCUSTL5             74                   S01464
     C***********          MOVE BFCFGC    WWCFGC  2                 48202 S01464
     C***********          END                             E3             S01464
     C***********                                                         S01464
     C************IN74     IFEQ '1'                        B3             S01464
     C************IN37     OREQ '1'                                       S01464
     C***********BFSBJF    ORNE 'Y'                                       S01464
     C***********BBDTDL    ORNE *ZEROS                                    S01464
     C***********BBDTDL    ANDLEBJRDNB                                    S01464
     C***********                                                         S01464
     C***********          MOVEL'SE05011' ZAMSID                          S01464
     C***********          EXSR ZASNMS                                    S01464
     C***********          SETON                     8377                 S01464
     C***********          MOVE '1'       WKEROR                          S01464
     C***********          END                             E3             S01464
     C***********          END                             E2             S01464
     C***********                                                         S01464
     C***********          ELSE                            X1             S01464
     C***********                                                         S01464
     C***********S1CUST    CHAINSDCUSTL6             74                   S01464
     C***********                                                         S01464
     C************IN74     IFEQ '1'                                       S01464
     C***********          MOVE 'Y'       WKSNER                          S01464
     C***********          END                                            S01464
     C*                                                                   S01464
     C* First check for SC Fee Customer ('BFSBJF must = 'Y').
     C*
     C************IN74     IFEQ '0'                        B2             S01464
     C           @RTCD     IFEQ *BLANKS                                   S01464
     C           BBCUST    CHAINSDSECSL1             37
     C*
     C           *IN37     IFEQ '0'                        B3             48202
     C                     MOVE BFCFGC    WWCFGC  2                       48202
     C                     END                             E3             48202
     C*
     C                     END                             E2
     C*
     C************IN74     IFEQ '1'                        B2             S01464
     C           @RTCD     IFNE *BLANKS                                   S01464
     C           @RTCD     ANDNE'*NOSEL '                                 S01464
     C           *IN37     OREQ '1'
     C           BFSBJF    ORNE 'Y'
     C           BBDTDL    ORNE *ZEROS
     C           BBDTDL    ANDLEBJRDNB
     C                     MOVEL'SE05011' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     8377
     C                     MOVE '1'       WKEROR
     C                     END                             E2
     C*
     C                     END                             E1
     C*                                                                   S01464
     C** Validate Branch of Customer                                      S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                        B1             S01464
     C           S1BRCH    IFNE *BLANKS                    B2             S01464
     C**********           CALL 'AOBRCHR0'                                S01464              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM '*BLANKS' @RTCD   7                       S01464
     C                     PARM '*KEY   ' @OPTN   7                       S01464
     C                     PARM S1BRCH    @DSNB   3                       S01464
     C********** SDBRCH    PARM SDBRCH    DSFDY                           S01464              CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
     C*                                                                   S01464
     C           @RTCD     IFNE *BLANKS                    B3             S01464
     C           @RTCD     ANDNE'*NOSEL '                                 S01464
     C                     MOVEL'SE05020' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     SETON                     5177                 S01464
     C                     MOVE '1'       WKEROR                          S01464
     C*                                                                   S01464
     C                     ELSE                            X3             S01464
     C                     MOVE A8BRCD    S1BRCH                          S01464
     C           @RTCD     IFEQ '*NOSEL '                  B4             S01464
     C                     MOVE *BLANKS   S1BRCH                          S01464
     C                     END                             E4             S01464
     C                     END                             E3             S01464
     C*                                                                   S01464
     C           S1BRCH    IFNE BBBRCD                                    S01464
     C                     MOVEL'SE05023' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     SETON                     5177                 S01464
     C                     MOVE '1'       WKEROR                          S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C                     ELSE                            X2             S01464
     C                     MOVE BBBRCD    S1BRCH                          S01464
     C                     END                             E2             S01464
     C                     END                             E1             S01464
     C*                                                                   S01464
     C** DO SPF VALIDATION FOR BRANCH/ACTION CODE AUTHORITY               S01464
     C*                                                                   S01464
     C           *IN50     IFNE '1'                                       S01464
     C                     CALL 'ZVACTU'                                  S01464
     C                     PARM 'I'       @ZACTN  1                       S01464
     C                     PARM           @ERR    10                      S01464
     C*                                                                   S01464
     C** If action invalid for user (single entity)                       S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C                     MOVEL'SEM1019' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     SETON                     77
     C                     MOVE '1'       WKEROR
     C                     END                                            S01464
     C*                                                                   S01464
     C                     ELSE                                           S01464
     C                     CALL 'ZVACTBU'                                 S01464
     C                     PARM 'I'       @ZACTN  1                       S01464
     C                     PARM S1BRCH    @BRNCH  3                       S01464
     C                     PARM           @ERR    10                      S01464
     C*                                                                   S01464
     C** If action invalid for user (multientity)                         S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C                     MOVEL'SEM1020' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     SETON                     77
     C                     MOVE '1'       *IN51                           S01464
     C                     MOVE '1'       WKEROR
     C                     END                                            S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 2                                         S01464
     C                     MOVEL'SEM1021' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     SETON                     77
     C                     MOVE '1'       WKEROR
     C                     MOVE '1'       *IN51                           S01464
     C                     END                                            S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C***********                                                         S01464
     C**Validate*Portfolio.                                               S01464
     C***********                                                         S01464
     C***********S1PORT    IFNE *BLANKS                    B1             S01464
     C***********                                                         S01464
     C***********S1PORT    IFNE P9R997                     B2             S01464
     C***********S1PORT    ANDNEP9R999                                    S01464
     C***********S1PORT    ANDNE*BLANKS                                   S01464
     C***********                                                         S01464
     C***********          MOVE BBCUST    PNCNUM                          S01464
     C***********          MOVE S1PORT    PNPTFR                          S01464
     C*
     C****       PORTKY    CHAINPMPORTLL             71                   48202
     C***********PORTKY    CHAINPMPORTPP             71             48202 S01464
     C***********                                                         S01464
     C**Must*be*a*live*record.                                            S01464
     C***********                                                         S01464
     C************IN71     IFEQ '1'                        B3             S01464
     C***********PNRECI    OREQ '*'                                       S01464
     C****                 MOVEL'SE05011' ZAMSID                          S01355
     C***********          MOVEL'SE05018' ZAMSID                    S01355S01464
     C***********          EXSR ZASNMS                                    S01464
     C***********          SETON                     8477                 S01464
     C***********          MOVE '1'       WKEROR                          S01464
     C***********          END                             E3             S01464
     C************IN71     IFEQ '0'                        B3        48202S01464
     C***********          MOVE PNCFGC    WWCFGC  2                  48202S01464
     C***********          END                             E3        48202S01464
     C***********                                                         S01464
     C***********                                                         S01464
     C***********          END                             E2             S01464
     C***********          END                             E1             S01464
     C*                                                                   091522
     C** Validate Portfolio.                                              091522
     C*                                                                   091522
     C           S1PORT    IFNE *BLANKS                                   091522
     C*                                                                   091522
     C           S1PORT    IFNE FCR997                                    091522
     C           S1PORT    ANDNEFCR999                                    091522
     C           S1PORT    ANDNE*BLANKS                                   091522
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   091522
     C                     MOVE BBCUST    PNCNUM                          091522
     C                     MOVE S1PORT    PNPTFR                          091522
     C*                                                                   091522
     C           PORTKY    CHAINPMPORTPD             71                   091522
     C*                                                                   091522
     C* Must be a live record.                                            091522
     C*                                                                   091522
     C           *IN71     IFEQ '1'                                       091522
     C           PNRECI    OREQ '*'                                       091522
     C                     MOVEL'SE05018' ZAMSID                          091522
     C                     EXSR ZASNMS                                    091522
     C                     SETON                     8477                 091522
     C                     MOVE '1'       WKEROR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           *IN71     IFEQ '0'                                       091522
     C                     MOVE PNCFGC    WWCFGC  2                       091522
     C                     END                                            091522
     C*                                                                   091522
     C                     END                                            091522
     C*                                                                   091522
     C                     END                                            091522
     C*
     C** IF BOTH CUSTOMER AND PORTFOLIO BLANK SET OFF ERROR INDICATORS
     C** AND F9 SETOFF ERROR INDICATORS
     C           *IN09     IFEQ '1'
     C           WKSNER    ANDEQ'N'
     C                     SETOF                     838477
     C                     SETOF                     51                   S01464
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C                     END
     C*
     C** CHECK WHETHER ACCRUALS EXIST ON PF/SESCFAPD FOR CUSTOMER AND
     C** PORTFOLIO
     C           *IN77     IFEQ '0'                        B1
     C           *IN09     ANDEQ'0'                        B1
     C*
     C           S1CUST    IFNE *BLANKS                    B2
     C***********S1PORT    ANDEQ*BLANKS                                   S01464
     C           S1PORT    ANDEQ*BLANKS                                   091522
     C*
     C           WKCUSB    IFEQ *BLANKS
     C                     MOVELS1CUST    WKCNUM
     C                     MOVELS1CUST    S1CUSS
     C                     ELSE
     C                     MOVE BBCUST    WKCNUM
     C                     MOVE BBCUST    S1CUSS
     C                     END
     C*
     C                     MOVE *LOVAL    WKPTFR
     C***********          MOVE S1BRCH    WKBRCA                   S01464 091522
     C***********FAXKEY    SETLLSCSCFAXX                                  S01464
     C           FAXKEY    SETLLSESCFAXX                                  S01464
     C***********          READ SCSCFAXX                 71               S01464
     C                     READ SESCFAXX                 71               S01464
     C*
     C** IF NO RECORD FOUND FOR CUSTOMER ERROR
     C           *IN71     IFEQ '1'                        B3
     C           SDCNUM    ORNE WKCNUM
     C                     MOVEL'SE05014' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     8477
     C                     MOVE '1'       WKEROR
     C                     END                             E3
     C                     END                             E2
     C***********                                                         S01464
     C***IF*PORTFOLIO*REFERENCE*ENTERED*CHECK*THAT*EXIXTS*ON*FILE         S01464
     C***********                                                         S01464
     C***********S1CUST    IFNE *BLANKS                    B2             S01464
     C***********S1PORT    ANDNE*BLANKS                                   S01464
     C***********                                                         S01464
     C***********WKCUSB    IFEQ *BLANKS                                   S01464
     C***********          MOVELS1CUST    WKCNUM                          S01464
     C***********          MOVELS1CUST    S1CUSS                          S01464
     C***********          ELSE                                           S01464
     C***********          MOVE BBCUST    WKCNUM                          S01464
     C***********          MOVE BBCUST    S1CUSS                          S01464
     C***********          END                                            S01464
     C***********                                                         S01464
     C***********S1PORT    IFEQ P9R997                     B3             S01464
     C***********          MOVE '9997'    WKPTFR                          S01464
     C***********          END                             E3             S01464
     C***********                                                         S01464
     C***********S1PORT    IFEQ P9R999                     B3             S01464
     C***********          MOVE '9999'    WKPTFR                          S01464
     C***********          END                             E3             S01464
     C***********                                                         S01464
     C***********S1PORT    IFNE P9R997                     B3             S01464
     C***********S1PORT    ANDNEP9R999                                    S01464
     C***********S1PORT    ANDNE*BLANKS                                   S01464
     C***********          MOVE S1PORT    WKPTFR                          S01464
     C***********          END                             E3             S01464
     C***********                                                         S01464
     C***********FAXKEY    SETLLSCSCFAXX                                  S01464
     C***********          READ SCSCFAXX                 71               S01464
     C************                                                        S01464
     C***IF*NO*RECORD*FOUN*FOR*CUSTOMER*ERROR                             S01464
     C************IN71     IFEQ '1'                        B3             S01464
     C***********SDCNUM    ORNE WKCNUM                                    S01464
     C***********SDPTFR    ORNE WKPTFR                                    S01464
     C***********          MOVEL'SE05013' ZAMSID                          S01464
     C***********          EXSR ZASNMS                                    S01464
     C***********          SETON                     847783               S01464
     C***********          MOVE '1'       WKEROR                          S01464
     C***********          END                                            S01464
     C***********          END                                            S01464
     C*                                                                   091522
     C** If Portfolio Reference entered, check that it exists on file     091522
     C*                                                                   091522
     C           S1CUST    IFNE *BLANKS                                   091522
     C           S1PORT    ANDNE*BLANKS                                   091522
     C*                                                                   091522
     C           WKCUSB    IFEQ *BLANKS                                   091522
     C                     MOVELS1CUST    WKCNUM                          091522
     C                     MOVELS1CUST    S1CUSS                          091522
     C                     ELSE                                           091522
     C                     MOVE BBCUST    WKCNUM                          091522
     C                     MOVE BBCUST    S1CUSS                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1PORT    IFEQ FCR997                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9997'    WKPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1PORT    IFEQ FCR999                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9999'    WKPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1PORT    IFNE FCR997                                    091522
     C           S1PORT    ANDNEFCR999                                    091522
     C           S1PORT    ANDNE*BLANKS                                   091522
     C           S1PORT    OREQ FCR997                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C           S1PORT    OREQ FCR999                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C                     MOVE S1PORT    WKPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           FAXKEY    SETLLSESCFAXX                                  091522
     C                     READ SESCFAXX                 71               091522
     C*                                                                   091522
     C** If no record found for customer, error.                          091522
     C*                                                                   091522
     C           *IN71     IFEQ '1'                                       091522
     C           SDCNUM    ORNE WKCNUM                                    091522
     C           SDPTFR    ORNE WKPTFR                                    091522
     C                     MOVEL'SE05013' ZAMSID                          091522
     C                     EXSR ZASNMS                                    091522
     C                     SETON                     847783               091522
     C                     MOVE '1'       WKEROR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C                     END                                            091522
     C*                                                                   091522
     C                     END                             E1
     C*
     C* If CMD 9 pressed then go back to First screen
     C*
     C                     MOVE 'N'       WKINSA
     C           *IN77     IFEQ '0'                        B1
     C*
     C** SET OFF ERROR INDICATORS
     C                     SETOF                     46
     C                     MOVE 'N'       WKINER  1
     C*
     C           *IN09     IFEQ '1'                        B2
     C                     SETOF                     454609
     C                     SETOF                     818283
     C                     SETOF                     5152                 S01464
     C                     SETOF                     848687
     C                     SETOF                     89
     C                     MOVE 'N'       WKINER
     C                     EXSR #B
     C*                                                                   S01464
     C           S1BRCH    IFEQ *BLANKS                                   S01464
     C                     MOVE USRBCH    S1BRCH                          S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** Check if authorise to default branch                             S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                                       S01464
     C                     CALL 'ZVACTBU'                                 S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM S1BRCH    @BRNCH  3                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     MOVE *BLANKS   WWEROR                          S01464
     C*                                                                   S01464
     C                     ELSE                                           S01464
     C                     CALL 'ZVACTU'                                  S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** If action invalid for user                                       S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C           @ERR      OREQ 2                                         S01464
     C                     MOVEL'1'       WWEROR                          S01464
     C                     MOVEL'1'       WKEROR                          S01464
     C                     MOVE '1'       *IN51                           S01464
     C                     MOVEL'SE05024' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     END                                            S01464
     C                     EXSR #YA
     C*
     C                     ELSE                            X2
     C*
     C* Build Subfile.
     C                     SETOF                     64
     C                     EXSR #H
     C*
     C                     MOVE 'Y'       WKINSA
     C                     Z-ADD1         S1RRN
     C                     Z-ADDS1RRN     WKFRRN
     C***********          SETOF                     8384                 S01464
     C                     SETOF                     838452               S01464
     C*
     C                     END                             E2
     C*
     C* Set 'Error on Insert screen - insert mode' indicator.
     C*
     C                     ELSE                            X1
     C                     MOVE 'Y'       WKINER
     C                     END                             E1
     C*
     C           WKINSA    IFEQ 'Y'
     C*
     C* Prepare Screen for Output.
     C*
     C* Customer and portfolio fields protected.
     C*
     C                     SETON                     63
     C*
     C* Subfile not protected.
     C*
     C                     SETOF                     64
     C*
     C* Confirm non-display.
     C*
     C                     SETON                     68
     C*
     C* Enable CMD 9 and CMD 12.
     C*
     C                     SETON                     4243
     C*
     C* Display correct footings.
     C*
     C                     SETON                     67
     C                     SETOF                     606162
     C*
     C* Set on Subfile indicators.
     C*
     C                     SETON                     353234
     C*
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #CD       - VALIDATE INSERT SCREEN -Amend Mode                  *
     C*                                                                  *
     C*  CALLS     -                                                     *
     C*                                                                  *
     C*  CALLED BY -                                                     *
     C*                                                                  *
     C********************************************************************
     C           #CD       BEGSR
     C*                                                                   S01464
     C           S1BRCH    IFEQ *BLANKS                                   S01464
     C                     MOVE USRBCH    S1BRCH                          S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** Check if authorise to default branch                             S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                                       S01464
     C                     CALL 'ZVACTBU'                                 S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM S1BRCH    @BRNCH  3                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     MOVE *BLANKS   WWEROR  1                       S01464
     C*                                                                   S01464
     C                     ELSE                                           S01464
     C                     CALL 'ZVACTU'                                  S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** If action invalid for user                                       S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C           @ERR      OREQ 2                                         S01464
     C                     MOVEL'1'       WWEROR                          S01464
     C                     MOVEL'1'       WKEROR                          S01464
     C                     MOVE '1'       *IN51                           S01464
     C                     MOVEL'SE05024' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     END                                            S01464
     C*
     C* If CMD 12 then Output Insert Mode screen again i.e no subfile
     C* displayed.
     C*
     C           *IN12     IFEQ '1'
     C                     MOVE 'N'       WKINSA
     C                     SETOF                     818286
     C***********          SETOF                     8789                 S01464
     C                     SETOF                     878952               S01464
     C                     ELSE
     C*
     C           *IN09     IFEQ '1'
     C                     MOVE 'Y'       WKIN09
     C                     ELSE
     C*
     C                     MOVE 'N'       WKIN09
     C                     END
     C*  Validate Screen.
     C*
     C                     EXSR #CF
     C*
     C* If a record has changed and there are no errors on screen
     C* then set flag to ensure Confirm screen is displayed.
     C*
     C           *IN77     IFEQ '0'
     C*
     C* Prepare to output Confirm.
     C*
     C                     MOVE 'Y'       WKLDCF
     C*
     C                     SETOF                     66
     C*
     C                     END
     C*
     C* Set off SFLNXTCHG and Error Indicator.
     C*
     C                     SETOF                     77
     C*
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #CC       - VALIDATION OF CONFIRM SCREEN (Insert Mode)          *
     C*                                                                  *
     C*  CALLS     -                                                     *
     C*                                                                  *
     C*  CALLED BY - #C                                                  *
     C*                                                                  *
     C********************************************************************
     C           #CC       BEGSR
     C*
     C* Clear screen message queue.
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C* Set of error indicators.
     C*
     C                     SETOF                     887765
     C                     MOVE *BLANKS   WKEROR
     C*
     C* Only validate Confirm field.
     C*
     C           S1CNFM    IFNE 'Y'
     C           S1CNFM    ANDNE'N'
     C                     MOVEL'SE05009' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     8877
     C                     MOVE '1'       WKEROR
     C                     ELSE
     C*
     C* Confirm field Valid.
     C*
     C           S1CNFM    IFEQ 'Y'
     C*
     C* Re-set Subfile End indicator.
     C*
     C           WKSEND    IFEQ 'Y'
     C                     SETON                     35
     C                     ELSE
     C                     SETOF                     35
     C                     END
     C*
     C* Process Update.
     C                     EXSR #K
     C*
     C* If update successful and Review from fields not blank then
     C* clear Subfile and re-load subfile from those values on.
     C*
     C           *IN65     IFEQ '0'
     C*
     C           WKIN09    IFEQ 'N'
     C*
     C* Customer and portfolio fields protected.
     C*
     C                     SETON                     63
     C                     SETON                     4243
     C                     SETON                     67
     C                     SETOF                     606162
     C*
     C                     EXSR #F
     C                     MOVE 'N'       WKFSRN
     C*
     C                     ELSE
     C*
     C* Change Screen next (Amend Mode).
     C*
     C*
     C** MOVE CUSTOMER NUMBER FORM SCREEN OR FROM LF/SDCUSTL6 INTO KEY
     C                     MOVE S1CUST    WWCHK4  4
     C           WWCHK4    IFEQ *BLANKS
     C                     MOVELS1CUST    WKCNUM
     C                     ELSE
     C                     MOVE BBCUST    WKCNUM
     C                     END
     C***********          MOVE S1BRCH    WKBRCA                   S01464 091522
     C*
     C***********S1PORT    IFEQ P9R997                                    S01464
     C***********          MOVE '9997'    WKPTFR                          S01464
     C***********          END                                            S01464
     C***********                                                         S01464
     C***********S1PORT    IFEQ P9R999                                    S01464
     C***********          MOVE '9999'    WKPTFR                          S01464
     C***********          END                                            S01464
     C***********                                                         S01464
     C***********S1PORT    IFEQ *BLANKS                                   S01464
     C***********          MOVE *LOVAL    WKPTFR                   S01464 091522
     C***********          END                                            S01464
     C***********                                                         S01464
     C***********S1PORT    IFNE P9R997                                    S01464
     C***********S1PORT    ANDNEP9R999                                    S01464
     C***********S1PORT    ANDNE*BLANKS                                   S01464
     C***********          MOVE S1PORT    WKPTFR                          S01464
     C***********          END                                            S01464
     C*                                                                   091522
     C           S1PORT    IFEQ FCR997                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9997'    WKPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1PORT    IFEQ FCR999                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9999'    WKPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1PORT    IFEQ *BLANKS                                   091522
     C                     MOVE *LOVAL    WKPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1PORT    IFNE FCR997                                    091522
     C           S1PORT    ANDNEFCR999                                    091522
     C           S1PORT    ANDNE*BLANKS                                   091522
     C           S1PORT    OREQ FCR997                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C           S1PORT    OREQ FCR999                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C                     MOVE S1PORT    WKPTFR                          091522
     C                     END                                            091522
     C*
     C***********FAXKEY    SETLLSCOCFSXX                                  S01464
     C           FAXKEY    SETLLSEOCFSXX                                  S01464
     C                     SETOF                     4589
     C                     SETOF                     818283
     C                     SETOF                     5152                 S01464
     C                     SETOF                     848687
     C                     MOVE *BLANKS   S1ACTN
     C                     MOVE *BLANKS   S1CUST
     C                     MOVE *BLANKS   S1PORT
     C                     MOVE 'N'       WKFSRN
     C                     MOVE 'N'       WKINSA
     C                     EXSR #B
     C*                                                                   S01464
     C           S1BRCH    IFEQ *BLANKS                                   S01464
     C                     MOVE USRBCH    S1BRCH                          S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** Check if authorise to default branch                             S01464
     C*                                                                   S01464
     C           *IN50     IFEQ '1'                                       S01464
     C                     CALL 'ZVACTBU'                                 S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM S1BRCH    @BRNCH  3                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     MOVE *BLANKS   WWEROR  1                       S01464
     C*                                                                   S01464
     C                     ELSE                                           S01464
     C                     CALL 'ZVACTU'                                  S01464
     C                     PARM 'A'       @ZACTN  1                       S01464
     C                     PARM           @ERR    10                      S01464
     C                     END                                            S01464
     C*                                                                   S01464
     C** If action invalid for user                                       S01464
     C*                                                                   S01464
     C           @ERR      IFEQ 1                                         S01464
     C           @ERR      OREQ 2                                         S01464
     C                     MOVEL'1'       WWEROR                          S01464
     C                     MOVEL'1'       WKEROR                          S01464
     C                     MOVE '1'       *IN51                           S01464
     C                     MOVEL'SE05024' ZAMSID                          S01464
     C                     EXSR ZASNMS                                    S01464
     C                     END                                            S01464
     C                     EXSR #YA
     C*
     C                     END
     C*
     C                     ELSE
     C*
     C                     Z-ADDWKFRRN    S1RRN
     C                     END
     C*
     C                     ELSE
     C*
     C* Prepare to output original unprotected subfile again.
     C*
     C* Customer and portfolio fields protected.
     C*
     C                     SETON                     63
     C*
     C* Enable CMD 9 and CMD 12.
     C*
     C                     SETON                     4243
     C*
     C* Display correct footings.
     C*
     C                     SETON                     67
     C                     SETOF                     606162
     C*
     C                     EXSR #F
     C                     MOVE 'N'       WKFSRN
     C                     END
     C*
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #H        - LOAD SUBFILE - INSERT MODE                          *
     C*                                                                  *
     C*  CALLS     -                                                     *
     C*                                                                  *
     C*  CALLED BY -                                                     *
     C*                                                                  *
     C********************************************************************
     C*
     C           #H        BEGSR
     C*
     C* Initialize Counter.
     C                     Z-ADD0         S1RRN
     C                     Z-ADD0         WKLRRN
     C           S1RRN     ADD  1         WKFRRN
     C*
     C* Clear Subfile.
     C                     SETON                     31
     C                     WRITESE6050C2
     C                     SETOF                     31
     C*                                                                   S01464
     C*  IF SPECIFIC PORTFOLIO ENTERED FORMAT DETAILS                     S01464
     C           S1PORT    IFNE *BLANKS                    B1             S01464
     C***********                                                         S01464
     C***IF*CUSTOMER*POSITION*USED*SET*PORTFOLIO*TO*BLANK                 S01464
     C***********SACFCP    IFEQ 'C'                        B2             S01464
     C***********          MOVE *BLANKS   S1FOLI                          S01464
     C***********          ELSE                            X2             S01464
     C***********                                                         S01464
     C***SET*FOLIO*UP*CONTAINING*DETAILS*OF*REQUESTED*PORTFOLIO           S01464
     C***********                                                         S01464
     C***********SDPTFR    IFEQ '9997'                                    S01464
     C***********          MOVE P9R997    S1FOLI                          S01464
     C***********          END                                            S01464
     C***********                                                         S01464
     C***********SDPTFR    IFEQ '9999'                                    S01464
     C***********          MOVE P9R999    S1FOLI                          S01464
     C***********          END                                            S01464
     C***********                                                         S01464
     C***********SDPTFR    IFNE '9997'                                    S01464
     C***********SDPTFR    ANDNE'9999'                                    S01464
     C***********          MOVE SDPTFR    S1FOLI                          S01464
     C***********          END                                            S01464
     C***********                                                         S01464
     C***********          EXSR #I                                        S01464
     C**Write*record*to*subfile.                                          S01464
     C***********                                                         S01464
     C***********          ADD  1         S1RRN                           S01464
     C***********          WRITESE6050S1                                  S01464
     C***********                                                         S01464
     C***********          END                             E2             S01464
     C*                                                                   091522
     C** If customer position used set portfolio to blank                 091522
     C*                                                                   091522
     C           FBCFCP    IFEQ 'C'                                       091522
     C                     MOVE *BLANKS   S1FOLI                          091522
     C                     ELSE                                           091522
     C*                                                                   091522
     C** Set folio up containing details of requested portfolio           091522
     C*                                                                   091522
     C           SDPTFR    IFEQ '9997'                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE FCR997    S1FOLI                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           SDPTFR    IFEQ '9999'                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE FCR999    S1FOLI                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           SDPTFR    IFNE '9997'                                    091522
     C           SDPTFR    ANDNE'9999'                                    091522
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVE SDPTFR    S1FOLI                          091522
     C                     END                                            091522
     C*                                                                   091522
     C                     EXSR #I                                        091522
     C*                                                                   091522
     C** Write record to subfile.                                         091522
     C*                                                                   091522
     C                     ADD  1         S1RRN                           091522
     C                     WRITESE6050S1                                  091522
     C*                                                                   091522
     C                     END                             E2             091522
     C*
     C** IF CUSTODY FEES NOT REQUESTED FOR SPECIFIC PORTFOLIO
     C                     ELSE                            X1
     C*
     C***********SACFCP    IFEQ 'C'                        B2             S01464
     C           FBCFCP    IFEQ 'C'                        B2            S01464
     C*
     C**   Add one record to subfile for cutomer if fees per customer
     C**   (not portfolio)
     C*
     C                     MOVE *BLANKS   S1FOLI
     C                     EXSR #I
     C* Write record to subfile.
     C*
     C                     ADD  1         S1RRN
     C                     WRITESE6050S1
     C*
     C                     ELSE                            X2
     C***********                                                         S01464
     C*****Add*one*record*to*subfile*for*each*of*the*customers*portfolios S01464
     C*****which*has*an*accruals*record                                   S01464
     C***********                                                         S01464
     C***********          Z-ADDSDCNUM    PNCNUM                          S01464
     C***********          MOVE *LOVAL    PNPTFR                          S01464
     C***********                                                         S01464
     C****       PORTKY    SETLLPMPORTLL                                  48202
     C****                 READ PMPORTLL                 71               48202
     C***********PORTKY    SETLLPMPORTPP                            48202 S01464
     C***********          READ PMPORTPP                 71         48202 S01464
     C***********                                                         S01464
     C**Write*records*to*subfile*until*there*are*no                       S01464
     C**more*records*on*file.                                             S01464
     C***********                                                         S01464
     C************IN71     DOWEQ'0'                        B3             S01464
     C***********PNCNUM    ANDEQSDCNUM                                    S01464
     C***********                                                         S01464
     C***********          SETOF                     36                   S01464
     C***********                                                         S01464
     C***********          MOVE PNPTFR    WKPTFR                          S01464
     C***********          Z-ADDPNCNUM    WKCNUM                          S01464
     C***********FAXKEY    CHAINSCSCFAXX             72                   S01464
     C***********FAXKEY    CHAINSESCFAXX             72                   S01464
     C***********                                                         S01464
     C************IN72     IFEQ '0'                        B4             S01464
     C***********SDRECI    ANDNE'*'                                       S01464
     C**Move*values*from*file*to*screen*fields.                           S01464
     C***********                                                         S01464
     C***********          MOVE PNPTFR    S1FOLI                          S01464
     C***********          EXSR #I                                        S01464
     C***********          ADD  1         S1RRN                           S01464
     C***********                                                         S01464
     C**Write*record*to*subfile.                                          S01464
     C***********                                                         S01464
     C***********          WRITESE6050S1                                  S01464
     C***********          END                             E4             S01464
     C***********                                                         S01464
     C**Read*next*'non-deleted'*Record*from*File*SEOCFSXX.                S01464
     C***********                                                         S01464
     C****                 READ PMPORTLL                 71               48202
     C***********          READ PMPORTPP                 71         48202 S01464
     C***********                                                         S01464
     C***********          END                             E3             S01464
     C***********                                                         S01464
     C**Record*from*File*SCCCFAXX.                                        S01464
     C***********                                                         S01464
     C***********          MOVE SDCNUM    QBCUST                          S01464
     C***********QBCUST    CHAINSDPLCSPD             71                   S01464
     C***********                                                         S01464
     C************IN71     IFEQ '1'                                       S01464
     C***********QBRECI    OREQ '*'                                       S01464
     C***********          MOVE '9999'    WKPTFR                          S01464
     C***********          MOVE P9R999    S1FOLI                          S01464
     C***********          ELSE                                           S01464
     C***********          MOVE '9997'    WKPTFR                          S01464
     C***********          MOVE P9R997    S1FOLI                          S01464
     C***********          END                                            S01464
     C*                                                                   091522
     C** Add one record to subfile for each of the customers portfolios   091522
     C** which has an accruals record                                     091522
     C*                                                                   091522
     C**********           Z-ADDSDCNUM    PNCNUM                          091522       091522 CSD027
     C                     MOVE SDCNUM    PNCNUM                                              CSD027
     C                     MOVE *LOVAL    PNPTFR                          091522
     C*                                                                   091522
     C           PORTKY    SETLLPMPORTPD                                  091522
     C                     READ PMPORTPD                 71               091522
     C*                                                                   091522
     C** Write records to subfile until there are no                      091522
     C** more records on file.                                            091522
     C*                                                                   091522
     C           *IN71     DOWEQ'0'                        B3             091522
     C           PNCNUM    ANDEQSDCNUM                                    091522
     C*                                                                   091522
     C                     SETOF                     36                   091522
     C*                                                                   091522
     C                     MOVE PNPTFR    WKPTFR                          091522
     C**********           Z-ADDPNCNUM    WKCNUM                                       091522 CSD027
     C                     MOVE PNCNUM    WKCNUM                                              CSD027
     C           FAXKEY    CHAINSESCFAXX             72                   091522
     C*                                                                   091522
     C           *IN72     IFEQ '0'                        B4             091522
     C           SDRECI    ANDNE'*'                                       091522
     C*                                                                   091522
     C** Move values from file to screen fields.                          091522
     C*                                                                   091522
     C                     MOVE PNPTFR    S1FOLI                          091522
     C                     EXSR #I                                        091522
     C                     ADD  1         S1RRN                           091522
     C*                                                                   091522
     C* Write record to subfile.                                          091522
     C*                                                                   091522
     C                     WRITESE6050S1                                  091522
     C                     END                                            091522
     C*                                                                   091522
     C* Read next 'non-deleted' Record from File SCOCFSXX.                091522
     C*                                                                   091522
     C                     READ PMPORTPD                 71               091522
     C*                                                                   091522
     C                     END                                            091522
     C*                                                                   091522
     C* Record from File SCCCFAXX.                                        091522
     C*                                                                   091522
     C                     MOVE SDCNUM    QBCUST                          091522
     C           QBCUST    CHAINSDPLCSL0             71                   091522
     C*                                                                   091522
     C           *IN71     IFEQ '1'                                       091522
     C           QBRECI    OREQ '*'                                       091522
     C                     MOVE '9999'    WKPTFR                          091522
     C                     MOVE FCR999    S1FOLI                          091522
     C                     ELSE                                           091522
     C                     MOVE '9997'    WKPTFR                          091522
     C                     MOVE FCR997    S1FOLI                          091522
     C                     END                                            091522
     C*
     C**********           Z-ADDSDCNUM    WKCNUM                                              CSD027
     C                     MOVE SDCNUM    WKCNUM                                              CSD027
     C***********          MOVE SDBRCA    WKBRCA                   S01464 091522
     C                     MOVE SDBRCA    S1BRCH                          091522
     C                     MOVE *BLANKS   WKPTFR                          S01464
     C***********FAXKEY    CHAINSCSCFAXX             71                   S01464
     C           FAXKEY    CHAINSESCFAXX             71                   S01464
     C*
     C           *IN71     IFEQ '0'                        B3
     C           SDRECI    ANDNE'*'
     C                     EXSR #I
     C*
     C* Write record to subfile.
     C*
     C                     ADD  1         S1RRN
     C                     WRITESE6050S1
     C                     END                             E3
     C                     END                             E2
     C                     END                             E1
     C*
     C* Store RRN's.
     C                     Z-ADDS1RRN     WKLRRN
     C                     Z-ADDWKFRRN    S1RRN
     C*
     C                     SETON                     35
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #I        - LOAD SUBFILE RECORD - INSERT MODE                   *
     C*                                                                  *
     C*  CALLS     - NONE                                                *
     C*                                                                  *
     C*  CALLED BY - #H                                                  *
     C*                                                                  *
     C********************************************************************
     C           #I        BEGSR
     C*
     C                     MOVE 'Y'       S1UPDT
     C                     MOVE *BLANKS   S1ACTN
     C*
     C***********SAAUPI    IFEQ 'Y'                                       S01464
     C           FBAUPI    IFEQ 'Y'                                       S01464
     C                     MOVE 'X'       S1STAT
     C                     ELSE
     C                     MOVE *BLANKS   S1STAT
     C                     END
     C*
     C                     MOVE BBCUST    S1CUSS
     C*
     C                     Z-ADDSDCFAC    WKCFAC 140
     C           SDOSAS    IFEQ '+'
     C           SDCFAC    ADD  SDOSAJ    WKACTF 140
     C                     ELSE
     C           SDCFAC    SUB  SDOSAJ    WKACTF
     C                     END
     C*                                                                   48202
     C** CHECK THAT 'ACTUAL FEE' *GE MINIMUM COMMISSION                   48202
     C                     EXSR MINCOM                                    48202
     C*
     C                     MOVE WKCFAC    ZFLD15                          48202
     C***********          Z-ADDSABCGD    ZDECS                      48202S01464
     C                     Z-ADDWWNBDP    ZDECS                           S01464
     C                     EXSR ZSEDIT                                    48202
     C                     MOVE ZOUT21    WWFL15                          48202
     C                     MOVELWWFL15    S1ACRU                          48202
     C*
     C                     MOVE WKACTF    ZFLD15
     C***********          Z-ADDSABCGD    ZDECS                           S01464
     C                     Z-ADDWWNBDP    ZDECS                           S01464
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15
     C****                 MOVELWWFL15    S1ACRU                          48202
     C                     MOVELWWFL15    S1ACTF                          48202
     C****                 MOVE S1ACRU    S1ACTF                          48202
     C                     MOVE S1ACTF    S1HACT
     C*
     C**   Set up Currency, Account and Branch fields
     C*
     C           S1FOLI    IFEQ *BLANKS
     C***********S1FOLI    OREQ P9R997                                    S01464
     C***********S1FOLI    OREQ P9R999                                    S01464
     C           S1FOLI    OREQ FCR997                                    091522
     C           S1FOLI    OREQ FCR999                                    091522
     C*                                                                   S01464
     C           BBCUST    CHAINSDCFCDL0             74                   S01464
     C*                                                                   S01464
     C           *IN74     IFEQ '1'                                       S01464
     C                     MOVE *BLANKS   S1CURR                          S01464
     C                     MOVE *BLANKS   S1ACCV                          S01464
     C                     MOVE *BLANKS   S1BRCA                          S01464
     C                     MOVE *BLANKS   S1HCUS                          S01464
     C                     ELSE                                           S01464
     C                     MOVE E6SCCY    S1CURR                          S01464
     C                     MOVE E6SMAC    S1ACCV                          S01464
     C                     MOVE E6SBCH    S1BRCA                          S01464
     C                     MOVE *BLANKS   S1HCUS                          S01464
     C                     END                                            S01464
     C***********          MOVE BBCSCY    S1CURR                          S01464
     C***********          MOVE BBCUSA    S1ACCV                          S01464
     C***********          MOVE BBCUSB    S1HCUS                          S01464
     C***********          ELSE                                           S01464
     C***********                                                         S01464
     C***********PNCSCY    IFNE *BLANKS                                   S01464
     C***********          MOVE PNCSCY    S1CURR                          S01464
     C***********          MOVE PNCUSA    S1ACCV                          S01464
     C***********          MOVE PNCUSB    S1HCUS                          S01464
     C***********          ELSE                                           S01464
     C***********          MOVE BBCSCY    S1CURR                          S01464
     C***********          MOVE BBCUSA    S1ACCV                          S01464
     C***********          MOVE BBCUSB    S1HCUS                          S01464
     C***********          END                                            S01464
     C*                                                                   091522
     C                     ELSE                                           091522
     C*                                                                   091522
     C           PNCSCY    IFNE *BLANKS                                   091522
     C                     MOVE PNCSCY    S1CURR                          091522
     C                     MOVE PNCUSA    S1ACCV                          091522
     C                     MOVE PNCUSB    S1BRCA                          091522
     C                     MOVE *BLANKS   S1HCUS                          091522
     C                     ELSE                                           091522
     C*                                                                   091522
     C           BBCUST    CHAINSDCFCDL0             74                   091522
     C*                                                                   091522
     C           *IN74     IFEQ '1'                                       091522
     C                     MOVE *BLANKS   S1CURR                          091522
     C                     MOVE *BLANKS   S1ACCV                          091522
     C                     MOVE *BLANKS   S1BRCA                          091522
     C                     MOVE *BLANKS   S1HCUS                          091522
     C                     ELSE                                           091522
     C                     MOVE E6SCCY    S1CURR                          091522
     C                     MOVE E6SMAC    S1ACCV                          091522
     C                     MOVE E6SBCH    S1BRCA                          091522
     C                     MOVE *BLANKS   S1HCUS                          091522
     C                     END                                            091522
     C*                                                                   091522
     C                     END                                            091522
     C*
     C                     END
     C*
     C** IF SETTLEMENT CURRENCY BLANK (IE NO SETTLEMENT ACCOUNT DEFINED)
     C** SETTLEMENT WILL BE GENERATED TO SUSPENSE ACCOUNT IN BANK
     C** CHARGING CURRENCY
     C           S1ACCV    IFEQ *BLANKS
     C***********          MOVE SABCGC    S1CURR                          S01464
     C                     MOVE FBBCGC    S1CURR                          S01464
     C                     MOVE BBBRCD    S1HCUS
     C                     END
     C*
     C                     MOVE S1CURR    S1HCCY
     C                     MOVE S1ACCV    S1HACC
     C                     MOVE S1BRCA    S1HBRC                          S01464
     C*
     C* Convert projected Settlement Amount to Settlement Currency.
     C*
     C                     Z-ADDWKACTF    ZAMTF
     C***********          MOVE SABCGC    ZCCYF                           S01464
     C                     MOVE FBBCGC    ZCCYF                           S01464
     C                     MOVE S1CURR    ZCCYT
     C                     MOVE BJCYCD    ZCCYB
     C******************** EXSR ZCCYKK                                    48200
     C/COPY WNCPYSRC,SE6050C006
     C                     EXSR ZCCYGB                                    48200
     C/COPY WNCPYSRC,SE6050C007
     C*
     C                     Z-ADDZSCYDP    ZDECS
     C                     Z-ADDZAMTT     ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15
     C                     MOVELWWFL15    S1SETA
     C*
     C                     MOVE BJRDNB    S1HVDN
     C                     MOVE BJRDNB    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     S1CDTE
     C                     MOVE S1CDTE    S1HDAT
     C*
     C*
     C                     Z-ADD0         S1HTRN
     C                     Z-ADDSDTNLU    S1HATN
     C*
     C                     ENDSR
     C********************************************************************48202
     C/EJECT                                                              48202
     C********************************************************************48202
     C**                                                              *   48202
     C**   MINCOM    - If the Amount accrued (SDCFAC) is less than    *   48202
     C**               minimum commission and the minimum is not zero,*   48202
     C**               output the minimum Amount insted of the Accrued*   48202
     C**               amount to field SEAFTS when writing to SEOCFSPD*   48202
     C**                                                              *   48202
     C**   CALLS     - NONE                                           *   48202
     C**                                                              *   48202
     C**   CALLED BY - #BB                                            *   48202
     C**                                                              *   48202
     C*****************************************************************   48202
     C           MINCOM    BEGSR                                          48202
     C*                                                                   48202
     C** FOR DEFINED PORTFOLIOS DETERMINE CUSTODY FEE GROUP FROM          48202
     C** PORTFOLIO DEFINITION                                             48202
     C*                                                                   091522
     C           FBCFCP    IFEQ 'P'                                       091522
     C*                                                                   091522
     C           SDPTFR    IFNE '9997'                     B1             48202
     C           SDPTFR    ANDNE'9998'                                    48202
     C           SDPTFR    ANDNE'9999'                                    48202
     C***********          MOVE SDCNUM    PNCNUM                    48202 S01464
     C***********          MOVE SDPTFR    PNPTFR                    48202 S01464
     C*                                                                   48202
     C***********PORTKY    CHAINPMPORTPP             71             48202 S01464
     C************IN71     IFEQ '1'                        B2       48202 S01464
     C***********          Z-ADD11        DBASE                     48202 S01464
     C***********          MOVE *BLANKS   DBFILE     ***************48202 S01464
     C***********          MOVEL'PMPORTPP'DBFILE     * DBERROR 001 *48202 S01464
     C***********          MOVELPNCNUM    DBKEY      ***************48202 S01464
     C***********          MOVE PNPTFR    DBKEY                     48202 S01464
     C***********          MOVE '1'       *INU7                     48202 S01464
     C***********          MOVE '1'       *INU8                     48202 S01464
     C***********          MOVE '1'       *INLR                     48202 S01464
     C***********          RETRN                                    48202 S01464
     C***********          END                             E2       48202 S01464
     C*                                                                   48202
     C***********          MOVE PNCFGC    WWCFGC                    48202 S01464
     C*                                                                   091522
     C                     MOVE SDCNUM    PNCNUM                          091522
     C                     MOVE SDPTFR    PNPTFR                          091522
     C*                                                                   091522
     C           PORTKY    CHAINPMPORTPD             71                   091522
     C           *IN71     IFEQ '1'                                       091522
     C                     Z-ADD11        DBASE                           091522
     C                     MOVE *BLANKS   DBFILE           ***************091522
     C                     MOVEL'PMPORTPD'DBFILE           * DBERROR 011 *091522
     C                     MOVELPNCNUM    DBKEY            ***************091522
     C                     MOVE PNPTFR    DBKEY                           091522
     C                     MOVE '1'       *INU7                           091522
     C                     MOVE '1'       *INU8                           091522
     C                     MOVE '1'       *INLR                           091522
     C                     RETRN                                          091522
     C                     END                                            091522
     C*                                                                   091522
     C                     MOVE PNCFGC    WWCFGC                          091522
     C                     END                                            48202
     C*                                                                   091522
     C                     END                                            091522
     C*                                                                   48202
     C** IF CUSTODY FEE GROUP CODE BLANK BRANCH TO END OF ROUTINE         48202
     C           WWCFGC    CABEQ'  '      ENDMIN                          48202
      *                                                                   48202
     C***********WWCFGC    CHAINSCCFGRP0             10             48202 S01464
     C           WWCFGC    CHAINSECFGRP0             10                   S01464
      *  Bypass if does not exist                                         48202
     C           *IN10     CABEQ'1'       ENDMIN                          48202
      *  Bypass if deleted                                                48202
     C           SBCHTP    CABEQ'D'       ENDMIN                          48202
     C*                                                                   48202
     C** IF THE MINIMUM COMMISSION IS NOT EQUAL TO ZERO CALCULATE         48202
     C** THE MINIMUM COMMISSION DUE SINCE LAST SETTLEMENT DATE            48202
     C           SBMICO    IFNE 0                                         48202
     C*                                                                   48202
     C***********BJRDNB    SUB  SALCRD    WWMIND  50                48202 S01464
     C           BJRDNB    SUB  FBLCRD    WWMIND  50                      S01464
     C           WWMIND    MULT SBMICO    WWMICO 150                      48202
     C           WWMICO    DIV  365       WWMICO 150H                     48202
     C*                                                                   48202
     C** IF THE ACTUAL FEE IS LESS THAN THE MINIMUM COMMISSION RESET      48202
     C** THE ACTUAL FEE TO THE MINIMUM COMMISSION                         48202
     C           WKACTF    IFLT WWMICO                                    48202
     C                     Z-ADDWWMICO    WKACTF                          48202%
     C                     END                                            48202
     C                     END                                            48202
      *                                                                   48202
     C           ENDMIN    ENDSR                                          48202
     C********************************************************************
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #YB       - DISPLAY SCREEN                                      *
     C*                                                                  *
     C*  CALLS     - NONE                                                *
     C*                                                                  *
     C*  CALLED BY - #B                                                  *
     C*                                                                  *
     C********************************************************************
     C           #YB       BEGSR
     C*
     C* Display headings and subfile.
     C*
     C                     WRITESE6050C2
     C*
     C* Display footings.
     C*
     C                     WRITESE6050C3
     C*
     C* If errors write message subfile to screen.
     C*
     C           WKEROR    IFEQ '1'
     C                     WRITESE6050C4
     C                     END
     C*
     C* Read Screen.
     C*
     C                     MOVE S1BRCH    WKBRCH  3                       091522
     C           WKFSRN    IFEQ 'Y'
     C                     READ SE6050C3                 59
     C                     ELSE
     C                     READ SE6050C2                 59
     C                     END
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #E        - UPDATE PROCESSING                                   *
     C*                                                                  *
     C*  CALLS     -                                                     *
     C*                                                                  *
     C*  CALLED BY -                                                     *
     C*                                                                  *
     C********************************************************************
     C           #E        BEGSR
     C*
     C                     SETOF                     65
     C                     MOVE *BLANKS   WKEROR
     C*
     C* Read all Records in the Subfile.
     C*
     C                     Z-ADD1         S1RRN
     C           S1RRN     CHAINSE6050S1             75
     C*
     C           *IN75     DOWEQ'0'                        B1
     C                     SETOF                     368182
     C*
     C* If hidden field is 'Y' then record has changed so therefore
     C* update the files.
     C*
     C           S1UPDT    IFEQ 'Y'                        B2
     C                     MOVE 'N'       S1UPDT
     C*
     C* Get Transaction no. of last update.
     C*
     C                     EXSR ZTNLU1
     C*
     C                     MOVE S1CUSS    SECNUM
     C************************************************************ S01464 091522
     C**If*multi-branch*environment,*move*branch*code************* S01464 091522
     C************************************************************ S01464 091522
     C************IN50     IFEQ '1'                                S01464 091522
     C*                                                                   091522
     C** Always use screen branch in the key.                             091522
     C*                                                                   091522
     C                     MOVE S1BRCH    SEBRCA                          S01464
     C***********          END                                     S01464 091522
     C*
     C***********S1FOLI    IFEQ P9R997                                    S01464
     C***********          MOVE '9997'    SEPTFR                          S01464
     C***********          END                                            S01464
     C***********                                                         S01464
     C***********S1FOLI    IFEQ P9R999                                    S01464
     C***********          MOVE '9999'    SEPTFR                          S01464
     C***********          END                                            S01464
     C***********                                                         S01464
     C***********S1FOLI    IFNE P9R997                                    S01464
     C***********S1FOLI    ANDNEP9R999                                    S01464
     C***********S1FOLI    ANDNE*BLANKS                                   S01464
     C***********          MOVE S1FOLI    SEPTFR                          S01464
     C***********          END                                            S01464
     C*                                                                   091522
     C           FBCFCP    IFEQ 'P'                                       091522
     C*                                                                   091522
     C           S1FOLI    IFEQ FCR997                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9997'    SEPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1FOLI    IFEQ FCR999                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9999'    SEPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1FOLI    IFNE FCR997                                    091522
     C           S1FOLI    ANDNEFCR999                                    091522
     C           S1FOLI    ANDNE*BLANKS                                   091522
     C           S1FOLI    OREQ FCR997                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C           S1FOLI    OREQ FCR999                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C                     MOVE S1FOLI    SEPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C                     END                                            091522
     C*                                                                   049067
     C                     MOVE S1CDTE    ZDATE                           049067
     C                     EXSR ZDATE1                                    049067
     C                     Z-ADDZDAYNO    SESEVD                          049067
     C*
     C* Access File 'SEOCFSPD'.
     C*
     C***********FSPDKY    CHAINSCOCFSPD             33                   S01464
     C           FSPDKY    CHAINSEOCFSPD             33                   S01464
     C*
     C           *IN33     IFEQ '0'                        B3
     C*
     C* If Transaction Number of last update has changed since
     C* last access update subfile with new values from file.
     C*
     C           SETNLU    IFNE S1HTRN                     B4
     C*
     C* Move File values to screen fields.
     C*
     C                     MOVE *BLANKS   S1ACTN
     C           SERECI    IFEQ '*'                        B5
     C                     MOVE 'D'       S1STAT
     C                     SETON                     64
     C                     ELSE                            X5
     C                     SETOF                     64
     C           SEAUIN    IFEQ 'Y'                        B6
     C                     MOVE 'X'       S1STAT
     C*****      SAAUPI    IFEQ 'N'
     C*****                SETON                     64
     C*****                END
     C                     ELSE                            X6
     C                     MOVE *BLANKS   S1STAT
     C                     END                             E6
     C                     END                             E5
     C*
     C***********          Z-ADDSABCGD    ZDECS                           S01464
     C                     Z-ADDWWNBDP    ZDECS                           S01464
     C                     Z-ADDSECFAC    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15
     C                     MOVELWWFL15    S1ACRU
     C*
     C                     Z-ADDSEAFTS    ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15
     C                     MOVELWWFL15    S1ACTF
     C                     MOVELS1ACTF    S1HACT
     C*
     C                     MOVE SECSCY    S1CURR
     C                     MOVE SECSCY    S1HCCY
     C                     MOVE SECUSA    S1ACCV
     C                     MOVE SECUSA    S1HACC
     C                     MOVE SESEVD    S1HVDN
     C                     MOVE SESEVD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     S1CDTE
     C                     MOVE ZDATE     S1HDAT
     C                     MOVE SECUSB    S1HCUS
     C           *IN50     IFEQ '1'                                       S01464
     C                     MOVE SECUSB    S1BRCA                          S01464
     C                     MOVE SECUSB    S1HBRC                          S01464
     C                     END                                            S01464
     C                     MOVE SETNLU    S1HTRN
     C*
     C* Convert projected Settlement Amount to Settlement Currency.
     C*
     C                     Z-ADDSEAFTS    ZAMTF
     C***********          MOVE SABCGC    ZCCYF                           S01464
     C                     MOVE FBBCGC    ZCCYF                           S01464
     C                     MOVE SECSCY    ZCCYT
     C                     MOVE BJCYCD    ZCCYB
     C******************** EXSR ZCCYKK                                    48200
     C/COPY WNCPYSRC,SE6050C008
     C                     EXSR ZCCYGB                                    48200
     C/COPY WNCPYSRC,SE6050C009
     C*
     C                     Z-ADDZSCYDP    ZDECS
     C                     Z-ADDZAMTT     ZFLD15
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    WWFL15
     C                     MOVELWWFL15    S1SETA
     C*
     C                     MOVE '1'       WKEROR
     C                     MOVEL'SE05010' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     368182
     C                     SETON                     65
     C                     MOVE 'Y'       S1UPDT
     C*
     C* Else - No Change so update file values.
     C*
     C                     ELSE
     C*
     C           S1ACTN    IFEQ 'D'
     C                     MOVE '*'       SERECI
     C                     ELSE
     C                     MOVE 'D'       SERECI
     C                     END
     C*
     C                     MOVE BJMRDT    WKDAT
     C                     MOVE BJRDNB    SELCD
     C                     MOVE WKDAY     SEDLUP
     C                     MOVE WKMTH     SEMLUP
     C                     MOVE WKYR      SEYLUP
     C*
     C                     TIME           SETLUP
     C*
     C           S1ACTN    IFEQ 'D'
     C                     MOVE 'D'       SECHTP
     C                     ELSE
     C           SELCD     IFNE BJRDNB
     C           S1ACTN    IFEQ 'X'
     C                     MOVE 'X'       SECHTP
     C                     ELSE
     C                     MOVE 'A'       SECHTP
     C                     END
     C                     END
     C                     END
     C*
     C                     MOVE WWNATN    SETNLU
     C*
     C***********          Z-ADDSABCGD    ZADEC                           S01464
     C                     Z-ADDWWNBDP    ZADEC                           S01464
     C                     Z-ADD0         ZADIG
     C***********13        SUB  SABCGD    ZADIG                           S01464
     C           13        SUB  WWNBDP    ZADIG                           S01464
     C                     MOVE '0'       *IN99
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE S1ACTF    ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    SEAFTS
     C*
     C                     MOVE S1CURR    SECSCY
     C                     MOVE S1ACCV    SECUSA
     C                     MOVE S1BRCA    SECUSB                          S01464
     C                     MOVE S1CDTE    ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    SESEVD
     C*
     C           S1ACTN    IFEQ 'X'
     C                     MOVE 'Y'       SEAUIN
     C                     END
     C*
     C* Update File.
     C***********          UPDATSCOCFSP1                                  S01464
     C                     UPDATSEOCFSP1                                  S01464
     C*
     C* Update Hidden Subfile fields.
     C*
     C                     MOVE WWNATN    S1HTRN
     C                     MOVE S1ACTF    S1HACT
     C                     MOVE S1CURR    S1HCCY
     C                     MOVE S1BRCA    S1HBRC                          S01464
     C                     MOVE S1ACCV    S1HACC
     C                     MOVE S1CDTE    S1HDAT
     C                     Z-ADDSESEVD    S1HVDN
     C                     MOVE *BLANKS   S1ACTN
     C           SERECI    IFEQ '*'
     C                     MOVE 'D'       S1STAT
     C                     SETON                     64
     C                     ELSE
     C                     SETOF                     64
     C           SEAUIN    IFEQ 'Y'
     C                     MOVE 'X'       S1STAT
     C******     SAAUPI    IFEQ 'N'
     C******               SETON                     64
     C******               END
     C                     ELSE
     C                     MOVE *BLANKS   S1STAT
     C                     END
     C                     END
     C*
     C                     END
     C                     END
     C*
     C                     UPDATSE6050S1
     C                     END
     C*
     C                     ADD  1         S1RRN
     C           S1RRN     CHAINSE6050S1             75
     C                     END
     C*
     C**   COMIT UPDATES
     C*
     C**   SET UP COMMITMENT TEXT
     C*
     C                     MOVE *BLANKS   ACTCDX
     C                     TIME           MTIME
     C           CMTTXT    COMIT
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C*
     C*
     C/EJECT
     C********************************************************************
     C*                                                                  *
     C*  #K        - UPDATE PROCESSING FOR INSERTIONS                    *
     C*                                                                  *
     C*  CALLS     -                                                     *
     C*                                                                  *
     C*  CALLED BY -                                                     *
     C*                                                                  *
     C********************************************************************
     C           #K        BEGSR
     C*
     C                     SETOF                     65
     C                     MOVE *BLANKS   WKEROR
     C*
     C* Clear screen message queue.
     C*
     C                     CALL 'Y2CLMSC'
     C                     PARM           WWTPGQ
     C                     PARM           WWPGQR
     C*
     C* Read all Records in the Subfile.
     C*
     C                     Z-ADD1         S1RRN
     C           S1RRN     CHAINSE6050S1             75
     C*
     C           *IN75     DOWEQ'0'                        B1
     C           *IN65     ANDEQ'0'
     C*
     C* Get Transaction no. of last update.
     C*
     C                     EXSR ZTNLU1
     C*
     C                     MOVE S1CUSS    SECNUM
     C*************************************************************S01464 091522
     C**If*multi-branch*environment,*move*branch*code**************S01464 091522
     C*************************************************************S01464 091522
     C************IN50     IFEQ '1'                                S01464 091522
     C*                                                                   091522
     C** Always use screen branch as key.                                 091522
     C*                                                                   091522
     C                     MOVE S1BRCH    SEBRCA                          S01464
     C***********          END                                     S01464 091522
     C*
     C***********S1FOLI    IFEQ P9R997                     B2             S01464
     C***********          MOVE '9997'    SEPTFR                          S01464
     C***********          END                             E2             S01464
     C***********                                                         S01464
     C***********S1FOLI    IFEQ P9R999                     B2             S01464
     C***********          MOVE '9999'    SEPTFR                          S01464
     C***********          END                             E2             S01464
     C***********                                                         S01464
     C***********S1FOLI    IFNE P9R997                     B2             S01464
     C***********S1FOLI    ANDNEP9R999                                    S01464
     C***********S1FOLI    ANDNE*BLANKS                                   S01464
     C***********          MOVE S1FOLI    SEPTFR                          S01464
     C***********          END                             E2             S01464
     C*                                                                   091522
     C           FBCFCP    IFEQ 'P'                                       091522
     C*                                                                   091522
     C           S1FOLI    IFEQ FCR997                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9997'    SEPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1FOLI    IFEQ FCR999                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9999'    SEPTFR                          091522
     C                     END                                            091522
     C*                                                                   091522
     C           S1FOLI    IFNE FCR997                                    091522
     C           S1FOLI    ANDNEFCR999                                    091522
     C           S1FOLI    ANDNE*BLANKS                                   091522
     C           S1FOLI    OREQ FCR997                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C           S1FOLI    OREQ FCR999                                    CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C                     MOVE S1FOLI    SEPTFR                          091522
     C                     END                                            091522
     C*                                                                   049067
     C                     MOVE S1CDTE    ZDATE                           049067
     C                     EXSR ZDATE1                                    049067
     C                     Z-ADDZDAYNO    SESEVD                          049067
     C*                                                                   091522
     C                     END                                            091522
     C*
     C* Access File 'SEOCFSPD'.
     C*
     C***********FSPDKY    CHAINSCOCFSPD             33                   S01464
     C           FSPDKY    CHAINSEOCFSPD             33                   S01464
     C*
     C           *IN33     IFEQ '0'                        B2
     C           SERECI    ANDEQ'D'                                       44139
     C*
     C                     MOVEL'SE05015' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     65
     C                     MOVE '1'       WKEROR
     C*
     C                     ELSE                            X2
     C*
     C* Create new record.
     C*
     C***********S1ACTN    IFEQ 'D'                        B3             44139
     C***********          MOVE '*'       SERECI                          44139
     C***********          ELSE                            X3             44139
     C***********          MOVE 'D'       SERECI                          44139
     C***********          END                             E3             44139
     C                     MOVE 'D'       SERECI                          44139
     C*
     C                     MOVE BJMRDT    WKDAT
     C                     MOVE WKDAY     SEDLUP
     C                     MOVE WKMTH     SEMLUP
     C                     MOVE WKYR      SEYLUP
     C*
     C                     TIME           SETLUP
     C*                                                                   045532
     C                     MOVE 'I'       SECHTP                          045532
     C*
     C***********S1ACTN    IFEQ 'D'                        B3             44139
     C***********          MOVE 'D'       SECHTP                          44139
     C***********          ELSE                            X3             44139
     C***********S1ACTN    IFEQ 'X'                        B4             44139
     C****                 MOVE 'I'       SECHTP                          48202
     C                     MOVE 'X'       SECHTP                          48202
     C***********          END                             E4             44139
     C***********          END                             E3             44139
     C*
     C                     MOVE BJRDNB    SELCD
     C                     MOVE WWNATN    SETNLU
     C*
     C***********          Z-ADDSABCGD    ZADEC                           S01464
     C                     Z-ADDWWNBDP    ZADEC                           S01464
     C                     Z-ADD0         ZADIG
     C***********13        SUB  SABCGD    ZADIG                           S01464
     C           13        SUB  WWNBDP    ZADIG                           S01464
     C                     MOVE '0'       *IN99
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE S1ACRU    ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    SECFAC
     C*
     C                     MOVE '0'       *IN99
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE S1ACTF    ZFIELD
     C                     EXSR ZALIGN
     C                     MOVE ZFIELD    SEAFTS
     C*
     C                     MOVE S1CURR    SECSCY
     C                     MOVE S1ACCV    SECUSA
     C*                                                                   S01464
     C           *IN50     IFEQ '0'                                       S01464
     C                     MOVE S1HCUS    SECUSB
     C                     ELSE                                           S01464
     C                     MOVE S1BRCA    SECUSB                          S01464
     C                     END                                            S01464
     C*
     C                     MOVE S1CDTE    ZDATE
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    SESEVD
     C*
     C***********S1ACTN    IFEQ 'X'                                       44139
B3   C           FBAUPI    IFEQ 'Y'                        B3             44139
     C                     MOVE 'Y'       SEAUIN
     C                     ELSE                            X3
     C                     MOVE 'N'       SEAUIN
     C                     END                             E3
     C*
     C* Update existing deleted record or write new record                045532
     C*                                                                   045532
     C           *IN33     IFEQ '1'                                       045532
     C***********          WRITESCOCFSP1               33                 S01464
     C                     WRITESEOCFSP1               33                 S01464
     C                     ELSE                                           045532
     C                     UPDATSEOCFSP1               33                 045532
     C                     END                                            045532
     C*
     C           *IN33     IFEQ '0'                        B3
     C*
     C* Chain to SESCFAPD.
     C                     MOVE S1CUSS    WKCNUM
     C***********          MOVE S1BRCH    WKBRCA                   S01464 091522
     C                     MOVE *BLANKS   WKPTFR                          S01464
     C***********S1FOLI    IFEQ P9R999                     B4             S01464
     C***********          MOVE '9999'    WKPTFR                          S01464
     C***********          ELSE                            X4             S01464
     C***********S1FOLI    IFEQ P9R997                     B5             S01464
     C***********          MOVE '9997'    WKPTFR                          S01464
     C***********          ELSE                            X5             S01464
     C***********          MOVE S1FOLI    WKPTFR                          S01464
     C***********          END                             E5             S01464
     C***********          END                             E4             S01464
     C*
     C           S1FOLI    IFEQ FCR999                                    091522
     C                     MOVE '9999'    WKPTFR                          091522
     C                     ELSE                                           091522
     C           S1FOLI    IFEQ FCR997                                    091522
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE '9997'    WKPTFR                          091522
     C                     ELSE                                           091522
     C                     MOVE S1FOLI    WKPTFR                          091522
     C                     END                                            091522
     C                     END                                            091522
     C*                                                                   091522
     C***********FAXKEY    CHAINSCSCFAPD             75                   S01464
     C           FAXKEY    CHAINSESCFAPD             75                   S01464
     C*
     C           *IN75     IFEQ '1'                        B4
     C***********SDTNLU    ORNE S1HATN                                    44139
     C*
     C                     MOVEL'SE05016' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     65
     C                     MOVE '1'       WKEROR
     C*
     C                     ELSE                            X4
     C*
     C***********          DELETSCSCFAP1                                  S01464
     C                     DELETSESCFAP1                                  S01464
     C                     END                             E4
     C*
     C                     ELSE                            X3
     C*
     C* File update not successful.
     C*
     C                     MOVEL'SE05016' ZAMSID
     C                     EXSR ZASNMS
     C                     SETON                     65
     C                     MOVE '1'       WKEROR
     C*
     C                     END                             E3
     C                     END                             E2
     C*
     C                     ADD  1         S1RRN
     C           S1RRN     CHAINSE6050S1             75
     C                     END                             E1
     C*
     C           *IN65     IFEQ '0'                        B1
     C           CMTTXT    COMIT
     C*
     C* Clear Subfile.
     C                     SETON                     31
     C                     WRITESE6050C2
     C                     SETOF                     31
     C*
     C                     MOVE 'Y'       WKIN09
     C*
     C                     ELSE                            X1
     C                     ROLBK
     C                     MOVE 'N'       WKINSA
     C                     MOVE 'N'       WKINER
     C                     SETON                     28
     C                     END                             E1
     C*
     C                     ENDSR
     C*
     C********************************************************************
     C*
     C/EJECT
     C*********************************************************************
     C**                                                                  *
     C** ZCCYKK subroutine to convert an amount in one currency to an     *
     C** amount in another currency using the Swiss Konventionkurse       *
     C** exchange rates.                                                  *
     C**     Input fields:   ZAMTF  15/0   Amount in 'From' Currency      *
     C**                     ZCCYF  3      'From' Currency                *
     C**                     ZCCYT  3      'To' Currency                  *
     C**                     ZCCYB  3      Base Currency                  *
     C**                                                                  *
     C**     Output fields:  ZAMTT  ]5/0   Amount in 'To' Currency        *
     C**                     ZCRSRT 13/8   Cross Exchange Rate            *
     C**                     ZCRSMD 1      Cross Rate Mult/Div Ind.       *
     C**                     ZSCYDP 1/0    Settle. Ccy Dec Places         *
     C**                                                                  *
     C**     If Indicator 85 is set after calling this subroutine         *
     C**     standard Database Error processing must be performed         *
     C**                                                                  *
     C**     Also Requires:  Currency file (SDCURRJ0)                     *
     C**                                                                  *
     C**     Calls:   ZCCYCN                                              *
     C**                                                                  *
     C***        ZCCYKK    BEGSR                           **  ZCCYKK     *
     C***
     C***DEFINE WORK FIELDS
     C***                  Z-ADDZAMTF     ZAMTF  150
     C***                  MOVE ZCCYF     ZCCYF   3
     C***                  MOVE ZCCYT     ZCCYT   3
     C***                  MOVE ZCCYB     ZCCYB   3
     C***                  Z-ADDZAMTT     ZAMTT  150
     C***                  Z-ADDZCRSRT    ZCRSRT 138
     C***                  MOVE ZCRSMD    ZCRSMD  1
     C***                  MOVE ZSCYDP    ZSCYDP  10
     C***                  MOVE 'N'       ZZIND   1
     C*
     C** INITIALISE INDICATOR FOR DATABASE ERROR
     C***                  MOVE '0'       *IN85
     C***
     C***CHECK IF THE 'FROM' CURRENCY EQUALS THE 'TO' CURRENCY
     C***        ZCCYF     IFEQ ZCCYT                      B1
     C***                  Z-ADDZAMTF     ZAMTT
     C***                  Z-ADD1         ZCRSRT
     C***                  MOVE 'M'       ZCRSMD
     C***
     C***                  ELSE                            X1
     C***
     C***ACCESS THE CURRENCY FILE USING THE 'FROM' CCY
     C***        ZCCYF     CHAINSDCURRJ0             80
     C*
     C** IF RECORD NOT FOUND OR LAST CHANGE TYPE = 'D' THEN DB ERROR
     C*
     C***        *IN80     IFEQ '1'                        B2
     C***                  MOVE '1'       *IN85                        ****
     C***                  ELSE                            X2
     C***
     C***CHECK THE 'FROM' CURRENCY AGAINST THE BASE CURRENCY
     C***        ZCCYF     IFEQ ZCCYB                      B3
     C***                  Z-ADDA6NBDP    ZCDPF
     C***                  MOVE 'M'       ZMDINF
     C***                  Z-ADD1         ZRATEF
     C***                  ELSE                            X3
     C***
     C***CHECK THE 'TO' CURRENCY AGAINST THE BASE CURRENCY
     C***        ZCCYT     IFEQ ZCCYB                      B4
     C***                  Z-ADDA6NBDP    ZCDPF
     C***
     C***        CYSELR    IFNE 0                          B5
     C***                  MOVE CYSELI    ZMDINF
     C***                  Z-ADDCYSELR    ZRATEF
     C***                  ELSE                            X5
     C***                  MOVE A6MDIN    ZMDINF
     C***                  Z-ADDA6SPRT    ZRATEF
     C***                  END                             E5
     C***
     C***                  ELSE                            X4
     C***
     C***        CYBUYR    IFEQ 0                          B5
     C***                  MOVE A6MDIN    CYBUYI
     C***                  Z-ADDA6SPRT    CYBUYR
     C***                  END                             E5
     C***
     C***        CYSELR    IFEQ 0                          B5
     C***                  MOVE A6MDIN    CYSELI
     C***                  Z-ADDA6SPRT    CYSELR
     C***                  END                             E5
     C***
     C***CHECK THE CONVENTION BID MULT/DIV INDICATOR
     C***        CYBUYI    IFEQ 'D'                        B5
     C***
     C***TAKE THE INVERSE OF THE BID RATE - CHECK FOR DIVIDE BY ZERO
     C***        CYBUYR    IFNE 0                          B6
     C***        1         DIV  CYBUYR    WWBMLT 138H
     C***                  ELSE                            X6
     C***                  Z-ADD0         WWBMLT
     C***                  END                             E6
     C***                  ELSE                            X5
     C***                  Z-ADDCYBUYR    WWBMLT
     C***                  END                             E5
     C***
     C** CHECK THE CONVENTION SELL MULT/DIV INDICATOR
     C***        CYSELI    IFEQ 'D'                        B5
     C***
     C***TAKE THE INVERSE OF THE SELL RATE - CHECK FOR DIVIDE BY ZERO
     C***        CYSELR    IFNE 0                          B6
     C***        1         DIV  CYSELR    WWSMLT 138H
     C***                  ELSE                            X6
     C***                  Z-ADD0         WWSMLT
     C***                  END                             E6
     C***                  ELSE                            X5
     C***                  Z-ADDCYSELR    WWSMLT
     C***                  END                             E5
     C***
     C***                  Z-ADDA6NBDP    ZCDPF
     C***                  MOVE 'M'       ZMDINF
     C***        WWBMLT    ADD  WWSMLT    WWMRAT 148
     C***        WWMRAT    DIV  2         ZRATEF
     C***                  END                             E4
     C***                  END                             E3
     C***
     C***ACCESS THE CURRENCY FILE USING THE 'TO' CCY
     C***        ZCCYT     CHAINSDCURRJ0             80
     C***
     C***IF RECORD NOT FOUND OR LAST CHANGE TYPE = 'D' THEN DB ERROR
     C***
     C***        *IN80     IFEQ '1'                        B3
     C***                  MOVE '1'       *IN85                        ****
     C***                  ELSE                            X3
     C***
     C** SET ON INDICATOR STATING ZCCYT USED TO ACCESS LF/SDCURRJ0 AND
     C** SAVE DECIMAL PLACES
     C***                  MOVE 'Y'       ZZIND
     C***                  Z-ADDA6NBDP    ZSCYDP
     C***
     C***CHECK THE 'TO' CURRENCY AGAINST THE BASE CURRENCY
     C***        ZCCYT     IFEQ ZCCYB                      B4
     C***                  Z-ADDA6NBDP    ZCDPT
     C***                  MOVE 'M'       ZMDINT
     C***                  Z-ADD1         ZRATET
     C***                  ELSE                            X4
     C***
     C***                  Z-ADDA6NBDP    ZCDPT
     C***
     C***        CYBUYR    IFEQ 0                          B5
     C***                  MOVE A6MDIN    ZMDINT
     C***                  Z-ADDA6SPRT    ZRATET
     C***                  ELSE                            X5
     C***                  MOVE CYBUYI    ZMDINT
     C***                  Z-ADDCYBUYR    ZRATET
     C***                  END                             E5
     C***
     C***                  END                             E4
     C***
     C***                  EXSR ZCCYCN
     C***
     C***                  END                             E3
     C***                  END                             E2
     C***                  END                             E1
     C***
     C** IF CURRENCIES FILE NOT ACCESSED WITH ZCCYT ACCESS TO GET TO
     C** CURRENCY DECIMAL PLACES
     C***        ZZIND     IFEQ 'N'                        B1
     C***        ZCCYT     CHAINSDCURRJ0             80
     C***
     C***IF RECORD NOT FOUND OR LAST CHANGE TYPE = 'D' THEN DB ERROR
     C***
     C***        *IN80     IFEQ '1'                        B2
     C***                  MOVE '1'       *IN85                        ****
     C***                  ELSE                            X2
     C***                  Z-ADDA6NBDP    ZSCYDP
     C***                  END                             E2
     C***                  END                             E1
     C***
     C***        ZKKEND    ENDSR
     C***
     C********************************************************************
     C**                                                                 *
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** ZTNLU1    - RETRIEVE/UPDATE TRANS NO. OF LAST UPDATE            *
     C**                                                                 *
     C** CALLS     - NONE                                                *
     C**                                                                 *
     C** CALLED BY - #ZAA                                                *
     C**                                                                 *
     C********************************************************************
     C           ZTNLU1    BEGSR                                        **
     C*
     C           *NAMVAR   DEFN MNATN     DNATN
     C           *LOCK     IN   DNATN
     C                     Z-ADDFNATN     WWDSTN  50
     C                     Z-ADDFNATN     WWNATN
     C                     ADD  1         FNATN
     C                     OUT  DNATN
     C*
     C                     ENDSR
     C********************************************************************
     C*
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** ZSEDIT subroutine to insert a decimal point and sign into a     *
     C** numeric field and to blank out leading zeros (optionaly         *
     C** inserting commas).                                              *
     C**     Input fields:   ZFLD15 15/0                                 *
     C**                     ZDECS  1/0                                  *
     C**                     ZECODE 1/  ('J', 'L' or blank)              *
     C**                                                                 *
     C**     Arrays:         ZS1    15/1/0                               *
     C**                     ZS2    21/1/                                *
     C**                                                                 *
     C**     Output fields:  ZOUT21 21                                   *
     C**                                                                 *
     CSR         ZSEDIT    BEGSR                           **  ZSEDIT   *
     C*
     C* Define/Clear fields
     C*
     C                     Z-ADDZFLD15    ZFLD15 150
     C                     Z-ADDZDECS     ZDECS   10
     C                     MOVE ZECODE    ZECODE  1
     C                     MOVE *BLANKS   ZOUT21 21
     C*
     C*       SET UP WORK FIELDS
     C*
     C                     Z-ADD0         ZS1
     C                     MOVE ' '       ZS2
     C*
     C                     Z-ADD15        Z1      20
     C                     Z-ADD20        Z2      20
     C*
     C           15        SUB  ZDECS     ZINTS   20
     C*
     C* Check if numeric field is negative
     C*
     C           ZFLD15    IFLT *ZEROS
     C                     MOVE '-'       ZS2,21
     C                     Z-SUBZFLD15    ZFLD15
     C                     END
     C*
     C                     Z-ADDZFLD15    WORK15
     C*
     C*       CHECK TO SEE IF THERE ARE ANY DECIMAL PLACES
     C*
     C           ZDECS     CABEQ0         ZS10
     C*
     C*       SET UP DECIMALS
     C*
     C                     Z-ADD*ZEROS    ZCNT    10
     C           ZCNT      DOUEQZDECS
     C                     MOVE ZS1,Z1    ZS2,Z2
     C                     SUB  1         Z2
     C                     ADD  1         ZCNT
     C                     SUB  1         Z1
     C                     END
     C*
     C*       PUT IN DECIMAL PLACE
     C*
     C                     MOVE '.'       ZS2,Z2
     C                     SUB  1         Z2
     C*
     C           ZS10      TAG                             ** ZS10 TAG **
     C*
     C*       SET UP INTEGERS
     C*
     C                     Z-ADD*ZEROS    CNT3    10
     C           Z1        DOUEQ*ZEROS
     C                     MOVE ZS1,Z1    ZS2,Z2
     C                     SUB  1         Z1
     C                     SUB  1         Z2
     C*
     C* If edit code is 'J', insert a ',' before each group of three
     C* digits - not if beginning of array reached.
     C*
     C           Z2        IFGT *ZEROS
     C           ZECODE    ANDEQ'J'
     C                     ADD  1         CNT3
     C           CNT3      IFEQ 3
     C                     MOVE ','       ZS2,Z2
     C                     SUB  1         Z2
     C                     Z-ADD*ZEROS    CNT3
     C                     END
     C                     END
     C*
     C                     END
     C*
     C*       PUT IN LEADING BLANKS
     C*
     C                     Z-ADD1         Z2
     C           ZS2,Z2    DOWEQ'0'
     C           ZS2,Z2    OREQ ' '
     C           ZS2,Z2    OREQ ','
     C                     MOVE ' '       ZS2,Z2
     C                     ADD  1         Z2
     C           Z2        CABEQ22        ZS20
     C                     END
     C*
     C*       IF NO INTEGERS PUT IN LEADING ZERO
     C*
     C           ZS20      TAG                             ** ZS20 TAG **
     C*
     C           Z2        IFEQ 22
     C                     SUB  2         Z2
     C                     MOVE '0'       ZS2,Z2
     C                     ELSE
     C*
     C           ZS2,Z2    IFEQ '.'
     C                     SUB  1         Z2
     C                     MOVE '0'       ZS2,Z2
     C                     END
     C                     END
     C*
     C*       SET UP OUTPUT FIELD
     C*
     C                     MOVEAZS2       ZOUT21
     C*
     CSR                   ENDSR
     C*****************************************************************
     C/EJECT
     C********************************************************************
     C**
     C**   ZALIGN SR. TO VALIDATE AND RIGHT-ALIGN NUMERIC FIELDS.
     C**
     C           ZALIGN    BEGSR                           *** ZALIGN ***
     C**
     C                     SETOF                     929399
     C**
     C**   SAVE INPUT FIELD IN ARRAY, ZA1.
     C                     MOVEAZFIELD    ZA1
     C**
     C**   CALCULATION TO DEFINE NUMBER STRUCTURE CONTROL FIELDS.
     C                     Z-ADDZADIG     ZADIG   20
     C                     Z-ADDZADEC     ZADEC   10
     C**
     C**   CALCULATIONS TO DEFINE/CLEAR FIELDS.
     C                     MOVE ' '       ZA2
     C                     MOVEAZA2       ZFIELD 16
     C                     Z-ADD0         ZX      20
     C                     Z-ADD0         ZY      20
     C**
     C**   ENSURE REQUIRED STRUCTURE OF FIELD IS VALID.
     C           ZADIG     ADD  ZADEC     ZZ      20
     C           ZZ        COMP 15                   99
     C   99                GOTO ZAEND
     C**
     C**   LOOP TO FIND DECIMAL POINT, BLANKS AND CHARACTERS.
     C           ZATAG1    TAG                             ** ZATAG1 TAG *
     C           ZX        ADD  1         ZX
     C**
     C**   CHECK FOR DECIMAL POINT. ERROR IF SECOND DECIMAL POINT.
     C           ZA1,ZX    COMP '.'                      90
     C   90 93             SETON                     99
     C   99                GOTO ZAEND
     C**
     C**
     C**   CHECK FOR 'M' CONSTANT. ERROR IF NOT LAST CHARACTER ENTERED
     C           ZA1,ZX    COMP 'M'                      96
     C   96                DO
     C           ZX        COMP 15                   99  99
     C   99                GOTO ZAEND
     C           ZX        ADD  1         ZX
     C           ZA1,ZX    COMP ' '                  9999
     C   99                GOTO ZAEND
     C           ZX        SUB  1         ZX
     C           ZX        COMP 9                    99
     C   99                GOTO ZAEND
     C                     END
     C**
     C**   CHECK FOR 'T' CONSTANT. ERROR IF NOT LAST CHARACTER ENTERED
     C           ZA1,ZX    COMP 'T'                      97
     C   97                DO
     C           ZX        COMP 15                   99  99
     C   99                GOTO ZAEND
     C           ZX        ADD  1         ZX
     C           ZA1,ZX    COMP ' '                  9999
     C   99                GOTO ZAEND
     C           ZX        SUB  1         ZX
     C           ZX        COMP 12                   99
     C   99                GOTO ZAEND
     C                     END
     C**
     C**   CLEAR ALPHAMERIC CONSTANT FROM ZA1
     C   96
     COR 97                MOVE ' '       ZA1,ZX
     C**
     C**   CHECK FOR BLANKS. BYPASS FOR FIRST BLANK AFTER A DIGIT.
     C           ZA1,ZX    COMP ' '                      91
     C   91 92             GOTO ZATAG2
     C**
     C**   CHECK FOR NUMERIC, IF NOT '.' OR ' '.
     C  N90N91   ZA1,ZX    COMP '0'                    99
     C  N90N91N99ZA1,ZX    COMP '9'                  99
     C   99                GOTO ZAEND                      NOT NUMERIC
     C**
     C**   STORE DIGITS IN ARRAY AND HOW MANY.
     C**   ZY, TOTAL OF DIGITS IN THE INPUT FIELD.
     C**   ZZ, TOTAL OF DIGITS TO THE LEFT OF DECIMAL POINT.
     C  N90N91   ZY        ADD  1         ZY         92
     C  N90N91             MOVE ZA1,ZX    ZA2,ZY
     C   90                Z-ADDZY        ZZ         93  93
     C**
     C           ZX        COMP 16                     94  CHECK IF ALL
     C   94                GOTO ZATAG1
     C**
     C           ZATAG2    TAG                             ** ZATAG2 TAG *
     C**
     C**   IF 'M' SPECIFIED, MULTIPLY ZA1 BY 1 MILLION
     C   96      ZZ        ADD  6         ZZ
     C**
     C**   IF 'T' SPECIFIED, MULTIPLY ZA1 BY 1 THOUSAND
     C   97      ZZ        ADD  3         ZZ
     C**
     C**   FILL IN ZEROS IN ANY BLANKS LEFT OF DECIMAL POINT
     C   96 93
     COR 97 93   ZZ        DOWGTZY
     C           ZY        ADD  1         ZY
     C                     MOVE '0'       ZA2,ZY
     C                     END
     C**
     C**   IF CONSTANT SPECIFIED WITH NO DECIMAL POINT ZEROISE BLANKS
     C   96N93             DO   6
     C           ZY        ADD  1         ZY
     C                     MOVE '0'       ZA2,ZY
     C                     END
     C**
     C   97N93             DO   3
     C           ZY        ADD  1         ZY
     C                     MOVE '0'       ZA2,ZY
     C                     END
     C**
     C**   IF NO DECIMAL POINT FOUND, SET TOTAL FIELD ZZ.
     C  N93                Z-ADDZY        ZZ
     C**
     C**   CHECK FOR EMBEDDED BLANKS.
     C   91 92             MOVEAZA1,ZX    ZFIELD
     C   91 92   ZFIELD    COMP ' '                  9999
     C   99                GOTO ZAEND                      EMBEDDED BLANK
     C**
     C**   ENSURE THAT NUMBER OF DIGITS ENTERED EITHER SIDE
     C**   OF DECIMAL POINT ARE NOT MORE THAN ALLOWED.
     C           ZZ        COMP ZADIG                99
     C           ZY        SUB  ZZ        ZX
     C  N99      ZADEC     SUB  ZX        ZX           9995
     C   99                GOTO ZAEND
     C   95                GOTO ZATAG4                     NO TRAILING
     C**                                                   BLANKS.
     C**   FILL THE TRAILING BLANKS WITH ZEROS.
     C           ZY        ADD  ZX        ZZ
     C           ZATAG3    TAG                             ** ZATAG3 TAG *
     C           ZY        ADD  1         ZY
     C                     MOVE '0'       ZA2,ZY
     C           ZY        COMP ZZ                     94
     C   94                GOTO ZATAG3
     C**
     C**   RIGHT-ALIGN THE VALUE BY MOVING BACK TO ARRAY, ZA1.
     C           ZATAG4    TAG                             ** ZATAG4 TAG *
     C                     MOVE '0'       ZA1
     C                     Z-ADD16        ZX
     C           ZATAG5    TAG                             ** ZATAG5 TAG *
     C           ZY        COMP 0                        94
     C   94                GOTO ZATAG6
     C                     MOVE ZA2,ZY    ZA1,ZX
     C           ZY        SUB  1         ZY
     C           ZX        SUB  1         ZX
     C                     GOTO ZATAG5
     C           ZATAG6    TAG                             ** ZATAG6 TAG *
     C**
     C**   MOVE VALIDATED AND RIGHT-ALIGNED NUMBER BACK INTO ZFIELD.
     C                     MOVEAZA1       ZFIELD
     C**
     C                     SETOF                     9697
     C**
     C           ZAEND     ENDSR                           * ZAEND ENDSR *
     C**
     C**
     C********************************************************************
     C**
     C/EJECT
     C********************************************************************
     C**
     C**   ZDATE1 SR. TO VALIDATE DATES SUBMITTED AND
     C**              CONVERT TO A NUMBER OF DAYS.
     C**
     C**   THE YEAR 2000, BEING DIVISIBLE BY 400, IS A LEAP YEAR.
     C**
     C           ZDATE1    BEGSR                           *** ZDATE1 ***
     C**
     C**   CLEAR DAY NUMBER. RESET ERROR INDICATOR
     C                     Z-ADD0         ZDAYNO  50
     C                     SETOF                     99
     C**
     C**   CALCULATION TO DEFINE INPUT DATE FIELD.
     C                     Z-ADDZDATE     ZDATE   60
     C**
     C**   GET INDIVIDUAL DAY, MONTH AND YEAR FIELDS.
     C                     MOVE ZDATE     ZYEAR   20
     C  N98                MOVELZDATE     ZDAY    20
     C   98                MOVELZDATE     ZMTH    20
     C                     MOVE ZDATE     ZWRK4   40
     C  N98                MOVELZWRK4     ZMTH
     C   98                MOVELZWRK4     ZDAY
     C**
     C**   ENSURE MONTH IS VALID. BYPASS IF ERROR
     C           ZMTH      IFLE 0
     C           ZMTH      ORGT 12
     C                     SETON                     99
     C                     GOTO ZDEND1
     C                     END
     C**
     C**   ENSURE DAY IS VALID. BYPASS IF ERROR
     C           ZDAY      IFLE 0
     C                     SETON                     99
     C                     GOTO ZDEND1
     C                     END
     C**
     C**   CHECK FOR 30 DAY MONTHS. BYPASS IF ERROR
     C           ZMTH      IFEQ 4
     C           ZMTH      OREQ 6
     C           ZMTH      OREQ 9
     C           ZMTH      OREQ 11
     C**
     C           ZDAY      IFGT 30
     C                     SETON                     99
     C                     GOTO ZDEND1
     C                     END
     C**
     C                     ELSE
     C**
     C**   CHECK FOR 31 DAY MONTHS (ALL OTHERS BUT FEB). BYPASS IF ERROR
     C           ZDAY      IFGT 31
     C           ZMTH      ANDNE2
     C                     SETON                     99
     C                     GOTO ZDEND1
     C                     END
     C**
     C                     END
     C**
     C**   CHECK FOR LEAP YEAR: REMAINDER WILL BE ZERO IF IT IS A LEAP YR
     C           ZYEAR     ADD  28        ZYEAR
     C           ZYEAR     DIV  4         ZLYR    20
     C                     MVR            ZLY     10
     C**
     C**   IF FEBUARY FURTHER VALIDATE DAY.
     C           ZMTH      IFEQ 2
     C**
     C**   INVALID IF GREATER THAN 28 AND NOT A LEAP YEAR
     C           ZLY       IFGT 0
     C           ZDAY      ANDGT28
     C                     SETON                     99
     C                     GOTO ZDEND1                     BYPASS IF ERROR
     C                     END
     C**
     C**   INVALID IF GREATER THAN 29 AND A LEAP YEAR - BYPASS IF ERROR
     C           ZLY       IFEQ 0
     C           ZDAY      ANDGT29
     C                     SETON                     99
     C                     GOTO ZDEND1
     C                     END
     C**
     C                     END
     C**
     C**   DETERMINE NUMBER OF DAYS FROM 31/12/1971.
     C**
     C**   MULTIPLY NO. OF FOUR-YEAR SPANS, BY NO. OF DAYS IN SPAN
     C           ZLYR      MULT 1461      ZDAYNO
     C**
     C**   IF NOT A LEAP YEAR, ADD APPROPRIATE NO. OF DAYS FOR EXTRA
     C**   YEARS USING REMAINDER FIELD (IE. 1, 2 OR 3 X 356)
     C           ZLY       IFGT 0
     C           ZDAYNO    ADD  ZYDY,ZLY  ZDAYNO
     C                     END
     C**
     C**   IF IT IS A LEAP YEAR, AND LATER THAN FEBRUARY, ADD ONE FOR
     C**   29TH OF FEB
     C           ZLY       IFEQ 0
     C           ZMTH      ANDGT2
     C           ZDAYNO    ADD  1         ZDAYNO
     C                     END
     C**
     C**   ADD APPROPRIATE NUMBER OF DAYS FOR THE MONTH NUMBER
     C           ZDAYNO    ADD  ZMDY,ZMTH ZDAYNO
     C**
     C**   ADD NUMBER OF DAYS IN MONTH
     C           ZDAYNO    ADD  ZDAY      ZDAYNO
     C**
     C           ZDEND1    ENDSR                           * ZDEND1 ENDSR*
     C**
     C**
     C********************************************************************
     C********************************************************************
     C**
     C**   ZDATE2 SR. TO CONVERT A DAY NUMBER TO DATE FORMATS.
     C**
     C**   THE YEAR 2000, BEING DIVISIBLE BY 400, IS A LEAP YEAR.
     C**
     C           ZDATE2    BEGSR                           *** ZDATE2 ***
     C**
     C**   CLEAR LEAP YEAR WORK FIELD.
     C                     MOVE 'N'       ZLEAP   1
     C**
     C**   CLEAR DATE FIELDS.
     C                     Z-ADD0         ZDATE   60
     C                     MOVEL'       ' ZADATE  7
     C**
     C**   CALCULATION TO DEFINE INPUT DAY NUMBER.
     C                     Z-ADDZDAYNO    ZDAYNO  50
     C**
     C**   DETERMINE YEAR NUMBER.
     C**
     C**   ADJUST DAY NUMBER IN CASE LAST DAY OF YEAR.
     C           ZDAYNO    SUB  1         ZDAYN1  50
     C           ZDAYN1    IFLT 0
     C                     GOTO ZDEND2
     C                     END
     C**
     C**   CALCULATE NUMBER OF 4 YEAR SPANS SINCE 31/12/1971.
     C           ZDAYN1    DIV  1461      ZLYR    20
     C                     MVR            ZDAYN1           SAVE REMAINING
     C**                                                   DAYS
     C**   CALCULATE NUMBER OF REMAINING YEARS.
     C                     Z-ADD1         ZWRK2   20
     C           ZDTAG1    TAG                             ** ZDTAG1 TAG *
     C           ZDAYN1    IFGE ZYDY,ZWRK2
     C           ZWRK2     ADD  1         ZWRK2
     C                     GOTO ZDTAG1
     C                     END
     C*
     C           ZWRK2     SUB  1         ZWRK2
     C**
     C**   DECREMENT DAY NO. BY DAYS IN REMAINING YEARS.
     C           ZWRK2     IFNE 0
     C           ZDAYN1    SUB  ZYDY,ZWRK2ZDAYN1
     C                     END
     C**
     C**   CALCULATE ACTUAL YEAR NUMBER.
     C           ZLYR      MULT 4         ZWRK3   30
     C           ZWRK3     ADD  72        ZWRK3            BASE IS 1972
     C                     Z-ADDZWRK3     ZYEAR   20
     C           ZYEAR     ADD  ZWRK2     ZYEAR            YEAR
     C**
     C**   DETERMINE MONTH NUMBER.
     C**
     C**   ADJUST DAY NO. IN CASE LAST DAY OF LEAP YEAR FEBRUARY.
     C           ZWRK2     IFEQ 0
     C           ZDAYN1    IFEQ 59
     C                     MOVE 'Y'       ZLEAP
     C                     END
     C           ZDAYN1    IFGE 59
     C           ZDAYN1    SUB  1         ZDAYN1
     C                     END
     C                     END
     C**
     C**   CALCULATE MONTH NUMBER.
     C                     Z-ADD2         ZWRK2
     C           ZDTAG2    TAG                             ** ZDTAG2 TAG *
     C           ZDAYN1    IFGE ZMDY,ZWRK2
     C           ZWRK2     ADD  1         ZWRK2
     C                     GOTO ZDTAG2
     C                     END
     C*
     C           ZWRK2     SUB  1         ZWRK2
     C**
     C                     Z-ADDZWRK2     ZMTH    20       MONTH
     C**
     C**   DETERMINE DAY OF MONTH.
     C**
     C**   ADD BACK LAST DAY OF YEAR ADJUSTMENT.
     C           ZDAYN1    ADD  1         ZDAYN1
     C**
     C**   CALCULATE DAY OF MONTH.
     C           ZDAYN1    SUB  ZMDY,ZWRK2ZDAY    20       DAY
     C**
     C**   ADD BACK LEAP YEAR 29TH FEBUARY ADJUSTMENT, IF REQUIRED.
     C           ZLEAP     IFEQ 'Y'
     C           ZDAY      ADD  1         ZDAY
     C                     END
     C**
     C**   FORMAT DATE, DDMMYY OR MMDDYY.
     C  N98                MOVELZDAY      ZWRK4   40
     C   98                MOVE ZDAY      ZWRK4
     C  N98                MOVE ZMTH      ZWRK4
     C   98                MOVELZMTH      ZWRK4
     C                     MOVELZWRK4     ZDATE
     C                     MOVE ZYEAR     ZDATE
     C**
     C**   FORMAT ALPHA DATE, DDMMMYY.
     C                     MOVELZDAY      ZWRK5   5
     C           ZDAY      IFLT 10
     C                     MOVEL' '       ZWRK5
     C                     END
     C                     MOVE ZMNM,ZMTH ZWRK5
     C                     MOVELZWRK5     ZADATE
     C                     MOVE ZYEAR     ZADATE
     C**
     C           ZDEND2    ENDSR                           * ZDEND2 ENDSR*
     C**
     C**
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** ZASNMS    - SEND MESSAGE TO PROGRAM'S MESSAGE QUEUE             *
     C**                                                                 *
     C** CALLS     - Y2SNMGC                                             *
     C**                                                                 *
     C** CALLED BY - #BA, #BAA, #BBA, #ZAA, #ZAB                         *
     C**                                                                 *
     C********************************************************************
     C           ZASNMS    BEGSR                           ** ZASNMS    **
     C*
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGM  10
     C                     PARM           ZAPGRL  5
     C                     PARM           ZAMSID  7
     C                     PARM           ZAMSGF 10
     C                     PARM           ZAMSDA132
     C                     PARM           ZAMSTP  7
     C*
     C                     ENDSR
     C/COPY ZSRSRC,ZCCYGBZ1                                               48200
     C/COPY ZSRSRC,ZCCYCN
     C****/COPY ZSRSRC,ZCCYXR                                             47719
     C/COPY WNCPYSRC,SE6050C010
     C********************************************************************
     C/EJECT
     C********************************************************************
     C**                                                                 *
     C** *PSSR     - PROGRAM ERROR HANDLING ROUTINE                      *
     C**                                                                 *
     C** CALLS     - NONE                                                *
     C**                                                                 *
     C** CALLED BY - #ZAA                                                *
     C**                                                                 *
     C********************************************************************
     C           *PSSR     BEGSR
     C*
     C                     DUMP
     C*
     C                     ROLBK
     C*
     C                     MOVE '1'       *INLR
     C*
     C                     RETRN
     C*
     C                     ENDSR
     C********************************************************************
     C/EJECT
     O*****************************************************************
     O/EJECT
** CPY@
(c) Finastra International Limited 2001
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
