     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE ER Blocked Positions Exceptions Rep.')
     F*****************************************************************
     F*                                                               *
     F*  Midas - Securities Trading Module                        *
     F*                                                               *
     F*  SE6830 - SE ER Blocked Positions Exceptions Report           *
     F*                                                               *
      *  (c) Finastra International Limited 2001                      *
     F*                                                               *
      *  Last Amend No. MD058285           Date 22Jun21               *
      *  Prev Amend No. AR1075401          Date 01Jun20               *
      *                 MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4 --------------- Base -------------------------*
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CPB001             Date 26Aug99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CEU017             Date 03Avr98               *
     F*                 CSE007             Date 05Jan98               *
     F*                 S01496             Date 04Oct94               *
     F*                 S10978             Date 30Mar93               *
     F*                                                               *
     F*---------------------------------------------------------------*
     F*                                                               *
      *  MD058285 - Change base rate code to alphanumeric (Recompile) *
      *  AR1075401 - Increase QANOML and QAOTNM length in PMCPOSPD.   *
      *              Recompiled. (Child: AR1075402)                   *
      *  MD046248 - Finastra Rebranding                               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CGL029 - Increase Account Code to 10 digits                  *
     F*  CPB001 - 'Private Banking' Module                            *
     F*  CEU017 - Securities Redenomination Euro Changes              *
     F*  CSE007 - Corporate Actions                                   *
     F*  S01496 - Incorporation of Jyske Enhancements (S10978)        *
     F*  S10978 - JYSZRH: EARLY REDEMPTIONS                           *
     F*                                                               *
     F*****************************************************************
     F*  C R E A T I O N     P A R A M E T E R S                      *
     F*                                                               *
     F*                                                               *
     F*****************************************************************
      /EJECT
     F*
     F*****BJ*-*Bank*Details*-*Rtv*Idx*********************************   S01496
     F***SDBANKL1IF**E           K        DISK                            S01496
     F***********                                   KINFSR *PSSR          S01496
     F*
     F**   Securities Details
     FSECTY   IF  E           K        DISK
     F                                              KINFSR *PSSR
     F*
     F**   VD - SE ER Block Positions
     F***SEBKALL2IF**E           K        DISK                            S01496
     FSEBKALL5IF  E           K        DISK                               S01496
     F                                              KINFSR *PSSR
     F*
     F**   SE Customer Position
     FCPOSN   IF  E           K        DISK
     F                                              KINFSR *PSSR
     F*
     F**   PM Portfolio Positions
     FPMCPOSL0IF  E           K        DISK
     F                                              KINFSR *PSSR
     F*
     F*****Portfolio*Management*ICD*-*Rtv*Idx**************************   S01496
     F***SDPORTL1IF**E           K        DISK                            S01496
     F***********                                   KINFSR *PSSR          S01496
     F*
     F*****Modules*Details*-*Rtv*Idx***********************************   S01496
     F***SDMMODL1IF**E           K        DISK                            S01496
     F***********                                   KINFSR *PSSR          S01496
     F*
     F**   Printer file - SE ER Blocked Positions Exceptions List
     F***SE6830P1O***E             70     PRINTER                         S01496
     FSE6830P1O   E             70     PRINTER      KINFDS SPOOL      UC  S01496
     F                                              KINFSR *PSSR
     F*                                                                   S01496
     F**   Printer file - SE ER Blocked Positions Exceptions List         S01496
     FSE6830AUO   E                    PRINTER      KINFDS SPOOLU     UC  S01496
     F                                              KINFSR *PSSR          S01496
     ******************************************************************
      /EJECT
     *********************************************************************
      *
      * ID F  C  H  L    Function of indicators
      * ---------------------------------------
      *
      *   03 - Record format SECOALD0 read.                               CSE007
      *                                                                   CSE007
      *   45 - Portfolio management indicator                             S01496
      *                                                                   S01496
      *   50 - 0 Decimal Place
      *   51 - 1 Decimal Place
      *   52 - 2 Decimal Places
      *   53 - 3 Decimal Places
      *   54 - 4 Decimal Places
      *
      *   55 - Multibranching indicator                                   S01496
      *   56 - Branch level indicator                                     S01496
      *                                                                   S01496
      *   60 - Feature CSE007 is switched ON.                             CSE007
      *                                                                   CSE007
      *   70 - Page Overflow
      *
      *   87,88 - Work Indicator
      *
      *   89 - Record not Found
      *
      *   LR :    Last record
      *   U7/U8 : Database error
      *
      *   90-99 : Used by Standard Subroutines
      **************************************************************************
      /EJECT
      **************************************************************************
      *
      * Name of the Subroutines
      * -----------------------
      *
      *       P001  - Initial processing
      *       P002  - Main processing
      *       P003  - Termination processing
      *       P004  - Obtain Number of Decimal Places for a Security
      *       P005  - Obtain Current Trade Position
      *
      *       R001  - Output Details to Printer File
      *
      *       #LBRPR -  Process a change in branch                        S01496
      *       #LZSFL -  Call ZSFILE                                       S01496
      *                                                                   S01496
      *       *PSSR - "Standard" Database error processing
      *
      **************************************************************************
      /EJECT
     *********************************************************************
      *                                                                   CSE007
     E/COPY ZSRSRC,ZDATE2Z1                                               CSE007
     E*
     E**   FOR COMPILATION - COPYRIGHT INSERTION
     E*
     E                    CPY@    1   1 80
     *********************************************************************
      /EJECT
     *********************************************************************
     ISEERALD0
     I              VCRECI                          XXRECI
     I              VCBRCD                          XXBRCD
     I              VCCNUM                          XXCNUM
     I              VCPTFR                          XXPTFR
     I              VCERTP                          XXBLTY
     I              VCSESN                          XXSESN
     I              VCNOMA                          XXNOMB
     I              VCBEDT                          XXBEDT                S01496
     I*
     ISEBLKPD0
     I              VDRECI                          XXRECI
     I              VDBRCD                          XXBRCD
     I              VDCNUM                          XXCNUM
     I              VDPTFR                          XXPTFR
     I              VDBLTY                          XXBLTY
     I              VDSESN                          XXSESN
     I              VDNOMB                          XXNOMB
     I              VDBEDT                          XXBEDT                S01496
     I              VDBSTT                          XXBSTT                CSE007
     I              VDEWIN                          XXEWIN                CSE007
      *                                                                   CSE007
     ISECOALD0    03                                                      CSE007
     I              MCRECI                          XXRECI                CSE007
     I              MCCNUM                          XXCNUM                CSE007
     I              MCPTFR                          XXPTFR                CSE007
     I              MCBLTY                          XXBLTY                CSE007
     I              MCBSEC                          XXSESN                CSE007
     I              MCBEDT                          XXBEDT                CSE007
     I              MCBRCD                          XXBRCD                CSE007
     I              MCBSTT                          XXBSTT                CSE007
     I              MCBEWI                          XXEWIN                CSE007
     ISECOBKD0                                                            CSE007
     I              MURECI                          XXRECI                CSE007
     I              MUCNUM                          XXCNUM                CSE007
     I              MUPTFR                          XXPTFR                CSE007
     I              MUBLTY                          XXBLTY                CSE007
     I              MUSESN                          XXSESN                CSE007
     I              MUNOMB                          XXNOMB                CSE007
     I              MUBEDT                          XXBEDT                CSE007
     I              MUBRCD                          XXBRCD                CSE007
     I              MUBSTT                          XXBSTT                CSE007
     I              MUBEWI                          XXEWIN                CSE007
     I*
     I**   DATA STRUCTURE FOR COMPILATION - COPYRIGHT INSERTION
     I*
     ICPYR@#      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@##
     I*
     I**   DATA STRUCTURE FOR DATABASE ERROR
     I*
     ILDA         DS                            256
     I                                      132 183 WWLOT
     I                                      132 141 WWFILE
     I                                      142 170 WWKEY
     I                                      171 180 WWPGM
     I                                      181 1830WWASE
     I*                                                                   S01496
     ISPOOL       DS                                                      S01496
     I**  File Information Data Structure - P1 report                     S01496
     I*                                                                   S01496
     I                                       83  92 SFILE1                S01496
     I                                    B 123 1240SFNUM1                S01496
     ISPOOLU      DS                                                      S01496
     I**  File Information Data Structure - AU report                     S01496
     I*                                                                   S01496
     I                                       83  92 SFILEU                S01496
     I                                    B 123 1240SFNUMU                S01496
     I*                                                                   S01496
     ISDBANK    E DSSDBANKPD                                              S01496
     I**  Data structure for bank details                                 S01496
     I*                                                                   S01496
     ISDBRCH    E DSSDBRCHPD                                              S01496
     I**  Data structure for branch details                               S01496
     I*                                                                   S01496
     ISDMMOD    E DSSDMMODPD                                              S01496
     I**  Data structure for module details                               S01496
     I*                                                                   S01496
     ISDPORT    E DSSDPORTPD                                              S01496
     I**  Data structure for portfolio management details                 S01496
     I*                                                                   S01496
     IDSSDY     E DSDSSDY                                                 S01496
     I**  Long data structure for access objects                          S01496
     I*                                                                   S01496
     *********************************************************************
      /EJECT
     C********************************************************************
     C**    P R O G R A M   S T A R T
     C********************************************************************
     C*                                                                   S01496
     C**  Entry parameters                                                S01496
     C*                                                                   S01496
     C           *ENTRY    PLIST                                          S01496
     C                     PARM           @RSEQ   5                       S01496
     C                     PARM           @RLEV   1                       S01496
     C                     PARM           @RENT   3                       S01496
     C*
     C**   INITIAL PROCESSING
     C*
     C                     EXSR P001
     C*
     C**   MAIN PROCESSING
     C*
     C                     EXSR P002
     C*
     C**   TERMINATION PROCESSING
     C*
     C                     EXSR P003
     C*
     C********************************************************************
     C**    P R O G R A M     E N D
     C********************************************************************
      /EJECT
     ******************************************************************
     C* P001   : INITIAL PROCESSING                                   *
     ******************************************************************
     C*
     C           P001      BEGSR
     C*                                                                   S01496
     C**  Copyright statement                                             S01496
     C*                                                                   S01496
     C                     MOVEACPY@      ACT@   80                       S01496
     C*                                                                   S01496
     C**  Check report level                                              S01496
     C*                                                                   S01496
     C           @RLEV     IFEQ 'B'                                       S01496
     C                     MOVE '1'       *IN56                           S01496
     C                     END                                            S01496
     C*
     C**   INITIALISE KEY AND WORKING FIELDS
     C*
     C                     MOVE *BLANKS   WWLOT
     C                     MOVEL'SE6830'  DBPGM  10
     C*
     C***********          MOVE *BLANKS   WBRCD   30                      S01496
     C                     MOVE *BLANKS   WBRCD   3                       S01496
     C**********           MOVE *BLANKS   WCNUM   60                                          CSD027
     C                     MOVE *BLANKS   WCNUM   6                                           CSD027
     C                     MOVE *BLANKS   WPTFR   4
     C                     MOVE *BLANKS   WSESN  10
     C                     MOVE *BLANKS   WBLTY   1
     C*
     C                     MOVE 'Y'       WNODET  1
     C*
     C**   KEY FIELDS
     C*
     C           KEY1      KLIST
     C***********          KFLD           KBRCD   30                      S01496
     C                     KFLD           KBRCD   3                       S01496
     C                     KFLD           KSESN  10
     C**********           KFLD           KCNUM   60                                          CSD027
     C                     KFLD           KCNUM   6                                           CSD027
     C*
     C           KEY2      KLIST
     C                     KFLD           KSESN
     C                     KFLD           KCNUM
     C                     KFLD           KTVDA   1
     C                     KFLD           KPTFR   4
     C*
     C**   ACCESS TO BANK DETAILS TO RETRIEVE THE MIDAS RUN DATE
     C*
     C************LOVAL    SETLLSDBANKL1                                  S01496
     C***********          READ SDBANKL1                 89               S01496
     C*                                                                   S01496
     C                     CALL 'AOBANKR0'                                S01496
     C                     PARM *BLANKS   WLRTCD  7                       S01496
     C                     PARM '*FIRST'  WLOPTN  7                       S01496
     C           SDBANK    PARM SDBANK    DSSDY                           S01496
     C*
     C**   IF RECORD NOT FOUND
     C*
     C************IN89     IFEQ '1'                        B*1            S01496
     C           WLRTCD    IFNE *BLANKS                                   S01496
     C                     MOVEL'001'     DBASE   30       *****************
     C***********          MOVEL'SDBANKL1'DBFILE 10        ** DB ERROR 01 S01496
     C                     MOVE 'SDBANKPD'DBFILE 10        * DB ERROR 01 *S01496
     C                     MOVEL*BLANKS   DBKEY  29        *****************
     C                     EXSR *PSSR
     C                     END                             E*1
     C*
     C**   DETERMINE DATE FORMAT
     C*
     C           BJDFIN    IFEQ 'M'                        B*1
     C                     MOVE '1'       *IN98
     C                     END                             E*1
     C*
     C*****OUTPUT*TITLE*TO*REPORT**************************************   S01496
     C*
     C***********          WRITEHEADER                                    S01496
     C*
     C**   ACCESS TO MODULES DETAILS FILE TO RETRIEVE THE 'PORTFOLIO
     C**   MANAGEMENT INDICATOR'
     C*
     C************LOVAL    SETLLSDMMODL1                                  S01496
     C***********          READ SDMMODL1                 89               S01496
     C*                                                                   S01496
     C                     CALL 'AOMMODR0'                                S01496
     C                     PARM *BLANKS   WLRTCD                          S01496
     C                     PARM '*FIRST'  WLOPTN                          S01496
     C           SDMMOD    PARM SDMMOD    DSSDY                           S01496
     C*
     C**   IF RECORD NOT FOUND
     C*
     C************IN89     IFEQ '1'                        B*1            S01496
     C           WLRTCD    IFNE *BLANKS                                   S01496
     C                     MOVEL'002'     DBASE            *****************
     C***********          MOVEL'SDMMODL1'DBFILE           ** DB ERROR 02 S01496
     C                     MOVE 'SDMMODPD'DBFILE           * DB ERROR 02 *S01496
     C                     MOVEL*BLANKS   DBKEY            *****************
     C                     EXSR *PSSR
     C                     END                             E*1
     C*                                                                   S01496
     C**  Setup multibranching indicator                                  S01496
     C*                                                                   S01496
     C           BGMBIN    IFEQ 'Y'                                       S01496
     C                     MOVE '1'       *IN55                           S01496
     C                     ELSE                                           S01496
     C*                                                                   S01496
     C**  Else, setup appropriate level and entity                        S01496
     C                     MOVE 'S'       @RLEV                           S01496
     C                     MOVE *BLANKS   @RENT                           S01496
     C                     MOVE '0'       *IN56                           S01496
     C                     END                                            S01496
     C*
     C**   IF 'PORTFOLIO MANAGEMENT' PRESENT
     C*
     C           BGPFMG    IFEQ 'Y'                        B*1
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C*                                                                   S01496
     C**  Setup the portfolio management indicator                        S01496
     C*                                                                   S01496
     C                     MOVE '1'       *IN45                           S01496
     C*
     C**   ACCESS TO PORTFOLIO MANAGEMENT FILE TO RETRIEVE THE 'REFERENCE
     C**   ATTACHED TO "9997"'
     C*
     C************LOVAL    SETLLSDPORTL1                                  S01496
     C***********          READ SDPORTL1                 89               S01496
     C*                                                                   S01496
     C           BGPFMG    IFEQ 'Y'                                       CPB001
     C                     CALL 'AOPORTR0'                                S01496
     C                     PARM *BLANKS   WLRTCD                          S01496
     C                     PARM '*FIRST'  WLOPTN                          S01496
     C           SDPORT    PARM SDPORT    DSSDY                           S01496
     C*
     C**   IF RECORD NOT FOUND
     C*
     C************IN89     IFEQ '1'                        B*2            S01496
     C           WLRTCD    IFNE *BLANKS                                   S01496
     C                     MOVEL'003'     DBASE            *****************
     C***********          MOVEL'SDPORTL1'DBFILE           ** DB ERROR 03 S01496
     C                     MOVE 'SDPORTPD'DBFILE           * DB ERROR 03 *S01496
     C                     MOVEL*BLANKS   DBKEY            *****************
     C                     EXSR *PSSR
     C                     END                             E*2
     C                     END                             E*1
     C                     ENDIF                                          CPB001
      *                                                                   CSE007
      ***  Call access program to access Switchable Features Details.     CSE007
      *                                                                   CSE007
     C                     MOVE 'N'       CSE007  1                       CSE007
     C                     MOVE '0'       *IN60                           CSE007
     C                     CALL 'AOSARDR0'                                CSE007
     C                     PARM '       ' @RTCD   7                       CSE007
     C                     PARM '*VERIFY' @OPTN   7                       CSE007
     C                     PARM 'CSE007'  @SARD   6                       CSE007
      *                                                                   CSE007
      ***  If feature CSE007 is switched ON.                              CSE007
      *                                                                   CSE007
     C           @RTCD     IFEQ *BLANKS                                   CSE007
     C                     MOVE 'Y'       CSE007                          CSE007
     C                     MOVE '1'       *IN60                           CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CEU017
      ***  Call access program to access Switchable Features Details.     CEU017
      *                                                                   CEU017
     C                     MOVE 'N'       CEU017  1                       CEU017
     C                     CALL 'AOSARDR0'                                CEU017
     C                     PARM '       ' @RTCD   7                       CEU017
     C                     PARM '*VERIFY' @OPTN   7                       CEU017
     C                     PARM 'CEU017'  @SARD   6                       CEU017
      *                                                                   CEU017
      ***  If feature CEU017 is switched ON.                              CEU017
      *                                                                   CEU017
     C           @RTCD     IFEQ *BLANKS                                   CEU017
     C                     MOVE 'Y'       CEU017                          CEU017
     C                     MOVE '1'       *IN60                           CEU017
     C                     ENDIF                                          CEU017
     C*
     C                     ENDSR
      *****************************************************************
      /EJECT
     ******************************************************************
     C* P002   : MAIN PROCESSING                                      *
     ******************************************************************
     C*
     C           P002      BEGSR
     C*
     C                     MOVE 'Y'       WNOREC  1
     C*
     C*****ACCESS*FIRST*RECORD*TO*RETREIVE*FIRST*BLOCK*****************   S01496
     C***********                                                         S01496
     C***********BJRDNB    SETLLSEBKALL2                                  S01496
     C***********          READ SEBKALL2                 88               S01496
     C*                                                                   S01496
     C**  Access first record only if 'ALL' branches selected or          S01496
     C**  system level is requested                                       S01496
     C*                                                                   S01496
     C                     MOVE '0'       *IN03                           CSE007
      *                                                                   CSE007
     C           @RENT     IFEQ 'ALL'                                     S01496
     C           @RENT     OREQ *BLANKS                                   S01496
     C           *LOVAL    SETLLSEBKALL5                                  S01496
     C                     READ SEBKALL5                 88               S01496
     C                     ELSE                                           S01496
     C*                                                                   S01496
     C**  Else, use the selected branch (entity) as key                   S01496
     C*                                                                   S01496
     C           @RENT     SETLLSEBKALL5                                  S01496
     C           @RENT     READESEBKALL5                 88               S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C**  Select only those records which are not less than rundate       S01496
     C*                                                                   S01496
     C           *IN88     DOWEQ'0'                                       S01496
     C           XXBEDT    ANDLTBJRDNB                                    S01496
     C*                                                                   S01496
     C                     MOVE '0'       *IN03                           CSE007
     C           @RENT     IFEQ 'ALL'                                     S01496
     C           @RENT     OREQ *BLANK                                    S01496
     C                     READ SEBKALL5                 88               S01496
     C                     ELSE                                           S01496
     C           @RENT     READESEBKALL5                 88               S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     END                                            S01496
     C*
     C**   INITIALISE SAVED BRANCH, CUSTOMER, PORTFOLIO, SECURITY, BLOCK TYPE
     C**   FIELDS WITH CONTENTS OF RECORD READ
     C*
     C***********          Z-ADDXXBRCD    WBRCD                           S01496
     C                     MOVE XXBRCD    WBRCD                           S01496
     C**********           Z-ADDXXCNUM    WCNUM                                               CSD027
     C                     MOVE XXCNUM    WCNUM                                               CSD027
     C                     MOVE XXPTFR    WPTFR
     C                     MOVE XXSESN    WSESN
     C                     MOVE XXBLTY    WBLTY
     C*
     C**   WHILE "END OF FILE" IS NOT REACHED
     C*
     C           *IN88     DOWEQ'0'                        B*1
     C*                                                                   S01496
     C**  Blocked end date should be greater than or equal to rundate     S01496
     C*                                                                   S01496
     C           XXBEDT    IFGE BJRDNB                                    S01496
     C*
     C                     MOVE 'N'       WNOREC
     C*
     C**   IF RECORD READ IS NOT FOR SAME BRANCH, CUSTOMER, PORTFOLIO,
     C**   SECURITY AND BLOCK TYPE
     C*
     C           XXBRCD    IFNE WBRCD                      B*2
     C           XXCNUM    ORNE WCNUM
     C           XXPTFR    ORNE WPTFR
     C           XXSESN    ORNE WSESN
     C           XXBLTY    ORNE WBLTY
     C*
     C**   RETRIEVE CURRENT TRADE POSITION
     C*
     C                     EXSR P005
     C*
     C**   IF RETURN INDICATOR IS OFF
     C*
     C           WRTCD     IFEQ 'Y'                        B*3
     C*
     C**   IF BLOCK TYPE IS 'P' AND 'TOTAL BLOCKED NOMINAL' IS GREATER THAN
     C**   'CURRENT TRADE POSITION' OR
     C**   IF BLOCK TYPE IS 'S' AND 'TOTAL BLOCKED NOMINAL' IS LOWER   THAN
     C**   'CURRENT TRADE POSITION'
     C*
     C           WBLTY     IFEQ 'P'                        B*4
     C           WTBNP     ANDGTWCTPP
     C           WBLTY     OREQ 'S'
     C           WTBNP     ANDLTWCTPP
     C*                                                                   S01496
     C**  Process a change in branch                                      S01496
     C*                                                                   S01496
     C           WBRCD     IFNE RRBRCA                                    S01496
     C                     EXSR #LBRPR                                    S01496
     C                     END                                            S01496
     C*
     C**   IF THE OVERFLOW INDICATOR IS ON
     C*
     C           *IN70     IFEQ '1'                        B*5
     C                     WRITEHEADER
     C                     MOVE '0'       *IN70
     C                     END                             E*5
     C*
     C           WSESN     IFNE *BLANKS                    B*5
     C*
     C**   ACCESS TO SECURITY DETAILS TO RETRIEVE THE NOMINAL DECIMAL PLACES
     C*
     C                     EXSR P004
     C                     END                             E*5
     C*
     C**   OUTPUT A DETAIL LINE
     C*
     C                     EXSR R001
     C                     END                             E*4
     C                     END                             E*3
     C*
     C**   RESET TO ZERO 'TOTAL BLOCKED NOMINAL'
     C*
     C                     Z-ADD*ZEROS    WTBNP  130
     C*
     C***********          Z-ADDXXBRCD    WBRCD                           S01496
     C                     MOVE XXBRCD    WBRCD                           S01496
     C**********           Z-ADDXXCNUM    WCNUM                                               CSD027
     C                     MOVE XXCNUM    WCNUM                                               CSD027
     C                     MOVE XXPTFR    WPTFR
     C                     MOVE XXSESN    WSESN
     C                     MOVE XXBLTY    WBLTY
     C                     END                             E*2
     C*
     C**   ADD 'BLOCKED NOMINAL' TO 'TOTAL BLOCKED NOMINAL'
     C*
      ***  If record is read from SECOALPD.                               CSE007
      *                                                                   CSE007
     C           *IN03     IFEQ '1'                                       CSE007
     C                     ADD  MCEXPO    WTBNP                           CSE007
     C                     ELSE                                           CSE007
     C                     ADD  XXNOMB    WTBNP
     C                     ENDIF                                          CSE007
     C*                                                                   S01496
     C                     END                                            S01496
     C*
     C**   ACCESS NEXT RECORD
     C*
     C***********          READ SEBKALL2                 88               S01496
     C                     MOVE '0'       *IN03                           CSE007
     C                     READ SEBKALL5                 88               S01496
     C*                                                                   S01496
     C**  Stop processing if branch is not equal to branch selected       S01496
     C**  and entity is not 'ALL' and not blank                           S01496
     C*                                                                   S01496
     C           @RENT     IFNE 'ALL'                                     S01496
     C           @RENT     ANDNE*BLANKS                                   S01496
     C           @RENT     ANDNEXXBRCD                                    S01496
     C                     MOVE '1'       *IN88                           S01496
     C                     END                                            S01496
     C                     END                             E*1
     C*
     C**   IF AT LEAST ONE RECORD IN THE LOGICAL FILE
     C*
     C           WNOREC    IFEQ 'N'                        B*1
     C*
     C**   RETRIEVE CURRENT TRADE POSITION
     C*
     C                     EXSR P005
     C*
     C**   IF RETURN INDICATOR IS OFF
     C*
     C           WRTCD     IFEQ 'Y'                        B*2
     C*
     C**   IF BLOCK TYPE IS 'P' AND 'TOTAL BLOCKED NOMINAL' IS GREATER THAN
     C**   'CURRENT TRADE POSITION' OR
     C**   IF BLOCK TYPE IS 'S' AND 'TOTAL BLOCKED NOMINAL' IS LOWER   THAN
     C**   'CURRENT TRADE POSITION'
     C*
     C           WBLTY     IFEQ 'P'                        B*3
     C           WTBNP     ANDGTWCTPP
     C           WBLTY     OREQ 'S'
     C           WTBNP     ANDLTWCTPP
     C*                                                                   S01496
     C**  Process a change in branch                                      S01496
     C*                                                                   S01496
     C           WBRCD     IFNE RRBRCA                                    S01496
     C                     EXSR #LBRPR                                    S01496
     C                     END                                            S01496
     C*
     C**   IF THE OVERFLOW INDICATOR IS ON
     C*
     C           *IN70     IFEQ '1'                        B*4
     C                     WRITEHEADER
     C                     MOVE '0'       *IN70
     C                     END                             E*4
     C*
     C           WSESN     IFNE *BLANKS                    B*4
     C*
     C**   ACCESS TO SECURITY DETAILS TO RETRIEVE THE NOMINAL DECIMAL PLACES
     C*
     C                     EXSR P004
     C                     END                             E*4
     C*
     C**   OUTPUT A DETAIL LINE
     C*
     C                     EXSR R001
     C                     END                             E*3
     C                     END                             E*2
     C                     END                             E*1
     C*
     C                     ENDSR
     C*****************************************************************
      /EJECT
     ******************************************************************
     C* P003   : TERMINATION PROCESSING                               *
     ******************************************************************
     C*
     C           P003      BEGSR
     C*
     C**   IF NO DETAIL RECORDS ARE PRINTED
     C*
     C           WNODET    IFEQ 'Y'                        B*1
     C*
     C**   WRITE EMPTY RECORD
     C*
     C***********          WRITENODATA                                    S01496
     C*                                                                   S01496
     C**  Open audit printer file and output "No details to report"       S01496
     C*                                                                   S01496
     C                     OPEN SE6830AU                                  S01496
     C                     WRITEHEADAU                                    S01496
     C                     WRITENODTLS                                    S01496
     C*                                                                   S01496
     C**  Ensure audit report is recorded by RCF                          S01496
     C*                                                                   S01496
     C                     Z-ADDSFNUMU    ZSNUM                           S01496
     C                     MOVELSFILEU    SFILE                           S01496
     C                     MOVE *BLANKS   SENTY                           S01496
     C                     EXSR #LZSFL                                    S01496
     C                     CLOSESE6830AU                                  S01496
     C                     END                             E*1
     C*
     C**   WRITE END OF REPORT
     C*
     C           WLOPN     IFEQ 'Y'                                       S01496
     C                     WRITEENDRP
     C                     CLOSESE6830P1                                  S01496
     C                     MOVE *BLANK    WLOPN                           S01496
     C                     END                                            S01496
     C*
     C**   END OF PROGRAM
     C*
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR
     ******************************************************************
      /EJECT
     ******************************************************************
     C* P004   : FIND NUMBER OF DECIMAL PLACE(S)                      *
     ******************************************************************
     C*
     C           P004      BEGSR
     C*
     C**   REINITIALISE INDICATOR
     C*
     C                     MOVE '0'       *IN50
     C                     MOVE '0'       *IN51
     C                     MOVE '0'       *IN52
     C                     MOVE '0'       *IN53
     C                     MOVE '0'       *IN54
     C*
     C**   ACCESS TO SECURITY DETAILS TO RETRIEVE THE NOMINAL DECIMAL PLACES
     C*
     C           WSESN     CHAINSECTY                89
     C*
     C**   IF RECORD IS NOT FOUND
     C*
     C           *IN89     IFEQ '1'                        B*1
     C                     MOVEL'004'     DBASE            *****************
     C***********          MOVEL'SECTY   'DBFILE           ** DB ERROR 04 S01496
     C                     MOVE 'SECTY   'DBFILE           * DB ERROR 04 *S01496
     C                     MOVELWSESN     DBKEY            *****************
     C                     EXSR *PSSR
     C                     END                             E*1
     C*
     C**   SETON CORRECT INDICATOR FOLLOWING THE NUMBER OF DECIMAL PLACES
     C*
     C           NMDP      IFEQ 0                          B*1
     C                     MOVE '1'       *IN50
     C                     ELSE                            X*1
     C           NMDP      IFEQ 1                          B*2
     C                     MOVE '1'       *IN51
     C                     ELSE                            X*2
     C           NMDP      IFEQ 2                          B*3
     C                     MOVE '1'       *IN52
     C                     ELSE                            X*3
     C           NMDP      IFEQ 3                          B*4
     C                     MOVE '1'       *IN53
     C                     ELSE                            X*4
     C                     MOVE '1'       *IN54
     C                     END                             E*4
     C                     END                             E*3
     C                     END                             E*2
     C                     END                             E*1
     C*
     C                     ENDSR
     ******************************************************************
      /EJECT
     ******************************************************************
     C* P005   : OBTAIN CURRENT TRADE POSITION                        *
     ******************************************************************
     C*
     C           P005      BEGSR
     C*
     C                     MOVE 'Y'       WRTCD
     C*
     C**   RESET TO ZERO 'CURRENT TRADE POSITION', 'TRADE DATE POSITION' AND
     C**   'VALUE DATE POSITION
     C*
     C                     Z-ADD*ZEROS    WCTPP  150
     C                     Z-ADD*ZEROS    WTDNP  150
     C                     Z-ADD*ZEROS    WVDNP  150
     C*
     C**   IF PORTFOLIO REFERENCE IS BLANK
     C*
     C           WPTFR     IFEQ *BLANKS                    B*1
     C*
     C**   SETUP KEY FIELDS
     C*
     C***********          Z-ADDWBRCD     KBRCD                           S01496
     C                     MOVE WBRCD     KBRCD                           S01496
     C                     MOVE WSESN     KSESN
     C**********           Z-ADDWCNUM     KCNUM                                               CSD027
     C                     MOVE WCNUM     KCNUM                                               CSD027
     C*
     C**   ACCESS TO CUSTOMER POSITION WITH BRANCH, SECURITY AND CUSTOMER
     C*
     C           KEY1      CHAINCPOSN                89
     C*
     C**   IF A RECORD IS FOUND
     C*
     C           *IN89     IFEQ '0'                        B*2
     C                     Z-ADDCSNT      WCTPP
     C                     Z-ADDCSNT      WTDNP
     C                     Z-ADDCSNV      WVDNP
     C*
     C**   IF NO RECORD FOUND, DO NOT PRODUCE AN EXCEPTION RECORD ON REPORT
     C*
     C                     ELSE                            X*2
     C                     MOVE 'N'       WRTCD   1
     C                     END                             E*2
     C*
     C**   ELSE, 'PORTFOLIO REFERENCE' NOT BLANK
     C*
     C                     ELSE                            X*1
     C*
     C                     MOVE WSESN     KSESN
     C**********           Z-ADDWCNUM     KCNUM                                               CSD027
     C                     MOVE WCNUM     KCNUM                                               CSD027
     C                     MOVE 'T'       KTVDA
     C                     MOVE WPTFR     KPTFR
     C*
     C**   ACCESS TO PORTFOLIO REFERENCE FILE WITH SECURITY, CUST, 'T' AND PORTF
     C*
     C           KEY2      CHAINPMCPOSL0             89
     C*
     C**   IF A RECORD IS FOUND
     C*
     C           *IN89     IFEQ '0'                        B*2
     C                     Z-ADDQANOML    WCTPP
     C                     Z-ADDQANOML    WTDNP
     C                     ELSE                            X*2
     C                     MOVE 'N'       WRTCD
     C                     END                             E*2
     C*
     C**   ACCESS TO PORTFOLIO REFERENCE FILE WITH SECURITY, CUST, 'V' AND PORTF
     C*
     C                     MOVE WSESN     KSESN
     C**********           Z-ADDWCNUM     KCNUM                                               CSD027
     C                     MOVE WCNUM     KCNUM                                               CSD027
     C                     MOVE 'V'       KTVDA
     C                     MOVE WPTFR     KPTFR
     C*
     C           KEY2      CHAINPMCPOSL0             89
     C*
     C**   IF A RECORD IS FOUND
     C*
     C           *IN89     IFEQ '0'                        B*2
     C                     Z-ADDQANOML    WVDNP
     C                     END                             E*2
     C                     END                             E*1
     C*
     C                     ENDSR
     ******************************************************************
      /EJECT
     ******************************************************************
     C* R001   : OUTPUT ER DEPOT DETAILS                              *
     ******************************************************************
     C*
     C           R001      BEGSR
     C*
     C                     MOVE 'N'       WNODET
     C*
     C                     MOVE WBRCD     BRCDP1
     C*
     C********** WCNUM     IFEQ *ZEROS                     B*1                                CSD027
     C           WCNUM     IFEQ *BLANKS                    B*1                                CSD027
     C                     MOVE *BLANKS   CNUMP1
     C                     ELSE                            X*1
     C                     MOVE WCNUM     CNUMP1
     C                     END                             E*1
     C*
     C           WPTFR     IFEQ '9997'                     B*1
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C***********          MOVE P9R997    PTFRP1                          S01496
     C                     MOVE FCR997    PTFRP1                          S01496
     C                     ELSE                            X*1
     C                     MOVE WPTFR     PTFRP1
     C                     END                             E*1
     C*
     C                     MOVE WSESN     SESNP1
     C*
     C**    IF 0 DECIMAL PLACE
     C*
     C           *IN50     IFEQ '1'                        B*1
     C                     MOVE WTDNP     TDNPP0
     C                     MOVE WVDNP     VDNPP0
     C                     MOVE WTBNP     TBNPP0
     C                     END                             E*1
     C*
     C**    IF 1 DECIMAL PLACE
     C*
     C           *IN51     IFEQ '1'                        B*1
     C                     MOVE WTDNP     TDNPP1
     C                     MOVE WVDNP     VDNPP1
     C                     MOVE WTBNP     TBNPP1
     C                     END                             E*1
     C*
     C**    IF 2 DECIMAL PLACES
     C*
     C           *IN52     IFEQ '1'                        B*1
     C                     MOVE WTDNP     TDNPP2
     C                     MOVE WVDNP     VDNPP2
     C                     MOVE WTBNP     TBNPP2
     C                     END                             E*1
     C*
     C**    IF 3 DECIMAL PLACES
     C*
     C           *IN53     IFEQ '1'                        B*1
     C                     MOVE WTDNP     TDNPP3
     C                     MOVE WVDNP     VDNPP3
     C                     MOVE WTBNP     TBNPP3
     C                     END                             E*1
     C*
     C**    IF 4 DECIMAL PLACES
     C*
     C           *IN54     IFEQ '1'                        B*1
     C                     MOVE WTDNP     TDNPP4
     C                     MOVE WVDNP     VDNPP4
     C                     MOVE WTBNP     TBNPP4
     C                     END                             E*1
     C*
     C                     MOVE WBLTY     BLTYP1
      *                                                                   CSE007
      ***  If feature CSE007 is switched ON.                              CSE007
      ***  Or feature CEU017 is switched ON.                              CEU017
      *                                                                   CSE007
     C           CSE007    IFEQ 'Y'                                       CSE007
     C           CEU017    OREQ 'Y'                                       CEU017
      *                                                                   CSE007
      ***  Format Block from Date.                                        CSE007
      *                                                                   CSE007
     C                     MOVE *BLANKS   BSTTP1                          CSE007
     C           XXBSTT    IFNE *ZEROS                                    CSE007
     C                     MOVE XXBSTT    ZDAYNO                          CSE007
     C                     EXSR ZDATE2                                    CSE007
     C                     MOVE ZADATE    BSTTP1                          CSE007
     C                     ENDIF                                          CSE007
      *                                                                   CSE007
      ***  Block Error/Warning Indicator.                                 CSE007
      *                                                                   CSE007
     C                     MOVE *BLANKS   EWINP1                          CSE007
     C                     MOVE XXEWIN    EWINP1                          CSE007
     C                     ENDIF                                          CSE007
     C*
     C**   OUTPUT DETAIL
     C*
     C                     WRITEDETAIL
     C*
     C                     ENDSR
     ******************************************************************
      /EJECT
     C*****************************************************************   S01496
     C* #LBRPR - Subroutine to process a change in branch             *   S01496
     C*****************************************************************   S01496
     C*                                                                   S01496
     C           #LBRPR    BEGSR                                          S01496
     C*                                                                   S01496
     C**  If printer file is open and entity is not blank, print footer   S01496
     C*                                                                   S01496
     C           WLOPN     IFEQ 'Y'                                       S01496
     C           @RENT     ANDNE*BLANKS                                   S01496
     C*                                                                   S01496
     C**  Output "End of Report"                                          S01496
     C                     WRITEENDRP                                     S01496
     C*                                                                   S01496
     C**  Close printer file                                              S01496
     C                     CLOSESE6830P1                                  S01496
     C                     MOVE *BLANK    WLOPN   1                       S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C**  Get branch name using access object                             S01496
     C*                                                                   S01496
     C**********           CALL 'AOBRCHR0'                                S01496              CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   WLRTCD                          S01496
     C                     PARM '*KEY   ' WLOPTN                          S01496
     C                     PARM WBRCD     WLBRCA  3                       S01496
     C           SDBRCH    PARM SDBRCH    DSSDY                           S01496
     C*                                                                   S01496
     C**  Check if error occurred                                         S01496
     C*                                                                   S01496
     C           WLRTCD    IFNE *BLANKS                                   S01496
     C                     MOVE 'SDBRCHPD'DBFILE           ***************S01496
     C                     Z-ADD5         DBASE            * DB ERROR 05 *S01496
     C                     MOVE *BLANKS   DBKEY            ***************S01496
     C                     MOVELWBRCD     DBKEY                           S01496
     C                     EXSR *PSSR                                     S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     MOVE A8BRNM    RRBRNM                          S01496
     C                     MOVE WBRCD     RRBRCA                          S01496
     C*                                                                   S01496
     C**  Open printer file SE6830P1 if entity is not blank               S01496
     C**  or the printer file is not yet open                             S01496
     C*                                                                   S01496
     C           @RENT     IFNE *BLANKS                                   S01496
     C           WLOPN     ORNE 'Y'                                       S01496
     C                     OPEN SE6830P1                                  S01496
     C                     MOVE 'Y'       WLOPN                           S01496
     C*                                                                   S01496
     C** Ensure Report Spool File recorded by RCF                         S01496
     C*                                                                   S01496
     C           @RENT     IFNE *BLANKS                                   S01496
     C                     MOVE WBRCD     SENTY                           S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     Z-ADDSFNUM1    ZSNUM                           S01496
     C                     MOVELSFILE1    SFILE                           S01496
     C                     EXSR #LZSFL                                    S01496
     C*                                                                   S01496
     C**  Output report header                                            S01496
     C*                                                                   S01496
     C                     WRITEHEADER                                    S01496
     C*                                                                   S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     ENDSR                                          S01496
     C*****************************************************************   S01496
     C/EJECT                                                              S01496
     C*****************************************************************   S01496
     C* #LZSFL - Subroutine to call ZSFILE                            *   S01496
     C*****************************************************************   S01496
     C*                                                                   S01496
     C           #LZSFL    BEGSR                                          S01496
     C*                                                                   S01496
     C                     CALL 'ZSFILE'                                  S01496
     C                     PARM           @RSEQ                           S01496
     C                     PARM           SENTY   3                       S01496
     C                     PARM           SFILE  10                       S01496
     C                     PARM           ZSNUM   60                      S01496
     C                     PARM           ZSERR   1                       S01496
     C*                                                                   S01496
     C** If an error occurred during ZSFILE processing,                   S01496
     C** return to the calling program.                                   S01496
     C*                                                                   S01496
     C           ZSERR     IFEQ 'Y'                                       S01496
     C                     SETON                     U7U8LR               S01496
     C                     RETRN                                          S01496
     C                     END                                            S01496
     C*                                                                   S01496
     C                     ENDSR                                          S01496
     C*****************************************************************   S01496
     C/EJECT                                                              S01496
     ******************************************************************
     C* *PSSR - TO PROCESS ABNORMAL END OF PROGRAM                    *
     ******************************************************************
     C           *PSSR     BEGSR
     C*
     C**   UPDATE LDA WITH ERROR INFORMATION
     C*
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C***********          MOVELDBFILE    WWFILE                          S01496
     C                     MOVE DBFILE    WWFILE                          S01496
     C                     MOVELDBKEY     WWKEY
     C                     MOVELDBPGM     WWPGM
     C                     MOVELDBASE     WWASE
     C                     OUT  LDA
     C*
     C**   OUTPUT ERROR ON PRINTER FILE
     C*
     C           WLOPN     IFEQ 'Y'                                       S01496
     C                     WRITEERROR
     C                     END                                            S01496
     C*
     C*****WRITE*END*OF*REPORT*****************************************   S01496
     C*
     C***********          WRITEENDRP                                     S01496
     C*                                                                   S01496
     C**  Output database error details in audit printer file             S01496
     C*                                                                   S01496
     C                     OPEN SE6830AU                                  S01496
     C                     WRITEHEADAU                                    S01496
     C                     WRITEDBERROR                                   S01496
     C*                                                                   S01496
     C**  Ensure audit report is recorded by RCF                          S01496
     C*                                                                   S01496
     C                     Z-ADDSFNUMU    ZSNUM                           S01496
     C                     MOVELSFILEU    SFILE                           S01496
     C                     MOVEL*BLANKS   SENTY                           S01496
     C                     EXSR #LZSFL                                    S01496
     C                     CLOSESE6830AU                                  S01496
     C*
     C**   PRINT DUMP AND CANCEL PROGRAM
     C*
     C                     DUMP
     C*
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C*
     C                     ENDSR
     ******************************************************************
      /EJECT
     ******************************************************************
     C/COPY ZSRSRC,ZDATE2Z2                                               CSE007
      /EJECT                                                              CSE007
     ******************************************************************   CSE007
      /COPY ZSRSRC,ZDATE2Z3                                               CSE007
**  CPY@
(c) Finastra International Limited 2001
