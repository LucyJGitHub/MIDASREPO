     H        1
      *****************************************************************
/*XBI *: OVRDBF FILE(SECTYZ1) TOFILE(SECTY) SHARE(*NO)              : *
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Corporate actions depot selection')           *
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  SE7512  - SE Corporate Actions - Depot Maintenance           *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD046248           Date 27Oct17               *
      *  Prev Amend No. CER059             Date 19Jul10               *
      *                 CER020             Date 19May08               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      *                 CSC023             Date 28Jan04               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CPK014             Date 14Nov01               *
      *                 189119             Date 12Jul01               *
      *                 190204             Date 31May01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 184520             Date 16Nov00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 CSE020             Date 21Mar00               *
      *                 161732             Date 21Mar00               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 164022             Date 13Jul99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 162284             Date 10Jun99               *
      *                 159908             Date 29Apr99               *
      *                 159517             Date 22Apr99               *
      *                 156532             Date 08Mar99               *
      *                 155622             Date 23Feb99               *
      *                 137877             Date 06Jul98               *
      *                 136935             Date 27Jul98               *
      *                 144398             Date 07Oct98               *
      *                 137879             Date 01Jul98               *
      *                 136930             Date 17Jun98               *
      *                 135690             Date 08Jun98               *
      *                 136428             Date 15Jun98               *
      *                 135689             Date 02Jun98               *
      *                 135685             Date 28May98               *
      *                 CEU017             Date 05Mar98               *
      *                 CSE007 *Create     Date 01Dec97               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD046248 - Finastra Rebranding                               *
      *  CER059 - German Feature Upgrade to Delhi                     *
      *  CER020 - Enhanced Rollover Window: Upgrade FGE089 to         *
      *           Midas Plus (Recompile)                              *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CSC023 - SBMJOB output queue must be *JOBD.                  *
      *  CPK014 - Submit jobs with user *JOBD                         *
      *  189119 - Allow allocation against a CA if Dummy customer     *
      *           position is not zero after warning operator.        *
      *  190204 - MDDIVU replaced by MDDIV1 in PF/SECODVPD.           *
      *  184520 - Do not allow allocation if dummy customer has       *
      *           position in CPOSN.                                  *
      *  CSE020 - Corporate Actions Domino Effect Processing          *
      *  161732 - Corporate Actions Exercise and Conversion -         *
      *           Part Stock/Keep Rest Calculation                    *
      *           (Recompiled due to changes in PF/SECOEXPD)          *
      *  164022 - no reply necessary for DV type 'C' or 'S'           *
      *  162284 - Don't validate if Mkt Price is 0 on SE7507          *
      *  159908 - Corporate Actions: Impossible to authorise a type   *
      *           'CR' with Status 'L' (Allocated) and Final Alloc.  *
      *           Indicator 'S' (Stock)                              *
      *  159517 - Corporate Actions: Allow Allocation run of a Rights *
      *           Issue even if the details from the rights tradable  *
      *           screen are not yet completely filled.               *
      *           These details must be filled before setting Final   *
      *           Allocation Indicator to 'Y'.                        *
      *  156532 - Corporate Actions: Invalid Action Code ...          *
      *  155622 - Corporate Actions: In case of multiple options,     *
      *           'Default No Reply' & 'Default Cash/Stock Preferred' *
      *           fields must be filled before action code 'L' valid. *
      *  137877 - Corporate Actions: Reply Handling amendments and    *
      *           review some validations when specific action taken  *
      *  136935 - Corporate Actions: Allocation processing amendments:*
      *           1. Correct error during control for requested stage *
      *              according to Processing Type.                    *
      *           2. For Stock Dividend, allow authorisation even if  *
      *              Market Ex Price and Subscription Price equal 0.  *
      *  144398 - Complete fix 137879                                 *
      *  137879 - Add validation on Authorisation (SPF)               *
      *  136930 - EMU and Corporate Actions: various errors:          *
      *           - Blink on confirmation screen Ex-Date Position if  *
      *             different from Allocation detail file and Depot   *
      *             Position file.                                    *
      *  135690 - Various errors for Corporate Actions:               *
      *           - For processing type Dividend Events, allow the    *
      *             entry of 'MARKET' on Subscription Price, which    *
      *             will use the Market Price of the Security minus   *
      *             Discount at allocation effective date.            *
      *  136428 - Recompile due to addition of Days Basis and Divisor *
      *           Basis field in SECORBPD.                            *
      *  135689 - Corporate Actions and EMU                           *
      *           (1) For 'CR', field 'Cash Payment' no more mandatory*
      *           (2) Status on PF/SECORBPD must never be reset to 'I'*
      *           (3) Review validation for the run of the allocation *
      *               on processing type 'DV' - Dividend Events       *
      *  135685 - It's not feasible to enter the Compensation Price   *
      *           at the Bulk level as the Bulk will have many        *
      *           Securities all giving a cash compensation at a      *
      *           different level. Therefore, allow the entry of      *
      *           'MARKET' which will use the Market Price of the     *
      *           Security at allocation effective date.              *
      *  CEU017 - Securities Redenomination Euro Changes              *
      *  CSE007 - Corporate Actions                                   *
      *                                                               *
      *****************************************************************
      /EJECT
      *       FILE DEFINITIONS
      *      ------------------
      *
      **   Midas SE Securities - Details
     FSECTYZ1 IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      **   Midas SE Depot Positions - Current and Historic
     FSEDPOHL0IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      **   Midas Corporate Actions - Depots update index
     FSECODPL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      **   Midas Corporate Actions - Depots Update index
     FSECODRL0UF  E           K        DISK                      A
     F                                              KINFSR *PSSR
     F                                              KCOMIT
      *
      **   MA - SE CORPORATE ACTIONS References - Upd Idx
     FSECORFL0UF  E           K        DISK                      A
     F                                              KINFSR *PSSR
     F                                              KCOMIT
      *
      **   MC - SE CORPORATE ACTIONS - Allocations
     FSECOALL7UF  E           K        DISK         KINFSR *PSSR A
     F                                              KCOMIT
      *                                                                   CSE020
      **   Midas SE Corporate Actions - Stock Allocations                 CSE020
     FSECOALL5IF  E           K        DISK                               CSE020
     F            SECOALD0                          KRENAMESECOALD5       CSE020
     F                                              KINFSR *PSSR          CSE020
      *                                                                   CSE020
      **   Midas SE Corporate Actions References - Rtv Idx                CSE020
     FSECORFL1UF  E           K        DISK                               CSE020
     F            SECORFD0                          KRENAMESECORFD1       CSE020
     F                                              KINFSR *PSSR          CSE020
      *                                                                   CSE020
      **   Midas SE Corporate Actions References - Rtv Idx                CSE020
     FSECORFPMIF  E                    DISK                               CSE020
     F                                              KINFSR *PSSR          CSE020
      *                                                                   CSE020
      **   Midas SE Corporate Actions - Name Changes                      CSE020
     FSECONCL1IF  E           K        DISK         KINFSR *PSSR          CSE020
      *                                                                   CSE020
      **   Midas SE Corporate Actions - Name Changes                      CSE020
     FSECODPL5UF  E           K        DISK         KINFSR *PSSR          CSE020
     F            SECODPD0                          KRENAMESECODPD5       CSE020
      *
      **   MD - SE CORPORATE ACTIONS - Dividends
     FSECODVL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      **   ME - SE CORPORATE ACTIONS - Free Allocations
     FSECOFRL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      **   MF - SE CORPORATE ACTIONS - Rights
     FSECORGL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      **   MG - SE CORPORATE ACTIONS - Capital events
     FSECOCEL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      **   MH - SE CORPORATE ACTIONS - Corporate Reorganisation
     FSECOCRL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      **   MI - SE CORPORATE ACTIONS - Offers
     FSECOOFL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      **   MJ - SE CORPORATE ACTIONS - Exercises and Conversions
     FSECOEXL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *                                                                   159517
      **  SE Corporate Actions - Exercises and Conversions                159517
     FSECOEXL2IF  E           K        DISK                               159517
     F            SECOEXD0                          KRENAMESECOEXD2       159517
     F                                              KINFSR *PSSR          159517
      *                                                                   CEU017
      **   NA - SE CORPORATE ACTIONS - Curreny Changes                    CEU017
     FSECOCCL2IF  E           K        DISK                               CEU017
     F                                              KINFSR *PSSR          CEU017
      *                                                                   CEU017
      **  NB - Securities Redenomination Bulk Details - Updt Index        CEU017
     FSECORBL0UF  E           K        DISK         KCOMIT                CEU017
     F                                              KINFSR *PSSR          CEU017
      *
      **  Customer position file.                                         184520
     FCPOSN   IF  E           K        DISK                               184520
      **   Display file
     FSE7512DFCF  E                    WORKSTN
     F                                              KINFSR *PSSR
     F                                              KINFDS SCRDS
     F                                        #1RRN KSFILE SE7512S1
      *****************************************************************
      /EJECT
      ********************************************************************
      *
      ** Array for copyright.
     E                    CPY@    1   1 80
      *
      ** Text messages for command keys.
     E***********         TXT     1   4 78                                CSE020
     E                    TXT     1   5 78                                CSE020
      *
      **  Array for testing MHMKTP                                               162284
      *                                                                          162284
     E                    AR1        20 10                                       162284
     E                    AR8        20 16                                       162284
      *                                                                   CSE020
      ** Array for the New Securities                                     CSE020
      *                                                                   CSE020
     E                    NSEC      180 10                                CSE020
      *
     E/COPY ZSRSRC,ZSEDITZ1
     E/COPY ZSRSRC,ZDATE2Z1
     E/COPY ZSRSRC,ZASIGNZ1
      *
      ** Array for Security Shortnames
     E                    SSARR      20 10
      *
     E                    CMD     1   3 80               SBMJOB
      *
     E                    NARR    1   3 24
      *
      ********************************************************************
      /EJECT
      *****************************************************************
     ISECOALD5                                                            CSE020
      ** Rename fields of SECOALL5: Midas SE CA - Stock Allocations       CSE020
      *                                                                   CSE020
     I              MCRECI                          M5RECI                CSE020
     I              MCLCD                           M5LCD                 CSE020
     I              MCCHTP                          M5CHTP                CSE020
     I              MCLUID                          M5LUID                CSE020
     I              MCCORF                          M5CORF                CSE020
     I              MCOPTN                          M5OPTN                CSE020
     I              MCBRCD                          M5BRCD                CSE020
     I              MCDDPT                          M5DDPT                CSE020
     I              MCCOTP                          M5COTP                CSE020
     I              MCBOOK                          M5BOOK                CSE020
     I              MCCNUM                          M5CNUM                CSE020
     I              MCPTFR                          M5PTFR                CSE020
     I              MCEXPO                          M5EXPO                CSE020
     I              MCSESN                          M5SESN                CSE020
     I              MCOALR                          M5OALR                CSE020
     I              MCOTSA                          M5OTSA                CSE020
     I              MCOSTR                          M5OSTR                CSE020
     I              MCOCAR                          M5OCAR                CSE020
     I              MCCAOP                          M5CAOP                CSE020
     I              MCASTA                          M5ASTA                CSE020
     I              MCHOST                          M5HOST                CSE020
     I              MCHOCA                          M5HOCA                CSE020
     I              MCACAA                          M5ACAA                CSE020
     I              MCASTR                          M5ASTR                CSE020
     I              MCACAR                          M5ACAR                CSE020
     I              MCOPT1                          M5OPT1                CSE020
     I              MCOPT2                          M5OPT2                CSE020
     I              MCREST                          M5REST                CSE020
     I              MCBSEC                          M5BSEC                CSE020
     I              MCBEDT                          M5BEDT                CSE020
     I              MCBSTT                          M5BSTT                CSE020
     I              MCBLTY                          M5BLTY                CSE020
     I              MCBEWI                          M5BEWI                CSE020
     I              MCCOAT                          M5COAT                CSE020
     I              MCTRRF                          M5TRRF                CSE020
     I              MCTRR2                          M5TRR2                CSE020
     I              MCTRR3                          M5TRR3                CSE020
     I              MCRVRF                          M5RVRF                CSE020
     I              MCRVR2                          M5RVR2                CSE020
     I              MCRVR3                          M5RVR3                CSE020
     I              MCTNL1                          M5TNL1                CSE020
     I              MCLTRQ                          M5LTRQ                CSE020
     I              MCTOTF                          M5TOTF                CSE020
     I              MCTOTT                          M5TOTT                CSE020
     ISECORFD1                                                            CSE020
      ** Rename fields of SECORFL1: Midas SE CA - References              CSE020
      *                                                                   CSE020
     I              MARECI                          MNRECI                CSE020
     I              MALCD                           MNLCD                 CSE020
     I              MACHTP                          MNCHTP                CSE020
     I              MALUID                          MNLUID                CSE020
     I              MACORF                          MNCORF                CSE020
     I              MAJOBN                          MNJOBN                CSE020
     I              MAUSER                          MNUSER                CSE020
     I              MAJNBR                          MNJNBR                CSE020
     I              MASESN                          MNSESN                CSE020
     I              MACOAT                          MNCOAT                CSE020
     I              MAPTYP                          MNPTYP                CSE020
     I              MACOAN                          MNCOAN                CSE020
     I              MACOEX                          MNCOEX                CSE020
     I              MAALEF                          MNALEF                CSE020
     I              MANBOP                          MNNBOP                CSE020
     I              MATDVD                          MNTDVD                CSE020
     I              MACOPD                          MNCOPD                CSE020
     I              MATDDT                          MNTDDT                CSE020
     I              MAEVDT                          MNEVDT                CSE020
     I              MACPNB                          MNCPNB                CSE020
     I              MASHMD                          MNSHMD                CSE020
     I              MALTBS                          MNLTBS                CSE020
     I              MAOCPV                          MNOCPV                CSE020
     I              MANCPV                          MNNCPV                CSE020
     I              MAONML                          MNONML                CSE020
     I              MANNML                          MNNNML                CSE020
     I              MACUPC                          MNCUPC                CSE020
     I              MAEXPC                          MNEXPC                CSE020
     I              MACLRD                          MNCLRD                CSE020
     I              MACLRT                          MNCLRT                CSE020
     I              MADLRD                          MNDLRD                CSE020
     I              MADLRT                          MNDLRT                CSE020
     I              MABLOS                          MNBLOS                CSE020
     I              MABLOP                          MNBLOP                CSE020
     I              MABFRD                          MNBFRD                CSE020
     I              MABEND                          MNBEND                CSE020
     I              MAREFO                          MNREFO                CSE020
     I              MACONR                          MNCONR                CSE020
     I              MADFNR                          MNDFNR                CSE020
     I              MADFCP                          MNDFCP                CSE020
     I              MADFSP                          MNDFSP                CSE020
     I              MALREQ                          MNLREQ                CSE020
     I              MALPRO                          MNLPRO                CSE020
     I              MALTSI                          MNLTSI                CSE020
     I              MASTAT                          MNSTAT                CSE020
     I              MAPREF                          MNPREF                CSE020
     ISECORFM0                                                            CSE020
      ** Rename fields of SECORFPM: Midas SE CA - References              CSE020
      *                                                                   CSE020
     I              MARECI                          MORECI                CSE020
     I              MALCD                           MOLCD                 CSE020
     I              MACHTP                          MOCHTP                CSE020
     I              MALUID                          MOLUID                CSE020
     I              MACORF                          MOCORF                CSE020
     I              MAJOBN                          MOJOBN                CSE020
     I              MAUSER                          MOUSER                CSE020
     I              MAJNBR                          MOJNBR                CSE020
     I              MASESN                          MOSESN                CSE020
     I              MACOAT                          MOCOAT                CSE020
     I              MAPTYP                          MOPTYP                CSE020
     I              MACOAN                          MOCOAN                CSE020
     I              MACOEX                          MOCOEX                CSE020
     I              MAALEF                          MOALEF                CSE020
     I              MANBOP                          MONBOP                CSE020
     I              MATDVD                          MOTDVD                CSE020
     I              MACOPD                          MOCOPD                CSE020
     I              MATDDT                          MOTDDT                CSE020
     I              MAEVDT                          MOEVDT                CSE020
     I              MACPNB                          MOCPNB                CSE020
     I              MASHMD                          MOSHMD                CSE020
     I              MALTBS                          MOLTBS                CSE020
     I              MAOCPV                          MOOCPV                CSE020
     I              MANCPV                          MONCPV                CSE020
     I              MAONML                          MOONML                CSE020
     I              MANNML                          MONNML                CSE020
     I              MACUPC                          MOCUPC                CSE020
     I              MAEXPC                          MOEXPC                CSE020
     I              MACLRD                          MOCLRD                CSE020
     I              MACLRT                          MOCLRT                CSE020
     I              MADLRD                          MODLRD                CSE020
     I              MADLRT                          MODLRT                CSE020
     I              MABLOS                          MOBLOS                CSE020
     I              MABLOP                          MOBLOP                CSE020
     I              MABFRD                          MOBFRD                CSE020
     I              MABEND                          MOBEND                CSE020
     I              MAREFO                          MOREFO                CSE020
     I              MACONR                          MOCONR                CSE020
     I              MADFNR                          MODFNR                CSE020
     I              MADFCP                          MODFCP                CSE020
     I              MADFSP                          MODFSP                CSE020
     I              MALREQ                          MOLREQ                CSE020
     I              MALPRO                          MOLPRO                CSE020
     I              MALTSI                          MOLTSI                CSE020
     I              MASTAT                          MOSTAT                CSE020
     I              MAPREF                          MOPREF                CSE020
     I              MALEVL                          MOLEVL                CSE020
      *                                                                   CSE020
      *                                                                   184520
     ISDSTRD    E DSSDSTRDPD                                              184520
      *                                                                   184520
     ISCRDS       DS
     I                                    B 378 3790CPFPOS
      *
      **  Data Structure for compilation - Copyright insertion
     ICPYR@$      DS
     I                                        1  80 CPY@
     I                                        1  20 CPY@$$
      *
      **  Data Structure for command string for QCMDEXC
     ICMDTXT      DS                            240
     I                                       12  20 @CJOB
     I                                       14  19 @REF
     I                                       20  20 @ACTI
     I                                       72  77 @REFN
     I                                       81 160 CMDTX2                                    CPK014
     I                                      161 240 CMDTX3                                    CPK014
     I                                       83  85 @BRCD
     I                                       91  96 @DEPT
      *
      **  Program status data structure
     IPSDS       SDS
     I                                     *PROGRAM ##PGM
     I                                      244 253 JOB
     I                                      254 263 USER
      *
      **  Parameters for Allocation report
     I@PARM       DS                            100
     I                                        1   1 DDSLAL
     I                                        2   7 DDREFN
     I                                        8   9 DDOPTN
     I                                       10  12 DDBRC
     I                                       13  18 DDDEP
      *
      **  Local data area for database error details
      **  *LOCK IN LDA immediately before and OUT LDA immediately
      **  after each database error handling.
     ILDA         DS                            256
     I                                      134 141 WWFILE
     I                                      142 170 WWKEY
     I                                      171 180 WWPGM
     I                                      181 1830WWASE
      *
      **  Date formatting data structure
     IUPDATE      DS
     I                                        1   2 CADAY
     I                                        3   5 CAMON
     I                                        6   7 CAYER
      *                                                                   144398
     IZMUSER      DS                             17                       144398
      ** Data area ZMUSER                                                 144398
     I                                       11  13 BVBRCD                144398
      *
      **  Standard Data Area Layout for System flags and Run Date
     IRUNDAT    E DS
      *
      **  Bank Details
     ISDBANK    E DSSDBANKPD
      *                                                                   S01117
      **  Customer Details                                                S01117
     ISDCUST    E DSSDCUSTPD                                              S01117
      *
      **  Second DS for access programs, long data structure
     IDSSDY     E DSDSSDY
      *
     I/COPY ZSRSRC,ZSEDITZ2
      *
      /EJECT
      *****************************************************************
      * Main Processing
      *****************************************************************
      *
      **  Entry parameters
     C           *ENTRY    PLIST
     C                     PARM           WWREFN  6        ER Reference
     C                     PARM           WWSECN 10        Security Shortname
     C                     PARM           WWCOAT  2        Corporate Action Type
     C                     PARM           WWPTYP  2        Processing Type
     C                     PARM           WWEXDT  5        Ex-Date
     C                     PARM           WWNBOP  2        Number of options
     C                     PARM           WWMODE  1        Amend or Enquiry ?
     C                     PARM           WWGSTS  1        General Status
     C                     PARM           WWRTCD  1        Return Code
      *
      ** Initial processing
     C                     EXSR P001
      *
      ** Set 'First Time' flag to 'Y'
     C                     MOVE 'Y'       FIRST   1
      *
      ** Do until F3 or F12
     C           *INKC     DOUEQ'1'                         B*1
     C           *INKL     OREQ '1'
      *
      ** If 'FIRST TIME' = 'Y'
     C           FIRST     IFEQ 'Y'                         B*2
      *
      ** Clear messages from program message quque.
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
      ** Build the subfile
     C                     EXSR P002
      *
      ** Set first time flag to 'N'
     C                     MOVE 'N'       FIRST
     C                     ENDIF
      *
      ** Write SE6512DF on screen
     C           WWCPT     IFEQ 0
     C                     Z-ADD0         #1RRN
     C                     MOVEL'CO00001' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE
     C                     Z-ADD1         #1RRN
     C                     ENDIF
      *
     C           W#FLAG    IFNE 'Y'                                       CSE020
     C                     MOVE TXT,1     ##CTX1
     C                     MOVE '0'       *IN60                           CSE020
     C                     ELSE                                           CSE020
     C                     MOVE TXT,5     ##CTX1                          CSE020
     C                     MOVE '1'       *IN60                           CSE020
     C                     ENDIF                                          CSE020
      *
     C                     WRITESE7512C2
     C                     WRITESE7512C1
     C                     WRITESE7512F1
      *
      ** Read SE7512DF
     C           *INKC     IFEQ *OFF
     C                     READ SE7512F1                 89
     C                     MOVE ' '       WWRTCD
     C                     ENDIF
      *
      ** Clear messages from program message quque.
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
      ** If ENTER taken
     C           *INKC     IFEQ *OFF                       B*2
     C           *INKL     ANDEQ*OFF
     C           *INKE     ANDEQ*OFF
     C           #1RRN     ANDNE0
      *
      ** Validate subfile records as per P003.
     C                     EXSR P003
     C                     ENDIF
      *
      ** If F3 taken
      ** OR If F12 taken
     C           *INKC     IFEQ *ON
     C           *INKL     OREQ *ON
      *
     C           WWCPT     IFNE 0
      *
      ** Access LF/SECODRL0 and read all records with same corporate
      ** action reference
     C           WWREFN    SETLLSECODRL0
     C           WWREFN    READESECODRL0                 89
      *
     C           *IN89     IFEQ '0'
     C                     MOVE MSCOST    WWCOST  1
     C                     MOVE MSCOST    WLCOST  1
     C                     ELSE
     C                     MOVE 'I'       WWCOST
     C                     MOVE 'I'       WLCOST
     C                     ENDIF
      *
     C                     MOVE 'Y'       WWSAME  1
     C                     MOVE 'Y'       WFIRST  1
      *
     C           *IN89     DOWEQ'0'
      *
     C           MSCOST    IFNE WWCOST
     C                     MOVE 'N'       WWSAME
     C                     ENDIF
      *
     C           MSCOST    IFNE WLCOST
      *
     C           MSCOST    IFEQ 'I'
     C                     MOVE 'I'       WLCOST
     C                     ENDIF
      *
     C           MSCOST    IFEQ 'L'
     C           WLCOST    ANDNE'I'
     C                     MOVE 'L'       WLCOST
     C                     ENDIF
      *
     C           MSCOST    IFEQ 'S'
     C           WLCOST    ANDNE'L'
     C           WLCOST    ANDNE'I'
     C                     MOVE 'S'       WLCOST
     C                     ENDIF
      *
     C           MSCOST    IFEQ 'X'
     C           WLCOST    ANDNE'L'
     C           WLCOST    ANDNE'I'
     C           WLCOST    ANDNE'S'
     C                     MOVE 'X'       WLCOST
     C                     ENDIF
      *
     C                     ENDIF
      *
     C           WWREFN    READESECODRL0                 89
     C                     ENDDO
      *
     C                     ELSE
     C                     MOVE 'I'       WWCOST
     C                     MOVE 'Y'       WWSAME
     C                     ENDIF
      *
      ** If all records have the same status, then update the status
      ** on PF/SECORFPD, else update it with the "lower" status found
     C           WWREFN    CHAINSECORFL0             89
     C           WWSAME    IFEQ 'Y'
     C                     MOVE WWCOST    MASTAT
     C                     UPDATSECORFD0
      *
     C           MAPTYP    IFEQ 'CC'                                      CEU017
     C           WWCOST    ANDNE'I'                                       135689
     C           MACORF    CHAINSECOCCL2             89                   CEU017
      *                                                                   CEU017
     C           *IN89     IFEQ '0'                                       CEU017
     C           NABLKR    ANDNE*ZEROS                                    CEU017
     C           NABLKR    CHAINSECORBL0             89                   CEU017
      *                                                                   CEU017
      **  Reverse matching record in LF/SECORBL0                          CEU017
     C                     MOVE WWCOST    NBSTAT                          CEU017
     C                     UPDATSECORBD0                                  CEU017
     C                     ENDIF                                          CEU017
     C                     ENDIF                                          CEU017
      *                                                                   CEU017
     C                     ELSE
     C           WLCOST    IFNE *BLANKS
     C                     MOVE WLCOST    MASTAT
      *
     C           MAPTYP    IFEQ 'CC'                                      CEU017
     C           WLCOST    ANDNE'I'                                       135689
     C           MACORF    CHAINSECOCCL2             89                   CEU017
      *                                                                   CEU017
     C           *IN89     IFEQ '0'                                       CEU017
     C           NABLKR    ANDNE*ZEROS                                    CEU017
     C           NABLKR    CHAINSECORBL0             89                   CEU017
      *                                                                   CEU017
      **  Reverse matching record in LF/SECORBL0                          CEU017
     C                     MOVE WLCOST    NBSTAT                          CEU017
     C                     UPDATSECORBD0                                  CEU017
     C                     ENDIF                                          CEU017
     C                     ENDIF                                          CEU017
      *                                                                   CEU017
     C                     ELSE
     C                     MOVE 'I'       MASTAT
     C                     ENDIF
     C                     UPDATSECORFD0
     C                     ENDIF
      *
     C                     MOVE MASTAT    WWGSTS           General Status
      *
     C                     ENDIF
      *
      ** If F3 taken
     C           *INKC     IFEQ *ON
     C                     MOVE '3'       WWRTCD
      *
      ** Comit changed records.
     C                     COMIT
     C                     ENDIF
      *
      ** If F12 taken
     C           *INKL     IFEQ *ON
     C                     MOVE '2'       WWRTCD
      *
      ** Comit changed records.
     C                     COMIT
     C                     ENDIF
      *
      ***  If F5:Refresh taken
     C           *INKE     IFEQ *ON
      *
      ***  Clear messages from program message queue.
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
      ***  Re-build Subfile.
     C                     MOVE *BLANKS   DDACN
     C                     MOVE *BLANKS   W#FLAG                          CSE020
     C                     MOVEA'000'     *IN,50
     C                     EXSR P002
     C                     ENDIF
      *
     C                     ENDDO
      *
      ** Return to SE7502
     C                     MOVE *ON       *INLR
     C                     RETRN
      *
      *****************************************************************
      * P001   : Initial Processing                                   *
      *****************************************************************
      *
     C           P001      BEGSR
      *
      **   ONLY TO DECLARE THE FILE IN 'ADD' MODE
      *
     C           *IN99     IFEQ '0'                        B*1
     C           *IN99     ANDEQ'1'
     C                     WRITESECOALD0
     C                     ENDIF                           E*1
      *
      ** Copyright statement
     C                     MOVEACPY@      ACT@   80
      *
     C           WWMODE    IFEQ 'E'                        B*1
     C                     MOVE '1'       *IN40
     C                     ELSE                            X*1
     C                     MOVE '0'       *IN40
     C                     ENDIF                           E*1
      *
     C           WWPTYP    IFEQ 'NC'                       B*1
     C           WWPTYP    OREQ 'NF'
     C***********WWPTYP    OREQ 'CC'                                      CEU017
     C                     MOVE '1'       *IN41
     C                     ELSE                            X*1
     C                     MOVE '0'       *IN41
     C                     ENDIF                           E*1
      *
      ** Initialise key and work fields
     C                     MOVEL'SE7512  'DBPGM  10
      *
     C                     MOVE WWREFN    DDREFN           ER Reference
     C                     MOVE WWSECN    DDSECU           Security Shortname
     C                     MOVE WWCOAT    DDACTY           Corporate Action Type
     C                     MOVE WWNBOP    WWOPNB           Number of Options
      *
     C           WWEXDT    IFEQ *BLANKS
     C           WWEXDT    OREQ *ZEROS
     C                     MOVE *BLANKS   DDEXDT
     C                     ELSE
     C                     MOVE WWEXDT    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     DDEXDT           Ex-Date
     C                     ENDIF
      *
      ** Setup screen time
     C                     TIME           ##TME   60       Screen time.
      *                                                                   144398
      **  Read in DTAARA/ZMUSER                                           144398
     C           *NAMVAR   DEFN           ZMUSER                          144398
     C                     IN   ZMUSER                                    144398
      *
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
      *
      ** If first time program called
     C           FIRST     IFNE 'N'                        B*1
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   WLRTCD  7
     C                     PARM '*FIRST'  WLOPTN  7
     C           SDBANK    PARM SDBANK    DSSDY
      *
      ** If record not found in SDBANKL1
     C           WLRTCD    IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'001'     DBASE   30       ***************
     C                     MOVE 'SDBANKPD'DBFILE 10        * DB ERROR 01 *
     C                     MOVEL*BLANKS   DBKEY  29        ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF                           E*2
      *
     C                     MOVELUSER      USIDXX
     C                     MOVELJOB       WSID
     C                     MOVE BJMRDT    ##MRDT           MIDAS RUN DATE
     C                     MOVE *OFF      *IN98
      *
      ** Retrieve Nominal Currency and Nominal Currency dec. places.
     C           WWSECN    CHAINSECTYZ1              30
      *
      ** No record found
     C           *IN30     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'002'     DBASE            ***************
     C                     MOVE 'SECTYZ1 'DBFILE           * DB ERROR 02 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
      *
     C                     ELSE
     C                     MOVE NMCY      DDNCCY
     C                     Z-ADDNMDP      WNCDP   10
     C                     ENDIF                           E*2
     C                     ENDIF
      *
      ** Select the program MSGQ for error msg
     C                     MOVEL'*'       TOPQ   10
     C                     MOVEL'*PRV'    TOPRQ   5
     C                     MOVEL'SEUSRMSG'PMSGF  10
      *
      ** Fill in fields for subroutine ZASNMS
     C                     MOVEL'SE7512'  ZAPGM  10        Message queue
     C                     MOVEL'SEUSRMSG'ZAMSGF 10        Message file
     C                     MOVEL*BLANK    ZAPGRL  5        Rel queue
     C                     MOVEL*BLANK    ZAMSID  7        Message Id.
     C                     MOVEL*BLANK    ZAMSDA132        Message data.
     C                     MOVEL*BLANK    ZAMSTP  7        Message type.
      *
     C           WWREFN    CHAINSECORFL0             89
      *
      ** ONLY to declare the file in 'ADD' mode
     C           *IN89     IFEQ '0'                        B*1
     C           *IN89     ANDEQ'1'
     C                     WRITESECORFD0
     C                     ENDIF                           E*1
      *
      ** If CA is a child, obtain the Security from the Originating CA    CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C           MAPREF    CHAINSECORFL1             71                   CSE020
     C           *IN71     IFEQ *ON                                       CSE020
     C           *LOCK     IN   LDA                                       CSE020
     C                     Z-ADD008       DBASE            ***************CSE020
     C                     MOVEL'SECORFL1'DBFILE           * DB ERROR 008*CSE020
     C                     MOVELMAPREF    DBKEY            ***************CSE020
     C                     OUT  LDA                                       CSE020
     C                     EXSR *PSSR                                     CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C           MNPREF    DOWNE*BLANKS                                   CSE020
     C           MNPREF    CHAINSECORFL1             71                   CSE020
     C           *IN71     IFEQ *ON                                       CSE020
     C           *LOCK     IN   LDA                                       CSE020
     C                     Z-ADD009       DBASE            ***************CSE020
     C                     MOVEL'SECORFL1'DBFILE           * DB ERROR 009*CSE020
     C                     MOVELMNPREF    DBKEY            ***************CSE020
     C                     OUT  LDA                                       CSE020
     C                     EXSR *PSSR                                     CSE020
     C                     ENDIF                                          CSE020
     C                     ENDDO                                          CSE020
     C                     MOVE MNSESN    WOSESN 10                       CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
      ** Access SAR Details file to determine if CSE020 is installed      CSE020
      *                                                                   CSE020
     C                     CALL 'AOSARDR0'                                CSE020
     C                     PARM *BLANKS   WRTCD   7                       CSE020
     C                     PARM '*VERIFY' WOPTN   7                       CSE020
     C                     PARM 'CSE020'  WSARD   6                       CSE020
      *                                                                   CSE020
      ** Handle Database Error                                            CSE020
      *                                                                   CSE020
     C           WRTCD     IFNE *BLANKS                                   CSE020
     C           WRTCD     ANDNE'*NRF   '                                 CSE020
     C           *LOCK     IN   LDA                                       CSE020
     C                     MOVEL'SCSARDPD'DBFILE           ***************CSE020
     C                     Z-ADD010       DBASE            *DB ERROR 010 *CSE020
     C                     MOVEL'CSE020  'DBKEY            ***************CSE020
     C                     OUT  LDA                                       CSE020
     C                     EXSR *PSSR                                     CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C           WRTCD     IFEQ *BLANKS                                   CSE020
     C                     MOVEL'Y'       CSE020  1                       CSE020
     C                     ELSE                                           CSE020
     C                     MOVEL'N'       CSE020                          CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C/COPY WNCPYSRC,SEH00024
      ** Find out the number of the dummy customer for corporate action   184520
      *  customers.                                                       184520
      ***  Call Access Program for Securities Trading Details.            184520
      *                                                                   184520
     C                     CALL 'AOSTRDR0'                                184520
     C                     PARM '*BLANKS' WRTCD   7                       184520
     C                     PARM '*FIRST ' WOPTN   7                       184520
     C           SDSTRD    PARM SDSTRD    DSSDY                           184520
      *                                                                   184520
      ***  If record not found, handle database error.                    184520
      *                                                                   184520
     C           WRTCD     IFNE *BLANKS                                   184520
     C           *LOCK     IN   LDA                                       184520
     C                     MOVEL'SDSTRDPD'DBFILE           ***************184520
     C                     MOVEL'*FIRST  'DBKEY            * DB ERROR 04 *184520
     C                     Z-ADD004       DBASE            ***************184520
     C                     MOVEL'SE7512'  DBPGM                           184520
     C                     OUT  LDA                                       184520
     C                     EXSR *PSSR                                     184520
     C                     ENDIF                                          184520
      *                                                                   184520
      ***  Retrieve Dummy Customer Number.                                184520
      *                                                                   184520
     C**********           MOVE BVERCU    WDUMMY  60                                   184520 CSD027
     C                     MOVE BVERCU    WDUMMY  6                                           CSD027
      *                                                                   184520
      ** Setup keylist to LF/CPOSNX                                       184520
     C           WKEY1     KLIST                                          184520
     C                     KFLD           WBRCD1  3                       184520
     C                     KFLD           WSESN1 10                       184520
     C**********           KFLD           WCDCN1  60                                   184520 CSD027
     C                     KFLD           WCDCN1  6                                           CSD027
      *                                                                   184520
     C                     ENDSR
      *
      *****************************************************************
      * P002   : Build the subfile                                    *
      *****************************************************************
      *
     C           P002      BEGSR
      *
      ** Clear subfile
     C                     MOVE *ON       *IN80
     C                     WRITESE7512C1
     C                     MOVE *OFF      *IN80
     C                     MOVE *OFF      *IN81
      *
     C                     Z-ADD0         SFLLEN  40
     C                     Z-ADD1         #1RRN
     C                     Z-ADD#1RRN     SFLRRN
     C                     MOVE *OFF      P002#1  1
      *
      ** Setup screen time
     C                     TIME           ##TME   60       Screen time.
      *
      ** Read first record from LF/SEDPOHL0
     C           *LOVAL    SETLLSEDPOHL0
     C                     READ SEDPOHL0                 30
      *
      ** If record read
     C           *IN30     IFEQ *OFF
     C           *LIKE     DEFN DSBA      WWDSBA
     C           *LIKE     DEFN DDPT      WWDDPT
     C           *LIKE     DEFN DSSC      WWDSSC
     C           *LIKE     DEFN DDTE      WWDDTE
     C           *LIKE     DEFN DDTE      WWDDT2
      *
      ** Save branch and depot
     C                     MOVELDSBA      WWDSBA
     C                     MOVELDDPT      WWDDPT
      *
     C                     Z-ADD0         WWCPT   20
      *                                                                   CSE020
      ** If CA is a child, save Security.                                 CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WWSECN    WKSESN 10                       CSE020
     C                     ENDIF                                          CSE020
      *
      ** Do while records read from LF/SEDPOHL0
     C           *IN30     DOWEQ*OFF
     C           WWCPT     ANDLT16
      *                                                                   CSE020
      ** If CA is a child, use the Security obtained from the             CSE020
      ** Originating CA before reading LF/SEDPOHL0.                       CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WOSESN    WWSECN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ** Setup first keylist to LF/SEDPOHL0
     C           KEY1      KLIST
     C                     KFLD           WWDSBA
     C                     KFLD           WWDDPT
     C                     KFLD           WWSECN
     C                     KFLD           WWDDTE
      *
      ** Setup second keylist to LF/SEDPOHL0
     C           KEY2      KLIST
     C                     KFLD           WWDSBA
     C                     KFLD           WWDDPT
     C                     KFLD           WWDSSC
     C                     KFLD           WWDDT2
      *
     C                     MOVE WWEXDT    WWDDTE
     C                     MOVELWWSECN    WWDSSC
      *
      ** SETGT on LF/SEDPOHL0 with key of save Branch and Depot, and
      ** Security and Date.
     C           KEY1      SETGTSEDPOHL0
      *
      ** Read previous record on LF/SEDPOHL0
     C                     READPSEDPOHL0                 30
      *
      **  If multibranching is ON, check if the user is authorised
      **  to the branch
     C           AGMBIN    IFEQ 'Y'
     C                     CALL 'ZVBBU'
     C                     PARM DSBA      WLBRCH  3
     C                     PARM *ZEROS    WLERR   10
     C                     END
      *
     C           WLERR     IFEQ *ZEROS
      *
      ** If record read...
     C           *IN30     IFEQ *OFF
      *
      ** For the same Security, Branch and Depot
     C           DSSC      IFEQ WWSECN
     C           DSBA      ANDEQWWDSBA
     C           DDPT      ANDEQWWDDPT
      *
      ** Setup keylist to LF/SECODPL1
     C           KEY3      KLIST
     C                     KFLD           WWREFN  6
     C                     KFLD           WWOPNB  20
     C                     KFLD           WWDSBA
     C                     KFLD           WWDDPT
      *
      ** Access LF/SECODPL1
     C           KEY3      CHAINSECODPL1             89
     C                     MOVE *IN89     KEY3F   1
      *
      ** Setup keylist to LF/SECODRL0
     C           KEY4      KLIST
     C                     KFLD           WWREFN  6
     C                     KFLD           WWDSBA
     C                     KFLD           WWDDPT
      *
      ** Access LF/SECODRL0
     C           KEY4      CHAINSECODRL0            N89
     C                     MOVE *IN89     KEY4F   1
      *                                                                   CSE020
      ** If CA is a child, restore saved security before writing to       CSE020
      ** the subfile.                                                     CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WKSESN    WWSECN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ** Write the subfile record as per U001
     C                     ADD  1         WWCPT
     C                     EXSR U001
      *
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ** SETGT on LF/SEDPOHL0 with key of saved Branch and Depot,
      ** and Security and Date of *HIVAL.
     C                     MOVEL*HIVAL    WWDSSC
     C                     MOVEL*HIVAL    WWDDT2
      *
     C           KEY2      SETGTSEDPOHL0
      *
     C                     READ SEDPOHL0                 30
      *
     C           *IN30     IFEQ *OFF
     C                     MOVELDSBA      WWDSBA
     C                     MOVELDDPT      WWDDPT
     C                     ENDIF
      *
     C                     ENDDO
      *
      ** End of cycle
     C                     ENDIF
      *
      ** If CA is a child, restore saved Security of the child action.    CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WKSESN    WWSECN                          CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     Z-ADD1         #1RRN
     C                     ENDSR
      *
      *****************************************************************
      * P003   : Validate subfile records                             *
      *****************************************************************
      *
     C           P003      BEGSR
      *
      ** Clear messages from program message queue.
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
      ** Read first subfile record
     C                     Z-ADD1         SFLRRN  40
      *
     C                     READCSE7512S1                 87
      *
      ** Do while records exist in subfile
     C           *IN87     DOWEQ*OFF
     C           *INKC     ANDEQ'0'
     C           *INKL     ANDEQ'0'
      *
      ** Reset error indicators
     C                     MOVE *OFF      *IN50
     C                     MOVE *OFF      *IN51
     C                     MOVE *OFF      *IN52
      *
     C                     MOVE *ON       *IN84            SFLNXTCHG
      *
      ** Set 'RECORD VALID' flag to 'Y'
     C                     MOVE 'Y'       #RECVA  1
     C                     MOVE *BLANKS   W#FLAG                          CSE020
      *
      ** Execute SR/V001 to validate details input.
     C                     EXSR V001
      *
     C           #RECVA    IFEQ 'N'
     C                     MOVE SHIN54    *IN54                           136930
     C                     UPDATSE7512S1
     C                     GOTO TAG1
     C                     ENDIF
      *
      ** If action indicator is changed
     C           DDACN     IFNE ' '
     C                     EXSR P004
      *
     C           #RECVA    IFEQ 'N'
     C                     MOVE SHIN54    *IN54                           136930
     C                     UPDATSE7512S1
     C                     GOTO TAG1
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** If Status is changed...
      ** Or If Final Allocation is changed...
     C           DDSTS     IFNE DDSTSH
     C           DDFLA     ORNE DDFLAH
     C                     MOVE DDSTS     DDSTSH
     C                     MOVE DDFLA     DDFLAH
      *
      ** Update SECODRPD
     C                     EXSR P006
      *                                                                   CSE020
      ** Delete all allocation records of subordinates if F10 is pressed  CSE020
      *                                                                   CSE020
     C           *INKJ     IFEQ '1'                                       CSE020
     C                     EXSR SRDELT                                    CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     ENDIF
      *
      ** Process action
     C           DDACN     IFNE ' '
     C                     EXSR P004A
     C                     ENDIF
      *
     C           #RECVA    IFEQ 'Y'
     C                     MOVE *BLANKS   DDACN
     C                     MOVE '0'       *IN84
     C                     MOVE SHIN54    *IN54                           136930
     C                     UPDATSE7512S1
     C                     ELSE
     C                     MOVE '1'       *IN84
     C                     MOVE SHIN54    *IN54                           136930
     C                     UPDATSE7512S1
     C                     ENDIF
      *
     C           TAG1      TAG
      *
     C                     WRITESE7512C2
      *
      ** Read next subfile record
     C                     READCSE7512S1                 87
     C                     ENDDO
      *
      ** Redisplay current screen
      *
     C           *INKC     IFEQ '0'
     C                     WRITESE7512C2
     C                     WRITESE7512C1
     C                     WRITESE7512F1
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * P004   : Process 'Action'                                     *
      *****************************************************************
      *
     C           P004      BEGSR
      *
      ** If 'Action' is not ' ', 'A', 'E', 'L', 'X' or 'P', error.
     C           DDACN     IFNE ' '                        B*1
     C           DDACN     ANDNE'A'
     C           DDACN     ANDNE'E'
     C           DDACN     ANDNE'L'
     C           DDACN     ANDNE'X'
     C           DDACN     ANDNE'P'
     C           WWMODE    ANDEQ'A'
      *
     C           DDACN     ORNE ' '
     C           DDACN     ANDNE'E'
     C           WWMODE    ANDEQ'E'
      *
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00192' ZAMSID
     C                     EXSR ZASNMS
      *
      ** 'Action' entered is valid...
     C                     ELSE                            X*1
      *
      ** If 'Action' is 'X'.
     C           DDACN     IFEQ 'X'                        B*2
      *                                                                   144398
      **  Check if user is authorised to action 'Authorisation'           144398
      *                                                                   144398
     C           AGMBIN    IFNE 'Y'                                       144398
      *                                                                   144398
      **  If single branch environment                                    144398
      *                                                                   144398
     C                     CALL 'ZVACTU'                                  144398
     C                     PARM 'X'       WLACTN  1                       144398
     C                     PARM *ZERO     WLERR   10                      144398
      *                                                                   144398
     C           WLERR     IFNE *ZERO                                     144398
     C                     MOVE 'N'       #RECVA                          144398
     C                     MOVE *ON       *IN50                           144398
     C                     MOVEL'CO00034' ZAMSID                          144398
     C                     EXSR ZASNMS                                    144398
     C                     ENDIF                                          144398
      *                                                                   144398
     C                     ELSE                                           144398
      *                                                                   144398
      **  If multibranching environment                                   144398
      *                                                                   144398
     C                     CALL 'ZVACTBU'                                 144398
     C                     PARM 'X'       WLACTN  1                       144398
     C                     PARM BVBRCD    WLBRCH  3                       144398
     C                     PARM *ZERO     WLERR   10                      144398
      *                                                                   144398
     C           WLERR     IFEQ 1                                         144398
     C                     MOVE 'N'       #RECVA                          144398
     C                     MOVE *ON       *IN50                           144398
     C                     MOVEL'CO00035' ZAMSID                          144398
     C                     EXSR ZASNMS                                    144398
     C                     ELSE                                           144398
     C           WLERR     IFEQ 2                                         144398
     C                     MOVE 'N'       #RECVA                          144398
     C                     MOVE *ON       *IN50                           144398
     C                     MOVEL'CO00036' ZAMSID                          144398
     C                     EXSR ZASNMS                                    144398
     C                     ENDIF                                          144398
     C                     ENDIF                                          144398
      *                                                                   144398
     C                     ENDIF                                          144398
      *                                                                   144398
     C           WLERR     IFEQ *ZERO                                     144398
      *
      ** Action 'X' is not allowed if status is 'I' (Except for 'NC'), 'X', 'C'
     C           DDSTS     IFEQ 'I'                        B*3
     C           WWPTYP    ANDNE'NC'
     C           DDSTS     OREQ 'X'
     C           DDSTS     OREQ 'C'
     C           DDSTS     OREQ 'R'
      *
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00193' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*3
      *
      ** Action 'X' is not allowed if Final Allocation is 'N' or 'S'.
     C           DDFLA     IFEQ 'N'                        B*3
     C           DDSTS     OREQ 'S'
     C           DDFLA     ANDEQ'S'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00195' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*3
      *
      ** Verify matching between Depot Actual Stock Alloc. and all Customers Act
      ** if Final Allocation indicator is 'S' or 'Y'
      ** Verify matching between Depot Actual Cash Alloc. and all Customers Actu
      ** If Final Allocation indicator is 'Y'
     C           DDFLA     IFEQ 'S'                        B*3
     C           DDFLA     OREQ 'Y'
     C                     EXSR P009
      *
      ** Action 'X' not allowed because NO MATCHING
     C           WWDIFF    IFEQ 'Y'                        B*4
     C           WFIRST    OREQ 'Y'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
      *
     C           DDFLA     IFEQ 'S'                        B*5
     C                     MOVEL'CO00233' ZAMSID
     C                     ELSE                            X*5
     C                     MOVEL'CO00234' ZAMSID
     C                     ENDIF                           E*5
      *
     C                     EXSR ZASNMS
     C                     ELSE                            X*4
      *
      ** Action 'X' not allowed because at least one of the Customers/Books
      ** has no reply (=reply status is not 'R')
     C           WWRPLY    IFEQ 'Y'                        B*5
     C*****      WWPTYP    ANDNE'NC'                                      137877
     C*****      WWPTYP    ANDNE'CC'                               CEU017 137877
     C           WWPTYP    IFEQ 'EX'                       B*6            137877
     C           WWPTYP    OREQ 'RG'                                      137877
     C           WWPTYP    OREQ 'DV'                                      137877
     C           WWPTYP    OREQ 'OF'                                      137877
     C           WWPTYP    OREQ 'FR'                                      137877
     C           WWPTYP    OREQ 'CR'                                      137877
     C           WWPTYP    OREQ 'CE'                                      137877
      *                                                                   137877
     C                     SELEC                                          137877
     C           WWPTYP    WHEQ 'EX'                       B*7            137877
     C           WWREFN    CHAINSECOEXL1             89                   137877
     C           WWPTYP    WHEQ 'RG'                                      137877
     C           WWREFN    CHAINSECORGL1             89                   137877
     C           WWPTYP    WHEQ 'DV'                                      137877
     C           WWREFN    CHAINSECODVL1             89                   137877
     C           WWPTYP    WHEQ 'OF'                                      137877
     C           WWREFN    CHAINSECOOFL1             89                   137877
     C                     ENDSL                           E*7            137877
      *                                                                   137877
     C           MANBOP    IFGT 1                          B*7            137877
     C           MADFNR    ANDEQ*BLANKS                                   137877
     C           WWPTYP    OREQ 'EX'                                      137877
     C           MJDFNR    ANDEQ*BLANKS                                   137877
     C           WWPTYP    OREQ 'RG'                                      137877
     C           MFDFNR    ANDEQ*BLANKS                                   137877
     C           WWPTYP    OREQ 'DV'                                      137877
     C           MDDFNR    ANDEQ*BLANKS                                   137877
     C           MDSDIT    ANDNE'C'                                       164022
     C           MDSDIT    ANDNE'S'                                       164022
     C           WWPTYP    OREQ 'OF'                                      137877
     C           MIDFNR    ANDEQ*BLANKS                                   137877
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00298' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*7            137877
     C                     ENDIF                           E*6            137877
     C                     ENDIF                           E*5
     C                     ENDIF                           E*4
     C                     ENDIF                           E*3
      *
      ** If Market Ex Price is equal to *zeros
     C           MAEXPC    IFEQ *ZEROS                     B*3
      *
     C           WWPTYP    IFEQ 'DV'                       B*4
     C           WWPTYP    OREQ 'OF'
     C           WWPTYP    OREQ 'EX'
     C                     MOVE 'N'       WWZERO  1
      *
     C                     SELEC
      *
      ** If Processing Type is 'DV'
     C           WWPTYP    WHEQ 'DV'                       B*5
     C           WWREFN    SETLLSECODVL1
     C           WWREFN    READESECODVL1                 89
      *
     C           *IN89     DOWEQ'0'                        B*6
     C           WWZERO    ANDEQ'N'
     C           MDSBPR    IFEQ *ZEROS                     B*7
     C           MDMRKI    ANDNE'Y'                                       137877
     C*****      MDSDIT    ANDNE'S'                                136935 137877
     C                     MOVE 'Y'       WWZERO
     C                     ENDIF                           E*7
     C           WWREFN    READESECODVL1                 89
     C                     ENDDO                           E*6
      *
      ** If Processing Type is 'OF'
     C           WWPTYP    WHEQ 'OF'                       B*5
     C           WWREFN    SETLLSECOOFL1
     C           WWREFN    READESECOOFL1                 89
      *
     C           *IN89     DOWEQ'0'                        B*6
     C           WWZERO    ANDEQ'N'
     C           MISUPR    IFEQ *ZEROS                     B*7
     C                     MOVE 'Y'       WWZERO
     C                     ENDIF                           E*7
     C           WWREFN    READESECOOFL1                 89
     C                     ENDDO                           E*6
      *
      ** If Processing Type is 'EX'
     C           WWPTYP    WHEQ 'EX'                       B*5
     C           WWREFN    SETLLSECOEXL1
     C           WWREFN    READESECOEXL1                 89
      *
     C           *IN89     DOWEQ'0'                        B*6
     C           WWZERO    ANDEQ'N'
     C           MJSUPR    IFEQ *ZEROS                     B*7
     C                     MOVE 'Y'       WWZERO
     C                     ENDIF                           E*7
     C           WWREFN    READESECOEXL1                 89
     C                     ENDDO                           E*6
      *
     C                     ENDSL                           E*5
      *
     C           WWZERO    IFEQ 'Y'                        B*5
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00235' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*5
      *
     C                     ELSE                            X*4
     C           WWPTYP    IFNE 'CC'                       B*5            CEU017
     C           WWPTYP    ANDNE'NF'                                      137877
     C           WWPTYP    ANDNE'NC'                                      137877
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00236' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*5            CEU017
     C                     ENDIF                           E*4
     C                     ENDIF                           E*3
      *
     C                     ENDIF                                          144398
     C                     ENDIF                           E*2
      *
      ** If 'Action' is 'L'.
     C           DDACN     IFEQ 'L'                        B*2
      *
      * If customer dummy allocation already has a position against       184520
      * this security stop another allocation taking place until          184520
      * position cleared.                                                 184520
      *                                                                   184520
      * Check customer position file CPOSND to see if live position       184520
      * against dummy customer. Reject allocation if postion not equal    184520
      * zero and send rejection message.                                  184520
     C*                                                                   184520
     C                     MOVE DDBRC     WBRCD1                          184520
     C                     MOVE DDSECU    WSESN1                          184520
     C                     MOVE WDUMMY    WCDCN1                          184520
     C*                                                                   184520
     C                     MOVE '0'       *IN32                           184520
     C*                                                                   184520
     C           *IN33     IFEQ '0'                                                           189119
      *                                                                                       189119
     C           WKEY1     CHAINCPOSN                31                   184520
     C*                                                                   184520
     C           *IN31     IFEQ '0'                                       184520
     C           CSNT      IFNE 0                                         184520
     C           CSNV      ORNE 0                                         184520
     C           CSNS      ORNE 0                                         184520
     C           CSEX      ORNE 0                                         184520
     C                     MOVE '1'       *IN32                           184520
     C                     MOVE '1'       *IN33                                               189119
     C                     END                                            184520
     C                     END                                            184520
     C*                                                                   184520
     C                     END                                                                189119
      *                                                                   184520
      **If*indicator*32*on*send*out*message*and*stop*allocation*run.***                184520 189119
      ** Send warning message to operator that dummy position exists.                         189119
      *                                                                   184520
     C           *IN32     IFEQ '1'                                       184520
     C                     MOVE 'N'       #RECVA                          184520
     C**********           MOVE *ON       *IN50                                        184520 189119
     C**********           MOVEL'CO01112' ZAMSID                                       184520 189119
     C                     MOVEL'CO01113' ZAMSID                                              189119
     C                     EXSR ZASNMS                                    184520
     C                     ENDIF                                          184520
     C*                                                                   184520
      ** Action 'L' is not allowed if status is 'X', 'S', 'C' or 'R'.
     C           DDSTS     IFEQ 'X'                        B*3
     C           DDSTS     OREQ 'S'
     C           DDSTS     OREQ 'C'
     C           DDSTS     OREQ 'R'
      *
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00194' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*3
      *
      ** Action 'L' is not allowed if Final Allocation is 'Y'/'S'.
     C           DDFLA     IFEQ 'Y'                        B*3
     C           DDFLA     OREQ 'S'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00196' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*3
     C/COPY WNCPYSRC,SEH00025
      *                                                                   155622
      ** Action 'L' is not allowed if 'Default No Reply' from             155622
      ** General Information screen is not entered ...                    155622
     C           #RECVA    IFEQ 'Y'                        B*3            155622
     C           MANBOP    ANDGT1                                         155622
     C           MADFNR    IFEQ *BLANKS                    B*4            155622
     C           MADFCP    OREQ *BLANKS                                   155622
     C           MADFSP    OREQ *BLANKS                                   155622
     C                     MOVE 'N'       #RECVA                          155622
     C                     MOVE *ON       *IN50                           155622
     C                     MOVEL'CO00606' ZAMSID                          155622
     C                     EXSR ZASNMS                                    155622
     C                     ENDIF                           E*4            155622
     C                     ENDIF                           E*3            155622
      *                                                                   CSE020
      ** Check if Action 'L' is allowed for child                         CSE020
      *                                                                   CSE020
     C           #RECVA    IFEQ 'Y'                                       CSE020
     C           MAPREF    ANDNE*BLANKS                                   CSE020
      *                                                                   CSE020
      ** Parent is not yet authorised                                     CSE020
      *                                                                   CSE020
     C           MAPREF    CHAINSECORFL1             71                   CSE020
     C           *IN71     IFEQ *OFF                                      CSE020
     C           MNSTAT    ANDNE'X'                                       CSE020
     C                     MOVE 'N'       #RECVA                          CSE020
     C                     MOVE *ON       *IN50                           CSE020
     C                     MOVEL'CO00366' ZAMSID                          CSE020
     C                     EXSR ZASNMS                                    CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
      ** Ex-date of the child is not the same as the Parent Action        CSE020
      *                                                                   CSE020
     C           MACOEX    IFNE MNCOEX                                    CSE020
     C                     MOVE 'N'       #RECVA                          CSE020
     C                     MOVE *ON       *IN50                           CSE020
     C                     MOVEL'CO00370' ZAMSID                          CSE020
     C                     EXSR ZASNMS                                    CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
      ** Initialise array for New Securities                              CSE020
      *                                                                   CSE020
     C                     Z-ADD1         X       30                      CSE020
      *                                                                   CSE020
     C           X         DOWLE180                                       CSE020
     C                     MOVE *BLANKS   NSEC,X                          CSE020
     C                     ADD  1         X                               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
      ** Security of the child action is not equal to one of the New      CSE020
      ** Security of the parent action                                    CSE020
      *                                                                   CSE020
     C                     Z-ADD1         X                               CSE020
      *                                                                   CSE020
     C                     SELEC                                          CSE020
     C           MNPTYP    WHEQ 'DV'                                      CSE020
     C           MNCORF    SETLLSECODVL1                                  CSE020
     C           MNCORF    READESECODVL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MDNSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVEAMNSESN    NSEC,X                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVEAMDNSEC    NSEC,X                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         X                               CSE020
     C           MNCORF    READESECODVL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           MNPTYP    WHEQ 'FR'                                      CSE020
     C           MNCORF    SETLLSECOFRL1                                  CSE020
     C           MNCORF    READESECOFRL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MENSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVEAMNSESN    NSEC,X                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVEAMENSEC    NSEC,X                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         X                               CSE020
     C           MNCORF    READESECOFRL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           MNPTYP    WHEQ 'CR'                                      CSE020
     C           MNCORF    SETLLSECOCRL1                                  CSE020
     C           MNCORF    READESECOCRL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MHSECA    IFEQ *BLANKS                                   CSE020
     C                     MOVEAMNSESN    NSEC,X                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVEAMHSECA    NSEC,X                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  20        X                               CSE020
     C           MNCORF    READESECOCRL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           MNPTYP    WHEQ 'OF'                                      CSE020
     C           MNCORF    SETLLSECOOFL1                                  CSE020
     C           MNCORF    READESECOOFL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MINSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVE MNSESN    NSEC,X                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE MINSEC    NSEC,X                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         X                               CSE020
     C           MNCORF    READESECOOFL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           MNPTYP    WHEQ 'RG'                                      CSE020
     C           MNCORF    SETLLSECORGL1                                  CSE020
     C           MNCORF    READESECORGL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MFNSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVE MNSESN    NSEC,X                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE MFNSEC    NSEC,X                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         X                               CSE020
     C           MNCORF    READESECORGL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           MNPTYP    WHEQ 'EX'                                      CSE020
     C           MNCORF    SETLLSECOEXL1                                  CSE020
     C           MNCORF    READESECOEXL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MJNSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVE MNSESN    NSEC,X                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE MJNSEC    NSEC,X                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         X                               CSE020
     C           MNCORF    READESECOEXL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           MNPTYP    WHEQ 'NC'                                      CSE020
     C           MNCORF    SETLLSECONCL1                                  CSE020
     C           MNCORF    READESECONCL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MLSESN    IFEQ *BLANKS                                   CSE020
     C                     MOVE MNSESN    NSEC,X                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE MLSESN    NSEC,X                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         X                               CSE020
     C           MNCORF    READESECONCL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           MNPTYP    WHEQ 'CC'                                      CSE020
     C           MNCORF    SETLLSECOCCL2                                  CSE020
     C           MNCORF    READESECOCCL2                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           NANSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVE MNSESN    NSEC,X                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE NANSEC    NSEC,X                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         X                               CSE020
     C           MNCORF    READESECOCCL2                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C                     ENDSL                                          CSE020
      *                                                                   CSE020
      ** Validate security of the child such that it is equal to          CSE020
      ** new security of the parent                                       CSE020
      *                                                                   CSE020
     C           MASESN    LOKUPNSEC                     88               CSE020
     C           *IN88     IFEQ '0'                                       CSE020
     C                     MOVE 'N'       #RECVA                          CSE020
     C                     MOVE '1'       *IN50                           CSE020
     C                     MOVEL'CO00371' ZAMSID                          CSE020
     C                     EXSR ZASNMS                                    CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     ENDIF                           E*2
      *
      ** If action is 'A', 'E', 'P', 'L' or 'X', Ex-date must not be greater tha
      ** or equal to rundate.
     C                     MOVE WWEXDT    WWEXDN  50
     C           DDACN     IFEQ 'A'                        B*2
     C           DDACN     OREQ 'E'
     C           DDACN     OREQ 'P'
     C           DDACN     OREQ 'L'
     C           DDACN     OREQ 'X'
     C           WWEXDN    IFGE BJRDNB                     B*3
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00197' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*3
     C                     ENDIF                           E*2
      *
      ** Action 'L' is allowed if all the fields mandatory for the
      ** requested stage are not blanks or zero.
     C                     MOVE *BLANKS   WWSTGL  2
     C                     MOVE *BLANK    WWSTGX  1
      *
     C           DDACN     IFEQ 'L'                        B*2
     C           DDACN     OREQ 'A'
      *
      ** Setup the requested stage
     C                     MOVEL'L'       WWSTGL
     C                     MOVE DDFLA     WWSTGL
     C                     EXSR P007
     C                     ENDIF                           E*2
      *
      ** Action 'X' is allowed if all the fields mandatory for the
      ** requested stage are not blank or zero.
     C           DDACN     IFEQ 'X'                        B*2
      *
      ** Setup the requested stage
     C           DDFLA     IFEQ 'S'                        B*3
     C                     MOVE 'S'       WWSTGX
     C                     ENDIF                           E*3
      *
     C           DDFLA     IFEQ 'Y'                        B*3
     C                     MOVE 'X'       WWSTGX
     C                     ENDIF                           E*3
      *
     C                     EXSR P007
     C                     ENDIF                           E*2
      *
      ** If 'Action' is 'P'.
      ** Action 'P' is not allowed for status 'I', 'R'.
     C           DDACN     IFEQ 'P'                        B*2
     C           DDSTS     ANDEQ'I'
     C           DDACN     OREQ 'P'
     C           DDSTS     ANDEQ'R'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00198' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*2
      *
      ** If 'Action' is 'A'.
     C           DDACN     IFEQ 'A'                        B*2
      *
      ** Action 'A' is not allowed for status 'C' or 'R'.
     C           DDSTS     IFEQ 'C'                        B*3
     C           DDSTS     OREQ 'R'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00199' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*3
      *
      ** Action 'A' is not allowed for processing type 'NC' and 'NF'
     C           WWPTYP    IFEQ 'NC'                       B*3
     C           WWPTYP    OREQ 'NF'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00291' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*3
     C                     ENDIF                           E*2
      *
     C                     ENDIF                           E*1
      *
     C                     ENDSR
      *
      *****************************************************************
      * P004A  : Process Action                                       *
      *****************************************************************
      *
     C           P004A     BEGSR
      *
      ** If Action is 'Allocation'('L') or 'Authorisation'('X'),
      ** process Confirmation.
     C           DDACN     IFEQ 'L'
     C           DDACN     OREQ 'X'
     C                     EXSR P005
     C                     ENDIF
      *
      ** If no error, process 'Action'.
     C           *IN50     IFEQ *OFF
      *
     C           DDACN     CASEQ'A'       P008
     C           DDACN     CASEQ'E'       P008
     C           DDACN     CASEQ'L'       PALOC
     C           DDACN     CASEQ'X'       PATHR
     C           DDACN     CASEQ'P'       PPRNT
     C                     END
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * P005   : Process 'Confirmation' screen                        *
      *****************************************************************
      *
     C           P005      BEGSR
      *
      ** Move subfile record fields to confirmation screen fields.
     C                     MOVELDDBRC     DDBRC2
     C                     MOVELDDDEP     DDDEP2
     C                     MOVELDDDEPS    DDDP2S
     C                     MOVELDDEDP     DDEDP2
     C                     MOVELDDLTA     DDLTA2
     C                     MOVELDDFLA     DDFLA2
     C                     MOVELDDSTS     DDSTS2
     C                     MOVE SHIN54    *IN54                           136930
      *
      ** Initialise 'Confirmation' indicator to blank and setup the
      ** narrative.
     C                     MOVE *BLANK    DDCONF
      *
     C           DDACN     IFEQ 'L'
     C                     MOVE *OFF      *IN53
     C                     ELSE
     C                     MOVE *ON       *IN53
     C                     ENDIF
      *
     C                     MOVE TXT,2     ##CTX1
     C                     MOVE *BLANKS   DDCONF
      *
      ** Loop while F3 or F12 is not pressed, or an error occurs.
     C           *INKC     DOWEQ*OFF
     C           *INKL     ANDEQ*OFF
     C           DDCONF    ANDNE'Y'
     C           DDCONF    ANDNE'N'
      *
     C                     WRITESE7512C2
     C                     WRITESE7512F1
     C                     EXFMTSE7512F2
      *
     C           *INKC     IFEQ *OFF
     C           *INKL     ANDEQ*OFF
      *
      ** Clear messages from program message queue.
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
     C                     MOVE *OFF      *IN55
     C           DDCONF    IFNE 'Y'
     C           DDCONF    ANDNE'N'
     C                     MOVE *ON       *IN55
     C                     MOVEL'CO00200' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDDO
      *
     C           #1RRN     CHAINSE7512S1             89
      *
     C           *INKL     IFEQ *ON
     C                     MOVE *OFF      *INKL
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * P006   : UPDATE PF/SECODRPD                                   *
      *****************************************************************
      *
     C           P006      BEGSR
      *
     C                     MOVELDDBRC     WWDSBA
     C                     MOVELDDDEP     WWDDPT
      *
     C           KEY4      CHAINSECODRL0             89
      *
      ** If no record found, write a new record to PF/SECODRPD.
     C           *IN89     IFEQ *ON
      *
      ** Write details as per U002
     C                     MOVE 'W'       WWWRUP  1
     C                     EXSR U002
     C                     WRITESECODRD0
      *
      ** If a record is found, update the record in PF/SECODRPD.
     C                     ELSE
      *
      ** Update details as per U002
     C                     MOVE 'U'       WWWRUP
     C                     EXSR U002
     C                     UPDATSECODRD0
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * P007   : Process the corporate action type                    *
      *****************************************************************
      *
     C           P007      BEGSR
      *
      ** Reset error indicator
     C                     MOVE *BLANKS   ERROR
      *
      ** Trial Allocation ('LN')
     C           WWSTGL    IFEQ 'LN'                       B*1
      ** Final Allocation Stock ('LS')
     C           WWSTGL    OREQ 'LS'
      ** Final Allocation Cash and Stock ('LY')
     C           WWSTGL    OREQ 'LY'
      ** Stock Authorised ('S')
     C           WWSTGX    OREQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MACOEX    IFEQ *ZEROS                     B*2
     C           MATDVD    OREQ *BLANKS
     C           MAREFO    OREQ *BLANKS
     C                     MOVE 'Y'       ERROR
     C                     ELSE                            X*2
      *
      ** Stock Authorised ('S')
     C           WWSTGX    IFEQ 'S'                        B*3
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MAALEF    IFEQ *ZEROS                     B*4
     C                     MOVE 'Y'       ERROR
     C                     ENDIF                           E*4
     C                     ENDIF                           E*3
     C                     ENDIF                           E*2
     C                     ENDIF                           E*1
      *
     C           ERROR     IFEQ *BLANKS                    B*1
     C           WWPTYP    ANDNE'NC'
     C           WWPTYP    ANDNE'NF'
     C           WWPTYP    ANDNE'CC'                                      CEU017
      *
      ** Read LF according to Processing type
     C                     SELEC                           B*2
     C           WWPTYP    WHEQ 'DV'
     C           WWREFN    SETLLSECODVL1
     C           WWREFN    READESECODVL1                 89
      *
     C           WWPTYP    WHEQ 'FR'
     C           WWREFN    SETLLSECOFRL1
     C           WWREFN    READESECOFRL1                 89
      *
     C           WWPTYP    WHEQ 'RG'
     C           WWREFN    SETLLSECORGL1
     C           WWREFN    READESECORGL1                 89
      *
     C           WWPTYP    WHEQ 'CE'
     C           WWREFN    SETLLSECOCEL1
     C           WWREFN    READESECOCEL1                 89
      *
     C           WWPTYP    WHEQ 'CR'
     C           WWREFN    SETLLSECOCRL1
     C           WWREFN    READESECOCRL1                 89
      *
     C           WWPTYP    WHEQ 'OF'
     C           WWREFN    SETLLSECOOFL1
     C           WWREFN    READESECOOFL1                 89
      *
     C           WWPTYP    WHEQ 'EX'
     C           WWREFN    SETLLSECOEXL1
     C           WWREFN    READESECOEXL1                 89
      *
     C                     ENDSL                           E*2
      *
      ** Execute subroutine according to Processing type.
     C           *IN89     DOWEQ'0'                        B*2
     C           ERROR     ANDEQ' '
      *
     C                     SELEC                           B*3
     C           WWPTYP    WHEQ 'DV'
     C                     EXSR V0DV
     C           WWREFN    READESECODVL1                 89
      *
     C           WWPTYP    WHEQ 'FR'
     C                     EXSR V0FR
     C           WWREFN    READESECOFRL1                 89
      *
     C           WWPTYP    WHEQ 'RG'
     C                     EXSR V0RG
     C           WWREFN    READESECORGL1                 89
      *
     C           WWPTYP    WHEQ 'CE'
     C                     EXSR V0CE
     C           WWREFN    READESECOCEL1                 89
      *
     C           WWPTYP    WHEQ 'CR'
     C                     EXSR V0CR
     C           WWREFN    READESECOCRL1                 89
      *
     C           WWPTYP    WHEQ 'OF'
     C                     EXSR V0OF
     C           WWREFN    READESECOOFL1                 89
      *
     C           WWPTYP    WHEQ 'EX'
     C                     EXSR V0EX
     C           WWREFN    READESECOEXL1                 89
      *
     C                     ENDSL                           E*3
      *
     C                     ENDDO                           E*2
     C                     ELSE                            X*1            CEU017
     C           WWPTYP    IFEQ 'CC'                       B*2            CEU017
     C           WWREFN    SETLLSECOCCL2                                  CEU017
     C           WWREFN    READESECOCCL2                 89               CEU017
     C                     EXSR V0CC                                      CEU017
     C                     ENDIF                           E*2            CEU017
     C                     ENDIF                           E*1
      *
      ** If error...
     C           ERROR     IFEQ 'Y'                        B*1
     C           MAALEF    IFEQ *ZEROS                     B*2
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00296' ZAMSID
     C                     EXSR ZASNMS
     C                     ELSE                            E*1
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN50
     C                     MOVEL'CO00201' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF                           E*1
     C                     ENDIF                           E*1
      *
     C                     ENDSR
      *
      *****************************************************************
      * P008   : Call Depot Maintenance program                       *
      *****************************************************************
      *
     C           P008      BEGSR
      *
      **  If number of options is greater than 1
     C                     MOVE WWNBOP    W2NBOP  20       Number of Options
     C           W2NBOP    IFGT 1                          B*1
      *
     C                     CALL 'SE7592'               99
     C                     PARM           WWREFN           ER Reference
     C                     PARM           WWSECN           Security Shortname
     C                     PARM           WWCOAT           Corporate Action Type
     C                     PARM           WWPTYP           Processing Type
     C                     PARM           WWEXDT           Ex-Date
     C                     PARM           WWNBOP           Number of Options
     C**********           PARM DDACN     WWMODE  1        Amend or Enqui 156532
     C                     PARM DDACN     WWACTN  1        Amend/Enquiry  156532
     C                     PARM DDBRC     WWBRCD  3        Branch
     C                     PARM DDDEP     WWDEPT  6        Depot
     C                     PARM DDEDP     WWEXPO 17        Ex-date position
     C                     PARM DDLTA     WWCOAD  6        Last Allocation Date
     C                     PARM DDSTS     WWCOST  1        Status
     C                     PARM DDFLA     WWFAID  1        Last Allocation Indic
     C                     PARM DDNCCY    WWNCCY  3        Nominal Currency
     C                     PARM *BLANKS   WWUPDT  1        Update done ?
     C                     PARM *BLANKS   WWRTCD  1        Return Code
      *
     C                     ELSE                            X*1
      *
     C                     CALL 'SE7593'               99
     C                     PARM           WWREFN  6        ER Reference
     C                     PARM           WWSECN 10        Security Shortname
     C                     PARM           WWCOAT  2        Corporate Action Type
     C                     PARM           WWPTYP  2        Processing Type
     C                     PARM           WWEXDT  5        Ex-Date
     C                     PARM '??'      WWNBOP  2        Option Number
     C                     PARM DDACN     WWACTN  1        Action 'A' or 'E'
     C                     PARM DDBRC     WWBRCD  3        Branch
     C                     PARM DDDEP     WWDEPT  6        Depot
     C                     PARM DDEDP     WWEXPO 17        Ex-date position
     C                     PARM DDLTA     WWCOAD  6        Last Allocation Date
     C                     PARM DDSTS     WWSTAT  1        Corporate Action Stat
     C                     PARM DDFLA     WWFINA  1        Final Allocation Indi
     C                     PARM DDNCCY    WWNCCY  3        Nominal Currency
     C                     PARM *BLANKS   WWUPDT  1        Update done ?
     C                     PARM *BLANKS   WWRTCD  1        Return Code
     C                     ENDIF                           E*1
      *
      **  If error indicator of the called program is on, Database error
     C           *IN99     IFEQ '1'                        B*1
     C           WWRTCD    OREQ 'E'
      *
     C           *LOCK     IN   LDA
     C           W2NBOP    IFGT 1                          B*2
     C                     MOVEANARR,2    DBKEY
     C                     ELSE                            X*2
     C                     MOVEANARR,3    DBKEY
     C                     ENDIF                           E*2
      *
     C                     MOVEL'003'     DBASE            *****************
     C                     MOVEL*BLANKS   DBFILE           ** DB ERROR 03 **
     C                     OUT  LDA                        *****************
     C                     EXSR *PSSR
     C                     ENDIF                           E*1
      *
     C           WWRTCD    IFEQ '3'                        B*1
     C                     MOVE '1'       *INKC
     C                     ENDIF                           E*1
      *
     C           WWUPDT    IFEQ 'Y'                        B*1
     C                     MOVELDDBRC     WWDSBA
     C                     MOVELDDDEP     WWDDPT
     C           KEY4      CHAINSECODRL0             89
     C                     Z-ADDBJRDNB    MSCOAD
     C                     MOVE 'L'       MSCOST
     C                     UPDATSECODRD0
      *
     C                     Z-ADDBJRDNB    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     DDLTA
     C                     MOVE 'L'       DDSTS
     C                     MOVE 'L'       DDSTSH
     C                     ENDIF                           E*1
      *
     C                     ENDSR
      *
      *****************************************************************
      * P009   : Verification for the action 'X'                      *
      *****************************************************************
      *
     C           P009      BEGSR
      *
     C                     MOVE 'N'       WWDIFF  1
     C                     MOVE 'N'       WWRPLY  1
     C                     MOVE DDBRC     WWDSBA
     C                     MOVE DDDEP     WWDDPT
      *
     C           WWREFN    SETLLSECOALL7
      *
     C                     MOVE 'Y'       WFIRST  1
     C                     Z-ADD*ZEROS    WWOPTN  20
     C                     MOVE *BLANKS   WWSESN 10
     C                     Z-ADD*ZEROS    WWASTA 150
     C                     Z-ADD*ZEROS    WWACAA 150
      *
     C                     MOVE '0'       *IN61
      *
      ** Do while not end of file or a difference is found
     C           *IN61     DOWEQ'0'                        B*2
     C           WWDIFF    ANDEQ'N'
     C*****      WWRPLY    ANDEQ'N'                                       137879
      *
     C           WWREFN    READESECOALL7                 61
      *
      ** If record read for same Branch and Depot than fields from subfile recor
     C           MCBRCD    IFEQ WWDSBA                     B*3
     C           MCDDPT    ANDEQWWDDPT
     C           *IN61     ANDEQ'0'
      *
      ** If it's the first time
     C           WFIRST    IFEQ 'Y'                        B*4
     C                     Z-ADDMCOPTN    WWOPTN
     C                     MOVE MCSESN    WWSESN
     C                     MOVE 'N'       WFIRST
     C                     ENDIF                           E*4
      *
      ** If change of Option number
     C           MCOPTN    IFNE WWOPTN                     B*4
     C           MCSESN    ORNE WWSESN
     C                     MOVE '0'       *IN33                                               189119
      *                                                                                       189119
      *
      ** Setup keylist to LF/SECODPL1
     C           KEY5      KLIST
     C                     KFLD           WWREFN  6
     C                     KFLD           WWOPTN
     C                     KFLD           WWDSBA
     C                     KFLD           WWDDPT
     C                     KFLD           WWSESN
      *
      ** Access LF/SECODPL1
     C           KEY5      CHAINSECODPL1             89
      *
     C           *IN89     IFEQ '1'                        B*5
     C           *LOCK     IN   LDA
     C                     MOVEL'004'     DBASE            ***************
     C                     MOVE 'SECODPL1'DBFILE           * DB ERROR 04 *
     C                     MOVEL'SEE DUMP'DBKEY            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF                           E*5
      *
      **  Stock Allocation of the depot must match the actual stock allocation
      **  of all customers holding a position at the depot
     C           MBASTA    IFNE WWASTA                     B*5
     C                     MOVE 'Y'       WWDIFF
     C                     ENDIF                           E*5
     C                     Z-ADDMCASTA    WWASTA
      *
      **  Total Cash Allocation of the depot must match the Total actual cash al
      **  of all customers holding a position at the depot
      **  (Total Cash = Actual Cash Allocation + Actual Cash Rounding)
     C           DDFLA     IFEQ 'Y'                        B*5
     C                     Z-ADD*ZEROS    WTOTCA 150
     C           MBACAA    ADD  MBACAR    WTOTCA
     C           WTOTCA    IFNE WWACAA                     B*6
     C                     MOVE 'Y'       WWDIFF
     C                     ENDIF                           E*6
     C                     Z-ADDMCACAA    WWACAA
     C                     ADD  MCACAR    WWACAA
     C                     ENDIF                           E*5
      *
     C                     Z-ADDMCOPTN    WWOPTN
     C                     MOVE MCSESN    WWSESN
      *
     C                     ELSE                            X*4
     C                     ADD  MCASTA    WWASTA
     C           DDFLA     IFEQ 'Y'                        B*5
     C                     ADD  MCACAA    WWACAA
     C                     ADD  MCACAR    WWACAA
     C                     ENDIF                           E*5
     C                     ENDIF                           E*4
      *
     C                     ENDIF                           E*3
      *
     C           MCREST    IFNE 'R'                        B*3
     C           WWDIFF    ANDEQ'N'
     C           WWPTYP    ANDNE'CC'                                      CEU017
     C*****                MOVE 'N'       WFIRST                          137879
     C                     MOVE 'Y'       WWRPLY
     C                     ENDIF                           E*3
      *
     C                     ENDDO                           E*2
      *
     C****       WWDIFF    IFEQ 'N'                        B*2            137879
      ****                                                                137879
     C****       MBASTA    IFNE WWASTA                     B*3            137879
     C****       WTOTCA    ORNE WWACAA                                    137879
     C****                 MOVE 'Y'       WWDIFF                          137879
     C****                 ENDIF                           E*3            137879
      ****                                                                137879
     C****                 ENDIF                           E*2            137879
      *                                                                   137879
     C           WWDIFF    IFEQ 'N'                        B*1            137879
     C           WFIRST    ANDNE'Y'                                       137879
      *                                                                   137879
      ** Access LF/SECODPL1                                               137879
     C           KEY5      CHAINSECODPL1             89                   137879
      *                                                                   137879
     C           *IN89     IFEQ '1'                        B*2            137879
     C           *LOCK     IN   LDA                                       137879
     C                     MOVEL'005'     DBASE            ***************137879
     C                     MOVE 'SECODPL1'DBFILE           * DB ERROR 05 *137879
     C                     MOVEL'SEE DUMP'DBKEY            ***************137879
     C                     OUT  LDA                                       137879
     C                     EXSR *PSSR                                     137879
     C                     ENDIF                           E*2            137879
      *                                                                   137879
     C                     Z-ADD*ZEROS    WTOTCA                          137879
     C           MBACAA    ADD  MBACAR    WTOTCA                          137879
      *                                                                   137879
     C           MBASTA    IFNE WWASTA                     B*2            137879
     C           WTOTCA    ORNE WWACAA                                    137879
     C           DDFLA     ANDEQ'Y'                                       137879
     C                     MOVE 'Y'       WWDIFF                          137879
     C                     ENDIF                           E*2            137879
      *                                                                   137879
     C                     ENDIF                           E*1            137879
      *
     C                     ENDSR
      *
      *****************************************************************
      * V001   : Validate subfile record                              *
      *****************************************************************
      *
     C           V001      BEGSR
      *
      ** If Final Allocation is changed...
     C           DDFLA     IFNE DDFLAH
      *                                                                   159517
     C           WWPTYP    IFEQ 'RG'                                      159517
     C           WWREFN    CHAINSECORGL1             89                   159517
      *                                                                   159517
     C           DDFLAH    IFEQ 'N'                                       159517
     C           DDFLA     ANDEQ'S'                                       159517
     C           DDFLAH    OREQ 'N'                                       159517
     C           DDFLA     ANDEQ'Y'                                       159517
      *                                                                   159517
     C           WWREFN    CHAINSECOEXL2             89                   159517
      *                                                                   159517
     C           *IN89     IFEQ '1'                                       159517
     C                     MOVE 'N'       #RECVA                          159517
     C                     MOVE *ON       *IN51                           159517
     C                     MOVEL'CO00608' ZAMSID                          159517
     C                     EXSR ZASNMS                                    159517
     C                     ENDIF                                          159517
     C                     ENDIF                                          159517
     C                     ENDIF                                          159517
      *
      ** Final Allocation
      ** Final Allocation is not 'N', 'S' or 'Y'.
     C           DDFLA     IFNE 'N'
     C           DDFLA     ANDNE'S'
     C           DDFLA     ANDNE'Y'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN51
     C                     MOVEL'CO00188' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ** If current status is 'I', 'X', 'R' or 'C', Final Allocation
      ** cannot be amended.
     C           DDFLA     IFNE DDFLAH
     C           DDSTSH    IFEQ 'I'
     C           DDSTSH    OREQ 'X'
     C           DDSTSH    OREQ 'R'
     C           DDSTSH    OREQ 'C'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN51
     C                     MOVEL'CO00189' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF
      *
      ** If current status is 'S', Final Allocation can only be amended
      ** to 'Y'.
     C           DDFLA     IFNE 'Y'
     C           DDSTSH    ANDEQ'S'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN51
     C                     MOVEL'CO00190' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     ENDIF
      *
      ** If Status is changed...
     C           DDSTS     IFNE DDSTSH
      *
     C           DDSTS     IFEQ 'L'
     C           DDSTSH    ANDNE'X'
     C           DDSTSH    ANDNE'S'
     C           DDSTS     OREQ 'S'
     C           DDSTSH    ANDNE'X'
     C           DDSTS     ORNE 'L'
     C           DDSTS     ANDNE'S'
     C                     MOVE 'N'       #RECVA
     C                     MOVE *ON       *IN52
     C                     MOVEL'CO00191' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *                                                                   CSE020
      ** If Status is changed from 'X' to 'L', all the allocation records CSE020
      ** for the child, grandchild, and so on should be deleted from      CSE020
      ** SECOALPD, SECODPPD, and SECODRPD                                 CSE020
      *                                                                   CSE020
     C           CSE020    IFEQ 'Y'                                       CSE020
      *                                                                   CSE020
     C           DDSTS     IFEQ 'L'                                       CSE020
     C           DDSTSH    ANDEQ'X'                                       CSE020
     C           *INKJ     ANDEQ'0'                                       CSE020
     C                     MOVE 'N'       #RECVA                          CSE020
     C                     MOVE *ON       *IN52                           CSE020
     C                     MOVEL'CO00372' ZAMSID                          CSE020
     C                     EXSR ZASNMS                                    CSE020
     C                     MOVE 'Y'       W#FLAG  1                       CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     ENDIF                                          CSE020
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * V0DV   : 'DV' Processing Type                                 *
      *****************************************************************
      *
     C           V0DV      BEGSR
      *
      ** Select requested stage for Dividends Events.
      *
      ** Trial Allocation ('LN')
     C           WWSTGL    IFEQ 'LN'                       B*1
      ** Final Allocation Stock ('LS')
     C           WWSTGL    OREQ 'LS'
      ** Final Allocation Cash and Stock ('LY')
     C           WWSTGL    OREQ 'LY'
      ** Stock Authorised ('S')
     C           WWSTGX    OREQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MDNSEC    IFEQ *BLANKS                    B*2
     C           MDSDIT    OREQ *BLANKS
      *
     C********** MDDIVU    OREQ *ZEROS                                    190204
     C           MDDIV1    OREQ *ZEROS                                    190204
     C           MDSDIT    ANDEQ'C'
     C********** MDDIVU    OREQ *ZEROS                                    190204
     C           MDDIV1    OREQ *ZEROS                                    190204
     C           MDSDIT    ANDEQ'O'
     C********** MDDIVU    OREQ *ZEROS                                    190204
     C           MDDIV1    OREQ *ZEROS                                    190204
     C           MDSDIT    ANDEQ'R'
      *
     C********** MDDIVU    OREQ *ZEROS                                    190204
     C           MDDIV1    OREQ *ZEROS                                    190204
     C           MDNSHA    ANDEQ*ZEROS
     C           MDSDIT    ANDEQ'S'
      *
     C******     MDSBPR    OREQ *ZEROS                                    135690
     C******     MDSDIT    ANDEQ'R'                                135689 135690
     C           MDSDIT    OREQ 'R'                                       135690
     C           MDSBPR    ANDEQ*ZEROS                                    135690
     C           MDMRKI    ANDNE'Y'                                       135690
     C           MDSBPR    OREQ *ZEROS                                    135689
     C           MDMRKI    ANDNE'Y'                                       135690
     C********** MDDIVU    ANDNE*ZEROS                              135689190204
     C           MDDIV1    ANDNE*ZEROS                                    190204
     C           MDSDIT    ANDEQ'S'                                       135689
     C           MDSBPR    OREQ *ZEROS                                    135689
     C           MDMRKI    ANDNE'Y'                                       135690
     C           MDNSHA    ANDEQ*ZEROS                                    135689
     C           MDSDIT    ANDEQ'O'                                       135689
      *
     C******     MDDSRT    OREQ *ZEROS                                    135689
     C******     MDSDIT    ANDEQ'R'                                       135689
      *
     C           MDNSHA    OREQ *ZEROS
     C           MDSDIT    ANDEQ'C'
     C           MDNSHA    OREQ *ZEROS                                    135689
     C           MDSBPR    ANDEQ*ZEROS                                    135689
     C           MDMRKI    ANDNE'Y'                                       135690
     C           MDSDIT    ANDEQ'O'
      *
     C           MDOSHA    OREQ *ZEROS
     C           MDNSHA    ANDNE*ZEROS
     C           MDDMLT    OREQ *ZEROS
     C           MDRNDN    OREQ *BLANKS
     C           MDRNDS    OREQ *BLANKS
      *
     C           MDCOMP    OREQ *ZEROS
     C           MDRNDS    ANDEQ'Y'
      *
     C           MDOPSH    OREQ *BLANKS
     C                     MOVE 'Y'       ERROR   1
      *
     C                     ELSE                            X*2
     C           MDSBRT    IFEQ 'Y'                        B*3
     C           MDSBRS    IFEQ *BLANKS                    B*4
     C*****      MDREPR    OREQ *ZEROS                                    137877
     C           MDREXD    OREQ *ZEROS
     C           MDREAT    OREQ *BLANKS
     C           MDRTRF    OREQ *ZEROS
     C           WWSTGX    ANDEQ'S'                                       137877
     C           MDRTRF    OREQ *ZEROS                                    137877
     C           WWSTGX    ANDEQ'X'                                       137877
     C           MDRTRT    OREQ *ZEROS
     C           WWSTGX    ANDEQ'S'                                       137877
     C           MDRTRT    OREQ *ZEROS                                    137877
     C           WWSTGX    ANDEQ'X'                                       137877
     C           MDRNNS    OREQ *ZEROS
     C           MDRNRI    OREQ *ZEROS
     C           MDRMLT    OREQ *ZEROS
     C*****      MDRDIV    OREQ *ZEROS                                    137877
     C                     MOVE 'Y'       ERROR   1
     C                     ENDIF                           E*4
     C                     ENDIF                           E*3
      *
     C                     ENDIF                           E*2
      *
     C                     ENDIF                           E*1
      *
      ** Stock Authorised ('S')
     C           WWSTGX    IFEQ 'S'                        B*1
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MDSBRT    IFEQ 'Y'                        B*2
     C           MDREXA    ANDEQ*ZEROS
     C                     MOVE 'Y'       ERROR   1
     C                     ENDIF                           E*2
     C                     ENDIF                           E*1
      *
     C                     ENDSR
      *
      *****************************************************************
      * V0FR   : 'FR' Processing Type                                 *
      *****************************************************************
      *
     C           V0FR      BEGSR
      *
      ** Status Allocated, Trial Allocation ('LN')
     C           WWSTGL    IFEQ 'LN'
      ** Final Allocation Stock ('LS')
     C           WWSTGL    OREQ 'LS'
      ** Final Allocation Cash and Stock ('LY')
     C           WWSTGL    OREQ 'LY'
      ** Stock Authorised ('S')
     C           WWSTGX    OREQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MENSEC    IFEQ *BLANKS
     C           MENSHA    OREQ *ZEROS
     C           MEOSHA    OREQ *ZEROS
     C           MEADRE    OREQ *BLANKS
     C           MEDMLT    OREQ *ZEROS
     C           MERNDN    OREQ *BLANKS
     C           MERNDS    OREQ *BLANKS
     C           MECOMP    OREQ *ZEROS
     C           MERNDS    ANDEQ'Y'
     C           MEOPSH    OREQ *BLANKS
     C                     MOVE 'Y'       ERROR
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * V0RG   : 'RG' Processing Type                                 *
      *****************************************************************
      *
     C           V0RG      BEGSR
      *
      ** Status Allocated, Trial Allocation ('LN')
     C           WWSTGL    IFEQ 'LN'
      ** Final Allocation Stock ('LS')
     C           WWSTGL    OREQ 'LS'
      ** Final Allocation Cash and Stock ('LY')
     C           WWSTGL    OREQ 'LY'
      ** Stock Authorised ('S')
     C           WWSTGX    OREQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MFNSEC    IFEQ *BLANKS
     C           MFRIMP    OREQ *ZEROS
     C           MFADRE    OREQ *BLANKS
     C           MFNSHA    OREQ *ZEROS
     C           MFOSHA    OREQ *ZEROS
     C           MFDMLT    OREQ *ZEROS
     C           MFRNDN    OREQ *BLANKS
     C           MFRNDS    OREQ *BLANKS
     C           MFCOMP    OREQ *ZEROS
     C           MFRNDS    ANDEQ'Y'
     C           MFOPSH    OREQ *BLANKS
     C*****      MFSBRS    OREQ *BLANKS                                   159517
     C*****      MFSBRP    OREQ *ZEROS                                    159517
     C*****      MFREXD    OREQ *ZEROS                                    159517
     C*****      MFREXA    OREQ *ZEROS                                    159517
     C*****      MFREAT    OREQ *BLANKS                                   159517
     C*****      MFRTRF    OREQ *ZEROS                                    159517
     C*****      MFRTRT    OREQ *ZEROS                                    159517
     C*****      MFRNNS    OREQ *ZEROS                                    159517
     C*****      MFRNRI    OREQ *ZEROS                                    159517
     C*****      MFRMLT    OREQ *ZEROS                                    159517
     C*****      MFRDIV    OREQ *ZEROS                                    137877
     C*****      MFAVOP    OREQ *BLANKS                                   159517
     C                     MOVE 'Y'       ERROR
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * V0CE   : 'CE' Processing Type                                 *
      *****************************************************************
      *
     C           V0CE      BEGSR
      *
      ** Status Allocated, Trial Allocation ('LN')
     C           WWSTGL    IFEQ 'LN'
      ** Final Allocation Stock ('LS')
     C           WWSTGL    OREQ 'LS'
      ** Final Allocation Cash and Stock ('LY')
     C           WWSTGL    OREQ 'LY'
      ** Stock Authorised ('S')
     C           WWSTGX    OREQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MGCARE    IFEQ *ZEROS
     C           MGOPSH    OREQ *BLANKS
     C                     MOVE 'Y'       ERROR
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * V0CR   : 'CR' Processing Type                                 *
      *****************************************************************
      *
     C           V0CR      BEGSR
      *
      ** Status Allocated, Trial Allocation ('LN')
     C           WWSTGL    IFEQ 'LN'
      ** Final Allocation Stock ('LS')
     C           WWSTGL    OREQ 'LS'
      ** Final Allocation Cash and Stock ('LY')
     C           WWSTGL    OREQ 'LY'
      ** Stock Authorised ('S')
     C           WWSTGX    OREQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MHOSHA    IFEQ *ZEROS
     C*****      MHCAPA    OREQ *ZEROS                                    135689
     C           MHADRE    OREQ *BLANKS
     C           MHOPSH    OREQ *BLANKS
     C           MHSECA    OREQ *BLANKS
     C           MHNSHA    OREQ *BLANKS
     C           MHDMLA    OREQ *BLANKS
     C           MHRNDN    OREQ *BLANKS
     C           MHRNDS    OREQ *BLANKS
     C                     MOVE 'Y'       ERROR
     C                     ELSE
      *
      ** Stock Authorised ('S')
     C           WWSTGX    IFEQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
     C*****      MHMKTP    ANDEQ*BLANKS                                   159908
     C***********MHMKTP    IFEQ *BLANKS                            159908 162284
     C                     Z-ADD1         W       20                      162284
     C                     MOVEAMHSECA    AR1                             162284
     C                     MOVEAMHMKTP    AR8                             162284
     C           W         DOWLT21                                        162284
     C           AR1,W     IFNE *BLANKS                                   162284
     C           AR8,W     ANDEQ*BLANKS                                   162284
     C           AR1,W     ORNE *BLANKS                                   162284
     C           AR8,W     ANDEQ*ZERO                                     162284
     C                     MOVE 'Y'       ERROR                           136935
     C                     ENDIF                                          162284
     C                     ADD  1         W                               162284
     C                     ENDDO                                          162284
     C***********          ENDIF                                   159908 162284
     C           ERROR     IFEQ 'Y'                        B*1            162284
     C                     MOVEL'CO00700' ZAMSID                          162284
     C                     EXSR ZASNMS                                    162284
     C                     ENDIF                                          162284
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * V0OF   : 'OF' Processing Type                                 *
      *****************************************************************
      *
     C           V0OF      BEGSR
      *
      ** Status Allocated, Trial Allocation ('LN')
     C           WWSTGL    IFEQ 'LN'
      ** Final Allocation Stock ('LS')
     C           WWSTGL    OREQ 'LS'
      ** Final Allocation Cash and Stock ('LY')
     C           WWSTGL    OREQ 'LY'
      ** Stock Authorised ('S')
     C           WWSTGX    OREQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MINSEC    IFEQ *BLANKS
     C           MIADRE    OREQ *BLANKS
     C           MIOFTY    ANDNE'P'                                       135689
     C           MIOFTY    OREQ *BLANKS
     C           MINSHA    OREQ *ZEROS
     C           MIOFTY    ANDEQ'E'
     C           MIOSHA    OREQ *ZEROS
     C           MIOFTY    ANDEQ'E'
     C           MIDMLT    OREQ *ZEROS
     C           MISUPR    OREQ *ZEROS
     C           MIOFTY    ANDEQ'S'
     C           MIREPR    OREQ *ZEROS
     C           MIOFTY    ANDEQ'P'
     C           MIRNDN    OREQ *BLANKS
     C           MIRNDS    OREQ *BLANKS
     C           MICOMP    OREQ *ZEROS
     C           MIRNDS    ANDEQ'Y'
     C           MIOPSH    OREQ *BLANKS
     C                     MOVE 'Y'       ERROR
     C                     ELSE
      *
      ** Stock Authorised ('S')
     C           WWSTGX    IFEQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
     C*****      MIMKTP    ANDEQ*ZEROS                                    159908
     C           MIMKTP    IFEQ *ZEROS                                    159908
     C                     MOVE 'Y'       ERROR                           136935
     C                     ENDIF                                          159908
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * V0EX   : 'EX' processing Type                                 *
      *****************************************************************
      *
     C           V0EX      BEGSR
      *
      ** Status Allocated, Trial Allocation ('LN')
     C           WWSTGL    IFEQ 'LN'
      ** Final Allocation Stock ('LS')
     C           WWSTGL    OREQ 'LS'
      ** Final Allocation Cash and Stock ('LY')
     C           WWSTGL    OREQ 'LY'
      ** Stock Authorised ('S')
     C           WWSTGX    OREQ 'S'
      ** Fully Authorised ('X')
     C           WWSTGX    OREQ 'X'
      *
     C           MJNSEC    IFEQ *BLANKS
     C*****      MJTRAF    OREQ *ZEROS                                    137877
     C*****      MJTRAT    OREQ *ZEROS                                    137877
     C           MJNSHA    OREQ *ZEROS
     C           MJCPRC    ANDEQ*ZEROS
     C           MJOSHA    OREQ *ZEROS
     C           MJNSHA    ANDNE*ZEROS
     C*****      MJSUPR    OREQ *ZEROS                                    137877
     C           MJDMLT    OREQ *ZEROS
     C           MJRNDN    OREQ *BLANKS
     C           MJRNDS    OREQ *BLANKS
     C           MJCOMP    OREQ *ZEROS
     C           MJRNDS    ANDEQ'Y'
     C           MJSUPR    OREQ *ZEROS                                    137877
     C           MJCPRC    ANDNE*ZEROS                                    137877
     C           MJOPSH    OREQ *BLANKS
     C                     MOVE 'Y'       ERROR
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************   CEU017
      * V0CC   : 'CC' processing Type                                 *   CEU017
      *****************************************************************   CEU017
      *                                                                   CEU017
     C           V0CC      BEGSR                                          CEU017
      *                                                                   CEU017
      ** Status Allocated, Trial Allocation ('LN')                        CEU017
     C           WWSTGL    IFEQ 'LN'                                      CEU017
      ** Final Allocation Stock ('LS')                                    CEU017
     C           WWSTGL    OREQ 'LS'                                      CEU017
      ** Final Allocation Cash and Stock ('LY')                           CEU017
     C           WWSTGL    OREQ 'LY'                                      CEU017
      ** Stock Authorised ('S')                                           CEU017
     C           WWSTGX    OREQ 'S'                                       CEU017
      ** Fully Authorised ('X')                                           CEU017
     C           WWSTGX    OREQ 'X'                                       CEU017
      *                                                                   CEU017
     C           NANCCY    IFEQ *BLANKS                                   CEU017
     C           NAVCCY    OREQ *BLANKS                                   CEU017
     C           NANSEC    OREQ *BLANKS                                   CEU017
     C           NADMLT    OREQ *ZEROS                                    CEU017
     C           NAONSZ    OREQ *ZEROS                                    CEU017
     C           NANNSZ    OREQ *ZEROS                                    CEU017
     C           NARNDN    OREQ *BLANKS                                   CEU017
     C           NARNDS    OREQ *BLANKS                                   CEU017
     C******     NACOMP    OREQ *ZEROS                             CEU017 135685
     C******     NARNDS    ANDEQ'Y'                                CEU017 135685
     C           NARNDS    OREQ 'Y'                                       135685
     C           NACOMP    ANDEQ*ZEROS                                    135685
     C           NAMRKI    ANDNE'Y'                                       135685
     C                     MOVE 'Y'       ERROR                           CEU017
     C                     ENDIF                                          CEU017
     C                     ENDIF                                          CEU017
      *                                                                   CEU017
     C                     ENDSR                                          CEU017
      *                                                                   CEU017
      *****************************************************************
      * U001   : Write a record to the subfile                        *
      *****************************************************************
      *
     C           U001      BEGSR
      *
      ** ACTION
     C                     MOVEL*BLANKS   DDACN
      *
      ** DEPOT BRANCH
     C                     MOVELDSBA      DDBRC
      *
      ** DEPOT NUMBER
     C                     MOVELDDPT      DDDEP
      *
      ** DEPOT SHORTNAME
     C                     MOVE *BLANKS   WLKEYC
     C                     MOVELDDPT      WLKEYC
     C                     CALL 'AOCUSTR0'
     C                     PARM '*DBERR'  WLRTCD
     C                     PARM '*KEY   ' WLOPTN
     C                     PARM           WLKEYC 10
     C                     PARM *BLANKS   WLKYST  7
     C           SDCUST    PARM SDCUST    DSSDY
      *
      **  If record not found
     C           WLRTCD    IFNE *BLANKS                    B*1
     C           *LOCK     IN   LDA
     C                     Z-ADD006       DBASE            ****************
     C                     MOVE 'SDCUSTPD'DBFILE           * DB ERROR 006 *
     C                     MOVELDDPT      DBKEY            ****************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF                           E*1
      *
     C                     MOVELBBCSSN    DDDEPS
      *
      ** EX-DATE POSITION
     C                     MOVE *OFF      *IN54
      *
      ** If record found in LF/SECODPL1, use ex-date position
      ** in PF/SECODPPD.
     C           KEY3F     IFEQ *OFF
      *
      ** Edit DDEDP
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MBEXPO    ZFLD15
     C                     Z-ADDWNCDP     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    DDEDP
      *
     C           MATDVD    IFEQ 'V'
     C           MBEXPO    ANDNEDSNV
     C           MATDVD    OREQ 'T'
     C           MBEXPO    ANDNEDSNT
     C                     MOVE *ON       *IN54
     C                     ENDIF
      *
      ** If not found, use value date or trade date position
      ** in PF/DPOSND
     C                     ELSE
      *
     C                     MOVE *BLANKS   ZFLD15
     C           MATDVD    IFEQ 'V'
     C                     MOVE DSNV      ZFLD15
     C                     ELSE
     C                     MOVE DSNT      ZFLD15
     C                     ENDIF
      *
      ** Edit DDEDP
     C                     Z-ADDWNCDP     ZDECS
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    DDEDP
      *
     C                     ENDIF
      *                                                                   CSE020
      ** If CA is a child, derive Ex-date position by adding up the       CSE020
      ** Actual Stock Allocation of the Parent CA.                        CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C           KEY6      KLIST                                          CSE020
     C                     KFLD           MAPREF                          CSE020
     C                     KFLD           DSBA                            CSE020
     C                     KFLD           DDPT                            CSE020
     C                     Z-ADD*ZERO     WWASTA                          CSE020
     C           KEY6      SETLLSECOALL5                                  CSE020
     C           KEY6      READESECOALL5                 72               CSE020
     C           *IN72     DOWEQ*OFF                                      CSE020
     C           M5SESN    IFEQ WWSECN                                    CSE020
     C                     ADD  M5ASTA    WWASTA                          CSE020
     C                     ENDIF                                          CSE020
     C           KEY6      READESECOALL5                 72               CSE020
     C                     ENDDO                                          CSE020
     C                     MOVE *BLANKS   ZFLD15                          CSE020
     C                     MOVE WWASTA    ZFLD15                          CSE020
     C                     Z-ADDWNCDP     ZDECS                           CSE020
     C                     MOVE 'L'       ZECODE                          CSE020
     C                     EXSR ZSEDIT                                    CSE020
     C                     MOVE ZOUT21    DDEDP                           CSE020
     C                     ENDIF                                          CSE020
      *
      ** LAST ALLOCATION
      *
      ** If record found in LF/SECODRL0, use last allocation
      ** in PF/SECODRPD.
     C           KEY4F     IFEQ *OFF
     C           MSCOAD    ANDNE*ZEROS
     C                     MOVE MSCOAD    ZDAYNO
      *
      ** Format date
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     DDLTA
      *
      ** If not found, output blanks
     C                     ELSE
     C                     MOVE *BLANKS   DDLTA
     C                     ENDIF
      *
      ** FINAL ALLOCATION
      ** If record found in LF/SECODRL0, use final allocation
      ** in PF/SECODRPD.
     C           KEY4F     IFEQ *OFF
     C                     MOVE MSFAID    DDFLA
      *
      ** If not found, output blanks
     C                     ELSE
     C                     MOVE 'N'       DDFLA
     C                     ENDIF
      *
     C                     MOVE '0'       *IN70
      *
      ** STATUS
      ** If record found in LF/SECODRL0, use status
      ** in PF/SECODRPD.
     C           KEY4F     IFEQ *OFF
     C                     MOVE MSCOST    DDSTS
     C           MSALOC    IFEQ 'Y'
     C                     MOVE '1'       *IN70
     C                     ENDIF
      *
      ** If not found, output blanks
     C                     ELSE
     C                     MOVE 'I'       DDSTS
     C                     ENDIF
      *
      ** Hidden fields
     C                     MOVE DDFLA     DDFLAH
     C                     MOVE DDSTS     DDSTSH
     C                     MOVE *IN54     SHIN54                          136930
      *
      ** Write subfile record
     C                     WRITESE7512S1
     C                     ADD  1         SFLLEN
     C                     ADD  1         SFLRRN     81
     C                     Z-ADDSFLRRN    #1RRN
      *
      ** If record not found write a record on PF/SECODRPD
     C           KEY4F     IFEQ *ON
     C                     MOVE 'W'       WWWRUP
     C                     EXSR U002
     C                     WRITESECODRD0
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      * U002   : Update/Write details on PF/SECODRPD                  *
      *****************************************************************
      *
     C           U002      BEGSR
      *
      ** Record Identifier
     C                     MOVE 'D'       MSRECI
      *
      ** Last Change Date
     C                     Z-ADDBJRDNB    MSLCD
      *
      ** Type of Last Change
      ** New Record
     C           WWWRUP    IFEQ 'W'
     C                     MOVE 'I'       MSCHTP
     C                     ENDIF
      *
      ** Amend a Record
     C           WWWRUP    IFEQ 'U'
     C                     MOVE 'A'       MSCHTP
     C                     ENDIF
      *
      ** Last User Identifier
     C                     MOVELUSER      MSLUID
      *
      ** Reference Number
     C                     MOVE DDREFN    MSCORF
      *
      ** Branch
     C                     MOVE DDBRC     MSBRCD
      *
      ** Depot number
     C                     MOVELDDDEP     MSDDPT
      *
      ** Final Allocation
     C                     MOVE DDFLA     MSFAID
      *
      ** Status
     C                     MOVE DDSTS     MSCOST
      *
      ** Last Allocation Date
     C                     MOVE DDLTA     ZDATE
      *
      ** Convert to equivalent Midas day no.
     C                     EXSR ZDATE1
     C                     Z-ADDZDAYNO    MSCOAD
      *
     C                     MOVE 'N'       MSALOC
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * PALOC  : Action 'L' - Allocation                              *
      *****************************************************************
      *
     C           PALOC     BEGSR
      *
     C           DDCONF    IFEQ 'Y'
      *
     C                     MOVELDDBRC     WWDSBA
     C                     MOVELDDDEP     WWDDPT
      *
     C           KEY4      CHAINSECODRL0             89
      *
     C                     MOVE 'Y'       MSALOC
     C                     UPDATSECODRD0
     C                     COMIT
      *
     C                     MOVE '1'       *IN70
      *
      **   SUBMIT IN BATCH 'CORPORATE ACTIONS ALLOCATION' PROGRAM
      **   WITH CO REFERENCE AS PARAMETER
      *
     C                     MOVEL*BLANKS   CMDTXT
     C***********          MOVEL*BLANKS   CMDTX1160                                           CPK014
     C                     Z-ADD240       CMDLEN 155
     C***********          MOVELCMD,1     CMDTX1                                              CPK014
     C***********          MOVE CMD,2     CMDTX1                                              CPK014
     C***********          MOVELCMDTX1    CMDTXT                                              CPK014
     C***********          MOVE CMD,3     CMDTXT                                              CPK014
     C                     MOVELCMD,1     CMDTXT                                              CPK014
     C                     MOVELCMD,2     CMDTX2                                              CPK014
     C                     MOVELCMD,3     CMDTX3                                              CPK014
      *
     C                     MOVELDDREFN    @REF
     C                     MOVELDDACN     @ACTI
      *
     C                     MOVELDDREFN    @REFN
     C                     MOVELDDBRC     @BRCD
     C                     MOVELDDDEP     @DEPT
      *
     C                     CALL 'QCMDEXC'
     C                     PARM           CMDTXT
     C                     PARM           CMDLEN
      *
      ** Clear messages from program message quque.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM ##PGM     ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
     C                     MOVEL'CO00293' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
     C                     MOVE *BLANKS   DDACN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * PATHR  : Action 'X' - Authorisation                           *
      *****************************************************************
      *
     C           PATHR     BEGSR
      *
     C           DDCONF    IFEQ 'Y'
      *
      ** If the Final Indicator is 'S' (Final Stock Allocation)
      ** Status will be changed to 'S'
     C           DDFLA     IFEQ 'S'
     C                     MOVE 'S'       DDSTS
     C                     MOVE 'S'       DDSTSH
     C                     ELSE
      *
      ** If the Final Indicator is 'Y' (Final Stock AND Cash Allocation)
      ** Status will be changed to 'X'
     C           DDFLA     IFEQ 'Y'
     C                     MOVE 'X'       DDSTS
     C                     MOVE 'X'       DDSTSH
     C                     ENDIF
     C                     ENDIF
      *
     C           KEY4      CHAINSECODRL0             89
     C                     MOVE DDSTS     MSCOST
     C                     UPDATSECODRD0
     C                     ENDIF
      *
     C                     ENDSR
      *****************************************************************   CSE020
      /EJECT                                                              CSE020
      *****************************************************************   CSE020
      * SRDELT : Delete all allocation records of subordinates        *   CSE020
      *****************************************************************   CSE020
      *                                                                   CSE020
     C           SRDELT    BEGSR                                          CSE020
      *                                                                   CSE020
      ** Set pointer                                                      CSE020
      *                                                                   CSE020
     C           1         SETLLSECORFPM                                  CSE020
     C                     READ SECORFPM                 88               CSE020
     C           MOCORF    DOWNEWWREFN                                    CSE020
     C           *IN88     ANDNE'1'                                       CSE020
     C                     READ SECORFPM                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C                     READ SECORFPM                 88               CSE020
      *                                                                   CSE020
     C           MOLEVL    DOWNE*BLANKS                                   CSE020
     C           MOLEVL    ANDNE'+'                                       CSE020
     C           *IN88     ANDEQ'0'                                       CSE020
      *                                                                   CSE020
      ** Delete all records in SECOALPD                                   CSE020
      *                                                                   CSE020
     C           MOCORF    SETLLSECOALL7                                  CSE020
     C           MOCORF    READESECOALL7                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C                     DELETSECOALL7                                  CSE020
     C           MOCORF    READESECOALL7                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
      ** Delete all records in SECODPPD                                   CSE020
      *                                                                   CSE020
     C           MOCORF    SETLLSECODPL5                                  CSE020
     C           MOCORF    READESECODPL5                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C                     DELETSECODPL5                                  CSE020
     C           MOCORF    READESECODPL5                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
      ** Delete all records in SECODRPD                                   CSE020
      *                                                                   CSE020
     C           MOCORF    SETLLSECODRL0                                  CSE020
     C           MOCORF    READESECODRL0                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C                     DELETSECODRL0                                  CSE020
     C           MOCORF    READESECODRL0                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
      ** Update Status of Subordinates                                    CSE020
      *                                                                   CSE020
     C           MOCORF    CHAINSECORFL1             88                   CSE020
     C           *IN88     IFEQ '0'                                       CSE020
     C                     MOVE 'I'       MNSTAT                          CSE020
     C                     UPDATSECORFD1                                  CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     READ SECORFPM                 88               CSE020
      *                                                                   CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C                     ENDSR                                          CSE020
      *****************************************************************
      /EJECT
      *****************************************************************
      * PPRNT  : Action 'P' - Print Allocation Report                 *
      *****************************************************************
      *
     C           PPRNT     BEGSR
      *
     C                     MOVE *BLANKS   DDACN
     C                     MOVE *BLANKS   DDSLAL
      *
     C                     MOVEL'SE7534'  @RNAM
     C                     MOVEL'SEC7534' @COTT
     C                     CALL 'FC0040X'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM           @RNAM  10
     C                     PARM           @COTT  10
     C                     PARM '10001'   @CSEQ   5
     C                     PARM           @PARM 100
     C                     PARM AGMBIN    @MBRC   1
     C                     PARM 'S'       @LVL    1
     C                     PARM *BLANKS   @ETTY   3
      *
      **   IR ERROR INDICATOR OF THE PROGRAM CALL IS ON
      **   OR IF RETURN CODE IS EQUAL TO 'E' (ERROR)
      **         DATABASE ERROR
      *
     C           @RTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'007'     DBASE            *****************
     C                     MOVEL*BLANKS   DBFILE           ** DB ERROR 07 **
     C                     MOVELNARR,1    DBKEY            *****************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     END                             E*2
      *
     C                     MOVEL'CO00292' ZAMSID
     C                     EXSR ZASNMS
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      * *PSSR : Error processing                                      *
      *****************************************************************
      *
     C           *PSSR     BEGSR
      *
      ** Update LDA with error information
      *
     C           *NAMVAR   DEFN           LDA
     C           *LOCK     IN   LDA
     C                     MOVELDBFILE    WWFILE
     C                     MOVELDBKEY     WWKEY
     C                     MOVELDBPGM     WWPGM
     C                     MOVELDBASE     WWASE
     C                     OUT  LDA
      *
      **   ROLLBACK CHANGES, PRINT DUMP AND CANCEL PROGRAM
     C                     ROLBK
     C                     MOVE 'E'       WWRTCD
     C                     DUMP
      *
     C                     MOVE *ON       *INU7
     C                     MOVE *ON       *INU8
     C                     MOVE *ON       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * ZASNMS   - Send message to program message queue              *
      *                                                               *
      * CALLS    Y2SNMSGC                                             *
      *                                                               *
      * CALLED BY                                                     *
      *                                                               *
      *****************************************************************
     C           ZASNMS    BEGSR
      *
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGM            Program queue
     C                     PARM           ZAPGRL           Rel queue
     C                     PARM           ZAMSID           Message Id.
     C                     PARM           ZAMSGF           Message file.
     C                     PARM           ZAMSDA           Message data.
     C                     PARM           ZAMSTP           Message type.
      *
      ** Clear all fields for default mechanism next time.
     C                     MOVEL*BLANK    ZAPGM            Message queue
     C                     MOVEL*BLANK    ZAPGRL           Rel queue
     C                     MOVEL*BLANK    ZAMSDA           Message data.
     C                     MOVEL*BLANK    ZAMSTP           Message type.
      *
     C           ZASNM9    ENDSR                           ZASNM9 TAG
      **
     C/COPY ZSRSRC,ZSEDITZ3
     C/COPY ZSRSRC,ZDATE1Z2
     C/COPY ZSRSRC,ZDATE2Z4
     C/COPY ZSRSRC,ZASIGNZ2
      **
**  CPY@
(c) Finastra International Limited 2001
**
F3=Exit  F5=Refresh  F12=Previous Screen  Rollup/Down
F3=Exit  F12=Previous
F3=Exit F5=Refresh Screen F12=Previous F20=Exit Without Saving   Rollup/Down
F12=Previous
F3=Exit  F5=Refresh  F12=Previous Screen  Rollup/Down  F10=Confirm
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  CMD - CALL 'QCMDEXC' TO SBMJOB
SBMJOB JOB(COnnnnnnx) JOBD(BULKTJOBD) RQSDTA('CALL PGM(SEC7550) PARM(''xxxxxx''
''xxx'' ''xxxxxx'' ''  '' ''          '' ''  '' ''      '' ''    '')')
MSGQ(MOPERQ) RTGDTA(*NONE) INLLIBL(*JOBD) USER(*JOBD) OUTQ(*JOBD)                             CSC023
**  NARR
ERROR CALL PGM 'SE7534'
ERROR CALL PGM 'SE7592'
ERROR CALL PGM 'SE7593'
