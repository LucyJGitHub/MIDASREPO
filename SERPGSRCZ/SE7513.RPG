     H        1
      *****************************************************************
/*XBI *: OVRDBF FILE(SECTYZ1) TOFILE(SECTY) SHARE(*NO)              : *
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE CO customer/book by depot maintenance')
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  SE7513 -  Corporate Action Customer/Book Maintenance         *
      *                                                               *
      *  Function:  Used to maintain details of allocations per       *
      *  (I/C)      Customer/Book position to a specific depot.       *
      *                                                               *
      *  BE CAREFUL: All amendments of calculations made in this      *
      *              program must obligatorily be done in RPG/        *
      *              SE7550: Midas SE Corporate Actions Automatic     *
      *               Allocation Processing |                         *
      *               Some of those amendments must perhaps be done   *
      *               in RPG/SE7593: Midas SE Corporate Actions       *
      *               Depot Maintenance, depending on calculations    *
      *               used in this program |                          *
      *                                                               *
      *  Called by: SE7593  -  Corporate Action Depot Maintenance     *
      *                                                               *
      *  Calls: AOSTRDR0 - Midas AO Securities Trading ICD access obj.*
      *         AOMMODR0 - Midas AO Access Midas Modules *RDR.        *
      *         AOPORTR0 - Midas AO Portfolio Management ICD *RDR.    *
      *         AOBANKR0 - Midas AO Bank ICD access object.           *
      *         AOCUSTR0 - Midas AO Client details access object.     *
      *         AOCUSTR1 - Midas AO Client details access object.     *                       223539
      *         AOCURRR0 - Midas AO Currency codes access object.     *
      *         AOPLCSR0 - Midas AO Portfolio Mngemnt Cust Det. *RDR. *
      *         AOSARDR0 - Midas AO Sweatchable Features.             *
      *         AOBRCHR0 - Midas AO Branch details access object.     *
      *         AOSCTXR0 - Midas AO SE Country Tax Rates.             *
      *         AOCBTXR0 - Midas AO SE Country to Branch Tax Rates.   *
      *         AOSECSR0 - Midas AO Securities Clients *RDR.          *
      *         Y2CLMSC  - Midas ABS Clear specific program message   *
      *                    queue.                                     *
      *         Y2SNMGC  - Midas ABS Send a message SNDxxxMSG.        *
      *         DBERRCTL - Midas SC DB error ctl for interactive jobs.*
      *         SE7515   - Midas SE Corporate Action Reply Handling   *
      *                    Maintenance.                               *
      *         SE7540   - Midas SE Global Customer/Book Enquiry.     *
      *         SE7550   - Midas SE Corporate Actiona Automatic       *
      *                    Allocation Processing (SBMJOB BY CALL      *
      *                    QCMDEXC).                                  *
      *                                                               *
      *  (c) Misys International Banking Systems Ltd. 2001            *
      *                                                               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *  Last Amend No. CSD031             Date 10Apr06               *
      *  Prev Amend No. CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 223182             Date 30Jan04               *
      *                 223539             Date 23Jan04               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 CGL029             Date 01Sep03               *
      *                 CSC023             Date 28Jan04               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 CPK014             Date 11Oct01               *
      *                 190204             Date 31May01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 184520             Date 17Jan01               *
      *                 179205             Date 27Dec00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 177221             Date 28Mar00               *
      *                 CSE020             Date 21Mar00               *
      *                 161732             Date 21Mar00               *
      *                 179197             Date 18May00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CPB001             Date 26Aug99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                  161591            Date 07JUN99               *
      *                  161641            Date 13MAY99               *
      *                  CAC005            Date 23Nov98               *
      *                  155622            Date 18Feb99               *
      *                  145872            Date 23Oct98               *
      *                  136935            Date 27Jul98               *
      *                  137879            Date 01Jul98               *
      *                  136930            Date 17Jun98               *
      *                  135690            Date 08Jun98               *
      *                  135686            Date 05Jun98               *
      *                  135689            Date 02Jun98               *
      *                  135685            Date 28May98               *
      *                  CEU017            Date 05Mar98               *
      *                  CSE007 *CREATE    Date 01Dec97               *
      *                                                               *
      *****************************************************************
      *                                                               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  223182 - Error on Corporate Action - Write *CLOSED*          *
      *           narrative to closed customers and protected fields  *
      *           for manual allocations.                             *
      *  223539 - Corporate Actions - Locks on CA events maintenance  *
      *           Access AOCUSTR1 insted of AOCUSTR0 and Ignore       *
      *           DBERR if Customer is closed.                        *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  CSC023 - SBMJOB output queue must be *JOBD.                  *
      *  CPK014 - Release 4 packaging. Field names for subfile out of *
      *           step.                                               *
      *         - Submit jobs with user *JOBD                         *
      *  190204 - Changed Dividend per Unit format from 9N0 to 13N8.  *
      *  184520 - If two dummy records needed for corporate action,   *
      *           display the second one on file.                     *
      *  179205 - If only a charge or a commission, fee calculated    *
      *           is zero. Allow the two to be calculated seperately. *
      *           Do not multiply result by CCY decimal places.       *
      *  177221 - DB error on CA Customer/Book Depot Maintenance due  *
      *           to opened file.                                     *
      *  CSE020 - Corporate Actions Domino Effect Processing          *
      *  161732 - Corporate Actions Exercise and Conversion - Part    *
      *           Stock/Keep Rest Calculation.                        *
      *  179197 - Corrected Mesage IDs                                *
      *  CPB001 - 'Private Banking' Module                            *
      *  161591 - Actual Cash Allocation Incorrect After Manual       *
      *           Changes Of Actual Stock Allocation                  *
      *  161641 - Change way of calculation of Total Settlement       *
      *  CAC005 - Profit Centre Accounting - SE Enhancement           *
      *  155622 - Corporate Actions: IBM problem displaying narrative *
      *           fields inside a subfile when compiling with multi-  *
      *           language indicator *ON                              *
      *  145872 - Corporate Actions: '% to Exchange' added for        *
      *           Exchange Offer ('OF').                              *
      *           If Exchange Offer, Calculat Base Ex-Date Position = *
      *           Ex-Date Position multiplied by Percentage to        *
      *           Exchange.                                           *
      *  136935 - Corporate Actions: Allocation processing amendments:*
      *           1. Due to database error, setup Portfolio screen    *
      *              fields to blank if Dummy Customer.               *
      *           2. Amend wrong calculation of Balancing Cash Alloca-*
      *              tion if Actual Stock Allocation amended on       *
      *              normal screen and loading new field on subfile   *
      *              control.                                         *
      *           3. Amend wrong calculation of Actual Cash rounding  *
      *              for Security '**CASH**' if Actual Cash Rounding  *
      *              amended on normal screen.                        *
      *           4. Amend Reply Status to 'M' (=Maunally Changed) for*
      *              Security '**CASH**' when at least one field has  *
      *              been recalculated, instead of when all fields    *
      *              have been recalculated.                          *
      *           5. Input Balancing Difference on Dummy Customer if  *
      *              Currency Change or depending if field 'Allocate  *
      *              Difference to Dummy' = 'Y' on Securities Trading *
      *              ICD.                                             *
      *           6. Amend wrong recalculation of Total Taxes, only   *
      *              for Reinvestment of Dividend.                    *
      *           7. Amend calculations for Offers.                   *
      *           8. Amend calculations for Exercices and Conversions.*
      *           9. For Reinvestment of Dividend, if Compensation    *
      *              Price entered, use Compensation Price instead of *
      *              Subscription Price, otherwise, calculate Sub-    *
      *              scription Price = Subscription Price minus Dis-  *
      *              count Rate.                                      *
      *  137879 - Amend Review from processing, if Status selected    *
      *           and roll up, the next pages shown all Status.       *
      *  136930 - EMU and Corporate Actions: various errors:          *
      *           1. Retrieve Allocation details for Customers in     *
      *              each case, not only if Status equal 'L' or 'X'.  *
      *           2. Amend wrong validation of action codes on        *
      *              enquiry mode.                                    *
      *  135690 - Various errors for Corporate Actions:               *
      *           1. Due to Fix 135689: Error in validation of        *
      *              Dividend per Unit, amend number of decimal       *
      *              places of Dividend per Unit for Dividend Events, *
      *              from New Currency instead of New Security.       *
      *           2. Amend wrong calculation of Holding Taken as      *
      *              Stock for Dividend Events.                       *
      *           3. Amend wrong loading of Cash preferred % for      *
      *              Processing Type Rights Issues, Cash Preferred %  *
      *              must always equal 0.                             *
      *           4. Amend wrong calculation of Cash Preferred % in   *
      *              case 2.1: if Standard Instruction found,         *
      *              condition if Cash % later than 50 or greater     *
      *              50 becomes if later than 50 or greater or equal  *
      *              50.                                              *
      *  135686 - Corporate Actions and EMU                           *
      *           1. Change Database error 23 to 33, 23 already used  *
      *           2. Due database error, don't check if Actual Stock  *
      *              Allocation entered is on Denomination Multiplier *
      *              precision if processing type = CE, NC or NF      *
      *           3. Amend wrong calculation on Actual Stock          *
      *              Allocation: if with Denomination Multiplier      *
      *              precision, no Decimal Placesused, so retrieve    *
      *              New Security Decimal Places.                     *
      *  135689 - Corporate Actions and EMU: various errors:          *
      *           1. Reset saved field SHIND4 used to blink Ex-Date   *
      *              Position on subfile record.                      *
      *           2. Don't allow Action Code 'L' (Run Allocation) on  *
      *              subfile for 'CASH' screen'.                      *
      *  135685 - It's not feasible to enter the Compensation Price   *
      *           at the Bulk level as the Bulk will have many        *
      *           Securities all giving a cash compensation at a      *
      *           different level. Therefore, allow the entry of      *
      *           'MARKET' which will use the Market Price of the     *
      *           Security at allocation effective date.              *
      *  CEU017 - Securities Redenomination Euro Changes              *
      *  CSE007- Corporate Actions                                    *
      *                                                               *
      *****************************************************************
      *
      ***  Midas SE Securities                                           - Prefixe
      *
     FSECTYZ1 IF  E           K        DISK         KINFSR *PSSR
      *
      ***  SE Corporate Actions - References Rtv Idx                     - Prefixe MA
      *
     FSECORFL1IF  E           K        DISK         KINFSR *PSSR
      *                                                                   CPB001
      ***  Midas PM Live Portfolio definition details                     CPB001
      *                                                                   CPB001
     F***PMPORTLLIF  E           K        DISK         KINFSR *PSSRCPB001 177221
     FPMPORTLLIF  E           K        DISK         KINFSR *PSSR      UC  177221
      *
      ***  Midas Corporate Actions - Depots live records                 - Prefixe MB
      *
     FSECODPL3UF  E           K        DISK         KINFSR *PSSR
     F                                              KCOMIT
      *
      ***  SE Corpotrate Actions - Allocat. Live Records                 - Prefixe MC
      *
     FSECOALL7UF  E           K        DISK         KINFSR *PSSR A
     F                                              KCOMIT
      *
      ***  SE Corporate Actions - Allocat. Live Records                  - Prefixe MC
      *
     FSECOALL1IF  E           K        DISK         KINFSR *PSSR
     F            SECOALD0                          KRENAMESECOALD1
      *
      ***  Midas SE User Depot Positions - Detail                        - Prefixe
      *
     FSEUDEPL0IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Client Depot Positions - Detail                      - Prefixe
      *
     FSECDEPL4IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Reply Handling                   - Prefixe MQ
      *
     FSECOREL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Instructions by Cust.            - Prefixe MO
      *
     FSECOSIL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Instructions by Book             - Prefixe MO
      *
     FSECOSIL2IF  E           K        DISK         KINFSR *PSSR
     F            SECOSID0                          KRENAMESECOSID2
      *
      ***  Midas SE Corporate Actions - Exchange Offers                  - Prefixe MI
      *
     FSECOOFL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Dividends Events                 - Prefixe MD
      *
     FSECODVL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Rights                           - Prefixe MF
      *
     FSECORGL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Exercice & Conversion            - Prefixe MJ
      *
     FSECOEXL1IF  E           K        DISK         KINFSR *PSSR
      *                                                                   CSE020
      ***  Midas SE Corporate Actions - Exercice & Conversion            -CSE020
      *                                                                   CSE020
     FSECONCL1IF  E           K        DISK         KINFSR *PSSR          CSE020
      *
      ***  Midas SE Corporate Actions - Corp. Reorganisation             - Prefixe MH
      *
     FSECOCRL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Free Allocations                 - Prefixe ME
      *
     FSECOFRL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Capital Events                   - Prefixe MG
      *
     FSECOCEL1IF  E           K        DISK         KINFSR *PSSR
      *                                                                   CEU017
      ***  Midas SE Corporate Actions - Currency Changes                  CEU017
      ***                                                    - Prefixe NA CEU017
      *                                                                   CEU017
     FSECOCCL2IF  E           K        DISK         KINFSR *PSSR          CEU017
      *
      ***  Midas SE Security Withholding Tax Details                     - Prefixe S1
      *
     FSESWHTL0IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SD Customer master file                                 - Prefixe
      *
     FCLINT   IF  E           K        DISK         KINFSR *PSSR
     F            CLINTCAF                          KIGNORE
     F            CLINTCCF                          KIGNORE
     F            CLINTC1F                          KIGNORE
     F            CLINTSEF                          KIGNORE
      *
      ***  Midas SE Corporate Actions - Default Charges                  - Prefixe MR
      *
     FSECOCHL0IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Default Charges                  - Prefixe MR
      *
     FSECOCHL1IF  E           K        DISK         KINFSR *PSSR
     F            SECOCHD0                          KRENAMESECOCHD1
      *
      ***  Midas SE Charge Types - CCY,CCOM                              - Prefixe
      *
     FSECGT   IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Market Prices file.                                  - Prefixe
      *
     FPRICM   IF  E           K        DISK         KINFSR *PSSR
      *                                                                   CSE020
      ***  SE Corporate Actions - Stock Allocations                       CSE020
      *                                                                   CSE020
     FSECOALL5IF  E           K        DISK         KINFSR *PSSR          CSE020
     F            SECOALD0                          KRENAMESECOALD5       CSE020
      *                                                                   CSE020
      ***  SE Corporate Actions - Reference Upd Idx                       CSE020
      *                                                                   CSE020
     FSECORFL9IF  E           K        DISK         KINFSR *PSSR          CSE020
     F            SECORFD0                          KRENAMESECORFD2       CSE020
      *
      ***  Display file
      *
     FSE7513DFCF  E                    WORKSTN      KINFSR *PSSR
     F                                              KINFDS SCRDS
     F                                        SRRN  KSFILE SE7513S0
     F                                        SRRN  KSFILE SE7513S1
      *
      *****************************************************************
      *                                                               *
      *  F U N C T I O N   O F   I N D I C A T O R S                  *
      *                                                               *
      *  13    Portfolio Management Facilities licensed,       (*ON)  *
      *        Customer and Portfolio displayed                       *
      *  14    Field SCOAL in error in SE7513F3-F4             (*ON)  *
      *  16    Record not found in file SECODPL3, SECOALL7,    (*ON)  *
      *********SECOxxL1.***********************************************   CEU017
      *        SECOxxL1, SECOCCL2.                                    *   CEU017
      *        (where xx = DV, OF, RG, EX, CR, CE or FR)              *
      *  17    Used to find informations for New Security      (*ON)  *
      *        in arrays retrieve from file SECOCRL1.                 *
      *  20    F20 pressed = Exit Without Saving               (*ON)  *
      *  21    - Confirm screen Exit Without Saving            (*ON)  *
      *        - Confirm screen allocation                     (*OFF) *
      *  25    End of program message subfile                         *
      *  27    Roll up key pressed                             (*ON)  *
      *  30    End of subfile SE7513S0-S1                      (*ON)  *
      *        (End of file SECDEPL4)                                 *
      *  33    No record change on subfile SE7513S0-S1         (*ON)  *
      *  40    - Record read from SEUDEPL0 (= Book calculation)(*ON)  *
      *        - Record read from SECDEPL4 (= Customer calcul.)(*OFF) *
      *  41    - Customer non Dummy Customer calculation       (*ON)  *
      *        - Dummy Customer calculation                    (*OFF) *
      *  45    First time processing                           (*OFF) *
      *  47    Processing running from 'Review from'           (*ON)  *
      *  50    Field SCUST in error in SE7513C0-C1             (*ON)  *
      *  51    Field SCSTAT in error in SE7513C0-C1            (*ON)  *
      *  52    Field SACODE in error in SE7513S0-S1            (*ON)  *
      *  53 - Field SPRFC in error in SE7513S0-S1              (*ON)  *   CAC005
      *  54    Field SASAL in error in SE7513S0                (*ON)  *
      *  55    Field SACRO in error in SE7513S0                (*ON)  *
      *  56    Field SRFBK in error in SE7513C0-C1             (*ON)  *
      *  57    Field SACAL in error in SE7513S1                (*ON)  *
      *  58    Field SACRO in error in SE7513S1                (*ON)  *
      *  59    Field SCONF in error in SE7513F3-F4             (*ON)  *
      *  60    - Cash Screen displayed                         (*ON)  *
      *        - Normal Screen displayed                       (*OFF) *
      *  62    Protect and non-display Portfolio               (*ON)  *
      *  63    Non-display Ex-Date Position                    (*ON)  *
      *  64    Ex-Date Position blink on subfile record        (*ON)  *
      *        (Ex-Date Position from SEUDEPL0 or SECDEPL4 is         *
      *        different than Ex-Date Position from SECOALL1)         *
      *  66    Protect Actual Stock Alloc. in normal subfile   (*ON)  *
      *  67    Protect Actual Cash Alloc. in normal subfile    (*ON)  *
      *        and Actual Cash Rounding in normal and 'CASH'          *
      *        subfile.                                               *
      *  68    Portfolio Management is present, so display     (*ON)  *
      *        Portfolio Reference in all screens.                    *
      *        Or Private BankingModule is present             (*ON)  *   CPB001
      *  69 - No Display for 'Prof Ctr' text                   (*ON)  *   CAC005
      *  70    Enquiry mode                                    (*ON)  *
      *  71    Record not found in file SDCUSTPD               (*ON)  *   CPB001
      *  75    Record not found in file SECORFL1               (*ON)  *
      *  76    Record not found in file SECODPL3               (*ON)  *
      *  79    Record not found in file SECOALL7               (*ON)  *
      ***80****Display*Subfile*SE7513S0-S1*********************(*ON)***   137879
      ***81****Display*Subfile*Control*SE7513C0-C1*************(*ON)***   137879
      *  80    - Clear Subfile SE7513S0-S1                     (*ON)  *   137879
      *        - Display Subfile Control SE7513C0-C1           (*OFF) *   137879
      *  81    Display Subfile SE7513S0-S1                     (*ON)  *   137879
      *  82    Record not found in file SECOREL1               (*ON)  *
      *  83    Record not found in file SECOSIL1, SECOSIL2     (*ON)  *
      *  84    SFLNXTCHG in subfile SE7513S0, SE7513S1         (*ON)  *
      *  87    Error calling PGM SE7515 or SE7540 or           (*ON)  *
      *        SBMJOB call SEC7550 (by QCMDEXC).                      *
      *  88    Use to position on subfile SE7513S0-S1                 *
      *  89    Record not found in file SECTYZ1 (= SECTY)      (*ON)  *
      *  98    - System Date Format DDMMYY                     (*OFF) *
      *        - System Date Format MMDDYY                     (*ON)  *
      *  90-99 Used by standard MIDAS subroutines                     *
      *                                                               *
      *  KC    F3 pressed = Exit program                       (*ON)  *
      *  KE    F5 pressed = Refresh screen                     (*ON)  *
      *  KL    F12 pressed = Previous screen                   (*ON)  *
      *                                                               *
      *  LR    End Program indicator.                          (*ON)  *
      *  U7-U8 Database error indicator.                       (*ON)  *
      *                                                               *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  S U B R O U T I N E   I N D E X                              *
      *                                                               *
      *  SRINIT - Initial processing.                                 *
      *  SRMAIN - Main processing.                                    *
      *  SRENDP - Termination processing.                             *
      *  SRCLSF - Clear subfile.                                      *
      *  SRBLDF - Build the first subfile page.                       *
      *  SRS001 - Set first lines of subfile for each Book Position   *
      *           records when subfile is build from begining.        *
      *  SRS002 - Set detail lines of subfile for each Customer       *
      *           Position records when subfile is build.             *
      *  SRS003 - Set subfile last line for each build of the subfile *
      *           when all details in files are reached.              *
      *  SRBLDN - Build the next subfile page.                        *
      *  SRVALD - Validate subfile records.                           *
      *  SRVLD2 - Validate amended fields.                            *
      *  RECCAS - Recalculate fields due Actual Cash Allocation or    *
      *           Actual Cash Rounding changed from 'CASH' screen.    *
      *  RECTAX - Recalculate Total Taxes.                            *
      *  RECFEE - Recalculate Total Fees.                             *
      *  CALAM2 - Calculate Charge Amounts.                           *
      *  RECNSE - Recalculate fields due Actual Stock Allocation or   *
      *           Actual Cash Rounding changed from normal screen.    *
      *  CHACAL - Check if Actual Allocation fields can be            *
      *           recalculated.                                       *
      *  RTVRPL - Retrieve Customer/Book Current Reply and Customer/  *
      *           Book Standard Corporate Action Instruction.         *
      *  REACAA - Recalculate Actual Cash Allocation.                 *
      *  REASTR - Recalculate Actual Stock Rounding.                  *
      *  REHOST - Recalculate Holding Taken as Stock.                 *
      *  REACAR - Recalculate Actual Cash Rounding.                   *
      *  CACAPO - Calculate Actual Cash Pool for Book/Customer.       *
      *  REHOCA - Recalculate Holding Taken as Cash.                  *
      *  SRPRAC - Process Action Code.                                *
      *  SRSAVE - Save subfile datas.                                 *
      *  SRU001 - Write a record to the subfile for each subfile      *
      *           record changes when subfile is build.               *
      *  SRU002 - Write/Update Allocation file for each subfile       *
      *           changes when enter is pressed or add mode is        *
      *           selected.                                           *
      *  *PSSR  - Error control subroutine.                           *
      *  ZASNMS - Send Message to Program Message Queue.              *
      *  RTVNDP - Set amount from num field 15.0 to num field 30.9    *
      *           with Retrieve Number of Decimal Places of a Ccy.    *
      *  SETNDP - Set amount from num field 30.9 to num field 15.0    *
      *           with Number of Decimal Places of a Currency.        *
      *  ROUNDD - Perform rounding to the Number of Decimal Places.   *
      *  CSBPR  - Calculate Subscription Price if Subscription Price  *
      *           entered as Market for Dividend Events.              *
      *  ZSEDIT - Standart subroutine to insert a decimal point into  *
      *           a numeric field and to blank out leading zeroes.    *
      *  ZDATE2 - Standart subroutine to convert a Day Number to      *
      *           date formats.                                       *
      *  ZALIGN - Standart subroutine to validate and righr-align     *
      *           numeric fields.                                     *
      *  ZASIGN - Standart subroutine to validate and right-align     *
      *           signed numeric fields.                              *
      *  ZCCAL1 - Standart subroutine to calculate Charges/           *
      *           Commissions.                                        *
      *  ZCCAL2 - Standart subroutine to calculate Charges/           *
      *           Commissions.                                        *
      *  ZCONV  - Standart subroutine to convert an amount from one   *
      *           Currency to another.                                *
      *                                                               *
      *****************************************************************
      /EJECT
      *
      ***  Array containing Reply Status narratives.
      *
     E                    STATUS  1   5 17
      *
      ***  Array containing error narrative when calling PGM.
      *
     E                    NARR    1   3 29
      *
      ***  Array to retrieve New Securities (20 potential) from SECOCRL1.
      *
     E                    TSEC       20 10
      *
      ***  Array to retrieve Number of New Shares (20 potential) from SECOCRL1.
      *
     E                    TNSH       20 16
      *
      ***  Array to retrieve Rounding (20 potential) from SECOCRL1.
      *
     E                    TNDN       20  1
      *
      ***  Array to retrieve Rounding Settlement in Cash (20 potential) from SECOCRL1.
      *
     E                    TNDS       20  1
      *
      ***  Array to retrieve Compensation Price (20 potential) from SECOCRL1.
      *
     E                    TOPA       20 16
      *
      ***  Array to retrieve Denomination Multiplier (20 potential) from SECOCRL1.
      *
     E                    TDML       20 16
      *                                                                   CSE020
      ** Array for the New Securities                                     CSE020
      *                                                                   CSE020
     E                    NSEC      180 10                                CSE020
      *
      ***  Array containing parameters for CALL 'QCMDEXC'.
      *
     E                    CMD     1   3 80               SBMJOB
      *
      ***  Arrays ZS1 and ZS2 used by standart subroutine ZSEDIT.
      *
     E/COPY ZSRSRC,ZSEDITZ1
      *
      ***  Arrays used by standart subroutine ZDATE2:
      ***    ZYDY containing Years in days cumulative, four year span,
      ***    ZMDY containing Months in days cumulative through year,
      ***    ZMNM containing Months short name.
      *
     E/COPY ZSRSRC,ZDATE2Z1
      *
      ***  Arrays ZA1 and ZA2 used by standart subroutine ZALIGN.
      *
     E/COPY ZSRSRC,ZALIGNZ1
      *
      ***  Arrays ZS3, ZS4 and ZS5 used by standart subroutine ZASIGN.
      *
     E/COPY ZSRSRC,ZASIGNZ1
      *
      ***  Arrays: - ZRA: Range Limits, used in standart subroutine ZCCAL1 and ZCCAL2 (called by
      ***                 standart subroutine ZCCAL1).
      ***          - ZPC: Percentages, used in standart subroutine ZCCAL1 and ZCCAL2 (called by
      ***                 standart subroutine ZCCAL1).
      ***          - ZCG: Flat Charges, used in standart subroutine ZCCAL1.
      *
     E/COPY ZSRSRC,ZCCAL1Z1
      *
      ***  Array POWER8: POWER8 array, used in standart subroutine ZCCAL1.
      *
     E/COPY ZSRSRC,ZPOWER8Z1
      *
      ***  Array POWER: POWER array, used in standart subroutine ZCONV (called by standard
      ***  subroutine ZCCAL1).
      *
     E/COPY ZSRSRC,ZPOWERZ1
      *
      ***  Array containing Copyright statement.
      *
     E                    CPY@    1   1 80
      *
      /SPACE 3
      *
      ***  Rename fields of SECOOFL1: Midas SE Corporate Actions - Offers.
      *
     ISECOOFD0
     I              MIRECI                          MDRECI
     I              MINSHA                          MDNSHA
     I              MIOSHA                          MDOSHA
     I              MIRNDN                          MDRNDN
     I              MIRNDS                          MDRNDS
     I              MICOMP                          MDCOMP
     I              MIDMLT                          MDDMLT
      *
      ***  Rename fields of SECORGL1: Midas SE Corporate Actions - Rights Issues.
      *
     ISECORGD0
     I              MFRECI                          MDRECI
     I              MFNSHA                          MDNSHA
     I              MFOSHA                          MDOSHA
     I              MFDFNR                          MDDFNR
     I              MFRNDN                          MDRNDN
     I              MFRNDS                          MDRNDS
     I              MFCOMP                          MDCOMP
     I              MFDMLT                          MDDMLT
      *
      ***  Rename fields of SECOEXL1: Midas SE Corporate Actions - Exercices and Conversions.
      *
     ISECOEXD0
     I              MJRECI                          MDRECI
     I              MJOSHA                          MDOSHA
     I              MJNSHA                          MDNSHA
     I              MJDFNR                          MDDFNR
     I              MJSUPR                          MDSBPR
     I              MJRNDN                          MDRNDN
     I              MJDMLT                          MDDMLT
      *
      ***  Rename fields of SECOCRL1: Midas SE Corporate Actions - Corporate Reorganisation.
      *
     ISECOCRD0
     I              MHRECI                          MDRECI
     I              MHOSHA                          MDOSHA
      *
      ***  Rename fields of SECOFRL1: Midas SE Corporate Actions - Free Allocation.
      *
     ISECOFRD0
     I              MERECI                          MDRECI
     I              MENSHA                          MDNSHA
     I              MEOSHA                          MDOSHA
     I              MERNDN                          MDRNDN
     I              MERNDS                          MDRNDS
     I              MECOMP                          MDCOMP
     I              MEDMLT                          MDDMLT
      *
      ***  Rename fields of SECOCEL1: Midas SE Corporate Actions - Capital Changes.
      *
     ISECOCED0
     I              MGRECI                          MDRECI
      *                                                                   CEU017
      ***  Rename fields of SECOCCL2: Midas SE Corporate Actions -        CEU017
      ***                             Currency Changes.                   CEU017
      *                                                                   CEU017
     ISECOCCD0                                                            CEU017
     I              NARECI                          MDRECI                CEU017
     I              NANNSZ                          MDNSHA                CEU017
     I              NAONSZ                          MDOSHA                CEU017
     I              NACOMP                          MDCOMP                CEU017
     I              NARNDN                          MDRNDN                CEU017
     I              NARNDS                          MDRNDS                CEU017
     I              NADMLT                          MDDMLT                CEU017
      *                                                                   CSE020
      ** Rename fields of SECOALL5:  Corporate Actions - Stock Alloc.     CSE020
      *                                                                   CSE020
     ISECOALD5                                                            CSE020
     I              MCRECI                          M5RECI                CSE020
     I              MCLCD                           M5LCD                 CSE020
     I              MCCHTP                          M5CHTP                CSE020
     I              MCLUID                          M5LUID                CSE020
     I              MCCORF                          M5CORF                CSE020
     I              MCOPTN                          M5OPTN                CSE020
     I              MCBRCD                          M5BRCD                CSE020
     I              MCDDPT                          M5DDPT                CSE020
     I              MCCOTP                          M5COTP                CSE020
     I              MCBOOK                          M5BOOK                CSE020
     I              MCCNUM                          M5CNUM                CSE020
     I              MCPTFR                          M5PTFR                CSE020
     I              MCEXPO                          M5EXPO                CSE020
     I              MCSESN                          M5SESN                CSE020
     I              MCOALR                          M5OALR                CSE020
     I              MCOTSA                          M5OTSA                CSE020
     I              MCOSTR                          M5OSTR                CSE020
     I              MCOCAR                          M5OCAR                CSE020
     I              MCCAOP                          M5CAOP                CSE020
     I              MCASTA                          M5ASTA                CSE020
     I              MCHOST                          M5HOST                CSE020
     I              MCHOCA                          M5HOCA                CSE020
     I              MCACAA                          M5ACAA                CSE020
     I              MCASTR                          M5ASTR                CSE020
     I              MCACAR                          M5ACAR                CSE020
     I              MCOPT1                          M5OPT1                CSE020
     I              MCOPT2                          M5OPT2                CSE020
     I              MCREST                          M5REST                CSE020
     I              MCBSEC                          M5BSEC                CSE020
     I              MCBEDT                          M5BEDT                CSE020
     I              MCBSTT                          M5BSTT                CSE020
     I              MCBLTY                          M5BLTY                CSE020
     I              MCBEWI                          M5BEWI                CSE020
     I              MCCOAT                          M5COAT                CSE020
     I              MCTRRF                          M5TRRF                CSE020
     I              MCTRR2                          M5TRR2                CSE020
     I              MCTRR3                          M5TRR3                CSE020
     I              MCRVRF                          M5RVRF                CSE020
     I              MCRVR2                          M5RVR2                CSE020
     I              MCRVR3                          M5RVR3                CSE020
     I              MCTNL1                          M5TNL1                CSE020
     I              MCLTRQ                          M5LTRQ                CSE020
     I              MCTOTF                          M5TOTF                CSE020
     I              MCTOTT                          M5TOTT                CSE020
      *                                                                   CSE020
      ** Rename fields of SECORFL9: Corporate Actions Upd Idx             CSE020
      *                                                                   CSE020
     ISECORFD2                                                            CSE020
     I              MARECI                          IPRECI                CSE020
     I              MALCD                           IPLCD                 CSE020
     I              MACHTP                          IPCHTP                CSE020
     I              MALUID                          IPLUID                CSE020
     I              MACORF                          IPCORF                CSE020
     I              MAJOBN                          IPJOBN                CSE020
     I              MAUSER                          IPUSER                CSE020
     I              MAJNBR                          IPJNBR                CSE020
     I              MASESN                          IPSESN                CSE020
     I              MACOAT                          IPCOAT                CSE020
     I              MAPTYP                          IPPTYP                CSE020
     I              MACOAN                          IPCOAN                CSE020
     I              MACOEX                          IPCOEX                CSE020
     I              MAALEF                          IPALEF                CSE020
     I              MANBOP                          IPNBOP                CSE020
     I              MATDVD                          IPTDVD                CSE020
     I              MACOPD                          IPCOPD                CSE020
     I              MATDDT                          IPTDDT                CSE020
     I              MAEVDT                          IPEVDT                CSE020
     I              MACPNB                          IPCPNB                CSE020
     I              MASHMD                          IPSHMD                CSE020
     I              MALTBS                          IPLTBS                CSE020
     I              MAOCPV                          IPOCPV                CSE020
     I              MANCPV                          IPNCPV                CSE020
     I              MAONML                          IPONML                CSE020
     I              MANNML                          IPNNML                CSE020
     I              MACUPC                          IPCUPC                CSE020
     I              MAEXPC                          IPEXPC                CSE020
     I              MACLRD                          IPCLRD                CSE020
     I              MACLRT                          IPCLRT                CSE020
     I              MADLRD                          IPDLRD                CSE020
     I              MADLRT                          IPDLRT                CSE020
     I              MABLOS                          IPBLOS                CSE020
     I              MABLOP                          IPBLOP                CSE020
     I              MABFRD                          IPBFRD                CSE020
     I              MABEND                          IPBEND                CSE020
     I              MAREFO                          IPREFO                CSE020
     I              MACONR                          IPCONR                CSE020
     I              MADFNR                          IPDFNR                CSE020
     I              MADFCP                          IPDFCP                CSE020
     I              MADFSP                          IPDFSP                CSE020
     I              MALREQ                          IPLREQ                CSE020
     I              MALPRO                          IPLPRO                CSE020
     I              MALTSI                          IPLTSI                CSE020
     I              MASTAT                          IPSTAT                CSE020
     I              MAPREF                          IPPREF                CSE020
      *
      ***  External data structure for Securities Trading details            - Prefixe BV
      *
     ISDSTRD    E DSSDSTRDPD
      *
      ***  External data structure for Module details                        - Prefixe BG
      *
     ISDMMOD    E DSSDMMODPD
      *
      ***  External data structure for Portfolio Management details          - Prefixe FC
      *
     ISDPORT    E DSSDPORTPD
      *
      ***  External data structures for Bank Details                         - Prefixe BJ.
      *
     ISDBANK    E DSSDBANKPD
      *
      ***  External data structure for Portfolio Customer details            - Prefixe QB
      *
     ISDPLCS    E DSSDPLCSPD
      *
      ***  External data structures for Customer Details                     - Prefixe BB.
      *
     ISDCUST    E DSSDCUSTPD
      *
      ***  External data structure for SE Country Tax Rate Details           - Prefixe TX
      *
     ISECNTR    E DSSECNTRPD
      *
      ***  External data structure for SE Country to Branch Tax Rate Details - Prefixe TB
      *
     ISECBTX    E DSSECBTXPD
      *
      ***  External data structure for Branch Details.                       - Prefixe A8
      *
     ISDBRCH    E DSSDBRCHPD
      *
      ***  External data structure for Security Customer Details.            - Prefixe BF
      *
     I              QQDFAC                          QQDFA1                                    CGL029
     ISDSECS    E DSSDSECSPD
      *
      ***  External data structure for Currency Details.                     - Prefixe A6
      *
     ISDCURR    E DSSDCURRPD
      *
      ***  First Data Strusture for Access Programs, Long Data Structure.
      *
     IDSSDY     E DSDSSDY
      *
      ***  Second Data Strusture for Access Programs, Short Data Structure.
      *
     IDSFDY     E DSDSFDY
      *                                                                                       223539
     IDSLDY     E DSDSLDY                                                                     223539
      *
      ***  Local Data Area.
      *
     ILDA       E DSLDA                         256
      *
      ***  Local data area for database error details
      ***  *LOCK IN LDA immediately before and OUT LDA immediately
      ***  after each database error handling.
      ***
      ***                                   134 141 DBFILE
      ***      Defines:                     142 170 DBKEY
      ***                                   171 180 DBPGM
      ***                                   181 1830DBASE
      *
      *
      ***  Data Area giving Midas SE Status.
      *
     ISESTAT    E DSSESTAT
      *
      ***  Program Status Data Structure.
      *
     IPSDS       SDS
     I                                     *PROGRAM SPGM
     I                                      244 253 SJOB
     I                                      254 263 SUSER
     I                                      282 2870STIME
      *
      ***  Display File Status Data Structure.
      *
     ISCRDS       DS
     I                                    B 378 3790CPFPOS
      *
      ***  Data structure for command string for QCMDEXC.
      *
     ICMDTXT      DS                            240
     I                                       81 160 CMDTX2                                    CPK014
     I                                      161 240 CMDTX3                                    CPK014
     I                                       12  20 @CJOB
     I                                       14  19 @REF
     I                                       20  20 @ACTI
     I                                       72  77 @REFN
     I                                       83  85 @BRCD
     I                                       91  96 @DEPT
     I                                      102 103 @OPTN
     I                                      109 118 @NSEC
     I                                      124 125 @BOOK
     I                                      131 136 @CNUM
     I                                      142 145 @PTFR
      *
      ***  Data structure for fields WORK15 used by standart subroutine ZSEDIT.
      *
     I/COPY ZSRSRC,ZSEDITZ2
      *
      /EJECT
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
      *
      ***  Initial processing.
      *
     C                     EXSR SRINIT
      *
      ***  Main processing
      *
     C                     EXSR SRMAIN
      *
      ***  End processing
      *
     C                     EXSR SRENDP
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *================================================================
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRINIT - Initial processing.                                 *
      *                                                               *
      *  Called by: Start mainline.                                   *
      *                                                               *
      *  Calls: *PSSR    - Error control subroutine.                  *
      *         ZSEDIT   - Standart subroutine to insert a decimal    *
      *                    point into a numeric field and to blank    *
      *                    out leading zeroes.                        *
      *         ZDATE2   - Standart subroutine to convert a Day       *
      *                    Number to date formats.                    *
      *         AOSTRDR0 - Midas AO Securities Trading ICD access obj.*
      *         AOMMODR0 - Midas AO Access Midas Modules *RDR.        *
      *         AOPORTR0 - Midas AO Portfolio Management ICD *RDR.    *
      *         AOBANKR0 - Midas AO Bank ICD access object.           *
      *         AOCUSTR0 - Midas AO Client details access object.     *
      *         AOCURRR0 - Midas AO Currency codes access object.     *
      *         AOSARDR0 - Midas AO Sweatchable Features.             *
      *         AOBRCHR0 - Midas AO Branch details access object.     *
      *                                                               *
      *****************************************************************
      *
     C           SRINIT    BEGSR                           ** SRINIT SR **
      *
      ***  Setup Copyright statement.
      *
     C                     MOVEACPY@      CPY2@  80
      *
      ***  Input Parameter List.
      *
     C           *ENTRY    PLIST
     C                     PARM           PCORF   6        CO Reference
     C                     PARM           PSESN  10        Event Security
     C                     PARM           PACT    2        Action Type
     C                     PARM           PPROC   2        Processing Type
     C                     PARM           PEXDT   5        Ex-Date
     C                     PARM           PSTAT   1        Status
     C                     PARM           PFINA   1        Final Allocation Indicator
     C                     PARM           PBRCD   3        Branch
     C                     PARM           PDPOT   6        Depot
     C                     PARM           PNMCY   3        Nominal CCY of the Event Security
     C                     PARM           PNWSEC 10        New Security
     C                     PARM           POPNB   2        Option Number
     C                     PARM           PMODE   1        Mode 'A' or 'E'
     C                     PARM           PRTCD   1        Return code
      *
      ***  Define Local dataarea.
      *
     C           *NAMVAR   DEFN           LDA
      *
      ***  Define Midas SE Status Data Area.
      *
     C           *NAMVAR   DEFN           SESTAT
      *
      ***  Search keys for LF/SECODPL3.
      *
     C           WKEY1     KLIST
     C                     KFLD           WKCORF  6        CO Reference
     C                     KFLD           WKOPTN  20       Option Number
     C                     KFLD           WKBRCD  3        Branch
     C**********           KFLD           WKDEPO  60       Depot                              CSD027
     C                     KFLD           WKDEPO  6        Depot                              CSD027
     C                     KFLD           WKSESN 10        Security
      *
      ***  Search keys for LF/SECDEPL4, LF/SEUDEPL0
      *
     C           WKEY2     KLIST
     C                     KFLD           WKBRCD           Branch
     C                     KFLD           WKSESN           Security
     C                     KFLD           WKDEPO           Depot
      *
      ***  Search keys for LF/SEUDEPL0.
      *
     C           WKEY3     KLIST
     C                     KFLD           WKBRCD           Branch
     C                     KFLD           WKSESN           Security
     C                     KFLD           WKDEPO           Depot
     C                     KFLD           WKUDMK  1        Market
     C                     KFLD           WKUDBK  2        Book
     C                     KFLD           WKUDDT  50       Ex-Date
      *
      ***  Search keys for LF/SECOALL1.
      *
     C           WKEY4     KLIST
     C                     KFLD           WKCORF           CO Reference
     C                     KFLD           WKOPTN           Option Number
     C                     KFLD           WKBRCD           Branch
     C                     KFLD           WKDEPO           Depot
     C                     KFLD           WKSESN           Security
     C                     KFLD           WKCOTP  1        Customer/Book Indicator
     C                     KFLD           WKBOOK  2        Book
     C**********           KFLD           WKCNUM  60       Customer                           CSD027
     C                     KFLD           WKCNUM  6        Customer                           CSD027
     C                     KFLD           WKPTFR  4        Portfolio
      *
      ***  Search keys for LF/SECDEPL4.
      *
     C           WKEY5     KLIST
     C                     KFLD           WKBRCD           Branch
     C                     KFLD           WKSESN           Security
     C                     KFLD           WKDEPO           Depot
     C                     KFLD           WKCDMK  1        Market
     C**********           KFLD           WKCDCN  60       Customer                           CSD027
     C                     KFLD           WKCDCN  6        Customer                           CSD027
     C                     KFLD           WKPTFR           Portfolio
     C                     KFLD           WKDDTE  50       Ex-Date
      *
      ***  Search keys for LF/SECOREL1.
      *
     C           WKEY6     KLIST
     C                     KFLD           WKCORF           CO Reference
     C                     KFLD           WKBRCD           Branch
     C                     KFLD           WKCOTP           Customer/Book Indicator
     C                     KFLD           WKBOOK           Book
     C                     KFLD           WKCNUM           Customer
      *
      ***  Search keys for LF/SECOSIL2.
      *
     C           WKEY7     KLIST
     C                     KFLD           PBRCD            Branch (parameter)
     C                     KFLD           WKBOOK           Book
     C                     KFLD           WKCOAT  2        Corporate Action Type
     C                     KFLD           WKNSEC 10        New Security
      *
      ***  Search keys for LF/SECOSIL1.
      *
     C           WKEY8     KLIST
     C                     KFLD           PBRCD            Branch (parameter)
     C                     KFLD           WKCNUM           Customer
     C                     KFLD           WKPORT  4        Portfolio Reference
     C                     KFLD           WKCOAT           Corporate Action Type
     C                     KFLD           WKNSEC           New Security
      *
      ***  Search Key for LF/CLINT (format CLINTCBF).
      *
     C           WKEY9     KLIST
     C**********           KFLD           KCUST   60       Customer                           CSD027
     C                     KFLD           KCUST   6        Customer                           CSD027
     C                     KFLD           KRTYP   1        Record Type
      *
      ***  Search Key for LF/SECOCHL0.
      *
     C           WKEY10    KLIST
     C                     KFLD           KCUGR   2        Customer Group
     C**********           KFLD           KCDCN   60       Customer                           CSD027
     C                     KFLD           KCDCN   6        Customer                           CSD027
     C                     KFLD           KSITP   3        Investment Type
     C                     KFLD           KCOAT   2        Corporate Action Type
      *
      ***  Search Key for LF/SECOCHL1.
      *
     C           WKEY11    KLIST
     C                     KFLD           KCLAS   1        Classification
     C                     KFLD           KCDCN            Customer
     C                     KFLD           KSITP            Investment Type
     C                     KFLD           KCOAT            Corporate Action Type
      *
      ***  Search Key for LF/SECGT.
      *
     C           WKEY12    KLIST
     C                     KFLD           NMCY1            Event Nominal Currency
     C                     KFLD           KCCOM            Charge Code
      *
      ***  Search keys for LF/SEUDEPL0.
      *
     C           WKEY13    KLIST
     C                     KFLD           WKBRCD           Brench
     C                     KFLD           WKSESN           Security
     C                     KFLD           WKDEPO           Depot
     C                     KFLD           WKUDMK           Market
     C                     KFLD           WKUDBK           Book
      *
      ***  Search Key for LF/SECOxxL1 (where xx = OF, DV, RG, EX, CR, FR or CE).
      *
     C           WKEY14    KLIST
     C                     KFLD           PCORF            CO Reference
     C                     KFLD           POPTN            Option Number
      *
      ***  Search Key for LF/PRICM.
      *
     C           WKEY15    KLIST
     C                     KFLD           MDNSEC           New Security from SECODVL1
     C                     KFLD           KPVDT   50       Value Date
      *
      ***  Search keys for LF/SECDEPL4.
      *
     C           WKEY16    KLIST
     C                     KFLD           WKBRCD           Branch
     C                     KFLD           WKSESN           Security
     C                     KFLD           WKDEPO           Depot
     C                     KFLD           WKCDMK           Market
     C                     KFLD           WKCDCN           Customer
     C                     KFLD           WKPTFR           Portfolio
      *
      ***  Initialise Key and Working Fields.
      *
     C                     MOVE PCORF     WKCORF           CO Reference
     C                     Z-ADDPOPTN     WKOPTN           Option Number
     C                     MOVE PBRCD     WKBRCD           Branch
     C                     Z-ADD0         WWRRN   40       Record Number saved
     C                     MOVE PEXDT     PEXDAT  50       Ex-Date
     C**********           MOVE PDPOT     PDEPO   60       Depot                              CSD027
     C**********           Z-ADDPDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE PDPOT     PDEPO   6        Depot                              CSD027
     C                     MOVE PDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE POPNB     POPTN   20       Option Number
     C                     MOVE 'A'       KRTYP            Record Type for Key
     C                     MOVE PROT      PROT    1        Used in standart SR ZCCAL1
      *
      ***  Access data area SESTAT: Midas SE Status to check if Portfolio Management have been
      ***  licensed, to diplay Customer and Portfolio Reference on screens.
      *
     C                     IN   SESTAT
     C           PFPL      IFEQ 'Y'
     C                     MOVE '1'       *IN13            Portolio Management installed
     C                     ENDIF
      *
      ***  Call Access Program for Switchable Feature Details to see if Private Banking SE
      ***  Enhancements is installed.
      *
     C                     MOVE 'N'       S01496  1
     C                     CALL 'AOSARDR0'
     C                     PARM '       ' WRTCD
     C                     PARM '*VERIFY' WOPTN
     C                     PARM 'S01496'  WSARD   6
      *
     C           WRTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       S01496
     C                     ENDIF
     C/COPY WNCPYSRC,SE7513C001
      *                                                                   CAC005
      ** Check if CAC005 is installed                                     CAC005
      *                                                                   CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   PRTCD1  7                       CAC005
     C                     PARM '*VERIFY' POPTN1  7                       CAC005
     C                     PARM 'CAC005'  PSARD   6                       CAC005
      *                                                                   CAC005
     C           PRTCD1    IFEQ *BLANKS                                   CAC005
     C                     MOVE 'Y'       CAC005  1                       CAC005
     C                     MOVE *OFF      *IN69                           CAC005
     C                     ELSE                                           CAC005
     C                     MOVE 'N'       CAC005                          CAC005
     C                     MOVE *ON       *IN69                           CAC005
     C                     ENDIF                                          CAC005
      *
      ***  Call Access Program for Switchable Feature Details to see if Customer Commissions
      ***  (Courtage) amendment is installed.
      *
     C                     MOVE 'N'       S01446  1
     C                     CALL 'AOSARDR0'
     C                     PARM '       ' WRTCD
     C                     PARM '*VERIFY' WOPTN
     C                     PARM 'S01446'  WSARD
      *
     C           WRTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       S01446
     C                     ENDIF
      *
      ***  Call Access Program for Switchable Feature Details to see if Withholding Tax feature
      ***  is installed.
      *
     C                     MOVE 'N'       S01447  1
     C                     CALL 'AOSARDR0'
     C                     PARM '       ' WRTCD
     C                     PARM '*VERIFY' WOPTN
     C                     PARM 'S01447'  WSARD   6
      *
     C           WRTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       S01447
     C                     ENDIF
      *
      ***  If Withholding Tax feature is ON.
      *
     C           S01447    IFEQ 'Y'
      *
      ***  Call Access Program for Branch Details to retrieve Branch Internal Customer.
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM PBRCD     WBRCD   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD001       DBASE            ***************
     C                     MOVEL'SDBRCHPD'DBFILE           * DB ERROR 01 *
     C                     MOVELPBRCD     DBKEY            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
      *
      ***  Otherwise, retrieve Country of Location for Branch Internal Customer.
      *
     C                     MOVE A8BICN    KCUST
     C           WKEY9     CHAINCLINT                84
      *
      ***  If record not found or not live, handle database error.
      *
     C           *IN84     IFEQ '1'
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD002       DBASE            ***************
     C                     MOVEL'CLINTCB 'DBFILE           * DB ERROR 02 *
     C                     MOVELKCUST     DBKEYB  7        ***************
     C                     MOVE KRTYP     DBKEYB
     C                     MOVELDBKEYB    DBKEY
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
      *
      ***  Otherwise, set Country of Location for Branch Internal Customer.
      *
     C                     MOVE CLOC      UBRLOC  2
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Retrieve CO References details.
      *
     C           PCORF     CHAINSECORFL1             75
     C           *IN75     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECORFL1'DBFILE           ***************
     C                     MOVELPCORF     DBKEY            * DB ERROR 03 *
     C                     Z-ADD003       DBASE            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C           MAPREF    CHAINSECORFD2             75                   CSE020
      *                                                                   CSE020
     C           *IN75     IFEQ '1'                                       CSE020
     C           *LOCK     IN   LDA                                       CSE020
     C                     MOVEL'SECORFL9'DBFILE           ***************CSE020
     C                     MOVELMAPREF    DBKEY            * DB ERROR 40 *CSE020
     C                     Z-ADD040       DBASE            ***************CSE020
     C                     MOVEL'SE7513'  DBPGM                           CSE020
     C                     OUT  LDA                                       CSE020
     C                     EXSR *PSSR                                     CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C           IPPREF    DOWNE*BLANKS                                   CSE020
     C           IPPREF    CHAINSECORFD2             75                   CSE020
     C           *IN75     IFEQ '1'                                       CSE020
     C                     MOVEL'SECORFL9'DBFILE           ***************CSE020
     C                     MOVELMAPREF    DBKEY            * DB ERROR 41 *CSE020
     C                     Z-ADD041       DBASE            ***************CSE020
     C                     MOVEL'SE7513'  DBPGM                           CSE020
     C                     OUT  LDA                                       CSE020
     C                     EXSR *PSSR                                     CSE020
     C                     ENDIF                                          CSE020
     C                     ENDDO                                          CSE020
     C                     MOVE IPSESN    WOSESN 10                       CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Call Access Program for Securities Trading Details.
      *
     C                     CALL 'AOSTRDR0'
     C                     PARM '*BLANKS' WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C           SDSTRD    PARM SDSTRD    DSSDY
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDSTRDPD'DBFILE           ***************
     C                     MOVEL'*FIRST  'DBKEY            * DB ERROR 04 *
     C                     Z-ADD004       DBASE            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Retrieve Dummy Customer Number.
      *
     C**********           MOVE BVERCU    WDUMMY  60                                          CSD027
     C                     MOVE BVERCU    WDUMMY  6                                           CSD027
      *
      ***  Call Access Program for Module Details - Portfolio Management Indicator.
      *
     C                     CALL 'AOMMODR0'
     C                     PARM '*BLANKS' WRTCD
     C                     PARM '*FIRST ' WOPTN
     C           SDMMOD    PARM SDMMOD    DSSDY
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDMMODPD'DBFILE           ***************
     C                     MOVEL'*FIRST  'DBKEY            * DB ERROR 05 *
     C                     Z-ADD005       DBASE            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Check if Portfolio Management is present.
      *
     C           BGPFMG    IFEQ 'Y'
     C           BGN4ST    OREQ 'Y'                                       CPB001
     C                     MOVE '1'       *IN68
      *
      ***  Call Access Program for Portfolio Management ICD.
      *
     C           BGPFMG    IFEQ 'Y'                                       CPB001
     C                     CALL 'AOPORTR0'
     C                     PARM '*BLANK ' WRTCD
     C                     PARM '*FIRST ' WOPTN
     C           SDPORT    PARM SDPORT    DSSDY
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANK                     ***************
     C           *LOCK     IN   LDA                        * DB ERROR 06 *
     C                     Z-ADD006       DBASE            ***************
     C                     MOVEL'SDPORTPD'DBFILE
     C                     MOVEL'*FIRST'  DBKEY
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Retrieve Reference Attached to 9997 field.
      *
     C                     MOVE FCR997    W9997   4
     C                     ENDIF                                          CPB001
      *
     C                     ENDIF
      *
      ***  Call Access Program for Bank Details - Title, Run Date and
      ***  Run Day Number.
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*BLANKS' WRTCD
     C                     PARM '*FIRST ' WOPTN
     C           SDBANK    PARM SDBANK    DSSDY
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE           ***************
     C                     MOVEL'*FIRST  'DBKEY            * DB ERROR 07 *
     C                     Z-ADD007       DBASE            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     MOVE BJMRDT    SMRDT
      *
      ***  Check System Date Format, DDMMYY (*IN98 off)
      ***                            MMDDYY (*IN98 on).
      *
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ENDIF
      *
      ***  Retrieve Event Currency, Event Security Decimal Places, Event Price Basis and Event
      ***  Security Investment Type.
      *
     C           PSESN     CHAINSECTYZ1              89
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECTY   'DBFILE
     C                     MOVELPSESN     DBKEY            ***************
     C                     Z-ADD008       DBASE            * DB ERROR 08 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
     C                     Z-ADDNMDP      NMDP1   10       Event Security Decimal Places
     C                     MOVE NMCY      NMCY1   3        Event Currency
     C                     MOVE SPBS      SPBS1   1        Event Price Basis
     C                     MOVE SITP      SITP1   3        Event Security Investment Type
      *
      ***  Retrieve Number of Decimal Places of Event Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM NMCY      WAJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD009       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 09 *
     C                     MOVELWAJCD     DBKEY            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    NMDPC1  10       Event Currency Decimal Places
     C                     ENDIF
      *
      ***  If New Security = '**CASH**'.
      *
     C           PNWSEC    IFEQ '**CASH**'
      *
     C                     MOVE *BLANKS   WUNSEC 10
      *
      ***  If Processing Type not Corporate Reorganisation.
      *
     C           PPROC     IFNE 'CR'
      *
      ***  Retrieve New Security Shortname on Corporate Actions Detail file, not for Processing
      ***  Type Capital Changes, where New Security = Event Security.
      *
     C                     SELEC
     C           PPROC     WHEQ 'DV'                       Divedend Events
     C           WKEY14    SETGTSECODVL1
     C           WKEY14    REDPESECODVL1                 89
     C                     MOVE MDNSEC    WUNSEC
     C                     MOVEL'SECODVL1'DBFILS  8
      *
     C           PPROC     WHEQ 'FR'                       Free Allocation
     C           WKEY14    SETGTSECOFRL1
     C           WKEY14    REDPESECOFRL1                 89
     C                     MOVE MENSEC    WUNSEC
     C                     MOVEL'SECOFRL1'DBFILS
      *
     C           PPROC     WHEQ 'RG'                       Rights Issues
     C           WKEY14    SETGTSECORGL1
     C           WKEY14    REDPESECORGL1                 89
     C                     MOVE MFNSEC    WUNSEC
     C                     MOVEL'SECORGL1'DBFILS
      *
     C           PPROC     WHEQ 'OF'                       Offers
     C           WKEY14    SETGTSECOOFL1
     C           WKEY14    REDPESECOOFL1                 89
     C                     MOVE MINSEC    WUNSEC
     C                     MOVEL'SECOOFL1'DBFILS
      *
     C           PPROC     WHEQ 'EX'                       Exercices and Conversions
     C           WKEY14    SETGTSECOEXL1
     C           WKEY14    REDPESECOEXL1                 89
     C                     MOVE MJNSEC    WUNSEC
     C                     MOVEL'SECOEXL1'DBFILS
      *
     C           PPROC     WHEQ 'CC'                       Currency       CEU017
     C           PCORF     SETGTSECOCCL2                   Changes        CEU017
     C           PCORF     REDPESECOCCL2                 89               CEU017
     C                     MOVE NANSEC    WUNSEC                          CEU017
     C                     MOVEL'SECOCCL2'DBFILS                          CEU017
      *                                                                   CEU017
      ***  If record not found, handle database error.
      *
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD010       DBASE            ***************
     C                     MOVELDBFILS    DBFILE           * DB ERROR 10 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C           PPROC     IFEQ 'CC'
     C                     MOVELPCORF     DBKEY
     C                     ELSE
     C                     MOVELPCORF     DBKEY1
     C                     MOVE POPTN     DBKEY1
     C                     MOVELDBKEY1    DBKEY
     C                     ENDIF
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDSL
      *
     C           WUNSEC    IFNE *BLANKS
      *
      ***  If Processing Type with New Security entered (else, New Security = Event Security),
      ***  retrieve New Currency.
      *
     C           WUNSEC    CHAINSECTYZ1              89
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECTYZ1 'DBFILE
     C                     MOVELWUNSEC    DBKEY            ***************
     C                     Z-ADD011       DBASE            * DB ERROR 11 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM NMCY      WAJCD
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD012       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 12 *
     C                     MOVELWAJCD     DBKEY            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    NMDPC2           New Currency Decimal Places
     C                     ELSE
      *
      ***  If Processing Type with no New Security entered (New Security = Event Security),
      ***  set New Currency Decimal Places to Event Currency Decimal Places.
      *
     C                     Z-ADDNMDPC1    NMDPC2           New Currency Decimal Places = Event
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If the value of PNWSEC is not equal to '**CASH**' display normal screen.
      *
     C           PNWSEC    IFNE '**CASH**'
      *
      ***  Load key fields.
      *
     C                     MOVE PCORF     WKCORF           CO Reference
     C                     MOVE POPTN     WKOPTN           Option Number
     C                     MOVE PBRCD     WKBRCD           Branch
     C**********           Z-ADDPDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE PDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE PNWSEC    WKSESN           Security = 'CASH'
     C                     MOVE '1'       *IN60            Normal screen processed
      *
      ***  Retrieve CO Depot details.
      *
     C           WKEY1     CHAINSECODPD0            N76
      *
      ***  If record not found, handle database error.
      *
     C           *IN76     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECODPL3'DBFILE
     C                     MOVE WKOPTN    WWOPTN  2
     C                     MOVE WKDEPO    WWDEPO  6
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C                     MOVELDBKEY4    DBKEY            ***************
     C                     Z-ADD013       DBASE            * DB ERROR 13 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Retrieve New Currency, New Security Decimal Places and New Price Basis.
      *
     C           PNWSEC    CHAINSECTYZ1              89
      *
      ***  If record not found, handle database error.
      *
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECTY   'DBFILE
     C                     MOVELPNWSEC    DBKEY            ***************
     C                     Z-ADD014       DBASE            * DB ERROR 14 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
     C                     Z-ADDNMDP      NMDP2   10       New Security Decimal Places
     C                     MOVE NMCY      NMCY2   3        New Currency
     C                     MOVE SPBS      SPBS2   1        New Price Basis
      *
      ***  Retrieve Number of Decimal Places of Event Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD   7
     C                     PARM '*KEY   ' WOPTN   7
     C                     PARM NMCY      WAJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD015       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 15 *
     C                     MOVELWAJCD     DBKEY            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    NMDPC2  10       New Currency Decimal Places
     C                     ENDIF
      *
      ***  Load screen fields.
      *
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MBBSTA    ZFLD15
     C                     MOVE NMDP2     ZDECS            New Security Decimal Places
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE *BLANKS   SACSTK
     C                     MOVE ZOUT21    SACSTK           Balancing Stock Allocation
     C                     MOVE NMCY2     SSTCCY           New Currency
      *
     C                     ENDIF
      *
      ***  Access CO Depot file with New Security = '**CASH**'.
      *
     C                     MOVE PCORF     WKCORF
     C                     MOVE POPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C**********           Z-ADDPDEPO     WKDEPO                                              CSD027
     C                     MOVE PDEPO     WKDEPO                                              CSD027
     C                     MOVE *BLANKS   WKSESN
     C                     MOVEL'**CASH**'WKSESN
     C           WKEY1     CHAINSECODPD0            N76
      *
      ***  If record not found, handle database error.
      *
     C           *IN76     IFEQ '1'
     C           MBRECI    ORNE 'D'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECODPL3'DBFILE
     C                     MOVE WKOPTN    WWOPTN
     C                     MOVE WKDEPO    WWDEPO
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C                     MOVELDBKEY4    DBKEY            ***************
     C                     Z-ADD016       DBASE            * DB ERROR 16 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
      *
      ***  If record found, output Balancing Actual Cash Allocation and currency.
      *
     C                     ELSE
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MBBCAA    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     MOVE NMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     MOVE NMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE *BLANKS   SCASH
     C                     MOVE ZOUT21    SCASH            Actual Cash Allocation
     C           PPROC     IFEQ 'CR'
     C                     MOVE NMCY1     SCHCCY           Event Currency
     C                     ELSE
     C                     MOVE NMCY2     SCHCCY           New Currency
     C                     ENDIF
      *
      ***  If the value of PNWSEC is equal to '**CASH**',
      ***  output Balancing Actual Stock Allocation and Currency
      *
     C           PNWSEC    IFEQ '**CASH**'
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MBBSTA    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     MOVE NMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     MOVE NMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE *BLANKS   SACSTK
     C                     MOVE ZOUT21    SACSTK           Actual Stock Allocation
     C           PPROC     IFEQ 'CR'
     C                     MOVE NMCY1     SSTCCY           Event Currency
     C                     ELSE
     C                     MOVE NMCY2     SSTCCY           New Currency
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Load screen fields.
      *
      * Call SDRTVTXT pgm to access appropriate text                      155622
      *  for a field used in a SFL                                        155622
      *                                                                   155622
      * Stock Allocation                                                  155622
     C                     MOVEL'ZZGBMSGF'MSGNM                           155622
     C                     MOVEL'ZZN6113' MSGDNB                          155622
     C                     CALL 'SDRTVTXT'                                155622
     C                     PARM           MSGDNB  7                       155622
     C                     PARM           MSGNM  10                       155622
     C                     PARM           MSGTXT 80                       155622
     C                     MOVELMSGTXT    ZZM002 16                       155622
      *                                                                   155622
      * Stock Rounding                                                    155622
     C                     MOVEL'ZZGBMSGF'MSGNM                           155622
     C                     MOVEL'ZZN6114' MSGDNB                          155622
     C                     CALL 'SDRTVTXT'                                155622
     C                     PARM           MSGDNB                          155622
     C                     PARM           MSGNM                           155622
     C                     PARM           MSGTXT                          155622
     C                     MOVELMSGTXT    ZZM003 14                       155622
      *                                                                   155622
      * Cash Rounding                                                     155622
     C                     MOVEL'ZZGBMSGF'MSGNM                           155622
     C                     MOVEL'ZZN6115' MSGDNB                          155622
     C                     CALL 'SDRTVTXT'                                155622
     C                     PARM           MSGDNB                          155622
     C                     PARM           MSGNM                           155622
     C                     PARM           MSGTXT                          155622
     C                     MOVELMSGTXT    ZZM004 13                       155622
      *                                                                   155622
      * Cash Option                                                       155622
     C                     MOVEL'ZZGBMSGF'MSGNM                           155622
     C                     MOVEL'ZZN6128' MSGDNB                          155622
     C                     CALL 'SDRTVTXT'                                155622
     C                     PARM           MSGDNB                          155622
     C                     PARM           MSGNM                           155622
     C                     PARM           MSGTXT                          155622
     C***********          MOVELMSGTXT    ZZM040 11                                    155622 CPK014
     C                     MOVELMSGTXT    ZZM041 11                                           CPK014
      *                                                                   155622
      * Actual Cash Allocation                                            155622
     C                     MOVEL'ZZGBMSGF'MSGNM                           155622
     C                     MOVEL'ZZN6129' MSGDNB                          155622
     C                     CALL 'SDRTVTXT'                                155622
     C                     PARM           MSGDNB                          155622
     C                     PARM           MSGNM                           155622
     C                     PARM           MSGTXT                          155622
     C***********          MOVELMSGTXT    ZZM041 18                                    155622 CPK014
     C                     MOVELMSGTXT    ZZM042 18                                           CPK014
      *                                                                   155622
      * Original Cash Rounding                                            155622
     C                     MOVEL'ZZGBMSGF'MSGNM                           155622
     C                     MOVEL'ZZN6130' MSGDNB                          155622
     C                     CALL 'SDRTVTXT'                                155622
     C                     PARM           MSGDNB                          155622
     C                     PARM           MSGNM                           155622
     C                     PARM           MSGTXT                          155622
     C***********          MOVELMSGTXT    ZZM042 17                                    155622 CPK014
     C                     MOVELMSGTXT    ZZM043 17                                           CPK014
      *                                                                   155622
      * Actual Cash Rounding                                              155622
     C                     MOVEL'ZZGBMSGF'MSGNM                           155622
     C                     MOVEL'ZZN6131' MSGDNB                          155622
     C                     CALL 'SDRTVTXT'                                155622
     C                     PARM           MSGDNB                          155622
     C                     PARM           MSGNM                           155622
     C                     PARM           MSGTXT                          155622
     C***********          MOVELMSGTXT    ZZM043 18                                    155622 CPK014
     C                     MOVELMSGTXT    ZZM044 18                                           CPK014
      *                                                                   155622
      * Total Fees                                                        155622
     C                     MOVEL'ZZGBMSGF'MSGNM                           155622
     C                     MOVEL'ZZN6132' MSGDNB                          155622
     C                     CALL 'SDRTVTXT'                                155622
     C                     PARM           MSGDNB                          155622
     C                     PARM           MSGNM                           155622
     C                     PARM           MSGTXT                          155622
     C***********          MOVELMSGTXT    ZZM044 10                                    155622 CPK014
     C                     MOVELMSGTXT    ZZM045 10                                           CPK014
      *                                                                   155622
      * Total Settlement                                                  155622
     C                     MOVEL'ZZGBMSGF'MSGNM                           155622
     C                     MOVEL'ZZN6133' MSGDNB                          155622
     C                     CALL 'SDRTVTXT'                                155622
     C                     PARM           MSGDNB                          155622
     C                     PARM           MSGNM                           155622
     C                     PARM           MSGTXT                          155622
     C***********          MOVELMSGTXT    ZZM045 16                                    155622 CPK014
     C                     MOVELMSGTXT    ZZM046 16                                           CPK014
      *                                                                   155622
     C                     MOVE PCORF     SREFNO           CO Reference
     C                     MOVE PSESN     SSESN            Security
     C                     MOVE PACT      SACTTY           CO Action Type
     C                     MOVE PSTAT     SSTAT            Status
     C                     MOVE PBRCD     SBRCH            Branch
     C                     MOVE POPNB     SOPT             Option Number
     C                     MOVE PNWSEC    SNWSEC           New Security
     C                     MOVE NMCY1     SNMCCY           Nominal Currency = Event Ccy
     C                     MOVE NMCY1     SCCY             Currency  = Event Ccy
     C                     MOVE NMCY2     SSACCY           Stock Allocation Currency = New Ccy
     C                     MOVE NMCY2     SSRCCY           Stock Rounding Currency = New Ccy
     C                     MOVE NMCY2     SCRCCY           Cash Rounding Currency = New Ccy
      *
     C                     MOVE PEXDT     ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZDATE     SEXDAT           Ex-Date
      *
      ***  Retrieve Depot Shortname.
      *
     C                     MOVE *BLANKS   WKEYC
     C                     MOVELPDPOT     WKEYC
     C**********           CALL 'AOCUSTR0'                                                    223539
     C                     CALL 'AOCUSTR1'                                                    223539
     C                     PARM '*DBERR'  WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM           WKEYC  10
     C                     PARM *BLANKS   WKYST   7
     C********** SDCUST    PARM SDCUST    DSSDY                                               223539
     C           SDCUST    PARM SDCUST    DSLDY                                               223539
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           BBCLST    ANDNE'Y'                                                           223539
     C           *LOCK     IN   LDA
     C                     Z-ADD017       DBASE            ***************
     C                     MOVEL'SDCUSTPD'DBFILE           * DB ERROR 17 *
     C                     MOVELPDPOT     DBKEY            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVELBBCSSN    SDEPOT           Depot Shortname
      *
     C                     MOVE 'Y'       WFIRST  1        Indicator first paasge
      *
      ***  Setup message file for subroutine ZASNMS.
      *
     C                     MOVEL'SEUSRMSG'ZAMSGF
      *
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRMAIN - Main processing.                                    *
      *                                                               *
      *  Called by: Start mainline.                                   *
      *                                                               *
      *  Calls: SRCLSF  - Clear subfile.                              *
      *         SRBLDF  - Build the first subfile page.               *
      *         SRBLDN  - Build the next subfile page.                *
      *         SRVALD  - Validate subfile records.                   *
      *         ZASNMS  - Send Message to Program Message Queue.      *
      *         ZALIGN  - Standart subroutine to validate and         *
      *                   right-align numeric fields.                 *
      *         Y2CLMSC - Midas ABS Clear specific program message    *
      *                    queue.                                     *
      *                                                               *
      *****************************************************************
      *
     C           SRMAIN    BEGSR                           ** SRMAIN SR **
      *
     C                     MOVE 'N'       ERMSG   1
      *
      ***  If Enquiry Mode, set indicator to protect fields.
      *
     C           PMODE     IFEQ 'E'
     C                     MOVE '1'       *IN70            Enquiry mode
     C                     ELSE
     C                     MOVE '0'       *IN70            Amend mode
     C                     ENDIF
      *
      ***  Do while F3: Exit, F12: Previous screen and F20: 'Exit without saving' pressed.
      *
     C           *INKL     DOWEQ'0'                        Exit
     C           *INKC     ANDEQ'0'                        Previous screen
     C           *IN20     ANDEQ'0'                        Exit without saving
      *
      ***  If it's the first time processing or F5: Refresh is pressed.
      *
     C           *IN45     IFEQ '0'                        First time processing
     C           *INKE     OREQ '1'                        Refresh
      *
     C                     MOVE '0'       *IN45            First time processing
      *
      ***  Reset Error indicators and field.
      *
     C                     MOVE 'N'       ERMSG            Error found indicator
     C***********          MOVEA'000'     *IN,50                          CAC005
     C                     MOVEA'0000'    *IN,50                          CAC005
     C                     MOVEA'00000'   *IN,54
     C                     MOVE ' '       SACODE           Action Code
      *                                                                   137879
      ***  Reset Review from fields.                                      137879
      *                                                                   137879
     C                     MOVE *BLANKS   SRFBK                           137879
     C                     MOVE *BLANKS   SPRFC                           CAC005
     C                     MOVE *BLANKS   SCUST                           137879
     C                     MOVE *BLANKS   SCSTAT                          137879
      *
      ***  Clear subfile.
      *
     C                     EXSR SRCLSF
      *
      ***  Build the first subfile page.
      *
     C                     EXSR SRBLDF
      *
     C                     MOVE '1'       *IN45            Not first time processing
     C                     ENDIF
      *
      ***  If Rollup is pressed and if no error detected.
      *
     C           *IN27     IFEQ '1'                        Rollup
     C           ERMSG     ANDEQ'N'                        No error
      *
      ***  Clear messages from program message queue.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM SPGM      ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
      ***  Build the next subfile page.
      *
     C                     EXSR SRBLDN
     C                     ENDIF
      *
      ***  If a review field is changed and no error detected.
      *
     C******     SCUST     IFNE *BLANKS                    Review Cust.   137879
     C******     SRFBK     ORNE *BLANKS                    Review Book    137879
     C******     SCSTAT    ORNE ' '                        Review Status  137879
     C           SCUST     IFNE WSCUST                     Review Cust.   137879
     C           SRFBK     ORNE WSRFBK                     Review Book    137879
     C           SPRFC     ORNE WSPRFC                                    CAC005
     C           SCSTAT    ORNE WSSTAT                     Review Status  137879
     C           ERMSG     ANDEQ'N'                        No error
      *
      ***  Review Book and Customer can not be entered at the same time.
      *
     C           SCUST     IFNE *BLANKS
     C           SRFBK     ANDNE*BLANKS
     C                     MOVEL'CO00222' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN50
     C                     MOVE '1'       *IN56
     C                     MOVE 'Y'       ERMSG
     C                     MOVE '0'       *IN47
      *
     C                     ELSE
      *                                                                   CAC005
      ** If CAC005 is installed                                           CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
      *                                                                   CAC005
      ** If screen-review-book code is blank and screen-review profit     CAC005
      ** centre is non-blank                                              CAC005
      *                                                                   CAC005
     C           SRFBK     IFEQ *BLANKS                                   CAC005
     C           SPRFC     ANDNE*BLANKS                                   CAC005
     C***********          MOVEL'PCA0008' ZAMSID                   CAC005 179197
     C                     MOVEL'PCA0014' ZAMSID                          179197
     C                     EXSR ZASNMS                                    CAC005
     C                     MOVE *ON       *IN53                           CAC005
     C                     MOVE 'Y'       ERMSG                           CAC005
     C                     MOVE *OFF      *IN47                           CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
      ** If screen-review-book code is non-blank and screen-review profit CAC005
      ** centre is blank                                                  CAC005
      *                                                                   CAC005
     C           SRFBK     IFNE *BLANKS                                   CAC005
     C           SPRFC     ANDEQ*BLANKS                                   CAC005
     C                     MOVEL'PCA0013' ZAMSID                          CAC005
     C                     EXSR ZASNMS                                    CAC005
     C                     MOVE *ON       *IN53                           CAC005
     C                     MOVE 'Y'       ERMSG                           CAC005
     C                     MOVE *OFF      *IN47                           CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
      ** If screen-review-book code is non-blank and screen-review-profit CAC005
      ** centre is non-blank                                              CAC005
      *                                                                   CAC005
     C           SRFBK     IFNE *BLANKS                                   CAC005
     C           SPRFC     ANDNE*BLANKS                                   CAC005
      *                                                                   CAC005
      ** Check if book - profit centre combination is valid               CAC005
      *                                                                   CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM *BLANKS   PRTCD1                          CAC005
     C                     PARM '*PSEUDO' POPTN1                          CAC005
     C                     PARM SRFBK     PBKCD   2                       CAC005
     C                     PARM SPRFC     PPRFC   4                       CAC005
     C                     PARM           PPSBK   2                       CAC005
      *                                                                   CAC005
     C           PRTCD1    IFNE *BLANKS                                   CAC005
     C                     MOVEL'PCA0012' ZAMSID                          CAC005
     C                     EXSR ZASNMS                                    CAC005
     C                     MOVE *ON       *IN53                           CAC005
     C                     MOVE 'Y'       ERMSG                           CAC005
     C                     MOVE *OFF      *IN47                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *
      ***  Check validity of Review Customer, if entered.
      *
     C           SCUST     IFNE *BLANKS
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SCUST     ZFIELD
     C                     Z-ADD6         ZADIG
     C                     Z-ADD0         ZADEC
     C                     EXSR ZALIGN
      *
      ***  If Review Customer not numeric, send error message.
      *
     C           *IN99     IFEQ '1'
     C                     MOVEL'CO00224' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN50
     C                     MOVE 'Y'       ERMSG
     C                     MOVE '0'       *IN47
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDIF
      *
      ***  Review Reply Status must be blank or 'R'eply received, 'S'td Inst Default,
      ***  'C'orporate Default, 'M'anually Changes or 'N'one.
      *
     C           SCSTAT    IFNE ' '
     C           SCSTAT    ANDNE'R'
     C           SCSTAT    ANDNE'S'
     C           SCSTAT    ANDNE'C'
     C           SCSTAT    ANDNE'M'
     C           SCSTAT    ANDNE'N'
     C                     MOVEL'CO00269' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN51
     C                     MOVE 'Y'       ERMSG
     C                     MOVE '0'       *IN47
     C                     ENDIF
      *
      ***  If no error detected.
      *
     C           ERMSG     IFEQ 'N'
      *
      ***  Clear subfile.
      *
     C                     EXSR SRCLSF
      *
     C                     MOVE '1'       *IN47            Review from asked
      *
      ***  Build the next subfile page but starting at 'Book', 'Customer' or 'Reply Status'
      ***  from 'Review'.
      *
     C                     EXSR SRBLDN
      *
     C                     MOVE '0'       *IN47            Reset indicator Review from asked
      *
      *****Reset*'Review*from'*fields.*********************************** 137879
      ***  Save 'Review from' fields.                                     137879
      *
     C******               MOVE *BLANKS   SRFBK            Book           137879
     C******               MOVE *BLANKS   SCUST            Customer       137879
     C******               MOVE ' '       SCSTAT           Reply Status   137879
     C                     MOVE SRFBK     WSRFBK  2        Book           137879
     C                     MOVE SPRFC     WSPRFC  4                       CAC005
     C                     MOVE SCUST     WSCUST  6        Customer       137879
     C                     MOVE SCSTAT    WSSTAT  1        Reply Status   137879
     C                     ENDIF
     C                     ENDIF
      *                                                                   137879
     C           *IN81     IFEQ '0'                                       137879
     C                     MOVEL'CO00001' ZAMSID                          137879
     C                     EXSR ZASNMS                                    137879
     C                     ENDIF                                          137879
      *
      ***  Setup screen time.
      *
     C                     TIME           STIME            Screen time.
      *
      ***  Execute the subfile control record.
      *
     C                     WRITE#MSGCTL                    program message137879
     C                     WRITESE7513F2                   Command keys
     C******               WRITE#MSGCTL                    program message137879
      *
     C           *IN60     IFEQ '1'
     C                     EXFMTSE7513C0                   normal screen
     C                     ELSE
     C                     EXFMTSE7513C1                   'CASH' screen
     C                     ENDIF
      *
      ***  Clear messages from program message queue.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM SPGM      ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
      ***  If no function is pressed, validate all subfile records.
      *
     C           *IN46     IFEQ '0'
     C                     EXSR SRVALD
     C                     ENDIF
     C                     ENDDO
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRENDP - Termination processing.                             *
      *                                                               *
      *  Called by: Start mainline.                                   *
      *                                                               *
      *  Calls: ZASNMS - Send Message to Program Message Queue.       *
      *                                                               *
      *****************************************************************
      *
     C           SRENDP    BEGSR                           ** SRENDP SR **
      *
      ***  F12: Previous screen pressed.
      *
     C           *INKL     IFEQ '1'
     C                     MOVE '2'       PRTCD
     C                     COMIT
     C                     ENDIF
      *
      ***  If F20: Exit without saving pressed.
      *
     C           *IN20     IFEQ '1'
      *
     C                     MOVE ' '       SCONF            Reset Confirm exit field
     C                     MOVE '1'       *IN21            Confirm exit indicator
      *
      ***  Do while Confirm 'Exit without saving' field no valid.
      *
     C           SCONF     DOWNE'Y'
     C           SCONF     ANDNE'N'
     C                     WRITE#MSGCTL                    program message137879
     C                     WRITESE7513F5                   Command keys
     C******               WRITE#MSGCTL                    program message137879
     C           *IN60     IFEQ '1'
     C                     EXFMTSE7513F3                   Confirn normal screen
     C                     ELSE
     C                     EXFMTSE7513F4                   Confirm 'CASH' screen
     C                     ENDIF
      *
      ***  Confirm 'Exit without saving' field must be blank, 'Y'es or 'N'o.
      *
     C           SCONF     IFNE ' '
     C           SCONF     ANDNE'Y'
     C           SCONF     ANDNE'N'
     C                     MOVEL'CO00200' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN59
     C                     ENDIF
      *
      ***  If Exit without saving confirmed, rollback changed records.
      *
     C           SCONF     IFEQ 'Y'
     C                     ROLBK
     C                     ELSE
      *
      ***  If Exit without saving not confirmed, comit changed records.
      *
     C           SCONF     IFEQ 'N'
     C                     COMIT
     C                     ENDIF
     C                     ENDIF
     C                     ENDDO
      *
      ***  Setup parameter indicator 'F3 pressed'.
      *
     C                     MOVE '3'       PRTCD
      *
     C                     ENDIF
      *
      ***  Setup *INKC = F3 = Exit.
      *
     C           *INKC     IFEQ '1'
     C                     MOVE '3'       PRTCD
     C                     ENDIF
      *
      ***  Return to calling program.
      *
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRCLSF - Clear subfile.                                      *
      *                                                               *
      *  Called by: SRMAIN - Main processing.                         *
      *                                                               *
      *  Calls: None.                                                 *
      *                                                               *
      *****************************************************************
      *
     C           SRCLSF    BEGSR                           ** SRCLSF SR **
      *
      ***  Clear subfile.
      *
     C                     MOVE '1'       *IN80            Clear subfile indicator
     C                     MOVE '0'       *IN81            Display subfile137879
      *
     C           *IN60     IFEQ '1'
     C                     WRITESE7513C0                   Normal subfile
     C                     ELSE
     C                     WRITESE7513C1                   'CASH' subfile
     C                     ENDIF
      *
     C                     MOVE '0'       *IN80            Clear subfile indicator
     C******               MOVE '1'       *IN81            Display subfile137879
     C                     MOVE '0'       *IN81            Display subfile137879
     C                     MOVE '0'       *IN30            End of subfile
     C                     Z-ADD*ZEROS    SRRN             Reset Record number
     C                     Z-ADD0         WWCPT   20       Meter record write in subfile
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRBLDF - Build the first subfile page.                       *
      *                                                               *
      *  Called by: SRMAIN - Main processing.                         *
      *                                                               *
      *  Calls: SRS001   - Set first lines of subfile for each Book   *
      *                    Position records when subfile is build     *
      *                    from begining.                             *
      *         SRS002   - Set detail lines of subfile for each       *
      *                    Customer Position records when subfile is  *
      *                    build.                                     *
      *         SRS003   - Set subfile last line for each build of    *
      *                    the subfile when all details in files are  *
      *                    reached.                                   *
      *         Y2CLMSC  - Midas ABS Clear specific program message   *
      *                    queue.                                     *
      *                                                               *
      *****************************************************************
      *
     C           SRBLDF    BEGSR                           ** SRBLDF SR **
      *
      ***  Clear messages from program message queue.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM SPGM      ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
      ***  Initialise input 'Rreview from' fields.
      *
     C                     MOVE *BLANKS   SCUST            Customer
     C                     MOVE *BLANKS   SPRFC                           CAC005
     C                     MOVE *BLANKS   SRFBK            Book
     C                     MOVE *BLANKS   SCSTAT           Reply Status
      *
      ***  Reset subfile next change indicator.
      *
     C                     MOVE '0'       *IN84
      *
      ***  Initialise error indicators.
      *
     C***********          MOVEA'000'     *IN,50                          CAC005
     C                     MOVEA'0000'    *IN,50                          CAC005
     C                     MOVEA'00000'   *IN,54
      *
      ***  Init screen line number.
      *
     C                     Z-ADD0         WWCPT   20
      *                                                                   CSE020
      ** Move the originating parent's security if parent reference       CSE020
      ** is not blanks.                                                   CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE PSESN     WSSESN 10                       CSE020
     C                     MOVE WOSESN    PSESN                           CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Set key fields for LF/SEUDEPL0 with branch, security, depot.
      *
     C                     MOVE PBRCD     WKBRCD           Branch
     C                     MOVE PSESN     WKSESN           Security
     C                     MOVE PDEPO     WKDEPO           Depot
      *
      ***  Set first lines of subfile = Book Positions.
      *
     C           WKEY2     SETLLSEUDEPL0
     C                     EXSR SRS001
      *
      ***  Set key fields for LF/SECDEPL4 with branch, security, depot.
      *
     C                     MOVE PBRCD     WKBRCD           Branch
     C                     MOVE PSESN     WKSESN           Security
     C                     MOVE PDEPO     WKDEPO           Depot
     C           WKEY2     SETLLSECDEPL4
      *
      ***  Set detail lines of subfile = Customer Positions.
      *
     C                     EXSR SRS002
      *
      ***  Set last lines of subfile = Dummy Customer.
      *
     C                     Z-ADD0         DUSRRN                          136935
     C                     EXSR SRS003
      *
      ***  Save position.
      *
     C                     Z-ADDSRRN      WWRRN            Save SFLRCDNBR.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRS001 - Set first lines of subfile for each Book Position   *
      *           records when subfile is build from begining.        *
      *                                                               *
      *  Called by: SRBLDF - Build the first subfile page.            *
      *             SRBLDN - Build the next subfile page.             *
      *                                                               *
      *  Calls: SRU001 - Write a record to the subfile for each       *
      *                  subfile record changes when subfile is       *
      *                  build.                                       *
      *         ZSEDIT - Standart subroutine to insert a decimal      *
      *                  point into a numeric field and to blank out  *
      *                  leading zeroes.                              *
      *                                                               *
      *****************************************************************
      *
     C           SRS001    BEGSR                           ** SRS001 SR **
      *
      ***  Read next record to retrieve first Book.
      *
     C                     READ SEUDEPL0                 30
      *
      ***  If not same Branch, Security Shortname and Depot, stop reading.
      *
     C           WKBRCD    IFNE UDBA                       not same Branch
     C           WKSESN    ORNE UDSN                       not same Security
     C           WKDEPO    ORNE UDPT                       not same Depot
     C                     MOVE '1'       *IN30
     C                     ENDIF
      *
      ***  Do while end of file not reached and line counter lower than 4.
      *
     C           *IN30     DOWEQ'0'
     C           WWCPT     ANDLT3
      *
      ***  Save Branch, Security, Depot, Market, Book and Ex-Date fields in work fields.
      *
     C                     MOVE PBRCD     WKBRCD           Branch
     C                     MOVE PSESN     WKSESN           Security
     C**********           Z-ADDPDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE PDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE UDMK      WKUDMK           Market
     C                     MOVE UDBK      WKUDBK           Book
     C                     Z-ADDPEXDAT    WKUDDT           Ex-Date
      *
      ***  Set greater on LF/SEUDEPL0 with Branch, Security, Depot, Market, Book and Ex-Date.
      *
     C           WKEY3     SETGTSEUDEPL0             30
     C                     READPSEUDEPL0                 30
      *
      ***  If same Branch, Security, Depot, Market and Book and not begining of file
      *
     C           *IN30     IFEQ '0'                        Not begining of file
     C           WKBRCD    ANDEQUDBA                       same Branch
     C           WKSESN    ANDEQUDSN                       same Security
     C           WKDEPO    ANDEQUDPT                       same Depot
     C           WKUDMK    ANDEQUDMK                       same Market
     C           WKUDBK    ANDEQUDBK                       same Book
      *
      ***  Use 'Nominal - Value Date Basis' or 'Nominal - Trade Date Basis'
      ***  from LF/SEUDEPL0 as 'Ex-Date Position', depending on Value/Trade Date Position.
      *
     C                     MOVE *BLANKS   SEXPOS
      *                                                                   CSE020
      ** Set up keys for Chain in SECOALL5                                CSE020
      *                                                                   CSE020
     C           WKEY18    KLIST                                          CSE020
     C                     KFLD           WKCORF                          CSE020
     C                     KFLD           WKBRCD                          CSE020
     C**********           KFLD           WKDDPT  60                                   CSE020 CSD027
     C                     KFLD           WKDDPT  6                                           CSD027
     C                     KFLD           WKCOTP                          CSE020
     C                     KFLD           WKBOOK                          CSE020
     C                     KFLD           WKCNUM                          CSE020
     C                     KFLD           WKPTFR                          CSE020
     C                     KFLD           WKSESN                          CSE020
      *                                                                   CSE020
     C                     MOVE MAPREF    WKCORF                          CSE020
     C                     MOVE UDBA      WKBRCD                          CSE020
     C**********           Z-ADDUDPT      WKDDPT                                       CSE020 CSD027
     C                     MOVE UDPT      WKDDPT                                              CSD027
     C                     MOVE 'B'       WKCOTP                          CSE020
     C                     MOVE UDBK      WKBOOK                          CSE020
     C**********           Z-ADD*ZEROS    WKCNUM                                       CSE020 CSD027
     C                     MOVE *BLANKS   WKCNUM                                              CSD027
     C                     MOVE *BLANKS   WKPTFR                          CSE020
     C                     MOVE WSSESN    WKSESN                          CSE020
      *                                                                   CSE020
      ** If Parent Refence is not blanks, Ex-date position of Child CA    CSE020
      ** depends on the parent CA. Otherwise, Ex-date position is equal   CSE020
      ** to Nominal Trade Date basis or Nominal Value Date basis.         CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C           WKEY18    CHAINSECOALD5             90                   CSE020
      *                                                                   CSE020
     C           *IN90     IFEQ '0'                                       CSE020
     C                     MOVE *BLANKS   ZFLD15                          CSE020
     C                     MOVE M5ASTA    ZFLD15                          CSE020
     C                     Z-ADDNMDP1     ZDECS                           CSE020
     C                     EXSR ZSEDIT                                    CSE020
     C                     MOVE ZOUT21    SEXPOS                          CSE020
     C                     Z-ADDM5ASTA    SHTDVD                          CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     ELSE                                           CSE020
     C           MATDVD    IFEQ 'V'
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE UDNV      ZFLD15
     C                     Z-ADDNMDP1     ZDECS            Event Security Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SEXPOS           Ex-Date Position = Value Date Basis
     C                     Z-ADDUDNV      SHTDVD           Ex-Date Position hidden screen field
     C                     ELSE
     C           MATDVD    IFEQ 'T'
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE UDNT      ZFLD15
     C                     Z-ADDNMDP1     ZDECS            Event Security Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SEXPOS           Ex-Date Position = Trade Date Basis
     C                     Z-ADDUDNT      SHTDVD           Ex-Date Position hidden screen field
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          CSE020
     C                     Z-ADDSHTDVD    WWTDVD 150
      *
      ***  Setup key and work fields.
      *
     C                     MOVE PCORF     WKCORF           CO Reference
     C                     Z-ADDPOPTN     WKOPTN           Option Number
     C                     MOVE PBRCD     WKBRCD           Branch
     C                     MOVE PDEPO     WKDEPO           Depot
     C                     MOVE PNWSEC    WKSESN           Security
     C                     MOVE 'B'       WKCOTP           Customer/Book Ind. = 'B'ook
     C                     MOVE UDBK      WKBOOK           Book
     C**********           Z-ADD0         WKCNUM           Customer                           CSD027
     C                     MOVE *BLANKS   WKCNUM           Customer                           CSD027
     C                     MOVE *BLANKS   WKPTFR           Portfoplio
     C                     MOVE 'B'       SHCOTP           Customer/Book Ind. hidden screen field
      *
      ***  Retrieve CO Allocation details.
      *
     C           WKEY4     CHAINSECOALL1             79
      *
     C******     *IN47     IFEQ '1'                        If Review Proc.137879
     C******     *IN79     ANDEQ'0'                           rcd found   137879
     C           *IN79     IFEQ '0'                        If rcd found   137879
     C           SCSTAT    ANDEQ' '                           Review Reply Status blank
     C******     *IN47     OREQ '1'                        Or Review Proc.137879
     C******     *IN79     ANDEQ'0'                           rcd found   137879
     C           *IN79     OREQ '0'                        Or rcd found   137879
     C           MCREST    ANDEQSCSTAT                        Reply Status = Review Reply Status
     C           SCSTAT    ANDNE' '                           Review Reply Status not blank
     C******     *IN47     OREQ '0'                        Or not Rw.Proc.137879
      *
      ***  Seton indicator to protect and non-display Portfolio.
      *
     C                     MOVEA'10'      *IN,62
      *
      ***  Add 1 to line counter.
      *
     C********             ADD  1         SRRN             SFLRCDNBR      137879
     C                     ADD  1         SRRN       81    SFLRCDNBR      137879
     C                     ADD  1         WWCPT            Screen line NBR
      *                                                                   CSE020
      ** Restore Security name if parent reference is non-blank           CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WSSESN    PSESN                           CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Write a subfile record.
      *
     C                     MOVE '1'       *IN40
     C                     EXSR SRU001
     C                     MOVE '0'       *IN40
      *
     C                     ENDIF
     C                     ENDIF
      *                                                                   CSE020
      ** Set PSESN again as Originating parent's security if parent       CSE020
      ** reference is non-blank.                                          CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WOSESN    PSESN                           CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Set Ex-Date to hival value.
      *
     C                     MOVE PSESN     WKSESN
     C                     Z-ADD*HIVAL    WKUDDT
      *
      ***  Set greater with Branch, Security, Depot, Market, Book and Ex-Date.
      *
     C           WKEY3     SETGTSEUDEPL0             30
      *
      ***  Read next record on LF/SEUDEPL0 to find next Book.
      *
     C                     READ SEUDEPL0                 30
      *
      ***  If not same Branch, Security Shortname and Depot, stop reading.
      *
     C           WKBRCD    IFNE UDBA                       not same Branch
     C           WKSESN    ORNE UDSN                       not same Security
     C           WKDEPO    ORNE UDPT                       not same Depot
     C                     MOVE '1'       *IN30
     C                     ENDIF
      *
     C                     ENDDO
      *                                                                   CSE020
      ** Restore Security name if parent reference is non-blank           CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WOSESN    PSESN                           CSE020
     C                     ENDIF                                          CSE020
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRS002 - Set detail lines of subfile for each Customer       *
      *           Position records when subfile is build.             *
      *                                                               *
      *  Called by: SRBLDF - Build the first subfile page.            *
      *             SRBLDN - Build the next subfile page.             *
      *                                                               *
      *  Calls: SRU001 - Write a record to the subfile for each       *
      *                  subfile record changes when subfile is       *
      *                  build.                                       *
      *         ZSEDIT - Standart subroutine to insert a decimal      *
      *                  point into a numeric field and to blank out  *
      *                  leading zeroes.                              *
      *                                                               *
      *****************************************************************
      *
     C           SRS002    BEGSR                           ** SRS002 SR **
      *
      ***  Read next record to retrieve first Customer.
      *
     C                     READ SECDEPL4                 30
      *
      ***  If not same Branch, Security Shortname and Depot, stop reading.
      *
     C           WKBRCD    IFNE CDPA                       not same Branch
     C           WKSESN    ORNE CDSN                       not same Security
     C           WKDEPO    ORNE CDPT                       not same Depot
     C                     MOVE '1'       *IN30
     C                     ENDIF
      *
      ***  Do while end of file not reached and line counter lower than 4.
      *
     C           *IN30     DOWEQ'0'
     C           WWCPT     ANDLT3
      *
      ***  Save Branch, Security, Depot, Market, Customer and Portfolio and Ex-Date fields in work
      ***  fields.
      *
     C                     MOVE PBRCD     WKBRCD           Branch
     C                     MOVE PSESN     WKSESN           Security
     C**********           Z-ADDPDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE PDEPO     WKDEPO           Depot                              CSD027
     C                     Z-ADDPEXDAT    WKDDTE           Ex-Date
     C                     MOVE CDMK      WKCDMK           Market
     C**********           Z-ADDCDCN      WKCDCN           Customer                           CSD027
     C                     MOVE CDCN      WKCDCN           Customer                           CSD027
     C                     MOVE PTFR      WKPTFR           Portfolio Reference
      *
      ***  Set greater on LF/SECDEPL4 with Branch, Security, Depot, Market, Customer, Portfolio and
      ***  Ex-Date.
      *
     C           WKEY5     SETGTSECDEPL4             30
     C                     READPSECDEPL4                 30
      *
      ***  If same Branch, Security, Depot, Market, Customer and Portfolio and Customer not
      ***  equal Dummy Customer and not begining of file.
      *
     C           *IN30     IFEQ '0'                        not begining of file
     C           WKBRCD    ANDEQCDPA                       same Branch
     C           WKSESN    ANDEQCDSN                       same Security
     C           WKDEPO    ANDEQCDPT                       same Depot
     C           WKCDMK    ANDEQCDMK                       same Market
     C           WKCDCN    ANDEQCDCN                       same Customer
     C           WKPTFR    ANDEQPTFR                       same Portfolio
     C           WDUMMY    ANDNECDCN                       Customer not Dummy Customer
      *
      ***  Use 'Nominal - Value Date Basis' or 'Nominal - Trade Date Basis'
      ***  from LF/SECDEPL4 as 'Ex-Date Position'.
      *
     C                     MOVE *BLANKS   SEXPOS
      *                                                                   CSE020
      ** Set up keys for Chain in SECOALL5                                CSE020
      *                                                                   CSE020
     C                     MOVE MAPREF    WKCORF                          CSE020
     C                     MOVE CDPA      WKBRCD                          CSE020
     C**********           Z-ADDCDPT      WKDDPT                                       CSE020 CSD027
     C                     MOVE CDPT      WKDDPT                                              CSD027
     C                     MOVE 'C'       WKCOTP                          CSE020
     C                     MOVE *BLANKS   WKBOOK                          CSE020
     C**********           Z-ADDCDCN      WKCNUM                                       CSE020 CSD027
     C                     MOVE CDCN      WKCNUM                                              CSD027
     C                     MOVE PTFR      WKPTFR                          CSE020
     C                     MOVE WSSESN    WKSESN                          CSE020
      *                                                                   CSE020
      ** If Parent Refence is not blanks, Ex-date position of Child CA    CSE020
      ** depends on the parent CA. Otherwise, Ex-date position is equal   CSE020
      ** to Nominal Trade Date basis or Nominal Value Date basis.         CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C           WKEY18    CHAINSECOALD5             90                   CSE020
      *                                                                   CSE020
     C           *IN90     IFEQ '0'                                       CSE020
     C                     MOVE *BLANKS   ZFLD15                          CSE020
     C                     MOVE M5ASTA    ZFLD15                          CSE020
     C                     Z-ADDNMDP1     ZDECS                           CSE020
     C                     EXSR ZSEDIT                                    CSE020
     C                     MOVE ZOUT21    SEXPOS                          CSE020
     C                     Z-ADDM5ASTA    SHTDVD                          CSE020
     C                     ENDIF                                          CSE020
     C                     ELSE                                           CSE020
      *                                                                   CSE020
     C           MATDVD    IFEQ 'V'
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE CDNV      ZFLD15
     C                     Z-ADDNMDP1     ZDECS            Event Security Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SEXPOS           Ex-Date Position = Value Date Basis
     C                     Z-ADDCDNV      SHTDVD           Ex-Date Position hidden screen field
     C                     ELSE
     C           MATDVD    IFEQ 'T'
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE CDNT      ZFLD15
     C                     Z-ADDNMDP1     ZDECS            Event Security Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SEXPOS           Ex-Date Position = Trade Date Basis
     C                     Z-ADDCDNT      SHTDVD           Ex-Date Position hidden screen field
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     Z-ADDSHTDVD    WWTDVD
      ******                                                              136930
      *****If*Status*not*Allocated*and*not*Fully*Authorised*(Cash*and**** 136930
      *****Stock).******************************************************* 136930
      ******                                                              136930
     C******     PSTAT     IFEQ 'L'                                       136930
     C******     PSTAT     OREQ 'X'                                       136930
      *
      ***  Setup key and work fields.
      *
     C                     MOVE PCORF     WKCORF           CO Reference
     C                     Z-ADDPOPTN     WKOPTN           Option Number
     C                     MOVE PBRCD     WKBRCD           Branch
     C**********           Z-ADDPDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE PDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE PNWSEC    WKSESN           Security
     C                     MOVE 'C'       WKCOTP           Customer/Book Ind. = 'C'ustomer
     C                     MOVE '  '      WKBOOK           Book
     C**********           Z-ADDCDCN      WKCNUM           Customer                           CSD027
     C                     MOVE CDCN      WKCNUM           Customer                           CSD027
     C                     MOVE PTFR      WKPTFR           Portfolio
     C                     MOVE 'C'       SHCOTP           Customer/Book Ind. hidden screen field
      *
      ***  Retrieve CO Allocation details.
      *
     C           WKEY4     CHAINSECOALL1             79
     C******               ELSE                                           136930
     C******               MOVE '1'       *IN79                           136930
     C******               ENDIF                                          136930
      *
     C******     *IN47     IFEQ '1'                        If Review Proc.137879
     C******     *IN79     ANDEQ'0'                           rcd found   137879
     C           *IN79     IFEQ '0'                        If rcd found   137879
     C           SCSTAT    ANDEQ' '                           Review Reply Status blank
     C******     *IN47     OREQ '1'                        Or Review Proc.137879
     C******     *IN79     ANDEQ'0'                           rcd found   137879
     C           *IN79     OREQ '0'                        Or rcd found   137879
     C           MCREST    ANDEQSCSTAT                        Reply Status = Review Reply status
     C           SCSTAT    ANDNE' '                           Review Reply Status not blank
     C******     *IN47     OREQ '0'                        Or not Rw Proc.137879
      *
      ***  Seton indicator to non-protect and display 'Portfolio'.
      *
     C                     MOVEA'00'      *IN,62
      *
      ***  Add 1 to line counter.
      *
     C********             ADD  1         SRRN             SFLRCDNBR      137879
     C                     ADD  1         SRRN       81    SFLRCDNBR      137879
     C                     ADD  1         WWCPT            Screen line NBR
      *                                                                   CSE020
      ** Restore Security name if parent reference is non-blank           CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WSSESN    PSESN                           CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Write a subfile record.
      *
     C                     MOVE '1'       *IN41
     C                     EXSR SRU001
     C                     MOVE '0'       *IN41
      *
     C                     ENDIF
     C                     ENDIF
      *                                                                   CSE020
      ** Set PSESN again as Originating parent's security if parent       CSE020
      ** reference is non-blank.                                          CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WOSESN    PSESN                           CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Set Ex-Date to hival value.
      *
     C                     MOVE PSESN     WKSESN
     C                     Z-ADD*HIVAL    WKDDTE
      *
      ***  Set greater with Branch, Security, Depot, Market, Customer, Portfolio and Ex-Date.
      *
     C           WKEY5     SETGTSECDEPL4             30
      *
      ***  Read next record on LF/SECDEPL4 to find next Customer.
      *
     C                     READ SECDEPL4                 30
      *
      ***  If not same Branch, Security Shortname and Depot, stop reading.
      *
     C           WKBRCD    IFNE CDPA                       not same Branch
     C           WKSESN    ORNE CDSN                       not same Security
     C           WKDEPO    ORNE CDPT                       not same Depot
     C                     MOVE '1'       *IN30
     C                     ENDIF
      *
     C                     ENDDO
      *                                                                   CSE020
      ** Restore Security name if parent reference is non-blank           CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WOSESN    PSESN                           CSE020
     C                     ENDIF                                          CSE020
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRS003 - Set subfile last line for each build of the subfile *
      *           when all details in files are reached.              *
      *                                                               *
      *  Called by: SRBLDF - Build the first subfile page.            *
      *             SRBLDN - Build the next subfile page.             *
      *                                                               *
      *  Calls: SRU001   - Write a record to the subfile for each     *
      *                    subfile record changes when subfile is     *
      *                    build.                                     *
      *         AOPLCSR0 - Midas AO Portfolio Mngemnt Cust Det. *RDR. *
      *                                                               *
      *****************************************************************
      *
     C           SRS003    BEGSR                           ** SRS003 SR **
      *
      ***  If line counter is lower than number of line per subfile page.
      *
     C           WWCPT     IFLT 3
      *
     C                     MOVE *BLANKS   WKPTFR           Reset Porfolio work field
      *
      ***  If Portfolio Management is present, use default '99997' Portfolio.
      *
     C           BGPFMG    IFEQ 'Y'
     C           BGN4ST    OREQ 'Y'                                       CPB001
      *
     C                     MOVE WDUMMY    KPNUM   6        Setup key with Dummy Customer
      *
      ***  Access Portfolio Customers file to check if the Dummy Customer is a Portfolio Customer.
      *
     C                     MOVE 'N'       WWEXC   1                       CPB001
     C           BGPFMG    IFEQ 'Y'                                       CPB001
     C                     CALL 'AOPLCSR0'
     C                     PARM *BLANKS   WLRTCD  7
     C                     PARM '*KEY  '  WLOPTN  7
     C                     PARM KPNUM     WLCUST 10
     C           SDPLCS    PARM SDPLCS    DSSDY
      *
      ***  If record is found, it means that Customer is a Portfolio Customer.
      *
     C           WLRTCD    IFEQ *BLANK
     C           BGN4ST    IFNE 'Y'                                       CPB001
     C                     MOVE '9997'    WKPTFR
     C                     ENDIF                                          CPB001
     C                     MOVE 'Y'       WWEXC                           CPB001
     C                     ENDIF
     C                     ENDIF
      *                                                                   CPB001
     C           BGN4ST    IFEQ 'Y'                                       CPB001
     C**********           CALL 'AOCUSTR0'                                             CPB001 223539
     C                     CALL 'AOCUSTR1'                                                    223539
     C                     PARM *BLANKS   WRTCD   7                       CPB001
     C                     PARM '*KEY   ' WOPTN   7                       CPB001
     C                     PARM KPNUM     WKEYC  10                       CPB001
     C                     PARM *BLANKS   WKYST   7                       CPB001
     C********** SDCUST    PARM SDCUST    DSSDY                                        CPB001 223539
     C           SDCUST    PARM SDCUST    DSLDY                                               223539
      *                                                                   CPB001
     C           WRTCD     IFEQ *BLANKS                                   CPB001
     C           BBCLST    ANDNE'Y'                                                           223539
     C                     MOVE 'Y'       WWEXC                           CPB001
     C                     ENDIF                                          CPB001
     C                     ENDIF                                          CPB001
      *                                                                   CPB001
     C           WWEXC     IFEQ 'Y'                                       CPB001
     C           BGN4ST    ANDEQ'Y'                                       CPB001
     C                     OPEN PMPORTLL                                  CPB001
     C           WDUMMY    SETLLPMPORTLL                                  CPB001
     C                     READ PMPORTLL                 71               CPB001
      *                                                                   CPB001
     C           *IN71     IFEQ '0'                                       CPB001
     C           PNCNUM    ANDEQWDUMMY                                    CPB001
     C                     MOVE PNPTFR    WKPTFR                          CPB001
     C                     ENDIF                                          CPB001
     C                     CLOSEPMPORTLL                                  CPB001
     C                     ENDIF                                          CPB001
     C                     ENDIF                                          CPB001
      *
     C********** WDUMMY    IFNE 0                                                             CSD027
     C           WDUMMY    IFNE *BLANKS                                                       CSD027
      *
      ***  If Dummy Customer not 0, Load screen field and write record on subfile.
      *
     C                     MOVE PCORF     WKCORF           CO Reference
     C                     MOVE POPTN     WKOPTN           Option Number
     C                     MOVE PBRCD     WKBRCD           Branch
     C**********           Z-ADDPDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE PDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE PNWSEC    WKSESN           New Security
     C                     MOVE 'C'       WKCOTP           Customer/Book Ind. = 'C'ustomer
     C                     MOVE '  '      WKBOOK           Book
     C**********           Z-ADDWDUMMY    WKCNUM           Customer = Dummy Customer          CSD027
     C                     MOVE WDUMMY    WKCNUM           Customer = Dummy Customer          CSD027
     C                     MOVE 'C'       SHCOTP           Customer/Book Ind. hidden screen field
      *
      ***  Retrieve CO Allocation Details for Dummy Customer.
      *
      ***  If two dummys were required for calculations, the second one   184520
      ***  contains the required data to display.                         184520
     C***********WKEY4     CHAINSECOALL1             79                   184520
     C           WKEY4     SETGTSECOALL1             79                   184520
     C           WKEY4     REDPESECOALL1                 79               184520
      *                                                                   137879
      ***  If Review from Status blank OR if Review from Status entered   137879
      ***  and record found and Reply Status = Review from Status entered.137879
      *                                                                   137879
     C           SCSTAT    IFEQ ' '                                       137879
     C           *IN79     ANDEQ'0'                                       CSE020
     C           SCSTAT    ORNE ' '                                       137879
     C           *IN79     ANDEQ'0'                                       137879
     C           MCREST    ANDEQSCSTAT                                    137879
      *
      ***  Protect and non-display Ex-Date Position.
      *
     C                     MOVEA'01'      *IN,62
      *
      ***  Add 1 to line counter.
      *
     C********             ADD  1         SRRN             SFLRCDNBR      137879
     C                     ADD  1         SRRN       81    SFLRCDNBR      137879
     C                     ADD  1         WWCPT            Screen line number
     C                     Z-ADDSRRN      DUSRRN  40                      136935
      *
      ***  Write a subfile record.
      *
     C                     EXSR SRU001
     C                     ENDIF                                          137879
     C                     ENDIF
      *
      ***  If Dummy Customer = 0, reset IN30 to see the '+' sign at the bottom of the screen.
      *
     C                     ELSE
     C                     MOVE '0'       *IN30
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRBLDN - Build the next subfile page.                        *
      *                                                               *
      *  Called by: SRMAIN - Main processing.                         *
      *                                                               *
      *  Calls: SRS001 - Set first lines of subfile for each Book     *
      *                  Position records when subfile is build from  *
      *                  begining.                                    *
      *         SRS002 - Set detail lines of subfile for each         *
      *                  Customer Position records when subfile is    *
      *                  build.                                       *
      *         SRS003 - Set subfile last line for each build of the  *
      *                  subfile when all details in files are        *
      *                  reached.                                     *
      *                                                               *
      *****************************************************************
      *
     C           SRBLDN    BEGSR                           ** SRBLDN SR **
      *
      ***  Reset subfile next change indicator.
      *
     C                     MOVE '0'       *IN84            No SFLNXTCHG
      *
      ***  Init screen line number.
      *
     C                     Z-ADD0         WWCPT   20
      *                                                                   CSE020
      ** Move the originating parent's security if parent reference       CSE020
      ** is not blanks.                                                   CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE PSESN     WKSESN 10                       CSE020
     C                     MOVE WOSESN    PSESN                           CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Set key fields for LF/SECDEPL4: branch, security and Depot.
      *
     C                     MOVE PBRCD     WKBRCD           Branch
     C                     MOVE PSESN     WKSESN           Security
     C                     MOVE PDEPO     WKDEPO           Depot
      *
      ***  If processing running from 'Review from', setup key fields with Review From fields
      ***  and position of file, depending on Review From field selected.
      *
     C           *IN47     IFEQ '1'
     C           SRFBK     IFEQ *BLANKS                                   137879
     C           SCUST     ANDEQ*BLANKS                                   137879
     C           WKEY2     SETLLSEUDEPL0                                  137879
     C           WKEY2     SETLLSECDEPL4                                  137879
     C                     ELSE                                           137879
     C           SRFBK     IFNE *BLANKS
     C                     MOVE SRFBK     WKUDBK           Review From Book
      *                                                                   CAC005
      ** If CAC005 is installed, retrieve the corresponding pseudo book   CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM *BLANKS   PRTCD1                          CAC005
     C                     PARM '*PSEUDO' POPTN1                          CAC005
     C                     PARM SRFBK     PBKCD                           CAC005
     C                     PARM SPRFC     PPRFC                           CAC005
     C                     PARM           PPSBK                           CAC005
      *                                                                   CAC005
     C           PRTCD1    IFEQ *BLANKS                                   CAC005
     C                     MOVE PPSBK     WKUDBK                          CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C           WKEY13    SETLLSEUDEPL0
     C           WKEY2     SETLLSECDEPL4
     C                     ELSE
     C                     MOVE *BLANKS   WKPTFR           Portfolio
     C                     MOVE SCUST     WKCDCN           Review From Customer
     C           WKEY16    SETLLSECDEPL4
     C                     ENDIF
     C                     ENDIF                                          137879
      *
     C                     ELSE
      *
      ***  If processing running from 'Rollup', retrieve last Customer and Portfolio processed on
      ***  subfile record, and set greater on LF/SECDEPL4.
      *
     C           *IN27     IFEQ '1'
     C                     MOVE '0'       *IN27
     C                     MOVE WWRRN     SRRN
     C           *IN60     IFEQ '1'
     C           SRRN      CHAINSE7513S0             88
     C                     ELSE
     C           SRRN      CHAINSE7513S1             88
     C                     ENDIF
     C                     MOVE SHCNUM    WKCDCN           Last Customer processed = hidden field
     C                     MOVE SHPORT    WKPTFR           Last Portfolio processed = hidden field
     C           WKEY5     SETGTSECDEPL4
     C                     ELSE
      *
      ***  Else, if not Rollup and not Review From processing, set greater on LF/SECDEPL4 with
      ***  Branch, Security and Depot.
      *
     C           WKEY2     SETGTSECDEPL4
     C                     ENDIF
     C                     ENDIF
      *
      ***  Set detail lines of subfile.
      *
     C                     EXSR SRS001
     C                     EXSR SRS002
      *
      ***  Set last line of subfile.
      *
     C                     Z-ADD0         DUSRRN                          136935
     C                     EXSR SRS003
      *
      ***  Save position.
      *
     C                     Z-ADDSRRN      WWRRN            Save SFLRCDNBR.
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRVALD - Validate subfile records.                           *
      *                                                               *
      *  Called by: SRMAIN - Main processing.                         *
      *                                                               *
      *  Calls: SRPRAC - Process Action Code.                         *
      *         SRVLD2 - Validate amended fields.                     *
      *         ZASNMS - Send Message to Program Message Queue.       *
      *                                                               *
      *****************************************************************
      *
     C           SRVALD    BEGSR                           ** SRVALD SR **
      *
      ***  Reset fields and indicators.
      *
     C                     MOVE ' '       SACODE           Action Code
     C                     MOVE 'N'       ERMSG            Error found
     C***********          MOVEA'000'     *IN,50                          CAC005
     C                     MOVEA'0000'    *IN,50                          CAC005
     C                     MOVEA'00000'   *IN,54
     C                     Z-ADD0         SVRRN   40       Record Number saved field
     C                     MOVE 'N'       DUMMYM  1                       136935
      *
      ***  Read first changed subfile record.
      *
     C           *IN60     IFEQ '1'
     C                     READCSE7513S0                 33Normal subfile
     C                     ELSE
     C                     READCSE7513S1                 33'CASH' subfile
     C                     ENDIF
      *
      ***  Do while record changed on subfile.
      *
     C           *IN33     DOWEQ'0'
      *
      ***  Save record number and indicator.
      *
     C                     Z-ADDSRRN      SVRRN
     C                     MOVE SHIND2    *IN62
     C                     MOVE SHIND3    *IN63
     C                     MOVE SHIND4    *IN64
     C                     MOVE SHIND6    *IN66
     C                     MOVE SHIND7    *IN67
      *
      ***  If Action field is not equal to blank.
      *
     C           SACODE    IFNE *BLANK
     C           PMODE     IFNE 'E'
     C           *IN60     IFEQ '1'                                       135689
     C           SACODE    IFNE 'Y'
     C           SACODE    ANDNE'J'
     C           SACODE    ANDNE'L'
     C           SACODE    ANDNE'V'
     C                     MOVEL'CO00267' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN52
     C                     MOVE 'Y'       ERMSG
     C                     ENDIF                                          135689
     C                     ELSE                                           135689
     C           SACODE    IFNE 'Y'                                       135689
     C           SACODE    ANDNE'J'                                       135689
     C           SACODE    ANDNE'V'                                       135689
     C                     MOVEL'CO00585' ZAMSID                          135689
     C                     EXSR ZASNMS                                    135689
     C                     MOVE '1'       *IN52                           135689
     C                     MOVE 'Y'       ERMSG                           135689
     C                     ENDIF                                          135689
     C                     ENDIF                                          135689
     C******               ELSE                                           135689
     C           ERMSG     IFNE 'Y'                                       135689
     C           PPROC     IFEQ 'CC'                                      CEU017
     C           SACODE    IFEQ 'Y'                                       CEU017
     C           SACODE    OREQ 'J'                                       CEU017
     C           SACODE    IFEQ 'Y'                                       CEU017
     C                     MOVEL'CO00360' ZAMSID                          CEU017
     C                     ELSE                                           CEU017
     C                     MOVEL'CO00361' ZAMSID                          CEU017
     C                     ENDIF                                          CEU017
     C                     EXSR ZASNMS                                    CEU017
     C                     MOVE '1'       *IN52                           CEU017
     C                     MOVE 'Y'       ERMSG                           CEU017
     C                     ENDIF                                          CEU017
     C                     ENDIF                                          CEU017
     C           SACODE    IFEQ 'L'
     C           SHCNUM    IFEQ WDUMMY
     C                     MOVEL'CO00326' ZAMSID           Allocation not allowed for
     C                     EXSR ZASNMS                     Dummy Customer.
     C                     MOVE '1'       *IN52
     C                     MOVE 'Y'       ERMSG
     C                     ENDIF
     C           SSTAT     IFEQ 'S'
     C           SSTAT     OREQ 'X'
     C                     MOVEL'CO00308' ZAMSID           Allocation not allowed for Status
     C                     EXSR ZASNMS                     'Stock Authorised' or 'Fully
     C                     MOVE '1'       *IN52            Authorised'.
     C                     MOVE 'Y'       ERMSG
     C                     ENDIF
     C           PFINA     IFEQ 'S'
     C           PFINA     OREQ 'Y'
     C                     MOVEL'CO00196' ZAMSID           Allocation not allowed for Final
     C                     EXSR ZASNMS                     Allocation Indicator 'Final Stock
     C                     MOVE '1'       *IN52            Allocation' or 'Final Cash Allocation'.
     C                     MOVE 'Y'       ERMSG
     C                     ENDIF
      *                                                                   CSE020
      ** Check if child is allowed to be allocated                        CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C           MAPREF    CHAINSECORFD2             90                   CSE020
      *                                                                   CSE020
      ** Parent is not yet authorised                                     CSE020
      *                                                                   CSE020
     C           IPSTAT    IFNE 'X'                                       CSE020
     C                     MOVEL'CO00366' ZAMSID                          CSE020
     C                     EXSR ZASNMS                                    CSE020
     C                     MOVE '1'       *IN52                           CSE020
     C                     MOVE 'Y'       ERMSG                           CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
      ** Ex-date of the child is not the same as the Parent Action        CSE020
      *                                                                   CSE020
     C           MACOEX    IFNE IPCOEX                                    CSE020
     C                     MOVEL'CO00370' ZAMSID                          CSE020
     C                     EXSR ZASNMS                                    CSE020
     C                     MOVE *ON       *IN52                           CSE020
     C                     MOVE 'Y'       ERMSG                           CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
      ** Initialise array for New Securities                              CSE020
      *                                                                   CSE020
     C                     Z-ADD1         Y       30                      CSE020
      *                                                                   CSE020
     C           Y         DOWLE180                                       CSE020
     C                     MOVE *BLANKS   NSEC,Y                          CSE020
     C                     ADD  1         Y                               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
      ** Security of the child action is not equal to one of the New      CSE020
      ** Security of the parent action                                    CSE020
      *                                                                   CSE020
     C                     Z-ADD1         Y                               CSE020
      *                                                                   CSE020
     C                     SELEC                                          CSE020
     C           IPPTYP    WHEQ 'DV'                                      CSE020
     C           IPCORF    SETLLSECODVL1                                  CSE020
     C           IPCORF    READESECODVL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MDNSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVEAIPSESN    NSEC,Y                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVEAMDNSEC    NSEC,Y                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         Y                               CSE020
     C           IPCORF    READESECODVL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           IPPTYP    WHEQ 'FR'                                      CSE020
     C           IPCORF    SETLLSECOFRL1                                  CSE020
     C           IPCORF    READESECOFRL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MENSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVEAIPSESN    NSEC,Y                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVEAMENSEC    NSEC,Y                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         Y                               CSE020
     C           IPCORF    READESECOFRL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           IPPTYP    WHEQ 'CR'                                      CSE020
     C           IPCORF    SETLLSECOCRL1                                  CSE020
     C           IPCORF    READESECOCRL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MHSECA    IFEQ *BLANKS                                   CSE020
     C                     MOVEAIPSESN    NSEC,Y                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVEAMHSECA    NSEC,Y                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  20        Y                               CSE020
     C           IPCORF    READESECOCRL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           IPPTYP    WHEQ 'OF'                                      CSE020
     C           IPCORF    SETLLSECOOFL1                                  CSE020
     C           IPCORF    READESECOOFL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MINSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVE IPSESN    NSEC,Y                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE MINSEC    NSEC,Y                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         Y                               CSE020
     C           IPCORF    READESECOOFL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           IPPTYP    WHEQ 'RG'                                      CSE020
     C           IPCORF    SETLLSECORGL1                                  CSE020
     C           IPCORF    READESECORGL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MFNSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVE IPSESN    NSEC,Y                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE MFNSEC    NSEC,Y                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         Y                               CSE020
     C           IPCORF    READESECORGL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           IPPTYP    WHEQ 'EX'                                      CSE020
     C           IPCORF    SETLLSECOEXL1                                  CSE020
     C           IPCORF    READESECOEXL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MJNSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVE IPSESN    NSEC,Y                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE MJNSEC    NSEC,Y                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         Y                               CSE020
     C           IPCORF    READESECOEXL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           IPPTYP    WHEQ 'NC'                                      CSE020
     C           IPCORF    SETLLSECONCL1                                  CSE020
     C           IPCORF    READESECONCL1                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           MLSESN    IFEQ *BLANKS                                   CSE020
     C                     MOVE IPSESN    NSEC,Y                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE MLSESN    NSEC,Y                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         Y                               CSE020
     C           IPCORF    READESECONCL1                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C           IPPTYP    WHEQ 'CC'                                      CSE020
     C           IPCORF    SETLLSECOCCL2                                  CSE020
     C           IPCORF    READESECOCCL2                 88               CSE020
     C           *IN88     DOWEQ'0'                                       CSE020
     C           NANSEC    IFEQ *BLANKS                                   CSE020
     C                     MOVE IPSESN    NSEC,Y                          CSE020
     C                     ELSE                                           CSE020
     C                     MOVE NANSEC    NSEC,Y                          CSE020
     C                     ENDIF                                          CSE020
     C                     ADD  1         Y                               CSE020
     C           IPCORF    READESECOCCL2                 88               CSE020
     C                     ENDDO                                          CSE020
      *                                                                   CSE020
     C                     ENDSL                                          CSE020
      *                                                                   CSE020
      ** Validate security of the child such that it is equal to          CSE020
      ** new security of the parent                                       CSE020
      *                                                                   CSE020
     C           MASESN    LOKUPNSEC                     88               CSE020
     C           *IN88     IFEQ '0'                                       CSE020
     C                     MOVEL'CO00371' ZAMSID                          CSE020
     C                     EXSR ZASNMS                                    CSE020
     C                     MOVE '1'       *IN52                           CSE020
     C                     MOVE 'Y'       ERMSG                           CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C           PMODE     IFEQ 'E'
     C******     SACODE    IFEQ 'L'                                       136930
     C******     SACODE    OREQ 'Y'                                       136930
     C           SACODE    IFNE 'J'                                       136930
     C           SACODE    ANDNE'V'                                       136930
     C                     MOVEL'CO00299' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN52
     C                     MOVE 'Y'       ERMSG
     C                     ELSE                                           CEU017
     C           PPROC     IFEQ 'CC'                                      CEU017
     C           SACODE    IFEQ 'J'                                       CEU017
     C                     MOVEL'CO00361' ZAMSID                          CEU017
     C                     EXSR ZASNMS                                    CEU017
     C                     MOVE '1'       *IN52                           CEU017
     C                     MOVE 'Y'       ERMSG                           CEU017
     C                     ENDIF                                          CEU017
     C                     ENDIF                                          CEU017
     C                     ENDIF
     C                     ENDIF
      *
     C           ERMSG     IFEQ 'N'
     C                     EXSR SRPRAC
     C                     MOVE ' '       SACODE
     C                     MOVE '0'       *IN59
     C                     ENDIF
      *
     C                     ELSE
     C                     EXSR SRVLD2
     C                     ENDIF
      *
     C           ERMSG     IFEQ 'N'
     C                     MOVE '0'       *IN84
     C                     ELSE
     C                     MOVE '1'       *IN84
     C                     ENDIF
      *
     C           *IN60     IFEQ '1'
     C                     UPDATSE7513S0
     C                     ELSE
     C                     UPDATSE7513S1
     C                     ENDIF
      *
     C                     Z-ADDWWRRN     SRRN
      *
     C***********          MOVEA'000'     *IN,50                          CAC005
     C                     MOVEA'0000'    *IN,50                          CAC005
     C                     MOVEA'00000'   *IN,54
      *
      ***  Read next change of subfile record.
      *
     C           *IN60     IFEQ '1'
     C                     READCSE7513S0                 33
     C                     ELSE
     C                     READCSE7513S1                 33
     C                     ENDIF
      *
     C                     ENDDO
      *                                                                   136935
      ***  If Dummy Customer amended and already displayed, update record 136935
      ***  on subfile for Dummy Customer.                                 136935
      *                                                                   136935
     C           DUSRRN    IFNE 0                                         136935
     C           DUMMYM    ANDEQ'Y'                                       136935
      *                                                                   136935
      ***  Setup key and work fields.                                     136935
      *                                                                   136935
     C                     MOVE PCORF     WKCORF           CO Reference   136935
     C                     Z-ADDPOPTN     WKOPTN           Option Number  136935
     C                     MOVE PBRCD     WKBRCD           Branch         136935
     C**********           Z-ADDPDEPO     WKDEPO           Depot                       136935 CSD027
     C                     MOVE PDEPO     WKDEPO           Depot                              CSD027
     C                     MOVE 'C'       WKCOTP           Cust/Book Ind. 136935
     C                     MOVE *BLANKS   WKBOOK           Book           136935
     C**********           Z-ADDWDUMMY    WKCNUM           Customer                    136935 CSD027
     C                     MOVE WDUMMY    WKCNUM           Customer                           CSD027
     C                     MOVE *BLANKS   WKPTFR           Portfolio      136935
     C           *IN60     IFEQ '1'                                       136935
     C                     MOVE PNWSEC    WKSESN           Security       136935
     C                     ELSE                                           136935
     C                     MOVEL'**CASH**'WKSESN    P      Sec. = CASH    136935
     C                     ENDIF                                          136935
      *                                                                   136935
      ***  Retrieve CO Allocation details for Dummy Customer              136935
      *                                                                   136935
     C           WKEY4     CHAINSECOALL1             79                   136935
      *                                                                   136935
     C           *IN60     IFEQ '1'                                       136935
     C           DUSRRN    CHAINSE7513S0             33    Normal subfile 136935
     C                     ELSE                                           136935
     C           DUSRRN    CHAINSE7513S1             33    'CASH' subfile 136935
     C                     ENDIF                                          136935
      *                                                                   136935
     C                     MOVE SHIND2    *IN62                           136935
     C                     MOVE SHIND3    *IN63                           136935
     C                     MOVE SHIND4    *IN64                           136935
     C                     MOVE SHIND6    *IN66                           136935
     C                     MOVE SHIND7    *IN67                           136935
      *                                                                   136935
     C                     SELEC                           Reply Status   136935
     C           MCREST    WHEQ 'R'                                       136935
     C                     MOVE STATUS,1  SREST                           136935
     C           MCREST    WHEQ 'S'                                       136935
     C                     MOVE STATUS,2  SREST                           136935
     C           MCREST    WHEQ 'C'                                       136935
     C                     MOVE STATUS,3  SREST                           136935
     C           MCREST    WHEQ 'M'                                       136935
     C                     MOVE STATUS,4  SREST                           136935
     C           MCREST    WHEQ 'N'                                       136935
     C                     MOVE STATUS,5  SREST                           136935
     C           MCREST    WHEQ ' '                                       136935
     C                     MOVE STATUS,5  SREST                           136935
     C                     ENDSL                                          136935
      *                                                                   136935
     C           *IN60     IFEQ '1'                        Normal screen  136935
      *                                                                   136935
     C                     MOVE *BLANKS   SASAL            Act.Stk Alloc. 136935
     C           MCASTA    IFNE 0                                         136935
     C                     MOVE *BLANKS   ZFLD15                          136935
     C                     MOVE MCASTA    ZFLD15                          136935
     C                     Z-ADDNMDP2     ZDECS            New Sec.Dec.Pl.136935
     C                     EXSR ZSEDIT                                    136935
     C                     MOVE ZOUT21    SASAL                           136935
     C                     ENDIF                                          136935
     C                     MOVE SASAL     SHASAL                          136935
     C                     Z-ADDMCASTA    SHASTA                          136935
      *                                                                   136935
     C                     MOVE *BLANKS   SASRO            Act.Stk Round. 136935
     C           MCASTR    IFNE 0                                         136935
     C                     MOVE *BLANKS   ZFLD15                          136935
     C                     MOVE MCASTR    ZFLD15                          136935
     C                     Z-ADD8         ZDECS            8 Dec. Places  136935
     C                     EXSR ZSEDIT                                    136935
     C                     MOVE ZOUT21    SASRO                           136935
     C                     ENDIF                                          136935
     C                     Z-ADDMCASTR    SHASTR                          136935
      *                                                                   136935
     C                     MOVE *BLANKS   SACRO            Act.Cash Round.136935
     C           MCACAR    IFNE 0                                         136935
     C                     MOVE *BLANKS   ZFLD15                          136935
     C                     MOVE MCACAR    ZFLD15                          136935
     C                     Z-ADDNMDPC2    ZDECS            New Ccy Dec.Pl.136935
     C                     EXSR ZSEDIT                                    136935
     C                     MOVE ZOUT21    SACRO                           136935
     C                     ENDIF                                          136935
     C                     MOVE SACRO     SHACRO                          136935
     C                     Z-ADDMCACAR    SHACAR                          136935
      *                                                                   136935
     C                     ELSE                            CASH screen    136935
      *                                                                   136935
     C                     MOVE *BLANKS   SACAL            Act.Cash Alloc.136935
     C           MCACAA    IFNE 0                                         136935
     C                     MOVE *BLANKS   ZFLD15                          136935
     C                     MOVE MCACAA    ZFLD15                          136935
     C           PPROC     IFEQ 'CR'                                      136935
     C                     Z-ADDNMDPC1    ZDECS            Ev.Ccy Dec.Pl. 136935
     C                     ELSE                                           136935
     C                     Z-ADDNMDPC2    ZDECS            New Ccy Dec.Pl.136935
     C                     ENDIF                                          136935
     C                     EXSR ZSEDIT                                    136935
     C                     MOVE ZOUT21    SACAL                           136935
     C                     ENDIF                                          136935
     C                     MOVE SACAL     SHACAL                          136935
     C                     Z-ADDMCACAA    SHACAA                          136935
     C                     Z-ADDMCACAA    HSACAA                          136935
      *                                                                   136935
     C                     MOVE *BLANKS   SACRO            Act.Cash Round.136935
     C           MCACAR    IFNE 0                                         136935
     C                     MOVE *BLANKS   ZFLD15                          136935
     C                     MOVE MCACAR    ZFLD15                          136935
     C           PPROC     IFEQ 'CR'                                      136935
     C                     Z-ADDNMDPC1    ZDECS            Ev.Ccy Dec.Pl. 136935
     C                     ELSE                                           136935
     C                     Z-ADDNMDPC2    ZDECS            New Ccy Dec.Pl.136935
     C                     ENDIF                                          136935
     C                     EXSR ZSEDIT                                    136935
     C                     MOVE ZOUT21    SACRO                           136935
     C                     ENDIF                                          136935
     C                     MOVE SACRO     SHACRO                          136935
     C                     Z-ADDMCACAR    SHACAR                          136935
     C                     Z-ADDMCACAR    HSACAR                          136935
      *                                                                   136935
      ***  Total Settlement = Actual Cash Allocation & Rounding +/- Total 136935
      ***  Fees +/- Total Taxes (+ if Ex-Date Position is > or = 0,       136935
      ***  else -).                                                       136935
      *                                                                   136935
     C           MCACAA    ADD  MCACAR    WWTSET 150                      136935
     C           MCEXPO    IFGE 0                                         136935
     C***********          ADD  MCTOTF    WWTSET                    136935161641
     C***********          ADD  MCTOTT    WWTSET                    136935161641
     C                     SUB  MCTOTF    WWTSET                          161641
     C                     SUB  MCTOTT    WWTSET                          161641
     C                     ELSE                                           136935
     C                     SUB  MCTOTF    WWTSET                          136935
     C***********          SUB  MCTOTT    WWTSET                    136935161641
     C                     ADD  MCTOTT    WWTSET                          161641
     C                     ENDIF                                          136935
     C                     MOVE *BLANKS   STSET                           136935
     C           WWTSET    IFNE 0                                         136935
     C                     MOVE *BLANKS   ZFLD15                          136935
     C                     MOVE WWTSET    ZFLD15                          136935
     C           PPROC     IFEQ 'CR'                                      136935
     C                     Z-ADDNMDPC1    ZDECS            Ev.Ccy Dec.Pl. 136935
     C                     ELSE                                           136935
     C                     Z-ADDNMDPC2    ZDECS            New Ccy Dec.Pl.136935
     C                     ENDIF                                          136935
     C                     EXSR ZSEDIT                                    136935
     C                     MOVE ZOUT21    STSET                           136935
     C                     ENDIF                                          136935
      *                                                                   136935
     C                     ENDIF                                          136935
      *                                                                   136935
     C           *IN60     IFEQ '1'                                       136935
     C                     UPDATSE7513S0                   Normal screen  136935
     C                     ELSE                                           136935
     C                     UPDATSE7513S1                   CASH screen    136935
     C                     ENDIF                                          136935
      *                                                                   136935
     C                     ENDIF                                          136935
      *                                                                   136935
     C           SVRRN     IFEQ 0
     C                     Z-ADDCPFPOS    SRRN
     C                     ELSE
     C                     Z-ADDSVRRN     SRRN
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRVLD2 - Validate amended fields.                            *
      *                                                               *
      *  Called by: SRVALD - Validate subfile records.                *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SRVLD2    BEGSR                           ** SRVLD2 SR **
      *
     C                     MOVE 'N'       AMHOCA  1
     C                     MOVE 'N'       AMHOST  1
     C                     MOVE 'N'       AMASAL  1
     C                     MOVE 'N'       AMACRO  1
     C                     MOVE 'N'       AMASTR  1
     C                     MOVE 'N'       AMACAR  1
     C                     MOVE 'N'       AMACAA  1
      *
      ***  For normal screen.
      *
     C           *IN60     IFEQ '1'
      *
      ***  Actual Stock Allocation and Actual Cash Rounding can not
      ***  be changed in same time.
      *
     C           SASAL     IFNE SHASAL
     C           SACRO     ANDNESHACRO
     C                     MOVEL'CO00302' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN54
     C                     MOVE '1'       *IN55
     C                     MOVE 'Y'       ERMSG
     C                     ELSE
      *
     C                     MOVE PCORF     WKCORF
     C                     Z-ADDPOPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C**********           Z-ADDPDEPO     WKDEPO                                              CSD027
     C                     MOVE PDEPO     WKDEPO                                              CSD027
      *
      ***  If Actual Stock Allocation has changed.
      *
     C           SASAL     IFNE SHASAL
     C                     MOVE NMDP2     ZSDEC            New Security Decimal Places
     C           15        SUB  ZSDEC     ZSDIG
     C                     MOVE SASAL     ZFLD17
     C                     EXSR ZASIGN
      *
      ***  Field must be numeric.
      *
     C           *IN99     IFEQ '1'
     C                     MOVEL'CO00264' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN54
     C                     MOVE 'Y'       ERMSG
     C                     ELSE
      *
      ***  Save Actual Stock Allocation entered.
      *
     C                     MOVE ZOUT15    WWASTA 150
     C           ZFSIGN    IFEQ '-'
     C                     MULT -1        WWASTA
     C                     ENDIF
     C                     Z-ADDNMDP2     WWNBDP  10       New Security Decimal Places
     C                     Z-ADDWWASTA    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDWWNUM     WUASTA 309
      *
      ***  Access File depending on CO Type.
      *
     C                     SELEC
     C           PPROC     WHEQ 'DV'                       Dividend Events
     C           WKEY14    CHAINSECODVL1             89
     C                     MOVE 'SECODVL1'WWFILE  8
      *
     C           PPROC     WHEQ 'RG'                       Rights Issues
     C           WKEY14    CHAINSECORGL1             89
     C                     MOVE 'SECORGL1'WWFILE
      *
     C           PPROC     WHEQ 'FR'                       Free Allocation
     C           WKEY14    CHAINSECOFRL1             89
     C                     MOVE 'SECOFRL1'WWFILE
      *
     C           PPROC     WHEQ 'OF'                       Offers
     C           WKEY14    CHAINSECOOFL1             89
     C                     MOVE 'SECOOFL1'WWFILE
      *
     C           PPROC     WHEQ 'CR'                       Corporate Reorganisation
     C           WKEY14    CHAINSECOCRL1             89
     C                     MOVE 'SECOCRL1'WWFILE
      *
     C           PPROC     WHEQ 'EX'                       Exercices and Conversions
     C           WKEY14    CHAINSECOEXL1             89
     C                     MOVE 'SECOEXL1'WWFILE
      *                                                                   CEU017
     C           PPROC     WHEQ 'CC'                       Currency       CEU017
     C           PCORF     CHAINSECOCCL2             89    Changes.       CEU017
     C                     MOVE 'SECOCCL2'WWFILE                          CEU017
     C                     ENDSL
      *
      ***  If record not found in its corresponding LF, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVELWWFILE    DBFILE
     C           PCORF     CAT  POPNB:0   DBKEY1  8
     C           DBKEY9    CAT  DBKEY1:0  DBKEYA 10
     C                     MOVELDBKEY1    DBKEY            ***************
     C******               Z-ADD023       DBASE            * DB ERROR 23 *135686
     C                     Z-ADD033       DBASE            * DB ERROR 33 *135686
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  If Processing Type not Capital Changes, not Non Financial Events and not Name Changes.
      *
     C                     MOVE 'Y'       ASAVAL  1
     C           PPROC     IFNE 'CE'                       Not Capital Changes
     C           PPROC     ANDNE'NF'                       Not Non Financial Events
     C           PPROC     ANDNE'NC'                       Not Name Changes
      *
      ***  Retrieve Rounding and Denomination Multiplier depending on CO Type.
      *
     C                     Z-ADD0         WWDMLT                          135686
     C           PPROC     IFEQ 'CR'
     C                     MOVEAMHSECA    TSEC,1
     C                     Z-ADD1         I       20
     C           PNWSEC    LOKUPTSEC,I                   17Search New Security (20 Potential)
     C           *IN17     IFEQ '0'
     C                     MOVE ' '       WWRNDN  1        Rounding
     C******               Z-ADD0         WWDMLT 158       Denom. Multip. 135686
     C                     Z-ADD1         WWDMLT 309       Denom. Multip. 135686
     C                     ELSE
     C                     MOVEAMHRNDN    TNDN,1
     C                     MOVE TNDN,I    WWRNDN           Rounding
     C                     MOVEAMHDMLA    TDML,1
     C******               MOVE TDML,I    WWDMLT           Denom. Multip. 135686
     C                     MOVE TDML,I    WUNUM            Denom. Multip. 135686
     C                     ENDIF
     C                     ELSE
     C******               Z-ADDMDDMLT    WWDMLT           Denom. Multip. 135686
     C                     Z-ADDMDDMLT    WUNUM            Denom. Multip. 135686
     C                     MOVE MDRNDN    WWRNDN           Rounding
     C                     ENDIF
     C           WWDMLT    IFNE 1                                         135686
     C           PNWSEC    CHAINSECTYZ1              89                   135686
     C           *IN89     IFEQ '1'                                       135686
     C           *LOCK     IN   LDA                                       135686
     C                     MOVEL'SECTY   'DBFILE                          135686
     C                     MOVELPNWSEC    DBKEY            ***************135686
     C                     Z-ADD034       DBASE            * DB ERROR 34 *135686
     C                     MOVEL'SE7513'  DBPGM            ***************135686
     C                     OUT  LDA                                       135686
     C                     EXSR *PSSR                                     135686
     C                     ENDIF                                          135686
     C                     Z-ADDNMDP      WWNBDP                          135686
     C                     EXSR RTVNDP                                    135686
     C                     Z-ADDWWNUM     WWDMLT                          135686
     C                     ENDIF                                          135686
      *
     C******     WWRNDN    IFEQ 'D'                                       135686
     C           WUASTA    DIV  WWDMLT    W1ASTA 300
     C                     MVR            RESTE   90                      135686
     C******               ELSE                                           135686
     C******     WUASTA    DIV  WWDMLT    W1ASTA    H                     135686
     C******               ENDIF                                          135686
     C******     W1ASTA    MULT WWDMLT    W2ASTA 309                      135686
      *
      ***  Actual Stock Allocation entered must be in Denomination Multiplier and Rounding
      ***  precision.
      *
     C******     WUASTA    IFNE W2ASTA                                    135686
     C           RESTE     IFNE 0                                         135686
     C                     MOVE '1'       *IN54
     C                     MOVE 'Y'       ERMSG
     C                     MOVE 'N'       ASAVAL
     C                     MOVEL'CO00362' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
     C                     ENDIF                                          135686
      *
      ***  If Actual Stock Allocation entered valid.
      *
     C           ASAVAL    IFEQ 'Y'
     C                     MOVE 'Y'       AMASAL
     C                     Z-ADDWWASTA    WWASAL 150
     C                     Z-ADDWUASTA    WUASAL 309
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Actual Cash Rounding has changed.
      *
     C           SACRO     IFNE SHACRO
     C                     MOVE NMDPC2    ZSDEC            New Currency Decimal Places
     C           15        SUB  ZSDEC     ZSDIG
     C                     MOVE SACRO     ZFLD17
     C                     EXSR ZASIGN
      *
      ***  Field must be numeric.
      *
     C           *IN99     IFEQ '1'
     C                     MOVEL'CO00265' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN55
     C                     MOVE 'Y'       ERMSG
     C                     ELSE
     C                     MOVE 'Y'       AMACRO
     C                     MOVE ZOUT15    WWACRO 150
     C           ZFSIGN    IFEQ '-'
     C                     MULT -1        WWACRO
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If input/output fields are changed and no error occured.
      *
     C           ERMSG     IFEQ 'N'
     C           SASAL     IFNE SHASAL
     C           SACRO     ORNE SHACRO
     C           SASAL     IFNE SHASAL
     C                     MOVE *BLANKS   SASAL
     C           WWASAL    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWASAL    ZFLD15
     C                     Z-ADDNMDP2     ZDECS            New Security Decimnal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SASAL
     C                     ENDIF
     C                     ENDIF
     C           SACRO     IFNE SHACRO
     C                     MOVE *BLANKS   SACRO
     C           WWACRO    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWACRO    ZFLD15
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SACRO
     C                     ENDIF
     C                     ENDIF
      *
      ***  Recalculate fields due amendments and update current record.
      *
     C                     MOVE 'N'       MDUMMY  1                       136935
     C                     Z-ADD0         ACAADU 150                      136935
     C                     Z-ADD0         ACARDU 150                      136935
     C                     Z-ADD0         ASTADU 150                      136935
     C                     Z-ADD0         ASTRDU 150                      136935
     C                     EXSR RECNSE
     C                     EXSR SRSAVE
     C           AMASAL    IFEQ 'Y'
     C                     MOVE SASAL     SHASAL
     C                     Z-ADDWWASAL    SHASTA
     C                     ENDIF
     C           AMACRO    IFEQ 'Y'
     C                     MOVE SACRO     SHACRO
     C                     Z-ADDWWACRO    SHACAR
     C                     ENDIF
     C           AMASTR    IFEQ 'Y'
     C                     Z-ADDWWASTR    SHASTR
     C                     ENDIF
     C********** SHCNUM    IFNE *ZEROS                                                        CSD027
     C           SHCNUM    IFNE *BLANKS                                                       CSD027
     C                     MOVE STATUS,4  SREST
     C                     ELSE
     C                     MOVE *BLANKS   SREST
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  For Cash screen.
      *
     C                     ELSE
      *
      *
      ***  If Actual Cash Allocation has changed.
      *
     C           SACAL     IFNE SHACAL
     C           PPROC     IFEQ 'CR'
     C                     MOVE NMDPC1    ZSDEC            Event Currency Decimal Places
     C                     ELSE
     C                     MOVE NMDPC2    ZSDEC            New Currency Decimal Places
     C                     ENDIF
     C           15        SUB  ZSDEC     ZSDIG
     C                     MOVE SACAL     ZFLD17
     C                     EXSR ZASIGN
      *
      ***  Field must be numeric.
      *
     C           *IN99     IFEQ '1'
     C                     MOVEL'CO00266' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN57
     C                     MOVE 'Y'       ERMSG
     C                     ELSE
     C                     MOVE ZOUT15    WWACAL 150
     C           ZFSIGN    IFEQ '-'
     C                     MULT -1        WWACAL
     C                     ENDIF
     C                     Z-ADDWWACAL    SHACAA
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Actual Cash Rounding has changed.
      *
     C           SACRO     IFNE SHACRO
     C           PPROC     IFEQ 'CR'
     C                     MOVE NMDPC1    ZSDEC            Event Currency Decimal Places
     C                     ELSE
     C                     MOVE NMDPC2    ZSDEC            New Currency Decimal Places
     C                     ENDIF
     C           15        SUB  ZSDEC     ZSDIG
     C                     MOVE SACRO     ZFLD17
     C                     EXSR ZASIGN
      *
      ***  Field must be numeric.
      *
     C           *IN99     IFEQ '1'
     C                     MOVEL'CO00265' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE '1'       *IN58
     C                     MOVE 'Y'       ERMSG
     C                     ELSE
     C                     MOVE ZOUT15    WWACRO 150
     C           ZFSIGN    IFEQ '-'
     C                     MULT -1        WWACRO
     C                     ENDIF
     C                     Z-ADDWWACRO    SHACAR
     C                     ENDIF
     C                     ENDIF
      *
      ***  If input/output fields are changed and no error occured.
      *
     C           ERMSG     IFEQ 'N'
     C           SACAL     IFNE SHACAL
     C           SACRO     ORNE SHACRO
     C           SACAL     IFNE SHACAL
     C                     MOVE *BLANKS   SACAL
     C           WWACAL    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWACAL    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SACAL
     C                     ENDIF
     C                     ENDIF
     C           SACRO     IFNE SHACRO
     C                     MOVE *BLANKS   SACRO
     C           WWACRO    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWACRO    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SACRO
     C                     ENDIF
     C                     ENDIF
      *
      ***  Recalculate fields due amendments and update current record.
      *
     C                     MOVE 'N'       MDUMMY                          136935
     C                     Z-ADD0         ACAADU                          136935
     C                     Z-ADD0         ACARDU                          136935
     C                     Z-ADD0         ASTADU                          136935
     C                     Z-ADD0         ASTRDU                          136935
     C                     EXSR RECCAS
     C                     EXSR SRSAVE
     C                     Z-ADDSHACAA    HSACAA
     C                     MOVE SACAL     SHACAL
     C                     Z-ADDSHACAR    HSACAR
     C                     MOVE SACRO     SHACRO
     C********** SHCNUM    IFNE *ZEROS                                                        CSD027
     C           SHCNUM    IFNE *BLANKS                                                       CSD027
     C                     MOVE STATUS,4  SREST
     C                     ELSE
     C                     MOVE *BLANKS   SREST
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  RECCAS - Recalculate fields due Actual Cash Allocation or    *
      *           Actual Cash Rounding changed from 'CASH' screen.    *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           RECCAS    BEGSR                           ** RECCAS SR **
      *
     C                     MOVE 'N'       ACCDPF  1
     C                     Z-ADD0         DUACAA                          136935
     C                     Z-ADD0         DUACAR                          136935
     C                     Z-ADD0         DUASTA                          136935
     C                     Z-ADD0         DUASTR                          136935
      *
      ***  If Actual Cash Rounding has changed.
      *
     C           SACRO     IFNE SHACRO
      *
      ***  Access Depot file with CO Reference, Option Number, Branch,
      ***  Depot and New Security = '**CASH**'.
      *
     C                     MOVE PCORF     WKCORF
     C                     MOVE POPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C**********           Z-ADDPDEPO     WKDEPO                                              CSD027
     C                     MOVE PDEPO     WKDEPO                                              CSD027
     C                     MOVE *BLANKS   WKSESN
     C                     MOVEL'**CASH**'WKSESN
     C           WKEY1     CHAINSECODPL3             16
      *
      ***  If record not found, handle Database error.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECODPL3'DBFILE
     C                     MOVE WKOPTN    WWOPTN
     C                     MOVE WKDEPO    WWDEPO
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C                     MOVELDBKEY4    DBKEY            ***************
     C                     Z-ADD018       DBASE            * DB ERROR 18 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVE 'Y'       ACCDPF
     C                     Z-ADDMBBCAA    SVBCAA                          136935
      *
      ***  Recalculate Balancing Cash Allocation by subtracting old value and adding new value
      ***  of Actual Cash Rounding.
      *
     C                     SUB  HSACAR    MBBCAA
     C                     ADD  SHACAR    MBBCAA
      *                                                                   136935
      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
      ***  reset it.                                                      136935
      *                                                                   136935
     C           MBBCAA    IFNE 0                                         136935
     C           PPROC     ANDEQ'CC'                                      136935
     C           MBBCAA    ORNE 0                                         136935
     C           PPROC     ANDNE'CC'                                      136935
     C           BVALDC    ANDEQ'Y'                                       136935
     C                     Z-SUBMBBCAA    DUACAR                          136935
     C                     Z-ADD0         MBBCAA                          136935
     C                     ENDIF                                          136935
      *
      ***  Output new value for Balancing Cash Allocation on top line
      ***  of screen.
      *
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MBBCAA    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     MOVE NMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     MOVE NMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE *BLANKS   SCASH
     C                     MOVE ZOUT21    SCASH
      *
     C                     ENDIF
      *
      ***  If Actual Cash Allocation has changed.
      *
     C           SACAL     IFNE SHACAL
      *
      ***  Access Depot file with CO Reference, Option Number, Branch,
      ***  Depot and New Security = '**CASH**'.
      *
     C           ACCDPF    IFEQ 'N'
     C                     MOVE PCORF     WKCORF
     C                     MOVE POPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C**********           Z-ADDPDEPO     WKDEPO                                              CSD027
     C                     MOVE PDEPO     WKDEPO                                              CSD027
     C                     MOVE *BLANKS   WKSESN
     C                     MOVEL'**CASH**'WKSESN
     C           WKEY1     CHAINSECODPL3             16
      *
      ***  If record not found, handle Database error.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECODPL3'DBFILE
     C                     MOVE WKOPTN    WWOPTN
     C                     MOVE WKDEPO    WWDEPO
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C                     MOVELDBKEY4    DBKEY            ***************
     C                     Z-ADD019       DBASE            * DB ERROR 19 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVE 'Y'       ACCDPF
     C                     Z-ADDMBBCAA    SVBCAA                          136935
     C                     ENDIF
      *
      ***  Recalculate Balancing Cash Allocation by subtracting old value and adding new value
      ***  of Actual Cash Allocation.
      *
     C                     SUB  HSACAA    MBBCAA
     C                     ADD  SHACAA    MBBCAA
      *                                                                   136935
      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
      ***  reset it.                                                      136935
      *                                                                   136935
     C           MBBCAA    IFNE 0                                         136935
     C           PPROC     ANDEQ'CC'                                      136935
     C           MBBCAA    ORNE 0                                         136935
     C           PPROC     ANDNE'CC'                                      136935
     C           BVALDC    ANDEQ'Y'                                       136935
     C                     Z-SUBMBBCAA    DUACAA                          136935
     C                     Z-ADD0         MBBCAA                          136935
     C                     ENDIF                                          136935
      *
      ***  Output new value for Balancing Cash Allocation on top line
      ***  of screen.
      *
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MBBCAA    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     MOVE NMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     MOVE NMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE *BLANKS   SCASH
     C                     MOVE ZOUT21    SCASH
      *
     C                     ENDIF
      *
      ***  If process for Customer (Customer/Book Indicator = 'C'),
      ***  and if Processing Type not Currency Changes,                   CEU017
      ***  Recalculate Total Fees.
      *
     C           SHCOTP    IFEQ 'C'
     C           PPROC     ANDNE'CC'                                      CEU017
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     Z-ADDSHACAA    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDWWNUM     ZTCON
     C                     Z-ADDSHACAR    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     ZTCON
     C                     EXSR RECFEE
     C                     Z-ADDWWTOTF    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     SHTOTF
     C                     MOVE *BLANKS   STFEE
     C           SHTOTF    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE SHTOTF    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    STFEE
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Processing Type = Dividend Events and feature Withholding Tax is ON, recalculate
      ***  Total Taxes, otherwise, set Total Taxes to 0.
      *
     C           PPROC     IFEQ 'DV'
     C           MDSDIT    ANDEQ'R'                                       136935
     C           S01447    ANDEQ'Y'
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     Z-ADDSHACAA    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDWWNUM     WWAMTT 309
     C                     Z-ADDSHACAR    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WWAMTT
     C                     EXSR RECTAX
     C                     Z-ADDTOTTAX    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     SHTOTT
     C                     MOVE *BLANKS   STOTT
     C           SHTOTT    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE SHTOTT    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    STOTT
     C                     ENDIF
     C                     ELSE
     C                     Z-ADD0         SHTOTT
     C                     MOVE *BLANKS   STOTT
     C                     ENDIF
      *
      *****Recalculate*Total*Settlement*=******************************** 161641
      *****Actual*Cash*Allocation*&*Rounding*+/-*Total Fees*+/-*Total**** 161641
      *****Taxes*(+*if*Ex-Date*Position*>*or*=*0,*else*-).*************** 161641
      ***  Total Settlement = Actual Cash Allocation & Rounding   - Total 161641
      ***  Fees +/- Total Taxes (- if Ex-Date Position is > or = 0,       161641
      ***  else +).                                                       161641
      *
     C           SHACAA    ADD  SHACAR    WWTSET
     C           SHTDVD    IFGE 0
     C***********          ADD  SHTOTF    WWTSET                          161641
     C***********          ADD  SHTOTT    WWTSET                          161641
     C                     SUB  SHTOTF    WWTSET                          161641
     C                     SUB  SHTOTT    WWTSET                          161641
     C                     ELSE
     C                     SUB  SHTOTF    WWTSET
     C***********          SUB  SHTOTT    WWTSET                          161641
     C                     ADD  SHTOTT    WWTSET                          161641
     C                     ENDIF
     C                     MOVE *BLANKS   STSET
     C           WWTSET    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWTSET    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    STSET
     C                     ENDIF
      *
      ***  Update record on Depot File for CO Reference, Option Number,
      ***  Branch, Depot and New Security = '**CASH**'.
      *
     C           SVBCAA    IFNE MBBCAA                                    136935
     C                     MOVE 'A'       MBCHTP
     C                     MOVE SUSER     MBLUID
     C                     Z-ADDBJRDNB    MBLCD
     C                     ENDIF                                          136935
     C                     UPDATSECODPD0
      *                                                                   136935
      ***  If Balancing Difference has been allocated to Dummy Customer,  136935
      ***  update record from SECOALL7 for Security '**CASH**' and Dummy  136935
      ***  Customer                                                       136935
      *                                                                   136935
     C           DUACAA    IFNE 0                                         136935
     C           DUACAR    ORNE 0                                         136935
     C           SHCNUM    IFNE WDUMMY                                    136935
     C                     MOVE 'C'       WKCOTP                          136935
     C                     MOVE *BLANKS   WKBOOK                          136935
     C                     MOVE WDUMMY    WKCNUM                          136935
     C                     MOVE *BLANKS   WKPTFR                          136935
     C           WKEY4     CHAINSECOALL7             16                   136935
      *                                                                   136935
      ***  If record no longer on file, handle Database Error.            136935
      *                                                                   136935
     C           *IN16     IFEQ '1'                                       136935
     C           *LOCK     IN   LDA                                       136935
     C                     Z-ADD035       DBASE            ***************136935
     C                     MOVE 'SECOALL7'DBFILE           * DB ERROR 35 *136935
     C                     MOVELWKCORF    DBKEY1           ***************136935
     C                     MOVE WKOPTN    DBKEY1                          136935
     C                     MOVELWKBRCD    DBKEY2                          136935
     C                     MOVE WKDEPO    DBKEY2                          136935
     C                     MOVELDBKEY1    DBKEY3                          136935
     C                     MOVE DBKEY2    DBKEY3                          136935
     C                     MOVELDBKEY3    DBKEY4                          136935
     C                     MOVE WKSESN    DBKEY4                          136935
     C                     MOVELWKCOTP    DBKEY5                          136935
     C                     MOVE WKBOOK    DBKEY5                          136935
     C                     MOVELWKCNUM    DBKEY6                          136935
     C                     MOVE WKPTFR    DBKEY6                          136935
     C                     MOVELDBKEY5    DBKEY7                          136935
     C                     MOVE DBKEY6    DBKEY7                          136935
     C                     MOVELDBKEY4    DBKEY8                          136935
     C                     MOVE DBKEY7    DBKEY8                          136935
     C                     MOVELDBKEY8    DBKEY                           136935
     C                     MOVEL'SE7513'  DBPGM                           136935
     C                     OUT  LDA                                       136935
     C                     EXSR *PSSR                                     136935
     C                     ENDIF                                          136935
     C                     ADD  DUACAA    MCACAA                          136935
     C                     ADD  DUACAR    MCACAR                          136935
     C                     MOVE 'A'       MCCHTP                          136935
     C                     Z-ADDBJRDNB    MCLCD                           136935
     C                     MOVE SUSER     MCLUID                          136935
     C                     MOVE 'M'       MCREST                          136935
     C                     UPDATSECOALD0                                  136935
     C                     MOVE 'Y'       MDUMMY                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ELSE                                           136935
     C                     ADD  DUACAA    ACAADU                          136935
     C                     ADD  DUACAR    ACARDU                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  RECTAX - Recalculate Total Taxes.                            *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           RECTAX    BEGSR                           ** RECTAX SR **
      *
      ***  Initialise Total Tax.
      *
     C                     Z-ADD0         TOTTAX
      *
      ***  Access Security Withholding Tax details file to retrieve Tax for the Event Security.
      *
     C           SSESN     CHAINSESWHTL0             84
      *
      ***  If record found.
      *
     C           *IN84     IFEQ '0'
      *
      ***  Initialise work tax rate and amount fields.
      *
     C                     CLEARUTXRSR
     C                     CLEARUTXRRF
     C                     CLEARUTXRUS
     C                     CLEARUDLOR
      *
      ***  If Tax Band at source is zero, then take Rate from Security Withholding Tax file.
      *
     C           S1TABD    IFEQ *ZERO
     C                     Z-ADDS1RASO    UTXRSR  74
     C                     ELSE
      *
      ***  Otherwise access SE Country Tax Rate file to get Tax Rate at source.
      *
     C                     MOVELS1CTTA    UKEY    3
     C                     MOVE S1TABD    UKEY
     C                     CALL 'AOSCTXR0'
     C                     PARM *BLANKS   WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM S1CTTA    WCTTA   2
     C                     PARM S1TABD    WTABD   10
     C           SECNTR    PARM SECNTR    DSSDY
      *
      ***  If record not found or not live, handle Database Error.
      *
     C           WRTCD     IFNE *BLANKS
     C           TXRECI    ORNE 'D'
     C           *LOCK     IN   LDA
     C                     Z-ADD020       DBASE            ***************
     C                     MOVEL'SECNTRL0'DBFILE           * DB ERROR 20 *
     C                     MOVELUKEY      DBKEY            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ELSE
     C                     Z-ADDTXRASO    UTXRSR
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Tax Band by User is not zero, then access Country to Branch Tax Rate file to get
      ***  Tax Rate by User, otherwise set to zero.
      *
     C           S1TABU    IFNE *ZERO
     C                     CALL 'AOCBTXR0'
     C                     PARM *BLANKS   WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM PBRCD     WBRCA   3
     C                     PARM S1CTTA    WCTTA
     C                     PARM S1TABU    WTABU   10
     C           SECBTX    PARM SECBTX    DSFDY
     C           WRTCD     IFEQ *BLANKS
     C           TBRECI    ANDEQ'D'
     C                     Z-ADDTBRASR    UTXRRF  74
     C                     Z-ADDTBRAUS    UTXRUS  74
     C                     MOVE TBDLOR    UDLOR   1
     C                     ENDIF
     C                     ENDIF
      *
      ***  Calculate amount deducted at source.
      *
     C           UTXRSR    DIV  100       URATE   54
     C           WWAMTT    MULT URATE     TASO   130H
      *
      ***  Calculate amount deducted refundable.
      *
     C           UTXRRF    DIV  100       URATE
     C           WWAMTT    MULT URATE     TASR   130H
      *
      ***  Calculate amount deducted by user.
      *
     C                     CLEARTAUS
     C           UTXRUS    IFGT *ZERO
     C           UDLOR     IFEQ 'N'
     C                     MOVE SHCNUM    KCUST
     C           WKEY9     CHAINCLINT                84
     C           *IN84     IFEQ '1'
     C           RECI      OREQ '*'
     C           *LOCK     IN   LDA
     C                     Z-ADD021       DBASE            ***************
     C                     MOVEL'CLINTCB 'DBFILE           * DB ERROR 21 *
     C                     MOVELKCUST     DBKEYB  7        ***************
     C                     MOVE KRTYP     DBKEYB
     C                     MOVELDBKEYB    DBKEY
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
     C           UDLOR     IFEQ 'Y'
     C           UDLOR     OREQ 'N'
     C           CLOC      ANDNEUBRLOC
     C           UTXRUS    DIV  100       URATE
     C           WWAMTT    MULT URATE     TAUS   130H
     C                     ENDIF
     C                     ENDIF
      *
      ***  Calculate Total Tax.
      *
     C           TAUS      ADD  TASO      TOTTAX 309
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  RECFEE - Recalculate Total Fees.                             *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           RECFEE    BEGSR                           ** RECFEE SR **
      *
      ***  Call Access Program for Security Customer Details to retrieve Customer Group.
      *
     C                     MOVE SHCNUM    WSCKY
     C                     CALL 'AOSECSR0'
     C                     PARM           WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM           WSCKY   6
     C           SDSECS    PARM SDSECS    DSSDY
      *
      ***  Handle Database Error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD022       DBASE            ***************
     C                     MOVEL'SDSECSPD'DBFILE           * DB ERROR 22 *
     C                     MOVELWSCKY     DBKEY            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           S01496    IFEQ 'Y'
     C           BVACOP    ANDEQ'Y'
      *
      ***  Retrieve the Commission and the Charge Code on the Corporate Actions Default Charges
      ***  file with Customer Group, Customer, Investment Type and Corporate Action Type.
      *
     C                     MOVE BFPSCG    KCUGR            Customer Group
     C**********           Z-ADDSHCNUM    KCDCN            Customer                           CSD027
     C                     MOVE SHCNUM    KCDCN            Customer                           CSD027
     C                     MOVE SITP1     KSITP            Investment Type
     C                     MOVE PACT      KCOAT            Corporate Action Type
     C           WKEY10    CHAINSECOCHL0             84
      *
      ***  If record not found, access with Customer Group, Customer and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C                     MOVE *BLANKS   KCOAT            Corporate Action Type
     C           WKEY10    CHAINSECOCHL0             84
      *
      ***  If record not found, access with Customer Group and Customer and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C                     MOVE *BLANKS   KSITP            Investment Type
     C           WKEY10    CHAINSECOCHL0             84
      *
      ***  If record not found, access with Customer Group and Customer = 0 and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C**********           Z-ADD0         KCDCN            Customer                           CSD027
     C                     MOVE *BLANKS   KCDCN            Customer                           CSD027
     C           WKEY10    CHAINSECOCHL0             84
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
      *
      ***  Retrieve the Commission and the Charge Code on the Corporate Actions Default Charges
      ***  file with Classification, Customer, Investment Type and Corporate Action Type.
      *
     C                     MOVE BFCLAS    KCLAS            Retrieve Classification
     C**********           Z-ADDSHCNUM    KCDCN            Customer                           CSD027
     C                     MOVE SHCNUM    KCDCN            Customer                           CSD027
     C                     MOVE SITP1     KSITP            Investment Type
     C                     MOVE PACT      KCOAT            Corporate Action Type
     C           WKEY11    CHAINSECOCHL1             84
      *
      ***  If record not found, access with Classification, Customer and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C                     MOVE *BLANKS   KCOAT            Corporate Action Type
     C           WKEY11    CHAINSECOCHL1             84
      *
      ***  If record not found, access with Classification and Customer and Investment type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C                     MOVE *BLANKS   KSITP            Investment Type
     C           WKEY11    CHAINSECOCHL1             84
      *
      ***  If record not found, access with Classification and Customer = 0 and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C**********           Z-ADD0         KCDCN            Customer                           CSD027
     C                     MOVE *BLANKS   KCDCN            Customer                           CSD027
     C           WKEY11    CHAINSECOCHL1             84
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If record not found with one access, set Total Fees to 0.
      *
     C           *IN84     IFEQ '1'
     C                     Z-ADD0         WWTOTF 309       Total Fees
      *
      ***  If record found with one access.
      *
     C                     ELSE
      *
      ***  Retrieve Charge Basis Indicator on Charge Types file with Charge Code retrieve above
      ***  and Event Nominal Currency.
      *
     C                     MOVE MRCOCH    KCCOM   2
     C           WKEY12    CHAINSECGT                84
      *
      ***  If no live record found, set Total Fees to 0.
      *
     C           *IN84     IFEQ '1'
     C***********          Z-ADD0         WWTOTF                          179205
     C                     Z-ADD0         CHRAMT                          179205
      *
      ***  If live record found, Calculate Charge Amount.
      *
     C                     ELSE
     C                     Z-ADD0         ZTCON
     C                     Z-ADD0         ZNOML
      *
      ***  If Processing Type not Non Financial Event.
      *
     C           PACT      IFNE 'NF'
      *
      ***  If Charge Basis Indicator = 'C'.
      *
     C           CHGB      IFEQ 'C'
      *
      ***  Calculate Charge Amount.
      *
     C                     EXSR CALAM2
     C                     Z-ADDZCHGA     CHRAMT 309
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          179205
      *
     C                     Z-ADD0         ZTCON
     C                     Z-ADD0         ZNOML
      *
      ***  Retrieve Charge Basis Indicator on Charge Types file with Commission Code retrieve
      ***  above and Event Nominal Currency.
      *
     C                     MOVE MRCOCO    KCCOM
     C           WKEY12    CHAINSECGT                84
      *
      ***  If no live record found, set Total Fees to 0.
      *
     C           *IN84     IFEQ '1'
     C***********          Z-ADD0         WWTOTF                          179205
     C                     Z-ADD0         COMAMT                          179205
      *
      ***  If live record found, Calculate Commission Amount.
      *
     C                     ELSE
      *
      ***  If Processing Type not Non Financial Event.
      *
     C           PPROC     IFNE 'NF'
      *
      ***  If Charge Basis Indicator = 'C'.
      ***  Cash Rounding).
      *
     C           CHGB      IFEQ 'C'
      *
      ***  Calculate Commission Amount.
      *
     C                     EXSR CALAM2
     C                     Z-ADDZCHGA     COMAMT 309
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          179205
      *
      ***  Calculate Total Fees = Charge Amount + Commission Amount calculated above.
      *
     C           CHRAMT    ADD  COMAMT    WWTOTF
     C                     ENDIF
     C***********          ENDIF                                          179205
     C***********          ENDIF                                          179205
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  CALAM2 - Calculate Charge Amounts.                           *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           CALAM2    BEGSR                           ** CALAM2 SR **
      *
      ***  Charge Details.
      *
     C                     MOVE CHGB      ZCHGB
     C                     MOVE THRI      ZTHRI
     C                     Z-ADDMNCH      ZMNCH
     C                     Z-ADDMXCH      ZMXCH
      *
      ***  Set up array for Upper Range Limits.
      *
     C                     Z-ADDSTU1      ZRA,1
     C                     Z-ADDSTU2      ZRA,2
     C                     Z-ADDSTU3      ZRA,3
     C                     Z-ADDSTU4      ZRA,4
     C                     Z-ADDSTU5      ZRA,5
     C                     Z-ADDSTU6      ZRA,6
     C                     Z-ADDSTU7      ZRA,7
     C                     Z-ADDSTU8      ZRA,8
     C                     Z-ADDSTU9      ZRA,9
     C                     Z-ADDST10      ZRA,10
     C                     Z-ADDST11      ZRA,11
     C                     Z-ADDST12      ZRA,12
     C                     Z-ADDST13      ZRA,13
     C                     Z-ADDST14      ZRA,14
      *
      ***  Set up array for Percentage Levels.
      *
     C                     Z-ADDPL01      ZPC,1
     C                     Z-ADDPL02      ZPC,2
     C                     Z-ADDPL03      ZPC,3
     C                     Z-ADDPL04      ZPC,4
     C                     Z-ADDPL05      ZPC,5
     C                     Z-ADDPL06      ZPC,6
     C                     Z-ADDPL07      ZPC,7
     C                     Z-ADDPL08      ZPC,8
     C                     Z-ADDPL09      ZPC,9
     C                     Z-ADDPL10      ZPC,10
     C                     Z-ADDPL11      ZPC,11
     C                     Z-ADDPL12      ZPC,12
     C                     Z-ADDPL13      ZPC,13
     C                     Z-ADDPL14      ZPC,14
     C                     Z-ADDPL15      ZPC,15
      *
      ***  Set up array for Flat Charges.
      *
     C                     Z-ADDFC01      ZCG,1
     C                     Z-ADDFC02      ZCG,2
     C                     Z-ADDFC03      ZCG,3
     C                     Z-ADDFC04      ZCG,4
     C                     Z-ADDFC05      ZCG,5
     C                     Z-ADDFC06      ZCG,6
     C                     Z-ADDFC07      ZCG,7
     C                     Z-ADDFC08      ZCG,8
     C                     Z-ADDFC09      ZCG,9
     C                     Z-ADDFC10      ZCG,10
     C                     Z-ADDFC11      ZCG,11
     C                     Z-ADDFC12      ZCG,12
     C                     Z-ADDFC13      ZCG,13
     C                     Z-ADDFC14      ZCG,14
     C                     Z-ADDFC15      ZCG,15
      *
     C                     Z-ADDNMDP1     ZDECS
      *
      ***  Nominal Decimal Places.
      *
     C                     Z-ADD0         ZNMDP
      *
      ***  Security Details.
      *
     C                     Z-ADD1         ZPRICE
     C                     Z-ADD0         ZTCFC
     C                     MOVE 'P'       ZPROT
     C                     MOVE *BLANKS   ZSPBS
      *
     C           S01446    IFEQ 'Y'
      *
      ***  Purchase Interest.
      *
     C                     Z-ADD0         ZTPI
      *
     C                     MOVE *BLANKS   ZCCYI
     C                     MOVE *BLANKS   ZCCYO
     C                     MOVE *BLANKS   ZEXCH
     C                     MOVE *BLANKS   ZMD
      *
     C                     ENDIF
      *
      ***  Total Nominal.
      *
     C                     Z-ADD*ZEROS    ZTNOM  150
      *
     C                     EXSR ZCCAL1
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  RECNSE - Recalculate fields due Actual Stock Allocation or   *
      *           Actual Cash Rounding changed from normal screen.    *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           RECNSE    BEGSR                           ** RECNSE SR **
      *
      ***  Access File depending on CO Type.
      *
     C                     MOVE '0'       *IN16
     C                     MOVE *BLANKS   DBKEY9  2
     C           PPROC     IFEQ 'DV'
     C           WKEY14    CHAINSECODVL1             16
     C                     MOVEL'SECODVL1'WWFILE  8
     C                     ELSE
     C           PPROC     IFEQ 'CR'
     C           WKEY14    CHAINSECOCRL1             16
     C                     MOVEL'SECOCRL1'WWFILE
     C                     ELSE
     C           PPROC     IFEQ 'CE'
     C           WKEY14    CHAINSECOCEL1             16
     C                     MOVEL'SECOCEL1'WWFILE
     C                     ELSE
     C           PPROC     IFEQ 'OF'
     C           WKEY14    CHAINSECOOFL1             16
     C                     MOVEL'SECOOFL1'WWFILE
     C                     ELSE
     C           PPROC     IFEQ 'RG'
     C           WKEY14    CHAINSECORGL1             16
     C                     MOVEL'SECORGL1'WWFILE
     C                     ELSE
     C           PPROC     IFEQ 'EX'
     C           WKEY14    CHAINSECOEXL1             16
     C                     MOVEL'SECOEXL1'WWFILE
     C                     ELSE
     C           PPROC     IFEQ 'FR'
     C           WKEY14    CHAINSECOFRL1             16
     C                     MOVEL'SECOFRL1'WWFILE
     C                     ELSE
     C           PPROC     IFEQ 'CC'                                      CEU017
     C           PCORF     CHAINSECOCCL2             16                   CEU017
     C                     MOVEL'SECOCCL2'WWFILE                          CEU017
     C                     ELSE                                           CEU017
     C                     MOVE '1'       *IN16
     C                     MOVEL'SECOxxL1'WWFILE
     C                     MOVE PPROC     DBKEY9
     C                     ENDIF                                          CEU017
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C           *IN16     IFEQ '1'
     C           MDRECI    ORNE 'D'
     C           *LOCK     IN   LDA
     C                     MOVELWWFILE    DBFILE
     C           PCORF     CAT  POPNB:0   DBKEY1  8
     C           DBKEY9    CAT  DBKEY1:0  DBKEYA 10
     C                     MOVELDBKEY1    DBKEY            ***************
     C                     Z-ADD023       DBASE            * DB ERROR 23 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Prepare Rounding:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           PPROC     IFEQ 'CR'
     C                     MOVEAMHSECA    TSEC,1
     C                     Z-ADD1         I       20
     C           PNWSEC    LOKUPTSEC,I                   17
     C           *IN17     IFEQ '0'
     C                     MOVE ' '       WWRNDN  1
     C                     ELSE
     C                     MOVEAMHRNDN    TNDN,1
     C                     MOVE TNDN,I    WWRNDN
     C                     ENDIF
     C                     ELSE
     C                     MOVE MDRNDN    WWRNDN
     C                     ENDIF
      *
      ***  If Processing Type = Dividend Events and Subscription Price is entered as Market,
      ***  the Subscription Price must first be calculated from Current Market Price minus Discount.
      *
     C           PPROC     IFEQ 'DV'
     C           MDMRKI    ANDEQ'Y'
     C                     EXSR CSBPR
     C                     ENDIF
      *                                                                   136935
      ***  If Processing Type = Dividend Events with Stock Dividend Type  136935
      ***  = 'R', if Compensation Price entered, use Compensation Price   136935
      ***  instead of Subscription Price, otherwise, calculate Subscrip-  136935
      ***  tion Price = Subscription Price minus Discount Rate.           136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'DV'                                      136935
     C           MDSDIT    ANDEQ'R'                                       136935
     C           MDCOMP    IFNE 0                                         136935
     C                     Z-ADDMDCOMP    MDSBPR                          136935
     C                     ELSE                                           136935
     C           MDMRKI    IFNE 'Y'                                       136935
     C           MDSBPR    MULT MDDSRT    WWSBPR                          136935
     C           WWSBPR    DIV  100       WWSBPR                          136935
     C                     SUB  WWSBPR    MDSBPR                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
      *
      ***  If Actual Stock Allocation has changed.
      *
     C           SASAL     IFNE SHASAL
      *
      ***  Check if Actual Allocation fields can be recalculated.
      *
     C                     EXSR CHACAL
      *
      ***  Ptrepare Dividend Per Unit.
      *
     C           PPROC     IFEQ 'DV'                       If Dividend Events, from file
     C******               Z-ADDNMDP2     WWNBDP           New Sec.Dec.pl.135690
     C**********           Z-ADDNMDPC2    WWNBDP           New.Cur.135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C**********           Z-ADDWWNUM     WWDIVU 309                      190204
     C                     Z-ADDMDDIV1    WWDIVU 309       13,8 ==> 30,9  190204
     C                     ELSE
     C                     ENDIF
      *
      ***  If Actual Allocation fields can be recalculated,
      ***  recalculate Actual Stock Rounding.
      *
     C           SPWRKF    IFEQ 'Y'
     C                     EXSR REASTR
     C                     ELSE
     C                     MOVE *BLANKS   SASRO
     C                     Z-ADD0         WUASTR
     C                     Z-ADD0         WWASTR
     C                     Z-ADD0         MCASTR
     C                     ENDIF
      *
      ***  Recalculate Holding Taken as Stock.
      *
     C                     EXSR REHOST
      *
     C           PPROC     IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'R'                           Stk Dividend Tp=Reinvestment of Divid.
      *
     C           PPROC     OREQ 'EX'                       Or Processing Type = Dividends Events
     C           MJCPRC    ANDNE0                             Conversion Price not 0
     C           MJCEXR    ANDNE0                             Conversion Exchange Rate not 0
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
      ***  Calculate Actual Cash Pool for Book/Customer.
      *
     C                     EXSR CACAPO
     C                     ENDIF
      *
      ***  If Actual Allocation fields can be recalculated, recalculate Actual Cash Rounding.
      *
     C           SPWRKF    IFEQ 'Y'
     C                     EXSR REACAR
     C                     ELSE
     C                     MOVE *BLANKS   SACRO
     C                     Z-ADD0         WWACRO
     C                     Z-ADD0         WUACAR 309
     C                     Z-ADD0         MCACAR
     C                     ENDIF
      *
      ***  Recalculate Holding Taken as Cash.
      *
     C           AMHOST    IFEQ 'Y'
     C                     EXSR REHOCA
     C                     ENDIF
      *
      ***  Access Allocation file with CO Reference, Option Number,
      ***  Branch, Depot, Security = '**CASH**', Cust/Book Ind.,
      ***  Book, Customer and Portfolio.
      *
     C                     MOVE PCORF     WKCORF
     C                     Z-ADDPOPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C                     MOVE PDEPO     WKDEPO
     C                     MOVE *BLANKS   WKSESN
     C                     MOVEL'**CASH**'WKSESN
     C                     MOVE SHCOTP    WKCOTP
     C                     MOVE SHBOOK    WKBOOK
     C**********           Z-ADDSHCNUM    WKCNUM                                              CSD027
     C                     MOVE SHCNUM    WKCNUM                                              CSD027
     C                     MOVE SHPORT    WKPTFR
     C           WKEY4     CHAINSECOALL7             16
      *
      ***  If record not found, handle Database error.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECOALL7'DBFILE
     C                     MOVE WKOPTN    WWOPTN
     C                     MOVE WKDEPO    WWDEPO
     C                     MOVE WKCNUM    WWCNUM  6
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C           WKCOTP    CAT  WKBOOK:0  DBKEY5  3
     C           WWCNUM    CAT  WKPORT:0  DBKEY6 10
     C           DBKEY5    CAT  DBKEY6:0  DBKEY7 13
     C           DBKEY4    CAT  DBKEY7:0  DBKEY8 40
     C                     MOVELDBKEY8    DBKEY            ***************
     C                     Z-ADD024       DBASE            * DB ERROR 24 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     Z-ADDMCHOST    SVHOST 150
     C                     Z-ADDMCACAR    SVACAR 150
     C                     Z-ADDMCHOCA    SVHOCA 150
     C                     Z-ADDMCHOCA    WWHOCA                    161591
     C                     Z-ADDMCACAA    SVACAA 150
     C                     Z-ADDMCTOTF    SVTOTF 150
     C                     Z-ADDMCTOTT    SVTOTT 150
      *
      ***  Move Holding Taken as Cash re-calculated into file field.
      *
     C           AMHOCA    IFEQ 'Y'
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDWWHOCA    WUNUM
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCHOCA
     C                     ELSE
     C                     Z-ADDWWHOCA    MCHOCA
     C                     ENDIF
     C                     ENDIF
      *
      ***  Move Holding Taken as Stock re-calculated into file field.
      *
     C           AMHOST    IFEQ 'Y'
     C                     Z-ADDWWHOST    MCHOST
     C                     ENDIF
      *
      ***  Recalculate Actual Cash Rounding by substract old value
      ***  and add new value of Actual Cash Rounding.
      *
     C           AMACAR    IFEQ 'Y'
     C                     SUB  SHACAR    MCACAR
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDWWACRO    WUNUM
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C                     ADD  WUNUM     MCACAR
     C                     ELSE
     C                     ADD  WWACRO    MCACAR
     C                     ENDIF
     C                     ENDIF
      *
      ***  Re-calculate Actual Cash Allocation.
      *
     C                     Z-ADDMCACAA    SHACAA 150
     C                     EXSR REACAA
     C                     Z-ADDMCACAA    WWACAA 150
      *
      ***  If process for Customer (Customer/Book Indicator = 'C'),
      ***  and if Processing Type not Currency Changes,                   CEU017
      ***  Recalculate Total Fees.
      *
     C           MCCOTP    IFEQ 'C'
     C           PPROC     ANDNE'CC'                                      CEU017
     C           AMACAA    ANDEQ'Y'
     C           MCCOTP    OREQ 'C'
     C           PPROC     ANDNE'CC'                                      CEU017
     C           AMACAR    ANDEQ'Y'
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     Z-ADDMCACAA    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDWWNUM     ZTCON
     C                     Z-ADDMCACAR    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     ZTCON
     C                     EXSR RECFEE
     C                     Z-ADDWWTOTF    WWNUM
      * No need to multiply the result, only to edit correctly on screen. 179205
     C***********          EXSR SETNDP                                    179205
     C                     Z-ADDWWNUM     WUNUM                           179205
     C                     Z-ADDWUNUM     MCTOTF
     C                     ENDIF
      *
      ***  If Processing Type = Dividend Events and feature Withholding Tax is ON, recalculate
      ***  Total Taxes, otherwise, set Total Taxes to 0.
      *
     C           PPROC     IFEQ 'DV'
     C           MDSDIT    ANDEQ'R'                                       136935
     C           S01447    IFEQ 'Y'
     C           AMACAA    IFEQ 'Y'
     C           AMACAR    OREQ 'Y'
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     Z-ADDMCACAA    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDWWNUM     WWAMTT 309
     C                     Z-ADDMCACAR    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WWAMTT
     C                     EXSR RECTAX
     C                     Z-ADDTOTTAX    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCTOTT
     C                     ENDIF
     C                     ELSE
     C                     Z-ADD0         MCTOTT
     C                     ENDIF
     C                     ENDIF
      *
     C           SVHOST    IFNE MCHOST
     C           SVACAR    ORNE MCACAR                                    136935
     C           SVHOCA    ORNE MCHOCA                                    136935
     C           SVACAA    ORNE MCACAA                                    136935
     C           SVTOTF    ORNE MCTOTF                                    136935
     C           SVTOTT    ORNE MCTOTT                                    136935
     C******     SVACAR    ANDNEMCACAR                                    136935
     C******     SVHOCA    ANDNEMCHOCA                                    136935
     C******     SVACAA    ANDNEMCACAA                                    136935
     C******     SVTOTF    ANDNEMCTOTF                                    136935
     C******     SVTOTT    ANDNEMCTOTT                                    136935
     C                     MOVE 'M'       MCREST
     C                     Z-ADDBJRDNB    MCLCD
     C                     MOVE 'A'       MCCHTP
     C                     MOVE SUSER     MCLUID
     C                     ENDIF
      *
      ***  Update Allocation file SECOALL7 for Security '**CASH**'.
      *
     C                     UPDATSECOALD0
      *
      ***  Access Depot file with CO Reference, Option Number, Branch,
      ***  Depot and New Security.
      *
     C                     MOVE PCORF     WKCORF
     C                     MOVE POPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C**********           Z-ADDPDEPO     WKDEPO                                              CSD027
     C                     MOVE PDEPO     WKDEPO                                              CSD027
     C                     MOVE PNWSEC    WKSESN
     C           WKEY1     CHAINSECODPL3             16
      *
      ***  If record not found, handle Database error.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECODPL3'DBFILE
     C                     MOVE WKOPTN    WWOPTN
     C                     MOVE WKDEPO    WWDEPO
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C                     MOVELDBKEY4    DBKEY            ***************
     C                     Z-ADD025       DBASE            * DB ERROR 25 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                   136935
     C                     Z-ADD0         DUACAA 150                      136935
     C                     Z-ADD0         DUACAR 150                      136935
     C                     Z-ADD0         DUASTA 150                      136935
     C                     Z-ADD0         DUASTR 150                      136935
     C                     Z-ADDMBBSTA    SVBSTA 150                      136935
     C                     Z-ADDMBBSTR    SVBSTR 150                      136935
     C                     Z-ADDMBBCAR    SVBCAR                          136935
      *
      ***  Recalculate Balancing Cash Rounding by adding old value and subtracting new value
      ***  of Actual Cash Rounding.
      *
     C           AMACAR    IFEQ 'Y'
     C                     ADD  SHACAR    MBBCAR
     C                     SUB  WWACRO    MBBCAR
      *                                                                   136935
      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
      ***  reset it.                                                      136935
      *                                                                   136935
     C           MBBCAR    IFNE 0                                         136935
     C           PPROC     ANDEQ'CC'                                      136935
     C           MBBCAR    ORNE 0                                         136935
     C           PPROC     ANDNE'CC'                                      136935
     C           BVALDC    ANDEQ'Y'                                       136935
     C                     Z-ADDMBBCAR    DUACAR                          136935
     C                     Z-ADD0         MBBCAR                          136935
     C                     ENDIF                                          136935
     C                     ENDIF
      *
      ***  Recalculate Balancing Stock Rounding by adding old value and subtracting new value
      ***  of Actual Stock Rounding.
      *
     C           AMASTR    IFEQ 'Y'
     C                     ADD  SHASTR    MBBSTR
     C                     SUB  WWASTR    MBBSTR
      *                                                                   136935
      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
      ***  reset it.                                                      136935
      *                                                                   136935
     C           MBBSTR    IFNE 0                                         136935
     C           PPROC     ANDEQ'CC'                                      136935
     C           MBBSTR    ORNE 0                                         136935
     C           PPROC     ANDNE'CC'                                      136935
     C           BVALDC    ANDEQ'Y'                                       136935
     C                     Z-ADDMBBSTR    DUASTR                          136935
     C                     Z-ADD0         MBBSTR                          136935
     C                     ENDIF                                          136935
     C                     ENDIF
      *
      ***  Recalculate Balancing Stock Allocation by adding old value and subtracting new value
      ***  of Actual Stock Allocation.
      *
     C                     ADD  SHASTA    MBBSTA
     C                     SUB  WWASAL    MBBSTA
      *                                                                   136935
      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
      ***  reset it.                                                      136935
      *                                                                   136935
     C           MBBSTA    IFNE 0                                         136935
     C           PPROC     ANDEQ'CC'                                      136935
     C           MBBSTA    ORNE 0                                         136935
     C           PPROC     ANDNE'CC'                                      136935
     C           BVALDC    ANDEQ'Y'                                       136935
     C                     Z-ADDMBBSTA    DUASTA                          136935
     C                     Z-ADD0         MBBSTA                          136935
     C                     ENDIF                                          136935
      *
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MBBSTA    ZFLD15
     C                     MOVE NMDP2     ZDECS            New Security Decimal Places
     C                     MOVE 'L'       ZECODE
     C                     EXSR ZSEDIT
     C                     MOVE *BLANKS   SACSTK
     C                     MOVE ZOUT21    SACSTK
      *
      ***  Update Depot file SECODPL3 for New Security.
      *
     C           SVBSTA    IFNE MBBSTA                                    136935
     C           SVBSTR    ORNE MBBSTR                                    136935
     C           SVBCAR    ORNE MBBCAR                                    136935
     C                     MOVE 'A'       MBCHTP
     C                     MOVE SUSER     MBLUID
     C                     Z-ADDBJRDNB    MBLCD
     C                     ENDIF                                          136935
     C                     UPDATSECODPD0
      *                                                                   136935
      ***  If at least one Balancing Difference has been allocated to     136935
      ***  Dummy Customer, update record from SECOALL7 for New Security   136935
      ***  and Dummy Customer.                                            136935
      *                                                                   136935
     C           DUASTA    IFNE 0                                         136935
     C           DUASTR    ORNE 0                                         136935
     C           DUACAR    ORNE 0                                         136935
     C           SHCNUM    IFNE WDUMMY                                    136935
     C                     MOVE 'C'       WKCOTP                          136935
     C                     MOVE *BLANKS   WKBOOK                          136935
     C                     MOVE WDUMMY    WKCNUM                          136935
     C                     MOVE *BLANKS   WKPTFR                          136935
     C           WKEY4     CHAINSECOALL7             16                   136935
      *                                                                   136935
      ***  If record no longer on file, handle Database Error.            136935
      *                                                                   136935
     C           *IN16     IFEQ '1'                                       136935
     C           *LOCK     IN   LDA                                       136935
     C                     Z-ADD036       DBASE            ***************136935
     C                     MOVE 'SECOALL7'DBFILE           * DB ERROR 36 *136935
     C                     MOVELWKCORF    DBKEY1           ***************136935
     C                     MOVE WKOPTN    DBKEY1                          136935
     C                     MOVELWKBRCD    DBKEY2                          136935
     C                     MOVE WKDEPO    DBKEY2                          136935
     C                     MOVELDBKEY1    DBKEY3                          136935
     C                     MOVE DBKEY2    DBKEY3                          136935
     C                     MOVELDBKEY3    DBKEY4                          136935
     C                     MOVE WKSESN    DBKEY4                          136935
     C                     MOVELWKCOTP    DBKEY5                          136935
     C                     MOVE WKBOOK    DBKEY5                          136935
     C                     MOVELWKCNUM    DBKEY6                          136935
     C                     MOVE WKPTFR    DBKEY6                          136935
     C                     MOVELDBKEY5    DBKEY7                          136935
     C                     MOVE DBKEY6    DBKEY7                          136935
     C                     MOVELDBKEY4    DBKEY8                          136935
     C                     MOVE DBKEY7    DBKEY8                          136935
     C                     MOVELDBKEY8    DBKEY                           136935
     C                     MOVEL'SE7513'  DBPGM                           136935
     C                     OUT  LDA                                       136935
     C                     EXSR *PSSR                                     136935
     C                     ENDIF                                          136935
     C                     ADD  DUASTA    MCASTA                          136935
     C                     ADD  DUASTR    MCASTR                          136935
     C                     ADD  DUACAR    MCACAR                          136935
     C                     MOVE 'A'       MCCHTP                          136935
     C                     Z-ADDBJRDNB    MCLCD                           136935
     C                     MOVE SUSER     MCLUID                          136935
     C                     MOVE 'M'       MCREST                          136935
     C                     UPDATSECOALD0                                  136935
     C                     MOVE 'Y'       MDUMMY                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ELSE                                           136935
     C                     ADD  DUASTA    ASTADU                          136935
     C                     ADD  DUASTR    ASTRDU                          136935
     C                     ADD  DUACAR    ACARDU                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
      *
      ***  Access Depot file with CO Reference, Option Number, Branch,
      ***  Depot and Security '**CASH**'.
      *
     C                     MOVE PCORF     WKCORF
     C                     MOVE POPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C**********           Z-ADDPDEPO     WKDEPO                                              CSD027
     C                     MOVE PDEPO     WKDEPO                                              CSD027
     C                     MOVE *BLANKS   WKSESN
     C                     MOVEL'**CASH**'WKSESN
     C           WKEY1     CHAINSECODPL3             16
      *
      ***  If record not found, handle Database error.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECODPL3'DBFILE
     C                     MOVE WKOPTN    WWOPTN
     C                     MOVE WKDEPO    WWDEPO
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C                     MOVELDBKEY4    DBKEY            ***************
     C                     Z-ADD026       DBASE            * DB ERROR 26 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     Z-ADDMBBCAA    SVBCAA 150
      *                                                                   136935
     C                     Z-ADD0         DUACAA                          136935
     C                     Z-ADD0         DUACAR                          136935
     C                     Z-ADD0         DUASTA                          136935
     C                     Z-ADD0         DUASTR                          136935
      *
      ***  Recalculate Balancing Cash Allocation by subtracting old values and adding new values
      ***  of Actual Cash Rounding and Actual Cash Allocation, and update file.
      *
     C           AMACAR    IFEQ 'Y'
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDSHACAR    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C                     SUB  WUNUM     MBBCAA
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDWWACRO    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C******               ADD  WWNUM     MBBCAA                          136935
     C                     ADD  WUNUM     MBBCAA                          136935
     C                     ELSE
     C                     SUB  SHACAR    MBBCAA
     C                     ADD  WWACRO    MBBCAA
     C                     ENDIF
      *                                                                   136935
      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
      ***  reset it.                                                      136935
      *                                                                   136935
     C           MBBCAA    IFNE 0                                         136935
     C           PPROC     ANDEQ'CC'                                      136935
     C           MBBCAA    ORNE 0                                         136935
     C           PPROC     ANDNE'CC'                                      136935
     C           BVALDC    ANDEQ'Y'                                       136935
     C                     Z-SUBMBBCAA    DUACAR                          136935
     C                     Z-ADD0         MBBCAA                          136935
     C                     ENDIF                                          136935
     C                     ENDIF
     C           AMACAA    IFEQ 'Y'
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDSHACAA    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C                     SUB  WUNUM     MBBCAA
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDWWACAA    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C                     ADD  WUNUM     MBBCAA
     C                     ELSE
     C                     SUB  SHACAA    MBBCAA
     C                     ADD  WWACAA    MBBCAA
     C                     ENDIF
      *                                                                   136935
      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
      ***  reset it.                                                      136935
      *                                                                   136935
     C           MBBCAA    IFNE 0                                         136935
     C           PPROC     ANDEQ'CC'                                      136935
     C           MBBCAA    ORNE 0                                         136935
     C           PPROC     ANDNE'CC'                                      136935
     C           BVALDC    ANDEQ'Y'                                       136935
     C                     Z-SUBMBBCAA    DUACAA                          136935
     C                     Z-ADD0         MBBCAA                          136935
     C                     ENDIF                                          136935
     C                     ENDIF
     C           SVBCAA    IFNE MBBCAA
     C                     MOVE 'A'       MBCHTP
     C                     MOVE SUSER     MBLUID
     C                     Z-ADDBJRDNB    MBLCD
     C                     ENDIF
     C                     UPDATSECODPD0
      *                                                                   136935
      ***  If Balancing Difference has been allocated to Dummy Customer,  136935
      ***  update record from SECOALL7 for Security '**CASH**' and Dummy  136935
      ***  Customer                                                       136935
      *                                                                   136935
     C           DUACAA    IFNE 0                                         136935
     C           DUACAR    ORNE 0                                         136935
     C                     MOVE 'C'       WKCOTP                          136935
     C                     MOVE *BLANKS   WKBOOK                          136935
     C                     MOVE WDUMMY    WKCNUM                          136935
     C                     MOVE *BLANKS   WKPTFR                          136935
     C           WKEY4     CHAINSECOALL7             16                   136935
      *                                                                   136935
      ***  If record no longer on file, handle Database Error.            136935
      *                                                                   136935
     C           *IN16     IFEQ '1'                                       136935
     C           *LOCK     IN   LDA                                       136935
     C                     Z-ADD037       DBASE            ***************136935
     C                     MOVE 'SECOALL7'DBFILE           * DB ERROR 37 *136935
     C                     MOVELWKCORF    DBKEY1           ***************136935
     C                     MOVE WKOPTN    DBKEY1                          136935
     C                     MOVELWKBRCD    DBKEY2                          136935
     C                     MOVE WKDEPO    DBKEY2                          136935
     C                     MOVELDBKEY1    DBKEY3                          136935
     C                     MOVE DBKEY2    DBKEY3                          136935
     C                     MOVELDBKEY3    DBKEY4                          136935
     C                     MOVE WKSESN    DBKEY4                          136935
     C                     MOVELWKCOTP    DBKEY5                          136935
     C                     MOVE WKBOOK    DBKEY5                          136935
     C                     MOVELWKCNUM    DBKEY6                          136935
     C                     MOVE WKPTFR    DBKEY6                          136935
     C                     MOVELDBKEY5    DBKEY7                          136935
     C                     MOVE DBKEY6    DBKEY7                          136935
     C                     MOVELDBKEY4    DBKEY8                          136935
     C                     MOVE DBKEY7    DBKEY8                          136935
     C                     MOVELDBKEY8    DBKEY                           136935
     C                     MOVEL'SE7513'  DBPGM                           136935
     C                     OUT  LDA                                       136935
     C                     EXSR *PSSR                                     136935
     C                     ENDIF                                          136935
     C                     ADD  DUACAA    MCACAA                          136935
     C                     ADD  DUACAR    MCACAR                          136935
     C                     MOVE 'A'       MCCHTP                          136935
     C                     Z-ADDBJRDNB    MCLCD                           136935
     C                     MOVE SUSER     MCLUID                          136935
     C                     MOVE 'M'       MCREST                          136935
     C                     UPDATSECOALD0                                  136935
     C                     MOVE 'Y'       MDUMMY                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ENDIF                                          136935
      *                                                                   136935
      ***  Output new value for Balancing Cash Allocation on top line     136935
      ***  of screen.                                                     136935
      *                                                                   136935
     C                     MOVE *BLANKS   ZFLD15                          136935
     C                     MOVE MBBCAA    ZFLD15                          136935
     C           PPROC     IFEQ 'CR'                                      136935
     C                     MOVE NMDPC1    ZDECS            Ev.Ccy Dec.Pl. 136935
     C                     ELSE                                           136935
     C                     MOVE NMDPC2    ZDECS            New Ccy Dec.Pl.136935
     C                     ENDIF                                          136935
     C                     EXSR ZSEDIT                                    136935
     C                     MOVE *BLANKS   SCASH                           136935
     C                     MOVE ZOUT21    SCASH                           136935
      *
     C                     ELSE
      *
      ***  If Actual Cash Rounding has changed.
      *
     C           SACRO     IFNE SHACRO
      *
      ***  Access Allocation file with CO Reference, Option Number,
      ***  Branch, Depot, Security = '**CASH**', Cust/Book Ind.,
      ***  Book, Customer and Portfolio.
      *
     C                     MOVE PCORF     WKCORF
     C                     Z-ADDPOPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C                     MOVE PDEPO     WKDEPO
     C                     MOVE *BLANKS   WKSESN
     C                     MOVEL'**CASH**'WKSESN
     C                     MOVE SHCOTP    WKCOTP
     C                     MOVE SHBOOK    WKBOOK
     C**********           Z-ADDSHCNUM    WKCNUM                                              CSD027
     C                     MOVE SHCNUM    WKCNUM                                              CSD027
     C                     MOVE SHPORT    WKPTFR
     C           WKEY4     CHAINSECOALL7             16
      *
      ***  If record not found, handle Database error.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECOALL7'DBFILE
     C                     MOVE WKOPTN    WWOPTN
     C                     MOVE WKDEPO    WWDEPO
     C                     MOVE WKCNUM    WWCNUM
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C           WKCOTP    CAT  WKBOOK:0  DBKEY5  3
     C           WWCNUM    CAT  WKPORT:0  DBKEY6 10
     C           DBKEY5    CAT  DBKEY6:0  DBKEY7 13
     C           DBKEY4    CAT  DBKEY7:0  DBKEY8 40
     C                     MOVELDBKEY8    DBKEY            ***************
     C                     Z-ADD027       DBASE            * DB ERROR 27 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Recalculate Actual Cash Rounding by substract old value
      ***  and add new value of Actual Cash Rounding and update file.
      *
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDSHACAR    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C******               SUB  WUNUM     MBBCAA                          136935
     C                     SUB  WUNUM     MCACAR                          136935
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDWWACRO    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C******               ADD  WUNUM     MBBCAA                          136935
     C                     ADD  WUNUM     MCACAR                          136935
     C                     ELSE
     C                     SUB  SHACAR    MCACAR
     C                     ADD  WWACRO    MCACAR
     C                     ENDIF
      *
     C                     MOVE 'M'       MCREST
     C                     Z-ADDBJRDNB    MCLCD
     C                     MOVE 'A'       MCCHTP
     C                     MOVE SUSER     MCLUID
     C                     UPDATSECOALD0
      *
      ***  Access Depot file with CO Reference, Option Number, Branch,
      ***  Depot and New Security = '**CASH**'.
      *
     C                     MOVE PCORF     WKCORF
     C                     MOVE POPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C**********           Z-ADDPDEPO     WKDEPO                                              CSD027
     C                     MOVE PDEPO     WKDEPO                                              CSD027
     C                     MOVE *BLANKS   WKSESN
     C                     MOVEL'**CASH**'WKSESN
     C           WKEY1     CHAINSECODPL3             16
      *
      ***  If record not found, handle Database error.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECODPL3'DBFILE
     C                     MOVE WKOPTN    WWOPTN
     C                     MOVE WKDEPO    WWDEPO
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C                     MOVELDBKEY4    DBKEY            ***************
     C                     Z-ADD028       DBASE            * DB ERROR 28 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                   136935
     C                     Z-ADDMBBCAA    SVBCAA                          136935
     C                     Z-ADD0         DUACAA                          136935
     C                     Z-ADD0         DUACAR                          136935
     C                     Z-ADD0         DUASTA                          136935
     C                     Z-ADD0         DUASTR                          136935
      *
      ***  Recalculate Balancing Cash Allocation by subtracting old value and adding new value
      ***  of Actual Cash Rounding, and update record.
      *
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDSHACAR    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C                     SUB  WUNUM     MBBCAA
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDWWACRO    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDNMDPC1    WWNBDP           Event Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     EXSR ROUNDD
     C                     EXSR SETNDP
     C                     ADD  WUNUM     MBBCAA
     C                     ELSE
     C                     SUB  SHACAR    MBBCAA
     C                     ADD  WWACRO    MBBCAA
     C                     ENDIF
      *                                                                   136935
      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
      ***  reset it.                                                      136935
      *                                                                   136935
     C           MBBCAA    IFNE 0                                         136935
     C           PPROC     ANDEQ'CC'                                      136935
     C           MBBCAA    ORNE 0                                         136935
     C           PPROC     ANDNE'CC'                                      136935
     C           BVALDC    ANDEQ'Y'                                       136935
     C                     Z-SUBMBBCAA    DUACAR                          136935
     C                     Z-ADD0         MBBCAA                          136935
     C                     ENDIF                                          136935
      *
     C           SVBCAA    IFNE MBBCAA                                    136935
     C                     MOVE 'A'       MBCHTP
     C                     MOVE SUSER     MBLUID
     C                     Z-ADDBJRDNB    MBLCD
     C                     ENDIF                                          136935
     C                     UPDATSECODPD0
      *                                                                   136935
      ***  If Balancing Difference has been allocated to Dummy Customer,  136935
      ***  update record from SECOALL7 for Security '**CASH**' and Dummy  136935
      ***  Customer                                                       136935
      *                                                                   136935
     C           DUACAR    IFNE 0                                         136935
     C                     MOVE 'C'       WKCOTP                          136935
     C                     MOVE *BLANKS   WKBOOK                          136935
     C                     MOVE WDUMMY    WKCNUM                          136935
     C                     MOVE *BLANKS   WKPTFR                          136935
     C           WKEY4     CHAINSECOALL7             16                   136935
      *                                                                   136935
      ***  If record no longer on file, handle Database Error.            136935
      *                                                                   136935
     C           *IN16     IFEQ '1'                                       136935
     C           *LOCK     IN   LDA                                       136935
     C                     Z-ADD038       DBASE            ***************136935
     C                     MOVE 'SECOALL7'DBFILE           * DB ERROR 38 *136935
     C                     MOVELWKCORF    DBKEY1           ***************136935
     C                     MOVE WKOPTN    DBKEY1                          136935
     C                     MOVELWKBRCD    DBKEY2                          136935
     C                     MOVE WKDEPO    DBKEY2                          136935
     C                     MOVELDBKEY1    DBKEY3                          136935
     C                     MOVE DBKEY2    DBKEY3                          136935
     C                     MOVELDBKEY3    DBKEY4                          136935
     C                     MOVE WKSESN    DBKEY4                          136935
     C                     MOVELWKCOTP    DBKEY5                          136935
     C                     MOVE WKBOOK    DBKEY5                          136935
     C                     MOVELWKCNUM    DBKEY6                          136935
     C                     MOVE WKPTFR    DBKEY6                          136935
     C                     MOVELDBKEY5    DBKEY7                          136935
     C                     MOVE DBKEY6    DBKEY7                          136935
     C                     MOVELDBKEY4    DBKEY8                          136935
     C                     MOVE DBKEY7    DBKEY8                          136935
     C                     MOVELDBKEY8    DBKEY                           136935
     C                     MOVEL'SE7513'  DBPGM                           136935
     C                     OUT  LDA                                       136935
     C                     EXSR *PSSR                                     136935
     C                     ENDIF                                          136935
     C                     ADD  DUACAR    MCACAR                          136935
     C                     MOVE 'A'       MCCHTP                          136935
     C                     Z-ADDBJRDNB    MCLCD                           136935
     C                     MOVE SUSER     MCLUID                          136935
     C                     MOVE 'M'       MCREST                          136935
     C                     UPDATSECOALD0                                  136935
     C                     MOVE 'Y'       MDUMMY                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ENDIF                                          136935
      *                                                                   136935
      ***  Output new value for Balancing Cash Allocation on top line     136935
      ***  of screen.                                                     136935
      *                                                                   136935
     C                     MOVE *BLANKS   ZFLD15                          136935
     C                     MOVE MBBCAA    ZFLD15                          136935
     C           PPROC     IFEQ 'CR'                                      136935
     C                     MOVE NMDPC1    ZDECS            Ev.Ccy Dec.Pl. 136935
     C                     ELSE                                           136935
     C                     MOVE NMDPC2    ZDECS            New Ccy Dec.Pl.136935
     C                     ENDIF                                          136935
     C                     EXSR ZSEDIT                                    136935
     C                     MOVE *BLANKS   SCASH                           136935
     C                     MOVE ZOUT21    SCASH                           136935
      *
      ***  Access Depot file with CO Reference, Option Number, Branch,
      ***  Depot and New Security.
      *
     C                     MOVE PCORF     WKCORF
     C                     MOVE POPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C**********           Z-ADDPDEPO     WKDEPO                                              CSD027
     C                     MOVE PDEPO     WKDEPO                                              CSD027
     C                     MOVE PNWSEC    WKSESN
     C           WKEY1     CHAINSECODPL3             16
      *
      ***  If record not found, handle Database error.
      *
     C           *IN16     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECODPL3'DBFILE
     C                     MOVE WKOPTN    WWOPTN
     C                     MOVE WKDEPO    WWDEPO
     C           WKCORF    CAT  WWOPTN:0  DBKEY1  8
     C           WKBRCD    CAT  WWDEPO:0  DBKEY2  9
     C           DBKEY1    CAT  DBKEY2:0  DBKEY3 17
     C           DBKEY3    CAT  WKSESN:0  DBKEY4 27
     C                     MOVELDBKEY4    DBKEY            ***************
     C                     Z-ADD029       DBASE            * DB ERROR 29 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                   136935
     C                     Z-ADDMBBCAR    SVBCAR 150                      136935
     C                     Z-ADD0         DUACAA                          136935
     C                     Z-ADD0         DUACAR                          136935
     C                     Z-ADD0         DUASTA                          136935
     C                     Z-ADD0         DUASTR                          136935
      *
      ***  Recalculate Balancing Cash Rounding by adding old value and subtracting new value
      ***  of Actual Cash Rounding, and update record.
      *
     C                     ADD  SHACAR    MBBCAR
     C                     SUB  WWACRO    MBBCAR
      *                                                                   136935
      ***  If Balancing Difference recalculated not 0 and Processing Type 136935
      ***  = Currency Change or not Currency Change with ICD field 'Allo- 136935
      ***  cate Difference to Dummy' = 'Y', save Balancing Difference and 136935
      ***  reset it.                                                      136935
      *                                                                   136935
     C           MBBCAR    IFNE 0                                         136935
     C           PPROC     ANDEQ'CC'                                      136935
     C           MBBCAR    ORNE 0                                         136935
     C           PPROC     ANDNE'CC'                                      136935
     C           BVALDC    ANDEQ'Y'                                       136935
     C                     Z-ADDMBBCAR    DUACAR                          136935
     C                     Z-ADD0         MBBCAR                          136935
     C                     ENDIF                                          136935
      *
     C           SVBCAR    IFNE MBBCAR                                    136935
     C                     MOVE 'A'       MBCHTP
     C                     MOVE SUSER     MBLUID
     C                     Z-ADDBJRDNB    MBLCD
     C                     ENDIF                                          136935
     C                     UPDATSECODPD0
      *                                                                   136935
      ***  If Balancing Difference has been allocated to Dummy Customer,  136935
      ***  update record from SECOALL7 for New Security and Dummy         136935
      ***  Customer                                                       136935
      *                                                                   136935
     C           DUACAR    IFNE 0                                         136935
     C           SHCNUM    IFNE WDUMMY                                    136935
     C                     MOVE 'C'       WKCOTP                          136935
     C                     MOVE *BLANKS   WKBOOK                          136935
     C                     MOVE WDUMMY    WKCNUM                          136935
     C                     MOVE *BLANKS   WKPTFR                          136935
     C           WKEY4     CHAINSECOALL7             16                   136935
      *                                                                   136935
      ***  If record no longer on file, handle Database Error.            136935
      *                                                                   136935
     C           *IN16     IFEQ '1'                                       136935
     C           *LOCK     IN   LDA                                       136935
     C                     Z-ADD039       DBASE            ***************136935
     C                     MOVE 'SECOALL7'DBFILE           * DB ERROR 39 *136935
     C                     MOVELWKCORF    DBKEY1           ***************136935
     C                     MOVE WKOPTN    DBKEY1                          136935
     C                     MOVELWKBRCD    DBKEY2                          136935
     C                     MOVE WKDEPO    DBKEY2                          136935
     C                     MOVELDBKEY1    DBKEY3                          136935
     C                     MOVE DBKEY2    DBKEY3                          136935
     C                     MOVELDBKEY3    DBKEY4                          136935
     C                     MOVE WKSESN    DBKEY4                          136935
     C                     MOVELWKCOTP    DBKEY5                          136935
     C                     MOVE WKBOOK    DBKEY5                          136935
     C                     MOVELWKCNUM    DBKEY6                          136935
     C                     MOVE WKPTFR    DBKEY6                          136935
     C                     MOVELDBKEY5    DBKEY7                          136935
     C                     MOVE DBKEY6    DBKEY7                          136935
     C                     MOVELDBKEY4    DBKEY8                          136935
     C                     MOVE DBKEY7    DBKEY8                          136935
     C                     MOVELDBKEY8    DBKEY                           136935
     C                     MOVEL'SE7513'  DBPGM                           136935
     C                     OUT  LDA                                       136935
     C                     EXSR *PSSR                                     136935
     C                     ENDIF                                          136935
     C                     ADD  DUACAR    MCACAR                          136935
     C                     MOVE 'A'       MCCHTP                          136935
     C                     Z-ADDBJRDNB    MCLCD                           136935
     C                     MOVE SUSER     MCLUID                          136935
     C                     MOVE 'M'       MCREST                          136935
     C                     UPDATSECOALD0                                  136935
     C                     MOVE 'Y'       MDUMMY                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ELSE                                           136935
     C                     ADD  DUACAR    ACARDU                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
      *
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  CHACAL - Check if Actual Allocation fields can be            *
      *           recalculated.                                       *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           CHACAL    BEGSR                           ** CHACAL SR **
      *
      ***  If Processing Type = 'NF': Non Financial Events or 'NC': Name Changes,
      ***  set-up special work field to 'N', it means the Actual Allocation fields must not be
      ***  calculated, else set-up this work field to 'Y'.
      *
     C           PPROC     IFEQ 'NF'                       Non Financial Events
     C           PPROC     OREQ 'NC'                       Name Changes
     C                     MOVE 'N'       SPWRKF  1
     C                     ELSE
     C                     MOVE 'Y'       SPWRKF
     C                     ENDIF
      *
      ***  Reset work fields.
      *
     C                     Z-ADD0         WCAPR   52       Cash %
     C                     MOVE ' '       OPTNAA  1        Option for Actual Allocation
      *
      ***  Retreive Customer/Book Current Reply and Standard Instruction.
      *
     C                     EXSR RTVRPL
      *
      ***  If Processing Type not Non Financial Events, not Name Changes, not Currency Changes
      ***  and Corporate Actions Type for Multiple Options (= with Number of Options retrieve
      ***  CO References file is > 1).
      *
     C           PPROC     IFNE 'NF'                       If not Non Financial Events
     C           PPROC     ANDNE'NC'                          not Name Changes
     C           PPROC     ANDNE'CC'                          not Currency Changes
     C           MANBOP    ANDGT1                             for Multiple Options
      *
      ***  If Customer/Book Current Reply and Standard Instruction does not exist.
      *
     C           EXBCRE    IFNE 'Y'
     C           EXBCSI    ANDNE'Y'
      *
      ***  If Default for No Reply from SECORFL1 is blank:
      ***  Actual Allocations must not be calculated and must be set to zeros. So set the Special
      ***  work field to 'N'.
      *
     C           MADFNR    IFEQ *BLANKS
     C                     MOVE 'N'       SPWRKF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Processing Type = Non Financial Events and Customer/Book Current Reply exists,
      ***  set Cash % to Reply Cash % Level 2.
      *
     C           PPROC     IFEQ 'NF'
     C           EXBCRE    ANDEQ'Y'
     C                     Z-ADDMQR2CA    WCAPR
     C                     ENDIF
      *
      ***  If Processing Type = Dividends Events, Rights Issues, Offers or Exercices and
      ***  Conversions.
      *
     C           PPROC     IFEQ 'DV'                       Dividend Events
     C           PPROC     OREQ 'RG'                       Rights Issues
     C           PPROC     OREQ 'OF'                       Offers
     C           PPROC     OREQ 'EX'                       Exercice and Conversion
      *
      ***  CASE 1: If Customer/Booh Current Reply exists.
      *
     C           EXBCRE    IFEQ 'Y'
      *
      ***  Set Option for Actual Allocation to Reply Option Level 2.
      *
     C                     MOVE MQR2RE    OPTNAA
      *
      ***  If Processing Type = Dividend Events.
      *
     C           PPROC     IFEQ 'DV'
      *
      ***  If Option 1 selected: Cash Payment/Sell Rights, set Cash % to 100.
      *
     C           OPTNAA    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option selected is 2: Take Stock+Buy Additional Rights or 3: Take Stock+Sell Excess
      ***  Rights or 4: Take Stock, set Cash % to 0.
      *
     C           OPTNAA    IFEQ '2'
     C           OPTNAA    OREQ '3'
     C           OPTNAA    OREQ '4'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  If Option 5 selected: Take Part Cash/Rest Stock, set Cash % to Reply Cash % Level 2.
      *
     C           OPTNAA    IFEQ '5'
     C                     Z-ADDMQR2CA    WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      ******                                                              135690
      ***  If Processing Type = Rights Issues.                            135690
      ******                                                              135690
     C******     PPROC     IFEQ 'RG'                                      135690
      ******                                                              135690
      ***  If Option 1 selected: Sell all Rights, set Cash % to 100.      135690
      ******                                                              135690
     C******     OPTNAA    IFEQ '1'                                       135690
     C******               Z-ADD100       WCAPR                           135690
     C******               ELSE                                           135690
      ******                                                              135690
      *****If*Option*selected*is*5:*Take*Part*Cash/Rest*Stock*or*6:*Take* 135690
      *****Part*Cash/Keep*Stock,*set*Cash*%*to*Reply*Cash*%*Level*2.***** 135690
      ******                                                              135690
     C******     OPTNAA    IFEQ '5'                                       135690
     C******     OPTNAA    OREQ '6'                                       135690
     C******               Z-ADDMQR2CA    WCAPR                           135690
     C******               ELSE                                           135690
      ******                                                              135690
      *****If*Option*selected*is*2:*Take*Stock+Buy*Fraction*or*3:*Take*** 135690
      *****Stock+Sell*Fraction*or*4:*Take*Stock*or*7:*Do*nothing,*set**** 135690
      *****Cash*%*to*0.************************************************** 135690
      ******                                                              135690
     C******     OPTNAA    IFEQ '2'                                       135690
     C******     OPTNAA    OREQ '3'                                       135690
     C******     OPTNAA    OREQ '4'                                       135690
     C******     OPTNAA    OREQ '7'                                       135690
     C******               Z-ADD0         WCAPR                           135690
     C******               ENDIF                                          135690
     C******               ENDIF                                          135690
     C******               ENDIF                                          135690
     C******               ELSE                                           135690
      *
      ***  If Processing Type = Offers.
      *
     C           PPROC     IFEQ 'OF'
      *
      ***  If Option 1 selected: Accept Offer, set Cash % to 100.
      *
     C           OPTNAA    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option 2 selected: Refuse Offer, set Cash % to 0.
      *
     C           OPTNAA    IFEQ '2'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  If Option 3 selected: Partial Accept Offer, set Cash % to Reply Cash % Level 2.
      *
     C           OPTNAA    IFEQ '3'
     C                     Z-ADDMQR2CA    WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Processing Type = Exercices and Conversions.
      *
     C           PPROC     IFEQ 'EX'
      *
      ***  If Option 1 selected: Sell all Rights, set Cash % to 100.
      *
     C           OPTNAA    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      *****If*Option*selected*is*5:*Take Part*Cash/Rest*Stock*or*6:*Take P161732
      ***  If Option selected is 5: Take Part Cash/Rest Stock             161732
      ***  set Cash % to Reply Cash % Level 2.
      *
     C           OPTNAA    IFEQ '5'
     C***********OPTNAA    OREQ '6'                                       161732
     C                     Z-ADDMQR2CA    WCAPR
     C                     ELSE
      *
      ***  If Option selected is 2: Take Stock+Buy Fraction or 3: Take Stock+Sell Fraction or 4:
      ***  Take Stock or 6:Take Part Stock/Keep Rest,                     161732
      ***  or 7: Do nothing, set Cash % to 0.                             161732
      *****Take*Stock*or*7:*Do*nothing,*set*Cash*%*to*0.                  161732
      *
     C           OPTNAA    IFEQ '2'
     C           OPTNAA    OREQ '3'
     C           OPTNAA    OREQ '4'
     C           OPTNAA    OREQ '6'                                       161732
     C           OPTNAA    OREQ '7'
     C                     Z-ADD0         WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  CASE 2: Else, if Customer/Book Current Reply does not exist.
      *
     C                     ELSE
      *
      ***  Set Option for Actual Allocation to Default for No Reply from SECOxxL1
      ***  (where xx = 'DV', 'RG', 'EX' or 'OF').
      *
     C                     MOVE MDDFNR    OPTNAA
      *
      ***  CASE 2.1: If Customer/Book Standard Corporate Actions Instruction exists (and Customer/
      ***            Book Current Reply does not exist).
      *
     C           EXBCSI    IFEQ 'Y'
      *
      ***  If Processing Type not Rights Issues.                          135690
      ***  Set Cash % to Cash Preferred % from SECOSIL1.
      *
     C           MAPTYP    IFNE 'RG'                                      135690
     C                     Z-ADDMOCAPP    WCAPR
     C                     ENDIF                                          135690
      *
      ***  If Processing Type = Dividend Events.
      *
     C           PPROC     IFEQ 'DV'
      *
      ***  If Stock Dividend Type = Stock for Stock or Combined for Cash and Stock, set Cash % to 0.
      *
     C           MDSDIT    IFEQ 'S'                        Stock for Stock
     C           MDSDIT    OREQ 'C'                        Combined for Cash and Stock
     C                     Z-ADD0         WCAPR
     C                     ENDIF
      *
      ***  If Cash % is < 50.
      *
     C           WCAPR     IFLT 50
      *
      ***  If Option 5 not allowed, set Cash % to 0.
      *
     C           MDOPT5    IFNE 'Y'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  If Option 5 allowed and Cash % not 0, default Option for Actual allocation is '5'
      ***  (Cash % already = Cash Preferred % from Standard Instruction (SECOSIL1)).
      *
     C           WCAPR     IFNE 0
     C                     MOVE '5'       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      *****If*Cash*%*>*50.*********************************************** 135690
      ***  Else, if Cash % > or = 50.                                     135690
      *
     C******     WCAPR     IFGT 50                                        135690
      *
      ***  If Option 5 not allowed, set Cash % to 100.
      *
     C           MDOPT5    IFNE 'Y'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option 5 allowed and Cash % not 100, default Option for Actual allocation is '5'
      ***  (Cash % already = Cash Preferred % from Standard Instruction (SECOSIL1)).
      *
     C           WCAPR     IFNE 100
     C                     MOVE '5'       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  If Cash % is 0 (means it is Stock Preferred).
      *
     C           WCAPR     IFEQ 0
      *
      ***  If Rounding Option from SECOSIL1 = 'U' and Option 2 is allowed, default Option for
      ***  Actual Allocation is '2' (Cash % is already 0).
      *
     C           MOROOP    IFEQ 'U'
     C           MDOPT2    IFEQ 'Y'
     C                     MOVE '2'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Option 2 is not allowed and Option 4 is allowed, default
      ***  Option for Actual Allocation is '4' (Cash % is already 0).
      *
     C           MDOPT4    IFEQ 'Y'
     C                     MOVE '4'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Options 2 and 4 are not allowed and Option 3 is allowed,
      ***  default Option for Actual Allocation is '3' (Cash % is already 0).
      *
     C           MDOPT3    IFEQ 'Y'
     C                     MOVE '3'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Options 2, 4 and 3 are not allowed and Option 5 is allowed,
      ***  default Option for Actual Allocation is '5' and Set Cash % to Cash Preferred % from
      ***  Standard Instruction (SECOSIL1).
      *
     C           MDOPT5    IFEQ 'Y'
     C                     MOVE '5'       OPTNAA
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Options 2, 4, 3 and 5 are not allowed and Option 1 is
      ***  allowed, default Option for Actual Allocation is '1' and Set Cash % to 100.
      *
     C           MDOPT1    IFEQ 'Y'
     C                     MOVE '1'       OPTNAA
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Options 2, 4, 3, 5 and 1 are not allowed, default
      ***  Option for Actual Allocation is blank.
      *
     C                     MOVE ' '       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Rounding Option from SECOSIL1 = 'D' and Option 3 is allowed, default Option for
      ***  Actual Allocation is '3' (Cash % is already 0).
      *
     C           MOROOP    IFEQ 'D'
     C           MDOPT3    IFEQ 'Y'
     C                     MOVE '3'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Option 3 is not allowed and Option 4 is allowed, default
      ***  Option for Actual Allocation is '4' (Cash % is already 0).
      *
     C           MDOPT4    IFEQ 'Y'
     C                     MOVE '4'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Options 3 and 4 are not allowed and Option 2 is allowed,
      ***  default Option for Actual Allocation is '2' (Cash % is already 0).
      *
     C           MDOPT2    IFEQ 'Y'
     C                     MOVE '2'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Options 3, 4 and 2 are not allowed and Option 5 is allowed,
      ***  default Option for Actual Allocation is '5' and Set Cash % to Cash Preferred % from
      ***  Standard Instruction (SECOSIL1).
      *
     C           MDOPT5    IFEQ 'Y'
     C                     MOVE '5'       OPTNAA
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Options 3, 4, 2 and 5 are not allowed and Option 1 is
      ***  allowed, default Option for Actual Allocation is '1' and Set Cash % to 100.
      *
     C           MDOPT1    IFEQ 'Y'
     C                     MOVE '1'       OPTNAA
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Options 3, 4, 2, 5 and 1 are not allowed, default
      ***  Option for Actual Allocation is blank.
      *
     C                     MOVE ' '       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Cash % is 100 (means it is Cash Preferred).
      *
     C           WCAPR     IFEQ 100
      *
      ***  If Option 1 allowed, default Option for Actual Allocation is '1' (Cash % is already
      ***  100).
      *
     C           MDOPT1    IFEQ 'Y'
     C                     MOVE '1'       OPTNAA
     C                     ELSE
      *
      ***  If Option 1 not allowed and Option 5 allowed, default Option for Actual Allocation is
      ***  '5' and set Cash % to Cash Preferred % from Standard Instruction (SECOSIL1).
      *
     C           MDOPT5    IFEQ 'Y'
     C                     MOVE '5'       OPTNAA
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Option 1 and 5 not allowed, set Cash % to 0.
      *
     C                     Z-ADD0         WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Processing Type = Offers.
      *
     C           PPROC     IFEQ 'OF'
      *
      ***  If % Accepted is < 50.
      *
     C           WCAPR     IFLT 50
      *
      ***  If Option 3 is not allowed, default as per % Accepted is 0.
      *
     C           MIOPT3    IFNE 'Y'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  If Option 3 is allowed and % Accepted is not 0, default Option for Actual Allocation is
      ***  '3' (% Accepted already = Cash Preferred % from Standard Instruction (SECOSIL1)).
      *
     C           WCAPR     IFNE 0
     C                     MOVE '2'       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      *****If*Cash*%*>*50.*********************************************** 135690
      ***  Else, if Cash % > or = 50.                                     135690
      *
     C******     WCAPR     IFGT 50                                        135690
      *
      ***  If Option 3 is not allowed (and % Accepted is > 50), default as per % Accepted is 100.
      *
     C           MIOPT3    IFNE 'Y'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option 3 is allowed and % Accepted is not 100, default Option for Actual Allocation
      ***  is '3' (% Accepted already = Cash Preferred % from Standard Instruction (SECOSIL1)).
      *
     C           WCAPR     IFNE 100
     C                     MOVE '3'       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  If % Accepted is 0 (means it is refused).
      *
     C           WCAPR     IFEQ 0
      *
      ***  If Option 2 allowed, default Option for Actual Allocation is '2' (% Accepted is
      ***  already 0).
      *
     C           MIOPT2    IFEQ 'Y'
     C                     MOVE '2'       OPTNAA
     C                     ELSE
      *
      ***  If Option 2 is not allowed and Option 3 is allowed, default Option for Actual Allocation
      ***  is '3' and set % Accepted to Cash Preferred % from Standard Instruction (SECOSIL1).
      *
     C           MIOPT3    IFEQ 'Y'
     C                     MOVE '3'       OPTNAA
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Option 2 and 3 are not allowed and Option 1 is allowed, default Option for Actual
      ***   Allocation is '1' and set % Accepted to 100.
      *
     C           MIOPT1    IFEQ 'Y'
     C                     MOVE '1'       OPTNAA
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option 2, 3 and 1 are not allowed, default Option for Actual Allocation is blank.
      *
     C                     MOVE ' '       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If % Accepted is 100 (means it is Cash Preferred).
      *
     C           WCAPR     IFEQ 100
      *
      ***  If Option 1 is allowed, default Option for Actual Allocation is '1' (% Accepted is
      ***  already 100).
      *
     C           MIOPT1    IFEQ 'Y'
     C                     MOVE '1'       OPTNAA
     C                     ELSE
      *
      ***  If Option 1 is not allowed and Option 3 is allowed, default Option for Actual Allocation
      ***  is '3' and set % Accepted to Cash Preferred % from Standard Instruction (SECOSIL1).
      *
     C           MIOPT3    IFEQ 'Y'
     C                     MOVE '3'       OPTNAA
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Option 1 and 3 are not allowed and Option 2 is allowed, default Option for Actual
      ***  Allocation is '2' and set % Accepted to 0.
      *
     C           MIOPT2    IFEQ 'Y'
     C                     MOVE '2'       OPTNAA
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  If Option 1, 3 and 2 are not allowed, default Option for Actual Allocation is blank.
      *
     C                     MOVE ' '       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      *****If*Processing*Type*=*Rights*Issues*or*Exercices*and*********** 135690
      *****Conversions.************************************************** 135690
      ***  If Processing Type = Exercices and Conversions.                135690
      *
     C******     PPROC     IFEQ 'RG'                                      135690
     C******     PPROC     OREQ 'EX'                                      135690
     C           PPROC     IFEQ 'EX'                                      135690
      *
      ***  Set Customer Options 1, 2, 3, 4, 5, 6 and 7, depending on Processing Type.
      *
     C******     PPROC     IFEQ 'RG'                                      135690
     C******               MOVE MFOPT1    WUOPT1  1                       135690
     C******               MOVE MFOPT2    WUOPT2  1                       135690
     C******               MOVE MFOPT3    WUOPT3  1                       135690
     C******               MOVE MFOPT4    WUOPT4  1                       135690
     C******               MOVE MFOPT5    WUOPT5  1                       135690
     C******               MOVE MFOPT6    WUOPT6  1                       135690
     C******               MOVE MFOPT7    WUOPT7  1                       135690
     C******               ELSE                                           135690
     C******               MOVE MJOPT1    WUOPT1                          135690
     C******               MOVE MJOPT2    WUOPT2                          135690
     C******               MOVE MJOPT3    WUOPT3                          135690
     C******               MOVE MJOPT4    WUOPT4                          135690
     C******               MOVE MJOPT5    WUOPT5                          135690
     C******               MOVE MJOPT6    WUOPT6                          135690
     C******               MOVE MJOPT7    WUOPT7                          135690
     C                     MOVE MJOPT1    WUOPT1  1                       135690
     C                     MOVE MJOPT2    WUOPT2  1                       135690
     C                     MOVE MJOPT3    WUOPT3  1                       135690
     C                     MOVE MJOPT4    WUOPT4  1                       135690
     C                     MOVE MJOPT5    WUOPT5  1                       135690
     C                     MOVE MJOPT6    WUOPT6  1                       135690
     C                     MOVE MJOPT7    WUOPT7  1                       135690
     C******               ENDIF                                          135690
      *
      ***  If Cash % is < 50.
      *
     C           WCAPR     IFLT 50
      *
      *****If*Option*5*and*6*are*not*allowed,*default*as*per*Cash*%*is*0. 161732
      ** If Option 5 is not allowed, set Cash % to 0.                     161732
      *
     C           WUOPT5    IFNE 'Y'
     C***********WUOPT6    ANDNE'Y'                                       161732
     C                     Z-ADD0         WCAPR
     C                     ENDIF
      *
      *****If*Option*5*and*6*are*allowed*and*Cash*%*is*not*0.             161732
      ** If Cash % is not 0, and either Option 5 or 6 is allowed:         161732
      *
     C           WUOPT5    IFEQ 'Y'
     C           WCAPR     ANDNE0                                         161732
     C***********WUOPT6    ANDEQ'Y'                                       161732
     C           WUOPT6    OREQ 'Y'                                       161732
     C           WCAPR     ANDNE0
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1) is 'C', default
      ***  Option for Actual Allocation is '5' (Cash % already = Cash Preferred % from Standard
      ***  Instruction (SECOSIL1)).
      *
     C           MOCKIN    IFEQ 'C'
     C                     MOVE '5'       OPTNAA
     C                     ENDIF
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1) is 'K', default
      ***  Option for Actual Allocation is '6' (Cash % already = Cash Preferred % from Standard
      ***  Instruction (SECOSIL1)).
      *
     C           MOCKIN    IFEQ 'K'
     C                     MOVE '6'       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      *****If*Cash*%*>*50.*********************************************** 135690
      ***  Else, if Cash % > or = 50.                                     135690
      *
     C******     WCAPR     IFGT 50                                        135690
      *
      *****If*Option*5*and*6*are*not*allowed,*default*as*per*Cash*%*is*100161732
      ** If Option 5 is not allowed, set Cash % to 100.                   161732
      *
     C           WUOPT5    IFNE 'Y'
     C***********WUOPT6    ANDNE'Y'                                       161732
     C                     Z-ADD100       WCAPR
     C                     ENDIF
      *
      *****If*Option*5*and*6*are*allowed*and*Cash*%*is*not*0.             161732
      ** If Cash % is not 100, and either Option 5 or 6 is allowed:       161732
      *
     C           WUOPT5    IFEQ 'Y'
     C           WCAPR     ANDNE100                                       161732
     C***********WUOPT6    ANDEQ'Y'                                       161732
     C           WUOPT6    OREQ 'Y'                                       161732
     C           WCAPR     ANDNE100
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1) is 'C', default
      ***  Option for Actual Allocation is '5' (Cash % already = Cash Preferred % from Standard
      ***  Instruction (SECOSIL1)).
      *
     C           MOCKIN    IFEQ 'C'
     C                     MOVE '5'       OPTNAA
     C                     ENDIF
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1) is 'K', default
      ***  Option for Actual Allocation is '6' (Cash % already = Cash Preferred % from Standard
      ***  Instruction (SECOSIL1)).
      *
     C           MOCKIN    IFEQ 'K'
     C                     MOVE '6'       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  If Cash % is 0 (means it is Stock Preferred).
      *
     C           WCAPR     IFEQ 0
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1) is 'K'
      *
     C           MOCKIN    IFEQ 'K'
      *
      ***  If Option 7 is allowed, default Option for Actual Allocation is '7' (Cash % already
      ***  = 0).
      *
     C           WUOPT7    IFEQ 'Y'
     C                     MOVE '7'       OPTNAA
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1) is 'C'
      *
     C           MOCKIN    IFEQ 'C'
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'U'.
      *
     C           MOROOP    IFEQ 'U'
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'U' and Option 2 is allowed,
      ***  default Option for Actual Allocation is '2' (Cash % already = 0).
      *
     C           WUOPT2    IFEQ 'Y'
     C                     MOVE '2'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'U' and Option 2 is not
      ***  allowed and Option 4 is allowed, default Option for Actual Allocation is '4'
      ***  (Cash % already = 0).
      *
     C           WUOPT4    IFEQ 'Y'
     C                     MOVE '4'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'U' and Options 2 and 4 are
      ***  not allowed and Option 3 is allowed, default Option for Actual Allocation is '3'
      ***  (Cash % already = 0).
      *
     C           WUOPT3    IFEQ 'Y'
     C                     MOVE '3'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'U' and Options 2, 4 and 3 are
      ***  not allowed and Option 5 is allowed, default Option for Actual Allocation is '5' and
      ***  set Cash % to Cash Preferred % from Standard Instruction (SECOSIL1).
      *
     C           WUOPT5    IFEQ 'Y'
     C                     MOVE '5'       OPTNAA
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'U' and Options 2, 4, 3 and 5
      ***  are not allowed and Option 1 is allowed, default Option for Actual Allocation is '1'
      ***  and set Cash % to 100.
      *
     C           WUOPT1    IFEQ 'Y'
     C                     MOVE '1'       OPTNAA
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'U' and Options 2, 4, 3, 5
      ***  and 1 are not allowed, default Option for Actual Allocation is blank.
      *
     C                     MOVE ' '       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'D'.
      *
     C           MOROOP    IFEQ 'D'
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'D' and Option 3 is allowed,
      ***  default Option for Actual Allocation is '3' (Cash % already = 0).
      *
     C           WUOPT3    IFEQ 'Y'
     C                     MOVE '3'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'D' and Option 3 is not
      ***  allowed and Option 4 is allowed, default Option for Actual Allocation is '4' (Cash %
      ***  already = 0).
      *
     C           WUOPT4    IFEQ 'Y'
     C                     MOVE '4'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'D' and Options 3 and 4 are
      ***  not allowed and Option 2 is allowed, default Option for Actual Allocation is '2' (Cash %
      ***  already = 0).
      *
     C           WUOPT2    IFEQ 'Y'
     C                     MOVE '2'       OPTNAA
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'D' and Options 3, 4 and 2 are
      ***  not allowed and Option 5 is allowed, default Option for Actual Allocation is '5' and set
      ***  Cash % to Cash Preferred % from Standard Instruction (SECOSIL1).
      *
     C           WUOPT5    IFEQ 'Y'
     C                     MOVE '5'       OPTNAA
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'D' and Options 3, 4, 2 and 5
      ***  are not allowed and Option 1 is allowed, default Option for Actual Allocation is '1' and
      ***  set Cash % to 100.
      *
     C           WUOPT1    IFEQ 'Y'
     C                     MOVE '1'       OPTNAA
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1) is 'D' and Options 3, 4, 2, 5 and
      ***  1 are not allowed, default Option for Actual Allocation is blank.
      *
     C                     MOVE ' '       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Cash % is 100 (means it is Cash Preferred).
      *
     C           WCAPR     IFEQ 100
      *
      ***  If Option 1 is allowed, default Option for Actual Allocation is '1' (Cash % already
      ***  = 100).
      *
     C           WUOPT1    IFEQ 'Y'
     C                     MOVE '1'       OPTNAA
     C                     ELSE
      *
      ***  If Option 1 is not allowed, default as per Cash % is 0.
      *
     C                     Z-ADD0         WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  CASE 2.2: IF Customer/Book Standard Corporate Action Instruction does not exist
      ***               (and Customer/Book Current Reply does not exist),
      ***            OR if Customer/Book Standard Corporate Action Instruction exist BUT default
      ***               Option (Option for Actual Allocation calculated in CASE 2.1 or retrieve
      ***               from Standard Instruction (SECOSIL1) in CASE 2) is blank (and Customer/Book
      ***               Current Reply does not exist).
      *
     C           EXBCSI    IFEQ 'N'
     C           EXBCSI    OREQ 'Y'
     C           OPTNAA    ANDEQ' '
      *
      ***  Set Option for Actual Allocation 2 to Default for No Reply from Corporate Actions
      ***  Detail (SECOxxL1, where xx = 'DV', 'RG', 'OF' or 'EX')
      *
     C                     MOVE MDDFNR    OPTNAA
      *
      ***  If Processing Type = Dividend Events.
      *
     C           PPROC     IFEQ 'DV'
      *
      ***  If Option 1 selected: Cash Payment/Sell Rights, set Cash % to 100.
      *
     C           OPTNAA    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option selected is 2: Take Stock+Buy Additional Rights or 3: Take Stock+Sell Excess
      ***  Rights or 4: Take Stock, set Cash % to 0.
      *
     C           OPTNAA    IFEQ '2'
     C           OPTNAA    OREQ '3'
     C           OPTNAA    OREQ '4'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  Else, Default No Reply will not be an Option which requires the entry of the %).
      *
     C                     MOVE ' '       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      ******                                                              135690
      *****If*Processing*Type*=*Rights*Issues.*************************** 135690
      ******                                                              135690
     C******     PPROC     IFEQ 'RG'                                      135690
      ******                                                              135690
      *****If*Option*1*selected:*Sell*all*Rights,*set*Cash*%*to*100.***** 135690
      ******                                                              135690
     C******     OPTNAA    IFEQ '1'                                       135690
     C******               Z-ADD100       WCAPR                           135690
     C******               ELSE                                           135690
      ******                                                              135690
      *****If*Option*selected*is*2:*Take*Stock+Buy*Fraction*or*3:*Take*** 135690
      *****Stock+Sell*Fraction*or*4:*Take*Stock*or*7:*Do*nothing,*set**** 135690
      *****Cash*%*to*0.************************************************** 135690
      ******                                                              135690
     C******     OPTNAA    IFEQ '2'                                       135690
     C******     OPTNAA    OREQ '3'                                       135690
     C******     OPTNAA    OREQ '4'                                       135690
     C******     OPTNAA    OREQ '7'                                       135690
     C******               Z-ADD0         WCAPR                           135690
     C******               ELSE                                           135690
      ******                                                              135690
      *****Else,*Default*No*Reply*will*not*be*an*Option*which*requires*** 135690
      *****the*entry*of*the*%).****************************************** 135690
      ******                                                              135690
     C******               MOVE ' '       OPTNAA                          135690
     C******               ENDIF                                          135690
     C******               ENDIF                                          135690
     C******               ELSE                                           135690
      *
      ***  If Processing Type = Offers.
      *
     C           PPROC     IFEQ 'OF'
      *
      ***  If Option 1 selected: Accept Offer, set Cash % to 100.
      *
     C           OPTNAA    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option 2 selected: Refuse Offer, set Cash % to 0.
      *
     C           OPTNAA    IFEQ '2'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  Else, Default No Reply will not be an Option which requires the entry of the %).
      *
     C                     MOVE ' '       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Processing Type = Exercices and Conversions.
      *
     C           PPROC     IFEQ 'EX'
      *
      ***  If Option 1 selected: Sell all Rights, set Cash % to 100.
      *
     C           OPTNAA    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option selected is 2: Take Stock+Buy Fraction or 3: Take Stock+Sell Fraction or 4:
      ***  Take Stock or 7: Do nothing, set Cash % to 0.
      *
     C           OPTNAA    IFEQ '2'
     C           OPTNAA    OREQ '3'
     C           OPTNAA    OREQ '4'
     C           OPTNAA    OREQ '7'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  Else, Default No Reply will not be an Option which requires the entry of the %).
      *
     C                     MOVE ' '       OPTNAA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  If Option not selected, set Cash % to 0 and 'Special Work Field' to 'N', it means that
      ***  the Actual Allocation fields must not be calculated.
      *
     C           OPTNAA    IFEQ ' '
     C                     Z-ADD0         WCAPR
     C                     MOVE 'N'       SPWRKF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  RTVRPL - Retrieve Customer/Book Current Reply and Customer/  *
      *           Book Standard Corporate Action Instruction.         *
      *                                                               *
      *  Called by:                                                   *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           RTVRPL    BEGSR                           ** RTVRPL SR **
      *
      ***  Set 'Customer/Book Current Reply Exists' work field to 'N'.
      *
     C                     MOVE 'N'       EXBCRE  1        Current Reply exist
      *
      ***  Retrieve current Reply with CO Reference, Branch, Customer/Book Indicator, Book and
      ***  Customer.
      *
     C                     MOVE PCORF     WKCORF
     C                     MOVE PBRCD     WKBRCD
     C                     MOVE SHCOTP    WKCOTP
     C                     MOVE SHBOOK    WKBOOK
     C                     MOVE SHCNUM    WKCNUM
     C           WKEY6     SETGTSECOREL1
     C           WKEY6     REDPESECOREL1                 82
      *
      ***  If record found and live.
      *
     C           *IN82     IFEQ '0'                        Found
     C           MQRECI    ANDEQ'D'                        Live
      *
      ***  Set 'Customer/Book Current Reply Exists' work field to 'Y'.
      *
     C                     MOVE 'Y'       EXBCRE
     C                     ENDIF
      *
      ***  Set 'Customer/Book Standard CO Instruction Exists' work field to 'N'.
      *
     C                     MOVE 'N'       EXBCSI  1        Standard Instruction exist
      *
      ***  If Book Calculation.
      *
     C           SHCOTP    IFEQ 'B'
      *
      ***  Retrieve the Standard Instructions for Books by accessing LF/SECOSIL2 with Branch
      ***  Book, Corporate Action Type and New Security.
      *
     C                     MOVE SHBOOK    WKBOOK
     C                     MOVE PACT      WKCOAT
     C                     MOVE PNWSEC    WKNSEC
     C           WKEY7     SETGTSECOSIL2
     C           WKEY7     REDPESECOSIL2                 83
      *
      ***  If no record found, access with Branch, Book, Corporate Action Type and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   WKNSEC
     C           WKEY7     SETGTSECOSIL2
     C           WKEY7     REDPESECOSIL2                 83
      *
      ***  If no record found, access with Branch, Book and Corporate Action Type and Security
      ***  = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   WKCOAT
     C           WKEY7     SETGTSECOSIL2
     C           WKEY7     REDPESECOSIL2                 83
      *
      ***  If no record found, access with Branch and Book, Corporate Action Type and Security
      ***  = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   WKBOOK
     C           WKEY7     SETGTSECOSIL2
     C           WKEY7     REDPESECOSIL2                 83
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Customer Calculation.
      *
     C                     ELSE
      *
      ***  Retrieve the Standard Instructions for Customer by accessing LF/SECOSIL1 with Branch,
      ***  Customer, Portfolio Reference, Corporate Action Type and Security.
      *
     C**********           Z-ADDSHCNUM    WKCNUM                                              CSD027
     C                     MOVE SHCNUM    WKCNUM                                              CSD027
     C                     MOVE SHPORT    WKPORT
     C                     MOVE PACT      WKCOAT
     C                     MOVE PNWSEC    WKNSEC
     C           WKEY8     SETGTSECOSIL1
     C           WKEY8     REDPESECOSIL1                 83
      *
      ***  If no record found, access with Branch, Customer, Portfolio Reference and Corporate
      ***  Action Type and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   WKNSEC
     C           WKEY8     SETGTSECOSIL1
     C           WKEY8     REDPESECOSIL1                 83
      *
      ***  If no record found, access with Branch, Customer and Portfolio Reference and Corporate
      ***  Action Type and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   WKCOAT
     C           WKEY8     SETGTSECOSIL1
     C           WKEY8     REDPESECOSIL1                 83
      *
      ***  If no record found, access with Branch and  Customer and Portfolio Reference, Corporate
      ***  Action Type and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   WKPORT
     C           WKEY8     SETGTSECOSIL1
     C           WKEY8     REDPESECOSIL1                 83
      *
      ***  If no record found, access with Branch and Customer = 0 and Porfolio Reference,
      ***  Corporate Action Type and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C**********           Z-ADD*ZEROS    WKCNUM                                              CSD027
     C                     MOVE *BLANKS   WKCNUM                                              CSD027
     C           WKEY8     SETGTSECOSIL1
     C           WKEY8     REDPESECOSIL1                 83
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Standard Corporate Actions Instruction exists (record found with one of the access).
      *
     C           *IN83     IFEQ '0'
     C           MORECI    ANDEQ'D'
      *
      ***  Set 'Customer/Booh Standard Instruction Exists' work field to 'Y'.
      *
     C                     MOVE 'Y'       EXBCSI
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  REACAA - Recalculate Actual Cash Allocation.                 *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           REACAA    BEGSR                           ** REACAA SR **
      *
      ***  Prepare Dividend Per Unit: from file if Processing Type = Dividends Events,
      ***                             = Receive Price if Processing Type = Offers and Offer Type =
      ***                               Exchange Offers or Purchase Offer,
      ***                             = Subscription Price if Processing Type = Offers and Offer
      ***                               Type = Subsrciption Offer.
      *
     C           PPROC     IFEQ 'DV'
     C******               Z-ADDNMDP2     WWNBDP           New Sec.Dec.Pl.135690
     C**********           Z-ADDNMDPC2    WWNBDP           New Cur.135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C**********           Z-ADDWWNUM     WWDIVU 309                      190204
     C                     Z-ADDMDDIV1    WWDIVU 309       13,8 ==>30,9   190204
     C                     ELSE
     C           PPROC     IFEQ 'OF'
     C           MIOFTY    ANDEQ'E'
     C           PPROC     OREQ 'OF'
     C           MIOFTY    ANDEQ'P'
     C                     Z-ADDMIREPR    WWDIVU
     C                     ELSE
     C           PPROC     IFEQ 'OF'
     C           MIOFTY    ANDEQ'S'
     C                     Z-ADDMISUPR    WWDIVU
     C                     ELSE
     C                     Z-ADD0         WWDIVU
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      *****If*Processing*Type*=*Offers*with*Offer*Type*=*Exchange*or***** 136935
      *****Subscription,************************************************* 136935
      ***  If Processing Type = Offers with Offer Type = Exchange,        136935
      ***  calculate Actual Cash Allocation = Holding Taken as stock previously calculated
      ***  multiplied by Receive Price.                                   136935
      *****multiplied*by*Receive*Price*(if*Offer*Type*=*Excahnge*Offers)* 136935
      *****or*Subscription*Price*(if*Offer*Type*=*Subscription*Price).*** 136935
      *
     C           PPROC     IFEQ 'OF'                       If Exchange Offers
     C           MIOFTY    ANDEQ'E'
     C******     PPROC     OREQ 'OF'                       Or Subscript.  136935
     C******     MIOFTY    ANDEQ'S'                           Offers      136935
     C                     Z-ADDNMDP1     WWNBDP           Event Security Decimal Places
     C                     Z-ADDWWHOST    WUNUM
     C                     EXSR RTVNDP
     C           WWNUM     MULT WWDIVU    WUACAA 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           SPBS2     IFEQ 'P'
     C           WUACAA    DIV  100       WUACAA    H
     C                     ENDIF
      *
      ***  Set Actual Cash Allocation recalculated.
      *
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWUACAA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WUACAA
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCACAA
     C                     MOVE 'Y'       AMACAA
     C                     ELSE
      *
      *****If*Processing*Type*=*Exercices*and*Conversions and Customer*** 136935
      *****Option*1,*2,*3,*4,*5*or*6*is*allowed,************************* 136935
      ***  If Processing Type = Exercices and Conversions and Option for  136935
      ***  Allocation 2 = '1', '2', '3', '4', '5' or '6',                 136935
      ***  calculate Actual Cash Allocation = Holding Taken as Cash previously calculated multiplied
      ***  by Subscription Price.
      *
     C           PPROC     IFEQ 'EX'                       If Exercices and Conversions
     C******     MJOPT1    IFEQ 'Y'                           Cust.Opt.1  136935
     C******     MJOPT2    OREQ 'Y'                           Cust.Opt.2  136935
     C******     MJOPT3    OREQ 'Y'                           Cust.Opt.3  136935
     C******     MJOPT4    OREQ 'Y'                           Cust.Opt.4  136935
     C******     MJOPT5    OREQ 'Y'                           Cust.Opt.5  136935
     C******     MJOPT6    OREQ 'Y'                           Cust.Opt.6  136935
     C           OPTNAA    IFEQ '1'                           Opt.Alloc=1 136935
     C           OPTNAA    OREQ '2'                           Opt.Alloc=2 136935
     C           OPTNAA    OREQ '3'                           Opt.Alloc=3 136935
     C           OPTNAA    OREQ '4'                           Opt.Alloc=4 136935
     C           OPTNAA    OREQ '5'                           Opt.Alloc=5 136935
     C***********OPTNAA    OREQ '6'                           Opt.A136935 161732
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDWWHOCA    WUNUM
     C                     EXSR RTVNDP
      *                                                                   161732
      ** Calculate Actual Cash Allocation =                               161732
      ** Holding Taken as Cash multiplied by Receive/Cash Price.          161732
      *                                                                   161732
     C***********WWNUM     MULT MDSBPR    WUACAA                          161732
     C           WWNUM     MULT MJRCPR    WUACAA                          161732
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           SPBS2     IFEQ 'P'
     C           WUACAA    DIV  100       WUACAA
     C                     ENDIF
      *
      ***  Set Actual Cash Allocation recalculated.
      *
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWUACAA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WUACAA
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCACAA
     C                     MOVE 'Y'       AMACAA
     C                     ENDIF
     C                     ELSE
      *
      ***  Calculate Actual Cash Allocation = Holding Taken as Cash calculated before
      ***  multiplied by Dividend Per Unit, and half adjust.              136935
      *****multiplied*by*Dividend*Per*Unit*(if*Processing*Type*=********* 136935
      *****Dividends*Events)*or*Cash*Payment*(if*Processing*Type*=******* 136935
      *****Corporate*Reorganisation),*and*half*adjust.******************* 136935
      *
     C******     PPROC     IFEQ 'OF'                       If Purchase    136935
     C******     MIOFTY    ANDEQ'P'                           Offer       136935
     C******     PPROC     OREQ 'DV'                       Or Dividend    136935
     C           PPROC     IFEQ 'DV'                       If Dividend    136935
     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
     C           PPROC     OREQ 'DV'                       Or Dividend Events
     C           MDSDIT    ANDEQ'O'                           Stk Dividend Tp=Optional for Cash&Stk
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     Z-ADDWWHOCA    WUNUM
     C                     EXSR RTVNDP
     C           WWNUM     MULT WWDIVU    WUACAA
      *
      ***  Set Actual Cash Allocation recalculated.
      *
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWUACAA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WUACAA
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCACAA
     C                     MOVE 'Y'       AMACAA
     C                     ELSE                                           136935
      *                                                                   136935
      ***  If Processing Type = Offers with Offer Type = Subscription,    136935
      ***  calculate Actual Cash Allocation = Actual Stock Allocation     136935
      ***  multiplied by Subscription Price.                              136935
      *                                                                   136935
     C           PPROC     IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C           WUASTA    MULT WWDIVU    WUACAA                          136935
      *                                                                   136935
      ***  If Price Basis is 'P' for %, result should be divided by 100.  136935
      *                                                                   136935
     C           SPBS2     IFEQ 'P'                                       136935
     C           WUACAA    DIV  100       WUACAA                          136935
     C                     ENDIF                                          136935
      *                                                                   136935
      ***  Set Actual Cash Allocation recalculated.                       136935
      *                                                                   136935
     C                     Z-ADDNMDPC2    WWNBDP           New Cur.Dec.Pl.136935
     C                     MOVE 'R'       WUROOP           half adjust    136935
     C                     Z-ADDWUACAA    WWNUM                           136935
     C                     EXSR ROUNDD                                    136935
     C                     Z-ADDWWNUM     WUACAA                          136935
     C                     EXSR SETNDP                                    136935
     C                     Z-ADDWUNUM     MCACAA                          136935
     C                     MOVE 'Y'       AMACAA                          136935
     C                     ENDIF                                          136935
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  REASTR - Recalculate Actual Stock Rounding.                  *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           REASTR    BEGSR                           ** REASTR SR **
      *                                                                   136935
      ***  If Processing Type not Offers or if = Offers with Offer Type = 136935
      ***  Exchange.                                                      136935
      *                                                                   136935
     C           PPROC     IFNE 'OF'                                      136935
     C           PPROC     OREQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'E'                                       136935
      *
     C                     Z-ADD0         FLDEE
      *
      ***  Calculate Stock preferred % = 100 - Cash Preeferred % previously calculated.
      *
     C           100       SUB  WCAPR     WSTPR   52
      *
      ***  If Current Reply exists and Reply Nominal (= Nominal Taken as Cash from SECOREL0) not 0,
      ***  calculate work field EE = Holding (= Ex-Date Position) - Reply Nominal (which is in fact
      ***  Nominal Accepted for Offers, which is Nominal Taken as Cash for Dividend Events or Rights
      ***  Issues).
      *
     C           EXBCRE    IFEQ 'Y'
     C           MQR2CN    ANDNE0
      *                                                                   145872
      ***  If Exchange Offer, calculate base Ex-Date Position = Ex-Date   145872
      ***  Position multiplied by Percentage to Exchange.                 145872
      *                                                                   145872
     C           PPROC     IFEQ 'OF'                                      145872
     C           MIOFTY    ANDEQ'E'                                       145872
     C           SHTDVD    MULT MIPREX    WUTDVD 249                      145872
     C           SHTDVD    DIV  100       WUTDVD                          145872
     C                     Z-ADDNMDP2     WWNBDP           New Sec.Dec.Pl.145872
     C                     MOVE WWRNDN    WUROOP           CO Det. Round. 145872
     C                     Z-ADDWUTDVD    WWNUM                           145872
     C                     EXSR ROUNDD                                    145872
     C                     Z-ADDWWNUM     WUTDVD                          145872
     C                     ENDIF                                          145872
      *                                                                   145872
     C                     Z-ADDNMDP1     WWNBDP           EVENT SECURITY DECIMAL PLACES
     C                     Z-ADDMQR2CN    WUNUM
     C                     EXSR RTVNDP
     C           PPROC     IFEQ 'OF'                                      145872
     C           MIOFTY    ANDEQ'E'                                       145872
     C           WUTDVD    SUB  WWNUM     FLDEE  249                      145872
     C                     ELSE                                           145872
     C           SHTDVD    SUB  WWNUM     FLDEE  249
     C                     ENDIF                                          145872
      *
      ***  Else, if Current Reply does not exist or Current Reply exists and Reply Nominal (=
      ***  Nominal Taken as Cash from SECOREL0) is 0.
      *
     C                     ELSE
      *
      ***  If Processing Type = Offers, calculate work field EE = True Stock Allocation previously
      ***  calculated multiplied by Cash Preferred % (which is in fact % Accepted) previously
      ***  calculated.
      *
     C           PPROC     IFEQ 'OF'                       If Offers
     C           SHOTSA    MULT WCAPR     FLDEE
     C           FLDEE     DIV  100       FLDEE
     C                     ELSE
      *
      ***  Else, if Processing Type not Offers, calculated work field EE = True Stock Allocation
      ***  previously calculated multiplied by Stock Preferred % calculated.
      *
     C           SHOTSA    MULT WSTPR     FLDEE
     C           FLDEE     DIV  100       FLDEE
     C                     ENDIF
     C                     ENDIF
      *
      ***  Calculate Actual Stock Rounding = work field EE -
      ***  Actual Stock Allocation entered.
      *
     C           FLDEE     SUB  WUASAL    WUASTR 309
     C                     Z-ADD8         WWNBDP           8 Decimal Places
     C                     MOVE WWRNDN    WUROOP  1        Rounding from CO Detail file
     C                     Z-ADDWUASTR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WUASTR
      *
     C                     Z-ADDWUASTR    WWASTR 158
     C                     MOVE 'Y'       AMASTR
     C                     MOVE *BLANKS   SASRO
     C           WWASTR    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWASTR    ZFLD15
     C                     Z-ADD8         ZDECS            8 Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SASRO
     C                     ENDIF
     C                     ENDIF                                          136935
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  REHOST - Recalculate Holding Taken as Stock.                 *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           REHOST    BEGSR                           ** REHOST SR **
      *
     C           PPROC     IFEQ 'DV'                       If CO Type = Dividends Events
      *
      ***  Retrieve Current Reply and Standard Instruction.
      *
     C                     EXSR RTVRPL
      *
      *****If*Standard*Instruction*exist.******************************** 135690
      ***  If Current Reply does not exist or Current Reply exists and    135690
      ***  Reply Nominal (= Nominal Taken as Cash Level 2) = 0.           135690
      *
     C******     EXBCSI    IFEQ 'Y'                                       135690
     C           EXBCRE    IFEQ 'N'                                       135690
     C           EXBCRE    OREQ 'Y'                                       135690
     C           MQR2CN    ANDEQ0                                         135690
      *
      ***  If Cash Preferred % not equal 100 and not equal 0.
      *
     C******     MOCAPP    IFNE 100                                       135690
     C******     MOCAPP    ANDNE0                                         135690
     C           WCAPR     IFNE 0                                         135690
     C           WCAPR     ANDNE100                                       135690
      *
      ***  If Number of Old and New Shares from SECODVL1 not equal 0.
      *
     C           MDNSHA    IFNE 0
     C           MDOSHA    ANDNE0
      *
      ***  Calculate Holding Taken as Stock = (Actual Stock Allocation entered
      ***  divided by Number of New Shares) multiplied by Number of Old Shares and rounded up.
      *
     C                     Z-ADDMDNSHA    WWNSHA                    161591
     C           WUASAL    DIV  WWNSHA    W1HOST 309
     C           W1HOST    MULT MDOSHA    WUHOST 309
      *
      ***  Else, if Number of Old or New Shares from SECODVL1 equal 0.
      *
     C                     ELSE
      *
      ***  Calculate Holding Taken as Stock = (Actual Stock Allocation entered
      ***  multiplied by Subscription Price) divided by Dividend Per Unit.
      *
     C           WUASAL    MULT MDSBPR    W1HOST
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           SPBS2     IFEQ 'P'
     C           W1HOST    DIV  100       W1HOST
     C                     ENDIF
     C           W1HOST    DIV  WWDIVU    WUHOST
     C                     ENDIF
      *
     C                     MOVE 'Y'       AMHOST
     C                     Z-ADDNMDP1     WWNBDP           Event Security Decimal Places
     C                     Z-ADDWUHOST    WWNUM
     C                     MOVE 'U'       WUROOP           Rounding = up
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WUHOST
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     WWHOST 150
     C                     MOVE *BLANKS   STAST
     C           WWHOST    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWHOST    ZFLD15
     C                     Z-ADDNMDP1     ZDECS            Event Security Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    STAST
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ** If Processing type is 'Exercise', and Option 6 was taken:        161732
      *                                                                   161732
     C           PPROC     IFEQ 'EX'                                      161732
     C           OPTNAA    ANDEQ'6'                                       161732
      *                                                                   161732
      ** If Reply Cash % level 2 is zero,                                 161732
      ** calculate Holding Taken as Stock = Reply Cash % level 2.         161732
      *                                                                   161732
     C           MQR2CA    IFEQ *ZERO                                     161732
     C                     Z-ADDMQR2CN    WUHOST                          161732
      *                                                                   161732
      ** Else, calculate Holding Taken as Stock as: Ex-date position      161732
      ** multiplied by Reply Cash % level 2, then divided by 100.         161732
      *                                                                   161732
     C                     ELSE                                           161732
     C           SHTDVD    MULT MQR2CA    WUHOST                          161732
     C                     DIV  100       WUHOST                          161732
     C                     ENDIF                                          161732
      *                                                                   161732
      ** Apply the correct number of decimal places to the Holding        161732
      ** Taken as Stock.                                                  161732
      *                                                                   161732
     C                     MOVE 'Y'       AMHOST                          161732
     C                     Z-ADDNMDP1     WWNBDP                          161732
     C                     Z-ADDWUHOST    WWNUM                           161732
     C                     MOVE 'U'       WUROOP                          161732
     C                     EXSR ROUNDD                                    161732
     C                     Z-ADDWWNUM     WUHOST                          161732
     C                     EXSR SETNDP                                    161732
     C                     Z-ADDWUNUM     WWHOST 150                      161732
      *                                                                   161732
      ** Output Holding Taken as Stock to the screen field.               161732
      *                                                                   161732
     C                     MOVE *BLANKS   STAST                           161732
     C           WWHOST    IFNE 0                                         161732
     C                     MOVE *BLANKS   ZFLD15                          161732
     C                     MOVE WWHOST    ZFLD15                          161732
     C                     Z-ADDNMDP1     ZDECS                           161732
     C                     EXSR ZSEDIT                                    161732
     C                     MOVE ZOUT21    STAST                           161732
     C                     ENDIF                                          161732
     C                     ENDIF                                          161732
      *                                                                   161732
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  REACAR - Recalculate Actual Cash Rounding.                   *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           REACAR    BEGSR                           ** REACAR SR **
      *
      ***  Retrieve Number of New Shares, Compensation Price, and Rounding Settlement in Cash,
      ***  depending on CO Type.
      *
     C           PPROC     IFEQ 'CR'
     C                     MOVEAMHSECA    TSEC,1
     C                     Z-ADD1         I       20
     C           PNWSEC    LOKUPTSEC,I                   17
     C           *IN17     IFEQ '0'
     C                     Z-ADD0         WWNSHA 157
     C                     Z-ADD0         WWCOMP 158
     C                     MOVE ' '       WWRNDS  1
     C                     ELSE
     C                     MOVEAMHNSHA    TNSH,1
     C                     MOVE TNSH,I    WWNSHA
     C                     MOVEAMHRNDS    TNDS,1
     C                     MOVE TNDS,I    WWRNDS
     C                     MOVEAMHCOPA    TOPA,1
     C                     MOVE TOPA,I    WWCOMP
     C                     ENDIF
     C                     ELSE
     C                     Z-ADDMDNSHA    WWNSHA
      *                                                                   135685
      ***  If Processing Type = Currency Change                           135685
      ***  and Compensation Price is entered as Market,                   135685
      ***  the Compensation Price must first be calculated                135685
      ***  from Current Market Price.                                     135685
      *                                                                   135685
     C           PPROC     IFEQ 'CC'                                      135685
     C           NAMRKI    ANDEQ'Y'                                       135685
     C                     EXSR CCOMP                                     135685
     C                     ENDIF                                          135685
      *                                                                   135685
     C                     Z-ADDMDCOMP    WWCOMP
     C                     MOVE MDRNDS    WWRNDS
     C                     ENDIF
      *
     C           PPROC     IFEQ 'DV'                       If CO Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares nor 0
      *
     C           PPROC     OREQ 'DV'                       Or CO Type = Dividends Events
     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           PPROC     OREQ 'DV'                       Or CO Type = Dividends Events
     C           MDSDIT    ANDEQ'O'                           Stk Dividend Tp=Optional for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           PPROC     OREQ 'FR'                       Or CO Type = Free Allocation
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           PPROC     OREQ 'RG'                       Or CO Type = Rights Issues
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           PPROC     OREQ 'CR'                       Or CO Type = Corporate Reorganisation
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           PPROC     OREQ 'EX'                       Or Proces.Type= Exervices and Conversions
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
     C           PPROC     OREQ 'OF'                       Or CO Type = Offers
     C           MIOFTY    ANDEQ'E'                           Exchange    136935
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *                                                                   CEU017
      ***  Or Processing Type = Currency Changes and Old and New Nominal  CEU017
      ***  Size not zero.                                                 CEU017
      *                                                                   CEU017
     C           PPROC     OREQ 'CC'                                      CEU017
     C           MDOSHA    ANDNE0                                         CEU017
     C           MDNSHA    ANDNE0                                         CEU017
      *
      ***  If Rounding Settlement in Cash = 'Y'.
      *
     C           WWRNDS    IFEQ 'Y'
      *
      ***  Calculate Actual Cash Rounding = Actual Stock Rounding previously re-calculated
      ***  multiplied by Compensation Price from SECOxxL1 (where xx = DV, OF, RG, CR or OF)
      ***  or SECOCCL2.                                                   CEU017
      *
     C           WUASTR    MULT WWCOMP    WUACAR
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           SPBS2     IFEQ 'P'
     C           WUACAR    DIV  100       WUACAR
     C                     ENDIF
      *
     C                     MOVE 'Y'       AMACAR
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWUACAR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WUACAR
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     WWACRO
     C                     MOVE *BLANKS   SACRO
     C           WWACRO    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWACRO    ZFLD15
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SACRO
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C           PPROC     IFEQ 'DV'                       If CO Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C********** MDDIVU    ANDNE0                             Dividend Per Unit not 0         190204
     C           MDDIV1    ANDNE0                             Dividend Per Unit not 0         190204
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
      ***  If Rounding Settlement in Cash = 'Y'.
      *
     C           WWRNDS    IFEQ 'Y'
      *
      ***  Calculate Actual Cash Rounding =
      ***  (Holding Taken as Stock previously re-calculated multiplied by Dividend
      ***  Per Unit from SECODVL1) - (Actual Stock Allocation entered multiplied by
      ***  Subscription Price from SECODVL1.
      *
     C******               Z-ADDNMDP2     WWNBDP           New Sec.Dec.Pl.135690
     C**********           Z-ADDNMDPC2    WWNBDP           New Cur.135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM            13,8 ==> 30,9  190204
     C           WUHOST    MULT WWNUM     W1ACAR 309
     C           WUASAL    MULT MDSBPR    W2ACAR 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           SPBS2     IFEQ 'P'
     C           W2ACAR    DIV  100       W2ACAR
     C                     ENDIF
     C           W1ACAR    SUB  W2ACAR    WUACAR
      *
     C                     MOVE 'Y'       AMACAR
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWUACAR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WUACAR
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     WWACRO
     C                     MOVE *BLANKS   SACRO
     C           WWACRO    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWACRO    ZFLD15
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SACRO
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C           PPROC     IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'R'                           Stk Dividend Tp=Reinvestment of Divid.
     C********** MDDIVU    ANDNE0                             Dividend Per Unit not 0         190204
     C           MDDIV1    ANDNE0                             Dividend Per Unit not 0         190204
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
     C           PPROC     OREQ 'EX'                       Or Processing Type = Dividends Events
     C           MJCPRC    ANDNE0                             Conversion Price not 0
     C           MJCEXR    ANDNE0                             Conversion Exchange Rate not 0
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
      ***  If Rounding Settlement in Cash = 'Y'.
      ***  Calculate Actual Cash Rounding = Actual Cash Pool previously calculated - (Actual Stock
      ***  Allocation previously calculated multiplied by Subscription Price).
      *
     C           WWRNDS    IFEQ 'Y'
     C           WUASAL    MULT MDSBPR    W1ACAR 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           SPBS2     IFEQ 'P'
     C           W1ACAR    DIV  100       W1ACAR
     C                     ENDIF
     C           ACCAPO    SUB  W1ACAR    WUACAR
      *
     C                     MOVE 'Y'       AMACAR
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWUACAR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WUACAR
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     WWACRO
     C                     MOVE *BLANKS   SACRO
     C           WWACRO    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWACRO    ZFLD15
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SACRO
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  CACAPO - Calculate Actual Cash Pool for Book/Customer.       *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           CACAPO    BEGSR                           ** CACAPO SR **
      *
      ***  If feature Withholding Tax is ON.
      *
     C           S01447    IFEQ 'Y'
      *
      ***  Calculate Tax Deducted at Source and Tax Deducted by User based on Dividend per Unit.
      *
     C                     Z-ADDWWDIVU    WWAMTT
     C                     EXSR RECTAX
      *
      ***  If Customer calculation, calculate Dividend Per Unit les Tax Deducted at Source and Tax
      ***  Deducted by User based on Dividend Per Unit.
      *
     C           SHCOTP    IFEQ 'C'
     C           WWDIVU    SUB  TOTTAX    TADIVU 309
     C                     ELSE
      *
      ***  If Book calculation, calculate Dividend Per Unit les Tax Deducted at Source based on
      ***  Dividend Per Unit.
      *
     C           WWDIVU    SUB  TASO      TADIVU
     C                     ENDIF
     C                     ELSE
      *
      ***  If feature Withholding Tax is OFF, Retrieve Dividend Per Unit.
      *
     C                     Z-ADDWWDIVU    TADIVU
     C                     ENDIF
      *
      ***  Calculate Actual Cash Pool:
      ***  - Customer Position: = Holding Taken as Stock multiplied by (Dividend Per Unit less Tax
      ***                         Deducted at Source and Tax Deducted by User) if feature
      ***                         Witholding Tax is ON,
      ***                       = Holding Taken as Stock multiplied by Dividend Per Unit if feature
      ***                         Witholding Tax is OFF.
      ***  - Book Position:     = Holding Taken as Stock multiplied by (Dividend Per Unit less Tax
      ***                         Deducted at Source) if feature Withholding Tax is ON,
      ***                       = Holding Taken as Stock multiplied by Dividend Per Unit if feature
      ***                         Witholding Tax is OFF.
      *
     C           AMHOST    IFEQ 'Y'
     C                     Z-ADDWUHOST    WWNUM            Holding Taken as Stock recalculated
     C                     ELSE
     C                     Z-ADDMCHOST    WUNUM            Retrieve Holding Taken as Stock
     C                     Z-ADDNMDP1     WWNBDP           Event Security Decimal Places
     C                     EXSR RTVNDP
     C                     ENDIF
     C           WWNUM     MULT TADIVU    ACCAPO 309
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  REHOCA - Recalculate Holding Taken as Cash.                  *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           REHOCA    BEGSR                           ** REHOCA SR **
      *
     C           PPROC     IFEQ 'DV'                       If CO Type = Dividends Events
     C           MDSDIT    ANDNE'C'                           Stk Divid.Tp not Combined for Cash&Stk
     C           PPROC     OREQ 'RG'                       Or CO Type = Rights Issues
     C           PPROC     OREQ 'CE'                       Or CO Type = Capital Changes
     C           PPROC     OREQ 'FR'                       Or CO Type = Free Allocation
     C           PPROC     OREQ 'CC'                       Or Ccy Changes CEU017
     C           PPROC     OREQ 'EX'                       Or CO Type = Exercices and Conversions
     C******     MJOPT1    ANDEQ'Y'                           Cust.Opt.1  136935
     C           OPTNAA    ANDEQ'1'                           Opt.Alloc=1 136935
     C           PPROC     OREQ 'EX'                       Or CO Type = Exercices and Conversions
     C******     MJOPT2    ANDEQ'Y'                           Cust.Opt.2  136935
     C           OPTNAA    ANDEQ'2'                           Opt.Alloc=2 136935
     C           PPROC     OREQ 'EX'                       Or CO Type = Exercices and Conversions
     C******     MJOPT3    ANDEQ'Y'                           Cust.Opt.3  136935
     C           OPTNAA    ANDEQ'3'                           Opt.Alloc=3 136935
     C           PPROC     OREQ 'EX'                       Or CO Type = Exercices and Conversions
     C******     MJOPT4    ANDEQ'Y'                           Cust.Opt.4  136935
     C           OPTNAA    ANDEQ'4'                           Opt.Alloc=4 136935
     C           PPROC     OREQ 'EX'                       Or CO Type = Exercices and Conversions
     C******     MJOPT5    ANDEQ'Y'                           Cust.Opt.5  136935
     C           OPTNAA    ANDEQ'5'                           Opt.Alloc=5 136935
      *
      ***  Calculate Holding Taken as Cash =
      ***  Ex-Date Position - Holding Taken as Stock previously re-calculated.
      *
     C           SHTDVD    SUB  WUHOST    WUHOCA 309
      *
     C                     MOVE 'Y'       AMHOCA
     C                     Z-ADDNMDPC2    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWUHOCA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WUHOCA
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     WWHOCA 150
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRPRAC - Process Action Code.                                *
      *                                                               *
      *  Called by: SRVALD - Validate subfile records.                *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SRPRAC    BEGSR                           ** SRPRAC SR **
      *
     C           P7515     PLIST
     C                     PARM           PCORF            Reference
     C                     PARM           PSESN            Security Shortname
     C                     PARM           PACT             Corporate Type
     C                     PARM           PPROC            Processing Type
     C                     PARM           PEXDT            Ex-Date
     C                     PARM           PSTAT            Corporate Action Status
     C                     PARM           PBRCD            Branch
     C                     PARM           PDPOT            Depot
     C                     PARM           SHBOOK           Book
     C                     PARM           WUCNUM           Customer
     C                     PARM           SHPORT           Portfolio
     C                     PARM           PEXPS  16        Ex-date Pos'n  161732
     C                     PARM           PCMODE           Mode
     C                     PARM *BLANKS   PCPGM   6        Calling program
     C                     PARM           PRTCD            Return Code
      *
     C                     MOVELSEXPOS    PEXPS                           161732
      *                                                                   161732
     C********** SHCNUM    IFEQ 0                                                             CSD027
     C           SHCNUM    IFEQ *BLANKS                                                       CSD027
     C                     MOVE *BLANKS   WUCNUM
     C                     ELSE
     C                     MOVE SHCNUM    WUCNUM  6
     C                     ENDIF
      *
     C           SACODE    IFEQ 'Y'
     C                     MOVE 'A'       PCMODE  1
     C                     CALL 'SE7515'  P7515        87
      *
      ***  Clear messages from program message queue.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM SPGM      ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
     C                     MOVELNARR,1    DBKEYN 29
     C                     ENDIF
      *
     C           SACODE    IFEQ 'J'
     C                     MOVE 'E'       PCMODE  1
     C                     CALL 'SE7515'  P7515        87
      *
      ***  Clear messages from program message queue.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM SPGM      ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
     C                     MOVELNARR,1    DBKEYN
     C                     ENDIF
      *
     C           SACODE    IFEQ 'V'
     C                     CALL 'SE7540'               87
     C                     PARM           PCORF
     C                     PARM           POPNB
     C                     PARM           PBRCD
     C                     PARM           SHBOOK
     C                     PARM           WUCNUM
     C                     PARM           SHPORT
     C                     PARM *BLANKS   PCPGM   6        Calling program
     C                     PARM           PRTCD
      *
      ***  Clear messages from program message queue.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM SPGM      ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
     C                     MOVELNARR,2    DBKEYN
     C                     ENDIF
      *
      ***  If 'Corporate Actions Allocation' for one Book or Customer/Book asked.
      *
     C           SACODE    IFEQ 'L'
      *
     C                     MOVE *BLANKS   SCOAL
     C                     MOVE '0'       *IN14
      *
      ***  Loop while F12=Previous screen is not pressed, or Comfirmation field not
      ***  valid.
      *
     C           *INKL     DOWEQ'0'
     C           SCOAL     ANDNE'Y'
     C           SCOAL     ANDNE'N'
      *
      ***  Display comfirmation screen.
      *
     C                     WRITE#MSGCTL                                   137879
     C                     WRITESE7513F5
     C******               WRITE#MSGCTL                                   137879
     C           *IN60     IFEQ '1'
     C                     EXFMTSE7513F3
     C                     ELSE
     C                     EXFMTSE7513F4
     C                     ENDIF
      *
      ***  If F12=Previous screen not pressed.
      *
     C           *INKL     IFEQ '0'
      *
      ***  Clear messages from program message queue.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM SPGM      ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
      ***  Reset error indicator.
      *
     C                     MOVE '0'       *IN14
      *
      ***  If Confirmation field not valid, send error message.
      *
     C           SCOAL     IFNE 'Y'
     C           SCOAL     ANDNE'N'
     C                     MOVE '1'       *IN14            Error indicator
     C                     MOVEL'CO00200' ZAMSID
     C                     EXSR ZASNMS
     C                     ENDIF
      *
      ***  If user confirm to run Allocation.
      *
     C           SCOAL     IFEQ 'Y'
      *
      ***  Prepare command.
      *
     C                     MOVEL*BLANKS   CMDTXT
     C***********          MOVEL*BLANKS   CMDTX1160                                           CPK014
     C                     Z-ADD240       CMDLEN 155
     C***********          MOVELCMD,1     CMDTX1                                              CPK014
     C***********          MOVE CMD,2     CMDTX1                                              CPK014
     C***********          MOVELCMDTX1    CMDTXT                                              CPK014
     C***********          MOVE CMD,3     CMDTXT                                              CPK014
     C                     MOVELCMD,1     CMDTXT                                              CPK014
     C                     MOVELCMD,2     CMDTX2                                              CPK014
     C                     MOVELCMD,3     CMDTX3                                              CPK014
      *
      ***  Prepare Job Name: COxxxxxxy (where xxxxxx = CO Reference and y = Action Code).
      *
     C                     MOVELSREFNO    @REF
     C                     MOVELSACODE    @ACTI
      *
      ***  Prepare parameters transmitted to CLP/SEC7550.
      *
     C                     MOVELSREFNO    @REFN            CO Refernce
     C                     MOVELSBRCH     @BRCD            Branch Code
     C                     MOVE PDPOT     @DEPT            Depot
     C                     MOVELSOPT      @OPTN            Option Number
     C                     MOVELSNWSEC    @NSEC            New Security
     C                     MOVELSHBOOK    @BOOK            Book Code
     C                     MOVELWUCNUM    @CNUM            Customer Number
     C                     MOVELSHPORT    @PTFR            Portfolio Reference
      *
      ***  Submit in batch 'CORPORATE ACTIONS ALLOCATION' program.
      *
     C                     CALL 'QCMDEXC'              87
     C                     PARM           CMDTXT
     C                     PARM           CMDLEN
      *
      ***  Clear messages from program message queue.
      *
     C                     CALL 'Y2CLMSC'
     C                     PARM SPGM      ZAPGM  10
     C                     PARM '*SAME'   ZAPGRL  5
      *
     C                     MOVELNARR,3    DBKEYN
      *
      ***  Send message 'Allocation processing submited ...'.
      *
     C                     MOVEL'CO00293' ZAMSID
     C                     EXSR ZASNMS
     C                     MOVE 'Y'       ERMSG
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDDO
      *
      ***  Reposition in Subfile.
      *
     C           *IN60     IFEQ '1'
     C           SRRN      CHAINSE7513S0             88
     C                     ELSE
     C           SRRN      CHAINSE7513S1             88
     C                     ENDIF
      *
      ***  Reset indicators F12 pressed to re-display subfile.
      *
     C                     MOVE '0'       *INKL
      *
     C                     ENDIF
      *
     C           PRTCD     IFEQ 'E'
     C           *INU7     OREQ '1'
     C           *INU8     OREQ '1'
     C           *IN87     OREQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD030       DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 30 *
     C                     MOVEL'SE7513'  DBPGM            ***************
     C                     MOVELDBKEYN    DBKEY
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           PRTCD     IFEQ '3'
     C           PMODE     IFEQ 'E'
     C                     MOVE '1'       *INKC
     C                     ELSE
     C                     MOVE '1'       *IN20
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRSAVE - Save subfile datas.                                 *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SRSAVE    BEGSR                           ** SRSAVE SR **
      *
     C                     MOVE PCORF     WKCORF
     C                     MOVE POPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C**********           Z-ADDPDEPO     WKDEPO                                              CSD027
     C                     MOVE PDEPO     WKDEPO                                              CSD027
      *
     C           *IN60     IFEQ '1'
     C                     MOVE PNWSEC    WKSESN
     C                     ELSE
     C                     MOVEL'**CASH**'WKSESN
     C                     ENDIF
      *
     C           SHBOOK    IFEQ ' '
     C                     MOVE 'C'       WKCOTP
     C                     MOVE '  '      WKBOOK
     C                     MOVE SHCNUM    WKCNUM
     C                     MOVE SHPORT    WKPTFR
     C                     ELSE
     C                     MOVE 'B'       WKCOTP
     C                     MOVE SHBOOK    WKBOOK
     C**********           Z-ADD0         WKCNUM                                              CSD027
     C                     MOVE *BLANKS   WKCNUM                                              CSD027
     C                     MOVE *BLANKS   WKPTFR
     C                     ENDIF
      *
     C           WKEY4     CHAINSECOALL7             79
      *
     C                     EXSR SRU002
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRU001 - Write a record to the subfile for each subfile      *
      *           record changes when subfile is build.               *
      *                                                               *
      *  Called by: SRS001 - Set first lines of subfile for each Book *
      *                      Position records when subfile is build   *
      *                      from begining.                           *
      *             SRS002 - Set detail lines of subfile for each     *
      *                      Customer Position records when subfile   *
      *                      is build.                                *
      *             SRS003 - Set subfile last line for each build of  *
      *                      the subfile when all details in files    *
      *                      are reached.                             *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SRU001    BEGSR                           ** SRU001 SR **
      *
     C                     MOVE '0'       *IN64
     C                     MOVEA'00'      *IN,66
     C                     MOVE *IN62     SHIND2
     C                     MOVE *IN63     SHIND3
     C                     MOVE *IN64     SHIND4                          135689
      *
      ***  If record from LF/SEUDEPL0.
      *
     C           *IN40     IFEQ '1'
     C                     MOVE *BLANKS   SBC
     C                     MOVELUDBK      SBC
      *                                                                   CAC005
      ** If CAC005 is installed, retrieve the corresponding user book     CAC005
      ** and profit center. UDBK in the User Depot Positions file is      CAC005
      ** being held as a pseudo book.                                     CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM *BLANKS   PRTCD1                          CAC005
     C                     PARM '*USER  ' POPTN1                          CAC005
     C                     PARM           PBKCD                           CAC005
     C                     PARM           PPRFC                           CAC005
     C                     PARM UDBK      PPSBK                           CAC005
      *                                                                   CAC005
     C           PRTCD1    IFEQ *BLANKS                                   CAC005
     C                     MOVELPBKCD     SBC                             CAC005
     C                     MOVE PPRFC     SBC                             CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C                     MOVE UDBK      SHBOOK
     C**********           MOVE *ZEROS    SHCNUM                                              CSD027
     C                     MOVE *BLANKS   SHCNUM                                              CSD027
     C                     MOVE *BLANKS   SPORT
     C                     MOVE *BLANKS   SHPORT
     C                     ELSE
      *
      ***  If record from LF/SECDEPL4.
      *
     C           *IN41     IFEQ '1'
     C                     MOVE *BLANKS   SHBOOK
      *
      ***  Retrieve Customer Shortname.
      *
     C                     MOVE *BLANKS   WKEYC
     C                     MOVELCDCN      WKEYC
     C**********           CALL 'AOCUSTR0'                                                    223539
     C                     CALL 'AOCUSTR1'                                                    223539
     C                     PARM '*DBERR'  WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM           WKEYC  10
     C                     PARM *BLANKS   WKYST   7
     C********** SDCUST    PARM SDCUST    DSSDY                                               223539
     C           SDCUST    PARM SDCUST    DSLDY                                               223539
      *
      ***  If record not found, handle Database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           BBCLST    ANDNE'Y'                                                           223539
     C           *LOCK     IN   LDA
     C                     Z-ADD031       DBASE            ***************
     C                     MOVEL'SDCUSTPD'DBFILE           * DB ERROR 31 *
     C                     MOVELCDCN      DBKEY            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVELBBCSSN    SBC
     C                     MOVE CDCN      SHCNUM
     C           PTFR      IFEQ '9997'
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVE W9997     SPORT
     C                     ELSE
     C                     MOVE PTFR      SPORT
     C                     ENDIF
     C                     MOVE PTFR      SHPORT
     C                     MOVE '0'       *IN85                                               223182
     C           BBCLST    IFEQ 'Y'                                                           223182
     C                     MOVE '1'       *IN85                                               223182
     C                     MOVE *BLANKS   SREST                                               223182
     C                     MOVE '*CLOSED*'SREST                                               223182
     C                     ENDIF                                                              223182
      *
      ***  If record for Dummy Customer.
      *
     C                     ELSE
     C                     MOVE '0'       *IN85                                               223182
     C                     MOVE *BLANKS   SHBOOK
     C                     MOVE *BLANKS   SPORT                           136935
     C                     MOVE *BLANKS   SHPORT                          136935
      *
      ***  Retrieve Customer Shortname.
      *
     C                     MOVE *BLANKS   WKEYC
     C                     MOVELWDUMMY    WKEYC
     C**********           CALL 'AOCUSTR0'                                                    223539
     C                     CALL 'AOCUSTR1'                                                    223539
     C                     PARM '*DBERR'  WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM           WKEYC  10
     C                     PARM *BLANKS   WKYST   7
     C********** SDCUST    PARM SDCUST    DSSDY                                               223539
     C           SDCUST    PARM SDCUST    DSLDY                                               223539
      *
      ***  If record not found, handle Database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           BBCLST    ANDNE'Y'                                                           223539
     C           *LOCK     IN   LDA
     C                     Z-ADD032       DBASE            ***************
     C                     MOVEL'SDCUSTPD'DBFILE           * DB ERROR 32 *
     C                     MOVELWDUMMY    DBKEY            ***************
     C                     MOVEL'SE7513'  DBPGM
     C                     OUT  LDA
     C                     EXSR *PSSR
     C                     ENDIF
     C                     MOVELBBCSSN    SBC
     C                     MOVE WDUMMY    SHCNUM
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Ex-Date Position is not coming from SEUDEPL0 or SECDEPL4.
      *
     C           *IN79     IFEQ '0'
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCEXPO    ZFLD15
     C                     Z-ADDNMDP1     ZDECS            Event Security Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE *BLANKS   SEXPOS
     C                     MOVE ZOUT21    SEXPOS
     C                     Z-ADDMCEXPO    SHTDVD
     C                     Z-ADDMCEXPO    WWEXPO
     C                     ELSE
     C                     Z-ADD0         WWEXPO 150
     C                     ENDIF
      *
      ***  If the Ex-Date Position retrieved from SEUDEPL0 or SECDEPL4 is different than Ex-Date
      ***  Position on SECOALL1, the field will blink on the screen.
      *
     C           WWEXPO    IFNE WWTDVD
     C                     MOVE '1'       *IN64
     C                     MOVE *IN64     SHIND4
     C                     ENDIF
      *
      ***  Setup the STATUS field.
      *
     C           *IN85     IFNE '1'                                                           223182
     C           *IN79     IFEQ '0'
     C********** SHCNUM    ANDNE*ZEROS                                                        CSD027
     C           SHCNUM    ANDNE*BLANKS                                                       CSD027
     C                     SELEC
     C           MCREST    WHEQ 'R'
     C                     MOVE STATUS,1  SREST
     C           MCREST    WHEQ 'S'
     C                     MOVE STATUS,2  SREST
     C           MCREST    WHEQ 'C'
     C                     MOVE STATUS,3  SREST
     C           MCREST    WHEQ 'M'
     C                     MOVE STATUS,4  SREST
     C           MCREST    WHEQ 'N'
     C                     MOVE STATUS,5  SREST
     C           MCREST    WHEQ ' '
     C                     MOVE STATUS,5  SREST
     C                     ENDSL
     C                     ELSE
     C                     MOVE *BLANKS   SREST
     C                     ENDIF
     C                     ENDIF                                                              223182
      *
      ***  Check if Current Reply exist for the Book or Customer.
      *
     C                     MOVE POPNB     OPT     1
     C                     MOVE SHBOOK    WKBOOK
     C                     MOVE SHCNUM    WKCNUM
     C                     MOVE PCORF     WKCORF
     C                     Z-ADDPOPTN     WKOPTN
     C                     MOVE PBRCD     WKBRCD
     C           WKEY6     CHAINSECOREL1             15
      *
      ***  If Corporate Actions Status is not Fully authorised (Cash and Stock)
      ***  and Option Number equal the Current Reply Level 1 if exist else the Default No Reply,
      ***  and Number of Options is greater than 1,
      ***  Or if Corporate Actions Status is not Fully authorised (Cash and Stock)
      ***  and Number of Options equal 1,
      ***  authorise amendments on fields: Actual Cash Rounding
      ***  and Actual Cash Allocation if "Cash" screen.
      *
     C           SSTAT     IFNE 'X'
     C           *IN15     ANDEQ'0'
     C           MQR1RE    ANDEQPOPNB
     C           MANBOP    ANDGT1
     C           SSTAT     ORNE 'X'
     C           *IN15     ANDEQ'1'
     C           MADFNR    ANDEQOPT
     C           MANBOP    ANDGT1
     C           SSTAT     ORNE 'X'
     C           MANBOP    ANDEQ1
     C                     MOVE '1'       *IN67
     C                     ENDIF
     C                     MOVE *IN66     SHIND6
     C                     MOVE *IN67     SHIND7
      *
      ***  Setup other input/output fields.
      *
     C           *IN60     IFEQ '1'
      *
      ***  For Normal Screen.
      *
     C           *IN79     IFEQ '0'
      *
      ***  If record found in SECOALL1, edit amount if not equal 0 else set to blank.
      *
     C                     MOVE *BLANKS   STAST
     C           MCHOST    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCHOST    ZFLD15
     C                     Z-ADDNMDP1     ZDECS            Event Security Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    STAST
     C                     ENDIF
      *
     C                     MOVE *BLANKS   SOSAL
     C           MCOALR    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCOALR    ZFLD15
     C                     Z-ADDNMDP2     ZDECS            New Security Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SOSAL
     C                     ENDIF
      *
     C                     MOVE *BLANKS   SASAL
     C           MCASTA    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCASTA    ZFLD15
     C                     Z-ADDNMDP2     ZDECS            New Security Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SASAL
     C                     ENDIF
      *
     C                     MOVE SASAL     SHASAL
     C                     Z-ADDMCASTA    SHASTA
      *
     C                     Z-ADDMCOTSA    SHOTSA
      *
     C                     MOVE *BLANKS   SOSRO
     C           MCOSTR    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCOSTR    ZFLD15
     C                     Z-ADD8         ZDECS            8 Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SOSRO
     C                     ENDIF
      *
     C                     MOVE *BLANKS   SASRO
     C           MCASTR    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCASTR    ZFLD15
     C                     Z-ADD8         ZDECS            8 Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SASRO
     C                     ENDIF
     C                     Z-ADDMCASTR    SHASTR
      *
     C                     MOVE *BLANKS   SOCRO
     C           MCOCAR    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCOCAR    ZFLD15
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SOCRO
     C                     ENDIF
      *
     C                     MOVE *BLANKS   SACRO
     C           MCACAR    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCACAR    ZFLD15
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SACRO
     C                     ENDIF
      *
     C                     MOVE SACRO     SHACRO
     C                     Z-ADDMCACAR    SHACAR
      *
     C                     ELSE
      *
      ***  If record not found in SECOALL1, set all fields to blank.
      *
     C                     MOVE *BLANKS   STAST
     C                     MOVE *BLANKS   SOSAL
     C                     MOVE *BLANKS   SASAL
     C                     MOVE *BLANKS   SHASAL
     C                     MOVE *BLANKS   SOSRO
     C                     MOVE *BLANKS   SASRO
     C                     MOVE *BLANKS   SOCRO
     C                     MOVE *BLANKS   SACRO
     C                     MOVE *BLANKS   SHACRO
     C                     ENDIF
      *
      ***  If Corporate Actions Status is not Stock authorised or Fully authorised (Cash and Stock)
      ***  and Option Number equal the Current Reply Level 1 if exist else the Default No Reply,
      ***  and Number of Options is greater than 1,
      ***  Or if Corporate Actions Status is not Stock authorised or Fully authorised (Cash and
      ***  stock) and Number of Options equal 1,
      ***  authorise amendments on field Actual Stock Allocation.
      *
     C           SSTAT     IFNE 'X'
     C           SSTAT     ANDNE'S'
     C           *IN15     ANDEQ'0'
     C           MQR1RE    ANDEQPOPNB
     C           MANBOP    ANDGT1
     C           SSTAT     ORNE 'X'
     C           SSTAT     ANDNE'S'
     C           *IN15     ANDEQ'1'
     C           MADFNR    ANDEQOPT
     C           MANBOP    ANDGT1
     C           SSTAT     ORNE 'X'
     C           SSTAT     ANDNE'S'
     C           MANBOP    ANDEQ1
     C                     MOVE '1'       *IN66
     C                     MOVE *IN66     SHIND6
     C                     ENDIF
      *
      ***  Write a record in the subfile.
      *
     C                     WRITESE7513S0
      *
     C                     ELSE
      *
      ***  For Cash Screen.
      *
     C           *IN79     IFEQ '0'
      *
      ***  If record found in SECOALL1, edit amount if not equal 0 else set to blank.
      *
     C                     MOVE *BLANKS   STACA
     C           MCHOCA    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCHOCA    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    STACA
     C                     ENDIF
      *
     C                     MOVE *BLANKS   SCAOP
     C           MCCAOP    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCCAOP    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SCAOP
     C                     ENDIF
      *
     C                     MOVE *BLANKS   SACAL
     C           MCACAA    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCACAA    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SACAL
     C                     ENDIF
      *
     C                     MOVE SACAL     SHACAL
     C                     Z-ADDMCACAA    SHACAA
     C                     Z-ADDMCACAA    HSACAA
      *
     C                     MOVE *BLANKS   SOCRO
     C           MCOCAR    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCOCAR    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SOCRO
     C                     ENDIF
      *
     C                     MOVE *BLANKS   SACRO
     C           MCACAR    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCACAR    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    SACRO
     C                     ENDIF
      *
     C                     MOVE SACRO     SHACRO
     C                     Z-ADDMCACAR    SHACAR
     C                     Z-ADDMCACAR    HSACAR
      *
     C                     MOVE *BLANKS   STFEE
     C           MCTOTF    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCTOTF    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    STFEE
     C                     ENDIF
      *
     C                     Z-ADDMCTOTF    SHTOTF
      *
     ******Total*Settlement*=*Actual*Cash*Allocation*&*Rounding*+/-*Total*Fees*+/-*Total*Taxes161641
     ******(+*if*Ex-Date*Position*is*>*or*=*0,*else*-).***************************************161641
      ***  Total Settlement = Actual Cash Allocation & Rounding   - Total 161641
      ***  Fees +/- Total Taxes (- if Ex-Date Position is > or = 0,       161641
      ***  else +).                                                       161641
      *
     C           MCACAA    ADD  MCACAR    WWTSET 150
     C           MCEXPO    IFGE 0
     C***********          ADD  MCTOTF    WWTSET                          161641
     C***********          ADD  MCTOTT    WWTSET                          161641
     C                     SUB  MCTOTF    WWTSET                          161641
     C                     SUB  MCTOTT    WWTSET                          161641
     C                     ELSE
     C                     SUB  MCTOTF    WWTSET
     C***********          SUB  MCTOTT    WWTSET                          161641
     C                     ADD  MCTOTT    WWTSET                          161641
     C                     ENDIF
     C                     MOVE *BLANKS   STSET
     C           WWTSET    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE WWTSET    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    STSET
     C                     ENDIF
      *
      ***  If Processing Type = Dividend Events and Withholding Tax feature is ON, display Total
      ***  Taxes, otherwise, display blank fields.
      *
     C           PPROC     IFEQ 'DV'
     C           S01447    ANDEQ'Y'
     C                     MOVEL'Total'   STTOT
     C                     MOVE 'Taxes'   STTOT
     C                     MOVE *BLANKS   STOTT
     C           MCTOTT    IFNE 0
     C                     MOVE *BLANKS   ZFLD15
     C                     MOVE MCTOTT    ZFLD15
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZDECS            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZDECS            New Currency Decimal Places
     C                     ENDIF
     C                     EXSR ZSEDIT
     C                     MOVE ZOUT21    STOTT
     C                     ENDIF
     C                     ELSE
     C                     MOVE *BLANKS   STTOT
     C                     MOVE *BLANKS   STOTT
     C                     ENDIF
     C                     Z-ADDMCTOTT    SHTOTT
      *
     C                     ELSE
      *
      ***  If record not found in SECOALL1, set all fields to blank.
      *
     C                     MOVE *BLANKS   STACA
     C                     MOVE *BLANKS   SCAOP
     C                     MOVE *BLANKS   SACAL
     C                     MOVE *BLANKS   SHACAL
     C                     MOVE *BLANKS   SOCRO
     C                     MOVE *BLANKS   SACRO
     C                     MOVE *BLANKS   SHACRO
     C                     MOVE *BLANKS   STFEE
     C                     MOVE *BLANKS   STSET
     C                     MOVE *BLANKS   STTOT
     C                     MOVE *BLANKS   STOTT
     C                     ENDIF
      *
      ***  Write a record in the subfile.
      *
     C                     WRITESE7513S1
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRU002 - Write/Update Allocation file for each subfile       *
      *           changes when enter is pressed or add mode is        *
      *           selected.                                           *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SRU002    BEGSR                           ** SRU002 SR **
      *
     C                     MOVE 'D'       MCRECI
     C                     Z-ADDBJRDNB    MCLCD
     C                     MOVE SUSER     MCLUID
     C                     MOVE PCORF     MCCORF
     C                     Z-ADDPOPTN     MCOPTN
     C                     MOVE PBRCD     MCBRCD
     C**********           Z-ADDPDEPO     MCDDPT                                              CSD027
     C                     MOVE PDEPO     MCDDPT                                              CSD027
      *
     C           SHBOOK    IFEQ *BLANKS
     C                     MOVE 'C'       MCCOTP
     C                     ELSE
     C                     MOVE 'B'       MCCOTP
     C                     ENDIF
      *
     C                     MOVE SHBOOK    MCBOOK
      *
     C                     MOVE *BLANKS   ZFIELD
     C                     MOVE SHCNUM    MCCNUM
      *
     C                     MOVE SHPORT    MCPTFR
      *
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVE SEXPOS    ZFLD17
     C                     Z-ADDNMDP1     ZSDEC            Event Security Decimal Places
     C           15        SUB  ZSDEC     ZSDIG
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    MCEXPO
     C           ZFSIGN    IFEQ '-'
     C                     Z-SUBMCEXPO    MCEXPO
     C                     ENDIF
      *
     C           *IN60     IFEQ '1'
     C                     MOVE PNWSEC    MCSESN
     C           *IN79     IFEQ '1'
     C                     Z-ADD0         MCOALR
     C                     Z-ADD0         MCOTSA
     C                     Z-ADD0         MCOSTR
     C                     Z-ADD0         MCOCAR
     C                     ENDIF
     C                     Z-ADD0         MCCAOP
     C                     Z-ADD0         MCTOTF
     C                     Z-ADD0         MCTOTT
      *
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVE SASAL     ZFLD17
     C                     Z-ADDNMDP2     ZSDEC            New Security Decimal Places
     C           15        SUB  ZSDEC     ZSDIG
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    MCASTA
     C           ZFSIGN    IFEQ '-'
     C                     Z-SUBMCASTA    MCASTA
     C                     ENDIF
     C           SHCNUM    IFEQ WDUMMY                                    136935
     C                     ADD  ASTADU    MCASTA                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ENDIF                                          136935
      *
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVE STAST     ZFLD17
     C                     Z-ADDNMDP1     ZSDEC            Event Security Decimal Places
     C           15        SUB  ZSDEC     ZSDIG
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    MCHOST
     C           ZFSIGN    IFEQ '-'
     C                     Z-SUBMCHOST    MCHOST
     C                     ENDIF
      *
     C           AMHOCA    IFEQ 'Y'
     C                     Z-ADDWWHOCA    MCHOCA
     C                     ENDIF
      *
     C                     Z-ADD0         MCACAA
      *
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVE SASRO     ZFLD17
     C                     Z-ADD7         ZSDIG
     C                     Z-ADD8         ZSDEC            8 Decimal Places
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    MCASTR
     C           ZFSIGN    IFEQ '-'
     C                     Z-SUBMCASTR    MCASTR
     C                     ENDIF
     C           SHCNUM    IFEQ WDUMMY                                    136935
     C                     ADD  ASTRDU    MCASTR                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ENDIF                                          136935
      *
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVELSACRO     ZFLD17
     C                     Z-ADDNMDPC2    ZSDEC            New Currency Decimal Places
     C           15        SUB  ZSDEC     ZSDIG
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    MCACAR
     C           ZFSIGN    IFEQ '-'
     C                     Z-SUBMCACAR    MCACAR
     C                     ENDIF
     C           SHCNUM    IFEQ WDUMMY                                    136935
     C                     ADD  ACARDU    MCACAR                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ENDIF                                          136935
      *
     C                     ELSE
      *
     C                     MOVEL'**CASH**'MCSESN
     C                     Z-ADD0         MCOALR
     C                     Z-ADD0         MCOSTR
     C                     Z-ADD0         MCASTA
     C                     Z-ADD0         MCASTR
     C           *IN79     IFEQ '1'
     C                     Z-ADD0         MCOTSA
     C                     Z-ADD0         MCOCAR
     C                     Z-ADD0         MCCAOP
     C                     ENDIF
      *
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVE SACAL     ZFLD17
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZSDEC            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZSDEC            New Currency Decimal Places
     C                     ENDIF
     C           15        SUB  ZSDEC     ZSDIG
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    MCACAA
     C           ZFSIGN    IFEQ '-'
     C                     Z-SUBMCACAA    MCACAA
     C                     ENDIF
     C           SHCNUM    IFEQ WDUMMY                                    136935
     C                     ADD  ACAADU    MCACAA                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ENDIF                                          136935
      *
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVE SACRO     ZFLD17
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZSDEC            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZSDEC            New Currency Decimal Places
     C                     ENDIF
     C           15        SUB  ZSDEC     ZSDIG
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    MCACAR
     C           ZFSIGN    IFEQ '-'
     C                     Z-SUBMCACAR    MCACAR
     C                     ENDIF
     C           SHCNUM    IFEQ WDUMMY                                    136935
     C                     ADD  ACARDU    MCACAR                          136935
     C                     MOVE 'Y'       DUMMYM                          136935
     C                     ENDIF                                          136935
      *
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVE STFEE     ZFLD17
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZSDEC            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZSDEC            New Currency Decimal Places
     C                     ENDIF
     C           15        SUB  ZSDEC     ZSDIG
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    MCTOTF
     C           ZFSIGN    IFEQ '-'
     C                     Z-SUBMCTOTF    MCTOTF
     C                     ENDIF
      *
     C                     MOVE *BLANKS   ZFLD17
     C                     MOVE STOTT     ZFLD17
     C           PPROC     IFEQ 'CR'
     C                     Z-ADDNMDPC1    ZSDEC            Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDNMDPC2    ZSDEC            New Currency Decimal Places
     C                     ENDIF
     C           15        SUB  ZSDEC     ZSDIG
     C                     EXSR ZASIGN
     C                     MOVE ZOUT15    MCTOTT
     C           ZFSIGN    IFEQ '-'
     C                     Z-SUBMCTOTT    MCTOTT
     C                     ENDIF
      *
     C                     ENDIF
      *
     C           *IN79     IFEQ '1'
     C                     MOVE 'I'       MCCHTP
     C                     MOVE ' '       MCOPT1
     C                     MOVE ' '       MCOPT2
     C                     MOVE 'M'       MCREST
     C                     Z-ADDMABEND    MCBEDT
     C                     Z-ADDMABFRD    MCBSTT
     C                     MOVE 'P'       MCBLTY
     C                     MOVE MABLOP    MCBEWI
     C                     MOVE PACT      MCCOAT
     C                     MOVE *BLANKS   MCTRRF
     C                     MOVE *BLANKS   MCTRR2
     C                     MOVE *BLANKS   MCRVRF
     C                     Z-ADD0         MCTNL1
     C                     MOVE MALREQ    MCLTRQ
      *
     C                     WRITESECOALD0
      *
     C                     ELSE
     C                     MOVE 'A'       MCCHTP
     C                     MOVE 'M'       MCREST
      *
     C                     UPDATSECOALD0
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  *PSSR  - Error control subroutine.                           *
      *                                                               *
      *  Called by: SRINIT - Initial processing.                      *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR                           ** *PSSR SR **
      *
      ***  Rollback Changes, Print Dump and Cancel Program.
      *
     C                     ROLBK
     C                     MOVE 'E'       PRTCD
     C                     DUMP
      *
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     CALL 'DBERRCTL'
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZASNMS - Send Message to Program Message Queue.              *
      *                                                               *
      *  Called by: SRMAIN - Main processing.                         *
      *             SRENDP - Termination processing.                  *
      *             SRVALD - Validate subfile records.                *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           ZASNMS    BEGSR                           ** ZASNMS SR **
      *
     C           ZAPGMQ    IFEQ *BLANKS
     C                     MOVELSPGM      ZAPGMQ
     C                     ENDIF
      *
     C                     CALL 'Y2SNMGC'
     C                     PARM           ZAPGMQ 10        Program queue
     C                     PARM           ZAPGRL  5        Rel queue
     C                     PARM           ZAMSID  7        Message Id.
     C                     PARM           ZAMSGF 10        Message file.
     C                     PARM           ZAMSDA132        Message data.
     C                     PARM           ZAMSTP  7        Message type.
      *
     C           ZASNM9    ENDSR                           ** ZASNM9 **
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  RTVNDP - Set amount from num field 15.0 to num field 30.9    *
      *           with Retrieve Number of Decimal Places of a Ccy.    *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           RTVNDP    BEGSR                           ** RTVNDP SR **
      *
     C           WWNBDP    IFEQ 0                          If no Decimal Place
     C                     Z-ADDWUNUM     WWNUM  309
     C                     ELSE
     C           WWNBDP    IFEQ 1                          If 1 Decimal Place
     C           WUNUM     DIV  10        WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 2                          If 2 Decimal Places
     C           WUNUM     DIV  100       WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 3                          If 3 Decimal Places
     C           WUNUM     DIV  1000      WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 4                          If 4 Decimal Places
     C           WUNUM     DIV  10000     WWNUM
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SETNDP - Set amount from num field 30.9 to num field 15.0    *
      *           with Number of Decimal Places of a Currency.        *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           SETNDP    BEGSR                           ** SETNDP SR **
      *
     C           WWNBDP    IFEQ 0                          If no Decimal Place
     C                     Z-ADDWWNUM     WUNUM  150
     C                     ELSE
     C           WWNBDP    IFEQ 1                          If 1 Decimal Place
     C           WWNUM     MULT 10        WUNUM
     C                     ELSE
     C           WWNBDP    IFEQ 2                          If 2 Decimal Places
     C           WWNUM     MULT 100       WUNUM
     C                     ELSE
     C           WWNBDP    IFEQ 3                          If 3 Decimal Places
     C           WWNUM     MULT 1000      WUNUM
     C                     ELSE
     C           WWNBDP    IFEQ 4                          If 4 Decimal Places
     C           WWNUM     MULT 10000     WUNUM
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  ROUNDD - Perform rounding to the Number of Decimal Places.   *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           ROUNDD    BEGSR                           ** ROUNDD SR **
      *
     C           WWNBDP    IFEQ 0                          If no Decimal Place
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD0 240H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD0
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD0
     C                     ADD  1         WUFLD0
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD0    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 1                          If 1 Decimal Place
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD1 241H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD1
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD1
     C                     ADD  0.1       WUFLD1
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD1    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 2                          If 2 Decimal Places
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD2 242H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD2
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD2
     C                     ADD  0.01      WUFLD2
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD2    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 3                          If 3 Decimal Places
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD3 243H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD3
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD3
     C                     ADD  0.001     WUFLD3
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD3    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 4                          If 4 Decimal Places
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD4 244H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD4
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD4
     C                     ADD  0.0001    WUFLD4
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD4    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 8                          If 8 Decimal Places
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD8 248H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD8
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD8
     C                     ADD  0.00000001WUFLD8
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD8    WWNUM
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  CSBPR  - Calculate Subscription Price if Subscription Price  *
      *           entered as Market for Dividend Events.              *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C           CSBPR     BEGSR                           ** CSBPR SR **
      *
      ***  Find Market Price with correct Date.
      *
     C                     MOVE 'N'       WWCHCK  1
      *
     C                     Z-ADDMACOEX    KPVDT
     C           WKEY15    SETGTPRICM
     C                     READPPRICM                    44
      *
      ***  If record found use this Price.
      *
     C           *IN44     IFEQ '0'
     C           PSSN      ANDEQMDNSEC
     C                     MOVE 'Y'       WWCHCK
      *
      ***  Otherwise check for Current Price.
      *
     C                     ELSE
     C                     Z-ADD*HIVAL    KPVDT
      *
     C           WKEY15    SETGTPRICM
     C                     READPPRICM                    44
      *
      ***  If record found use this price.
      *
     C           *IN44     IFEQ '0'
     C           PSSN      ANDEQMDNSEC
     C                     MOVE 'Y'       WWCHCK
     C                     ENDIF
     C                     ENDIF
      *
     C           WWCHCK    IFEQ 'N'
     C                     Z-ADDMKPR      MPRICE 158       Market Price from Security file.
     C                     ELSE
     C                     Z-ADDPPRC      MPRICE
     C                     ENDIF
      *
      ***  Calculate Subscription Price = Current Market Price minus Discount.
      *
     C           MPRICE    MULT MDDSRT    WWSBPR 158
     C           WWSBPR    DIV  100       WWSBPR
     C           MPRICE    SUB  WWSBPR    MDSBPR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT                                                              135685
      *****************************************************************   135685
      *                                                               *   135685
      *  CCOMP  - Calculate Compensation Price if Compensation Price  *   135685
      *           entered as Market for Currency Change Events.       *   135685
      *                                                               *   135685
      *  Called by:                                                   *   135685
      *                                                               *   135685
      *  Calls:                                                       *   135685
      *                                                               *   135685
      *****************************************************************   135685
      *                                                                   135685
     C           CCOMP     BEGSR                           ** CCOMP SR ** 135685
      *                                                                   135685
      ***  Find Market Price with correct Date.                           135685
      *                                                                   135685
     C                     MOVE 'N'       WWCHCK  1                       135685
      *                                                                   135685
     C           WKEY17    KLIST                                          135685
     C                     KFLD           NANSEC           New Security   135685
     C                     KFLD           KALEF   50       Alloc. Effec.  135685
      *                                                                   135685
     C                     Z-ADDMAALEF    KALEF                           135685
     C           WKEY17    SETGTPRICM                                     135685
     C                     READPPRICM                    44               135685
      *                                                                   135685
      ***  If record found use this Price.                                135685
      *                                                                   135685
     C           *IN44     IFEQ '0'                                       135685
     C           PSSN      ANDEQNANSEC                                    135685
     C                     MOVE 'Y'       WWCHCK                          135685
      *                                                                   135685
      ***  Otherwise check for Current Price.                             135685
      *                                                                   135685
     C                     ELSE                                           135685
     C                     Z-ADD*HIVAL    KALEF                           135685
      *                                                                   135685
     C           WKEY17    SETGTPRICM                                     135685
     C                     READPPRICM                    44               135685
      *                                                                   135685
      ***  If record found use this price.                                135685
      *                                                                   135685
     C           *IN44     IFEQ '0'                                       135685
     C           PSSN      ANDEQNANSEC                                    135685
     C                     MOVE 'Y'       WWCHCK                          135685
     C                     ENDIF                                          135685
     C                     ENDIF                                          135685
      *                                                                   135685
     C           WWCHCK    IFEQ 'N'                                       135685
     C                     Z-ADDMKPR      MDCOMP 158       Market Price   135685
     C                     ELSE                                           135685
     C                     Z-ADDPPRC      MDCOMP                          135685
     C                     ENDIF                                          135685
      *                                                                   135685
     C                     ENDSR                                          135685
      *                                                                   135685
      *****************************************************************   135685
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZSEDIT - Standart subroutine to insert a decimal point into  *
      *           a numeric field and to blank out leading zeroes.    *
      *                                                               *
      *  Called by: SRINIT - Initial processing.                      *
      *             SRS001 - Set first lines of subfile for each Book *
      *                      Position records when subfile is build   *
      *                      from begining.                           *
      *             SRS002 - Set detail lines of subfile for each     *
      *                      Customer Position records when subfile   *
      *                      is build.                                *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C/COPY ZSRSRC,ZSEDITZ3
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZDATE2 - Standart subroutine to convert a Day Number to      *
      *           date formats.                                       *
      *                                                               *
      *  Called by: SRINIT - Initial processing.                      *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C/COPY ZSRSRC,ZDATE2Z2
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZALIGN - Standart subroutine to validate and righr-align     *
      *           numeric fields.                                     *
      *                                                               *
      *  Called by: SRMAIN - Main processing.                         *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C/COPY ZSRSRC,ZALIGNZ2
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZASIGN - Standart subroutine to validate and right-align     *
      *           signed numeric fields.                              *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C/COPY ZSRSRC,ZASIGNZ2
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZCCAL1 - Standart subroutine to calculate Charges/           *
      *           Commissions.                                        *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C/COPY ZSRSRC,ZCCAL1Z2
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZCCAL2 - Standart subroutine to calculate Charges/           *
      *           Commissions.                                        *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C/COPY ZSRSRC,ZCCAL2Z1
      *
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZCONV  - Standart subroutine to convert an amount from one   *
      *           Currency to another.                                *
      *                                                               *
      *  Called by:                                                   *
      *                                                               *
      *  Calls:                                                       *
      *                                                               *
      *****************************************************************
      *
     C/COPY ZSRSRC,ZCONVZ1
      *
      /EJECT
**  STATUS
Reply Received
Std Inst Default
Corporate Default
Manually Changed
None
**  NARR
ERROR CALLING PGM 'SE7515'
ERROR CALLING PGM 'SE7540'
ERROR SBMJOB CALLING'SEC7550'
**  CMD - CALL 'QCMDEXC' TO SBMJOB
SBMJOB JOB(COnnnnnnx) JOBD(BULKTJOBD) RQSDTA('CALL PGM(SEC7550) PARM(''xxxxxx''
''xxx'' ''xxxxxx'' ''xx'' ''xxxxxxxxxx'' ''xx'' ''xxxxxx'' ''xxxx'')')
MSGQ(MOPERQ) RTGDTA(*NONE) INLLIBL(*JOBD) USER(*JOBD) OUTQ(*JOBD)                             CSC023
**   ZYDY - YEARS IN DAYS CUMULATIVE, FOUR YEAR SPAN
0366073110961461
**   ZMDY - MONTHS IN DAYS CUMULATIVE THROUGH YEAR
000031059090120151181212243273304334365
**   ZMNM - MONTHS SHORT NAMES
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  CPY@
(c) Misys International Banking Systems Ltd. 2001
