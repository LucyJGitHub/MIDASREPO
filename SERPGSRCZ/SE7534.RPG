     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE Corporate action allocation report')
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  SE7534 - Corporate Action Allocation Report                  *
      *                                                               *
      *  Function:  Report Program for Corporate Action Allocation.   *
      *  (I/C)                                                        *
      *                                                               *
      *  Called by: SEC7534 - Corporate Action Allocation Report.     *
      *                                                               *
      *  Calls: AOBANKR0 - Midas AO Bank ICD access object.           *
      *         AOCUSTR0 - Midas AO Client details access object.     *
      *         AOCUSTR1 - Midas AO Client details access object.     *   229342
      *         AOCURRR0 - Midas AO Currency codes access object.     *
      *         ZSFILE   - Midas FC Set-up spool file numbers file.   *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD058285           Date 22Jun21               *
      *  Prev Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 229342             Date 04Dec03               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 CLE025             Date 20Oct03               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 190204             Date 31May01               *
      *                 166168             Date 31May01               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 161732             Date 21Mar00               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 CAC005             Date 29Dec98               *
      *                 136930             Date 25Jun98               *
      *                 135683             Date 05Apr98               *
      *                 CEU017             Date 05Apr98               *
      *                 CSE007  *CREATE    Date 01Dec97               *
      *                                                               *
      *****************************************************************
      *                                                               *
      *  MD058285 - Change base rate code to alphanumeric (Recompile) *
      *  MD046248 - Finastra Rebranding                               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  229342 - ACCESS  AOCUSTR1 INSTEAD OF AOCUSTR0                *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  190204 - Recompiled due to changes in PF/SECODVPD.           *
      *  166168 - Recompiled due to changes in SE7534P1/P2.           *
      *  161732 - Corporate Actions Exercise and Conversion -         *
      *           Part Stock/Keep Rest Calculation                    *
      *           (Recompiled due to changes in PF/SECOEXPD)          *
      *  CAC005 - PCA-SE Enhancement.                                 *
      *  136930 - EMU and Corporate Actions: various errors:          *
      *           Correct loading amount report fields: use standard  *
      *           ZSEDIT instead of ZFRPED, due to wrong alignment    *
      *           if nul amount and 0 decimal places.                 *
      *  135683 - Dummy Customer detail lines must be the last detail *
      *           lines printed on Allocation details report, and     *
      *           reset to blank reply narrative if Reply Status      *
      *           blank.                                              *
      *  CEU017 - Securities Redenomination Euro Changes              *
      *  CSE007- Corporate Actions                                    *
      *                                                               *
      *****************************************************************
      *
      ***  Midas SE Securities                                                 - Prefixe   .
      *
     FSECTY   IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Reference Upd Idx                      - Prefixe MA.
      *
     FSECORFL0IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Depots Live records                    - Prefixe MB.
      *
     FSECODPL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Depots Reference                       - Prefixe MS.
      *
     FSECODRL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Allocations by Depots, Book, Customers - Prefixe MC.
      *
     FSECOALL3IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Action Type                                      - Prefixe MM.
      *
     FSECOATL0IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Dividends Events                       - Prefixe MD.
      *
     FSECODVL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Free Allocations                       - Prefixe ME.
      *
     FSECOFRL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Rights                                 - Prefixe MF.
      *
     FSECORGL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Exchange Offers                        - Prefixe MI.
      *
     FSECOOFL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Exercice & Conversion                  - Prefixe MJ.
      *
     FSECOEXL1IF  E           K        DISK         KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions - Name Changes                           - Prefixe ML.
      *
     FSECONCL1IF  E           K        DISK         KINFSR *PSSR
      *                                                                   CEU017
      ***  Midas SE Corporate Actions - Currency Changes                  CEU017
      ***                                                   -  Prefixe NA CEU017
      *                                                                   CEU017
     FSECOCCL2IF  E           K        DISK         KINFSR *PSSR          CEU017
      *
      ***  Midas SE Corporate Actions Allocation Customers/Books Report.
      *
     FSE7534P2O   E                    PRINTER      KINFDS SPOOL2     UC
      *
      ***  Midas SE Corporate Actions Allocation Depots Report.
      *
     FSE7534P1O   E                    PRINTER      KINFDS SPOOL1     UC
      *
      ***  Midas SE Corporate Action Allocation Audit Report.
      *
     FSE7534AUO   E                    PRINTER      KINFDS SPOOLU
      *
      *****************************************************************
      *                                                               *
      *  F U N C T I O N    O F    I N D I C A T O R S                *
      *                                                               *
      *  37    Multibranching Indicator.                       (*ON)  *
      *  70    Change in Depot and/or Branch.                  (*ON)  *
      *  80    Chain Fail ON SECORFL0, SECOALL3, SECOATL0,     (*ON)  *
      *        SECODRL1 OR SECTY.                                     *
      *  81    End of file SECORFL0.                           (*ON)  *
      *  82    End of file SECODPL1.                           (*ON)  *
      *  83    End of file SECOALL3.                           (*ON)  *
      *  89    Live record not found on SECOxxL1 or SECOCCL2   (*ON)  *
      *        (where xx = 'DV', 'FR', 'RG', 'OF', 'EX' or 'NC'.      *
      *  98    Date in format DDMMYY,                          (*OFF) *
      *        Date in formAt MMDDYY.                          (*ON)  *
      *                                                               *
      *  LR    End Program indicator                           (*ON)  *
      *  U7-U8 Database error indicator                        (*ON)  *
      *                                                               *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  S U B R O U T I N E    I N D E X                             *
      *                                                               *
      *  SRINIT - Program initialisation.                             *
      *  SRCUST - Customers/Books processing.                         *
      *  SRDUMC   - Dummy Customer processing.                        *   135683
      *  SRDEPO - Depot processing.                                   *
      *  SRREF  - Move CO Reference fields to P1 and P2 headers.      *
      *  SRAUDT - Audit processing.                                   *
      *  SRSFIL - Register printer files via RCF.                     *
      *  SRCDEP - Chain MACORF from PF/SECODPPD.                      *
      *  SRSEC  - Chain Security Shortname from LF/SECTY.             *
      *  *PSSR  - Error Routine.                                      *
      *                                                               *
      *  ZDATE2 - Standart subroutine to convert a Day Number to      *
      *           date formats.                                       *
      ***ZFRPED*-*Standard*subroutine*to*insert*a*decimal*point*and****   136930
      ************sign*into*a*numeric*field*and*to*blank*out*leading***   136930
      ************zeros*(optionaly*inserting*commas).******************   136930
      *  ZSEDIT - Standard subroutine to insert a decimal point and   *   136930
      *           sign into a numeric field and to blank out leading  *   136930
      *           zeros (optionaly inserting commas).                 *   136930
      *                                                               *
      *****************************************************************
      /EJECT
      *
      ***  Array containing Reply Narratives.
      *
     E                    ARPT    1  10 20
      *
      ***  Array containing titles for report.
      *
     E                    ATIT    1   3 20
      *
      ***  Arrays used by standart subroutine ZDATE2:
      ***    ZYDY containing Years in days cumulative, four year span,
      ***    ZMDY containing Months in days cumulative through year,
      ***    ZMNM containing Months short name.
      *
     E/COPY ZSRSRC,ZDATE2Z1
      *
      *****Arrays*ZS1*and*ZS2*used*by*standart*subroutine*ZFRPED.******** 136930
      ***  Arrays ZS1 and ZS2 used by standard subroutine ZSEDIT.         136930
      *
     E******/COPY ZSRSRC,ZFRPEDZ1                                         136930
     E/COPY ZSRSRC,ZSEDITZ1                                               136930
      *
      ***  Array containing Copyright statement.
      *
     E                    CPY@    1   1 80
      /SPACE 3
      *
      ***  Local data area for database error details
      ***  *LOCK IN LDA immediately before and OUT LDA immediately
      ***  after each database error handling.
      ***
      ***                                   134 141 DBFILE
      ***      Defines:                     142 170 DBKEY
      ***                                   171 180 DBPGM
      ***                                   181 1830DBASE
      *
     ILDA       E DSLDA                         256
      *
      ***  Program Status Data Structure.
      *
     IPSDS       SDS
     I                                     *PROGRAM PGM
     I                                      244 253 WSID
     I                                      254 263 USER
      *
      ***  File Information Data Structure for SE7534P1.
      *
     ISPOOL1      DS
     I                                       83  92 SFILE1
     I                                    B 123 1240SFNUM1
     I                                    B 188 1890OFLLN1
     I                                    B 367 3680PRTLN1
      *
      ***  File Information Data Structure for SE7534P2.
      *
     ISPOOL2      DS
     I                                       83  92 SFILE2
     I                                    B 123 1240SFNUM2
     I                                    B 188 1890OFLLN2
     I                                    B 367 3680PRTLN2
      *
      ***  File Information Data Structure for SE7534AU.
      *
     ISPOOLU      DS
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
      *
      ***  External data structure for Rundate data area.                      - Prefixe AG
      *
     IRUNDAT    E DSRUNDAT
      *
      ***  External data structures for Bank Details                           - Prefixe BJ.
      *
     ISDBANK    E DSSDBANKPD
      *
      ***  External data structures for Customer Details                       - Prefixe BB.
      *
     ISDCUST    E DSSDCUSTPD
      *
      ***  External data structure for Currency details                        - Prefixe A6.
      *
     ISDCURR    E DSSDCURRPD
      *                                                                   135683
      ***  Data structure for Securities Trading Details _ Prefixe BV     135683
      *                                                                   135683
     ISDSTRD    E DSSDSTRDPD                                              135683
      *
      ***  First DS for access programs, Long  data structure.
      *
     IDSSDY     E DSDSSDY
      *                                                                   229342
     IDSLDY     E DSDSLDY                                                 229342
      *
      *****Data*structure*for*fields*ZWRK15*and*ZOUT25*used*by*standart** 136930
      *****subroutine*ZFRPED.******************************************** 136930
      ***  Data structure for field WORK15 used by standard subroutine    136930
      ***  ZSEDIT.                                                        136930
      *
     I******/COPY ZSRSRC,ZFRPEDZ2                                         136930
     I/COPY ZSRSRC,ZSEDITZ2                                               136930
      /EJECT
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
      *
      ***  Process initialisation.
      *
     C                     EXSR SRINIT
      *
      ***  Process Depot.
      *
     C                     EXSR SRDEPO
      *
      ***  Process Audit.
      *
     C                     EXSR SRAUDT
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *================================================================
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRINIT - Program initialisation.                             *
      *                                                               *
      *  Called by: Main processing.                                  *
      *                                                               *
      *  Call: SRREF    - Move CO Reference fields to P1 and P2       *
      *                   headers.                                    *
      *        SRAUDT   - Audit processing.                           *
      *        SRSFIL   - Register printer files via RCF.             *
      *        *PSSR    - Error Routine.                              *
      *        AOBANKR0 -  Midas AO Bank ICD access object            *
      *                                                               *
      *****************************************************************
      *
     C           SRINIT    BEGSR                           ** SRINIT SR **
      *
      ***  Set-up Copyright parameter.
      *
     C                     MOVEACPY@      CPY2@  80
      *
      ***  Receive Parameter List.
      *
     C           *ENTRY    PLIST
     C                     PARM           WRSEQ   5        Sequence Number
     C                     PARM           WRLEV   1        Level
     C                     PARM           WRENT   3        Entity
     C                     PARM           WSLAL   1        Select all CO
     C                     PARM           WCARF   6        CO Reference
     C                     PARM           WOPNO   2        Option Number
     C                     PARM           WBRCD   3        Branch
     C                     PARM           WDPRF   6        Depot
      *
      ***  Search key for SECOALL3: Midas SE CO Allocation file.
      *
     C           WKEY      KLIST
     C                     KFLD           MBCORF           CO Reference from SECODPL1
     C                     KFLD           MBOPTN           Option Number from SECODPL1
     C                     KFLD           MBBRCD           Branch from SECODPL1
     C                     KFLD           MBDDPT           Depot from SECODPL1
      *
      ***  Search key for SECODRL1: Midas SE CO Depots Reference.
      *
     C           WKEY1     KLIST
     C                     KFLD           MBCORF           CO Reference from SECODPL1
     C                     KFLD           MBBRCD           Branch from SECODPL1
     C                     KFLD           MBDDPT           Depot from SECODPL1
      *
      ***  Search Key for CO Detail file: SECOxxL1.
      *
     C           WKEY2     KLIST
     C                     KFLD           WPCARF           CO Reference
     C                     KFLD           WPOPTN           Option Number
      *                                                                   135683
      ***  Search key for SECOALL3: Midas SE CO Allocation file.          135683
      *                                                                   135683
     C           WKEY3     KLIST                                          135683
     C                     KFLD           MBCORF           CO Reference   135683
     C                     KFLD           MBOPTN           Option Number  135683
     C                     KFLD           MBBRCD           Branch         135683
     C                     KFLD           MBDDPT           Depot          135683
     C                     KFLD           WUCOTP  1        Cust./Book ind.135683
     C                     KFLD           WUBOOK  2        Book           135683
     C**********           KFLD           WUERCU  60       Dummy Cust.                 135683 CSD027
     C                     KFLD           WUERCU  6        Dummy Cust.                        CSD027
      *
      ***  Call Access Program for Bank Details - Title, Run Date and
      ***  Run Day Number.
      *
     C                     CALL 'AOBANKR0'
     C                     PARM '*BLANKS' WRTCD   7
     C                     PARM '*FIRST ' WOPTN   7
     C           SDBANK    PARM SDBANK    DSSDY
      *
      ***  If ICD Bank not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     MOVEL'SDBANKPD'DBFILE
     C                     MOVEL'*FIRST  'DBKEY            ***************
     C                     Z-ADD001       DBASE            * DB ERROR 01 *
     C                     MOVEL'SE7534'  DBPGM            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Check System Date Format, DDMMYY (*IN98 off)
      ***                            MMDDYY (*IN98 on).
      *
     C           BJDFIN    IFEQ 'M'
     C                     MOVE '1'       *IN98
     C                     ENDIF
      *
      ***  Access RUNDAT for multibranching indicator.
      *
     C           *NAMVAR   DEFN           RUNDAT
     C                     IN   RUNDAT
      *
      ***  If Multibranching on, set on *IN37.
      *
     C           AGMBIN    IFEQ 'Y'
     C                     MOVE '1'       *IN37
     C                     ENDIF
      *                                                                   135683
      ***  Call Access Program for Securities Trading Details,            135683
      ***  to retrieve Dummy Customer.                                    135683
      *                                                                   135683
     C                     CALL 'AOSTRDR0'                                135683
     C                     PARM *BLANKS   @RTCD   7                       135683
     C                     PARM '*FIRST'  @OPTN   7                       135683
     C           SDSTRD    PARM SDSTRD    DSSDY                           135683
      *                                                                   135683
      ***  Handle Database Error.                                         135683
      *                                                                   135683
     C           @RTCD     IFNE *BLANKS                                   135683
     C                     Z-ADD015       DBASE            ***************135683
     C                     MOVEL'SDSTRDPD'DBFILE           * DB ERROR 15 *135683
     C                     MOVEL*BLANKS   DBKEY            ***************135683
     C                     EXSR *PSSR                                     135683
     C                     ENDIF                                          135683
     C                     MOVE BVERCU    WUERCU                          135683
      *                                                                   CAC005
      ***  Check if CAC005 - PCA-SE Enhancement is on.                    CAC005
      *                                                                   CAC005
     C                     MOVE 'N'       CAC005  1                       CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   @RTCD   7                       CAC005
     C                     PARM '*VERIFY' @OPTN   7                       CAC005
     C                     PARM 'CAC005'  @SARD   6                       CAC005
      *                                                                   CAC005
     C           @RTCD     IFEQ *BLANK                                    CAC005
     C                     MOVE 'Y'       CAC005                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
      *
      ***  Define local data area.
      *
     C           *NAMVAR   DEFN           LDA
      *
      ***  RCF Processing for Audit File.
      *
     C                     MOVELSFILEU    ZSILEU
     C                     Z-ADDSFNUMU    ZSNUMU  60
     C                     EXSR SRSFIL
      *
      ***  Read CO Reference file.
      *
     C                     READ SECORFD0                 81
      *
      ***  If CO Reference file empty, process audit: null report.
      *
     C           *IN81     IFEQ '1'
     C                     Z-ADD0         WTREF   10       Indicator no CO Reference processed
     C                     EXSR SRAUDT
     C                     ENDIF
      *
      ***  If CO Reference received as parameter not blank, retrieve CO Reference details.
      *
     C           WCARF     IFNE *BLANKS
     C           WCARF     CHAINSECORFD0             80
      *
      ***  If CO Reference not found, handle database error.
      *
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECORFL0'DBFILE
     C                     MOVELWCARF     DBKEY            ***************
     C                     Z-ADD002       DBASE            * DB ERROR 02 *
     C                     MOVEL'SE7534'  DBPGM            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
      ***  Move CO Reference fields to P1 and P2 headers.
      *
     C                     EXSR SRREF
      *                                                                   135683
      ***  Initialise work field.                                         135683
      *                                                                   135683
     C                     MOVE 'N'       WWDUMC  1        Dummy Cust.    135683
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRCUST - Customers/Books Processing.                         *
      *                                                               *
      *  Called by: SRDEPO - Depot processing.                        *
      *                                                               *
      *  Calls: SRSEC    - Chain Security Shortname from LF/SECTY.    *
      *         *PSSR    - Error Routine.                             *
      *         SRDUMC   - Dummy Customer processing.                 *   135683
      **********ZFRPED***-*Standard*subroutine*to*insert*a*decimal*****   136930
      *********************point*and*sign*into*a*numeric*field*and*****   136930
      *********************to*blank*out*leading*zeros*(optionaly*******   136930
      *********************inserting commas).**************************   136930
      *         ZSEDIT   - Standard subroutine to insert a decimal    *   136930
      *                    point and sign into a numeric field and to *   136930
      *                    blank out leading zeros (optionaly         *   136930
      *                    inserting commas).                         *   136930
      *         AOCUSTR0 - Midas AO Client details access object.     *
      *         AOCURRR0 - Midas AO Currency codes access object.     *
      *                                                               *
      *****************************************************************
      *
     C           SRCUST    BEGSR                           ** SRCUST SR **
      *
      ***  Retrieve CO Allocation details for CO Reference, Option Number, Branch and Depot from
      ***  CO Depots details.
      *
     C           WKEY      CHAINSECOALD0             80
      *
      ***  If no CO Allocation detail live record found, set report detail fields to blanks and
      ***  write Null report.
      *
     C           *IN80     IFEQ '1'
     C           MCRECI    ORNE 'D'
     C                     MOVE *BLANKS   RBOOK            Book/Customer
     C                     MOVE *BLANKS   RPTFR            Portfolio
     C                     MOVE *BLANKS   RCEXDT           Ex-Dat Position
     C                     MOVE *BLANKS   RCHOLD           Holding Taken as Stock
     C                     MOVE *BLANKS   RREPLY           Reply Status
      *
     C                     WRITEDET4P2                     Detail record format
     C                     WRITENODTP2                     Null report
      *
      ***  Else, if CO Allocation detail live record found.
      *
     C                     ELSE
      *
      ***  Save some fields and set other one to blank.
      *
     C                     MOVE MCCORF    WPCORF  6        CO Reference
     C                     MOVE MCOPTN    WPOPT   20       Option Number
     C                     MOVE MCBRCD    WPBRCH  3        Branch
     C**********           MOVE MCDDPT    WPDPT   60       Depot                              CSD027
     C**********           MOVE *BLANKS   WPCUST  60       Customer = blank                   CSD027
     C                     MOVE MCDDPT    WPDPT   6        Depot                              CSD027
     C                     MOVE *BLANKS   WPCUST  6        Customer = blank                   CSD027
     C                     MOVE *BLANKS   WPPTFR  4        Portfolio = blank
     C                     MOVE *BLANKS   WPBOOK  2        Book = blank
      *                                                                   135683
      ***  Reset indicator 83.                                            135683
      *                                                                   135683
     C                     MOVE '0'       *IN83                           135683
      *
      ***  Do while not end of file and same CO Reference, same Option Number, same Branch and
      ***  same Depot read.
      *
     C           MCCORF    DOWEQWPCORF                     Same CO Reference
     C           MCOPTN    ANDEQMBOPTN                     Same Option Number
     C           MCBRCD    ANDEQWPBRCH                     Same Branch
     C           MCDDPT    ANDEQWPDPT                      Same Depot
     C           *IN83     ANDEQ'0'                        Not end of file
      *                                                                   135683
      ***  If Customer from CO Allocation detail file not = 0 and         135683
      ***  Customer equal Dummy Customer, set work field Dummy Customer   135683
      ***  found (Dummy Customer must be the detail line printed for      135683
      ***  Depot and Branch).                                             135683
      *                                                                   135683
     C********** MCCNUM    IFNE 0                                                      135683 CSD027
     C           MCCNUM    IFNE *BLANKS                                                       CSD027
     C           MCCNUM    ANDEQWUERCU                                    135683
     C                     MOVE 'Y'       WWDUMC                          135683
     C                     ELSE                                           135683
      *
      ***  If Book/Customer Indicator = 'C', set Book save field to blank, else set Customer and
      ***  Portfolio save fields to blank.
      *
     C           MCCOTP    IFEQ 'C'
     C                     MOVE *BLANKS   WPBOOK
     C                     ELSE
     C                     MOVE *BLANKS   WPCUST
     C                     MOVE *BLANKS   WPPTFR
     C                     ENDIF
      *
      ***  If Change of Customer, Portfolio or Book.
      *
     C           MCCNUM    IFNE WPCUST
     C           MCPTFR    ORNE WPPTFR
     C           MCBOOK    ORNE WPBOOK
      *
      ***  Set flag to 'Y' to write sub-heading for New Security Allocation details.
      *
     C                     MOVE 'Y'       WFLAG   1
      *
      ***  Set Security save field to blank.
      *
     C                     MOVE *BLANKS   WPSECU
      *
      ***  Set Currency for Book/Customer detail report format to Event Currency.
      *
     C                     MOVE ECCY      RCYCD1
      *
      ***  Set Number of Decimal Places used in standart subroutine to Event Security Decimal
      ***  Places.
      *
     C                     MOVE ESNBDP    ZDECS
      *
      ***  If Customer from CO Allocation detail file not = 0.
      *
     C********** MCCNUM    IFNE 0                                                             CSD027
     C           MCCNUM    IFNE *BLANKS                                                       CSD027
      *
      ***  Save Customer and Portfolio.
      *
     C                     MOVE MCCNUM    WPCUST           Customer
     C                     MOVE MCPTFR    WPPTFR           Portfolio
      *
      ***  Retrieve Customer Report Name by calling access object.
      *
     C                     MOVE *BLANKS   RBOOK
      *
     C                     MOVE *BLANKS   WKEYC
     C                     MOVELMCCNUM    WKEYC            Set-up key = Customer Number
      *
     C***********          CALL 'AOCUSTR0'                                229342
     C                     CALL 'AOCUSTR1'                                229342
     C                     PARM '*DBERR'  WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM           WKEYC  10
     C                     PARM *BLANKS   WKYST   7
     C***********SDCUST    PARM SDCUST    DSSDY                           229342
     C           SDCUST    PARM SDCUST    DSLDY                           229342
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           BBCLST    ANDNE'Y'                                       229342
     C           *LOCK     IN   LDA
     C                     Z-ADD003       DBASE            ***************
     C                     MOVEL'SDCUSTPD'DBFILE           * DB ERROR 03 *
     C                     MOVELWKEYC     DBKEY            ***************
     C                     MOVEL'SE7534'  DBPGM
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Load 'Customer Report Name' report field.
      *
     C                     MOVELBBCSSN    RBOOK
      *
      ***  Else, if Customer Number = 0, save Book code and load 'Book code' report field.
      *
     C                     ELSE
     C                     MOVE MCBOOK    WPBOOK
     C                     MOVE *BLANKS   RBOOK
     C                     MOVE MCBOOK    RBOOK
      *                                                                   CAC005
      ** If CAC005 is on, retrieve user book from AOBKPCR0.               CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM           PRTCD   7                       CAC005
     C                     PARM '*USER  ' POPTN   7                       CAC005
     C           PMBKCD    PARM *BLANKS   PMBKCD  2                       CAC005
     C           PMPRFC    PARM *BLANKS   PMPRFC  4                       CAC005
     C                     PARM MCBOOK    PMPSBK  2                       CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPMBKCD    RBOOK                           CAC005
     C                     MOVE PMPRFC    RBOOK                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C                     ENDIF
      *
      ***  Load report fields.
      *
     C                     MOVE MCPTFR    RPTFR            Portfolio
      *
     C                     MOVE MCEXPO    ZFLD15           Ex-Date Position
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCEXDT
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCEXDT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCEXDT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCEXDT                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCEXDT                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCEXDT                          136930
      *
     C                     MOVE MCHOST    ZFLD15           Holding Taken as Stock
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCHOLD
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCHOLD                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCHOLD                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCHOLD                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCHOLD                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCHOLD                          136930
      *
     C                     MOVE *BLANKS   RREPLY                          135683
     C                     SELEC                           Reply Status
     C           MCREST    WHEQ 'R'
     C                     MOVEAARPT,7    RREPLY
     C           MCREST    WHEQ 'S'
     C                     MOVEAARPT,8    RREPLY
     C           MCREST    WHEQ 'C'
     C                     MOVEAARPT,9    RREPLY
     C           MCREST    WHEQ 'M'
     C                     MOVEAARPT,10   RREPLY
     C           MCREST    WHEQ 'N'
     C                     MOVE *BLANKS   RREPLY
     C                     ENDSL
      *
      ***  Write Book/Customer Details.
      *
     C           OFLLN2    SUB  PRTLN2    WREM2   20
     C           WREM2     IFLT 21                         If end of page
     C                     WRITEHEADP2                        write header
     C                     WRITEDET1P2                        write CO Reference details
     C                     WRITEDET2P2                        write sub-heading CO Depot
     C                     WRITEDET3P2                        write CO Depot details
     C                     ENDIF
      *
     C                     WRITEDET4P2                     write Book/Customer details
      *
      ***  If Security from CO Allocation file = '**CASH**'
      *
     C           MCSESN    IFEQ '**CASH**'
      *
      ***  Retrieve New Security Shortname on Corporate Actions Detail file, depending on Processing
      ***  Type, not for Processing Type Capital Changes and Non Financial Events, where New
      ***  Security = Event Security.
      *
     C                     MOVE *BLANKS   WUNSEC 10
     C                     SELEC
     C           MAPTYP    WHEQ 'DV'                       Divedend Events
     C           WKEY2     SETGTSECODVL1
     C           WKEY2     REDPESECODVL1                 89
     C                     MOVE MDNSEC    WUNSEC
     C                     MOVEL'SECODVL1'DBFILS  8
      *
     C           MAPTYP    WHEQ 'FR'                       Free Allocation
     C           WKEY2     SETGTSECOFRL1
     C           WKEY2     REDPESECOFRL1                 89
     C                     MOVE MENSEC    WUNSEC
     C                     MOVEL'SECOFRL1'DBFILS
      *
     C           MAPTYP    WHEQ 'RG'                       Rights Issues
     C           WKEY2     SETGTSECORGL1
     C           WKEY2     REDPESECORGL1                 89
     C                     MOVE MFNSEC    WUNSEC
     C                     MOVEL'SECORGL1'DBFILS
      *
     C           MAPTYP    WHEQ 'OF'                       Offers
     C           WKEY2     SETGTSECOOFL1
     C           WKEY2     REDPESECOOFL1                 89
     C                     MOVE MINSEC    WUNSEC
     C                     MOVEL'SECOOFL1'DBFILS
      *
     C           MAPTYP    WHEQ 'EX'                       Exercices and Conversions
     C           WKEY2     SETGTSECOEXL1
     C           WKEY2     REDPESECOEXL1                 89
     C                     MOVE MJNSEC    WUNSEC
     C                     MOVEL'SECOEXL1'DBFILS
      *
     C           MAPTYP    WHEQ 'NC'                       Name Changes
     C           WPCARF    SETGTSECONCL1
     C           WPCARF    REDPESECONCL1                 89
     C                     MOVE MLSESN    WUNSEC
     C                     MOVEL'SECONCL1'DBFILS
      *
     C           MAPTYP    WHEQ 'CC'                       Currency       CEU017
     C           WPCARF    SETGTSECOCCL2                   Changes        CEU017
     C           WPCARF    REDPESECOCCL2                 89               CEU017
     C                     MOVE NANSEC    WUNSEC                          CEU017
     C                     MOVEL'SECOCCL2'DBFILS                          CEU017
      *                                                                   CEU017
      ***  If record not found, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD004       DBASE            ***************
     C                     MOVELDBFILS    DBFILE           * DB ERROR 04 *
     C                     MOVEL'SE7534'  DBPGM            ***************
     C           MAPTYP    IFEQ 'NC'
     C           MAPTYP    OREQ 'CC'
     C                     MOVELWPCARF    DBKEY
     C                     ELSE
     C                     MOVELWPCARF    DBKEY3  8
     C                     MOVE WPOPTN    DBKEY3
     C                     MOVELDBKEY3    DBKEY
     C                     ENDIF
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDSL
      *
      ***  If New Security retrieve not blank (for Processing Type NC, if Security from CO detail
      ***  file is blank, New Security = Event Security).
      *
     C           WUNSEC    IFNE *BLANKS
      *
      ***  Chain Security Shortname from LF/SECTY to retrieve New Currency.
      *
     C                     MOVE WUNSEC    WSESN  10
     C                     EXSR SRSEC
      *
      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM NMCY      WAJCD
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD005       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 05 *
     C                     MOVELWAJCD     DBKEY            ***************
     C                     MOVEL'SE7534'  DBPGM
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Set Number of Decimal Places used in standart subroutine to New Currency Decimal Places.
      *
     C                     Z-ADDA6NBDP    ZDECS
      *
      ***  Set Currency fields for Cash line to New Currency.
      *
     C                     MOVE NMCY      RCYCD2           Ccy of Cash Allocation
     C                     MOVE NMCY      RCYCD3           Ccy of Cash Rounding
     C                     MOVE NMCY      RCYCD4           Ccy of Total Fees and Settlement
      *
      ***  Else, if New Security retrieve is blank or No access done (= New Security = Event
      ***  Security).
      *
     C                     ELSE
      *
      ***  Set Number of Decimal Places used in standart subroutine to Event Currency Decimal
      ***  Places.
      *
     C                     MOVE ECNBDP    ZDECS
      *
      ***  Set Currency fields for Cash line to Event Currency.
      *
     C                     MOVE ECCY      RCYCD2           Ccy of Cash Allocation
     C                     MOVE ECCY      RCYCD3           Ccy of Cash Rounding
     C                     MOVE ECCY      RCYCD4           Ccy of Total Fees and Settlement
     C                     ENDIF
      *
      ***  If Processing Type = Dividend Events, set Total Taxes Currency to New Currency.
      *
     C           MMPTYP    IFEQ 'DV'
     C                     MOVE NMCY      RCYCD5
     C                     ELSE
     C                     MOVE *BLANKS   RCYCD5
     C                     ENDIF
      *
      ***  Load detail Allocation report fields for Cash line.
      *
     C                     MOVE MCCAOP    ZFLD15           Cash Option
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAOPT
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCAOPT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCAOPT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCAOPT                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCAOPT                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCAOPT                          136930
      *
     C                     MOVE MCACAA    ZFLD15           Actual Cash Allocation
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAALL
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCAALL                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCAALL                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCAALL                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCAALL                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCAALL                          136930
      *
     C                     MOVE MCOCAR    ZFLD15           Original Cash Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAORG
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCAORG                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCAORG                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCAORG                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCAORG                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCAORG                          136930
      *
     C                     MOVE MCACAR    ZFLD15           Actual Cash Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAACT
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCAACT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCAACT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCAACT                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCAACT                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCAACT                          136930
      *
     C                     MOVE MCTOTF    ZFLD15           Total Fees
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RTFEE
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RTFEE                           136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RTFEE                           136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RTFEE                           136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RTFEE                           136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RTFEE                           136930
      *
     C           MMPTYP    IFEQ 'DV'                       If Prcessing Type = Dividend Events
     C                     MOVE MCTOTT    ZFLD15              Total Taxes
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RTTAX
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RTTAX                           136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RTTAX                           136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RTTAX                           136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RTTAX                           136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RTTAX                           136930
     C                     ELSE                            Else
     C                     MOVE *BLANKS   RTTAX               Total Taxes = blank
     C                     ENDIF
      *
      ***  Calculate Total Settlement =
      ***  Actual Cash Allocation & Rounding +/- Total Fees +/- Total Taxes (if Dividend Events)
      ***  (+ if Ex-Date Position > or = 0, else -).
      *
     C                     Z-ADD*ZEROS    WTSET  150
     C           MCACAA    ADD  MCACAR    WTSET
      *
     C           MCEXPO    IFGE 0
     C           WTSET     ADD  MCTOTF    WTSET
     C           MMPTYP    IFEQ 'DV'
     C           WTSET     ADD  MCTOTT    WTSET
     C                     ENDIF
     C                     ELSE
     C           WTSET     SUB  MCTOTF    WTSET
     C           MMPTYP    IFEQ 'DV'
     C           WTSET     SUB  MCTOTT    WTSET
     C                     ENDIF
     C                     ENDIF
      *
     C                     MOVE WTSET     ZFLD15           Total Settlement
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RTSET
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RTSET                           136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RTSET                           136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RTSET                           136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RTSET                           136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RTSET                           136930
      *
     C           OFLLN2    SUB  PRTLN2    WREM2   20
     C           WREM2     IFLT 17                         If end of page
     C                     WRITEHEADP2                        write header
     C                     WRITEDET1P2                        write CO Reference details
     C                     WRITEDET2P2                        write sub-heading CO Depot
     C                     WRITEDET3P2                        write CO Depot details
     C                     WRITEDET4P2                        write Book/Customer details
     C                     ENDIF
      *
     C                     WRITEDET5P2                        write Cash line details
      *
      ***  Save New Security Shortname.
      *
     C                     MOVE MCSESN    WPSECU 10
     C                     ENDIF
     C                     ENDIF
      *
      ***  If change of Security.
      *
     C           MCSESN    IFNE WPSECU
      *
     C           MCSESN    IFEQ '**CASH**'
     C                     MOVE MASESN    WSESN
     C                     ELSE
     C                     MOVE MCSESN    WSESN
     C                     ENDIF
      *
      ***  Chain Security Shortname from LF/SECTY to retrieve New Currency.
      *
     C                     EXSR SRSEC
     C                     Z-ADDNMDP      NSNBDP  10
      *
      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM NMCY      WAJCD
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD006       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 06 *
     C                     MOVELWAJCD     DBKEY            ***************
     C                     MOVEL'SE7534'  DBPGM
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    NCNBDP  10
      *
      ***  If flag = 'Y', write sub-heading for New Security Allocation details.
      *
     C           WFLAG     IFEQ 'Y'
     C           OFLLN2    SUB  PRTLN2    WREM2   20
     C           WREM2     IFLT 21                         If end of page
     C                     WRITEHEADP2                        write header
     C                     WRITEDET1P2                        write CO Reference details
     C                     WRITEDET2P2                        write sub-heading CO Depot
     C                     WRITEDET3P2                        write CO Depot details
     C                     WRITEDET4P2                        write Book/Customer details
     C                     ENDIF
     C                     WRITEDET7P2                     write sub-headin for New Sec.Alloc.Detail
     C                     MOVE 'N'       WFLAG            Reset flag
     C                     ENDIF
      *
      ***  Load New Security Allocation details for Book/Customer fields.
      *
     C                     MOVE NMCY      RCYCD5           New Currency
     C                     MOVE MCSESN    RCNSEC           Security Shortname
      *
      ***  Save New Security.
      *
     C                     MOVE MCSESN    WPSECU
      *
      ***  Write New Security details.
      *
     C           OFLLN2    SUB  PRTLN2    WREM2   20
     C           WREM2     IFLT 20                         If end of page
     C                     WRITEHEADP2                        write header
     C                     WRITEDET1P2                        write CO Reference details
     C                     WRITEDET2P2                        write sub-heading CO Depot
     C                     WRITEDET3P2                        write CO Depot details
     C                     WRITEDET4P2                        write Book/Customer details
     C                     ENDIF
     C                     WRITEDET6P2                     Write New Security details
      *
      ***  Load Allocation details for Book/Customer and New Security fields.
      *
     C                     MOVEAATIT,1    RCTIT            Stock Allocation title
     C                     Z-ADDNSNBDP    ZDECS            New Security Decimal Places
      *
     C                     MOVE MCOALR    ZFLD15           Original Stock Allocation
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCOR
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCOR                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCOR                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCOR                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCOR                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCOR                            136930
      *
     C                     MOVE MCASTA    ZFLD15           Actual Stock Allocation
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAC
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCAC                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCAC                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCAC                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCAC                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCAC                            136930
      *
      ***  Write Stock Allocation details.
      *
     C           OFLLN2    SUB  PRTLN2    WREM2   20
     C           WREM2     IFLT 17                         If end of page
     C                     WRITEHEADP2                        write header
     C                     WRITEDET1P2                        write CO Reference details
     C                     WRITEDET2P2                        write sub-heading CO Depot
     C                     WRITEDET3P2                        write CO Depot details
     C                     WRITEDET4P2                        write Book/Customer details
     C                     ENDIF
     C                     WRITEDET8P2                     Write Allocation details
      *
      ***  Load Allocation details for Book/Customer and New Security fields.
      *
     C                     MOVEAATIT,2    RCTIT            Stock Rounding title
     C                     Z-ADD8         ZDECS            8 Decimal Places
     C                     MOVE MCOSTR    ZFLD15           Original Stock Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C******               MOVE ZOUT25    RCOR                            136930
     C                     MOVE ZOUT21    RCOR                            136930
     C                     MOVE MCASTR    ZFLD15           Actual Stock Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C******               MOVE ZOUT25    RCAC                            136930
     C                     MOVE ZOUT21    RCAC                            136930
      *
      ***  Write Stock Rounding details.
      *
     C           OFLLN2    SUB  PRTLN2    WREM2   20
     C           WREM2     IFLT 17                         If end of page
     C                     WRITEHEADP2                        write header
     C                     WRITEDET1P2                        write CO Reference details
     C                     WRITEDET2P2                        write sub-heading CO Depot
     C                     WRITEDET3P2                        write CO Depot details
     C                     WRITEDET4P2                        write Book/Customer details
     C                     ENDIF
     C                     WRITEDET8P2                     Write Allocation details
      *
      ***  Load Allocation details for Book/Customer and New Security fields.
      *
     C                     MOVEAATIT,3    RCTIT            Cash Rounding title
     C                     Z-ADDNCNBDP    ZDECS            New Currency Decimal Places
      *
     C                     MOVE MCOCAR    ZFLD15           Original Cash Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCOR
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCOR                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCOR                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCOR                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCOR                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCOR                            136930
      *
     C                     MOVE MCACAR    ZFLD15           Actual Cash Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAC
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCAC                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCAC                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCAC                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCAC                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCAC                            136930
      *
      ***  Write Cash Rounding details.
      *
     C           OFLLN2    SUB  PRTLN2    WREM2   20
     C           WREM2     IFLT 17                         If end of page
     C                     WRITEHEADP2                        write header
     C                     WRITEDET1P2                        write CO Reference details
     C                     WRITEDET2P2                        write sub-heading CO Depot
     C                     WRITEDET3P2                        write CO Depot details
     C                     WRITEDET4P2                        write Book/Customer details
     C                     ENDIF
     C                     WRITEDET8P2                     Write Allocation details
      *
     C                     ENDIF
     C                     ENDIF                                          135683
      *
      ***  Read newt record on CO Allocation details fiel.
      *
     C                     READ SECOALD0                 83
     C                     ENDDO
      *                                                                   135683
      ***  If Dummy Customer found for Depot and Branch, print detail     135683
      ***  lines for Dummy Customer (Dummy Customer must be the last      135683
      ***  detail lines printed for Depot and Branch.                     135683
      *                                                                   135683
     C           WWDUMC    IFEQ 'Y'                                       135683
     C                     EXSR SRDUMC                                    135683
     C                     ENDIF                                          135683
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRDEPO - Depot processing.                                   *
      *                                                               *
      *  Called by: Main processing.                                  *
      *                                                               *
      *  Calls: SRCUST   - Customers/Books processing.                *
      *         SRREF    - Move CO Reference fields to P1 and P2      *
      *                    headers.                                   *
      *         SRCDEP   - Chain MACORF from PF/SECODPPD.             *
      *         SRSEC    - Chain Security Shortname from LF/SECTY.    *
      *         *PSSR    - Error Routine.                             *
      *         ZDATE2   - Standart subroutine to convert a Day       *
      *                    Number to date formats.                    *
      **********ZFRPED***-*Standard*subroutine*to*insert*a*decimal*****   136930
      *********************point*and*sign*into*a*numeric*field*and*****   136930
      *********************to*blank*out*leading*zeros*(optionaly*******   136930
      *********************inserting commas).**************************   136930
      *         ZSEDIT   - Standard subroutine to insert a decimal    *   136930
      *                    point and sign into a numeric field and to *   136930
      *                    blank out leading zeros (optionaly         *   136930
      *                    inserting commas).                         *   136930
      *         AOCUSTR0 - Midas AO Client details access object.     *
      *         AOCURRR0 - Midas AO Currency codes access object.     *
      *                                                               *
      *****************************************************************
      *
     C           SRDEPO    BEGSR                           ** SRDEPO SR **
      *
      ***  Open printer files and set work fields printer open to 'Y'.
      *
     C                     OPEN SE7534P1                   CO Allocation by Depots report
     C                     OPEN SE7534P2                   CO Allocation by Custoemrs/Books report
     C                     MOVE 'Y'       WOPEN1  1        Printer CO Alloc. by Depot opened
     C                     MOVE 'Y'       WOPEN2  1        Printer CO Alloc. by Cus/Books opened
      *
      ***  Do while not end of file CO References and CO Reference received as parameter blank, or
      ***  do for CO Reference received as parameter (= if not blank).
      *
     C           *IN81     DOWEQ'0'
      *
      ***  If selection all CO References, retrieve CO Depot details for CO Reference from CO
      ***  References file.
      *
     C           WSLAL     IFEQ 'Y'
     C                     EXSR SRCDEP
      *
      ***  If no record found in CO Depot details, read next record on CO References file.
      *
     C           ROPTNO    IFEQ *BLANKS
     C                     GOTO REREAD
     C                     ENDIF
     C                     ENDIF
      *
      ***  If selection all Depots selection one CO Reference, retrieve CO Depot details.
      *
     C           WDPRF     IFEQ *BLANKS
     C           WCARF     ORNE *BLANKS
      *
     C                     EXSR SRCDEP
      *
      ***  If no record found in CO Depot details, read next record on CO References file.
      *
     C           ROPTNO    IFEQ *BLANKS
     C                     GOTO REREAD
     C                     ENDIF
     C                     ELSE
      *
      ***  Load Option Number for reports.
      *
     C                     MOVE MBOPTN    ROPTNO           CO Allocation by Depots report
     C                     MOVE MBOPTN    ROPNUM           CO Allocation by Customers/Books report
     C                     ENDIF
      *
      ***  Set-up work fileds.
      *
     C                     Z-ADD1         WTREF            Indicator CO Reference processed
     C**********           Z-ADD0         WPDEPO  60       Reset Depot saved field            CSD027
     C                     MOVE *BLANKS   WPDEPO  6        Reset Depot saved field            CSD027
     C                     MOVE *BLANKS   WPSEC  10        Reset Security saved field
     C                     MOVE *BLANKS   WPBRCD  3        Reset Branch saved field
      *
      ***  Save CO Reference and Option Number from CO Depot details file.
      *
     C                     MOVE MBCORF    WPCARF  6        CO Reference
     C                     Z-ADDMBOPTN    WPOPTN  20       Option Number
      *
      ***  Do while same CO Reference from CO Depot details file and not end of CO Depot details
      ***  file.
      *
     C           MBCORF    DOWEQWPCARF
     C           *IN82     ANDNE'1'
      *
      ***  Reset work field.
      *
     C                     Z-ADD0         WSUM   150
      *
      ***  If change of Option Number, load reports fields and set-up saved fields.
      *
     C           MBOPTN    IFNE WPOPTN
     C                     MOVE MBOPTN    ROPTNO           Option Number of CO Alloc.by Depot report
     C                     MOVE MBOPTN    ROPNUM           Opt Num of CO Alloc.by Cust/Book report
     C                     Z-ADDMBOPTN    WPOPTN           Save Option Number
     C**********           Z-ADD0         WPDEPO           Reset Depot saved field            CSD027
     C                     MOVE *BLANKS   WPDEPO           Reset Depot saved field            CSD027
     C                     ENDIF
      *
      ***  If New Security from CO Depot details file = '**CASH**'.
      *
     C           MBSESN    IFEQ '**CASH**'
      *
     C                     MOVE *BLANKS   WUNSEC 10
      *
      ***  Retrieve New Security Shortname on Corporate Actions Detail file, depending on Processing
      ***  Type, not for Processing Type Capital Changes and Non Financial Events, where New
      ***  Security = Event Security.
      *
     C                     SELEC
     C           MAPTYP    WHEQ 'DV'                       Divedend Events
     C           WKEY2     SETGTSECODVL1
     C           WKEY2     REDPESECODVL1                 89
     C                     MOVE MDNSEC    WUNSEC
     C                     MOVEL'SECODVL1'DBFILS  8
      *
     C           MAPTYP    WHEQ 'FR'                       Free Allocation
     C           WKEY2     SETGTSECOFRL1
     C           WKEY2     REDPESECOFRL1                 89
     C                     MOVE MENSEC    WUNSEC
     C                     MOVEL'SECOFRL1'DBFILS
      *
     C           MAPTYP    WHEQ 'RG'                       Rights Issues
     C           WKEY2     SETGTSECORGL1
     C           WKEY2     REDPESECORGL1                 89
     C                     MOVE MFNSEC    WUNSEC
     C                     MOVEL'SECORGL1'DBFILS
      *
     C           MAPTYP    WHEQ 'OF'                       Offers
     C           WKEY2     SETGTSECOOFL1
     C           WKEY2     REDPESECOOFL1                 89
     C                     MOVE MINSEC    WUNSEC
     C                     MOVEL'SECOOFL1'DBFILS
      *
     C           MAPTYP    WHEQ 'EX'                       Exercices and Conversions
     C           WKEY2     SETGTSECOEXL1
     C           WKEY2     REDPESECOEXL1                 89
     C                     MOVE MJNSEC    WUNSEC
     C                     MOVEL'SECOEXL1'DBFILS
      *
     C           MAPTYP    WHEQ 'NC'                       Name Changes
     C           WPCARF    SETGTSECONCL1
     C           WPCARF    REDPESECONCL1                 89
     C                     MOVE MLSESN    WUNSEC
     C                     MOVEL'SECONCL1'DBFILS
      *
     C           MAPTYP    WHEQ 'CC'                       Currency       CEU017
     C           WPCARF    SETGTSECOCCL2                   Changes        CEU017
     C           WPCARF    REDPESECOCCL2                 89               CEU017
     C                     MOVE NANSEC    WUNSEC                          CEU017
     C                     MOVEL'SECOCCL2'DBFILS                          CEU017
      *                                                                   CEU017
      ***  If record not found, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     Z-ADD007       DBASE            ***************
     C                     MOVELDBFILS    DBFILE           * DB ERROR 07 *
     C                     MOVEL'SE7534'  DBPGM            ***************
     C           MAPTYP    IFEQ 'NC'
     C           MAPTYP    OREQ 'CC'
     C                     MOVELWPCARF    DBKEY
     C                     ELSE
     C                     MOVELWPCARF    DBKEY3
     C                     MOVE WPOPTN    DBKEY3
     C                     MOVELDBKEY3    DBKEY
     C                     ENDIF
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDSL
      *
      ***  If New Security retrieve not blank (for Processing Type NC, if Security from CO detail
      ***  file is blank, New Security = Event Security).
      *
     C           WUNSEC    IFNE *BLANKS
      *
      ***  Chain Security Shortname from LF/SECTY to retrieve New Currency.
      *
     C                     MOVE WUNSEC    WSESN
     C                     EXSR SRSEC
      *
      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM NMCY      WAJCD
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD008       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 08 *
     C                     MOVELWAJCD     DBKEY            ***************
     C                     MOVEL'SE7534'  DBPGM
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Set Number of Decimal Places used in standart subroutine to New Currency Decimal
      ***  Places.
      *
     C                     Z-ADDA6NBDP    ZDECS
      *
      ***  Set Currency fields for Cash line to New Currency.
      *
     C                     MOVE NMCY      RCCY1
     C                     MOVE NMCY      RCCY2
      *
      ***  Else, if New Security retrieve is blank or No access done (= New Security = Event
      ***  Security).
      *
     C                     ELSE
      *
      ***  Set Number of Decimal Places used in standart subroutine to Event Currency Decimal
      ***  Places.
      *
     C                     MOVE ECNBDP    ZDECS
      *
      ***  Set Currency fields for Cash line to Event Currency.
      *
     C                     MOVE ECCY      RCCY1
     C                     MOVE ECCY      RCCY2
     C                     ENDIF
      *
      ***  Load Cash line fields for CO Allocation by Depot report.
      *
     C           MBACAA    ADD  MBACAR    WSUM             Total Actual Cash Allocation + Rounding
     C                     MOVE WSUM      ZFLD15
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCSACT
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCSACT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCSACT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCSACT                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCSACT                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCSACT                          136930
      *
     C                     MOVE MBBCAA    ZFLD15           Balancing Cash Allocation
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCSBAL
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCSBAL                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCSBAL                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCSBAL                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCSBAL                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCSBAL                          136930
      *
     C                     MOVE MBCAOP    ZFLD15           Original Cash Option
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCOORG
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCOORG                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCOORG                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCOORG                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCOORG                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCOORG                          136930
      *
     C                     MOVE MBACAA    ZFLD15           Actual Cash Allocation
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCOACT
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCOACT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCOACT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCOACT                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCOACT                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCOACT                          136930
      *
     C                     MOVE MBOCAR    ZFLD15           Original Cash Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCRORG
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCRORG                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCRORG                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCRORG                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCRORG                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCRORG                          136930
      *
     C                     MOVE MBACAR    ZFLD15           Actual Cash Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCRACT
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RCRACT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RCRACT                          136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RCRACT                          136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RCRACT                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RCRACT                          136930
     C                     ENDIF
      *
      ***  If Change of Depot or Branch.
      *
     C           WPDEPO    IFNE MBDDPT
     C           WPBRCD    ORNE MBBRCD
      *
      ***  Set-up work fields and indicator.
      *
     C                     MOVE *BLANKS   WPSEC            Reset Security saved field
     C                     MOVE '1'       *IN70            Indicator Change of Depot or Branch
     C                     MOVE MBDDPT    WPDEPO           Save Depot
     C                     MOVE MBBRCD    WPBRCD           Save Branch
     C                     MOVE 'N'       WWDUMC           Dummy Cust.    135683
      *
      ***  Retrieve Depot Reference details for CO Reference, Branch and Depot processed.
      *
     C           WKEY1     CHAINSECODRL1             80
      *
      ***  If record not found, handle database error.
      *
     C           *IN80     IFEQ '1'
     C           MSRECI    ORNE 'D'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECODRL1'DBFILE           ***************
     C                     Z-ADD009       DBASE            * DB ERROR 09 *
     C                     MOVEL'SE7534'  DBPGM            ***************
     C                     MOVELMBCORF    DBKEY1  9
     C                     MOVE MBBRCD    DBKEY1
     C                     MOVELDBKEY1    DBKEY2 15
     C                     MOVE MBDDPT    DBKEY2 15
     C                     MOVELDBKEY2    DBKEY
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Load Status reports fields.
      *
     C                     SELEC
     C           MSCOST    WHEQ 'L'                        Status = 'Allocated'
     C                     MOVEAARPT,1    RSTAT              Status for CO Alloc. by Depot report
     C                     MOVEAARPT,1    RSTATU             Status for CO Alloc.by Cust/Book report
     C           MSCOST    WHEQ 'X'                        Status = 'Stock Authorised'
     C           MSFAID    ANDEQ'S'
     C                     MOVEAARPT,2    RSTAT              Status for CO Alloc. by Depot report
     C                     MOVEAARPT,2    RSTATU             Status for CO Alloc.by Cust/Book report
     C           MSCOST    WHEQ 'X'                        Status = 'Fully Authorised'
     C           MSFAID    ANDEQ'Y'
     C                     MOVEAARPT,3    RSTAT              Status for CO Alloc. by Depot report
     C                     MOVEAARPT,3    RSTATU             Status for CO alloc.by Cust/Book report
     C                     ENDSL
      *
      ***  Load Final Allocation reports fields.
      *
     C                     SELEC
     C           MSFAID    WHEQ 'N'                        Final Allocation = 'Trial'
     C                     MOVEAARPT,4    RFINAL             Final Alloc. for CO Alloc./Depot report
     C                     MOVEAARPT,4    RFALLO             Final Alloc.for CO Alloc.by C/B report
     C           MSFAID    WHEQ 'S'                        Final Allocation = 'Final Stock'
     C                     MOVEAARPT,5    RFINAL             Final Alloc. for CO Alloc./Depot report
     C                     MOVEAARPT,5    RFALLO             Final Alloc.for CO Alloc.by C/B report
     C           MSFAID    WHEQ 'Y'                        Final Allocation = 'Final Stock/Cash'
     C                     MOVEAARPT,6    RFINAL             Final Alloc. for CO Alloc./Depot report
     C                     MOVEAARPT,6    RFALLO             Final Alloc.for CO Alloc.by C/B report
     C                     ENDSL
      *
      ***  Load Currency and Branch for Depot details line of reports.
      *
     C                     MOVE ECCY      RCCY             Ccy for CO Alloc. by Depot report
     C                     MOVE ECCY      RCYCD            Ccy for CO Alooc. by Cust/Books report
     C                     MOVE MBBRCD    RBRCH            Branch for CO Alloc. by Deopt report
     C                     MOVE MBBRCD    RBRCOD           Branch for CO Alloc.by Cust/Books report
      *
      ***  Set Number of Decimal Places used in standart subroutine to event Security Decimal
      ***  Places.
      *
     C                     MOVE ESNBDP    ZDECS
      *
      ***  Retrieve Depot Report Name by calling access object.
      *
     C                     MOVE *BLANKS   WKEYC
     C                     MOVELMBDDPT    WKEYC
     C***********          CALL 'AOCUSTR0'                                229342
     C                     CALL 'AOCUSTR1'                                229342
     C                     PARM '*DBERR'  WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM           WKEYC  10
     C                     PARM *BLANKS   WKYST   7
     C***********SDCUST    PARM SDCUST    DSSDY                           229342
     C           SDCUST    PARM SDCUST    DSLDY                           229342
      *
      ***  If record not found, handle database error.
      *
     C           WRTCD     IFNE *BLANKS
     C           BBCLST    ANDNE'Y'                                       229342
     C           *LOCK     IN   LDA
     C                     Z-ADD010       DBASE            ***************
     C                     MOVEL'SDCUSTPD'DBFILE           * DB ERROR 10 *
     C                     MOVELWKEYC     DBKEY            ***************
     C                     MOVEL'SE7534'  DBPGM
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Load Depot Report Name fields for reports.
      *
     C                     MOVELBBCSSN    RDEPO            for CO Allocation by Depot report
     C                     MOVELBBCSSN    RDEPOT           for CO Allocation by Cust/Books report
      *
      ***  Load reports fields.
      *
     C                     MOVE MBEXPO    ZFLD15           Ex-Date Position
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C******               MOVE ZOUT22    REXPOS                          136930
     C******               MOVE ZOUT22    RXPOS                           136930
     C                     MOVE ZOUT21    REXPOS                          136930
     C                     MOVE ZOUT21    RXPOS                           136930
      *
     C                     MOVE MBHOST    ZFLD15           Holding Taken as Stock
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C******               MOVE ZOUT22    RHOLD                           136930
     C******               MOVE ZOUT22    RHOTS                           136930
     C                     MOVE ZOUT21    RHOLD                           136930
     C                     MOVE ZOUT21    RHOTS                           136930
      *
     C                     MOVE MSCOAD    ZDAYNO           Last Allocation Date
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RLAST              for CO Alloc. by Depot report
     C                     MOVE ZADATE    RLALLO             for CO Alloc. by Cust/Books report
      *
      ***  If CO Status from CO Depot References file = 'I' (Incomplet), set Status and Final
      ***  Allocation reports fields to blank.
      *
     C           MSCOST    IFEQ 'I'
     C                     MOVE *BLANK    RSTAT            Status for CO Alloc. by Depot report
     C                     MOVE *BLANK    RSTATU           Status for CO Alloc.by Cust/Books report
     C                     MOVE *BLANK    RFINAL           Final Alloc.for CO Alloc.by Depot report
     C                     MOVE *BLANK    RFALLO           Final Alloc.for CO Alloc.by C/B report
     C                     ENDIF
      *
      ***  Print header and details for CO Allocation by Depots report (SE7534P1).
      *
     C                     WRITEHEADP1                     write header
     C                     WRITEDET1P1                     write details for CO Reference
     C                     WRITEDET2P1                     write sub-heading for Branch/Depot
     C                     WRITEDET3P1                     write details for Branch/Depot
      *
      ***  Print header and details for CO Allocation by Customers/Books report (SE7534P2).
      *
     C                     WRITEHEADP2                     write header
     C                     WRITEDET1P2                     write details for CO Reference
     C                     WRITEDET2P2                     write sub-heading for Branch/Depot
     C                     WRITEDET3P2                     write details for Branch/Depot
      *
      ***  If Status from CO Depot Reference file = 'I' (Incomplet), write null report record, reset
      ***  indicator change of Branch or Depot and read next record on CO Depot details file.
      *
     C           MSCOST    IFEQ 'I'
     C                     WRITENODTP1                     for CO Allocation by Depot report
     C                     WRITENODTP2                     for CO Alloc. by Customers/Books report
     C                     MOVE '0'       *IN70            indicator change of Branch or Depot
     C                     GOTO READDP                     read next record
     C                     ENDIF
      *
      ***  Write sub-heading for Security details on CO Allocation by Depot report.
      *
     C                     WRITEDET4P1
      *
      ***  If Security from CO Depot details file = '**CASH**', write details for CASH Security and
      ***  save Security from CO Depot details file.
      *
     C           MBSESN    IFEQ '**CASH**'
     C                     WRITEDET5P1
     C                     MOVE MBSESN    WPSEC
     C                     ENDIF
      *
      ***  Process Customers/Books details for the Depot processed.
      *
     C                     EXSR SRCUST
      *
     C                     ENDIF
      *
      ***  If change of New Security and change of Branch or Depot.
      *
     C           WPSEC     IFNE MBSESN
     C           *IN70     ANDEQ'1'
      *
      ***  Retrieve New Currency, New Security Decimal Places.
      *
     C           MBSESN    IFEQ '**CASH**'
     C                     MOVE MASESN    WSESN
     C                     ELSE
     C                     MOVE MBSESN    WSESN
     C                     ENDIF
     C                     EXSR SRSEC
     C                     MOVE NMDP      NSNBDP  10       New Security Decimal Places
     C                     MOVE NMCY      RCCY3            New Currency
      *
      ***  Load New Security report field and save New Security.
      *
     C                     MOVE MBSESN    WPSEC            Save New Security
     C                     MOVE MBSESN    RNSEC            New Security for CO Alloc.by Depot report
      *
      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM NMCY      WAJCD
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD011       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 11 *
     C                     MOVELWAJCD     DBKEY            ***************
     C                     MOVEL'SE7534'  DBPGM
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    NCNBDP  10       New Currency Decimal Places
      *
      ***  Print New Security details on CO Allocation by Depot report (SE7534P1).
      *
     C           OFLLN1    SUB  PRTLN1    WREM1   20
     C           WREM1     IFLT 16                         If end of page
     C                     WRITEHEADP1                       write header
     C                     WRITEDET1P1                       write details for CO Reference
     C                     WRITEDET2P1                       write sub-heading for Branch/Depot
     C                     WRITEDET3P1                       write details for Branch/Depot
     C                     WRITEDET4P1                       write sub-heading for Security
     C                     ENDIF
      *
     C                     WRITEDET6P1                     write New Security details
      *
      ***  Load report fields.
      *
     C                     MOVEAATIT,1    RTITLE           Stock Allocation title
     C                     Z-ADDNSNBDP    ZDECS            New Security Decimal Places
      *
     C                     MOVE MBOALR    ZFLD15           Original Stock Allocation
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RORG
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RORG                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RORG                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RORG                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RORG                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RORG                            136930
      *
     C                     MOVE MBASTA    ZFLD15           Actual Stock Allocation
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RACT
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RACT                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RACT                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RACT                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RACT                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RACT                            136930
      *
     C                     MOVE MBBSTA    ZFLD15           Balancing Stock Allocation
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RBAL
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RBAL                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RBAL                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RBAL                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RBAL                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RBAL                            136930
      *
      ***  Write Depot details for Stock Allocation for the New Security.
      *
     C           OFLLN1    SUB  PRTLN1    WREM1   20
     C           WREM1     IFLT 16                         If end of page
     C                     WRITEHEADP1                       write header
     C                     WRITEDET1P1                       write details for CO Reference
     C                     WRITEDET2P1                       write sub-heading for Branch/Depot
     C                     WRITEDET3P1                       write details for Branch/Depot
     C                     WRITEDET4P1                       write sub-heading for Security
     C                     ENDIF
      *
     C                     WRITEDET7P1                     write New Security Alloc. details
      *
      ***  Load report fields.
      *
     C                     MOVEAATIT,2    RTITLE           Stock Rounding title
     C                     Z-ADD8         ZDECS            8 Decimal Places
      *
     C                     MOVE MBOSTR    ZFLD15           Original Stock Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C******               MOVE ZOUT25    RORG                            136930
     C                     MOVE ZOUT21    RORG                            136930
      *
     C                     MOVE MBASTR    ZFLD15           Actual Stock Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C******               MOVE ZOUT25    RACT                            136930
     C                     MOVE ZOUT21    RACT                            136930
      *
     C                     MOVE MBBSTR    ZFLD15           Balancing Stock Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C******               MOVE ZOUT25    RBAL                            136930
     C                     MOVE ZOUT21    RBAL                            136930
      *
      ***  Write Depot details for Stock Rounding for the New Security.
      *
     C           OFLLN1    SUB  PRTLN1    WREM1   20
     C           WREM1     IFLT 16
     C                     WRITEHEADP1                       write header
     C                     WRITEDET1P1                       write details for CO Reference
     C                     WRITEDET2P1                       write sub-heading for Branch/Depot
     C                     WRITEDET3P1                       write details for Branch/Depot
     C                     WRITEDET4P1                       write sub-heading for Security
     C                     ENDIF
      *
     C                     WRITEDET7P1                     write New Security Alloc. details
      *
      ***  Load report fields.
      *
     C                     MOVEAATIT,3    RTITLE           Cash Rounding title
     C                     Z-ADDNCNBDP    ZDECS            New Currency Decimal Places
      *
     C                     MOVE MBOCAR    ZFLD15           Original Cash Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RORG
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RORG                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RORG                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RORG                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RORG                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RORG                            136930
      *
     C                     MOVE MBACAR    ZFLD15           Actual Cash Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RACT
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RACT                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RACT                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RACT                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RACT                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RACT                            136930
      *
     C                     MOVE MBBCAR    ZFLD15           Balancing Cash Rounding
     C******               EXSR ZFRPED                                    136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RBAL
     C******     ZDECS     IFEQ 0                                         136930
     C******               MOVE ZOUT0     RBAL                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 1                                         136930
     C******               MOVE ZOUT1     RBAL                            136930
     C******               ELSE                                           136930
     C******     ZDECS     IFEQ 2                                         136930
     C******               MOVE ZOUT2     RBAL                            136930
     C******               ELSE                                           136930
     C******               MOVE ZOUT25    RBAL                            136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C******               ENDIF                                          136930
     C                     MOVE ZOUT21    RBAL                            136930
      *
      ***  Write Depot details for Cash Rounding for the New Security.
      *
     C           OFLLN1    SUB  PRTLN1    WREM1   20
     C           WREM1     IFLT 16
     C                     WRITEHEADP1                       write header
     C                     WRITEDET1P1                       write details for CO Reference
     C                     WRITEDET2P1                       write sub-heading for Branch/Depot
     C                     WRITEDET3P1                       write details for Branch/Depot
     C                     WRITEDET4P1                       write sub-heading for Security
     C                     ENDIF
      *
     C                     WRITEDET7P1                     write New Security Alloc. details
      *
     C                     ENDIF
      *
      ***  Read next record on CO Depot details file.
      *
     C           READDP    TAG
     C                     READ SECODPD0                 82
      *
     C                     ENDDO
      *
      ***  Read next record on CO References file.
      *
     C           REREAD    TAG
     C                     READ SECORFD0                 81
      *
      ***  If CO Reference selected (= CO Reference received as parameter not blank), stop
      ***  processing (only this CO Reference to process).
      *
     C           WCARF     IFNE *BLANKS
     C                     MOVE '1'       *IN81
     C                     GOTO ENDDEP
     C                     ENDIF
      *
      ***  Move CO Reference fields to P1 and P2 headers.
      *
     C                     EXSR SRREF
      *
     C           ENDDEP    TAG
     C                     ENDDO
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRREF  - Move SECORFPD fields to P1 and P2 headers.          *
      *                                                               *
      *  Called by: SRINIT - Program initialisation.                  *
      *             SRDEPO - Depot processing.                        *
      *                                                               *
      *  Calls: SRSEC    - Chain Security Shortname from LF/SECTY.    *
      *         *PSSR    - Error Routine.                             *
      *         ZDATE2   - Standart subroutine to convert a Day       *
      *                    Number to date formats.                    *
      *         AOCURRR0 - Midas AO Currency codes access object.     *
      *                                                               *
      *****************************************************************
      *
     C           SRREF     BEGSR                           ** SRREF SR **
      *
      ***  Retrieve Decimal Places, Currency and Security Report Name for the Event Security.
      *
     C                     MOVE MASESN    WSESN
     C                     EXSR SRSEC
     C                     MOVE NMDP      ESNBDP  10       Event Security Decimal Places
     C                     MOVE NMCY      ECCY    3        Event Currency
      *
      ***  Load fields for CO Allocation by Depot report (SE7534P1).
      *
     C                     MOVE NMCY      RNMCCY           Nominal Currency
     C                     MOVE NMCY      RCCY             Currency for Branch/Depot details
     C                     MOVE SRPN      RREPNA           Security Report Name
      *
      ***  Load fields for CO Allocation by Customers/Books report (SE7534P2).
      *
     C                     MOVE NMCY      RNOCCY           Nominal Currency
     C                     MOVE NMCY      RCYCD            Currency for Branch/Depot details
     C                     MOVE SRPN      RREPT            Security Report Name
      *
      ***  Set edit code used in standart subroutine to 'J' (Decimal point, sign '-', leading 0
      ***  suppressed, commas and print 0 balance).
      *
     C                     MOVE 'J'       ZECODE
      *
      ***  Retrieve Number of Decimal Places of Event Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' WRTCD
     C                     PARM '*KEY   ' WOPTN
     C                     PARM NMCY      WAJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           WRTCD     IFNE *BLANKS
     C           *LOCK     IN   LDA
     C                     Z-ADD012       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 12 *
     C                     MOVELWAJCD     DBKEY            ***************
     C                     MOVEL'SE7534'  DBPGM
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    ECNBDP  10       Event Currency Decimal Places
      *
      ***  Retrieve CO Type Description and CO Processing Type.
      *
     C           MACOAT    CHAINSECOATD0             80
      *
      ***  If record not found, handle database error.
      *
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECOATL0'DBFILE
     C                     MOVELMACOAT    DBKEY            ***************
     C                     Z-ADD013       DBASE            * DB ERROR 13 *
     C                     MOVEL'SE7534'  DBPGM            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Load reports fields (P1 = for CO Allocation by Depot report (SE7534P1)
      ***                       P2 = for CO Allocation by Customers/Books report (SE7534P2)).
      *
     C                     MOVE MASESN    RSEC             Security Shortname (P1)
     C                     MOVE MASESN    RSECUR           Security Shortname (P2)
      *
     C                     MOVE MACORF    RREFNO           CO Reference (P1)
     C                     MOVE MACORF    RREFER           CO Reference (P2)
      *
     C                     MOVE MACOAN    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RDATAN           Date of Announcement (P1)
     C                     MOVE ZADATE    RDTANN           Date of Announcement (P2)
      *
     C                     MOVE MACOEX    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    REXDAT           Ex-Date (P1)
     C                     MOVE ZADATE    RXDATE           Ex-Date (P2)
      *
     C                     MOVE MANBOP    RNOOPT           Number of Options (P1)
     C                     MOVE MANBOP    RNOPTS           Number of Options (P2)
      *
     C                     MOVE MAALEF    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RALEFF           Allocation Effective Date (P1)
     C                     MOVE ZADATE    RALOEF           Allocation Effective Date (P2)
      *
     C                     MOVE MMDESC    RNARRA           CO Type Description (P1) = Narrative
     C                     MOVE MMDESC    RNARAT           CO Type Description (P2) = Narrative
      *
     C                     MOVE MACOPD    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    RPAYDT           Payment Date (P1)
     C                     MOVE ZADATE    RPAY             Payment Date (P2)
      *
     C                     MOVE MAEVDT    ZDAYNO
     C                     EXSR ZDATE2
     C                     MOVE ZADATE    REVDT            Event Date (P1)
     C                     MOVE ZADATE    REVENT           Event Date (P2)
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRAUDT - Audit processing.                                   *
      *                                                               *
      *  Called by: Main processing.                                  *
      *             SRINIT - Program initialisation.                  *
      *             *PSSR  - Error Routine.                           *
      *                                                               *
      *  Calls: SRSFIL - Register printer files via RCF.              *
      *                                                               *
      *****************************************************************
      *
     C           SRAUDT    BEGSR                           ** SRAUDT SR **
      *
      ***  If there is a database error, output the database error information.
      *
     C           *INU7     IFEQ '1'
      *
      ***  If CO Allocation by Depot report opened, write database error information.
      *
     C           WOPEN1    IFEQ 'Y'
     C                     WRITEDBERP1
     C                     ENDIF
      *
      ***  If CO Allocation by Customers/Books report opened, write database error information.
      *
     C           WOPEN2    IFEQ 'Y'
     C                     WRITEDBERP2
     C                     ENDIF
      *
      ***  Write the database error information on Audit report.
      *
     C                     WRITEHEADAU
     C                     WRITEDBERROR
     C                     ELSE
      *
      ***  If no records read, output "No Details" message.
      *
     C           WTREF     IFEQ 0
      *
      ***  On Audit report.
      *
     C                     WRITEHEADAU
     C                     WRITENODTLS
     C                     ELSE
      *
      ***  If records read, output "End of Report" message.
      *
     C                     WRITETRAILP1                    On CO Allocation by Depot report
     C                     WRITETRAILP2                    On CO Alloc.by Customers/Books report
     C                     ENDIF
     C                     ENDIF
      *
      ***  If CO Allocation by Depot report opened, process RCF for SE7534P1 file.
      *
     C           WOPEN1    IFEQ 'Y'
     C                     MOVELSFILE1    ZSILEU
     C                     Z-ADDSFNUM1    ZSNUMU  60
     C                     EXSR SRSFIL
     C                     ENDIF
      *
      ***  If CO Allocation by Customers/Books report opened, process RCF for SE7534P2 file.
      *
     C           WOPEN2    IFEQ 'Y'
     C                     MOVELSFILE2    ZSILEU
     C                     Z-ADDSFNUM2    ZSNUMU  60
     C                     EXSR SRSFIL
     C                     ENDIF
      *
      ***  End of program: close all files and return.
      *
     C                     CLOSE*ALL
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRSFIL - Register Printer Files via RCF.                     *
      *                                                               *
      *  Called by: SRINIT - Program initialisation.                  *
      *             SRAUDT - Audit processing.                        *
      *                                                               *
      *  Calls: ZSFILE - Midas FC Set-up spool file numbers file.     *
      *                                                               *
      *****************************************************************
      *
     C           SRSFIL    BEGSR                           ** SRSFIL SR **
      *
     C                     CALL 'ZSFILE'
     C                     PARM WRSEQ     SEQ     5
     C                     PARM *BLANKS   SENTY   3
     C                     PARM           ZSILEU 10
     C                     PARM           ZSNUMU  60
     C                     PARM *BLANK    ZSERR   1
      *
      ***  If Error occurs during ZSFILE processing, then return to the Calling program.
      *
     C           ZSERR     IFEQ 'Y'
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     RETRN
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRCDEP - Chain MACORF from PF/SECODPPD.                      *
      *                                                               *
      *  Called by: SRDEPO - Depot processing.                        *
      *                                                               *
      *  Calls: None.                                                 *
      *                                                               *
      *****************************************************************
      *
     C           SRCDEP    BEGSR                           ** SRCDEP SR **
      *
      ***  Retrieve first live record on CO Depot details file.
      *
     C           MACORF    CHAINSECODPD0             80
      *
      ***  If record found, load Option Number for reports.
      *
     C           *IN80     IFEQ '0'
     C                     MOVE MBOPTN    ROPTNO           for CO Allocation by Depot report
     C                     MOVE MBOPTN    ROPNUM           for CO Alloc. by Customers/Books report
     C                     ELSE
      *
      ***  Else, if record not found, set Option Number for reports to blank.
      *
     C                     MOVE *BLANKS   ROPTNO           for CO Allocation by Depot report
     C                     MOVE *BLANKS   ROPNUM           for CO Alloc. by Customers/Books report
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  SRSEC  - Chain Security Shortname from LF/SECTY.             *
      *                                                               *
      *  Called by: SRCUST - Customers/Books Processing.              *
      *             SRDEPO - Depot processing.                        *
      *             SRREF  - Move SECORFPD fields to P1 and P2        *
      *                      headers.                                 *
      *                                                               *
      *  Calls: *PSSR  - Error Routine.                               *
      *                                                               *
      *****************************************************************
      *
     C           SRSEC     BEGSR                           ** SRSEC SR **
      *
      ***  Retrieve details for the Security.
      *
     C           WSESN     CHAINSECTYDF              80
      *
      ***  If record not found, handle database error.
      *
     C           *IN80     IFEQ '1'
     C           *LOCK     IN   LDA
     C                     MOVEL'SECTY'   DBFILE
     C                     MOVELWSESN     DBKEY            ***************
     C                     Z-ADD014       DBASE            * DB ERROR 14 *
     C                     MOVEL'SE7534'  DBPGM            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************   135683
      *                                                               *   135683
      *  SRDUMC - Dummy Customer processing.                          *   135683
      *                                                               *   135683
      *  Called by: SRCUST - Customers/Books Processing.              *   135683
      *                                                               *   135683
      *  Calls: SRSEC    - Chain Security Shortname from LF/SECTY.    *   135683
      *         *PSSR    - Error Routine.                             *   135683
      **********ZFRPED***-*Standard*subroutine*to*insert*a*decimal*****   135683 136930
      *********************point*and*sign*into*a*numeric*field*and*****   135683 136930
      *********************to*blank*out*leading*zeros*(optionaly*******   135683 136930
      *********************inserting commas).**************************   135683 136930
      *         ZSEDIT   - Standard subroutine to insert a decimal    *   136930
      *                    point and sign into a numeric field and to *   136930
      *                    blank out leading zeros (optionaly         *   136930
      *                    inserting commas).                         *   136930
      *         AOCUSTR0 - Midas AO Client details access object.     *   135683
      *         AOCURRR0 - Midas AO Currency codes access object.     *   135683
      *                                                               *   135683
      *****************************************************************   135683
      *                                                                   135683
     C           SRDUMC    BEGSR                           ** SRDUMC SR **135683
      *                                                                   135683
      ***  Set key fields for SECOALL3.                                   135683
      *                                                                   135683
     C                     MOVE 'C'       WUCOTP           Cust./Book Ind.135683
     C                     MOVE *BLANKS   WUBOOK           Book           135683
     C                     MOVE BVERCU    WUERCU           Dummy Cust.    135683
      *                                                                   135683
      ***  Set some fields to blank.                                      135683
      *                                                                   135683
     C**********           MOVE *BLANKS   WPCUST  60       Customer                    135683 CSD027
     C                     MOVE *BLANKS   WPCUST  6        Customer                           CSD027
     C                     MOVE *BLANKS   WPPTFR  4        Portfolio      135683
      *                                                                   135683
      ***  Retrieve CO Allocation details for CO Reference, Option        135683
      ***  Number, Branch and Depot from CO Depots details.               135683
      *                                                                   135683
     C           WKEY3     SETLLSECOALD0                                  135683
     C           WKEY3     READESECOALD0                 83               135683
      *                                                                   135683
      ***  Save some fields and set other one to blank.                   135683
      *                                                                   135683
     C                     MOVE MCCORF    WPCORF  6        CO Reference   135683
     C                     MOVE MCOPTN    WPOPT   20       Option Number  135683
     C                     MOVE MCBRCD    WPBRCH  3        Branch         135683
     C**********           MOVE MCDDPT    WPDPT   60       Depot                       135683 CSD027
     C**********           MOVE *BLANKS   WPCUST  60       Customer=blank              135683 CSD027
     C                     MOVE MCDDPT    WPDPT   6        Depot                              CSD027
     C                     MOVE *BLANKS   WPCUST  6        Customer=blank                     CSD027
     C                     MOVE *BLANKS   WPPTFR  4        Portfolio=blank135683
     C                     MOVE *BLANKS   WPBOOK  2        Book = blank   135683
      *                                                                   135683
      ***  Do while not end of file and same CO Reference, same Option    135683
      ***  Number, same Branch, same Depot, same Customer (= Dummy        135683
      ***  Customer) read.                                                135683
      *                                                                   135683
     C           *IN83     DOWEQ'0'                        Not end of file135683
      *                                                                   135683
      ***  Set Book save field to blank.                                  135683
      *                                                                   135683
     C                     MOVE *BLANKS   WPBOOK                          135683
      *                                                                   135683
      ***  If Change of Customer, Portfolio or Book.                      135683
      *                                                                   135683
     C           MCCNUM    IFNE WPCUST                                    135683
     C           MCPTFR    ORNE WPPTFR                                    135683
      *                                                                   135683
      ***  Set flag to 'Y' to write sub-heading for New Security          135683
      ***  Allocation details.                                            135683
      *                                                                   135683
     C                     MOVE 'Y'       WFLAG   1                       135683
      *                                                                   135683
      ***  Set Security save field to blank.                              135683
      *                                                                   135683
     C                     MOVE *BLANKS   WPSECU                          135683
      *                                                                   135683
      ***  Set Currency for Book/Customer detail report format to Event   135683
      ***  Currency.                                                      135683
      *                                                                   135683
     C                     MOVE ECCY      RCYCD1                          135683
      *                                                                   135683
      ***  Set Number of Decimal Places used in standart subroutine to    135683
      ***  Event Security Decimal Places.                                 135683
      *                                                                   135683
     C                     MOVE ESNBDP    ZDECS                           135683
      *                                                                   135683
      ***  Save Customer and Portfolio.                                   135683
      *                                                                   135683
     C                     MOVE MCCNUM    WPCUST           Customer       135683
     C                     MOVE MCPTFR    WPPTFR           Portfolio      135683
      *                                                                   135683
      ***  Retrieve Customer Report Name by calling access object.        135683
      *                                                                   135683
     C                     MOVE *BLANKS   RBOOK                           135683
      *                                                                   135683
     C                     MOVE *BLANKS   WKEYC                           135683
     C                     MOVELMCCNUM    WKEYC                           135683
     C*****************    CALL 'AOCUSTR0'                         135683 229342
     C                     CALL 'AOCUSTR1'                                229342
     C                     PARM '*DBERR'  WRTCD                           135683
     C                     PARM '*KEY   ' WOPTN                           135683
     C                     PARM           WKEYC  10                       135683
     C                     PARM *BLANKS   WKYST   7                       135683
     C***********SDCUST    PARM SDCUST    DSSDY                    135683 229342
     C           SDCUST    PARM SDCUST    DSLDY                           229342
      *                                                                   135683
      ***  If record not found, handle database error.                    135683
      *                                                                   135683
     C           WRTCD     IFNE *BLANKS                                   135683
     C           BBCLST    ANDNE'Y'                                       229342
     C           *LOCK     IN   LDA                                       135683
     C                     Z-ADD016       DBASE            ***************135683
     C                     MOVEL'SDCUSTPD'DBFILE           * DB ERROR 16 *135683
     C                     MOVELWKEYC     DBKEY            ***************135683
     C                     MOVEL'SE7534'  DBPGM                           135683
     C                     EXSR *PSSR                                     135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Load 'Customer Report Name' report field.                      135683
      *                                                                   135683
     C                     MOVELBBCSSN    RBOOK                           135683
      *                                                                   135683
      ***  Load report fields.                                            135683
      *                                                                   135683
     C                     MOVE MCPTFR    RPTFR            Portfolio      135683
      *                                                                   135683
      ***  Ex-Date Position.                                              135683
      *                                                                   135683
     C                     MOVE MCEXPO    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCEXDT                          135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCEXDT                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCEXDT                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCEXDT                   135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCEXDT                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCEXDT                          136930
      *                                                                   135683
      ***  Holding Taken as Stock.                                        135683
      *                                                                   135683
     C                     MOVE MCHOST    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCHOLD                          135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCHOLD                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCHOLD                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCHOLD                   135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCHOLD                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCHOLD                          136930
      *                                                                   135683
     C                     MOVE *BLANKS   RREPLY                          135683
     C                     SELEC                           Reply Status   135683
     C           MCREST    WHEQ 'R'                                       135683
     C                     MOVEAARPT,7    RREPLY                          135683
     C           MCREST    WHEQ 'S'                                       135683
     C                     MOVEAARPT,8    RREPLY                          135683
     C           MCREST    WHEQ 'C'                                       135683
     C                     MOVEAARPT,9    RREPLY                          135683
     C           MCREST    WHEQ 'M'                                       135683
     C                     MOVEAARPT,10   RREPLY                          135683
     C           MCREST    WHEQ 'N'                                       135683
     C                     MOVE *BLANKS   RREPLY                          135683
     C                     ENDSL                                          135683
      *                                                                   135683
      ***  Write Book/Customer Details.                                   135683
      *                                                                   135683
     C           OFLLN2    SUB  PRTLN2    WREM2   20                      135683
      *                                                                   135683
      ***  If end of page, write header, CO Reference dertails, sub-      135683
      ***  CO details and CO Depot details.                               135683
      *                                                                   135683
     C           WREM2     IFLT 21                                        135683
     C                     WRITEHEADP2                                    135683
     C                     WRITEDET1P2                                    135683
     C                     WRITEDET2P2                                    135683
     C                     WRITEDET3P2                                    135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Write Book/Customer details.                                   135683
      *                                                                   135683
     C                     WRITEDET4P2                                    135683
      *                                                                   135683
      ***  If Security from CO Allocation file = '**CASH**'               135683
      *                                                                   135683
     C           MCSESN    IFEQ '**CASH**'                                135683
      *                                                                   135683
      ***  Retrieve New Security Shortname on Corporate Actions Detail    135683
      ***  file, depending on Processing Type, not for Processing Type    135683
      ***  Capital Changes and Non Financial Events, where New Security   135683
      ***  = Event Security.                                              135683
      *                                                                   135683
     C                     MOVE *BLANKS   WUNSEC 10                       135683
     C                     SELEC                                          135683
     C           MAPTYP    WHEQ 'DV'                       Divedend Events135683
     C           WKEY2     SETGTSECODVL1                                  135683
     C           WKEY2     REDPESECODVL1                 89               135683
     C                     MOVE MDNSEC    WUNSEC                          135683
     C                     MOVEL'SECODVL1'DBFILS  8                       135683
      *                                                                   135683
     C           MAPTYP    WHEQ 'FR'                       Free Allocation135683
     C           WKEY2     SETGTSECOFRL1                                  135683
     C           WKEY2     REDPESECOFRL1                 89               135683
     C                     MOVE MENSEC    WUNSEC                          135683
     C                     MOVEL'SECOFRL1'DBFILS                          135683
      *                                                                   135683
     C           MAPTYP    WHEQ 'RG'                       Rights Issues  135683
     C           WKEY2     SETGTSECORGL1                                  135683
     C           WKEY2     REDPESECORGL1                 89               135683
     C                     MOVE MFNSEC    WUNSEC                          135683
     C                     MOVEL'SECORGL1'DBFILS                          135683
      *                                                                   135683
     C           MAPTYP    WHEQ 'OF'                       Offers         135683
     C           WKEY2     SETGTSECOOFL1                                  135683
     C           WKEY2     REDPESECOOFL1                 89               135683
     C                     MOVE MINSEC    WUNSEC                          135683
     C                     MOVEL'SECOOFL1'DBFILS                          135683
      *                                                                   135683
     C           MAPTYP    WHEQ 'EX'                       Exercices and  135683
     C           WKEY2     SETGTSECOEXL1                   Conversions    135683
     C           WKEY2     REDPESECOEXL1                 89               135683
     C                     MOVE MJNSEC    WUNSEC                          135683
     C                     MOVEL'SECOEXL1'DBFILS                          135683
      *                                                                   135683
     C           MAPTYP    WHEQ 'NC'                       Name Changes   135683
     C           WPCARF    SETGTSECONCL1                                  135683
     C           WPCARF    REDPESECONCL1                 89               135683
     C                     MOVE MLSESN    WUNSEC                          135683
     C                     MOVEL'SECONCL1'DBFILS                          135683
      *                                                                   135683
     C           MAPTYP    WHEQ 'CC'                       Currency       135683
     C           WPCARF    SETGTSECOCCL2                   Changes        135683
     C           WPCARF    REDPESECOCCL2                 89               135683
     C                     MOVE NANSEC    WUNSEC                          135683
     C                     MOVEL'SECOCCL2'DBFILS                          135683
      *                                                                   135683
      ***  If record not found, handle Database Error.                    135683
      *                                                                   135683
     C           *IN89     IFEQ '1'                                       135683
     C           *LOCK     IN   LDA                                       135683
     C                     Z-ADD017       DBASE            ***************135683
     C                     MOVELDBFILS    DBFILE           * DB ERROR 17 *135683
     C                     MOVEL'SE7534'  DBPGM            ***************135683
     C           MAPTYP    IFEQ 'NC'                                      135683
     C           MAPTYP    OREQ 'CC'                                      135683
     C                     MOVELWPCARF    DBKEY                           135683
     C                     ELSE                                           135683
     C                     MOVELWPCARF    DBKEY3  8                       135683
     C                     MOVE WPOPTN    DBKEY3                          135683
     C                     MOVELDBKEY3    DBKEY                           135683
     C                     ENDIF                                          135683
     C                     EXSR *PSSR                                     135683
     C                     ENDIF                                          135683
     C                     ENDSL                                          135683
      *                                                                   135683
      ***  If New Security retrieve not blank (for Processing Type NC, if 135683
      ***  Security from CO detail file is blank, New Security = Event    135683
      ***  Security).                                                     135683
      *                                                                   135683
     C           WUNSEC    IFNE *BLANKS                                   135683
      *                                                                   135683
      ***  Chain Security Shortname from LF/SECTY to retrieve New         135683
      ***  Currency.                                                      135683
      *                                                                   135683
     C                     MOVE WUNSEC    WSESN  10                       135683
     C                     EXSR SRSEC                                     135683
      *                                                                   135683
      ***  Retrieve Number of Decimal Places of New Currency by calling   135683
      ***  access objet.                                                  135683
      *                                                                   135683
     C                     CALL 'AOCURRR0'                                135683
     C                     PARM '*MSG   ' WRTCD                           135683
     C                     PARM '*KEY   ' WOPTN                           135683
     C                     PARM NMCY      WAJCD                           135683
     C           SDCURR    PARM SDCURR    DSSDY                           135683
      *                                                                   135683
      ***  If record not found, handle Database Error.                    135683
      *                                                                   135683
     C           WRTCD     IFNE *BLANKS                                   135683
     C           *LOCK     IN   LDA                                       135683
     C                     Z-ADD018       DBASE            ***************135683
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 18 *135683
     C                     MOVELWAJCD     DBKEY            ***************135683
     C                     MOVEL'SE7534'  DBPGM                           135683
     C                     EXSR *PSSR                                     135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Set Number of Decimal Places used in standart subroutine to    135683
      ***  New Currency Decimal Places.                                   135683
      *                                                                   135683
     C                     Z-ADDA6NBDP    ZDECS                           135683
      *                                                                   135683
      ***  Set Currency fields for Cash line to New Currency.             135683
      *                                                                   135683
     C                     MOVE NMCY      RCYCD2           of Cash Alloc. 135683
     C                     MOVE NMCY      RCYCD3           of Cash Round. 135683
     C                     MOVE NMCY      RCYCD4           of Tot.Fees&Set135683
      *                                                                   135683
      ***  Else, if New Security retrieve is blank or No access done      135683
      ***  (= New Security = Event Security).                             135683
      *                                                                   135683
     C                     ELSE                                           135683
      *                                                                   135683
      ***  Set Number of Decimal Places used in standart subroutine to    135683
      ***  Event Currency Decimal Places.                                 135683
      *                                                                   135683
     C                     MOVE ECNBDP    ZDECS                           135683
      *                                                                   135683
      ***  Set Currency fields for Cash line to Event Currency.           135683
      *                                                                   135683
     C                     MOVE ECCY      RCYCD2           of Cash Alloc. 135683
     C                     MOVE ECCY      RCYCD3           of Cash Round. 135683
     C                     MOVE ECCY      RCYCD4           of Tot.Fees&Set135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  If Processing Type = Dividend Events, set Total Taxes Currency 135683
      ***  to New Currency.                                               135683
      *                                                                   135683
     C           MMPTYP    IFEQ 'DV'                                      135683
     C                     MOVE NMCY      RCYCD5                          135683
     C                     ELSE                                           135683
     C                     MOVE *BLANKS   RCYCD5                          135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Load detail Allocation report fields for Cash line.            135683
      *                                                                   135683
     C                     MOVE MCCAOP    ZFLD15           Cash Option    135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAOPT                          135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCAOPT                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCAOPT                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCAOPT                   135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCAOPT                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCAOPT                          135683
      *                                                                   135683
      ***  Actual Cash Allocation.                                        135683
      *                                                                   135683
     C                     MOVE MCACAA    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAALL                          135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCAALL                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCAALL                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCAALL                   135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCAALL                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCAALL                          136930
      *                                                                   135683
      ***  Original Cash Rounding.                                        135683
      *                                                                   135683
     C                     MOVE MCOCAR    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAORG                          135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCAORG                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCAORG                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCAORG                   135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCAORG                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCAORG                          136930
      *                                                                   135683
      ***  Actual Cash Rounding.                                          135683
      *                                                                   135683
     C                     MOVE MCACAR    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAACT                          135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCAACT                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCAACT                   135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCAACT                   135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCAACT                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCAACT                          136930
      *                                                                   135683
     C                     MOVE MCTOTF    ZFLD15           Total Fees     135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RTFEE                           135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RTFEE                    135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RTFEE                    135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RTFEE                    135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RTFEE                    135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RTFEE                           136930
      *                                                                   135683
      ***  If Processing Type = Dividend Events, load Total Taxes, else   135683
      ***  set this field to blank.                                       135683
      *                                                                   135683
     C           MMPTYP    IFEQ 'DV'                                      135683
     C                     MOVE MCTOTT    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RTTAX                           135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RTTAX                    135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RTTAX                    135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RTTAX                    135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RTTAX                    135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RTTAX                           136930
     C                     ELSE                                           135683
     C                     MOVE *BLANKS   RTTAX                           135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Calculate Total Settlement =                                   135683
      ***  Actual Cash Allocation & Rounding +/- Total Fees +/- Total     135683
      ***  Taxes (if Dividend Events).                                    135683
      ***  (+ if Ex-Date Position > or = 0, else -).                      135683
      *                                                                   135683
     C                     Z-ADD*ZEROS    WTSET  150                      135683
     C           MCACAA    ADD  MCACAR    WTSET                           135683
      *                                                                   135683
     C           MCEXPO    IFGE 0                                         135683
     C           WTSET     ADD  MCTOTF    WTSET                           135683
     C           MMPTYP    IFEQ 'DV'                                      135683
     C           WTSET     ADD  MCTOTT    WTSET                           135683
     C                     ENDIF                                          135683
     C                     ELSE                                           135683
     C           WTSET     SUB  MCTOTF    WTSET                           135683
     C           MMPTYP    IFEQ 'DV'                                      135683
     C           WTSET     SUB  MCTOTT    WTSET                           135683
     C                     ENDIF                                          135683
     C                     ENDIF                                          135683
      *                                                                   135683
     C                     MOVE WTSET     ZFLD15           Tot. Settlement135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RTSET                           135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RTSET                    135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RTSET                    135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RTSET                    135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RTSET                    135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RTSET                           136930
      *                                                                   135683
     C           OFLLN2    SUB  PRTLN2    WREM2   20                      135683
      *                                                                   135683
      ***  If end of page, write header, CO Reference details,            135683
      ***  sub-heading CO Depot, CO Depot details and Book/Customer       135683
      ***  details.                                                       135683
      *                                                                   135683
     C           WREM2     IFLT 17                                        135683
     C                     WRITEHEADP2                                    135683
     C                     WRITEDET1P2                                    135683
     C                     WRITEDET2P2                                    135683
     C                     WRITEDET3P2                                    135683
     C                     WRITEDET4P2                                    135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Write Casj line details.                                       135683
      *                                                                   135683
     C                     WRITEDET5P2                                    135683
      *                                                                   135683
      ***  Save New Security Shortname.                                   135683
      *                                                                   135683
     C                     MOVE MCSESN    WPSECU 10                       135683
     C                     ENDIF                                          135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  If change of Security.                                         135683
      *                                                                   135683
     C           MCSESN    IFNE WPSECU                                    135683
      *                                                                   135683
     C           MCSESN    IFEQ '**CASH**'                                135683
     C                     MOVE MASESN    WSESN                           135683
     C                     ELSE                                           135683
     C                     MOVE MCSESN    WSESN                           135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Chain Security Shortname from LF/SECTY to retrieve New         135683
      ***  Currency.                                                      135683
      *                                                                   135683
     C                     EXSR SRSEC                                     135683
     C                     Z-ADDNMDP      NSNBDP  10                      135683
      *                                                                   135683
      ***  Retrieve Number of Decimal Places of New Currency by calling   135683
      ***  access objet.                                                  135683
      *                                                                   135683
     C                     CALL 'AOCURRR0'                                135683
     C                     PARM '*MSG   ' WRTCD                           135683
     C                     PARM '*KEY   ' WOPTN                           135683
     C                     PARM NMCY      WAJCD                           135683
     C           SDCURR    PARM SDCURR    DSSDY                           135683
      *                                                                   135683
      ***  If record not found, handle Database Error.                    135683
      *                                                                   135683
     C           WRTCD     IFNE *BLANKS                                   135683
     C           *LOCK     IN   LDA                                       135683
     C                     Z-ADD019       DBASE            ***************135683
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 19 *135683
     C                     MOVELWAJCD     DBKEY            ***************135683
     C                     MOVEL'SE7534'  DBPGM                           135683
     C                     EXSR *PSSR                                     135683
     C                     ENDIF                                          135683
     C                     Z-ADDA6NBDP    NCNBDP  10                      135683
      *                                                                   135683
      ***  If flag = 'Y', write sub-heading for New Security Allocation   135683
      ***  details.                                                       135683
      *                                                                   135683
     C           WFLAG     IFEQ 'Y'                                       135683
     C           OFLLN2    SUB  PRTLN2    WREM2   20                      135683
      *                                                                   135683
      ***  If end of page, write header, CO Reference details, sub-       135683
      ***  heading CO Depot, CO Depot details and Book/Customer details.  135683
      *                                                                   135683
     C           WREM2     IFLT 21                                        135683
     C                     WRITEHEADP2                                    135683
     C                     WRITEDET1P2                                    135683
     C                     WRITEDET2P2                                    135683
     C                     WRITEDET3P2                                    135683
     C                     WRITEDET4P2                                    135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Write sub-heading for New Security Allocation details and      135683
      ***  reset flag.                                                    135683
      *                                                                   135683
     C                     WRITEDET7P2                                    135683
     C                     MOVE 'N'       WFLAG                           135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Load New Security Allocation details for Book/Customer fields. 135683
      *                                                                   135683
     C                     MOVE NMCY      RCYCD5           New Currency   135683
     C                     MOVE MCSESN    RCNSEC           Sec. Shortname 135683
      *                                                                   135683
      ***  Save New Security.                                             135683
      *                                                                   135683
     C                     MOVE MCSESN    WPSECU                          135683
      *                                                                   135683
      ***  Write New Security details.                                    135683
      *                                                                   135683
     C           OFLLN2    SUB  PRTLN2    WREM2   20                      135683
      *                                                                   135683
      ***  If end of page, write header, CO Reference details, sub-       135683
      ***  heading CO Depot, CO Depot details and Book/Customer details.  135683
      *                                                                   135683
     C           WREM2     IFLT 20                                        135683
     C                     WRITEHEADP2                                    135683
     C                     WRITEDET1P2                                    135683
     C                     WRITEDET2P2                                    135683
     C                     WRITEDET3P2                                    135683
     C                     WRITEDET4P2                                    135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Write New Security details.                                    135683
      *                                                                   135683
     C                     WRITEDET6P2                                    135683
      *                                                                   135683
      ***  Load Allocation details for Book/Customer and New Security     135683
      ***  fields.                                                        135683
      *                                                                   135683
     C                     MOVEAATIT,1    RCTIT            Stk Alloc.title135683
     C                     Z-ADDNSNBDP    ZDECS            New Sec.Dec.Pl.135683
      *                                                                   135683
      ***  Original Stock Allocation.                                     135683
      *                                                                   135683
     C                     MOVE MCOALR    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCOR                            135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCOR                     135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCOR                     135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCOR                     135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCOR                     135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCOR                            136930
      *                                                                   135683
      ***  Actual Stock Allocation.                                       135683
      *                                                                   135683
     C                     MOVE MCASTA    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAC                            135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCAC                     135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCAC                     135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCAC                     135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCAC                     135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCAC                            136930
      *                                                                   135683
      ***  Write Stock Allocation details.                                135683
      *                                                                   135683
     C           OFLLN2    SUB  PRTLN2    WREM2   20                      135683
      *                                                                   135683
      ***  If end of page, write header, CO Reference details, sub-       135683
      ***  heading CO Depot, CO Depot details and Book/Customer details.  135683
      *                                                                   135683
     C           WREM2     IFLT 17                                        135683
     C                     WRITEHEADP2                                    135683
     C                     WRITEDET1P2                                    135683
     C                     WRITEDET2P2                                    135683
     C                     WRITEDET3P2                                    135683
     C                     WRITEDET4P2                                    135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Write Allocation details.                                      135683
      *                                                                   135683
     C                     WRITEDET8P2                                    135683
      *                                                                   135683
      ***  Load Allocation details for Book/Customer and New Security     135683
      ***  fields.                                                        135683
      *                                                                   135683
     C                     MOVEAATIT,2    RCTIT            Stk Round.title135683
     C                     Z-ADD8         ZDECS            8 Decimal Pl.  135683
      *                                                                   135683
      ***  Original Stock Rounding.                                       135683
      *                                                                   135683
     C                     MOVE MCOSTR    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C******               MOVE ZOUT25    RCOR                     135683 136930
     C                     MOVE ZOUT21    RCOR                            136930
      *                                                                   135683
      ***  Actual Stock Rounding.                                         135683
      *                                                                   135683
     C                     MOVE MCASTR    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C******               MOVE ZOUT25    RCAC                     135683 136930
     C                     MOVE ZOUT21    RCAC                            136930
      *                                                                   135683
      ***  Write Stock Rounding details.                                  135683
      *                                                                   135683
     C           OFLLN2    SUB  PRTLN2    WREM2   20                      135683
      *                                                                   135683
      ***  If end of page, write header, CO Reference details, sub-       135683
      ***  heading CO Depot, CO Depot details and Book/Customer details.  135683
      *                                                                   135683
     C           WREM2     IFLT 17                                        135683
     C                     WRITEHEADP2                                    135683
     C                     WRITEDET1P2                                    135683
     C                     WRITEDET2P2                                    135683
     C                     WRITEDET3P2                                    135683
     C                     WRITEDET4P2                                    135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Write Allocation details.                                      135683
      *                                                                   135683
     C                     WRITEDET8P2                                    135683
      *                                                                   135683
      ***  Load Allocation details for Book/Customer and New Security     135683
      ***  fields.                                                        135683
      *                                                                   135683
     C                     MOVEAATIT,3    RCTIT            Cash Round.tit.135683
     C                     Z-ADDNCNBDP    ZDECS            New Ccy Dec.Pl.135683
      *                                                                   135683
      ***  Original Cash Rounding.                                        135683
      *                                                                   135683
     C                     MOVE MCOCAR    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCOR                            135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCOR                     135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCOR                     135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCOR                     135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCOR                     135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCOR                            136930
      *                                                                   135683
      ***  Actual Cash Rounding.                                          135683
      *                                                                   135683
     C                     MOVE MCACAR    ZFLD15                          135683
     C******               EXSR ZFRPED                             135683 136930
     C                     EXSR ZSEDIT                                    136930
     C                     MOVE *BLANKS   RCAC                            135683
     C******     ZDECS     IFEQ 0                                  135683 136930
     C******               MOVE ZOUT0     RCAC                     135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 1                                  135683 136930
     C******               MOVE ZOUT1     RCAC                     135683 136930
     C******               ELSE                                    135683 136930
     C******     ZDECS     IFEQ 2                                  135683 136930
     C******               MOVE ZOUT2     RCAC                     135683 136930
     C******               ELSE                                    135683 136930
     C******               MOVE ZOUT25    RCAC                     135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C******               ENDIF                                   135683 136930
     C                     MOVE ZOUT21    RCAC                            136930
      *                                                                   135683
      ***  Write Cash Rounding details.                                   135683
      *                                                                   135683
     C           OFLLN2    SUB  PRTLN2    WREM2   20                      135683
      *                                                                   135683
      ***  If end of page, write header, CO Reference details, sub-       135683
      ***  heading CO Depot, CO Depot details and Book/Customer details.  135683
      *                                                                   135683
     C           WREM2     IFLT 17                                        135683
     C                     WRITEHEADP2                                    135683
     C                     WRITEDET1P2                                    135683
     C                     WRITEDET2P2                                    135683
     C                     WRITEDET3P2                                    135683
     C                     WRITEDET4P2                                    135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Write Allocation details.                                      135683
      *                                                                   135683
     C                     WRITEDET8P2                                    135683
      *                                                                   135683
     C                     ENDIF                                          135683
      *                                                                   135683
      ***  Read newt record on CO Allocation details fiel.                135683
      *                                                                   135683
     C           WKEY3     READESECOALD0                 83               135683
     C                     ENDDO                                          135683
      *                                                                   135683
     C                     ENDSR                                          135683
      *                                                                   135683
      *****************************************************************   135683
      /EJECT                                                              135683
      *****************************************************************
      *                                                               *
      *  *PSSR  - Error Routine.                                      *
      *                                                               *
      *  Called by: SRINIT - Program initialisation.                  *
      *             SRCUST - Customers/Books Processing.              *
      *             SRDEPO - Depot processing.                        *
      *             SRREF  - Move SECORFPD fields to P1 and P2        *
      *                      headers.                                 *
      *             SRSEC  - Chain Security Shortname from LF/SECTY.  *
      *                                                               *
      *  Calls: SRAUDT - Audit processing.                            *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR                           ** *PSSR SR **
      *
      ***  Check to see that *PSSR has not already been called.
      *
     C           WRUN      IFEQ *BLANK
     C                     MOVE 'Y'       WRUN    1
     C                     OUT  LDA
     C                     MOVE '1'       *INU7
     C                     MOVE '1'       *INU8
     C                     MOVE '1'       *INLR
     C                     DUMP
     C                     EXSR SRAUDT                     Output Audit
     C                     ENDIF
      *
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      *  ZDATE2 - Standart subroutine to convert a Day Number to      *
      *           date formats.                                       *
      *                                                               *
      *  Called by: SRDEPO - Depot processing.                        *
      *             SRREF  - Move SECORFPD fields to P1 and P2        *
      *                      headers.                                 *
      *                                                               *
      *  Calls: None.                                                 *
      *                                                               *
      *****************************************************************
      *
     C/COPY ZSRSRC,ZDATE2Z2
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      ***ZFRPED*-*Standard*subroutine*to*insert*a*decimal*point*and****   136930
      ************sign*into*a*numeric*field*and*to*blank*out*leading***   136930
      ************zeros*(optionaly*inserting*commas).******************   136930
      *  ZSEDIT - Standard subroutine to insert a decimal point and   *   136930
      *           sign into a numeric field and to blank out leading  *   136930
      *           zeros (optionaly inserting commas).                 *   136930
      *                                                               *
      *  Called by: SRCUST - Customers/Books Processing.              *
      *             SRDEPO - Depot processing.                        *
      *                                                               *
      *  Calls: None.                                                 *
      *                                                               *
      *****************************************************************
      *
     C******/COPY ZSRSRC,ZFRPEDZ3                                         136930
     C/COPY ZSRSRC,ZSEDITZ3                                               136930
      *
      *****************************************************************
      /EJECT
**  ARPT - Reply Narratives.
ALLOCATED
STOCK AUTHORISED
FULLY AUTHORISED
TRIAL
FINAL STOCK
FINAL STOCK/CASH
REPLY RECEIVED
STD INST DEFAULT
CORPORATE DEFAULT
MANUALLY CHANGED
**  ATIT - Titles for report.
Stock Allocation
Stock Rounding
Cash Rounding
**  ZYDY - Years in days cumulative, four year span,
0366073110961461
**  ZMDY - Months in days cumulative through year,
000031059090120151181212243273304334365
**  ZMNM - Months short name.
JANFEBMARAPRMAYJUNJULAUGSEPOCTNOVDEC
**  CPY@ - Copyright statement.
(c) Finastra International Limited 2001
