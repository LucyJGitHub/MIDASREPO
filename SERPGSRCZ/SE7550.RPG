     H        1
      *****************************************************************
/*STD *  RPGBASE                                                      *
/*EXI *  TEXT('Midas SE CO automatic allocation processing')
      *****************************************************************
      *                                                               *
      *  Midas - Securities Trading Module                            *
      *                                                               *
      *  SE7550 - SE Corporate Actions Automatic Allocation           *
      *           Processing                                          *
      *                                                               *
      *  Function:  This program calculate Original and Actual        *
      *  (I/C)      Allocations for the Depot and for the Book/       *
      *             Customer Positions at the Depot.                  *
      *                                                               *
      *  BE CAREFUL: Some of amendments of calculations must          *
      *              perhaps be done in RPG/SE7593: Midas SE          *
      *              Corporate Actions Depot Maintenance and in       *
      *              RPG/SE7513: Midas SE Corporate Actions           *
      *              Customer/Book by Depot Maintenance, depending    *
      *              on calculations used in those programs |         *
      *                                                               *
      *  Called By: SEC7550 - SE CO Automatic Allocation Processing.  *
      *                                                               *
      *  (c) Finastra International Limited 2001                      *
      *                                                               *
      *  Last Amend No. MD050604           Date 21Feb20               *
      *  Prev Amend No. MD046248           Date 27Oct17               *
      * Bank Fusion Midas 1.4 Base -----------------------------------*
      * Midas Plus 1.4 Base 04 ---------------------------------------*
      * Midas Plus 1.4 Base ------------------------------------------*
      * Midas Plus 1.3 ----------- Base ------------------------------*
      *                 CSD031             Date 10Apr06               *
      *                 CSD027             Date 09Dec05               *
      *                 CSE071             Date 19Jul05               *
      *                 CSW037A            Date 02May05               *
      *                 223182             Date 30Jan04               *
      *                 220007             Date 28Jul03               *
      *                 220006             Date 25Jul03               *
      *                 211444 (BUG2652)   Date 28Jul03               *
      *                 219976             Date 28Jul03               *
      *                 219635             Date 16JuL03               *
      *                 219579             Date 22JuL03               *
      *                 219553             Date 16JuL03               *
      *                 218698             Date 12Jun03               *
      *                 215071             Date 18Mar03               *
      *                 CSD025             Date 11Jan05               *
      *                 CSW037             Date 15Dec04               *
      *                 CSW036             Date 15Dec04               *
      *                 BUG3122            Date 17Jul04               *
      *                 CLE025             Date 20Oct03               *
      *                 BUG2652            Date 17May04               *
      *                 CGL029             Date 01Sep03               *
      * Midas Release 4.01 -------------------------------------------*
      *                 193662             Date 30Nov01               *
      *                 191178             Date 30Nov01               *
      * Midas Release 4 --------------- Base -------------------------*
      *                 190204             Date 31May01               *
      *                 164020             Date 08May01               *
      * Midas DBA 3.05 -----------------------------------------------*
      *                 179205             Date 27Dec00               *
      * Midas DBA 3.03 -----------------------------------------------*
      *                 181131             Date 06Jul00               *
      *                 CSE020             Date 21Mar00               *
      *                 161732             Date 21Mar00               *
      * Midas DBA 3.02 -----------------------------------------------*
      *                 CPB001             Date 08Sep99               *
      * Midas DBA 3.01 -----------------------------------------------*
      *                 164243             Date 19Aug99               *
      * Midas DBA 3.00 ---------------- Base -------------------------*
      *                 161419             Date 28May99               *
      *                 CAC005             Date 23Nov98               *
      *                 157229             Date 17Mar99               *
      *                 156701             Date 10Mar99               *
      *                 156690             Date 10Mar99               *
      *                 156538             Date 05Mar99               *
      *                 155622             Date 22Feb99               *
      *                 153729             Date 21Jan99               *
      *                 145872             Date 23Oct98               *
      *                 137886             Date 14Jul98               *
      *                 136935             Date 29Jun98               *
      *                 152932             Date 12Jan99               *
      *                 150252             Date 10Dec98               *
      *                 149782             Date 07Dec98               *
      *                 149257             Date 08Jun98               *
      *                 149153             Date 30Nov98               *
      *                 135690             Date 08Jun98               *
      *                 135692             Date 03Jun98               *
      *                 135686             Date 28May98               *
      *                 135685             Date 28May98               *
      *                 CEU017             Date 05Mar98               *
      *                 CSE007  *CREATE    Date 12Jan98               *
      *                                                               *
      *---------------------------------------------------------------*
      *                                                               *
      *  MD050604 - Average price of position changed incorrectly.    *
      *           - Recompiled due to changes in copy source ZCCAL1Z2.*
      *  MD046248 - Finastra Rebranding                               *
      *  CSD031 - Enhanced Centralised Static Data (Recompile)        *
      *  CSD027 - Conversion Of Customer Number to Alpha              *
      *  CSE071 - Multiple Holidays Re Securities (recompile)         *
      *  CSW037A- Additional Field extended to 40 chars (recompile)   *
      *  223182 - Error on Corporate Action.                          *
      *           Zeroised Allocation for Dummy Customers.            *
      *  220007 - TO RETRIEVE THE CORRECT SECURITY.                   *
      *         - ARRAY INDEX NOT VALID  (I)                          *
      *  220006 - ALLOCATION IS WRONG FOR 'OF' TYPE 'E'               *
      *  219976 - PARTIAL OFFER INCORRECTLY HANDLED.                  *
      *  209292 - Replace line removed by 136935                      *
      *  219635 - Allocation ignoring nominal decimal places          *
      *           Apply 179024 Round denomination multiplier correctly*
      *  219635A- INCORRECT DEFINITION OF WUTDVD 15,0 >> 19,4         *
      *  219579 - For exchange offer (EX) with type '4', no cash      *
      *           is calculated. This should be done taking into con- *
      *           sideration the subscription price.                  *
      *  219553 - No stock allocation calculated and taken as stock   *
      *           for Exchange Offer.                                 *
      *  218698 - Actual stock allocation computed incorrectly for    *
      *           option 3 of Exchange offer. Fix is to use the actual*
      *           rate entered and not subtract it from 100.          *
      *  215071 - No stock allocation calculated for stock dividend   *
      *           types 'O'. Fix is to calculate stock allocation for *
      *           stock dividend types 'O'based on customer reply     *
      *           definition.                                         *
      *  CSD025 - Customer De-Activation                              *
      *  CSW037 - Additional Field Data on MT300/MT320                *
      *  CSW036 - Dual SWIFT BIC held on Client Details               *
      *  BUG3122 - Recompiled due to changes in SDSECSPD.             *
      *  CLE025 - Credit Lines (Recompile)                            *
      *  BUG2652 - Amend program to ensure Cash Repaid amount is 7    *
      *            decimal places.                                    *
      *  CGL029 - Increase Account Code to 10 digits                  *
      *  193662 - The system did not allocate shares eventhough a     *
      *           default reply "Accept Offer" is defined in the      *
      *           Subscription Offer corporate action details.        *
      *           Expected allocation should be generated if Default  *
      *           reply exists on the corporate action details.       *
      *  191178 - Corporate Action: Stock Dividend: Cash rounding     *
      *           included twice in total settlement. Fix is to amend *
      *           the computation of holding taken as cash when cash% *
      *           is entered to ensure that the exact amount is calcu-*
      *           lated to come up with an exact actual stock alloc.  *
      *           Fix only caters for processing type 'DV' with stock *
      *           dividend type not 'C'.                              *
      *  190204 - Changed Dividend per Unit format from 9N0 to 13N8.  *
      *  164020 - Calculate taxes with extra accuracy.                *
      *  179205 - If only a charge or a commission, fee calculated    *
      *           is zero. Allow the two to be calculated seperately. *
      *           Do not multiply result by CCY decimal places.       *
      *  181131 - Incorrect Actual Stock Allocation for Customer/Book *
      *  CSE020 - Corporate Actions Domino Effect Processing          *
      *  161732 - Corporate Actions Exercise and Conversion -         *
      *           Part Stock/Keep Rest Calculation                    *
      *  CPB001 - 'Private Banking' Module                            *
      *  164243 - Review actual stock allocation for 'EX' type        *
      *  161419 - Corporate Actions: The Stock allocation calculation *
      *           for No. of New and No. of Old is calculated         *
      *           incorrectly.                                        *
      *  CAC005 - Profit Centre Accounting - SE Enhancements          *
      *  157229 - Corporate Actions: Review calculation of Actual     *
      *           Cach Allocation for processing type 'CR'.           *
      *           Should use the Holding Taken as Stock instead of    *
      *           the Holding at the Ex-date position.                *
      *  156701 - Corporate Actions: Review Setup of field Convert/   *
      *           Keep indicator for allocation of Processing Type EX *
      *  156690 - Corporate Actions: Review Depot Calculation for 'OF'*
      *  156538 - Corporate Actions: Cash allocation for Depot not    *
      *           calculated.                                         *
      *  155622 - Corporate Actions: Cash Payment has now 7 decimal   *
      *           places (Corporate Reorganisation)                   *
      *  153729 - Corporate Actions: No Trades/Depot Movements        *
      *           generated for a processing type 'NC' with change of *
      *           Security Shortname                                  *
      *  145872 - Corporate Actions: '% to Exchange' added for        *
      *           Exchange Offer ('OF').                              *
      *           If Exchange Offer, Calculat Base Ex-Date Position = *
      *           Ex-Date Position multiplied by Percentage to        *
      *           Exchange.                                           *
      *  137886 - Corporate Actions: Add the possibility to allocate  *
      *           (or not) the balancing difference directly to the   *
      *           Dummy Customer.                                     *
      *  136935 - Corporate Actions: Allocation processing amendments:*
      *           1. If Number of Options greater than 1, record      *
      *              '**CASH**' for previous option write 2 times.    *
      *           2. Amend calculations for Exercices and Conversions.*
      *           3. Amend calculations for Offers.                   *
      *           4. Final Allocation must be set to Y' for Corporate *
      *              Actions with processing type 'NC' and 'NF'.      *
      *           5. Review calculation of cash (processing type 'CR')*
      *              Cash Option = (Holding divided by Number of OLD  *
      *              Shares) multiplied by Compensation Price.        *
      *           6. Input Balancing Cash Allocation on Dummy Cust.   *
      *              on Cash Alocation and Rounding instead of only   *
      *              on Cash Alocation, and all Balancing Differences *
      *              only on Actual field, no more on Original field. *
      *           7. For Reinvestment of Dividend, if Compensation    *
      *              Price entered, use Compensation Price instead of *
      *              Subscription Price, otherwise, calculate Sub-    *
      *              scription Price = Subscription Price minus Dis-  *
      *              count Rate.                                      *
      *           8. Review Allocation in case of multiple options    *
      *  152932 - If no Customer and no Book processed for the        *
      *           Security (no records in SECOALPD), don't processed  *
      *           Security for the Depot.                             *
      *  150252 - In some cases, balancing difference between Depot   *
      *           and Customers/Books not allocated to the Dummy Cust.*
      *  149782 - Error in calculating the stock allocation for       *
      *           french government OAT bonds                         *
      *  149257 - Allocation for Funds (Investment Type 7) do not     *
      *           take care of decimal positions                      *
      *  149153 - Error in allocation for EIB bonds                   *
      *  135690 - Various errors for Corporate Actions:               *
      *           1. Due to Fix 135689: Error in validation of        *
      *              Dividend per Unit, amend number of decimal       *
      *              places of Dividend per Unit for Dividend Events, *
      *              from New Currency instead of New Security.       *
      *           2. Amend wrong calculation of Holding Taken as      *
      *              Stock, for Dividend Events, Subscription and     *
      *              Exchange Offers and Non financial Events.        *
      *           3. Amend wrong loading of Cash preferred % for      *
      *              Processing Type Rights Issues, Cash Preferred %  *
      *              must always equal 0.                             *
      *           4. Amend wrong calculation of Cash Preferred % in   *
      *              case 2.1: if Standard Instruction found,         *
      *              condition if Cash % later than 50 or greater     *
      *              50 becomes if later than 50 or greater or equal  *
      *              50.                                              *
      *  135692 - Calculation of total taxes was processed if         *
      *           processing type not Dividend Events, process this   *
      *           calculation only if processing type is Dividend     *
      *           Events.                                             *
      *  135686 - EMU and Corporate Actions: various amendments:      *
      *           1. Allow rounding up with Denomination Multiplier   *
      *              precision on Original and Actual Stock           *
      *              Allocation calculations.                         *
      *           2. Allow Customer and Book processing if historic   *
      *              records find in Client and User Depot Positions  *
      *              detail files.                                    *
      *           3. On Depot calculations, process details if live   *
      *              record found on Allocation detail file.          *
      *           4. Process Dummy Customer only if Customer or       *
      *              Book processed.                                  *
      *           5. Due to database error when allocation called     *
      *              from Customer/Book maintenance, loop to delete   *
      *              all '**CASH**' records on Allocation file.       *
      *           6. Correct wrong calculation of Balancing Cash      *
      *              Allocation: Depot - Total instead of Total -     *
      *              Depot.                                           *
      *           7. Input Balancing Differences on Dummy Customer    *
      *              only for processing type Currency Change, else   *
      *              load Balancing Differences fields on Depot       *
      *              Allocation file, and input on Dummy Customer     *
      *              without inversion of sign.                       *
      *  135685 - It's not feasible to enter the Compensation Price   *
      *           at the Bulk level as the Bulk will have many        *
      *           Securities all giving a cash compensation at a      *
      *           different level. Therefore, allow the entry of      *
      *           'MARKET' which will use the Market Price of the     *
      *           Security at allocation effective date.              *
      *  CEU017 - Securities Redenomination Euro Changes              *
      *  CSE007 - Corporate Actions                                   *
      *                                                               *
      *****************************************************************
      /SPACE 3
      *
      ***  Midas SE Corporate Actions Reference - Rtv Idx                - Prefixe MA
      *
     FSECORFL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *                                                                   CSE020
      ** Midas SE Corporate Actions Reference - Rtv Idx                   CSE020
      *                                                                   CSE020
     FSECORFL0IF  E           K        DISK                               CSE020
     F            SECORFD0                          KRENAMESECORFX0       CSE020
     F                                              KINFSR *PSSR          CSE020
      *
      ***  Midas SE Corporate Actions Allocations - Upd Idx              - Prefixe MC
      *
     FSECOALL0UF  E           K        DISK                      A
     F                                              KCOMIT
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Depots - Upd Idx                   - Prefixe MB
      *
     FSECODPL0UF  E           K        DISK                      A
     F                                              KCOMIT
     F                                              KINFSR *PSSR
      *                                                                   CSE020
      ** Midas SE Corporate Actions Stock Allocations - Rtv Idx           CSE020
      *                                                                   CSE020
     FSECOALL5IF  E           K        DISK                               CSE020
     F            SECOALD0                          KRENAMESECOALD5       CSE020
     F                                              KINFSR *PSSR          CSE020
      *
      ***  Midas SE Corporate Actions Dividends Events - Rtv Idx         - Prefixe MD
      *
     FSECODVL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Free Allocation - Rtv Idx          - Prefixe ME
      *
     FSECOFRL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Rights Issues - Rtv Idx            - Prefixe MF
      *
     FSECORGL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Capital Change - Rtv Idx           - Prefixe MG
      *
     FSECOCEL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Corporate Reorganisation - Rtv Idx - Prefixe MH
      *
     FSECOCRL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Offers - Rtv Idx                   - Prefixe MI
      *
     FSECOOFL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Exercices and Conversion - Rtv Idx - Prefixe MJ
      *
     FSECOEXL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions General Meeting/Info - Rtv Idx     - Prefixe MK
      *
     FSECONFL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Name Changes - Rtv Idx             - Prefixe ML
      *
     FSECONCL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *                                                                   CEU017
      ***  Midas SE Corporate Actions Currency Changes - Rtv Idx          CEU017
      ***                                                   -  Prefixe NA CEU017
      *                                                                   CEU017
     FSECOCCL2IF  E           K        DISK                               CEU017
     F                                              KINFSR *PSSR          CEU017
      *
      ***  Midas SE Securities.                                          - Prefixe
      *
     FSECTY   IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE User Depot Positions Details.                        - Prefixe
      *
     FSEUDEPL0IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Client Depot Position Details.                       - Prefixe
      *
     FSECDEPL4IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Depot Positions-Current & Historic.                  - Prefixe
      *
     FSEDPOHL0IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Depots Reference - Upd Idx.        - Prefixe MS
      *
     FSECODRL0UF  E           K        DISK                      A
     F                                              KCOMIT
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Reply Handling.                    - Prefixe MQ
      *
     FSECOREL0IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Instructions by Customer.          - Prefixe MO
      *
     FSECOSIL1IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Corporate Actions Instructions by Book.              - Prefixe MO
      *
     FSECOSIL2IF  E           K        DISK
     F            SECOSID0                          KRENAMESECOSID2
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Charge Types.                                        - Prefixe
      *
     FSECGT   IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE CO Default Charges file by Customer Group.           - Prefixe MR
      *
     FSECOCHL0IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SE CO Default Charges file by Classification.           - Prefixe MR
      *
     FSECOCHL1IF  E           K        DISK
     F            SECOCHD0                          KRENAMESECOCHD1
     F                                              KINFSR *PSSR
      *
      ***  Midas SE Security Withholding Tax Details.                    - Prefixe S1
      *
     FSESWHTL0IF  E           K        DISK
     F                                              KINFSR *PSSR
      *
      ***  Midas SD Customer Master file.                                - Prefixe
      *
     FCLINT   IF  E           K        DISK         KINFSR *PSSR
     F            CLINTCAF                          KIGNORE
     F            CLINTCCF                          KIGNORE
     F            CLINTC1F                          KIGNORE
     F            CLINTSEF                          KIGNORE
      *
      ***  Midas SE Market Prices file.                                  - Prefixe
      *
     FPRICM   IF  E           K        DISK
     F                                              KINFSR *PSSR
      *                                                                   CPB001
      ***  Midas PM Portfolio Reference                                   CPB001
      *                                                                   CPB001
     FPMPORTLLIF  E           K        DISK                           UC  CPB001
     F                                              KINFSR *PSSR          CPB001
      *
      ***  Midas SE CO Automatic Allocation Processing - Audit.
      *
     FSE7550AUO   E                    PRINTER
     F                                              KINFDS SPOOLU
     F                                              KINFSR *PSSR
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  F U N C T I O N   O F   I N D I C A T O R S                  *
      *                                                               *
      *   13  - Program called from SE7512: Corporate Actions  (*OFF) *
      *         Depot Selection.                                      *
      *       - Program called from SE7513: Corporate Actions  (*ON)  *
      *         Customers/Books by Depots Maintenance.                *
      *   44  - Record not Found on PRICM                      (*ON)  *
      *  79 - Print Profit Centre if CAC005 is installed              *   CAC005
      *   80  - Record not Found on SECORFL1, SECTY, SECOALL0  (*ON)  *
      *       - Record not Found on SECTY                      (*ON)  *
      *       - End of file SECOALL0, SECODPL0, SECOXXL1       (*ON)  *
      *         (Where xx = 'DV', 'FR', 'RG', 'CE', 'CR', 'OF',       *
      ***********'EX',*'NF'*or*'NC').**********************************   CEU017
      *          'EX', 'NF' or 'NC') or SECOCCL2.                     *   CEU017
      *   81  - Begin or end of file SEUDEPL0, SECDEPL4        (*ON)  *
      *       - Begin of file SEDPOHL0                         (*ON)  *
      *       - End of file SECOALL0                           (*ON)  *
      *   82  - Record not Found on SECOREL0, SECODRL0         (*ON)  *
      *   83  - Record not Found on SECOSIL1, SECOSIL2         (*ON)  *
      *   84  - Record not found on SECOCHL0-L1, SECGT,        (*ON)  *
      *         SESWHTL0, CLINT (format CLINTCBF)                     *
      *   87  - Error calling PGM 'SE7534' or 'ZSFILE'         (*ON)  *
      *   88  - Indicator used in calculation specifications   (*ON)  *
      *   89  - Error detected when write, update or delete    (*ON)  *
      *         operations on SECOALL0, SECODPL0, SECODRL0            *
      *   99  - Used in calculation.                                  *
      *                                                               *
      * U7+U8 - Database Error                                        *
      *                                                               *
      *****************************************************************
      /SPACE 3
      *****************************************************************
      *                                                               *
      *  S U B R O U T I N E   I N D E X                              *
      *                                                               *
      * #INIT  - Program Initialisation.                              *
      * DETAIL - Detail Processing.                                   *
      * DADCOR - Delete Corporate Actions Allocation and Depot for    *
      *          CO Reference and Depot.                              *
      * DADNSE - Delete Corporate Actions Allocation and Depot for    *
      *          CO Reference, Option, Branch, Depot, New Security,   *
      *          Book, Customer and Portfolio.                        *
      * PDCORF - Process Detail for CO Reference depending on the     *
      *          Processing Type.                                     *
      * PDNSEC - Process Detail for CO Reference, Option Number and   *
      *          New Security, depending on the Processing Type.      *
      * PBKDPT - Process Books for the Depot.                         *
      * PCUDPT - Process Customers for the Depot.                     *
      * PDUMCU - CO Dummy Customer processing.                        *
      * PDEPOT - Process the Depot.                                   *
      * PSEDPT - Process New Security for the Deopt.                  *
      * PRDTAG - Print details of Allocation generated.               *
      * PBLOCK - Blocking processing.                                 *
      * RAAOPT - Retrieve Actual Allocation for Options and           *
      *          Actual Allocation for options within the Option.     *
      * CALLOC - Calculate Allocations:                               *
      *            - Original Stock Allocation                        *
      *            - True Stock Allocation                            *
      *            - Original Stock Rounding                          *
      *            - Original Cask Rounding.                          *
      * CALBC  - Calculate other Book/Customer Allocations.           *
      * CALDPT - Calculate other Depot Allocations.                   *
      * CCABC  - Calculate Cash Option and Actual Cash Allocation     *
      *          for Book/Customer.                                   *
      * CCADPT - Calculate Cash Option and Actual Cash Allocation for *
      *          Depot.                                               *
      * CCAOPT - Calculate Cash Option.                               *
      * CACABC - Calculate Actual Cash Allocation for Book/Customer.  *
      * CACADP - Calculate Actual Cash Allocation for Depot.          *
      * CACRBC - Calculate Actual Cash Rounding for Book/Customer.    *
      * CACRDP - Calculate Actual Cash Rounding for Depot.            *
      * CASRDP - Calculate Actual Stock Rounding for Depot.           *
      * CASABC - Calculate Actual Stock Allocation for Book/Customer. *
      * CASADP - Calculate Actual Stock Allocation for Depot.         *
      * CASRBC - Calculate Actual Stock Rounding for Book/Customer.   *
      * CTSA1  - 1st calculation of True Stock Allocation.            *
      * CTSA2  - 2nd calculation of True Stock Allocation.            *
      * COCR1  - 1st calculation of Original Cash Rounding.           *
      * COCR2  - 2nd calculation of Original Cash Rounding.           *
      * COSA1  - 1st calculation of Original Stock Allocation.        *
      * COSA2  - 2nd calculation of Original Stock Allocation.        *
      * COSR1  - 1st calculation of Original Stock Rounding.          *
      * COSR2  - 2nd calculation of Original Stock Rounding.          *
      * CHCABC - Calculate Holding Taken as Cash for Book/Customer.   *
      * CHCADP - Calculate Holding Taken as Cash for Depot.           *
      * CHSTBC - Calculate Holding Taken as Stock for Book/Customer.  *
      * CHSTDP - Calculate Holding Taken as Stock for Depot.          *
      * CACAPO - Calculate Actual Cash Pool.                          *
      * CTFEES - Calculate Total Fees for Customer.                   *
      * CALAM2 - Calculate Charge Amounts.                            *
      * CTOTAX - Calculate total Tax.                                 *
      * RTVRPL - Retrieve Customer/Book Current Reply and Customer/   *
      *          Book Standard Corporate Action Instruction.          *
      * SETNDP - Set amount from num field 24.9 to num field 15.0     *
      *          with Number of Decimal Places from Nominal Currency  *
      *          received as parameter.                               *
      * RTVNDP - Set amount from num field 15.0 to num field 24.9     *
      *          with Retrieve Number of Decimal Places from Nominal  *
      *          Currency received as parameter.                      *
      * ROUNDD - Perform rounding to the Number of Decimal Places.    *
      * WRCOAL - Write a record on SECOALL0: Corporate Actions        *
      *          Allocations file.                                    *
      * WRCODP - Write a record on SECODPL0: Corporate Actions Depots *
      *          file.                                                *
      * CSBPR  - Calculate Subscription Price if Subscription Price   *
      *          entered as Market for Dividend Events.               *
      * ENDPGM - Termination Processing.                              *
      * RCFAU  - Subroutine to register the AU Printer File via RCF.  *
      * *PSSR  - Program exception error routine.                     *
      *                                                               *
      *****************************************************************
      *                                                               *
      *  S T A N D A R D   S U B R O U T I N E   I N D E X            *
      *                                                               *
      * ZCCAL1 - Calculate Charges/Commissions.                       *
      * ZCCAL2 - Calculate Charges/Commissions (Called by standard    *
      *          subroutine ZCCAL1).                                  *
      * ZCONV  - Convert Amount from one Currency to another (Called  *
      *          by standard subroutine ZCCAL1).                      *
      *                                                               *
      *****************************************************************
      *                                                               *
      *  E X T E R N A L   S T A N D A R D   P R O G R A M S   I D X  *
      *                                                               *
      * AOBANKR0 - Access Program for Bank Details.                   *
      * AOSTRDR0 - Access Program for Securities Trading Details.     *
      * AOMMODR0 - Access Program for Module Details.                 *
      * AOPLCSR0 - Access Program for Portfolio Management Customer   *
      *            Details.                                           *
      * AOSARDR0 - Access Program for Switchable Feature Details.     *
      * AOSECSR0 - Access Program for Security Customer Details.      *
      * ZSFILE   - Midas FC Set-up Spool File Number File.            *
      *                                                               *
      *****************************************************************
      *                                                               *
      *  E X T E R N A L   P R O G R A M S   I N D E X                *
      *                                                               *
      * SE7534   - Corporate Actions Report.                          *
      *                                                               *
      *****************************************************************
      /EJECT
      *
      ***  Arrays: - ZRA: Range Limits, used in standard subroutine ZCCAL1 and ZCCAL2 (called by
      ***                 standard subroutine ZCCAL1).
      ***          - ZPC: Percentages, used in standard subroutine ZCCAL1 and ZCCAL2 (called by
      ***                 standard subroutine ZCCAL1).
      ***          - ZCG: Flat Charges, used in standard subroutine ZCCAL1.
      *
     E/COPY ZSRSRC,ZCCAL1Z1
      *
      ***  Array POWER8: POWER8 array, used in standard subroutine ZCCAL1.
      *
     E/COPY ZSRSRC,ZPOWER8Z1
      *
      ***  Array POWER: POWER array, used in standard subroutine ZCONV (called by standard
      ***  subroutine ZCCAL1).
      *
     E/COPY ZSRSRC,ZPOWERZ1
      *
      ***  Arrays to perform processing for each New Securities.
      *
     E                    TSEC       20 10
     E                    SECT       20 10
      *
      ***  Arrays to retrieve Number of New Shares.
      *
     E                    TNSH       20 16
     E                    NSHT       20 16
      *
      ***  Arrays to retrieve Rounding.
      *
     E                    TNDN       20  1
     E                    NDNT       20  1
      *
      ***  Arrays to retrieve Rounding Settlement in Cash.
      *
     E                    TNDS       20  1
     E                    NDST       20  1
      *
      ***  Arrays to retrieve Denomination Multiplier.
      *
     E                    TDML       20 16
     E                    DMLT       20 16
      *
      ***  Arrays to retrieve Compensation Price.
      *
     E                    TOPA       20 16
     E                    OPAT       20 16
      *
      ***  Array to retrieve Number of Decimal Places for New Securities.
      *
     E                    TSDP       20  1 0
      *
      ***  Array to retrieve Price Basis for New Securities.
      *
     E                    TSPB       20  1
      *
      ***  Array to retrieve Number of Decimal places for New Currencies.
      *
     E                    TCDP       20  1 0
      *
      ***  Array to input Balancing Stock Allocation of New Security to Actual Stock Allocation
      ***  for Dummy Customer.
      *
     E                    TBSA       20 30 9
      *
      ***  Array to input Balancing Stock Rounding of New Security to Actual Stock Rounding
      ***  for Dummy Customer.
      *
     E                    TBSR       20 30 9
      *
      ***  Array to input Balancing Cash Rounding of New Security to Actual Cash Rounding
      ***  for Dummy Customer.
      *
     E                    TBCR       20 30 9
      *
      ***  Array for error narrative when calling PGM.
      *
     E                    NARR    1   2 29
      *
      ***  Array containing Copyright statement.
      *
     E                    CPY@    1   1 80
      /SPACE 3
     ISECORFX0                                                            CSE020
      ** Rename fields of SECORFL0: Midas SE CA Reference File            CSE020
      *                                                                   CSE020
     I              MARECI                          MNRECI                CSE020
     I              MALCD                           MNLCD                 CSE020
     I              MACHTP                          MNCHTP                CSE020
     I              MALUID                          MNLUID                CSE020
     I              MACORF                          MNCORF                CSE020
     I              MAJOBN                          MNJOBN                CSE020
     I              MAUSER                          MNUSER                CSE020
     I              MAJNBR                          MNJNBR                CSE020
     I              MASESN                          MNSESN                CSE020
     I              MACOAT                          MNCOAT                CSE020
     I              MAPTYP                          MNPTYP                CSE020
     I              MACOAN                          MNCOAN                CSE020
     I              MACOEX                          MNCOEX                CSE020
     I              MAALEF                          MNALEF                CSE020
     I              MANBOP                          MNNBOP                CSE020
     I              MATDVD                          MNTDVD                CSE020
     I              MACOPD                          MNCOPD                CSE020
     I              MATDDT                          MNTDDT                CSE020
     I              MAEVDT                          MNEVDT                CSE020
     I              MACPNB                          MNCPNB                CSE020
     I              MASHMD                          MNSHMD                CSE020
     I              MALTBS                          MNLTBS                CSE020
     I              MAOCPV                          MNOCPV                CSE020
     I              MANCPV                          MNNCPV                CSE020
     I              MAONML                          MNONML                CSE020
     I              MANNML                          MNNNML                CSE020
     I              MACUPC                          MNCUPC                CSE020
     I              MAEXPC                          MNEXPC                CSE020
     I              MACLRD                          MNCLRD                CSE020
     I              MACLRT                          MNCLRT                CSE020
     I              MADLRD                          MNDLRD                CSE020
     I              MADLRT                          MNDLRT                CSE020
     I              MABLOS                          MNBLOS                CSE020
     I              MABLOP                          MNBLOP                CSE020
     I              MABFRD                          MNBFRD                CSE020
     I              MABEND                          MNBEND                CSE020
     I              MAREFO                          MNREFO                CSE020
     I              MACONR                          MNCONR                CSE020
     I              MADFNR                          MNDFNR                CSE020
     I              MADFCP                          MNDFCP                CSE020
     I              MADFSP                          MNDFSP                CSE020
     I              MALREQ                          MNLREQ                CSE020
     I              MALPRO                          MNLPRO                CSE020
     I              MALTSI                          MNLTSI                CSE020
     I              MASTAT                          MNSTAT                CSE020
     I              MAPREF                          MNPREF                CSE020
     ISECOALD5                                                            CSE020
      ** Rename fields of SECOALL5: Midas SE CA Stock Allocations File    CSE020
      *                                                                   CSE020
     I              MCRECI                          M5RECI                CSE020
     I              MCLCD                           M5LCD                 CSE020
     I              MCCHTP                          M5CHTP                CSE020
     I              MCLUID                          M5LUID                CSE020
     I              MCCORF                          M5CORF                CSE020
     I              MCOPTN                          M5OPTN                CSE020
     I              MCBRCD                          M5BRCD                CSE020
     I              MCDDPT                          M5DDPT                CSE020
     I              MCCOTP                          M5COTP                CSE020
     I              MCBOOK                          M5BOOK                CSE020
     I              MCCNUM                          M5CNUM                CSE020
     I              MCPTFR                          M5PTFR                CSE020
     I              MCEXPO                          M5EXPO                CSE020
     I              MCSESN                          M5SESN                CSE020
     I              MCOALR                          M5OALR                CSE020
     I              MCOTSA                          M5OTSA                CSE020
     I              MCOSTR                          M5OSTR                CSE020
     I              MCOCAR                          M5OCAR                CSE020
     I              MCCAOP                          M5CAOP                CSE020
     I              MCASTA                          M5ASTA                CSE020
     I              MCHOST                          M5HOST                CSE020
     I              MCHOCA                          M5HOCA                CSE020
     I              MCACAA                          M5ACAA                CSE020
     I              MCASTR                          M5ASTR                CSE020
     I              MCACAR                          M5ACAR                CSE020
     I              MCOPT1                          M5OPT1                CSE020
     I              MCOPT2                          M5OPT2                CSE020
     I              MCREST                          M5REST                CSE020
     I              MCBSEC                          M5BSEC                CSE020
     I              MCBEDT                          M5BEDT                CSE020
     I              MCBSTT                          M5BSTT                CSE020
     I              MCBLTY                          M5BLTY                CSE020
     I              MCBEWI                          M5BEWI                CSE020
     I              MCCOAT                          M5COAT                CSE020
     I              MCTRRF                          M5TRRF                CSE020
     I              MCTRR2                          M5TRR2                CSE020
     I              MCTRR3                          M5TRR3                CSE020
     I              MCRVRF                          M5RVRF                CSE020
     I              MCRVR2                          M5RVR2                CSE020
     I              MCRVR3                          M5RVR3                CSE020
     I              MCTNL1                          M5TNL1                CSE020
     I              MCLTRQ                          M5LTRQ                CSE020
     I              MCTOTF                          M5TOTF                CSE020
     I              MCTOTT                          M5TOTT                CSE020
      *
      ***  Rename fields of SECOFRL1: Midas SE Corporate Actions - Free Allocations.
      *
     ISECOFRD0
     I              MERECI                          MDRECI
     I              MEOPTN                          MDOPTN
     I              MENSEC                          MDNSEC
     I              MENSHA                          MDNSHA
     I              MEOSHA                          MDOSHA
     I              MEDMLT                          MDDMLT
     I              MERNDN                          MDRNDN
     I              MERNDS                          MDRNDS
     I              MECOMP                          MDCOMP
      *
      ***  Rename fields of SECORGL1: Midas SE Corporate Actions - Rights Issues.
      *
     ISECORGD0
     I              MFRECI                          MDRECI
     I              MFOPTN                          MDOPTN
     I              MFNSEC                          MDNSEC
     I              MFNSHA                          MDNSHA
     I              MFOSHA                          MDOSHA
     I              MFDMLT                          MDDMLT
     I              MFRNDN                          MDRNDN
     I              MFRNDS                          MDRNDS
     I              MFCOMP                          MDCOMP
     I              MFDFNR                          MDDFNR
      *
      ***  Rename fields of SECOCEL1: Midas SE Corporate Actions - Capital Change.
      *
     ISECOCED0
     I              MGRECI                          MDRECI
     I              MGOPTN                          MDOPTN
      *
      ***  Rename fields of SECOCRL1: Midas SE Corporate Actions - Corporate Reorganisation.
      *
     ISECOCRD0
     I              MHRECI                          MDRECI
     I              MHOPTN                          MDOPTN
     I              MHOSHA                          MDOSHA
      *
      ***  Rename fields of SECOOFL1: Midas SE Corporate Actions - Offers.
      *
     ISECOOFD0
     I              MIRECI                          MDRECI
     I              MIOPTN                          MDOPTN
     I              MINSEC                          MDNSEC
     I              MINSHA                          MDNSHA
     I              MIOSHA                          MDOSHA
     I              MIDMLT                          MDDMLT
     I              MIRNDN                          MDRNDN
     I              MIRNDS                          MDRNDS
     I              MICOMP                          MDCOMP
     I              MIDFNR                          MDDFNR
      *
      ***  Rename fields of SECOEXL1: Midas SE Corporate Actions - Exercices and Conversions.
      *
     ISECOEXD0
     I              MJRECI                          MDRECI
     I              MJOPTN                          MDOPTN
     I              MJNSEC                          MDNSEC
     I              MJNSHA                          MDNSHA
     I              MJOSHA                          MDOSHA
     I              MJSUPR                          MDSBPR
     I              MJDMLT                          MDDMLT
     I              MJRNDN                          MDRNDN
     I              MJRNDS                          MDRNDS
     I              MJCOMP                          MDCOMP
     I              MJDFNR                          MDDFNR
     I              MJRCPR                          MDRCPR                161732
      *
      ***  Rename fields of SECONFL1: Midas SE Corporate Actions - Non Financial Events.
      *
     ISECONFD0
     I              MKRECI                          MDRECI
      *
      ***  Rename fields of SECONCL1: Midas SE Corporate Actions - Name Changes.
      *
     ISECONCD0
     I              MLRECI                          MDRECI
     I              MLSESN                          MDNSEC
      *                                                                   CEU017
      ***  Rename fields of SECOCCL2: Midas SE Corporate Actions -        CEU017
      ***                             Currency Changes.                   CEU017
      *                                                                   CEU017
     ISECOCCD0                                                            CEU017
     I              NARECI                          MDRECI                CEU017
     I              NANSEC                          MDNSEC                CEU017
     I              NADMLT                          MDDMLT                CEU017
     I              NARNDN                          MDRNDN                CEU017
     I              NARNDS                          MDRNDS                CEU017
     I              NAONSZ                          MDOSHA                CEU017
     I              NANNSZ                          MDNSHA                CEU017
     I              NACOMP                          MDCOMP                CEU017
      *
      ***  Data area for database error details
      *
     ILDA         DS                            256
     I                                      132 141 WWFILE
     I                                      142 170 WWKEY
     I                                      171 180 WWPGM
     I                                      181 1830WWASE
      *
      ***  Program Status Data Structure.
      *
     IPSDS       SDS
     I                                      254 263 USER
      *
      ***  File Information Data Structure for SE7550AU.
      *
     ISPOOLU      DS
     I                                       83  92 SFILEU
     I                                    B 123 1240SFNUMU
      *
      ***  Data structure for Bank Details.                              - Prefixs BJ
      *
     ISDBANK    E DSSDBANKPD
      *
      ***  Data structure for Securities Trading Details.                - Prefixe BV
      *
     ISDSTRD    E DSSDSTRDPD
      *
      ***  Data structure for Module Details.                            - Prefixe BG
      *
     ISDMMOD    E DSSDMMODPD
      *
      ***  Data structure for Portfolio Management Customer Details.     - Prefixe QB
      *
     ISDPLCS    E DSSDPLCSPD
      *
      ***  Data structure for Security Customer Details.                 - Prefixe BF
      *
     ISDSECS    E DSSDSECSPD
      *
      ***  Data structure for Currency Details.                          - Prefixe A6
      *
     ISDCURR    E DSSDCURRPD
      *
      ***  Data structure for SE Country Tax Rate Details.               - Prefixe TX
      *
     ISECNTR    E DSSECNTRPD
      *
      ***  Data structure for SE Country to Branch Tax Rate Details.     - Prefixe TB
      *
     ISECBTX    E DSSECBTXPD
      *
      ***  Data structure for Branch Details.                            - Prefixe A8
      *
     ISDBRCH    E DSSDBRCHPD
      *                                                                   CPB001
      ***  Data structure for Customer Details.                           CPB001
      *                                                                   CPB001
     ISDCUST    E DSSDCUSTPD                                              CPB001
      *
      ***  Short data structure for access objects.
      *
     I              QQDFAC                          QQDFA1                                    CGL029
     IDSFDY     E DSDSFDY
      *
      ***  Long data structure for access objects.
      *
     IDSSDY     E DSDSSDY
      *                                                                   CPB001
      ***  Very Long data structure for access objects.                   CPB001
      *                                                                   CPB001
     IDSLDY     E DSDSLDY                                                 CPB001
      *
      ***  Data Area giving Midas SE Status.
      *
     ISESTAT    E DSSESTAT
      *
      /EJECT
      *================================================================
      *  P R O G R A M   S T A R T                                    *
      *================================================================
      *
      ***  Perform Initialisation.
      *
     C                     EXSR #INIT
      *
      ***  Details Processing.
      *
     C                     EXSR DETAIL
      *
      ***  Termination Processing.
      *
     C                     EXSR ENDPGM
      *
      *================================================================
      *  P R O G R A M   E N D                                        *
      *================================================================
      /EJECT
      *****************************************************************
      *                                                               *
      * #INIT  - Program Initialisation.                              *
      *                                                               *
      * Called by: Main Processing.                                   *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           #INIT     BEGSR                           ** #INIT SR **
      *
      ***  Entry Parameters.
      *
     C           *ENTRY    PLIST
     C                     PARM           PCORF            CO Reference
     C                     PARM           PBRCD            Branch Code
     C                     PARM           PDDPT   6        Depot
     C                     PARM           POPTN   2        Option Number
     C                     PARM           PNSEC            New Security
     C***********          PARM           PBOOK            Book Code      CAC005
     C                     PARM           PBOOK   2        Book Code      CAC005
     C                     PARM           PCNUM   6        Customer Number
     C                     PARM           PPTFR            Portfolio Reference
      *
      ***  Set up copyright parameter.
      *
     C                     MOVEACPY@      CPY2@  80
      *
      ***  Define Local Data Area and Midas SE Status Data Area.
      *
     C           *NAMVAR   DEFN           LDA
     C           *NAMVAR   DEFN           SESTAT
      *
      ***  Access data area SESTAT: Midas SE Status to check if Portfolio Management have been
      ***  licensed.
      *
     C                     IN   SESTAT
      *
      ***  If Book Code or Customer Number received as parameter not blank, it seams that program
      ***  called from SE7513: Corporate Actions Customers/Books by Depots Maintenance,
      ***  else program called from SE7512: Corporate Actions Depot Selection.
      *
     C           PBOOK     IFNE *BLANKS
     C           PCNUM     ORNE *BLANKS
     C                     MOVE '1'       *IN13
     C                     MOVE POPTN     WWOPTN  20       Option Number (num field - parameter)
     C           PCNUM     IFNE *BLANKS
     C**********           MOVE PCNUM     WWCNUM  60      Customer No (num field - parameter) CSD027
     C                     MOVE PCNUM     WWCNUM  6        Customer No (num field - parameter CSD027
     C                     MOVE 'C'       KCOTP   1        Customer/Book Indicator (for key list)
     C                     ELSE
     C                     MOVE 'B'       KCOTP            Customer/Book Indicator (for key list)
     C                     ENDIF
     C                     ENDIF
      *
      ***  Initialise work fields.
      *
     C                     MOVE *BLANKS   WWERPT  4        Portfolio Reference
     C**********           MOVE PDDPT     WWDDPT  60       Depot (num field - parameter)      CSD027
     C                     MOVE PDDPT     WWDDPT  6        Depot (num field - parameter)      CSD027
     C                     MOVEL'SE7550'  DBPGM
     C                     MOVE PROT      PROT    1
     C                     MOVE POPTN     ROPT
     C                     MOVE 'A'       KRTYP            Record Type for Key
      *
      ***  Define key lists.
      *
     C           @KEY1     KLIST                           Short key for files SEUDEPL0,SECDEPL4
     C                     KFLD           PBRCD            Branch (Parameter)
     C                     KFLD           MASESN           Security (from SECORFL1)
     C                     KFLD           WWDDPT           Depot (num field - Parameter)
      *
     C           @KEY2     KLIST                           Long key for file SEUDEPL0
     C                     KFLD           PBRCD            Branch (Parameter)
     C                     KFLD           MASESN           Security (from SECORFL1)
     C                     KFLD           WWDDPT           Depot (num field - Parameter)
     C                     KFLD           WWUDMK           Market Ind. (work field)
     C                     KFLD           WWUDBK           Book (work field)
     C                     KFLD           KUDDT            Date
      *
     C           @KEY3     KLIST                           Long key for file SECDEPL4
     C                     KFLD           PBRCD            Branch (Parameter)
     C                     KFLD           MASESN           Security (from SECORFL1)
     C                     KFLD           WWDDPT           Depot (num field - Parameter)
     C                     KFLD           WWUDMK           Market Ind. (work field)
     C                     KFLD           WWCDCN           Customer (work field)
     C                     KFLD           WWPTFR           Portolio Reference (work field)
     C                     KFLD           KUDDT            Date
      *
     C           @KEY4     KLIST                           Key for file SEDPOHL0
     C                     KFLD           PBRCD            Branch (Parameter)
     C                     KFLD           WWDDPT           Depot (num field - Parameter)
     C                     KFLD           MASESN           Security (from SECORFL1)
     C                     KFLD           MACOEX           Ex-Date (from SECORFL1)
      *
     C           @KEY5     KLIST                           1st short key for file SECOALL0
     C                     KFLD           PCORF            CO Reference (Parameter)
     C                     KFLD           WWOPTN           Option Number
     C                     KFLD           PBRCD            Branch (Parameter)
     C                     KFLD           WWDDPT           Depot (num field - Parameter)
      *
     C           @KEY6     KLIST                           Key for file SECOREL0
     C                     KFLD           PCORF            CO Reference (Parameter)
     C                     KFLD           PBRCD            Branch (Parameter)
     C                     KFLD           WWCOTP           Customer/Book Indicator (Calculated)
     C                     KFLD           WWUDBK           Book (from SEUDEPL0)
     C                     KFLD           WWCDCN           Customer (from SECDEPL4)
      *
     C           @KEY7     KLIST                           Key for file SECOSIL2
     C                     KFLD           PBRCD            Branch (Parameter)
     C                     KFLD           KUDBK   2        Book
     C                     KFLD           KCOAT   2        Corporate Action Type
     C                     KFLD           KSESN  10        Security
      *
     C           @KEY8     KLIST                           Key for file CLINT (format CLINTCBF)
     C**********           KFLD           KCUST   60       Customer                           CSD027
     C                     KFLD           KCUST   6        Customer                           CSD027
     C                     KFLD           KRTYP   1        Record Type
      *
     C           @KEY9     KLIST                           Key for file SECOSIL1
     C                     KFLD           PBRCD            Branch (Parameter)
     C**********           KFLD           KCDCN   60       Customer                           CSD027
     C                     KFLD           KCDCN   6        Customer                           CSD027
     C                     KFLD           KPTFR   4        Portfolio Reference
     C                     KFLD           KCOAT            Corporate Action Type
     C                     KFLD           KSESN            Security
      *
     C           @KEY12    KLIST                           Key for file SECODRL0
     C                     KFLD           PCORF            CO Reference (Parameter)
     C                     KFLD           PBRCD            Branch (Parameter)
     C                     KFLD           WWDDPT           Depot (num field - Parameter)
      *
     C           @KEY13    KLIST                           Key for file SECOCHL0
     C                     KFLD           KCUGR   2        Customer Group
     C                     KFLD           KCDCN            Customer
     C                     KFLD           KSITP   3        Investment Type
     C                     KFLD           KCOAT            Corporate Action Type
      *
     C           @KEY14    KLIST                           Key for file SECOCHL1
     C                     KFLD           KCLAS   1        Classification
     C                     KFLD           KCDCN            Customer
     C                     KFLD           KSITP            Investment Type
     C                     KFLD           KCOAT            Corporate Action Type
      *
     C           @KEY17    KLIST                           Key for file SECGT
     C                     KFLD           ESNCCY           Event Nominal Currency
     C                     KFLD           KCCOM            Charge Code
      *
     C           @KEY18    KLIST                           Long key for file SECOALL0
     C                     KFLD           PCORF            CO Reference (parameter)
     C                     KFLD           WWOPTN           Option Number (Num field - parameter)
     C                     KFLD           PBRCD            Branch Code (parameter)
     C                     KFLD           WWDDPT           Depot (num field - parameter)
     C                     KFLD           KSESN            New Security
     C                     KFLD           KCOTP            Customer/Book Indicator
     C                     KFLD           PBOOK            Book Code (parameter)
     C                     KFLD           WWCNUM           Customer Number (num field - parameter)
     C                     KFLD           PPTFR            Portfolio Reference (parameter)
      *
     C           @KEY19    KLIST                           Key for file SECOxxL1
     C                     KFLD           PCORF            CO Reference (parameter)
     C                     KFLD           WWOPTN           Option Number (Num field - parameter)
      *
     C           @KEY20    KLIST                           Short key for file SECOALL0-SECODPL0
     C                     KFLD           PCORF            CO Reference (parameter)
     C                     KFLD           WWOPTN           Option Number (Num field - parameter)
     C                     KFLD           PBRCD            Branch Code (parameter)
     C                     KFLD           WWDDPT           Depot (num field - parameter)
      *
     C           @KEY21    KLIST                           Key for file PRICM
     C                     KFLD           MDNSEC           New Security from SECODVL1
     C                     KFLD           KPVDT   50       Value Date
      *                                                                   CSE020
     C           @KEY22    KLIST                                          CSE020
     C                     KFLD           MAPREF                          CSE020
     C                     KFLD           WKBRCD  3                       CSE020
     C**********           KFLD           WKDDPT  60                                   CSE020 CSD027
     C                     KFLD           WKDDPT  6                                           CSD027
     C                     KFLD           WKCOTP  1                       CSE020
     C                     KFLD           WKBOOK  2                       CSE020
     C**********           KFLD           WKCNUM  60                                   CSE020 CSD027
     C                     KFLD           WKCNUM  6                                           CSD027
     C                     KFLD           WKPTFR  4                       CSE020
     C                     KFLD           MASESN                          CSE020
      *                                                                   CSE020
     C           @KEY23    KLIST                                          CSE020
     C                     KFLD           MAPREF                          CSE020
     C                     KFLD           DSBA                            CSE020
     C                     KFLD           DDPT                            CSE020
      *
      ***  RCF Processing for Audit File.
      *
     C                     EXSR RCFAU
      *
      ***  Call Access Program for Bank Details.
      *
     C                     CALL 'AOBANKR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST'  @OPTN   7
     C           SDBANK    PARM SDBANK    DSSDY
      *
      ***  Handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD001       DBASE            ***************
     C                     MOVEL'SDBANKPD'DBFILE           * DB ERROR 01 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Call Access Program for Switchable Feature Details to see if Private Banking SE
      ***  Enhancements is installed.
      *
     C                     MOVE 'N'       S01496  1
     C                     CALL 'AOSARDR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*VERIFY' @OPTN
     C                     PARM 'S01496'  @SARD   6
      *
     C           @RTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       S01496
     C                     ENDIF
      *
      ***  Call Access Program for Switchable Feature Details to see if Customer Commissions
      ***  (Courtage) amendment is installed.
      *
     C                     MOVE 'N'       S01446  1
     C                     CALL 'AOSARDR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*VERIFY' @OPTN
     C                     PARM 'S01446'  @SARD
      *
     C           @RTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       S01446
     C                     ENDIF
      *
      ***  Call Access Program for Switchable Feature Details to see if Withholding Tax feature
      ***  is installed.
      *
     C                     MOVE 'N'       S01447  1
     C                     CALL 'AOSARDR0'
     C                     PARM '       ' @RTCD
     C                     PARM '*VERIFY' @OPTN
     C                     PARM 'S01447'  @SARD   6
      *
     C           @RTCD     IFEQ *BLANKS
     C                     MOVE 'Y'       S01447
     C                     ENDIF
      *                                                                   CAC005
      ** Check if CAC005 is installed                                     CAC005
      *                                                                   CAC005
     C                     CALL 'AOSARDR0'                                CAC005
     C                     PARM *BLANKS   PRTCD   7                       CAC005
     C                     PARM '*VERIFY' P1OPTN  7                       CAC005
     C                     PARM 'CAC005'  PSARD   6                       CAC005
      *                                                                   CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVE 'Y'       CAC005  1                       CAC005
     C                     MOVE *ON       *IN79                           CAC005
     C                     ELSE                                           CAC005
     C                     MOVE 'N'       CAC005                          CAC005
     C                     MOVE *OFF      *IN79                           CAC005
     C                     ENDIF                                          CAC005
      *                                                                   CAC005
     C                     MOVELPBOOK     PBOOK1                          CAC005
     C                     MOVEL*BLANKS   PPRCT                           CAC005
      *                                                                   CAC005
     C           CAC005    IFEQ 'Y'                                       CAC005
     C           PBOOK     ANDNE*BLANKS                                   CAC005
     C                     CALL 'AOBKPCR0'                                CAC005
     C                     PARM *BLANKS   PRTCD                           CAC005
     C                     PARM '*USER  ' P1OPTN                          CAC005
     C                     PARM           PBKCD   2                       CAC005
     C                     PARM           PPRFC   4                       CAC005
     C                     PARM PBOOK     PPSBK   2                       CAC005
      *                                                                   CAC005
     C           PRTCD     IFEQ *BLANKS                                   CAC005
     C                     MOVELPBKCD     PBOOK1                          CAC005
     C                     MOVELPPRFC     PPRCT                           CAC005
     C                     ENDIF                                          CAC005
     C                     ENDIF                                          CAC005
      *
      ***  Call Access Program for Securities Trading Details.
      *
     C                     CALL 'AOSTRDR0'
     C                     PARM *BLANKS   @RTCD   7
     C                     PARM '*FIRST'  @OPTN   7
     C           SDSTRD    PARM SDSTRD    DSSDY
      *
      ***  Handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD002       DBASE            ***************
     C                     MOVEL'SDSTRDPD'DBFILE           * DB ERROR 02 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Call Access Program for Module Details - Portfolio Management Indicator.
      *
     C                     CALL 'AOMMODR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*FIRST'  @OPTN
     C           SDMMOD    PARM SDMMOD    DSFDY
      *
      ***  Handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD003       DBASE            ***************
     C                     MOVEL'SDMMODPD'DBFILE           * DB ERROR 03 *
     C                     MOVEL*BLANKS   DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                   CPB001
     C           BGPFMG    IFEQ 'Y'                                       CPB001
     C           BGN4ST    OREQ 'Y'                                       CPB001
      *
      ***  If Portfolio Management Indicator = 'Y'.
      *
     C                     MOVE 'N'       WWEXC   1                       CPB001
     C           BGPFMG    IFEQ 'Y'
      *
      ***  Call Access Program for Portfolio Management Customer Details to check if CO
      ***  Dummy Customer is a Portfolio Customer.
      *
     C                     CALL 'AOPLCSR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY  '  @OPTN
     C                     PARM BVERCU    @CUST  10
     C           SDPLCS    PARM SDPLCS    DSSDY
      *
      ***  If CO Dummy Customer is a Portfolio Customer, setup Portfolio Reference work field.
      *
     C           @RTCD     IFEQ *BLANKS                    Found
     C           BGN4ST    ANDNE'Y'                                       CPB001
     C                     MOVEL'9997'    WWERPT
     C                     ELSE                                           CPB001
     C           @RTCD     IFEQ *BLANKS                                   CPB001
     C                     MOVE 'Y'       WWEXC                           CPB001
     C                     ENDIF                                          CPB001
     C                     ENDIF
     C                     ENDIF
      *                                                                   CPB001
      ***  If Private Banking is ON                                       CPB001
      *                                                                   CPB001
     C           BGN4ST    IFEQ 'Y'                                       CPB001
     C                     CALL 'AOCUSTR1'                                CPB001
     C                     PARM *BLANKS   @RTCD                           CPB001
     C                     PARM '*KEY    '@OPTN                           CPB001
     C                     PARM BVERCU    @CUST                           CPB001
     C                     PARM           WWK7    7                       CPB001
     C           SDCUST    PARM SDCUST    DSLDY                           CPB001
     C           @RTCD     IFEQ *BLANKS                                   CPB001
     C           BBPRBA    ANDEQ'Y'                                       CPB001
     C                     MOVE 'Y'       WWEXC                           CPB001
     C                     ENDIF                                          CPB001
     C                     ENDIF                                          CPB001
      *                                                                   CPB001
      ***  Default Portfolio Reference if neede                           CPB001
      *                                                                   CPB001
     C           WWEXC     IFEQ 'Y'                                       CPB001
     C                     OPEN PMPORTLL                                  CPB001
     C**********           MOVELBVERCU    WKCUST  60                                   CPB001 CSD027
     C                     MOVELBVERCU    WKCUST  6                                           CSD027
     C           WKCUST    SETLLPMPORTLL                                  CPB001
     C           WKCUST    READEPMPORTLL                 89               CPB001
     C           *IN89     IFEQ *OFF                                      CPB001
     C                     MOVE PNPTFR    WWERPT                          CPB001
     C                     ENDIF                                          CPB001
     C                     CLOSEPMPORTLL                                  CPB001
     C                     ENDIF                                          CPB001
     C                     ENDIF                                          CPB001
      *
      ***  If Withholding Tax feature is ON.
      *
     C           S01447    IFEQ 'Y'
      *
      ***  Call Access Program for Branch Details to retrieve Branch Internal Customer.
      *
     C**********           CALL 'AOBRCHR0'                                                    CGL029
     C                     CALL 'AOBRCHR1'                                                    CGL029
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM PBRCD     @BRCD   3
     C********** SDBRCH    PARM SDBRCH    DSFDY                                               CGL029
     C           SDBRCH    PARM SDBRCH    DSSDY                                               CGL029
      *
      ***  If record not found, handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD004       DBASE            ***************
     C                     MOVEL'SDBRCHPD'DBFILE           * DB ERROR 04 *
     C                     MOVELPBRCD     DBKEY            ***************
     C                     EXSR *PSSR
     C                     ELSE
      *
      ***  Otherwise, retrieve Country of Location for Branch Interbal Customer.
      *
     C                     MOVE A8BICN    KCUST
     C           @KEY8     CHAINCLINT                84
      *
      ***  If record not found or not live, handle Database Error.
      *
     C           *IN84     IFEQ '1'
     C           RECI      OREQ '*'
     C                     Z-ADD005       DBASE            ***************
     C                     MOVEL'CLINTCB 'DBFILE           * DB ERROR 05 *
     C                     MOVELKCUST     DBKEY2  7        ***************
     C                     MOVE KRTYP     DBKEY2
     C                     MOVELDBKEY2    DBKEY
     C                     EXSR *PSSR
     C                     ELSE
      *
      ***  Otherwise, set Country of Location for Branch Internal Customer.
      *
     C                     MOVE CLOC      UBRLOC  2
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C/COPY WNCPYSRC,SE7550C001
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * DETAIL - Detail Processing.                                   *
      *                                                               *
      * Called by: Main Processing.                                   *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           DETAIL    BEGSR                           ** DETAIL SR **
      *
      ***  Access Corporate Actions file with CO Reference received as parameter to obtain details.
      *
     C           PCORF     CHAINSECORFL1             80
      *
      ***  If record not found, handle Database Error.
      *
     C           *IN80     IFEQ '1'                        Not found
     C                     Z-ADD006       DBASE            ***************
     C                     MOVEL'SECORFL1'DBFILE           * DB ERROR 06 *
     C                     MOVELPCORF     DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *                                                                   CSE020
      ** If CA is a child, obtain the Security from the Originating CA    CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C           MAPREF    CHAINSECORFL0             70                   CSE020
     C           *IN70     IFEQ *ON                                       CSE020
     C           *LOCK     IN   LDA                                       CSE020
     C                     Z-ADD040       DBASE            ***************CSE020
     C                     MOVEL'SECORFPD'DBFILE           * DB ERROR 040*CSE020
     C                     MOVELMAPREF    DBKEY            ***************CSE020
     C                     OUT  LDA                                       CSE020
     C                     EXSR *PSSR                                     CSE020
     C                     ENDIF                                          CSE020
     C           MNPREF    DOWNE*BLANKS                                   CSE020
     C           MNPREF    CHAINSECORFL0             70                   CSE020
     C           *IN70     IFEQ *ON                                       CSE020
     C           *LOCK     IN   LDA                                       CSE020
     C                     Z-ADD041       DBASE            ***************CSE020
     C                     MOVEL'SECORFPD'DBFILE           * DB ERROR 041*CSE020
     C                     MOVELMNPREF    DBKEY            ***************CSE020
     C                     OUT  LDA                                       CSE020
     C                     EXSR *PSSR                                     CSE020
     C                     ENDIF                                          CSE020
     C                     ENDDO                                          CSE020
     C                     MOVE MNSESN    WOSESN 10                       CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Retrieve field 'Letter Required'.
      *
     C                     MOVE MALREQ    WWLTRQ  1
      *
      ***  Access Midas SE Securities.
      *
     C           MASESN    CHAINSECTY                80
      *
      ***  If record not found, handle Database Error.
      *
     C           *IN80     IFEQ '1'                        Not found
     C                     Z-ADD007       DBASE            ***************
     C                     MOVEL'SECTY'   DBFILE           * DB ERROR 07 *
     C                     MOVELMASESN    DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Save Nominal Currency, Number of Decimal Places for Nominal Currency, Investment Type,
      ***  Market Centre and Price Basis of Event Security from SECORFL1.
      *
     C                     MOVE NMCY      ESNCCY  3        Nominal Currency
     C                     Z-ADDNMDP      ESNBDP  10       Number of Decimal Places
     C                     MOVE SITP      ESSITP  3        Investment Type
     C                     MOVE SMCC      ESSMCC  2        Market Centre
     C                     MOVE SPBS      ESSPBS  1        Price Basis
      *
      ***  Retrieve Number of Decimal Places of Event Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM ESNCCY    @AJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD008       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 08 *
     C                     MOVEL@AJCD     DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    ECNBDP  10
      *
      ***  If program called from SE7512: Corporate Actions Depot Selection (*IN13 OFF).
      *
     C           *IN13     IFEQ '0'
      *
      ***  Delete Corporate Actions Allocation and Depot for CO Reference and Depot received as
      ***  parameter.
      *
     C                     EXSR DADCOR
      *
      ***  Process Detail for CO Reference depending on the Processing Type.
      *
     C                     EXSR PDCORF
      *
      ***  Else, if program called from SE7513: Corporate Actions Customers/Books by Depots
      ***  Maintenance (*IN13 ON).
      *
     C                     ELSE
      *
      ***  Delete Corporate Actions Allocation and Depot for CO Reference, Option Number, Branch,
      ***  Depot, New Security, Book, Customer and Portfolio.
      *
     C                     EXSR DADNSE
      *
      ***  Process Detail for CO Reference, Option Number and New Security, depending on the
      ***  Processing Type.
      *
     C                     EXSR PDNSEC
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * PBKDPT - Process Books for the Depot.                         *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           PBKDPT    BEGSR                           ** PBKDPT SR **
      *
      ***  Reset work fields.
      *
     C**********           MOVE *ZEROS    WWCDCN  60       Customer                           CSD027
     C                     MOVE *BLANKS   WWCDCN  6        Customer                           CSD027
     C                     MOVE *BLANKS   WWPTFR  4        Protfolio Reference
      *                                                                   CSE020
      ** If CA is a child, save Security. Instead, use Security           CSE020
      ** obtained from the Originating CA before reading SEUDEPL0.        CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE MASESN    WKSESN 10                       CSE020
     C                     MOVE WOSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ***  If program called from SE7512: Corporate Actions Depot Selection.
      *
     C           *IN13     IFEQ '0'
      *
      ***  Set lower on User Depot Positions Details file with Branch, Security and Depot (num
      ***  field) received as parameter and read next record.
      *
     C           @KEY1     SETLLSEUDEPL0
     C                     READ SEUDEPL0                 81
      *
      ***  Else, if program called from SE7513: Corporate Actions Customers/Books by Depots
      ***  Maintenance.
      *
     C                     ELSE
      *
      ***  Set lower on User Depot Positions Details file with Branch, Security and Depot (num
      ***  field) received as parameter and read next record until Book = Book received as
      ***  parameter.
      *
     C                     MOVE '0'       *IN88
     C           @KEY1     SETLLSEUDEPL0
     C           @KEY1     READESEUDEPL0                 81
     C   81                MOVE '1'       *IN88
     C           *IN88     DOWEQ'0'
     C           UDBK      IFEQ PBOOK
     C                     MOVE '1'       *IN88
     C                     ELSE
     C           @KEY1     READESEUDEPL0                 81
     C   81                MOVE '1'       *IN88
     C                     ENDIF
     C                     ENDDO
     C                     ENDIF
      *
      ***  Save Market Indicator.
      *
     C                     MOVE UDMK      WWUDMK  1
      *
      ***  Do while not end of file, and record read with same Branch, Security and Depot (num
      ***  field) received as parameter and same Market Indicator saved, if program called from
      ***  SE7512: Corporate Actions Depot Selection,
      ***  OR do while not end of file, and record read with same Branch, New Security, Depot (num
      ***  field) and Book received as parameter and same Market Indicator saved, if program called
      ***  from SE7513: Corporate Actions Customers/Books by Depots Maintenance.
      *
     C           *IN81     DOWEQ'0'                        Do while: Not end of file
     C           *IN13     ANDEQ'0'                                  Program called from SE7512
     C           UDBA      ANDEQPBRCD                                Same Branch
     C           UDSN      ANDEQMASESN                               Same Security
     C           UDPT      ANDEQWWDDPT                               Same Depot
     C           UDMK      ANDEQWWUDMK                               Same Market Indicator
     C           *IN81     OREQ '0'                        OR      : Not end of file
     C           *IN13     ANDEQ'1'                                  Program called from SE7513
     C           UDBA      ANDEQPBRCD                                Same Branch
     C           UDSN      ANDEQMASESN                               Same Security
     C           UDPT      ANDEQWWDDPT                               Same Depot
     C           UDMK      ANDEQWWUDMK                               Same Market Indicator
     C           UDBK      ANDEQPBOOK                                Same Book
      ******                                                              135686
      *****If*live*record.*********************************************** 135686
      ******                                                              135686
     C******     RECI      IFEQ 'D'                                       135686
      *
      ***  Save Book.
      *
     C                     MOVE UDBK      WWUDBK  2
      *
      ***  Set greater on User Depot Positions Details file with Branch, Security and Depot (num
      ***  field) received as parameter, Market Indicator and Book saved and Ex-Date (num field)
      ***  received as parameter and read previous record.
      *
     C                     Z-ADDMACOEX    KUDDT   50
     C           @KEY2     SETGTSEUDEPL0
     C                     READPSEUDEPL0                 81
      *
      ***  If record read with same Branch, Security and Depot (num field) received as parameter
      ***  and same Market Indicator and Book saved.                      135686
      *****and*same*Market*Indicator*and*Book*saved*and*live*record.***** 135686
      *
     C           UDBA      IFEQ PBRCD                      Same Branch
     C           UDSN      ANDEQMASESN                     Same Security
     C           UDPT      ANDEQWWDDPT                     Same Depot
     C           UDMK      ANDEQWWUDMK                     Same Market Indicator
     C           UDBK      ANDEQWWUDBK                     Same Book
     C******     RECI      ANDEQ'D'                        Live record    135686
      *
      ***  Set Customer/Book Indicator to 'B'.
      *
     C                     MOVE 'B'       WWCOTP  1
      *                                                                   CSE020
      ** If CA is a child, restore MASESN with Security of the child      CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WKSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Retrieve Book Current Reply and Standard Instruction.
      *
     C                     MOVE 'B'       FROMBC  1
     C                     EXSR RTVRPL
      *
      ***  Retrieve Actual Allocation for Options and Actual Allocation for options within the
      ***  Option.
      *
     C                     EXSR RAAOPT
      *
      ***  If Trade/Value Date Position from SECORFL1 = 'T', set Ex-Date Position = Nominal Trade
      ***  Date Basis.
      *
     C           MATDVD    IFEQ 'T'
     C**********           Z-ADDUDNT      WWTDVD 150                      149257
     C                     Z-ADDUDNT      WWTDVD 194                      149257
      *
      ***  If Trade/Value Date Position from SECORFL1 = 'V', set Ex-Date Position = Nominal Value
      ***  Date Basis.
      *
     C                     ELSE
     C                     Z-ADDUDNV      WWTDVD
     C                     ENDIF
      *                                                                   CSE020
      ** If CA is a child, set Ex-date Position = Actual Stock            CSE020
      ** Allocation of the Parent CA. Setup fields for the key list.      CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE UDBA      WKBRCD                          CSE020
     C                     MOVE UDPT      WKDDPT                          CSE020
     C                     MOVE 'B'       WKCOTP                          CSE020
     C                     MOVE UDBK      WKBOOK                          CSE020
     C                     MOVE *BLANKS   WKCNUM                          CSE020
     C                     MOVE *BLANKS   WKPTFR                          CSE020
      *                                                                   CSE020
      ** Chain to LF/SECOALL5 to retrieve Actual Stock Allocation.        CSE020
      *                                                                   CSE020
     C           @KEY22    CHAINSECOALL5             70                   CSE020
     C           *IN70     IFEQ *OFF                                      CSE020
     C                     Z-ADDM5ASTA    WWTDVD                          CSE020
     C                     ELSE                                           CSE020
     C                     Z-ADD0         WWTDVD                          CSE020
     C                     ENDIF                                          CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     Z-ADDESNBDP    WWNBDP  10
     C                     Z-ADDWWTDVD    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDWWNUM     WWTDVD
      *
      ***  Set Total Fees and Total Taxes to 0, must not be calculated for Book.
      *
     C                     Z-ADD0         WWTOTF 309
     C                     Z-ADD0         WWTOTT 309
      *                                                                   136935
      ***  Reset total Original and Actual Stock Allocation work fields.  136935
      *                                                                   136935
     C                     Z-ADD0         WUOALR 309                      136935
     C                     Z-ADD0         W2OALR 309                      136935
     C                     Z-ADD0         WUASTA 309                      136935
      *
      ***  Do while New Security not blank.
      *
     C                     Z-ADD1         I       20
     C           I         DOWLE20
     C           TSEC,I    ANDNE*BLANKS
      *
      ***  Setup New Security Shortname.
      *
     C                     MOVE TSEC,I    NWSESN 10
      *
      ***  Prepare Price Basis for New Security.
      *
     C                     MOVE TSPB,I    NSSPBS  1
      *
      ***  Prepare Number of Decimal Places of New Security.
      *
     C                     MOVE TSDP,I    NSNBDP  10
      *
      ***  Prepare Number of Decimal Places of New Currency.
      *
     C                     MOVE TCDP,I    NCNBDP  10
      *
      ***  Prepare Number Of New Shares:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TNSH,I    WWNSHA 157
     C                     ELSE
     C                     Z-ADDMDNSHA    WWNSHA
     C                     ENDIF
      *
      ***  Prepare Denomination Multiplier:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C*****                MOVE TDML,I    WUNUM                           179024
     C                     MOVE TDML,I    WDM16  160                      179024
     C                     ELSE
     C*****                Z-ADDMDDMLT    WUNUM                           179024
     C                     Z-ADDMDDMLT    WDM16                           179024
     C                     ENDIF
     C           5         SUB  NSNBDP    J       10                      179024
     C           WDM16     MULT POWER8,J  WWDMLT 309                      179024
     C*****                Z-ADDNSNBDP    WWNBDP                          179024
     C*****                EXSR RTVNDP                                    179024
     C*****                Z-ADDWWNUM     WWDMLT 309                      179024
      *
      ***  Prepare Rounding:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TNDN,I    WWRNDN  1
     C                     ELSE
     C                     MOVE MDRNDN    WWRNDN
     C                     ENDIF
      *
      ***  Prepare field Rounding Settlement in Cash:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Details File.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TNDS,I    WWRNDS  1
     C                     ELSE
     C                     MOVE MDRNDS    WWRNDS
     C                     ENDIF
      *
      ***  Prepare Compensation Price:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Details File.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TOPA,I    WWCOMP 158
     C                     ELSE
      *                                                                   135685
      ***  If Processing Type = Currency Change                           135685
      ***  and Compensation Price is entered as Market,                   135685
      ***  the Compensation Price must first be calculated                135685
      ***  from Current Market Price.                                     135685
      *                                                                   135685
     C           MAPTYP    IFEQ 'CC'                                      135685
     C           NAMRKI    ANDEQ'Y'                                       135685
     C                     EXSR CCOMP                                     135685
     C                     ENDIF                                          135685
      *                                                                   135685
     C                     Z-ADDMDCOMP    WWCOMP
     C                     ENDIF
      *                                                                   145872
      ***  If Exchange Offer, calculate base Ex-Date Position = Ex-Date   145872
      ***  Position multiplied by Percentage to Exchange.                 145872
      *                                                                   145872
     C           MAPTYP    IFEQ 'OF'                                      145872
     C           MIOFTY    ANDEQ'E'                                       145872
     C***********          Z-ADDWWTDVD    WUTDVD 150               145872 219635A
     C                     Z-ADDWWTDVD    WUTDVD 194                      219635A
     C           WWTDVD    MULT MIPREX    WWTDVD                          145872
     C           WWTDVD    DIV  100       WWTDVD                          145872
     C                     Z-ADDESNBDP    WWNBDP           New Sec.Dec.Pl.145872
     C                     MOVE WWRNDN    WUROOP           CO Det. Round. 145872
     C                     Z-ADDWWTDVD    WWNUM                           145872
     C                     EXSR ROUNDD                                    145872
     C                     Z-ADDWWNUM     WWTDVD                          145872
     C                     ENDIF                                          145872
      *
      ***  Some fields must not be calculated for New Security.
      *
     C                     Z-ADD0         WWCAOP           Original Cash Option
     C                     Z-ADD0         WWACAA           Actual Cash Allocation
      *                                                                   136935
     C                     MOVE WWOPT1    WKOPTN  10                      136935
     C           MDOPTN    IFEQ WKOPTN                                    136935
     C           MANBOP    OREQ 1                                         136935
      *
      ***  Calculate Allocations: - Original Stock Allocation
      ***                         - True Stock Allocation
      ***                         - Original Stock Rounding
      ***                         - Original Cask Rounding.
      *
     C                     EXSR CALLOC
      *
      ***  Calculate other Book Allocations.
      *
     C                     EXSR CALBC
     C                     ELSE                                           136935
     C                     Z-ADD0         WWOALR                          136935
     C                     Z-ADD0         WWOTSA                          136935
     C                     Z-ADD0         WWOSTR                          136935
     C                     Z-ADD0         WWOCAR                          136935
     C                     Z-ADD0         WWASTA                          136935
     C                     Z-ADD0         WWASTR                          136935
     C                     Z-ADD0         WWACAR                          136935
     C                     Z-ADD0         WWHOST                          136935
     C                     Z-ADD0         WWHOCA                          136935
     C                     ENDIF                                          136935
      *
      ***  Set Reply Status to 'N' (by default).
      *
     C                     MOVE 'N'       WWREST  1        'None'
      *
      ***  If Book Current Reply exists, set Reply Status to 'R'.
      *
     C           EXBCRE    IFEQ 'Y'
     C                     MOVE 'R'       WWREST           'Reply Received'
      *
      ***  Else, if Book Current Reply does not exists.
      *
     C                     ELSE
      *
      ***  If Book Standard Corporate Actions Instruction exists, set Reply Status to 'S'.
      *
     C           EXBCSI    IFEQ 'Y'
     C                     MOVE 'S'       WWREST           'Std Inst Default'
     C                     ELSE
      *
      ***  Else, if Book Standard Corporate Actions Instruction does not exist (and Book Current
      ***  Reply does not exist), set the Reply Status to 'C' (the default no reply is used).
      *
     C                     MOVE 'C'       WWREST           'Corporate Default'
     C                     ENDIF
     C                     ENDIF
      *
      ***  Write a record on SECOALL0: Corporate Actions Allocations file.
      *
     C                     EXSR WRCOAL
      *                                                                   135686
      ***  Set indicator Customer or Book processed to 'Y'.               135686
      *                                                                   135686
     C                     MOVE 'Y'       BCPROC                          135686
      *
     C                     ADD  1         I
     C                     ENDDO
      *
      ***  Setup New Security to '**CASH**'.
      *
     C                     MOVE *BLANKS   NWSESN
     C                     MOVEL'**CASH**'NWSESN
      *
      ***  Some fields must not be calculated for Security = '**CASH**'.
      *
     C                     Z-ADD0         WWOALR           Original Stock Allocation
     C                     Z-ADD0         WWOTSA           True Stock Allocation
     C                     Z-ADD0         WWOSTR           Original Stock Rounding
     C                     Z-ADD0         WWASTA           Actual Stock Allocation
     C                     Z-ADD0         WWASTR           Actual Stock Rounding
      *                                                                   136935
     C                     MOVE WWOPT1    WKOPTN                          136935
     C           MDOPTN    IFEQ WKOPTN                                    136935
     C           MANBOP    OREQ 1                                         136935
      *
      ***  Calculate Original Cash Rounding for Security = '**CASH**'.
      *
     C                     EXSR COCR
      *
      ***  Calculate Actual Cash Rounding for Security = '**CASH**'.
      *
     C                     Z-ADDWTACAR    WWNUM            Total Actual Cash Rounding accumulated
     C                     EXSR CACR
      *
      ***  Calculate Holding Taken as Stock for Security = '**CASH**'.
      *
     C                     EXSR CHST
      *
      ***  Calculate Holding Taken as Cash for Security = '**CASH**'.
      *
     C                     EXSR CHCA
      *
      ***  Calculate Cash Option and Actual Cash Allocation for Book/Customer.
      *
     C                     EXSR CCABC
     C                     ELSE                                           136935
     C                     Z-ADD0         WWOALR                          136935
     C                     Z-ADD0         WWOTSA                          136935
     C                     Z-ADD0         WWOSTR                          136935
     C                     Z-ADD0         WWOCAR                          136935
     C                     Z-ADD0         WWASTA                          136935
     C                     Z-ADD0         WWASTR                          136935
     C                     Z-ADD0         WWACAR                          136935
     C                     Z-ADD0         WWHOST                          136935
     C                     Z-ADD0         WWHOCA                          136935
     C                     ENDIF                                          136935
      *
      ***  Write a record on SECOALL0: Corporate Actions Allocations file.
      *
     C                     EXSR WRCOAL
      *
      ***  Set to zero the Total Actual Cash Rounding and the Total Original Cash Rounding work
      ***  fields.
      *
     C                     Z-ADD0         WTACAR           Total Actual Cash Rounding
     C                     Z-ADD0         WTOCAR           Total Original Cash Rounding
      *
     C                     ENDIF
      *                                                                   CSE020
      ** If CA is a child, replace Security with the Security obtained    CSE020
      ** from the Originating CA before reading SEUDEPL0.                 CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WOSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Set greater on User Depot Positions Details file with Branch, Security and Depot (num
      ***  field) received as parameter, Market Indicator and Book saved and Ex-Date equal to *HIVAL
      ***  and read next record.
      *
     C                     MOVE *HIVAL    KUDDT
     C           @KEY2     SETGTSEUDEPL0
     C                     READ SEUDEPL0                 81
      ******                                                              135686
     C******               ELSE                                           135686
     C***13*               READ SEUDEPL0                 81               135686
     C**N13*     @KEY1     READESEUDEPL0                 81               135686
     C******               ENDIF                                          135686
      *
     C                     ENDDO
      *
      ** If CA is a child, restore MASESN with Security of the child      CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WKSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * PCUDPT - Process Customers for the Depot.                     *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           PCUDPT    BEGSR                           ** PCUDPT SR **
      *
      ***  Reset work field.
      *
     C                     MOVE *BLANKS   WWUDBK           Book
      *                                                                   CSE020
      ** If CA is a child, save Security. Instead, use Security           CSE020
      ** obtained from the Originating CA before reading SECDEPL4.        CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE MASESN    WKSESN                          CSE020
     C                     MOVE WOSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ***  If program called from SE7512: Corporate Actions Depot Selection.
      *
     C           *IN13     IFEQ '0'
      *
      ***  Set lower on Client Depot Position Deatils with Branch, Security and Depot (num field)
      ***  received as parameter and read next record.
      *
     C           @KEY1     SETLLSECDEPL4
     C                     READ SECDEPL4                 81
      *
      ***  Else, if program called from SE7513: Corporate Actions Customers/Books by Depots
      ***  Maintenance.
      *
     C                     ELSE
      *
      ***  Set lower on User Depot Positions Details file with Branch, Security and Depot (num
      ***  field) received as parameter and read next record until Customer and Portfolio = Customer
      ***  (num field) and Portfolio received as parameter.
      *
     C                     MOVE '0'       *IN88
     C           @KEY1     SETLLSECDEPL4
     C           @KEY1     READESECDEPL4                 81
     C   81                MOVE '1'       *IN88
     C           *IN88     DOWEQ'0'
     C           CDCN      IFEQ WWCNUM
     C           PTFR      ANDEQPPTFR
     C                     MOVE '1'       *IN88
     C                     ELSE
     C           @KEY1     READESECDEPL4                 81
     C   81                MOVE '1'       *IN88
     C                     ENDIF
     C                     ENDDO
     C                     ENDIF
      *
      ***  Save Market Indicator.
      *
     C                     MOVE CDMK      WWUDMK
      *
      ***  Do while not end of file, and record read with same Branch, Security and Depot (num
      ***  field) received as parameter and same Market Indicator saved, if program called from
      ***  SE7512: Corporate Actions Depot Selection,
      ***  OR do while not end of file, and record read with same Branch, New Security, Depot (num
      ***  field), Customer (num field) and Portfolio received as parameter and same Market
      ***  Indicator saved, if program called from SE7513: Corporate Actions Customers/Books by
      ***  Depots Maintenance.
      *
     C           *IN81     DOWEQ'0'                        Do while: Not end of file
     C           *IN13     ANDEQ'0'                                  Program called from SE7512
     C           CDPA      ANDEQPBRCD                                Same Branch
     C           CDSN      ANDEQMASESN                               Same Security
     C           CDPT      ANDEQWWDDPT                               Same Depot
     C           CDMK      ANDEQWWUDMK                               Same Market Indicator
     C           *IN81     OREQ '0'                        OR      : Not end of file
     C           *IN13     ANDEQ'1'                                  Program called from SE7513
     C           CDPA      ANDEQPBRCD                                Same Branch
     C           CDSN      ANDEQMASESN                               Same Security
     C           CDPT      ANDEQWWDDPT                               Same Depot
     C           CDMK      ANDEQWWUDMK                               Same Market Indicator
     C           CDCN      ANDEQWWCNUM                               Same Customer
     C           PTFR      ANDEQPPTFR                                Same Portfolio
      ******                                                              135686
      *****If*live*record************************************************ 135686
      ******                                                              135686
     C******     RECI      IFEQ 'D'                                       135686
      *
      ***  Save Customer and Portfolio Reference.
      *
     C                     MOVE CDCN      WWCDCN
     C                     MOVE PTFR      WWPTFR
      *
      ***  Set greater on Client Depot Positions Details file with Branch, Security and Depot (num
      ***  field) received as parameter, Market Indicator, Customer and Portfolio Reference saved
      ***  and Ex-Date (num field) received as parameter and read previous record.
      *
     C                     Z-ADDMACOEX    KUDDT
     C           @KEY3     SETGTSECDEPL4
     C                     READPSECDEPL4                 81
      *
      ***  If record read with same Branch, Security and Depot (num field) received as parameter
      ***  and same Market Indicator, Customer and Portfolio Reference    135686
      ***  saved.                                                         135686
      *****and*same*Market*Indicator,*Customer*and*Portfolio*Reference*** 135686
      *****saved*and*live*record.**************************************** 135686
      *
     C           CDPA      IFEQ PBRCD                      Same Branch
     C           CDSN      ANDEQMASESN                     Same Security
     C           CDPT      ANDEQWWDDPT                     Same Depot
     C           CDMK      ANDEQWWUDMK                     Same Market Indicator
     C           CDCN      ANDEQWWCDCN                     Same Customer
     C           PTFR      ANDEQWWPTFR                     Same Portfolio Reference
     C******     RECI      ANDEQ'D'                        Live record    135686
      *
      ***  Set first passage for Processing Type Corporate Action to 'Y' (Block fields should only
      ***  be filled on first record written in CO Allocation file (SECOALL0) for Processing Type
      ***  = Corporate Reorganisation).
      *
     C                     MOVE 'Y'       FIRSCR  1
      *
      ***  Set Customer/Book Indicator to 'C'.
      *
     C                     MOVE 'C'       WWCOTP
      *                                                                   CSE020
      ** If CA is a child, restore MASESN with Security of the child      CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WKSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Retrieve Book Current Reply and Standard Instruction.
      *
     C                     MOVE 'C'       FROMBC
     C                     EXSR RTVRPL
      *
      ***  Retrieve Actual Allocation for Options and Actual Allocation for options within the
      ***  Option.
      *
     C                     EXSR RAAOPT
      *
      ***  If Trade/Value Date Position from SECORFL1 = 'T', set Ex-Date Position = Nominal Trade
      ***  Date Basis.
      *
     C           MATDVD    IFEQ 'T'
     C                     Z-ADDCDNT      WWTDVD
      *
      ***  If Trade/Value Date Position from SECORFL1 = 'V', set Ex-Date Position = Nominal Value
      ***  Date Basis.
      *
     C                     ELSE
     C                     Z-ADDCDNV      WWTDVD
     C                     ENDIF
      *                                                                   CSE020
      ** If CA is a child, set Ex-date Position = Actual Stock            CSE020
      ** Allocation of the Parent CA. Setup fields for the key list.      CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE CDPA      WKBRCD                          CSE020
     C                     MOVE CDPT      WKDDPT                          CSE020
     C                     MOVE 'C'       WKCOTP                          CSE020
     C                     MOVE *BLANKS   WKBOOK                          CSE020
     C                     MOVE CDCN      WKCNUM                          CSE020
     C                     MOVE PTFR      WKPTFR                          CSE020
      *                                                                   CSE020
      ** Chain to LF/SECOALL5 to retrieve Actual Stock Allocation.        CSE020
      *                                                                   CSE020
     C           @KEY22    CHAINSECOALL5             70                   CSE020
     C           *IN70     IFEQ *OFF                                      CSE020
     C                     Z-ADDM5ASTA    WWTDVD                          CSE020
     C                     ELSE                                           CSE020
     C                     Z-ADD0         WWTDVD                          CSE020
     C                     ENDIF                                          CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     Z-ADDESNBDP    WWNBDP
     C                     Z-ADDWWTDVD    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDWWNUM     WWTDVD
      *                                                                   136935
      ***  Reset total Original and Actual Stock Allocation work fields.  136935
      *                                                                   136935
     C                     Z-ADD0         WUOALR 309                      136935
     C                     Z-ADD0         W2OALR 309                      136935
     C                     Z-ADD0         WUASTA 309                      136935
      *
      ***  Do while New Security not blank.
      *
     C                     Z-ADD1         I
     C           I         DOWLE20
     C           TSEC,I    ANDNE*BLANKS
      *
      ***  Setup New Security Shortname.
      *
     C                     MOVE TSEC,I    NWSESN
      *
      ***  Prepare Price Basis for New Security.
      *
     C                     MOVE TSPB,I    NSSPBS  1
      *
      ***  Prepare Number of Decimal Places of New Security.
      *
     C                     MOVE TSDP,I    NSNBDP  10
      *
      ***  Prepare Number of Decimal Places of New Currency.
      *
     C                     MOVE TCDP,I    NCNBDP  10
      *
      ***  Prepare Number Of New Shares:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TNSH,I    WWNSHA 157
     C                     ELSE
     C                     Z-ADDMDNSHA    WWNSHA
     C                     ENDIF
      *
      ***  Prepare Denomination Multiplier:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C*****                MOVE TDML,I    WUNUM                           179024
     C                     MOVE TDML,I    WDM16  160                      179024
     C                     ELSE
     C*****                Z-ADDMDDMLT    WUNUM                           179024
     C                     Z-ADDMDDMLT    WDM16                           179024
     C                     ENDIF
     C           5         SUB  NSNBDP    J       10                      179024
     C           WDM16     MULT POWER8,J  WWDMLT 309                      179024
     C*****                Z-ADDNSNBDP    WWNBDP                          179024
     C*****                EXSR RTVNDP                                    179024
     C*****                Z-ADDWWNUM     WWDMLT 309                      179024
      *
      ***  Prepare Rounding:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TNDN,I    WWRNDN  1
     C                     ELSE
     C                     MOVE MDRNDN    WWRNDN
     C                     ENDIF
      *
      ***  Prepare field Rounding Settlement in Cash:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TNDS,I    WWRNDS  1
     C                     ELSE
     C                     MOVE MDRNDS    WWRNDS
     C                     ENDIF
      *
      ***  Prepare Compensation Price:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Details File.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TOPA,I    WWCOMP 158
     C                     ELSE
      *                                                                   135685
      ***  If Processing Type = Currency Change                           135685
      ***  and Compensation Price is entered as Market,                   135685
      ***  the Compensation Price must first be calculated                135685
      ***  from Current Market Price.                                     135685
      *                                                                   135685
     C           MAPTYP    IFEQ 'CC'                                      135685
     C           NAMRKI    ANDEQ'Y'                                       135685
     C                     EXSR CCOMP                                     135685
     C                     ENDIF                                          135685
      *                                                                   135685
     C                     Z-ADDMDCOMP    WWCOMP
     C                     ENDIF
      *                                                                   145872
      ***  If Exchange Offer, calculate base Ex-Date Position = Ex-Date   145872
      ***  Position multiplied by Percentage to Exchange.                 145872
      *                                                                   145872
     C           MAPTYP    IFEQ 'OF'                                      145872
     C           MIOFTY    ANDEQ'E'                                       145872
     C                     Z-ADDWWTDVD    WUTDVD                          145872
     C           WWTDVD    MULT MIPREX    WWTDVD                          145872
     C           WWTDVD    DIV  100       WWTDVD                          145872
     C                     Z-ADDESNBDP    WWNBDP           New Sec.Dec.Pl.145872
     C                     MOVE WWRNDN    WUROOP           CO Det. Round. 145872
     C                     Z-ADDWWTDVD    WWNUM                           145872
     C                     EXSR ROUNDD                                    145872
     C                     Z-ADDWWNUM     WWTDVD                          145872
     C                     ENDIF                                          145872
      *
      ***  Some fields must not be calculated for New Security.
      *
     C                     Z-ADD0         WWCAOP           Original Cash Option
     C                     Z-ADD0         WWACAA           Actual Cash Allocation
     C                     Z-ADD0         WWTOTF           Total Fees
     C                     Z-ADD0         WWTOTT           Total Taxes
      *                                                                   136935
     C                     MOVE WWOPT1    WKOPTN                          136935
     C           MDOPTN    IFEQ WKOPTN                                    136935
     C           MANBOP    OREQ 1                                         136935
      *
      ***  Calculate Allocations: - Original Stock Allocation
      ***                         - True Stock Allocation
      ***                         - Original Stock Rounding
      ***                         - Original Cask Rounding.
      *
     C                     EXSR CALLOC
      *
      ***  Calculate other Customer Allocations.
      *
     C                     EXSR CALBC
     C                     ELSE                                           136935
     C                     Z-ADD0         WWOALR                          136935
     C                     Z-ADD0         WWOTSA                          136935
     C                     Z-ADD0         WWOSTR                          136935
     C                     Z-ADD0         WWOCAR                          136935
     C                     Z-ADD0         WWASTA                          136935
     C                     Z-ADD0         WWASTR                          136935
     C                     Z-ADD0         WWACAR                          136935
     C                     Z-ADD0         WWHOST                          136935
     C                     Z-ADD0         WWHOCA                          136935
     C                     ENDIF                                          136935
      *
      ***  Set Reply Status to 'N' (by default).
      *
     C                     MOVE 'N'       WWREST           'None'
      *
      ***  If Customer Current Reply exists set Reply Status to 'R'.
      *
     C           EXBCRE    IFEQ 'Y'
     C                     MOVE 'R'       WWREST           'Reply Received'
      *
      ***  Else, if Customer Current Reply does not exist.
      *
     C                     ELSE
      *
      ***  If Standard Corporate Actions Instruction exists, set Reply Status to 'S'.
      *
     C           EXBCSI    IFEQ 'Y'
     C                     MOVE 'S'       WWREST           'Std Inst Default'
     C                     ELSE
      *
      ***  Else, if Customer Standard Corporate Action Instruction does not exist (and Customer
      ***  Current Reply does not exist), set the Reply Status to 'C' (default no reply is used).
      *
     C                     MOVE 'C'       WWREST           'Corporate Default'
     C                     ENDIF
     C                     ENDIF
      *
      ***  Write a record on SECOALL0: Corporate Actions Allocations file.
      *
     C                     EXSR WRCOAL
      *                                                                   135686
      ***  Set indicator Customer or Book processed to 'Y'.               135686
      *                                                                   135686
     C                     MOVE 'Y'       BCPROC                          135686
      *
     C                     ADD  1         I
     C                     ENDDO
      *
      ***  Setup New Security to '**CASH**'.
      *
     C                     MOVE *BLANKS   NWSESN
     C                     MOVEL'**CASH**'NWSESN
      *
      ***  Some fields must not be calculated for Security = '**CASH**'.
      *
     C                     Z-ADD0         WWOALR           Original Stock Allocation
     C                     Z-ADD0         WWOTSA           True Stock Allocation
     C                     Z-ADD0         WWOSTR           Original Stock Rounding
     C                     Z-ADD0         WWASTA           Actual Stock Allocation
     C                     Z-ADD0         WWASTR           Actual Stock Rounding
      *                                                                   136935
     C                     MOVE WWOPT1    WKOPTN                          136935
     C           MDOPTN    IFEQ WKOPTN                                    136935
     C           MANBOP    OREQ 1                                         136935
      *
      ***  Calculate Original Cash Rounding for Security = '**CASH**'.
      *
     C                     EXSR COCR
      *
      ***  Calculate Actual Cash Rounding for Security = '**CASH**'.
      *
     C                     Z-ADDWTACAR    WWNUM            Total Actual Cash Rounding accumulated
     C                     EXSR CACR
      *
      ***  Calculate Holding Taken as Stock for Security = '**CASH**'.
      *
     C                     EXSR CHST
      *
      ***  Calculate Holding Taken as Cash for Security = '**CASH**'.
      *
     C                     EXSR CHCA
      *
      ***  Calculate Cash Option and Actual Cash Allocation for Book/Customer.
      *
     C                     EXSR CCABC
      *
      ***  If Processing Type not Currency Changes,                       CEU017
      ***  Calculate Total Fees for Customer.
      *
     C           MAPTYP    IFNE 'CC'                                      CEU017
     C                     EXSR CTFEES
     C                     ENDIF                                          CEU017
      *
      ***  If Processing Type = Dividend Events and feature Withholding Tax is ON,
      ***  Calculate Total Taxes for Customer, based on Actual Cash Allocation + Rounding
      ***  if Stock Dividend Type not 'R' or based on Original Cash Option if Stock Dividend
      ***  Type = 'R' as Reinvestment of Dividend (Total Taxes = Tax Deducted at Source + Tax
      ***  Deducted by User).
      *
     C******     MAPTYP    IFNE 'DV'                                      135692
     C           MAPTYP    IFEQ 'DV'                                      135692
     C           S01447    ANDEQ'Y'
     C           MDSDIT    IFEQ 'R'
     C                     Z-ADDWWCAOP    WWAMTT
     C                     ELSE
     C           WWACAA    ADD  WWACAR    WWAMTT 309
     C                     ENDIF
     C                     EXSR CTOTAX
     C                     Z-ADDTOTTAX    WWTOTT
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     MOVE 'R'       WUROOP           Rounding = alf adjust
     C                     Z-ADDWWTOTT    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWTOTT
     C                     ELSE
     C                     Z-ADD0         WWTOTT
     C                     ENDIF
     C                     ELSE                                           136935
     C                     Z-ADD0         WWOALR                          136935
     C                     Z-ADD0         WWOTSA                          136935
     C                     Z-ADD0         WWOSTR                          136935
     C                     Z-ADD0         WWOCAR                          136935
     C                     Z-ADD0         WWASTA                          136935
     C                     Z-ADD0         WWASTR                          136935
     C                     Z-ADD0         WWACAR                          136935
     C                     Z-ADD0         WWHOST                          136935
     C                     Z-ADD0         WWHOCA                          136935
     C                     ENDIF                                          136935
      *
      ***  Write a record on SECOALL0: Corporate Actions Allocations file.
      *
     C                     EXSR WRCOAL
      *
      ***  Set to zero the Total Actual Cash Rounding and the Total Original Cash Rounding work
      ***  fields.
      *
     C                     Z-ADD0         WTACAR           Total Actual Cash Rounding
     C                     Z-ADD0         WTOCAR           Total Original Cash Rounding
      *
     C                     ENDIF
      *                                                                   CSE020
      ** If CA is a child, replace Security with the Security obtained    CSE020
      ** from the Originating CA before reading SECDEPL4.                 CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WOSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Set greater on Client Depot Positions Details file with Branch, Security and Depot (num
      ***  field) received as parameter, Market Indicator, Customer and Portfolio Reference saved
      ***  and Ex-Date equal to *HIVAL and read next record.
      *
     C                     MOVE *HIVAL    KUDDT
     C           @KEY3     SETGTSECDEPL4
     C                     READ SECDEPL4                 81
      ******                                                              135686
     C******               ELSE                                           135686
     C***13*               READ SECDEPL4                 81               135686
     C**N13*     @KEY1     READESECDEPL4                 81               135686
     C******               ENDIF                                          135686
      *
     C                     ENDDO
      *
      ** If CA is a child, restore MASESN with Security of the child      CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WKSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *                                                                   CSE020
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * PDUMCU - CO Dummy Customer processing.                        *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           PDUMCU    BEGSR                           ** PDUMCU SR **
      *
      ***  Load fields (all amounts set to 0).
      *
     C                     MOVE 'D'       MCRECI           Record Id.
     C                     Z-ADDBJRDNB    MCLCD            Last Change Date = Run Date
     C                     MOVE 'I'       MCCHTP           Type of Last Change
     C                     MOVE USER      MCLUID           User Id.
     C                     MOVE PCORF     MCCORF           CO Reference = Parameter
      *
     C           MAPTYP    IFEQ 'NF'                       If Processing Type = Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
     C           MAPTYP    OREQ 'CC'                       Or Ccy Changes CEU017
     C                     MOVE '01'      MCOPTN              Option Number = 01
     C                     ELSE                            Else
     C                     MOVE MDOPTN    MCOPTN              Option Number = from SECOxxL0
     C                     ENDIF
      *
     C                     MOVE PBRCD     MCBRCD           Branch = Parameter
     C**********           Z-ADDWWDDPT    MCDDPT           Depot = Parameter (num field)      CSD027
     C                     MOVE WWDDPT    MCDDPT           Depot = Parameter (num field)      CSD027
     C                     MOVE 'C'       MCCOTP           Customer/Book Ind. = 'C'
     C                     MOVE *BLANKS   MCBOOK           Book = blank
     C                     MOVE BVERCU    MCCNUM           Customer = Dummy Customer from SDSTRDPD
     C                     Z-ADD0         MCEXPO           Ex-Date Position = 0
     C                     Z-ADD0         MCOALR           Orig.Stk Alloc.136935
     C                     Z-ADD0         MCOSTR           Orig.Stk Round.136935
     C                     Z-ADD0         MCOCAR           Orig.Cash Round136935
     C                     Z-ADD0         MCCAOP           Original Cash Option = 0
     C                     Z-ADD0         MCHOCA           Holding Taken as Cash = 0
     C                     Z-ADD0         MCACAA           Actual Cash Allocation = 0
     C                     Z-ADD0         MCOTSA           True Stock Allocation = 0
     C                     Z-ADD0         MCHOST           Holding Taken as Stock = 0
     C                     MOVE *BLANKS   MCOPT1           Option for Actual Allocation 1 = blank
     C                     MOVE *BLANKS   MCOPT2           Option for Actual Allocation 2 = blank
     C                     MOVE *BLANKS   MCBSEC           Block Security = blank
     C                     Z-ADD0         MCBEDT           Blocked End Date = 0
     C                     Z-ADD0         MCBSTT           Blocked Start Date = 0
     C                     MOVE *BLANKS   MCBLTY           Block Type = blank
     C                     MOVE *BLANKS   MCBEWI           Block Error/Warning Ind. = blank
     C                     MOVE MACOAT    MCCOAT           CO Type = from SECORFL1
     C                     MOVE *BLANKS   MCTRRF           Transaction Reference = blank
     C                     MOVE *BLANKS   MCTRR2           Transaction Reference 2 = blank
     C                     MOVE *BLANKS   MCTRR3           Transaction Reference 3 = blank
     C                     MOVE *BLANKS   MCRVRF           Reversal Reference = blank
     C                     MOVE *BLANKS   MCRVR2           Reversal Reference 2 = blank
     C                     MOVE *BLANKS   MCRVR3           Reversal Reference 3 = blank
     C                     Z-ADD0         MCTNL1           Position Settlement TNL1 = 0
     C                     MOVE *BLANKS   MCLTRQ           Letter Required = blank
     C                     Z-ADD0         MCTOTF           Total Fees = 0
     C                     Z-ADD0         MCTOTT           Total Taxes = 0
      *
      ***  If Dummy Customer is a Portfolio Customer, Portfolio Reference seted with '9997',
      ***  else it was seted with blank.
      *
     C                     MOVE WWERPT    MCPTFR           Portfolio Reference
      *                                                                   136935
     C                     Z-ADD0         BACRDC 309                      136935
      *
      ***  Do while New Security not blank.
      *
     C                     Z-ADD1         I
     C           I         DOWLE20
     C           TSEC,I    ANDNE*BLANKS
      *
      ***  Setup New Security Shortname.
      *
     C                     MOVE TSEC,I    MCSESN           Securiry Shortname
      *                                                                   135686
      ***  If processing type = Currency Change.                          135686
      *                                                                   135686
     C           MAPTYP    IFEQ 'CC'                                      135686
     C           MAPTYP    ORNE 'CC'                                      137886
     C           BVALDC    ANDEQ'Y'                                       137886
      *
      ***  Input Balancing Stock Allocation calculated for the New Security into Actual Stock
      ***  Allocation for the Dummy Customer.                             136935
      *****Allocation*and*Original*Stock*Allocation*for*the*Dummy******** 136935
      *****Customer.***************************************************** 136935
      *
     C                     Z-ADDTBSA,I    WWNUM
     C                     Z-ADDTSDP,I    WWNBDP           New Security Decimal Places
     C                     EXSR SETNDP
     C******               Z-SUBWUNUM     MCASTA           Act.Stk Alloc. 135686
     C******               Z-SUBWUNUM     MCOALR           Orig.Stk Alloc.135686
     C                     Z-ADDWUNUM     MCASTA           Act.Stk Alloc. 135686
     C******               Z-ADDWUNUM     MCOALR                   135686 136935
     C                     Z-ADD0         TBSA,I           Reset Actual Stock Allocation
      *
      ***  Input Balancing Stock Rounding calculated for the New Security into Actual Stock Rounding
      ***  for the Dummy Customer.                                        136935
      *****and*Original*Stock*Rounding*for*the*Dummy*Customer.*********** 136935
      *
     C******               Z-SUBTBSR,I    MCASTR           Act.Stk Round. 135686
     C******               Z-SUBTBSR,I    MCOSTR           Orig.Stk Round.135686
     C                     Z-ADDTBSR,I    MCASTR           Act.Stk Round. 135686
     C******               Z-ADDTBSR,I    MCOSTR                   135686 136935
     C                     Z-ADD0         TBSR,I           Reset Actual Stock Rounding
      *
      ***  Input Balancing Cash Rounding calculated for the New Security into Actual cash Rounding
      ***  for the Dummy Customer.                                        136935
      *****and*Original*Cash*Rounding*for*the*Dummy*Customer.************ 136935
      *
     C                     Z-ADDTBCR,I    WWNUM
     C                     Z-ADDTCDP,I    WWNBDP           New Currency Decimal Places
     C                     EXSR SETNDP
     C******               Z-SUBWUNUM     MCACAR           Act.Cash Round.135686
     C******               Z-SUBWUNUM     MCOCAR           Orig.Cash Round135686
     C                     Z-ADDWUNUM     MCACAR           Act.Cash Round.135686
     C******               Z-ADDWUNUM     MCOCAR                   135686 136935
     C                     ADD  TBCR,I    BACRDC                          136935
     C                     Z-ADD0         TBCR,I           Reset Actual Cash Rounding
      *                                                                   135686
      ***  Else, if processing type not Currency Change, set fields to 0. 135686
      *                                                                   135686
     C                     ELSE                                           135686
     C                     Z-ADD0         MCASTA           Act.Stk Alloc. 135686
     C                     Z-ADD0         MCOALR           Orig.Stk Alloc.135686
     C                     Z-ADD0         MCASTR           Act.Stk Round. 135686
     C                     Z-ADD0         MCOSTR           Orig.Stk Round.135686
     C                     Z-ADD0         MCACAR           Act.Cash Round.135686
     C                     Z-ADD0         MCOCAR           Orig.Cash Round135686
     C                     ENDIF                                          135686
      *
      ***  If Actual Stock Allocation and Actual Stock Rounding and Actual Cash Rounding = 0, set
      ***  Reply Status to blank, else set Reply Status to 'C' as 'Corporate Default'.
      *
     C           MCASTA    IFEQ 0
     C           MCASTR    ANDEQ0
     C           MCACAR    ANDEQ0
     C                     MOVE *BLANKS   MCREST           Reply Status = blank
     C                     ELSE
     C                     MOVE 'C'       MCREST           Reply Status = 'Corporate Default'
     C                     ENDIF
      *
      ***  Write record on file SECOALL0.
      *
     C                     WRITESECOALD0               89
      *
      ***  If error detected when write, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD009       DBASE            ***************
     C                     MOVEL'SECOALL0'DBFILE           * DB ERROR 09 *
     C                     MOVEL'WRITE'   DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ADD  1         RSEAL
      *
     C                     ADD  1         I
     C                     ENDDO
      *
      ***  Write a record on SECOALL0: Corporate Actions Allocations file with Security Shortname =
      ***  '**CASH**'.
      *
     C                     MOVE *BLANKS   MCSESN
     C                     MOVEL'**CASH**'MCSESN           Securiry Shortname
      *
      ***  Reset Actual and Original Stock Allocation, Actual and Original Stock Rounding and
      ***  Actual and Original Cash Rounding.
      *
     C                     Z-ADD0         MCASTA           Actual Stock Allocation = 0
     C                     Z-ADD0         MCOALR           Original Stock Allocation = 0
     C                     Z-ADD0         MCASTR           Actual Stock Rounding = 0
     C                     Z-ADD0         MCOSTR           Original Stock Rounding = 0
     C                     Z-ADD0         MCACAR           Actual Cash Rounding = 0
     C                     Z-ADD0         MCOCAR           Original Cash Rounding = 0
      *                                                                   135686
      ***  If processing type = Currency Change.                          135686
      *                                                                   135686
     C           MAPTYP    IFEQ 'CC'                                      135686
     C           MAPTYP    ORNE 'CC'                                      137886
     C           BVALDC    ANDEQ'Y'                                       137886
      *
      ***  Input Balancing Cash Allocation calculatad for the Depot into Actual Cash Allocation
      ***  and Actual Cash Rounding for the Dummy Customer.               136935
      *****and*Original*Cash*Option*for*the*Dummy*Customer.************** 136935
      *
     C******               Z-ADDBACADC    WWNUM                           136935
     C           BACADC    SUB  BACRDC    WWNUM                           136935
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     EXSR SETNDP
     C******               Z-SUBWUNUM     MCACAA           Act.Cash Alloc.135686
     C******               Z-SUBWUNUM     MCCAOP           Orig.Cash Opt. 135686
     C                     Z-ADDWUNUM     MCACAA           Act.Cash Alloc.135686
     C******               Z-ADDWUNUM     MCCAOP                   135686 136935
     C                     Z-ADD0         BACADC           Reset Actual Cash Allocation
     C                     Z-ADDBACRDC    WWNUM                           136935
     C                     EXSR SETNDP                                    136935
     C                     Z-ADDWUNUM     MCACAR           Act.Cash Round.136935
     C                     Z-ADD0         BACRDC                          136935
      *                                                                   135686
      ***  Else, if processing type not Currency Change, set fields to 0. 135686
      *                                                                   135686
     C                     ELSE                                           135686
     C                     Z-ADD0         MCACAA           Act.Cash Alloc.135686
     C                     Z-ADD0         MCCAOP           Orig.Cash Opt. 135686
     C                     ENDIF                                          135686
      *
      ***  If Actual Cash Allocation = 0, set Reply Status to blank, else set Reply Status to 'C'
      ***  as 'Corporate Default'.
      *
     C           MCACAA    IFEQ 0
     C                     MOVE *BLANKS   MCREST           Reply Status = blank
     C                     ELSE
     C                     MOVE 'C'       MCREST           Reply Status = 'Corporate Default'
     C                     ENDIF
      *
      ***  Write record on file SECOALL0.
      *
     C                     WRITESECOALD0               89
      *
      ***  If error detected when write, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD010       DBASE            ***************
     C                     MOVEL'SECOALL0'DBFILE           * DB ERROR 10 *
     C                     MOVEL'WRITE'   DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ADD  1         RSEAL
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * PDEPOT - Process the Depot.                                   *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           PDEPOT    BEGSR                           ** PDEPOT SR **
      *                                                                   136935
      ***  Reset work field.                                              136935
      *                                                                   136935
     C                     MOVE *BLANKS   WWSESN                          136935
      *                                                                   CSE020
      ** If CA is a child, save Security. Instead, use Security           CSE020
      ** obtained from the Originating CA before reading SEDPOHL0.        CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE MASESN    WKSESN                          CSE020
     C                     MOVE WOSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ***  Set greater on Depot Positions-Current & Historic with Branch, Depot (num field),
      ***  Security and Ex-Date (num field) received as parameter and read previous record.
      *
     C           @KEY4     SETGTSEDPOHL0
     C                     READPSEDPOHL0                 81
      *
      ***  If live record.
      *
     C           *IN81     IFEQ '0'                        Not begining of file
     C           DSBA      ANDEQPBRCD                      Same Branch
     C           DDPT      ANDEQWWDDPT                     Same Depot
     C           DSSC      ANDEQMASESN                     Same Security
      *                                                                   CSE020
      ** If CA is a child, restore MASESN with Security of the child      CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     MOVE WKSESN    MASESN                          CSE020
     C                     ENDIF                                          CSE020
      *
      ***  If Trade/Value Date Position from SECORFL1 = 'T', set Ex-Date Position = Nominal Trade
      ***  Date Basis.
      *
     C           MATDVD    IFEQ 'T'
     C                     Z-ADDDSNT      WWTDVD
      *
      ***  If Trade/Value Date Position from SECORFL1 = 'V', set Ex-Date Position = Nominal Value
      ***  Date Basis.
      *
     C                     ELSE
     C                     Z-ADDDSNV      WWTDVD
     C                     ENDIF
      *                                                                   CSE020
      ** If CA is a child, set Ex-date Position = sum of Actual Stock     CSE020
      ** Allocation of the Parent CA.                                     CSE020
      *                                                                   CSE020
     C           MAPREF    IFNE *BLANKS                                   CSE020
     C                     Z-ADD*ZERO     WKASTA 150                      CSE020
     C           @KEY23    SETLLSECOALL5                                  CSE020
     C           @KEY23    READESECOALL5                 70               CSE020
     C           *IN70     DOWEQ*OFF                                      CSE020
     C           M5SESN    IFEQ MASESN                                    CSE020
     C                     ADD  M5ASTA    WKASTA                          CSE020
     C                     ENDIF                                          CSE020
     C           @KEY23    READESECOALL5                 70               CSE020
     C                     ENDDO                                          CSE020
     C                     Z-ADDWKASTA    WWTDVD                          CSE020
     C                     ENDIF                                          CSE020
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C                     Z-ADDWWTDVD    WUNUM
     C                     EXSR RTVNDP
     C                     Z-ADDWWNUM     WWTDVD
      *
      ***  If Program called from SE7513: Corporate Actions Customer/Books by Depots Maintenance and
      ***  Processing Type is Corporate Reorganisation, retrieve the potential 20 New Securities,
      ***  Number of New Shares, Rounding, Rounding Settlement in Cash, Denomination Multiplier and
      ***  Compensation Price.
      *
     C           *IN13     IFEQ '1'
     C           MAPTYP    ANDEQ'CR'
     C                     MOVEAMHSECA    TSEC,1
     C                     MOVEAMHNSHA    TNSH,1
     C                     MOVEAMHRNDN    TNDN,1
     C                     MOVEAMHRNDS    TNDS,1
     C                     MOVEAMHDMLA    TDML,1
     C                     MOVEAMHCOPA    TOPA,1
      *
      ***  Retrieve Nominal Currency Decimal Places for the potential 20 New Securities.
      *
     C                     DO   20        I
     C           TSEC,I    IFNE *BLANKS
      *
      ***  Access Midas SE Securities to retrieve Nominal Currency decimal places with New Security.
      *
     C                     MOVE TSEC,I    @SEC
     C           @SEC      CHAINSECTY                80
      *
      ***  If record not found or not live, handle Database Error.
      *
     C           *IN80     IFEQ '1'                        Not found
     C           RECI      ORNE 'D'                        Not live
     C                     Z-ADD011       DBASE            ***************
     C                     MOVEL'SECTY'   DBFILE           * DB ERROR 11 *
     C                     MOVEL@SEC      DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Save Number of Decimal Places and Price Basis for Nominal Currency of New Security.
      *
     C                     Z-ADDNMDP      TSDP,I
     C                     MOVE SPBS      TSPB,I
      *
      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM NMCY      @AJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD012       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 12 *
     C                     MOVEL@AJCD     DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    TCDP,I           Number of Decimal Places
     C                     ENDIF
     C                     ENDDO
     C                     ENDIF
      *
      ***  Set lower on Corporate Actions Allocations file with CO Reference received as parameter,
      ***  Option Number from SECOxxL1, Branch and Depot (num field) received as parameter and read
      ***  next record with the same 4 fields (Reference, Option, Branch and Depot).
      *
     C           MAPTYP    IFEQ 'NF'                       If Processing Type = Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
     C           MAPTYP    OREQ 'CC'                       Or Ccy Changes CEU017
     C                     Z-ADD01        WWOPTN              Option Number = 01
     C                     ELSE                            Else
     C                     Z-ADDMDOPTN    WWOPTN              Option Number = from SECOxxL1
     C                     ENDIF
     C           @KEY5     SETLLSECOALL0
     C           @KEY5     READESECOALL0                 81
      *                                                                   135686
     C           *IN81     IFEQ '0'                                       135686
     C           MCRECI    ANDEQ'D'                                       135686
      *
      ***  Save New Security Shortname from SECOALL0.
      *
     C                     MOVE MCSESN    WWSESN 10
      *
      ***  Setup indice I to retrieve informations for New security.
      *
     C           MCSESN    IFNE '**CASH**'
     C                     Z-ADD1         I
     C           MCSESN    LOKUPTSEC,I                   90
     C                     ENDIF
      *
      ***  Setup New Security Shortname.
      *
     C                     MOVE TSEC,I    NWSESN
      *
      ***  Prepare Price Basis for New Security.
      *
     C                     MOVE TSPB,I    NSSPBS  1
      *
      ***  Prepare Number of Decimal Places of New Security.
      *
     C                     MOVE TSDP,I    NSNBDP  10
      *
      ***  Prepare Number of Decimal Places of New Currency.
      *
     C                     MOVE TCDP,I    NCNBDP  10
     C                     ENDIF                                          135686
      *                                                                   145872
      ***  If Exchange Offer, calculate base Ex-Date Position = Ex-Date   145872
      ***  Position multiplied by Percentage to Exchange.                 145872
      *                                                                   145872
     C           MAPTYP    IFEQ 'OF'                                      145872
     C           MIOFTY    ANDEQ'E'                                       145872
     C                     Z-ADDWWTDVD    WUTDVD                          145872
     C           WWTDVD    MULT MIPREX    WWTDVD                          145872
     C           WWTDVD    DIV  100       WWTDVD                          145872
     C                     Z-ADDESNBDP    WWNBDP           New Sec.Dec.Pl.145872
     C                     MOVE WWRNDN    WUROOP           CO Det. Round. 145872
     C                     Z-ADDWWTDVD    WWNUM                           145872
     C                     EXSR ROUNDD                                    145872
     C                     Z-ADDWWNUM     WWTDVD                          145872
     C                     ENDIF                                          145872
      *
      ***  Reset work fields.
      *
     C                     Z-ADD0         WTHOST 309       Total Holding Taken as Stock
     C                     Z-ADD0         WTHOCA 309       Total Holding Taken as Cash
     C                     Z-ADD0         WTASTA 309       Total Actual Stock Allocation
     C                     Z-ADD0         WTASTR 309       Total Actual Stock Rounding
     C                     Z-ADD0         WTACAR 309       1st total Actual Cash Rounding
     C                     Z-ADD0         WTAAAR 309       Total Actual Cash Allocation+Rounding
     C                     Z-ADD0         TWACAR 309       2nd total Actual Cash Rounding
     C                     Z-ADD0         WTOCAR 309       Total Original Cash Rounding
     C                     Z-ADD0         WTACAA 309                      136935
      *
      ***  Do while not end of file, and record read with same CO Reference received as parameter,
      ***  Same Option Number from SECOxxL1, same Branch and Depot (num field) received as
      ***  parameter.
      *
     C           *IN81     DOWEQ'0'
      *
     C           MCRECI    IFEQ 'D'
      *
      ***  If change of Security Shortname and Security work field not equal to '**CASH**'.
      *
     C           MCSESN    IFNE WWSESN
     C           WWSESN    ANDNE'**CASH**'
     C           WWSESN    ANDNE*BLANKS                                   135690
      *
     C                     Z-ADD1         I                               220007
     C           WWSESN    LOKUPTSEC,I                   90               220007
      *
      ***  Process New Security for the Depot.
      *
     C                     EXSR PSEDPT
     C                     ENDIF
      *
      ***  If Security is not '**CASH**'.
      *
     C           MCSESN    IFNE '**CASH**'
      *
      ***  If change of Security, Setup indice I to retrieve informations for New security.
      *
     C           MCSESN    IFNE WWSESN
     C                     Z-ADD1         I
     C           MCSESN    LOKUPTSEC,I                   90
     C                     ENDIF
      *
      ***  Setup New Security Shortname.
      *
     C                     MOVE TSEC,I    NWSESN
      *
      ***  Prepare Price Basis for New Security.
      *
     C                     MOVE TSPB,I    NSSPBS  1
      *
      ***  Prepare Number of Decimal Places of New Security.
      *
     C                     MOVE TSDP,I    NSNBDP  10
      *
      ***  Prepare Number of Decimal Places of New Currency.
      *
     C                     MOVE TCDP,I    NCNBDP  10
      *
      ***  Accumulate Total Holding taken as Stock.
      *
     C                     Z-ADDESNBDP    WWNBDP
     C                     Z-ADDMCHOST    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WTHOST
      *
      ***  Accumulate Total Actual Stock Allocation.
      *
     C                     Z-ADDNSNBDP    WWNBDP
     C                     Z-ADDMCASTA    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WTASTA
      *
      ***  Accumulate Total Actual Stock Rounding.
      *
     C                     ADD  MCASTR    WTASTR
      *
      ***  Accumulate Total Holding taken as Cash.
      *
     C                     Z-ADDNCNBDP    WWNBDP
     C                     Z-ADDMCHOCA    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WTHOCA
      *
      ***  Accumulate Total Actual Cash Rounding.
      *
     C                     Z-ADDMCACAR    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WTACAR
      *
     C                     ELSE
      *
      ***  Accumulate Actual Cash Allocation + Actual Cash Rounding.
      ***  and Actual Cash Allocation.                                    136935
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP
     C                     ENDIF
     C                     Z-ADDMCACAR    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WTAAAR
     C                     Z-ADDMCACAA    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WTAAAR
     C                     ADD  WWNUM     WTACAA                          136935
      *
     C                     ENDIF
      *
      ***  Save Security Shortname from SECOALL0.
      *
     C                     MOVE MCSESN    WWSESN
      *
     C                     ENDIF
      *
      ***  Read next record with the same CO Reference received as parameter, same Option Number
      ***  from SECOxxL1, same Branch and same Depot (num field) received as parameter.
      *
     C           @KEY5     READESECOALL0                 81
      *
     C                     ENDDO
      *
      ***  Process New Security for the Depot.
      *
     C           MCSESN    IFNE '**CASH**'                                150252
     C           MCSESN    ANDNE*BLANKS                                   152932
     C                     Z-ADD1         I                               220007
     C           MCSESN    LOKUPTSEC,I                   90               220007
     C                     EXSR PSEDPT
     C                     ENDIF                                          150252
      *
      ***  Setup New Security to '**CASH**'.
      *
     C                     MOVE *BLANKS   NWSESN
     C                     MOVEL'**CASH**'NWSESN
      *
      ***  Some fields must not be calculated for Security = '**CASH**'.
      *
     C                     Z-ADD0         WWOALR           Original Stock Allocation
     C                     Z-ADD0         WWOTSA           True Stock Allocation
     C                     Z-ADD0         WWOSTR           Original Stock Rounding
     C                     Z-ADD0         WWASTA           Actual Stock Allocation
     C                     Z-ADD0         WWASTR           Actual Stock Rounding
     C                     Z-ADD0         WWBSTA           Balancing Stock Allocation
     C                     Z-ADD0         WWBSTR           Balancing Stock Rounding
     C                     Z-ADD0         WWBCAR           Balancing Cash Rounding
      *                                                                   136935
     C******               MOVE WWOPT1    WKOPTN                   136935 156538
     C******     MDOPTN    IFEQ WKOPTN                             136935 156538
     C******     MANBOP    OREQ 1                                  136935 156538
      *
      ***  Calculate Original Cash Rounding for Security = '**CASH**'.
      *
     C                     EXSR COCR
      *
      ***  Calculate Actual Cash Rounding for Security = '**CASH**'.
      *
     C                     Z-ADDTWACAR    WWNUM            Total Actual Cash Rounding accumulated
     C                     EXSR CACR
      *
      ***  Calculate Holding Taken as Stock for Security = '**CASH**'.
      *
     C                     EXSR CHST
      *
      ***  Calculate Holding Taken as Cash for Security = '**CASH**'.
      *
     C                     EXSR CHCA
      *
      ***  Calculate Cash Option and Actual Cash Allocation for Depot.
      *
     C                     EXSR CCADPT
     C******               ENDIF                                   136935 156538
      *
      ***  Calculate Balancing Cash Allocation =
      ***  Actual Cash Allocation+Rounding - Total Actual Cash            135686
      ***  Allocation+Rounding.                                           135686
      *****Total*Actual*Cash*Allocation+Rounding*-*Actual*Cash*********** 135686
      *****Allocation+Rounding.****************************************** 135686
      *
     C           WWACAA    ADD  WWACAR    WWAAAR 309
     C******     WTAAAR    SUB  WWAAAR    WWBCAA                          135686
     C           WWAAAR    SUB  WTAAAR    WWBCAA                          135686
      *
      ***  Set Balancing Cash Allocation calculated.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWWBCAA    WWNUM
     C                     EXSR ROUNDD
      *                                                                   135686
      ***  If processing type = Currency Change, load work field for      135686
      ***  Dummy Customer and reset work field for Depot Allocation file  135686
      ***  (Balancing Differences are input on Dummy Customer).           135686
      *                                                                   135686
     C           MAPTYP    IFEQ 'CC'                                      135686
     C           MAPTYP    ORNE 'CC'                                      137886
     C           BVALDC    ANDEQ'Y'                                       137886
     C                     Z-ADD0         WWBCAA
     C                     Z-ADDWWNUM     BACADC 309
      *                                                                   135686
      ***  Else, if processing type not Currency Change, load work field  135686
      ***  for Depot Allocation file and reset work field for Dummy       135686
      ***  Customer.                                                      135686
      *                                                                   135686
     C                     ELSE                                           135686
     C                     Z-ADDWWNUM     WWBCAA                          135686
     C                     Z-ADD0         BACADC                          135686
     C                     ENDIF                                          135686
      *                                                                   136935
     C           MDOPTN    IFNE WKOPTN                                    136935
     C           MANBOP    ANDNE1                                         136935
     C           WWBCAA    ANDNE*ZEROS                                    136935
     C           WWBCAA    IFLT *ZEROS                                    136935
     C                     Z-SUBWWBCAA    WWACAA                          136935
     C                     ELSE                                           136935
     C                     Z-ADDWWBCAA    WWACAA                          136935
     C                     ENDIF                                          136935
     C                     Z-ADD*ZEROS    WWBCAA                          136935
     C                     Z-ADD0         BACADC                          136935
     C                     ENDIF                                          136935
      *
      ***  Write a record on SECODPL0: Corporate Actions Depotrs file.
      *
     C                     EXSR WRCODP
      *
      ***  Set to zero the Total Holding taken as Stock.
      *
     C                     Z-ADD0         WTHOST
      *
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * PRDTAG - Print details of Allocation generated.               *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           PRDTAG    BEGSR                           ** PRDTAG SR **
      *
      ***  Print details of Allocation generated by calling RPG/SE7534: Corporate Action Report.
      *
     C                     CALL 'SE7534'               87
     C                     PARM *BLANKS   WCSEQ   5        Sequence
     C                     PARM *BLANKS   WLVL    1        Level
     C                     PARM *BLANKS   WETTY   3        Entity
     C                     PARM *BLANKS   WSLAL   1        Select All
     C                     PARM           PCORF            CO Reference (Parameter)
     C                     PARM *BLANKS   POPTN            Option Number from SECOxxL0
     C                     PARM           PBRCD            Branch Code
     C                     PARM           PDDPT            Depot (Parameter)
      *
     C           *IN87     IFEQ '1'
     C           *INU7     OREQ '1'
     C           *INU8     OREQ '1'
     C                     Z-ADD015       DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 15 *
     C                     MOVELNARR,1    DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * PBLOCK - Blocking processing.                                 *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           PBLOCK    BEGSR                           ** PBLOCK SR **
      *
      ***  If Processing Type not Corporate Reorganisation or if Corporate Reorganisation and
      ***  not first passge, set Block fields (for Processing Type Corporate Reorganisation,
      ***  the Block fields should only be filled on first record written in CO Allocation file
      ***  (SECOALL0)).
      *
     C           MAPTYP    IFEQ 'CR'
     C           FIRSCR    ANDEQ'Y'
     C           MAPTYP    ORNE 'CR'
      *
      ***  If Customer Current Reply does not exist, set Blocked fields to fields from CO
      ***  References (SECORFL1).
      *
     C           CUSRPL    IFEQ 'N'
     C                     Z-ADDMABFRD    WWBSTT  50       Block Start Date = Block From Date
     C                     Z-ADDMABEND    WWBEDT  50       Block End Date = Block End Date
     C                     MOVE MABLOP    WWBEWI  1        Block Err./Warn.Ind.=Block Positions
     C                     ENDIF
     C           WWBEDT    IFNE 0                          If Blocked End Date not zero
     C                     MOVE 'P'       WWBLTY  1           Set Block Type to 'P'
     C                     ELSE                            Else, if Blocked End Date equal zero
     C                     MOVE *BLANK    WWBLTY              Set Block Type to blank
     C                     ENDIF
      *
      ***  Set other Blocked fields to fields from CO References (SECORFL1).
      *
     C                     MOVE MASESN    WWBSEC 10        Block Security
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * RAAOPT - Retrieve Actual Allocation for Options and           *
      *          Actual Allocation for options within the Option.     *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           RAAOPT    BEGSR                           ** RAAOPT SR **
      *
      ***  If Processing Type = Non Financial Events or Name Changes,
      ***  set-up special work field to 'N', it means the Actual Allocation fields must not be
      ***  calculated, else set-up this work field to 'Y'.
      *
     C           MAPTYP    IFEQ 'NF'                       Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Name Changes
     C                     MOVE 'N'       SPWRKF  1
     C                     ELSE
     C                     MOVE 'Y'       SPWRKF
     C                     ENDIF
      *
      ***  Reset work fields.
      *
     C                     Z-ADD0         WCAPR   52       Cash %
     C                     MOVE *BLANKS   WWOPT1  1        Option for Actual Allocation 1
     C                     MOVE *BLANKS   WWOPT2  1        Option for Actual Allocation 2
      *
      ***  If Customer/Book Current Reply exists.
      *
     C           EXBCRE    IFEQ 'Y'
      *
      ***  If Processing Type not Corporate Reorganisation or if Processing Type = Corporate
      ***  Reorganisation and this is the first passge, set Blocked fields to fields from
      ***  Customer Current Reply (SECOREL1) (for Processing Type = Corporate Reorganisation,
      ***  the Block fields should only be filled on first record written in CO Allocation file
      ***  (SECOALL0)).
      *
     C           MAPTYP    IFEQ 'CR'                       If Corporate Reorganistion
     C           FIRSCR    ANDEQ'Y'                           First passage
     C           MAPTYP    ORNE 'CR'                       Or not Corporate Reorganisation
     C           CUSRPL    IFEQ 'Y'
     C                     Z-ADDMQR1BF    WWBSTT           Block Start Date = Block from Date Level1
     C                     Z-ADDMQR1BE    WWBEDT           Block End Date = Block End Date Level 1
     C                     MOVE MQR1BA    WWBEWI           Block Err./Warn.Ind.=Block Pos.Level 1
     C           WWBEDT    IFNE 0                          If Blocked End Date not zero
     C                     MOVE 'P'       WWBLTY              Set Block Type to 'P'
     C                     ELSE                            Else, if Blocked End Date equal zero
     C                     MOVE *BLANKS   WWBLTY              Set Block Type to blank
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Processing Type = Non Financial Events, Name Changes or Currency Changes, or if
      ***  Processing Type = Dividend Events, Offers, Rights Issues, Exercices and Conversions,
      ***  Free Allocation, Capital Changes or Corporate Reorganisation for Single Option
      ***  (= with Number of Options retrieve from CO References file (SECORFL1) < or = 1), set
      ***  Option for Actual Allocation 1 to '1'.
      *
     C           MAPTYP    IFEQ 'NF'                       If Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Name Changes
     C           MAPTYP    OREQ 'CC'                       Or Currency Changes
     C           MANBOP    ORLE 1                          Or for Single Option
     C                     MOVE '1'       WWOPT1
      *
      ***  Else, if Processing Type = Dividend Events, Offers, Rights Issues, Exercices and
      ***  Conversions, Free Allocation, Capital Changes or Corporate Reorganisation for Multiple
      ***  Options (= with Number of Options retrieve from CO References file (SECORFL1) > 1).
      *
     C                     ELSE
      *
      ***  If Customer/Book Current Reply exists.
      *
     C           EXBCRE    IFEQ 'Y'
      *
      ***  Set Option for Actual Allocation 1 to Current Reply (Reply Option Level 1 from SECOREL0).
      *
     C                     MOVE MQR1RE    WWOPT1
      *
      ***  Else, if Customer/Book Current Reply does not exist.
      *
     C                     ELSE
      *
      ***  If Customer/Book Standard Corporate Actions Instruction exists.
      *
     C           EXBCSI    IFEQ 'Y'
      *
      ***  If Cash Preferred % is > or = 50, set Option for Actual Allocation 1 to Default
      ***  Cash Preferred from SECORFL1.
      *
     C           MOCAPP    IFGE 50
     C                     MOVE MADFCP    WWOPT1
      *
      ***  Else, if Cash Preferred % is < 50, set Option for Actual Allocation 1 to Default
      ***  Stock Preferred from SECORFL1.
      *
     C                     ELSE
     C                     MOVE MADFSP    WWOPT1
     C                     ENDIF
      *
      ***  Else, if Customer/Book Standard Corporate Actions Instruction does not exist (and
      ***  Customer/Book Current Reply does not exist).
      *
     C                     ELSE
      *
      ***  Set Option for Actual Allocation 1 to Default for No Reply from SECORFL1.
      *
     C                     MOVE MADFNR    WWOPT1
      *
      ***  If Default for No Reply from SECORFL1 is blank:
      ***  Actual Allocations must not be calculated and must be set to zeros. So set the Special
      ***  work field to 'N'.
      *
     C           MADFNR    IFEQ *BLANKS
     C                     MOVE 'N'       SPWRKF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Processing Type = Non Financial Events and Customer/Book Current Reply exists,
      ***  set Cash % to Reply Cash % Level 2 from SECOREL0.
      *
     C           MAPTYP    IFEQ 'NF'
     C           EXBCRE    ANDEQ'Y'
     C                     Z-ADDMQR2CA    WCAPR
     C                     ENDIF
      *
      ***  If Processing Type = Dividends Events, Rights Issues, Offers or Exercices and
      ***  Conversions.
      *
     C           MAPTYP    IFEQ 'DV'                       If Dividends Events
     C           MAPTYP    OREQ 'RG'                       Or Rights Issues
     C           MAPTYP    OREQ 'OF'                       Or Offers
     C           MAPTYP    OREQ 'EX'                       Or Exercices and Conversions
      *
      ***  CASE 1: If Customer/Book Current Reply exists.
      *
     C           EXBCRE    IFEQ 'Y'
      *
      ***  Set Option for Actual Allocation 2 to Reply Option Level 2 from SECOREL0.
      *
     C                     MOVE MQR2RE    WWOPT2
      *
      ***  If Processing Type = Dividends Events.
      *
     C           MAPTYP    IFEQ 'DV'
      *
      ***  If Option 1 selected: Cash Payment/Sell Rights, set Cash % to 100.
      *
     C           WWOPT2    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option selected is 2: Take Stock+Buy Additional Rights or 3: Take Stock+Sell Excess
      ***  Rights or 4: Take Stock, set Cash % to 0.
      *
     C           WWOPT2    IFEQ '2'
     C           WWOPT2    OREQ '3'
     C           WWOPT2    OREQ '4'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  If Option 5 selected: Take Part Cash/Rest Stock, set Cash % to Reply Cash % Level 2
      ***  from SECOREL0.
      *
     C           WWOPT2    IFEQ '5'
     C                     Z-ADDMQR2CA    WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      ******                                                              135690
      *****If*Processing*Type*=*Rights*Issues.*************************** 135690
      ******                                                              135690
     C******     MAPTYP    IFEQ 'RG'                                      135690
      ******                                                              135690
      *****If*Option*1*selected:*Sell*all*Rights,*set*Cash*%*to*100.***** 135690
      ******                                                              135690
     C******     WWOPT2    IFEQ '1'                                       135690
     C******               Z-ADD100       WCAPR                           135690
     C******               ELSE                                           135690
      ******                                                              135690
      *****If*Option*selected*is*5:*Take*Part*Cash/Rest*Stock*or*6:*Take* 135690
      *****Part*Cash/Keep*Stock,*set*Cash*%*to*Reply*Cash*%*Level*2*from* 135690
      *****SECOREL0.***************************************************** 135690
      ******                                                              135690
     C******     WWOPT2    IFEQ '5'                                       135690
     C******     WWOPT2    OREQ '6'                                       135690
     C******               Z-ADDMQR2CA    WCAPR                           135690
     C******               ELSE                                           135690
      ******                                                              135690
      *****If*Option*selected*is*2:*Take*Stock+Buy*Fraction*or*3:*Take*** 135690
      *****Stock+Sell*Fraction*or*4:*Take*Stock*or*7:*Do*nothing,*set**** 135690
      *****Cash*%*to*0.************************************************** 135690
      ******                                                              135690
     C******     WWOPT2    IFEQ '2'                                       135690
     C******     WWOPT2    OREQ '3'                                       135690
     C******     WWOPT2    OREQ '4'                                       135690
     C******     WWOPT2    OREQ '7'                                       135690
     C******               Z-ADD0         WCAPR                           135690
     C******               ENDIF                                          135690
     C******               ENDIF                                          135690
     C******               ENDIF                                          135690
     C******               ELSE                                           135690
      *
      ***  If Processing Type = Offers.
      *
     C           MAPTYP    IFEQ 'OF'
      *
      ***  If Option 1 selected: Accept Offer, set Cash % to 100.
      *
     C           WWOPT2    IFEQ '1'
     C           MIOFTY    IFEQ 'E'                                       136935
     C                     Z-ADD0         WCAPR                           136935
     C                     ELSE                                           136935
     C                     Z-ADD100       WCAPR
     C                     ENDIF                                          136935
     C                     ELSE
      *
      ***  If Option 2 selected: Refuse Offer, set Cash % to 0.
      *
     C           WWOPT2    IFEQ '2'
     C           MIOFTY    IFEQ 'E'                                       136935
     C                     Z-ADD100       WCAPR                           136935
     C                     ELSE                                           136935
     C                     Z-ADD0         WCAPR
     C                     ENDIF                                          136935
     C                     ELSE
      *
      ***  If Option 3 selected: Partial Accept Offer, set Cash % to Reply Cash % Level 2 from
      ***  SECOREL0.
      *
     C           WWOPT2    IFEQ '3'
     C                     Z-ADDMQR2CA    WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Processing Type = Exercices and Conversions.
      *
     C           MAPTYP    IFEQ 'EX'
      *
      ***  If Option 1 selected: Sell all Rights, set Cash % to 100.
      *
     C           WWOPT2    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      *****If*Option*selected*is*5:*Take*Part*Cash/Rest*Stock*or*6:*Take* 161732
      *****set*Cash*%*to*Reply*Cash*%*Level*2*from*SECOREL0.************* 161732
      ** If Option selected is 5: Take Part Cash/Rest Stock,              161732
      ** set Cash % to Reply Cash % Level 2 from SECOREL0.                161732
      *
     C           WWOPT2    IFEQ '5'
     C***********WWOPT2    OREQ '6'                                       161732
     C                     Z-ADDMQR2CA    WCAPR
     C                     ELSE
      *
      *****If*Option*selected*is*2:*Take*Stock+Buy*Fraction*or*3:*Take*St 161732
      *****Take*Stock*or*7:*Do*nothing,*set*Cash*%*to*0.***************** 161732
      ** If Option selected is 2: Take Stock+Buy Fraction or 3: Take      161732
      ** Stock+Sell Fraction or 4: Take Stock or 6: Take Part Stock+      161732
      ** Keep Rest or 7: Do nothing, set Cash % to 0.                     161732
      *
     C           WWOPT2    IFEQ '2'
     C           WWOPT2    OREQ '3'
     C           WWOPT2    OREQ '4'
     C           WWOPT2    OREQ '6'                                       161732
     C           WWOPT2    OREQ '7'
     C                     Z-ADD0         WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  CASE 2: Else, if Customer/Book Current Reply does not exist.
      *
     C                     ELSE
      *
      ***  Set Option for Actual Allocation 2 to Default for No Reply from SECOxxL1
      ***  (where xx = 'DV', 'RG', 'EX' or 'OF').
      *
     C                     MOVE MDDFNR    WWOPT2
      *
      ***  CASE 2.1: If Customer/Book Standard Corporate Actions Instruction exists (and Customer/
      ***            Book Current Reply does not exist).
      *
     C           EXBCSI    IFEQ 'Y'
      *
      ***  If Processing Type not Rights Issues.                          135690
      ***  Set Cash % to Cash Preferred % from Standard Instruction (SECOSIL1-2).
      *
     C           MAPTYP    IFNE 'RG'                                      135690
     C                     Z-ADDMOCAPP    WCAPR
     C                     ENDIF                                          135690
      *
      ***  If Processing Type = Dividends Events.
      *
     C           MAPTYP    IFEQ 'DV'
      *
      ***  If Stock Dividend Type = Stock for Stock or Combined for Cash and Stock, set Cash % to 0.
      *
     C           MDSDIT    IFEQ 'S'                        Stock for Stock
     C           MDSDIT    OREQ 'C'                        Combined for Cash and Stock
     C                     Z-ADD0         WCAPR
     C                     ENDIF
      *
      ***  If Cash % is < 50.
      *
     C           WCAPR     IFLT 50
      *
      ***  If Option 5 not allowed, set Cash % to 0.
      *
     C           MDOPT5    IFNE 'Y'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  If Option 5 allowed and Cash % not 0, default Option for Actual allocation 2 is '5'
      ***  (Cash % already = Cash Preferred % from Standard Instruction (SECOSIL1-2)).
      *
     C           WCAPR     IFNE 0
     C                     MOVE '5'       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      *****If*Cash*%*>*50.*********************************************** 135690
      ***  Else, if Cash % > or = 50.                                     135690
      *
     C******     WCAPR     IFGT 50                                        135690
      *
      ***  If Option 5 not allowed, set Cash % to 100.
      *
     C           MDOPT5    IFNE 'Y'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option 5 allowed and Cash % not 100, default Option for Actual allocation 2 is '5'
      ***  (Cash % already = Cash Preferred % from Standard Instruction (SECOSIL1-2)).
      *
     C           WCAPR     IFNE 100
     C                     MOVE '5'       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  If Cash % is 0 (means it is Stock Preferred).
      *
     C           WCAPR     IFEQ 0
      *
      ***  If Rounding Option from SECOSIL1-2 = 'U' and Option 2 is allowed, default Option for
      ***  Actual Allocation 2 is '2' (Cash % is already 0).
      *
     C           MOROOP    IFEQ 'U'
     C           MDOPT2    IFEQ 'Y'
     C                     MOVE '2'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Option 2 is not allowed and Option 4 is allowed, default
      ***  Option for Actual Allocation 2 is '4' (Cash % is already 0).
      *
     C           MDOPT4    IFEQ 'Y'
     C                     MOVE '4'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Options 2 and 4 are not allowed and Option 3 is allowed,
      ***  default Option for Actual Allocation 2 is '3' (Cash % is already 0).
      *
     C           MDOPT3    IFEQ 'Y'
     C                     MOVE '3'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Options 2, 4 and 3 are not allowed and Option 5 is allowed,
      ***  default Option for Actual Allocation 2 is '5' and Set Cash % to Cash Preferred % from
      ***  Standard Instruction (SECOSIL1-2).
      *
     C           MDOPT5    IFEQ 'Y'
     C                     MOVE '5'       WWOPT2
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Options 2, 4, 3 and 5 are not allowed and Option 1 is
      ***  allowed, default Option for Actual Allocation 2 is '1' and Set Cash % to 100.
      *
     C           MDOPT1    IFEQ 'Y'
     C                     MOVE '1'       WWOPT2
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Rounding Option is 'U' and Options 2, 4, 3, 5 and 1 are not allowed, default
      ***  Option for Actual Allocation 2 is blank.
      *
     C                     MOVE ' '       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Rounding Option from SECOSIL1-2 = 'D' and Option 3 is allowed, default Option for
      ***  Actual Allocation 2 is '3' (Cash % is already 0).
      *
     C           MOROOP    IFEQ 'D'
     C           MDOPT3    IFEQ 'Y'
     C                     MOVE '3'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Option 3 is not allowed and Option 4 is allowed, default
      ***  Option for Actual Allocation 2 is '4' (Cash % is already 0).
      *
     C           MDOPT4    IFEQ 'Y'
     C                     MOVE '4'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Options 3 and 4 are not allowed and Option 2 is allowed,
      ***  default Option for Actual Allocation 2 is '2' (Cash % is already 0).
      *
     C           MDOPT2    IFEQ 'Y'
     C                     MOVE '2'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Options 3, 4 and 2 are not allowed and Option 5 is allowed,
      ***  default Option for Actual Allocation 2 is '5' and Set Cash % to Cash Preferred % from
      ***  Standard Instruction (SECOSIL1-2).
      *
     C           MDOPT5    IFEQ 'Y'
     C                     MOVE '5'       WWOPT2
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Options 3, 4, 2 and 5 are not allowed and Option 1 is
      ***  allowed, default Option for Actual Allocation 2 is '1' and Set Cash % to 100.
      *
     C           MDOPT1    IFEQ 'Y'
     C                     MOVE '1'       WWOPT2
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Rounding Option is 'D' and Options 3, 4, 2, 5 and 1 are not allowed, default
      ***  Option for Actual Allocation 2 is blank.
      *
     C                     MOVE ' '       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Cash % is 100 (means it is Cash Preferred).
      *
     C           WCAPR     IFEQ 100
      *
      ***  If Option 1 allowed, default Option for Actual Allocation 2 is '1' (Cash % is already
      ***  100).
      *
     C           MDOPT1    IFEQ 'Y'
     C                     MOVE '1'       WWOPT2
     C                     ELSE
      *
      ***  If Option 1 not allowed and Option 5 allowed, default Option for Actual Allocation 2 is
      ***  '5' and set Cash % to Cash Preferred % from Standard Instruction (SECOSIL1-2).
      *
     C           MDOPT5    IFEQ 'Y'
     C                     MOVE '5'       WWOPT2
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Option 1 and 5 not allowed, set Cash % to 0.
      *
     C                     Z-ADD0         WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Processing Type = Offers (% Accepted = field Cash %).
      *
     C           MAPTYP    IFEQ 'OF'
      *
      ***  If % Accepted is < 50.
      *
     C           WCAPR     IFLT 50
      *
      ***  If Option 3 is not allowed, default as per % Accepted is 0.
      *
     C           MIOPT3    IFNE 'Y'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  If Option 3 is allowed and % Accepted is not 0, default Option for Actual Allocation 2 is
      ***  '3' (% Accepted already = Cash Preferred % from Standard Instruction (SECOSIL1-2)).
      *
     C           WCAPR     IFNE 0
     C                     MOVE '2'       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      *****If*%*Accepted*is*>*50.**************************************** 135690
      ***  Else, if % Accepted is > or = 50.                              135690
      *
     C******     WCAPR     IFGT 50                                        135690
      *
      ***  If Option 3 is not allowed (and % Accepted is > 50), default as per % Accepted is 100.
      *
     C           MIOPT3    IFNE 'Y'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option 3 is allowed and % Accepted is not 100, default Option for Actual Allocation 2
      ***  is '3' (% Accepted already = Cash Preferred % from Standard Instruction (SECOSIL1-2)).
      *
     C           WCAPR     IFNE 100
     C                     MOVE '3'       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  If % Accepted is 0 (means it is refused).
      *
     C           WCAPR     IFEQ 0
      *
      ***  If Option 2 allowed, default Option for Actual Allocation 2 is '2' (% Accepted is
      ***  already 0).
      *
     C           MIOPT2    IFEQ 'Y'
     C           MIOFTY    IFEQ 'E'                                       136935
     C                     Z-ADD100       WCAPR                           136935
     C                     ELSE                                           136935
     C                     Z-ADD0         WCAPR                           136935
     C                     ENDIF                                          136935
     C                     MOVE '2'       WWOPT2
     C                     ELSE
      *
      ***  If Option 2 is not allowed and Option 3 is allowed, default Option for Actual Allocation
      ***  2 is '3' and set % Accepted to Cash Preferred % from Standard Instruction (SECOSIL1-2).
      *
     C           MIOPT3    IFEQ 'Y'
     C                     MOVE '3'       WWOPT2
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Option 2 and 3 are not allowed and Option 1 is allowed, default Option for Actual
      ***  Allocation 2 is '1' and set % Accepted to 100.
      *
     C           MIOPT1    IFEQ 'Y'
     C                     MOVE '1'       WWOPT2
     C           MIOFTY    IFEQ 'E'                                       136935
     C                     Z-ADD0         WCAPR                           136935
     C                     ELSE                                           136935
     C                     Z-ADD100       WCAPR
     C                     ENDIF                                          136935
     C                     ELSE
      *
      ***  If Option 2, 3 and 1 are not allowed, default Option for Actual Allocation 2 is blank.
      *
     C                     MOVE ' '       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If % Accepted is 100 (means it is Cash Preferred).
      *
     C           WCAPR     IFEQ 100
      *
      ***  If Option 1 is allowed, default Option for Actual Allocation 2 is '1' (% Accepted is
      ***  already 100).
      *
     C           MIOPT1    IFEQ 'Y'
     C                     MOVE '1'       WWOPT2
     C           MIOFTY    IFEQ 'E'                                       136935
     C                     Z-ADD0         WCAPR                           136935
     C                     ELSE                                           136935
     C                     Z-ADD100       WCAPR                           136935
     C                     ENDIF                                          136935
     C                     ELSE
      *
      ***  If Option 1 is not allowed and Option 3 is allowed, default Option for Actual Allocation
      ***  2 is '3' and set % Accepted to Cash Preferred % from Standard Instruction (SECOSIL1-2).
      *
     C           MIOPT3    IFEQ 'Y'
     C                     MOVE '3'       WWOPT2
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Option 1 and 3 are not allowed and Option 2 is allowed, default Option for Actual
      ***  Allocation 2 is '2' and set % Accepted to 0.
      *
     C           MIOPT2    IFEQ 'Y'
     C                     MOVE '2'       WWOPT2
     C           MIOFTY    IFEQ 'E'                                       136935
     C                     Z-ADD100       WCAPR                           136935
     C                     ELSE                                           136935
     C                     Z-ADD0         WCAPR
     C                     ENDIF                                          136935
     C                     ELSE
      *
      ***  If Option 1, 3 and 2 are not allowed, default Option for Actual Allocation is blank.
      *
     C                     MOVE ' '       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      *****If*Processing*Type*=*Rights*Issues*or*Exercices*and*********** 135690
      *****Conversions.************************************************** 135690
      ***  If Processing Type = Exercices and Conversions.                135690
      *
     C******     MAPTYP    IFEQ 'RG'                                      135690
     C******     MAPTYP    OREQ 'EX'                                      135690
     C           MAPTYP    IFEQ 'EX'                                      135690
      *
      ***  Set Customer Options 1, 2, 3, 4, 5, 6 and 7, depending on Processing Type.
      *
     C******     MAPTYP    IFEQ 'RG'                                      135690
     C******               MOVE MFOPT1    WUOPT1  1                       135690
     C******               MOVE MFOPT2    WUOPT2  1                       135690
     C******               MOVE MFOPT3    WUOPT3  1                       135690
     C******               MOVE MFOPT4    WUOPT4  1                       135690
     C******               MOVE MFOPT5    WUOPT5  1                       135690
     C******               MOVE MFOPT6    WUOPT6  1                       135690
     C******               MOVE MFOPT7    WUOPT7  1                       135690
     C******               ELSE                                           135690
     C******               MOVE MJOPT1    WUOPT1                          135690
     C******               MOVE MJOPT2    WUOPT2                          135690
     C******               MOVE MJOPT3    WUOPT3                          135690
     C******               MOVE MJOPT4    WUOPT4                          135690
     C******               MOVE MJOPT5    WUOPT5                          135690
     C******               MOVE MJOPT6    WUOPT6                          135690
     C******               MOVE MJOPT7    WUOPT7                          135690
     C                     MOVE MJOPT1    WUOPT1  1                       135690
     C                     MOVE MJOPT2    WUOPT2  1                       135690
     C                     MOVE MJOPT3    WUOPT3  1                       135690
     C                     MOVE MJOPT4    WUOPT4  1                       135690
     C                     MOVE MJOPT5    WUOPT5  1                       135690
     C                     MOVE MJOPT6    WUOPT6  1                       135690
     C                     MOVE MJOPT7    WUOPT7  1                       135690
     C******               ENDIF                                          135690
      *
      ***  If Cash % is < 50.
      *
     C           WCAPR     IFLT 50
      *
      *****If*Options*5*and*6*are*not*allowed,*default*as*per*Cash*%*is*0.161732
      ** If Options 5 is not allowed, default as per Cash % is 0.         161732
      *
     C           WUOPT5    IFNE 'Y'
     C***********WUOPT6    ANDNE'Y'                                       161732
     C                     Z-ADD0         WCAPR
     C                     ENDIF
      *
      *****If*Options*5*and*6*are*allowed*and*Cash*%*is*not*0.*********** 161732
      ** If either Option 5 or 6 is allowed, and Cash % is not 0          161732
      *
     C           WUOPT5    IFEQ 'Y'
     C           WCAPR     ANDNE0                                         161732
     C***********WUOPT6    ANDEQ'Y'                                       161732
     C           WUOPT6    OREQ 'Y'                                       161732
     C           WCAPR     ANDNE0
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1-2) is 'C', default
      ***  Option for Actual Allocation 2 is '5' (Cash % already = Cash Preferred % from Standard
      ***  Instruction (SECOSIL1-2)).
      *
     C           MOCKIN    IFEQ 'C'
     C                     MOVE '5'       WWOPT2
     C                     ENDIF
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1-2) is 'K', default
      ***  Option for Actual Allocation 2 is '6' (Cash % already = Cash Preferred % from Standard
      ***  Instruction (SECOSIL1-2)).
      *
     C           MOCKIN    IFEQ 'K'
     C                     MOVE '6'       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      *****If*Cash*%*is*>*50.******************************************** 135690
      ***  Else, if Cash % is > or = 50.                                  135690
      *
     C******     WCAPR     IFGT 50                                        135690
      *
      *****If*Options*5*and*6*are*not*allowed,*default*as*per*Cash*%*is*  161732
      ** If Options 5 is not allowed, default as per Cash % is 100.       161732
      *
     C           WUOPT5    IFNE 'Y'
     C***********WUOPT6    ANDNE'Y'                                       161732
     C                     Z-ADD100       WCAPR
     C                     ENDIF
      *
      ***  If Option 5 and 6 are allowed and Cash % is not 0.
      *
     C           WUOPT5    IFEQ 'Y'
     C           WCAPR     ANDNE100                                       161732
     C***********WUOPT6    ANDEQ'Y'                                       161732
     C           WUOPT6    OREQ 'Y'                                       161732
     C           WCAPR     ANDNE100
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1-2) is 'C', default
      ***  Option for Actual Allocation 2 is '5' (Cash % already = Cash Preferred % from Standard
      ***  Instruction (SECOSIL1-2)).
      *
     C           MOCKIN    IFEQ 'C'
     C                     MOVE '5'       WWOPT2
     C                     ENDIF
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1-2) is 'K', default
      ***  Option for Actual Allocation 2 is '6' (Cash % already = Cash Preferred % from Standard
      ***  Instruction (SECOSIL1-2)).
      *
     C           MOCKIN    IFEQ 'K'
     C                     MOVE '6'       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  If Cash % is 0 (means it is Stock Preferred).
      *
     C           WCAPR     IFEQ 0
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1-2) is 'K'
      *
     C           MOCKIN    IFEQ 'K'
      *
      ***  If Option 7 is allowed, default Option for Actual Allocation is '7' (Cash % already
      ***  = 0).
      *
     C           WUOPT7    IFEQ 'Y'
     C                     MOVE '7'       WWOPT2
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Convertible/Keep Indicator from Standard Instruction (SECOSIL1-2) is 'C'
      *
     C           MOCKIN    IFEQ 'C'
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'U'.
      *
     C           MOROOP    IFEQ 'U'
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'U' and Option 2 is allowed,
      ***  default Option for Actual Allocation 2 is '2' (Cash % already = 0).
      *
     C           WUOPT2    IFEQ 'Y'
     C                     MOVE '2'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'U' and Option 2 is not
      ***  allowed and Option 4 is allowed, default Option for Actual Allocation 2 is '4'
      ***  (Cash % already = 0).
      *
     C           WUOPT4    IFEQ 'Y'
     C                     MOVE '4'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'U' and Options 2 and 4 are
      ***  not allowed and Option 3 is allowed, default Option for Actual Allocation 2 is '3'
      ***  (Cash % already = 0).
      *
     C           WUOPT3    IFEQ 'Y'
     C                     MOVE '3'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'U' and Options 2, 4 and 3
      ***  are not allowed and Option 5 is allowed, default Option for Actual Allocation 2 is '5'
      ***  and set Cash % to Cash Preferred % from Standard Instruction (SECOSIL1-2).
      *
     C           WUOPT5    IFEQ 'Y'
     C                     MOVE '5'       WWOPT2
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'U' and Options 2, 4, 3 and
      ***  5 are not allowed and Option 1 is allowed, default Option for Actual Allocation 2 is '1'
      ***  and set Cash % to 100.
      *
     C           WUOPT1    IFEQ 'Y'
     C                     MOVE '1'       WWOPT2
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'U' and Options 2, 4, 3, 5
      ***  and 1 are not allowed, default Option for Actual Allocation 2 is blank.
      *
     C                     MOVE ' '       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'D'.
      *
     C           MOROOP    IFEQ 'D'
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'D' and Option 3 is allowed,
      ***  default Option for Actual Allocation 2 is '3' (Cash % already = 0).
      *
     C           WUOPT3    IFEQ 'Y'
     C                     MOVE '3'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'D' and Option 3 is not
      ***  allowed and Option 4 is allowed, default Option for Actual Allocation is '4' (Cash %
      ***  already = 0).
      *
     C           WUOPT4    IFEQ 'Y'
     C                     MOVE '4'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'D' and Options 3 and 4 are
      ***  not allowed and Option 2 is allowed, default Option for Actual Allocation is '2' (Cash %
      ***  already = 0).
      *
     C           WUOPT2    IFEQ 'Y'
     C                     MOVE '2'       WWOPT2
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'D' and Options 3, 4 and 2
      ***  are not allowed and Option 5 is allowed, default Option for Actual Allocation 2 is '5'
      ***  and set Cash % to Cash Preferred % from Standard Instruction (SECOSIL1-2).
      *
     C           WUOPT5    IFEQ 'Y'
     C                     MOVE '5'       WWOPT2
     C                     Z-ADDMOCAPP    WCAPR
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'D' and Options 3, 4, 2 and
      ***  5 are not allowed and Option 1 is allowed, default Option for Actual Allocation is '1'
      ***  and set Cash % to 100.
      *
     C           WUOPT1    IFEQ 'Y'
     C                     MOVE '1'       WWOPT2
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Rounding Option from Standard Instruction (SECOSIL1-2) is 'D' and Options 3, 4, 2, 5
      ***  and 1 are not allowed, default Option for Actual Allocation is blank.
      *
     C                     MOVE ' '       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Cash % is 100 (means it is Cash Preferred).
      *
     C           WCAPR     IFEQ 100
      *
      ***  If Option 1 is allowed, default Option for Actual Allocation 2 is '1' (Cash % already
      ***  = 100).
      *
     C           WUOPT1    IFEQ 'Y'
     C                     MOVE '1'       WWOPT2
     C                     ELSE
      *
      ***  If Option 1 is not allowed, default as per Cash % is 0.
      *
     C                     Z-ADD0         WCAPR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  CASE 2.2: IF Customer/Book Standard Corporate Action Instruction does not exist
      ***               (and Customer/Book Current Reply does not exist),
      ***            OR if Customer/Book Standard Corporate Action Instruction exist BUT default
      ***               Option (Option for Actual Allocation 2 calculated in CASE 2.1 or retrieve
      ***               from Standard Instruction (SECOSIL1-2) in CASE 2) is blank (and Customer/
      ***               Book Current Reply does not exist).
      *
     C           EXBCSI    IFEQ 'N'
     C           EXBCSI    OREQ 'Y'
     C           WWOPT2    ANDEQ' '
      *
      ***  Set Option for Actual Allocation 2 to Default for No Reply from Corporate Actions
      ***  Detail (SECOxxL1, where xx = 'DV', 'RG', 'OF' or 'EX')
      *
     C                     MOVE MDDFNR    WWOPT2
      *
      ***  If Processing Type = Dividends Events.
      *
     C           MAPTYP    IFEQ 'DV'
      *
      ***  If Option 1 selected: Cash Payment/Sell Rights, set Cash % to 100.
      *
     C           WWOPT2    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      ***  If Option selected is 2: Take Stock+Buy Additional Rights or 3: Take Stock+Sell Excess
      ***  Rights or 4: Take Stock, set Cash % to 0.
      *
     C           WWOPT2    IFEQ '2'
     C           WWOPT2    OREQ '3'
     C           WWOPT2    OREQ '4'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  Else, Default No Reply will not be an Option which requires the entry of the %).
      *
     C                     MOVE ' '       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      ******                                                              135690
      *****If*Processing*Type*=*Rights*Issues.*************************** 135690
      ******                                                              135690
     C******     MAPTYP    IFEQ 'RG'                                      135690
      ******                                                              135690
      *****If*Option*1*selected:*Sell*all*Rights,*set*Cash*%*to*100.***** 135690
      ******                                                              135690
     C******     WWOPT2    IFEQ '1'                                       135690
     C******               Z-ADD100       WCAPR                           135690
     C******               ELSE                                           135690
      ******                                                              135690
      *****If*Option*selected*is*2:*Take*Stock+Buy*Fraction*or*3:*Take*** 135690
      *****Stock+Sell*Fraction*or*4:*Take*Stock*or*7:*Do*nothing,*set**** 135690
      *****Cash*%*to*0.************************************************** 135690
      ******                                                              135690
     C******     WWOPT2    IFEQ '2'                                       135690
     C******     WWOPT2    OREQ '3'                                       135690
     C******     WWOPT2    OREQ '4'                                       135690
     C******     WWOPT2    OREQ '7'                                       135690
     C******               Z-ADD0         WCAPR                           135690
     C******               ELSE                                           135690
      ******                                                              135690
      *****Else,*Default*No*Reply*will*not*be*an*Option*which*requires*** 135690
      *****the*entry*of*the*%).****************************************** 135690
      ******                                                              135690
     C******               MOVE ' '       WWOPT2                          135690
     C******               ENDIF                                          135690
     C******               ENDIF                                          135690
     C******               ELSE                                           135690
      *
      ***  If Processing Type = Offers.
      *
     C           MAPTYP    IFEQ 'OF'
      *
      ***  If Option 1 selected: Accept Offer, set Cash % to 100.
      *
     C           WWOPT2    IFEQ '1'
     C           MIOFTY    IFEQ 'E'                                       136935
     C                     Z-ADD0         WCAPR                           136935
     C                     ELSE                                           136935
     C                     Z-ADD100       WCAPR
     C                     ENDIF                                          136935
     C                     ELSE
      *
      ***  If Option 2 selected: Refuse Offer, set Cash % to 0.
      *
     C           WWOPT2    IFEQ '2'
     C           MIOFTY    IFEQ 'E'                                       136935
     C                     Z-ADD100       WCAPR                           136935
     C                     ELSE                                           136935
     C                     Z-ADD0         WCAPR
     C                     ENDIF                                          136935
     C                     ELSE
      *
      ***  Else, Default No Reply will not be an Option which requires the entry of the %).
      *
     C                     MOVE ' '       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Processing Type = Exercices and Conversions.
      *
     C           MAPTYP    IFEQ 'EX'
      *
      ***  If Option 1 selected: Sell all Rights, set Cash % to 100.
      *
     C           WWOPT2    IFEQ '1'
     C                     Z-ADD100       WCAPR
     C                     ELSE
      *
      *****If*Option*selected*is*2:*Take*Stock+Buy*Fraction*or*3:*Take St 161732
      *****Take*Stock*or*7:*Do*nothing,*set*Cash*%*to*0.***************** 161732
      ** If Option selected is 2: Take Stock+Buy Fraction or 3: Take      161732
      ** Stock+Sell Fraction or 4: Take Stock or 6: Take Part Stock+      161732
      ** Keep Rest or 7: Do nothing, set Cash % to 0.                     161732
      *
     C           WWOPT2    IFEQ '2'
     C           WWOPT2    OREQ '3'
     C           WWOPT2    OREQ '4'
     C           WWOPT2    OREQ '6'                                       161732
     C           WWOPT2    OREQ '7'
     C                     Z-ADD0         WCAPR
     C                     ELSE
      *
      ***  Else, Default No Reply will not be an Option which requires the entry of the %).
      *
     C                     MOVE ' '       WWOPT2
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C******               ENDIF                                          135690
     C                     ENDIF
      *
      ***  If Option not selected, set Cash % to 0 and 'Special Work Field' to 'N', it means that
      ***  the Actual Allocation fields must not be calculated.
      *
     C           WWOPT2    IFEQ ' '
     C                     Z-ADD0         WCAPR
     C                     MOVE 'N'       SPWRKF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * RTVRPL - Retrieve Customer/Book Current Reply and Customer/   *
      *          Book Standard Corporate Action Instruction.          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           RTVRPL    BEGSR                           ** RTVRPL SR **
      *
      ***  Set 'Customer/Book Current Reply Exists' work field to 'N'.
      *
     C                     MOVE 'N'       EXBCRE  1        Current Reply exist
      *
      ***  Retrieve current Reply with CO Reference, Branch, Customer/Book Indicator, Book and
      ***  Customer.
      *
     C           @KEY6     SETGTSECOREL0
     C           @KEY6     REDPESECOREL0                 82
      *
      ***  If record found and live.
      *
     C           *IN82     IFEQ '0'                        Found
     C           MQRECI    ANDEQ'D'                        Live
      *
      ***  If SR called from Customer Calculation, set 'Customer Reply Exists' work field to 'Y'.
      *
     C           FROMBC    IFEQ 'C'
     C                     MOVE 'Y'       CUSRPL
     C                     ENDIF
      *
      ***  Set 'Customer/Book Current Reply Exists' work field to 'Y'.
      *
     C                     MOVE 'Y'       EXBCRE
     C                     ENDIF
      *
      ***  Set 'Customer/Book Standard CO Instruction Exists' work field to 'N'.
      *
     C                     MOVE 'N'       EXBCSI  1        Standard Instruction exist
      *
      ***  If SR called from Book Calculation.
      *
     C           FROMBC    IFEQ 'B'
      *
      ***  Retrieve the Standard Instructions for Books by accessing LF/SECOSIL2 with Branch
      ***  (parameter), Book from SEUDEPL0, Corporate Action Type and Security Shortname received
      ***  as parameter.
      *
     C                     MOVE WWUDBK    KUDBK
     C                     MOVE MACOAT    KCOAT
     C                     MOVE MASESN    KSESN
     C           @KEY7     SETGTSECOSIL2
     C           @KEY7     REDPESECOSIL2                 83
      *
      ***  If no record found, access with Branch (parameter), Book from SEUDEPL0, Corporate
      ***  Action Type received as parameter and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   KSESN
     C           @KEY7     SETGTSECOSIL2
     C           @KEY7     REDPESECOSIL2                 83
      *
      ***  If no record found, access with Branch (parameter), Book from SEUDEPL0 and Corporate
      ***  Action Type and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   KCOAT
     C           @KEY7     SETGTSECOSIL2
     C           @KEY7     REDPESECOSIL2                 83
      *
      ***  If no record found, access with Branch (parameter) and Book, Corporate Action Type and
      ***  Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   KUDBK
     C           @KEY7     SETGTSECOSIL2
     C           @KEY7     REDPESECOSIL2                 83
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If SR called from Customer Calculation.
      *
     C                     ELSE
      *
      ***  Retrieve the Standard Instructions for Customer by accessing LF/SECOSIL1 with Branch
      ***  (parameter), Customer and Portfolio Reference from SECDEPL4, Corporate Action Type and
      ***  Security Shortname received as parameter.
      *
     C**********           Z-ADDWWCDCN    KCDCN                                               CSD027
     C                     MOVE WWCDCN    KCDCN                                               CSD027
     C                     MOVE WWPTFR    KPTFR
     C                     MOVE MACOAT    KCOAT
     C                     MOVE MASESN    KSESN
     C           @KEY9     SETGTSECOSIL1
     C           @KEY9     REDPESECOSIL1                 83
      *
      ***  If no record found, access with Brancg (parameter), Customer and Portfolio Reference from
      ***  SECDEPL4, Corporate Action Type received as parameter and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   KSESN
     C           @KEY9     SETGTSECOSIL1
     C           @KEY9     REDPESECOSIL1                 83
      *
      ***  If no record found, access with Branch (parameter), Customer and Portfolio Reference from
      ***  SECDEPL4 and Corporate Action Type and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   KCOAT
     C           @KEY9     SETGTSECOSIL1
     C           @KEY9     REDPESECOSIL1                 83
      *
      ***  If no record found, access with Branch (parameter), Customer from SECDEPL4 and Portfolio
      ***  Reference, Corporate Action Type and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C                     MOVE *BLANKS   KPTFR
     C           @KEY9     SETGTSECOSIL1
     C           @KEY9     REDPESECOSIL1                 83
      *
      ***  If no record found, access with Branch (parameter), Customer = 0 and Porfolio Reference,
      ***  Corporate Action Type and Security = blank.
      *
     C           *IN83     IFEQ '1'
     C           MORECI    ORNE 'D'
     C**********           Z-ADD*ZEROS    KCDCN                                               CSD027
     C                     MOVE *BLANKS   KCDCN                                               CSD027
     C           @KEY9     SETGTSECOSIL1
     C           @KEY9     REDPESECOSIL1                 83
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Standard Corporate Actions Instruction exists (record found with one of the access).
      *
     C           *IN83     IFEQ '0'
     C           MORECI    ANDEQ'D'
      *
      ***  Set 'Customer/Booh Standard Instruction Exists' work field to 'Y'.
      *
     C                     MOVE 'Y'       EXBCSI
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CALLOC - Calculate Allocations:                               *
      *            - Original Stock Allocation                        *
      *            - True Stock Allocation                            *
      *            - Original Stock Rounding                          *
      *            - Original Cask Rounding.                          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CALLOC    BEGSR                           ** CALLOC SR **
      *
      ***  Reset work fields.
      *
     C                     Z-ADD0         WWOALR 309       Original Stock Allocation
     C                     Z-ADD0         WWOTSA 309       True Stock Allocation
     C                     Z-ADD0         WWOSTR 309       Original Stock Rounding
     C                     Z-ADD0         WWOCAR 309       Original Cash Rounding
      *
      *****If*Processing*Type*=*Capital*Change,*Offers*with*Offer*Type*=* 136935
      *****Purchase*Offer*or*Non*Financial*Events,*********************** 136935
      ***  If Processing Type = Capital Change or Non Financial Events,   136935
      ***  some fields must not be calculated.
      *
     C           MAPTYP    IFEQ 'CE'                       Capital Change
     C******     MAPTYP    OREQ 'OF'                       Purchase Offer 136935
     C******     MIOFTY    ANDEQ'P'                                       136935
     C           MAPTYP    OREQ 'NF'                       Non Financial Events
     C                     Z-ADD0         WWOALR           Original Stock Allocation
     C                     Z-ADD0         WWOTSA           True Stock Allocation
     C                     Z-ADD0         WWOSTR           Original Stock Rounding
     C                     Z-ADD0         WWOCAR           Original Cash Rounding
     C                     ENDIF
      *
      ***  If Processing Type = 'NC': Name Changes, set Original Stock Rounding and Original
      ***  Cash Rounding to 0.
      *
     C           MAPTYP    IFEQ 'NC'
     C                     Z-ADD0         WWOSTR           Original Stock Rounding
     C                     Z-ADD0         WWOCAR           Original Cash Rounding
      *
      ***  If Security Shortname changed, set Original Stock Allocation and True Stock Allocation
      ***  to Current Holding (= Ex-Date Position), otherwise set thoses 2 fields to 0.
      *
     C           MASESN    IFNE MDNSEC
     C                     Z-ADDWWTDVD    WWOALR           Original Stock Allocation
      *
      ***  Set Original Stock Allocation calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWOALR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOALR
      *
     C                     Z-ADDWWTDVD    WWOTSA           True Stock Allocation
      *
      ***  Set True Stock Allocation calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     Z-ADD8         WWNBDP           Decimal Places = 8
     C                     Z-ADDWWOTSA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOTSA
     C                     ELSE
     C                     Z-ADD0         WWOALR           Original Stock Allocation
     C                     Z-ADD0         WWOTSA           True Stock Allocation
     C                     ENDIF
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'O'                           Stk Dividend Tp=Optional for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'CR'                       Or Proces.Type = Corporate Reorganisation
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'OF'                       Or Processing Type = Offers
     C           MIOFTY    ANDEQ'E'                           Offer Type = Exchange Offers
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'OF'                       Or Processing Type = Offers
     C           MIOFTY    ANDEQ'S'                           Offer Type = Subsrciption Offer
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *                                                                   136935
     C           MAPTYP    OREQ 'OF'                       Or Purchase    136935
     C           MIOFTY    ANDEQ'P'                           Offer       136935
     C           MDOSHA    ANDNE0                             Old Shr <>0 136935
     C           WWNSHA    ANDNE0                             New Shr <>0 136935
      *
     C           MAPTYP    OREQ 'EX'                       Or Proces.Type= Exercices and Conversion
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
     C*****      MDSBPR    ANDNE0                             Subscription136935
      *
     C           MAPTYP    OREQ 'FR'                       Or Processing Type = Free Allocation
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *                                                                   CEU017
      ***  Or Processing Type = Currency Changes and Old and New Nominal  CEU017
      ***  Size not zero.                                                 CEU017
      *                                                                   CEU017
     C           MAPTYP    OREQ 'CC'                                      CEU017
     C           MDOSHA    ANDNE0                                         CEU017
     C           WWNSHA    ANDNE0                                         CEU017
      *
      ***  Calculate Original Stock Allocation.
      *
     C                     EXSR COSA1
      *
      ***  Calculate True Stock Allocation.
      *
     C                     EXSR CTSA1
      *
      ***  Calculate Original Stock Rounding.
      *
     C                     EXSR COSR1
      *
      ***  Calculate Original Cash Rounding.
      *
     C                     EXSR COCR1
      *
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C********** MDDIVU    ANDNE0                             Dividend per Unit not zero      190204
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      190204
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'R'                           Stk Dividend Tp=Reinvestment of Divid.
     C********** MDDIVU    ANDNE0                             Dividend per Unit not zero      190204
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      190204
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
     C           MAPTYP    OREQ 'DV'                       If Processing Type = Div Events    215071
     C           MDSDIT    ANDEQ'O'                           Stock Div Tp=Opt for cash stock 215071
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      215071
     C           MDSBPR    ANDNE0                             Subscription Price not zero     215071
      *                                                                                       215071
     C           MAPTYP    OREQ 'EX'                       Or Proces.Type= Exercices and Conversion
     C           MJCPRC    ANDNE0                             Conversion Price not zero
     C           MJCEXR    ANDNE0                             Exchange Rate not zero
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
      ***  Calculate Original Stock Allocation.
      *
     C                     EXSR COSA2
      *
      ***  Calculate True Stock Allocation.
      *
     C                     EXSR CTSA2
      *
      ***  Calculate Original Stock Rounding.
      *
     C                     EXSR COSR2
      *
      ***  Calculate Original Cash Rounding.
      *
     C                     EXSR COCR2
      *
     C                     ENDIF
      *
      ***  Accumulate Original Cash Rounding calculated.
      *
     C                     ADD  WWOCAR    WTOCAR 309
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CALBC  - Calculate other Book/Customer Allocations.           *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CALBC     BEGSR                           ** CALBC SR **
      *
      ***  Reset work fields.
      *
     C                     Z-ADD0         WWASTA 309       Actual Stock Allocation
     C                     Z-ADD0         WWASTR 309       Actual Stock Rounding
     C                     Z-ADD0         WWACAR 309       Actual Cash Rounding
     C                     Z-ADD0         WWHOST 309       Holding Taken as Stock
     C                     Z-ADD0         WWHOCA 309       Holding Taken as Cash
     C                     Z-ADD0         ACCAPO 309       Actual Cash Pool for Book/Customer
     C                     Z-ADD0         WUHOST 309       Holding Taken as Stock saved
     C                     Z-ADD0         WUHOCA 309       Holding Taken as Cash saved
      *                                                                   153729
     C           MAPTYP    IFEQ 'NC'                       Name Changes   153729
     C                     Z-ADDWWOALR    WWASTA           Actual Stock   153729
     C                     ENDIF                                          153729
      *
      ***  If Special work field equal 'Y', it means the Actual Allocation fields must be
      ***  calculated.
      *
     C           SPWRKF    IFEQ 'Y'
      *
      ***  Calculate Actual Stock Allocation for Book/Customer.
      *
     C                     EXSR CASABC
      *
      ***  Calculate Actual Stock Rounding for Book/Customer.
      *
     C                     EXSR CASRBC
     C                     ENDIF
      *
      ***  Prepare Dividend Per Unit: = from CO Detail file if Processing Type = Dividends Events,
      ***                             = Cash Repaid if Processing Type = Capital Change,
      ***                             = Cash Payment if Processing Type = Corporate Reorganisation.
      *
     C           MAPTYP    IFEQ 'DV'
     C******               Z-ADDNSNBDP    WWNBDP                          135690
     C**********           Z-ADDNCNBDP    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM             13,8 => 30.9  190204
     C                     Z-ADDWWNUM     WWDIVU 309
     C                     ELSE
     C           MAPTYP    IFEQ 'CE'
     C**********           Z-ADDESNBDP    WWNBDP                                             BUG2652
     C**********           Z-ADDMGCARE    WUNUM                                              BUG2652
     C**********           EXSR RTVNDP                                                       BUG2652
     C           MGCARE    DIV  10000000  WWNUM                                              BUG2652
     C                     Z-ADDWWNUM     WWDIVU
     C                     ELSE
     C           MAPTYP    IFEQ 'CR'
     C*****                Z-ADDESNBDP    WWNBDP                          155622
     C*****                Z-ADDMHCAPA    WUNUM                           155622
     C*****                EXSR RTVNDP                                    155622
     C           MHCAPA    DIV  10000000  WWNUM                           155622
     C                     Z-ADDWWNUM     WWDIVU
     C                     ELSE
     C                     Z-ADD0         WWDIVU
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Calculate Holding Taken as Stock for Book/Customer.
      *
     C                     EXSR CHSTBC
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'R'                           Stk Dividend Tp=Reinvestment of Divid.
      *
     C           MAPTYP    OREQ 'EX'                       Or Processing Type = Dividends Events
     C           MJCPRC    ANDNE0                             Conversion Price not 0
     C           MJCEXR    ANDNE0                             Conversion Exchange Rate not 0
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
      ***  Calculate Actual Cash Pool for Book/Customer.
      *
     C                     EXSR CACAPO
     C                     ENDIF
      *
      ***  If Special work field equal 'Y', it means the Actual Allocation fields must be
      ***  calculated.
      *
     C           SPWRKF    IFEQ 'Y'
      *
      ***  Calculate Actual Cash Rounding for Book/Customer.
      *
     C                     EXSR CACRBC
     C                     ENDIF
      *
      ***  If Processing Type = 'NC': Name Changes, 'CR': Corporate Reorganisation,
      ***  or 'OF': Offers and Offer Type = 'E': Exchange Offers or 'S': Subscription Offers,
      ***  set Holding Taken as Cash to 0,
      *
     C           MAPTYP    IFEQ 'NC'                       If Name Changes
     C           MAPTYP    OREQ 'CR'                       Or Corporate Reorganisation
     C           MAPTYP    OREQ 'OF'                       Or Offers
     C           MIOFTY    ANDEQ'E'                           Exchange Offer
     C           MAPTYP    OREQ 'OF'                       Or Offers
     C           MIOFTY    ANDEQ'S'                           Subscription Offer
     C                     Z-ADD0         WWHOCA
      *
      ***  Else, calculate Holding Taken as Cash for Book/Customer.
      *
     C                     ELSE
     C                     EXSR CHCABC
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * WRCOAL - Write a record on SECOALL0: Corporate Actions        *
      *          Allocations file.                                    *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           WRCOAL    BEGSR                           ** WRCOAL SR **
      *
      ***  Blocking processing.
      *
     C                     EXSR PBLOCK
      *
      ***  Load fields.
      *
     C                     MOVE 'D'       MCRECI           Record Id.
     C                     Z-ADDBJRDNB    MCLCD            Last Change Date = Run Date
     C                     MOVE 'I'       MCCHTP           Type of Last Change
     C                     MOVE USER      MCLUID           User Id.
     C                     MOVE PCORF     MCCORF           CO Reference = Parameter
      *
     C           MAPTYP    IFEQ 'NF'                       If Processing Type = Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
     C           MAPTYP    OREQ 'CC'                       Or Ccy Changes CEU017
     C                     MOVE '01'      MCOPTN              Option Number = 01
     C                     ELSE                            Else
     C                     MOVE MDOPTN    MCOPTN              Option Number = from SECOxxL0
     C                     ENDIF
      *
     C                     MOVE PBRCD     MCBRCD           Branch = Parameter
     C**********           Z-ADDWWDDPT    MCDDPT           Depot = Parameter (num field)      CSD027
     C                     MOVE WWDDPT    MCDDPT           Depot = Parameter (num field)      CSD027
     C                     MOVE WWCOTP    MCCOTP           Customer/Book Ind. = Calculated
     C                     MOVE WWUDBK    MCBOOK           Book = Calculated
     C                     MOVE WWCDCN    MCCNUM           Customer = Calculated
     C                     MOVE WWPTFR    MCPTFR           Portfolio Reference = Calculated
     C                     MOVE NWSESN    MCSESN           Security = Calculated
      *
      ***  Fields always in Event Security Decimal Places.
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C           MAPTYP    IFEQ 'OF'                                      145872
     C           MIOFTY    ANDEQ'E'                                       145872
     C                     Z-ADDWUTDVD    WWNUM                           145872
     C                     ELSE                                           145872
     C                     Z-ADDWWTDVD    WWNUM
     C                     ENDIF                                          145872
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCEXPO           Ex-Date Position = Retrieve
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCHOST           Holding Taken as Stock = Calculated
      *
      ***  Fields always with 8 Decimal Places.
      *
     C                     Z-ADDWWOTSA    MCOTSA           True Stock Allocation = Calculated
     C                     Z-ADDWWOSTR    MCOSTR           Original Stock Rounding = Calculated
     C                     Z-ADDWWASTR    MCASTR           Actual Stock Rounding = Calculated
      *
      ***  Fields calculated only for New Security (for Security '**CASH**' = 0), so in New
      ***  Security Decimal Places.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     Z-ADDWWOALR    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCOALR           Original Stock Allocation = Calculated
     C                     Z-ADDWWASTA    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCASTA           Actual Stock Allocation = Calculated
      *
      ***  Fields calculated for New Security and for Security '**CASH**', in Event Currency Decimal
      ***  Places when Security = '**CASH**' and Processing Type = Corporate Reorganisation, else
      ***  in New Currency Decimal Places.
      *
     C           MCSESN    IFEQ '**CASH**'
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     ELSE
     C                     Z-ADDNCNBDP    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     Z-ADDWWOCAR    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCOCAR           Original Cash Rounding
     C                     Z-ADDWWHOCA    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCHOCA           Holding Taken as Cash = Calculated
     C                     Z-ADDWWACAR    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCACAR           Actual Cash Rounding
      *
      ***  Fields calculated only for Security '**CASH**' (for New Security = 0), in Event
      ***  Currency Decimal Places when Processing Type = Corporate Reorganisation, else in New
      ***  Currency Decimal Places.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     Z-ADDWWCAOP    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCCAOP           Original Cash Option = Calculated
     C                     Z-ADDWWACAA    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCACAA           Actual Cash Allocation = Calculated
      *
      ***  Fields calculated only for Security '**CASH**' for Customer calculations, else = 0,
      ***  so in New Currency Decimal Places.
      *
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     Z-ADDWWTOTF    WWNUM
      * No need to multiply the result, only to edit correctly on screen. 179205
     C***********          EXSR SETNDP                                    179205
     C                     Z-ADDWWNUM     WUNUM                           179205
     C                     Z-ADDWUNUM     MCTOTF           Total Fees = calculated
     C                     Z-ADDWWTOTT    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MCTOTT           Total Taxes = calculated
      *
     C                     MOVE WWOPT1    MCOPT1           Option for Actual Allocation 1 = Calculat
     C                     MOVE WWOPT2    MCOPT2           Option for Actual Allocation 2 = Calculat
     C                     MOVE WWREST    MCREST           Reply Status = Calculated
     C                     MOVE WWBSEC    MCBSEC           Block Security = Calculated
     C                     Z-ADDWWBEDT    MCBEDT           Blocked End Date = Calculated
     C                     Z-ADDWWBSTT    MCBSTT           Blocked Start Date = Calculated
     C                     MOVE WWBLTY    MCBLTY           Block Type = Calculated
     C                     MOVE WWBEWI    MCBEWI           Block Error/Warning Ind. = Calculated
     C                     MOVE MACOAT    MCCOAT           CO Type = from SECORFL1
     C                     MOVE WWLTRQ    MCLTRQ           Letter Required = calculated
      *
     C                     MOVE *BLANKS   MCTRRF           Transaction Reference
     C                     MOVE *BLANKS   MCTRR2           Transaction Reference 2
     C                     MOVE *BLANKS   MCTRR3           Transaction Reference 3
     C                     MOVE *BLANKS   MCRVRF           Reversal Reference
     C                     MOVE *BLANKS   MCRVR2           Reversal Reference 2
     C                     MOVE *BLANKS   MCRVR3           Reversal Reference 3
     C                     Z-ADD0         MCTNL1           Position Settlement TNL1
      *                                                                                       223182
     C                     MOVE *BLANKS   WTCNUM 10                                           223182
     C                     MOVELWWCDCN    WTCNUM                                              223182
     C                     CALL 'AOCUSTR1'                                                    223182
     C                     PARM *BLANKS   @RTCD                                               223182
     C                     PARM '*KEY    '@OPTN                                               223182
     C                     PARM WTCNUM    @CUST                                               223182
     C                     PARM           WWK7    7                                           223182
     C           SDCUST    PARM SDCUST    DSLDY                                               223182
     C           BBCLST    IFEQ 'Y'                                                           223182
     C           MCSESN    IFEQ '**CASH**'                                                    223182
     C                     Z-ADD0         MCACAA                                              223182
     C                     Z-ADD0         MCACAR                                              223182
     C                     ELSE                                                               223182
     C                     Z-ADD0         MCASTA                                              223182
     C                     Z-ADD0         MCASTR                                              223182
     C                     Z-ADD0         MCACAR                                              223182
     C                     ENDIF                                                              223182
     C                     ENDIF                                                              223182
      *
      ***  Write record on file SECOALL0.
      *
     C                     WRITESECOALD0               89
      *
      ***  If error detected when write, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD016       DBASE            ***************
     C                     MOVEL'SECOALL0'DBFILE           * DB ERROR 16 *
     C                     MOVEL'WRITE'   DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ADD  1         RSEAL
      *
      ***  Reset all block fields if Corporate Action Type = Corporate Reorganisation
      ***  (must only be filled on first record written in CO Allocation file (SECOALL0)).
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE *BLANKS   WWBSEC           Block Security
     C                     Z-ADD0         WWBEDT           Blocked End Date
     C                     Z-ADD0         WWBSTT           Blocked Start Date
     C                     MOVE *BLANKS   WWBLTY           Block Typeed
     C                     MOVE *BLANKS   WWBEWI           Block Error/Warning Indicator
     C                     MOVE 'N'       FIRSCR           First passage for CO Type = 'CR' done
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CCABC  - Calculate Cash Option and Actual Cash Allocation     *
      *          for Book/Customer.                                   *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CCABC     BEGSR                           ** CCABC SR **
      *
      ***  Reset work fields.
      *
     C                     Z-ADD0         WWCAOP 309       Original Cash Option
     C                     Z-ADD0         WWACAA 309       Actual Cash Allocation
      *
      ***  Prepare Dividend Per Unit: from file if Processing Type = Dividends Events,
      ***                             = Cash Repaid if Processing Type = Capital Change,
      ***                             = Cash Payment if Processing Type = Corporate Reorganisation.
      ***                             = Receive Price if Processing Type = Offers and Offer Type =
      ***                               Exchange Offers or Purchase Offer,
      ***                             = Subscription Price if Processing Type = Offers and Offer
      ***                               Type = Subsrciption Offer.
      *
     C           MAPTYP    IFEQ 'DV'
     C******               Z-ADDTSDP,1    WWNBDP                          135690
     C**********           Z-ADDTCDP,1    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM             13,8 ==> 30,9 190204
     C                     Z-ADDWWNUM     WWDIVU
     C                     ELSE
     C           MAPTYP    IFEQ 'CE'
     C**********           Z-ADDESNBDP    WWNBDP                                             BUG2652
     C**********           Z-ADDMGCARE    WUNUM                                              BUG2652
     C**********           EXSR RTVNDP                                                       BUG2652
     C           MGCARE    DIV  10000000  WWNUM                                              BUG2652
     C                     Z-ADDWWNUM     WWDIVU
     C                     ELSE
     C           MAPTYP    IFEQ 'CR'
     C*****                Z-ADDESNBDP    WWNBDP                          155622
     C*****                Z-ADDMHCAPA    WUNUM                           155622
     C*****                EXSR RTVNDP                                    155622
     C           MHCAPA    DIV  10000000  WWNUM                           155622
     C                     Z-ADDWWNUM     WWDIVU
     C                     ELSE
     C           MAPTYP    IFEQ 'OF'
     C           MIOFTY    ANDEQ'E'
     C           MAPTYP    OREQ 'OF'
     C           MIOFTY    ANDEQ'P'
     C                     Z-ADDMIREPR    WWDIVU
     C                     ELSE
     C           MAPTYP    IFEQ 'OF'
     C           MIOFTY    ANDEQ'S'
     C                     Z-ADDMISUPR    WWDIVU
     C                     ELSE
     C                     Z-ADD0         WWDIVU
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C           MAPTYP    OREQ 'FR'                       Or Processing Type = Free Allocation
     C           MAPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
     C           MAPTYP    OREQ 'NF'                       Or Processing Type = Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
     C********** MAPTYP    OREQ 'EX'                       Or Proces. Type = Exercices & Conve219579
     C           MAPTYP    OREQ 'CC'                       Or Ccy Changes CEU017
      *
      ***  Set Cash Option to zero.
      *
     C                     Z-ADD0         WWCAOP
      *
      ***  Else, Calculate Cash Option.
      *
     C                     ELSE
     C                     EXSR CCAOPT
     C                     ENDIF
      *
      ***  Calculate Actual Cash Allocation for Book/Customer.
      *
     C                     EXSR CACABC
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CALDPT - Calculate other Depot Allocations.                   *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CALDPT    BEGSR                           ** CALDPT SR **
      *
      ***  Reset work fields.
      *
     C                     Z-ADD0         WWASTA 309       Actual Stock Allocation
     C                     Z-ADD0         WWASTR 309       Actual Stock Rounding
     C                     Z-ADD0         WWACAR 309       Actual Cash Rounding
     C                     Z-ADD0         WWHOST 309       Holding Taken as Stock
     C                     Z-ADD0         WWHOCA 309       Holding Taken as Cash
     C                     Z-ADD0         WUHOST 309       Holding Taken as Stock saved
     C                     Z-ADD0         WUHOCA 309       Holding Taken as Cash saved
      *
     C           MAPTYP    IFEQ 'CE'                       If Processing Type = Capital Exchange
     C******     MAPTYP    OREQ 'OF'                       Or Purchase    136935
     C******     MIOFTY    ANDEQ'P'                           Offer       136935
     C           MAPTYP    OREQ 'NF'                       Or Processing Type = Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
      *
      ***  Set Actual Stock Allocation to zero.
      *
     C           MAPTYP    IFEQ 'NC'                       Name Changes   153729
     C                     Z-ADDWWOALR    WWASTA           Actual Stock   153729
     C                     ELSE                                           153729
     C                     Z-ADD0         WWASTA
     C                     ENDIF                                          153729
      *                                                                   153729
     C                     ELSE
      *
      ***  Calculate Actual Stock Allocation for Depot.
      *
     C                     EXSR CASADP
     C                     ENDIF
      *
      ***  Calculate Holding Taken as Stock for Depot.
      *
     C                     EXSR CHSTDP
      *
      ***  Calculate Holding Taken as Cash for Depot.
      *
     C                     EXSR CHCADP
      *
     C           MAPTYP    IFEQ 'NF'                       If Processing Type = Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
     C           MAPTYP    OREQ 'OF'                       Or Subscript.  136935
     C           MIOFTY    ANDEQ'S'                           Offers      136935
     C           MAPTYP    OREQ 'OF'                       Or Purchase    136935
     C           MIOFTY    ANDEQ'P'                           Offers      136935
      *
      ***  Set Actual Stock Rounding and WWACAR: Actual Cash Rounding to zero.
      *
     C                     Z-ADD0         WWASTR
     C                     Z-ADD0         WWACAR
     C                     ELSE
      *
      ***  Calculate Actual Stock Rounding for Depot.
      *
     C                     EXSR CASRDP
      *
      ***  Calculate Actual Cash Rounding for Depot.
      *
     C                     EXSR CACRDP
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * WRCODP - Write a record on SECODPL0: Corporate Actions Depots *
      *          file.                                                *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           WRCODP    BEGSR                           ** WRCODP SR **
      *
      ***  Load fields.
      *
     C                     MOVE 'D'       MBRECI           Record Id.
     C                     Z-ADDBJRDNB    MBLCD            Last Change Date = Run Date
     C                     MOVE 'I'       MBCHTP           Type of Last Change
     C                     MOVE USER      MBLUID           User Id.
     C                     MOVE PCORF     MBCORF           CO Reference = Parameter
      *
     C           MAPTYP    IFEQ 'NF'                       If Processing Type = Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
     C           MAPTYP    OREQ 'CC'                       Or Ccy Changes CEU017
     C                     MOVE '01'      MBOPTN              Option Number = 01
     C                     ELSE                            Else
     C                     MOVE MDOPTN    MBOPTN              Option Number = from SECOxxL0
     C                     ENDIF
      *
     C                     MOVE PBRCD     MBBRCD           Branch = Parameter
     C**********           Z-ADDWWDDPT    MBDDPT           Depot = Parameter (num field)      CSD027
     C                     MOVE WWDDPT    MBDDPT           Depot = Parameter (num field)      CSD027
     C                     MOVE NWSESN    MBSESN           New Security
      *
      ***  Fields always in Event Security Decimal Places.
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C           MAPTYP    IFEQ 'OF'                                      145872
     C           MIOFTY    ANDEQ'E'                                       145872
     C                     Z-ADDWUTDVD    WWNUM                           145872
     C                     ELSE                                           145872
     C                     Z-ADDWWTDVD    WWNUM
     C                     ENDIF                                          145872
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBEXPO           Ex-Date Position = retrieve
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBHOST           Holding Taken as Stock = calculated
      *
      ***  Fields calculated only for Security '**CASH**' (for New Security = 0), so in Event
      ***  Currency Decimal Places if Processing Type = Corporate reorganisation, else in New
      ***  Currency Decimal Places.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     Z-ADDWWCAOP    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBCAOP           Original Cash Option = Calculated
     C                     Z-ADDWWACAA    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBACAA           Actual Cash Allocation = Calculated
     C                     Z-ADDWWBCAA    WWNUM
     C                     EXSR SETNDP
     C           MBSESN    IFNE '**CASH**'                                137886
     C                     Z-ADDWUNUM     MBBCAA           Balancing Cash Allocation = Calculated
     C                     ELSE                                           137886
     C                     Z-SUBWUNUM     MBBCAA                          137886
     C                     ENDIF                                          137886
      *
      ***  Fields always in 8 Decimal Places.
      *
     C                     Z-ADD8         WWNBDP           8 Decimal Places
     C                     Z-ADDWWOTSA    MBOTSA           True Stock Allocation = Calculated
     C                     Z-ADDWWOSTR    MBOSTR           Original Stock Rounding = Calculated
     C                     Z-ADDWWASTR    MBASTR           Actual Stock Rounding = Calculated
     C                     Z-ADDWWBSTR    MBBSTR           Balancing Stock Rounding = Calculated
      *
      ***  Fields "stock" calculated only for New Security (for Security '**CASH**' = 0), so in
      ***  New Security Decimal Places.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     Z-ADDWWOALR    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBOALR           Original Stock Allocation = Calculated
     C                     Z-ADDWWASTA    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBASTA           Actual Stock Allocation = Calculated
     C                     Z-ADDWWBSTA    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBBSTA           Balancing Stock Allocation = Calculated
      *
      ***  Fields "cash" calculated only for New Security (for Security '**CASH**' = 0), so in
      ***  New Currency Decimal Places.
      *
     C                     Z-ADDNCNBDP    WWNBDP           New Currency Decimal Places
     C                     Z-ADDWWBCAR    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBBCAR           Balancing Cash Rounding = Calculated
      *
      ***  Fields calculated for New Security and for Security '**CASH**', in Event Currency Decimal
      ***  Places when Security = '**CASH**' and Processing Type = Corporate Reorganisation, else
      ***  in New Currency Decimal Places.
      *
     C           MBSESN    IFEQ '**CASH**'
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     ELSE
     C                     Z-ADDNCNBDP    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     Z-ADDWWOCAR    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBOCAR           Original Cash Rounding
     C                     Z-ADDWWHOCA    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBHOCA           Holding Taken as Cash = Calculated
     C                     Z-ADDWWACAR    WWNUM
     C                     EXSR SETNDP
     C                     Z-ADDWUNUM     MBACAR           Actual Cash Rounding
      *
     C                     MOVE MACOAT    MBCOAT           CO Type = Parameter
      *
     C                     Z-ADD0         MBTNL1           Position Settlement TNL1
      *
      ***  Write record on file SECODPL0.
      *
     C                     WRITESECODPD0               89
      *
      ***  If error detected when write, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD017       DBASE            ***************
     C                     MOVEL'SECODPL0'DBFILE           * DB ERROR 17 *
     C                     MOVEL'WRITE'   DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ADD  1         RSEDP
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CCADPT - Calculate Cash Option and Actual Cash Allocation for *
      *          Depot.                                               *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CCADPT    BEGSR                           ** CCADPT SR **
      *
      ***  Reset work fields.
      *
     C                     Z-ADD0         WWCAOP 309       Original Cash Option
     C                     Z-ADD0         WWACAA 309       Actual Cash Allocation
      *
      ***  Prepare Dividend Per Unit: from file if Processing Type = Dividends Events,
      ***                             = Cash Repaid if Processing Type = Capital Change,
      ***                             = Cash Payment if Processing Type = Corporate Reorganisation,
      ***                             = Receive Price if Processing Type = Offers and Offer Type =
      ***                               Exchange Offers or Purchase Offer,
      ***                             = Subscription Price if Processing Type = Offers and Offer
      ***                               Type = Subsrciption Offer.
      *
     C           MAPTYP    IFEQ 'DV'
     C******               Z-ADDTSDP,1    WWNBDP                          135690
     C**********           Z-ADDTCDP,1    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM             13,8 => 30,9  190204
     C                     Z-ADDWWNUM     WWDIVU
     C                     ELSE
     C           MAPTYP    IFEQ 'CE'
     C**********           Z-ADDESNBDP    WWNBDP                                             BUG2652
     C**********           Z-ADDMGCARE    WUNUM                                              BUG2652
     C**********           EXSR RTVNDP                                                       BUG2652
     C           MGCARE    DIV  10000000  WWNUM                                              BUG2652
     C                     Z-ADDWWNUM     WWDIVU
     C                     ELSE
     C           MAPTYP    IFEQ 'CR'
     C*****                Z-ADDESNBDP    WWNBDP                          155622
     C*****                Z-ADDMHCAPA    WUNUM                           155622
     C*****                EXSR RTVNDP                                    155622
     C           MHCAPA    DIV  10000000  WWNUM                           155622
     C                     Z-ADDWWNUM     WWDIVU
     C                     ELSE
     C           MAPTYP    IFEQ 'OF'
     C           MIOFTY    ANDEQ'E'
     C           MAPTYP    OREQ 'OF'
     C           MIOFTY    ANDEQ'P'
     C                     Z-ADDMIREPR    WWDIVU
     C                     ELSE
     C           MAPTYP    IFEQ 'OF'
     C           MIOFTY    ANDEQ'S'
     C                     Z-ADDMISUPR    WWDIVU
     C                     ELSE
     C                     Z-ADD0         WWDIVU
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C           MAPTYP    OREQ 'FR'                       Or Processing Type = Free Allocation
     C           MAPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
     C           MAPTYP    OREQ 'NF'                       Or Processing Type = Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
     C***********MAPTYP    OREQ 'EX'                       Or Proces. Type = Exercices & Conve219579
     C           MAPTYP    OREQ 'CC'                       Or Ccy Changes CEU017
      *
      ***  Set Cash Option to zero.
      *
     C                     Z-ADD0         WWCAOP
      *
      ***  Else, calculate Cash Option.
      *
     C                     ELSE
     C                     EXSR CCAOPT
     C                     ENDIF
      *
      ***  Calculate Actual Cash Allocation for Depot.
      *
     C                     EXSR CACADP
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * COSA1  - 1st calculation of Original Stock Allocation.        *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           COSA1     BEGSR                           ** COSA1 SR **
      *                                                                   136935
      ***  If Processing Type = Offer with Offer Type = Exchange.         136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'E'                                       136935
     C           WINDPT    ANDNE'Y'                                       156690
      *                                                                   136935
      ***  Calculate work field A = (Ex-Date Position multiplied by Stock 136935
      ***  Preferred %) divided by Number of Old Shares, where Stock      136935
      ***  Preferred % = 100 - % Accepted previously calculated.          136935
      *                                                                   136935
     C********** 100       SUB  WCAPR     WSTPR                                        136935 218698
     C********** WWTDVD    MULT WSTPR     FLDA                                         136935 218698
     C           WWOPT2    IFEQ '3'                                                           220006
     C           WWTDVD    MULT WCAPR     FLDA                                                220006
     C                     END                                                                220006
     C           FLDA      DIV  100       FLDA                            136935
     C           FLDA      DIV  MDOSHA    FLDA                            136935
     C           EXBCRE    IFEQ 'Y'                                                           220006
     C           MQR2CN    ANDNE0                                                             220006
     C                     Z-ADDMQR2CN    FLDA                                                220006
     C                     END                                                                220006
      *                                                                   136935
      ***  Else, if Processing Type not Offer with Offer Type = Exchange. 136935
      *                                                                   136935
     C                     ELSE                                           136935
      *                                                                   136935
      ***  If Processing Type = Exercices and Conversions.                136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'EX'                                      136935
      *                                                                   136935
      ***  If Standard Corporate Actions Instruction exists, set          136935
      ***  Convert/Keep work field to Convertible/Keep field retreive     136935
      ***  from SECOSIL1-2.                                               136935
      *                                                                   136935
     C                     MOVE ' '       WWCKIN  1                       136935
     C           EXBCSI    IFEQ 'Y'                                       136935
     C           MJOPT5    ANDEQ'Y'                                       156701
     C           MJOPT6    ANDEQ'Y'                                       156701
     C                     MOVE MOCKIN    WWCKIN                          136935
     C                     ELSE                                           136935
      *                                                                   136935
      ***  Else, if Customer/Book Standard Corporate Actions Instruction  136935
      ***  does not exist, set Convertible/Keep work field to 'C' if      136935
      ***  Default for no Reply retrieve from SECOEXL1 is 1 to 5, else    136935
      ***  set it to 'K' if Default No Reply = 6 or 7.                    136935
      *                                                                   136935
     C           MDDFNR    IFEQ '1'                                       136935
     C           MDDFNR    OREQ '2'                                       136935
     C           MDDFNR    OREQ '3'                                       136935
     C           MDDFNR    OREQ '4'                                       136935
     C           MDDFNR    OREQ '5'                                       136935
     C                     MOVE 'C'       WWCKIN                          136935
     C                     ELSE                                           136935
     C           MDDFNR    IFEQ '6'                                       136935
     C           MDDFNR    OREQ '7'                                       136935
     C                     MOVE 'K'       WWCKIN                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
      *                                                                   136935
      ***  If Convert/Keep Indicator = 'K', set Accept on Holding to 0.   136935
      *                                                                   136935
     C           WWCKIN    IFEQ 'K'                                       136935
     C                     Z-ADD0         ACCHLD                          136935
     C                     ELSE                                           136935
      *                                                                   136935
      ***  Else, if Convert/Keep Indicator = 'C', calculate Accept on     136935
      ***  Holding = Holding (=Ex-Date Position) - Sell on Holding, where 136935
      ***  Sell on Holding = Holding (=Ex-Date Position multiplied by     136935
      ***  Cash % previously calculated.                                  136935
      *                                                                   136935
     C           WWTDVD    MULT WCAPR     SELHLD 309                      136935
     C           SELHLD    DIV  100       SELHLD                          136935
     C           WWTDVD    SUB  SELHLD    ACCHLD 309                      136935
     C                     ENDIF                                          136935
      *                                                                   136935
      ***  Calculate work field A = Accept on Holding divided by Number   136935
      ***  of Old Shares.                                                 136935
      *                                                                   136935
     C           ACCHLD    DIV  MDOSHA    FLDA                            136935
      *                                                                   136935
      ***  Else, if Processing Type not Offer with Offer Type = Exchange, 136935
      ***  and not Exercices and Conversions.                             136935
      *                                                                   136935
     C                     ELSE                                           136935
      *
      ***  Calculate work field A = Ex-Date Position divided by Number of Old Shares.
      *
     C           WWTDVD    DIV  MDOSHA    FLDA   309
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
      *
      ***  Calculate work field AA = work field A rounded down if Rounding Indicator from Corporate
      ***  Actions Details file = 'D' or half adjust if Rounding = 'R' (rounded is perform to Number
      ***  of Decimal Places of New Security).
      *
     C                     Z-ADDFLDA      WWNUM
     C                     Z-ADDNSNBDP    WWNBDP
     C                     MOVE WWRNDN    WUROOP
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     FLDAA  309
      *
      ***  Calculate work field B = work field AA multipled by Number of New Shares.
      *
     C           WWRNDN    IFEQ 'B'                                       149153
     C           1         MULT WWNSHA    FLDB                            149153
     C                     ELSE                                           149153
     C********** WWRNDN    IFEQ 'O'                                149782 161419
     C           FLDA      MULT WWNSHA    FLDB   309                      149782
     C**********           ELSE                                    149782 161419
     C********** FLDAA     MULT WWNSHA    FLDB   309                      161419
     C**********           ENDIF                                   149782 161419
     C                     ENDIF                                          149153
      *
      ***  Calculate work field C = work field B divided by Denomination Multilier.
      *
     C           FLDB      DIV  WWDMLT    FLDC   309
      *
      ***  Calculate work field CA = work field C rounding down to nearest unit if Rounding
      ***  Indicator from Corporate Actions Detail file = 'D', or half adjust to nearest unit
      ***  if Rounding = 'R'.
      *
     C           WWRNDN    IFEQ 'D'
     C           WWRNDN    OREQ 'U'                                       135686
     C           WWRNDN    OREQ 'B'                                       149153
     C           WWRNDN    OREQ 'O'                                       149782
     C                     Z-ADDFLDC      FLDCA  300
     C                     ELSE
     C                     Z-ADDFLDC      FLDCA  300H
     C                     ENDIF
      *
      ***  Calculate Original Stock Allocation = work field CA multiplied by Denomination
      ***  Multiplier.
      *
     C           FLDCA     MULT WWDMLT    WWOALR
      *                                                                   135686
     C           WWRNDN    IFEQ 'U'                                       135686
     C           WWOALR    ANDNEFLDB                                      135686
     C                     ADD  WWDMLT    WWOALR                          135686
     C                     ENDIF                                          135686
      *                                                                   136935
      ***  If Processting Type = Offers with Offer Type = Subscription,   136935
      ***  accumulate Original Stock Allocation calculated.               136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C                     ADD  WWOALR    WUOALR                          136935
     C                     ENDIF                                          136935
      *                                                                   136935
      ***  If Processting Type = Offers with Offer Type = Purchase,       136935
      ***  accumulate Original Stock Allocation calculated multiplied by  136935
      ***  Cash Preferred %.                                              136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'P'                                       136935
     C           WWOALR    MULT WCAPR     W1OALR 309                      136935
     C                     DIV  100       W1OALR                          136935
     C           MQR2CN    IFNE 0                                         219976
     C                     Z-ADDMQR2CN    W1OALR                          219976
     C                     END                                            219976
     C**********           ADD  W1OALR    W2OALR                   136935 209292
     C                     ADD  W1OALR    W2OALR                          219976
     C                     ADD  WWOALR    WUOALR                                              193662
     C                     ENDIF                                          136935
      *                                                                   149153
     C           WWRNDN    IFEQ 'B'                                       149153
     C                     Z-ADDWWOALR    WWOAL1 309                      149153
     C           WWOALR    MULT FLDA      WWOALR                          149153
     C                     ENDIF                                          149153
      *
      ***  Set Original Stock Allocation calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWOALR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOALR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CTSA1  - 1st calculation of True Stock Allocation.            *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CTSA1     BEGSR                           ** CTSA1 SR **
      *                                                                   136935
      ***  If Processing Type =  Offers with Offer Type = Subscription or 136935
      ***  Purchase, set True Stock Allocation to 0.                      136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C           MAPTYP    OREQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'P'                                       136935
     C                     Z-ADD0         WWOTSA                          136935
      *                                                                   136935
      ***  Else, if Processing Type not Offers with Offer Type =          136935
      ***  Subscription and Purchase.                                     136935
      *                                                                   136935
     C                     ELSE                                           136935
      *
      ***  Calculate True Stock Allocation = work field A calculated previously multiplied
      ***  by Number of new shares.
      *
     C           FLDA      MULT WWNSHA    WWOTSA
      *
      ***  Set True Stock Allocation calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     Z-ADD8         WWNBDP           Decimal Places = 8
     C                     Z-ADDWWOTSA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOTSA
     C                     ENDIF                                          136935
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * COSR1  - 1st calculation of Original Stock Rounding.          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           COSR1     BEGSR                           ** COSR1 SR **
      *                                                                   136935
      ***  If Processing Type =  Offers with Offer Type = Subscription or 136935
      ***  Purchase, set Original Stock Rounding to 0.                    136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C           MAPTYP    OREQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'P'                                       136935
     C                     Z-ADD0         WWOSTR                          136935
      *                                                                   136935
      ***  Else, if Processing Type not Offers with Offer Type =          136935
      ***  Subscription and Purchase.                                     136935
      *                                                                   136935
     C                     ELSE                                           136935
      *
      ***  Calculate Original Stock Rounding = True Stock Allocation calculated before
      ***  - Original Stock Allocation calculated before.
      *
     C           WWRNDN    IFEQ 'B'                                       149153
     C           WWNSHA    SUB  WWOAL1    WWOSTR                          149153
     C                     Z-ADDWWOSTR    WWOST1 309                      149153
     C           WWOSTR    MULT FLDA      WWOSTR                          149153
     C                     ELSE                                           149153
     C           WWOTSA    SUB  WWOALR    WWOSTR
     C                     ENDIF                                          149153
      *
      ***  Set Original Stock Rounding calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     Z-ADD8         WWNBDP           Decimal Places = 8
     C                     Z-ADDWWOSTR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOSTR
     C                     ENDIF                                          136935
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * COSR2  - 2nd calculation of Original Stock Rounding.          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           COSR2     BEGSR                           ** COSR2 SR **
      *
      ***  Calculate Original Stock Rounding = ((Holding (Ex-Date Position) multiplied by Dividend
      ***  Per Unit) - (Original Stock Allocation previously calculated multiplied by Subscription
      ***  Price) divided by Subscription Price.
      ***  Use Conversion Price multiplied by Exchange Rate instead of    136935
      ***  Dividend Per Unit if Processing Type = Exercices and           136935
      ***  Conversions (= if not 'DV').                                   136935
      *
     C           MAPTYP    IFEQ 'DV'                                      136935
     C******               Z-ADDNSNBDP    WWNBDP                          135690
     C**********           Z-ADDNCNBDP    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM            13,8 => 30,9   190204
     C           WWTDVD    MULT WWNUM     FLDFW  309
     C                     ELSE                                           136935
     C           WWTDVD    MULT MJCPRC    FLDFW                           136935
     C           FLDFW     MULT MJCEXR    FLDFW                           136935
     C                     ENDIF                                          136935
     C           WWOALR    MULT MDSBPR    FLDFWW 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           FLDFWW    DIV  100       FLDFWW
     C                     ENDIF
     C                     SUB  FLDFWW    FLDFW
     C           FLDFW     DIV  MDSBPR    WWOSTR
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           WWOSTR    DIV  100       WWOSTR
     C                     ENDIF
      *
      ***  Set Original Stock Rounding calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     Z-ADD8         WWNBDP           Decimal Places = 8
     C                     Z-ADDWWOSTR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOSTR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * COCR1  - 1st calculation of Original Cash Rounding.           *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           COCR1     BEGSR                           ** COCR1 SR **
      *                                                                   136935
      ***  If Processing Type =  Offers with Offer Type = Subscription or 136935
      ***  Purchase, set Original Cash Rounding to 0.                     136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C           MAPTYP    OREQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'P'                                       136935
     C                     Z-ADD0         WWOCAR                          136935
      *                                                                   136935
      ***  Else, if Processing Type not Offers with Offer Type =          136935
      ***  Subscription and Purchase.                                     136935
      *                                                                   136935
     C                     ELSE                                           136935
      *
      ***  If Rounding Settlement in Cash = 'Y', calculate Original Cash Rounding = Original Stock
      ***  Rounding previously calculated multiplied by Compensation Price.
      *
     C           WWRNDS    IFEQ 'Y'
     C           WWRNDN    IFEQ 'B'                                       149153
     C           WWOST1    MULT WWCOMP    WWOCAR                          149153
     C           WWOCAR    MULT FLDA      WWOCAR                          149153
     C                     ELSE                                           149153
     C           WWOSTR    MULT WWCOMP    WWOCAR 309
     C                     ENDIF                                          149153
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           WWOCAR    DIV  100       WWOCAR
     C                     ENDIF
      *
      ***  Set Original Cash Rounding calculated.
      *
     C                     Z-ADDNCNBDP    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWWOCAR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOCAR
      *
      ***  Else, If Rounding Settlement in Cash not equal 'Y', set Original Cash Rounding
      ***  to zero.
      *
     C                     ELSE
     C                     Z-ADD0         WWOCAR
     C                     ENDIF
     C                     ENDIF                                          136935
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * COCR   - Calculation of Original Cash Rounding for Security = *
      *          '**CASH**'.                                          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           COCR      BEGSR                           ** COCR SR **
      *
      ***  Set Original Cash Rounding = Total Original Cash Rounding accumulated for all
      ***  New Securities.
      *
     C                     Z-ADDWTOCAR    WWNUM
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP
     C                     ENDIF
     C                     MOVE 'R'       WURROP  1
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOCAR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CACR   - Calculation of Actual Cash Rounding for Security =   *
      *          '**CASH**'.                                          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CACR      BEGSR                           ** CACR SR **
      *
      ***  Set Actual Cash Rounding = Total Actual Cash Rounding accumulated for all
      ***  New Securities.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP
     C                     ENDIF
     C                     MOVE 'R'       WURROP
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWACAR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CHST   - Calculation of Holding Taken as Stock for Security = *
      *          '**CASH**'.                                          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CHST      BEGSR                           ** CHST SR **
      *
      ***  Set Holding Taken as Stock = same value as preceeding record (= value saved).
      *
     C                     Z-ADDESNBDP    WWNBDP
     C                     MOVE WWRNDN    WUROOP
     C                     Z-ADDWUHOST    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOST
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CHCA   - Calculation of Holding Taken as Cash for Security =  *
      *          '**CASH**'.                                          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CHCA      BEGSR                           ** CHCA SR **
      *
      ***  Set Holding Taken as Cash = same value as preceeding record (= value saved).
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP
     C                     ENDIF
     C                     MOVE 'R'       WUROOP
     C                     Z-ADDWUHOCA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOCA
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * COSA2  - 2nd calculation of Original Stock Allocation.        *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           COSA2     BEGSR                           ** COSA2 SR **
      *
      ***  If Processing Type = Dividend Events,
      ***  calculate Cash Pool = Ex-Date Position multiplied by Dividend Per Unit.
      *
     C           MAPTYP    IFEQ 'DV'
     C******               Z-ADDNSNBDP    WWNBDP                          135690
     C**********           Z-ADDNCNBDP    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM            13,8 => 30,9   190204
     C           WWTDVD    MULT WWNUM     CASPOO 309
      *
      ***  Else, if Processing Type = Exercices and Conversions.
      *
     C                     ELSE
      *
      ***  If Standard Corporate Actions Instruction exists, set Convertible/Keep work field to
      ***  Convertible/Keep field retreive from SECOSIL1-2.
      *
     C                     MOVE ' '       WWCKIN  1
     C           EXBCSI    IFEQ 'Y'
     C           MJOPT5    ANDEQ'Y'                                       156701
     C           MJOPT6    ANDEQ'Y'                                       156701
     C                     MOVE MOCKIN    WWCKIN
     C                     ELSE
      *
      ***  Else, if Customer/Book Standard Corporate Actions Instruction does not exist, set
      ***  Convertible/Keep work field to 'C' if Default for no Reply retreive from SECOEXL1
      ***  is 1 to 5, else set it to 'K' if Default No Reply = 6 or 7.
      *
     C           MDDFNR    IFEQ '1'
     C           MDDFNR    OREQ '2'
     C           MDDFNR    OREQ '3'
     C           MDDFNR    OREQ '4'
     C           MDDFNR    OREQ '5'
     C                     MOVE 'C'       WWCKIN
     C                     ELSE
     C           MDDFNR    IFEQ '6'
     C           MDDFNR    OREQ '7'
     C                     MOVE 'K'       WWCKIN
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Convertible/Keep work field = 'C',calculate % to be converted = 100 - Cash %.
      ***  and calculate Accept on Holding = Holding (=Ex-Date Position)  136935
      ***  - Sell on Holding, where Sell on Holding = Holding (=Ex-Date   136935
      ***  Position multiplied by Cash % previously calculated.           136935
      *
     C           WWCKIN    IFEQ 'C'
     C           100       SUB  WCAPR     PETBCO  52       % to be converted
     C           WWTDVD    MULT WCAPR     SELHLD 309                      136935
     C           SELHLD    DIV  100       SELHLD                          136935
     C           WWTDVD    SUB  SELHLD    ACCHLD 309                      136935
      *
      ***  Else, if Convertible/Keep work field not 'K' (no conversion), set % to be converted to 0.
      ***  and Accept on Holding to 0.                                    136935
      *
     C                     ELSE
     C                     Z-ADD0         PETBCO           % to be converted
     C                     Z-ADD0         ACCHLD                          136935
     C                     ENDIF
      *
      *****Calculate*Nominal*to*be*converted*=*Ex-Date*Position********** 136935
      *****multiplied*by*%*to*be*converted.****************************** 136935
      ***  Calculate Nominal to be converted = Accept on Holding          136935
      ***  multiplied by % to be converted.                               136935
      *
     C******     WWTDVD    MULT PETBCO    NMTBCO 309                      136935
     C           ACCHLD    MULT PETBCO    NMTBCO 309                      136935
     C           NMTBCO    DIV  100       NMTBCO           Nominal to be converted
      *
      ***  Calculate Cash Pool = Nominal to be converted multiplied by Conversion Price multiplied
      ***  by Exchange Rate.
      *
     C           NMTBCO    MULT MJCPRC    CASPOW 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           CASPOW    DIV  100       CASPOW    H
     C                     ENDIF
     C           CASPOW    MULT MJCEXR    CASPOO 309       Cash Pool
     C                     ENDIF
      *
      ***  Calculate work field BB = Cash Pool divided by Subscription Price.
      *
     C           CASPOO    DIV  MDSBPR    FLDBB  309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           FLDBB     DIV  100       FLDBB     H
     C                     ENDIF
      *
      ***  Calculate work field B = work field BB rounded down if Rounding Indicator from Corporate
      ***  Actions Details file = 'D' or half adjust if Rounding = 'R' (rounded is perform to
      ***  Number of Decimal Places of New Security).
      *
     C                     Z-ADDFLDBB     WWNUM
     C                     MOVE WWRNDN    WUROOP
     C                     Z-ADDNSNBDP    WWNBDP
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     FLDB   309
      *
      ***  Calculate work field C = work field B divided by Denomination Multiplier.
      *
     C           FLDB      DIV  WWDMLT    FLDC   309
      *
      ***  Calculate work field CA = work field C rounding down to nearest unit if Rounding
      ***  Indicator from Corporate Actions Detail file = 'D' or half adjust to nearest unit
      ***  if Rounding = 'R'.
      *
     C           WWRNDN    IFEQ 'D'
     C           WWRNDN    OREQ 'U'                                       135686
     C                     Z-ADDFLDC      FLDCA
     C                     ELSE
     C                     Z-ADDFLDC      FLDCA     H
     C                     ENDIF
      *
      ***  Calculate Original Stock Allocation = work field CA multiplied by Denomination
      ***  Multiplier.
      *
     C           FLDCA     MULT WWDMLT    WWOALR
      *                                                                   135686
     C           WWRNDN    IFEQ 'U'                                       135686
     C           WWOALR    ANDNEFLDB                                      135686
     C                     ADD  WWDMLT    WWOALR                          135686
     C                     ENDIF                                          135686
      *
      ***  Set Original Stock Allocation calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWOALR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOALR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CTSA2  - 2nd calculation of True Stock Allocation.            *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CTSA2     BEGSR                           ** CTSA2 SR **
      *
      ***  Calculate True Stock Allocation = work field BB calculated previously.
      *
     C                     Z-ADDFLDBB     WWOTSA
      *
      ***  Set True Stock Allocation calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     Z-ADD8         WWNBDP           Decimal Places = 8
     C                     Z-ADDWWOTSA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOTSA
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * COCR2  - 2nd calculation of Original Cash Rounding.           *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           COCR2     BEGSR                           ** COCR2 SR **
      *
      ***  If Rounding Settlement in Cash = 'Y', Original Cash Rounding = (Holding (Ex-Date
      ***  Position) multiplied by Dividend Per Unit) - (Original Stock Allocation previously
      ***  calculated multiplied by Subscription Price).
      ***  Use Conversion Price multiplied by Exchange Rate instead of    136935
      ***  Dividend Per Unit if Processing Type = Exercices and           136935
      ***  Conversions (= if not 'DV').                                   136935
      *
     C           WWRNDS    IFEQ 'Y'
     C           MAPTYP    IFEQ 'DV'                                      136935
     C******               Z-ADDNSNBDP    WWNBDP                          135690
     C**********           Z-ADDNCNBDP    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM            13,8 => 30,9   190204
     C           WWTDVD    MULT WWNUM     FLDGW  309
     C                     ELSE                                           136935
     C           WWTDVD    MULT MJCPRC    FLDGW                           136935
     C           FLDGW     MULT MJCEXR    FLDGW                           136935
     C                     ENDIF                                          136935
     C           WWOALR    MULT MDSBPR    WUOCAR 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           WUOCAR    DIV  100       WUOCAR
     C                     ENDIF
     C           FLDGW     SUB  WUOCAR    WWOCAR
      *
      ***  Set Original Cash Rounding calculated.
      *
     C                     Z-ADDNCNBDP    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWWOCAR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWOCAR
      *
      ***  Else, If Rounding Settlement in Cash not equal 'Y', set Original Cash Rounding
      ***  to zero.
      *
     C                     ELSE
     C                     Z-ADD0         WWOCAR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CASADP - Calculate Actual Stock Allocation for Depot.         *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CASADP    BEGSR                           ** CASADP SR **
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'O'                           Stk Dividend Tp=Optional for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'CR'                       Or Proces.Type = Corporate Reorganisation
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      ******                                                              136935
     C******     MAPTYP    OREQ 'OF'                       Or Exchange    136935
     C******     MIOFTY    ANDEQ'E'                           Offer       136935
     C******     MDOSHA    ANDNE0                             Old Sh.not 0136935
     C******     WWNSHA    ANDNE0                             New Sh.not 0136935
      ******                                                              136935
     C******     MAPTYP    OREQ 'OF'                       Or Subscript.  136935
     C******     MIOFTY    ANDEQ'S'                           Offers      136935
     C******     MDOSHA    ANDNE0                             Old Sh.not 0136935
     C******     WWNSHA    ANDNE0                             New Sh.not 0136935
      *                                                                   156690
     C           MAPTYP    OREQ 'OF'                       Or Exchange    156690
     C           MIOFTY    ANDEQ'E'                           Offer       156690
     C           MDOSHA    ANDNE0                             Old Sh.not 0156690
     C           WWNSHA    ANDNE0                             New Sh.not 0156690
      *                                                                   156690
     C           MAPTYP    OREQ 'OF'                       Or Subscript.  156690
     C           MIOFTY    ANDEQ'S'                           Offers      156690
     C           MDOSHA    ANDNE0                             Old Sh.not 0156690
     C           WWNSHA    ANDNE0                             New Sh.not 0156690
      *
     C           MAPTYP    OREQ 'EX'                       Or Proces.Type= Exercices and Conversion
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
     C*****      MDSBPR    ANDNE0                             Subscription136935
      *
     C           MAPTYP    OREQ 'FR'                       Or Processing Type = Free Allocation
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *                                                                   CEU017
      ***  Or Processing Type = Currency Changes and Old and New Nominal  CEU017
      ***  Size not zero.                                                 CEU017
      *                                                                   CEU017
     C           MAPTYP    OREQ 'CC'                                      CEU017
     C           MDOSHA    ANDNE0                                         CEU017
     C           WWNSHA    ANDNE0                                         CEU017
      *                                                                                       193662
     C           MAPTYP    IFEQ 'OF'                                                          193662
     C           MIOFTY    ANDEQ'S'                                                           193662
     C                     Z-ADDWTHOST    WWASTA                                              193662
     C                     Z-ADDWWASTA    WUASTA                                              193662
     C                     ELSE                                                               193662
      *
      ***  Calculate work field A = Total Holding Taken as Stock calculated before divided by
      ***  Number of Old Shares.
      *
     C           WTHOST    DIV  MDOSHA    FLDA   309
      *
      ***  Calculate work field AA = work field A rounded down if Rounding Indicator from Corporate
      ***  Actions Details file = 'D' or half adjust if Rounding = 'R' (rounded is perform to
      ***  Number of Decimal Places of New Security).
      *
     C                     Z-ADDFLDA      WWNUM
     C                     Z-ADDNSNBDP    WWNBDP
     C                     MOVE WWRNDN    WUROOP  1
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     FLDAA  309
      *
      ***  Calculate work field B = work field AA multiplied by Number of New Shares.
      *
     C           WWRNDN    IFEQ 'B'                                       149153
     C           1         MULT WWNSHA    FLDB                            149153
     C                     ELSE                                           149153
     C********** FLDAA     MULT WWNSHA    FLDB                            161419
     C           FLDA      MULT WWNSHA    FLDB                            161419
     C                     ENDIF                                          149153
      *
      ***  Calculate work field C = work field B divided by Denomination Multilier.
      *
     C           FLDB      DIV  WWDMLT    FLDC   309
      *
      ***  Calculate work field CA = work field C rounded down to nearest unit if Rounding Indicator
      ***  from CO Details file = 'D' or half adjust to nearest unit if Rounding = 'R'.
      *
     C           WWRNDN    IFEQ 'D'
     C           WWRNDN    OREQ 'U'                                       135686
     C           WWRNDN    OREQ 'B'                                       149153
     C           WWRNDN    OREQ 'O'                                       149782
     C                     Z-ADDFLDC      FLDCA
     C                     ELSE
     C                     Z-ADDFLDC      FLDCA     H
     C                     ENDIF
      *
      ***  Calculate Actual Stock Allocation = work field CA multiplied by Denomination
      ***  Multiplier.
      *
     C           FLDCA     MULT WWDMLT    WWASTA
      *                                                                   135686
     C           WWRNDN    IFEQ 'U'                                       135686
     C           WWASTA    ANDNEFLDB                                      135686
     C                     ADD  WWDMLT    WWASTA                          135686
     C                     ENDIF                                          135686
      *                                                                   149153
     C           WWRNDN    IFEQ 'B'                                       149153
     C           WWASTA    MULT FLDAA     WWASTA                          149153
     C                     ENDIF                                          149153
      *                                                                                       193662
     C                     ENDIF                                                              193662
      *
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C********** MDDIVU    ANDNE0                             Dividend per Unit not zero      190204
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      190204
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
     C           MAPTYP    OREQ 'DV'                       If Processing Type = Div Events    215071
     C           MDSDIT    ANDEQ'O'                           Stock Div Tp=Opt for cash stock 215071
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      215071
     C           MDSBPR    ANDNE0                             Subscription Price not zero     215071
      *                                                                                       215071
      ***  Calculate Cash Pool = Total Holding Taken as Stock previously calculated multiplied by
      ***  Dividend Per Unit.
      *
     C******               Z-ADDTSDP,I    WWNBDP                          135690
     C**********           Z-ADDTCDP,I    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM            13,8 ==> 30,9  190204
     C           WTHOST    MULT WWNUM     CASPOO 309
      *
      ***  Calculate work field BB = Cash Pool divided by Subscription Price.
      *
     C           CASPOO    DIV  MDSBPR    FLDBB  309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           FLDBB     DIV  100       FLDBB     H
     C                     ENDIF
      *
      ***  Calculate work field B = work field BB rounded down if Rounding Indicator from Corporate
      ***  Actions Details file = 'D' or half adjust if Rounding = 'R' (rounded is perform to
      ***  Number of Decimal Places of New Security).
      *
     C                     Z-ADDFLDBB     WWNUM
     C                     MOVE WWRNDN    WUROOP
     C                     Z-ADDNSNBDP    WWNBDP
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     FLDB   309
      *
      ***  Calculate work field C = work field B divided by Denomination Multiplier.
      *
     C           FLDB      DIV  WWDMLT    FLDC   309
      *
      ***  Calculate work field CA = work field C rounded down to nearest unit if Rounding Indicator
      ***  from CO Details file = 'D' or half adjust to nearest unit if Rounding = 'R'.
      *
     C           WWRNDN    IFEQ 'D'
     C           WWRNDN    OREQ 'U'                                       135686
     C                     Z-ADDFLDC      FLDCA
     C                     ELSE
     C                     Z-ADDFLDC      FLDCA     H
     C                     ENDIF
      *
      ***  Calculate Actual Stock Allocation = work field CA multiplied by Denomination
      ***  Multiplier.
      *
     C           FLDCA     MULT WWDMLT    WWASTA
      *                                                                   135686
     C           WWRNDN    IFEQ 'U'                                       135686
     C           WWASTA    ANDNEFLDB                                      135686
     C                     ADD  WWDMLT    WWASTA                          135686
     C                     ENDIF                                          135686
      *
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'R'                           Stk Dividend Tp=Reinvestment of Divid.
     C********** MDDIVU    ANDNE0                             Dividend per Unit not zero      190204
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      190204
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
     C           MAPTYP    OREQ 'EX'                       Or Proces.Type= Exercices and Conversion
     C           MJCPRC    ANDNE0                             Conversion Price not zero
     C           MJCEXR    ANDNE0                             Exchange Rate not zero
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *                                                                   136935
     C           MAPTYP    OREQ 'OF'                       Or Purchase    136935
     C           MIOFTY    ANDEQ'P'                           Offer       136935
      *
      ***  Calculate Actual Stock Allocation = Total of all Actual Stock Allocation for all
      ***  Customer/Books, and accumulate Actual Stock Allocation.
      *
     C                     Z-ADDWTASTA    WWASTA
     C                     ADD  WWASTA    TWASTA 309
     C                     ENDIF
      *****                                                        136935 156690
      *****If*Processing*Type*=*Offers*with*Offer*Type*=*Subscripti136935 156690
      *****Exchange,*calculate*Actual*Stock*Allocation*=*Original*S136935 156690
      *****Allocation*previously*calculated*multiplied*by*Stock*Pre136935 156690
      *****%.******************************************************136935 156690
      *****                                                        136935 156690
     C*****      MAPTYP    IFEQ 'OF'                               136935 156690
     C*****      MIOFTY    ANDEQ'S'                                136935 156690
     C*****      MAPTYP    OREQ 'OF'                               136935 156690
     C*****      MIOFTY    ANDEQ'E'                                136935 156690
     C*****      100       SUB  WCAPR     WSTPR                    136935 156690
     C*****      WWOALR    MULT WSTPR     WWASTA                   136935 156690
     C*****      WWASTA    DIV  100       WWASTA                   136935 156690
     C*****                Z-ADDWWASTA    WUASTA                   136935 156690
     C*****                ENDIF                                   136935 156690
      *
      ***  Set Actual Stock Allocation calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP
     C                     MOVE WWRNDN    WUROOP
     C                     Z-ADDWWASTA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWASTA
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CHSTDP - Calculate Holding Taken as Stock for Depot.          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CHSTDP    BEGSR                           ** CHSTDP SR **
      *
      ***  Calculate Holding Taken as Stock = Total of all Customers and Books Holdings Taken
      ***  as Stock calculated, and save value.
      *
     C                     Z-ADDWTHOST    WWHOST
     C                     Z-ADDWWHOST    WUHOST
      *
      ***  Set Holding Taken as Stock calculated.
      *
     C                     Z-ADDESNBDP    WWNBDP
     C                     MOVE WWRNDN    WUROOP
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOST
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CHCADP - Calculate Holding Taken as Cash for Depot.           *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CHCADP    BEGSR                           ** CHCADP SR **
      *
      ***  Calculate Holding Taken as Cash = Total of all Customers and Books Holdings Taken
      ***  as Cash calculated, and save value.
      *
     C                     Z-ADDWTHOCA    WWHOCA
     C                     Z-ADDWWHOCA    WUHOCA
      *
      ***  Set Holding Taken as Cash calculated.
      *
     C                     Z-ADDNCNBDP    WWNBDP
     C                     MOVE 'R'       WUROOP
     C                     Z-ADDWWHOCA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOCA
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CASRDP - Calculate Actual Stock Rounding for Depot.           *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CASRDP    BEGSR                           ** CASRDP SR **
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'R'                           Stk Dividend Tp=Reinvestment of Divid.
     C********** MDDIVU    ANDNE0                             Dividend per Unit not zero      190204
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      190204
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
     C           MAPTYP    OREQ 'EX'                       Or Proces.Type= Exercices and Conversion
     C           MJCPRC    ANDNE0                             Conversion Price not zero
     C           MJCEXR    ANDNE0                             Exchange Rate not zero
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
      ***  Set Actual Stock Rounding to 0.
      *
     C                     Z-ADD0         WWASTR
      *
     C                     ELSE
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'O'                           Stk Dividend Tp=Optional for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'CR'                       Or Proces.Type = Corporate Reorganisation
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'OF'                       Or Processing Type = Offers
     C           MIOFTY    ANDEQ'E'                           Offer Type = Exchange Offers
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
      ******                                                              136935
     C******     MAPTYP    OREQ 'OF'                       Or Subscript.  136935
     C******     MIOFTY    ANDEQ'S'                           Offers      136935
     C******     MDOSHA    ANDNE0                             Old Sh.not 0136935
     C******     WWNSHA    ANDNE0                             New Sh.not 0136935
      *
     C           MAPTYP    OREQ 'EX'                       Or Proces.Type= Exercices and Conversion
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
     C*****      MDSBPR    ANDNE0                             Subscription136935
      *
     C           MAPTYP    OREQ 'FR'                       Or Processing Type = Free Allocation
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *                                                                   CEU017
      ***  Or Processing Type = Currency Changes and Old and New Nominal  CEU017
      ***  Size not zero.                                                 CEU017
      *                                                                   CEU017
     C           MAPTYP    OREQ 'CC'                                      CEU017
     C           MDOSHA    ANDNE0                                         CEU017
     C           WWNSHA    ANDNE0                                         CEU017
      *
      ***  Calculate work field A = Total of all Customers and Books Holdings Taken as Stock
      ***  divided by Number of Old Shares.
      *
     C           WTHOST    DIV  MDOSHA    FLDA   309
      *
      ***  Calculate True Stock Allocation (using Total of all Customers and Books Holdings Taken
      ***  as Stock as Holding) = work field A previously calculated multiplied by Number of New
      ***  Shares.
      *
     C           FLDA      MULT WWNSHA    WUOTSA 309
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C********** MDDIVU    ANDNE0                             Dividend per Unit not zero      190204
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      190204
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
     C           MAPTYP    OREQ 'DV'                       If Processing Type = Div Events    215071
     C           MDSDIT    ANDEQ'O'                           Stock Div Tp=Opt for cash stock 215071
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      215071
     C           MDSBPR    ANDNE0                             Subscription Price not zero     215071
      *                                                                                       215071
      ***  Calculate Cash Pool = Total of all Customers and Books Holdings Taken as Stock multiplied
      ***  by Dividend Per Unit.
      *
     C******               Z-ADDNSNBDP    WWNBDP                          135690
     C**********           Z-ADDNCNBDP    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM            13,8 ==> 30,9  190204
     C           WTHOST    MULT WWNUM     CASPOO 309
      *
      ***  Calculate work field BB = Cash Pool divided by Subscription Price.
      *
     C           CASPOO    DIV  MDSBPR    FLDBB  309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           FLDBB     DIV  100       FLDBB     H
     C                     ENDIF
      *
      ***  Set True Stock Allocation (using Total of all Customers and Books Holdings Taken
      ***  as Stock as Holding) = work field BB previously calculated.
      *
     C                     Z-ADDFLDBB     WUOTSA
     C                     ENDIF
      *
      ***  Calculate Actual Stock Rounding = True Stock Allocation (using Total of all Customers and
      ***  Books Holdings Taken as Stock) - Actual Stock Allocation previously calculated.
      *
     C           WUOTSA    SUB  WWASTA    WWASTR
     C                     ENDIF
      *
      ***  Set Actual Stock Rounding calculated.
      *
     C                     Z-ADD8         WWNBDP
     C                     MOVE WWRNDN    WUROOP
     C                     Z-ADDWWASTR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWASTR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CACRDP - Calculate Actual Cash Rounding for Depot.            *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CACRDP    BEGSR                           ** CACRDP SR **
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'O'                           Stk Dividend Tp=Optional for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'FR'                       Or Processing Type = Free Allocation
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'CR'                       Or Proces.Type = Corporate Reorganisation
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'OF'                       Or Processing Type = Offers
     C           MDOSHA    ANDNE0                             Number of Old Shares not zero
     C           WWNSHA    ANDNE0                             Number of New Shares not zero
      *
     C           MAPTYP    OREQ 'EX'                       Or Proces.Type= Exervices and Conversions
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
     C*****      MDSBPR    ANDNE0                             Subscription136935
      *                                                                   CEU017
      ***  Or Processing Type = Currency Changes and Old and New Nominal  CEU017
      ***  Size not zero.                                                 CEU017
      *                                                                   CEU017
     C           MAPTYP    OREQ 'CC'                                      CEU017
     C           MDOSHA    ANDNE0                                         CEU017
     C           WWNSHA    ANDNE0                                         CEU017
      *
      ***  If Rounding Settlement in Cash = 'Y', calculate Actual Cash Rounding = Actual Stock
      ***  Rounding previously calculated multiplied by Compensation Price.
      *
     C           WWRNDS    IFEQ 'Y'
     C           WWASTR    MULT WWCOMP    WWACAR 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           WWACAR    DIV  100       WWACAR
     C                     ENDIF
      *
      ***  Else, If Rounding Settlement in Cash not equal 'Y', set Actual Cash Rounding to 0.
      *
     C                     ELSE
     C                     Z-ADD0         WWACAR
     C                     ENDIF
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C********** MDDIVU    ANDNE0                             Dividend Per Unit not zero      190204
     C           MDDIV1    ANDNE0                             Dividend Per Unit not zero      190204
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
     C           MAPTYP    OREQ 'DV'                       If Processing Type = Div Events    215071
     C           MDSDIT    ANDEQ'O'                           Stock Div Tp=Opt for cash stock 215071
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      215071
     C           MDSBPR    ANDNE0                             Subscription Price not zero     215071
      *                                                                                       215071
      ***  If Rounding Settlement in Cash = 'Y', calculate Actual Cash Rounding = (Holding Taken as
      ***  Stock previously calculated multiplied by Dividend Per Unit) - (Actual Stock Allocation
      ***  previously calculated multiplied by Subscription Price).
      *
     C           WWRNDS    IFEQ 'Y'
     C******               Z-ADDNSNBDP    WWNBDP                          135690
     C**********           Z-ADDNCNBDP    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM            13,8 => 30,9   190204
     C           WWHOST    MULT WWNUM     W1ACAR
     C           WWASTA    MULT MDSBPR    W2ACAR
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           W2ACAR    DIV  100       W2ACAR
     C                     ENDIF
     C           W1ACAR    SUB  W2ACAR    WWACAR
      *
      ***  Else, If Rounding Settlement in Cash not equal 'Y', set Actual Cash Rounding to 0.
      *
     C                     ELSE
     C                     Z-ADD0         WWACAR
     C                     ENDIF
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'CE'                       If Processing Type = Capital Changes
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'R'                           Stk Dividend Tp=Combined for Cash&Stk
     C********** MDDIVU    ANDNE0                             Dividend Per Unit not zero      190204
     C           MDDIV1    ANDNE0                             Dividend Per Unit not zero      190204
     C           MDSBPR    ANDNE0                             Subscription Price not zero
      *
     C           MAPTYP    OREQ 'EX'                       Or Processing Type = Dividends Events
     C           MJCPRC    ANDNE0                             Conversion Price not 0
     C           MJCEXR    ANDNE0                             Conversion Exchange Rate not 0
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
      ***  Set Actual Cash Rounding to 0.
      *
     C                     Z-ADD0         WWACAR
     C                     ENDIF
      *                                                                   161732
      ** If Processing Type = Exercise and Conversions, and Option for    161732
      ** Allocation = '6', zeroise Actual Cash Rounding.                  161732
      *                                                                   161732
     C           MAPTYP    IFEQ 'EX'                                      161732
     C           WWOPT2    ANDEQ'6'                                       161732
     C                     Z-ADD0         WWACAR                          161732
     C                     ENDIF                                          161732
      *
      ***  Set Actual Cash Rounding calculated.
      *
     C                     Z-ADDNCNBDP    WWNBDP
     C                     MOVE 'R'       WUROOP
     C                     Z-ADDWWACAR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWACAR
      *
      ***  Accumulate Actual Cash Rounding.
      *
     C                     ADD  WWACAR    TWACAR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CCAOPT - Calculate Cash Option.                               *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CCAOPT    BEGSR                           ** CCAOPT SR **
      *
      *****If*Processing*Type*=*Offers*and*Offer*Type*=*Exchange*Offers** 136935
      *****or*Purchase*Offer,******************************************** 136935
      ***  If Processing Type = Offers and Offer Type = Exchange Offers,  136935
      ***  calculate Cash Option = Ex-Date Position multiplied by Receive Price.
      *
     C           MAPTYP    IFEQ 'OF'
     C           MIOFTY    ANDEQ'E'
     C******     MAPTYP    OREQ 'OF'                                      136935
     C******     MIOFTY    ANDEQ'P'                                       136935
     C           WWTDVD    MULT MIREPR    WWCAOP
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           TSPB,1    IFEQ 'P'
     C           WWCAOP    DIV  100       WWCAOP
     C                     ENDIF
     C                     ELSE
      *
      ***  If Processing Type = Offers and Offer Type = Subsrciption Offer,
      ***  calculate Cash Option = total Original Stock allocation        136935
      ***  previously calculatecalculated multiplied by Subscription      136935
      ***  Price.                                                         136935
      *****calculate*Cash*Option*=*Ex-Date*Position*multiplied*by******** 136935
      *****Subscription*Price.******************************************* 136935
      *
     C           MAPTYP    IFEQ 'OF'
     C           MIOFTY    ANDEQ'S'
     C           MAPTYP    OREQ 'EX'                                      219579
     C           WWOPT2    ANDEQ'4'                                       219579
     C******     WWTDVD    MULT MISUPR    WWCAOP                          136935
     C           WUOALR    MULT MISUPR    WWCAOP                          136935
     C           MAPTYP    IFEQ 'EX'                                      219579
     C           WWTDVD    MULT MDSBPR    WWCAOP                          219579
     C                     END                                            219579
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           TSPB,1    IFEQ 'P'
     C           WWCAOP    DIV  100       WWCAOP
     C                     ENDIF
     C                     ELSE
      *                                                                   136935
      ***  If Processing Type = Offers and Offer Type = Purchase Offer,   136935
      ***  calculate Cash Option = total Original Stock allocation        136935
      ***  previously calculatecalculated multiplied by Recieve Price.    136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'P'                                       136935
     C********** WUOALR    MULT MISUPR    WWCAOP                                       136935 193662
     C           WUOALR    MULT MIREPR    WWCAOP                                              193662
      *                                                                   136935
      ***  If Price Basis is 'P' for %, result should be divided by 100.  136935
      *                                                                   136935
     C           TSPB,1    IFEQ 'P'                                       136935
     C           WWCAOP    DIV  100       WWCAOP                          136935
     C                     ENDIF                                          136935
     C                     ELSE                                           136935
      *
      ***  If Processing Type = Dividends Events or Capital Changes or Corporate Reorganistion,
      ***  calculate Cash Option = Holding (=Ex-Date Position) multiplied by Dividend Per Unit
      ***  (for Capital Change, used Cash Repaid instead of Dividend Per Unit, and for Corporate
      ***  Reorganistion, used Cash Payment instead of Dividend Per Unit).
      *
     C           MAPTYP    IFEQ 'DV'                       If Dividend Events
     C           MAPTYP    OREQ 'CE'                       Or Capital Changes
     C           MAPTYP    OREQ 'CR'                       Or Corporate Reorganisation
     C           MAPTYP    IFEQ 'CR'                                      136935
     C           MDOSHA    ANDNE*ZEROS                                    136935
     C           WWTDVD    DIV  MDOSHA    WWCAOP                          136935
     C                     MULT WWDIVU    WWCAOP                          136935
     C                     ELSE                                           136935
     C           WWTDVD    MULT WWDIVU    WWCAOP
     C                     ENDIF                                          136935
     C                     ENDIF
     C                     ENDIF                                          136935
     C                     ENDIF
     C                     ENDIF
      *
      ***  Set Original Cash Option calculated.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWWCAOP    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWCAOP
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CACABC - Calculate Actual Cash Allocation for Book/Customer.  *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CACABC    BEGSR                           ** CACABC SR **
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividend Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C           MAPTYP    OREQ 'FR'                       Or Processing Type = free Allocation
     C           MAPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
     C           MAPTYP    OREQ 'NF'                       Or Processing Type = Non financial Events
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
     C           MAPTYP    OREQ 'CC'                       Or Ccy Changes CEU017
     C           MAPTYP    OREQ 'EX'                       Or Exercices and Conversions
     C******     MJOPT7    ANDEQ'Y'                           Cust.Opt. 7 136935
     C           WWOPT2    ANDEQ'7'                           Opt.Alloc=7 136935
      *
      ***  Set Actual Cash Allocation to zero.
      *
     C                     Z-ADD0         WWACAA 309
     C                     ELSE
      *
      ***  Else, if Processing Type = Capital Changes or Corporate Reorganisation, calculate
      ***  Actual Cash Allocation = Current Holding (Ex-Date Position) multiplied by Cash Repaid
      ***  (if Processing Type = Capital Change) or Cash Payment (if Processing Type = Corporate
      ***  Reorganisation).
      *
     C           MAPTYP    IFEQ 'CE'                       If Capital Changes
     C           MAPTYP    OREQ 'CR'                       Or Corporate Reorganisation
     C           MAPTYP    IFEQ 'CR'                                      136935
     C           MDOSHA    ANDNE*ZEROS                                    136935
     C           WWTDVD    DIV  MDOSHA    WWACAA                          136935
     C                     MULT WWDIVU    WWACAA                          136935
     C                     ELSE                                           136935
     C           WWTDVD    MULT WWDIVU    WWACAA
     C                     ENDIF                                          136935
     C                     ELSE
      *
      *****If*Processing*Type*=*Offers*with*Offer*Type*=*Exchange*or***** 136935
      *****Subscription,************************************************* 136935
      ***  If Processing Type = Offers with Offer Type = Exchange,        136935
      ***  calculate Actual Cash Allocation = Holding Taken as stock previously calculated
      ***  multiplied by Receive Price.                                   136935
      *****multiplied*by*Receive*Price*(if*Offer*Type*=*Excahnge*Offers)* 136935
      *****or*Subscription*Price*(if*Offer*Type*=*Subscription*Price).*** 136935
      *
     C           MAPTYP    IFEQ 'OF'                       If Exchange Offers
     C           MIOFTY    ANDEQ'E'
     C******     MAPTYP    OREQ 'OF'                       Or Subscript.  136935
     C******     MIOFTY    ANDEQ'S'                           Offers      136935
     C           WWHOST    MULT WWDIVU    WWACAA
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           TSPB,1    IFEQ 'P'
     C           WWACAA    DIV  100       WWACAA
     C                     ENDIF
     C                     ELSE
      *                                                                   136935
      ***  If Processing Type = Offers with Offer Type = Subscription,    136935
      ***  calculate Actual Cash Allocation = Actual Stock Allocation     136935
      ***  multiplied by Subscription Price.                              136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C           WUASTA    MULT WWDIVU    WWACAA                          136935
      *                                                                   136935
      ***  If Price Basis is 'P' for %, result should be divided by 100.  136935
      *                                                                   136935
     C           TSPB,1    IFEQ 'P'                                       136935
     C           WWACAA    DIV  100       WWACAA                          136935
     C                     ENDIF                                          136935
     C                     ELSE                                           136935
      *                                                                   136935
      ***  If Processing Type = Offers with Offer Type = Purchase,        136935
      ***  calculate Actual Cash Allocation = total (Original Stock       136935
      ***  Allocation multiplied by Cash Preferred %) multiplied by       136935
      ***  Receive Price.                                                 136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'P'                                       136935
     C           W2OALR    MULT WWDIVU    WWACAA                          136935
     C           MQR2CN    IFNE 0                                         219976
     C           MQR2CN    MULT MIREPR    WWACAA                          219976
     C                     END                                            219976
      *                                                                   136935
      ***  If Price Basis is 'P' for %, result should be divided by 100.  136935
      *                                                                   136935
     C           TSPB,1    IFEQ 'P'                                       136935
     C           WWACAA    DIV  100       WWACAA                          136935
     C                     ENDIF                                          136935
     C                     ELSE                                           136935
      *
      *****If*Processing*Type*=*Exercices*and*Conversions*and*Customer*** 136935
      *****Option*1,*2,*3,*4,*5*or*6*is*allowed,************************* 136935
      *****If*Processing*Type*=*Exercices*and*Conversions*and*Opti 136935 161732
      *****Allocation*2*=*'1',*'2',*'3',*'4',*'5'*or*'6',********* 136935 161732
      *****calculate*Actual*Cash*Allocation*=*Holding*Taken*as*Cash*previ 161732
      *****by*Subscription*Price.**************************************** 161732
      ** If Processing Type = Exercices and Conversions and Option for    161732
      ** Allocation 2 = '1', '2', '3', '4', or '5', calculate Actual      161732
      ** Cash Allocation = Holding Taken as Cash previously calculated    161732
      ** multiplied by Receive/Cash Price.                                161732
      *
     C           MAPTYP    IFEQ 'EX'                       If Exercices and Conversions
     C******     MJOPT1    IFEQ 'Y'                           Cust.Opt. 1 136935
     C******     MJOPT2    OREQ 'Y'                           Cust.Opt. 2 136935
     C******     MJOPT3    OREQ 'Y'                           Cust.Opt. 3 136935
     C******     MJOPT4    OREQ 'Y'                           Cust.Opt. 4 136935
     C******     MJOPT5    OREQ 'Y'                           Cust.Opt. 5 136935
     C******     MJOPT6    OREQ 'Y'                           Cust.Opt. 6 136935
     C           WWOPT2    IFEQ '1'                                       136935
     C           WWOPT2    OREQ '2'                                       136935
     C           WWOPT2    OREQ '3'                                       136935
     C           WWOPT2    OREQ '4'                                       136935
     C           WWOPT2    OREQ '5'                                       136935
     C***********WWOPT2    OREQ '6'                                136935 161732
     C***********WWHOCA    MULT MDSBPR    WWACAA                          161732
     C           WWHOCA    MULT MDRCPR    WWACAA                          161732
      *                                                                   219579
     C           WWOPT2    IFEQ '4'                                       219579
     C           WWHOCA    MULT MDSBPR    WWACAA                          219579
     C                     END                                            219579
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           TSPB,1    IFEQ 'P'
     C           WWACAA    DIV  100       WWACAA
     C                     ENDIF
      *                                                                   161732
      ** Else, if Processing Type = Exercises and Conversions, and        161732
      ** Option for Allocation 2 = '6', zeroise Actual Cash Allocation    161732
      *                                                                   161732
     C                     ELSE                                           161732
     C           WWOPT2    IFEQ '6'                                       161732
     C                     Z-ADD0         WWACAA                          161732
     C                     ENDIF                                          161732
     C                     ENDIF
     C                     ELSE
      *
      ***  If Processing Type = Dividend Events and Stock Dividend Type = 'R' as Reinvestment of
      ***  Dividend, calculate Actual Cash Allocation = Original Cash Option - Actual Cash Pool.
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividend Events
     C           MDSDIT    ANDEQ'R'                           Stk Dividend Tp=Reinvestment of Divid.
     C           WWCAOP    SUB  ACCAPO    WWACAA
     C                     ELSE
      *
      ***  Else, calculate Actual Cash Allocation = Holding Taken as Cash calculated before
      ***  multiplied by Dividend Per Unit (if Processing Type = Dividends Events) or Cash Payment
      ***  (if Processing Type = Corporate Reorganisation).
      *
     C           WWHOCA    MULT WWDIVU    WWACAA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Set Actual Cash Allocation calculated.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWWACAA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWACAA
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CACADP - Calculate Actual Cash Allocation for Depot.          *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CACADP    BEGSR                           ** CACADP SR **
      *
      ***  Reset work field.
      *
     C                     Z-ADD0         WWACAA
      *
     C           MAPTYP    IFEQ 'DV'                       If Dividend Events
     C           MDSDIT    ANDEQ'S'                           Stock for Stock
     C           MAPTYP    OREQ 'FR'                       Or Free Allocation
     C           MAPTYP    OREQ 'RG'                       Or Rights Issues
     C           MAPTYP    OREQ 'NF'                       Or Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Name Changes
     C           MAPTYP    OREQ 'CC'                       Or Ccy Changes CEU017
      *
      ***  Set Actual Cash Allocation to zero.
      *
     C                     Z-ADD0         WWACAA
     C                     ELSE
      *
      ***  Else, if Processing Type = Capital Changes or Corporate Reorganisation, calculate
      ***  Actual Cash Allocation = Current Holding (Ex-Date Position) multiplied by Cash Repaid
      ***  (if Processing Type = Capital Change) or Cash Payment (if Processing Type = Corporate
      ***  Reorganisation).
      *
     C           MAPTYP    IFEQ 'CE'                       If Capital Changes
     C           MAPTYP    OREQ 'CR'                       Or Corporate Reorganisation
     C           MAPTYP    IFEQ 'CR'                                      136935
     C           MDOSHA    ANDNE*ZEROS                                    136935
     C*****      WWTDVD    DIV  MDOSHA    WWACAA                   136935 157229
     C           WWHOST    DIV  MDOSHA    WWACAA                          157229
     C                     MULT WWDIVU    WWACAA                          136935
     C                     ELSE                                           136935
     C           WWTDVD    MULT WWDIVU    WWACAA
     C                     ENDIF                                          136935
     C                     ELSE
      *                                                                   136935
      ***  Else, if Processing Type = Offers with Offer Type =            136935
      ***  Subscription, calculate Actual Cash Allocation = Actual Stock  136935
      ***  Allocation multiplied by Subscription Price.                   136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C           WUASTA    MULT WWDIVU    WWACAA                          136935
      *                                                                   136935
      ***  If Price Basis is 'P' for %, result should be divided by 100.  136935
      *                                                                   136935
     C           TSPB,1    IFEQ 'P'                                       136935
     C           WWACAA    DIV  100       WWACAA                          136935
     C                     ENDIF                                          136935
     C                     ELSE                                           136935
      *                                                                   136935
      ***  Else, if Processing Type = Offers with Offer Type =            136935
      ***  Purchase, calculate Actual Cash Allocation = Actual Cash       136935
      ***  Allocation accumulated.                                        136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'P'                                       136935
     C                     Z-ADDWTACAA    WWACAA                          136935
     C                     ELSE                                           136935
      *
      *****Else,*if*Processing*Type*=*Offers,*calculate*Actual*Cash****** 136935
      *****Allocation*=*Holding*Taken*as*Stock*previously*calculated***** 136935
      *****multiplied*by*Receive*Price*(if*Offer*Type*=*Excahnge*Offers** 136935
      *****or*Purchase*Offer)*or*Subscription*Price*(if*Offer*Type*=***** 136935
      *****Subscription).************************************************ 136935
      ***  Else, if Processing Type = Offers with Offer Type = Exchange,  136935
      ***  calculate Actual Cash Allocation = Holding Taken as Stock      136935
      ***  previously calculated multiplied by Receive Price.             136935
      *
     C           MAPTYP    IFEQ 'OF'                       If Offers
     C           MIOFTY    ANDEQ'E'                           Exchange    136935
     C           WWHOST    MULT WWDIVU    WWACAA
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           TSPB,1    IFEQ 'P'
     C           WWACAA    DIV  100       WWACAA
     C                     ENDIF
     C                     ELSE
      *
      ***  Else, if Processing Type = Exercices and Conversions, calculate Actual Cash Allocation =
      *****Holding*Taken*as*Cash*previously*calculated*multiplied*by*Subsc161732
      ** Holding Taken as Cash previously calculated multiplied by        161732
      ** Receive/Cash Price.                                              161732
      *
     C           MAPTYP    IFEQ 'EX'                       If Exercices and Conversions
     C           WWOPT2    IFNE '6'                                       161732
     C***********WWHOCA    MULT MDSBPR    WWACAA                          161732
     C           WWHOCA    MULT MDRCPR    WWACAA                          161732
     C           WWOPT2    IFEQ '4'                                       219579
     C           WWHOCA    MULT MDSBPR    WWACAA                          219579
     C                     ENDIF                                          219579
     C                     ENDIF                                          161732
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           TSPB,1    IFEQ 'P'
     C           WWACAA    DIV  100       WWACAA
     C                     ENDIF
     C                     ELSE
      *
      ***  Else, if Processing Type = Dividend Events and Stock Dividend Type = 'R' as Reinvestment
      ***  of Dividend, calculate Actual Cash Allocation = Original Cash Option of the Depot -
      ***  (Total of all Actual Stock Allocation for Customers/Books of the Depot multiplied by
      ***  Subscription Price).
      *
     C           MAPTYP    IFEQ 'DV'                       If Dividend Events
     C           MDSDIT    ANDEQ'R'                           Reinvestment of Dividend
     C           TWASTA    MULT MDSBPR    W1ACAA 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           TSPB,1    IFEQ 'P'
     C           W1ACAA    DIV  100       W1ACAA
     C                     ENDIF
     C           WWCAOP    SUB  W1ACAA    WWACAA
     C                     Z-ADD0         TWASTA
     C                     ELSE
      *
      ***  Else, calculate Actual Cash Allocation = Holding Taken as Cash calculated before
      ***  multiplied by Dividend Per Unit (if Processing Type = Dividends Events) or Cash Payment
      ***  (if Processing Type = Corporate Reorganisation), and half adjust.
      *
     C           WWHOCA    MULT WWDIVU    WWACAA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
     C                     ENDIF
     C                     ENDIF
      *
      ***  Set Actual Cash Allocation calculated.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWWACAA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWACAA
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CASABC - Calculate Actual Stock Allocation for Book/Customer. *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CASABC    BEGSR                           ** CASABC SR **
      *                                                                                       193662
      ** For offers, cash preferred is on the actions                                         193662
      *                                                                                       193662
     C           MAPTYP    IFEQ 'OF'                                                          193662
     C           MIOFTY    ANDEQ'S'                                                           193662
     C           MAPTYP    OREQ 'OF'                                                          193662
     C           MIOFTY    ANDEQ'P'                                                           193662
     C                     Z-ADDWCAPR     WSTPR                                               193662
     C                     ELSE                                                               193662
      *
      ***  Calculate Stock preferred % = 100 - Cash Preeferred % previously calculated.
      *
     C           100       SUB  WCAPR     WSTPR   52
      *                                                                                       193662
     C                     ENDIF                                                              193662
      *
      ***  If Current Reply exists and Reply Nominal (= Nominal Taken as Cash from SECOREL0) not 0,
      ***  calculate work field EE = Holding (= Ex-Date Position) - Reply Nominal (which is in fact
      ***  Nominal Accepted for Offers, which is Nominal Taken as Cash for Dividend Events or Rights
      ***  Issues).
      *
     C           EXBCRE    IFEQ 'Y'
     C           MQR2CN    ANDNE0
     C                     Z-ADDESNBDP    WWNBDP
     C                     Z-ADDMQR2CN    WUNUM
     C                     EXSR RTVNDP
     C********   WWTDVD    SUB  WWNUM     FLDEE  309                      220006
     C                     Z-ADDWWNUM     FLDEE  309                      220006
     C           MAPTYP    IFEQ 'EX'                                      161732
     C           WWOPT2    ANDEQ'6'                                       161732
     C                     Z-ADDWWNUM     FLDEE                           161732
     C                     ENDIF                                          161732
      *                                                                   181131
      ** Multipy by No.of New Shares/No.of Old Shares                     181131
      *                                                                   181131
     C           MDOSHA    IFNE 0                                         181131
     C           FLDEE     DIV  MDOSHA    FLDEE                           181131
     C           FLDEE     MULT WWNSHA    FLDEE                           181131
     C                     Z-ADDFLDEE     WWOALR                          220006
     C                     ENDIF                                          181131
      *
      ***  Else, if Current Reply does not exist or Current Reply exists and Reply Nominal (=
      ***  Nominal Taken as Cash from SECOREL0) is 0.
      *
     C                     ELSE
      *
      ***  If Processing Type = Offers, calculate work field EE = True Stock Allocation previously
      ***  calculated multiplied by Cash Preferred % (which is in fact % Accepted) previously
      ***  calculated.
      *
     C           MAPTYP    IFEQ 'OF'                       If Offers
     C           MIOFTY    ANDNE'E'                                       136935
     C           WWOTSA    MULT WCAPR     FLDEE
     C           MIOFTY    IFEQ 'P'                                       219976
     C           WWOALR    MULT WCAPR     FLDEE                           219976
     C                     END                                            219976
     C           FLDEE     DIV  100       FLDEE
     C                     ELSE
      *
      ***  If Processing Type = 'EX', work field EE = WWOTSA (that has    164243
      ***  already been calculated with Cash Preferred %)                 164243
      *                                                                   164243
     C           MAPTYP    IFEQ 'EX'                       If 'EX'        164243
     C           WWOPT2    IFNE '6'                                       161732
     C                     Z-ADDWWOTSA    FLDEE                           164243
     C                     ELSE                                           161732
      *                                                                   161732
      ***  If Processing type is 'EX' and Option reply is 6               161732
      *                                                                   161732
     C           MQR2CA    IFNE 0                                         161732
     C           WWOTSA    MULT MQR2CA    FLDEE                           161732
     C           FLDEE     DIV  100       FLDEE                           161732
     C                     ENDIF                                          161732
     C                     ENDIF                                          161732
     C                     ELSE                                           164243
      *                                                                   164243
      ***  Else, if Processing Type not Offers, calculated work field EE = True Stock Allocation
      ***  previously calculated multiplied by Stock Preferred % calculated.
      *
     C           WWOTSA    MULT WSTPR     FLDEE
     C           FLDEE     DIV  100       FLDEE
     C           WWOPT2    IFEQ '3'                                                           220006
     C                     Z-ADDWWOTSA    FLDEE                                               220006
     C                     END                                                                220006
     C                     ENDIF                                          164243
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Processing Type = Dividend Events and Stock Dividend Type = 'R' as Reinvestment
      ***  of Dividend and feature Withholding Tax is ON, calculate work field EE = work field EE
      ***  previously calculated less Tax Deducted at Source and Tax Deducted by User based on work
      ***  field EE.
      *
     C           MAPTYP    IFEQ 'DV'
     C           MDSDIT    ANDEQ'R'
     C           S01447    ANDEQ'Y'
     C                     Z-ADDFLDEE     WWAMTT
     C                     EXSR CTOTAX
     C                     SUB  TOTTAX    FLDEE
     C                     ENDIF
      *                                                                   136935
      ***  If Processing Type = Offers with Offer Type = Subscription or  136935
      ***  Exchange, calculate Actual Stock Allocation = Original Stock   136935
      ***  Allocation previously calculated multiplied by Stock Preferred 136935
      ***  %.                                                             136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C           MAPTYP    OREQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'E'                                       136935
     C********** 100       SUB  WCAPR     WSTPR                                        136935 193662
     C           WWOALR    MULT WSTPR     WWASTA                          136935
     C           WWASTA    DIV  100       WWASTA                          136935
     C                     Z-ADDWWASTA    WUASTA                          136935
     C           WWOPT2    IFEQ '3'                                       220006
     C                     Z-ADDWWOALR    WUASTA                          220006
     C                     Z-ADDWWOALR    WWASTA                          220006
     C                     END                                            220006
     C                     ELSE                                           136935
      *
      ***  If Processing Type = Exercices and Conversion.
      *
     C           MAPTYP    IFEQ 'EX'
      *
      *****If*Customer*Option*6*or*7*is*allowed,*Actual*Stock*Allocation* 136935
      *****must*be*set*to*0.********************************************* 136935
      ***  If Option for Allocation 2 = '6' or '7', Actual Stock          136935
      ***  Allocation must be set to 0.                                   136935
      *
     C******     MJOPT6    IFEQ 'Y'                                       136935
     C******     MJOPT7    OREQ 'Y'                                       136935
     C***********WWOPT2    IFEQ '6'                                136935 161732
     C***********WWOPT2    OREQ '7'                                136935 161732
     C           WWOPT2    IFEQ '7'                                       161732
     C                     Z-ADD0         WWASTA
     C                     ELSE
      *
      *****Else,*if*Customer*Option*1,*2,*3,*4*or*5*is*allowed,********** 136935
      *****calculate*Actual*Stock*Allocation*=*Holding*multiplied by***** 136935
      *****(100*-*Cash*%*calculated).************************************ 136935
      ***  Else, if Option for Allocation 2 = '1', '2', '3', '4' or '5',  136935
      ***  calculate Actual Stock Allocation = Original Stock Allocation  136935
      ***  previously calculated multiplied by (100 - Cash % calculated). 136935
      *
     C******     MJOPT1    IFEQ 'Y'                                       136935
     C******     MJOPT2    OREQ 'Y'                                       136935
     C******     MJOPT3    OREQ 'Y'                                       136935
     C******     MJOPT4    OREQ 'Y'                                       136935
     C******     MJOPT5    OREQ 'Y'                                       136935
     C           WWOPT2    IFEQ '1'                                       136935
     C           WWOPT2    OREQ '2'                                       136935
     C           WWOPT2    OREQ '3'                                       136935
     C           WWOPT2    OREQ '4'                                       136935
     C           WWOPT2    OREQ '5'                                       136935
     C           100       SUB  WCAPR     WWCAPR  52
     C******     WWTDVD    MULT WWCAPR    WWASTA                          136935
     C******     WWOALR    MULT WWCAPR    WWASTA                   136935 164243
     C******     WWASTA    DIV  100       WWASTA                          164243
     C                     Z-ADDWWOALR    WWASTA                          164243
     C                     ELSE                                           161732
     C           WWOPT2    IFEQ '6'                                       161732
     C           MQR2CA    IFNE 0                                         161732
     C           WWOALR    MULT MQR2CA    WWASTA                          161732
     C           WWASTA    DIV  100       WWASTA                          161732
     C                     ELSE                                           161732
     C                     Z-ADDESNBDP    WWNBDP                          161732
     C                     Z-ADDMQR2CN    WUNUM                           161732
     C                     EXSR RTVNDP                                    161732
     C           WWOALR    MULT WWNUM     @WST   300                      161732
     C           @WST      DIV  WWTDVD    WWASTA                          161732
     C                     ENDIF                                          161732
     C                     ENDIF                                          161732
     C                     ENDIF
     C                     ENDIF
     C                     ELSE
      *
      ***  If Processing Type = Offers and Offer Type = Purchase Offer,   136935
      ***  calculate Actual Stock Allocation = Original Stock Allocation  136935
      ***  previously calculated multiplied by Stock Preferred %.         136935
      *****set*Actual*Stock*Allocation*to*0.***************************** 136935
      *
     C           MAPTYP    IFEQ 'OF'
     C           MIOFTY    ANDEQ'P'
     C********** WWOALR    MULT WSTPR     WWASTA                   136935 219976
     C           WWOALR    MULT WCAPR     WWASTA                          219976
     C           WWASTA    DIV  100       WWASTA                          136935
     C           MQR2CN    IFNE 0                                         219976
     C                     Z-ADDMQR2CN    WWASTA                          219976
     C                     END                                            219976
     C******               Z-ADD0         WWASTA                          136935
     C                     ELSE
      *
      ***  If Processing Type with no Customer Options (= if Free Allocation or Capital Events or
      ***  Corporate Reorganistion or Currency Change), set Actual Stock Allocation to Original
      ***  Stock Allocation previously calculated (D).
      *
     C           MAPTYP    IFEQ 'FR'                       If Free Allocation
     C           MAPTYP    OREQ 'CE'                       Or Capital Events
     C           MAPTYP    OREQ 'CR'                       Or Corporate Reorganisation
     C           MAPTYP    OREQ 'CC'                       Or Currency Change
     C                     Z-ADDWWOALR    WWASTA
      *
      *****Else,*=*if*Processing*Type*=*Dividend*Events*or*Rights*Issues* 136935
      *****or*Offer*with*Offer*Type*=*Exchange*Offer*or*Subscription***** 136935
      *****Offer.******************************************************** 136935
      ***  Else, = if Processing Type = Dividend Events or Rights Issues. 136935
      *
     C                     ELSE
      *
      ***  If Standard Instruction exists, set Customer Preference to Rounding Option from Standard
      ***  Instruction.
      *
     C                     MOVE ' '       WWROOP
     C           EXBCSI    IFEQ 'Y'
     C                     MOVE MOROOP    WWROOP  1
      *
      ***  Else, if standard Instruction does not exist.
      *
     C                     ELSE
      *
      ***  If Processing Type = Dividend Events or Rights Issues, the Rounding depends on the Option
      ***  chosen (either by the Reply Handling or by the Default No Reply).
      *
     C           MAPTYP    IFEQ 'DV'                       If Dividend Events
     C           MAPTYP    OREQ 'RG'                       Or Rights Issues
      *
      ***  If Option chosen is 2, then Customer Preference should be Round Up.
      *
     C           WWOPT2    IFEQ '2'
     C                     MOVE 'U'       WWROOP
     C                     ELSE
      *
      ***  If Option chosen is 3, then Customer Preference should be Round Down.
      *
     C           WWOPT2    IFEQ '3'
     C                     MOVE 'D'       WWROOP
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Cash Preferred % previously calculated = 0 and Reply Nominal = 0.
      *
     C           WCAPR     IFEQ 0
     C           MQR2CN    ANDEQ0
      *
      ***  Retrieve Customer Options 2 and 3, depending on Processing Type.
      *
     C           MAPTYP    IFEQ 'DV'                       If Dividend Events, fron SECODVL1
     C                     MOVE MDOPT2    WUOPT2
     C                     MOVE MDOPT3    WUOPT3
     C                     ELSE
     C           MAPTYP    IFEQ 'RG'                       If Rights Issues, from SECORGL1
     C                     MOVE MFOPT2    WUOPT2
     C                     MOVE MFOPT3    WUOPT3
     C******               ELSE                                           136935
     C******     MAPTYP    IFEQ 'OF'                       If Offers,     136935
     C******               MOVE MIOPT2    WUOPT2           from SECOOFL1  136935
     C******               MOVE MIOPT3    WUOPT3                          136935
     C******               ELSE                                           136935
     C******               ENDIF                                          136935
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Customer Preference is Round Up.
      *
     C           WWROOP    IFEQ 'U'
      *
      ***  If Customer Option 2 is allowed.
      *
     C           WUOPT2    IFEQ 'Y'
      *
      ***  Calculate work field I = True Stock Allocation previously calculated divided by
      ***  Denomination Multiplier and rounding up to nearest unit.
      *
     C           WWOTSA    DIV  WWDMLT    FLDIW  309
     C                     Z-ADDFLDIW     FLDI   300
     C           FLDIW     IFNE FLDI
     C                     ADD  1         FLDI
     C                     ENDIF
      *
      ***  Calculate Actual Stock Allocation = work field I multiplied by Denomination
      ***  Multiplier.
      *
     C           FLDI      MULT WWDMLT    WWASTA
     C                     ELSE
      *
      ***  Else, if Customer Option 2 is not allowed, set Actual Stock Allocation to Original
      ***  Stock Allocation previously calculated.
      *
     C                     Z-ADDWWOALR    WWASTA
     C                     ENDIF
      *
      ***  Else, if Customer Preference is not Round Up.
      *
     C                     ELSE
      *
      ***  If Customer Option 3 is allowed.
      *
     C           WUOPT3    IFEQ 'Y'
      *
      ***  Calculate work field I = True Stock Allocation previously calculated divided by
      ***  Denomination Multiplier and rounding down to nearest unit.
      *
     C           WWOTSA    DIV  WWDMLT    FLDI
      *
      ***  Calculate Actual Stock Allocation = work field I multiplied by Denomination
      ***  Multiplier.
      *
     C           FLDI      MULT WWDMLT    WWASTA
     C                     ELSE
      *
      ***  Else, if Customer Option 3 is not allowed, set Actual Stock Allocation to Original
      ***  Stock Allocation previously calculated.
      *
     C                     Z-ADDWWOALR    WWASTA
     C                     ENDIF
     C                     ENDIF
      *
      ***  Else, if Cash Preferred % previously calculated not 0 or Reply Nominal not 0.
      *
     C                     ELSE
      *
      ***  If Customer Preference is Round Up, calculate work field I = work field EE divided by
      ***  Denomination Multiplier and rounding up to nearest unit.
      *
     C           WWROOP    IFEQ 'U'
     C           FLDEE     DIV  WWDMLT    FLDIW
     C                     Z-ADDFLDIW     FLDI
     C           FLDIW     IFNE FLDI
     C                     ADD  1         FLDI
     C                     ENDIF
     C                     ELSE
      *
      ***  Else, if Customer Preference is not Round Down, calculate work field I = work field EE
      ***  divided by Denomination Multiplier and rounding down to nearest unit.
      *
     C           FLDEE     DIV  WWDMLT    FLDI
     C                     ENDIF
      *
      ***  Calculate Actual Stock Allocation = Wrk field I multiplied by Denomination Multiplier.
      *
     C           FLDI      MULT WWDMLT    WWASTA
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          136935
      *
      ***  Set Actual Stock Allocation calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWASTA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWASTA
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CASRBC - Calculate Actual Stock Rounding for Book/Customer.   *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CASRBC    BEGSR                           ** CASRBC SR **
      *                                                                   136935
      ***  If Processing Type = Offer with Offer Type = Subscription or   136935
      ***  Purchase, set Actual Stock Rounding to 0.                      136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C           MAPTYP    OREQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'P'                                       136935
     C                     Z-ADD0         WWASTR                          136935
      *                                                                   136935
      ***  Else, if Processing Type not Offer with Offer Type =           136935
      ***  Subscription and Purchase.                                     136935
      *                                                                   136935
     C                     ELSE                                           136935
      *
      ***  Calculate Actual Stock Rounding = work field EE previously calculated - Actual Stock
      ***  Allocation previously calculated.
      *
     C           FLDEE     SUB  WWASTA    WWASTR
      *
      ***  Set Actual Stock Rounding calculated.
      *
     C                     Z-ADD8         WWNBDP           8 Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWASTR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWASTR
     C                     ENDIF                                          136935
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CACRBC - Calculate Actual Cash Rounding for Book/Customer.    *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CACRBC    BEGSR                           ** CACRBC SR **
      *                                                                   136935
      ***  If Processing Type = Offer with Offer Type = Subscription or   136935
      ***  Purchase, set Actual Cash Rounding to 0.                       136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C           MAPTYP    OREQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'P'                                       136935
     C                     Z-ADD0         WWACAR                          136935
      *                                                                   136935
      ***  Else, if Processing Type not Offer with Offer Type =           136935
      ***  Subscription and Purchase.                                     136935
      *                                                                   136935
     C                     ELSE                                           136935
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           MAPTYP    OREQ 'DV'                       Or Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'O'                           Stk Dividend Tp=Optional for Cash&Stk
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           MAPTYP    OREQ 'FR'                       Or Processing Type = Free Allocation
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           MAPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           MAPTYP    OREQ 'CR'                       Or Proces.Type = Corporate Reorganisation
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *
     C           MAPTYP    OREQ 'EX'                       Or Proces.Type= Exervices and Conversions
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
     C*****      MDSBPR    ANDNE0                             Subscription136935
      *
     C           MAPTYP    OREQ 'OF'                       Or Processing Type = Offers
     C           MDOSHA    ANDNE0                             Number of Old Shares not 0
     C           WWNSHA    ANDNE0                             Number of New Shares not 0
      *                                                                   CEU017
      ***  Or Processing Type = Currency Changes and Old and New Nominal  CEU017
      ***  Size not zero.                                                 CEU017
      *                                                                   CEU017
     C           MAPTYP    OREQ 'CC'                                      CEU017
     C           MDOSHA    ANDNE0                                         CEU017
     C           WWNSHA    ANDNE0                                         CEU017
      *
      ***  If Rounding Settlement in Cash = 'Y',
      ***  calculate Actual Cash Rounding = Actual Stock Rounding previously calculated
      ***  multiplied by Compensation Price.
      *
     C           WWRNDS    IFEQ 'Y'
     C           WWASTR    MULT WWCOMP    WWACAR
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           WWACAR    DIV  100       WWACAR
     C                     ENDIF
     C                     ELSE
      *
      ***  If Rounding Settlement in Cash = 'N', set Actual Cash Rounding to 0.
      *
     C                     Z-ADD0         WWACAR
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          136935
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'S'                           Stock Dividend Type = Stock for Stock
     C********** MDDIVU    ANDNE0                             Dividend Per Unit not 0         190204
     C           MDDIV1    ANDNE0                             Dividend Per Unit not 0         190204
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
     C           MAPTYP    OREQ 'DV'                       If Processing Type = Div Events    215071
     C           MDSDIT    ANDEQ'O'                           Stock Div Tp=Opt for cash stock 215071
     C           MDDIV1    ANDNE0                             Dividend per Unit not zero      215071
     C           MDSBPR    ANDNE0                             Subscription Price not zero     215071
      *                                                                                       215071
      ***  If Rounding Settlement in Cash = 'Y'.
      ***  Calculate Actual Cash Rounding = (Holding Taken as Stock previously calculated multiplied
      ***  by Dividend Per Unit) - (Actual Stock Allocation previously calculated multiplied by
      ***  Subscription Price).
      *
     C           WWRNDS    IFEQ 'Y'
     C******               Z-ADDNSNBDP    WWNBDP                          135690
     C**********           Z-ADDNCNBDP    WWNBDP                   135690 190204
     C**********           Z-ADDMDDIVU    WUNUM                           190204
     C**********           EXSR RTVNDP                                    190204
     C                     Z-ADDMDDIV1    WWNUM                           190204
     C           WWHOST    MULT WWNUM     W1ACAR 309
     C           WWASTA    MULT MDSBPR    W2ACAR 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           W2ACAR    DIV  100       W2ACAR
     C                     ENDIF
     C           W1ACAR    SUB  W2ACAR    WWACAR
     C                     ELSE
      *
      ***  If Rounding Settlement in Cash = 'N', set Actual Cash Rounding to 0.
      *
     C                     Z-ADD0         WWACAR
     C                     ENDIF
     C                     ENDIF
      *
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'R'                           Stk Dividend Tp=Reinvestment of Divid.
     C********** MDDIVU    ANDNE0                             Dividend Per Unit not 0         190204
     C           MDDIV1    ANDNE0                             Dividend Per Unit not 0         190204
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
     C           MAPTYP    OREQ 'EX'                       Or Processing Type = Dividends Events
     C           MJCPRC    ANDNE0                             Conversion Price not 0
     C           MJCEXR    ANDNE0                             Conversion Exchange Rate not 0
     C           MDSBPR    ANDNE0                             Subscription Price not 0
      *
      ***  If Rounding Settlement in Cash = 'Y'.
      ***  Calculate Actual Cash Rounding = Actual Cash Pool previously calculated - (Actual Stock
      ***  Allocation previously calculated multiplied by Subscription Price).
      *
     C           WWRNDS    IFEQ 'Y'
     C           WWASTA    MULT MDSBPR    W1ACAR 309
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           W1ACAR    DIV  100       W1ACAR
     C                     ENDIF
     C           ACCAPO    SUB  W1ACAR    WWACAR
     C                     ELSE
      *
      ***  If Rounding Settlement in Cash = 'N', set Actual Cash Rounding to 0.
      *
     C                     Z-ADD0         WWACAR
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Processing Type = Capital Changes, set Actual Cash Rounding to 0.
      *
     C           MAPTYP    IFEQ 'CE'
     C                     Z-ADD0         WWACAR
     C                     ENDIF
      *                                                                   161732
      ** If Processing Type = Exercise and Conversions, and Option for    161732
      ** Allocation = '6', zeroise Actual Cash Rounding.                  161732
      *                                                                   161732
     C           MAPTYP    IFEQ 'EX'                                      161732
     C           WWOPT2    ANDEQ'6'                                       161732
     C                     Z-ADD0         WWACAR                          161732
     C                     ENDIF                                          161732
      *
      ***  Set Actual Cash Rounding calculated.
      *
     C                     Z-ADDNCNBDP    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWWACAR    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWACAR
      *
      ***  Accumulate Actual Cash Rounding.
      *
     C                     ADD  WWACAR    WTACAR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CHSTBC - Calculate Holding Taken as Stock for Book/Customer.  *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CHSTBC    BEGSR                           ** CHSTBC SR **
      *                                                                   136935
      ***  If Processing Type = Offers with Offer Type = Subscription,    136935
      ***  calculate Holding Taken as Stock = Original Stock              136935
      ***  Allocation multiplied by Stock Preferred %.                    136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'OF'                                      136935
     C           MIOFTY    ANDEQ'S'                                       136935
     C********** 100       SUB  WCAPR     WSTPR                                        136935 193662
     C           WWOALR    MULT WSTPR     WWHOST                          136935
     C           WWHOST    DIV  100       WWHOST                          136935
     C                     Z-ADDESNBDP    WWNBDP           Event Sec.DP   136935
     C                     MOVE WWRNDN    WUROOP           Rnd from CO Dt.136935
     C                     Z-ADDWWHOST    WWNUM                           136935
     C                     EXSR ROUNDD                                    136935
     C                     Z-ADDWWNUM     WWHOST                          136935
     C                     ELSE                                           136935
      *
     C           MAPTYP    IFEQ 'OF'                       If Processing Type = Offers
     C           MIOFTY    ANDEQ'P'                           Offer Type = Purchase Offer
      *
      ***  Set Holding Taken as Stock to 0 (must not be calculated) and save value.
      *
     C                     Z-ADD0         WWHOST
     C                     Z-ADD0         WUHOST
      *
     C                     ELSE
      *
     C           MAPTYP    IFEQ 'EX'                       If Process.Type = Exercices & Conversions
      *
      *****If*Customer*Option*6*or*7*is*allowed,*Holding*Taken*as*Stock** 136935
      *****must*be*set*to*0*and*save*value.****************************** 136935
      *****If*Option*for*Actual*Allocation*2*=*'6'*or*'7',*Holding 136935 161732
      *****as*Stock*must*be*set*to*0,*and*save*value.************* 136935 161732
      ** If Option for Allocation 2 = '7', set Holding Taken as Stock     161732
      ** to 0, and save value.                                            161732
      *
     C******     MJOPT6    IFEQ 'Y'                                       136935
     C******     MJOPT7    OREQ 'Y'                                       136935
     C***********WWOPT2    IFEQ '6'                                136935 161732
     C***********WWOPT2    OREQ '7'                                136935 161732
     C           WWOPT2    IFEQ '7'                                       161732
     C                     Z-ADD0         WWHOST
     C                     Z-ADD0         WUHOST
     C                     ELSE
      *
      *****Else,*if*Customer*Option*1,*2,*3,*4*or*5*is*allowed,********** 136935
      ***  Else, if Option for Allocation 2 = '1', '2', '3', '4' or '5',  136935
      ***  Calculate Holding Taken as Stock = Holding (= Ex-Date Position) multiplied by
      ***  (100 - Cash % calculated).
      *
     C******     MJOPT1    IFEQ 'Y'                                       136935
     C******     MJOPT2    OREQ 'Y'                                       136935
     C******     MJOPT3    OREQ 'Y'                                       136935
     C******     MJOPT4    OREQ 'Y'                                       136935
     C******     MJOPT5    OREQ 'Y'                                       136935
     C           WWOPT2    IFEQ '1'                                       136935
     C           WWOPT2    OREQ '2'                                       136935
     C           WWOPT2    OREQ '3'                                       136935
     C           WWOPT2    OREQ '4'                                       136935
     C           WWOPT2    OREQ '5'                                       136935
     C           100       SUB  WCAPR     WWCAPR  52
     C           WWTDVD    MULT WWCAPR    WWHOST
     C           WWHOST    DIV  100       WWHOST
      *
      ***  Save Holding Taken as Stock.
      *
     C                     Z-ADDWWHOST    WUHOST
      *
      ***  Set Holding Taken as Stock calculated.
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOST
     C                     ELSE                                           161732
      *                                                                   161732
      ** Else if Option for Allocation 2 = '6'                            161732
      *                                                                   161732
     C           WWOPT2    IFEQ '6'                                       161732
      *                                                                   161732
      ** If Reply Cash % Level 2 is zero, set Holding Taken as Stock      161732
      ** equal to Nominal Taken as Cash Level 2.                          161732
      *                                                                   161732
     C           MQR2CA    IFEQ *ZERO                                     161732
     C                     Z-ADDMQR2CN    WUHOST                          161732
      *                                                                   161732
      ** Else, calculate Holding Taken as Stock = Ex-date position        161732
      ** multiplied by Reply Cash % Level 2 divided by 100                161732
      *                                                                   161732
     C                     ELSE                                           161732
     C           WWTDVD    MULT MQR2CA    WUHOST                          161732
     C                     DIV  100       WUHOST                          161732
     C                     ENDIF                                          161732
      *                                                                   161732
      ** Apply correct no. of decimal places to Holding Taken as Stock    161732
      *                                                                   161732
     C                     Z-ADDESNBDP    WWNBDP                          161732
     C                     MOVE WWRNDN    WUROOP                          161732
     C                     Z-ADDWUHOST    WWNUM                           161732
     C                     EXSR ROUNDD                                    161732
     C***********          Z-ADDWWNUM     WUHOST                          161732
     C                     Z-ADDWWNUM     WWHOST                          161732
     C                     ENDIF                                          161732
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
      *
     C           MAPTYP    IFEQ 'OF'                       If Processing Type = Offers
     C           MIOFTY    ANDEQ'E'                           Offer Type = Exchange Offers
     C******     MAPTYP    OREQ 'OF'                       Or Subscription136935
     C******     MIOFTY    ANDEQ'S'                           Offers      136935
     C           MAPTYP    OREQ 'NF'                       Or Processing Type = Non Financial Events
      *
      ***  If Current Reply exists.
      ***  and Reply Nominal (= Nominal Taken as Cash Level 2) not 0,     135690
      ***  calculate Holding Taken as Stock = Holding (= Ex-Date          135690
      ***  Position) - Reply Nominal (= Nominal Taken as Cash Level 2).   135690
      *
     C           EXBCRE    IFEQ 'Y'
     C           MQR2CN    ANDNE0                                         135690
      *                                                                   135690
      *****Calculate*Holding*Taken*as*Stock*=*Current*Holding*(=*Ex-Date* 135690
      *****Position)***%*accepted*calculated*previously*OR*Nominal******* 135690
      *****Accepted*(=*Nominal*Taken*as*Cash*Level*2*from*Current*Reply** 135690
      *****(SECOREL0)).************************************************** 135690
      ******                                                              135690
     C******     WCAPR     IFNE 0                                         135690
     C******     WWTDVD    MULT WCAPR     W1HOST 309                      135690
     C******     W1HOST    DIV  100       WWHOST 309                      135690
     C******               ELSE                                           135690
     C                     Z-ADDESNBDP    WWNBDP
     C                     Z-ADDMQR2CN    WUNUM
     C                     EXSR RTVNDP
     C           WWTDVD    MULT WWNUM     WWHOST 309
     C           WWOPT2    IFEQ '3'                                       220006
     C                     Z-ADDWWNUM     WWHOST                          220006
     C                     END                                            220006
     C******               ENDIF                                          135690
     C                     ELSE                                           135690
      *                                                                   135690
      ***  Else, if Current Reply does not exist otr Current Reply exists 135690
      ***  and Reply Nominal (= Nominal Taken as Cash Level 2) = 0,       135690
      ***  calculate Holding Taken as Stock = Current Holding (= Ex-Date  135690
      ***  Position) * % accepted calculated previously for Offers or %   135690
      ***  accepted entered on the Reply Handling screen (= Reply Cash %  135690
      ***  Level 2) for Non Financial Event.                              135690
      *                                                                   135690
     C           MAPTYP    IFEQ 'OF'                                      135690
     C*****      WWTDVD    MULT WCAPR     W1HOST 309               135690 136935
     C           MIOFTY    IFEQ 'E'                                                           193662
     C           100       SUB  WCAPR     WSTPR                           136935
     C                     ENDIF                                                              193662
     C           WWTDVD    MULT WSTPR     W1HOST 309                      136935
     C           WWOPT2    IFEQ '3'                                       220006
     C           WWTDVD    MULT WCAPR     W1HOST 309                      220006
     C                     END                                            220006
     C                     ELSE                                           135690
     C           WWTDVD    MULT MQR2CA    W1HOST 309                      135690
     C                     ENDIF                                          135690
     C           W1HOST    DIV  100       WWHOST 309                      135690
     C                     ENDIF                                          135690
      *
      ***  Save Holding Taken as Stock.
      *
     C                     Z-ADDWWHOST    WUHOST
      *
      ***  Set Holding Taken as Stock calculated.
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOST
     C******               ELSE                                           135690
     C******               Z-ADD0         WWHOST                          135690
     C******               ENDIF                                          135690
      *
     C                     ELSE
      *
     C           MAPTYP    IFEQ 'FR'                       If Processing Type = Free Allocation
     C           MAPTYP    OREQ 'RG'                       Or Processing Type = Rights Issues
     C           MAPTYP    OREQ 'CE'                       Or Processing Type = Capital Change
     C           MAPTYP    OREQ 'CR'                       Or Proces.Type = Corporate Reorganisation
     C           MAPTYP    OREQ 'NC'                       Or Processing Type = Name Changes
     C           MAPTYP    OREQ 'CC'                       Or Ccy Changes CEU017
      *
      ***  Set Holding Taken as Stock to Ex-Date Position from SEUDEPL0 or SECDEPL4
      ***  previously retrieved (= Original Holding) and save value.
      *
     C                     Z-ADDWWTDVD    WWHOST
     C                     Z-ADDWWTDVD    WUHOST
      *
      ***  Set Holding Taken as Stock calculated.
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOST
     C                     ELSE
      *
      ***  If Processing Type = Dividend Events,
      ***  if Current Reply exists and Reply Nominal (= Nominal Taken as Cash Level 2) not 0,
      ***  calculate Holding Taken as Stock = Holding (= Ex-Date Position) - Reply Nominal
      ***  (= Nominal Taken as Cah Level 2).
      *
     C           EXBCRE    IFEQ 'Y'
     C           MQR2CN    ANDNE0
     C                     Z-ADDESNBDP    WWNBDP
     C                     Z-ADDMQR2CN    WUNUM
     C                     EXSR RTVNDP
     C           WWTDVD    SUB  WWNUM     WWHOST
      *
      ***  Save Holding Taken as Stock.
      *
     C                     Z-ADDWWHOST    WUHOST
      *
      ***  Set Holding Taken as Stock calculated.
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOST
      *
      ***  Else, if Current Reply does not exist otr Current Reply exists and Reply Nominal
      ***  (= Nominal Taken as Cash Level 2) = 0.
      *
     C                     ELSE
      *
      ***  If Cash Preferred % = 0.
      *
     C******     MOCAPP    IFEQ 0                                         135690
     C           WCAPR     IFEQ 0                                         135690
      *
      ***  Set Holding Taken as Stock to Ex-Date Position from SEUDEPL0 or SECDEPL4
      ***  previously retrieved and save value.
      *
     C                     Z-ADDWWTDVD    WWHOST
     C                     Z-ADDWWTDVD    WUHOST
      *
      ***  Set Holding Taken as Stock calculated.
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOST
      *
      ***  Else, if Cash Preferred % not equal 0.
      *
     C                     ELSE
      *
      ***  If Cash Preferred % = 100.
      *
     C******     MOCAPP    IFEQ 100                                       135690
     C           WCAPR     IFEQ 100                                       135690
      *
      ***  Set Holding Taken as Stock to 0 and save value.
      *
     C                     Z-ADD0         WWHOST
     C                     Z-ADD0         WUHOST
      *
      ***  Else, if Cash Preferred % not equal 100 (and not equal 0).
      *
     C                     ELSE
      *
      ***  If Number of Old and New Shares from SECOxxL1 not equal 0.
      *
     C           WWNSHA    IFNE 0
     C           MDOSHA    ANDNE0
      *
      ***  Calculate Holding Taken as Stock = (Actual Stock Allocation calculated before
      ***  divided by Number of New Shares from SECOxxL1) multiplied by Number of Old Shares from
      ***  SECOxxL1 and rounded up.
      *
     C           WWASTA    DIV  WWNSHA    W1HOST 309
     C           W1HOST    MULT MDOSHA    WWHOST
      *
      ***  Save Holding Taken as Stock.
      *
     C                     Z-ADDWWHOST    WUHOST
      *
      ***  Set Holding Taken as Stock calculated.
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C                     MOVE 'U'       WUROOP           Rounding = up
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOST
      *
      ***  Else, if Number of Old or New Shares from SECOxxL1 equal 0.
      *
     C                     ELSE
      *
      ***  Calculate Holding Taken as Stock = (Actual Stock Allocation calculated before
      ***  multiplied by Subscription Price) divided by Dividend Per Unit (less Tax Deducted at
      ***  Source and Tax Deducted by User based on Dividend Per Unit if Stock Dividend Type = 'R'
      ***  as Reinvestment of Dividend and feature Witholding Tax is ON), and rounded up.
      *
     C           WWASTA    MULT MDSBPR    W1HOST
      *
      ***  If Price Basis is 'P' for %, result should be divided by 100.
      *
     C           NSSPBS    IFEQ 'P'
     C           W1HOST    DIV  100       W1HOST
     C                     ENDIF
     C           MDSDIT    IFEQ 'R'
     C           S01447    ANDEQ'Y'
     C                     Z-ADDWWDIVU    WWAMTT
     C                     EXSR CTOTAX
     C                     SUB  TOTTAX    WWDIVU
     C                     ENDIF
     C           W1HOST    DIV  WWDIVU    WWHOST
      *
      ***  Save Holding Taken as Stock.
      *
     C                     Z-ADDWWHOST    WUHOST
      *
      ***  Set Holding Taken as Stock calculated.
      *
     C                     Z-ADDESNBDP    WWNBDP           Event Security Decimal Places
     C                     MOVE 'U'       WUROOP           Rounding = up
     C                     Z-ADDWWHOST    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOST
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF                                          136935
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CACAPO - Calculate Actual Cash Pool for Book/Customer.        *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CACAPO    BEGSR                           ** CACAPO SR **
      *
      ***  If feature Withholding Tax is ON.
      *
     C           S01447    IFEQ 'Y'
      *
      ***  Calculate Tax Deducted at Source and Tax Deducted by User based on Dividend per Unit.
      *
     C                     Z-ADDWWDIVU    WWAMTT
     C                     EXSR CTOTAX
      *
      ***  If Customer calculation, calculate Dividend Per Unit les Tax Deducted at Source and Tax
      ***  Deducted by User based on Dividend Per Unit.
      *
     C           FROMBC    IFEQ 'C'
     C           WWDIVU    SUB  TOTTAX    TADIVU 309
     C                     ELSE
      *
      ***  If Book calculation, calculate Dividend Per Unit les Tax Deducted at Source based on
      ***  Dividend Per Unit.
      *
     C           WWDIVU    SUB  TASO      TADIVU
     C                     ENDIF
     C                     ELSE
      *
      ***  If feature Withholding Tax is OFF, Retrieve Dividend Per Unit.
      *
     C                     Z-ADDWWDIVU    TADIVU
     C                     ENDIF
      *
      ***  Calculate Actual Cash Pool:
      ***  - Customer Position: = Holding Taken as Stock multiplied by (Dividend Per Unit less Tax
      ***                         Deducted at Source and Tax Deducted by User) if feature
      ***                         Witholding Tax is ON,
      ***                       = Holding Taken as Stock multiplied by Dividend Per Unit if feature
      ***                         Witholding Tax is OFF.
      ***  - Book Position:     = Holding Taken as Stock multiplied by (Dividend Per Unit less Tax
      ***                         Deducted at Source) if feature Withholding Tax is ON,
      ***                       = Holding Taken as Stock multiplied by Dividend Per Unit if feature
      ***                         Witholding Tax is OFF.
      *
     C           WWHOST    MULT TADIVU    ACCAPO 309
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CHCABC - Calculate Holding Taken as Cash for Book/Customer.   *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CHCABC    BEGSR                           ** CHCABC SR **
      *
     C           MAPTYP    IFEQ 'OF'                       If Processing Type = Offers
     C******     MIOFTY    ANDEQ'S'                           Subscription136935
     C******     MAPTYP    OREQ 'OF'                       Or Offres      136935
     C           MIOFTY    ANDEQ'P'                           Offer Type = Purchase Offer
      *****If*Current*Reply*exists.************************************** 136935
      ******                                                              136935
     C******     EXBCRE    IFEQ 'Y'                                       136935
      ******                                                              136935
      *****Calculate*Holding*Taken*as*Cash*=*Current*Holding*(=*Ex-Date** 136935
      *****Position)***%*accepted*calculated*previously*OR*Nominal******* 136935
      *****Accepted*(=*Nominal*Taken*as*Cash*Level*2*from*Current*Reply** 136935
      *****(SECOREL0)).************************************************** 136935
      ******                                                              136935
     C******     WCAPR     IFNE 0                                         136935
     C******     WWTDVD    MULT WCAPR     W1HOCA 309                      136935
     C******     W1HOCA    DIV  100       WWHOCA                          136935
     C******               ELSE                                           136935
     C******               Z-ADDESNBDP    WWNBDP                          136935
     C******               Z-ADDMQR2CN    WUNUM                           136935
     C******               EXSR RTVNDP                                    136935
     C******     WWTDVD    MULT WWNUM     WWHOCA                          136935
     C******               ENDIF                                          136935
     C******               ELSE                                           136935
     C******               Z-ADD0         WWHOCA                          136935
     C******               ENDIF                                          136935
      *                                                                   136935
      ***  Calculate Holding Taken as Cash = Original Stock Allocation    136935
      ***  multiplied by Nominal Accepted if Current Reply exists and not 136935
      ***  0 or by Cash %.                                                136935
      *                                                                   136935
     C           EXBCRE    IFEQ 'Y'                                       136935
     C           MQR2CN    ANDNE0                                         136935
     C                     Z-ADDESNBDP    WWNBDP                          136935
     C                     Z-ADDMQR2CN    WUNUM                           136935
     C                     EXSR RTVNDP                                    136935
     *********** WWOALR    MULT WWNUM     WWHOCA                   136935 219976
     C                     Z-ADDWWNUM     WWHOCA                          219976
     C                     ELSE                                           136935
     C           WWOALR    MULT WCAPR     W1HOCA 309                      136935
     C           W1HOCA    DIV  100       WWHOCA                          136935
     C                     ENDIF                                          136935
     C                     ELSE
     C           MAPTYP    IFEQ 'DV'                       If Processing Type = Dividends Events
     C           MDSDIT    ANDEQ'C'                           Stk Dividend Tp=Combined for Cash&Stk
      *
      ***  Set Holding Taken as Cash to Ex-Date Position from SEUDEPL0 or SECDEPL4
      ***  previously retrieved.
      *
     C                     Z-ADDWWTDVD    WWHOCA 309
     C                     ELSE
      *
      ***  Else, if Processing Type = Exercices and Conversions and       136935
      ***  Option for Allocation 2 = '7'.                                 136935
      *****Else,*if*Processing*Type*=*Corporate*Reorganisation or******** 136935
      *****Processing*Type*=*Name*Changes*or*Processing*Type*=*Exercices* 136935
      *****and*Conversions*and*Customer*Option*7*is*allowed.************* 136935
      *
     C******     MAPTYP    IFEQ 'CR'                       If Corp. Reorg.136935
     C******     MAPTYP    OREQ 'NC'                       Or Name Changes136935
     C******     MAPTYP    OREQ 'OF'                       Or Exchange    136935
     C******     MIOFTY    ANDEQ'E'                           Offer       136935
     C******     MAPTYP    OREQ 'EX'                       Or Exerc.&Conv.136935
     C******     MJOPT7    ANDEQ'Y'                           Cust.Opt 7  136935
     C           MAPTYP    IFEQ 'EX'                       Or Exerc.&Conv.136935
     C           WWOPT2    ANDEQ'7'                           Opt.Alloc=7 136935
      *
      ***  Set Holding Taken as Cash to 0.
      *
     C                     Z-ADD0         WWHOCA 309
     C                     ELSE
      *
      *****Else,*if*Processing*Type*=*Exercices*and*Conversions*and****** 136935
      *****Customer*Option*6*is*allowed.********************************* 136935
      ***  Else, if Processing Type = Exercices and Conversions and       136935
      ***  Option for Allocation 2 = '6'.                                 136935
      *
     C           MAPTYP    IFEQ 'EX'                       Or Exercices and Conversions
     C******     MJOPT6    ANDEQ'Y'                           Cust.Opt.6  136935
     C           WWOPT2    ANDEQ'6'                           Opt.Alloc=6 136935
      ********************************************************************161732
      *****If*Current*Reply*exists*and*Reply*Nominal*(=*Nominal*Taken*as*C161732
      *****calculate*Holding*Taken*as*Cash*=*Reply*Nominal*(=*Nominal*Take161732
      *
     C***********EXBCRE    IFEQ 'Y'                                       161732
     C***********MQR2CN    IFNE 0                                         161732
     C***********          Z-ADDESNBDP    WWNBDP                          161732
     C***********          Z-ADDMQR2CN    WUNUM                           161732
     C***********          EXSR RTVNDP                                    161732
     C***********          Z-ADDWWNUM     WWHOCA                          161732
     C***********          ELSE                                           161732
      ********************************************************************161732
      *****If*Current*Reply*exists*and*Cash*%*not*0,*calculate*Holding*Tak161732
      *****(=*Ex-Date*Position)*multiplied*by*Cash*%.*********************161732
      ****************************************************************c***161732
     C***********WWTDVD    MULT WCAPR     W1HOCA 309                      161732
     C***********W1HOCA    DIV  100       WWHOCA                          161732
     C***********          ENDIF                                          161732
     C***********          ELSE                                           161732
      *
      *****If*Current*Reply*does*not*exist,*set*Holding*Taken*as*Cash*to*0161732
      *
     C                     Z-ADD0         WWHOCA
     C***********          ENDIF                                          161732
     C                     ELSE
      *                                                                                       191178
      **  If processing type is 'DV' and stock dividend type not 'C'...                       191178
      *                                                                                       191178
     C           MAPTYP    IFEQ 'DV'                                                          191178
     C           MDSDIT    ANDNE'C'                                                           191178
     C           MQR2CN    ANDEQ0                                                             191178
     C           WCAPR     ANDNE0                                                             191178
      *                                                                                       191178
     C                     Z-ADD0         W2HOCA 309                                          191178
      *                                                                                       191178
     C           WWTDVD    MULT WCAPR     W2HOCA                                              191178
     C           W2HOCA    DIV  100       WWHOCA                                              191178
     C                     ELSE                                                               191178
      *
      ***  Calculate Holding Taken as Cash = Ex-Date Position from SECDEPL4 ot SEUDEPL0
      ***  previously retrieved - Holding Taken as Stock previously calculated.
      *
     C           WWTDVD    SUB  WWHOST    WWHOCA
     C                     ENDIF                                                              191178
     C           MAPTYP    IFEQ 'EX'                       Or Exercices an219579
     C           WWOPT2    ANDEQ'4'                           Opt.Alloc=6 219579
     C                     Z-ADDWWHOST    WWHOCA                          219579
     C                     ENDIF                                          219579
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Save Holding Taken as Cash.
      *
     C                     Z-ADDWWHOCA    WUHOCA
      *
      ***  Set Holding Taken as Cash calculated.
      *
     C                     Z-ADDNCNBDP    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWWHOCA    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWHOCA
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * PSEDPT - Process New Security for the Deopt.                  *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           PSEDPT    BEGSR                           ** PSEDPT SR **
      *
      ***  Prepare Price Basis for New Security.
      *
     C                     MOVE TSPB,I    NSSPBS
      *
      ***  Prepare Number of Decimal Places of New Security.
      *
     C                     MOVE TSDP,I    NSNBDP
      *
      ***  Prepare Number of Decimal Places of New Currency.
      *
     C                     MOVE TCDP,I    NCNBDP
      *
      ***  Prepare Number Of New Shares:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TNSH,I    WWNSHA
     C                     ELSE
     C                     Z-ADDMDNSHA    WWNSHA
     C                     ENDIF
      *
      ***  Prepare Denomination Multiplier:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C*****                MOVE TDML,I    WUNUM                           179024
     C                     MOVE TDML,I    WDM16  160                      179024
     C                     ELSE
     C*****                Z-ADDMDDMLT    WUNUM                           179024
     C                     Z-ADDMDDMLT    WDM16                           179024
     C                     ENDIF
     C           5         SUB  NSNBDP    J       10                      179024
     C           WDM16     MULT POWER8,J  WWDMLT                          179024
     C*****                Z-ADDNSNBDP    WWNBDP                          179024
     C*****                EXSR RTVNDP                                    179024
     C*****                Z-ADDWWNUM     WWDMLT                          179024
      *
      ***  Prepare Rounding:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  Else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TNDN,I    WWRNDN
     C                     ELSE
     C                     MOVE MDRNDN    WWRNDN
     C                     ENDIF
      *
      ***  Prepare Rounding Settlement in Cash:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  Else retrieve from Corporate Actions Detail file.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TNDS,I    WWRNDS
     C                     ELSE
     C                     MOVE MDRNDS    WWRNDS
     C                     ENDIF
      *
      ***  Prepare Compensation Price:
      ***  If Processing Type = 'CR': Corporate Reorganisation, retrieve position of array,
      ***  else retrieve from Corporate Actions Details File.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVE TOPA,I    WWCOMP 158
     C                     ELSE
      *                                                                   135685
      ***  If Processing Type = Currency Change                           135685
      ***  and Compensation Price is entered as Market,                   135685
      ***  the Compensation Price must first be calculated                135685
      ***  from Current Market Price.                                     135685
      *                                                                   135685
     C           MAPTYP    IFEQ 'CC'                                      135685
     C           NAMRKI    ANDEQ'Y'                                       135685
     C                     EXSR CCOMP                                     135685
     C                     ENDIF                                          135685
      *                                                                   135685
     C                     Z-ADDMDCOMP    WWCOMP
     C                     ENDIF
      *
      ***  Some fields must not be calculated for New Security.
      *
     C                     Z-ADD0         WUOALR                                              193662
     C                     Z-ADD0         WWCAOP           Original Cash Option
     C                     Z-ADD0         WWACAA           Actual Cash Allocation
     C                     Z-ADD0         WWBCAA 309       Balancing Cash Allocation
      *
      ***  Calculate Allocations: - Original Stock Allocation
      ***                         - True Stock Allocation
      ***                         - Original Stock Rounding
      ***                         - Original Cask Rounding.
      *
     C                     MOVE 'Y'       WINDPT  1                       156690
     C                     EXSR CALLOC
     C                     MOVE 'N'       WINDPT                          156690
      *
      ***  Calculate other Depot Allocations.
      *
     C                     EXSR CALDPT
      *
      ***  Calculate Balancing Difference for Actual Stock Allocation, Actual Stock Rounding, Actual
      ***  Actual Cash Rounding = difference between the total fields accumulated above and the
      ***  Depot fields.
      *
     C           WWASTA    SUB  WTASTA    WWBSTA 309       Balancing Stock Allocation
     C           WWASTR    SUB  WTASTR    WWBSTR 309       Balancing Stock Rounding
     C           WWACAR    SUB  WTACAR    WWBCAR 309       Balancing Cash Rounding
      *
      ***  Set Balancing Stock Allocation calculated.
      *
     C                     Z-ADDNSNBDP    WWNBDP           New Security Decimal Places
     C                     MOVE WWRNDN    WUROOP           Rounding from CO Detail file
     C                     Z-ADDWWBSTA    WWNUM
     C                     EXSR ROUNDD
      *                                                                   135686
      ***  If processing type =  Currency Change, load work array entry   135686
      ***  for Dummy Customer and reset work field for Allocation details 135686
      ***  file (Balancing Differences are input on Dummy Customer).      135686
      *                                                                   135686
     C           MAPTYP    IFEQ 'CC'                                      135686
     C           MAPTYP    ORNE 'CC'                                      137886
     C           BVALDC    ANDEQ'Y'                                       137886
     C                     Z-ADD0         WWBSTA
     C                     Z-ADDWWNUM     TBSA,I
      *                                                                   135686
      ***  Else, if processing type not Currency Change, load work field  135686
      ***  for Depot Allocation file and reset work array entry for       135686
      ***  Dummy Customer.                                                135686
      *                                                                   135686
     C                     ELSE                                           135686
     C                     Z-ADDWWNUM     WWBSTA                          135686
     C                     Z-ADD0         TBSA,I                          135686
     C                     ENDIF                                          135686
      *
      ***  Set Balancing Stock Rounding calculated.
      *
     C                     Z-ADD8         WWNBDP           8 Decimal Places
     C                     Z-ADDWWBSTR    WWNUM
     C                     EXSR ROUNDD
      *                                                                   135686
      ***  If processing type =  Currency Change, load work array entry   135686
      ***  for Dummy Customer and reset work field for Allocation details 135686
      ***  file (Balancing Differences are input on Dummy Customer).      135686
      *                                                                   135686
     C           MAPTYP    IFEQ 'CC'                                      135686
     C           MAPTYP    ORNE 'CC'                                      137886
     C           BVALDC    ANDEQ'Y'                                       137886
     C                     Z-ADD0         WWBSTR
     C                     Z-ADDWWNUM     TBSR,I
      *                                                                   135686
      ***  Else, if processing type not Currency Change, load work field  135686
      ***  for Depot Allocation file and reset work array entry for       135686
      ***  Dummy Customer.                                                135686
      *                                                                   135686
     C                     ELSE                                           135686
     C                     Z-ADDWWNUM     WWBSTR                          135686
     C                     Z-ADD0         TBSR,I                          135686
     C                     ENDIF                                          135686
      *
      ***  Set Balancing Cash Rounding calculated.
      *
     C                     Z-ADDNCNBDP    WWNBDP           New Currency Decimal Places
     C                     MOVE 'R'       WUROOP           Rounding = half adjust
     C                     Z-ADDWWBCAR    WWNUM
     C                     EXSR ROUNDD
      *                                                                   135686
      ***  If processing type =  Currency Change, load work array entry   135686
      ***  for Dummy Customer and reset work field for Allocation details 135686
      ***  file (Balancing Differences are input on Dummy Customer).      135686
      *                                                                   135686
     C           MAPTYP    IFEQ 'CC'                                      135686
     C           MAPTYP    ORNE 'CC'                                      137886
     C           BVALDC    ANDEQ'Y'                                       137886
     C                     Z-ADD0         WWBCAR
     C                     Z-ADDWWNUM     TBCR,I
      *                                                                   135686
      ***  Else, if processing type not Currency Change, load work field  135686
      ***  for Depot Allocation file and reset work array entry for       135686
      ***  Dummy Customer.                                                135686
      *                                                                   135686
     C                     ELSE                                           135686
     C                     Z-ADDWWNUM     WWBCAR                          135686
     C                     Z-ADD0         TBCR,I                          135686
     C                     ENDIF                                          135686
      *
      ***  Write a record on SECODPL0: Corporate Actions Depots file.
      *
     C                     EXSR WRCODP
      *
      ***  Reset work fields.
      *
     C                     Z-ADD0         WTHOST           Total Holding Taken as Stock
     C                     Z-ADD0         WTHOCA           Total Holding Taken as Cash
     C                     Z-ADD0         WTASTA           Total Actual Stock Allocation
     C                     Z-ADD0         WTASTR           Total Actual Stock Rounding
     C                     Z-ADD0         WTACAR           1st total Actual Cash Rounding
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CTFEES - Calculate Total Fees for Customer.                   *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CTFEES    BEGSR                           ** CTFEES SR **
      *
      ***  Call Access Program for Security Customer Details to retrieve Customer Group.
      *
     C                     MOVE WWCDCN    @SCKY
     C                     CALL 'AOSECSR0'
     C                     PARM           @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM           @SCKY   6
     C           SDSECS    PARM SDSECS    DSSDY
      *
      ***  Handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD018       DBASE            ***************
     C                     MOVEL'SDSECSPD'DBFILE           * DB ERROR 18 *
     C                     MOVEL@SCKY     DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C           S01496    IFEQ 'Y'
     C           BVACOP    ANDEQ'Y'
      *
      ***  Retrieve the Commission and the Charge Code on the Corporate Actions Default Charges
      ***  file with Customer Group, Customer, Investment Type and Corporate Action Type.
      *
     C                     MOVE BFPSCG    KCUGR            Customer Group
     C**********           Z-ADDWWCDCN    KCDCN            Customer                           CSD027
     C                     MOVE WWCDCN    KCDCN            Customer                           CSD027
     C                     MOVE ESSITP    KSITP            Investment Type
     C                     MOVE MACOAT    KCOAT            COrporate Action Type
     C           @KEY13    CHAINSECOCHL0             84
      *
      ***  If record not found, access with Customer Group, Customer and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C                     MOVE *BLANKS   KCOAT            COrporate Action Type
     C           @KEY13    CHAINSECOCHL0             84
      *
      ***  If record not found, access with Customer Group and Customer and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C                     MOVE *BLANKS   KSITP            Investment Type
     C           @KEY13    CHAINSECOCHL0             84
      *
      ***  If record not found, access with Customer Group and Customer = 0 and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C**********           Z-ADD0         KCDCN            Customer                           CSD027
     C                     MOVE *BLANKS   KCDCN            Customer                           CSD027
     C           @KEY13    CHAINSECOCHL0             84
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ELSE
      *
      ***  Retrieve the Commission and the Charge Code on the Corporate Actions Default Charges
      ***  file with Classification, Customer, Investment Type and Corporate Action Type.
      *
     C                     MOVE BFCLAS    KCLAS            Retrieve Classification
     C**********           Z-ADDWWCDCN    KCDCN            Customer                           CSD027
     C                     MOVE WWCDCN    KCDCN            Customer                           CSD027
     C                     MOVE ESSITP    KSITP            Investment Type
     C                     MOVE MACOAT    KCOAT            COrporate Action Type
     C           @KEY14    CHAINSECOCHL1             84
      *
      ***  If record not found, access with Classification, Customer and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C                     MOVE *BLANKS   KCOAT            COrporate Action Type
     C           @KEY14    CHAINSECOCHL1             84
      *
      ***  If record not found, access with Classification and Customer and Investment type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C                     MOVE *BLANKS   KSITP            Investment Type
     C           @KEY14    CHAINSECOCHL1             84
      *
      ***  If record not found, access with Classification and Customer = 0 and Investment Type and
      ***  Corporate Action Type = blank.
      *
     C           *IN84     IFEQ '1'
     C**********           Z-ADD0         KCDCN            Customer                           CSD027
     C                     MOVE *BLANKS   KCDCN            Customer                           CSD027
     C           @KEY14    CHAINSECOCHL1             84
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  If record not found with one access, set Total Fees to 0.
      *
     C           *IN84     IFEQ '1'
     C***********          Z-ADD0         WWTOTF           Total Fees     179205
     C                     Z-ADD0         CHRAMT                          179205
      *
      ***  If record found with one access.
      *
     C                     ELSE
      *
      ***  Retrieve Charge Basis Indicator on Charge Types file with Charge Code retrieve above
      ***  and Event Nominal Currency.
      *
     C                     MOVE MRCOCH    KCCOM   2
     C           @KEY17    CHAINSECGT                84
      *
      ***  If no live record found, set Total Fees to 0.
      *
     C           *IN84     IFEQ '1'
     C                     Z-ADD0         WWTOTF
      *
      ***  If live record found, Calculate Charge Amount.
      *
     C                     ELSE
     C                     Z-ADD0         ZTCON
     C                     Z-ADD0         ZNOML
      *
      ***  If Processing Type = 'NF', set field ZNOML to Ex-Date Position for Corporate Action
      *
     C           MAPTYP    IFEQ 'NF'
     C                     Z-ADDWWTDVD    ZNOML
      *
      ***  Else, if Processing Type not = 'NF'.
      *
     C                     ELSE
      *
      ***  If Charge Basis Indicator = 'C', set field ZTCON to (Actual Cash Allocation + Actual
      ***  Cash Rounding).
      *
     C           CHGB      IFEQ 'C'
     C           WWACAA    ADD  WWACAR    ZTCON
      *
      ***  Else, if Processing Type not = 'NF' and Charge Basis Indicator not = 'C'.
      *
     C                     ELSE
      *
      ***  If Charge Basis Indicator = 'N', set field ZNOML to Ex-Date.
      *
     C           CHGB      IFEQ 'N'
     C                     Z-ADDWWTDVD    ZNOML
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Calculate Charge Amount.
      *
     C                     EXSR CALAM2
     C                     Z-ADDZCHGA     CHRAMT 309
     C                     ENDIF                                          179205
      *
     C                     Z-ADD0         ZTCON
     C                     Z-ADD0         ZNOML
      *
      ***  Retrieve Charge Basis Indicator on Charge Types file with Commission Code retrieve
      ***  above and Event Nominal Currency.
      *
     C                     MOVE MRCOCO    KCCOM
     C           @KEY17    CHAINSECGT                84
      *
      ***  If no live record found, set Total Fees to 0.
      *
     C           *IN84     IFEQ '1'
     C***********          Z-ADD0         WWTOTF                          179205
     C                     Z-ADD0         COMAMT                          179205
      *
      ***  If live record found, Calculate Commission Amount.
      *
     C                     ELSE
      *
      ***  If Processing Type = 'NF', set field ZNOML to Ex-Date Position for Corporate Action
      *
     C           MAPTYP    IFEQ 'NF'
     C                     Z-ADDWWTDVD    ZNOML
      *
      ***  Else, if Processing Type not = 'NF'.
      *
     C                     ELSE
      *
      ***  If Charge Basis Indicator = 'C', set field ZTCON to (Actual Cash Allocation + Actual
      ***  Cash Rounding).
      *
     C           CHGB      IFEQ 'C'
     C           WWACAA    ADD  WWACAR    ZTCON
      *
      ***  Else, if Processing Type not = 'NF' and Charge Basis Indicator not = 'C'.
      *
     C                     ELSE
      *
      ***  If Charge Basis Indicator = 'N', set field ZNOML to Ex-Date.
      *
     C           CHGB      IFEQ 'N'
     C                     Z-ADDWWTDVD    ZNOML
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Calculate Commission Amount.
      *
     C                     EXSR CALAM2
     C                     Z-ADDZCHGA     COMAMT 309
     C                     ENDIF                                          179205
      *
      ***  Calculate Total Fees = Charge Amount + Commission Amount calculated above.
      *
     C           CHRAMT    ADD  COMAMT    WWTOTF
      *
      ***  Set Total Fees calculated.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     Z-ADDECNBDP    WWNBDP           Event Currency Decimal Places
     C                     ELSE
     C                     Z-ADDTCDP,1    WWNBDP           New Currency Decimal Places
     C                     ENDIF
     C                     MOVE 'R'       WUROOP           Rounding = alf adjust
     C                     Z-ADDWWTOTF    WWNUM
     C                     EXSR ROUNDD
     C                     Z-ADDWWNUM     WWTOTF
     C                     ENDIF
     C***********          ENDIF                                          179205
     C***********          ENDIF                                          179205
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CALAM2 - Calculate Charge Amounts.                            *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CALAM2    BEGSR                           ** CALAM2 SR **
      *
      ***  Charge Details.
      *
     C                     MOVE CHGB      ZCHGB
     C                     MOVE THRI      ZTHRI
     C                     Z-ADDMNCH      ZMNCH
     C                     Z-ADDMXCH      ZMXCH
      *
      ***  Set up array for Upper Range Limits.
      *
     C                     Z-ADDSTU1      ZRA,1
     C                     Z-ADDSTU2      ZRA,2
     C                     Z-ADDSTU3      ZRA,3
     C                     Z-ADDSTU4      ZRA,4
     C                     Z-ADDSTU5      ZRA,5
     C                     Z-ADDSTU6      ZRA,6
     C                     Z-ADDSTU7      ZRA,7
     C                     Z-ADDSTU8      ZRA,8
     C                     Z-ADDSTU9      ZRA,9
     C                     Z-ADDST10      ZRA,10
     C                     Z-ADDST11      ZRA,11
     C                     Z-ADDST12      ZRA,12
     C                     Z-ADDST13      ZRA,13
     C                     Z-ADDST14      ZRA,14
      *
      ***  Set up array for Percentage Levels.
      *
     C                     Z-ADDPL01      ZPC,1
     C                     Z-ADDPL02      ZPC,2
     C                     Z-ADDPL03      ZPC,3
     C                     Z-ADDPL04      ZPC,4
     C                     Z-ADDPL05      ZPC,5
     C                     Z-ADDPL06      ZPC,6
     C                     Z-ADDPL07      ZPC,7
     C                     Z-ADDPL08      ZPC,8
     C                     Z-ADDPL09      ZPC,9
     C                     Z-ADDPL10      ZPC,10
     C                     Z-ADDPL11      ZPC,11
     C                     Z-ADDPL12      ZPC,12
     C                     Z-ADDPL13      ZPC,13
     C                     Z-ADDPL14      ZPC,14
     C                     Z-ADDPL15      ZPC,15
      *
      ***  Set up array for Flat Charges.
      *
     C                     Z-ADDFC01      ZCG,1
     C                     Z-ADDFC02      ZCG,2
     C                     Z-ADDFC03      ZCG,3
     C                     Z-ADDFC04      ZCG,4
     C                     Z-ADDFC05      ZCG,5
     C                     Z-ADDFC06      ZCG,6
     C                     Z-ADDFC07      ZCG,7
     C                     Z-ADDFC08      ZCG,8
     C                     Z-ADDFC09      ZCG,9
     C                     Z-ADDFC10      ZCG,10
     C                     Z-ADDFC11      ZCG,11
     C                     Z-ADDFC12      ZCG,12
     C                     Z-ADDFC13      ZCG,13
     C                     Z-ADDFC14      ZCG,14
     C                     Z-ADDFC15      ZCG,15
      *
     C                     Z-ADDESNBDP    ZDECS
      *
      ***  Nominal Decimal Places.
      *
     C                     Z-ADD0         ZNMDP
      *
      ***  Security Details.
      *
     C                     Z-ADD1         ZPRICE
     C                     Z-ADD0         ZTCFC
     C                     MOVE 'P'       ZPROT
     C                     MOVE *BLANKS   ZSPBS
      *
     C           S01446    IFEQ 'Y'
      *
      ***  Purchase Interest.
      *
     C                     Z-ADD0         ZTPI
      *
     C                     MOVE *BLANKS   ZCCYI
     C                     MOVE *BLANKS   ZCCYO
     C                     MOVE *BLANKS   ZEXCH
     C                     MOVE *BLANKS   ZMD
      *
     C                     ENDIF
      *
      ***  Total Nominal.
      *
     C                     Z-ADD*ZEROS    ZTNOM  150
      *
     C                     EXSR ZCCAL1
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * DADCOR - Delete Corporate Actions Allocation and Depot for    *
      *          CO Reference and Depot.                              *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           DADCOR    BEGSR                           ** DADCOR SR **
      *
      ***  Access Corporate Actions Allocations file with CO Reference received as parameter.
      *
     C           PCORF     SETLLSECOALL0
     C           PCORF     READESECOALL0                 80
      *
     C           *IN80     DOWEQ'0'
      *
      ***  If Depot = Depot (num field) received as parameter and Branch = Branch received as
      ***  parameter.
      *
     C           MCDDPT    IFEQ WWDDPT
     C           MCBRCD    ANDEQPBRCD
      *
      ***  If record live, delete logically.
      *
     C           MCRECI    IFNE '*'
     C                     MOVE '*'       MCRECI
     C                     UPDATSECOALD0               89
      *
      ***  If error detected when update, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD019       DBASE            ***************
     C                     MOVEL'SECOALL0'DBFILE           * DB ERROR 19 *
     C                     MOVEL'UPDATE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
      *
      ***  If record already logically deleted (MCRECI = '*'), delete physically.
      *
     C                     ELSE
     C                     DELETSECOALD0               89
      *
      ***  If error detected when delete, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD020       DBASE            ***************
     C                     MOVEL'SECOALL0'DBFILE           * DB ERROR 20 *
     C                     MOVEL'DELETE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ENDIF
     C                     ENDIF
     C           PCORF     READESECOALL0                 80
     C                     ENDDO
      *
      ***  Access Corporate Actions Depot file with CO Reference received as parameter.
      *
     C           PCORF     SETLLSECODPL0
     C           PCORF     READESECODPL0                 80
      *
     C           *IN80     DOWEQ'0'
      *
      ***  If Depot = Depot (num field) received as parameter, and Branch = Branch received as
      ***  parameter.
      *
     C           MBDDPT    IFEQ WWDDPT
     C           MBBRCD    ANDEQPBRCD
      *
      ***  If record live, delete logically.
      *
     C           MBRECI    IFNE '*'
     C                     MOVE '*'       MBRECI
     C                     UPDATSECODPD0               89
      *
      ***  If error detected when update, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD021       DBASE            ***************
     C                     MOVEL'SECODPL0'DBFILE           * DB ERROR 21 *
     C                     MOVEL'UPDATE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
      *
      ***  If record already logically deleted (MBRECI = '*'), delete physically.
      *
     C                     ELSE
     C                     DELETSECODPD0               89
      *
      ***  If error detected when delete, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD022       DBASE            ***************
     C                     MOVEL'SECODPL0'DBFILE           * DB ERROR 22 *
     C                     MOVEL'DELETE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ENDIF
     C                     ENDIF
     C           PCORF     READESECODPL0                 80
     C                     ENDDO
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * DADNSE - Delete Corporate Actions Allocation and Depot for    *
      *          CO Reference, Option, Branch, Depot, New Security,   *
      *          Book, Customer and Portfolio.                        *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           DADNSE    BEGSR                           ** DADNSE SR **
      *
      ***  Access Corporate Actions Allocations file with CO Reference, Option Number (num field),
      ***  Branch, Depot (num field), New Security, Book, Customer (num field) and Portfolio
      ***  Reference received as parameters and Customer/Book Indicator.
      *
     C                     MOVE PNSEC     KSESN
     C           @KEY18    SETLLSECOALL0
     C           @KEY18    READESECOALL0                 80
      *
     C           *IN80     DOWEQ'0'
      *
      ***  If record live, delete logically.
      *
     C           MCRECI    IFNE '*'
     C                     MOVE '*'       MCRECI
     C                     UPDATSECOALD0               89
      *
      ***  If error detected when update, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD023       DBASE            ***************
     C                     MOVEL'SECOALL0'DBFILE           * DB ERROR 23 *
     C                     MOVEL'UPDATE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
      *
      ***  If record already logically deleted (MCRECI = '*'), delete physically.
      *
     C                     ELSE
     C                     DELETSECOALD0               89
      *
      ***  If error detected when delete, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD024       DBASE            ***************
     C                     MOVEL'SECOALL0'DBFILE           * DB ERROR 24 *
     C                     MOVEL'DELETE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ENDIF
     C           @KEY18    READESECOALL0                 80
     C                     ENDDO
      *
      ***  Access Corporate Actions Allocations file with CO Reference, Option Number (num field),
      ***  Branch, Depot (num field), Book, Customer (num field) and Portfolio Reference received
      ***  as parameters, Customer/Book Indicator and New Security = '**CASH**'.
      *
     C                     MOVE *BLANKS   KSESN
     C                     MOVEL'**CASH**'KSESN
     C******     @KEY18    CHAINSECOALL0             80                   135686
     C           @KEY18    SETLLSECOALL0                                  135686
     C           @KEY18    READESECOALL0                 80               135686
      *
     C******     *IN80     IFEQ '0'                                       135686
     C           *IN80     DOWEQ'0'                                       135686
      *
      ***  If record live, delete logically.
      *
     C           MCRECI    IFNE '*'
     C                     MOVE '*'       MCRECI
     C                     UPDATSECOALD0               89
      *
      ***  If error detected when update, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD025       DBASE            ***************
     C                     MOVEL'SECOALL0'DBFILE           * DB ERROR 25 *
     C                     MOVEL'UPDATE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
      *
      ***  If record already logically deleted (MCRECI = '*'), delete physically.
      *
     C                     ELSE
     C                     DELETSECOALD0               89
      *
      ***  If error detected when delete, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD026       DBASE            ***************
     C                     MOVEL'SECOALL0'DBFILE           * DB ERROR 26 *
     C                     MOVEL'DELETE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ENDIF
     C******               ENDIF                                          135686
     C           @KEY18    READESECOALL0                 80               135686
     C                     ENDDO                                          135686
      *
      ***  Access Corporate Actions Depot file with CO Reference, Option Number (num field),
      ***  Branch and Depot (num field) received as parameter.
      *
     C           @KEY20    SETLLSECODPL0
     C           @KEY20    READESECODPL0                 80
      *
     C           *IN80     DOWEQ'0'
      *
      ***  If record live, delete logically.
      *
     C           MBRECI    IFNE '*'
     C                     MOVE '*'       MBRECI
     C                     UPDATSECODPD0               89
      *
      ***  If error detected when update, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD027       DBASE            ***************
     C                     MOVEL'SECODPL0'DBFILE           * DB ERROR 27 *
     C                     MOVEL'UPDATE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
      *
      ***  If record already logically deleted (MBRECI = '*'), delete physically.
      *
     C                     ELSE
     C                     DELETSECODPD0               89
      *
      ***  If error detected when delete, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD028       DBASE            ***************
     C                     MOVEL'SECODPL0'DBFILE           * DB ERROR 28 *
     C                     MOVEL'DELETE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ENDIF
     C           @KEY20    READESECODPL0                 80
     C                     ENDDO
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * PDCORF - Process Detail for CO Reference depending on the     *
      *          Processing Type.                                     *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           PDCORF    BEGSR                           ** PDCORF SR **
      *
      ***  Access Corporate Actions Details file depending on the Processing Type, with CO
      ***  Reference received as parameter.
      *
     C           MAPTYP    IFEQ 'DV'                       Dividends Events.
     C           PCORF     SETLLSECODVL1
     C           PCORF     READESECODVL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'FR'                       Free Allocations.
     C           PCORF     SETLLSECOFRL1
     C           PCORF     READESECOFRL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'RG'                       Rights Issues.
     C           PCORF     SETLLSECORGL1
     C           PCORF     READESECORGL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CE'                       Capital Change.
     C           PCORF     SETLLSECOCEL1
     C           PCORF     READESECOCEL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CR'                       Corporate Reorganisation.
     C           PCORF     SETLLSECOCRL1
     C           PCORF     READESECOCRL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'OF'                       Offers.
     C           PCORF     SETLLSECOOFL1
     C           PCORF     READESECOOFL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'EX'                       Exercises and Conversions.
     C           PCORF     SETLLSECOEXL1
     C           PCORF     READESECOEXL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'NC'                       Name Changes.
     C           PCORF     SETLLSECONCL1
     C           PCORF     READESECONCL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'NF'                       Non Financial.
     C           PCORF     SETLLSECONFL1
     C           PCORF     READESECONFL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CC'                       Currency       CEU017
     C           PCORF     SETLLSECOCCL2                   Changes.       CEU017
     C           PCORF     READESECOCCL2                 80               CEU017
     C                     ELSE                                           CEU017
     C                     Z-ADD029       DBASE            ***************
     C                     MOVEL'SECOxxLx'DBFILE           * DB ERROR 29 *
     C                     MOVELMAPTYP    DBKEY1  8        ***************
     C                     MOVE PCORF     DBKEY1
     C                     MOVELDBKEY1    DBKEY
     C                     EXSR *PSSR
     C                     ENDIF                                          CEU017
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Do while not end of file for CO Reference received as parameter = for each Option.
      *
     C           *IN80     DOWEQ'0'
      *
      ***  If live record.
      *
     C           MDRECI    IFEQ 'D'
      *
      ***  If Processing Type is Corporate Reorganisation, retrieve the potential 20 New Securities,
      ***  Numbers of New Shares, Roundings, Roundings Settlement in Cash, Denominations Multiplier
      ***  and Compensation Prices from SECOCRL2
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVEAMHSECA    TSEC,1
     C                     MOVEAMHNSHA    TNSH,1
     C                     MOVEAMHRNDN    TNDN,1
     C                     MOVEAMHRNDS    TNDS,1
     C                     MOVEAMHDMLA    TDML,1
     C                     MOVEAMHCOPA    TOPA,1
     C                     ELSE
      *
      ***  Else, if Processing Type is Capital Change, Non Financial Events or Name Changes with
      ***  Security Shortname blank, set New Security = Event Security.
      *
     C           MAPTYP    IFEQ 'CE'                       If Capital Change
     C           MAPTYP    OREQ 'NF'                       Or Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Name Changes
     C           MDNSEC    ANDEQ*BLANKS                       Security from SECONCL1 blank
     C                     MOVE MASESN    TSEC,1
      *
      ***  Else, if Processing Type is Dividend Events, Exercices and Conversions, Offers, Rights
      ***  Issues, Free Allocation or Name Changes with Security Shortname not blank,
      ***  or Currency Changes,                                           CEU017
      ***  retrieve New Security from Corporate Actions Detail file.
      *
     C                     ELSE
     C                     MOVE MDNSEC    TSEC,1
     C                     ENDIF
     C                     ENDIF
      *
      ***  Retrieve Number of Decimal Places of Security and Currency and Price Basis for the New
      ***  Securities.
      *
     C                     DO   20        I       20
     C           TSEC,I    IFNE *BLANKS
      *
      ***  Access Midas SE Securities.
      *
     C                     MOVE TSEC,I    @SEC   10
     C           @SEC      CHAINSECTY                80
      *
      ***  If record not found, handle Database Error.
      *
     C           *IN80     IFEQ '1'                        Not found
     C                     Z-ADD030       DBASE            ***************
     C                     MOVEL'SECTY'   DBFILE           * DB ERROR 30 *
     C                     MOVEL@SEC      DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Save Number of Decimal Places for Nominal Currency and Price Basis of New Security.
      *
     C                     Z-ADDNMDP      TSDP,I           Number of Decimal Places
     C                     MOVE SPBS      TSPB,I           Price Basis
      *
      ***  Retrieve Number of Decimal Places of New Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM NMCY      @AJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD031       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 31 *
     C                     MOVELNMCY      DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    TCDP,I           Number of Decimal Places
     C                     ENDIF
     C                     ENDDO
      *
      ***  If Processing Type = Dividend Events and Subscription Price is entered as Market,
      ***  the Subscription Price must first be calculated from Current Market Price minus Discount.
      *
     C           MAPTYP    IFEQ 'DV'
     C           MDMRKI    ANDEQ'Y'
     C                     EXSR CSBPR
     C                     ENDIF
      *                                                                   136935
      ***  If Processing Type = Dividend Events with Stock Dividend Type  136935
      ***  = 'R', if Compensation Price entered, use Compensation Price   136935
      ***  instead of Subscription Price, otherwise, calculate Subscrip-  136935
      ***  tion Price = Subscription Price minus Discount Rate.           136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'DV'                                      136935
     C           MDSDIT    ANDEQ'R'                                       136935
     C           MDCOMP    IFNE 0                                         136935
     C                     Z-ADDMDCOMP    MDSBPR                          136935
     C                     ELSE                                           136935
     C           MDMRKI    IFNE 'Y'                                       136935
     C           MDSBPR    MULT MDDSRT    WWSBPR                          136935
     C           WWSBPR    DIV  100       WWSBPR                          136935
     C                     SUB  WWSBPR    MDSBPR                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
      *
      ***  Set 'Customer Reply Exists' work field to 'N'.
      *
     C                     MOVE 'N'       CUSRPL  1
      *                                                                   135686
      ***  Reset indicator Customer or Book processed.                    135686
      *                                                                   135686
     C                     MOVE 'N'       BCPROC  1                       135686
      *
      ***  Process Books for the Depot.
      *
     C                     EXSR PBKDPT
      *
      ***  If Portfolio Management Facilities have been licensed, process Customers for the Depot.
      *
     C           PFPL      IFEQ 'Y'
     C                     EXSR PCUDPT
     C                     ENDIF
      *
      ***  Process the Depot.
      *
     C**********           MOVE *ZEROS    WWCDCN           Customer                           CSD027
     C                     MOVE *BLANKS   WWCDCN           Customer                           CSD027
     C                     MOVE *BLANKS   WWPTFR           Protfolio Reference
     C                     MOVE *BLANKS   WWUDBK           Book
     C                     EXSR PDEPOT
      *
      ***  CO Dummy Customer processing.
      ***  If Customer or Book processed.                                 135686
      *
     C********** BVERCU    IFNE *ZEROS                                                        CSD027
     C           BVERCU    IFNE *BLANKS                                                       CSD027
     C           BVERCU    ANDNE*BLANKS
     C           BCPROC    ANDEQ'Y'                                       135686
     C                     EXSR PDUMCU
     C                     ENDIF
      *
     C                     ENDIF
      *
      ***  Read next record depending on the Processing Type, with CO Reference received as
      ***  parameter.
      *
     C           MAPTYP    IFEQ 'DV'                       Dividends Events.
     C           PCORF     READESECODVL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'FR'                       Free Allocations.
     C           PCORF     READESECOFRL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'RG'                       Rights Issues.
     C           PCORF     READESECORGL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CE'                       Capital Change.
     C           PCORF     READESECOCEL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CR'                       Corporate Reorganisation.
     C           PCORF     READESECOCRL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'OF'                       Offers.
     C           PCORF     READESECOOFL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'EX'                       Exercises and Conversions.
     C           PCORF     READESECOEXL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'NC'                       Name Changes.
     C           PCORF     READESECONCL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'NF'                       Non Financial.
     C           PCORF     READESECONFL1                 80
     C                     ELSE                                           CEU017
     C           MAPTYP    IFEQ 'CC'                       Currency       CEU017
     C           PCORF     READESECOCCL2                 80Changes.       CEU017
     C                     ENDIF                                          CEU017
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDDO
      *
      ***  Access Corporate Actions Depots file with CO Reference received as parameter, Option
      ***  Number from SECOxxL0, Branch and Depot (num field) received as parameter.
      *
     C           @KEY12    CHAINSECODRL0             82
      *
      ***  If record found, update.
      *
     C           *IN82     IFEQ '0'
      *
     C                     Z-ADDBJRDNB    MSLCD            Last Change Date = Run Date
     C                     MOVE 'A'       MSCHTP           Type of last Change
     C                     MOVE USER      MSLUID           User Id.
     C                     Z-ADDBJRDNB    MSCOAD           Last Allocation Date = Run Date
     C                     MOVE 'L'       MSCOST           Set CO Status to 'L' = Allocated
     C                     MOVE 'N'       MSALOC           Allocation running ?
     C           MAPTYP    IFEQ 'NC'                       Currency       136935
     C           MAPTYP    OREQ 'NF'                       Currency       136935
     C                     MOVE 'Y'       MSFAID           Final Alloc.   136935
     C                     ENDIF                                          136935
     C                     UPDATSECODRD0               89  Update SECODRL0
      *
      ***  If error detected when update, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD013       DBASE            ***************
     C                     MOVEL'SECODRL0'DBFILE           * DB ERROR 13 *
     C                     MOVEL'UPDATE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
      *
      ***  If record not found, write a new record on file.
      *
     C                     ELSE
     C                     MOVE 'D'       MSRECI           Record Id.
     C                     Z-ADDBJRDNB    MSLCD            Last Change Date = Run Date
     C                     MOVE 'I'       MSCHTP           Type of last Change
     C                     MOVE USER      MSLUID           User Id.
     C                     MOVE PCORF     MSCORF           CO Reference = Parameter
     C                     MOVE PBRCD     MSBRCD           Branch = Parameter
     C**********           Z-ADDWWDDPT    MSDDPT           Depot = Parameter (num field)      CSD027
     C                     MOVE WWDDPT    MSDDPT           Depot = Parameter (num field)      CSD027
     C                     Z-ADDBJRDNB    MSCOAD           Last Allocation Date = Run Date
     C           MAPTYP    IFEQ 'NC'                       Currency       136935
     C           MAPTYP    OREQ 'NF'                       Currency       136935
     C                     MOVE 'Y'       MSFAID           Final Alloc.   136935
     C                     ELSE                                           136935
     C                     MOVE 'N'       MSFAID           Final Allocation Ind. = Trial Allocation
     C                     ENDIF                                          136935
     C                     MOVE 'L'       MSCOST           CO Status = allocated
     C                     MOVE 'N'       MSALOC           Allocation running ?
     C                     WRITESECODRD0               89  Write record on SECODRL0
      *
      ***  If error detected when write, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD014       DBASE            ***************
     C                     MOVEL'SECODRL0'DBFILE           * DB ERROR 14 *
     C                     MOVEL'WRITE'   DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ENDIF
      *
      ***  Print details of Allocation generated.
      *
     C                     EXSR PRDTAG
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * PDNSEC - Process Detail for CO Reference, Option Number and   *
      *          New Security, depending on the Processing Type.      *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           PDNSEC    BEGSR                           ** PDNSEC SR **
      *
     C           @KEY20    SETLLSECOALL0
     C           @KEY20    READESECOALL0                 80
     C           *IN80     DOWEQ'0'
     C           MCRECI    IFEQ 'D'                        Live record
     C           MCCOTP    ANDEQKCOTP                      Same Customer/Book Indicator
     C           MCBOOK    ANDEQPBOOK                      Same Book
     C           MCCNUM    ANDEQWWCNUM                     Same Customer Number
     C           MCPTFR    ANDEQPPTFR                      Same Portfolio Reference
      *
      ***  Retrieve Currency Number of Decimal Places.
      *
      ***  Access Midas SE Securities.
      *
     C           MCSESN    CHAINSECTY                80
      *
      ***  If record not found, handle Database Error.
      *
     C           *IN80     IFEQ '1'                        Not found
     C                     Z-ADD032       DBASE            ***************
     C                     MOVEL'SECTY'   DBFILE           * DB ERROR 32 *
     C                     MOVELMCSESN    DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Retrieve Number of Decimal Places of Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM NMCY      @AJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD033       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 33 *
     C                     MOVELNMCY      DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    WWNBDP           Number of Decimal Places
      *
      ***  Accumulate Actual Cash Rounding.
      *
     C                     Z-ADDMCACAR    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WTACAR 309
      *
      ***  Accumulate Original Cash Rounding.
      *
     C                     Z-ADDMCOCAR    WUNUM
     C                     EXSR RTVNDP
     C                     ADD  WWNUM     WTOCAR 309
     C                     ENDIF
     C           @KEY20    READESECOALL0                 80
     C                     ENDDO
      *
      ***  Access Corporate Actions Details file depending on the Processing Type, with CO
      ***  Reference and Option Number received as parameter.
      *
     C           MAPTYP    IFEQ 'DV'                       Dividends Events.
     C           @KEY19    SETLLSECODVL1
     C           @KEY19    READESECODVL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'FR'                       Free Allocations.
     C           @KEY19    SETLLSECOFRL1
     C           @KEY19    READESECOFRL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'RG'                       Rights Issues.
     C           @KEY19    SETLLSECORGL1
     C           @KEY19    READESECORGL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CE'                       Capital Change.
     C           @KEY19    SETLLSECOCEL1
     C           @KEY19    READESECOCEL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CR'                       Corporate Reorganisation.
     C           @KEY19    SETLLSECOCRL1
     C           @KEY19    READESECOCRL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'OF'                       Offers.
     C           @KEY19    SETLLSECOOFL1
     C           @KEY19    READESECOOFL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'EX'                       Exercises and Conversions.
     C           @KEY19    SETLLSECOEXL1
     C           @KEY19    READESECOEXL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'NF'                       Non Financial Events
     C           PCORF     SETLLSECONFL1
     C           PCORF     READESECONFL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'NC'                       Name Changes
     C           PCORF     SETLLSECONCL1
     C           PCORF     READESECONCL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CC'                       Currency       CEU017
     C           PCORF     SETLLSECOCCL2                   Changes.       CEU017
     C           PCORF     READESECOCCL2                 80               CEU017
     C                     ELSE                                           CEU017
     C                     Z-ADD034       DBASE            ***************
     C                     MOVEL'SECOxxLx'DBFILE           * DB ERROR 34 *
     C                     MOVELMAPTYP    DBKEY1  8        ***************
     C                     MOVE PCORF     DBKEY1
     C                     MOVELDBKEY1    DBKEY
     C                     EXSR *PSSR
     C                     ENDIF                                          CEU017
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
      ***  Do while not end of file for CO Reference and Option Number received as parameter.
      *
     C           *IN80     DOWEQ'0'
      *
      ***  If live record.
      *
     C           MDRECI    IFEQ 'D'
     C                     MOVE '0'       *IN88
      *
      ***  If Processing Type is Corporate Reorganisation.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVEAMHSECA    SECT,1
     C           PNSEC     LOKUPSECT                     88
     C                     ELSE
      *
      ***  Else, if Processing Type is Capital Change, Non Financial Events or Name Changes with
      ***  Security Shortname blank.
      *
     C           MAPTYP    IFEQ 'CE'                       If Capital Change
     C           MAPTYP    OREQ 'NF'                       Or Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Name Changes
     C           MDNSEC    ANDEQ*BLANKS                       Security from SECONCL1 blank
     C                     MOVE '1'       *IN88
     C                     ELSE
      *
      ***  Else, if Processing Type is Dividends Events, Rights Issues, Offers, Exercises and
      ***  Conversions, Free Allocation or Name Changes with Security Shortname not blank.
      ***  or Currency Changes.                                           CEU017
      *
     C           MDNSEC    COMP PNSEC                    88
     C                     ENDIF
     C                     ENDIF
      *
      ***  If New Security = New Security received as parameter.
      *
     C           *IN88     IFEQ '1'
      *
      ***  If Processing Type is Corporate Reorganisation, retrieve the New Security,
      ***  Number of New Shares, Rounding, Rounding Settlement in Cash, Denomination Multiplier and
      ***  Compensation Price.
      *
     C           MAPTYP    IFEQ 'CR'
     C                     MOVEAMHNSHA    NSHT,1
     C                     MOVEAMHRNDN    NDNT,1
     C                     MOVEAMHRNDS    NDST,1
     C                     MOVEAMHDMLA    DMLT,1
     C                     MOVEAMHCOPA    OPAT,1
     C                     Z-ADD1         I
     C           PNSEC     LOKUPSECT,I                   90
     C                     MOVE SECT,I    TSEC,1
     C                     MOVE NSHT,I    TNSH,1
     C                     MOVE NDNT,I    TNDN,1
     C                     MOVE NDST,I    TNDS,1
     C                     MOVE DMLT,I    TDML,1
     C                     MOVE OPAT,I    TOPA,1
     C                     ELSE
      *
      ***  Else, if Processing Type is Capital Change, Non Financial Events or Name Changes with
      ***  Security Shortname blank, set New Security = Event Security.
      *
     C           MAPTYP    IFEQ 'CE'                       If Capital Change
     C           MAPTYP    OREQ 'NF'                       Or Non Financial Events
     C           MAPTYP    OREQ 'NC'                       Or Name Changes
     C           MDNSEC    ANDEQ*BLANKS                       Security from SECONCL1 blank
     C                     MOVE MASESN    TSEC,1
      *
      ***  Else, if Processing Type is Dividend Events, Exercices and Conversions, Offers, Rights
      ***  Issues, Free Allocation or Name Changes with Security Shortname not blank,
      ***  or Currency Changes,                                           CEU017
      ***  retrieve New Security from Corporate Actions Detail file.
      *
     C                     ELSE
     C                     MOVE MDNSEC    TSEC,1
     C                     ENDIF
     C                     ENDIF
      *
      ***  Retrieve Number of Decimal Places of Security and Currency and Price Basis for the New
      ***  Security.
      *
      ***  Access Midas SE Securities.
      *
     C                     MOVE TSEC,1    @SEC   10
     C           @SEC      CHAINSECTY                80
      *
      ***  If record not found, handle Database Error.
      *
     C           *IN80     IFEQ '1'                        Not found
     C                     Z-ADD035       DBASE            ***************
     C                     MOVEL'SECTY'   DBFILE           * DB ERROR 35 *
     C                     MOVEL@SEC      DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
      ***  Save Number of Decimal Places for Nominal Currency and Price Basis of New Security.
      *
     C                     Z-ADDNMDP      TSDP,1           Number of Decimal Places
     C                     MOVE SPBS      TSPB,1           Price Basis
      *
      ***  Retrieve Number of Decimal Places of Event Currency by calling access objet.
      *
     C                     CALL 'AOCURRR0'
     C                     PARM '*MSG   ' @RTCD   7
     C                     PARM '*KEY   ' @OPTN   7
     C                     PARM ESNCCY    @AJCD   3
     C           SDCURR    PARM SDCURR    DSSDY
      *
      ***  If record not found, handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C                     Z-ADD036       DBASE            ***************
     C                     MOVEL'SDCURRPD'DBFILE           * DB ERROR 36 *
     C                     MOVELESNCCY    DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     Z-ADDA6NBDP    TCDP,1           Number of Decimal Places
      *
      ***  If Processing Type = Dividend Events and Subscription Price is entered as Market,
      ***  the Subscription Price must first be calculated from Current Market Price minus Discount.
      *
     C           MAPTYP    IFEQ 'DV'
     C           MDMRKI    ANDEQ'Y'
     C                     EXSR CSBPR
     C                     ENDIF
      *                                                                   136935
      ***  If Processing Type = Dividend Events with Stock Dividend Type  136935
      ***  = 'R', if Compensation Price entered, use Compensation Price   136935
      ***  instead of Subscription Price, otherwise, calculate Subscrip-  136935
      ***  tion Price = Subscription Price minus Discount Rate.           136935
      *                                                                   136935
     C           MAPTYP    IFEQ 'DV'                                      136935
     C           MDSDIT    ANDEQ'R'                                       136935
     C           MDCOMP    IFNE 0                                         136935
     C                     Z-ADDMDCOMP    MDSBPR                          136935
     C                     ELSE                                           136935
     C           MDMRKI    IFNE 'Y'                                       136935
     C           MDSBPR    MULT MDDSRT    WWSBPR                          136935
     C           WWSBPR    DIV  100       WWSBPR                          136935
     C                     SUB  WWSBPR    MDSBPR                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
     C                     ENDIF                                          136935
      *
      ***  Set 'Customer Reply Exists' work field to 'N'.
      *
     C                     MOVE 'N'       CUSRPL  1
      *                                                                   135686
      ***  Reset indicator Customer or Book processed.                    135686
      *                                                                   135686
     C                     MOVE 'N'       BCPROC  1                       135686
      *
      ***  If Book received as parameter not blank, it seams that allocation must be runed for one
      ***  Depot.
      *
     C           PBOOK     IFNE *BLANKS
      *
      ***  Process Books for the Depot.
      *
     C                     EXSR PBKDPT
      *
      ***  Else, if Customer received as parameter not blank, it seams that allocation must be runed
      ***  for one Customer/Portfolio.
      *
     C                     ELSE
      *
      ***  If Portfolio Management Facilities have been licensed, process Customers for the Depot.
      *
     C           PFPL      IFEQ 'Y'
     C                     EXSR PCUDPT
     C                     ENDIF
     C                     ENDIF
      *
      ***  Process the Depot.
      *
     C**********           MOVE *ZEROS    WWCDCN           Customer                           CSD027
     C                     MOVE *BLANKS   WWCDCN           Customer                           CSD027
     C                     MOVE *BLANKS   WWPTFR           Protfolio Reference
     C                     MOVE *BLANKS   WWUDBK           Book
     C                     EXSR PDEPOT
      *
     C                     ENDIF
     C                     ENDIF
      *
      ***  Read next record depending on the Processing Type, with CO Reference and Option Number
      ***  received as parameter.
      *
     C           MAPTYP    IFEQ 'DV'                       Dividends Events.
     C           @KEY19    READESECODVL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'FR'                       Free Allocations.
     C           @KEY19    READESECOFRL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'RG'                       Rights Issues.
     C           @KEY19    READESECORGL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CE'                       Capital Change.
     C           @KEY19    READESECOCEL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'CR'                       Corporate Reorganisation.
     C           @KEY19    READESECOCRL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'OF'                       Offers.
     C           @KEY19    READESECOOFL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'EX'                       Exercises and Conversions.
     C           @KEY19    READESECOEXL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'NF'                       Non Financial Events
     C           PCORF     READESECONFL1                 80
     C                     ELSE
     C           MAPTYP    IFEQ 'NC'                       Name Changes
     C           PCORF     READESECONCL1                 80
     C                     ELSE                                           CEU017
     C           MAPTYP    IFEQ 'CC'                       Currency       CEU017
     C           PCORF     READESECOCCL2                 80Changes.       CEU017
     C                     ENDIF                                          CEU017
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDDO
      *
      ***  Access Corporate Actions Depots file with CO Reference received as parameter, Option
      ***  Number from SECOxxL0, Branch and Depot (num field) received as parameter.
      *
     C           @KEY12    CHAINSECODRL0             82
      *
      ***  If record found, update.
      *
     C           *IN82     IFEQ '0'
      *
     C                     Z-ADDBJRDNB    MSLCD            Last Change Date = Run Date
     C                     MOVE 'A'       MSCHTP           Type of last Change
     C                     MOVE USER      MSLUID           User Id.
     C                     Z-ADDBJRDNB    MSCOAD           Last Allocation Date = Run Date
     C                     MOVE 'L'       MSCOST           Set CO Status to 'L' = Allocated
     C                     MOVE 'N'       MSALOC           Allocation running ?
     C           MAPTYP    IFEQ 'NC'                       Currency       136935
     C           MAPTYP    OREQ 'NF'                       Currency       136935
     C                     MOVE 'Y'       MSFAID           Final Alloc.   136935
     C                     ENDIF                                          136935
     C                     UPDATSECODRD0               89  Update SECODRL0
      *
      ***  If error detected when update, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD013       DBASE            ***************
     C                     MOVEL'SECODRL0'DBFILE           * DB ERROR 13 *
     C                     MOVEL'UPDATE'  DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
      *
      ***  If record not found, write a new record on file.
      *
     C                     ELSE
     C                     MOVE 'D'       MSRECI           Record Id.
     C                     Z-ADDBJRDNB    MSLCD            Last Change Date = Run Date
     C                     MOVE 'I'       MSCHTP           Type of last Change
     C                     MOVE USER      MSLUID           User Id.
     C                     MOVE PCORF     MSCORF           CO Reference = Parameter
     C                     MOVE PBRCD     MSBRCD           Branch = Parameter
     C**********           Z-ADDWWDDPT    MSDDPT           Depot = Parameter (num field)      CSD027
     C                     MOVE WWDDPT    MSDDPT           Depot = Parameter (num field)      CSD027
     C                     Z-ADDBJRDNB    MSCOAD           Last Allocation Date = Run Date
     C           MAPTYP    IFEQ 'NC'                       Currency       136935
     C           MAPTYP    OREQ 'NF'                       Currency       136935
     C                     MOVE 'Y'       MSFAID           Final Alloc.   136935
     C                     ELSE                                           136935
     C                     MOVE 'N'       MSFAID           Final Allocation Ind. = Trial Allocation
     C                     ENDIF                                          136935
     C                     MOVE 'L'       MSCOST           CO Status = allocated
     C                     MOVE 'N'       MSALOC           Allocation running ?
     C                     WRITESECODRD0               89  Write record on SECODRL0
      *
      ***  If error detected when write, handle Database Error.
      *
     C           *IN89     IFEQ '1'
     C                     Z-ADD014       DBASE            ***************
     C                     MOVEL'SECODRL0'DBFILE           * DB ERROR 14 *
     C                     MOVEL'WRITE'   DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
     C                     COMIT
     C                     ENDIF
      *
      ***  Print details of Allocation generated.
      *
     C                     EXSR PRDTAG
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CTOTAX - Calculate total Tax.                                 *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CTOTAX    BEGSR                           ** CTOTAX SR **
      *
      ***  Initialise Total Tax.
      *
     C                     Z-ADD0         TOTTAX
      *
      ***  Access Security Withholding Tax details file to retrieve Tax for the Event Security.
      *
     C           MASESN    CHAINSESWHTL0             84
      *
      ***  If record found.
      *
     C           *IN84     IFEQ '0'
      *
      ***  Initialise work tax rate and amount fields.
      *
     C                     CLEARUTXRSR
     C                     CLEARUTXRRF
     C                     CLEARUTXRUS
     C                     CLEARUDLOR
      *
      ***  If Tax Band at source is zero, then take Rate from Security Withholding Tax file.
      *
     C           S1TABD    IFEQ *ZERO
     C                     Z-ADDS1RASO    UTXRSR  74
     C                     ELSE
      *
      ***  Otherwise access SE Country Tax Rate file to get Tax Rate at source.
      *
     C                     MOVELS1CTTA    UKEY    3
     C                     MOVE S1TABD    UKEY
     C                     CALL 'AOSCTXR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM S1CTTA    @CTTA   2
     C                     PARM S1TABD    @TABD   10
     C           SECNTR    PARM SECNTR    DSSDY
      *
      ***  If record not found or not live, handle Database Error.
      *
     C           @RTCD     IFNE *BLANKS
     C           TXRECI    ORNE 'D'
     C                     Z-ADD037       DBASE            ***************
     C                     MOVEL'SECNTRL0'DBFILE           * DB ERROR 37 *
     C                     MOVELUKEY      DBKEY            ***************
     C                     EXSR *PSSR
     C                     ELSE
     C                     Z-ADDTXRASO    UTXRSR
     C                     ENDIF
     C                     ENDIF
      *
      ***  If Tax Band by User is not zero, then access Country to Branch Tax Rate file to get
      ***  Tax Rate by User, otherwise set to zero.
      *
     C           S1TABU    IFNE *ZERO
     C                     CALL 'AOCBTXR0'
     C                     PARM *BLANKS   @RTCD
     C                     PARM '*KEY   ' @OPTN
     C                     PARM PBRCD     @BRCA   3
     C                     PARM S1CTTA    @CTTA
     C                     PARM S1TABU    @TABU   10
     C           SECBTX    PARM SECBTX    DSFDY
     C           @RTCD     IFEQ *BLANKS
     C           TBRECI    ANDEQ'D'
     C                     Z-ADDTBRASR    UTXRRF  74
     C                     Z-ADDTBRAUS    UTXRUS  74
     C                     MOVE TBDLOR    UDLOR   1
     C                     ENDIF
     C                     ENDIF
      *
      ***  Calculate amount deducted at source.
      *
     C           UTXRSR    DIV  100       URATE   54
     C***********WWAMTT    MULT URATE     TASO   130H                     164020
     C           WWAMTT    MULT URATE     TASO   152H                     164020
      *
      ***  Calculate amount deducted refundable.
      *
     C           UTXRRF    DIV  100       URATE
     C***********WWAMTT    MULT URATE     TASR   130H                     164020
     C           WWAMTT    MULT URATE     TASR   152H                     164020
      *
      ***  Calculate amount deducted by user.
      *
     C                     CLEARTAUS
     C           UTXRUS    IFGT *ZERO
     C           UDLOR     IFEQ 'N'
     C                     MOVE WWCDCN    KCUST
     C           @KEY8     CHAINCLINT                84
     C           *IN84     IFEQ '1'
     C           RECI      OREQ '*'
     C                     Z-ADD038       DBASE            ***************
     C                     MOVEL'CLINTCB 'DBFILE           * DB ERROR 38 *
     C                     MOVELKCUST     DBKEY2  7        ***************
     C                     MOVE KRTYP     DBKEY2
     C                     MOVELDBKEY2    DBKEY
     C                     EXSR *PSSR
     C                     ENDIF
     C                     ENDIF
      *
     C           UDLOR     IFEQ 'Y'
     C           UDLOR     OREQ 'N'
     C           CLOC      ANDNEUBRLOC
     C           UTXRUS    DIV  100       URATE
     C***********WWAMTT    MULT URATE     TAUS   130H                     164020
     C           WWAMTT    MULT URATE     TAUS   152H                     164020
     C                     ENDIF
     C                     ENDIF
      *
      ***  Calculate Total Tax.
      *
     C           TAUS      ADD  TASO      TOTTAX 309
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * SETNDP - Set amount from num field 24.9 to num field 15.0     *
      *          with Number of Decimal Places from Nominal Currency  *
      *          received as parameter.                               *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           SETNDP    BEGSR                           ** SETNDP SR **
      *
     C           WWNBDP    IFEQ 0                          If no Decimal Place
     C**********           Z-ADDWWNUM     WUNUM  150                      149257
     C                     Z-ADDWWNUM     WUNUM  194                      149257
     C                     ELSE
     C           WWNBDP    IFEQ 1                          If 1 Decimal Place
     C           WWNUM     MULT 10        WUNUM
     C                     ELSE
     C           WWNBDP    IFEQ 2                          If 2 Decimal Places
     C           WWNUM     MULT 100       WUNUM
     C                     ELSE
     C           WWNBDP    IFEQ 3                          If 3 Decimal Places
     C           WWNUM     MULT 1000      WUNUM
     C                     ELSE
     C           WWNBDP    IFEQ 4                          If 4 Decimal Places
     C           WWNUM     MULT 10000     WUNUM
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * RTVNDP - Set amount from num field 15.0 to num field 24.9     *
      *          with Retrieve Number of Decimal Places from Nominal  *
      *          Currency received as parameter.                      *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           RTVNDP    BEGSR                           ** RTVNDP SR **
      *
     C           WWNBDP    IFEQ 0                          If no Decimal Place
     C                     Z-ADDWUNUM     WWNUM  309
     C                     ELSE
     C           WWNBDP    IFEQ 1                          If 1 Decimal Place
     C           WUNUM     DIV  10        WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 2                          If 2 Decimal Places
     C           WUNUM     DIV  100       WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 3                          If 3 Decimal Places
     C           WUNUM     DIV  1000      WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 4                          If 4 Decimal Places
     C           WUNUM     DIV  10000     WWNUM
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * ROUNDD - Perform rounding to the Number of Decimal Places.    *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           ROUNDD    BEGSR                           ** ROUNDD SR **
      *
     C           WWNBDP    IFEQ 0                          If no Decimal Place
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD0 300H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD0
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD0
     C                     ADD  1         WUFLD0
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD0    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 1                          If 1 Decimal Place
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD1 241H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD1
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD1
     C                     ADD  0.1       WUFLD1
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD1    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 2                          If 2 Decimal Places
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD2 242H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD2
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD2
     C                     ADD  0.01      WUFLD2
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD2    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 3                          If 3 Decimal Places
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD3 243H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD3
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD3
     C                     ADD  0.001     WUFLD3
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD3    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 4                          If 4 Decimal Places
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD4 244H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD4
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD4
     C                     ADD  0.0001    WUFLD4
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD4    WWNUM
     C                     ELSE
     C           WWNBDP    IFEQ 8                          If 8 Decimal Places
     C           WUROOP    IFEQ 'R'
     C                     Z-ADDWWNUM     WUFLD8 248H
     C                     ELSE
     C                     Z-ADDWWNUM     WUFLD8
     C           WUROOP    IFEQ 'U'
     C           WWNUM     ANDNEWUFLD8
     C                     ADD  0.00000001WUFLD8
     C                     ENDIF
     C                     ENDIF
     C                     Z-ADDWUFLD8    WWNUM
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * CSBPR  - Calculate Subscription Price if Subscription Price   *
      *          entered as Market for Dividend Events.               *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           CSBPR     BEGSR                           ** CSBPR SR **
      *
      ***  Find Market Price with correct Date.
      *
     C                     MOVE 'N'       WWCHCK  1
      *
     C                     Z-ADDMACOEX    KPVDT
     C           @KEY21    SETGTPRICM
     C                     READPPRICM                    44
      *
      ***  If record found use this Price.
      *
     C           *IN44     IFEQ '0'
     C           PSSN      ANDEQMDNSEC
     C                     MOVE 'Y'       WWCHCK
      *
      ***  Otherwise check for Current Price.
      *
     C                     ELSE
     C                     Z-ADD*HIVAL    KPVDT
      *
     C           @KEY21    SETGTPRICM
     C                     READPPRICM                    44
      *
      ***  If record found use this price.
      *
     C           *IN44     IFEQ '0'
     C           PSSN      ANDEQMDNSEC
     C                     MOVE 'Y'       WWCHCK
     C                     ENDIF
     C                     ENDIF
      *
     C           WWCHCK    IFEQ 'N'
     C                     Z-ADDMKPR      MPRICE 158       Market Price from Security file.
     C                     ELSE
     C                     Z-ADDPPRC      MPRICE
     C                     ENDIF
      *
      ***  Calculate Subscription Price = Current Market Price minus Discount.
      *
     C           MPRICE    MULT MDDSRT    WWSBPR 158
     C           WWSBPR    DIV  100       WWSBPR
     C           MPRICE    SUB  WWSBPR    MDSBPR
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT                                                              135685
      *****************************************************************   135685
      *                                                               *   135685
      * CCOMP  - Calculate Subscription Price if Subscription Price   *   135685
      *          entered as Market for Dividend Events.               *   135685
      *                                                               *   135685
      * Called by:                                                    *   135685
      *                                                               *   135685
      * Calls:                                                        *   135685
      *                                                               *   135685
      *****************************************************************   135685
      *                                                                   135685
     C           CCOMP     BEGSR                           ** CCOMP SR ** 135685
      *                                                                   135685
      ***  Find Market Price with correct Date.                           135685
      *                                                                   135685
     C                     MOVE 'N'       WWCHCK  1                       135685
      *                                                                   135685
     C                     Z-ADDMAALEF    KPVDT                           135685
     C           @KEY21    SETGTPRICM                                     135685
     C                     READPPRICM                    44               135685
      *                                                                   135685
      ***  If record found use this Price.                                135685
      *                                                                   135685
     C           *IN44     IFEQ '0'                                       135685
     C           PSSN      ANDEQMDNSEC                                    135685
     C                     MOVE 'Y'       WWCHCK                          135685
      *                                                                   135685
      ***  Otherwise check for Current Price.                             135685
      *                                                                   135685
     C                     ELSE                                           135685
     C                     Z-ADD*HIVAL    KPVDT                           135685
      *                                                                   135685
     C           @KEY21    SETGTPRICM                                     135685
     C                     READPPRICM                    44               135685
      *                                                                   135685
      ***  If record found use this price.                                135685
      *                                                                   135685
     C           *IN44     IFEQ '0'                                       135685
     C           PSSN      ANDEQMDNSEC                                    135685
     C                     MOVE 'Y'       WWCHCK                          135685
     C                     ENDIF                                          135685
     C                     ENDIF                                          135685
      *                                                                   135685
     C           WWCHCK    IFEQ 'N'                                       135685
     C                     Z-ADDMKPR      MDCOMP           Market Price   135685
     C                     ELSE                                           135685
     C                     Z-ADDPPRC      MDCOMP                          135685
     C                     ENDIF                                          135685
      *                                                                   135685
     C                     ENDSR                                          135685
      *                                                                   135685
      *****************************************************************   135685
      /EJECT
      *****************************************************************
      *                                                               *
      * ENDPGM - Termination Processing.                              *
      *                                                               *
      * Called by: Main Processing.                                   *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           ENDPGM    BEGSR                           ** ENDPGM SR **
      *
      ***  Write Report Header and File Control on Audit (PRTF/SE7550AU).
      *
     C                     WRITEHEADAU
     C  N13                WRITESUBHD1
     C   13                WRITESUBHD2
     C                     WRITECONTROL
      *
      ***  End of program.
      *
     C                     MOVE '1'       *INLR
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * RCFAU  - Subroutine to register the AU Printer File via RCF.  *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           RCFAU     BEGSR                            *** RCFAU  ***
      *
      ***  Ensure Audit Spool File recorded by RCF.
      *
     C                     Z-ADDSFNUMU    ZSNUMU  60
      *
     C                     CALL 'ZSFILE'               87
     C                     PARM           SEQ     5
     C                     PARM *BLANKS   SENTY   3
     C                     PARM           SFILEU
     C                     PARM           ZSNUMU
     C                     PARM *BLANK    ZSERR   1
      *
      ***  If Error occurs during ZSFILE processing, handle Database Error.
      *
     C           ZSERR     IFEQ 'Y'
     C           *IN87     OREQ '1'
     C           *INU7     OREQ '1'
     C           *INU8     OREQ '1'
     C                     Z-ADD039       DBASE            ***************
     C                     MOVEL*BLANKS   DBFILE           * DB ERROR 39 *
     C                     MOVELNARR,2    DBKEY            ***************
     C                     EXSR *PSSR
     C                     ENDIF
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *****************************************************************
      *                                                               *
      * *PSSR  - Program exception error routine                      *
      *          Called automatically if a program error occurs,      *
      *          or directly by the program code using EXSR.          *
      *          This subroutine DUMPs the program just once.         *
      *                                                               *
      * Called by:                                                    *
      *                                                               *
      * Calls:                                                        *
      *                                                               *
      *****************************************************************
      *
     C           *PSSR     BEGSR                           ** *PSSR SR **
      *
     C           @RUN      IFEQ *BLANK
     C                     MOVE 'Y'       @RUN    1
      *
      ***  Update LDA with error information.
      *
     C           *LOCK     IN   LDA
     C                     MOVELDBFILE    WWFILE
     C                     MOVELDBKEY     WWKEY
     C                     MOVELDBPGM     WWPGM
     C                     MOVELDBASE     WWASE
     C                     OUT  LDA
      *
      ***  Rollback and print Dump.
      *
     C                     ROLBK
     C                     DUMP
     C                     ENDIF
      *
      ***  Write Report Header and Database Error on Audit (PRTF/SE7550AU).
      *
     C                     WRITEHEADAU
     C  N13                WRITESUBHD1
     C   13                WRITESUBHD2
     C                     WRITEDBERROR
      *
     C                     SETON                     U7U8LR
     C                     RETRN
      *
     C                     ENDSR
      *
      *****************************************************************
      /EJECT
      *
      ***  Standard Subroutine to calculate Charges/Commissions.
      ***  ( Called by: CALAM2 - Calculate Charge Amounts.
      ***    Calls: ZCCAL2 - Calculate Charges/Commissions.
      ***           ZCONV  - Convert Amount from one Currency to another. )
      *
     C/COPY ZSRSRC,ZCCAL1Z2
      /EJECT
      *
      ***  Standard Subroutine to calculate Charges/Commissions.
      ***  ( Called by: ZCCAL1 - Calculate Charges/Commissions.
      ***    Calls: None. )
      *
     C/COPY ZSRSRC,ZCCAL2Z1
      /EJECT
      *
      ***  Standard Subroutine to convert Amount from one Currency to another.
      ***  ( Called by: ZCCAL1 - Calculate Charges/Commissions.
      ***    Calls: None. )
      *
     C/COPY ZSRSRC,ZCONVZ1
      /EJECT
**  POWER8 - ARRAY OF POWERS FOR CURRENCY CONVERSION
00000001
00000010
00000100
00001000
00010000
00100000
01000000
10000000
**  POWER - ARRAY OF POWERS FOR CURRENCY CONVERSION
0000001
0000010
0000100
0001000
0010000
0100000
1000000
**  NARR
ERROR CALL PGM 'SE7534'
ERROR CALL PGM 'ZSFILE'
**  CPY@
(c) Finastra International Limited 2001
